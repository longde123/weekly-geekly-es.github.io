<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐คพ ๐ ๐ด ุงุชุตุงู VPN IPSec ุจูู MikroTik ู Kerio Control ๐ง๐ป ๐จ๐ฝ โ๐ผ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุงููุนููุงุช ุงูุฃูููุฉ: 



1. ุงูููุชุจ ุงูุฑุฆูุณู ูููุคุณุณุฉ ูุน ุงุซููู ูู ูููุงุก ุงูุญุฏูุฏ Kerio Control v.9.2.9 build 3171 (ุฎูู Kerio ููุฌุฏ ููุชุงุญ Cisco 3550 ุงูุฐู ูุญุฏุฏ ุช...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุงุชุตุงู VPN IPSec ุจูู MikroTik ู Kerio Control</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439736/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/zg/b9/cd/zgb9cd1ivkh83waulyxllysswwe.png"><br><br>  ุงููุนููุงุช ุงูุฃูููุฉ: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูููุชุจ ุงูุฑุฆูุณู ูููุคุณุณุฉ ูุน ุงุซููู ูู ูููุงุก ุงูุญุฏูุฏ Kerio Control v.9.2.9 build 3171 (ุฎูู Kerio ููุฌุฏ ููุชุงุญ Cisco 3550 ุงูุฐู ูุญุฏุฏ ุชูููู ุงูุดุจูุฉ ุงููุญููุฉ ููููุชุจ). </li><li style=";text-align:right;direction:rtl">  ูู Kerio ูุฏูู ููุงุชุงู ูุน ููุงุฒูุฉ ุชุญููู ุชุตู ุฅูู ISP (ูู ุงูุฑุณู ุงูุจูุงูู - ISP # 1 ู ISP # 2) ูุน IPs ุซุงุจุช ุฃุจูุถ. </li><li style=";text-align:right;direction:rtl">  ูู ุฌุงูุจ ุงูููุชุจ ุงูุจุนูุฏ ุ ุชู ุชุซุจูุช MikroTik 951G-2HnD (OS v.6.43.11). </li><li style=";text-align:right;direction:rtl">  ูุฃุชู ูุฒูุฏู ุฎุฏูุงุช ุงูุฅูุชุฑูุช ุฅูู MikroTik (ูู ุงููุฎุทุท ููุง ISP # 3 ู ISP # 4). </li></ol><br>  ูู ููุช ูุชุงุจุฉ ูุฐุง ุงูุชูุฑูุฑ ุ ุณูุงุก ูู ุงูููุชุจ ุงูุฑุฆูุณู ุฃู ูู ุงูููุชุจ ุงูุจุนูุฏ ุ ูุงู ุงูุงุชุตุงู ูุน ููุฏูู ุงูุฎุฏูุงุช ุฒูุฌูุง ููุชูููุง. <br><br><h3 style=";text-align:right;direction:rtl">  ูุงุฆูุฉ ุงูููุงู: </h3><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูู ุจุชุฃุณูุณ ุงุชุตุงู IPSec VPN ุจูู MikroTik ู Kerio Control ุ ุญูุซ ุณูููู MikroTik ูู ุงูุจุงุฏุฆ. </li><li style=";text-align:right;direction:rtl"> ุถูุงู ุงูุชุณุงูุญ ูุน ุงูุฎุทุฃ ูุงุชุตุงู VPN ุ ุฃู  ุจุงูุฅุถุงูุฉ ุฅูู ุญูููุฉ ุฃู MikroTik ูุฌุจ ุฃู ุชุฑุงูุจ ุฃุฏุงุก ูุฒูุฏู ุฎุฏูุงุช ุงูุฅูุชุฑูุช (ุงูููุงูุฉ <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a></b> ) ุ ูุฌุจ ุนูููุง ุฃูุถูุง ูุฑุงูุจุฉ ูุฏู ุชููุฑ ูู ุฎุงุฏู Kerio ูุชุญุฏูุฏ ุงููุตูู ุนุจุฑ ุฃู ููุงุฉ (ูู ุฎูุงููุง ISP ูู Kerio) ุณูุชู ุงูุงุชุตุงู. </li><li style=";text-align:right;direction:rtl">  ููุฑ ุงููุฏุฑุฉ ุนูู ุชุบููุฑ ุนููุงู ุงูุดุจูุฉ ุงูุฐู ูุชุตู ุจู MikroTik ูุน Kerio.  ูุฐุง ูุฑุฌุน ุฅูู ุญูููุฉ ุฃู ููุฑูู ุ ูููุณ ุฌูุงุฒ ุงูุชูุฌูู ุ ููุฌูุฏูู ูู ููุฑ "ุงูุญุฏูุฏ". </li></ol><a name="habracut"></a><br><br><h3 style=";text-align:right;direction:rtl">  ูุงุฐุง ูุญุตู ุนูู ุงูุงูุชุงุฌุ </h3><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุนูุฏ ุจุฏุก ุชุดุบูู MikroTik (schedStartup) ุ ุณูุชู ุชูุธูู ููุงุฉ ูุดุจูุฉ ุงููุคุณุณุฉ (ุณูุชู ุชุดุบูู ุงูููุงุฉ ุจูุงุณุทุฉ MikroTik) ุ ููุง ูุณูุญ ูููุณุชุฎุฏู ุนู ุจุนุฏ ุจุงูุนูู ูุน ููุงุฑุฏ ุงูุดุฑูุฉ ุฏูู ุจุฏุก Kerio Client ูุจุฏูู ุฅุนุฏุงุฏ ุงุชุตุงู VPN ุฅุถุงูู ุจุงุณุชุฎุฏุงู ูุธุงู ุงูุชุดุบูู ุ </li><li style=";text-align:right;direction:rtl">  ุณูู ุชููู MikroTik ุจุชุทุจูู ุชุฌุงูุฒ ุงููุดู ุ ูุงูุฐู ููุชูู ุชููุงุฆููุง ุฅูู ูุฒูุฏ ุฎุฏูุฉ ุงูุฅูุชุฑูุช ุงููุจุงุดุฑ ุ </li><li style=";text-align:right;direction:rtl">  ููููู ุชุนููู ุงูุฃููููุงุช ูููุงุท ุงูุงุชุตุงู ุจุดุจูุฉ ุงููุคุณุณุฉ ุนู ุทุฑูู ุชุบููุฑ ุงูุชูุงุก ุฃูุฑุงููู ุงูุฐูู ุชู ุชูููููู ููุงุชุตุงู ุจู Kerio Control ุฅูู ูุฌููุนุฉ ุฃู ุฃุฎุฑู ูู ููุงูุจ ุงูุณูุงุณุงุช ูู MikroTik ุ </li><li style=";text-align:right;direction:rtl">  ุณูููู ุจุฅููุงู MikroTik ูุฑุงูุจุฉ ุฃุฏุงุก ุฎูุงุฏู Kerio Control ุชููุงุฆููุง ุ ูุฅุฐุง ุชู ูุทุน ุงูุงุชุตุงู ุจููุทุฉ ุงูุฃููููุฉ ุ ุงูุชูู ุฅูู ุงูููุงุฉ ุงููุจุงุดุฑุฉ ุจุดูู ูุณุชูู ุ </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ุชู ูุดุฑ ุฎูุงุฏู Kerio Control ุนูู ุฎูุงุฏู DNS ุงูุฎุงุฑุฌูุฉ ุ ูุณุชุชููู MikroTik ูู ุชุชุจุน ุงูุชุบููุฑุงุช ูู ุนูุงููู IP ุงูุฎุงุตุฉ ุจูุง (ุนูู ุณุจูู ุงููุซุงู ุ ูู ุญุงูุฉ ุชุบููุฑ ุงููููุฑ ุงูุฎุงุต ุจู) ูุฅุฌุฑุงุก ุชุบููุฑุงุช ุจุดูู ูุณุชูู ุนูู ุงูุชูููู ุงูุฎุงุต ุจู (scriptSetIPSecSADstAddrFromDNS). </li></ol><br><br>  ูุฌุจ ุฃู ุฃููู ุนูู ุงูููุฑ ุฃู ูุฐุง ุงูููุงู ููุณ ุชุนูููููุง (ูู ุญูุซ ุงููุจุฏุฃ ุ ููุฏ ุชุนุฑูุช ุนูู ุฃุฌูุฒุฉ ุงูุชูุฌูู ูุฎุงุตุฉู ูุน MikroTik ุจุนุฏ ุดูุฑูู ููุท (ููุงูุฉ ุนุงู 2017) ูุจู ุฅูุดุงุก ุงูุชูููู) ููู ูุชูุงูู ุงูุฃุณุฆูุฉ "ููุงุฐุงุ" ุ ุณูููู ููุง ููุฑุฏ ูุตู ูุชูููู ุงูุนูู ูู MikroTik ุ ูุงูุฐู ูุณุชุฎุฏู ูู ูุคุณุณุฉ ุญููููุฉ. <br><br>  <b>ููุงุญุธุฉ:</b> <br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ููุงุญุชูุงุธ ุจุชุนูููุงุช ุจุงููุบุฉ ุงูุฑูุณูุฉ ุนูุฏ ููู ุฑูุฒ ุงูุจุฑูุงูุฌ ุงููุตู ุฅูู MikroTik ุ ูุจู ูุณุฎ ุงููุต ุฅูู ุงููุฎุฒู ุงููุคูุช ููุจู ุงูุฅุฏุฑุงุฌ ูู ุงููุฎุฒู ุงููุคูุช ุ ุชุฃูุฏ ูู ุชุดุบูู ุชุฎุทูุท ููุญุฉ ุงูููุงุชูุญ ุงูุฑูุณูุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ูุฌุฏุช ุฃู ุงูุจุฑุงูุฌ ุงููุตูุฉ ูุชุณุฌูู ุงูุฏุฎูู ุบูุฑ ุถุฑูุฑูุฉ ุ ูููููู ุงูุชุนููู ุฃู ุญุฐู ุงูุฃุณุทุฑ ุงูุชู ุชุญุชูู ุนูู "ุชุญุฐูุฑ ุงูุณุฌู" ู "ุฎุทุฃ ูู ุงูุณุฌู" ุ </li><li style=";text-align:right;direction:rtl">  ูุฏ ุชูุงุญุธ ุฃูุถูุง ุชุนููู "ุชุญุฐูุฑ ุงูุณุฌู" ู "ุฎุทุฃ ุงูุณุฌู" ูู ุงูููุฏ ุ ููุฐู ูุญุงููุฉ ูุฅุถุงูุฉ ุฅููุงููุฉ ุงุณุชุฎุฏุงู ุงูุชุณุฌูู ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉ ... </li></ol><br><br>  ูุฐูู ุฏุนููุง ูุจุฏุฃ: <br><br>  <b>ุงููุนููุงุช ุงูุฃุณุงุณูุฉ:</b> <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุดุจูุฉ ุงููุคุณุณุฉ ุงูุฃู (ุฎูู ููุฑูู) ูู 192.168.77.0/24 (ููุง ูุณุชุฎุฏู ุนููุงู ุงูุดุจูุฉ ุญูุซ ููุฌุฏ ููุฑูู ูู ุดุจูุฉ ุงููุคุณุณุฉ) </li><li style=";text-align:right;direction:rtl">  ุดุจูุฉ ุงููุฑูุน (ุฎูู MikroTik) - 192.168.11.0/24 </li><li style=";text-align:right;direction:rtl">  ุงูุดุจูุฉ ุงูุชู ุณูุชู ุชุนููู ุงูุดุจูุฉ ุงููุฑุนูุฉ ุฅูููุง ุนูุฏ ุงูุงุชุตุงู ุจู Kerio Control # 1 - 192.168.22.0/24 </li><li style=";text-align:right;direction:rtl">  ุงูุดุจูุฉ ุงูุชู ุณูุชู ุชุนููู ุงูุดุจูุฉ ุงููุฑุนูุฉ ุนูููุง ุนูุฏ ุงูุงุชุตุงู ุจู Kerio Control # 2 - 192.168.33.0/24 </li><li style=";text-align:right;direction:rtl">  ุนููุงู IP ูู ุชุฌูุน ISP # 1 (Kerio # 1) - 11.11.11.111 </li><li style=";text-align:right;direction:rtl">  ุนููุงู IP ูู ุชุฌูุน ISP # 2 (Kerio # 1) - 22.22.22.111 </li><li style=";text-align:right;direction:rtl">  ุนููุงู IP ูู ุชุฌูุน ISP # 1 (Kerio # 2) - 11.11.11.222 </li><li style=";text-align:right;direction:rtl">  ุนููุงู IP ูู ุชุฌูุน ISP # 2 (Kerio # 2) ูู 22.22.22.222 </li><li style=";text-align:right;direction:rtl">  ุนููุงู IP ูู ุชุฌูุน ISP # 3 (MikroTik) - 33.33.33.111 </li><li style=";text-align:right;direction:rtl">  ุนููุงู IP ูู ุชุฌูุน ISP # 4 (MikroTik) - 44.44.44.111 </li></ol><br>  ุฃูู ุดูุก ูุนูู ูู ุชูููู DDNS ุนูู MikroTik: <br><br><pre style=";text-align:right;direction:rtl"><code class="plaintext hljs">/ip cloud set ddns-enabled=yes</code> </pre> <br>  ูุธุฑูุง ูุญูููุฉ ุฃู MikroTik ูู ูููู ูู ุนููุงู IP ุซุงุจุช ุฃุจูุถ ุ ูุฅู ุงูุนูู ุงูุฅุถุงูู ููุชูููู ูุงูุจุฑุงูุฌ ุงููุตูุฉ ูุนุชูุฏ ุนูู ุงุณุชุฎุฏุงู DDNS. <br><br>  ูุฃูุถูุง --- --- ูุชู ุงุณุชุฎุฏุงู ุงูุณุญุงุจุฉ ูุชุญุฏูุฏ ุนููุงู IP ุงูุฎุงุฑุฌู ููููุฑูุชู ุ ูุงูุฐู ูุธูุฑ ููู ุนูู ุงูุฅูุชุฑูุช. <br><br>  ุงูุขู ุ ุฏุนููุง ูููู ุจุชููุฆุฉ Kerio Control # 1 ุ ุจุญูุซ ูุง ูุนูุฏ ุฅููู ูุงุญููุง: <br>  ูุฐูุจ ุฅูู ูุณู "ูุงุฌูุงุช" ููุถูู ูุงุฌูุฉ "ููู VPN" ุงูุฌุฏูุฏุฉ ... <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชูููู ุงูููู ูู ููุฑูู ูููุชุฑูู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  1. ูู ุญูู ุงูุงุณู ุ ูู ุจุชุนููู ุงุณู ูููุงุฌูุฉ ุ <br>  2. ุถุน ุงูููุชุงุญ ูู ุงูููุถุน "ุงูุณูุจู - ููุจู ููุท ุงูุงุชุตุงูุงุช ุงููุงุฑุฏุฉ" ุ <br>  3. ุงูุชุจ ุฅุฌุงุฒุฉ "IPSec" ุ <br>  4. ุนูุงูุฉ ุงูุชุจููุจ "ุงููุตุงุฏูุฉ": <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  4.1 ูู ุงูุญูู "ููุชุงุญ ูุญุฏุฏ ูุณุจููุง:" ุฃุฏุฎู ุนุจุงุฑุฉ ุงูููุชุงุญ ุงูุชู ุณูุชู ุงุณุชุฎุฏุงููุง ููุงุชุตุงู ุ </li><li style=";text-align:right;direction:rtl">  <b>ููุงุญุธุฉ:</b> <br><br>  ุฃูุตู ุจุดูู ูุงุทุน ุจุชุนููู ุฌููุน ุงูุนุจุงุฑุงุช ุงูุฑุฆูุณูุฉ ุนูู ุฌููุน ุฃููุงู VPN ุงูุชู ุชู ุฅูุดุงุคูุง ุนูู ุฎุงุฏู Kerio ูุญุฏุฏ ูุงุญุฏ! <br><br>  ูุฐุง ูุฑุฌุน ุฅูู ุญูููุฉ ุฃู ููุฑูู ูุฏูู ุฎุทุฃ ุนุงุฆู ุ ูุงูุฐู ูุชู ุงูุชุนุจูุฑ ุนูู ูู ูุง ููู. <br><br>  ุชุฎูู ุฃูู ูู ุชูููู Kerio ุ ููุง ูู ุญุงูุชู ุ ููุงู ุนุฏุฉ ูุงุฌูุงุช "ููู VPN" ุชู ุชูููููุง ููุงุชุตุงู ุจู MikroTik ุ ูุงูุชู ุชุฎุชูู ุนู ุจุนุถูุง ุงูุจุนุถ ููุท ูู ุงูุฅุนุฏุงุฏุงุช ุงูููุฌูุฏุฉ ูู ุญูู "ุงููุนุฑู ุงููุญูู:" (ุณูุชู ููุงูุดุชูุง ุฃุฏูุงู). <br><br>  ูุฐูู ุ ุนูุฏ ุฅูุดุงุก (ุณุฃุทูู ุนููู ุฐูู) ููู ูุงุฑุฏ ุ ุจุบุถ ุงููุธุฑ ุนู ุนููุงู IP ุงูุฎุงุฑุฌู ุงูุฐู ุณุชุชุตู ุจู Kerio ูุน MikroTik ุ ุณูููู Kerio (ูุณุจุจ ูุง) ุจุชูุดูุท ุงููุงุฌูุฉ ุงูุฃููู ุงูุชู ุชุธูุฑ ุ ูุฅุฐุง ูุงู ุนููุงู IP ุงููุญุฏุฏ ูู ุงูุฅุนุฏุงุฏุงุช ุงูููู ุนูู ุฌุงูุจ ููุฑูู ูุฎุชูู ุนู ุงูููู ุงูุฐู ูุดูุฑ ุฅููู MikroTik ุ ุงูููู ุบูุฑ ููุธู. <br><br>  ููู ุญุงูุฉ ุงูุฅุดุงุฑุฉ ุฅูู ุนุจุงุฑุงุช ุฑุฆูุณูุฉ ูุฎุชููุฉ ูุฌููุน ุงูุฃููุงู ุ ุชุชููู ูุฐู ุงููุดููุฉ. </li><li style=";text-align:right;direction:rtl">  4.2 ูู ุญูู "ุงููุนุฑู ุงููุญูู:" ุ ุฃุฏุฎู ุนููุงู IP ูู ุชุฌูุน ุนูุงููู ISP # 1 (ูู ุงููุซุงู 11.11.11.111) ุงููุนูู ููุงุฌูุฉ Keran Control # 1 WAN ุ ุงูุชู ุณุชุตู ุฅูููุง MikroTik ุ </li><li style=";text-align:right;direction:rtl">  4.3 ูู ุญูู "ุงููุนุฑู ุงูุจุนูุฏ:" ุ ุฃุฏุฎู FQDN ุ ูุงูุฐู ุชู ุงูุญุตูู ุนููู ุจูุงุณุทุฉ MikroTik ูู DDNS (IP ---&gt; Cloud ---&gt; DNS Name).  ูุณูุญ ููุง ูุฐุง ุงูุฅุนุฏุงุฏ ุจุนุฏู ุงูุงูุชูุงู ุจููููุฉ ูุตูู ISP MikroTik ุฅูู Kerio ุ </li><li style=";text-align:right;direction:rtl">  4.4 ูู ุญูู "ุชุดููุฑ ุงููุฑุญูุฉ ุงูุฃููู (IKE):" ุญุฏุฏ aes128-sha1-modp2048 ูู ุงููุงุฆูุฉ ุ </li><li style=";text-align:right;direction:rtl">  4.5 ูู ุญูู "ุงููุฑุญูุฉ ุงูุซุงููุฉ ูู ุงูุชุดููุฑ (ESP):" ุญุฏุฏ 3des-sha1-modp2048 ูู ุงููุงุฆูุฉ ุ </li><li style=";text-align:right;direction:rtl">  <b>ููุงุญุธุฉ:</b> <br>  ุชุญุฑูุฑ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ ุงููุณุชุฎุฏูุฉ ูู ุฎูุงู ุฒุฑ "ุชุบููุฑ ..." ุ <br>  ูุชู ุงุฎุชูุงุฑ ูู ูู ุงูุฃุตูุงุฑ ุจุงุณุชุฎุฏุงู "ุฃุณููุจ ุจุฏุณ ุงูุนูููุฉ". </li></ul><br>  5. ุนูุงูุฉ ุงูุชุจููุจ "ุงูุดุจูุงุช ุงูุจุนูุฏุฉ": <br><br>  ุณูููู ููุง ุจุฅุฏุฎุงู ุนููุงู IP ุงูุฎุงุต ุจุงูุดุจูุฉ ุงููุญููุฉ ุงูุฐู ุณุชุณุชุฎุฏูู MikroTik ุนูุฏ ุงูุงุชุตุงู ุจุฎุงุฏู Kerio Control ุงููุญุฏุฏ (ูู ุงููุซุงู - 192.168.22.0/24). <br>  ููู!  ูู ูู ุงูุจุงูู (ูู ุญุงูุชู ูุชู ุชุญุฏูุฏูุง ุจูุงุณุทุฉ ุนุฏุฏ ูุฒูุฏู ุฎุฏูุฉ ุงูุฅูุชุฑูุช ูู ููุฑูู) ูู ุงูุฃููุงู ุนูู MikroTik ุ ุนูู ุฎุงุฏู ููุฑูู ุ ูุฌุจ ุงูุฅุดุงุฑุฉ ุฅูู ููุณ ุนููุงู IP! <br><br>  ุงุณูุญูุง ูู ุฃู ุฃุฐูุฑู ุจุฃู ูุฐุง ูุฑุฌุน ุฅูู ุงูุญุงุฌุฉ ุฅูู ุชูููู ุงูุทุฑูู ุฅูู ูุฐู ุงูุดุจูุฉ ูู ุดุจูุฉ ุงูููุชุจ ุงูุฑุฆูุณู. <br><br>  6. ุนูุงูุฉ ุงูุชุจููุจ "ุดุจูุงุช ุงูููุงุทู ุงููุญููุฉ": <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  6.1 ุฃูุบ ุชุญุฏูุฏ ุงููุฑุจุน "ุงุณุชุฎุฏุงู ุงูุดุจูุงุช ุงููุญููุฉ ุงูููุชุดูุฉ ุชููุงุฆููุง" ุ </li><li style=";text-align:right;direction:rtl">  6.2 ูู ุจุชุนููู ุฎุงูุฉ ุงูุงุฎุชูุงุฑ "ุงุณุชุฎุฏุงู ุงูุดุจูุงุช ุงููุฎุตุตุฉ:" ุ ูุฃุถู ุนููุงู ุงูุดุจูุฉ "ูุบุทู" ูุฌููุนุฉ ูุงููุฉ ูู ุงูุนูุงููู ุงููุณุชุฎุฏูุฉ ูู ุงูุดุจูุฉ ุงููุญููุฉ ูุฑุงุก Kerio Control ุฅูู ูุงุฆูุฉ ุงูุดุจูุงุช (ูู ุงููุซุงู - 192.168.0.0/16). </li></ul><br>  ููุฑุฑ ุฌููุน ุงูุฎุทูุงุช ุงููุฐููุฑุฉ ุฃุนูุงู ููููู ุงูุซุงูู ุนูู ููุณ ุฎุงุฏู ููุฑูู. <br><br>  ุณูุฎุชูู ุชูููู ุงูููู ุงูุซุงูู ููุท ุนู ุทุฑูู ุงุณุชุฎุฏุงู ุนุจุงุฑุฉ ูุฑูุฑ ูุฎุชููุฉ (ุงูููุฑุฉ 4.1) ูุนููุงู IP ุฎุงุฑุฌู ูุฎุชูู ุนู ุชุฌูุน ุนูุงููู ISP # 2 (ุงูููุฑุฉ 4.2) (ูู ุงููุซุงู 22.22.22.111). <br><br>  ุชุชุดุงุจู ุฅุนุฏุงุฏุงุช Kerio Control # 2 ูุน ุชูู ุงูููุถุญุฉ ุฃุนูุงู ุ ุจุงุณุชุซูุงุก ุนููุงู ุงูุดุจูุฉ ุงููุดุงุฑ ุฅููู ูู ุนูุงูุฉ ุชุจููุจ ุงูุดุจูุงุช ุงูุจุนูุฏุฉ (ุงูุตูุญุฉ 5) (ูู ุงููุซุงู ุ 192.168.33.0/24) ุ ูุจูุงุกู ุนูู ุฐูู ุ ุนูุงููู IP ูู ุงููุนุฑู ุงููุญูู: ุงูุญูู ( ุงูููุฑุฉ 4.2) ุ ูุงูุชู ูุฌุจ ุชุญุฏูุฏูุง ูู ุนูุงููู IP ุงููุนููุฉ ููุงุฌูุงุช Kerio Control # 2 WAN (ูู ุงููุซุงู ุ 11.11.11.222 ู 22.22.22.222). <br></div></div><br>  ุจุนุฏ ุฐูู ุ ูููู ุจุฅูุดุงุก ูุงุนุฏุฉ ุงูุณูุงุญ ูุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุง ุนูู Kerio ูู MikroTik ... <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุจููุบ ุงููุงุนุฏุฉ ูู ููุฑูู ุงูุชุญูู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  ูุฐูุจ ุฅูู ูุณู "ููุงุนุฏ ุงููุฑูุฑ" ูููุดุฆ ูุงุนุฏุฉ ุฌุฏูุฏุฉ ูุน ุงููุนููุงุช ุงูุชุงููุฉ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงููุตุฏุฑ - ุชุดูุฑ ุฅูู FQDN ุงูุชู ุชููุงูุง MikroTik ูุฏููุง ูู DDNS ุ </li><li style=";text-align:right;direction:rtl">  ุงููุฌูุฉ - ุฌุฏุงุฑ ุงูุญูุงูุฉ </li><li style=";text-align:right;direction:rtl">  ุฎุฏูุฉ - ุจููุบ. </li><li style=";text-align:right;direction:rtl">  ููููู ุฃูุถูุง ุชุญุฏูุฏ ุฅุตุฏุงุฑ IP (IPv4) ุ ููู ูุฐุง ููุณ ุถุฑูุฑููุง. </li></ul><br>  ูููู ุจุญูุธ ุงููุงุนุฏุฉ ุจุงุณู ูููููุฉ ูู ูุณุญุจูุง ุฅูู ุฃุนูู ูุงุฆูุฉ ุงูููุงุนุฏ. <br><br>  ููุฑุฑ ููุณ ุงูุฅุฌุฑุงุก ุนูู ุฎุงุฏู ููุฑูู ุงูุซุงูู. <br></div></div><br>  ูุง ุชูุณ ุชุณุฌูู ุงููุณุงุฑุงุช ุนูู ุงูุดุจูุฉ ุฎูู MikroTik ูู ุงููุญููุงุช ุฃู ุฃุฌูุฒุฉ ุงูุชูุฌูู ุนูู ุฌุงูุจ ุงูููุชุจ ุงูุฑุฆูุณู ุญุชู ุชุนุฑู ุดุจูุฉ ุงูููุชุจ ุงูุฑุฆูุณู ููุงู ุชูุฌูู ุญุฑูุฉ ุงููุฑูุฑ (ูู ุญุงูุชู ุ ููุฐู ุทุฑููุชุงู ุซุงุจุชุชุงู ุนูู ุงูุดุจูุงุช 192.168.22.0/24 ู 192.168.33.0/24). <br><br>  ูู ุงูููุชุจ ุงูุฑุฆูุณู ุ ูููุง ุจูู ุดูุก ุ ูุงูุขู ููุชูู ุฅูู MikroTik. <br><br>  ููุจุฏุฃ ุจุฅูุดุงุก ูุงุฆูุงุช ุงูุชูููู ุงูุฃุณุงุณูุฉ ูุชูุธูู ูุงุฎุชุจุงุฑ ููู VPN. <br><br>  ุงูุฎุทูุฉ ุงูุฃููู ูู ุฅูุดุงุก ูุงุฆูุฉ ุนูุงููู ุดุจูุฉ ูุฑุนูุฉ ูุญููุฉ.  ุณูู ูุณุชุฎุฏููุง ูู ููุงุนุฏ ุฌุฏุงุฑ ุงูุญูุงูุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip firewall address-list #      MikroTik, # IP-      DHCP add address=192.168.11.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #1 # (     VPN-  Kerio Control #1, #   " ") add address=192.168.22.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #2 # (     VPN-  Kerio Control #2, #   " ") add address=192.168.33.0/24 list="Local subnet"</code> </pre> <br>  ุจุนุฏ ุฐูู ุ ูู ุจุฅูุดุงุก ูุงุนุฏุฉ ุงูุณูุงุญ ูุญุฑูุฉ ูุฑูุฑ IKE ููุถุนูุง ูู ุฃุนูู ูุงุฆูุฉ ุงูููุงุนุฏ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">add action=accept chain=input comment="VPN Allow IKE" dst-port=500 protocol=udp</code> </pre> <br>  ุซู ุฃุถู ูุงุนุฏุชูู ุฅูู "ุนุงูู ุชุตููุฉ ุฌุฏุงุฑ ุงูุญูุงูุฉ" ููุนูู ูุน ุญุฑูุฉ ูุฑูุฑ VPN ... <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip firewall filter add action=accept chain=forward comment="VPN In IpSec" dst-address-list=\ "Local subnet" ipsec-policy=in,ipsec src-address=192.168.0.0/16 \ src-address-list="!Local subnet" add action=accept chain=forward comment="VPN Out" dst-address=192.168.0.0/16 \ dst-address-list="!Local subnet" src-address-list="Local subnet"</code> </pre> <br>  ... ูููููู ุฅูู ููุถุน <b>ุฃุนูู</b> ูุจุงุดุฑุฉ <b>ูู ูุงุนุฏุฉ ุงูุฅุณูุงุท</b> ุ ูุงูุฐู ูุญุธุฑ ุญุฑูุฉ ุงููุฑูุฑ ุงููุงุฑุฏุฉ ูู ุฎุงุฑุฌ ุงูุดุจูุฉ ุงููุญููุฉ.  ูู ุงูุชูููู ุงูุงูุชุฑุงุถู ุงูุฎุงุต ุจู ุ ูุงู ูุน ุงูุชุนููู "defconf: ุฅููุงุช ูู ุดูุก ูุง ูุฃุชู ูู LAN" <br><br>  ุงูุชูู ุฅูู Firewall Mangle ููู ุจุฅูุดุงุก ุงูููุงุนุฏ ุงูุชุงููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip firewall mangle #      , #  ... add action=mark-connection chain=prerouting comment="VPN In" \ new-connection-mark=VPN_conn_in passthrough=no src-address=192.168.0.0/16 \ src-address-list="!Local subnet" # ...   add action=mark-routing chain=output comment="VPN In" connection-mark=\ VPN_conn_in new-routing-mark=VPN_route_in passthrough=yes #     MikroTik      . #     NAT. add action=mark-connection chain=postrouting comment="VPN Out" dst-address=\ 192.168.0.0/16 dst-address-list="!Local subnet" new-connection-mark=\ VPN_conn_out passthrough=no</code> </pre> <br>  ุจุนุฏ ุฐูู ุ ููุงุญุธ ูู ุฌุฏุงุฑ ุงูุญูุงูุฉ NAT: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip firewall nat #     MikroTik     #      , #    Kerio- (:  Kerio Control #1 - 192.168.22.0/24,  Kerio Control #2 - 192.168.33.0/24) # ! # comment=KerioVpnNatOut   ! add action=netmap chain=srcnat comment=KerioVpnNatOut connection-mark=\ VPN_conn_out to-addresses=192.168.22.0/24 #     MikroTik     #          MikroTik add action=netmap chain=dstnat comment=KerioVpnNatIn connection-mark=\ VPN_conn_in to-addresses=192.168.11.0/24 #  MikroTik  Kerio- add action=accept chain=srcnat comment=KerioVpnNatPing out-interface-list=WAN protocol=icmp</code> </pre> <br>  <b>ููู!</b>  ูุฌุจ ูุถุน ูุฐู ุงูููุงุนุฏ ููู ููุงุนุฏ ุงูุชููุฑ. <br><br>  ููุชูู ุงูุขู ุฅูู ูุณู IP ---&gt; IPSec ุ ุญูุซ ูุญุชุงุฌ ุฅูู ุฅูุดุงุก ูุฌููุนุงุช ูุงูุจ ุณูุงุณุฉ ุฃู ูุธูุฑ ุฃู ุณูุงุณุฉ (ุณุฃูุงูุด ุงูุบุฑุถ ูููุง ูุงุญููุง) ูุงูุชุฑุงุญ ูุฅุนุฏุงุฏ ุชุดููุฑ ุงููุฑุญูุฉ 2. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุชุฑุงุญ IP IPSEC</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip ipsec proposal add enc-algorithms=3des name=KerioVPNProposal#01 pfs-group=modp2048</code> </pre> <br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุฌููุนุฉ ุณูุงุณุฉ IP IPSEC</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip ipsec policy group add name=1 add name=2 add name=3 add name=4</code> </pre> <br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">IP IPSEC ุงูุฃูุฑุงู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip ipsec peer add address=11.11.11.111/32 comment=vs01-i01-01.domain.ru exchange-mode=\ main-l2tp local-address=33.33.33.111 my-id=\ fqdn:mikrotik.sn.mynetname.net policy-template-group=1 profile=\ profile_4 secret=pass1111</code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุณูุงุณุฉ IP IPSEC</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip ipsec policy add comment=KerioVPNPolicy dst-address=192.168.77.0/24 proposal=KerioVPNProposal#01 \ sa-dst-address=11.11.11.111 sa-src-address=33.33.33.111 src-address=\ 192.168.22.0/24 tunnel=yes</code> </pre> <br></div></div><br>  ุงูุชุนููู: <br><br>  1. / ip ipsec ุงูููุชุฑุญ - ุฃุฏุฎู ููุณ ูุนููุงุช ุงูุชุดููุฑ ุงูุชู ุญุฏุฏูุงูุง ุนูุฏ ุชูููู Kerio Control ูู ุญูู "Phase 2 Encryption (ESP):". <br><br>  <b>ููุงุญุธุฉ:</b> <br><br>  ุงูุชุจู ุฅูู ุงููุนููุฉ "name = KerioVPNProposal # 01". <br><br>  ููุณ ูู ุงูุถุฑูุฑู ุงุณุชุฎุฏุงู ูุฐุง ุงูุงุณู ุนูู ูุฌู ุงูุชุญุฏูุฏ ุ ูููู ุฅุฐุง ูุฑุฑุช ุงุณุชุฎุฏุงู ุงุณู ุขุฎุฑ ุ ูุจุนุฏ ุชุบููุฑู ุ ุณุชุญุชุงุฌ ุฅูู ุงูุชุญูู ุ ูุฅุฐุง ูุฒู ุงูุฃูุฑ ุ ูู ุจุชุบููุฑ ุฅุนุฏุงุฏ ุณูุงุณุฉ IPSec ุงููุฑุชุจุทุฉ ุ ุจุงูุฅุถุงูุฉ ุฅูู ุชุบููุฑ ุงููููุฉ ุงููุนููุฉ ููุชุบูุฑ DefKerioPropName ูู ุงูุจุฑูุงูุฌ ุงููุตู scriptCheckActiveVpnServer ุ ูุงูุฐู ุณูุชู ููุงูุดุชู ุงูููุงู ูุฐูู. <br><br>  (ูู ุงููุงูุน ุ ูุชู ุงุณุชุฎุฏุงู ูุนุธู ุฃุณูุงุก ูุชุนูููุงุช ุงููุงุฆูุงุช ูู ุงูุชูุตูู ุงูููุตูู ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ุ ูุฐุง ูุฅู ุฅุนุงุฏุฉ ุชุณููุชูุง ูุฏ ุชุณุจุจ ูู ุจุนุถ ุงูุฅุฒุนุงุฌ ุจุณุจุจ ุงูุญุงุฌุฉ ุฅูู ุฅุฌุฑุงุก ุชุบููุฑุงุช ุนูู ุดูุฑุฉ ุงูุจุฑูุงูุฌ ุงููุตู. ุณุฃุญุงูู ุชูุฏูู ููุงุญุธุงุช ููุงุณุจุฉ ูู ุงููุต ูุชุณููู ุงูุจุญุซ ุนู ูุฐู ุงููุงุฆูุงุช.) <br><br>  2. / IP IPSEC ุณูุงุณุฉ ุงููุฌููุนุฉ <br><br>  ูุฑุฌุน ุฅูุดุงุก ุงููุฌููุนุงุช ุฅูู ุญูููุฉ ุฃููุง ูู ุงููุณุชูุจู ุณูููู ุจูุนุงูุฌุฉ ุฃุณูุงุฆูู (1 ุ 2 ุ ... ู) ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ูุงุณุชุฎุฏุงููุง ูุชุญุฏูุฏ ุฃููููุงุช ุนูุงููู IP ูุฎูุงุฏู ููุฑูู ุงูุชู ุณูุตู ุฅูููุง. <br><br>  ุฃูุง ุฎูู ุฃุฑุจุน ูุฌููุนุงุช ูู ููุช ูุงุญุฏ ู  ูุฏู ูุฒูุฏุงู ูุฎุฏูุงุช ุงูุฅูุชุฑูุช ุ ูุน ูุฌูุฏ ุงุซููู ูู ุนูุงููู IP ุงูุฎุงุฑุฌูุฉ ุนูู ูู ูู ููุฑูู.  ูู ูุฐู ุงููุฑุญูุฉ ุ ูุญู ูุณุชุฎุฏู ูุฌููุนุฉ ูุงุญุฏุฉ ููุท ุญุชู ุงูุขู. <br><br>  3. / IP IPSEC ุงูุฃูุฑุงู <br><br>  ูู ุงููุธูุฑ ุ ุญุฏุฏ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุนููุงู - ุนููุงู IP ูููุฑูู ุ ูุงูุฐู ุณูุชู ุงูุงุชุตุงู ุจู ูุน MikroTik.  ูุฌุจ ุชุญุฏูุฏ ููุณ ุงูุนููุงู ุงูุฐู ุฃุฏุฎููุงู ูู / ip ipsec policy sa-dst-address ุ ููุท ูุน ุงูููุงุน "/ 32" ุ </li><li style=";text-align:right;direction:rtl">  ุงูุนููุงู ุงููุญูู - ุนููุงู IP ุงูุฎุงุต ุจู MikroTik ุ ูุงูุฐู ุณูุชู ุงููุตูู ุฅูู Kerio ููู.  ูุฌุจ ุชุญุฏูุฏ ููุณ ุงูุนููุงู ุงูุฐู ุฃุฏุฎููุงู ูู / ip ipsec policy sa-src-address ุ </li><li style=";text-align:right;direction:rtl">  ุงููุตุงุฏูุฉ  ุงูุทุฑููุฉ - ุญุฏุฏ "ุงูููุชุงุญ ุงููุดุชุฑู ูุณุจููุง" ูู ุงููุงุฆูุฉ ุ </li><li style=";text-align:right;direction:rtl">  ูุถุน ุงูุชุจุงุฏู - ุญุฏุฏ main-l2tp ูู ุงููุงุฆูุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ุชู ุถุจุทู ุ ูู ุจุฅูุบุงุก ุชุญุฏูุฏ ุงููุฑุจุน "ุงูุณูุจู" ุ </li><li style=";text-align:right;direction:rtl">  ุณุฑ - ุฃุฏุฎู ุนุจุงุฑุฉ ุงููุฑูุฑ ุงูุชู ุฃุฏุฎููุงูุง ุนูุฏูุง ูููุง ุจุชููุฆุฉ ูุงุฌูุฉ VPN ุนูู ููุฑูู ุ ูู ุนูุงูุฉ ุงูุชุจููุจ "ุงููุตุงุฏูุฉ" ุ ูู ุงูุญูู "ููุชุงุญ ูุญุฏุฏ ูุณุจููุง:" ุ </li><li style=";text-align:right;direction:rtl">  ูุฌููุนุฉ ููุงูุจ ุงูุณูุงุณุงุช - ุงุฎุชุฑ ูู ุงููุงุฆูุฉ ุงููุฌููุนุฉ ุงูุชู ุฃูุดุฃูุงูุง ุณุงุจููุง ุจุงุณู "1" ุ </li><li style=";text-align:right;direction:rtl">  ูู ุจุฅูุบุงุก ุชุญุฏูุฏ NAT Traversal ุ </li><li style=";text-align:right;direction:rtl">  ููุน ูููุชู - ุญุฏุฏ ุงููููุฉ "fqdn" ูู ุงููุงุฆูุฉ ุ </li><li style=";text-align:right;direction:rtl">  ูููุชู - ุฃุฏุฎู FQDN ุงููุนูู ูู ูุจู MikroTik ูู DDNS ุ </li><li style=";text-align:right;direction:rtl">  ูู ุนูุงูุฉ ุงูุชุจููุจ "ุงูุชุดููุฑ" ุ ุญุฏุฏ ูุนููุงุช ุงูุชุดููุฑ ุงูุชู ุฃุฏุฎููุงูุง ุนูุฏูุง ูููุง ุจุชูููู ูุงุฌูุฉ VPN ุนูู ููุฑูู ุ ูู ุนูุงูุฉ ุงูุชุจููุจ "ุงููุตุงุฏูุฉ" ุ ูู ุญูู "ุงููุฑุญูุฉ ุงูุฃููู (IKE):" ุ </li><li style=";text-align:right;direction:rtl">  ุชุนููู ( <b>ุชุญุฐูุฑ! ุชุณุชุฎุฏู ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ!</b> ). </li></ul><br>  ูู ุงูุชุนููู ุ ุฃุดูุฑ ุฅูู FQDN ุงูููู ุงููุงูู ููุฎูุงุฏู ุงูุฎุงุตุฉ ุจู ุ ูุงูุชู ูุชู ูุดุฑูุง ุนูู ุฎูุงุฏู DNS ุงูุชู ุชุฎุฏู ููุทูุชู ุงูุฎุงุฑุฌูุฉ. <br><br>  ุจุงูุฅุถุงูุฉ ุฅูู ุงุณุชุฎุฏุงู ูุฐุง ุงูุชูููู ุ ูุชูุญ ูู ูุฐุง ุงูุงุญุชูุงุธ ุจูุนูููุงุช ูุญุฏุซุฉ ุนู ุนูุงููู IP ุงูุฎุงุฑุฌูุฉ ูุฎูุงุฏู Kerio ุงููุณุชุฎุฏูุฉ (ุฃุฑูุฏ ููุท ุชุบููุฑ ุนููุงู IP ุนูู ุฎุงุฏู DNS ุงูุฎุงุฑุฌู ูุณูุชู ุชุบููุฑู ุชููุงุฆููุง ุฅูู MikroTik (ุงูููุงูุฉ <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a></b> )). <br><br>  ุจุงููุณุจุฉ ูุฃููุฆู ุงูุฐูู ูู ูุณูู ููุบุงูุฉ ูููู ุ ุฃูุชุจุณ ุฑูุฒ ุงูุนูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptSetIPSecSADstAddrFromDNS owner=\ admin policy=read,write</code> </pre><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุจุฑูุงูุฌ ุงููุตู ุณุฑุฏ โโุงูุจุฑูุงูุฌ ุงููุตู SetIPSecSADstAddrFromDNS</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">:if ([:len [/system script job find script=SetIPSecSADstAddrFromDNS]]&gt;1) do={ :error } :local DnsNameFromComment :local ResolvedIpFromComment :local ResolvedIpWithMaskFromComment :local IpPeerAddr :foreach IpSecPeerCount in=[/ip ipsec peer find] do={ :set DnsNameFromComment [/ip ipsec peer get $IpSecPeerCount comment] :if ($DnsNameFromComment!="") do={ :do { :set ResolvedIpFromComment [:resolve $DnsNameFromComment] :set ResolvedIpWithMaskFromComment ($ResolvedIpFromComment . "/32") :set IpPeerAddr [/ip ipsec peer get $IpSecPeerCount address] :if ($ResolvedIpWithMaskFromComment!=$IpPeerAddr) do={ :log warning ("[SetIPSecSADstAddrFromDNS]     " . DnsNameFromComment . "  IP-  " . $IpPeerAddr . "  " . $ResolvedIpFromComment) #:log warning ("[SetIPSecSADstAddrFromDNS] In the peer to the server " . DnsNameFromComment . " changed IP address from " . $IpPeerAddr . " on " . $ResolvedIpFromComment) /ip ipsec peer set $IpSecPeerCount address=$ResolvedIpWithMaskFromComment } } on-error={ :set ResolvedIpFromComment "unknown" :log error ("[SetIPSecSADstAddrFromDNS]     " . $DnsNameFromComment) #:log error ("[SetIPSecSADstAddrFromDNS] Cant resolve name " . $DnsNameFromComment) } } } :log warning ("[SetIPSecSADstAddrFromDNS]  IP- VPN- ") #:log warning ("[SetIPSecSADstAddrFromDNS] The IP-addresses of the VPN-servers are checked")</code> </pre><br></div></div><br>  <b>ุงููุงุนุฏุฉ ุงูุฃุณุงุณูุฉ ุงูุชู ุชูุทุจู ุนูู ุงูุชุนููู ูู ุงูุฃูุฑุงู</b> ูู ุฃู ุงูุงุณู ูุฌุจ ุฃู ูุจุฏุฃ ุจุฃูุฉ ุฃุญุฑู ู / ุฃู ุฃุฑูุงู ุ ุจุฏูู ูุณุงูุงุช ุ ูุชุจูุนูุง <b>ูุงุตูุฉ ุฅูุฒุงููุฉ</b> ("-") ุ ูุชุจูุนุฉ ุจุฃู ุนุฏุฏ ูู ุงูุฃุญุฑู ุงูุชุนุณููุฉ. <br><br>  ุฃูุง ุงุณุชุฎุฏู ุงูุชูุณูู ุงูุชุงูู: <br><br>  vsNN-pNN-NN.domain.ru <br><br>  ุญูุซ: <br><br>  vsNN - vpn-server #NN (ุชุชู ูุนุงูุฌุฉ ูุฐุง ุงูุฌุฒุก ูู ุงูุชุนููู ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ูุงุณุชุฎุฏุงูู ูู IP ---&gt; ุฌุฏุงุฑ ุงูุญูุงูุฉ ---&gt; ููุงุฆู ุงูุนูุงููู (ุงูุธุฑ ุฃุฏูุงู)) ุ <br>  pNN - ISP #NNุ <br>  NN - ุงูุฑูู ุงูุชุณูุณูู ูุนููุงู IP ุงูุฎุงุฑุฌู ูู ูุฌููุนุฉ ุงูุนูุงููู ุงูุชู ุฃุตุฏุฑูุง ูู ุงููุฒูุฏ ุนูู Kerio ุ <br><br>  4. / IP IPSEC ุงูุณูุงุณุฉ <br><br>  ูู ุงูุณูุงุณุฉ ุ ูุนุฑูู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุชูููุช ุงูุตููู  ุงูุนููุงู - ุนููุงู ุงูุดุจูุฉ ูุฑุงุก ููุฑูู (ุนููุงู ุงูุชูููุช ุงูุตููู) ุ </li><li style=";text-align:right;direction:rtl">  Src.  ุงูุนููุงู - ุนููุงู ุงูุดุจูุฉ ุงูุฐู ุณุชุญุฌุจู MikroTik (ุฑุงุฌุน ุฅุนุฏุงุฏุงุช IP ---&gt; ุฌุฏุงุฑ ุงูุญูุงูุฉ ---&gt; NAT ุฃุฏูุงู) ุดุจูุชูุง ุงููุญููุฉ (ุนููุงู src).  ุณูููู ุนููุงู ุงูุดุจูุฉ ูุฑุฆููุง ูู ุฌุงูุจ ููุฑูู (ุญุฏุฏูุงู ุนูุฏ ุชููุฆุฉ ูุงุฌูุฉ VPN ุนูู ููุฑูู ุ ูู ุนูุงูุฉ ุงูุชุจููุจ ุงูุดุจูุงุช ุงูุจุนูุฏุฉ) ุ </li><li style=";text-align:right;direction:rtl">  ุงูุจุฑูุชูููู - 255 (ุงููู) ุ </li><li style=";text-align:right;direction:rtl">  ุงูุนูู - ุชุดููุฑ. </li><li style=";text-align:right;direction:rtl">  ุงููุณุชูู - ุชุชุทูุจ ุ </li><li style=";text-align:right;direction:rtl">  ุจุฑูุชููููุงุช IPSec - espุ </li><li style=";text-align:right;direction:rtl">  ุถุจุท ููู ุงููุนููุฉ = ูุนู ุ </li><li style=";text-align:right;direction:rtl">  SA Src.  ุงูุนููุงู - ุนููุงู IP ุงูุฎุงุฑุฌู ุงูุฎุงุต ุจู MikroTik ุ ูุงูุฐู ุณูุชู ุงููุตูู ุฅูู Kerio ููู (ุนููุงู sa-src) ุ </li><li style=";text-align:right;direction:rtl">  SA Dst.  ุงูุนููุงู - ุนููุงู IP ูู Kerio ุ ูุงูุฐู ุณูุชู ุงูุงุชุตุงู ุจู MikroTik (sa-dst-address) ุ </li><li style=";text-align:right;direction:rtl">  Proposal - ุฃุฏุฎู ุงููููุฉ ุงููุนููุฉ ููุนููุฉ ุงูุงุณู ูู ูุณู ุงูุชุฑุงุญ ip / ip ipsec (ูู ูุฐุง ุงูุชูููู - KerioVPNProposal # 01) ุ </li><li style=";text-align:right;direction:rtl">  ุชุนููู ( <b>ุชุญุฐูุฑ! ูุณุชุฎุฏู ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ!</b> ) - KerioVPNPolicy. </li></ul><br>  ุฅุฐุง ุชู ูู ุดูุก ุจุดูู ุตุญูุญ ุ ุซู ุจุนุฏ ุญูุธ ุงูุณูุงุณุฉ ุ ูุฌุจ ุฃู ุชุธูุฑ ุงููููุฉ "ุงููุญุฏุฏุฉ" ูู ุญูู "PH2 State" ุ ููุง ูุดูุฑ ุฅูู ุชุซุจูุช ููุงุฉ VPN ุจูู MikroTik ู Kerio. <br>  ููููู ุงูุชุญูู ูู ุฐูู ุนู ุทุฑูู ุงูุชุญูู ูู ุญุงูุฉ ูุงุฌูุฉ VPN ูู Kerio Control.  ููุงู ุ ูู ุญูู "ุงููุนูููุงุช" ุ ููุงุจู ุงููุงุฌูุฉ ุงูุชู ุชู ุฅุฌุฑุงุก ุงูุงุชุตุงู ุจูุง ุ ูุฌุจ ุฃู ูุธูุฑ ุงูููุด "ุงุชุตุงู IP_your_MikroTik". <br><br>  ููุงุตู ... <br><br>  ุงูุขู ุณููุดุฆ ูุธุฑุงุก ูุฌููุน ุนูุงููู IP ุงููุชุจููุฉ ูุฎูุงุฏู Kerio (ูู ุงูุชูููู ุงูุฎุงุต ุจู ุ ูู ุงูุถุฑูุฑู ุฅูุดุงุก ุซูุงุซุฉ ูุธุงุฆุฑ ุฃุฎุฑู). <br><br>  ููููุงู ุจุฐูู ุ ูุญุชุงุฌ ุฅูู ุชูุฑุงุฑ ุฌููุน ุงูุฎุทูุงุช ุงููุดุงุฑ ุฅูููุง ูู ุงูููุฑุฉ 3 (/ ip ipsec peer) ุ ูููู ูุฌุจ ุงูุงูุชุจุงู ุฅูู ุงูุชุบููุฑุงุช ุงูุชุงููุฉ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุนููุงู - ุชุบููุฑ ุนููุงู IP ููุฑูู. </li><li style=";text-align:right;direction:rtl">  ุณุฑ - ุฃุฏุฎู ุนุจุงุฑุฉ ุงููุฑูุฑ ุงููุชุนููุฉ ุจุงูุงุชุตุงู ุงูุฌุงุฑู ุฅูุดุงุคู (pass2222ุ pass3333ุ ... passNNNN)ุ </li><li style=";text-align:right;direction:rtl">  ูุฌููุนุฉ ููุงูุจ ุงูุณูุงุณุฉ - ุญุฏุฏ ุงููุฌููุนุฉ ุงูุชุงููุฉ ูู ุงููุงุฆูุฉ ูู ุงููุงุฆูุฉ (2 ุ 3 ุ ... ู). </li></ul><br>  <b>ููุงุญุธุฉ:</b> <br><br>  ุซู ููููู ุชุบููุฑ ุฃููููุฉ ุงูุฎูุงุฏู ุงูุฎุงุตุฉ ุจู ูู ุฃู ููุช ุนู ุทุฑูู ุชุบููุฑ ุงููุฌููุนุฉ ูู ุฅุนุฏุงุฏุงุช ุงููุธูุฑ. <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุนููู - ูู ุญุงูุชู ูุชุบูุฑ ุฅูู ุฎุงุฏู Kerio ุขุฎุฑ FQDN. </li></ul><br>  ูุชู ุฅุฏุฎุงู ุฌููุน ุงููุนููุงุช ุงูุฃุฎุฑู ููุง ูู ุงูุนูุฏ ุงูุฃูู.  ุชุชู ูุนุงูุฌุฉ ุชูู ุงูุชู ุณุชุญุชุงุฌ ุฅูู ุชุบููุฑ ุจูุงุณุทุฉ ุงูุจุฑุงูุฌ ุงููุตูุฉ ูููููู ูุณุฎูุง ุฏูู ุชุบููุฑ ูู ุงูููุช ุงูุญุงูู. <br><br>  ุงูุฎุทูุฉ ุงูุฃุฎูุฑุฉ ููุชูููู ูุจู ุชูุตูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ุจุงูุนูู ูู ุฌุนู MikroTik ูุนูู ููุณุชูุฏุน ููุซูุงุจุช ุ ูุงูุชู ุณูู ูุณุชุฎุฏููุง ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ... <br>  ุฃุถู ูุงุฆูุชูู ุฅูู ููุงุฆู ุนูุงููู ุฌุฏุงุฑ ุงูุญูุงูุฉ ( <b>ุชุญุฐูุฑ! ูุณุชุฎุฏู ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ!</b> ): <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/ip firewall address-list add address=192.168.22.0/24 list=vs01 add address=192.168.33.0/24 list=vs02</code> </pre> <br>  ูููุง ุ ูุดูุฑ ุฅูู ุนูุงููู ุงูุดุจูุงุช ูุน ุงูุฅุดุงุฑุฉ ุฅูู ุจุงุฏุฆุงุช ุงุณู ุฎุงุฏู ููุฑูู ุ ุญูุซ ุณูููู ุจุชุนููู ุญุฑูุฉ ูุฑูุฑ VPN ุงูุตุงุฏุฑุฉ. <br><br>  ุญุณููุง ุ ูู ุฃุฌู ุฃุชูุชุฉ ุนูู ูู ูุฐุง ุงูุนูุจ ุ ูุถูู ูุตูู ูุซูุงุซุฉ ุฌุฏุงูู <b>(ุฅุฐุง ูุฑุฑุช ุฅุนุงุฏุฉ ุชุณููุฉ ุงูุจุฑุงูุฌ ุงููุตูุฉ ุ ููุง ุชูุณ ุฅุฌุฑุงุก ุงูุชุบููุฑุงุช ุงูููุงุณุจุฉ ุนูู ุงูุดูุฑุฉ)</b> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptFunctionsList owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre> <br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุงุฆูุฉ ุณุฑุฏ ุงูุจุฑูุงูุฌ ุงููุตููุธุงุฆู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">#   IP --&gt; Cloud   DNS- #  : # # $start (true/false); # #  ""  "updated" :global subUpdateCloudDns do={ put ($start); :if ($start=false) do={ set $CloudDnsStatus; #     set $m 1; log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt;  "); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; CHECK STARTED"); do { log warning ("[subUpdateCloudDns] ---&gt; DDNS ,  ---&gt; " . $m); [/ip cloud force-update]; delay 30000ms; set $CloudDnsStatus ([/ip cloud get status]); set $m ($m+1); :if ($CloudDnsStatus="updated") do={ log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } else={ log error ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log error ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } } while=(($CloudDnsStatus!="updated") and ($m&lt;10)); return ($CloudDnsStatus); } } #    IP --&gt; Cloud #   : # # 0 - ; # 1 - ,   ; # 2 -    :global subCheckCloudDDNS do={ set $CloudDnsActive ([/ip cloud get ddns-enabled]); #  - ( $m=0 ) set $m 0; :if ($CloudDnsActive=yes) do { #  IP---&gt;Cloud  ( $m=1 ) set $m ($m+1); set $CloudDnsStatus ([/ip cloud get status]); #    IP- (  IP---&gt;Cloud    DNS) set $CloudDnsIP ([/ip cloud get public-address]); set $CheckIpAddr ([resolve [/ip cloud get dns-name]]); :if ($CloudDnsIP!=$CheckIpAddr) do={ #  IP  (  MikroTik  )... set $CloudDnsStatus "updating..."; } :if ($CloudDnsStatus="updated") do { #  IP---&gt;Cloud    ( $m=2 ) set $m ($m+1); } } return ($m); } #       #  : # # $ScriptName ( ) :global subRepeatScript do={ put ($ScriptName); :if ($ScriptName!="") do { [/system script run $ScriptName]; } } #     VPN-   # #   IP- VPN-     :global subGetVpnServers do={ #    IP- VPN-        :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ set $MaskPos [find $CheckIpAddr "/"]; set $GroupFromPeer ([/ip ipsec peer get $IpSecPeerId policy-template-group]); set $IpFromPeer ([pick $CheckIpAddr 0 $MaskPos]); set $VpnServersList ($VpnServersList, {{$GroupFromPeer; $IpFromPeer}}); } } return ($VpnServersList); } #        # #    ID   :global subDisableIpSecPeers do={ # ...  ,  (passive=false) ... :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ log warning ("[IP IPSec Peer] ---&gt;    ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #log warning ("[IP IPSec Peer] ---&gt; processed peer on ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #  address   ... set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ #  address  ,  IP-  ... set $MaskPos ([find $CheckIpAddr "/"]); set $CheckIpAddr ([pick $CheckIpAddr 0 $MaskPos]); # ...   IPSec- :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$CheckIpAddr] do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId disabled]!=yes) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  " . [/ip ipsec policy get $IpSecPolicyId comment] . " "); #log warning ("[IP IPSec Policy] ---&gt; policy " . [/ip ipsec policy get $IpSecPolicyId comment] . " deactivated"); } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } } # :     ,      :if ([/ip ipsec peer get $IpSecPeerId disabled]!=yes) do={ [/ip ipsec peer disable $IpSecPeerId]; log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; "); #log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; deactivated"); } } return ($IdList); } #        #  : # # $PeerID (ID   VPN-); # $PolIdList ( ID  $subDisableIpSecPeers); # $CloudIP (IP MikroTik  DDNS); # $SrcIP (src-address    VPN-) :global subEnableIpSecPeers do={ put ($PeerID); put ($PolIdList); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($PolIdList!="")&amp;&amp;($PolIdList!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   VPN- set $ActiveVPN [/ip ipsec peer get $PeerID address]; :if ($ActiveVPN!="") do={ #  ,  IP-   set $MaskPos [find $ActiveVPN "/"]; set $ActiveVPN ([pick $ActiveVPN 0 $MaskPos]); } #   ,      :if ([/ip ipsec peer get $PeerID disabled]=yes) do={ delay 5000ms; [/ip ipsec peer enable $PeerID]; log warning ("[IP IPSec Peer] ---&gt;  peer  ---&gt; " . [/ip ipsec peer get $PeerID address]); #log warning ("[IP IPSec Peer] ---&gt; activated peer on ---&gt; " . [/ip ipsec peer get $PeerID address]); } #    ID   PolIdList, ,    Src. Address, SA Src. Address  SA Dst. Address,   :foreach IpSecPolicyId in=$PolIdList do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId src-address]!=$SrcIP) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$SrcIP]; log warning ("[IP IPSec Policy] ---&gt;  src-address"); #log warning ("[IP IPSec Policy] ---&gt; src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP) do={ [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;  sa-src-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-dst-address]!=$ActiveVPN) do={ [/ip ipsec policy set $IpSecPolicyId sa-dst-address=$ActiveVPN]; log warning ("[IP IPSec Policy] ---&gt;  sa-dst-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-dst-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId disabled]=yes) do={ delay 3000ms; [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } } } } } #      ID  #  : # # $PeerIP (IP    ); # $CloudIP (IP MikroTik  DDNS); # $action (enable/disable/skip) # #    ID,   ,  :global subGetPoliciesByPeer do={ put ($PeerIP); put ($CloudIP); put ($action); :if (($action="")||($action=nil)) do={ set $action "skip"; } :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$PeerIP] do={ :if ($IpSecPolicyId!="") do={ #     $action=disable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]!=yes)&amp;&amp;($action="disable")) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated"); } #     $CloudIP  sa-src-address!=$CloudIP ( ISP),     sa-src-address :if (($CloudIP!="")&amp;&amp;($CloudIP!=nil)&amp;&amp;([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP)) do={ [/ip ipsec policy disable $IpSecPolicyId]; [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;   ---&gt;  sa-src-address ---&gt; " . $CloudIP); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated ---&gt; new sa-src-address ---&gt; " . $CloudIP); #   ,  Kerio   delay 30000ms; } #     $action=enable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]=yes)&amp;&amp;($action="enable")) do={ [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } return ($IdList); } #   local-address  #  : # # $PeerID (ID   VPN-); # $CloudIP (IP MikroTik  DDNS) :global subCheckPeerLocalIp do={ put ($PeerID); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   DDNS-IP :if ([/ip ipsec peer get $PeerID local-address]!=$CloudIP) do={ [/ip ipsec peer set $PeerID local-address=$CloudIP]; log warning ("[IP IPSec Peer] ---&gt;  local-address"); #log warning ("[IP IPSec Peer] ---&gt; local-address changed"); } } }</code> </pre> <br></div></div><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptCheckActiveVpnServer owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  scriptCheckActiveVpnServer</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">:if ([:len [/system script job find script=scriptCheckActiveVpnServer]]&gt;1) do={ :error } #      scheduleStartup #   ,       :global subCheckCloudDDNS :global subCheckPeerLocalIp :global subDisableIpSecPeers :global subEnableIpSecPeers :global subGetPoliciesByPeer :global subGetVpnServers :global subUpdateCloudDns :local CheckIP :local CheckPeer #     DDNS ( ) :local CloudDnsStatus ([:put [$subCheckCloudDDNS]]) :local Exit false :local DefMikroTikSrcNet 192.168.11.0/24 :local DefKerioDstNet 192.168.77.0/24 :local DefKerioPropName KerioVPNProposal#01 :local DefKerioPolName KerioVPNPolicy :local IpSecPolicyId :local KerioName :local KerioVpnNatRuleName KerioVpnNatOut :local m :local n 1 :local PeerCount 0 :local PeerDisabled :local PingCount 3 :local PingResult :local PoliciesList :local PublicIp :local VpnServersList #   DDNS ,  ,    IP- MikroTik :if ($CloudDnsStatus=0) do={ #  Cloud DDNS  ,         :log error ("[schedule CheckActiveVpnServer] ---&gt;    VPN-   Cloud DDNS! (IP -&gt; Cloud)") # :log error ("[schedule CheckActiveVpnServer] ---&gt; to connect to the VPN server, you need to activate Cloud DDNS! (IP -&gt; Cloud)") :error } :if ($CloudDnsStatus=1) do={ #  Cloud DDNS ,   ,   ( ) :set CloudDnsStatus [:put [$subUpdateCloudDns start=false]] :if ($CloudDnsStatus="updated") do={ :set CloudDnsStatus 2 } } :if ($CloudDnsStatus=2) do { #  Cloud DDNS    ... #  IP  DDNS :set PublicIp [/ip cloud get public-address] #   VPN-  ,    ( ) :set VpnServersList ([:put [$subGetVpnServers]]) #     :foreach VpnIpId in=$VpnServersList do={ :set PeerCount ($PeerCount+1) } #   VPN-    DDNS-IP ( ,   VPN-    ) :while (($Exit!=true)&amp;&amp;$n&lt;=$PeerCount) do={ :foreach VpnIpId in=$VpnServersList do={ #  IP- VPN-    :if (($VpnIpId-&gt;0)=$n) do={ :set CheckIP ($VpnIpId-&gt;1) :if ($CheckIP!="") do={ #    IP :set PingResult ([:put [/ping address=$CheckIP count=$PingCount src-address=$PublicIp]]) :if ($PingResult=$PingCount) do={ :log warning ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) #  IP ,     IP- :set CheckPeer (:put [/ip ipsec peer find address=($CheckIP . "/32")]) :if ($CheckPeer!="") do={ #   ,     src- (IP ---&gt; Firewall ---&gt; Address Lists),     Kerio #    Kerio    :set KerioName [/ip ipsec peer get $CheckPeer comment] #    (  ,  FQDN  Kerio   KerioName-Parameter1-...-Parameter_n :if ($KerioName!="") do={ #    :set m ([find $KerioName "-"]) #  KerioName    :set KerioName ([pick $KerioName 0 $m]) #    Firewall -&gt; Address List (       : # Name ---&gt; KerioName (eg srv1) # Address ---&gt; DefMikroTikSrcNet (eg 192.168.99.0/24)) :set m [/ip firewall address-list find list=$KerioName] :set DefMikroTikSrcNet ([/ip firewall address-list get $m address]) } # ...          Kerio :set IpSecPolicyId (:put [/ip ipsec policy find comment="$DefKerioPolName"]) #      ,       # (    )         :if ($IpSecPolicyId="") do={ [/ip ipsec policy add disabled=yes dst-address=$DefKerioDstNet proposal=$DefKerioPropName sa-dst-address=$CheckIP sa-src-address=$PublicIp src-address=$DefMikroTikSrcNet tunnel=yes comment=$DefKerioPolName place-before=0] :log warning ("[schedule CheckActiveVpnServer] ---&gt;   " . $DefKerioPolName . " ---&gt;    ") #:log warning ("[schedule CheckActiveVpnServer] ---&gt; created policy " . $DefKerioPolName . " ---&gt; default parameters used") } else={ #   ,     src-address,   . :if ($DefMikroTikSrcNet!=[/ip ipsec policy get $IpSecPolicyId src-address]) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$DefMikroTikSrcNet]; :log warning ("[schedule CheckActiveVpnServer] ---&gt;  " . $DefKerioPolName . "  ---&gt; src-address   ---&gt; " . $DefMikroTikSrcNet) #:log warning ("[schedule CheckActiveVpnServer] ---&gt; policy " . $DefKerioPolName . " changed ---&gt; src-address changed to ---&gt; " . $DefMikroTikSrcNet) } } #   :set m #  NAT-      Kerio  :set m [/ip firewall nat find comment=$KerioVpnNatRuleName] :if ($m!="") do={ #   src-address   ipsec,       Kerio  :if ([/ip firewall nat get $m to-addresses]!=$DefMikroTikSrcNet) do={ [/ip firewall nat set $m to-addresses $DefMikroTikSrcNet] :log warning ("[IP Firewall NAT] ---&gt;    ---&gt; " . $KerioVpnNatRuleName) #:log warning ("[IP Firewall NAT] ---&gt; netmap rule changed ---&gt; " . $KerioVpnNatRuleName) } } # ... local-address      IP MikroTik,    ( ) :put [$subCheckPeerLocalIp PeerID=$CheckPeer CloudIP=$PublicIp] # ...    :set PeerDisabled ([/ip ipsec peer get $CheckPeer disabled]) :if ($PeerDisabled=true) do={ #   ... #       ( ) :set PoliciesList ([:put [$subDisableIpSecPeers]]) #     VPN-   ( ) :put [$subEnableIpSecPeers PeerID=$CheckPeer PolIdList=$PoliciesList CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet] } else={ #   ... #      ,    ( ) :set PoliciesList ([:put [$subGetPoliciesByPeer PeerIP=$CheckIP CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet action="enable"]]) } :set Exit true } } else={ :log error ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) } } } } :set n ($n+1) } }</code> </pre><br></div></div><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/system scheduler add interval=1h name=scheduleCheckIPSecSADstAddrFromDNS on-event=\ "/system script run scriptSetIPSecSADstAddrFromDNS" policy=read,write \ start-date=oct/30/2017 start-time=00:10:00 add name=scheduleStartup on-event=":global StartupScript true :global RepeatRun false /system script run scriptFunctionsList" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-time=startup add interval=5m name=scheduleCheckActiveVpnServer on-event=\ "/system script run scriptCheckActiveVpnServer" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-date=nov/29/2017 start-time=00:00:00</code> </pre><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  scheduleStartup</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">:global StartupScript true :global RepeatRun false /system script run scriptFunctionsList</code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  scheduleCheckIPSecSADstAddrFromDNS</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/system script run scriptSetIPSecSADstAddrFromDNS</code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  scheduleCheckActiveVpnServer</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/system script run scriptCheckActiveVpnServer</code> </pre><br></div></div><br><br> <b> :</b> <br>    MikroTik  DNS- ,   Kerio Control,         MikroTik,   IP ---&gt; DNS ---&gt; Staticโฆ <br><br>   - ! <br><br> ,       โฆ <br><br>  ุดูุฑุง ูุงูุชูุงููู! <br><br>  ููุงุญุธุฉ <br> <b>   :</b> <br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">   ยซ   ?:ยป; </li><li style=";text-align:right;direction:rtl">       ; </li><li style=";text-align:right;direction:rtl">  IP- ,   ISP,    ; </li><li style=";text-align:right;direction:rtl">   ยซ :ยป; </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar439736/">https://habr.com/ru/post/ar439736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar439726/index.html">ููู ูู: ุตุญูุญ ุฃู ุฎูุงูุ</a></li>
<li><a href="../ar439728/index.html">ูู ุจุชูููู ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุฑุฏุงุฏ ุงููุงูู ูุงููููุตู ูู Zimbra OSE ุฏูู ุงุณุชุฎุฏุงู Zextras</a></li>
<li><a href="../ar439730/index.html">ุชูุธูู ุงููุฎูุถ ูู ุฎูุงู ูุฆุฉ ููุงุณูุฉ</a></li>
<li><a href="../ar439732/index.html">Lazarus - ุงูุฑุณูู ุงููุชุญุฑูุฉ ุงูุจุณูุทุฉ ุจุงุณุชุฎุฏุงู ูููู TImageFragment</a></li>
<li><a href="../ar439734/index.html">ูุดุฑ Kubernetes ุนูู ุณุทุญ ุงูููุชุจ ูู ุฏูุงุฆู ูุน MicroK8s</a></li>
<li><a href="../ar439738/index.html">ุจุญุซุง ุนู ุฒุฑ "ุงูุนู ุฌูุฏุง". ZYXEL ูู ุดุจูุฉ ุงูุดุฑูุงุช ุงูุตุบูุฑุฉ ูุงููุชูุณุทุฉ</a></li>
<li><a href="../ar439742/index.html">ุงููุจูู ูู ุจุฑูุงูุฌ ุงููุงุฌุณุชูุฑ JetBrains ูู ุฌุงูุนุฉ ITMO</a></li>
<li><a href="../ar439744/index.html">ุตูู ุจุงุญุซูู ูู ูุนูุฏ ูุงุณุงุชุดูุณุชุณ ููุชูููููุฌูุง "ุงููุณุชุทูู" ุงูุฐู ูุญูู ุฅุดุงุฑุงุช Wi-Fi ุฅูู ููุฑุจุงุก</a></li>
<li><a href="../ar439746/index.html">ููู ูุนูุฏ ุฌุงูุง ุณูุฑูุจุช</a></li>
<li><a href="../ar439748/index.html">ููุฎุต ุงูููุงุฏ ุงููุซูุฑุฉ ููุงูุชูุงู ููุทููุฑ ุงูุจุฑุงูุฌ ุงูุฌููุงู ุฑูู 285 (ูู 4 ุฅูู 10 ูุจุฑุงูุฑ)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>