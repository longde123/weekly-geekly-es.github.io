<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôçüèø #‚É£ üìí Bagaimana saya mempercepat pemrosesan gambar di Android 15 kali üßôüèΩ üö£üèª üì≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bagaimana cara mengoptimalkan pemrosesan gambar dalam runtime ketika diperlukan untuk membuat 6 gambar, yang masing-masing terdiri dari 15-16 PNG yang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana saya mempercepat pemrosesan gambar di Android 15 kali</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439596/"><p>  Bagaimana cara mengoptimalkan pemrosesan gambar dalam runtime ketika diperlukan untuk membuat 6 gambar, yang masing-masing terdiri dari 15-16 PNG yang secara berurutan dilapis, tanpa menerima OutOfMemoryException dalam perjalanan? </p><br><p><img src="https://habrastorage.org/webt/n4/ir/yg/n4irygl0boui-gzrxl1lolvdezg.jpeg" alt="gambar"></p><a name="habracut"></a><br><p>  Saat mengembangkan aplikasi hewan peliharaan saya, saya menemui masalah pemrosesan gambar.  Saya tidak bisa memberikan Googlecases yang baik untuk Google, jadi saya harus berjalan menyapu dan menciptakan sepeda sendiri. <br>  Juga selama pengembangan, ada migrasi dari Jawa ke Kotlin, jadi kode akan diterjemahkan di beberapa titik. </p><br><h4 id="zadacha">  Tantangan </h4><br><p> <em>Aplikasi untuk pelatihan di gym.</em>  <em>Penting untuk membuat peta kerja otot berdasarkan hasil pelatihan dalam runtime aplikasi.</em> <em><br></em>  <em>Dua jenis kelamin: M dan G. Pertimbangkan pilihan M, karena untuk M semuanya sama.</em> <em><br></em>  <em>6 gambar harus dibangun secara bersamaan: 3 periode (satu sesi pelatihan, per minggu, per bulan) x 2 tampilan (depan, belakang)</em> </p><br><p><img src="https://habrastorage.org/webt/ad/i1/2_/adi12_wz_nqagmag3vg2qxfvgta.jpeg" alt="gambar"></p><br><p>  Setiap gambar tersebut terdiri dari 15 gambar kelompok otot untuk tampilan depan dan 14 untuk tampilan belakang.  Ditambah 1 gambar foundation (kepala, tangan dan kaki).  Secara total, untuk mengumpulkan tampilan depan, 16 gambar harus ditumpangkan, 15 di belakang. </p><br><p>  Hanya 23 kelompok otot untuk kedua sisi (untuk mereka dengan 15 + 14! = 23, sedikit penjelasan - beberapa otot ‚Äúterlihat‚Äù di kedua sisi). </p><br><p>  Algoritma dalam pendekatan pertama: </p><br><ol><li>  Berdasarkan data dari latihan yang diselesaikan, HashMap &lt;String, Float&gt; dibangun, String adalah nama kelompok otot, Float adalah tingkat beban dari 0 hingga 10. </li><li>  Masing-masing dari 23 otot dicat ulang dalam warna dari 0 (tidak terlibat) hingga 10 (Maks. Load). </li><li>  Hamparkan gambar otot yang dicat ulang dalam dua gambar (depan, belakang). </li><li>  Kami menyimpan semua 6 gambar. </li></ol><br><p><img src="https://habrastorage.org/webt/rg/d-/s-/rgd-s-voieskh-uscrujasgqvte.jpeg" alt="gambar"></p><br><p>  Untuk menyimpan 31 (16 + 15) gambar berukuran 1500x1500 px dengan mode 24-bit, diperlukan 31x1500x1500x24bit = 199 MB RAM.  Ketika Anda melebihi ~ 30-40 MB, Anda mendapatkan OutOfMemoryException.  Sejalan dengan itu, Anda tidak dapat memuat semua gambar dari sumber pada saat yang bersamaan, karena Anda perlu membebaskan sumber daya untuk tidak menerima penerimaan.  Ini berarti Anda perlu overlay gambar secara berurutan.  Algoritma berubah menjadi sebagai berikut: </p><br><p>  Berdasarkan data dari latihan yang diselesaikan, HashMap &lt;String, Float&gt;, String - muscle, Float - load level mulai 0 hingga 10 dibangun. </p><br><p>  Siklus untuk masing-masing dari 6 gambar: </p><br><ol><li>  Dapatkan sumber daya BitmapFactory.decodeResource (). </li><li>  Masing-masing dari 23 otot dicat ulang dalam warna dari 0 (tidak terlibat) hingga 10 (maks. Beban) </li><li>  Hamparkan gambar otot yang dicat ulang pada satu Kanvas. </li><li>  Bitmap.recycle () membebaskan sumber daya. </li></ol><br><p>  Kami melakukan tugas dalam utas terpisah menggunakan AsyncTask.  Di setiap Tugas, dua gambar dibuat secara berurutan: tampilan depan dan tampilan belakang. </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BitmapMusclesTask</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;Void, Void, DoubleMusclesBitmaps&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> final WeakReference&lt;HashMap&lt;String, Float&gt;&gt; musclesMap; BitmapMusclesTask(HashMap&lt;String, Float&gt; musclesMap) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.musclesMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeakReference&lt;&gt;(musclesMap); } @<span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> DoubleMusclesBitmaps </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void... voids)</span></span></span><span class="hljs-function"> </span></span>{ DoubleMusclesBitmaps bitmaps = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleMusclesBitmaps(); bitmaps.bitmapBack = createBitmapMuscles(musclesMap.get(), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); bitmaps.bitmapFront = createBitmapMuscles(musclesMap.get(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmaps; } @<span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DoubleMusclesBitmaps bitmaps)</span></span></span><span class="hljs-function"> </span></span>{ super.onPostExecute(bitmaps); Uri uriBack = saveBitmap(bitmaps.bitmapBack); Uri uriFront = saveBitmap(bitmaps.bitmapFront); bitmaps.bitmapBack.recycle(); bitmaps.bitmapFront.recycle(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (listener != null) listener.onUpdate(uriFront, uriBack); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleMusclesBitmaps</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Bitmap bitmapFront; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Bitmap bitmapBack; }</code> </pre> <br><p>  Kelas tambahan DoubleMusclesBitmaps diperlukan hanya untuk mengembalikan dua variabel Bitmap: tampilan depan dan tampilan belakang.  Ke depan, kelas Java DoubleMusclesBitmaps digantikan oleh Pair &lt;Bitmap, Bitmap&gt; di Kotlin. </p><br><h3 id="risovanie">  Menggambar </h3><br><p>  Warna colors.xml dalam sumber daya nilai. </p><br><pre> <code class="css hljs">&lt;?<span class="hljs-selector-tag"><span class="hljs-selector-tag">xml</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">version</span></span>="1<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">encoding</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">utf-8</span></span>"?&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">resources</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color0</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#BBBBBB</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color1</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#ffb5cf</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color2</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#fda9c6</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color3</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#fa9cbe</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color4</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f890b5</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color5</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f583ac</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color6</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f377a4</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color7</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f06a9b</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color8</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#ee5e92</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color9</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#eb518a</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color10</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#e94581</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">resources</span></span>&gt;</code> </pre> <br><p>  Buat satu tampilan </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBitmapMuscles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HashMap&lt;String, Float&gt; musclesMap, Boolean isFront)</span></span></span><span class="hljs-function"> </span></span>{ Bitmap musclesBitmap = Bitmap.createBitmap(<span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, Bitmap.Config.ARGB_8888); Canvas resultCanvas = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Canvas(musclesBitmap); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (HashMap.Entry entry : musclesMap.entrySet()) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> color = Math.round((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) entry.getValue()); <span class="hljs-comment"><span class="hljs-comment">//         color = context.getResources().getColor(context.getResources() .getIdentifier("muscles_color" + color, "color", context.getPackageName())); drawMuscleElement(resultCanvas, entry.getKey(), color); } return musclesBitmap; }</span></span></code> </pre> <br><p>  Hamparan otot tunggal </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawMuscleElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas resultCanvas, String drawableName, @ColorInt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> color)</span></span></span><span class="hljs-function"> </span></span>{ PorterDuff.Mode mode = PorterDuff.Mode.SRC_IN; Paint paint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Paint(Paint.ANTI_ALIAS_FLAG); Bitmap bitmapDst = BitmapFactory.decodeResource(context.getResources(), context.getResources().getIdentifier(drawableName, <span class="hljs-string"><span class="hljs-string">"drawable"</span></span>, context.getPackageName())); bitmapDst = Bitmap.createScaledBitmap(bitmapDst, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); paint.setColorFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PorterDuffColorFilter(color, mode)); resultCanvas.drawBitmap(bitmapDst, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, paint); bitmapDst.recycle();<span class="hljs-comment"><span class="hljs-comment">//  }</span></span></code> </pre> <br><p>  Kami memulai pembuatan 3 pasang gambar. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskLast; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskWeek; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskMonth; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startImageGenerating</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ taskLast = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapLast); taskLast.execute(); taskWeek = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapWeek); taskWeek.execute(); taskMonth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapMonth); taskMonth.execute(); }</code> </pre> <br><p>  Kami mulai startImageGenerating (): </p><br><pre> <code class="plaintext hljs">&gt; start 1549350950177 &gt; finish 1549350959490 diff=9313 ms</code> </pre> <br><p>  Perlu dicatat bahwa sumber daya membaca membutuhkan banyak waktu.  Untuk setiap pasangan gambar, 29 file PNG dari sumber daya diterjemahkan.  Dalam kasus saya, dari total biaya pembuatan gambar, fungsi BitmapFactory.decodeResource () menghabiskan ~ 75% dari waktu: ~ 6960 ms. </p><br><p>  Cons: </p><br><ol><li>  Saya mendapatkan OutOfMemoryException dari waktu ke waktu. </li><li>  Pemrosesan membutuhkan waktu lebih dari 9 detik, dan ini ada pada emulator (!) Di telepon "rata-rata" (tambang lama) mencapai 20 detik. </li><li>  AsyncTask dengan semua kebocoran [memori] yang dihasilkan. </li></ol><br><p>  Pro: <br>  Dengan probabilitas (1-OutOfMemoryException) gambar diambil. </p><br><h3 id="asynctask-v-intentservice">  AsyncTask di IntentService </h3><br><p>  Untuk meninggalkan AsyncTask, diputuskan untuk beralih ke IntentServiCe, di mana tugas membuat gambar dilakukan.  Setelah layanan selesai, jika BroadcastReceiver berjalan, kami mendapatkan Uri dari semua enam gambar yang dihasilkan, jika tidak gambar hanya disimpan sehingga saat berikutnya pengguna membuka aplikasi, tidak perlu menunggu proses pembuatan.  Pada saat yang sama, waktu operasi tidak berubah, tetapi dengan satu kekurangan - kebocoran memori yang ditemukan, ada dua minus lagi. </p><br><p>  Memaksa pengguna untuk mengharapkan kreasi gambar untuk jumlah waktu seperti itu, tentu saja, tidak mungkin.  Perlu dioptimalkan. </p><br><p>  Cara pengoptimalan garis besar: </p><br><ol><li>  Pemrosesan gambar. </li><li>  Menambahkan LruCache. </li></ol><br><h3 id="obrabotka-izobrazheniy">  Pemrosesan gambar </h3><br><p>  Semua sumber PNG sumber berukuran 1500x1500 px.  Kurangi hingga 1080x1080. <br>  Seperti yang dapat Anda lihat di foto kedua, semua kode sumber berbentuk bujur sangkar, otot-otot berada di tempatnya, dan piksel-piksel berguna yang sebenarnya menempati area kecil.  Fakta bahwa semua kelompok otot sudah ada di tempat nyaman untuk programmer, tetapi tidak rasional untuk kinerja.  Kami memotong (memotong) kelebihan di semua kode sumber, merekam posisi (x, y) dari masing-masing kelompok otot untuk selanjutnya menerapkannya ke tempat yang tepat. </p><br><p>  Dalam pendekatan pertama, semua 29 gambar kelompok otot dicat ulang dan ditumpangkan di pangkalan.  Pangkalan hanya mencakup kepala, tangan, dan bagian kaki.  Kami mengubah dasar: sekarang ini termasuk, selain kepala, lengan dan kaki, semua kelompok otot lainnya.  Kami melukis semuanya dengan color_muscle0 abu-abu.  Ini akan memungkinkan tidak mengecat ulang dan tidak memaksakan kelompok-kelompok otot yang tidak terlibat. </p><br><p>  Sekarang semua sumber terlihat seperti ini: </p><br><p><img src="https://habrastorage.org/webt/ya/zy/c3/yazyc3i8kbg590hw4qquapexzic.jpeg" alt="gambar"></p><br><h3 id="lrucache">  Lrucache </h3><br><p>  Setelah pemrosesan tambahan dari gambar asli, beberapa mulai mengambil sedikit memori, yang mengarah pada pemikiran untuk menggunakan kembali (tidak membebaskan mereka setelah setiap overlay dengan metode .recycle ()) menggunakan LruCache.  Kami membuat kelas untuk menyimpan gambar sumber, yang secara bersamaan mengasumsikan fungsi membaca dari sumber daya: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LruCacheBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val context: Context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val lruCache: LruCache&lt;String, Bitmap&gt; init { val maxMemory = (Runtime.getRuntime().maxMemory() / <span class="hljs-number"><span class="hljs-number">1024</span></span>).toInt() val cacheSize = maxMemory / <span class="hljs-number"><span class="hljs-number">4</span></span> lruCache = object : LruCache&lt;String, Bitmap&gt;(cacheSize) { override fun sizeOf(key: String, bitmap: Bitmap): Int { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap.byteCount } } } fun getBitmap(drawableName: String): Bitmap? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lruCache.get(drawableName) != null) lruCache.get(drawableName) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> decodeMuscleFile(drawableName) } fun clearAll() { lruCache.evictAll() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> fun decodeMuscleFile(drawableName: String): Bitmap? { val bitmap = BitmapFactory.decodeResource(context.resources, context.resources.getIdentifier(drawableName, <span class="hljs-string"><span class="hljs-string">"drawable"</span></span>, context.packageName)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bitmap != null) { lruCache.put(drawableName, bitmap) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap } }</code> </pre> <br><p>  Gambar disiapkan, decoding sumber daya dioptimalkan. <br>  Kami tidak akan membahas kelancaran transisi dari Jawa ke Kotlin, tetapi itu memang terjadi. </p><br><h2 id="korutiny">  Coroutine </h2><br><p>  Kode menggunakan IntentService berfungsi, tetapi keterbacaan kode dengan panggilan balik tidak bisa disebut menyenangkan. </p><br><p>  Tambahkan keinginan untuk melihat coroutine Kotlin dalam pekerjaan.  Kami menambahkan pemahaman bahwa setelah beberapa bulan akan lebih menyenangkan untuk membaca kode sinkron Anda daripada mencari tempat untuk mengembalikan file Uri dari gambar yang dihasilkan. </p><br><p>  Juga, percepatan pemrosesan gambar mendorong gagasan untuk menggunakan fitur di beberapa tempat baru dalam aplikasi, khususnya dalam deskripsi latihan, dan tidak hanya setelah pelatihan. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val errorHandler = CoroutineExceptionHandler { _, e -&gt; e.printStackTrace()} <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val job = SupervisorJob() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val scope = CoroutineScope(Dispatchers.Main + job + errorHandler) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> var uries: HashMap&lt;String, Uri?&gt; = HashMap() fun startImageGenerating() = scope.launch { ... val imgMuscle = ImgMuscle() uries = withContext(Dispatchers.IO) { imgMuscle.createMuscleImages() } ... }</code> </pre><br><p>  Bundel standar errorHandler, pekerjaan, dan ruang lingkup adalah scout coroutine dengan penangan kesalahan jika coroutine rusak. </p><br><p>  uries - HashMap, yang menyimpan 6 gambar dalam dirinya sendiri untuk output berikutnya ke UI: <br>  uries ["last_back"] = Uri? <br>  uries ["last_front"] = Uri? <br>  uries ["week_back"] = Uri? <br>  uries ["week_front"] = Uri? <br>  uries ["month_back"] = Uri? <br>  uries ["month_front"] = Uri? </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImgMuscle</span></span></span><span class="hljs-class"> {</span></span> val lruBitmap: <span class="hljs-function"><span class="hljs-function">LruCacheBitmap suspend fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createMuscleImages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: HashMap&lt;String, Uri?&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> suspendCoroutine { continuation -&gt; val resultUries = HashMap&lt;String, Uri?&gt;() ... <span class="hljs-comment"><span class="hljs-comment">//    continuation.resume(resultUries) } } }</span></span></code> </pre><br><p>  Kami mengukur waktu pemrosesan. </p><br><pre> <code class="plaintext hljs">&gt;start 1549400719844 &gt;finish 1549400720440 diff=596 ms</code> </pre> <br><h4 id="s-9313-ms-obrabotka-umenshilas-do-596-ms">  Dari 9313 ms, pemrosesan menurun menjadi 596 ms. </h4><br><p>  Jika Anda memiliki ide untuk optimasi tambahan - jangan ragu untuk berkomentar. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id439596/">https://habr.com/ru/post/id439596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id439586/index.html">Protokol SPBm sebagai dasar Extreme Automated Campus</a></li>
<li><a href="../id439588/index.html">ESET menemukan versi baru dari DanaBot Trojan</a></li>
<li><a href="../id439590/index.html">Quals: Keamanan Cyber ‚Äã‚ÄãNasional Saudi dan Oman CTF 2019. WriteUp</a></li>
<li><a href="../id439592/index.html">Otomatisasi Kegiatan Etis</a></li>
<li><a href="../id439594/index.html">Anotasi Musim Semi: AOP Magic</a></li>
<li><a href="../id439598/index.html">Microsoft berbicara tentang biaya dukungan berbayar untuk Windows 7</a></li>
<li><a href="../id439600/index.html">Finlandia merangkum hasil percobaan awal dengan penghasilan dasar terjamin</a></li>
<li><a href="../id439602/index.html">Etika dalam ruang digital - aturan dasar hubungan digital internasional</a></li>
<li><a href="../id439604/index.html">Bagaimana cara mengatur barcode?</a></li>
<li><a href="../id439606/index.html">Uji coba produksi elektronik dengan harga minimum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>