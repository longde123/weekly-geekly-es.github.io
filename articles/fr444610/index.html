<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧣 👨🏿‍🤝‍👨🏼 🕵🏽 Statistiques et suivi des scripts PHP en temps réel. ClickHouse et Grafana vont aider Pinba 🧝🏽 📙 🚛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je vais vous montrer comment utiliser pinba avec clickhouse et grafana au lieu de pinba_engine et pinboard. 

 Sur un projet phba, p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Statistiques et suivi des scripts PHP en temps réel. ClickHouse et Grafana vont aider Pinba</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444610/"> Dans cet article, je vais vous montrer comment utiliser pinba avec clickhouse et grafana au lieu de pinba_engine et pinboard. <br><br>  Sur un projet phba, pinba est probablement le seul moyen fiable de comprendre ce qui se passe avec les performances.  Certes, pinba n'est généralement implémenté que lorsque des problèmes sont déjà observés et qu'il n'est pas clair où creuser. <br><br>  Souvent, personne n'a la moindre idée du nombre de fois par seconde / minute qu'un script particulier est appelé et commence à optimiser «au toucher», à partir des endroits qui semblent plus logiques. <br><br>  Quelqu'un analyse les journaux nginx et quelqu'un ralentit les demandes dans une base de données. <br><br>  Bien sûr, la pinba ne serait pas superflue, mais il y a plusieurs raisons pour lesquelles elle n'est pas sur tous les projets. <br><br> <a href=""><img src="https://habrastorage.org/webt/br/zm/qz/brzmqzc8itwc2lt3gjp0q2p-kse.png"></a> <br><a name="habracut"></a><br>  Et la première raison est l'installation. <br><br>  Afin d'obtenir plus ou moins une sorte «d'échappement» de l'introduction de la pinba, il est très souhaitable de voir les métriques non seulement dans les dernières minutes, mais également sur une longue période de temps (de quelques jours à plusieurs mois). <br><br>  Pour ce faire, vous avez besoin de: <br><br><ul><li>  installer l'extension pour php (et peut-être que vous voulez un module pour nginx) </li><li>  compiler l'extension pour mysql </li><li>  installer le panneau d'affichage et configurer cron </li></ul><br>  En raison de la petite quantité d'informations sur pinba, beaucoup ont l'impression que cela ne fonctionnait que sur php5 et a longtemps été dans le passé, mais comme nous le verrons plus tard, ce n'est pas le cas. <br><br>  La première étape est la plus simple, il vous suffit d'exécuter la commande: <br><br><pre><code class="bash hljs">apt install php-pinba</code> </pre> <br>  Dans les référentiels, cette extension est jusqu'à php 7.3 inclus et vous n'avez rien besoin de compiler. <br><br>  Après avoir exécuté la commande d'installation, nous obtenons immédiatement une extension déjà fonctionnelle qui collecte et envoie les métriques de chaque script (durée, mémoire, etc.) au format <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">protobuf</a> par udp à 127.0.0.1 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">{0002</a> . <br><br>  Personne n'a encore capturé et traité ces packages udp, mais cela n'affecte pas la vitesse ou la stabilité de vos scripts php. <br><br>  Jusqu'à récemment, seule <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pinba_engine</a> était la seule application qui pouvait intercepter et traiter ces paquets udp.  La description de l'installation " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">simple et concise</a> " décourage l'envie de la lire et de la plonger à nouveau.  Dans les listes de dépendances longues d'un kilomètre, il y a à la fois des noms de package et des noms de programme et des liens vers des pages individuelles avec leur installation, et ceux-ci ont leurs propres liens vers d'autres dépendances.  Pour faire face à cette merde, personne n'a ni le temps ni l'envie. <br><br>  Le processus d'installation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pinba2 n'est</a> pas devenu <a href="">beaucoup plus facile</a> . <br><br>  Peut-être qu'un jour, pinba10 peut être installé avec une ou deux commandes et ne pas lire un tas de matériel pour comprendre comment faire cela, mais jusqu'à présent, ce n'est pas le cas. <br><br>  Si vous avez toujours installé pinba_engine, cela ne représente que la moitié de la bataille.  Après tout, sans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tableau d'affichage,</a> vous devrez vous limiter aux données uniquement au cours des dernières minutes ou agréger, enregistrer et visualiser vos données vous-même.  C'est bien que le panneau d'affichage soit assez facile à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">installer</a> . <br><br>  Il semblerait, pourquoi une telle souffrance si toutes les métriques de php vont déjà au port udp au format protobuf et tout ce qui est nécessaire est d'écrire une application qui les capturera et les stockera dans une sorte de stockage?  Apparemment, les développeurs qui ont eu cette idée se sont immédiatement assis pour écrire leurs vélos, dont certains sont tombés sur le github. <br><br>  Ce qui suit est un examen de quatre projets open source qui stockent des métriques dans le stockage, à partir desquelles ces données sont faciles à obtenir et à visualiser, par exemple, en utilisant grafana. <br><br><h4>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">olegfedoseev / pinba-server</a> (novembre 2017) </h4><br>  serveur udp en déplacement, qui stocke les métriques dans OpenTSDB.  Peut-être que si vous utilisez déjà OpenTSDB sur le projet, alors une telle solution vous conviendra sinon je vous recommande de passer. <br><br><h4>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Olegfedoseev / pinba-influxdb</a> (juin 2018) </h4><br>  serveur udp en marche, à partir du même <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habrayuzer</a> qui enregistre cette fois des métriques dans InfluxDB.  Sur de nombreux projets, InfluxDB est déjà utilisé pour la surveillance, cette solution peut donc être idéale pour eux. <br><br>  Avantages: <br><br><ul><li>  InfluxDB vous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">permet d'</a> agréger les métriques reçues et de supprimer l'original après un délai spécifié. </li></ul><br>  Inconvénients: <br><br><ul><li>  cette solution n'enregistre pas les informations du minuteur. </li><li>  InfluxDB enregistrera les adresses de page en tant que balises et si vous avez plusieurs adresses de page uniques, cela entraînera une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">augmentation de</a> la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">consommation de</a> mémoire.  A partir d'un certain moment, il " <a href="">va commencer à manger la mémoire comme s'il n'était pas en lui-même</a> ".  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">source</a> ) </li></ul><br><h4>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ClickHouse-Ninja / Proton</a> (janvier 2019) </h4><br>  serveur udp en déplacement qui stocke les métriques dans ClickHouse.  Ceci est la décision de mon ami.  C'est après l'avoir rencontré que j'ai décidé qu'il était temps de s'attaquer au pinbu et au clickhouse. <br><br>  Avantages: <br><br><ul><li>  le clickhouse est idéal pour de telles tâches, il vous permet de compresser tellement de données que vous pouvez stocker toutes les données brutes même sans agrégations </li><li>  si nécessaire, vous pouvez facilement agréger les mesures résultantes </li><li>  modèle prêt à l'emploi pour grafana </li><li>  enregistre les informations de la minuterie </li></ul><br>  Inconvénients: <br><br><ul><li>  <s><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">défaut fatal</a></s> </li><li>  il n'y a pas de configuration dans laquelle il serait possible de configurer le nom de la base de données et des tables, l'adresse et le port du serveur. </li><li>  lors de l'enregistrement des données brutes, une table de dictionnaire auxiliaire est utilisée pour stocker les adresses de page et de domaine, ce qui complique ensuite les requêtes </li><li>  d'autres petites choses qui découlent du premier moins </li></ul><br><h4>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">serveur pinba / serveur pinba</a> (avril 2019) </h4><br>  serveur udp en php qui stocke les métriques dans ClickHouse.  Ceci est ma solution résultant de ma connaissance de pinba, ClickHouse et protobuf.  Pendant que je traitais tout ce tas, j'ai écrit une «preuve de concept» qui, de façon inattendue pour moi, n'a pas consommé de ressources importantes (30 Mo de RAM et moins de 1% de l'un des huit cœurs de processeur), j'ai donc décidé de la partager avec le public. <br><br>  Les avantages sont les mêmes que dans la solution précédente, j'ai également utilisé les noms habituels du pinba_engine d'origine.  J'ai également ajouté une configuration qui vous permet d'exécuter plusieurs instances de pinbaserver à la fois pour enregistrer des métriques dans différentes tables - cela est utile si vous souhaitez collecter des données non seulement à partir de php, mais également à partir de nginx. <br>  Inconvénients - une "faille fatale" et ces petites choses avec lesquelles vous ne serez pas à l'aise personnellement, mais ma solution est "aussi simple que des pantoufles" et ne comprend qu'environ 100 lignes de code, de sorte que tout développeur php peut changer ce qu'il n'aime pas en quelques minutes. <br><br>  <b>Principe de fonctionnement</b> <br><br>  On écoute le port udp 30002. Tous les paquets entrants sont décodés selon le schéma protobuf et sont agrégés.  Une fois par minute, le paquet est inséré dans la clickhouse de la table pinba.requests.  (tous les paramètres sont configurés dans la <a href="">config</a> ) <br><br>  <b>Un peu sur Clickhouse</b> <br><br>  Clickhouse prend en charge divers moteurs de stockage.  Le plus couramment utilisé est MergeTree. <br><br>  Si, à un moment donné, vous décidez de stocker des données agrégées pour tout le temps et des données brutes uniquement pour le dernier, vous pouvez créer une vue matérialisée avec un regroupement et nettoyer périodiquement la table principale pinba.requests, tandis que toutes les données resteront dans la vue matérialisée.  De plus, lors de la création de la table pinba.requests, vous pouvez spécifier "engine = Null", puis les données brutes ne seront pas du tout enregistrées sur le disque et en même temps, elles entreront toujours dans la vue matérialisée et stockées agrégées.  J'utilise ce schéma pour les métriques nginx, car sur nginx j'ai 50 fois plus de requêtes que sur php. <br><br>  Donc, vous avez parcouru un long chemin et je ne voudrais pas vous laisser à mi-chemin, donc il y aura une description détaillée de l'installation et de la configuration de ma solution et de tout ce dont vous avez besoin, ainsi que des pièges dans lesquels plus d'un navire s'est écrasé.  L'ensemble du processus d'installation est décrit pour Ubuntu 18.04 LTS et Centos 7, sur d'autres distributions et versions, le processus peut varier légèrement. <br><br><h4>  L'installation </h4><br>  J'ai fait toutes les commandes nécessaires dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dockerfile</a> pour faciliter la reproductibilité des instructions.  Seuls les pièges seront décrits ci-dessous. <br><br>  <b>php pinba</b> <br><br>  Après l'installation, assurez-vous que dans le fichier /etc/php/7.2/fpm/conf.d/20-pinba.ini, toutes les options ne sont pas commentées.  Dans certaines distributions (par exemple, les centos), elles peuvent être commentées. <br><br><pre> <code class="plaintext hljs">extension=pinba.so pinba.enabled=1 pinba.server=127.0.0.1:30002</code> </pre> <br>  <b>Clickhouse</b> <br><br>  Lors de l'installation, clickhouse vous demandera de définir un mot de passe pour l'utilisateur par défaut.  Par défaut, cet utilisateur est disponible sur toutes les adresses IP, donc si vous n'avez pas de pare-feu sur le serveur, assurez-vous de lui attribuer un mot de passe.  Cela peut également être fait après l'installation dans le fichier /etc/clickhouse-server/users.xml. <br><br>  Il convient également de noter que clickhouse utilise plusieurs ports, dont 9000. Ce port est également utilisé pour php-fpm dans certaines distributions (par exemple, centos).  Si ce port est déjà utilisé, vous pouvez le remplacer par un autre dans le fichier /etc/clickhouse-server/config.xml. <br><br>  <b>grafana avec plugin clickhouse</b> <br><br>  Après avoir installé grafana, utilisez le nom d'utilisateur administrateur et le mot de passe administrateur.  À la première entrée, le graphon vous demandera de définir un nouveau mot de passe. <br><br>  Ensuite, allez dans le menu "+" -&gt; importation et spécifiez le numéro de tableau de bord pour l'importation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">10011</a> .  J'ai préparé et rempli ce tableau de bord pour que vous n'ayez pas à le refaire vous-même. <br><br>  Le grafana prend en charge le travail avec le clickhouse via un plug-in tiers, mais pour les plug-ins tiers, grafana ne fonctionne pas d'alertes (un ticket pour cela existe depuis plusieurs années). <br><br>  <b>serveur pinba</b> <br><br>  L'installation de protobuf et libevent est facultative, mais améliore les performances du serveur pinba.  Si vous installez pinba-server dans un dossier autre que / opt, vous devrez également corriger le fichier de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script systemd</a> . <br><br>  <b>module pinba sous nginx</b> <br><br>  Pour compiler le module, vous avez besoin des sources de la même version de nginx qui est déjà installée sur votre serveur, ainsi que des mêmes options de compilation, sinon l'assembly réussira, mais lorsque le module est connecté, une erreur sera générée que le module est incompatible binaire.  Les options de compilation peuvent être affichées à l'aide de la commande nginx -V <br><br>  <b>Astuces de vie</b> <br><br>  Tous mes sites fonctionnent uniquement sur https.  Le champ du schéma devient vide de sens, donc je l'utilise pour séparer le web / la console. <br><br>  Dans les scripts accessibles depuis le Web, j'utilise: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ini_get(<span class="hljs-string"><span class="hljs-string">'pinba.enabled'</span></span>)) { pinba_schema_set(<span class="hljs-string"><span class="hljs-string">'web'</span></span>); }</code> </pre><br>  Et dans la console (par exemple, les scripts de couronne): <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ini_get(<span class="hljs-string"><span class="hljs-string">'pinba.enabled'</span></span>)) { pinba_schema_set(<span class="hljs-string"><span class="hljs-string">'console'</span></span>); }</code> </pre> <br>  Dans mon tableau de bord dans graphan, il y a un commutateur web / console pour afficher les statistiques séparément. <br><br>  Vous pouvez également transférer vos tags vers pinbu, par exemple: <br><br><pre> <code class="php hljs">pinba_tag_set(<span class="hljs-string"><span class="hljs-string">'country'</span></span>, $countryCode);</code> </pre> <br>  <b>C’est tout.</b> <br><br>  Une grosse demande pour répondre aux sondages sous l'article. <br><br>  Traditionnellement, je préviens que je ne conseille pas et n'aide pas à travers des messages personnels de Habr et des réseaux sociaux. <br><br>  Commencez un ticket sur github. <br><br>  En outre, veuillez prendre en charge la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version anglaise de</a> cet article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur reddit avec les goûts</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr444610/">https://habr.com/ru/post/fr444610/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr444594/index.html">Gros o</a></li>
<li><a href="../fr444596/index.html">Iodide: Mozilla Interactive Science Editor</a></li>
<li><a href="../fr444598/index.html">Le CD a 40 ans et il est mort (n'est-ce pas?)</a></li>
<li><a href="../fr444600/index.html">Évaluation de 14 cm sans tête 2019</a></li>
<li><a href="../fr444602/index.html">Encapsulation en C ++ et C</a></li>
<li><a href="../fr444612/index.html">Dommages macro pour le code C ++</a></li>
<li><a href="../fr444614/index.html">Toute l'histoire de Linux. Partie II: hauts et bas des entreprises</a></li>
<li><a href="../fr444616/index.html">Création de votre propre enregistreur vocal Android à l'aide de Kotlin</a></li>
<li><a href="../fr444620/index.html">Utilisation de fichiers de séquence de noyau Linux</a></li>
<li><a href="../fr444622/index.html">Le package tidyr et ses nouvelles fonctions pivot_longer et pivot_wider</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>