<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîù üë¶üèø üë©üèΩ‚ÄçüöÄ Bot√£o de chamada DIY. Raspberry Pi, MajorDoMo, Freeswitch e Linphonec üë∑üèª üßü ‚è´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° algum tempo, eu precisava me comunicar com uma pessoa ap√≥s uma doen√ßa que n√£o podia usar fisicamente o telefone. Era necess√°rio um dispositivo de c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot√£o de chamada DIY. Raspberry Pi, MajorDoMo, Freeswitch e Linphonec</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464309/">  H√° algum tempo, eu precisava me comunicar com uma pessoa ap√≥s uma doen√ßa que n√£o podia usar fisicamente o telefone.  Era necess√°rio um dispositivo de chamada simples, uma chamada de voz com o toque de um bot√£o.  A necessidade desapareceu, no entanto, tendo visitado o pr√≥prio hospital, olhando os pacientes, pensava-se que essa solu√ß√£o poderia ser √∫til. <br>  Agora vejo o uso pessoal deste dispositivo como uma campainha SIP. <br><br>  Talvez com pequenas altera√ß√µes, a combina√ß√£o de telefonia VoIP com um sistema de automa√ß√£o residencial.  Como op√ß√µes de uso - campainha SIP, interfone, sistema de comunica√ß√£o de voz (pessoal do cliente, diretor-secret√°rio), etc. <br><br><img src="https://habrastorage.org/webt/lr/x1/5g/lrx15gxymgjqei5tsqgkgzxtaiy.jpeg"><br><br>  Toda a solu√ß√£o √© feita em software livre e de c√≥digo aberto: sistema operacional - Raspbian Stretch (Debian 9), sistema de automa√ß√£o residencial - MajorDoMo, servidor VoIP - Freeswitch, software cliente de telefonia IP com a capacidade de trabalhar no modo terminal Linphonec. <br><br>  Nesta parte, sob o corte, falaremos principalmente sobre a instala√ß√£o do cliente SIP do console Linphonec. <br><a name="habracut"></a><br>  Vamos precisar de: <br><br><ol><li>  Raspberry Pi - Computador de placa √∫nica (eu tenho um modelo Raspberry Pi 3B) </li><li>  Cart√£o de mem√≥ria Micro SD de pelo menos 16 GB, carregador USB, compartimento. </li><li>  Placa de som USB (uma das mais baratas, Gembird usado), microfone, alto-falante (fones de ouvido). </li><li>  Bot√£o e um par de jumpers BBJ para pinos GPIO. </li></ol><br>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Primeiro passo - Instalando uma imagem MajorDoMo para RPI</a> <br>  Atualmente, a vers√£o atual da imagem para o Raspberry Pi √© v.  3,40  Aqui est√° uma breve descri√ß√£o das imagens e altera√ß√µes do MajorDoMo: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Imagens b√°sicas do MajorDoMo para Raspberry Pi</a> <br><br>  Ap√≥s a instala√ß√£o e quando o sistema inicializar, conectar os alto-falantes ao conector 3.5 - ouviremos as mensagens do sistema e o endere√ßo IP do Raspberry. <br><br>  O nome de usu√°rio padr√£o √©: pi senha: raspberry. <br><br>  2. Instale o FREESWITCH, <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Instalando o servidor VoIP FRESWITCH para Raspberry</a> <br><br>  Depois disso, procedemos √† instala√ß√£o dos componentes necess√°rios.  Uma etapa √∫til opcional, mas possivelmente posterior. <br><br><h4>  Instale o RPi-Monitor </h4><br>  Instale um utilit√°rio de monitor RPI pequeno, mas √∫til, que mostre os recursos do nosso Raspberry PI. <br><br>  O RPi-Monitor √© um software de monitoramento de placas Raspberry Pi baseado na Web.  Esta ferramenta pode ser √∫til para controlar o uso de espa√ßo em disco, carga da CPU, mem√≥ria e tr√°fego de rede, temperatura.  O RPI-Monitor √© bastante simples de instalar e exibe visualmente informa√ß√µes sobre o sistema. <br><br>  Primeiro, darei um link para a fonte: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">RPi-Monitor</a> . <br><br>  Instale a chave p√∫blica do RPi-Monitor e adicione-a aos reposit√≥rios confi√°veis: <br><br><pre><code class="plaintext hljs">sudo apt-get install dirmngr sudo apt-key adv --recv-keys --keyserver keyserver.ubuntu.com 2C0D3C0F sudo wget http://goo.gl/vewCLL -O /etc/apt/sources.list.d/rpimonitor.list</code> </pre> <br>  Em seguida, atualize o sistema e instale o pr√≥prio monitor RPI: <br><br><pre> <code class="plaintext hljs">sudo apt-get update sudo apt-get install rpimonitor</code> </pre><br>  Abra o IP do seu computador no navegador com a porta: 8888, na qual o monitor est√° sendo executado, e veja o status do RPI. <br><br><img src="https://habrastorage.org/webt/97/xd/rb/97xdrbtse_r_tukes5aqhdz5c_8.png"><br><br><h4>  Instalando uma placa de √°udio USB e configurando som no Raspberry Pi OS </h4><br>  Infelizmente, o nosso mini computador Raspberry n√£o possui seu pr√≥prio microfone embutido e entrada para isso.  Portanto, para conectar um microfone, voc√™ precisar√° usar uma placa de som USB externa.  Conectamos o cart√£o √† porta USB Raspberry e executamos o comando (que mostra os dispositivos de som no sistema): <br><br><pre> <code class="plaintext hljs">cat /proc/asound/cards</code> </pre> <br>  Vemos a resposta com dois cart√µes, bcm2835 - interno, externo definido como dispositivo de √°udio USB: <br><br>  <i>0 [ALSA]: bcm2835_alsa - bcm2835 ALSA</i> <i><br></i>  <i>bcm2835 ALSA</i> <i><br></i>  <i>1 [Dispositivo]: √Åudio USB - Dispositivo de √°udio USB</i> <i><br></i>  <i>GeneralPlus USB Audio Device em usb-3f980000.usb-1.4, velocidade m√°xima</i> <br>  O sistema operacional v√™ nossa placa de som, mas ainda n√£o est√° registrada no sistema. <br><br>  Crie um arquivo: <br><br><pre> <code class="plaintext hljs">sudo nano /etc/modprobe.d/alsa-base.conf</code> </pre> <br>  Escrevemos (colamos) a seguinte linha: <br><br>  <i>op√ß√µes snd-usb-audio index = 1</i> <br><br>  Salvar (no editor Ctrl + X). <br><br>  Crie outro arquivo: <br><br><pre> <code class="plaintext hljs">sudo nano /etc/asound.conf</code> </pre> <br>  Adicionar conte√∫do: <br><br><div class="spoiler">  <b class="spoiler_title">conte√∫do do arquivo</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">pcm.!default { type plug slave { pcm "hw:1,0" } } ctl.!default { type hw card 1 }</code> </pre> <br></div></div><br>  Editamos o seguinte arquivo de configura√ß√£o: <br><br><pre> <code class="plaintext hljs">sudo nano /usr/share/alsa/alsa.conf</code> </pre> <br>  Altere a placa de som padr√£o de 0 para 1 (placa USB). Obviamente, 0 por padr√£o √© a sa√≠da de som interna do minicomputador, defina os seguintes par√¢metros em 2 linhas: <br><br><pre> <code class="plaintext hljs">defaults.ctl.card 1 defaults.pcm.card 1</code> </pre> <br>  As altera√ß√µes entrar√£o em vigor, ap√≥s a reinicializa√ß√£o, sobrecarregaremos digitando no console: <br><br><pre> <code class="plaintext hljs">sudo reboot</code> </pre> <br>  Conectamos um microfone e alto-falantes (fones de ouvido) a uma placa de √°udio externa.  Ap√≥s a reinicializa√ß√£o, execute o utilit√°rio de configura√ß√£o de som Alsamixer. <br><br><pre> <code class="plaintext hljs">alsamixer</code> </pre> <br>  Vemos nossos dispositivos que definimos no sistema por padr√£o: <br><br><img src="https://habrastorage.org/webt/bx/em/kt/bxemktswfv1xvsofnautaly542i.png"><br><br>  Use as teclas do cursor para a esquerda e para a direita, selecione o dispositivo desejado, para cima e para baixo, ajuste, preste aten√ß√£o aos s√≠mbolos no dispositivo selecionado: <br><br>  xOOx - o dispositivo est√° ligado, xMMx - o dispositivo est√° desligado.  Como voc√™ pode ver na captura de tela, meu microfone foi desligado por padr√£o no sistema. <br>  Para ligar / desligar o dispositivo, voc√™ precisa pressionar <b>M</b> no teclado. <br>  Saia do samsixer (saia ctr + C). <br>  Verificando o som no sistema.  Alto-falantes e microfone est√£o conectados √†s sa√≠das USB correspondentes da placa de som. <br><br>  N√≥s damos o comando: <br><br><pre> <code class="plaintext hljs">arecord -D plughw:1,0 -f cd /home/pi/test_record.wav</code> </pre> <br>  Com este comando, um arquivo de som √© gravado atrav√©s do microfone no diret√≥rio apropriado (no nosso caso, o pi inicial do usu√°rio).  Pare de gravar <b>Ctrl + c</b> . <br><br>  Verifique o arquivo gravado: <br><br><pre> <code class="plaintext hljs">aplay /home/pi/test_record.wav</code> </pre> <br>  Faremos uma verifica√ß√£o melhor mais tarde. <br><br><h4>  Instalando o cliente VoIP do console Linphonec </h4><br>  N√£o existem tantos programas que possam funcionar no sistema operacional sem uma interface gr√°fica; decidi pelo pacote Linphone. <br><br>  O pacote √© bastante grande, possui muitos recursos em potencial, mas at√© agora precisamos apenas de um pequeno utilit√°rio Linphonec que possa funcionar no terminal e tenha a fun√ß√£o de resposta autom√°tica (coleta autom√°tica). <br><br>  Para ela, as seguintes a√ß√µes ser√£o realizadas. <br><br>  Percebo que, ao instalar a partir do reposit√≥rio Raspbian, uma vers√£o 3.6.1 bastante antiga √© instalada, que n√£o funciona corretamente com o sistema de som ALSA, tive uma perda de som, o programa travou v√°rias vezes. <br><br>  Portanto, usarei uma vers√£o mais atual. <br><br>  Para auto-montagem do pacote a partir das fontes, instalamos depend√™ncias adicionais: <br><br><pre> <code class="plaintext hljs">sudo apt-get install cmake automake autoconf libtool intltool yasm libasound2-dev libpulse-dev libv4l-dev nasm git libglew-dev</code> </pre><br>  V√° para o diret√≥rio inicial: <br><br><pre> <code class="plaintext hljs">cd /home/pi/</code> </pre> <br>  Fa√ßa o download do pacote Linphone, o download levou cerca de 20 minutos. <br><br><pre> <code class="plaintext hljs">git clone git://git.linphone.org/linphone-desktop.git --recursive</code> </pre> <br>  N√£o pude compilar e compilar o pacote Linphone da primeira ou da segunda vez.  Portanto, darei meu algoritmo de a√ß√£o. <br><br>  Paramos quase todos os servi√ßos atualmente em execu√ß√£o, mas atualmente n√£o utilizados, usando o sistema de gerenciamento de servi√ßos systemctl. <br><br>  Ocorreram erros durante a montagem, nosso mini PC simplesmente n√£o possui recursos suficientes.  Liberte-os para instala√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Interrompendo servi√ßos</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">sudo systemctl stop freeswitch.service sudo systemctl stop majordomo.service sudo systemctl stop avahi-daemon.socket sudo systemctl stop avahi-daemon.service sudo systemctl stop mosquitto.service sudo systemctl stop mysql sudo systemctl stop mpd.service sudo systemctl stop mpd.socket sudo systemctl stop homebridge.service sudo systemctl stop nginx.service sudo systemctl stop bluetooth.target sudo systemctl stop bluetooth.service</code> </pre><br></div></div><br>  Por precau√ß√£o, podemos criar um arquivo de troca tempor√°rio (antes de reiniciar) (espa√ßo no disco r√≠gido), que o sistema operacional usa em caso de RAM insuficiente. <br>  Para verificar se o arquivo de troca est√° inclu√≠do em nossa instala√ß√£o do Raspbian (Debian), digitando: <br><br><pre> <code class="plaintext hljs">sudo swapon --show</code> </pre> <br>  A sa√≠da est√° vazia, o que significa que o sistema n√£o possui um arquivo de troca. <br>  Adicione 1G swap e crie um arquivo: <br><br><pre> <code class="plaintext hljs">sudo fallocate -l 1G /swapfile</code> </pre> <br>  Somente o usu√°rio root pode ler e gravar no arquivo de pagina√ß√£o, portanto, definimos as permiss√µes corretas: <br><br><pre> <code class="plaintext hljs">sudo chmod 600 /swapfile</code> </pre> <br>  Usamos a ferramenta mkswap para configurar a √°rea de troca do Linux no arquivo e ativ√°-la digitando os seguintes comandos: <br><br><pre> <code class="plaintext hljs">sudo mkswap /swapfile sudo swapon /swapfile</code> </pre><br>  V√° para o diret√≥rio criado ao baixar o pacote: <br><br><pre> <code class="plaintext hljs">cd linphone-desktop</code> </pre> <br>  Preparamos para a instala√ß√£o uma vers√£o sem uma interface gr√°fica: <br><br><pre> <code class="plaintext hljs">sudo ./prepare.py no-ui -DENABLE_OPENH264=ON -DENABLE_WEBRTC_AEC=OFF -DENABLE_UNIT_TESTS=OFF -DENABLE_MKV=OFF -DENABLE_FFMPEG=ON -DENABLE_CXX_WRAPPER=OFF -DENABLE_NON_FREE_CODECS=ON -DENABLE_VCARD=OFF -DENABLE_BV16=OFF -DENABLE_V4L=OFF</code> </pre><br>  Crie usando o atributo ‚Äìj4 (ou seja, crie 4 threads ao mesmo tempo). <br><br><pre> <code class="plaintext hljs">sudo make -j4</code> </pre> <br>  Ao instalar, podemos verificar o status do nosso computador no RPI-Monitor: <br><br><img src="https://habrastorage.org/webt/mo/av/vx/moavvxkzq01wxkp5hxayi-oip2y.png"><br><br>  O tempo de constru√ß√£o para mim foi de 30 a 40 minutos. <br><br>  Os arquivos de programa compilados apareceram no diret√≥rio OUTPUT / no-ui / bin.  Para executar o programa, vamos entrar nele: <br><br><pre> <code class="plaintext hljs">cd OUTPUT/no-ui/bin</code> </pre> <br>  Verifique a vers√£o do programa: <br><br><pre> <code class="plaintext hljs">./linphonec -v</code> </pre> <br>  Temos o resultado: vers√£o: 3.12.0 <br>  Sobrecarregando nossa framboesa <br>  Ao reiniciar, o arquivo de permuta desaparece, todos os servi√ßos em execu√ß√£o registrados na inicializa√ß√£o s√£o restaurados. <br><br><h4>  Uma pequena configura√ß√£o inicial do Freeswitch. </h4><br>  O servidor FREESWITCH √© instalado por padr√£o no diret√≥rio / usr / local / freeswitch /.  A pasta conf cont√©m arquivos de configura√ß√£o.  Por padr√£o, a configura√ß√£o de teste de baunilha √© instalada, o que na maioria das vezes serve para se familiarizar com a possibilidade de um servidor VoIP e cont√©m um grande n√∫mero de exemplos claramente redundantes para uso dom√©stico.  Primeiro, vamos ver a configura√ß√£o pronta para uso do servidor VoIP. <br><br>  Edite o arquivo de configura√ß√£o vars.xml <br><br><pre> <code class="plaintext hljs">sudo nano /usr/local/freeswitch/conf/vars.xml</code> </pre> <br>  Primeiro, altere a senha padr√£o 1234 para um valor diferente, digamos 1111. Se voc√™ n√£o fizer isso, antes de cada chamada, uma pausa ser√° definida antes de discar 10 segundos. <br><br>  Por padr√£o, como escrevi em um artigo anterior, temos 20 n√∫meros de assinantes 1001-1020.  O Dialplan tamb√©m √© instalado por padr√£o. <br><br>  Por alguma raz√£o, nesses tempos, em compara√ß√£o com seis meses atr√°s, quando o m√≥dulo mod_xml_rpc foi ativado, o servidor travava constantemente. <br><br>  O Dialplan FreeSWITCH faz uso extensivo de express√µes regulares.  O plano de discagem padr√£o √© respons√°vel pelo processamento de chamadas, a pr√≥xima se√ß√£o do arquivo Local_Extension √© respons√°vel pelo envio para nossos n√∫meros locais.  Comente algumas linhas: <br><br><pre> <code class="plaintext hljs">sudo nano /usr/local/freeswitch/conf/dialplan/defaults.xml</code> </pre> <br>  Na caixa de di√°logo, insira um s√≠mbolo de coment√°rio nesta se√ß√£o: <br><br><div class="spoiler">  <b class="spoiler_title">Edi√ß√£o de di√°logo dos n√∫meros 1001-1019</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Local_Extension"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"destination_number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(10[01][0-9])$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"export"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dialed_extension=$1"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;action application="bind_meta_app" data="1 bs execute_extension::dx XML features"/&gt; &lt;action application="bind_meta_app" data="2 bs record_session::$${recordings_dir}/${caller_id_number}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"/&gt; &lt;action application="bind_meta_app" data="3 bs execute_extension::cf XML features"/&gt; &lt;action application="bind_meta_app" data="4 bs execute_extension::att_xfer XML features"/&gt; --&gt;</span></span></code> </pre><br></div></div><br>  <i>Uma pequena digress√£o, na minha opini√£o, apesar da capacidade de trabalho do FS, ap√≥s nossas v√°rias altera√ß√µes, √© melhor refazer os arquivos de configura√ß√£o do FS, incluindo:</i>  <i>assinatura, plano de discagem etc., mas voc√™ n√£o pode incluir tudo em um artigo. Por isso, procuramos nosso cliente de terminal.</i> <br><br><h4>  Configurar e iniciar o cliente de terminal Linphonec </h4><br>  Execute o Linphonec no modo de atendimento autom√°tico do usu√°rio pi atual: <br><br><pre> <code class="plaintext hljs">/home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonec -a</code> </pre> <br>  No primeiro lan√ßamento, o Linphonec tenta criar um arquivo de banco de dados e um arquivo de configura√ß√µes.  No entanto, o lan√ßamento est√° errado. <br><br><div class="spoiler">  <b class="spoiler_title">erros ao iniciar o linphonec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">2019-08-02 18:02:58:715 mediastreamer-error-Connection to the pulseaudio server failed 2019-08-02 18:02:58:946 belle-sip-error-udp bind() failed for ::0 port 5060: Address already in use 2019-08-02 18:02:58:947 belle-sip-error-TCP bind() failed for ::0 port 5060: Address already in use 2019-08-02 18:02:59:126 liblinphone-fatal-Unable to open linphone database. Aborted</code> </pre> <br></div></div><br>  Inicialmente, lidaremos com o √∫ltimo erro, abrindo o arquivo de banco de dados. <br><br>  O arquivo do banco de dados √© criado no diret√≥rio inicial ao longo do seguinte caminho: /home/pi/.local/share/linphone <br>  Um arquivo Linux (ou diret√≥rio) √© considerado oculto se o nome come√ßar com um ponto ‚Äú.‚Äù.  Por exemplo, ".myfile".  Normalmente, esses arquivos s√£o usados ‚Äã‚Äãpelos aplicativos para armazenar configura√ß√µes, configura√ß√µes e outras informa√ß√µes que precisam ser ocultadas do usu√°rio. <br>  Crie um diret√≥rio a partir do usu√°rio atual (pi) <br><pre> <code class="plaintext hljs">mkdir /home/pi/.local mkdir /home/pi/.local/share mkdir /home/pi/.local/share/linphone</code> </pre> <br>  Iniciamos o programa, o programa foi iniciado, mas ocorre um erro: <br><div class="spoiler">  <b class="spoiler_title">Erro de abertura da porta</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">2019-08-07 11:29:32:780 mediastreamer-error-Connection to the pulseaudio server failed 2019-08-07 11:29:32:866 belle-sip-error-udp bind() failed for ::0 port 5060: Address already in use 2019-08-07 11:29:32:866 belle-sip-error-TCP bind() failed for ::0 port 5060: Address already in use</code> </pre> <br></div></div><br>  Descobrimos o primeiro problema de criar um banco de dados: no lan√ßamento inicial, o programa gerava um arquivo de banco de dados. <br><br>  O erro associado ao sistema de som Pulseaudio - n√£o interfere no funcionamento do programa, pretendo usar o ALSA, se necess√°rio, um servidor de som sempre pode ser instalado antes. <br><br>  As segundas portas 5060 est√£o ocupadas.  Essas portas s√£o comumente usadas por aplicativos SIP.  Podemos sair do programa e dar o comando: <br><br><pre> <code class="plaintext hljs">sudo netstat -tulpn | grep LISTEN</code> </pre> <br>  Veremos que a porta 5060 usa nosso servidor VoIP FREESWITCH.  Bem, usaremos portas livres. <br><br>  Voltamos ao programa linphonec.  E fa√ßa uma pequena configura√ß√£o. <br><br>  Primeiro, alteramos a porta do Linfon, depois indicamos o registro no servidor VoIP, verificamos o status do registro e observamos a lista de placas de som, a placa usada e a configuramos em um USB externo (com um √≠ndice no programa Linphone - 2): <br><br><pre> <code class="plaintext hljs">ports sip 5062 register sip:1001@192.168.15.13 192.168.15.13 1111 linphonec&gt; help register status register soundcard list soundcard show soundcard use 2 soundcard show</code> </pre><br><img src="https://habrastorage.org/webt/o3/1u/3d/o31u3dvxihunuxmqclxmbfkwfng.png"><br><br>  Na equipe de registro, usamos o seguinte formato: Sip user ID - por padr√£o, temos 20 assinantes com os n√∫meros 1001-1019.  Esses n√∫meros s√£o os nomes de usu√°rio dos assinantes: Login do assinante @ [Nome do dom√≠nio] - nome do dom√≠nio - endere√ßo IP do nosso Raspberry.  Sip proxy - corresponde ao endere√ßo IP do RPI e, no final, √† senha do usu√°rio que configuramos 1111 recentemente. <br><br>  Saia do programa (Ctrl + x), as configura√ß√µes nem sempre s√£o aplicadas em tempo real.  Ap√≥s sair do diret√≥rio inicial / home / pi, o arquivo de configura√ß√£o do cliente do console apareceu: .linphonerc. <br>  J√° podemos fazer altera√ß√µes editando o arquivo de configura√ß√£o do cliente SIP. <br>  Em um novo cliente SIP do console de ativa√ß√£o. <br>  Paralelamente √† sess√£o SSH atual, abra uma nova, fa√ßa login usando seu nome de usu√°rio e senha. <br>  Come√ßamos um samsixer.  Em uma sess√£o, temos o Linphonec, na segunda, um utilit√°rio de ajuste de som. <br>  Fazemos a configura√ß√£o da chamada do cliente SIP em um smartphone ou PC (conforme descrito no artigo sobre a instala√ß√£o do FREESWITCH) alterando a senha padr√£o para sua pr√≥pria e discando um n√∫mero, no nosso caso 1001. Podemos acessar o portal freswitch em IP_Raspberry: 8080, visualizar o registro de assinantes, status chamada etc. <br><br><img src="https://habrastorage.org/webt/wu/qq/ta/wuqqta-dhsd0j8nr_mixybesqam.png"><br><br>  Usando o alsamixer, ajustamos o som.  As altera√ß√µes de som s√£o aplicadas em tempo real, sem sair dos programas. <br><br>  Infelizmente, devido ao uso de uma placa de √°udio barata, n√£o consegui um som aceit√°vel; um eco foi ouvido nos alto-falantes.  Pode ser minimizado um pouco, mas completamente removido - n√£o obtive sucesso. <br><br>  Portanto, como n√£o foi poss√≠vel remov√™-lo de uma maneira, n√≥s a eliminamos de outra. <br>  Feche o Linphonec, edite o arquivo de configura√ß√£o: <br><br><pre> <code class="plaintext hljs">sudo nano /home/pi/.linphonerc</code> </pre> <br>  Na se√ß√£o de som, trazemos as tr√™s √∫ltimas linhas para este formul√°rio: <br><br><div class="spoiler">  <b class="spoiler_title">Se√ß√£o de som Linphonerc</b> <div class="spoiler_text"><pre> <code class="xml hljs">[sound] remote_ring=/home/pi/linphone-desktop/OUTPUT/no-ui/share/sounds/linphone/ringback.wav playback_gain_db=0.000000 mic_gain_db=0.000000 ringer_dev_id=ALSA: bcm2835 ALSA playback_dev_id=ALSA: bcm2835 ALSA capture_dev_id=ALSA: USB Audio Device</code> </pre><br></div></div><br>  Dessa maneira, for√ßamos o toque e o dispositivo de sa√≠da de som a trabalhar no conector raspberry 3.5 embutido, e o dispositivo de grava√ß√£o - microfone para funcionar atrav√©s de uma placa de som externa - o eco desapareceu. <br><br>  Mude os alto-falantes para o pr√≥prio conector da framboesa. <br><br>  Levamos em considera√ß√£o o seguinte momento: ao carregar e, em alguns casos, o sistema dom√©stico inteligente reproduz as mensagens do sistema atrav√©s desta sa√≠da de √°udio. <br><br>  Desligue-os.  Passamos o IP_Rasberry para a p√°gina principal, abrindo o sistema de automa√ß√£o residencial MajorDoMo. <br><br>  Entramos no painel de controle - o objeto Computador (expanda o dispositivo) - ThisComputer na guia Propriedades e definimos os valores: <br><br><pre> <code class="plaintext hljs"> ThisComputer.minMsgLevel 100 ThisComputer.volumeLevel 0</code> </pre> <br><img src="https://habrastorage.org/webt/tr/to/tj/trtotjj9oalk1kj-3tddund0ggi.png"><br><br>  Adicione uma entrada ao cron (um programa daemon projetado para executar tarefas em um hor√°rio espec√≠fico ou em determinados intervalos. O utilit√°rio crontab √© usado para editar tarefas): <br><br><pre> <code class="plaintext hljs">crontab ‚Äìe</code> </pre> <br>  Observo que estamos fazendo isso sob o usu√°rio pi. <br><br>  Insira a linha no final: <br><br><pre> <code class="xml hljs">@reboot /home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonec ‚Äìa</code> </pre> <br>  Ao reiniciar, ligando o computador, esta linha inicia o programa Linphonec no modo de atendimento autom√°tico. <br>  Voltar para MajorDoMo: <br>  Vamos para a p√°gina principal, na se√ß√£o de servi√ßo: <br>  No menu desta se√ß√£o, bot√µes s√£o criados para reiniciar (desligar) o computador. <br>  O fato √© que, para economizar os recursos do cart√£o de mem√≥ria SD, as altera√ß√µes s√£o registradas no sistema ‚Äúsmart home‚Äù ap√≥s um certo tempo (15 minutos).  Portanto, se voc√™ precisar sobrecarregar framboesas, √© melhor faz√™-lo corretamente.  N√≥s reiniciamos o sistema. <br><br><img src="https://habrastorage.org/webt/bn/wl/dg/bnwldg1njtqrveligvtgmkm9iya.png"><br><br>  Ap√≥s a reinicializa√ß√£o, v√° para a p√°gina principal do MajorDoMo, v√° para o painel de controle e, como no √∫ltimo artigo, fazemos uma chamada do console usando o seguinte formato: <br><br><pre> <code class="xml hljs">GetURL("http://freeswitch:works@192.168.1.103:8080/webapi/originate?user/1001%201003%20XML%20default")</code> </pre> <br>  Ap√≥s o comando, o Linphonec atende automaticamente o telefone.  No alto-falante RPI, um arquivo de som est√° sendo reproduzido, uma chamada est√° sendo enviada para o segundo softphone (PC / smartphone).  Depois de pegar o fone (pressionando o bot√£o de atendimento no programa), a conex√£o √© estabelecida. <br><br><img src="https://habrastorage.org/webt/ry/4p/qk/ry4pqktur2kidele7g7hvs0mgou.png"><br><br>  Sobre isso, eu termino esta parte.  Tentarei descrever um pouco mais tarde o bot√£o em si usando o GPIO e configurar chamadas fora da minha rede local. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt464309/">https://habr.com/ru/post/pt464309/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt464295/index.html">Exemplos de uso de alguns novos recursos JavaScript</a></li>
<li><a href="../pt464299/index.html">0, 0, 1, 0, 2, 0, 2, 2, 1, 6, 0, 5, 0, 2, 6, 5, 4, 0, 5, 3, 0, 3, 2, 9, 0, 4, 9, 3, 6, 14, 0, 6, 3, 5, 15, 0, 5, 3, 5 ...</a></li>
<li><a href="../pt464303/index.html">Dados de s√©ries temporais em um DBMS relacional. Extens√µes TimescaleDB e PipelineDB for PostgreSQL</a></li>
<li><a href="../pt464305/index.html">Pequeno sim. Desembalagem do microvirtual Firecracker</a></li>
<li><a href="../pt464307/index.html">Teste de integra√ß√£o de microsservi√ßos no Scala</a></li>
<li><a href="../pt464315/index.html">O filme em que havia solo. Pesquisa Yandex e um breve hist√≥rico de pesquisa por significado</a></li>
<li><a href="../pt464317/index.html">Projeto Konbanwa</a></li>
<li><a href="../pt464325/index.html">Como o Scrumban une o melhor das metodologias Kanban e Scrum</a></li>
<li><a href="../pt464327/index.html">Compara√ß√£o do uso de mem√≥ria de diferentes GUIs do kit de ferramentas</a></li>
<li><a href="../pt464331/index.html">Benef√≠cios In√∫teis: S√≠ntese de Produtos Qu√≠micos Absorventes de UV a partir de Castanhas de Caju</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>