<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’…ğŸ¿ ğŸ‘ ğŸ™‡ğŸ¿ å¯¹ç®€å•çš„U-netï¼ˆç”¨äºåˆ†æ®µçš„ç»å…¸å·ç§¯ç½‘ç»œï¼‰çš„å±æ€§è¿›è¡Œçš„å°è§„æ¨¡ç ”ç©¶ ğŸ”¥ ğŸŒ˜ ğŸ’†ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¿™ç¯‡æ–‡ç« æ˜¯å…³äºå¯¹æµ·ä¸Šå¯»æ‰¾èˆ¹åªæ¯”èµ›çš„ææ–™çš„åˆ†æå’Œç ”ç©¶è€Œå†™çš„ã€‚ 



 è®©æˆ‘ä»¬å°è¯•äº†è§£ç½‘ç»œå¯»æ‰¾çš„æ–¹å¼å’Œå†…å®¹ä»¥åŠå‘ç°çš„å†…å®¹ã€‚ æœ¬æ–‡åªæ˜¯å‡ºäºå¥½å¥‡å’Œé—²ç½®å…´è¶£çš„ç»“æœï¼Œåœ¨å®è·µä¸­ä¸€æ— æ‰€è·ï¼Œå¯¹äºå®é™…ä»»åŠ¡ï¼Œæ²¡æœ‰ä»»ä½•å†…å®¹å¯ä¾›å¤åˆ¶ç²˜è´´ã€‚ ä½†æ˜¯ç»“æœå¹¶ä¸æ˜¯å®Œå…¨é¢„æœŸçš„ã€‚ äº’è”ç½‘ä¸Šå……æ–¥ç€å¯¹ç½‘ç»œæ“ä½œçš„æè¿°ï¼Œä½œè€…åœ¨å…¶ä¸­è¯¦ç»†ä»‹ç»äº†å›¾åƒ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¯¹ç®€å•çš„U-netï¼ˆç”¨äºåˆ†æ®µçš„ç»å…¸å·ç§¯ç½‘ç»œï¼‰çš„å±æ€§è¿›è¡Œçš„å°è§„æ¨¡ç ”ç©¶</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ods/blog/431512/"> è¿™ç¯‡æ–‡ç« æ˜¯å…³äºå¯¹æµ·ä¸Šå¯»æ‰¾èˆ¹åªæ¯”èµ›çš„ææ–™çš„åˆ†æå’Œç ”ç©¶è€Œå†™çš„ã€‚ <br><br><img src="https://habrastorage.org/webt/mu/kx/gb/mukxgbd0ziyg5hpxyf_ijb06yz0.png" alt="å›¾ç‰‡"><br><br> è®©æˆ‘ä»¬å°è¯•äº†è§£ç½‘ç»œå¯»æ‰¾çš„æ–¹å¼å’Œå†…å®¹ä»¥åŠå‘ç°çš„å†…å®¹ã€‚ æœ¬æ–‡åªæ˜¯å‡ºäºå¥½å¥‡å’Œé—²ç½®å…´è¶£çš„ç»“æœï¼Œåœ¨å®è·µä¸­ä¸€æ— æ‰€è·ï¼Œå¯¹äºå®é™…ä»»åŠ¡ï¼Œæ²¡æœ‰ä»»ä½•å†…å®¹å¯ä¾›å¤åˆ¶ç²˜è´´ã€‚ ä½†æ˜¯ç»“æœå¹¶ä¸æ˜¯å®Œå…¨é¢„æœŸçš„ã€‚ äº’è”ç½‘ä¸Šå……æ–¥ç€å¯¹ç½‘ç»œæ“ä½œçš„æè¿°ï¼Œä½œè€…åœ¨å…¶ä¸­è¯¦ç»†ä»‹ç»äº†å›¾åƒï¼Œå¹¶ç”ŸåŠ¨æè¿°äº†ç½‘ç»œå¦‚ä½•ç¡®å®šåŸå§‹å…ƒç´ ï¼ˆè§’åº¦ï¼Œåœ†ï¼Œèƒ¡é¡»ï¼Œå°¾å·´ç­‰ï¼‰ï¼Œç„¶åå¯¹å…¶è¿›è¡Œæœç´¢ä»¥è¿›è¡Œåˆ†æ®µ/åˆ†ç±»ã€‚ ä½¿ç”¨æ¥è‡ªå…¶ä»–å¤§å‹å’Œå¹¿åŸŸç½‘ç»œçš„æƒé‡ï¼Œå¯ä»¥èµ¢å¾—å¾ˆå¤šæ¯”èµ›ã€‚ ç†è§£å¹¶äº†è§£ç½‘ç»œæ˜¯å¦‚ä½•æ„å»ºçš„ä»¥åŠä»€ä¹ˆæ„å»ºäº†å“ªäº›åŸè¯­æ˜¯å¾ˆæœ‰è¶£çš„ã€‚ <br><a name="habracut"></a><br> æˆ‘ä»¬å°†è¿›è¡Œä¸€æ¬¡å°å‹ç ”ç©¶ï¼Œå¹¶è€ƒè™‘å„ç§é€‰é¡¹-åˆ—å‡ºä½œè€…çš„æ¨ç†å’Œä»£ç ï¼Œæ‚¨å¯ä»¥è‡ªå·±æ£€æŸ¥/è¡¥å……/æ›´æ”¹æ‰€æœ‰å†…å®¹ã€‚ <br><br>  kaggleæµ·æ´‹æœç´¢æ¯”èµ›æœ€è¿‘ç»“æŸäº†ã€‚ ç©ºä¸­å®¢è½¦å…¬å¸å»ºè®®åˆ†ææœ‰èˆ¹å’Œæ— èˆ¹çš„æµ·æ´‹å«æ˜Ÿå›¾åƒã€‚ åœ¨æ€»å…±192555å¼ å›¾ç‰‡ä¸­ï¼Œ768x768x3 â€“å¦‚æœæ˜¯uint8ï¼Œåˆ™ä¸º340 720 680 960å­—èŠ‚ï¼›å¦‚æœæ˜¯float32ï¼Œåˆ™ä¸ºå››å€ï¼ˆé€šè¿‡float32æ¯”float64æ›´å¿«ï¼Œå†…å­˜è®¿é—®è¾ƒå°‘ï¼‰ï¼›åœ¨15606å¼ å›¾ç‰‡ä¸Šï¼Œæ‚¨éœ€è¦æ‰¾åˆ°èˆ¹ã€‚ åƒå¾€å¸¸ä¸€æ ·ï¼Œæ‰€æœ‰é‡è¦çš„åœ°æ–¹éƒ½ç”±å‚ä¸ODSï¼ˆods.aiï¼‰çš„äººå‘˜æ¥æ›¿ï¼Œè¿™æ˜¯è‡ªç„¶è€Œæœ‰å¸Œæœ›çš„ï¼Œæˆ‘å¸Œæœ›æˆ‘ä»¬èƒ½å¤Ÿå°½å¿«å­¦ä¹ æ€è·¯å’Œè·èƒœè€…å’Œè·å¥–è€…çš„å®ˆåˆ™ã€‚ <br><br> æˆ‘ä»¬å°†è€ƒè™‘ä¸€ä¸ªç±»ä¼¼çš„é—®é¢˜ï¼Œä½†è¦å¯¹å…¶è¿›è¡Œæ˜¾ç€ç®€åŒ–-å–æµ·np.random.sampleï¼ˆï¼‰* 0.5ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ³¢æµªï¼Œé£ï¼Œæµ·æ»©å’Œå…¶ä»–éšè—çš„å›¾æ¡ˆå’Œé¢å­”ã€‚ è®©æˆ‘ä»¬ä½¿æµ·æ´‹å›¾åƒåœ¨0.0åˆ°0.5çš„RGBèŒƒå›´å†…çœŸæ­£éšæœºã€‚ æˆ‘ä»¬å°†ä¸ºèˆ¹åªæ¶‚ä¸Šç›¸åŒçš„é¢œè‰²ï¼Œå¹¶å°†å®ƒä»¬ä¸æµ·åŒºåˆ†å¼€ï¼Œå°†å®ƒä»¬æ”¾ç½®åœ¨0.5åˆ°1.0çš„èŒƒå›´å†…ï¼Œå¹¶ä¸”å®ƒä»¬çš„å½¢çŠ¶éƒ½ç›¸åŒ-æ¤­åœ†çš„å¤§å°å’Œæ–¹å‘ä¸åŒã€‚ <br><br><img src="https://habrastorage.org/webt/yb/3w/gt/yb3wgteawunrk3urgpsxpnxugm4.png" alt="å›¾ç‰‡"><br><br> ä½¿ç”¨éå¸¸é€šç”¨çš„ç½‘ç»œç‰ˆæœ¬ï¼ˆæ‚¨å¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„ç½‘ç»œï¼‰ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒè¿›è¡Œæ‰€æœ‰å®éªŒã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ›´æ”¹å›¾ç‰‡çš„å‚æ•°ï¼Œåˆ›å»ºå¹²æ‰°å¹¶å»ºç«‹å‡è®¾-å› æ­¤ï¼Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»äº†ç½‘ç»œæŸ¥æ‰¾æ¤­åœ†çš„ä¸»è¦ç‰¹å¾ã€‚ ä¹Ÿè®¸è¯»è€…ä¼šå¾—å‡ºç»“è®ºå¹¶åé©³ä½œè€…ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">æˆ‘ä»¬åŠ è½½åº“ï¼Œç¡®å®šå›¾ç‰‡æ•°ç»„çš„å¤§å°</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt %matplotlib inline <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> math <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tqdm <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tqdm_notebook, tqdm <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> skimage.draw <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ellipse, polygon <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.callbacks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> EarlyStopping, ModelCheckpoint, ReduceLROnPlateau <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> load_model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.optimizers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Adam <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.layers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Input, Conv2D, Conv2DTranspose, MaxPooling2D, concatenate, Dropout <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.losses <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> binary_crossentropy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> keras <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> keras <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> backend <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> K <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tqdm <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tqdm_notebook w_size = <span class="hljs-number"><span class="hljs-number">256</span></span> train_num = <span class="hljs-number"><span class="hljs-number">8192</span></span> train_x = np.zeros((train_num, w_size, w_size,<span class="hljs-number"><span class="hljs-number">3</span></span>), dtype=<span class="hljs-string"><span class="hljs-string">'float32'</span></span>) train_y = np.zeros((train_num, w_size, w_size,<span class="hljs-number"><span class="hljs-number">1</span></span>), dtype=<span class="hljs-string"><span class="hljs-string">'float32'</span></span>) img_l = np.random.sample((w_size, w_size, <span class="hljs-number"><span class="hljs-number">3</span></span>))*<span class="hljs-number"><span class="hljs-number">0.5</span></span> img_h = np.random.sample((w_size, w_size, <span class="hljs-number"><span class="hljs-number">3</span></span>))*<span class="hljs-number"><span class="hljs-number">0.5</span></span> + <span class="hljs-number"><span class="hljs-number">0.5</span></span> radius_min = <span class="hljs-number"><span class="hljs-number">10</span></span> radius_max = <span class="hljs-number"><span class="hljs-number">30</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ç¡®å®šæŸå¤±å’Œå‡†ç¡®æ€§å‡½æ•°</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dice_coef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(y_true, y_pred)</span></span></span><span class="hljs-function">:</span></span> y_true_f = K.flatten(y_true) y_pred = K.cast(y_pred, <span class="hljs-string"><span class="hljs-string">'float32'</span></span>) y_pred_f = K.cast(K.greater(K.flatten(y_pred), <span class="hljs-number"><span class="hljs-number">0.5</span></span>), <span class="hljs-string"><span class="hljs-string">'float32'</span></span>) intersection = y_true_f * y_pred_f score = <span class="hljs-number"><span class="hljs-number">2.</span></span> * K.sum(intersection) / (K.sum(y_true_f) + K.sum(y_pred_f)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> score <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dice_loss</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(y_true, y_pred)</span></span></span><span class="hljs-function">:</span></span> smooth = <span class="hljs-number"><span class="hljs-number">1.</span></span> y_true_f = K.flatten(y_true) y_pred_f = K.flatten(y_pred) intersection = y_true_f * y_pred_f score = (<span class="hljs-number"><span class="hljs-number">2.</span></span> * K.sum(intersection) + smooth) / (K.sum(y_true_f) + K.sum(y_pred_f) + smooth) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span> - score <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bce_dice_loss</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(y_true, y_pred)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> binary_crossentropy(y_true, y_pred) + dice_loss(y_true, y_pred) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_iou_vector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(A, B)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Numpy version batch_size = A.shape[0] metric = 0.0 for batch in range(batch_size): t, p = A[batch], B[batch] true = np.sum(t) pred = np.sum(p) # deal with empty mask first if true == 0: metric += (pred == 0) continue # non empty mask case. Union is never empty # hence it is safe to divide by its number of pixels intersection = np.sum(t * p) union = true + pred - intersection iou = intersection / union # iou metrric is a stepwise approximation of the real iou over 0.5 iou = np.floor(max(0, (iou - 0.45)*20)) / 10 metric += iou # teake the average over all images in batch metric /= batch_size return metric def my_iou_metric(label, pred): # Tensorflow version return tf.py_func(get_iou_vector, [label, pred &gt; 0.5], tf.float64) from keras.utils.generic_utils import get_custom_objects get_custom_objects().update({'bce_dice_loss': bce_dice_loss }) get_custom_objects().update({'dice_loss': dice_loss }) get_custom_objects().update({'dice_coef': dice_coef }) get_custom_objects().update({'my_iou_metric': my_iou_metric })</span></span></code> </pre><br></div></div><br> æˆ‘ä»¬åœ¨å›¾åƒåˆ†å‰²ä¸­ä½¿ç”¨ç»å…¸æŒ‡æ ‡ï¼Œæœ‰å¾ˆå¤šæ–‡ç« ï¼Œæœ‰å…³æ‰€é€‰æŒ‡æ ‡çš„å¸¦æœ‰æ³¨é‡Šçš„æ–‡æœ¬å’Œä»£ç ï¼Œåœ¨åŒä¸€kaggleä¸Šï¼Œæœ‰å¾ˆå¤šå¸¦æœ‰æ³¨é‡Šå’Œè§£é‡Šçš„é€‰é¡¹ã€‚ æˆ‘ä»¬å°†é¢„æµ‹åƒç´ çš„é®ç½©-è¿™æ˜¯â€œæµ·â€æˆ–â€œèˆ¹â€ï¼Œå¹¶è¯„ä¼°é¢„æµ‹çš„çœŸå®æ€§æˆ–è™šå‡æ€§ã€‚ å³ ä»¥ä¸‹å››ä¸ªé€‰é¡¹æ˜¯å¯èƒ½çš„-æˆ‘ä»¬æ­£ç¡®åœ°é¢„æµ‹åƒç´ æ˜¯â€œæµ·â€ï¼Œæ­£ç¡®åœ°é¢„æµ‹åƒç´ æ˜¯â€œèˆ¹â€ï¼Œæˆ–è€…åœ¨é¢„æµ‹â€œæµ·â€æˆ–â€œèˆ¹â€æ—¶å‡ºé”™ã€‚ å› æ­¤ï¼Œå¯¹äºæ‰€æœ‰å›¾ç‰‡å’Œæ‰€æœ‰åƒç´ ï¼Œæˆ‘ä»¬ä¼°è®¡æ‰€æœ‰å››ä¸ªé€‰é¡¹çš„æ•°é‡å¹¶è®¡ç®—ç»“æœ-è¿™å°†æ˜¯ç½‘ç»œçš„ç»“æœã€‚ é”™è¯¯çš„é¢„æµ‹è¶Šå°‘è¶Šå‡†ç¡®ï¼Œç»“æœè¶Šå‡†ç¡®ï¼Œç½‘ç»œè¶Šå¥½ã€‚ <br><br> ä¸ºäº†è¿›è¡Œç ”ç©¶ï¼Œè®©æˆ‘ä»¬é‡‡ç”¨ç»è¿‡ç²¾å¿ƒç ”ç©¶çš„u-netï¼Œå®ƒæ˜¯ç”¨äºå›¾åƒåˆ†å‰²çš„å‡ºè‰²ç½‘ç»œã€‚ è¯¥ç½‘ç»œåœ¨æ­¤ç±»æ¯”èµ›ä¸­éå¸¸æ™®éï¼Œå¹¶ä¸”å­˜åœ¨è®¸å¤šæè¿°ï¼Œåº”ç”¨ç¨‹åºçš„ç²¾å¦™ä¹‹å¤„ç­‰ã€‚ é€‰æ‹©äº†ç»å…¸U-netçš„å˜ä½“ï¼Œå½“ç„¶ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œå‡çº§ï¼Œæ·»åŠ å‰©ä½™å—ç­‰ã€‚ ä½†æ˜¯â€œæ‚¨ä¸èƒ½æ‹¥æŠ±å·¨å¤§çš„äº‹ç‰©â€å¹¶ç«‹å³è¿›è¡Œæ‰€æœ‰å®éªŒå’Œæµ‹è¯•ã€‚  U-netå¯¹å›¾ç‰‡æ‰§è¡Œéå¸¸ç®€å•çš„æ“ä½œ-å®ƒé€šè¿‡é€æ­¥è¿›è¡Œå˜æ¢æ¥å‡å°å›¾ç‰‡çš„å¤§å°ï¼Œç„¶åå°è¯•ä»å‹ç¼©å›¾åƒä¸­æ¢å¤é®ç½©ã€‚ å³ åœ¨æœ¬ä¾‹ä¸­ï¼Œå›¾ç‰‡çš„å°ºå¯¸è¢«è®¾ä¸º32x32ï¼Œç„¶åæˆ‘ä»¬å°è¯•ä½¿ç”¨ä¹‹å‰æ‰€æœ‰å‹ç¼©ä¸­çš„æ•°æ®æ¥è¿˜åŸè’™ç‰ˆã€‚ <br><br> åœ¨å›¾ä¸­ï¼ŒU-netæ–¹æ¡ˆæ¥è‡ªåŸå§‹æ–‡ç« ï¼Œä½†æˆ‘ä»¬å¯¹å…¶è¿›è¡Œäº†ä¸€äº›é‡ç¼–ï¼Œä½†æœ¬è´¨ä»ç„¶ç›¸åŒ-æˆ‘ä»¬å‹ç¼©å›¾åƒâ†’æ‰©å±•ä¸ºè’™ç‰ˆã€‚ <br><br><img src="https://habrastorage.org/webt/un/ay/gn/unaygnyzsdhk_2dbk4qq2-2m340.png" alt="å›¾ç‰‡"><br><br><div class="spoiler">  <b class="spoiler_title">åªæ˜¯Uç½‘</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input_layer, start_neurons)</span></span></span><span class="hljs-function">:</span></span> conv1 = Conv2D(start_neurons*<span class="hljs-number"><span class="hljs-number">1</span></span>,(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>),activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>, padding=<span class="hljs-string"><span class="hljs-string">"same"</span></span>)(input_layer) conv1 = Conv2D(start_neurons*<span class="hljs-number"><span class="hljs-number">1</span></span>,(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>),activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>, padding=<span class="hljs-string"><span class="hljs-string">"same"</span></span>)(conv1) pool1 = MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>))(conv1) pool1 = Dropout(<span class="hljs-number"><span class="hljs-number">0.25</span></span>)(pool1) conv2 = Conv2D(start_neurons*<span class="hljs-number"><span class="hljs-number">2</span></span>,(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>),activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>, padding=<span class="hljs-string"><span class="hljs-string">"same"</span></span>)(pool1) conv2 = Conv2D(start_neurons*<span class="hljs-number"><span class="hljs-number">2</span></span>,(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>),activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>, padding=<span class="hljs-string"><span class="hljs-string">"same"</span></span>)(conv2) pool2 = MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>))(conv2) pool2 = Dropout(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)(pool2) conv3 = Conv2D(start_neurons*<span class="hljs-number"><span class="hljs-number">4</span></span>,(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>),activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>, padding=<span class="hljs-string"><span class="hljs-string">"same"</span></span>)(pool2) conv3 = Conv2D(start_neurons*<span class="hljs-number"><span class="hljs-number">4</span></span>,(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>),activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>, padding=<span class="hljs-string"><span class="hljs-string">"same"</span></span>)(conv3) pool3 = MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>))(conv3) pool3 = Dropout(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)(pool3) conv4 = Conv2D(start_neurons*<span class="hljs-number"><span class="hljs-number">8</span></span>,(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>),activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>, padding=<span class="hljs-string"><span class="hljs-string">"same"</span></span>)(pool3) conv4 = Conv2D(start_neurons*<span class="hljs-number"><span class="hljs-number">8</span></span>,(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>),activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>, padding=<span class="hljs-string"><span class="hljs-string">"same"</span></span>)(conv4) pool4 = MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>))(conv4) pool4 = Dropout(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)(pool4) <span class="hljs-comment"><span class="hljs-comment"># Middle convm = Conv2D(start_neurons*16,(3,3),activation="relu", padding="same")(pool4) convm = Conv2D(start_neurons*16,(3,3),activation="relu", padding="same")(convm) deconv4 = Conv2DTranspose(start_neurons * 8, (3, 3), strides=(2, 2), padding="same")(convm) uconv4 = concatenate([deconv4, conv4]) uconv4 = Dropout(0.5)(uconv4) uconv4 = Conv2D(start_neurons*8,(3,3),activation="relu", padding="same")(uconv4) uconv4 = Conv2D(start_neurons*8,(3,3),activation="relu", padding="same")(uconv4) deconv3 = Conv2DTranspose(start_neurons*4,(3,3),strides=(2, 2), padding="same")(uconv4) uconv3 = concatenate([deconv3, conv3]) uconv3 = Dropout(0.5)(uconv3) uconv3 = Conv2D(start_neurons*4,(3,3),activation="relu", padding="same")(uconv3) uconv3 = Conv2D(start_neurons*4,(3,3),activation="relu", padding="same")(uconv3) deconv2 = Conv2DTranspose(start_neurons*2,(3,3),strides=(2, 2), padding="same")(uconv3) uconv2 = concatenate([deconv2, conv2]) uconv2 = Dropout(0.5)(uconv2) uconv2 = Conv2D(start_neurons*2,(3,3),activation="relu", padding="same")(uconv2) uconv2 = Conv2D(start_neurons*2,(3,3),activation="relu", padding="same")(uconv2) deconv1 = Conv2DTranspose(start_neurons*1,(3,3),strides=(2, 2), padding="same")(uconv2) uconv1 = concatenate([deconv1, conv1]) uconv1 = Dropout(0.5)(uconv1) uconv1 = Conv2D(start_neurons*1,(3,3),activation="relu", padding="same")(uconv1) uconv1 = Conv2D(start_neurons*1,(3,3),activation="relu", padding="same")(uconv1) uncov1 = Dropout(0.5)(uconv1) output_layer = Conv2D(1,(1,1), padding="same", activation="sigmoid")(uconv1) return output_layer</span></span></code> </pre><br></div></div><br><h3> ç¬¬ä¸€ä¸ªå®éªŒã€‚ æœ€ç®€å•çš„ </h3><br> ä¸ºäº†ç®€åŒ–èµ·è§ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ç¬¬ä¸€ä¸ªå®éªŒç‰ˆæœ¬-æµ·æ´‹æ›´æµ…ï¼Œèˆ¹èˆ¶æ›´æš—ã€‚ ä¸€åˆ‡éƒ½éå¸¸ç®€å•æ˜äº†ï¼Œæˆ‘ä»¬å‡è®¾ç½‘ç»œå°†æ¯«æ— é—®é¢˜åœ°ä»¥ä»»ä½•ç²¾åº¦æ‰¾åˆ°èˆ¹åª/æ¤­åœ†ã€‚  next_pairå‡½æ•°ç”Ÿæˆä¸€å¯¹å›¾ç‰‡/é®ç½©ï¼Œå…¶ä¸­éšæœºé€‰æ‹©ä½ç½®ï¼Œå¤§å°ï¼Œæ—‹è½¬è§’åº¦ã€‚ æ­¤å¤–ï¼Œå°†å¯¹æ­¤åŠŸèƒ½è¿›è¡Œæ‰€æœ‰æ›´æ”¹-æ›´æ”¹é¢œè‰²ï¼Œå½¢çŠ¶ï¼Œå¹²æ¶‰ç­‰ã€‚ ä½†æ˜¯ï¼Œç°åœ¨æœ€ç®€å•çš„é€‰æ‹©æ˜¯ï¼Œæˆ‘ä»¬åœ¨æµ…è‰²èƒŒæ™¯ä¸Šæµ‹è¯•æš—èˆ¹çš„å‡è®¾ã€‚ <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_pair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> p = np.random.sample() - <span class="hljs-number"><span class="hljs-number">0.5</span></span> <span class="hljs-comment"><span class="hljs-comment">#    # r,c -    r = np.random.sample()*(w_size-2*radius_max) + radius_max c = np.random.sample()*(w_size-2*radius_max) + radius_max #      r_radius = np.random.sample()*(radius_max-radius_min) + radius_min c_radius = np.random.sample()*(radius_max-radius_min) + radius_min rot = np.random.sample()*360 #   rr, cc = ellipse( r, c, r_radius, c_radius, rotation=np.deg2rad(rot), shape=img_l.shape ) #     #   /    0.5  1.0 img = img_h.copy() #       0.0  0.5 img[rr, cc] = img_l[rr, cc] msk = np.zeros((w_size, w_size, 1), dtype='float32') msk[rr, cc] = 1. #     return img, msk</span></span></code> </pre><br> æˆ‘ä»¬ç”Ÿæˆäº†æ•´ä¸ªç«è½¦ï¼Œçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆã€‚ å®ƒçœ‹èµ·æ¥åƒæµ·ä¸Šçš„å°èˆ¹ï¼Œä»…æ­¤è€Œå·²ã€‚ ä¸€åˆ‡éƒ½æ¸…æ™°å¯è§ï¼Œæ¸…æ™°æ˜“æ‡‚ã€‚ è¯¥ä½ç½®æ˜¯éšæœºçš„ï¼Œæ¯å¼ å›¾ç‰‡ä¸­åªæœ‰ä¸€ä¸ªæ¤­åœ†ã€‚ <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(train_num): <span class="hljs-comment"><span class="hljs-comment">#   img train img, msk = next_pair() train_x[k] = img train_y[k] = msk fig, axes = plt.subplots(2, 10, figsize=(20, 5)) #    10   for k in range(10): axes[0,k].set_axis_off() axes[0,k].imshow(train_x[k]) axes[1,k].set_axis_off() axes[1,k].imshow(train_y[k].squeeze())</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/pf/cl/wa/pfclwaca6lntxzgsiplghwevvzk.png" alt="å›¾ç‰‡"><br><br> æ¯«æ— ç–‘é—®ï¼Œç½‘ç»œå°†æˆåŠŸå­¦ä¹ å¹¶å‘ç°æ¤­åœ†ã€‚ ä½†æ˜¯ï¼Œè®©æˆ‘ä»¬æ£€éªŒä¸€ä¸‹æˆ‘ä»¬çš„å‡è®¾ï¼Œå³è¯¥ç½‘ç»œç»è¿‡è®­ç»ƒå¯ä»¥æ‰¾åˆ°æ¤­åœ†/èˆ¹ï¼Œå¹¶ä¸”åŒæ—¶å…·æœ‰å¾ˆé«˜çš„å‡†ç¡®æ€§ã€‚ <br><br><pre> <code class="python hljs">input_layer = Input((w_size, w_size, <span class="hljs-number"><span class="hljs-number">3</span></span>)) output_layer = build_model(input_layer, <span class="hljs-number"><span class="hljs-number">16</span></span>) model = Model(input_layer, output_layer) model.compile(loss=bce_dice_loss, optimizer=Adam(lr=<span class="hljs-number"><span class="hljs-number">1e-3</span></span>), metrics=[my_iou_metric]) model.save_weights(<span class="hljs-string"><span class="hljs-string">'./keras.weights'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: history = model.fit(train_x, train_y, batch_size=<span class="hljs-number"><span class="hljs-number">32</span></span>, epochs=<span class="hljs-number"><span class="hljs-number">1</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">1</span></span>, validation_split=<span class="hljs-number"><span class="hljs-number">0.1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> history.history[<span class="hljs-string"><span class="hljs-string">'my_iou_metric'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0.75</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br> <code>Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 55s 7ms/step - loss: 0.2272 - my_iou_metric: 0.7325 - val_loss: 0.0063 - val_my_iou_metric: 1.0000 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 53s 7ms/step - loss: 0.0090 - my_iou_metric: 1.0000 - val_loss: 0.0045 - val_my_iou_metric: 1.0000 <br></code> <br><br> ç½‘ç»œæˆåŠŸæ‰¾åˆ°æ¤­åœ†ã€‚ ä½†è¿™å¹¶ä¸èƒ½å®Œå…¨è¯æ˜å¥¹æ­£åœ¨å¯»æ‰¾å…³äºäººç±»çš„æ¤­åœ†ï¼Œå› ä¸ºæ¤­åœ†åŒºåŸŸæ˜¯ä¸€ä¸ªä»¥æ¤­åœ†æ–¹ç¨‹ä¸ºè¾¹ç•Œå¹¶å¡«å……æœ‰ä¸èƒŒæ™¯ä¸åŒçš„å†…å®¹çš„åŒºåŸŸï¼Œå› æ­¤æ— æ³•ç¡®å®šç½‘ç»œæƒé‡æ˜¯å¦ç±»ä¼¼äºäºŒæ¬¡æ¤­åœ†æ–¹ç¨‹çš„ç³»æ•°ã€‚ å¾ˆæ˜æ˜¾ï¼Œæ¤­åœ†çš„äº®åº¦å°äºèƒŒæ™¯çš„äº®åº¦ï¼Œå¹¶ä¸”æ²¡æœ‰ç§˜å¯†æˆ–è°œè¯­-æˆ‘ä»¬å‡è®¾æˆ‘ä»¬åªæ˜¯æ£€æŸ¥äº†ä»£ç ã€‚ è®©æˆ‘ä»¬ä¿®å¤æ˜æ˜¾çš„é¢å­”ï¼Œä¹Ÿä½¿æ¤­åœ†çš„èƒŒæ™¯å’Œé¢œè‰²éšæœºã€‚ <br><br><h3> ç¬¬äºŒé€‰æ‹© </h3><br> ç°åœ¨ï¼Œç›¸åŒçš„æ¤­åœ†åœ¨åŒä¸€æ¡æµ·æ´‹ä¸Šï¼Œä½†æ˜¯æµ·æ´‹çš„é¢œè‰²ä»¥åŠèˆ¹çš„é¢œè‰²æ˜¯éšæœºé€‰æ‹©çš„ã€‚ å¦‚æœæµ·æ´‹æ›´é»‘ï¼Œåˆ™èˆ¹ä¼šæ›´äº®ï¼Œåä¹‹äº¦ç„¶ã€‚ å³ æ ¹æ®è¿™ç»„ç‚¹çš„äº®åº¦ï¼Œä¸å¯èƒ½ç¡®å®šå®ƒä»¬æ˜¯å¦åœ¨æ¤­åœ†ä¹‹å¤–ï¼Œå³å¤§æµ·è¿˜æ˜¯è¿™äº›åœ¨æ¤­åœ†å†…éƒ¨ã€‚ å†æ¬¡ï¼Œæˆ‘ä»¬æ£€éªŒæˆ‘ä»¬çš„å‡è®¾ï¼Œå³ç½‘ç»œå°†å‘ç°æ¤­åœ†è€Œä¸ç®¡é¢œè‰²å¦‚ä½•ã€‚ <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_pair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> p = np.random.sample() - <span class="hljs-number"><span class="hljs-number">0.5</span></span> <span class="hljs-comment"><span class="hljs-comment">#    / r = np.random.sample()*(w_size-2*radius_max) + radius_max c = np.random.sample()*(w_size-2*radius_max) + radius_max r_radius = np.random.sample()*(radius_max-radius_min) + radius_min c_radius = np.random.sample()*(radius_max-radius_min) + radius_min rot = np.random.sample()*360 rr, cc = ellipse( r, c, r_radius, c_radius, rotation=np.deg2rad(rot), shape=img_l.shape ) if p &gt; 0: #     img = img_l.copy() img[rr, cc] = img_h[rr, cc] else: #     img = img_h.copy() img[rr, cc] = img_l[rr, cc] msk = np.zeros((w_size, w_size, 1), dtype='float32') msk[rr, cc] = 1. return img, msk</span></span></code> </pre><br> ç°åœ¨ï¼Œé€šè¿‡åƒç´ åŠå…¶å‘¨å›´ç¯å¢ƒï¼Œæ— æ³•ç¡®å®šèƒŒæ™¯æˆ–æ¤­åœ†å½¢ã€‚ æˆ‘ä»¬è¿˜ç”Ÿæˆå›¾ç‰‡å’Œè’™ç‰ˆï¼Œå¹¶æŸ¥çœ‹å±å¹•ä¸Šçš„å‰10ä¸ªã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å»ºç­‘é¢å…·</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(train_num): img, msk = next_pair() train_x[k] = img train_y[k] = msk fig, axes = plt.subplots(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, figsize=(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10</span></span>): axes[<span class="hljs-number"><span class="hljs-number">0</span></span>,k].set_axis_off() axes[<span class="hljs-number"><span class="hljs-number">0</span></span>,k].imshow(train_x[k]) axes[<span class="hljs-number"><span class="hljs-number">1</span></span>,k].set_axis_off() axes[<span class="hljs-number"><span class="hljs-number">1</span></span>,k].imshow(train_y[k].squeeze())</code> </pre><br></div></div><br><br><img src="https://habrastorage.org/webt/fj/rz/vs/fjrzvsnrryaba58fxxb08mlmayu.png" alt="å›¾ç‰‡"><br><pre> <code class="python hljs">input_layer = Input((w_size, w_size, <span class="hljs-number"><span class="hljs-number">3</span></span>)) output_layer = build_model(input_layer, <span class="hljs-number"><span class="hljs-number">16</span></span>) model = Model(input_layer, output_layer) model.compile(loss=bce_dice_loss, optimizer=Adam(lr=<span class="hljs-number"><span class="hljs-number">1e-3</span></span>), metrics=[my_iou_metric]) model.load_weights(<span class="hljs-string"><span class="hljs-string">'./keras.weights'</span></span>, by_name=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: history = model.fit(train_x, train_y, batch_size=<span class="hljs-number"><span class="hljs-number">32</span></span>, epochs=<span class="hljs-number"><span class="hljs-number">1</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">1</span></span>, validation_split=<span class="hljs-number"><span class="hljs-number">0.1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> history.history[<span class="hljs-string"><span class="hljs-string">'my_iou_metric'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0.75</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br> <code>Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 56s 8ms/step - loss: 0.4652 - my_iou_metric: 0.5071 - val_loss: 0.0439 - val_my_iou_metric: 0.9005 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 55s 7ms/step - loss: 0.1418 - my_iou_metric: 0.8378 - val_loss: 0.0377 - val_my_iou_metric: 0.9206</code> <br> <br> ç½‘ç»œå¯ä»¥è½»æ¾åº”å¯¹å¹¶æ‰¾åˆ°æ‰€æœ‰æ¤­åœ†ã€‚ ä½†æ˜¯è¿™é‡Œå­˜åœ¨å®ç°ä¸Šçš„ç¼ºé™·ï¼Œè€Œä¸”ä¸€åˆ‡éƒ½å¾ˆæ˜æ˜¾-å›¾ç‰‡ä¸­ä¸¤ä¸ªåŒºåŸŸä¸­è¾ƒå°çš„ä¸€ä¸ªæ˜¯æ¤­åœ†å½¢ï¼Œå¦ä¸€ä¸ªèƒŒæ™¯ã€‚ ä¹Ÿè®¸è¿™æ˜¯ä¸€ä¸ªé”™è¯¯çš„å‡è®¾ï¼Œä½†ä»ç„¶å¯ä»¥è§£å†³ï¼Œå°†å¦ä¸€ä¸ªå¤šè¾¹å½¢æ·»åŠ åˆ°ä¸æ¤­åœ†é¢œè‰²ç›¸åŒçš„å›¾ç‰‡ä¸Šã€‚ <br><br><h3> ç¬¬ä¸‰é€‰æ‹© </h3><br> åœ¨æ¯å¼ å›¾ç‰‡ä¸­ï¼Œæˆ‘ä»¬ä»ä¸¤ä¸ªé€‰é¡¹ä¸­éšæœºé€‰æ‹©æµ·æ´‹çš„é¢œè‰²ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ¤­åœ†å’Œä¸€ä¸ªçŸ©å½¢ï¼Œä¸¤è€…å‡ä¸æµ·æ´‹çš„é¢œè‰²ä¸åŒã€‚ åŸæ¥æ˜¯ç›¸åŒçš„â€œæµ·æ´‹â€ï¼Œä¹Ÿæ˜¯æ¶‚æ¼†çš„â€œèˆ¹â€ï¼Œä½†æ˜¯åœ¨åŒä¸€å¼ å›¾ç‰‡ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸â€œèˆ¹â€ç›¸åŒé¢œè‰²çš„çŸ©å½¢ï¼Œå¹¶ä¸”å…·æœ‰éšæœºé€‰æ‹©çš„å¤§å°ã€‚ ç°åœ¨æˆ‘ä»¬çš„å‡è®¾æ›´åŠ å¤æ‚ï¼Œåœ¨å›¾ç‰‡ä¸­æœ‰ä¸¤ä¸ªé¢œè‰²ç›¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯æˆ‘ä»¬å‡è®¾ç½‘ç»œä»å°†å­¦ä¹ é€‰æ‹©æ­£ç¡®çš„å¯¹è±¡ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">ç»˜åˆ¶æ¤­åœ†å’ŒçŸ©å½¢çš„ç¨‹åº</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_pair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#        p = np.random.sample() - 0.5 r = np.random.sample()*(w_size-2*radius_max) + radius_max c = np.random.sample()*(w_size-2*radius_max) + radius_max r_radius = np.random.sample()*(radius_max-radius_min) + radius_min c_radius = np.random.sample()*(radius_max-radius_min) + radius_min rot = np.random.sample()*360 rr, cc = ellipse( r, c, r_radius, c_radius, rotation=np.deg2rad(rot), shape=img_l.shape ) p1 = np.rint(np.random.sample()*(w_size-2*radius_max) + radius_max) p2 = np.rint(np.random.sample()*(w_size-2*radius_max) + radius_max) p3 = np.rint(np.random.sample()*(2*radius_max - radius_min) + radius_min) p4 = np.rint(np.random.sample()*(2*radius_max - radius_min) + radius_min) #   /,    poly = np.array(( (p1, p2), (p1, p2+p4), (p1+p3, p2+p4), (p1+p3, p2), (p1, p2), )) rr_p, cc_p = polygon(poly[:, 0], poly[:, 1], img_l.shape) in_sc = list(set(rr) &amp; set(rr_p)) #   ,    #     #        if len(in_sc) &gt; 0: if np.mean(rr_p) &gt; np.mean(in_sc): poly += np.max(in_sc) - np.min(in_sc) else: poly -= np.max(in_sc) - np.min(in_sc) rr_p, cc_p = polygon(poly[:, 0], poly[:, 1], img_l.shape) if p &gt; 0: img = img_l.copy() img[rr, cc] = img_h[rr, cc] img[rr_p, cc_p] = img_h[rr_p, cc_p] else: img = img_h.copy() img[rr, cc] = img_l[rr, cc] img[rr_p, cc_p] = img_l[rr_p, cc_p] msk = np.zeros((w_size, w_size, 1), dtype='float32') msk[rr, cc] = 1. return img, msk</span></span></code> </pre><br></div></div><br> å’Œä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬è®¡ç®—å›¾ç‰‡å’Œè’™ç‰ˆå¹¶æŸ¥çœ‹å‰10å¯¹ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å»ºç­‘é¢å…·å›¾ç‰‡æ¤­åœ†å’ŒçŸ©å½¢</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(train_num): img, msk = next_pair() train_x[k] = img train_y[k] = msk fig, axes = plt.subplots(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, figsize=(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10</span></span>): axes[<span class="hljs-number"><span class="hljs-number">0</span></span>,k].set_axis_off() axes[<span class="hljs-number"><span class="hljs-number">0</span></span>,k].imshow(train_x[k]) axes[<span class="hljs-number"><span class="hljs-number">1</span></span>,k].set_axis_off() axes[<span class="hljs-number"><span class="hljs-number">1</span></span>,k].imshow(train_y[k].squeeze())</code> </pre><br></div></div><br><br><img src="https://habrastorage.org/webt/cg/p3/ak/cgp3ak3qbhsiecrrr2ge3mjxovc.png" alt="å›¾ç‰‡"><br><pre> <code class="python hljs">input_layer = Input((w_size, w_size, <span class="hljs-number"><span class="hljs-number">3</span></span>)) output_layer = build_model(input_layer, <span class="hljs-number"><span class="hljs-number">16</span></span>) model = Model(input_layer, output_layer) model.compile(loss=bce_dice_loss, optimizer=Adam(lr=<span class="hljs-number"><span class="hljs-number">1e-3</span></span>), metrics=[my_iou_metric]) model.load_weights(<span class="hljs-string"><span class="hljs-string">'./keras.weights'</span></span>, by_name=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: history = model.fit(train_x, train_y, batch_size=<span class="hljs-number"><span class="hljs-number">32</span></span>, epochs=<span class="hljs-number"><span class="hljs-number">1</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">1</span></span>, validation_split=<span class="hljs-number"><span class="hljs-number">0.1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> history.history[<span class="hljs-string"><span class="hljs-string">'my_iou_metric'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0.75</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre><br> <code>Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 57s 8ms/step - loss: 0.7557 - my_iou_metric: 0.0937 - val_loss: 0.2510 - val_my_iou_metric: 0.4580 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 55s 7ms/step - loss: 0.0719 - my_iou_metric: 0.8507 - val_loss: 0.0183 - val_my_iou_metric: 0.9812</code> <br> <br> ä¸å¯èƒ½æ··æ·†ç½‘ç»œçš„çŸ©å½¢ï¼Œæˆ‘ä»¬çš„å‡è®¾å¾—åˆ°äº†è¯å®ã€‚ ä»å®ä¾‹å’Œè®¨è®ºæ¥çœ‹ï¼Œç©ºå®¢ç«èµ›ä¸­çš„æ¯ä¸ªäººéƒ½åªæœ‰ä¸€è‰˜èˆ¹ï¼Œå‡ è‰˜èˆ¹éƒ½éå¸¸å‡†ç¡®åœ°åœ¨é™„è¿‘ã€‚ çŸ©å½¢çš„æ¤­åœ†-å³ å³ä½¿å¤šè¾¹å½¢çš„é¢œè‰²ä¸æ¤­åœ†ç›¸åŒï¼Œèˆ¹è¿˜æ˜¯æ¥è‡ªå²¸ä¸Šçš„æˆ¿å±‹ï¼Œç½‘ç»œä¹Ÿå¾ˆæ˜æ˜¾ã€‚ è¿™ä¸é¢œè‰²æ— å…³ï¼Œå› ä¸ºæ¤­åœ†å’ŒçŸ©å½¢å‡è¢«éšæœºåœ°ç»˜åˆ¶ã€‚ <br><br><h3> ç¬¬å››é€‰æ‹© </h3><br> ä¹Ÿè®¸ç½‘ç»œæ˜¯ç”¨çŸ©å½¢æ¥åŒºåˆ†çš„-æ­£ç¡®ï¼Œä½¿å®ƒä»¬å˜å½¢ã€‚ å³ ä¸è®ºå½¢çŠ¶å¦‚ä½•ï¼Œç½‘ç»œéƒ½å¯ä»¥è½»æ¾æ‰¾åˆ°ä¸¤ä¸ªå°é—­åŒºåŸŸï¼Œå¹¶ä¸¢å¼ƒçŸ©å½¢åŒºåŸŸã€‚ è¿™æ˜¯ä½œè€…çš„å‡è®¾-æˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œæ£€æŸ¥ï¼Œä¸ºæ­¤æˆ‘ä»¬å°†ä¸æ·»åŠ çŸ©å½¢ï¼Œè€Œæ˜¯æ·»åŠ ä»»æ„å½¢çŠ¶çš„å››è¾¹å½¢å¤šè¾¹å½¢ã€‚ åŒæ ·ï¼Œæˆ‘ä»¬çš„å‡è®¾æ˜¯ç½‘ç»œå°†æ¤­åœ†ä¸ç›¸åŒé¢œè‰²çš„ä»»æ„å››è¾¹å½¢å¤šè¾¹å½¢åŒºåˆ†å¼€ã€‚ <br><br> æ‚¨å½“ç„¶å¯ä»¥è¿›å…¥ç½‘ç»œçš„å†…éƒ¨ï¼Œç„¶åæŸ¥çœ‹å„å±‚å¹¶åˆ†ææƒé‡å’Œç­æ¬¡çš„å«ä¹‰ã€‚ ä½œè€…å¯¹ç½‘ç»œçš„æœ€ç»ˆè¡Œä¸ºæ„Ÿå…´è¶£ï¼›åˆ¤æ–­å°†åŸºäºå·¥ä½œçš„ç»“æœï¼Œå°½ç®¡ä»å†…éƒ¨çœ‹æ€»æ˜¯å¾ˆæœ‰è¶£çš„ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">æ›´æ”¹å›¾åƒç”Ÿæˆ</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_pair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> p = np.random.sample() - <span class="hljs-number"><span class="hljs-number">0.5</span></span> r = np.random.sample()*(w_size<span class="hljs-number"><span class="hljs-number">-2</span></span>*radius_max) + radius_max c = np.random.sample()*(w_size<span class="hljs-number"><span class="hljs-number">-2</span></span>*radius_max) + radius_max r_radius = np.random.sample()*(radius_max-radius_min) + radius_min c_radius = np.random.sample()*(radius_max-radius_min) + radius_min rot = np.random.sample()*<span class="hljs-number"><span class="hljs-number">360</span></span> rr, cc = ellipse( r, c, r_radius, c_radius, rotation=np.deg2rad(rot), shape=img_l.shape ) p0 = np.rint(np.random.sample()*(radius_max-radius_min) + radius_min) p1 = np.rint(np.random.sample()*(w_size-radius_max)) p2 = np.rint(np.random.sample()*(w_size-radius_max)) p3 = np.rint(np.random.sample()*<span class="hljs-number"><span class="hljs-number">2.</span></span>*radius_min - radius_min) p4 = np.rint(np.random.sample()*<span class="hljs-number"><span class="hljs-number">2.</span></span>*radius_min - radius_min) p5 = np.rint(np.random.sample()*<span class="hljs-number"><span class="hljs-number">2.</span></span>*radius_min - radius_min) p6 = np.rint(np.random.sample()*<span class="hljs-number"><span class="hljs-number">2.</span></span>*radius_min - radius_min) p7 = np.rint(np.random.sample()*<span class="hljs-number"><span class="hljs-number">2.</span></span>*radius_min - radius_min) p8 = np.rint(np.random.sample()*<span class="hljs-number"><span class="hljs-number">2.</span></span>*radius_min - radius_min) poly = np.array(( (p1, p2), (p1+p3, p2+p4+p0), (p1+p5+p0, p2+p6+p0), (p1+p7+p0, p2+p8), (p1, p2), )) rr_p, cc_p = polygon(poly[:, <span class="hljs-number"><span class="hljs-number">0</span></span>], poly[:, <span class="hljs-number"><span class="hljs-number">1</span></span>], img_l.shape) in_sc = list(set(rr) &amp; set(rr_p)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(in_sc) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> np.mean(rr_p) &gt; np.mean(in_sc): poly += np.max(in_sc) - np.min(in_sc) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: poly -= np.max(in_sc) - np.min(in_sc) rr_p, cc_p = polygon(poly[:, <span class="hljs-number"><span class="hljs-number">0</span></span>], poly[:, <span class="hljs-number"><span class="hljs-number">1</span></span>], img_l.shape) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> p &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: img = img_l.copy() img[rr, cc] = img_h[rr, cc] img[rr_p, cc_p] = img_h[rr_p, cc_p] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: img = img_h.copy() img[rr, cc] = img_l[rr, cc] img[rr_p, cc_p] = img_l[rr_p, cc_p] msk = np.zeros((w_size, w_size, <span class="hljs-number"><span class="hljs-number">1</span></span>), dtype=<span class="hljs-string"><span class="hljs-string">'float32'</span></span>) msk[rr, cc] = <span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> img, msk</code> </pre><br></div></div><br> æˆ‘ä»¬è®¡ç®—å›¾ç‰‡å’Œè’™ç‰ˆï¼Œå¹¶æŸ¥çœ‹å‰10å¯¹ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">æˆ‘ä»¬å»ºç«‹å›¾ç‰‡è’™ç‰ˆæ¤­åœ†å’Œå¤šè¾¹å½¢</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(train_num): img, msk = next_pair() train_x[k] = img train_y[k] = msk fig, axes = plt.subplots(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, figsize=(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10</span></span>): axes[<span class="hljs-number"><span class="hljs-number">0</span></span>,k].set_axis_off() axes[<span class="hljs-number"><span class="hljs-number">0</span></span>,k].imshow(train_x[k]) axes[<span class="hljs-number"><span class="hljs-number">1</span></span>,k].set_axis_off() axes[<span class="hljs-number"><span class="hljs-number">1</span></span>,k].imshow(train_y[k].squeeze())</code> </pre><br></div></div><br><br><img src="https://habrastorage.org/webt/qc/hl/xu/qchlxu1uxvjmm5ooktztuw1ewbq.png" alt="å›¾ç‰‡"><br> æˆ‘ä»¬å¯åŠ¨æˆ‘ä»¬çš„ç½‘ç»œã€‚ è®©æˆ‘æé†’æ‚¨ï¼Œæ‰€æœ‰é€‰é¡¹éƒ½ç›¸åŒã€‚ <br><br><pre> <code class="python hljs">input_layer = Input((w_size, w_size, <span class="hljs-number"><span class="hljs-number">3</span></span>)) output_layer = build_model(input_layer, <span class="hljs-number"><span class="hljs-number">16</span></span>) model = Model(input_layer, output_layer) model.compile(loss=bce_dice_loss, optimizer=Adam(lr=<span class="hljs-number"><span class="hljs-number">1e-3</span></span>), metrics=[my_iou_metric]) model.load_weights(<span class="hljs-string"><span class="hljs-string">'./keras.weights'</span></span>, by_name=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: history = model.fit(train_x, train_y, batch_size=<span class="hljs-number"><span class="hljs-number">32</span></span>, epochs=<span class="hljs-number"><span class="hljs-number">1</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">1</span></span>, validation_split=<span class="hljs-number"><span class="hljs-number">0.1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> history.history[<span class="hljs-string"><span class="hljs-string">'my_iou_metric'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0.75</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre><br> <code>Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 56s 8ms/step - loss: 0.6815 - my_iou_metric: 0.2168 - val_loss: 0.2078 - val_my_iou_metric: 0.4983 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 53s 7ms/step - loss: 0.1470 - my_iou_metric: 0.6396 - val_loss: 0.1046 - val_my_iou_metric: 0.7784 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 53s 7ms/step - loss: 0.0642 - my_iou_metric: 0.8586 - val_loss: 0.0403 - val_my_iou_metric: 0.9354 <br></code> <br> å‡è®¾å¾—åˆ°è¯å®ï¼Œå¤šè¾¹å½¢å’Œæ¤­åœ†å½¢å¾ˆå®¹æ˜“åŒºåˆ†ã€‚ ç»†å¿ƒçš„è¯»è€…ä¼šåœ¨è¿™é‡Œæ³¨æ„åˆ°-å½“ç„¶ï¼Œå®ƒä»¬æ˜¯ä¸åŒçš„ï¼Œè¿™æ˜¯èƒ¡è¯´å…«é“ï¼Œä»»ä½•æ­£å¸¸çš„AIéƒ½å¯ä»¥åŒºåˆ†ç¬¬äºŒé˜¶æ›²çº¿ä¸ç¬¬ä¸€é˜¶æ›²çº¿ã€‚ å³ ç½‘ç»œå¯ä»¥è½»æ¾åœ°ä»¥äºŒé˜¶æ›²çº¿çš„å½¢å¼ç¡®å®šè¾¹ç•Œçš„å­˜åœ¨ã€‚ æˆ‘ä»¬ä¸ä¼šäº‰è®ºï¼Œå°†æ¤­åœ†å½¢æ›¿æ¢ä¸ºä¸ƒè¾¹å½¢å¹¶è¿›è¡Œæ£€æŸ¥ã€‚ <br><br><h3> ç¬¬äº”å®éªŒï¼Œæœ€å›°éš¾ </h3><br> æ²¡æœ‰æ›²çº¿ï¼Œåªæœ‰è§„åˆ™å€¾æ–œå’Œæ—‹è½¬çš„ä¸ƒè¾¹å½¢ä»¥åŠä»»æ„å››è¾¹å½¢å¤šè¾¹å½¢çš„å…‰æ»‘é¢ã€‚ æˆ‘ä»¬å°†å›¾åƒ/é®ç½©ç”Ÿæˆå™¨çš„æ›´æ”¹å¼•å…¥åŠŸèƒ½ä¸­-ä»…æŠ•å½±æ­£åˆ™ä¸ƒè¾¹å½¢å’Œç›¸åŒé¢œè‰²çš„ä»»æ„å››è¾¹å½¢å¤šè¾¹å½¢ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å›¾åƒç”ŸæˆåŠŸèƒ½çš„æœ€ç»ˆä¿®è®¢ç‰ˆ</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_pair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_n = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> p = np.random.sample() - <span class="hljs-number"><span class="hljs-number">0.5</span></span> c_x = np.random.sample()*(w_size<span class="hljs-number"><span class="hljs-number">-2</span></span>*radius_max) + radius_max c_y = np.random.sample()*(w_size<span class="hljs-number"><span class="hljs-number">-2</span></span>*radius_max) + radius_max radius = np.random.sample()*(radius_max-radius_min) + radius_min d = np.random.sample()*<span class="hljs-number"><span class="hljs-number">0.5</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span> a_deg = np.random.sample()*<span class="hljs-number"><span class="hljs-number">360</span></span> a_rad = np.deg2rad(a_deg) poly = [] <span class="hljs-comment"><span class="hljs-comment">#    for k in range(_n): #     # _ _ -  poly.append(c_x+radius*math.sin(2.*k*math.pi/_n)) poly.append(c_y+radius*math.cos(2.*k*math.pi/_n)) # \  #    0.5  1.5  poly[-2] = (poly[-2]-c_x)/d +c_x poly[-1] = (poly[-1]-c_y) +c_y #     poly[-2] = ((poly[-2]-c_x)*math.cos(a_rad)\ - (poly[-1]-c_y)*math.sin(a_rad)) + c_x poly[-1] = ((poly[-2]-c_x)*math.sin(a_rad)\ + (poly[-1]-c_y)*math.cos(a_rad)) + c_y poly = np.rint(poly).reshape(-1,2) rr, cc = polygon(poly[:, 0], poly[:, 1], img_l.shape) p0 = np.rint(np.random.sample()*(radius_max-radius_min) + radius_min) p1 = np.rint(np.random.sample()*(w_size-radius_max)) p2 = np.rint(np.random.sample()*(w_size-radius_max)) p3 = np.rint(np.random.sample()*2.*radius_min - radius_min) p4 = np.rint(np.random.sample()*2.*radius_min - radius_min) p5 = np.rint(np.random.sample()*2.*radius_min - radius_min) p6 = np.rint(np.random.sample()*2.*radius_min - radius_min) p7 = np.rint(np.random.sample()*2.*radius_min - radius_min) p8 = np.rint(np.random.sample()*2.*radius_min - radius_min) poly = np.array(( (p1, p2), (p1+p3, p2+p4+p0), (p1+p5+p0, p2+p6+p0), (p1+p7+p0, p2+p8), (p1, p2), )) rr_p, cc_p = polygon(poly[:, 0], poly[:, 1], img_l.shape) in_sc = list(set(rr) &amp; set(rr_p)) if len(in_sc) &gt; 0: if np.mean(rr_p) &gt; np.mean(in_sc): poly += np.max(in_sc) - np.min(in_sc) else: poly -= np.max(in_sc) - np.min(in_sc) rr_p, cc_p = polygon(poly[:, 0], poly[:, 1], img_l.shape) if p &gt; 0: img = img_l.copy() img[rr, cc] = img_h[rr, cc] img[rr_p, cc_p] = img_h[rr_p, cc_p] else: img = img_h.copy() img[rr, cc] = img_l[rr, cc] img[rr_p, cc_p] = img_l[rr_p, cc_p] msk = np.zeros((w_size, w_size, 1), dtype='float32') msk[rr, cc] = 1. return img, msk</span></span></code> </pre><br></div></div><br> å’Œä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬æ„å»ºæ•°ç»„å¹¶æŸ¥çœ‹å‰10ä¸ªã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å»ºç­‘é¢å…·</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(train_num): img, msk = next_pair() train_x[k] = img train_y[k] = msk fig, axes = plt.subplots(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, figsize=(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10</span></span>): axes[<span class="hljs-number"><span class="hljs-number">0</span></span>,k].set_axis_off() axes[<span class="hljs-number"><span class="hljs-number">0</span></span>,k].imshow(train_x[k]) axes[<span class="hljs-number"><span class="hljs-number">1</span></span>,k].set_axis_off() axes[<span class="hljs-number"><span class="hljs-number">1</span></span>,k].imshow(train_y[k].squeeze())</code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/ze/fs/lv/zefslv3lqpbtq2vuvk0usrvpua8.png" alt="å›¾ç‰‡"><br><pre> <code class="python hljs">input_layer = Input((w_size, w_size, <span class="hljs-number"><span class="hljs-number">3</span></span>)) output_layer = build_model(input_layer, <span class="hljs-number"><span class="hljs-number">16</span></span>) model = Model(input_layer, output_layer) model.compile(loss=dice_loss, optimizer=Adam(lr=<span class="hljs-number"><span class="hljs-number">1e-3</span></span>), metrics=[my_iou_metric]) model.load_weights(<span class="hljs-string"><span class="hljs-string">'./keras.weights'</span></span>, by_name=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: history = model.fit(train_x, train_y, batch_size=<span class="hljs-number"><span class="hljs-number">32</span></span>, epochs=<span class="hljs-number"><span class="hljs-number">1</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">1</span></span>, validation_split=<span class="hljs-number"><span class="hljs-number">0.1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> history.history[<span class="hljs-string"><span class="hljs-string">'my_iou_metric'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0.75</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre><br> <code>Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 54s 7ms/step - loss: 0.5005 - my_iou_metric: 0.1296 - val_loss: 0.1692 - val_my_iou_metric: 0.3722 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 52s 7ms/step - loss: 0.1287 - my_iou_metric: 0.4522 - val_loss: 0.0449 - val_my_iou_metric: 0.6833 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 52s 7ms/step - loss: 0.0759 - my_iou_metric: 0.5985 - val_loss: 0.0397 - val_my_iou_metric: 0.7215 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 52s 7ms/step - loss: 0.0455 - my_iou_metric: 0.6936 - val_loss: 0.0297 - val_my_iou_metric: 0.7304 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 52s 7ms/step - loss: 0.0432 - my_iou_metric: 0.7053 - val_loss: 0.0215 - val_my_iou_metric: 0.7846 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 53s 7ms/step - loss: 0.0327 - my_iou_metric: 0.7417 - val_loss: 0.0171 - val_my_iou_metric: 0.7970 <br> Train on 7372 samples, validate on 820 samples <br> Epoch 1/1 <br> 7372/7372 [==============================] - 52s 7ms/step - loss: 0.0265 - my_iou_metric: 0.7679 - val_loss: 0.0138 - val_my_iou_metric: 0.8280</code> <br> <br><h3> æ€»ç»“ </h3><br> å¦‚æ‚¨æ‰€è§ï¼Œç½‘ç»œåœ¨æµ‹è¯•é›†ä¸ŠåŒºåˆ†å‡ºæ­£ä¸ƒè¾¹å½¢å’Œä»»æ„å››è¾¹å½¢å¤šè¾¹å½¢çš„æŠ•å½±ï¼Œç²¾åº¦ä¸º0.828ã€‚ ç½‘ç»œè®­ç»ƒè¢«0.75çš„ä»»æ„å€¼åœæ­¢ï¼Œæœ€æœ‰å¯èƒ½çš„å‡†ç¡®æ€§åº”è¯¥è¦å¥½å¾—å¤šã€‚ å¦‚æœæˆ‘ä»¬ä»ç½‘ç»œæ‰¾åˆ°åŸè¯­å¹¶ä¸”å®ƒä»¬çš„ç»„åˆç¡®å®šå¯¹è±¡è¿™ä¸€è®ºç‚¹å‡ºå‘ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œæœ‰ä¸¤ä¸ªåŒºåŸŸä¸èƒŒæ™¯çš„å¹³å‡å€¼ä¸åŒï¼Œåœ¨äººç±»çš„ç†è§£ä¸­å°±æ²¡æœ‰åŸè¯­äº†ã€‚ æ²¡æœ‰æ˜æ˜¾çš„å•è‰²çº¿ï¼Œä¹Ÿæ²¡æœ‰è§’ï¼Œåªæœ‰è¾¹ç•Œéå¸¸ç›¸ä¼¼çš„åŒºåŸŸã€‚ å³ä½¿æ‚¨æ„å»ºçº¿ï¼Œå›¾ç‰‡ä¸­çš„ä¸¤ä¸ªå¯¹è±¡éƒ½æ˜¯ä»ç›¸åŒçš„åŸºå…ƒæ„å»ºçš„ã€‚ <br><br> é‰´èµå®¶çš„é—®é¢˜-è¯¥ç½‘ç»œè¢«è§†ä¸ºæ˜¯â€œèˆ¹â€ä¸â€œå¹²æ‰°â€åŒºåˆ†å¼€çš„æ ‡å¿—ï¼Ÿ æ˜¾ç„¶ï¼Œè¿™ä¸æ˜¯èˆ¹åªè¾¹ç•Œçš„é¢œè‰²æˆ–å½¢çŠ¶ã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ç ”ç©¶â€œæµ·â€ /â€œèˆ¹â€çš„è¿™ç§æŠ½è±¡æ„é€ ï¼Œæˆ‘ä»¬ä¸æ˜¯ç§‘å­¦é™¢ï¼Œåªèƒ½å‡ºäºå¥½å¥‡è€Œè¿›è¡Œç ”ç©¶ã€‚ æˆ‘ä»¬å¯ä»¥å°†ä¸ƒè¾¹å½¢æ›´æ”¹ä¸ºå…«è¾¹å½¢ï¼Œæˆ–ä»¥è§„åˆ™çš„äº”è§’å’Œå…­è§’å¡«å……å›¾ç‰‡ï¼Œçœ‹çœ‹å®ƒä»¬çš„ç½‘ç»œæ˜¯å¦å¯åŒºåˆ†ã€‚ æˆ‘å°†å…¶ç•™ç»™è¯»è€…-å°½ç®¡æˆ‘ä¹Ÿæƒ³çŸ¥é“ç½‘ç»œæ˜¯å¦å¯ä»¥è®¡ç®—å¤šè¾¹å½¢çš„è§’ç‚¹æ•°é‡ï¼Œå¹¶ä¸”ä¸ºäº†è¿›è¡Œæµ‹è¯•ï¼Œåœ¨å›¾ç‰‡ä¸­ä¸æ’åˆ—è§„åˆ™çš„å¤šè¾¹å½¢ï¼Œè€Œæ˜¯æ’åˆ—å®ƒä»¬çš„éšâ€‹â€‹æœºæŠ•å½±ã€‚ <br><br> è¿™ç§èˆ¹è¿˜æœ‰å…¶ä»–åŒæ ·æœ‰è¶£çš„ç‰¹æ€§ï¼Œè¿™ç§å®éªŒçš„ç”¨å¤„åœ¨äºæˆ‘ä»¬è‡ªå·±è®¾ç½®äº†ç ”ç©¶é›†åˆçš„æ‰€æœ‰æ¦‚ç‡ç‰¹å¾ï¼Œè€Œç»è¿‡ç²¾å¿ƒç ”ç©¶çš„ç½‘ç»œçš„æ„å¤–è¡Œä¸ºå°†å¢åŠ çŸ¥è¯†å¹¶å¸¦æ¥æ”¶ç›Šã€‚ <br><br> éšæœºé€‰æ‹©èƒŒæ™¯ï¼Œéšæœºé€‰æ‹©é¢œè‰²ï¼Œéšæœºé€‰æ‹©èˆ¹/æ¤­åœ†ä½ç½®ã€‚ å›¾ç‰‡ä¸­æ²¡æœ‰çº¿æ¡ï¼Œå­˜åœ¨å…·æœ‰ä¸åŒç‰¹å¾çš„åŒºåŸŸï¼Œä½†æ˜¯æ²¡æœ‰å•è‰²çº¿æ¡ï¼ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“ç„¶ä¼šæœ‰ç®€åŒ–ï¼Œå¹¶ä¸”ä»»åŠ¡å¯èƒ½ä¼šæ›´åŠ å¤æ‚-ä¾‹å¦‚ï¼Œé€‰æ‹©0.0 ... 0.9å’Œ0.1 ... 1.0ä¹‹ç±»çš„é¢œè‰²-ä½†å¯¹äºç½‘ç»œè€Œè¨€åˆ™æ²¡æœ‰åŒºåˆ«ã€‚ ç½‘ç»œå¯ä»¥å‘ç°ä¸äººä»¬æ¸…æ¥šçœ‹åˆ°å’Œå‘ç°çš„æ¨¡å¼ä¸åŒçš„æ¨¡å¼ã€‚ <br><br> å¦‚æœå…¶ä¸­ä¸€ä½è¯»è€…æ„Ÿå…´è¶£ï¼Œåˆ™å¯ä»¥ç»§ç»­åœ¨ç½‘ç»œä¸Šè¿›è¡Œç ”ç©¶å’ŒæŒ‘é€‰ï¼Œå¦‚æœæ— æ³•è§£å†³æˆ–ä¸æ¸…æ¥šçš„äº‹ç‰©ï¼Œæˆ–è€…å‡ºç°äº†æ–°çš„å¥½æƒ³æ³•å¹¶ç»™å®ƒç•™ä¸‹æ·±åˆ»çš„å°è±¡ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥éšæ—¶ä¸æˆ‘ä»¬åˆ†äº«æˆ–è¯¢é—®å¤§å¸ˆï¼ˆä¹ŸåŒ…æ‹¬å¤§å¸ˆï¼‰å¹¶åœ¨ODSç¤¾åŒºå¯»æ±‚åˆæ ¼çš„å¸®åŠ©ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN431512/">https://habr.com/ru/post/zh-CN431512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN431502/index.html">iOSå¼€å‘äººå‘˜Kolesa Mobile 3.0ä¼šè®®ã€‚ å½±ç‰‡æŠ¥å‘Š</a></li>
<li><a href="../zh-CN431504/index.html">ç½‘ç»œé’“é±¼-ä½œå“ã€‚ iPhone XSç›—çªƒçºªäº‹ï¼Œç„¶åæ˜¯iCloudæ•°æ®ç›—çªƒ</a></li>
<li><a href="../zh-CN431506/index.html">LLDBä¸­çš„Xcodeå’Œé«˜çº§è°ƒè¯•ï¼šç¬¬1éƒ¨åˆ†</a></li>
<li><a href="../zh-CN431508/index.html">æ˜¥å­£é«˜æ•ˆçš„äº¤æ˜“ç®¡ç†</a></li>
<li><a href="../zh-CN431510/index.html">å¦‚ä½•ä»è½®å»“ä¸­æ”¶é›†ä¿¡æ¯ã€‚</a></li>
<li><a href="../zh-CN431514/index.html">é¢è¯•å®˜é¢è¯•</a></li>
<li><a href="../zh-CN431516/index.html">è´¢åŠ¡é¡¾é—®ç”Ÿæ´»ä¸­çš„ä¸€å¤©</a></li>
<li><a href="../zh-CN431518/index.html">Microsoft Connectï¼ˆï¼‰; è«æ–¯ç§‘èšä¼š</a></li>
<li><a href="../zh-CN431520/index.html">ä½¿ç”¨RFMæ–¹æ³•é¢„æµ‹ç”¨æˆ·æµå¤±</a></li>
<li><a href="../zh-CN431524/index.html">Javaä¸­çš„åºåˆ—åŒ–ã€‚ æ²¡é‚£ä¹ˆç®€å•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>