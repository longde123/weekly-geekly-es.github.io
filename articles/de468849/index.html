<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§õ üëµ üèöÔ∏è Unbekanntes Prozessor-Reverse Engineering in einem einzigen Programm üíô üïü üë®üèΩ‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR: Wir haben ein Programm f√ºr eine v√∂llig unbekannte CPU-Architektur ohne Dokumentation auf der CPU (ohne Emulator, ohne ISA, ohne alles) in nur ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unbekanntes Prozessor-Reverse Engineering in einem einzigen Programm</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468849/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mf/1z/aq/mf1zaqnw0lte41iurmzthf-qjbk.png"></div><br>  TL; DR: Wir haben ein Programm f√ºr eine v√∂llig unbekannte CPU-Architektur ohne Dokumentation auf der CPU (ohne Emulator, ohne ISA, ohne alles) in nur zehn Stunden r√ºckentwickelt.  Aus dem Artikel erfahren Sie, wie wir es gemacht haben ... <br><br>  Letztes Wochenende haben das CMU PPP-Team und ich am Dragon Sector Teaser CTF 2019-Team teilgenommen, um uns zu entspannen und von der harten Frist von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CHI 2020 abzuweichen</a> .  Dragon Sector ist ein angesehenes polnisches Team mit einer Geschichte interessanter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CTFs</a> . Ich habe mich gefragt, was sie auf Lager haben. <br><br>  Nachdem ich ‚Äûummmfpu‚Äú gel√∂st hatte, eine Aufgabe, die das Reverse Engineering des Bytecodes f√ºr den Micromega uM-FPU-Gleitkomma-Coprozessor beinhaltete, entschied ich mich, an einem Wettbewerb zur L√∂sung des CPU Adventure-Problems teilzunehmen, das zu diesem Zeitpunkt von keinem der Teams (als Ergebnis) gel√∂st wurde Wir waren die einzigen, die die Aufgabe erledigt haben. <br><br>  Hier ist eine Beschreibung der CPU Adventure-Aufgabe: <br><br><blockquote> Mein Gro√üvater war in den 60er Jahren mit der Entwicklung von Computern besch√§ftigt.  Als ich die Dinge auf seinem Dachboden in Ordnung brachte, fand ich ein seltsames Auto.  Neben der Maschine befand sich ein Stapel Lochkarten mit der Aufschrift ‚ÄûDragon Adventure Game‚Äú.  Nach einiger Zeit habe ich es geschafft, es an moderne Ger√§te anzuschlie√üen, aber das Spiel ist zu kompliziert und ich kann nicht bis zum Ende kommen, ohne zu schummeln.  Kannst du mir helfen?  Ich lege eine Transkription der in der Maschine verwendeten Lochkarten bei.  Es wird behauptet, dass die Maschine 4 Allzweckregister, 1 Kibibyte Datenspeicher und 32 Kibibyte Befehlsspeicher hat.  Um das Spiel zu spielen, stellen Sie wie folgt eine Verbindung zum Server her: <code>socat tcp4-connect:cpuadventure.hackable.software:1234 fd:0,rawer</code> Hinweis: Der Prozessor des Computers ist eindeutig. Versuchen Sie nicht, Informationen dar√ºber zu googeln. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">game.bin</a> </blockquote><a name="habracut"></a><br>  Nachdem wir uns mit dem Server verbunden haben, haben wir die folgenden Informationen erhalten: <br><br><blockquote> <code>THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS. <br> <br> SELECT AN OPTION: <br> <br> - GO (N)ORTH <br> - GO (E)AST <br> - (T)ALK TO VALIS <br> - (D)RINK <br> - SHOW (I)NVENTORY <br> <br> YOUR CHOICE:</code> </blockquote> <br>  Gro√üartig.  Dies ist ein Abenteuerspiel der alten Schule.  Nachdem wir es ein wenig gespielt hatten, stellten wir fest, dass Sie gegen Feinde k√§mpfen und eine Flagge von diesem Valis-Charakter erhalten k√∂nnen, wenn wir ihm gefallen: <br><br><blockquote> <code>YOUR CHOICE: T <br> <br> YOU ENTER THE TAVERN AND APPROACH VALIS. <br> <br> - HEY, I WAS WONDERING IF YOU COULD HELP ME FIND THE FLAG? <br> - THE FLAG? MAYBE, BUT FIRST, I NEED A REDBULL. <br> - I... I DON'T HAVE A REDBULL. <br> - WELL THEN, MAKE YOURSELF USEFUL AND FIND ONE. <br> <br> THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS. <br> <br> SELECT AN OPTION: <br> <br> - GO (N)ORTH <br> - GO (E)AST <br> - (T)ALK TO VALIS <br> - (D)RINK <br> - SHOW (I)NVENTORY <br> <br> YOUR CHOICE:</code> </blockquote> <br><h3>  Erste Schritte </h3><br>  Ich habe das Spiel nicht lange gespielt und festgestellt, dass es h√∂chstwahrscheinlich wichtiger ist, die Datei <code>game.bin</code> .  Ich habe es in einem Hex-Editor ge√∂ffnet und erwartet, dass Bin√§rwerte angezeigt werden.  Stellen Sie sich meine √úberraschung vor, als ich das sah: <br><br><pre>  1100111111010000001111001100100011100000110011010000000000001100100111010100000011010011111000011111001100111000000011 ... </pre><br><br>  Dies <em>ist buchst√§blich eine</em> Bin√§rdatei - eine Textdatei, die nichts anderes als die ASCII-Zeichen 1 und 0 enth√§lt. Wir wissen, dass dies h√∂chstwahrscheinlich der Maschinencode des Prozessors ist, aber zus√§tzlich zu 4 Registern, 1 KByte Datenspeicher und 32 Kibibyte des Befehlsspeichers, <em>nichts ist dar√ºber</em> bekannt.  Daher wird unsere erste ernsthafte Aufgabe darin bestehen, die Einheitsgr√∂√üe dieser Bin√§rdatei zu bestimmen (hat sie beispielsweise eine 8-Bit-Dimension? Oder vielleicht eine 12-Bit- oder 18-Bit-Dimension, wie in einigen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">alten Architekturen</a> ?). <br><br>  Um die Gr√∂√üe einer unbekannten Datei herauszufinden, habe ich einen alten Trick verwendet: Ich habe die Gr√∂√üe des Textfelds ge√§ndert, bis die Zeilenumbruchl√§nge der Ausrichtung entsprach.  Diese Methode eignet sich hervorragend f√ºr Dinge wie mehrere XOR-verschl√ºsselte Texte, unbekannte (unkomprimierte) Dateiformate und Code von einer unbekannten CPU: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b0/264/13d/7b026413d2a0beb1ad79904ab78ffb15.gif"></div><br>  <i>√Ñndern Sie die Gr√∂√üe des Textfelds</i> <br><br>  Bei dieser schnellen √úberpr√ºfung habe ich herausgefunden, dass die Einheitsgr√∂√üe dieser Datei ein Teiler von 20 sein sollte (die Breite des ausgerichteten Fensters).  Um die genaue Gr√∂√üe herauszufinden, habe ich schnell ein Skript geschrieben, das nach langen sich wiederholenden Zeilen sucht (vorausgesetzt, jeder Code hat sich wiederholende stereotype Sequenzen).  Die l√§ngste sich wiederholende Zeile war der folgende 425-Bit-Block, der bei 43625 und 44510 gefunden wurde: <br><br><pre>  10000011111110000001010100011111110100000101100010111000001001000101000100001000100001010001011000101000000001111111111100010000011110010100100001010100111100000110000010100000101000101000011110001111001101111001010100001010000111110100001010000110010011011110011111000000111011101000000001100000110000111101011010111011000100100010100000111000100011100011000000000101010101100010111000001010000001101010010000000011000001100 </pre><br>  Da der Abstand zwischen den Wiederholungen 885 betr√§gt, kamen wir zu dem Schluss, dass die Dimension 5 Bits betragen sollte, d. H.  Eine unbekannte CPU muss 5-Bit-Bytes haben.  Fortschritt! <br><br>  Wir suchten nach 5-Bit-Lochkartencodierungen und entschieden uns schnell f√ºr die alte Codierung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mit dem Baudot-Code</a> .  Und tats√§chlich - als wir den Online-Decoder zum Decodieren einiger Fragmente verwendeten, erhielten wir lesbaren Text! <br><br><blockquote>  ‚á©DRAGON‚á©HERE‚áß; ‚áß‚áß‚á©SHE‚á©APPEARS‚á©TO‚á©BE‚á©GUARDING‚á© EINIGE ART VON ‚á©A‚á©BOTTLE‚áß; &amp;. &amp;. ‚á©‚êÄTHERE‚á©IS‚á©A‚á©B <br><br>  <i>LSB Baudot ITA-erweiterter 425-Bit-Code</i> </blockquote><br>  Dann haben wir versucht, die gesamte Datei mit Bodo-Code zu dekodieren, aber in den ersten 20.000 Bits haben wir M√ºll bekommen, wonach es einen perfekt lesbaren Text gab.  Dies machte uns klar, dass der erste Teil der Datei zum Abschnitt ‚ÄûCode‚Äú geh√∂rt, gefolgt vom Abschnitt ‚ÄûDaten‚Äú, der konstante Zeilen enth√§lt.  Wir gingen davon aus, dass die Maschine wahrscheinlich Bodo-Code f√ºr E / A verwendet und daher konstante Zeilen in der Bodo-Codierung auch im Speicher speichert.  Um das Codesegment besser lesbar zu machen, habe ich beschlossen, es mit der Base-32-Codierung zu codieren, √§hnlich der hexadezimalen Codierung, aber mit dem Alphabet 0-9a-v zu erweitern.  So sieht die Datei game.bin aus, wobei der erste Teil von base-32 und der zweite Teil von Bodo codiert werden (die vollst√§ndige Datei finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">game.b32</a> ): <br><br><blockquote> <code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf1sf24p5f3r9c11qad0f0sf1df26p5f39c21qad0f05f1ff26p5f39c41qad0f08f1df26p5f39c81qad0f0hf1ef26p5f3r1c00qaq15c20qcl0f01f1of27p5f3p3g3psf35c10qal0f02f1nf27p5f3p3g3psf3rf0hf1nf27p5f3f05f16f27p5f3rf84f95101311fl0f510f84907qa40b518447qa40b514f84f95k9m0k9m0k9m0907qa40b511447qa40b512ruougf10f20g0i9g0i910931b320u2u1u0ro9f0o9f0ojh0o9f0o9f0o9f0olj0o9f0o9f0o9f0o9f0o9f0o9f0o9f0o9k1onp0o9f0o9f0o9f0o9f0onf0ot82odi0o9f0o9f0o9f0o9f0o9f0o9f0o9f0olg0o9f0f0gf1df24p5f3r9c11qa835548755 <br> [...] <br> 93e9n59ka8fo87r85g8ui8ml8ed87b9h89u291u82333333333456789abcdb01234567892)%c3BOTTLE OF SOPLICA PIGWOWAENEMY HEALTH: <br> <br> YOU ATTACK <br> <br> YOU APPROACH REDFORD. <br> <br> <br> <br> YOU ENTER THE TAVERN AND APPROACH VALIS. <br> [...]</code> </blockquote> <br>  Der Einfachheit halber werde ich unten F√ºnf-Bit-Einheiten "Bytes" nennen.  Im Team haben wir uns andere Namen f√ºr sie ausgedacht - ich nannte sie Knabbereien und Zak-Hacks. <br><br><h3>  Reverse Engineering unbekannter Prozessorarchitektur </h3><br>  Jetzt kommen wir zum schwierigen Teil - Reverse Engineering von 4000 Byte Code, der auf einer v√∂llig unbekannten, einzigartigen CPU-Architektur ausgef√ºhrt wird.  Aus dem Code geht hervor, dass dies eine Reihe von Anweisungen <em>variabler L√§nge sein sollte</em> , da darin kein erkennbares stabiles Wiederholungsmuster zu finden ist.  Ich verbrachte ein paar Stunden damit, sp√§ter begann mein Teammitglied Zachary Wade (@ zwad3) mir zu helfen.  Zun√§chst suchte ich nach doppelten Codeteilen, was darauf hindeutete, dass sie h√§ufig eine kleine Anzahl von Anweisungen verwenden w√ºrden.  Ich begann den Code in k√ºrzere sich wiederholende Sequenzen aufzuteilen, die f√ºr die Analyse bequemer waren.  Ich m√∂chte sagen, dass es ein strenger Prozess war, aber tats√§chlich wurde haupts√§chlich der folgende vage Algorithmus verwendet: <br><br><ul><li>  Wir schauen uns den Code an und pr√ºfen, ob sich darin sehr oft etwas wiederholt </li><li>  F√ºhren Sie die Such- und Ersetzungsprozedur durch, um neben dieser Wiederholung eine neue Zeile einzuf√ºgen </li><li>  Untersuchen Sie die √Ñhnlichkeiten / Unterschiede zwischen den resultierenden Trennlinien. </li><li>  Wiederholen Sie diesen Vorgang etwa eine Stunde lang ... </li></ul><br>  Zum Beispiel war eines der Muster, die ich entdeckte, "0f0.f", wobei "."  zeigt ein unbekanntes Zeichen an.  Ich habe die Schnur nach diesem Muster gebrochen und Folgendes erhalten: <br><br><blockquote> <code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf <br> 1sf24p5f3r9c11qad0f0sf <br> 1df26p5f39c21qad0f05f <br> 1ff26p5f39c41qad0f08f <br> 1df26p5f39c81qad0f0hf <br> 1ef26p5f3r1c00qaq15c20qcl0f01f <br> 1of27p5f3p3g3psf35c10qal0f02f</code> </blockquote> <br>  Sehr hilfreich!  In der zweiten und dritten Zeile sehen wir, dass es "... p5f3r9c ..." und "... p5f39c ..." gibt, und dies deutet darauf hin, dass "r" ein Einzelbyte-Opcode ist, dh "... 5f3" ist das Ende eines Opcodes und " 9c .. ‚Äùist der Anfang eines anderen.  In den letzten beiden Zeilen sehen wir "p5f3r1c ..." und dies bedeutet, dass "1c .." ein anderer Opcode ist und "p3 ..." auch ein anderer Opcode ist. <br><br>  Ich fuhr fort, Anweisungen auf √§hnliche Weise immer wieder aufzuteilen, wobei ich die √Ñhnlichkeiten und Unterschiede √§hnlicher Bl√∂cke verwendete, um wahrscheinliche Anweisungen zu finden.  Am Ende habe ich so etwas bekommen: <br><br><blockquote> <code>pv83 <br> pi70 <br> pk00 <br> p7a0 <br> qfgv <br> pjg3 <br> f0k <br> f13 <br> f28 <br> p5f3 <br> pv10 <br> pk40 <br> pn60 <br> f0s <br> f1s <br> f24 <br> p5f3 <br> r <br> 9c11 <br> qad0 <br> f0s <br> f1d <br> f26 <br> p5f3 <br> 9c21 <br> qad0 <br> f05 <br> f1f</code> </blockquote> <br>  Ich nahm an, dass "p" und "q" Anweisungen mit drei Bytes von Operanden waren, "f0", "f1" und "f2" Anweisungen mit einem Operanden waren und "9c" eine Anweisung mit zwei Operanden war.  Ich wusste jedoch nicht, was jede dieser Anweisungen ist. <br><br>  Also wandte ich mich dem Verzeichnis aller von mir hervorgehobenen "p" -Anweisungen zu und stellte fest, dass im Moment die h√§ufigsten Anweisungen mit "p" "p5f3" waren.  Als ich mir die Orte ansah, an denen es auftritt, stellte ich au√üerdem fest, dass immer die Anweisungen ‚Äûf0‚Äú, ‚Äûf1‚Äú und ‚Äûf2‚Äú vorangestellt sind.  Bei Betrachtung aller Operanden ‚Äûf0‚Äú, ‚Äûf1‚Äú und ‚Äûf2‚Äú habe ich festgestellt, dass die Operanden f2 immer im Bereich von 4 bis 8 liegen.  Als ich mich daran erinnerte, dass die CPU √ºber 32 KB Programmspeicher f√ºr die Adressierung verf√ºgt, was 15 Bit erfordert, nahm ich an, dass ‚Äûf0‚Äú, ‚Äûf1‚Äú und ‚Äûf2‚Äú eine Adresse mit f2 als High-Byte geladen haben.  Als ich einige dieser Adressen miteinander verband, stellte ich fest, dass sie alle genau auf den Anfang der konstanten Linien im Datenabschnitt zeigen.  Ich habe die <code>print</code> !  Es folgte sofort, dass "p5f3" tats√§chlich eine Art Anweisung zum Drucken einer Leitung oder eines Anrufs ist;  Wenn Sie den Drei-Byte-Operanden ber√ºcksichtigen, handelt es sich h√∂chstwahrscheinlich um einen ‚ÄûAufruf‚Äú.  Beim Betrachten der "p" -Anweisungen wurde mir wieder klar, dass die drei Bytes des Operanden die Adresse in <em>direkter Reihenfolge (Little-Endian)</em> angeben, <em>dh</em> das letzte Byte des Operanden ist das h√∂chste Byte der Adresse. <br><br>  Es war ein gro√üer Durchbruch!  Wir haben unsere erste Anweisung identifiziert.  Nachdem ich gesehen hatte, dass "f0" und "f1" an einigen anderen Stellen verwendet werden, nahm ich an, dass sie nicht die Adressen laden, sondern eines der vier Register (zum Beispiel l√§dt f0 das Register 0) mit 5-Bit-Konstanten mit direkter Adressierung.  Dies ist f√ºr p5f3 logisch - es werden drei Registerargumente f√ºr die 3f5-Funktion geladen (‚Äûprint_string‚Äú). <br><br>  Ich habe angefangen, einen Disassembler zu schreiben, der die Ausdrucksweise ‚ÄûDrucken‚Äú (f0x, f1x, f2x, p5f3) erkennt und die Ersetzung der gedruckten Zeile in den disassemblierten Code einf√ºgt.  Aufgrund der gro√üen Anzahl von Zeilen im Programm wurde der zerlegte Code schnell sehr gut lesbar und es wurde einfacher, die Position der Funktionsbl√∂cke herauszufinden (der vollst√§ndige zerlegte Code ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ): <br><br><blockquote> <code>0: call 38v <br> 4: call 7i <br> 8: call k <br> c: call a7 <br> g: q vgf <br> <br> k: call 3gj <br> o: print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00' <br> 15: call 1v <br> 19: call 4k <br> 1d: call 6n <br> 1h: print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00' <br> 1u: ret <br> <br> 1v: unk 9 <br> 20: unk c <br> 21: unk 1 <br> 22: unk 1 <br> 23: q 0da <br> 27: print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00' <br> 2k: unk 9 <br> 2l: unk c <br> 2m: unk 2 <br> 2n: unk 1 <br> 2o: q 0da <br> 2s: print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00' <br> 39: unk 9 <br> 3a: unk c <br> 3b: unk 4 <br> 3c: unk 1 <br> 3d: q 0da <br> 3h: print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00' <br> 3u: unk 9 <br> 3v: unk c <br> 40: unk 8 <br> 41: unk 1 <br> 42: q 0da <br> 46: print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00' <br> 4j: ret</code> </blockquote> <br>  Aus diesem kleinen Codefragment konnte ich verschiedene Aspekte herausfinden: Die Anweisung "q0" sollte eine bedingte Verzweigung anzeigen (da sie zum √úberspringen unn√∂tiger Anweisungen in Funktion 1v verwendet wird) und die Anweisungen "9c11", "9c21", "9c41", " 9c81 ‚Äúsollte eine Art UND-Anweisung anzeigen - sie √ºberpr√ºfen die gesetzten Bits, um festzustellen, ob diese Anweisungen zul√§ssig sind (dies wird durch die Verwendung von‚Äû 1 ‚Äú,‚Äû 2 ‚Äú,‚Äû 4 ‚Äúund‚Äû 8 ‚Äúin diesen Anweisungen deutlich angedeutet). <br><br>  In den n√§chsten zwei Stunden sortierten Zachary Wade (@ zwad3) und ich die verschiedenen Anweisungen aus und machten und verfeinerten unsere Annahmen dar√ºber, was sie taten.  Viele lesbare Druckaussagen haben uns die Arbeit erheblich erleichtert.  Wir beschlossen, dass jeder von uns einzeln seinen eigenen Disassembler schreibt, damit wir die Anweisungen in unserem eigenen Tempo pr√ºfen und unsere Ergebnisse teilen k√∂nnen. <br><br><h3>  Code Reverse Engineering </h3><br>  Nach ein paar Stunden machte ich gro√üe Fortschritte beim Zerlegen.  Nachdem wir den Code untersucht hatten, der mit dem Inventar des Benutzers zusammenarbeitete (genauer gesagt die Funktion ‚Äûdrink‚Äú und jeden damit verbundenen Handler), fanden wir Anweisungen zum Speichern und Laden aus dem Speicher (vergessen Sie nicht, dass die CPU √ºber 1 Kibibyte Datenspeicher verf√ºgt).  Dann fanden wir heraus, dass einige arithmetische / logische (ALU) Befehle Speicheroperanden verwenden (zum Beispiel bedeutet "9c41" "UND mit Wert an Datenadresse 1 mit Wert 4 ausf√ºhren").  Auf diese Weise konnten wir die Variablen im Datenspeicher neu erstellen, z. B. in [0] wird die NPC-Kennung am aktuellen Speicherort gespeichert und in [6,7] wird der aktuelle Zustand des Spielers gespeichert (die unteren 5 Bits in [6], die √§ltesten 5 Bits in [7] ]).  Zu diesem Zeitpunkt wechselte ich von den Anweisungen f√ºr das Reverse Engineering zum Kommentieren meines zerlegten Codes und zum Reverse Engineering des Programms selbst.  Unten ist meine lustige Notation f√ºr 5-Bit-Werte: <br><br><blockquote> <code>_start: <br> call init <br> <br> L4: <br> call check_moves <br> call print_menu <br> call handle_command <br> br 4 <br> <br> print_menu: <br> call print_itemname <br> print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00' <br> call print_moves <br> call print_npcmenu <br> call print_itemmenu <br> print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00' <br> ret <br> <br> print_moves: <br> and 0y1, [1] <br> brz 2k <br> print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00' <br> 2k: and 0y2, [1] <br> brz 39 <br> print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00' <br> 39: and 0y4, [1] <br> brz 3u <br> print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00' <br> 3u: and 0y8, [1] <br> brz 4j <br> print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00' <br> 4j: ret <br> <br> print_npcmenu: <br> add 0y0, [0] <br> brz 6m <br> sub 0y2, [0] <br> br&lt;c&gt; 5p <br> print 7o1 # '\x0e- (\x0fT\x0e)\x0fALK TO \x00' <br> call print_npcname <br> call print_crlf <br> 5p: sub 0y1, [0] <br> brz 6m <br> print 7n2 # '\x0e- (\x0fF\x0e)\x0fIGHT \x00' <br> call print_npcname <br> call print_crlf <br> 6m: ret <br> <br> print_itemmenu: <br> print 7nh # '\x0e- (\x0fD\x0e)\x0fRINK\r\n\x00' <br> print 765 # '\x0e- \x0fSHOW \x0e(\x0fI\x0e)\x0fNVENTORY\r\n\x00' <br> ret</code> </blockquote> <br>  Wir haben zum Beispiel immer noch viele unbekannte Opcodes, obwohl wir herausgefunden haben, dass ‚Äûqa‚Äú eine bedingte Verzweigung auf Null ist (Verzweigung auf Null, brz), konnten wir nicht verstehen, was ‚Äûqc‚Äú ist (oben angegeben als brc)).  Aber das war genug, um die Logik des Programms zu verstehen. <br><br>  Tats√§chlich erlaubt das Spiel dem Spieler, sich auf einer 8 √ó 8-Karte zu bewegen, auf der NPCs (Drachen, rote Stiere und Menschen) zuf√§llig platziert sind.  Du kannst mit jedem NPC k√§mpfen (sogar mit Valis, obwohl kein entsprechender Men√ºpunkt vorhanden ist).  W√§hrend des Kampfes k√∂nnen Sie den Feind angreifen und eine zuf√§llige Menge an Schaden oder Fehlschlag verursachen. Danach greift der Feind den Spieler an und verursacht auch eine zuf√§llige Menge an Schaden oder Fehlschlag.  Sie k√∂nnen auch eine Schildsperre w√§hlen, dank der der Feind den Schild entweder verfehlt oder trifft, ohne Schaden zu verursachen.  Schlie√ülich k√∂nnen Sie betr√ºgen, indem Sie Ihre Gesundheit auf 1000 erh√∂hen. In diesem Fall wird die versteckte Variable (‚Äûbetrogen‚Äú, Adresse 10) auf 1 gesetzt. Wenn der Spieler den Feind erfolgreich t√∂tet, f√§llt ein Gegenstand aus ihm heraus, normalerweise eine Flasche Alkohol (offensichtlich) Dieses Spiel ist nicht f√ºr Kinder. <br><br>  Der Haupt-NPC Valis, von dem der Spieler die Flagge erhalten muss, verf√ºgt √ºber eine Zustandsmaschine, in der er den Spieler nach mehreren Gegenst√§nden fragt - einer Reihe von Red Bull-Getr√§nken (offensichtlich erhalten, wenn er Red Bull-Feinde besiegt), verschiedenen Mixgetr√§nken (zum Beispiel Gin Tonic). Um sie zu erhalten, musst du den blauen und den grauen Drachen besiegen und dann die von ihnen abgeworfenen Objekte und die Steckdosenleiste mischen, die du erhalten kannst, wenn du eine andere NPC-Person im Spiel besiegst (Redford) oder ihm hilfst.  Wenn Sie all diese langen Reihen von Anfragen erf√ºllen, gibt er Ihnen die Flagge, aber <em>nur,</em> wenn die Variable ‚Äûbetrogen‚Äú nicht gleich 1 ist. Das hei√üt, unsere Aufgabe ist es, das Spiel ohne Betrug zu gewinnen.  Da wir wie alle Feinde mit nur 100 HP beginnen, ist es mit der √ºblichen Passage unm√∂glich, alle Feinde zu besiegen (um alle notwendigen Dinge zu bekommen, die Sie ben√∂tigen, um etwa 20 Gegner zu besiegen).  Es ist notwendig, das RNG irgendwie zu modifizieren, damit der Feind immer verfehlt. <br><br>  Zufallszahlen werden von einer Funktion generiert, die einer Art PRNG (Adresse 37a) √§hnelt, jedoch eindeutige Anweisungen verwendet, die nirgendwo anders verwendet werden, sodass wir sie nicht zur√ºckentwickeln k√∂nnen.  Wir haben jedoch festgestellt, dass es seinen Zustandsvektor von drei Adressen im Speicher l√§dt ([11], [12] und [13]), dh sein vollst√§ndiger Zustand ben√∂tigt nur 15 Bit.  Dies bedeutet, dass das RNG eine kurze Periode haben muss - nicht l√§nger als 2 ^ 15 = 32768. <br><br>  W√§hrend wir (erfolglos) versuchten, die RNG-Implementierung umzukehren, implementierten Jay Bosamia (@ jay_f0xtr0t) und Matthew Savage (@thebluepichu) einen Exploit.  Durch einfaches 100.000-maliges Senden des Befehls "Schild" in Folge konnten wir eine Folge von feindlichen "Treffern" und "Fehlschl√§gen" erhalten, die der vom RNG ausgegebenen Bit entsprechen.  Wir haben daf√ºr gesorgt, dass sich diese Sequenz mit einem Zeitraum von 32767 wiederholt. Dank dessen konnten wir unseren Haupt-Exploit zusammenstellen. Beim Kampf mit dem ersten Feind, den wir getroffen haben, haben wir unsere Schilde 40 Mal geschlossen, um die Sequenz von Treffern und Fehlschl√§gen wiederherzustellen, diese Sequenz in einer gro√üen periodischen Sequenz gesucht und dann herausgefunden wann abgeschirmt und wann angegriffen werden muss, damit der Feind immer verfehlt.  Dann haben wir einfach die ganze Karte im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mordhobo-</a> Modus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">umrundet</a> , alle get√∂tet und ihre Beute <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gesammelt</a> .  Am Ende kehrten wir nach Valis zur√ºck und fragten h√∂flich nach unserer Flagge, die wir erhielten: <br><br><blockquote> <code>DrgnS{m4kin9-v4lis-happy-w1th-n4t1ve-b4ud0t-cpu}</code> </blockquote> <br>  Fuh!  In der Tat ein echtes Abenteuer.  Ich kann immer noch nicht ganz glauben, dass wir in weniger als 10 Stunden von einer bin√§ren Zeichenfolge und einem v√∂lligen Mangel an Prozessordokumentation zu zwei fast vollst√§ndigen Disassemblern und einem sauberen disassemblierten Code gekommen sind!  Der gesamte Code ist auf GitHub verf√ºgbar: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mein Disassembler</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zacharys Disassembler</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mein roher disassemblierter Code</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mein kommentierter disassemblierter Code</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Matts Exploit-Client</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de468849/">https://habr.com/ru/post/de468849/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de468837/index.html">So f√ºhren Sie ein technisches Interview durch: einen Aktionsplan f√ºr Anf√§nger</a></li>
<li><a href="../de468841/index.html">Kontinuierliche Lieferung f√ºr Ihre Kotlin Multiplatform-Bibliothek</a></li>
<li><a href="../de468843/index.html">Haben Sie Angst, ein CRM-System zu implementieren? Ihr Gesch√§ft kann krank sein</a></li>
<li><a href="../de468845/index.html">Ein kurzer Kurs in der Physiologie der Stadt oder K√∂rperteile</a></li>
<li><a href="../de468847/index.html">√ñffentliches Beschaffungswesen in anderen L√§ndern: Warum Gesetze Rahmenbedingungen ben√∂tigen</a></li>
<li><a href="../de468851/index.html">Implementierung der Animation in React Native</a></li>
<li><a href="../de468853/index.html">Die Geschichte einer erfolgreichen Anwendung von SPR in einem Legacy-Projekt</a></li>
<li><a href="../de468859/index.html">‚ÄûRouter zum Pumpen‚Äú: TP-Link-Ger√§teoptimierung f√ºr Internetprovider</a></li>
<li><a href="../de468861/index.html">Positive Technologien erwecken 'Hackable City' in The Standoff Cyberbattle auf der HITB + CyberWeek zum Leben</a></li>
<li><a href="../de468863/index.html">Internals Go: Wrap-Loop-Variablen werden geschlossen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>