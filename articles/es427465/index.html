<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æ ‚òëÔ∏è üöî Lo que sucede detr√°s de escena en C #: lo b√°sico para trabajar con la pila üõê ü•à üëßüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sugiero mirar todo lo que se encuentra detr√°s de l√≠neas simples de objetos de inicializaci√≥n, m√©todos de llamada y par√°metros de paso. Bueno, por supu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lo que sucede detr√°s de escena en C #: lo b√°sico para trabajar con la pila</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427465/">  Sugiero mirar todo lo que se encuentra detr√°s de l√≠neas simples de objetos de inicializaci√≥n, m√©todos de llamada y par√°metros de paso.  Bueno, por supuesto, usar esta informaci√≥n en la pr√°ctica es restar la pila del m√©todo de llamada. <br><br><h3>  Descargo de responsabilidad </h3><br>  Antes de comenzar la historia, le recomiendo que lea la primera publicaci√≥n sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">StructLayout</a> , porque  Hay un ejemplo que se utilizar√° en este art√≠culo. <br><br>  Todo el c√≥digo detr√°s del nivel superior se presenta para el modo de <b>depuraci√≥n</b> , es √©l quien muestra la base conceptual.  Adem√°s, todo lo anterior se considera para una plataforma de 32 bits.  La optimizaci√≥n JIT es un tema separado y grande que no se considerar√° aqu√≠. <br><br>  Tambi√©n me gustar√≠a advertir que este art√≠culo no contiene material que deba usarse en proyectos reales. <br><br><h3>  Comienza con la teor√≠a </h3><br>  Cualquier c√≥digo finalmente se convierte en un conjunto de comandos de m√°quina.  Lo m√°s comprensible es su representaci√≥n en forma de instrucciones en lenguaje ensamblador que corresponden directamente a una (o varias) instrucciones de m√°quina. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ya/yv/k7/yayvk7f2o3tfr5flwaybim4u1m8.jpeg"></div><a name="habracut"></a><br>  Antes de pasar a un ejemplo simple, le sugiero que se familiarice con lo que es una pila de software.  <b>La pila de software</b> es principalmente una pieza de memoria que se usa, como regla, para almacenar varios tipos de datos (como regla, pueden llamarse <i>datos temporales</i> ).  Tambi√©n vale la pena recordar que la pila crece hacia direcciones m√°s bajas.  Es decir, cuanto m√°s tarde se inserte el objeto en la pila, menos ser√° su direcci√≥n. <br><br>  Ahora veamos el siguiente fragmento de c√≥digo en lenguaje ensamblador (omit√≠ algunas de las llamadas que son inherentes al modo de depuraci√≥n). <br><br>  C #: <br><br><pre><code class="plaintext hljs">public class StubClass { public static int StubMethod(int fromEcx, int fromEdx, int fromStack) { int local = 5; return local + fromEcx + fromEdx + fromStack; } public static void CallingMethod() { int local1 = 7, local2 = 8, local3 = 9; int result = StubMethod(local1, local2, local3); } }</code> </pre> <br>  Asm: <br><br><pre> <code class="plaintext hljs">StubClass.StubMethod(Int32, Int32, Int32) 1: push ebp 2: mov ebp, esp 3: sub esp, 0x10 4: mov [ebp-0x4], ecx 5: mov [ebp-0x8], edx 6: xor edx, edx 7: mov [ebp-0xc], edx 8: xor edx, edx 9: mov [ebp-0x10], edx 10: nop 11: mov dword [ebp-0xc], 0x5 12: mov eax, [ebp-0xc] 13: add eax, [ebp-0x4] 14: add eax, [ebp-0x8] 15: add eax, [ebp+0x8] 16: mov [ebp-0x10], eax 17: mov eax, [ebp-0x10] 18: mov esp, ebp 19: pop ebp 20: ret 0x4 StubClass.CallingMethod() 1: push ebp 2: mov ebp, esp 3: sub esp, 0x14 4: xor eax, eax 5: mov [ebp-0x14], eax 6: xor edx, edx 7: mov [ebp-0xc], edx 8: xor edx, edx 9: mov [ebp-0x8], edx 10: xor edx, edx 11: mov [ebp-0x4], edx 12: xor edx, edx 13: mov [ebp-0x10], edx 14: nop 15: mov dword [ebp-0x4], 0x7 16: mov dword [ebp-0x8], 0x8 17: mov dword [ebp-0xc], 0x9 18: push dword [ebp-0xc] 19: mov ecx, [ebp-0x4] 20: mov edx, [ebp-0x8] 21: call StubClass.StubMethod(Int32, Int32, Int32) 22: mov [ebp-0x14], eax 23: mov eax, [ebp-0x14] 24: mov [ebp-0x10], eax 25: nop 26: mov esp, ebp 27: pop ebp 28: ret</code> </pre><br>  Lo primero a lo que debe prestar atenci√≥n son los registros <b>EBP</b> y <b>ESP</b> y las operaciones con ellos. <br><br>  Una idea err√≥nea entre mis amigos es que el registro <b>EBP</b> est√° relacionado de alguna manera con un puntero a la parte superior de la pila.  Debo decir que esto no es as√≠. <br><br>  El registro <b>ESP</b> es responsable del puntero a la parte superior de la pila.  En consecuencia, con cada <b>comando PUSH</b> (coloca el valor en la parte superior de la pila), el valor de este registro disminuye (la pila crece hacia direcciones m√°s bajas), y con cada operaci√≥n <b>POP</b> se incrementa.  El comando <b>CALL</b> tambi√©n empuja la direcci√≥n de retorno a la pila, disminuyendo as√≠ el valor del registro <b>ESP</b> tambi√©n.  De hecho, cambiar el registro <b>ESP</b> no solo se realiza cuando se ejecutan estas instrucciones (por ejemplo, cuando se ejecutan llamadas de interrupci√≥n, lo mismo sucede cuando se ejecutan las instrucciones <b>CALL</b> ). <br><br>  Considere StubMethod. <br><br>  En la primera l√≠nea, el contenido del registro <b>EBP</b> se guarda (se inserta en la pila).  Antes de regresar de la funci√≥n, este valor ser√° restaurado. <br><br>  La segunda l√≠nea almacena el valor actual de la parte superior de la direcci√≥n de la pila (el valor del registro <b>ESP</b> se ingresa en <b>EBP</b> ).  En este caso, el registro <b>EBP</b> es un tipo de cero en el contexto de la llamada actual.  El direccionamiento se realiza en relaci√≥n con √©l.  A continuaci√≥n, movemos la parte superior de la pila a tantas posiciones como sea necesario para almacenar variables y par√°metros locales (tercera l√≠nea).  Algo as√≠ como asignar memoria para todas las necesidades locales. <br><br>  Todo lo anterior se llama funci√≥n de pr√≥logo. <br><br>  Despu√©s de eso, el acceso a las variables en la pila ocurre a trav√©s del <b>EBP</b> almacenado, que indica el lugar donde comienzan las variables de este m√©todo en particular. <br>  Lo siguiente es la inicializaci√≥n de variables locales. <br><br>  Recordatorio sobre <i>fastcall</i> : el .net nativo utiliza la <i>convenci√≥n de</i> llamadas <i>fastcall</i> . <br>  El acuerdo rige la ubicaci√≥n y el orden de los par√°metros pasados ‚Äã‚Äãa la funci√≥n. <br>  Con <i>fastcall, los</i> par√°metros primero y segundo se pasan a trav√©s de los registros <b>ECX</b> y <b>EDX</b> , respectivamente, y los par√°metros posteriores se pasan a trav√©s de la pila. <br><br>  Para los m√©todos no est√°ticos, el primer par√°metro es impl√≠cito y contiene la direcci√≥n del objeto en el que se llama el m√©todo (abordar esto). <br><br>  En las l√≠neas 4 y 5, los par√°metros que se transmitieron a trav√©s de los registros (los primeros 2) se almacenan en la pila. <br><br>  Lo siguiente es limpiar el espacio de la pila para variables locales e inicializar variables locales. <br><br>  Vale la pena recordar que el resultado de la funci√≥n est√° en el registro <b>EAX</b> . <br><br>  En las l√≠neas 12-16, se agregan las variables necesarias.  Llamo su atenci√≥n a la l√≠nea 15. Hay una llamada a la direcci√≥n, m√°s que al comienzo de la pila, es decir, a la pila del m√©todo anterior.  Antes de llamar, el m√©todo de llamada empuja el par√°metro a la parte superior de la pila.  Aqu√≠ lo leemos.  El resultado de la adici√≥n se extrae del registro <b>EAX</b> y se empuja a la pila.  Dado que este es el valor de retorno de StubMethod, se coloca nuevamente en <b>EAX</b> .  Por supuesto, tales conjuntos absurdos de instrucciones son inherentes solo al modo de depuraci√≥n, pero muestran c√≥mo se ve nuestro c√≥digo exactamente sin un optimizador inteligente que hace la mayor parte del trabajo. <br><br>  Las l√≠neas 18 y 19 restauran el <b>EBP</b> anterior (el m√©todo de llamada) y el puntero a la parte superior de la pila (en el momento en que se llam√≥ al m√©todo). <br><br>  La √∫ltima l√≠nea vuelve.  Sobre el valor 0x4 lo contar√© un poco m√°s bajo. <br>  Esta secuencia de comandos se llama ep√≠logo de la funci√≥n. <br><br>  Ahora echemos un vistazo a CallingMethod.  Vayamos directamente a la l√≠nea 18. Aqu√≠ colocamos el tercer par√°metro en la parte superior de la pila.  Tenga en cuenta que hacemos esto utilizando la instrucci√≥n <b>PUSH</b> , es decir, el valor <b>ESP</b> se reduce.  Los otros 2 par√°metros se colocan en registros ( <i>llamada r√°pida</i> ).  Lo siguiente es la llamada al m√©todo StubMethod.  Ahora recuerde la instrucci√≥n <b>RET 0x4</b> .  La siguiente pregunta es posible aqu√≠: ¬øqu√© es 0x4?  Como mencion√© anteriormente, empujamos los par√°metros de la funci√≥n llamada a la pila.  Pero ahora no los necesitamos.  0x4 indica que el byte necesita ser borrado de la pila despu√©s de la llamada a la funci√≥n.  Como hab√≠a un par√°metro, debe borrar 4 bytes. <br><br>  Aqu√≠ hay una imagen de pila de muestra: <br><br><img src="https://habrastorage.org/webt/vz/eo/vz/vzeovzr2rvkuetuzi4xyp4iuxye.png"><br><br>  Por lo tanto, si damos la vuelta y vemos lo que se encuentra en la parte posterior de la pila inmediatamente despu√©s de la llamada al m√©todo, lo primero que veremos es el <b>EBP</b> empujado a la pila (de hecho, esto sucedi√≥ en la primera l√≠nea del m√©todo actual).  A continuaci√≥n, habr√° una direcci√≥n de retorno que indica d√≥nde continuar√° la ejecuci√≥n (utilizada por la instrucci√≥n <b>RET</b> ).  Y a trav√©s de estos campos veremos los par√°metros mismos de la funci√≥n actual (a partir del 3, los par√°metros se transmiten a trav√©s de los registros anteriores).  ¬°Y detr√°s de ellos est√° la pila del m√©todo de llamada en s√≠! <br>  Los campos primero y segundo mencionados explican el desplazamiento en + 0x8 cuando se refieren a los par√°metros. <br>  En consecuencia, los par√°metros deben estar en la parte superior de la pila en un orden estrictamente definido cuando se llama a la funci√≥n.  Por lo tanto, antes de llamar al m√©todo, cada par√°metro se inserta en la pila. <br>  Pero, ¬øqu√© pasa si no los presiona y la funci√≥n a√∫n los aceptar√°? <br><br><h3>  Un peque√±o ejemplo </h3><br>  Entonces, todos los hechos mencionados anteriormente me hicieron tener un deseo irresistible de leer la pila de un m√©todo que llamar√° a mi funci√≥n.  La idea de que, literalmente, en una posici√≥n del tercer argumento (ser√° la m√°s cercana a la pila del m√©todo de llamada) est√°n los datos atesorados que deseo tanto obtener, no me dej√≥ dormir. <br><br>  Por lo tanto, para leer la pila del m√©todo de llamada, necesito ir un poco m√°s all√° de los par√°metros. <br><br>  Cuando se hace referencia a par√°metros, el c√°lculo de la direcci√≥n de un par√°metro se basa solo en el hecho de que el m√©todo de llamada los empuj√≥ a todos a la pila. <br><br>  Pero el paso impl√≠cito a trav√©s del par√°metro <b>EDX</b> (a qui√©n le importa, el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√∫ltimo art√≠culo</a> ) sugiere que podemos burlar al compilador en algunos casos. <br><br>  La herramienta que hice esto se llama StructLayoutAttribute (caracter√≠sticas en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primer art√≠culo</a> ).  // Alg√∫n d√≠a aprender√© algo diferente a este atributo, lo prometo. <br><br>  Usamos la misma t√©cnica favorita con tipos de referencia. <br><br>  Al mismo tiempo, si los m√©todos superpuestos tienen un n√∫mero diferente de par√°metros, obtenemos que el compilador no empujar√° los que necesitamos a la pila (como el imaginario, porque no sabe cu√°les). <br>  Sin embargo, el m√©todo que en realidad se llama (con el mismo desplazamiento de otro tipo) aborda las direcciones m√°s en relaci√≥n con su pila, es decir, aquellas en las que planea encontrar los par√°metros. <br><br>  Pero all√≠ no los encuentra y comienza a leer la pila del m√©todo de llamada. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de spoiler</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">using System; using System.Runtime.InteropServices; namespace Magic { public class StubClass { public StubClass(int id) { Id = id; } public int Id; } [StructLayout(LayoutKind.Explicit)] public class CustomStructWithLayout { [FieldOffset(0)] public Test1 Test1; [FieldOffset(0)] public Test2 Test2; } public class Test1 { public virtual void Useless(int skipFastcall1, int skipFastcall2, StubClass adressOnStack) { adressOnStack.Id = 189; } } public class Test2 { public virtual int Useless() { return 888; } } class Program { static void Main() { Test2 objectWithLayout = new CustomStructWithLayout { Test2 = new Test2(), Test1 = new Test1() }.Test2; StubClass adressOnStack = new StubClass(3); objectWithLayout.Useless(); Console.WriteLine($"MAGIC - {adressOnStack.Id}"); // MAGIC - 189 } } }</code> </pre><br></div></div><br>  No voy a dar el c√≥digo de idioma del ensamblador, todo est√° bastante claro all√≠, pero si tiene preguntas, intentar√© responderlas en los comentarios <br><br>  Entiendo perfectamente que este ejemplo no se puede usar en la pr√°ctica, pero en mi opini√≥n, puede ser muy √∫til para comprender el esquema general de trabajo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427465/">https://habr.com/ru/post/es427465/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427451/index.html">Conecte las tareas de phpStorm a Bitrix24</a></li>
<li><a href="../es427453/index.html">C√≥mo hice la transmisi√≥n de sonido en la Raspberry Pi</a></li>
<li><a href="../es427457/index.html">La tercera ola de IA y sistemas para la seguridad del estado</a></li>
<li><a href="../es427459/index.html">L√°mparas LED Diall de la tienda Castorama</a></li>
<li><a href="../es427461/index.html">La belleza de las funciones NO an√≥nimas en JavaScript</a></li>
<li><a href="../es427467/index.html">La introducci√≥n m√°s corta a la programaci√≥n reactiva</a></li>
<li><a href="../es427469/index.html">Ingresos y ganancias de los fabricantes de productos electr√≥nicos, o que tienen m√°s margen</a></li>
<li><a href="../es427471/index.html">Desarrollamos transporte no tripulado en la escuela secundaria con LEGO EV3</a></li>
<li><a href="../es427473/index.html">¬øQu√© problemas de liderazgo de equipo se pueden resolver con la ayuda del juego?</a></li>
<li><a href="../es427475/index.html">Android LiveData en Kotlin usando Retrofit y corutinas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>