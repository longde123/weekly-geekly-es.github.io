<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé± üõÉ üìÖ Escalada de privilegios de Windows ü•ß ü¶É üòª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√°ctica de gesti√≥n de seguridad de la informaci√≥n: pentest 
 Elevar los privilegios de usuario al nivel de administrador de dominio de Windows 

 Int...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escalada de privilegios de Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423937/"><h2>  Pr√°ctica de gesti√≥n de seguridad de la informaci√≥n: pentest </h2><br>  <b>Elevar los privilegios de usuario al nivel de administrador de dominio de Windows</b> <br><br><h4>  Introduccion </h4><br>  Un buen sistema de gesti√≥n de seguridad de la informaci√≥n (SGSI) requiere una evaluaci√≥n peri√≥dica de su eficacia.  Existen diferentes m√©todos para tales evaluaciones, una de cuyas variedades es la llamada.  "Prueba de penetraci√≥n" o pentest: una simulaci√≥n autorizada de un ataque de piratas inform√°ticos en un sistema de informaci√≥n para identificar vulnerabilidades en su protecci√≥n antes de que un atacante real las detecte.  En este caso, se puede utilizar cualquier herramienta de hacker, exploits, m√©todos, etc. disponibles en la vida real. <br><br>  Este art√≠culo describe una de estas pr√°cticas contra la pirater√≠a, que ten√≠a como objetivo aumentar los privilegios de un usuario de dominio ordinario de Microsoft Windows al nivel de un administrador de dominio.  El art√≠culo se bas√≥ en un informe sobre los resultados de una prueba que se puso en pr√°ctica.  Por razones de confidencialidad, toda la informaci√≥n que permite identificar el lugar (nombres de dominio y host, cuentas, etc.) se elimina o cambia.  El art√≠culo muestra las t√©cnicas b√°sicas, para una mejor comprensi√≥n, proporcion√© los fundamentos te√≥ricos y las vulnerabilidades utilizadas para versiones espec√≠ficas de los sistemas operativos, as√≠ como recomendaciones generales para la protecci√≥n.  Y aunque la mayor√≠a de estas versiones de Windows se considerar√°n obsoletas en el momento de la publicaci√≥n, este art√≠culo puede ser √∫til para los administradores de sistemas novatos para comprender mejor los m√©todos de protecci√≥n de credenciales en un entorno de Windows. <br><a name="habracut"></a><br><h4>  Descripci√≥n del objeto de prueba. </h4><br>  El objeto de prueba es bastante est√°ndar: el sistema de informaci√≥n de una peque√±a empresa (menos de 200 empleados) especializada en desarrollo de software.  La red interna de la compa√±√≠a tambi√©n es t√≠pica: dial-up Gigabit Ethernet, dominio de Microsoft Windows (lo llamaremos CORP.LOCAL).  Los hosts internos se dividen en subredes IP en funci√≥n de su afiliaci√≥n funcional (como: un grupo de desarrolladores, ingenieros de calidad, departamento de recursos humanos, contabilidad, marketing, alta direcci√≥n, instalaciones, etc.), toda la segmentaci√≥n se realiza en el conmutador L3 .  Tambi√©n hay un parque de servidores internos que est√° dedicado a una subred IP separada y contiene: dos controladores de dominio de Windows Server 2008 con DNS integrado, un servidor de correo interno que ejecuta Exchange, un servidor de archivos, un servidor de terminal y algunos otros servidores auxiliares que ejecutan Windows y Linux.  Por separado, vale la pena se√±alar un laboratorio de pruebas con una flota de m√°quinas que ejecutan diferentes versiones de Microsoft Windows (tanto de escritorio como de servidor) y est√°n dise√±adas para probar el software desarrollado.  El acceso a los hosts del laboratorio de pruebas est√° disponible para todos los empleados.  La versi√≥n principal del sistema operativo de escritorio es Windows 7. En las computadoras y servidores de escritorio, se instala un software antivirus mal configurado de diferentes fabricantes (de Symantec, Kaspersky y Trend Micro, por qu√© se discutir√° uno mal configurado m√°s adelante). <br><br><h4>  Modelo de intrusos </h4><br>  Intruso: un empleado interno que tiene una cuenta de usuario sin privilegios en el dominio, una computadora de escritorio, acceso f√≠sico a computadoras de prueba (posiblemente tiene una computadora port√°til corporativa), pero no tiene privilegios de administrador local en ninguna de ellas.  Adem√°s, la cuenta de intrusos no tiene la capacidad de cambiar la configuraci√≥n del software antivirus.  La intenci√≥n del atacante es obtener un acceso equivalente al acceso del administrador al controlador de dominio y / o al servidor de archivos. <br><br>  Como vemos, tanto el modelo del intruso como la descripci√≥n de la empresa son bastante t√≠picos. <br><br><h3>  Implementaci√≥n de ataque </h3><br><h4>  Paso 0. Recolecci√≥n de informaci√≥n sobre la red interna </h4><br>  Entonces, actuamos en nombre del delincuente.  En este paso, necesitamos recopilar informaci√≥n sobre: <br><br><ul><li>  direccionamiento interno y subredes </li><li>  nombres de host y direcciones IP, en primer lugar estamos interesados ‚Äã‚Äãen una lista de servidores </li><li>  utilizando el protocolo NetBIOS. </li></ul><br>  Primero, usando la utilidad ipconfig, obtenemos las direcciones IP de los servidores DNS: 192.168.12.1 y 192.168.12.2.  Porque  DNS est√° integrado con Active Directory, lo que nos da razones para creer que conocemos las direcciones IP de los controladores de dominio.  Luego, usando la utilidad nslookup en modo interactivo, intentamos obtener una lista de todos los hosts en la zona corp.local: <br><br>  <i>&gt; ls ‚Äìd corp.local&gt; archivo</i> <br><br>  De hecho, este comando inicia una transferencia de zona DNS completa y la guarda en un archivo.  Muchos administradores olvidan establecer restricciones en la transferencia de zona para la red interna, lo que facilita que un atacante potencial recopile informaci√≥n sobre la infraestructura de la compa√±√≠a, para m√°s detalles, consulte [12]. <br><br>  <b>Resultado</b>  √âxito  Una transferencia de zona desprotegida nos dio una lista completa de nombres de host internos, incluidos los servidores, y sus direcciones IP.  Utilizando las utilidades nbtstat, telnet, as√≠ como cualquiera de los esc√°neres de vulnerabilidad comunes, un atacante puede recopilar informaci√≥n sobre la plataforma, los servicios en ejecuci√≥n y las versiones del sistema operativo en los hosts que le interesan. <br><br><h4>  Paso 1. Obtener privilegios de administrador local </h4><br>  <b>Teor√≠a</b>  Para obtener la contrase√±a del administrador local, se aplica un ataque al valor hash de esta contrase√±a almacenada en el registro del sistema.  A pesar de que la funci√≥n hash es matem√°ticamente irreversible, el c√°lculo de la contrase√±a es posible mediante la enumeraci√≥n directa de sus valores junto con un ataque de diccionario.  Hist√≥ricamente, Windows ha utilizado dos algoritmos para calcular una funci√≥n hash de contrase√±a: el algoritmo LM heredado y el algoritmo NT m√°s nuevo (a veces tambi√©n llamado NTLM).  La funci√≥n hash de LM es vulnerable debido a su baja complejidad computacional, lo que hace posible enumerar sus valores incluso en una computadora d√©bil.  La presencia de hash de contrase√±as LM y NT en el registro del sistema garantiza que el atacante pueda descifrarla en un per√≠odo de tiempo aceptable.  El valor hash de LM en la configuraci√≥n predeterminada se almacena en el registro de Windows XP / 2003, lo que hace que estos sistemas sean especialmente atractivos para el hacker.  La funci√≥n de hash NT es computacionalmente m√°s compleja, sin embargo, enumerar sus valores se simplifica enormemente por el hecho de que hay disponibles tablas de valores precalculados (las llamadas tablas Rainbow); reducen el c√°lculo del valor de hash a la b√∫squeda del hash deseado entre valores precalculados <br><br>  <b>Objeto de ataque.</b>  Hashes de contrase√±a en la base de datos SAM (registro).  En nuestro caso, estas son todas las m√°quinas a las que tenemos acceso f√≠sico.  En primer lugar, este es nuestro escritorio de trabajo y, en segundo lugar, hosts para realizar pruebas. <br><br>  <b>Implementaci√≥n</b>  Con m√°quinas que tienen acceso f√≠sico, realizamos la siguiente operaci√≥n: arrancar desde un medio externo (usando un CD de entorno de preinstalaci√≥n de Windows o un CD de Linux Live), montar la partici√≥n del sistema NTFS y copiar las ramas de registro HKLM \ SYSTEM y HKLM \ SAM (% WINDIR archivos % \ System32 \ Config \ System y% WINDIR% \ System32 \ Config \ Sam respectivamente).  Prestamos especial atenci√≥n a las m√°quinas que ejecutan Windows XP \ Windows 2003, en las que es probable que se encuentre el hash LM.  Para volcar las contrase√±as de los archivos de registro copiados, utilizamos las herramientas [1], [2] (todos los enlaces al final del art√≠culo).  Resultado: <br><br><img src="https://habrastorage.org/webt/kn/jq/wm/knjqwm1nlf7ljjd99ndwh60bngg.png" alt="imagen"><br><br>  La √∫ltima l√≠nea contiene el hash NT requerido del administrador local.  En los hosts del laboratorio de pruebas (llamemos a estos hosts LAB1 y LAB2) encontramos un hash LM distinto de cero: <br><br><img src="https://habrastorage.org/webt/sz/wi/30/szwi30d1cje8gsfkiok70xtnuyy.png" alt="imagen"><br><br><img src="https://habrastorage.org/webt/1j/g5/l-/1jg5l-dgphti0eayxdcozs-onts.png" alt="imagen"><br><br>  Entonces, obtuvimos hashes NT y LM.  ¬øPero c√≥mo recuperar la contrase√±a de ellos?  Para hacer esto, usaremos las mismas herramientas [1], [2], as√≠ como los servicios de hash reverse en l√≠nea [8] - [11]: <br><br><img src="https://habrastorage.org/webt/qx/dk/70/qxdk70sdc94zqcuzmxkavjeu4tg.png" alt="imagen"><br><br>  Nota: la contrase√±a real consist√≠a en el nombre de la empresa con un peque√±o modificador y r√°pidamente se rompi√≥ bajo un ataque de diccionario). <br><br>  <b>Resultado</b>  √âxito  Contrase√±as (que sean "Pa $$ word1" y "Pa $$ word2") de la cuenta de administrador local de nuestro escritorio de trabajo y se han recibido dos computadoras de prueba.  ¬øPero ayudar√°n a obtener derechos de administrador de dominio?  Sobre esto m√°s all√°. <br><br><h4>  Paso 2. Obtenci√≥n de credenciales de administrador de dominio </h4><br>  <b>Teor√≠a</b>  En la mayor√≠a de los casos, es suficiente para obtener el valor del hash NT de la contrase√±a para el administrador del dominio.  Esto se debe al hecho de que cuando se verifica a un usuario utilizando el protocolo NTLM, el sistema autenticado solo presenta el hash NT al autenticador y no se realiza la verificaci√≥n de la contrase√±a.  El hash NT se puede obtener del llamado  Almacenamiento de LSA haciendo referencia al llamado  Sesiones de inicio de sesi√≥n de administrador (la sesi√≥n de inicio de sesi√≥n es un √°rea de datos especial creada por el proceso Winlogon donde el nombre de usuario, el dominio de inicio de sesi√≥n y el valor de hash de la contrase√±a NT se almacenan, en conjunto, esto se denomina secreto LSA).  Este proceso de NTLM es utilizado por el proceso NTLMSSP para la autenticaci√≥n NTLM.  La sesi√≥n de inicio de sesi√≥n se guarda todo el tiempo mientras la cuenta se conecta al sistema.  Tambi√©n puede interceptar un hash NT desde una sesi√≥n de autenticaci√≥n de administrador NTLM.  Adem√°s, es posible obtener una contrase√±a de administrador del cach√© de Credenciales en cach√© de dominio (DCC).  DCC es un cach√© local que se completa cuando un usuario inicia sesi√≥n con √©xito en un dominio.  El prop√≥sito de la cach√© DCC es poder autenticar al usuario cuando el controlador de dominio no est√° disponible. <br><br>  <b>Atacar objetos:</b> <br><br><ul><li>  DCC hashes (rama de registro HKLM \ Security). </li><li>  Sesi√≥n de inicio de sesi√≥n de administrador de dominio (LSA-secret). </li><li>  Intercepci√≥n de sesiones NTLM (no considerado debido a una mayor complejidad pr√°ctica). </li></ul><br>  <b>Practica</b>  Muchos administradores de Windows usan una cuenta de administrador de dominio para realizar varios tipos de operaciones en las computadoras de los usuarios.  Al mismo tiempo, sus datos caen en el cach√© DCC.  Por lo tanto, primero intente obtener la contrase√±a del cach√© DCC.  Vamos a nuestra estaci√≥n de trabajo, guardamos la rama de registro HKLM \ Security e importamos a [1].  Porque  tenemos una contrase√±a de administrador local, ya no necesitamos iniciar la m√°quina desde medios externos para guardar el registro: <br><br><img src="https://habrastorage.org/webt/up/6p/v3/up6pv3qirtuto8wcxfk6lkofkqq.png" alt="imagen"><br><br>  El cach√© contiene los datos de la contrase√±a de tres cuentas.  La √∫ltima cuenta (*** usuario) no nos interesa, la segunda cuenta no tiene los privilegios requeridos, pero el usuario shadmin se parece al administrador que est√° buscando.  Desafortunadamente, el algoritmo MS-CACHE2 tiene una gran complejidad computacional y un ataque directo de fuerza bruta sobre √©l es ineficiente.  La funci√≥n MS-CACHEv2 contiene un "secreto computacional" - salt (el nombre de la cuenta se usa como "salt"), lo que lo protege contra ataques a las tablas Rainbow.  Sin embargo, en el futuro, pueden aparecer tablas de valores hash para cuentas est√°ndar: "Administrador", "Administrador", etc.  En aras del inter√©s, enviamos el "hash de cach√©" encontrado al servicio en la nube [8] - [11] (sobre los resultados y la eficacia de dichos servicios al final del art√≠culo).  Mientras la nube est√° pensando, estamos tratando de encontrar otros DCC.  Analizamos la lista de hosts obtenida en el paso 0, verificamos a qu√© servidores podemos acceder bajo el administrador local utilizando las contrase√±as obtenidas en el paso 1. Dado que el administrador local est√° bloqueado en el controlador de dominio y el servidor de correo generalmente est√° mejor protegido, debe experimentar con Servidores secundarios.  En nuestro caso, se encontr√≥ un servidor con el discreto nombre Upd en la lista de servidores.  El inicio de sesi√≥n con la contrase√±a "Pa $$ word2" encontrada en el paso 1 es exitosa.  Encontramos eso en el host Upd: <br><br><ol><li>  No hay software antivirus instalado. </li><li>  Ejecuta Apache, que es el servidor de administraci√≥n para el antivirus corporativo (esto significa que tambi√©n hay una contrase√±a para la cuenta utilizada para instalar el software antivirus de forma remota y, en teor√≠a, puede sacarlo de all√≠). </li><li>  El host no audita los intentos fallidos de inicio de sesi√≥n. </li><li>  Versi√≥n del sistema operativo: Windows 2008 R2. </li></ol><br>  Despu√©s de descargar el registro HKLM \ Security, obtenemos el hash DCC de la cuenta CORP.LOCAL \ Administrator (y varias otras): <br><br><img src="https://habrastorage.org/webt/a5/3t/--/a53t--0v2fycjxm29xiytiqri3g.png" alt="imagen"><br><br>  Te√≥ricamente, puede intentar encontrar la contrase√±a para el Administrador a trav√©s de un servicio en la nube.  Sin embargo, como mencion√© anteriormente, un ataque de fuerza bruta en MS-CACHEv2 es in√∫til (aunque es posible que en un par de a√±os la situaci√≥n cambie).  Deje solo DCC y contin√∫e buscando sesiones de inicio de sesi√≥n.  Compruebe qu√© usuario ha iniciado sesi√≥n en el host Upd: <br><br><img src="https://habrastorage.org/webt/57/ri/fa/57rifa8peyelwyvtbw6d4nwrofu.png" alt="imagen"><br><br>  Vemos que dos sesiones inactivas se cuelgan en la m√°quina Upd: el administrador y el usuario Shadmin, que ya conocemos, lo que significa que podemos obtener NT-hash de sus contrase√±as robando el secreto LSA.  Esta es la clave para determinar el √©xito de todo el ataque.  Para robar un hash, usa el exploit Lslsass [3].  Para ejecutarlo, necesita derechos de administrador local (o m√°s bien, derechos para depurar procesos), que ya tenemos.  Obtenemos la lista de secretos de LSA (en el formato "dominio \ cuenta: LM hash: NT hash :::"): <br><br><pre><code class="hljs pgsql">lslsass v1<span class="hljs-number"><span class="hljs-number">.0</span></span> - Copyright (C) <span class="hljs-number"><span class="hljs-number">2010</span></span> Bjorn Brolin, Truesec (www.truesec.com) <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> Lsass pid: <span class="hljs-number"><span class="hljs-number">520</span></span> Lsass process <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:&lt;i&gt;<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e&lt;/i&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>\UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; c690e441dc78bc5da8b389e78daa6392 &lt;/b&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \shadmin::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; <span class="hljs-number"><span class="hljs-number">5794</span></span>cba8b464364eacf366063ff70e78 &lt;/b&gt; :::</code> </pre> <br>  Las l√≠neas resaltadas en negrita contienen los hashes de contrase√±a necesarios.  Tambi√©n tenga en cuenta el hash en cursiva en la sexta l√≠nea.  Ya lo hemos visto en alguna parte, ¬øverdad? <br><br>  <b>Resultado</b>  √âxito  Tenemos el hash de contrase√±a NT de la cuenta de administrador de dominio en nuestras manos.  Pero, ¬øde qu√© sirve un hash si no es posible restaurar la contrase√±a original en un tiempo aceptable?  Sobre esto en el siguiente paso. <br><br><h4>  Paso 3. Hacer trampa en la sesi√≥n de autenticaci√≥n NTLM </h4><br>  <b>Teor√≠a</b>  Windows nunca usa una contrase√±a pura para la autenticaci√≥n, el sistema autenticado siempre presenta un hash.  Esto da lugar a la idea: al reemplazar el nombre de usuario, el dominio de inicio de sesi√≥n y el hash de NT en la sesi√≥n de inicio de sesi√≥n del usuario conectado con los valores de administrador de dominio correspondientes, podemos autenticarnos utilizando el protocolo NTLM antes del sistema remoto como administrador de dominio.  Este ataque [7] es posible solo con autenticaci√≥n usando el protocolo NTLM.  A pesar del uso generalizado del protocolo Kerberos, NTLM es la √∫nica forma posible de autenticar a un cliente cuando accede a un recurso compartido de red no es por nombre simb√≥lico, sino por direcci√≥n IP [13]. <br><br>  <b>Objeto de ataque.</b>  Sesi√≥n de inicio de sesi√≥n del administrador local. <br><br>  <b>Practica</b>  Hay varios exploits disponibles que le permiten implementar un ataque en las plataformas Windows Server 2008 x86 y x64.  El exploit principal es el Editor de credenciales de Windows [4].  Para llevar a cabo el ataque, vamos al host LAB2 usando las credenciales "Administrador" \ "Pa $$ word2".  Con [4], reemplazamos el nombre de la cuenta, el dominio de inicio de sesi√≥n y los datos hash de NT en la sesi√≥n de inicio de sesi√≥n con los valores Shadmin correspondientes que obtuvimos en el paso anterior: <br><br><img src="https://habrastorage.org/webt/ww/kp/hc/wwkphcbxcv5fjhsrlk_1ydcakze.png" alt="imagen"><br><br>  El nombre de la cuenta del administrador del dominio y su hash NT se pasan al comando wce como argumento desde la l√≠nea de comandos.  Resultado: el hash se modific√≥ correctamente.  Observo que la membres√≠a del usuario en el grupo y el token de acceso no cambian durante el ataque: <br><br><img src="https://habrastorage.org/webt/jg/jn/ym/jgjnymw3o3j8yv9cfd1sjojagbe.png" alt="imagen"><br><br>  Todav√≠a somos el administrador local, el nombre de host en verde en la captura de pantalla anterior est√° manchado con verde - LAB2.  Sin embargo, durante la autenticaci√≥n NTLM, el sistema remoto recibir√° el nombre de dominio CORP.LOCAL, el nombre de usuario Shadmin y el hash de contrase√±a Shadmin.  Aqu√≠ hay un volcado de un √∫nico paquete de red que contiene la sesi√≥n de blob de seguridad NTLM: <br><br><img src="https://habrastorage.org/webt/tt/c7/_x/ttc7_xrvp9e81zvathjqultz5sc.png" alt="imagen"><br><br>  El nombre de dominio (CORP.LOCAL) y el nombre de host (LAB2) est√°n atenuados en verde), se presenta una cuenta: Shadmin.  Ahora intentamos conectarnos a la partici√≥n ra√≠z del volumen del sistema en el controlador de dominio con el comando net use utilizando la direcci√≥n IP del controlador de dominio: <br><br><img src="https://habrastorage.org/webt/ja/ga/2h/jaga2h8xrnj_wbn5acv-fe6zlqs.png" alt="imagen"><br><br>  Con exito.  Para verificar el acceso, cre√© un archivo de texto en la ra√≠z (encu√©ntralo en la captura de pantalla).  Despu√©s de crear un archivo por lotes en el disco del controlador de dominio con la secuencia de comandos que necesitamos, podemos, utilizando [5], realizar la operaci√≥n necesaria en el controlador de dominio (por ejemplo, agregar el usuario al grupo de administradores de dominio).  La operaci√≥n se realizar√° con los derechos de la cuenta Shadmin.  Para ilustrar, cree un archivo por lotes simple en un host remoto que agregue un usuario local: <br><br>  <i>usuario neto TstUsr Pa $$ palabra / agregar</i> <br><br>  Ejec√∫telo de forma remota desde el host LAB2: <br><br><img src="https://habrastorage.org/webt/q3/3l/qf/q33lqf4cb4u9rw8zwqpcfpwhw-c.png" alt="imagen"><br><br>  Se ejecutar√° en el sistema remoto 192.168.13.125 con los privilegios del usuario de nuestra sesi√≥n actual: shadmin (es decir, administrador de dominio).  Comprobamos: <br><br><img src="https://habrastorage.org/webt/cq/oj/wp/cqojwpt8bb1c0volgimww9gsv-c.png" alt="imagen"><br><br>  La segunda salida del comando net user muestra al nuevo usuario.  A pesar de la imposibilidad de iniciar aplicaciones que requieren la interacci√≥n interactiva del usuario de esta manera (por ejemplo, complementos MMC), se puede realizar una amplia gama de acciones mediante scripts. <br><br>  <b>Resultado</b>  √âxito  Obtuvo acceso al sistema de archivos y al shell del controlador de dominio. <br><br><h4>  Resumen </h4><br>  Brevemente, la cadena de ataque se ve√≠a as√≠: Recopilando informaci√≥n sobre la estructura de la red -&gt; Obteniendo una contrase√±a de administrador local -&gt; Usando esta contrase√±a para iniciar sesi√≥n en uno de los servidores secundarios -&gt; Robo de credenciales de administrador de dominio "dejado desatendido" -&gt; Modificando su sesi√≥n de inicio de sesi√≥n y escalada de privilegios. <br><br>  El √©xito del ataque fue facilitado por: <br><br><ol><li>  Protecci√≥n d√©bil de la zona DNS de la transferencia a hosts no confiables. </li><li>  Pol√≠tica de contrase√±a d√©bil.  La mayor√≠a de las computadoras de dominio usaban la misma contrase√±a para la cuenta de administrador local, que era vulnerable a un ataque de diccionario. </li><li>  La ausencia o configuraci√≥n d√©bil de software antivirus en hosts cr√≠ticos. </li><li>  Protecci√≥n de hash de contrase√±a d√©bil: dos sesiones de inicio de sesi√≥n de administrador inactivas en el host Upd, hash de LM en la base de datos SAM. </li><li>  Mala pol√≠tica de auditor√≠a. </li></ol><br><br>  En base a esto, se pueden derivar recomendaciones generales de protecci√≥n: <br><br>  0. Ocultar completamente la estructura interna de la red de posibles atacantes.  Por lo tanto, los usuarios no deber√≠an poder obtener el contenido completo del archivo de zona DNS.  Los usuarios que no son de confianza (por ejemplo, aprendices, empleados que no han completado el per√≠odo de prueba, etc.) tiene sentido transferir a una subred separada usando NAT para falsificar direcciones (incluyendo, por ejemplo, modificar respuestas DNS). <br><br>  1. La pol√≠tica correcta para asignar contrase√±as al administrador local.  La contrase√±a del administrador local debe ser diferente en los hosts que tienen diferentes grados de protecci√≥n contra el acceso no autorizado.  Comprometer la contrase√±a del administrador local en cualquiera de los hosts del dominio deber√≠a minimizar la posibilidad de que un atacante use esta contrase√±a. <br><br>  2. El almacenamiento del hash LM en SAM debe estar prohibido por las pol√≠ticas de seguridad. <br><br>  3. No utilice el nombre de la empresa o su dominio como parte de la contrase√±a del administrador) Esto dificultar√° que un atacante ataque el diccionario.  Pero incluso utilizando una contrase√±a compleja, no se olvide de usted mismo y verifique regularmente su hash para mayor durabilidad utilizando los servicios en l√≠nea. <br><br>  4. No se recomienda realizar operaciones de rutina en equipos de dominio desde la cuenta de administrador de dominio.  Esto proteger√° la cuenta de la interceptaci√≥n de los datos de la sesi√≥n de inicio de sesi√≥n y del ingreso del hash de contrase√±a en el cach√© DCC. <br><br>  5. Establezca una regla para no dejar desatendida la sesi√≥n de inicio de sesi√≥n del administrador del dominio.  Pr√°ctica recomendada: trabajo terminado: cierre sesi√≥n. <br><br>  6. Las utilidades de falsificaci√≥n de LSA son bastante peque√±as.  Tiene sentido rastrear su evoluci√≥n y verificar su detecci√≥n exitosa por el software antivirus corporativo. <br><br>  7. Un usuario, incluso con derechos de administrador local, no deber√≠a poder cambiar la configuraci√≥n de un antivirus corporativo.  Desactivar el servicio antivirus en las estaciones de trabajo de dominio deber√≠a generar una notificaci√≥n al administrador del dominio (en este sentido, Symantec Endpoint Protection funcion√≥ bien durante la prueba). <br><br><h4>  Ap√©ndice 1. Comportamiento antivirus </h4><br>  Las computadoras de la compa√±√≠a usaban tres tipos de antivirus: KAV, actual en el momento de la prueba de Symantec Endpoint Protection, y un producto obsoleto de Trend Micro.  En la mayor√≠a de los casos, las herramientas utilizadas durante el ataque se identificaron como Hack Tool / Rootkit / Trojan.  KAV los elimin√≥ sin previo aviso, y SEP (incluso apagado) emiti√≥ un aviso y lo movi√≥ a cuarentena para evitar que se inicie.  Sin embargo, tener derechos de administrador local le permite deshabilitar KAV, y la protecci√≥n SEP se omiti√≥ configurando manualmente una ruta de excepci√≥n para la verificaci√≥n, nuevamente utilizando la cuenta de administrador local.  El antivirus de Trend Micro instalado en algunos hosts no reaccion√≥ de ninguna manera al lanzamiento de exploits. <br><br><h4>  Anexo 2. Eficiencia del uso de servicios de verificaci√≥n de hash en l√≠nea </h4><br>  Hay muchos servicios en l√≠nea disponibles para probar la solidez de los hashes de contrase√±as.  Le permiten trabajar con los hashes m√°s comunes: LM, NTLM, MD4, MD5, WPA, con hashes que usan sal, etc.  Para verificar el hash, la enumeraci√≥n directa se usa utilizando el poder de procesamiento de las GPU modernas, la enumeraci√≥n de diccionarios, los ataques h√≠bridos, etc.  Una vez abierto, el hash puede reponer la base de datos y ser utilizado en el futuro.  El servicio puede ser gratuito para verificar una contrase√±a corta (menos de 8 caracteres) o cobrar una peque√±a tarifa.  Durante la prueba utilic√© cuatro de estos servicios, los enlaces se dan al final del art√≠culo.  Envi√© varios hashes encontrados en el paso 2 y despu√©s de 15 meses recib√≠ una notificaci√≥n del servicio On-line Hash Crack [9] sobre la restauraci√≥n exitosa de uno de ellos) <br><br><h4>  Referencias </h4><br>  <b>Herramientas usadas</b> <br><br>  [1] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cain &amp; Abel</a> : una herramienta de recuperaci√≥n de contrase√±a para los sistemas operativos de Microsoft.  Permite la recuperaci√≥n f√°cil de varios tipos de contrase√±as al rastrear la red, descifrar contrase√±as cifradas mediante ataques de Diccionario, Fuerza Bruta y Criptoan√°lisis, grabar conversaciones VoIP, decodificar contrase√±as codificadas, recuperar claves de red inal√°mbricas, revelar cajas de contrase√±as, descubrir contrase√±as almacenadas en cach√© y analizar rutas protocolos <br>  [2] Grieta L0pht. <br>  [3] Explotaci√≥n de Lslsass.  Vuelca los hash de contrase√±a de sesi√≥n de inicio de sesi√≥n activo del proceso lsass. <br>  [4] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Editor de credenciales de Windows</a> post-exploit.  Herramienta para cambiar las credenciales de inicio de sesi√≥n. <br>  [5] PsExec de PS Tools <br><br>  <b>Descripciones detalladas de vulnerabilidad</b> <br><br>  [6] Serie de art√≠culos "Obtenci√≥n efectiva de un hash de contrase√±a en Windows" en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.securitylab.ru</a> <br>  [7] Pass-the-Hash, una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descripci√≥n de un ataque</a> a un sistema remoto al proporcionarle un hash comprometido. <br><br>  <b>Servicios de hackeo de Cloud Hash</b> <br>  [8] Question-defense.com (parece estar fuera de servicio en el momento de la publicaci√≥n () <br>  [9] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.onlinehashcrack.com</a> <br>  [10] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.cloudcracker.com</a> <br>  [11] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Asesino de hash en l√≠nea</a> <br><br>  <b>Materiales adicionales</b> <br><br>  [12] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Seguridad y ajuste de DNS en Windows Server</a> <br>  [13] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kerberos no se utiliza cuando se conecta a recursos compartidos SMB utilizando la direcci√≥n IP</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es423937/">https://habr.com/ru/post/es423937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es423925/index.html">Abrir webinar "Plantilla recursiva extra√±a"</a></li>
<li><a href="../es423927/index.html">10 motores de b√∫squeda prometedores para mejorar el SEO</a></li>
<li><a href="../es423931/index.html">¬øC√≥mo omitir la autenticaci√≥n por SMS cuando se conecta a redes Wi-Fi p√∫blicas?</a></li>
<li><a href="../es423933/index.html">Microsoft Office Security: objetos incrustados</a></li>
<li><a href="../es423935/index.html">Embox responde a preguntas populares del festival TechTrain IT</a></li>
<li><a href="../es423939/index.html">Programaci√≥n din√°mica o dividir y conquistar</a></li>
<li><a href="../es423941/index.html">Informes de iOS mitap Redmadrobot</a></li>
<li><a href="../es423943/index.html">Optimizaci√≥n de precios minoristas fuera de l√≠nea</a></li>
<li><a href="../es423945/index.html">La Corte Suprema especific√≥ el procedimiento para considerar casos con repost y likes</a></li>
<li><a href="../es423947/index.html">Nuestros datos personales no le cuestan nada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>