<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎱 🛃 📅 Escalada de privilegios de Windows 🥧 🦃 😻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Práctica de gestión de seguridad de la información: pentest 
 Elevar los privilegios de usuario al nivel de administrador de dominio de Windows 

 Int...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escalada de privilegios de Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423937/"><h2>  Práctica de gestión de seguridad de la información: pentest </h2><br>  <b>Elevar los privilegios de usuario al nivel de administrador de dominio de Windows</b> <br><br><h4>  Introduccion </h4><br>  Un buen sistema de gestión de seguridad de la información (SGSI) requiere una evaluación periódica de su eficacia.  Existen diferentes métodos para tales evaluaciones, una de cuyas variedades es la llamada.  "Prueba de penetración" o pentest: una simulación autorizada de un ataque de piratas informáticos en un sistema de información para identificar vulnerabilidades en su protección antes de que un atacante real las detecte.  En este caso, se puede utilizar cualquier herramienta de hacker, exploits, métodos, etc. disponibles en la vida real. <br><br>  Este artículo describe una de estas prácticas contra la piratería, que tenía como objetivo aumentar los privilegios de un usuario de dominio ordinario de Microsoft Windows al nivel de un administrador de dominio.  El artículo se basó en un informe sobre los resultados de una prueba que se puso en práctica.  Por razones de confidencialidad, toda la información que permite identificar el lugar (nombres de dominio y host, cuentas, etc.) se elimina o cambia.  El artículo muestra las técnicas básicas, para una mejor comprensión, proporcioné los fundamentos teóricos y las vulnerabilidades utilizadas para versiones específicas de los sistemas operativos, así como recomendaciones generales para la protección.  Y aunque la mayoría de estas versiones de Windows se considerarán obsoletas en el momento de la publicación, este artículo puede ser útil para los administradores de sistemas novatos para comprender mejor los métodos de protección de credenciales en un entorno de Windows. <br><a name="habracut"></a><br><h4>  Descripción del objeto de prueba. </h4><br>  El objeto de prueba es bastante estándar: el sistema de información de una pequeña empresa (menos de 200 empleados) especializada en desarrollo de software.  La red interna de la compañía también es típica: dial-up Gigabit Ethernet, dominio de Microsoft Windows (lo llamaremos CORP.LOCAL).  Los hosts internos se dividen en subredes IP en función de su afiliación funcional (como: un grupo de desarrolladores, ingenieros de calidad, departamento de recursos humanos, contabilidad, marketing, alta dirección, instalaciones, etc.), toda la segmentación se realiza en el conmutador L3 .  También hay un parque de servidores internos que está dedicado a una subred IP separada y contiene: dos controladores de dominio de Windows Server 2008 con DNS integrado, un servidor de correo interno que ejecuta Exchange, un servidor de archivos, un servidor de terminal y algunos otros servidores auxiliares que ejecutan Windows y Linux.  Por separado, vale la pena señalar un laboratorio de pruebas con una flota de máquinas que ejecutan diferentes versiones de Microsoft Windows (tanto de escritorio como de servidor) y están diseñadas para probar el software desarrollado.  El acceso a los hosts del laboratorio de pruebas está disponible para todos los empleados.  La versión principal del sistema operativo de escritorio es Windows 7. En las computadoras y servidores de escritorio, se instala un software antivirus mal configurado de diferentes fabricantes (de Symantec, Kaspersky y Trend Micro, por qué se discutirá uno mal configurado más adelante). <br><br><h4>  Modelo de intrusos </h4><br>  Intruso: un empleado interno que tiene una cuenta de usuario sin privilegios en el dominio, una computadora de escritorio, acceso físico a computadoras de prueba (posiblemente tiene una computadora portátil corporativa), pero no tiene privilegios de administrador local en ninguna de ellas.  Además, la cuenta de intrusos no tiene la capacidad de cambiar la configuración del software antivirus.  La intención del atacante es obtener un acceso equivalente al acceso del administrador al controlador de dominio y / o al servidor de archivos. <br><br>  Como vemos, tanto el modelo del intruso como la descripción de la empresa son bastante típicos. <br><br><h3>  Implementación de ataque </h3><br><h4>  Paso 0. Recolección de información sobre la red interna </h4><br>  Entonces, actuamos en nombre del delincuente.  En este paso, necesitamos recopilar información sobre: <br><br><ul><li>  direccionamiento interno y subredes </li><li>  nombres de host y direcciones IP, en primer lugar estamos interesados ​​en una lista de servidores </li><li>  utilizando el protocolo NetBIOS. </li></ul><br>  Primero, usando la utilidad ipconfig, obtenemos las direcciones IP de los servidores DNS: 192.168.12.1 y 192.168.12.2.  Porque  DNS está integrado con Active Directory, lo que nos da razones para creer que conocemos las direcciones IP de los controladores de dominio.  Luego, usando la utilidad nslookup en modo interactivo, intentamos obtener una lista de todos los hosts en la zona corp.local: <br><br>  <i>&gt; ls –d corp.local&gt; archivo</i> <br><br>  De hecho, este comando inicia una transferencia de zona DNS completa y la guarda en un archivo.  Muchos administradores olvidan establecer restricciones en la transferencia de zona para la red interna, lo que facilita que un atacante potencial recopile información sobre la infraestructura de la compañía, para más detalles, consulte [12]. <br><br>  <b>Resultado</b>  Éxito  Una transferencia de zona desprotegida nos dio una lista completa de nombres de host internos, incluidos los servidores, y sus direcciones IP.  Utilizando las utilidades nbtstat, telnet, así como cualquiera de los escáneres de vulnerabilidad comunes, un atacante puede recopilar información sobre la plataforma, los servicios en ejecución y las versiones del sistema operativo en los hosts que le interesan. <br><br><h4>  Paso 1. Obtener privilegios de administrador local </h4><br>  <b>Teoría</b>  Para obtener la contraseña del administrador local, se aplica un ataque al valor hash de esta contraseña almacenada en el registro del sistema.  A pesar de que la función hash es matemáticamente irreversible, el cálculo de la contraseña es posible mediante la enumeración directa de sus valores junto con un ataque de diccionario.  Históricamente, Windows ha utilizado dos algoritmos para calcular una función hash de contraseña: el algoritmo LM heredado y el algoritmo NT más nuevo (a veces también llamado NTLM).  La función hash de LM es vulnerable debido a su baja complejidad computacional, lo que hace posible enumerar sus valores incluso en una computadora débil.  La presencia de hash de contraseñas LM y NT en el registro del sistema garantiza que el atacante pueda descifrarla en un período de tiempo aceptable.  El valor hash de LM en la configuración predeterminada se almacena en el registro de Windows XP / 2003, lo que hace que estos sistemas sean especialmente atractivos para el hacker.  La función de hash NT es computacionalmente más compleja, sin embargo, enumerar sus valores se simplifica enormemente por el hecho de que hay disponibles tablas de valores precalculados (las llamadas tablas Rainbow); reducen el cálculo del valor de hash a la búsqueda del hash deseado entre valores precalculados <br><br>  <b>Objeto de ataque.</b>  Hashes de contraseña en la base de datos SAM (registro).  En nuestro caso, estas son todas las máquinas a las que tenemos acceso físico.  En primer lugar, este es nuestro escritorio de trabajo y, en segundo lugar, hosts para realizar pruebas. <br><br>  <b>Implementación</b>  Con máquinas que tienen acceso físico, realizamos la siguiente operación: arrancar desde un medio externo (usando un CD de entorno de preinstalación de Windows o un CD de Linux Live), montar la partición del sistema NTFS y copiar las ramas de registro HKLM \ SYSTEM y HKLM \ SAM (% WINDIR archivos % \ System32 \ Config \ System y% WINDIR% \ System32 \ Config \ Sam respectivamente).  Prestamos especial atención a las máquinas que ejecutan Windows XP \ Windows 2003, en las que es probable que se encuentre el hash LM.  Para volcar las contraseñas de los archivos de registro copiados, utilizamos las herramientas [1], [2] (todos los enlaces al final del artículo).  Resultado: <br><br><img src="https://habrastorage.org/webt/kn/jq/wm/knjqwm1nlf7ljjd99ndwh60bngg.png" alt="imagen"><br><br>  La última línea contiene el hash NT requerido del administrador local.  En los hosts del laboratorio de pruebas (llamemos a estos hosts LAB1 y LAB2) encontramos un hash LM distinto de cero: <br><br><img src="https://habrastorage.org/webt/sz/wi/30/szwi30d1cje8gsfkiok70xtnuyy.png" alt="imagen"><br><br><img src="https://habrastorage.org/webt/1j/g5/l-/1jg5l-dgphti0eayxdcozs-onts.png" alt="imagen"><br><br>  Entonces, obtuvimos hashes NT y LM.  ¿Pero cómo recuperar la contraseña de ellos?  Para hacer esto, usaremos las mismas herramientas [1], [2], así como los servicios de hash reverse en línea [8] - [11]: <br><br><img src="https://habrastorage.org/webt/qx/dk/70/qxdk70sdc94zqcuzmxkavjeu4tg.png" alt="imagen"><br><br>  Nota: la contraseña real consistía en el nombre de la empresa con un pequeño modificador y rápidamente se rompió bajo un ataque de diccionario). <br><br>  <b>Resultado</b>  Éxito  Contraseñas (que sean "Pa $$ word1" y "Pa $$ word2") de la cuenta de administrador local de nuestro escritorio de trabajo y se han recibido dos computadoras de prueba.  ¿Pero ayudarán a obtener derechos de administrador de dominio?  Sobre esto más allá. <br><br><h4>  Paso 2. Obtención de credenciales de administrador de dominio </h4><br>  <b>Teoría</b>  En la mayoría de los casos, es suficiente para obtener el valor del hash NT de la contraseña para el administrador del dominio.  Esto se debe al hecho de que cuando se verifica a un usuario utilizando el protocolo NTLM, el sistema autenticado solo presenta el hash NT al autenticador y no se realiza la verificación de la contraseña.  El hash NT se puede obtener del llamado  Almacenamiento de LSA haciendo referencia al llamado  Sesiones de inicio de sesión de administrador (la sesión de inicio de sesión es un área de datos especial creada por el proceso Winlogon donde el nombre de usuario, el dominio de inicio de sesión y el valor de hash de la contraseña NT se almacenan, en conjunto, esto se denomina secreto LSA).  Este proceso de NTLM es utilizado por el proceso NTLMSSP para la autenticación NTLM.  La sesión de inicio de sesión se guarda todo el tiempo mientras la cuenta se conecta al sistema.  También puede interceptar un hash NT desde una sesión de autenticación de administrador NTLM.  Además, es posible obtener una contraseña de administrador del caché de Credenciales en caché de dominio (DCC).  DCC es un caché local que se completa cuando un usuario inicia sesión con éxito en un dominio.  El propósito de la caché DCC es poder autenticar al usuario cuando el controlador de dominio no está disponible. <br><br>  <b>Atacar objetos:</b> <br><br><ul><li>  DCC hashes (rama de registro HKLM \ Security). </li><li>  Sesión de inicio de sesión de administrador de dominio (LSA-secret). </li><li>  Intercepción de sesiones NTLM (no considerado debido a una mayor complejidad práctica). </li></ul><br>  <b>Practica</b>  Muchos administradores de Windows usan una cuenta de administrador de dominio para realizar varios tipos de operaciones en las computadoras de los usuarios.  Al mismo tiempo, sus datos caen en el caché DCC.  Por lo tanto, primero intente obtener la contraseña del caché DCC.  Vamos a nuestra estación de trabajo, guardamos la rama de registro HKLM \ Security e importamos a [1].  Porque  tenemos una contraseña de administrador local, ya no necesitamos iniciar la máquina desde medios externos para guardar el registro: <br><br><img src="https://habrastorage.org/webt/up/6p/v3/up6pv3qirtuto8wcxfk6lkofkqq.png" alt="imagen"><br><br>  El caché contiene los datos de la contraseña de tres cuentas.  La última cuenta (*** usuario) no nos interesa, la segunda cuenta no tiene los privilegios requeridos, pero el usuario shadmin se parece al administrador que está buscando.  Desafortunadamente, el algoritmo MS-CACHE2 tiene una gran complejidad computacional y un ataque directo de fuerza bruta sobre él es ineficiente.  La función MS-CACHEv2 contiene un "secreto computacional" - salt (el nombre de la cuenta se usa como "salt"), lo que lo protege contra ataques a las tablas Rainbow.  Sin embargo, en el futuro, pueden aparecer tablas de valores hash para cuentas estándar: "Administrador", "Administrador", etc.  En aras del interés, enviamos el "hash de caché" encontrado al servicio en la nube [8] - [11] (sobre los resultados y la eficacia de dichos servicios al final del artículo).  Mientras la nube está pensando, estamos tratando de encontrar otros DCC.  Analizamos la lista de hosts obtenida en el paso 0, verificamos a qué servidores podemos acceder bajo el administrador local utilizando las contraseñas obtenidas en el paso 1. Dado que el administrador local está bloqueado en el controlador de dominio y el servidor de correo generalmente está mejor protegido, debe experimentar con Servidores secundarios.  En nuestro caso, se encontró un servidor con el discreto nombre Upd en la lista de servidores.  El inicio de sesión con la contraseña "Pa $$ word2" encontrada en el paso 1 es exitosa.  Encontramos eso en el host Upd: <br><br><ol><li>  No hay software antivirus instalado. </li><li>  Ejecuta Apache, que es el servidor de administración para el antivirus corporativo (esto significa que también hay una contraseña para la cuenta utilizada para instalar el software antivirus de forma remota y, en teoría, puede sacarlo de allí). </li><li>  El host no audita los intentos fallidos de inicio de sesión. </li><li>  Versión del sistema operativo: Windows 2008 R2. </li></ol><br>  Después de descargar el registro HKLM \ Security, obtenemos el hash DCC de la cuenta CORP.LOCAL \ Administrator (y varias otras): <br><br><img src="https://habrastorage.org/webt/a5/3t/--/a53t--0v2fycjxm29xiytiqri3g.png" alt="imagen"><br><br>  Teóricamente, puede intentar encontrar la contraseña para el Administrador a través de un servicio en la nube.  Sin embargo, como mencioné anteriormente, un ataque de fuerza bruta en MS-CACHEv2 es inútil (aunque es posible que en un par de años la situación cambie).  Deje solo DCC y continúe buscando sesiones de inicio de sesión.  Compruebe qué usuario ha iniciado sesión en el host Upd: <br><br><img src="https://habrastorage.org/webt/57/ri/fa/57rifa8peyelwyvtbw6d4nwrofu.png" alt="imagen"><br><br>  Vemos que dos sesiones inactivas se cuelgan en la máquina Upd: el administrador y el usuario Shadmin, que ya conocemos, lo que significa que podemos obtener NT-hash de sus contraseñas robando el secreto LSA.  Esta es la clave para determinar el éxito de todo el ataque.  Para robar un hash, usa el exploit Lslsass [3].  Para ejecutarlo, necesita derechos de administrador local (o más bien, derechos para depurar procesos), que ya tenemos.  Obtenemos la lista de secretos de LSA (en el formato "dominio \ cuenta: LM hash: NT hash :::"): <br><br><pre><code class="hljs pgsql">lslsass v1<span class="hljs-number"><span class="hljs-number">.0</span></span> - Copyright (C) <span class="hljs-number"><span class="hljs-number">2010</span></span> Bjorn Brolin, Truesec (www.truesec.com) <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> Lsass pid: <span class="hljs-number"><span class="hljs-number">520</span></span> Lsass process <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:&lt;i&gt;<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e&lt;/i&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>\UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; c690e441dc78bc5da8b389e78daa6392 &lt;/b&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \shadmin::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; <span class="hljs-number"><span class="hljs-number">5794</span></span>cba8b464364eacf366063ff70e78 &lt;/b&gt; :::</code> </pre> <br>  Las líneas resaltadas en negrita contienen los hashes de contraseña necesarios.  También tenga en cuenta el hash en cursiva en la sexta línea.  Ya lo hemos visto en alguna parte, ¿verdad? <br><br>  <b>Resultado</b>  Éxito  Tenemos el hash de contraseña NT de la cuenta de administrador de dominio en nuestras manos.  Pero, ¿de qué sirve un hash si no es posible restaurar la contraseña original en un tiempo aceptable?  Sobre esto en el siguiente paso. <br><br><h4>  Paso 3. Hacer trampa en la sesión de autenticación NTLM </h4><br>  <b>Teoría</b>  Windows nunca usa una contraseña pura para la autenticación, el sistema autenticado siempre presenta un hash.  Esto da lugar a la idea: al reemplazar el nombre de usuario, el dominio de inicio de sesión y el hash de NT en la sesión de inicio de sesión del usuario conectado con los valores de administrador de dominio correspondientes, podemos autenticarnos utilizando el protocolo NTLM antes del sistema remoto como administrador de dominio.  Este ataque [7] es posible solo con autenticación usando el protocolo NTLM.  A pesar del uso generalizado del protocolo Kerberos, NTLM es la única forma posible de autenticar a un cliente cuando accede a un recurso compartido de red no es por nombre simbólico, sino por dirección IP [13]. <br><br>  <b>Objeto de ataque.</b>  Sesión de inicio de sesión del administrador local. <br><br>  <b>Practica</b>  Hay varios exploits disponibles que le permiten implementar un ataque en las plataformas Windows Server 2008 x86 y x64.  El exploit principal es el Editor de credenciales de Windows [4].  Para llevar a cabo el ataque, vamos al host LAB2 usando las credenciales "Administrador" \ "Pa $$ word2".  Con [4], reemplazamos el nombre de la cuenta, el dominio de inicio de sesión y los datos hash de NT en la sesión de inicio de sesión con los valores Shadmin correspondientes que obtuvimos en el paso anterior: <br><br><img src="https://habrastorage.org/webt/ww/kp/hc/wwkphcbxcv5fjhsrlk_1ydcakze.png" alt="imagen"><br><br>  El nombre de la cuenta del administrador del dominio y su hash NT se pasan al comando wce como argumento desde la línea de comandos.  Resultado: el hash se modificó correctamente.  Observo que la membresía del usuario en el grupo y el token de acceso no cambian durante el ataque: <br><br><img src="https://habrastorage.org/webt/jg/jn/ym/jgjnymw3o3j8yv9cfd1sjojagbe.png" alt="imagen"><br><br>  Todavía somos el administrador local, el nombre de host en verde en la captura de pantalla anterior está manchado con verde - LAB2.  Sin embargo, durante la autenticación NTLM, el sistema remoto recibirá el nombre de dominio CORP.LOCAL, el nombre de usuario Shadmin y el hash de contraseña Shadmin.  Aquí hay un volcado de un único paquete de red que contiene la sesión de blob de seguridad NTLM: <br><br><img src="https://habrastorage.org/webt/tt/c7/_x/ttc7_xrvp9e81zvathjqultz5sc.png" alt="imagen"><br><br>  El nombre de dominio (CORP.LOCAL) y el nombre de host (LAB2) están atenuados en verde), se presenta una cuenta: Shadmin.  Ahora intentamos conectarnos a la partición raíz del volumen del sistema en el controlador de dominio con el comando net use utilizando la dirección IP del controlador de dominio: <br><br><img src="https://habrastorage.org/webt/ja/ga/2h/jaga2h8xrnj_wbn5acv-fe6zlqs.png" alt="imagen"><br><br>  Con exito.  Para verificar el acceso, creé un archivo de texto en la raíz (encuéntralo en la captura de pantalla).  Después de crear un archivo por lotes en el disco del controlador de dominio con la secuencia de comandos que necesitamos, podemos, utilizando [5], realizar la operación necesaria en el controlador de dominio (por ejemplo, agregar el usuario al grupo de administradores de dominio).  La operación se realizará con los derechos de la cuenta Shadmin.  Para ilustrar, cree un archivo por lotes simple en un host remoto que agregue un usuario local: <br><br>  <i>usuario neto TstUsr Pa $$ palabra / agregar</i> <br><br>  Ejecútelo de forma remota desde el host LAB2: <br><br><img src="https://habrastorage.org/webt/q3/3l/qf/q33lqf4cb4u9rw8zwqpcfpwhw-c.png" alt="imagen"><br><br>  Se ejecutará en el sistema remoto 192.168.13.125 con los privilegios del usuario de nuestra sesión actual: shadmin (es decir, administrador de dominio).  Comprobamos: <br><br><img src="https://habrastorage.org/webt/cq/oj/wp/cqojwpt8bb1c0volgimww9gsv-c.png" alt="imagen"><br><br>  La segunda salida del comando net user muestra al nuevo usuario.  A pesar de la imposibilidad de iniciar aplicaciones que requieren la interacción interactiva del usuario de esta manera (por ejemplo, complementos MMC), se puede realizar una amplia gama de acciones mediante scripts. <br><br>  <b>Resultado</b>  Éxito  Obtuvo acceso al sistema de archivos y al shell del controlador de dominio. <br><br><h4>  Resumen </h4><br>  Brevemente, la cadena de ataque se veía así: Recopilando información sobre la estructura de la red -&gt; Obteniendo una contraseña de administrador local -&gt; Usando esta contraseña para iniciar sesión en uno de los servidores secundarios -&gt; Robo de credenciales de administrador de dominio "dejado desatendido" -&gt; Modificando su sesión de inicio de sesión y escalada de privilegios. <br><br>  El éxito del ataque fue facilitado por: <br><br><ol><li>  Protección débil de la zona DNS de la transferencia a hosts no confiables. </li><li>  Política de contraseña débil.  La mayoría de las computadoras de dominio usaban la misma contraseña para la cuenta de administrador local, que era vulnerable a un ataque de diccionario. </li><li>  La ausencia o configuración débil de software antivirus en hosts críticos. </li><li>  Protección de hash de contraseña débil: dos sesiones de inicio de sesión de administrador inactivas en el host Upd, hash de LM en la base de datos SAM. </li><li>  Mala política de auditoría. </li></ol><br><br>  En base a esto, se pueden derivar recomendaciones generales de protección: <br><br>  0. Ocultar completamente la estructura interna de la red de posibles atacantes.  Por lo tanto, los usuarios no deberían poder obtener el contenido completo del archivo de zona DNS.  Los usuarios que no son de confianza (por ejemplo, aprendices, empleados que no han completado el período de prueba, etc.) tiene sentido transferir a una subred separada usando NAT para falsificar direcciones (incluyendo, por ejemplo, modificar respuestas DNS). <br><br>  1. La política correcta para asignar contraseñas al administrador local.  La contraseña del administrador local debe ser diferente en los hosts que tienen diferentes grados de protección contra el acceso no autorizado.  Comprometer la contraseña del administrador local en cualquiera de los hosts del dominio debería minimizar la posibilidad de que un atacante use esta contraseña. <br><br>  2. El almacenamiento del hash LM en SAM debe estar prohibido por las políticas de seguridad. <br><br>  3. No utilice el nombre de la empresa o su dominio como parte de la contraseña del administrador) Esto dificultará que un atacante ataque el diccionario.  Pero incluso utilizando una contraseña compleja, no se olvide de usted mismo y verifique regularmente su hash para mayor durabilidad utilizando los servicios en línea. <br><br>  4. No se recomienda realizar operaciones de rutina en equipos de dominio desde la cuenta de administrador de dominio.  Esto protegerá la cuenta de la interceptación de los datos de la sesión de inicio de sesión y del ingreso del hash de contraseña en el caché DCC. <br><br>  5. Establezca una regla para no dejar desatendida la sesión de inicio de sesión del administrador del dominio.  Práctica recomendada: trabajo terminado: cierre sesión. <br><br>  6. Las utilidades de falsificación de LSA son bastante pequeñas.  Tiene sentido rastrear su evolución y verificar su detección exitosa por el software antivirus corporativo. <br><br>  7. Un usuario, incluso con derechos de administrador local, no debería poder cambiar la configuración de un antivirus corporativo.  Desactivar el servicio antivirus en las estaciones de trabajo de dominio debería generar una notificación al administrador del dominio (en este sentido, Symantec Endpoint Protection funcionó bien durante la prueba). <br><br><h4>  Apéndice 1. Comportamiento antivirus </h4><br>  Las computadoras de la compañía usaban tres tipos de antivirus: KAV, actual en el momento de la prueba de Symantec Endpoint Protection, y un producto obsoleto de Trend Micro.  En la mayoría de los casos, las herramientas utilizadas durante el ataque se identificaron como Hack Tool / Rootkit / Trojan.  KAV los eliminó sin previo aviso, y SEP (incluso apagado) emitió un aviso y lo movió a cuarentena para evitar que se inicie.  Sin embargo, tener derechos de administrador local le permite deshabilitar KAV, y la protección SEP se omitió configurando manualmente una ruta de excepción para la verificación, nuevamente utilizando la cuenta de administrador local.  El antivirus de Trend Micro instalado en algunos hosts no reaccionó de ninguna manera al lanzamiento de exploits. <br><br><h4>  Anexo 2. Eficiencia del uso de servicios de verificación de hash en línea </h4><br>  Hay muchos servicios en línea disponibles para probar la solidez de los hashes de contraseñas.  Le permiten trabajar con los hashes más comunes: LM, NTLM, MD4, MD5, WPA, con hashes que usan sal, etc.  Para verificar el hash, la enumeración directa se usa utilizando el poder de procesamiento de las GPU modernas, la enumeración de diccionarios, los ataques híbridos, etc.  Una vez abierto, el hash puede reponer la base de datos y ser utilizado en el futuro.  El servicio puede ser gratuito para verificar una contraseña corta (menos de 8 caracteres) o cobrar una pequeña tarifa.  Durante la prueba utilicé cuatro de estos servicios, los enlaces se dan al final del artículo.  Envié varios hashes encontrados en el paso 2 y después de 15 meses recibí una notificación del servicio On-line Hash Crack [9] sobre la restauración exitosa de uno de ellos) <br><br><h4>  Referencias </h4><br>  <b>Herramientas usadas</b> <br><br>  [1] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cain &amp; Abel</a> : una herramienta de recuperación de contraseña para los sistemas operativos de Microsoft.  Permite la recuperación fácil de varios tipos de contraseñas al rastrear la red, descifrar contraseñas cifradas mediante ataques de Diccionario, Fuerza Bruta y Criptoanálisis, grabar conversaciones VoIP, decodificar contraseñas codificadas, recuperar claves de red inalámbricas, revelar cajas de contraseñas, descubrir contraseñas almacenadas en caché y analizar rutas protocolos <br>  [2] Grieta L0pht. <br>  [3] Explotación de Lslsass.  Vuelca los hash de contraseña de sesión de inicio de sesión activo del proceso lsass. <br>  [4] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Editor de credenciales de Windows</a> post-exploit.  Herramienta para cambiar las credenciales de inicio de sesión. <br>  [5] PsExec de PS Tools <br><br>  <b>Descripciones detalladas de vulnerabilidad</b> <br><br>  [6] Serie de artículos "Obtención efectiva de un hash de contraseña en Windows" en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.securitylab.ru</a> <br>  [7] Pass-the-Hash, una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descripción de un ataque</a> a un sistema remoto al proporcionarle un hash comprometido. <br><br>  <b>Servicios de hackeo de Cloud Hash</b> <br>  [8] Question-defense.com (parece estar fuera de servicio en el momento de la publicación () <br>  [9] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.onlinehashcrack.com</a> <br>  [10] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.cloudcracker.com</a> <br>  [11] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Asesino de hash en línea</a> <br><br>  <b>Materiales adicionales</b> <br><br>  [12] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Seguridad y ajuste de DNS en Windows Server</a> <br>  [13] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kerberos no se utiliza cuando se conecta a recursos compartidos SMB utilizando la dirección IP</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es423937/">https://habr.com/ru/post/es423937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es423925/index.html">Abrir webinar "Plantilla recursiva extraña"</a></li>
<li><a href="../es423927/index.html">10 motores de búsqueda prometedores para mejorar el SEO</a></li>
<li><a href="../es423931/index.html">¿Cómo omitir la autenticación por SMS cuando se conecta a redes Wi-Fi públicas?</a></li>
<li><a href="../es423933/index.html">Microsoft Office Security: objetos incrustados</a></li>
<li><a href="../es423935/index.html">Embox responde a preguntas populares del festival TechTrain IT</a></li>
<li><a href="../es423939/index.html">Programación dinámica o dividir y conquistar</a></li>
<li><a href="../es423941/index.html">Informes de iOS mitap Redmadrobot</a></li>
<li><a href="../es423943/index.html">Optimización de precios minoristas fuera de línea</a></li>
<li><a href="../es423945/index.html">La Corte Suprema especificó el procedimiento para considerar casos con repost y likes</a></li>
<li><a href="../es423947/index.html">Nuestros datos personales no le cuestan nada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>