<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¥üèæ üåú üëÜüèø RobotDyn Strikes Double: Mega + ESP8266 üêÑ üîì üë©üèΩ‚Äçü§ù‚Äçüë©üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQu√© hace un desarrollador en raras horas de ocio? As√≠ es, navegar por las listas de precios de las tiendas de hierro. Hubo un minuto libre y decid√≠ m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RobotDyn Strikes Double: Mega + ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402429/"><img src="https://habrastorage.org/files/07a/66b/52f/07a66b52ff5d4326bcef6a7fd2749aef.jpg" alt="RobotDyn Mega + ESP8266"><br>  ¬øQu√© hace un desarrollador en raras horas de ocio?  As√≠ es, navegar por las listas de precios de las tiendas de hierro.  Hubo un minuto libre y decid√≠ mirar a trav√©s de las p√°ginas de tiendas populares en l√≠nea: aburrimiento, nada interesante, ya hemos visto todo esto ... y de repente mis ojos se posaron en el pr√≥ximo Mega.  Bah!  S√≠, no es solo Mega, sino que se combina con el querido ESP8266 de todos y est√° cuidadosamente equipado con interruptores para que dos controladores trabajen juntos: cableados (usando Ethernet Shield) con una gran cantidad de GPIO y Wi-Fi para la comunicaci√≥n inal√°mbrica. <br><br>  No esta mal!  Pens√© y record√© acerca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AMS</a> , all√≠ puedes instalar dos servidores, cableados e inal√°mbricos, y conectarlos a un sistema: ESP8266 recibir√° 54 pines digitales y 16 anal√≥gicos, y Mega recibir√° control inal√°mbrico a trav√©s de Wi-Fi y todos los bollos ESP8266.  Hace mucho tiempo no me encontr√© con un tablero tan interesante. <br><br>  - hola  ¬øTienes una placa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mega + ESP8266</a> ? <br>  - S√≠, pero solo nos queda uno. <br>  "¬øPor qu√© solo uno?" <br>  - El resto fue desarmado. <br>  "Res√©rvala, por favor, para m√≠". <br><a name="habracut"></a><br><h2>  Unas palabras sobre la empresa </h2><br>  Me gustaron dos cosas RobotDyn: la primera, con sus soluciones tecnol√≥gicas.  No hay necesidad de ir muy lejos, un excelente ejemplo es la placa Mega + ESP8266 en consideraci√≥n.  Algo como esto no he visto en nuestras tiendas en l√≠nea (y no en las nuestras, pero realmente no lo busqu√© aqu√≠).  Y este no es el √∫nico ejemplo, todav√≠a existe la opci√≥n Uno + ESP8266 y la compa√±√≠a claramente no se detendr√° all√≠, aparentemente todav√≠a hay muchos dispositivos interesantes esper√°ndonos. <br><br>  Y el segundo es su pol√≠tica de precios.  No me detendr√© en este tema aqu√≠ en detalle, pero dir√© que los precios me sorprendieron gratamente: el lema de la compa√±√≠a es "Los precios son como en Aliexpress". <br><br>  En pocas palabras, describ√≠ los antecedentes en los que se desarrollar√°n todos los eventos posteriores, ahora vamos directamente a los detalles t√©cnicos y una descripci√≥n del tablero y c√≥mo trabajar con √©l. <br><br><h2>  El tablero en s√≠ </h2><br>  En general, una placa ordinaria, no muy diferente de muchas similares, si no fuera por una peque√±a parte, a saber, el chip ESP8266EX integrado en la placa.  Esto transfiere inmediatamente a la junta a la categor√≠a de soluciones extraordinarias.  Quiero llamar su atenci√≥n sobre un detalle m√°s: no se integra un m√≥dulo est√°ndar del tipo ESP-12 en la placa, sino que el chip y todo el cableado se realizan en la placa misma, lo que alude de manera transparente al nivel de los desarrolladores.  Tambi√©n quiero se√±alar que la placa tiene una antena impresa y un conector para conectar una antena externa, que en muchos casos puede ser muy √∫til. <br><img src="https://habrastorage.org/files/1d1/cee/155/1d1cee155967488581228289df3b6f28.jpg" alt="RobotDyn Mega + ESP8266"><br>  Hay conectores pin en la placa para conectar a los terminales ESP8266 y varios interruptores, que vale la pena mencionar un poco m√°s.  La idea principal de usar la placa es que al usar los interruptores, puede configurar la interacci√≥n de sus tres componentes de diferentes maneras: el chip Atmega2560, el chip ESP8266EX y el convertidor USB-TTL CH340G.  Son posibles conexiones simples y complejas, que le permiten organizar muchas opciones para la interacci√≥n de todas las partes del tablero.  Esto abre grandes oportunidades para construir varios dispositivos, pero m√°s sobre esto m√°s adelante. <br><br><img src="https://habrastorage.org/files/cb4/2f4/819/cb42f4819ba940369ad71818bbc7ff03.jpg" alt="Espigas ESP8266"><br><br>  Tambi√©n quiero se√±alar la capacidad de carga decente de la placa.  A juzgar por las inscripciones en √©l, es capaz de proporcionar una corriente de carga de 1.6 A en un canal de 5 voltios y 1 A en un 3.3 voltios.  Lo cual es muy bueno, especialmente en el agregado. <br><br>  No hay nada m√°s que decir sobre el tablero, pasamos a instalar software y probarlo. <br><br><h2>  Prueba de la junta </h2><br>  Como la placa est√° integrada y pr√°cticamente no hay espacio libre en ella, y el cableado de la parte de alta frecuencia del ESP8266EX se realiza en ella, al principio surgieron dudas sobre el funcionamiento correcto y sin problemas de toda esta econom√≠a. <br><br>  Mirando hacia el futuro, dir√© que a pesar de mis preocupaciones, todo funciona de manera estable y como se esperaba.  Conectamos los interruptores de la placa Atmega2560 a USB; obtenemos el Arduino Mega, conectamos el ESP8266EX a USB; obtenemos el ESP8266, cambiamos al modo de conexi√≥n del Atmega2560 con el ESP8266EX y obtenemos la conexi√≥n entre los chips a trav√©s de la interfaz en serie.  Todo funciona exactamente como se describe en la documentaci√≥n y exactamente como se espera intuitivamente. <br><br>  Una gran ventaja de esta soluci√≥n es que los desarrolladores se encargaron de hacer coincidir los niveles de se√±al l√≥gica de todos los componentes del sistema.  Cualquiera que haya intentado configurar manualmente el m√≥dulo ESP8266 y conectar correctamente todas las resistencias pull-up me entender√°.  No existen tales problemas, todo su trabajo se reduce a hacer clic en los interruptores de la placa de acuerdo con las instrucciones del fabricante. <br><br><h2>  Prueba de carga </h2><br>  ¬øC√≥mo probar el tablero?  Puede descargar un boceto est√°ndar, pero ser√° una prueba sobre nada.  Esta opci√≥n puede funcionar bien, y en condiciones de combate el sistema fallar√°.  Por lo tanto, el trabajo de ambas partes bajo el control de las versiones correspondientes del Arduino Mega Server fue elegido como una prueba de carga dura.  Para Mega - Arduino Mega Server para Mega y para ESP8266 - Arduino Mega Server para ESP8266 en la versi√≥n M1. <br><br>  El kit de distribuci√≥n M1 fue elegido debido al hecho de que solo 1 MB de memoria flash para ESP8266 est√° instalado en la placa.  Esto, en mi opini√≥n, es casi el √∫nico error para los desarrolladores: en futuras revisiones de la placa, recomendar√≠a que coloquen chips de memoria de 4 MB.  La diferencia de precio es peque√±a, y las posibilidades al usar la versi√≥n con 4 MB son mucho mayores.  Pero como hay una versi√≥n AMS para sistemas con 1 MB, no prest√© mucha atenci√≥n a este punto y continu√© probando. <br><br>  Que decir  Encendemos el tablero, completamos el software y obtenemos dos servidores independientes.  Uno conectado a trav√©s de Ethernet Shield y otro inal√°mbrico a trav√©s de Wi-Fi.  Belleza! <br><br>  Tambi√©n me gustar√≠a se√±alar que incluso la adici√≥n de un Ethernet Shield con un lector de tarjetas a este sistema ya sofisticado no caus√≥ ning√∫n conflicto o falla, todo sali√≥ de la manera en que deber√≠a funcionar.  Y en algunos casos es incluso mejor de lo habitual: esta es la primera placa en la que el firmware ESP8266 por el aire pas√≥ con √©xito en el 100% de los casos, en todas las dem√°s placas y m√≥dulos hay fallas ocasionales con este parpadeo. <br><br>  Y dos servidores est√°n girando, cargando la placa, cumpliendo con sus obligaciones y ... eso es todo.  Todo funciona, no hay nada que decir, pero este es probablemente el mejor elogio para cualquier sistema t√©cnico. <br><br><h2>  Mas interesante </h2><br>  Lo que describ√≠ aqu√≠ es interesante desde un punto de vista puramente acad√©mico: un tablero interesante, una soluci√≥n t√©cnica interesante, pero por supuesto estamos interesados ‚Äã‚Äãen su aplicaci√≥n pr√°ctica.  ¬øCu√°l es su punto culminante pr√°ctico y aplicado? <br><br>  El hecho es que con un interruptor en el tablero es posible conectar sus dos partes (Mega y ESP) en una sola unidad y, por lo tanto, en primer lugar, obtener un nuevo sistema de calidad y, en segundo lugar, compensar los defectos inherentes de cada una de sus partes individuales. <br><br>  Comencemos con el ESP8266.  El principal inconveniente de esta soluci√≥n generalmente excelente es la catastr√≥fica falta de pines GPIO.  Como dicen, uno, dos y mal calculados.  Es dif√≠cil decir qu√© pensaron los desarrolladores de este chip, pero antes del lanzamiento de ESP32 tuvieron un poco m√°s de tiempo para pensar y solucionaron esta deficiencia en el nuevo chip.  Pero estamos tratando espec√≠ficamente con 8266. <br><br>  Esta placa le permite hacer un movimiento de caballos y usar toda la potencia de Mega, y esto, entre otras cosas, 54 salidas digitales y 16 anal√≥gicas en el ESP8266.  Es decir, nuestro ESP desvencijado de repente tiene grandes oportunidades para trabajar con sensores, actuadores y otros perif√©ricos.  Resulta, por as√≠ decirlo, beb√© ESP con esteroides. <br><br>  Esta es solo una de las opciones posibles para usar el tablero, acostado en la superficie. <br><br>  Ahora echemos un vistazo a Mega.  Ella no interfiere con la interfaz inal√°mbrica y la capacidad de interactuar con dispositivos Wi-Fi, lo que puede proporcionarle integraci√≥n con la parte ESP del sistema.  Y al mismo tiempo, sigue existiendo la posibilidad de operaci√≥n en paralelo a trav√©s de una interfaz Ethernet cableada. <br><br>  Y esta tambi√©n es solo una de las posibles aplicaciones para esta placa, que yace en la superficie. <br><br>  Bueno, varias opciones de puente: Ethernet - Wi-Fi, nRF24 - Ethernet, nRF24 - Wi-Fi, nRF24 (1) - nRF24 (2), nooLite - Wi-Fi, nooLite - Ethernet, nooLite (1) - nooLite (2 ), etc., etc. hasta el infinito.  Puede enrutar se√±ales de docenas de subsistemas con los que el Arduino Mega Server funciona entre las dos partes de la placa y las interfaces conectadas a ellas. <br><br>  Ni siquiera s√© qu√© decir.  Muy guay. <br><br><h2>  Detalles t√©cnicos </h2><br>  Ahora un poco sobre los detalles t√©cnicos.  Ver√° una tabla en la que se presentan todos los modos de operaci√≥n posibles del tablero y se muestran todas las posiciones posibles de los interruptores en √©l.  Consideremos brevemente cada modo. <br><br><img src="https://habrastorage.org/files/a51/cc7/874/a51cc7874a274215b06fc93c7d7dbd4d.png" alt="Tabla de modos de funcionamiento de la placa RobotDyn"><br><br><h4>  Arduino Mega 2560 </h4><br>  El modo m√°s simple de operaci√≥n de la placa, en la tabla, se designa como modo 3. Si coloca los interruptores 3 y 4 en la posici√≥n de ENCENDIDO, y el resto en la posici√≥n de APAGADO, obtenemos el Arduino Mega 2560 habitual. Nada interesante, por el bien de esto, no vali√≥ la pena comprar esta placa, puede fue comprar el Mega habitual. <br><br><h4>  ESP8266 </h4><br>  Tampoco es un modo de operaci√≥n muy interesante.  En la tabla, se divide en dos modos secundarios, designados como 1 (cargando el boceto en ESP) y 2 (modo de conexi√≥n ESP a USB).  Esta es toda la funcionalidad del ESP8266 est√°ndar y, en aras de tal uso, tampoco val√≠a la pena comprar esta placa, podr√≠a pasar con el m√≥dulo ESP habitual. <br><br><h4>  Todos son independientes </h4><br>  Tampoco consideramos esta opci√≥n en el n√∫mero 6, porque en ella todas las conexiones entre las partes de la placa est√°n rotas y definitivamente no puede sernos √∫til para nada. <br><br><h4>  La conexi√≥n entre Mega y ESP </h4><br>  En este modo, designado como 5, la comunicaci√≥n se establece entre Mega y ESP a trav√©s de una interfaz en serie, pero no hay comunicaci√≥n con el convertidor USB-TTL.  ESP usa Serial est√°ndar, mientras que Mega no usa menos Serial3 est√°ndar.  La conexi√≥n funciona de manera estable y sin problemas a una velocidad de 115200. Este es un modo de operaci√≥n bastante espec√≠fico cuando ning√∫n controlador tiene conexi√≥n USB.  Y por eso tampoco es muy interesante para nosotros. <br><br><h4>  Comunicaci√≥n entre Mega y ESP y Mega y USB al mismo tiempo </h4><br>  Pero esto es lo que se llama una carta de triunfo.  Obtenemos todo a la vez: la conexi√≥n Mega USB y la capacidad de cargar bocetos a Mega y controlar su funcionamiento a trav√©s del mismo USB, la posibilidad de comunicaci√≥n entre Mega y ESP y la capacidad de cargar bocetos al ESP8266 y controlar su funcionamiento en la interfaz USB ... ¬°Mega!  Es decir, relleno completo, no salir directamente de la caja registradora. <br><br>  Este es el √∫nico modo correcto de operaci√≥n enumerado en la tabla.  Recuerda su n√∫mero ganador, que es cuatro.  En la configuraci√≥n de los interruptores en el tablero, tambi√©n se ve hermoso: 1, 2, 3, 4 est√°n en la posici√≥n ON, el resto est√°n OFF. <br><br>  Un lector atento preguntar√°: ¬øc√≥mo podemos cargar bocetos al ESP8266 si el puerto USB est√° ocupado conect√°ndose a la megaparte del sistema?  Y esta es la pregunta correcta, la respuesta es de ninguna manera.  ¬øY por qu√©, entonces, est√°s escribiendo que en esta configuraci√≥n podemos subir bocetos a ESP8266?  Debido a que el Arduino Mega Server tiene la capacidad de descargar bocetos por aire directamente desde el IDE de Arduino presionando un par de botones, as√≠ que es correcto: tenemos el relleno completo, todo funciona de inmediato. <br><br>  Pero, ¬øqu√© pasa con aquellos que quieren usar la placa sin Arduino Mega Server?  Solo hay dos opciones: hacer clic constantemente en los interruptores o agregar la capacidad de descargar bocetos por el aire en sus dise√±os.  Personalmente me gusta m√°s la segunda opci√≥n. <br><br><h2>  Configuraci√≥n de IDE de Arduino </h2><br>  La configuraci√≥n de IDE de Arduino para Mega no plantea ninguna pregunta, todo es est√°ndar all√≠, y para ESP8266 dar√© una captura de pantalla del men√∫ con configuraciones para una implementaci√≥n espec√≠fica de la parte ESP en la placa RobotDyn.  Debe establecer los mismos par√°metros para usted, con la excepci√≥n del n√∫mero de puerto; en su sistema, lo m√°s probable es que tenga un valor diferente. <br><br><img src="https://habrastorage.org/files/e1f/d98/bac/e1fd98bacc664b7e931699cb65b1c6ae.png" alt="Configuraci√≥n ESP8266 en Arduino IDE"><br><br><h2>  Arduino Mega Server para RobotDyn Mega + ESP8266 </h2><br>  Para esta placa, se ha lanzado una versi√≥n dual especial del Arduino Mega Server, que contiene dos servidores a la vez, optimizados espec√≠ficamente para esta placa.  Esto est√° fuera de la cuesti√≥n, ambos servidores contienen funcionalidad est√°ndar y se pueden usar para cualquiera de sus proyectos. <br><br>  Puede usar ambos servidores de forma independiente en la misma placa, o puede agregar la funcionalidad que necesita y usarlos en t√°ndem y en modo puente entre dos redes y cualquier interfaz conectada a los servidores. <br><br>  El primer ensamblaje Arduino Mega Server para la placa RobotDyn Mega + ESP8266 contiene un ejemplo de prueba de la interacci√≥n de dos controladores a trav√©s de una interfaz en serie.  Esta es una demostraci√≥n de las capacidades de la tecnolog√≠a sobre la base de las cuales puede desarrollar sus propias soluciones. <br><br>  Ahora un poco m√°s sobre el desarrollo de un protocolo para la interacci√≥n de dos controladores a trav√©s de la interfaz serial en general y en este tablero en particular. <br><br><h2>  Desarrollo de protocolo </h2><br>  ¬øQu√© debemos construir una casa?  ¬øNecesita desarrollar un protocolo de interacci√≥n entre las dos partes del sistema a trav√©s de la interfaz en serie?  - Vamos a desarrollar, aqu√≠ lo principal es establecer la tarea de forma clara y correcta.  Para demostrar el funcionamiento en t√°ndem del sistema, mostramos los indicadores de funcionamiento "asociado" en el panel de instrumentos de cada servidor. <br><br>  <em><strong>Un poco sobre terminolog√≠a.</strong></em>  <em>Para Mega, el "socio" es ESP8266, para ESP8266, respectivamente, Mega.</em> <br><br>  Cuando el compa√±ero est√° trabajando, el indicador se iluminar√° en verde, cuando no est√© en funcionamiento, rojo y gris cuando el estado no est√© definido.  Esto es muy conveniente: durante la operaci√≥n, ver√° inmediatamente el estado del alter ego de su sistema. <br><br>  Para una soluci√≥n pr√°ctica a este problema, hay exactamente un mill√≥n de formas, elegiremos lo siguiente: los bloques de comunicaci√≥n de ambas partes del sistema ser√°n id√©nticos, la interacci√≥n ocurrir√° en modo d√∫plex completo, los bloques de informaci√≥n tendr√°n un formato simple y claro: <br><br><pre><code class="java hljs">?=</code> </pre> <br>  o <br><br><pre> <code class="java hljs">?</code> </pre><br>  Este es solo un ejemplo de prueba para resolver la tarea, puede modificar este protocolo de interacci√≥n o escribir el suyo, adecuado para sus tareas.  Pero en el protocolo ya implementado, no solo puede monitorear el estado del socio, sino tambi√©n usarlo para muchos otros prop√≥sitos, por ejemplo, transmitir el estado de los pines del controlador, el estado de los sensores o enviar comandos de control al socio. <br><br>  Espec√≠ficamente, en nuestro sistema, los equipos se ver√°n as√≠: <br><br>  <strong>? mega = 1</strong> : Mega env√≠a datos sobre su rendimiento.  Par√°metro "mega", valor "1". <br><br>  <strong>? esp = 1</strong> - ESP8266 env√≠a datos sobre su estado.  El par√°metro es "esp", el valor es "1". <br><br>  Entonces, por ejemplo, considere la implementaci√≥n del protocolo para la megaparte del sistema. <br><br>  De manera est√°ndar, inicializamos el m√≥dulo AMS y el hardware Serial3 Mega a una velocidad de 115200. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">robotdynInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial3.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>); modulRobotdyn = MODUL_ENABLE; started(<span class="hljs-string"><span class="hljs-string">"RobotDyn"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }</code> </pre><br>  Verificamos el estado del puerto Serial3 y, en el caso de los datos del socio, formamos la variable de cadena serialReq que contiene los datos o comandos recibidos. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSerial</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial3.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sFlag) { serialReq = <span class="hljs-string"><span class="hljs-string">""</span></span>; sFlag = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = Serial3.read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">10</span></span>) { sFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; parseSerialStr(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">13</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// skip } else { if (serialReq.length() &lt; MAX_SERIAL_REQ) { serialReq += c; } } // if } // while (Serial3.available() &gt; 0) } // checkSerial()</span></span></code> </pre><br>  Analizamos los comandos y los datos, y en caso de informaci√≥n sobre el estado del socio, tomamos medidas en forma de cambiar el estado de la variable esp. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseSerialCmd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String command, parameter; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"?"</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pBegin = serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"?"</span></span>)) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pParam = serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)); command = serialReq.substring(pBegin, pParam); parameter = serialReq.substring(pParam + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { command = serialReq.substring(pBegin); parameter = <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command != F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { Serial.print(F(<span class="hljs-string"><span class="hljs-string">"command/parameter: "</span></span>)); Serial.print(command); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"/"</span></span>)); Serial.println(parameter); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter == F(<span class="hljs-string"><span class="hljs-string">"1"</span></span>)) { esp = <span class="hljs-number"><span class="hljs-number">1</span></span>; espTimer = millis(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } } <span class="hljs-comment"><span class="hljs-comment">// if (request.indexOf(F("?")) &gt;= 0) } // parseSerialCmd()</span></span></code> </pre><br>  Puede agregar f√°cilmente el procesamiento de cualquier otro comando cambiando y agregando a la secci√≥n de c√≥digo correspondiente. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter == F(<span class="hljs-string"><span class="hljs-string">"1"</span></span>)) { esp = <span class="hljs-number"><span class="hljs-number">1</span></span>; espTimer = millis(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Si utiliza muchos comandos y datos en sus propios proyectos y an√°lisis, es mejor dise√±ar esta secci√≥n de c√≥digo en forma de funciones correspondientes. <br><br>  Solo queda considerar la funci√≥n est√°ndar del m√≥dulo AMS, que es responsable de su trabajo.  Primero, se verifica el estado del puerto, luego cada cuatro segundos se env√≠a un comando al socio de que Mega est√° vivo y trabajando, y se comprueba el tiempo transcurrido desde que se recibieron los √∫ltimos datos del socio, y si excede los 8 segundos, se concluye que el socio no est√° funcionando. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">robotdynWork</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ checkSerial(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle4s) { Serial3.println(F(<span class="hljs-string"><span class="hljs-string">"?mega=1"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - espTimer &gt; <span class="hljs-number"><span class="hljs-number">8000</span></span>) { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } }</code> </pre><br>  Eso es todo magia.  Es cierto, nada complicado? <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo completo del m√≥dulo responsable de las comunicaciones entre sistemas entre Mega 2560 y ESP8266</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* Modul RobotDyn part of Arduino Mega Server project */</span></span> #ifdef ROBOTDYN_FEATURE bool sFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> espTimer = millis(); <span class="hljs-comment"><span class="hljs-comment">// Serial request #define MAX_SERIAL_REQ 32 String serialReq = ""; void robotdynInit() { Serial3.begin(115200); modulRobotdyn = MODUL_ENABLE; started("RobotDyn", true); } void printSerialStr() { Serial.print("["); Serial.print(serialReq); Serial.println("]"); } void parseSerialCmd() { String command, parameter; if (serialReq.indexOf(F("?")) &gt;= 0) { int pBegin = serialReq.indexOf(F("?")) + 1; if (serialReq.indexOf(F("=")) &gt;= 0) { int pParam = serialReq.indexOf(F("=")); command = serialReq.substring(pBegin, pParam); parameter = serialReq.substring(pParam + 1); } else { command = serialReq.substring(pBegin); parameter = ""; } // if (command != F("esp")) { Serial.print(F("command/parameter: ")); Serial.print(command); Serial.print(F("/")); Serial.println(parameter); //} if (command == F("esp")) { if (parameter == F("1")) { esp = 1; espTimer = millis(); } else { esp = 0; } } } // if (request.indexOf(F("?")) &gt;= 0) } // parseSerialCmd() void parseSerialStr() { if (serialReq[0] == '?') { parseSerialCmd(); } else { printSerialStr(); } } void checkSerial() { while (Serial3.available() &gt; 0) { if (sFlag) { serialReq = ""; sFlag = false; } char c = Serial3.read(); if (c == 10) { sFlag = true; parseSerialStr(); } else if (c == 13) { // skip } else { if (serialReq.length() &lt; MAX_SERIAL_REQ) { serialReq += c; } } // if } // while (Serial3.available() &gt; 0) } // checkSerial() void robotdynWork() { checkSerial(); if (cycle4s) { Serial3.println(F("?mega=1")); if (millis() - espTimer &gt; 8000) { esp = 0; } } } #endif // ROBOTDYN_FEATURE</span></span></code> </pre><br></div></div><br><h2>  Aspecto de la salida en el monitor serie </h2><br>  En el monitor serie Mega 2560, la salida, los datos y los comandos de la parte ESP del sistema se ven exactamente como los suyos.  Para distinguir la salida del socio de la salida de Mega, sus datos est√°n entre comillas cuadradas.  En este caso, puede ver el reinicio de ESP8266 y el registro de inicio de AMS en el monitor serial de Mega. <br><br><img src="https://habrastorage.org/files/a03/904/3b8/a039043b86d442d7a54e10bb73b314c7.png" alt="Salida ESP8266 al monitor de la serie Mega 2560"><br><br>  Y el registro del intercambio real de comandos entre las dos partes del sistema a trav√©s de la interfaz en serie.  Ver√° la salida de ESP8266 con informaci√≥n sobre la decodificaci√≥n de los datos de estado de Mega en la interfaz serial de Mega, entre comillas cuadradas. <br><br><img src="https://habrastorage.org/files/b5f/444/6cf/b5f4446cf54c4c048fa568f1e3418823.png" alt="Salida ESP8266 en decodificaci√≥n de megacomando"><br><h2>  Belleza en la interfaz </h2><br>  Ahora un poco sobre c√≥mo se ve todo en la interfaz Arduino Mega Server.  Para comenzar, har√© capturas de pantalla de ambas partes del sistema en el trabajo. <br><br><img src="https://habrastorage.org/files/774/faf/c92/774fafc92eb54ba29905a6ec201501da.png" alt="Arduino Mega Server para RobotDyn Mega + ESP8266"><br><br>  Las elipses est√°n rodeadas de inscripciones que identifican el controlador y la parte del sistema con la que est√° trabajando actualmente.  Los c√≠rculos se rodean alrededor de indicadores que muestran el estado del compa√±ero.  Por el momento, todo est√° en orden, ambas partes del sistema funcionan normalmente e interact√∫an normalmente entre s√≠ a trav√©s de la interfaz interna.  Si algo sale mal, lo sabr√° despu√©s de un m√°ximo de 8 segundos. <br><br><img src="https://habrastorage.org/files/f49/7ef/a1f/f497efa1ff1f427a860d4e61cdc5e13d.png" alt="Algo sali√≥ mal"><br><br>  Algo sali√≥ mal.  ESP8266 recibi√≥ una actualizaci√≥n de firmware a trav√©s del aire y la megaparte del sistema registr√≥ el momento de su reinicio.  Despu√©s de unos segundos, la parte ESP del sistema se reanudar√° y el indicador se apagar√° en rojo. <br><br>  Para mayor comodidad, cuando pasa el cursor sobre el indicador de estado del socio, aparece una pista y la posibilidad de hacer clic en √©l y en una ventana separada se abre la interfaz de la segunda parte del sistema, en este caso la parte ESP.  Esto se hace por conveniencia, puede en cualquier momento abrir con un clic la interfaz de la segunda parte del sistema. <br><br><img src="https://habrastorage.org/files/d00/a61/a28/d00a61a28c6b439086a42e4510e896cb.png" alt="Informaci√≥n sobre herramientas para AMS"><br><br><h2>  Ideas de proyectos </h2><br>  Ahora un poco sobre lo que puedes hacer con todo esto, tener un poco de imaginaci√≥n.  El tablero habitual, completamente discreto a primera vista, le permite hacer muchas cosas completamente inusuales e interesantes.  Esto es especialmente cierto en la combinaci√≥n con el Arduino Mega Server. <br><br>  Entonces, lo primero que viene a la mente: <br><br>  <strong>Reenviar datos de sensores entre controladores.</strong>  En ambos lados y en cantidades ilimitadas.  Este es un sistema que tiene las ventajas de ambas partes, y las posibilidades no solo suman, sino que se observa lo que se llama un efecto sin√©rgico. <br><br>  <strong>El puente entre las interfaces.</strong>  Arduino Mega Server puede funcionar con muchas interfaces y este sistema le permite enrutar datos y comandos entre cualquier interfaz conectada e inal√°mbrica. <br><br>  <strong>Trabaje en la misma red</strong> cuando Mega a trav√©s de Ethernet Shield y ESP8266 a trav√©s de Wi-Fi se comunican con dispositivos cableados e inal√°mbricos en la misma red. <br><br>  <strong>Trabaja en diferentes redes</strong> cuando Mega est√° conectado a Ethernet con cable y ESP8266 a trav√©s de Wi-Fi a otra red y el sistema enruta comandos y datos de una red a otra. <br><br>  <strong>La salida de una parte del sistema en la interfaz de otra.</strong>  V√≠a Ethernet utilizando fuentes web est√°ndar o mediante una conexi√≥n serial interna. <br><br>  <strong>Depuraci√≥n</strong>  Una parte del sistema puede actuar como depurador y probador de otra parte del sistema de acuerdo con su programa. <br><br>  <strong>Temporizador de vigilancia.</strong>  Cada controlador puede actuar como una especie de perro guardi√°n en relaci√≥n con otro. <br><br>  <strong>Fallos de registro.</strong>  Cada controlador puede mantener registros del trabajo de su socio, compilar estad√≠sticas e informar sobre situaciones alarmantes. <br><br>  <strong>Base de datos para ESP8266.</strong>  Con este sistema, puede organizar algo as√≠ como una base de datos SQL en Mega para ESP8266.  ESP hace su trabajo, y Mega act√∫a como un sistema de almacenamiento (hasta 32 GB). <br><br>  <strong>Parpadeando unos a otros.</strong>  Los controladores pueden actualizarse din√°micamente entre s√≠ de acuerdo con la l√≥gica incorporada o al llegar un comando de control externo. <br><br>  <strong>M√≥dulos de conexi√≥n.</strong>  Los controladores pueden conectarse a varios perif√©ricos que tienen problemas para conectarse a cualquier parte del sistema. <br><br>  Y as√≠ sucesivamente, creo que un lector curioso podr√° idear de manera independiente muchas formas no menos interesantes de utilizar este sistema. <br><br><h2>  Conclusi√≥n </h2><br>  En mi opini√≥n, esta es una soluci√≥n muy interesante, y debemos decir muchas gracias a RobotDyn por una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tarifa</a> tan interesante.  Yo, al menos, digo esto sinceramente. <br><br>  Descargue el kit de distribuci√≥n Arduino Mega Server para RobotDyn Mega + ESP8266 y verifique personalmente la validez de todo lo que est√° escrito aqu√≠, puede hacerlo en el sitio oficial del proyecto Arduino Mega Server en la secci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descargas</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es402429/">https://habr.com/ru/post/es402429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es402417/index.html">El ciclista pas√≥ desapercibido</a></li>
<li><a href="../es402419/index.html">Analizando el nuevo Nintendo Switch</a></li>
<li><a href="../es402421/index.html">Semana de Venus en el hemisferio norte</a></li>
<li><a href="../es402423/index.html">Practica de idiomas sin conexi√≥n</a></li>
<li><a href="../es402425/index.html">Los qu√≠micos son los primeros en apreciar los beneficios de las computadoras cu√°nticas</a></li>
<li><a href="../es402431/index.html">ONYX BOOX Vasco Da Gama: m√°s inteligente que un libro, m√°s simple que una tableta</a></li>
<li><a href="../es402433/index.html">Historia de los rascacielos</a></li>
<li><a href="../es402435/index.html">Compendio "World Hi-Fi": audio port√°til, software, formatos y vinilo</a></li>
<li><a href="../es402437/index.html">IPTV m√°s delgado que RMB</a></li>
<li><a href="../es402439/index.html">Geolocalizaci√≥n comercial: la privacidad es barata</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>