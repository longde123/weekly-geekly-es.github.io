<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ±Ô∏è üñãÔ∏è üîè RBKmoney Payments under the hood - la l√≥gica de la plataforma de pago üîû ‚òïÔ∏è üïñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Contin√∫o publicando el ciclo sobre el interior de la plataforma de pago RBK.money, que comenz√≥ en esta publicaci√≥n . Hoy hablaremos sobre e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RBKmoney Payments under the hood - la l√≥gica de la plataforma de pago</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rbkmoney/blog/447440/"><p><img src="https://habrastorage.org/webt/ao/li/cv/aolicvi50stowouvsmwppnyc7qk.jpeg"></p><br><p>  Hola Habr!  Contin√∫o publicando el ciclo sobre el interior de la plataforma de pago RBK.money, que comenz√≥ en esta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicaci√≥n</a> .  Hoy hablaremos sobre el esquema de procesamiento l√≥gico, los microservicios espec√≠ficos y su relaci√≥n entre ellos, c√≥mo los servicios que procesan cada parte de la l√≥gica de negocios est√°n separados l√≥gicamente, por qu√© el n√∫cleo de procesamiento no sabe nada sobre los n√∫meros de sus tarjetas de pago y c√≥mo se ejecutan los pagos dentro de la plataforma.  Adem√°s, con un poco m√°s de detalle, revelar√© el tema de c√≥mo proporcionamos alta disponibilidad y escala para manejar altas cargas. </p><a name="habracut"></a><br><h2 id="obzornaya-logicheskaya-shema-i-obschie-podhody">  Visi√≥n general l√≥gica y enfoques generales </h2><br><p>  En general, el esquema de los elementos b√°sicos de esa parte del procesamiento responsable de los pagos se ve as√≠. </p><br><p><img src="https://habrastorage.org/webt/r8/ee/bz/r8eebzud9-g1muc_xguixpokwfc.png"></p><br><p>  L√≥gicamente dentro de nosotros mismos, dividimos las √°reas de responsabilidad en 3 dominios: </p><br><ul><li>  zona externa, entidades que est√°n en Internet, como aplicaciones JS de nuestro formulario de pago (ingrese los datos de su tarjeta all√≠), backends de nuestros clientes comerciales, as√≠ como pasarelas de procesamiento de nuestros bancos asociados y proveedores de otros m√©todos de pago; </li><li>  una zona interna altamente accesible, los microservicios viven all√≠, que proporcionan el trabajo de la pasarela de pago directamente y gestionan el d√©bito de dinero, teniendo en cuenta en nuestro sistema y otros servicios en l√≠nea, que se caracterizan por el requisito "siempre debe estar disponible, a pesar de cualquier falla dentro de nuestros CD"; <br><ul><li>  Hay un √°rea separada de servicios que trabaja directamente con los datos completos de los titulares de tarjetas; estos servicios tienen requisitos separados establecidos por el Ministerio de Ferrocarriles y sujetos a certificaci√≥n obligatoria bajo los est√°ndares PCI-DSS.  Explicaremos con m√°s detalle por qu√© tal separaci√≥n a continuaci√≥n; </li></ul></li><li>  La zona interior, donde hay requisitos menores para la disponibilidad de los servicios prestados o el tiempo de su respuesta, en el sentido cl√°sico, es un back office.  Aunque, por supuesto, aqu√≠ tambi√©n tratamos de garantizar el principio de "siempre disponible", simplemente dedicamos menos esfuerzo a esto; </li></ul><br><p> Dentro de cada zona hay microservicios que realizan sus partes de procesamiento de l√≥gica de negocios.  Reciben llamadas RPC en la entrada, y en la salida, generan datos procesados ‚Äã‚Äãutilizando algoritmos integrados, que tambi√©n se ejecutan como llamadas de otros microservicios a lo largo de la cadena. </p><br><p>  Para garantizar la escalabilidad, intentamos almacenar estados en el menor n√∫mero de lugares posible.  Los servicios sin estado en el diagrama no tienen conexiones con almacenes persistentes, con estado, respectivamente, est√°n conectados a ellos.  En general, utilizamos varios servicios limitados para el almacenamiento de estado persistente; para la parte principal del procesamiento, estos son cl√∫steres Riak KV, para servicios relacionados: PostgreSQL, para el procesamiento de cola as√≠ncrono, utilizamos Kafka. </p><br><p>  Para garantizar una alta disponibilidad, implementamos servicios en varios casos, generalmente de 3 a 5. </p><br><p>  Es f√°cil escalar los servicios sin estado, simplemente aumentamos el n√∫mero de instancias que necesitamos en diferentes m√°quinas virtuales, est√°n registrados en Consul, est√°n disponibles para resolver a trav√©s de la consola DNS y comienzan a recibir llamadas de otros servicios, procesan los datos recibidos y los env√≠an m√°s. </p><br><p>  Los servicios con estado, o m√°s bien es nuestro principal y se muestran en el diagrama como Machinegun, implementan una interfaz altamente accesible (la arquitectura distribuida se basa en la distribuci√≥n de Erlang), y la sincronizaci√≥n a trav√©s de Consul KV se utiliza para garantizar el bloqueo en cola y distribuido.  Esta es una descripci√≥n breve y detallada en una publicaci√≥n separada. </p><br><p>  Fuera de la caja, Riak proporciona un almacenamiento sin maestros persistente altamente accesible, no lo preparamos de ninguna manera, la configuraci√≥n est√° casi predeterminada.  Con el perfil de carga actual, tenemos 5 nodos en el cl√∫ster implementados en hosts separados.  Una nota importante: pr√°cticamente no utilizamos √≠ndices y muestras de datos grandes, trabajamos con claves espec√≠ficas. </p><br><p>  Cuando es demasiado costoso implementar el esquema KV, utilizamos bases de datos PostgeSQL con replicaci√≥n, o incluso soluciones de modo √∫nico, ya que siempre podemos cargar los eventos necesarios en caso de falla de la parte en l√≠nea a trav√©s de Machinegun. </p><br><p>  La separaci√≥n de colores de los microservicios en el diagrama indica los idiomas en los que est√°n escritos, verde claro, estas son aplicaciones Java, azul claro, Erlang. </p><br><p>  Todos los servicios funcionan en contenedores Docker, que son artefactos de compilaci√≥n de CI y se encuentran en el Registro local de Docker.  Implementa servicios en la producci√≥n de SaltStack, cuya configuraci√≥n se encuentra en el repositorio privado de Github. </p><br><p>  Los desarrolladores realizan de forma independiente solicitudes de cambios en este repositorio, donde describen los requisitos para el servicio: indican la versi√≥n y los par√°metros deseados, como el tama√±o de la memoria asignada para el contenedor, transferida a las variables de entorno y otras cosas.  Adem√°s, despu√©s de la confirmaci√≥n manual de la solicitud de cambio por parte de los empleados autorizados (tenemos DevOps, soporte y seguridad de la informaci√≥n), el CD autom√°ticamente acumula las instancias del contenedor con las nuevas versiones para los hosts del entorno del producto. </p><br><p><img src="https://habrastorage.org/webt/31/ec/iy/31eciyvgovypqogaegextoyyuf0.jpeg"></p><br><p>  Adem√°s, cada servicio escribe registros en un formato comprensible para Elasticsearch.  Filebeat recoge los archivos de registro, que los escribe en el cl√∫ster Elasticsearch.  Por lo tanto, a pesar de que los desarrolladores no tienen acceso al entorno del producto, siempre tienen la oportunidad de depurar y ver qu√© sucede con sus servicios. </p><br><h2 id="vzaimodeystvie-s-vneshnim-mirom">  Interacci√≥n con el mundo exterior. </h2><br><p><img src="https://habrastorage.org/webt/nd/wp/lw/ndwplwol-avyp6uixovsla-otfq.jpeg"></p><br><p>  Cualquier cambio en el estado de la plataforma con nosotros ocurre exclusivamente a trav√©s de llamadas a los m√©todos correspondientes de API p√∫blicas.  No utilizamos aplicaciones web cl√°sicas ni la generaci√≥n de contenido del lado del servidor, de hecho, todo lo que ves como una interfaz de usuario son vistas JS sobre nuestras API p√∫blicas.  En principio, cualquier acci√≥n en la plataforma se puede realizar con una cadena de llamadas curl desde la consola, que utilizamos.  En particular, para escribir pruebas de integraci√≥n (las hemos escrito en JS como una biblioteca), que en CI, durante cada ensamblaje, verifica todos los m√©todos p√∫blicos. </p><br><p>  Adem√°s, este enfoque resuelve todos los problemas de integraci√≥n externa con nuestra plataforma, lo que le permite obtener un protocolo √∫nico para el usuario final en forma de una hermosa forma de ingresar datos de pago y de host a host para la integraci√≥n directa con el procesamiento de terceros utilizando la interacci√≥n exclusivamente entre servidores. </p><br><p>  Adem√°s de la cobertura total de las pruebas de integraci√≥n, utilizamos los enfoques de actualizaci√≥n por etapas, en una arquitectura distribuida es bastante f√°cil hacer esto, por ejemplo, implementando solo un servicio de cada grupo en una sola pasada, seguido de una pausa y an√°lisis de registros y gr√°ficos. </p><br><p>  Esto nos permite implementar casi todo el d√≠a, incluso los viernes por la noche, desplegar algo que no funciona sin mucho miedo o retroceder r√°pidamente, haciendo un simple revertir el compromiso con un cambio, hasta que nadie se d√© cuenta. </p><br><h2 id="registraciya-v-platforme-i-publichnye-api">  Registro de plataforma y API p√∫blicas </h2><br><p><img src="https://habrastorage.org/webt/tw/m4/0l/twm40lykiloaelwx8elbj6shjge.jpeg"></p><br><p>  Antes de cualquier llamada al m√©todo p√∫blico, debemos autorizar y autenticar al cliente.  Para que un cliente aparezca en la plataforma, necesita un servicio que se encargar√° de toda la interacci√≥n con el usuario final, proporcionar√° interfaces para registrar, ingresar y restablecer contrase√±as, control de seguridad y otros enlaces. </p><br><p>  Aqu√≠, no inventamos una bicicleta, sino que simplemente integramos la soluci√≥n de c√≥digo abierto de Redhat - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Keycloak</a> .  Antes de comenzar cualquier interacci√≥n con nosotros, deber√° registrarse en la plataforma, lo que, de hecho, ocurre a trav√©s de Keycloak. </p><br><p>  Despu√©s de una autenticaci√≥n exitosa en el servicio, el cliente recibe un JWT.  Lo usaremos m√°s tarde para la autorizaci√≥n: en el lado de Keycloak, puede especificar campos arbitrarios que describan roles que se integrar√°n como una estructura json simple en JWT y se firmar√°n con la clave privada del servicio. </p><br><p>  <em>Una de las caracter√≠sticas de JWT es que esta estructura est√° firmada por la clave privada del servidor; en consecuencia, para autorizar la lista de roles y sus otros objetos, no necesitamos acceder al servicio de autorizaci√≥n, el proceso est√° completamente desacoplado.</em>  <em>Los servicios CAPI al inicio leen la clave p√∫blica Keycloak y la usan para autorizar llamadas a m√©todos API p√∫blicos.</em> </p><br><p>  <em>A medida que se nos ocurri√≥ el esquema de revocaci√≥n de claves, la historia es independiente y merece su propia publicaci√≥n.</em> </p><br><p>  Entonces, hemos recibido el JWT, podemos usarlo para la autenticaci√≥n.  Aqu√≠ entra en juego el grupo de microservicios Common API, en el diagrama indicado como CAPI y CAPI-DSS, que implementan las siguientes funciones: </p><br><ul><li>  autorizaci√≥n de mensajes recibidos.  Cada llamada API p√∫blica est√° precedida por un encabezado HTTP Authorizaion: Bearer {JWT}.  Los servicios del grupo API com√∫n lo utilizan para verificar los datos firmados con la clave p√∫blica existente del servicio de autorizaci√≥n; </li><li>  validaci√≥n de los datos recibidos.  Dado que el esquema se describe como una especificaci√≥n OpenAPI, tambi√©n conocida como Swagger, la validaci√≥n de datos puede ser muy f√°cil y con pocas posibilidades de recibir comandos de control en el flujo de datos.  Esto tiene un efecto positivo en la seguridad del servicio en su conjunto; </li><li>  traducci√≥n de formatos de datos de REST JSON p√∫blico a binario interno Thrift; </li><li>  enmarcando el enlace de transporte con datos como un √∫nico trace_id y pasando el evento m√°s adentro de la plataforma a un servicio que gestiona la l√≥gica de negocios y sabe qu√© es, por ejemplo, el pago. </li></ul><br><p>  Tenemos muchos de estos servicios, son bastante simples y no almacenan ning√∫n estado, por lo que para el escalado de rendimiento lineal simplemente los implementamos en capacidades libres en las cantidades que necesitamos. </p><br><h3 id="pci-dss-i-otkrytye-kartochnye-dannye">  PCI-DSS y datos de tarjeta abierta </h3><br><p><img src="https://habrastorage.org/webt/ak/fh/x-/akfhx-regosuv_tbadtr-x2p6uo.jpeg"></p><br><p>  Como puede ver en el diagrama, tenemos dos de estos grupos de servicios: el principal, la API com√∫n, es responsable de procesar todos los flujos de datos que no tienen datos abiertos del titular de la tarjeta, y el segundo, la API com√∫n PCI-DSS, que funciona directamente con estas tarjetas.  En el interior, son exactamente iguales, pero los separamos f√≠sicamente y los colocamos en diferentes piezas de hierro. </p><br><p>  Esto se hace para minimizar el n√∫mero de ubicaciones para almacenar y procesar datos de tarjetas, reducir los riesgos de fuga de estos datos y el √°rea de certificaci√≥n PCI-DSS.  Y esto, cr√©anme, es un proceso bastante lento y costoso: como compa√±√≠a de pagos, debemos someternos a una certificaci√≥n paga para cumplir con los est√°ndares MPS cada a√±o, y cuantos menos servidores y servicios participen en √©l, m√°s r√°pido y f√°cil ser√° completar este proceso.  Bueno, en seguridad esto se refleja de la manera m√°s positiva. </p><br><h2 id="obrabotka-platezhnyh-dannyh-i-tokenizaciya">  Facturaci√≥n y Tokenizaci√≥n </h2><br><p><img src="https://habrastorage.org/webt/2y/ya/cm/2yyacmg2lhhzmvnbjv0azaei8gi.jpeg"></p><br><p>  Por lo tanto, queremos comenzar el pago y cancelar el dinero de la tarjeta del pagador. </p><br><p>  Imagine que la solicitud se realiz√≥ en forma de una cadena de llamadas a los m√©todos de nuestra API p√∫blica, que usted inici√≥ como pagador despu√©s de ir a la tienda en l√≠nea, recoger una cesta de productos, hacer clic en "Comprar" e ingresar los datos de su tarjeta en nuestro pago formulario y haga clic en el bot√≥n "Pagar". </p><br><p>  <em>Proporcionamos varios procesos comerciales para cancelar dinero, pero el m√°s interesante es el proceso que utiliza cuentas por pagar.</em>  <em>En nuestra plataforma, puede crear una factura para el pago, o una factura que ser√° un contenedor para los pagos.</em> </p><br><p>  <em>Dentro de una factura, puede intentar pagarla una por una, es decir, crear pagos hasta que el pr√≥ximo pago sea exitoso.</em>  <em>Por ejemplo, puede intentar pagar una factura desde diferentes tarjetas, billeteras y cualquier otro m√©todo de pago.</em>  <em>Si no hay dinero en una de las tarjetas, puede probar con otra y as√≠ sucesivamente.</em> </p><br><p>  <em>Esto tiene un efecto positivo en la conversi√≥n y la experiencia del usuario.</em> </p><br><h3 id="konechnyy-avtomat-invoysa">  M√°quina de estado de factura </h3><br><p><img src="https://habrastorage.org/webt/gh/u0/ld/ghu0ld9cimq5z13mc1blstsuycy.jpeg"></p><br><p>  Dentro de la plataforma, esta cadena se convierte en interacciones a lo largo de la siguiente ruta: </p><br><ul><li>  Antes de entregar contenido a su navegador, nuestro cliente-comerciante se integr√≥ con nuestra plataforma, se registr√≥ con nosotros y recibi√≥ un JWT para autorizaci√≥n; </li><li>  desde su backend, el comerciante llam√≥ al m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">createInvoice ()</a> , es decir, cre√≥ una factura para el pago en nuestra plataforma.  De hecho, el backend del comerciante envi√≥ una solicitud HTTP POST del siguiente contenido a nuestro punto final: </li></ul><br><pre><code class="bash hljs">curl -X POST \ https://api.rbk.money/v2/processing/invoices \ -H <span class="hljs-string"><span class="hljs-string">'Authorization: Bearer {JWT}'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json; charset=utf-8'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'X-Request-ID: 1554417367'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'cache-control: no-cache'</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{ "shopID": "TEST", "dueDate": "2019-03-28T17:41:32.569Z", "amount": 6000, "currency": "RUB", "product": "Order num 12345", "description": "Delicious meals", "cart": [ { "price": 5000, "product": "Sandwich", "quantity": 1, "taxMode": { "rate": "10%", "type": "InvoiceLineTaxVAT" } }, { "price": 1000, "product": "Cola", "quantity": 1, "taxMode": { "rate": "18%", "type": "InvoiceLineTaxVAT" } } ], "metadata": { "order_id": "Internal order num 13123298761" } }'</span></span></code> </pre> <br><p>  La solicitud se equilibr√≥ en una de las aplicaciones erlang del grupo Common API, que verific√≥ su validez, fue al servicio Bender, donde recibi√≥ la clave de idempotencia, la transfiri√≥ al tift y envi√≥ una solicitud al grupo de servicios Hellgate.  La instancia de Hellgate realiz√≥ verificaciones comerciales, por ejemplo, se asegur√≥ de que el propietario de este JWT no est√© bloqueado en principio, pueda crear facturas y, en general, interactuar con la plataforma y comenz√≥ a crear una factura. </p><br><p>  <em>Podemos decir que Hellgate es el n√∫cleo de nuestro procesamiento, ya que es √©l quien opera con entidades comerciales, sabe c√≥mo iniciar un pago, qui√©n debe ser expulsado para que este pago se convierta en un cargo de dinero real, c√≥mo calcular la ruta de este pago, a qui√©n se le debe pedir que cancele el pago. reflejado en los balances, calcular comisiones y otros enlaces.</em> </p><br><p>  <em>Por lo general, tampoco almacena ning√∫n estado y tambi√©n es f√°cilmente escalable.</em>  <em>Pero no querr√≠amos perder la factura ni obtener un doble cargo de dinero de la tarjeta en caso de una divisi√≥n de la red o la falla de Hellgate por cualquier motivo.</em>  <em>Es necesario guardar persistentemente estos datos.</em> </p><br><p>  Aqu√≠ viene el tercer microservicio, a saber, Machinegun.  Hellgate env√≠a a Machinegun una llamada para "crear un aut√≥mata" con una carga √∫til en forma de par√°metros de consulta.  Machinegun organiza solicitudes concurrentes y, utilizando Hellgate, crea el primer evento a partir de los par√°metros: InvoiceCreated.  Que luego se escribe y escribe en Riak y colas.  Despu√©s de eso, se devuelve una respuesta exitosa en el orden inverso a la solicitud inicial en la cadena. </p><br><p>  <em>En resumen, Machinegun es un DBMS con temporizadores sobre cualquier otro DBMS, en la versi√≥n actual de la plataforma, sobre Riak.</em>  <em>Proporciona una interfaz que le permite controlar m√°quinas independientes y garantiza garant√≠as de idempotencia y orden de grabaci√≥n.</em>  <em>Es MG el que no permitir√° que el evento se escriba fuera de la cola autom√°ticamente si varios HG llegan repentinamente con tal solicitud.</em> </p><br><p>  <em>Un aut√≥mata es una entidad √∫nica dentro de la plataforma, que consta de un identificador, un conjunto de datos en forma de una lista de eventos y un temporizador.</em>  <em>El estado final del aut√≥mata se calcula a partir del procesamiento de todos sus eventos que inician su transici√≥n al estado correspondiente.</em>  <em>Utilizamos este enfoque para trabajar con entidades comerciales, describi√©ndolas como m√°quinas de estados finitos.</em>  <em>De hecho, todas las facturas creadas por nuestros comerciantes, as√≠ como los pagos en ellas, son m√°quinas de estados finitos con su propia l√≥gica de transici√≥n entre estados.</em> </p><br><p>  <em>La interfaz para trabajar con temporizadores en Machinegun le permite recibir una solicitud del formulario "Quiero continuar procesando esta m√°quina en 15 a√±os" de otro servicio junto con eventos para la grabaci√≥n.</em>  <em>Dichas tareas pendientes se implementan en temporizadores integrados.</em>  <em>En la pr√°ctica, se usan con mucha frecuencia: llamadas peri√≥dicas al banco, acciones autom√°ticas con pagos debido a una larga inactividad, etc.</em> </p><br><p>  <em>Por cierto, los c√≥digos fuente de Machinegun est√°n abiertos bajo la licencia Apache 2.0 en nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio p√∫blico</a> .</em>  <em>Esperamos que este servicio pueda ser de utilidad para la comunidad.</em> </p><br><p>  <em>Una descripci√≥n detallada del trabajo de Machinegun y, en general, c√≥mo preparamos el sistema de distribuci√≥n, se traslada a una publicaci√≥n grande separada, por lo que no me detendr√© aqu√≠ con m√°s detalle.</em> </p><br><h3 id="nyuansy-avtorizacii-vneshnih-klientov">  Los matices de autorizaci√≥n de clientes externos. </h3><br><p><img src="https://habrastorage.org/webt/-l/4v/zo/-l4vzorvyofnp2f4cb9xq6n3oky.jpeg"></p><br><p>  Despu√©s de un guardado exitoso, Hellgate devuelve los datos al CAPI, convierte la estructura trift binaria en un JSON bellamente dise√±ado, listo para ser enviado al backend comercial: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"invoice"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"amount"</span></span>: <span class="hljs-number"><span class="hljs-number">6000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cart"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"cost"</span></span>: <span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"Sandwich"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"taxMode"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"rate"</span></span>: <span class="hljs-string"><span class="hljs-string">"10%"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"InvoiceLineTaxVAT"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"cost"</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"Cola"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"taxMode"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"rate"</span></span>: <span class="hljs-string"><span class="hljs-string">"18%"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"InvoiceLineTaxVAT"</span></span> } } ], <span class="hljs-attr"><span class="hljs-attr">"createdAt"</span></span>: <span class="hljs-string"><span class="hljs-string">"2019-04-04T23:00:31.565518Z"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currency"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUB"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Delicious meals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dueDate"</span></span>: <span class="hljs-string"><span class="hljs-string">"2019-04-05T00:00:30.889000Z"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"18xtygvzFaa"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"metadata"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"order_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"Internal order num 13123298761"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"Order num 12345"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"shopID"</span></span>: <span class="hljs-string"><span class="hljs-string">"TEST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"unpaid"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"invoiceAccessToken"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payload"</span></span>: <span class="hljs-string"><span class="hljs-string">"{JWT}"</span></span> } }</code> </pre> <br><p>  Parece que puede enviar contenido al pagador en el navegador e iniciar el proceso de pago, pero aqu√≠ pensamos que no todos los comerciantes estar√≠an listos para implementar independientemente la autorizaci√≥n en el lado del cliente, por lo que lo implementamos nosotros mismos.  El enfoque es que CAPI genera otro JWT que le permite iniciar procesos de tokenizaci√≥n de tarjetas y administrar una factura espec√≠fica y la agrega a la estructura de la factura devuelta. </p><br><p>  Un ejemplo de los roles descritos dentro de un JWT similar: </p><br><pre> <code class="json hljs"> <span class="hljs-string"><span class="hljs-string">"resource_access"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"common-api"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"roles"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"invoices.18xtygvzFaa.payments:read"</span></span>, <span class="hljs-string"><span class="hljs-string">"invoices.18xtygvzFaa.payments:write"</span></span>, <span class="hljs-string"><span class="hljs-string">"invoices.18xtygvzFaa:read"</span></span>, <span class="hljs-string"><span class="hljs-string">"payment_resources:write"</span></span> ] } }</code> </pre> <br><p>  Este JWT tiene un n√∫mero limitado de intentos de uso y la vida √∫til que configuramos, lo que le permite publicarlo en el navegador del pagador.  Incluso si se intercepta, lo m√°ximo que un atacante puede hacer es pagar la factura de otra persona o leer sus datos.  Adem√°s, dado que la m√°quina de pago no funciona con datos de tarjetas abiertas, lo m√°ximo que puede ver un atacante es un n√∫mero de tarjeta enmascarada del tipo <code>4242 42** **** 4242</code> , el monto del pago y, opcionalmente, una cesta de mercanc√≠as. </p><br><p>  La factura creada y la clave de acceso le permiten iniciar el proceso comercial de pago.  Entregamos el ID de la factura y su JWT al navegador del pagador y transferimos el control a nuestras aplicaciones JS. </p><br><p>  Nuestra aplicaci√≥n Checkout JS implementa una interfaz para interactuar con usted como pagador: dibuja un formulario de ingreso de datos de pago, inicia un pago, recibe su estado final, muestra un punto divertido o triste. </p><br><h3 id="tokenizaciya-i-kartochnye-dannye">  Tokenizaci√≥n y datos de la tarjeta </h3><br><p><img src="https://habrastorage.org/webt/gq/1d/gb/gq1dgbxkq1ewsfohsytcdvnotzs.jpeg"></p><br><p>  Pero Checkout no funciona con los datos de la tarjeta.  Como se mencion√≥ anteriormente, queremos almacenar datos confidenciales en forma de datos del titular de la tarjeta en la menor cantidad de lugares posible.  Para hacer esto, implementamos tokenizaci√≥n. </p><br><p>  Aqu√≠ es donde entra en juego la biblioteca Tokenizer JS.  Cuando ingresa su tarjeta en los campos de entrada y hace clic en "Pagar", intercepta estos datos y nos los env√≠a de forma as√≠ncrona para su procesamiento llamando al m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">createPaymentResource ()</a> . </p><br><p>  Esta solicitud est√° equilibrada para aplicaciones CAPI-DSS individuales, que tambi√©n autorizan la solicitud, solo verificando la factura JWT, validando los datos y envi√°ndolos por adelantado al servicio de almacenamiento de datos de la tarjeta.  En el diagrama, se indica como CDS - Almacenamiento de datos de tarjeta. </p><br><p>  Los principales objetivos de este servicio: </p><br><ul><li>  recibir datos confidenciales en una entrada, en nuestro caso, datos de su tarjeta; </li><li>  cifrar estos datos con una clave de cifrado de datos; </li><li>  generar alg√∫n valor aleatorio utilizado como clave; </li><li>  guardar datos cifrados en esta clave en su cl√∫ster Riak; </li><li>  devuelva la clave en forma de token de datos de pago al servicio CAPI-DSS. </li></ul><br><p>  En el camino, el servicio resuelve un mont√≥n de tareas importantes, como generar claves para cifrar claves, ingresar estas claves de forma segura, volver a cifrar datos, controlar la eliminaci√≥n de CVV despu√©s del pago, etc., pero esto est√° m√°s all√° del alcance de esta publicaci√≥n. </p><br><p>  <em>No fue sin protecci√≥n contra la posibilidad de dispararte en el pie.</em>  <em>Existe una probabilidad distinta de cero de que un JWT privado, dise√±ado para autorizar solicitudes del backend, se publique en la web en el navegador del cliente.</em>  <em>Para evitar que esto suceda, incorporamos protecci√≥n: puede llamar al m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">createPaymentResource ()</a> solo con la clave de autorizaci√≥n de la factura.</em>  <em>Cuando intente utilizar una plataforma JWT privada, devolver√° un error HTTP / 401.</em> </p><br><p>  Despu√©s de completar la solicitud de tokenizaci√≥n, el Tokenizer devuelve el token recibido a Checkout y finaliza su trabajo al respecto. </p><br><h3 id="biznes-process-platezhnogo-avtomata">  Proceso de negocio de m√°quina de pago </h3><br><p><img src="https://habrastorage.org/webt/ai/9s/7j/ai9s7jsxfzkuoume64zcw_chcks.png"></p><br><p>  Checkout inicia el proceso de pago, es decir, llama al m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">createPayment ()</a> , pasa el token de la tarjeta previamente recibido como argumento e inicia el proceso de eventos de sondeo, de hecho, llama al m√©todo API <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">getInvoiceEvents ()</a> una vez por segundo. </p><br><p>  Estas solicitudes a trav√©s de CAPI se incluyen en Hellgate, que comienza a implementar un proceso comercial de pago, sin utilizar los datos de la tarjeta: </p><br><ul><li>  En primer lugar, Hellgate va al servicio de administraci√≥n de configuraci√≥n - Dominante y recibe la revisi√≥n actual de la configuraci√≥n del dominio.  Contiene todas las reglas por las cuales se realizar√° este pago, para qu√© banco ir√° a autorizaci√≥n, qu√© tarifas de transacci√≥n se registrar√°n, etc. <br><ul><li>  del servicio de gesti√≥n de miembros, ahora es parte de HG, aprende datos sobre los n√∫meros internos de las cuentas del comerciante a favor de los cuales se realiza el pago, aplica el monto de las tarifas, prepara un plan de contabilizaci√≥n y lo pone en el servicio Shumway.  Este servicio es responsable de administrar la informaci√≥n sobre el movimiento de dinero en las cuentas de los participantes en una transacci√≥n al realizar un pago.  El plan de contabilizaci√≥n contiene la instrucci√≥n "para congelar el posible movimiento de fondos en las cuentas de los participantes en la transacci√≥n especificada en el plan"; </li><li>  enriquece los datos de pago al referirse a servicios adicionales, por ejemplo, en Binbase para averiguar el pa√≠s del banco emisor que emiti√≥ la tarjeta y su tipo, por ejemplo, "oro, cr√©dito"; </li><li>  llama al servicio del inspector, por lo general, esto es Antifraude para recibir la puntuaci√≥n de pago y decidir la elecci√≥n de una terminal que cubra el nivel de riesgo emitido por la puntuaci√≥n.  Por ejemplo, un terminal sin 3D-Secure puede usarse para pagos de bajo riesgo, y un pago que ha recibido un nivel de riesgo fatal terminar√° su vida con esto; </li><li>  llama al servicio de detecci√≥n de errores, el Detector de fallas y, en funci√≥n de los datos recibidos, selecciona la ruta de pago: el adaptador de protocolo bancario, que actualmente tiene la menor cantidad de errores y la mayor probabilidad de pago exitoso; </li><li>  env√≠a una solicitud al adaptador de protocolo de banco seleccionado, deje que sea el adaptador de YellowBank, "autorice la cantidad especificada de este token" en este caso. </li></ul></li></ul><br><p>  El adaptador de protocolo para el token recibido va a CDS, recibe los datos descifrados de la tarjeta, los transfiere a un protocolo espec√≠fico del banco y, en general, recibe autorizaci√≥n, confirmaci√≥n del banco adquirente de que la cantidad indicada se ha congelado en la cuenta del pagador. </p><br><p>  Es en este momento que recibe un SMS con un mensaje sobre el d√©bito de fondos de su tarjeta desde su banco, aunque de hecho los fondos solo se han congelado en su cuenta. </p><br><p>  El adaptador notifica a HG de la autorizaci√≥n exitosa, su c√≥digo CVV se elimina del servicio CDS y este es el final de la etapa de interacci√≥n.  La gerencia vuelve a HG. </p><br><p><img src="https://habrastorage.org/webt/jv/mm/cu/jvmmcuhwjxslwo0rvu5w-lsfsyy.jpeg"></p><br><p>  Dependiendo de la llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">createPayment ()</a> especificada por el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comerciante del</a> proceso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comercial de</a> pago, HG espera llamadas desde la API externa al m√©todo de captura de autorizaci√≥n, es decir, la confirmaci√≥n del retiro de dinero de su tarjeta, o lo hace inmediatamente por su cuenta, si el comerciante elige el esquema Pago en una sola etapa. </p><br><p>  <em>Como regla general, la mayor√≠a de los comerciantes utilizan un pago en una etapa, sin embargo, hay categor√≠as de negocios que, en el momento de la autorizaci√≥n, a√∫n no conocen el monto total adeudado.</em>  <em>Esto sucede a menudo en la industria del turismo cuando reserva un tour por una cantidad, y despu√©s de confirmar la reserva, la cantidad se especifica y puede diferir de la autorizada al principio.</em> </p><br><p>  <em>A pesar del hecho de que la cantidad de confirmaci√≥n puede ser exclusivamente igual o menor que la cantidad de autorizaci√≥n, aqu√≠ hay dificultades.</em>  <em>Imagine que paga por un producto o servicio desde una tarjeta en una moneda diferente de la moneda de su cuenta bancaria a la que est√° vinculada la tarjeta.</em> </p><br><p>  <em>En el momento de la autorizaci√≥n, el monto bloqueado en su cuenta en funci√≥n del tipo de cambio del d√≠a de la autorizaci√≥n.</em>  <em>Dado que el pago puede estar en el estado de "autorizado" (a pesar de que el Ministerio de Ferrocarriles tiene recomendaciones para un per√≠odo m√°ximo y ahora es de 3 d√≠as) durante varios d√≠as, la captura de la autorizaci√≥n se realizar√° a la tasa del d√≠a en que se realiz√≥.</em> </p><br><p>  <em>Por lo tanto, asume riesgos cambiarios, que pueden ser tanto a su favor como en su contra, especialmente en una situaci√≥n de alta volatilidad en el mercado de divisas.</em> </p><br><p>  Para capturar la autorizaci√≥n, se produce el mismo proceso de comunicaci√≥n con el adaptador de protocolo que para su recepci√≥n, y si tiene √©xito, HG aplica el plan de registro de cuenta dentro de Shumway y transfiere el pago al estado "Pagado".  Es en este momento que nosotros, como sistema de pago, tenemos obligaciones financieras con los participantes en la transacci√≥n. </p><br><p>  Tambi√©n vale la pena se√±alar que Hellgate registra en Machinegun cualquier cambio en el estado de la m√°quina de facturaci√≥n, que incluye el proceso de pago, lo que garantiza la persistencia de los datos y enriquece la factura con nuevos eventos. </p><br><h3 id="sinhronizaciya-sostoyaniy-avtomata-platezha-i-ui">  Sincronizaci√≥n de estado de una m√°quina de pago y UI </h3><br><p><img src="https://habrastorage.org/webt/o7/hf/iz/o7hfizxfqdiyz_5xlxugdhc_fsq.jpeg"></p><br><p>  Mientras el proceso de pago en segundo plano se lleva a cabo dentro de la plataforma, Checkout vierte el proceso solicitando eventos.  Al recibir ciertos eventos, dibuja el estado actual del pago de manera comprensible para una persona: dibuja un precargador, muestra la pantalla "Su pago se proces√≥ con √©xito" o "No se pudo recibir el pago", o redirige el navegador a la p√°gina de su banco emisor para ingresar la contrase√±a 3D-Secure; </p><br><p>  Si falla, Checkout le ofrecer√° elegir otro m√©todo de pago o volver a intentarlo, comenzando as√≠ un nuevo pago como parte de la factura. </p><br><p>  Tal esquema con sondeo de eventos hace posible restaurar el estado incluso despu√©s de cerrar la pesta√±a del navegador; en caso de inicio repetido, Checkout recibir√° la lista actual de eventos y dibujar√° el escenario actual de interacci√≥n del usuario, por ejemplo, ofrecer√° ingresar el c√≥digo 3D-Secure o mostrar√° que el pago ya se ha completado con √©xito. </p><br><h2 id="replikaciya-sobytiy-v-offline-zone">  Replicaci√≥n de eventos en la zona sin conexi√≥n </h2><br><p><img src="https://habrastorage.org/webt/ay/rm/sb/ayrmsbidsvdz2c9rxxkgge6easo.jpeg"></p><br><p>  Junto con las interfaces de control de la m√°quina, Machinegun implementa un servicio responsable de desbordar el flujo de eventos a los servicios responsables de otras tareas menos en l√≠nea de la plataforma. </p><br><p>  Como agente de colas en las finales, nos decidimos por Kafka, aunque anteriormente implementamos esta funcionalidad utilizando Machinegun.  En el caso general, este servicio es la preservaci√≥n de un flujo de eventos ordenado garantizado, o la emisi√≥n de una lista espec√≠fica de eventos a pedido de otros consumidores. </p><br><p>  Inicialmente, tambi√©n implementamos un esquema de deduplicaci√≥n de eventos, proporcionando garant√≠as de que el mismo evento no se replicar√≠a dos veces, sin embargo, la carga en Riak, que fue generada por uno similar, nos hizo rechazarlo; despu√©s de todo, buscar por √≠ndices no es lo mejor. Capacidad de almacenamiento de KV.  Ahora, cada consumidor de servicios es responsable de la deduplicaci√≥n de eventos de forma independiente. </p><br><p>  En general, la replicaci√≥n de eventos por parte de Machinegun termina con la confirmaci√≥n del almacenamiento de datos en Kafka, y los consumidores ya est√°n conectados a los temas de Kafka y descargan las listas de eventos que les interesan. </p><br><h3 id="shablon-tipichnogo-prilozheniya-offline-zony">  Plantilla t√≠pica de aplicaci√≥n de zona sin conexi√≥n </h3><br><p>  Por ejemplo, el servicio Dudoser es responsable de enviarle una notificaci√≥n por correo electr√≥nico de un pago exitoso.  Al inicio, genera una lista de eventos de pagos exitosos, toma informaci√≥n sobre la direcci√≥n y la cantidad desde all√≠, la guarda en una instancia local de PostgreSQL y la usa para el procesamiento posterior de la l√≥gica comercial. </p><br><p>  Todos los dem√°s servicios similares funcionan de acuerdo con la misma l√≥gica, por ejemplo, el servicio Magista, que es responsable de buscar facturas y pagos en la cuenta personal del comerciante o el servicio Hooker, que env√≠a devoluciones de llamada asincr√≥nicas al backend a los comerciantes que por una raz√≥n u otra no pueden organizar eventos de votaci√≥n contactando directamente a la API de procesamiento. </p><br><p>  Este enfoque nos permite liberar la carga del procesamiento, asignar los recursos m√°ximos y proporcionar alta velocidad y disponibilidad de procesamiento de pagos, proporcionando una alta conversi√≥n.  Las consultas pesadas como "los clientes comerciales quieren ver las estad√≠sticas sobre los pagos durante el a√±o pasado" son procesadas por servicios que no afectan la carga actual de la parte de procesamiento en l√≠nea y, por lo tanto, no lo afectan a usted, como pagadores y comerciantes, como nuestros clientes. </p><br><p>  Quiz√°s nos detendremos en esto para no convertir la publicaci√≥n en un alargado demasiado largo.  En futuros art√≠culos, definitivamente le contar√© sobre los matices de garantizar la atomicidad de los cambios, las garant√≠as y el orden en un sistema distribuido cargado usando Machinegun, Bender, CAPI e Hellgate como ejemplos. </p><br><p>  Bueno, sobre Salt Stack la pr√≥xima vez <code>¬Ø\_(„ÉÑ)_/¬Ø</code> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447440/">https://habr.com/ru/post/447440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447426/index.html">¬øC√≥mo, a qui√©n y por qu√© ir a consultar? Experiencia personal con Big Data</a></li>
<li><a href="../447430/index.html">IntelliJ IDEA 2019.1: Personalizaci√≥n de temas de interfaz, cambio de expresiones de Java 12, depuraci√≥n dentro de contenedores Docker</a></li>
<li><a href="../447434/index.html">Con amor de Stepik: plataforma educativa Hyperskill</a></li>
<li><a href="../447436/index.html">Seminario web "¬øPor qu√© necesitamos probadores?"</a></li>
<li><a href="../447438/index.html">Prueba unitaria y pruebas abstractas</a></li>
<li><a href="../447442/index.html">Presentamos el operador de shell: hacer que los operadores de Kubernetes sean a√∫n m√°s f√°ciles</a></li>
<li><a href="../447446/index.html">Talleres de IBM: primavera-verano 2019: inteligencia artificial, desarrollo en la nube, chat bots, blockchain y otras tecnolog√≠as</a></li>
<li><a href="../447448/index.html">Evoluci√≥n de la inteligencia: el comienzo</a></li>
<li><a href="../447450/index.html">Romper un simple "crack" con Ghidra - Parte 1</a></li>
<li><a href="../447452/index.html">Seguridad de la cadena de suministro: "Si yo fuera un estado naci√≥n ..."</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>