<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš‹ ğŸ“— ğŸ†˜ å¦‚ä½•åœ¨é¡¹ç›®ä¸­è¿›è¡Œé«˜åº¦å¯å®šåˆ¶çš„ç¼“å­˜å¹¶é¿å…åŒäº‹ç¼–å†™ç›¸åŒç±»å‹çš„ä»£ç  ğŸŒï¸ ğŸ“¹ ğŸ–ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘æƒ³ï¼šâ€œå¦‚æœç¨‹åºå‘˜å·¥ä½œçš„æœ¬è´¨æ˜¯ä½¿ä»–äººçš„å·¥ä½œè‡ªåŠ¨åŒ–ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘çš„å·¥ä½œè‡ªåŠ¨åŒ–å¾—è¿™ä¹ˆå°‘â€ï¼Œæˆ‘å†æ¬¡å¤åˆ¶äº†é¡¹ç›®ä¸­æ‰€éœ€çš„æ‰€æœ‰ç»‘å®šï¼Œä»¥å‘æ•°æ®åº“æ·»åŠ æ–°å®ä½“ã€‚ æˆ‘å†³å®šæ‘†è„±æ·»åŠ ä¾‹ç¨‹ç±»çš„ä¾‹ç¨‹ï¼ŒåŒæ—¶å¯¹é¡¹ç›®è¿›è¡Œâ€œè‰¯å¥½â€å¤„ç†ï¼Œä»ä¸å¿…è¦çš„è¯»å–æ“ä½œä¸­å¸è½½æ•°æ®åº“ã€‚ 

 åœ¨å®éªŒå¼€å§‹æ—¶ï¼Œæœ‰å…³æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„ç³»ç»ŸåŠå…¶çŠ¶æ€çš„ä¸€å°éƒ¨åˆ†å†…å®¹ï¼š...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¦‚ä½•åœ¨é¡¹ç›®ä¸­è¿›è¡Œé«˜åº¦å¯å®šåˆ¶çš„ç¼“å­˜å¹¶é¿å…åŒäº‹ç¼–å†™ç›¸åŒç±»å‹çš„ä»£ç </h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453382/"> æˆ‘æƒ³ï¼šâ€œå¦‚æœç¨‹åºå‘˜å·¥ä½œçš„æœ¬è´¨æ˜¯ä½¿ä»–äººçš„å·¥ä½œè‡ªåŠ¨åŒ–ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘çš„å·¥ä½œè‡ªåŠ¨åŒ–å¾—è¿™ä¹ˆå°‘â€ï¼Œæˆ‘å†æ¬¡å¤åˆ¶äº†é¡¹ç›®ä¸­æ‰€éœ€çš„æ‰€æœ‰ç»‘å®šï¼Œä»¥å‘æ•°æ®åº“æ·»åŠ æ–°å®ä½“ã€‚ æˆ‘å†³å®šæ‘†è„±æ·»åŠ ä¾‹ç¨‹ç±»çš„ä¾‹ç¨‹ï¼ŒåŒæ—¶å¯¹é¡¹ç›®è¿›è¡Œâ€œè‰¯å¥½â€å¤„ç†ï¼Œä»ä¸å¿…è¦çš„è¯»å–æ“ä½œä¸­å¸è½½æ•°æ®åº“ã€‚ <br><a name="habracut"></a><br> åœ¨å®éªŒå¼€å§‹æ—¶ï¼Œæœ‰å…³æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„ç³»ç»ŸåŠå…¶çŠ¶æ€çš„ä¸€å°éƒ¨åˆ†å†…å®¹ï¼š <br><br><ul><li> ä¸€ä¸ªç³»ç»Ÿï¼Œå…¶ä¸­90ï¼…çš„æ•°æ®è¢«ä¸»åŠ¨æ›´æ”¹å’Œå¤„ç†ï¼ˆäº¤æ˜“ï¼Œä¸ªäººæ•°æ®ï¼Œè®¡ç®—å¾—å‡ºçš„æ±‡æ€»ï¼‰ï¼Œä½†å¾ˆå°‘è¯»å–ï¼Œå…¶ä½™10ï¼…çš„æ•°æ®å¾ˆå°‘æ›´æ”¹ï¼Œä½†ç”¨äºæ¯æ¬¡æœºä¼šè¯»å– </li><li>  .NET Frameworkä¸Šå‡ ä¹æ‰€æœ‰çš„æœåŠ¡ï¼Œåœ¨å…¶ä¸­éƒ½å®ç°äº†è¿™äº›æœåŠ¡ </li><li>  Nhibernateå…·æœ‰æœ€å°çš„ç»‘å®šï¼Œç”¨äºè®¿é—®æ•°æ®åº“å’ŒåŸºäºæ•°æ®åº“çš„ä¸€å®šæ•°é‡çš„ç¼“å­˜ï¼ˆå¯¹BOå®ä½“è¿›è¡Œæ›´æ”¹çš„è®¢é˜…ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶è°ƒç”¨çš„å¤„ç†ç¨‹åºï¼‰ </li><li> åå‡ æ¡æ½œè§„åˆ™ï¼šâ€œå¦‚ä½•ç¼–å†™ä»£ç ä»¥è®¿é—®æ•°æ®åº“è€Œåˆä¸æŸå¤±NHibernateåŠŸèƒ½çš„æ€§èƒ½â€ï¼Œè¿™äº›è§„åˆ™ç»å¸¸åœ¨Core Reviewä¸Šæµè¡Œ </li><li> éœ€è¦ä¼˜åŒ–çš„æ•°æ®åº“æœ‰äº›æ²‰é—· </li></ul><br> åœ¨è€ƒè™‘æ•°æ®åº“çš„æƒ…å†µæ—¶ï¼Œå‡ºç°äº†ä¸€ä¸ªæƒ³æ³•ï¼šæ˜¯å¦ä»æ•°æ®åº“çš„è´Ÿè½½ä¸­åˆ é™¤è¿™10ï¼…çš„ç›¸åŒè¯·æ±‚ï¼ˆå¹¶åŒæ—¶æ‰“å¼€å®ƒä»¬æ‰€éœ€çš„ä¸æ•°æ®åº“çš„è¿æ¥ï¼Œä¿æŒå¼€æ”¾çš„äº‹åŠ¡å¹¶ä½¿ç”¨æ¨¡æ¿ä»£ç é€šè¿‡æˆ‘ä»¬çš„å­˜å‚¨åº“è®¿é—®æ•°æ®åº“ï¼‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰å¿…è¦è€ƒè™‘ï¼š <br><br><ul><li> æˆ‘ä»¬å·²ç»å°è¯•ä½¿ç”¨Nhibernateç¼“å­˜ï¼Œä½†æ˜¯å‘ç°å…¶è¡Œä¸ºå¹¶ä¸æ€»æ˜¯æ˜ç¡®ä¸”å¯é¢„æµ‹çš„ã€‚ </li><li> æˆ‘ä¸æƒ³åœ¨æ²¡æœ‰å……åˆ†ç†ç”±çš„æƒ…å†µä¸‹ä»æ ¹æœ¬ä¸Šæ›´æ”¹å¹³å°æˆ–åŸºç¡€æ¶æ„ä¸­çš„ä»»ä½•å†…å®¹ </li><li> ç»“æœï¼Œä¸ä»»ä½•æ‡’æƒ°çš„ç¨‹åºå‘˜ä¸€æ ·ï¼Œæ‰‹å†™ä»£ç çš„æ•°é‡åº”è¯¥å‡å°‘äº†ï¼Œç”¨æ‰‹ç¼–å†™äº†æ•°ç™¾è¡ŒåŒ…è£…ç¨‹åºå’Œç°æœ‰ç¼“å­˜çš„è®¢é˜… </li></ul><br><div class="spoiler">  <b class="spoiler_title">è¿™äº›æ—§ç¼“å­˜ä¹‹ä¸€çš„ç¤ºä¾‹å®ç°</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Base class for caches, containing rarely changed entities. Updated by subscription to nHibernate session commits. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">Type, used as a base for the cache. Sessions, containing changes to any instance of this class will cause cache refresh.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="K"&gt;</span></span></span><span class="hljs-comment">Key used for cache search.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="V"&gt;</span></span></span><span class="hljs-comment">Value, stored in cache.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public abstract class RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T, K, V&gt;</span></span></span><span class="hljs-comment"> : EmptySessionNotificationListener, ITransactionNotificationListener, IRareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment"> where T : class { [NotNull] private static readonly ILog Log = IikoBizLogManager.GetLogger(typeof(RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T, K, V&gt;</span></span></span><span class="hljs-comment">)); [NotNull] protected readonly ReaderWriterLockSlim LockObj = new ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion); [NotNull] protected readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment"> Cache = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment">(); [NotNull] protected abstract QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> GetQuery(); [NotNull] private readonly ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;String, bool&gt;</span></span></span><span class="hljs-comment"> changesByTransaction = new ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, bool&gt;</span></span></span><span class="hljs-comment">(); private DateTime lastRefreshTime = DateTime.MinValue; [NotNull] public HibernateSessionManager SessionManager { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Interval of automatic data renewal for cases of read access to cache. Also, cache is forcibly refreshed on any commit, changing base entities of this cache. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public TimeSpan AutoRefreshInterval { get; set; } public void Reset() { lastRefreshTime = DateTime.MinValue; } protected void ReloadCacheIfNeeded(ISession session = null) { if (SystemTime.Now - lastRefreshTime </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;= AutoRefreshInterval) return; LockObj.EnterWriteLock(); try { if (SystemTime.Now - lastRefreshTime &lt;= AutoRefreshInterval) return; IList&lt;object&gt;</span></span></span><span class="hljs-comment"> result; if (session == null) result = SessionManager.CallTransacted(s =&gt; GetQuery().GetExecutableQueryOver(s).List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">()); else //TODO At that moment, the transaction may have been closed, so a new transaction opens implicitly result = GetQuery().GetExecutableQueryOver(session).List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">(); Cache.Clear(); ProcessResult(result); lastRefreshTime = SystemTime.Now; } catch (Exception e) { Log.Error("Exception on cache invalidation: ", e); } finally { LockObj.ExitWriteLock(); } } protected abstract void ProcessResult(IList</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> result); public override void OnSaveOrUpdate(ISession session, object entity, Guid id, object[] currentState, object[] previousState, string[] propertyNames, IType[] types) { if (entity is T) { var transactionName = HibernateSessionManager.GetTransactionName(); if (!string.IsNullOrEmpty(transactionName)) { changesByTransaction.TryAdd(transactionName, true); } } } public override void OnDelete(ISession session, object entity, Guid id) { if (entity is T) { var transactionName = HibernateSessionManager.GetTransactionName(); if (!string.IsNullOrEmpty(transactionName)) { changesByTransaction.TryAdd(transactionName, true); } } } void ITransactionNotificationListener.AfterCommit(ISession session, string transactionName) { bool tmp; if (changesByTransaction.TryRemove(transactionName, out tmp)) Reset(); ReloadCacheIfNeeded(session); } void ITransactionNotificationListener.AfterRollback(ISession session, string transactionName) { } public bool Contains(K key) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return Cache.ContainsKey(key); } finally { LockObj.ExitReadLock(); } } public virtual V TryGet(K key) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return Cache.TryGetValue(key, out var value) ? value : default; } finally { LockObj.ExitReadLock(); } } protected TV GetOrAddEntry</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TK, TV&gt;</span></span></span><span class="hljs-comment">(IDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TK, TV&gt;</span></span></span><span class="hljs-comment"> dictionary, TK key) where TV : new() { TV list; if (!dictionary.TryGetValue(key, out list)) dictionary[key] = (list = new TV()); return list; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Caches all guest categories, grouped by organization or network they belong. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [UsedImplicitly] public sealed class GuestCategoryCache : RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory, Guid, HashSet&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment">&gt; { private static readonly QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment"> SelectAllEntitiesQuery = QueryOver.Of</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment">() .Fetch(gc =&gt; gc.Organization).Eager .Fetch(gc =&gt; gc.Network).Eager; private readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Guid, string&gt;</span></span></span><span class="hljs-comment"> invertedCache = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Guid, string&gt;</span></span></span><span class="hljs-comment">(); public bool TryGetNetworkExternalId(Guid id, out string extId) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return invertedCache.TryGetValue(id, out extId); } finally { LockObj.ExitReadLock(); } } protected override QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment"> GetQuery() { return SelectAllEntitiesQuery; } protected override void ProcessResult(IList</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> result) { invertedCache.Clear(); foreach (GuestCategory gc in result) { var orgOrNetworkId = gc.Organization?.Id ?? gc.Network.Id; GetOrAddEntry(Cache, orgOrNetworkId).Add(gc); } } }</span></span></code> </pre> <br></div></div><br> å½“æ—¶å·²ç»æœ‰ç‚¹ç´¯äº†ã€‚ <br>  -æ–°åŠŸèƒ½ä¸åº”åœ¨æ•´ä½“ä¸Šå½±å“å…¶ä»–å¼€å‘äººå‘˜ï¼Œå‘æ–°æ–¹æ³•çš„è¿ç§»åº”å¹³ç¨³è€Œæ¸©å’Œåœ°è¿›è¡Œã€‚ <br><br> åŒæ—¶ï¼Œæˆ‘æƒ³ç¡®ä¿åœ¨ç¼“å­˜æœºåˆ¶ä¸­æ·»åŠ æ–°å®ä½“èŠ±äº†æœ€å°‘çš„ç²¾åŠ›ï¼Œä»£ç ä¿æŒäº†å¯è¯»æ€§å’Œç›´æ¥æ€§ï¼Œå¹¶ä¸”å½“ä»ç¼“å­˜ä¸­æ£€ç´¢æ•°æ®æ—¶ï¼Œäººä»¬å¯ä»¥æœ€å°‘åœ°è€ƒè™‘åº”è¯¥ç¼–å†™ä»€ä¹ˆè¾…åŠ©ä»£ç ã€‚ æœ€åä¸¤ç‚¹å¤§å¤§å‡å°‘äº†é€‰æ‹©èŒƒå›´ã€‚ å®é™…ä¸Šï¼Œæ‚¨å¿…é¡»åœ¨åå°„å’Œæ³›å‹ç±»ä¸­æœ‰æ‰€ä½œä¸ºï¼Œæˆ–è€…è½¬å‘æ—§çš„å…ƒç¼–ç¨‹ã€‚ <br><br> ç”±äºä¸»è¦çš„å¼€å‘å·¥å…·æ˜¯Visual Studioï¼Œä½†æˆ‘ä¸æƒ³èŠ±å¾ˆå¤šç²¾åŠ›ï¼Œå› ä¸ºå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ•ˆæœï¼Œå› æ­¤æˆ‘å†³å®šä½¿ç”¨æœ€æ ‡å‡†çš„å·¥å…·â€œåœ¨é¢å¤´ä¸Šâ€åšå‡ºå†³å®šï¼Œè€Œä»…åœ¨å®Œæˆçš„æ¦‚å¿µè¯æ˜é˜¶æ®µä½¿ç”¨å‡ ä¸ªæœ€å¸¸ç”¨çš„å·¥å…·å®ä½“-å‘æ³•é™¢åŒäº‹æå‡ºå†³å®šã€‚ <br><br> æ¥ä¸‹æ¥æ˜¯ä¸€äº›é“å¾·å›°å¢ƒã€‚ æ˜¯å¦ä½¿ç”¨æŸäº›ç±»åœ¨æ‰€æœ‰åœºåˆéƒ½æŒ‚æœ‰å±æ€§çš„ç±»ä½œä¸ºæºï¼ˆé‡‡ç”¨Nhibernateåœ¨ç±»å›ºé†‡ä¸Šçš„Fluentæ˜ å°„çš„æ ·å¼ï¼‰ï¼Œæˆ–ç¼–å†™ç²¾ç¾çš„XMLã€‚ è®°ä½æ‡’æƒ°æ˜¯ç¨‹åºå‘˜æœ€å¥½çš„æœ‹å‹ï¼Œå¹¶ä¸”é€‰æ‹©å¸¦æœ‰å±æ€§çš„ç±»æ¯”ç¼–å†™ä¸€äº›XMLè€—æ—¶æ›´å¤šï¼Œæˆ‘é€‰æ‹©äº†åè€…ã€‚ <br><br> æœ¬è´¨ä¸Šï¼Œæˆ‘ä»å®ä½“æè¿°ä¸­éœ€è¦ä»€ä¹ˆï¼Ÿ <br><br><ul><li> ç¼“å­˜å­—æ®µçš„æè¿° </li><li> å¯ä»¥æŒ‡å®šä»è¿™äº›æ•°æ®ä¸­è·å–æ ·æœ¬çš„å±æ€§çš„èƒ½åŠ›ï¼Œå¦‚æœ‰å¿…è¦ï¼Œè¿˜å¯ä»¥é€šè¿‡æ¶ˆé™¤åˆ—è¡¨çš„çº¿æ€§é€šè¿‡æ¥ä¼˜åŒ–è¿™äº›æ ·æœ¬çš„èƒ½åŠ›ï¼ˆå¦‚æœæ‚¨ä»äº‹çš„æ˜¯ä¼˜åŒ–ï¼Œé‚£ä¹ˆè¯·å®Œæˆï¼‰ </li><li> ä¸ºäº†å°†ç±»åˆ†é…åˆ°ä¸åŒçš„æ–‡ä»¶å¤¹ä¸­å¹¶ä½¿ç”¨ä»£ç ä¸­çš„ç°æœ‰æ”¹è¿›æ¥å‡å°‘å…¶æ•°é‡ï¼Œä»»ä½•å…¶ä»–ä¾¿åˆ© </li></ul><br><div class="spoiler">  <b class="spoiler_title">æˆ‘ä»¬å¾—åˆ°äº†è¿™ä¸ªxmlç»“æ„</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">class</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"GuestCategory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logicallyDeletable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">revisioned</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">organizationNetworkBased</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">basedOn</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BO.GuestCategory"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitBo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">emitMapping</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitRepository</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dependsOn</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"guestCategoryCache"</span></span></span><span class="hljs-tag">&gt;</span></span>IGuestCategoryRepository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitRepository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IsActive"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bool"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IsDefaultForNewGuests"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bool"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">notNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">class</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br> è¿˜æœ‰ä¸€ä¸ªå¯æ€•çš„T4æ¨¡æ¿ï¼Œç”¨äºè§£æå®ƒå¹¶ç”Ÿæˆå„ç§ä½†æ€¥éœ€çš„ç±»ï¼š <br><br><ul><li> å…·æœ‰ä¸BOç›¸åŒå­—æ®µä½†ä¸å¯ç¼–è¾‘çš„â€œç¼“å­˜â€ç±»å‹ </li><li> ä½¿ç”¨ç­›é€‰å™¨é€‰æ‹©æ–¹æ³•ä¸ºç±»å‹å®ç°ç¼“å­˜ </li><li> ç¼“å­˜çš„æ³¨å†Œè¡¨ï¼Œç”¨äºè®¢é˜…Nhibernateåœ¨DIä¸­è¿›è¡Œé€šçŸ¥å’Œæ³¨å†Œçš„æœºåˆ¶ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºSpringï¼‰ </li><li> æ‰€æœ‰è¿™äº›æ¥å£éƒ½å¯ä»¥éšè—å†…éƒ¨ï¼Œå¹¶åœ¨å¿…è¦æ—¶å¯ä»¥ç”¨æ‰‹å†™å’Œåé€€æ›¿æ¢ç”Ÿæˆçš„ä»£ç ã€‚ </li><li> ä»ä¸€å¼€å§‹å°±è·å¾—ä»¤äººæ„å¤–çš„è®¡åˆ’å¤–å¥–é‡‘ï¼Œå¦‚æœå·²ç»å‡†å¤‡å¥½ä¸ä¸»è¦å®ä½“çš„åˆä½œ-æˆ‘èµ°äº†åŠæ­¥èµ°è¿ï¼Œå¹¶ä¸”åœ¨ä¸€ä¾§å¢åŠ äº†ç”Ÿæˆç®€å•BOç±»å‹å’Œæ˜ å°„åˆ°å®ƒä»¬çš„èƒ½åŠ›ï¼Œä½¿åŒäº‹æœ‰æœºä¼šä»¥åŠè¸¢çš„æ–¹å¼æ·»åŠ æ–°çš„ç±»ã€‚ </li></ul><br> ä»é€»è¾‘çš„è§’åº¦æ¥çœ‹ï¼Œæ¨¡æ¿æœ¬èº«åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼šå°†åŸå§‹xmlè§£æä¸ºæè¿°æ‰€éœ€ç±»ç»“æ„çš„ç±»ï¼ˆä¸ºå‡å°‘ä»»ä½•éšå¼è¡Œä¸ºçš„é£é™©ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†³å®šé€šè¿‡æ˜¾å¼è§£ææ ‡ç­¾è€Œä¸æ˜¯é€šè¿‡æ˜ å°„æ¥å®Œæˆï¼‰å±æ€§ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">ç»“æ„ç±»</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> LogicallyDeletable { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> BasedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DalBOType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] Implements { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] Include { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CustomConsistencyManager { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;DalField&gt; Fields { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;DalField&gt; ExplicitlyDefinedFields { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalGetBy[] GetBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalGetBy[] GetAllBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> GenerateInterface { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalEmitBo EmitBo { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalEmitRepository EmitRepository { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalClass</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Implements = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='implements']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; f.InnerText + <span class="hljs-string"><span class="hljs-string">","</span></span>) .ToArray(); Include = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='include']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; f.InnerText) .ToArray(); Name = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); LogicallyDeletable = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"logicallyDeletable"</span></span>); BasedOn = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"basedOn"</span></span>); DalBOType = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"dalBoType"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"dalBoType"</span></span>) : BasedOn; CustomConsistencyManager = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"customConsistencyManager"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"customConsistencyManager"</span></span>) == <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Fields = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='field']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalField(f)) .ToList(); ExplicitlyDefinedFields = Fields.ToList(); Fields = Fields.OrderBy(f=&gt;f.Name).ToList(); GetBy = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='getBy']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalGetBy(f)) .ToArray(); GetAllBy = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='getAllBy']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalGetBy(f)) .ToArray(); EmitBo = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='emitBo']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalEmitBo(f)) .SingleOrDefault(); EmitRepository = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='emitRepository']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalEmitRepository(f, Name)) .SingleOrDefault(); GenerateInterface = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetIncludedNamespaces</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"/n"</span></span>, Include.Select(i =&gt; <span class="hljs-string"><span class="hljs-string">"using "</span></span> + i + <span class="hljs-string"><span class="hljs-string">";"</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBoClassDefinition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Name + <span class="hljs-string"><span class="hljs-string">" :\n\t\tBaseEntity,\n\t\t"</span></span> + (LogicallyDeletable ? <span class="hljs-string"><span class="hljs-string">"ILogicallyDeletable,\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + (Implements.Any() ? <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span>, Implements) + <span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"I"</span></span> + Name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCachedClassDefinition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Cached"</span></span> + Name + <span class="hljs-string"><span class="hljs-string">" :\n\t\t"</span></span> + (LogicallyDeletable ? <span class="hljs-string"><span class="hljs-string">"Deletable"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"CachedEntity&lt;"</span></span> + BasedOn + <span class="hljs-string"><span class="hljs-string">"&gt;,\n\t\t"</span></span> + (Implements.Any() ? <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span>, Implements) + <span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"I"</span></span> + Name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetIsDeletedParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LogicallyDeletable) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">",bool getDeleted"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Empty; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetIsDeletedFilter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LogicallyDeletable) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">@" if (!getDeleted) entities = entities.Where(e =&gt; !e.IsDeleted); "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Empty; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFilterParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DalGetBy getBy</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;FieldDescription&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filter <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> getBy.Filters) filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldDescription { TypeName = Fields.Single(f =&gt; f.Name == filter.Key).FieldType, Alias = filter.Value }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">", "</span></span>, filters.Select(f =&gt; f.TypeName + <span class="hljs-string"><span class="hljs-string">" "</span></span> + f.Alias)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> FieldDescription { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TypeName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Alias; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalField</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FieldType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Source { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PropertySource { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> NotNull { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type</span></span></span><span class="hljs-function">)</span></span> { Name = name; FieldType = type; Source = name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Name = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); FieldType = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"type"</span></span>); Source = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"source"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"source"</span></span>) : sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); PropertySource = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"propertySource"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"propertySource"</span></span>) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NotNull = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"notNull"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"notNull"</span></span>) == <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConstructorInitValueExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldRealType = FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PropertySource!=<span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; fieldRealType.StartsWith(<span class="hljs-string"><span class="hljs-string">"I"</span></span>)) fieldRealType = <span class="hljs-string"><span class="hljs-string">"Cached"</span></span> + fieldRealType.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" = source."</span></span> + Source + (fieldIsArray ? <span class="hljs-string"><span class="hljs-string">".Select(i=&gt;new "</span></span> + fieldRealType + <span class="hljs-string"><span class="hljs-string">"(i)).ToArray()"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">";"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"public "</span></span> + GetType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + (PropertySource != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span> + PropertySource + <span class="hljs-string"><span class="hljs-string">";"</span></span> : <span class="hljs-string"><span class="hljs-string">" { get; private set; }"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBOPropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"public virtual "</span></span> + GetBoType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" { get; set; }"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInterfacePropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetNullAttribute() + GetType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" { get; }"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldIsArray) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"IEnumerable&lt;"</span></span> + FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FieldType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBoType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldIsArray) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"IList&lt;"</span></span> + FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FieldType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNullAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; TypeCanBeNull() ? NotNull ? <span class="hljs-string"><span class="hljs-string">"[NotNull] "</span></span> : <span class="hljs-string"><span class="hljs-string">"[CanBeNull] "</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] NotNullTypes = { <span class="hljs-string"><span class="hljs-string">"Guid"</span></span>, <span class="hljs-string"><span class="hljs-string">"DateTime"</span></span>, <span class="hljs-string"><span class="hljs-string">"DateTimeOffset"</span></span>, <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-string"><span class="hljs-string">"int"</span></span>, <span class="hljs-string"><span class="hljs-string">"long"</span></span>, <span class="hljs-string"><span class="hljs-string">"short"</span></span>, <span class="hljs-string"><span class="hljs-string">"ProgramType"</span></span>, <span class="hljs-string"><span class="hljs-string">"GuestSubscriptionTypes"</span></span>, <span class="hljs-string"><span class="hljs-string">"SenderType"</span></span>, <span class="hljs-string"><span class="hljs-string">"ApiClientType"</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TypeCanBeNull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; !NotNullTypes.Contains(FieldType); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpperInitial</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name[<span class="hljs-number"><span class="hljs-number">0</span></span>].ToString().ToUpperInvariant() + name.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalGetBy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsTry { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Alias { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Filters { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalGetBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { IsTry = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"try"</span></span>); Alias = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"alias"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (XmlElement filterNode <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='field']"</span></span>)) Filters.Add(filterNode.GetAttribute(<span class="hljs-string"><span class="hljs-string">"field"</span></span>), filterNode.GetAttribute(<span class="hljs-string"><span class="hljs-string">"alias"</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConditions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">" &amp;&amp; "</span></span>, Filters.Select(f =&gt; <span class="hljs-string"><span class="hljs-string">$"e.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Key}</span></span></span><span class="hljs-string"> == </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Value}</span></span></span><span class="hljs-string">"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">" &amp;&amp; "</span></span>, Filters.Select(f =&gt; <span class="hljs-string"><span class="hljs-string">$"e.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Key}</span></span></span><span class="hljs-string"> == </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Value}</span></span></span><span class="hljs-string">"</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalEmitBo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Namespace { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> EmitMapping { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> XmlElement sourceXml; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalEmitBo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Namespace = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"ns"</span></span>); EmitMapping = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"emitMapping"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sourceXml = sourceXml; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMapping</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DalField field</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> notNull = !field.TypeCanBeNull() || field.NotNull; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> overridenXml = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='column']"</span></span>).Cast&lt;XmlElement&gt;().SingleOrDefault(e =&gt; e.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) == field.Name); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = overridenXml != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OverridenProperties(overridenXml) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(field.FieldType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"string"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(notNull ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"not-null=\"true\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(props?.SqlType !=</span></span><span class="hljs-literal"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-literal">null</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"sql-type=\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> + props.SqlType+</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string">/&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\" type=\"boolean\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\" default=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{props?.DefaultValue??</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">\" sql-type=\"bit\" /&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"DateTime"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\"/&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"DateTime?"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" /&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"ProgramType"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" default=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{props?.DefaultValue??</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">\" </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(notNull ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"not-null=\"true\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string">/&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"Guid?"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" /&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">$"Not supported type </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.FieldType}</span></span></span><span class="hljs-string">. Edit DAL.tt to add mapping definition."</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OverridenProperties</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DefaultValue { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SqlType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OverridenProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { DefaultValue = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"default"</span></span>); SqlType = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"sql-type"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalEmitRepository</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Interface { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DependsOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalEmitRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> className</span></span></span><span class="hljs-function">)</span></span> { Interface = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(sourceXml.InnerText) ? <span class="hljs-string"><span class="hljs-string">"IRepository&lt;"</span></span>+className+<span class="hljs-string"><span class="hljs-string">"&gt;"</span></span> : sourceXml.InnerText; DependsOn = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"dependsOn"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRepositoryClassName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; Interface.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ç”Ÿæˆæ¨¡æ¿çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta">#@ template debug="false" hostspecific="true" language="C#" #&gt; &lt;#@ assembly name="System.Xml" #&gt; &lt;#@ assembly name="System.Core" #&gt; &lt;#@ assembly name="EnvDTE" #&gt; &lt;#@ import namespace="System.Xml" #&gt; &lt;#@ import namespace="System.Collections.Generic" #&gt; &lt;#@ import namespace="System.IO" #&gt; &lt;#@ import namespace="System.Linq" #&gt; &lt;#@ output extension="/" #&gt; &lt;# EnvDTE.DTE dte = (EnvDTE.DTE) ((IServiceProvider) this.Host) .GetService(typeof(EnvDTE.DTE)); XmlDocument doc = new XmlDocument(); doc.Load(System.IO.Path.Combine(dte.ActiveDocument.Path, "DAL.xml")); var classes = doc.SelectNodes("//*[local-name()='class']").Cast&lt;XmlElement&gt;().Select(classXml=&gt;new DalClass(classXml)).ToArray(); //fields foreach(var classNode in classes) { #&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using System.Collections.Generic; using System.Linq; using System.Runtime.Serialization; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace Domain.DALV2 { public class &lt;#=classNode.GetCachedClassDefinition()#&gt; { public Cached&lt;#=classNode.Name#&gt;(&lt;#=classNode.DalBOType#&gt; source) : base(source) { &lt;#=string.Join("\n\t\t\t", classNode.Fields.Where(f =&gt; f.PropertySource == null).Select(f=&gt;f.GetConstructorInitValueExpression()))#&gt; } &lt;#=string.Join("\n\n\t\t", classNode.Fields.Select(f=&gt;f.GetPropertyDefinitionExpression()))#&gt; } } &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.GenerateInterface){#&gt; namespace Domain.DAL { public interface I&lt;#=classNode.Name#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; :ILogicallyDeletableReadonly &lt;#}#&gt; { Guid Id { get; } &lt;#=string.Join("\n\n\t\t", classNode.Fields.Select(f=&gt;f.GetInterfacePropertyDefinitionExpression()))#&gt; } } &lt;#SaveOutput("Entities//gen//"+classNode.Name+".g.cs");#&gt; &lt;#}#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using System.Collections.Generic; using System.Linq; using System.Runtime.Serialization; using Resto.Framework.Common; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace Domain.DALV2 { public partial class &lt;#=classNode.Name#&gt;DAL : DAL&lt;Cached&lt;#=classNode.Name#&gt;, &lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt; { internal &lt;#=classNode.Name#&gt;DAL(ISessionManager sessionManager, ICacheConsistencyManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt; consistencyManager) : base(sessionManager, Repositories.&lt;#=classNode.Name#&gt;, consistencyManager) { } &lt;#foreach (var getBy in classNode.GetBy){#&gt; &lt;#=getBy.IsTry?"[CanBeNull]":"[NotNull]"#&gt; public Cached&lt;#=classNode.Name#&gt; &lt;#=getBy.IsTry?"Try":""#&gt;GetBy&lt;#=getBy.Alias#&gt;(&lt;#=classNode.GetFilterParameters(getBy)#&gt;) { UpdateCacheIfNeeded(); using (ConsistencyManager.GetReadLock()) { return Cache.Values.Single&lt;#=getBy.IsTry?"OrDefault":""#&gt;(e =&gt; &lt;#=getBy.GetConditions()#&gt;); } } &lt;#}#&gt; &lt;#foreach (var fieldNode in classNode.GetAllBy){#&gt; [NotNull] [ItemNotNull] public IList&lt;Cached&lt;#=classNode.Name#&gt;&gt; GetAllBy&lt;#=fieldNode.Alias#&gt;(&lt;#=classNode.GetFilterParameters(fieldNode)#&gt;) { UpdateCacheIfNeeded(); using (ConsistencyManager.GetReadLock()) { return Cache.Values.Where(e =&gt; &lt;#=fieldNode.GetConditions()#&gt;).ToList(); } } &lt;#}#&gt; [NotNull] protected override Cached&lt;#=classNode.Name#&gt; Convert(&lt;#=classNode.DalBOType#&gt; source) { return new Cached&lt;#=classNode.Name#&gt;(source); } } } &lt;#SaveOutput("Repositories//gen//"+ classNode.Name+".g.cs");#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(classNode.EmitBo != null){#&gt; &lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" assembly="Domain" namespace="&lt;#=classNode.EmitBo.Namespace#&gt;"&gt; &lt;class name="&lt;#=classNode.Name#&gt;" dynamic-update="true" dynamic-insert="true"&gt; &lt;id name="Id"&gt; &lt;generator class="assigned" /&gt; &lt;/id&gt; &lt;#=string.Join("\n\t\t", classNode.ExplicitlyDefinedFields.Select(f=&gt;classNode.EmitBo.GetMapping(f)))#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; &lt;property name="IsDeleted" not-null="true" type="boolean"&gt; &lt;column name="IsDeleted" not-null="true" default="0" /&gt; &lt;/property&gt; &lt;property name="WhenDeleted" type="DateTime" not-null="false"/&gt; &lt;#}#&gt; &lt;/class&gt; &lt;/hibernate-mapping&gt; &lt;#SaveOutput("..\\..\\DAL.Hibernate\\Mapping\\gen\\"+classNode.Name+".hbm.xml");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using Common.Domain.BO.DB; using Domain.DAL; using Domain.DALV2; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace &lt;#=classNode.EmitBo.Namespace#&gt; { public partial class &lt;#=classNode.GetBoClassDefinition()#&gt; { [UsedImplicitly] protected &lt;#=classNode.Name#&gt;(){} &lt;#=string.Join("\n\n\t\t", classNode.ExplicitlyDefinedFields.Select(f=&gt;f.GetBOPropertyDefinitionExpression()))#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; public virtual bool IsDeleted { get; set; } public virtual DateTime? WhenDeleted { get; set; } &lt;#}#&gt; } } &lt;# SaveOutput("..//BO//gen//"+ classNode.Name+".g.cs"); } } #&gt; &lt;!-- The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. --&gt; &lt;objects xmlns="http://www.springframework.net" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:db="http://www.springframework.net/database" xsi:schemaLocation="http://www.springframework.net http://www.springframework.net/xsd/spring-objects.xsd"&gt; &lt;# foreach(var classNode in classes.Where(c =&gt; !c.CustomConsistencyManager)) { #&gt; &lt;object id="&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager" type="Domain.DALV2.TransactionSubscribedManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt;, Domain" singleton="true"&gt; &lt;/object&gt; &lt;#}#&gt; &lt;object id="dalGeneratedListeners" type="System.Collections.Generic.List&lt;Common.Hibernate.DAL.ISessionNotificationListener&gt;, mscorlib"&gt; &lt;constructor-arg&gt; &lt;list element-type="Common.Hibernate.DAL.ISessionNotificationListener, Common.Hibernate"&gt; &lt;# foreach(var classNode in classes) { #&gt; &lt;ref object="&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager"/&gt; &lt;#}#&gt; &lt;/list&gt; &lt;/constructor-arg&gt; &lt;/object&gt; &lt;/objects&gt; &lt;#SaveOutput("..//Config//DALSpringDefinitions.g.xml");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using Common; using Common.Domain.DAL; using Domain.BO; using Domain.DALV2; using Spring.Context.Support; using JetBrains.Annotations; &lt;#=string.Join("\n", classes.Select(c=&gt;c.GetIncludedNamespaces()).Where(s=&gt;!string.IsNullOrEmpty(s)))#&gt; namespace Domain.DAL { public partial class DALs { private static readonly SafeLazy&lt;DALs&gt; instance = new SafeLazy&lt;DALs&gt;(() =&gt; new DALs()); private DALs() { var sessionManager = (ISessionManager)ContextRegistry.GetContext().GetObject("sessionManager"); &lt;# foreach(var classNode in classes){ #&gt; this.&lt;#=LowerInitial(classNode.Name)#&gt; = new &lt;#=classNode.Name#&gt;DAL(sessionManager, (ICacheConsistencyManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt;)ContextRegistry.GetContext().GetObject("&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager")); &lt;# } #&gt; } &lt;# foreach(var classNode in classes) { #&gt; [NotNull] private readonly &lt;#=classNode.Name#&gt;DAL &lt;#=LowerInitial(classNode.Name)#&gt;; [NotNull] public static &lt;#=classNode.Name#&gt;DAL &lt;#=classNode.Name#&gt; =&gt; instance.Value.&lt;#=LowerInitial(classNode.Name)#&gt;; &lt;#}#&gt; public static void ResetAll() =&gt; instance.Value.ResetAllImpl(); private void ResetAllImpl() { &lt;#foreach(var classNode in classes){#&gt; this.&lt;#=LowerInitial(classNode.Name)#&gt;.Reset(); &lt;#}#&gt; } } } &lt;#SaveOutput("DALs.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using JetBrains.Annotations; namespace Domain.DAL { public partial interface IRepositoryFactory { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; { get; } &lt;#}#&gt; } } &lt;#SaveOutput("IRepositoryFactory.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using JetBrains.Annotations; namespace Domain.DAL { public static partial class Repositories { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] public static &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; =&gt; Instance.Value.&lt;#=classNode.Name#&gt;; &lt;#}#&gt; } } &lt;#SaveOutput("Repositories.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using Common.Domain.DAL; using Common.Hibernate.DAL; using DAL.Hibernate.Cache.CachingProviders; using Domain.BO; using Domain.DAL; using Domain.DAL.Cache; using Domain.SaveManager; using System; using System.Collections.Generic; using JetBrains.Annotations; using Engine.Main; &lt;#=string.Join("\n", classes.Select(c=&gt;c.GetIncludedNamespaces()).Where(s=&gt;!string.IsNullOrEmpty(s)))#&gt; namespace DAL.Hibernate.DAL { public partial class RepositoryFactory : IRepositoryFactory { public void Init([NotNull] IOrganizationsByNetworkCache organizationsByNetworkCache, [NotNull] INetworkCache networkCache, [NotNull] ITransactionSaveManager transactionSaveManager, [NotNull] ILoginEntryDataProvider loginEntryDataProvider, ListenerNotifier listenerNotifier) { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; this.&lt;#=classNode.Name#&gt; = new &lt;#=classNode.EmitRepository.GetRepositoryClassName()#&gt;(&lt;#=classNode.EmitRepository.DependsOn#&gt;); &lt;#}#&gt; } &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] public &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; { get; private set; } &lt;#}#&gt; } } &lt;#SaveOutput("..\\..\\DAL.Hibernate\\DAL\\RepositoryFactory.g.cs");#&gt; &lt;#+ private string LowerInitial(string name) { return name[0].ToString().ToLowerInvariant() + name.Substring(1); } private string UpperInitial(string name) { return name[0].ToString().ToUpperInvariant() + name.Substring(1); } void SaveOutput(string outputFileName) { string templateDirectory = Path.GetDirectoryName(Host.TemplateFile); string outputFilePath = Path.Combine(templateDirectory, outputFileName); File.WriteAllText(outputFilePath, this.GenerationEnvironment.ToString()); this.GenerationEnvironment.Remove(0, this.GenerationEnvironment.Length); } #&gt;</span></span></code> </pre> <br></div></div><br> åœ¨æ²¡æœ‰ä¸€å®šæ•°é‡çš„æ£˜æ‰‹é€šç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ— éœ€è®¢é˜…å³å¯æ›´æ”¹æ•°æ®åº“ï¼ŒæŒ‰éœ€æ›´æ–°ç¼“å­˜å’Œå…¶ä»–ç”Ÿæ´»ä¹è¶£ã€‚ åœ¨è¿™é‡Œï¼Œé€šç”¨è¯æ˜è¶³ä»¥å…³é—­æ‰€æœ‰ç”¨ä¾‹ï¼Œä»¥åŠå·²ç»ç”¨è¿‡çš„ç”¨ä¾‹ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">è®¿é—®æ•°æ®çš„é€šç”¨ä»£ç </b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DAL</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>, <span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">CachedEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ILog log; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ISessionManager SessionManager; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IReadonlyRepository&lt;TBase&gt; BaseRepository; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICacheConsistencyManager&lt;TBase, TCachedBo&gt; ConsistencyManager; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Dictionary&lt;Guid, T&gt; Cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Guid, T&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DAL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISessionManager sessionManager, [NotNull] IReadonlyRepository&lt;TBase&gt; baseRepository, [NotNull] ICacheConsistencyManager&lt;TBase, TCachedBo&gt; consistencyManager</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SessionManager = sessionManager; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BaseRepository = baseRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ConsistencyManager = consistencyManager; log = LogManager.GetLogger(GetType()); } [CanBeNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Guid id</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Cache.GetOrDefault(id); } } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Guid id</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ValidateEntityFound(Cache.GetOrDefault(id), <span class="hljs-string"><span class="hljs-string">"{0} with id {1} not found"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T), id); } } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TBase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISession session, Guid id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseRepository.GetById(session, id); } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TBase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISession session, [NotNull] T e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseRepository.GetById(session, e.Id); } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HashSet&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByIds</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] HashSet&lt;Guid&gt; ids</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ids .Select(id =&gt; Cache.GetOrDefault(id)) .ToHashSet(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ConsistencyManager.Reset(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Convert</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TCachedBo source</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateCacheIfNeeded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ConsistencyManager.UpdateRequired) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; log.Debug(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-string"><span class="hljs-subst">(T).Name}</span></span></span><span class="hljs-string"> DAL: Update required, getting writeLock"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateScope = ConsistencyManager.GetWriteLock()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updateScope.UpdateRequired ?? ConsistencyManager.UpdateRequired) SessionManager.RunTransacted(session =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updatedEntities = updateScope.GetUpdatedEntities(BaseRepository, session); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updatedEntity <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> updatedEntities) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updatedEntity.Value != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Cache[updatedEntity.Key] = Convert(updatedEntity.Value); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Cache.Remove(updatedEntity.Key); Reindex(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ConsistencyManager.Reset(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }); } } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Reevaluate specific indexes, used for search in cached entities. Called after cache has been updated. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> protected virtual void Reindex() { } [NotNull] protected T1 ValidateEntityFound</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T1&gt;</span></span></span><span class="hljs-comment">([CanBeNull] T1 entity, [NotNull] string errorMessage, [NotNull] string frontMessage, [NotNull] params object[] p) { if (entity == null) throw new DataAccessException(Util.GetMessage(errorMessage, p), Util.GetMessage(frontMessage, p)); return entity; } }</span></span></code> </pre> <br><br></div></div><br> åœ¨æˆ‘çœ‹æ¥ï¼Œæœ‰è¶£çš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªç›‘è§†ç¼“å­˜ä¸€è‡´æ€§å¹¶ç®¡ç†å…¶æ›´æ–°çš„ç±»ï¼Œè¿™æ˜¯æˆ‘ä¸å¾—ä¸è€ƒè™‘å®ç°é”çš„ä¸»è¦ä½ç½®ï¼Œä»¥ä¾¿ä½¿æ‰€æœ‰å†…å®¹å¤„äºæœ€ä½³çŠ¶æ€å¹¶æœ€å°é™åº¦åœ°é˜»å¡ï¼Œä½†åŒæ—¶è¦å¯¹å…¶è¿›è¡Œä¿æŠ¤ <br><br><div class="spoiler">  <b class="spoiler_title">å®é™…æ‰§è¡Œ</b> <div class="spoiler_text"><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">UsedImplicitly</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TransactionSubscribedManager</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">EmptySessionNotificationListener</span></span>, <span class="hljs-title"><span class="hljs-title">ICacheConsistencyManager</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">ITransactionNotificationListener</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> UpdateRequired =&gt; needFullUpdate || !entitiesToUpdate.IsEmpty; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim LockObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion); [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ConcurrentBag&lt;Guid&gt;&gt; changesByTransaction = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ConcurrentBag&lt;Guid&gt;&gt;(); [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ConcurrentBag&lt;Guid&gt; entitiesToUpdate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> needFullUpdate = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> CacheWriteLockScope&lt;TBase, TCachedBo&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWriteLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { LockObj.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needFullUpdate) { needFullUpdate = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CacheWriteLockScope&lt;TBase, TCachedBo&gt;(LockObj); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdBasedCacheWriteLockScope&lt;TBase, TCachedBo&gt;(LockObj, ChangedEntitiesIdsProvider); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { LockObj.ExitWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ICollection&lt;Guid&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangedEntitiesIdsProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ids = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newBag = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldBag = Interlocked.Exchange(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> entitiesToUpdate, newBag); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (oldBag.TryTake(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id)) ids.Add(id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ids; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheReadLockScope </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetReadLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CacheReadLockScope(LockObj); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSaveOrUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ISession session, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> entity, Guid id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] currentState, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] previousState, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] propertyNames, IType[] types</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TBase) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionName = HibernateSessionManager.GetTransactionName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(transactionName)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changesByTransaction.TryAdd(transactionName, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;() { id })) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; changesByTransaction.TryGetValue(transactionName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionChangedEntities); <span class="hljs-comment"><span class="hljs-comment">// ReSharper disable once PossibleNullReferenceException // R# does not have attributes telling that value in dictionary is not null. But we know it. transactionChangedEntities.Add(id); } } } public override void OnDelete(ISession session, object entity, Guid id) { if (entity is TBase) { var transactionName = HibernateSessionManager.GetTransactionName(); if (string.IsNullOrEmpty(transactionName)) return; if (changesByTransaction.TryAdd(transactionName, new ConcurrentBag&lt;Guid&gt;() { id })) return; changesByTransaction.TryGetValue(transactionName, out var transactionChangedEntities); // ReSharper disable once PossibleNullReferenceException // R# does not have attributes telling that value in dictionary is not null. But we know it. transactionChangedEntities.Add(id); } } public void Reset() { needFullUpdate = true; } void ITransactionNotificationListener.AfterCommit(ISession session, string transactionName) { if (changesByTransaction.TryRemove(transactionName, out var transactionChangedEntities) &amp;&amp; !transactionChangedEntities.IsEmpty) while (transactionChangedEntities.TryTake(out var id)) entitiesToUpdate.Add(id); } void ITransactionNotificationListener.AfterRollback(ISession session, string transactionName) { changesByTransaction.TryRemove(transactionName, out _); } }</span></span></code> </pre> <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">IdBasedCacheWriteLockScope</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">CacheWriteLockScope</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICollection&lt;Guid&gt; changedEntitiesIds; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>? UpdateRequired =&gt; changedEntitiesIds.Any(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IdBasedCacheWriteLockScope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ReaderWriterLockSlim lockObj, [NotNull] Func&lt;ICollection&lt;Guid&gt;&gt; changedEntitiesIdsProvider</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lockObj</span></span></span><span class="hljs-function">)</span></span> { changedEntitiesIds = changedEntitiesIdsProvider() ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(changedEntitiesIdsProvider)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IDictionary&lt;Guid, TCachedBo&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUpdatedEntities</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReadonlyRepository&lt;TBase&gt; repository, ISession session</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entities = repository.GetByIds(session, changedEntitiesIds, <span class="hljs-literal"><span class="hljs-literal">true</span></span>).ToDictionary(e =&gt; e.Id, be =&gt; be <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCachedBo); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> changedEntitiesIds.Where(i =&gt; !entities.ContainsKey(i))) entities.Add(id, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entities; } }</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åœ¨æˆ˜æ–—çš„å‘å±•å’Œæ‰©å±•è¿‡ç¨‹ä¸­å‘ç°äº†æœ‰è¶£çš„é—¨æ¡†ï¼š </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åªæ˜¯æ‚¨æ— æ³•ä½¿ç”¨å®ƒä»¬ä¹‹é—´çš„ç›´æ¥é“¾æ¥æ¥æå–å’Œç¼“å­˜ç›¸å…³å®ä½“ã€‚</font><font style="vertical-align: inherit;">å¦åˆ™ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹å®ä½“ä¹‹ä¸€æ—¶ï¼Œè¿‡æ—¶çš„å‰¯æœ¬å°†ä¿ç•™åœ¨å¼•ç”¨è¯¥å®ä½“çš„å¯¹è±¡ä¸­ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬æ²¡æœ‰åšå‡ºä½¿è¿™äº›è¿æ¥æ— æ•ˆçš„æ£˜æ‰‹é€»è¾‘ï¼Œè€Œæ˜¯ç®€å•åœ°å†³å®šäº†æŒ‰å±æ€§è®¿é—®æ—¶æ€»æ˜¯ä»ç¼“å­˜ä¸­è·å–æœ€æ–°ä¿¡æ¯ã€‚</font></font></li><li>   ,              ,         (       ,   ,            , ).     ,              </li><li>     Â«Â»   (         )   ,         ,          </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN453382/">https://habr.com/ru/post/zh-CN453382/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN453368/index.html">ä½¿ç”¨ibdæ–‡ä»¶çš„å­—èŠ‚åˆ†æä»ä¸å…·æœ‰ç»“æ„æ–‡ä»¶çš„XtraDBè¡¨ä¸­æ¢å¤æ•°æ®</a></li>
<li><a href="../zh-CN453370/index.html">å¯¹æŠ—2019å¹´ï¼šå–·æ°”æœºå®‰å…¨å›¢é˜Ÿåœ¨å›½é˜²éƒ¨è·å¾—ç¬¬ä¸€å</a></li>
<li><a href="../zh-CN453374/index.html">ä¼ä¸šä¸šåŠ¡çš„åå¤§èŠå¤©ï¼ŒéŸ³é¢‘å’Œè§†é¢‘å‘¼å«APIå’ŒSDKæä¾›ç¨‹åº</a></li>
<li><a href="../zh-CN453376/index.html">å¦‚ä½•ç™½ç™½æµªè´¹æ—¶é—´å’ŒSSDèµ„æºï¼Ÿ ç®€å•å®¹æ˜“</a></li>
<li><a href="../zh-CN453380/index.html">ç§å®¶è½¦ä¸–ç•Œå¤§æˆ˜ï¼šMaaSå¼•é¢†åœ°çƒ</a></li>
<li><a href="../zh-CN453384/index.html">å®‰å…¨å©´å„¿åºŠï¼šREST</a></li>
<li><a href="../zh-CN453388/index.html">å¦‚ä½•åœ¨ä¸€å¤©å†…è·å¾—OFFZONE 2019å’ŒæŠ¥ä»·</a></li>
<li><a href="../zh-CN453390/index.html">å…³äºæ–§å¤´å’Œç™½èœ</a></li>
<li><a href="../zh-CN453392/index.html">æœ¬å‘¨æ–°é—»ï¼šç¾å›½ä¸åä¸ºçš„æˆ˜äº‰ï¼Œå‘å«æ˜Ÿå‘å°„äº’è”ç½‘å«æ˜Ÿï¼Œä¿„ç½—æ–¯ç”µåŠ¨æ±½è½¦</a></li>
<li><a href="../zh-CN453394/index.html">æ˜Ÿå›¾æˆ–å¦‚ä½•åœ¨è½¯æŠ€èƒ½çš„å½±å“ä¸‹å¹³è¡¡å›¢é˜Ÿä¸­çš„çŸ¥è¯†</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>