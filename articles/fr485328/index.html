<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ôüèª üßÄ üçÄ Sp√©cifications sur les st√©ro√Ødes üë©üèª‚Äçüè´ ü§öüèΩ ü§∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le th√®me des abstractions et de toutes sortes de beaux motifs est un bon terrain pour le d√©veloppement d'holivars et de conflits √©ternels: d'une part,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sp√©cifications sur les st√©ro√Ødes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/singularis/blog/485328/">  Le th√®me des abstractions et de toutes sortes de beaux motifs est un bon terrain pour le d√©veloppement d'holivars et de conflits √©ternels: d'une part, nous suivons le courant dominant, toutes sortes de mots √† la mode et un code propre, d'autre part, nous avons une pratique et une r√©alit√© qui dictent toujours leurs propres r√®gles. <br><br>  Que faire si les abstractions commencent √† ¬´fuir¬ª, comment utiliser les puces de langue et ce que vous pouvez retirer du mod√®le de ¬´sp√©cification¬ª - voir sous la coupe. <br><a name="habracut"></a><br>  Alors, passons aux choses s√©rieuses.  L'article contiendra les sections suivantes: pour commencer, nous examinerons ce qu'est le mod√®le de ¬´sp√©cification¬ª et pourquoi son application √† des √©chantillons de la base de donn√©es dans sa forme pure pose des probl√®mes. <br><br>  Ensuite, nous nous tournons vers les arbres d'expression, qui sont un outil tr√®s puissant, et voyons comment ils peuvent nous aider. <br><br>  Enfin, je vais d√©montrer ma mise en ≈ìuvre de la ¬´sp√©cification¬ª sur les st√©ro√Ødes. <br><br>  Commen√ßons par les choses de base.  Je pense que tout le monde a entendu parler du mod√®le de ¬´sp√©cification¬ª, mais pour ceux qui ne l'ont pas entendu, voici sa d√©finition de <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B5%25D1%2586%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Wikipedia</a> : <br><br><blockquote>  Une ¬´sp√©cification¬ª en programmation est un mod√®le de conception par lequel la repr√©sentation des r√®gles de logique m√©tier peut √™tre transform√©e en une cha√Æne d'objets connect√©s par des op√©rations de logique bool√©enne. <br><br>  Ce mod√®le met en √©vidence de telles sp√©cifications (r√®gles) dans la logique m√©tier qui peuvent √™tre ¬´coupl√©es¬ª avec d'autres.  Un objet de logique m√©tier h√©rite ses fonctionnalit√©s de la classe d'agr√©gat abstraite CompositeSpecification, qui contient une seule m√©thode IsSatisfiedBy qui renvoie une valeur bool√©enne.  Apr√®s l'instanciation, l'objet est encha√Æn√© avec d'autres objets.  Par cons√©quent, sans perdre la flexibilit√© de configurer la logique m√©tier, nous pouvons facilement ajouter de nouvelles r√®gles. </blockquote><br>  En d'autres termes, une sp√©cification est un objet qui impl√©mente l'interface suivante (suppression des m√©thodes de construction de cha√Ænes): <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> candidate</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br>  Ici, tout est simple et clair.  Mais maintenant, regardons un exemple du monde r√©el dans lequel, en plus du domaine, il y a une infrastructure qui est aussi une personne impitoyable: tournons-nous vers le cas de l'utilisation d'ORM, un SGBD et des sp√©cifications pour filtrer les donn√©es dans une base de donn√©es. <br><br>  Afin de ne pas √™tre infond√© et de ne pas pointer du doigt, nous prenons comme exemple le sujet suivant: supposons que nous d√©veloppons des MMORPG, nous avons des utilisateurs, chaque utilisateur a 1 ou plusieurs caract√®res, et chaque personnage a un ensemble d'√©l√©ments ( nous faisons l'hypoth√®se que les √©l√©ments sont uniques √† chaque utilisateur), et pour chacun des √©l√©ments, √† leur tour, des runes d'am√©lioration peuvent √™tre appliqu√©es.  Au total, sous forme de diagramme (nous consid√©rerons la classe ReadCharacter un peu plus tard lorsque nous parlerons de requ√™tes imbriqu√©es): <br><br><img src="https://habrastorage.org/webt/k5/bx/iw/k5bxiwkvgl5vghoog71-9w6vqdo.png" alt="image"><br><br>  Ce mod√®le est vaguement connect√© au monde r√©el, et il contient √©galement des champs qui refl√®tent une certaine connexion avec l'ORM utilis√©, mais cela nous suffira pour d√©montrer le travail. <br><br>  Supposons que nous voulons filtrer tous les caract√®res cr√©√©s apr√®s la date sp√©cifi√©e. <br>  Pour ce faire, nous √©crivons une sp√©cification du formulaire suivant: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedAfter</span></span>: <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DateTime _target; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { _target = target; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> candidate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> character = candidate <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Character; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(character == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> character.CreatedAt &gt; target; } }</code> </pre><br>  Eh bien, pour appliquer cette sp√©cification, nous faisons ce qui suit (ci-apr√®s, je consid√©rerai le code bas√© sur NHibernate): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> characters = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> session.Query&lt;Character&gt;().ToListAsync(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newCharacters = characters.Where(x =&gt; filter.IsSatisfiedBy(x)).ToArray();</code> </pre><br>  Tant que notre base est petite, tout fonctionnera magnifiquement et rapidement, mais si notre jeu devient plus ou moins populaire et gagne quelques dizaines de milliers d'utilisateurs, tout ce charme consommera de la m√©moire, du temps et de l'argent, et il vaut mieux tirer sur cette b√™te tout de suite parce que  il n'est pas locataire.  Sur cette triste note, nous allons reporter la sp√©cification et nous tournerons un peu vers ma pratique. <br><br>  Il √©tait une fois, dans un projet tr√®s, tr√®s √©loign√©, j'avais des classes dans mon code qui contenaient une logique pour r√©cup√©rer des donn√©es de la base de donn√©es.  Ils ressemblaient √† ceci: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ICharacterDal</span></span> { <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime date</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedBefore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime date</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedBetween</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, DateTime to</span></span></span><span class="hljs-function">)</span></span>; ... }</code> </pre><br>  et leur utilisation: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CharacterDal(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createdCharacters = dal.GetCharactersCreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre><br>  √Ä l'int√©rieur des classes se trouvait la logique de travail avec le SGBD (√† l'√©poque c'√©tait ADO.NET). <br><br>  Tout semblait bien, mais avec l'expansion du projet, ces classes se sont √©galement d√©velopp√©es, devenues des objets difficiles √† entretenir.  De plus, il y avait un arri√®re-go√ªt d√©sagr√©able - cela semble √™tre une r√®gle commerciale, mais ils √©taient stock√©s au niveau de l'infrastructure, car ils √©taient li√©s √† une impl√©mentation sp√©cifique. <br><br>  Cette approche a √©t√© remplac√©e par le r√©f√©rentiel <i>IQueryable &lt;T&gt;</i> , qui a permis de prendre toutes les r√®gles directement dans la couche domaine. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IQueryable&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">List</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T obj</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T obj</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  qui a √©t√© utilis√© quelque chose comme √ßa: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Repository(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createdUsers = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> repository.List().Where(x =&gt; x.CreatedAd &gt; targetDate).ToListAsync();</code> </pre><br>  Un peu plus agr√©able, mais le probl√®me est que les r√®gles se glissent le long du code, et la m√™me v√©rification peut se produire dans des centaines d'endroits, et il est facile d'imaginer ce que cela peut entra√Æner en modifiant les exigences. <br><br>  Cette approche cache un autre probl√®me - si vous ne mat√©rialisez pas la requ√™te, c'est-√†-dire une chance de r√©pondre √† plusieurs requ√™tes dans la base de donn√©es au lieu d'une, ce qui, bien s√ªr, affecte n√©gativement les performances du syst√®me. <br><br>  Et ici, sur l'un des projets, un coll√®gue a sugg√©r√© d'utiliser une <a href="https://github.com/rjperes/DevelopmentWithADot.NHibernateSpecifications">biblioth√®que</a> qui a sugg√©r√© la mise en ≈ìuvre du mod√®le de ¬´sp√©cification¬ª bas√© sur des arbres d'expression. <br><br>  Bref, sur la base de cette biblioth√®que, nous avons film√© des sp√©cifications qui nous ont permis de cr√©er des filtres pour les entit√©s et de construire des filtres plus complexes bas√©s sur des concat√©nations de r√®gles simples.  Par exemple, nous avons une sp√©cification pour les personnages cr√©√©s apr√®s la nouvelle ann√©e et il y a une sp√©cification pour choisir les personnages avec un certain √©l√©ment - puis en combinant ces r√®gles, nous pouvons construire une demande pour une liste de personnages cr√©√©s apr√®s la nouvelle ann√©e et ayant l'√©l√©ment sp√©cifi√©.  Et si √† l'avenir nous changerons la r√®gle pour d√©terminer de nouveaux caract√®res (par exemple, nous utiliserons la date du nouvel an chinois), nous la corrigerons uniquement dans la sp√©cification elle-m√™me et il n'est pas n√©cessaire de rechercher toutes les utilisations de cette logique par code! <br><br>  Ce projet a √©t√© men√© √† bien et l'exp√©rience de l'utilisation de cette approche a √©t√© tr√®s r√©ussie.  Mais je ne voulais pas rester immobile, et il y avait quelques probl√®mes dans la mise en ≈ìuvre, √† savoir: <br><br><ul><li>  l'op√©rateur de collage OR n'a pas fonctionn√©; </li><li>  l'union ne fonctionne que pour les requ√™tes qui contiennent des filtres de type Where, mais je voulais des r√®gles plus riches (requ√™tes imbriqu√©es, sauter / prendre, obtenir des projections); <br></li><li>  le code de sp√©cification d√©pendait de l'ORM s√©lectionn√©; </li><li>  il n‚Äôa pas √©t√© possible d‚Äôutiliser les fonctions ORM,  cela a conduit √† l'inclusion de d√©pendances sur celui-ci dans la couche logique m√©tier (par exemple, il √©tait impossible de faire une extraction). <br></li></ul><br>  Le r√©sultat de la r√©solution de ces probl√®mes a √©t√© le mini-framework <i>Singularis.Secification</i> , qui se compose de plusieurs assemblages: <br><br><ul><li>  Singularis.Specification.Definition - d√©finit l'objet de sp√©cification et contient √©galement l'interface IQuery avec laquelle la r√®gle est form√©e. </li><li>  Singularis.Specification.Executor. * - impl√©mente un r√©f√©rentiel et un objet pour ex√©cuter des sp√©cifications pour des ORM sp√©cifiques (actuellement pris en charge par ef.core et NHibernate, dans le cadre des exp√©riences, j'ai √©galement fait une impl√©mentation pour mongodb, mais ce code n'est pas entr√© en production). </li></ul><br>  Examinons de plus pr√®s la mise en ≈ìuvre. <br><br>  L'interface de sp√©cification d√©finit la propri√©t√© publique que contient la r√®gle de sp√©cification: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { IQuery Query { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } Type ResultType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpefication</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;: <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { }</code> </pre><br>  De plus, l'interface contient la propri√©t√© <i>ResultType</i> , qui renvoie le type d'entit√© obtenu √† la suite de la requ√™te. <br><br>  Son impl√©mentation est contenue dans la classe <i>Specification &lt;T&gt;</i> , qui impl√©mente la propri√©t√© <i>ResultType</i> , la calculant en fonction de la r√®gle stock√©e dans Query, ainsi que de deux m√©thodes: <i>Source ()</i> et <i>Source &lt;TSource&gt; ()</i> .  Ces m√©thodes servent √† former la source de la r√®gle.  <i>Source ()</i> cr√©e une r√®gle avec un type qui correspond √† l'argument de la classe de sp√©cifications, et <i>Source &lt;TSource&gt; ()</i> vous permet de cr√©er une r√®gle pour une classe arbitraire (utilis√©e lors de la g√©n√©ration de requ√™tes imbriqu√©es). <br><br>  En outre, il existe √©galement la classe <i>SpecificationExtension</i> , qui contient des m√©thodes d'extension pour cha√Æner les demandes. <br><br>  Deux types de jonction sont pris en charge: la concat√©nation (peut √™tre consid√©r√©e comme la jonction par la condition ¬´ET¬ª) et la jonction par la condition ¬´OU¬ª. <br><br>  Revenons √† notre exemple et impl√©mentons nos deux r√®gles: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedAfter</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Character</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { Query = Source().Where(x =&gt; x.CreatedAt &gt; target); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedBefore</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Character</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedBefore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { Query = Source().Where(x =&gt; x.CreatedAt &lt; target); } }</code> </pre><br>  et trouvez tous les utilisateurs qui satisfont aux deux r√®gles: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> specification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2019</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).Combine(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedBefore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = repository.List(specification);</code> </pre><br>  La combinaison avec la m√©thode <i>Combine</i> prend en charge des r√®gles arbitraires.  L'essentiel est que le type r√©sultant du c√¥t√© gauche co√Øncide avec le type d'entr√©e du c√¥t√© droit.  Ainsi, vous pouvez cr√©er des r√®gles contenant des projections, ignorer / prendre pour la pagination, les r√®gles de tri, r√©cup√©rer, etc. <br><br>  La r√®gle Ou est plus restrictive - elle ne prend en charge que les cha√Ænes contenant des conditions de filtrage Where.  Prenons l'exemple: on retrouve tous les personnages cr√©√©s avant 2000 ou apr√®s 2020: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> specification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).Or(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedBefore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = repository.List(specification );</code> </pre><br>  L'interface <i>IQuery</i> r√©p√®te largement l'interface <i>IQueryable</i> , donc il ne devrait pas y avoir de questions sp√©ciales.  Arr√™tons-nous uniquement sur des m√©thodes sp√©cifiques: <br><br>  <i>Fetch / ThenFetch</i> - vous permet d'inclure des donn√©es connexes dans la requ√™te g√©n√©r√©e √† des fins d'optimisation.  Bien s√ªr, c'est un peu tordu lorsque nous avons des caract√©ristiques de la mise en ≈ìuvre de l'infrastructure qui affectent les r√®gles commerciales, mais, comme je l'ai dit, la r√©alit√© est des abstractions dures et pures - c'est une chose plut√¥t th√©orique. <br><br>  <i>O√π</i> - <i>IQuery</i> d√©clare deux surcharges de cette m√©thode, l'une prend juste une expression lambda pour le filtrage sous la forme <i>Expression &lt;Func &lt;T, bool &gt;&gt;</i> , et la seconde prend √©galement des param√®tres suppl√©mentaires <i>IQueryContext</i> , qui vous permet d'ex√©cuter des sous-requ√™tes imbriqu√©es.  Regardons un exemple. <br><br>  Nous avons la classe ReadCharacter dans le mod√®le - supposons que notre mod√®le est pr√©sent√© comme une partie en lecture qui contient des donn√©es d√©normalis√©es et sert √† un retour rapide, et une partie en √©criture qui contient des liens, des donn√©es normalis√©es, etc.  Nous voulons afficher tous les caract√®res pour lesquels l'utilisateur a du courrier sur un domaine sp√©cifique. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CharactersForUserWithEmailDomain</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ReadCharacter</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CharactersForUserWithEmailDomain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> domain</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> usersQuery = Source&lt;User&gt;(x =&gt; x.Email.Contains(domain)).Projection(x =&gt; x.Id); Query = Source().Where((x, ctx) =&gt; ctx.GetQueryResult&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(usersQuery).Contains(x.Id)); } }</code> </pre><br>  √Ä la suite de l'ex√©cution, la requ√™te SQL suivante sera g√©n√©r√©e: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> readcharac0_.id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> id1_3_, readcharac0_.UserId <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> userid2_3_, readcharac0_.Name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> name3_3_ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ReadCharacters readcharac0_ <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> readcharac0_.UserId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> user1_.Id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Users</span></span> user1_ <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> user1_.Email <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> (<span class="hljs-string"><span class="hljs-string">'%'</span></span>+@p0+<span class="hljs-string"><span class="hljs-string">'%'</span></span>) ); @p0 = '@inmagna.ca' [Type: String (4000:0:0)]</code> </pre><br>  Pour remplir toutes ces merveilleuses r√®gles, l'interface <i>IRepository</i> est <i>d√©finie</i> , ce qui vous permet de recevoir des √©l√©ments par identifiant, de recevoir un (le premier appropri√©) ou une liste d'objets selon la sp√©cification, ainsi que d'enregistrer et de supprimer des √©l√©ments du r√©f√©rentiel. <br>  Avec la d√©finition des requ√™tes, nous avons compris, maintenant il reste √† apprendre √† notre ORM √† comprendre cela. <br>  Pour ce faire, nous analyserons l'assemblage de <i>Singularis.Infrastructure.NHibernate</i> (pour ef.core tout se ressemble, uniquement avec les sp√©cificit√©s d'ef.core). <br><br>  Le point d'acc√®s aux donn√©es est l'objet Repository, qui impl√©mente l'interface <i>IRepository</i> .  En cas de r√©ception d'un objet par identifiant, ainsi que de modification du stockage (sauvegarde / suppression), cette classe termine une session et masque une impl√©mentation sp√©cifique de la couche m√©tier.  Dans le cas de l'utilisation de sp√©cifications, il forme un objet <i>IQueryable</i> qui refl√®te notre requ√™te en termes d' <i>IQuery</i> , puis l'ex√©cute sur l'objet session. <br><br>  La magie principale et le code le plus laid se trouvent dans la classe responsable de la conversion d' <i>IQuery</i> en <i>IQueryable</i> - SpecificationExecutor.  Cette classe contient beaucoup de r√©flexion, qui appelle des m√©thodes Queryable ou des m√©thodes d'extension d'un ORM sp√©cifique (EagerFetchingExtensionsMethods pour NHiberante). <br><br>  Cette biblioth√®que est activement utilis√©e dans nos projets (pour √™tre honn√™te, une biblioth√®que d√©j√† mise √† jour est utilis√©e pour nos projets, mais progressivement tous ces changements seront pr√©sent√©s dans le domaine public) est en constante √©volution.  Il y a quelques semaines √† peine, la prochaine version est sortie, qui est pass√©e aux m√©thodes asynchrones, des bogues ont √©t√© corrig√©s dans executor'e pour ef.core, des tests et des √©chantillons ont √©t√© ajout√©s.  Il est probable que la biblioth√®que contienne des erreurs et une centaine de points d'optimisation - elle est n√©e en tant que projet parall√®le dans le cadre des travaux sur les principaux projets, donc je serai heureux de sugg√©rer des suggestions d'am√©lioration.  De plus, vous ne devez pas vous pr√©cipiter pour l'utiliser - il est probable que dans votre cas particulier, cela sera inutile ou inapplicable. <br><br>  Quand vaut-il la peine d'utiliser la solution d√©crite?  Il est probablement plus facile de partir de la question ¬´quand ne devrait pas¬ª: <br><br><ul><li>  highload - si vous avez besoin de hautes performances, l'utilisation de l'ORM lui-m√™me soul√®ve une question.  Bien s√ªr, personne n'interdit d'impl√©menter un ex√©cuteur qui traduira les requ√™tes en SQL et les ex√©cutera ... </li><li>  de tr√®s petits projets - c'est tr√®s subjectif, mais, vous devez l'admettre, tirer l'ORM et tout le zoo qui l'accompagne dans le projet "todo list" ressemble √† tirer des moineaux √† partir d'un canon. </li></ul><br>  En tout cas, qui a ma√Ætris√© la lecture jusqu'√† la fin - merci pour votre temps.  J'esp√®re avoir des commentaires pour un d√©veloppement futur! <br><br>  J'ai presque oubli√© - le code du projet est disponible sur GitHub'e - <a href="https://github.com/SingularisLab/singularis.specification">https://github.com/SingularisLab/singularis.specification</a> <br><br><div class="spoiler">  <b class="spoiler_title">Les assemblages sont disponibles pour t√©l√©chargement via nuget</b> <div class="spoiler_text"><ul><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Definition/">https://www.nuget.org/packages/Singularis.Specification.Definition/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.EntityFramework/">https://www.nuget.org/packages/Singularis.Specification.Executor.EntityFramework/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.Common/">https://www.nuget.org/packages/Singularis.Specification.Executor.Common/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.Nhibernate/">https://www.nuget.org/packages/Singularis.Specification.Executor.Nhibernate/</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485328/">https://habr.com/ru/post/fr485328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485316/index.html">Tous les SERP Google ressemblent d√©sormais √† des publicit√©s</a></li>
<li><a href="../fr485318/index.html">Ajout de beaut√© et d'interactivit√© aux ordinateurs portables Jupyter</a></li>
<li><a href="../fr485322/index.html">Parlez de PostgreSQL. Entretien avec Alexei Lesovsky dans le podcast Zinc Prod. Premi√®re partie</a></li>
<li><a href="../fr485324/index.html">Multithreading dans les widgets Qt</a></li>
<li><a href="../fr485326/index.html">Cr√©ation de micro frontends √† l'aide d'√©l√©ments angulaires: guide du d√©butant</a></li>
<li><a href="../fr485330/index.html">Comment battre au hasard sans √¢me dans les jeux roguelike</a></li>
<li><a href="../fr485334/index.html">Sondage de session</a></li>
<li><a href="../fr485336/index.html">L'ITMO University: conf√©rences, ateliers, concours et divertissements</a></li>
<li><a href="../fr485338/index.html">Comment surmonter la peur et commencer √† utiliser Azure Machine Learning</a></li>
<li><a href="../fr485342/index.html">Comment s'est pass√© 2019 dans le domaine des math√©matiques et de l'informatique?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>