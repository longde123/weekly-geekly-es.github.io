<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíô üåΩ ü§¶üèæ Docker para Symfony 4: de LAN a producci√≥n üéè ü§£ üëë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistoria 
 Un buen d√≠a necesitaba implementar un entorno de desarrollo para mi proyecto. Vagrant ya estaba harto y quer√≠a tener un entorno de desar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Docker para Symfony 4: de LAN a producci√≥n</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420673/"><h2>  Prehistoria </h2><br>  Un buen d√≠a necesitaba implementar un entorno de desarrollo para mi proyecto.  Vagrant ya estaba harto y quer√≠a tener un entorno de desarrollo √∫nico para todos los participantes del proyecto que fuera id√©ntico al servidor de producci√≥n.  En consecuencia, despu√©s de escuchar informaci√≥n sobre el acoplador inconformista, decid√≠ comenzar a lidiar con √©l.  A continuaci√≥n, intentar√© describir con el mayor detalle posible todos los pasos desde la instalaci√≥n de una ventana acoplable en una LAN hasta la implementaci√≥n de un producto en KVM. <br><br>  <b>Pila de tecnolog√≠a original:</b> <br><br>  docker <br>  - Symfony 4 <br>  - nginx <br>  - php-fpm <br>  - postgresql <br>  - b√∫squeda el√°stica <br>  - rabbitmq <br>  - jenkins <br><br>  <b>Hierro:</b> <br><br>  - computadora port√°til con sistema operativo Ubuntu 16.04 <br>  - servidor de producci√≥n en alojamiento KVM <br><br>  <i>¬øPor qu√©, adem√°s de la pila tecnol√≥gica, tambi√©n enumer√© la pila de hierro?</i> <br><br>  Si nunca antes ha trabajado con una ventana acoplable, puede encontrar una serie de problemas relacionados espec√≠ficamente con el hardware, el sistema operativo de su computadora port√°til o el tipo de virtualizaci√≥n de alojamiento. <br><br>  El primer y probablemente el aspecto m√°s importante al comenzar a trabajar con la ventana acoplable es el sistema operativo de su computadora port√°til.  La forma m√°s f√°cil de trabajar con Docker es en sistemas Linux.  Si trabaja en Windows o Mac, tendr√° un 100% de dificultades, pero estas dificultades no ser√°n cr√≠ticas y si desea "googlear" c√≥mo se soluciona esto, no habr√° problemas. <br><br>  La segunda pregunta es el alojamiento.  ¬øPor qu√© se necesita Hosting con el tipo de virtualizaci√≥n KVM?  La raz√≥n es que la virtualizaci√≥n de VPS es muy diferente de KVM y simplemente no podr√° instalar docker en VPS, ya que VPS asigna din√°micamente los recursos del servidor. <br><br>  Subtotal: para el inicio m√°s r√°pido en la ventana acoplable, es m√°s razonable elegir Ubuntu como SO local y alojamiento KVM (o su propio servidor).  Adem√°s, la historia depender√° precisamente de estos dos componentes. <br><a name="habracut"></a><br><h2>  Docker-compose para LAN </h2><br><h3>  Instalaci√≥n </h3><br>  Primero debe instalar la ventana acoplable localmente.  Puede ver las instrucciones de instalaci√≥n en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace del</a> sitio web oficial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">a la documentaci√≥n oficial de ubuntu</a> (necesita instalar docker y docker-compose), o ejecutando el comando en la consola: <br><br><pre><code class="bash hljs">curl -sSl https://get.docker.com/ | sh</code> </pre> <br>  Este comando instalar√° docker y docker-compose.  Despu√©s de eso, verifique la versi√≥n de Docker con el comando: <br><br><pre> <code class="bash hljs">docker --version</code> </pre> <br>  Estoy comenzando todo esto en la versi√≥n Docker 18.06.0-ce. <br><br>  ¬°La instalaci√≥n est√° completa! <br><br><h3>  Conciencia </h3><br>  Para trabajar con algo con menos √©xito, debe tener una idea de c√≥mo funciona.  Si anteriormente trabaj√≥ solo con Vagrant o algo similar, entonces ser√° extremadamente inusual e incomprensible al principio, pero esto es solo al principio. <br><br>  Intentar√© dibujar una analog√≠a para Vagrant.  Ahora muchos pueden decir que comparar Vagrant y Docker es fundamentalmente incorrecto.  S√≠, estoy de acuerdo con esto, pero no voy a compararlos, solo intentar√© transmitirles a los reci√©n llegados que trabajaron solo con el sistema de trabajo Vagrant the Docker, apelando a lo que saben los reci√©n llegados. <br><br>  Mi visi√≥n del contenedor "en los dedos" es la siguiente: cada contenedor es un peque√±o mundo aislado.  Cada contenedor se puede imaginar como si fuera un peque√±o Vagrant en el que solo est√° instalada 1 herramienta, por ejemplo nginx o php.  Inicialmente, los contenedores generalmente est√°n aislados de todo lo que hay a su alrededor, pero mediante manipulaciones dif√≠ciles, puede configurar todo para que se comuniquen entre s√≠ y trabajen juntos.  Esto no significa que cada uno de los contenedores sea una m√°quina virtual separada, en absoluto.  Pero es m√°s f√°cil para la comprensi√≥n inicial, como me parece. <br><br>  Vagrant simplemente muerde parte de los recursos de su computadora, crea una m√°quina virtual, instala un sistema operativo en ella, instala bibliotecas, instala todo lo que escribi√≥ en el script despu√©s de vagrant.  En definitiva, se parece a esto: <br><br>  ‚Üí <a href="">Ver esquema</a> <br><br>  Docker, a su vez, funciona radicalmente diferente.  No crea m√°quinas virtuales.  Docker crea contenedores (por ahora, puede pensar en ellos como m√°quinas micro virtuales) con su sistema operativo Alpine y 1-3 bibliotecas que son necesarias para que la aplicaci√≥n funcione, por ejemplo php o nginx.  Al mismo tiempo, Docker no bloquea los recursos de su sistema por s√≠ mismo, sino que simplemente los usa seg√∫n sea necesario.  En √∫ltima instancia, para ilustrar, se ver√° m√°s o menos as√≠: <br><br>  ‚Üí <a href="">Ver esquema</a> <br><br>  Cada uno de los contenedores tiene una imagen a partir de la cual se crea.  La gran mayor√≠a de las im√°genes es una extensi√≥n de otra imagen, por ejemplo, Ubuntu xenial o Alpine o Debian, en la que se colocan controladores adicionales y otros componentes en la parte superior. <br><br>  Mi primera imagen fue para php-fpm.  Mi imagen extiende la imagen oficial de php: 7.2-fpm-alpine3.6.  Es decir, en esencia, toma la imagen oficial y entrega los componentes que necesito, por ejemplo, pdo_pgsql, imagick, zip, etc.  Por lo tanto, puede crear la imagen que necesita.  Si quieres, puedes usarlo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  Con la creaci√≥n de im√°genes, todo es bastante simple en mi opini√≥n si se hacen sobre la base de xenial, por ejemplo, pero entregan un poco de hemorroides si se hacen sobre la base de Alpine.  Antes de comenzar a trabajar con la ventana acoplable, b√°sicamente no escuch√© sobre Alpine, ya que Vagrant siempre trabaj√≥ para m√≠ en Ubuntu xenial.  Alpine es un sistema operativo Linux vac√≠o, en el que esencialmente no hay nada en absoluto (m√≠nimo extremo).  Por lo tanto, al principio es extremadamente inconveniente trabajar con √©l, ya que existe, por ejemplo, la misma instalaci√≥n de apt-get (a la que te acostumbras), pero solo hay apk add y un conjunto de paquetes no del todo sensato.  Una gran ventaja de Alpine es su peso, por ejemplo, si Xenial pesa (en abstracto) 500 bolsas, entonces Alpine (en abstracto) es de aproximadamente 78 bolsas.  ¬øQu√© afecta esto?  Y esto afecta la velocidad de construcci√≥n y el peso final de todas las im√°genes que se almacenar√°n en su servidor al final.  Digamos que tiene 5 contenedores diferentes y todo basado en xenial su peso total ser√° de m√°s de 2.5 gigas, y alpino, alrededor de 500 bolsas solamente.  Por lo tanto, idealmente, debemos esforzarnos por garantizar que los contenedores sean lo m√°s delgados posible.  (Enlace √∫til para instalar paquetes en Alpine - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">paquetes Alpine</a> ). <br><br>  En todas partes del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Docker Hub</a> escriben c√≥mo iniciar el contenedor utilizando el <code>docker run</code> , y por alguna raz√≥n no escriben c√≥mo se puede iniciar a trav√©s de Docker-Comose, y es a trav√©s de Docker-Comose que comenzar√° la mayor parte del tiempo, ya que hay muy poca caza Inicie manualmente todos los contenedores, redes, puertos abiertos y m√°s.  Docker-compose en nombre del usuario solo parece un archivo yaml con configuraciones.  Incluye una descripci√≥n de cada uno de los servicios que deben iniciarse.  Mi construcci√≥n para el entorno local es la siguiente: <br><br><pre> <code class="hljs powershell">version: <span class="hljs-string"><span class="hljs-string">'3.1'</span></span> services: php<span class="hljs-literal"><span class="hljs-literal">-fpm</span></span>: image: otezvikentiy/php7.<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-literal"><span class="hljs-literal">-fpm</span></span>:<span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">11</span></span> ports: - <span class="hljs-string"><span class="hljs-string">'9000:9000'</span></span> volumes: - ../:/app working_dir: /app container_name: <span class="hljs-string"><span class="hljs-string">'php-fpm'</span></span> nginx: image: nginx:<span class="hljs-number"><span class="hljs-number">1.15</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> container_name: <span class="hljs-string"><span class="hljs-string">'nginx'</span></span> working_dir: /app ports: - <span class="hljs-string"><span class="hljs-string">'7777:80'</span></span> volumes: - ../:/app - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf postgres: image: postgres:<span class="hljs-number"><span class="hljs-number">9.6</span></span> ports: - <span class="hljs-string"><span class="hljs-string">'5432:5432'</span></span> container_name: <span class="hljs-string"><span class="hljs-string">'postgresql'</span></span> working_dir: /app restart: always environment: POSTGRES_DB: <span class="hljs-string"><span class="hljs-string">'db_name'</span></span> POSTGRES_USER: <span class="hljs-string"><span class="hljs-string">'db_user'</span></span> POSTGRES_PASSWORD: <span class="hljs-string"><span class="hljs-string">'db_pass'</span></span> volumes: - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/dump:/app/dump - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/postgresql:/var/lib/postgresql/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> rabbitmq: image: rabbitmq:<span class="hljs-number"><span class="hljs-number">3.7</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-literal"><span class="hljs-literal">-management</span></span> working_dir: /app hostname: rabbit<span class="hljs-literal"><span class="hljs-literal">-mq</span></span> container_name: <span class="hljs-string"><span class="hljs-string">'rabbit-mq'</span></span> ports: - <span class="hljs-string"><span class="hljs-string">'15672:15672'</span></span> - <span class="hljs-string"><span class="hljs-string">'5672:5672'</span></span> environment: RABBITMQ_DEFAULT_USER: user RABBITMQ_DEFAULT_PASS: password RABBITMQ_DEFAULT_VHOST: my_vhost elasticsearch: image: docker.elastic.co/elasticsearch/elasticsearch:<span class="hljs-number"><span class="hljs-number">6.3</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> container_name: <span class="hljs-string"><span class="hljs-string">'elastic-search'</span></span> environment: - discovery.type=single<span class="hljs-literal"><span class="hljs-literal">-node</span></span> - <span class="hljs-string"><span class="hljs-string">"discovery.zen.ping.unicast.hosts=elasticsearch"</span></span> - bootstrap.memory_lock=true - <span class="hljs-string"><span class="hljs-string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span> ports: - <span class="hljs-number"><span class="hljs-number">9200</span></span>:<span class="hljs-number"><span class="hljs-number">9200</span></span> - <span class="hljs-number"><span class="hljs-number">9300</span></span>:<span class="hljs-number"><span class="hljs-number">9300</span></span> working_dir: /app volumes: - ../:/app - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/elasticsearch:/usr/share/elasticsearch/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> volumes: elasticsearch: postgresql:</code> </pre><br>  docker-compose.yaml para SF4 es un determinado conjunto de servicios: nginx, php-fpm, postgresql, rabbitmq (si lo necesita), elasticsearch (si lo necesita).  Para el medio ambiente local, esto es suficiente.  Para que todo funcione, hay una configuraci√≥n m√≠nima, sin la cual nada funcionar√°.  En la mayor√≠a de los casos, estos son imagen, vol√∫menes, puertos, entorno, directorio de trabajo y nombre de contenedor.  Todo para iniciar esta o aquella imagen se describe en su documentaci√≥n en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hub.docker.com</a> .  No siempre hay una descripci√≥n para docker-compose, pero esto no significa que no funcione con ella.  Solo es necesario transferir todos los datos entrantes del comando docker run a docker-compose y todo funcionar√°. <br><br>  Por ejemplo, hay una imagen para RabbitMQ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Cuando ves ESTO por primera vez, causa sentimientos y emociones mezclados, pero no todo es tan aterrador.  Las etiquetas se indican en esta imagen.  Por lo general, las etiquetas representan diferentes im√°genes, diferentes versiones de la aplicaci√≥n con diferentes im√°genes expandibles.  Por ejemplo, la etiqueta 3.7.7-alpine significa que esta imagen es m√°s delgada que, por ejemplo, 3.7.7, ya que est√° basada en Alpine.  Bueno, y tambi√©n en las etiquetas, con mayor frecuencia se indican las versiones de la aplicaci√≥n.  Por lo general, elijo la √∫ltima versi√≥n y la versi√≥n estable de la aplicaci√≥n en s√≠ y la imagen alpina. <br><br>  Despu√©s de haber estudiado y seleccionado una etiqueta, a menudo ver√° algo de este tipo: <br><br><pre> <code class="bash hljs">docker run -d --hostname my-rabbit --name some-rabbit -e RABBITMQ_DEFAULT_USER=user -e RABBITMQ_DEFAULT_PASS=password rabbitmq:3-management</code> </pre> <br>  ¬øY el primer pensamiento es WTF?  ¬øC√≥mo transferir esto a docker-compose? <br><br>  Todo es bastante f√°cil.  De hecho, esta l√≠nea indica los mismos par√°metros que en el archivo yaml, solo abreviado.  Por ejemplo, -e es un entorno en el que se pasan varios par√°metros, tambi√©n puede haber entradas como -p: estos son puertos que se llaman puertos en yaml.  En consecuencia, para utilizar una imagen desconocida de una manera de calidad, solo necesita "googlear" la ventana acoplable para ejecutar abreviaturas y aplicar los nombres completos en el archivo yaml. <br><br>  Ahora volvamos a docker-compose.yml, que cit√© como muestra arriba. <br><br>  Este ejemplo usa mi imagen php7.2 hecha como una extensi√≥n para la imagen oficial php7.2-fpm-alpine, pero si no necesita tantas bibliotecas adicionales, puede construir su extensi√≥n para la imagen oficial y usarla.  El resto de las im√°genes para LAN son completamente originales y oficiales. <br><br>  <b>imagen</b> : indique qu√© imagen descargar.  Por ejemplo (rabbitmq: 3.7.7-management-alpine). <br><br>  <b>puertos</b> : especifique los puertos que usar√° el contenedor (consulte la documentaci√≥n de la imagen).  El puerto nginx de ejemplo es 80 por defecto.  En consecuencia, si desea utilizar el puerto 80, debe especificar 80:80 aqu√≠ y su sitio estar√° disponible en localhost.  O puede especificar 7777: 80, y luego su sitio estar√° en url localhost: 7777.  Esto es necesario para que se puedan implementar varios proyectos en el mismo host. <br><br>  <b>vol√∫menes</b> : los directorios compartidos se indican aqu√≠.  Por ejemplo, su proyecto se encuentra en el directorio ~ / projects / my-sf4-app, y el contenedor php est√° configurado para funcionar con el directorio / app (igual que en / var / www / my-sf4-app).  En consecuencia, ser√≠a conveniente que el contenedor tenga acceso al proyecto.  En consecuencia, en vol√∫menes escribimos <code>~/projects/my-sf4-app:/app</code> (vea este ejemplo en docker-compose.yml arriba (lo he indicado de manera relativa ../:/app)). <br><br>  Por lo tanto, la carpeta se compartir√° para el contenedor y podr√° realizar varias acciones en ella como <code>php bin/console doctrine:migrations:migrate</code> .  Tambi√©n es conveniente usar estos directorios para guardar los datos de la aplicaci√≥n.  Por ejemplo, postgresql, puede especificar un directorio para almacenar datos de la base de datos, y luego, cuando vuelva a crear el contenedor, no necesitar√° rodar un volcado o accesorios. <br><br>  <b>working_dir</b> : indica el directorio de trabajo del contenedor.  En este caso, / app (o por analog√≠a con el vagrant / var / www / my-sf4-app). <br><br>  <b>entorno</b> : todas las variables para el contenedor se pasan aqu√≠.  Por ejemplo, para rabbitmq, se transmiten el nombre de usuario y la contrase√±a, para postgresql, se pasan el nombre base, el nombre de usuario y la contrase√±a. <br><br>  <b>nombre_contenedor</b> es un campo opcional, pero prefiero especificarlo, por la conveniencia de conectarse a los contenedores.  Si no se especifica, se asignar√°n nombres predeterminados con hashes. <br><br>  Estos son los par√°metros principales que deben especificarse.  El resto puede ser opcional para configuraciones adicionales, o de acuerdo con la documentaci√≥n del contenedor. <br><br>  Ahora, para comenzar todo esto, debe ejecutar el <code>docker-compose up -d</code> en el directorio donde se encuentra el archivo docker-compose. <br><br><h3>  ¬øC√≥mo y d√≥nde almacenar todo esto para LAN? </h3><br>  Para LAN, uso la carpeta acoplable en la ra√≠z del proyecto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pv/rg/a8/pvrga87xk7vcujz2-qwbjnqmtjk.png"></div><br>  Contiene la carpeta de datos en la que almaceno toda la informaci√≥n postgresql y elasticsearch, para que cuando vuelva a crear el proyecto, no tenga que rodar los accesorios desde cero.  Tambi√©n hay un nginx daddy en el que almaceno la configuraci√≥n para el contenedor nginx local.  Sincronizo estas carpetas en docker-compose.yml con los archivos y carpetas correspondientes en los contenedores.  Tambi√©n en mi opini√≥n, es muy conveniente escribir scripts de bash para trabajar con docker.  Por ejemplo, el script start.sh inicia los contenedores, luego instala el compositor, limpia el cach√© y migra.  Tambi√©n es conveniente para los colegas del proyecto, no tienen que hacer nada, solo ejecutan el script y todo funciona. <br><br>  Ejemplo de script Start.sh <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash green=$(tput setf 2) toend=$(tput hpa $(tput cols))$(tput cub 6) echo -n '   ?: ' read name echo "  $name!       tutmesto.ru" echo -n "$name,      ? (y/n): " read use_dump echo '    !' docker-compose up -d || exit echo -en '\n' echo -n "  ! ${green}${toend}[OK]" echo -en '\n' echo '    .' ./composer-install.sh echo -en '\n' echo -n "   ${green}${toend}[OK]" echo -en '\n' echo '     40 ,    postgres-' sleep 5 echo '  35 ...' sleep 5 echo '  30 ...' sleep 5 echo '  25 ...' sleep 5 echo '  20 ...' sleep 5 echo '  15 ...' sleep 5 echo '  10 ...' sleep 5 echo '  5 ...' sleep 5 echo ' .   postgres-        !' case "$use_dump" in y|Y) ./dump.sh echo -en '\n' echo -n "  ! ${green}${toend}[OK]" echo -en '\n' ;; *) echo "$name, ,   ! =)" ;; esac echo '    !' ./migrations-migrate.sh echo -en '\n' echo -n "  ! ${green}${toend}[OK]" echo -en '\n' echo '  !' ./php-fpm-command.sh rm -rf var/cache/* ./php-fpm-command.sh chmod 777 var/ -R ./cache-clear.sh echo -en '\n' echo -n "  ! ${green}${toend}[OK]" echo -en '\n' echo '    !' ./env.sh echo -en '\n' echo -n "   ! ${green}${toend}[OK]" echo -en '\n' echo ", $name,    !    localhost:7777  !" echo -en '\n' echo "------------------------------------------------------------------------------" echo -en '\n' echo "    :" echo "./cache-clear.sh |  symfony 4" echo "./composer.sh [command(ex. install)] |  " echo "./composer-install.sh | composer install" echo "./connect-to-php-fpm.sh |   php" echo "./console.sh [command(ex. cache:clear)] |  php bin/console" echo "./destroy.sh |  .    ." echo "./dump.sh | ,     (dump.sql)" echo "./env.sh |   " echo "./migrations-migrate.sh | " echo "./php-fpm-command.sh [command(ex. php -m)] |   php-fpm " echo "./start.sh |  ( )" echo "./stop.sh |Gracefull shutdown " echo -en '\n' echo "        :" echo "client@c.cc | QWEasd123" echo "admin@a.aa | QWEasd123" echo "moderator@m.mm | QWEasd123" echo -en '\n' echo "------------------------------------------------------------------------------" echo -en '\n' echo -en '\n' echo 'OtezVikentiy brain corporation!' echo -en '\n' echo -en '\n'</span></span></code> </pre><br>  <i>Ejemplo de</i> script <i>Php-fpm-command.sh</i> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash cd "`dirname \"$0\"`" &amp;&amp; \ docker-compose exec -T "php-fpm" sh -c "cd /app &amp;&amp; $*"</span></span></code> </pre><br>  <i>Ejemplo de</i> script <i>Connect-to-php-fpm.sh</i> <br><br><pre> <code class="bash hljs"><span class="hljs-meta"><span class="hljs-meta">#!/usr/bin/env bash docker exec -i -t --privileged php-fpm bash</span></span></code> </pre><br>  El entorno de desarrollo local termina aqu√≠.  ¬°Felicitaciones, puede compartir el resultado final con sus colegas!  ) <br><br><h2>  Productiva </h2><br><h3>  Preparaci√≥n </h3><br>  Suponga que ya escribi√≥ algo en una LAN y desea ponerlo en un servidor de producci√≥n o en un servidor de prueba.  Tiene alojamiento en virtualizaci√≥n KVM o su servidor en la habitaci√≥n contigua con aire acondicionado. <br><br>  Para implementar un producto o beta, el servidor debe tener un sistema operativo (idealmente Linux) y un Docker instalado.  Docker se puede instalar de la misma manera que en LAN, no hay diferencias. <br><br>  Docker en productividad es ligeramente diferente de LAN.  En primer lugar, no puede simplemente tomar y especificar contrase√±as y otra informaci√≥n y componer la ventana acoplable.  En segundo lugar, no puede usar docker-compose directamente. <br><br>  Docker utiliza el enjambre de docker y la pila de docker para la productividad.  Si est√° justo en los dedos, entonces este sistema difiere solo en otros comandos y en ese docker swarm hay un equilibrador de carga para el cl√∫ster (nuevamente un poco abstracto, pero ser√° m√°s f√°cil de entender). <br><br>  PD: te aconsejo que practiques la configuraci√≥n de Docker Swarm en Vagrant (no importa lo parad√≥jico que pueda parecer).  Una receta simple para el entrenamiento: tome un Vagrant vac√≠o con el mismo sistema operativo que el producto y config√∫relo para que comience. <br><br>  Para configurar el enjambre de Docker, solo necesita ejecutar algunos comandos: <br><br><pre> <code class="bash hljs">docker swarm init --advertise-addr 192.168.***.** (ip-  ) mkdir /app (          app) chown docker /app (     ) docker stack deploy -c docker-compose.yml my-first-sf4-docker-app</code> </pre><br>  Ahora consideramos todo esto con un poco m√°s de detalle. <br><br>  <b>docker swarm init --advertise-addr</b> - lanza docker swarm directamente y confunde un enlace para que pueda conectar alg√∫n otro servidor a este "enjambre" para que funcionen en el cl√∫ster. <br>  <b>mkdir / app &amp;&amp; chown ..</b> : debe crear todos los directorios necesarios para que la ventana acoplable funcione con anticipaci√≥n para que durante la compilaci√≥n no se queje de la falta de directorios. <br>  <b>docker stack deploy -c docker-compose.yml my-first-sf4-docker-app</b> : este comando inicia el ensamblaje de su aplicaci√≥n, un an√°logo de docker-compose up -d solo para el enjambre de docker. <br><br>  Para iniciar cualquier ensamblaje, necesita el mismo docker-compose.yaml, pero ya est√° ligeramente modificado espec√≠ficamente para productivo / beta. <br><br><pre> <code class="hljs powershell">version: <span class="hljs-string"><span class="hljs-string">'3.1'</span></span> services: php<span class="hljs-literal"><span class="hljs-literal">-fpm</span></span>: image: otezvikentiy/php7.<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-literal"><span class="hljs-literal">-fpm</span></span>:<span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">11</span></span> ports: - <span class="hljs-string"><span class="hljs-string">'9000:9000'</span></span> networks: - my<span class="hljs-literal"><span class="hljs-literal">-test</span></span><span class="hljs-literal"><span class="hljs-literal">-network</span></span> depends_on: - postgres - rabbitmq volumes: - /app:/app working_dir: /app deploy: replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> restart_policy: condition: on<span class="hljs-literal"><span class="hljs-literal">-failure</span></span> placement: constraints: [<span class="hljs-type"><span class="hljs-type">node.role</span></span> == <span class="hljs-type"><span class="hljs-type">manager</span></span>] nginx: image: nginx:<span class="hljs-number"><span class="hljs-number">1.15</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> networks: - my<span class="hljs-literal"><span class="hljs-literal">-test</span></span><span class="hljs-literal"><span class="hljs-literal">-network</span></span> working_dir: /app ports: - <span class="hljs-string"><span class="hljs-string">'80:80'</span></span> depends_on: - php<span class="hljs-literal"><span class="hljs-literal">-fpm</span></span> volumes: - /app:/app - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf deploy: replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> restart_policy: condition: on<span class="hljs-literal"><span class="hljs-literal">-failure</span></span> placement: constraints: [<span class="hljs-type"><span class="hljs-type">node.role</span></span> == <span class="hljs-type"><span class="hljs-type">manager</span></span>] postgres: image: postgres:<span class="hljs-number"><span class="hljs-number">9.6</span></span> ports: - <span class="hljs-string"><span class="hljs-string">'5432:5432'</span></span> working_dir: /app networks: - my<span class="hljs-literal"><span class="hljs-literal">-test</span></span><span class="hljs-literal"><span class="hljs-literal">-network</span></span> secrets: - postgres_db - postgres_user - postgres_pass environment: POSTGRES_DB_FILE: /run/secrets/postgres_db POSTGRES_USER_FILE: /run/secrets/postgres_user POSTGRES_PASSWORD_FILE: /run/secrets/postgres_pass volumes: - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/dump:/app/dump - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/postgresql:/var/lib/postgresql/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> deploy: replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> restart_policy: condition: on<span class="hljs-literal"><span class="hljs-literal">-failure</span></span> placement: constraints: [<span class="hljs-type"><span class="hljs-type">node.role</span></span> == <span class="hljs-type"><span class="hljs-type">manager</span></span>] rabbitmq: image: rabbitmq:<span class="hljs-number"><span class="hljs-number">3.7</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-literal"><span class="hljs-literal">-management</span></span> networks: - my<span class="hljs-literal"><span class="hljs-literal">-test</span></span><span class="hljs-literal"><span class="hljs-literal">-network</span></span> working_dir: /app hostname: my<span class="hljs-literal"><span class="hljs-literal">-test</span></span><span class="hljs-literal"><span class="hljs-literal">-sf4</span></span><span class="hljs-literal"><span class="hljs-literal">-app</span></span><span class="hljs-literal"><span class="hljs-literal">-rabbit</span></span><span class="hljs-literal"><span class="hljs-literal">-mq</span></span> volumes: - /app:/app ports: - <span class="hljs-string"><span class="hljs-string">'5672:5672'</span></span> - <span class="hljs-string"><span class="hljs-string">'15672:15672'</span></span> secrets: - rabbitmq_default_user - rabbitmq_default_pass - rabbitmq_default_vhost environment: RABBITMQ_DEFAULT_USER_FILE: /run/secrets/rabbitmq_default_user RABBITMQ_DEFAULT_PASS_FILE: /run/secrets/rabbitmq_default_pass RABBITMQ_DEFAULT_VHOST_FILE: /run/secrets/rabbitmq_default_vhost deploy: replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> restart_policy: condition: on<span class="hljs-literal"><span class="hljs-literal">-failure</span></span> placement: constraints: [<span class="hljs-type"><span class="hljs-type">node.role</span></span> == <span class="hljs-type"><span class="hljs-type">manager</span></span>] elasticsearch: image: docker.elastic.co/elasticsearch/elasticsearch:<span class="hljs-number"><span class="hljs-number">6.3</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> networks: - my<span class="hljs-literal"><span class="hljs-literal">-test</span></span><span class="hljs-literal"><span class="hljs-literal">-network</span></span> depends_on: - postgres environment: - discovery.type=single<span class="hljs-literal"><span class="hljs-literal">-node</span></span> - discovery.zen.ping.unicast.hosts=elasticsearch - bootstrap.memory_lock=true - ES_JAVA_OPTS=<span class="hljs-literal"><span class="hljs-literal">-Xms512m</span></span> <span class="hljs-literal"><span class="hljs-literal">-Xmx512m</span></span> ports: - <span class="hljs-number"><span class="hljs-number">9200</span></span>:<span class="hljs-number"><span class="hljs-number">9200</span></span> - <span class="hljs-number"><span class="hljs-number">9300</span></span>:<span class="hljs-number"><span class="hljs-number">9300</span></span> working_dir: /app volumes: - /app:/app - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/elasticsearch:/usr/share/elasticsearch/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> deploy: replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> restart_policy: condition: on<span class="hljs-literal"><span class="hljs-literal">-failure</span></span> placement: constraints: [<span class="hljs-type"><span class="hljs-type">node.role</span></span> == <span class="hljs-type"><span class="hljs-type">manager</span></span>] jenkins: image: otezvikentiy/jenkins:<span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> networks: - my<span class="hljs-literal"><span class="hljs-literal">-test</span></span><span class="hljs-literal"><span class="hljs-literal">-network</span></span> ports: - <span class="hljs-string"><span class="hljs-string">'8080:8080'</span></span> - <span class="hljs-string"><span class="hljs-string">'50000:50000'</span></span> volumes: - /app:/app - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/jenkins:/var/jenkins_home - /var/run/docker.sock:/var/run/docker.sock - /usr/bin/docker:/usr/bin/docker deploy: replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> restart_policy: condition: on<span class="hljs-literal"><span class="hljs-literal">-failure</span></span> placement: constraints: [<span class="hljs-type"><span class="hljs-type">node.role</span></span> == <span class="hljs-type"><span class="hljs-type">manager</span></span>] volumes: elasticsearch: postgresql: jenkins: networks: my<span class="hljs-literal"><span class="hljs-literal">-test</span></span><span class="hljs-literal"><span class="hljs-literal">-network</span></span>: secrets: rabbitmq_default_user: file: ./secrets/rabbitmq_default_user rabbitmq_default_pass: file: ./secrets/rabbitmq_default_pass rabbitmq_default_vhost: file: ./secrets/rabbitmq_default_vhost postgres_db: file: ./secrets/postgres_db postgres_user: file: ./secrets/postgres_user postgres_pass: file: ./secrets/postgres_pass</code> </pre><br>  Como puede ver, el archivo de configuraci√≥n del producto es ligeramente diferente del archivo de LAN.  Agreg√≥ secretos, despliegues y redes. <br><br>  <b>secretos</b> : archivos para almacenar claves.  Las claves se crean de manera bastante simple.  Creas un archivo con el nombre de la clave: escribe el valor dentro.  Despu√©s de eso, en docker-compose.yml especifica la secci√≥n de secretos y transfiere la lista completa de archivos con claves.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">M√°s detalles</a> <br>  <b>redes</b> : esto crea una determinada red interna a trav√©s de la cual los contenedores se comunican entre s√≠.  En LAN, esto se hace autom√°ticamente, pero de manera productiva, esto debe hacerse un poco de forma manual.  Adem√°s, puede especificar configuraciones adicionales, excepto las predeterminadas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">M√°s detalles</a> <br>  <b>La implementaci√≥n</b> es la principal diferencia entre LAN y Producto / Beta. <br><br><pre> <code class="hljs powershell"> deploy: replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> restart_policy: condition: on<span class="hljs-literal"><span class="hljs-literal">-failure</span></span> placement: constraints: [<span class="hljs-type"><span class="hljs-type">node.role</span></span> == <span class="hljs-type"><span class="hljs-type">manager</span></span>]</code> </pre><br>  Conjunto m√≠nimo de luchador: <br><br>  <b>r√©plicas</b> : indique la cantidad de r√©plicas que necesita ejecutar (de hecho, esto se usa si tiene un cl√∫ster y usa el equilibrador de carga desde la ventana acoplable).  Por ejemplo, tiene dos servidores y los conect√≥ a trav√©s del enjambre Docker.  Al especificar el n√∫mero 2 aqu√≠, por ejemplo, se crear√° 1 instancia en 1 servidor y la segunda en el segundo servidor.  Por lo tanto, la carga en el servidor se dividir√° a la mitad. <br>  <b>restart_policy</b> : la pol√≠tica de "volver a subir" autom√°ticamente el contenedor en caso de que se caiga por alg√∫n motivo. <br>  <b>colocaci√≥n</b> : la ubicaci√≥n de la instancia del contenedor.  Por ejemplo, hay momentos en los que desea que todas las instancias de un contenedor giren solo en 1 de 5 servidores, y no se distribuyan entre ellos. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬°Quiero leer la documentaci√≥n!</a> <br><br>  Entonces, hemos mejorado un poco lo que distingue a docker-compose.yaml para LAN de la versi√≥n del producto / beta.  Ahora intentemos manejar este negocio. <br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supongamos que est√° entrenando en Vagrant y en la ra√≠z del servidor ya tiene el archivo configurado para el producto docker-compose.yml</font></font></i> <br><br><pre> <code class="bash hljs">sudo apt-get update sudo apt-get -y upgrade sudo apt-get install -y language-pack-en-base <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LC_ALL=en_US.UTF-8 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LANGUAGE=en_US.UTF-8 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LANG=en_US.UTF-8 curl -sSl https://get.docker.com/ | sh sudo usermod -aG docker ubuntu sudo apt-get install git sudo docker swarm init --advertise-addr 192.168.128.77 sudo mkdir /app sudo chmod 777 /app -R docker stack deploy -c /docker-compose.yml my-app git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@bitbucket.org:JohnDoe/my-app.git /app docker stack ps my-app docker stack ls docker stack services my-app</code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PD:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no patees por sudo y 777, por supuesto, no vale la pena hacerlo de manera productiva. </font><font style="vertical-align: inherit;">Esto es solo para aprender velocidad. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, estamos m√°s interesados ‚Äã‚Äãen las l√≠neas asociadas con la ventana acoplable. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primero inicializamos el "enjambre" (enjambre de docker). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego creamos los directorios necesarios para el trabajo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descargue el nabo con nuestro c√≥digo SF4 en el directorio / app. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de eso hay tres comandos: ps, ls y servicios. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada uno de ellos es √∫til a su manera. </font><font style="vertical-align: inherit;">Utilizo ps con mayor frecuencia, ya que muestra el estado de los contenedores y parte del error, si corresponde.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Digamos que los contenedores se han elevado, pero algunos de ellos se bloquean constantemente con un error y en docker stack ps my-app ves un mont√≥n de reinicios. </font><font style="vertical-align: inherit;">Para ver el motivo de la ca√≠da, debe ejecutar docker container ps -a, y aparecer√° un contenedor que cae constantemente. </font><font style="vertical-align: inherit;">Habr√° muchas instancias del mismo contenedor, por ejemplo my-app_php-fpm.1. * Alg√∫n hash feroz *. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En consecuencia, ahora, conociendo el nombre del contenedor, ejecute los registros de Docker my-app_php-fpm.1. * Alg√∫n hash feroz * y mire a trav√©s de los registros. </font><font style="vertical-align: inherit;">Corrija el error y reinicie TODO. </font><font style="vertical-align: inherit;">Para golpear todos los contenedores, puede hacer esto:</font></font><br><br><pre> <code class="bash hljs">docker stack rm my-app</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de eso, tendr√°s un enjambre limpio sin ning√∫n contenedor. </font><font style="vertical-align: inherit;">Solucione el error, y de nuevo docker stack deploy -c docker-compose.yml my-app.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420673/">https://habr.com/ru/post/es420673/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420663/index.html">M√©tricas simples y una forma de ahorrar tiempo al buscar problemas en la infraestructura</a></li>
<li><a href="../es420665/index.html">Creaci√≥n de una aplicaci√≥n en .NET Core y Kubernetes: nuestra experiencia</a></li>
<li><a href="../es420667/index.html">Principios de funcionamiento del protocolo EIGRP</a></li>
<li><a href="../es420669/index.html">Descripci√≥n general del mercado de automatizaci√≥n empresarial: soluciones para empresas de construcci√≥n y administraci√≥n de viviendas y servicios p√∫blicos</a></li>
<li><a href="../es420671/index.html">[Ekaterinburg, anuncio] UralJS # 9 - tres informes sobre microservicios, pruebas y registro de errores en el frente</a></li>
<li><a href="../es420675/index.html">SOC son personas. "Hola, estamos buscando talento" o de d√≥nde provienen los analistas del centro de monitoreo y respuesta a ataques cibern√©ticos</a></li>
<li><a href="../es420677/index.html">La historia de c√≥mo Epson proporcion√≥ al planeta 30 millones de "f√°bricas"</a></li>
<li><a href="../es420679/index.html">Nuevos cursos de Python del grupo Mail.Ru</a></li>
<li><a href="../es420681/index.html">AMD ThreadRipper 2: primera introducci√≥n</a></li>
<li><a href="../es420685/index.html">Arreglar y neutralizar: c√≥mo domesticamos la plata. Una palabra sobre bactericidas para el agua</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>