<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ò ü§∏üèæ üßîüèº [Terjemahan] Bagaimana Graal - Java JVM JVM Compiler Bekerja üë©üèæ‚Äçüè´ üåÉ ü¶ì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! Saya hadir untuk Anda terjemahan artikel " Memahami Cara Kerja Graal - Java JIT Compiler Ditulis di Jawa ". 
 Pendahuluan 


 Salah satu a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[Terjemahan] Bagaimana Graal - Java JVM JVM Compiler Bekerja</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419637/"><p> Halo, Habr!  Saya hadir untuk Anda terjemahan artikel " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Memahami Cara Kerja Graal - Java JIT Compiler Ditulis di Jawa</a> ". </p><br><h2 id="vvedenie">  Pendahuluan </h2><br><p>  Salah satu alasan mengapa saya menjadi peneliti dalam bahasa pemrograman adalah bahwa, dalam komunitas besar orang yang terlibat dalam teknologi komputer, hampir semua orang menggunakan bahasa pemrograman, dan banyak yang tertarik dengan cara kerjanya.  Ketika saya pertama kali menemukan pemrograman sebagai seorang anak dan berkenalan dengan bahasa pemrograman, hal pertama yang ingin saya ketahui adalah cara kerjanya, dan hal pertama yang ingin saya lakukan adalah menciptakan bahasa saya sendiri. </p><br><p>  Dalam presentasi ini, saya akan menunjukkan kepada Anda beberapa mekanisme kerja dari bahasa yang Anda semua gunakan - Java.  Keunikannya adalah bahwa saya akan menggunakan proyek yang disebut <em>Graal</em> , yang mengimplementasikan konsep <em>Java di Jawa</em> . </p><a name="habracut"></a><br><p>  Graal hanyalah salah satu komponen dalam pekerjaan Java - itu adalah kompiler <em>just-in-time</em> .  Ini adalah bagian dari JVM yang mengubah bytecode Java ke kode mesin selama eksekusi program, dan merupakan salah satu faktor yang memastikan kinerja platform yang tinggi.  Bagi saya, itu juga, apa yang dianggap sebagian besar orang sebagai salah satu bagian JVM yang paling kompleks dan tidak jelas, yang berada di luar pemahaman mereka.  Ubah opini ini adalah tujuan dari pidato ini. </p><br><p>  Jika Anda tahu apa itu JVM;  umumnya mengerti apa arti istilah <em>bytecode</em> dan <em>kode mesin</em> ;  dan mampu membaca kode yang ditulis dalam bahasa Jawa, maka, saya harap, ini akan cukup untuk memahami materi yang disajikan. </p><br><p>  Saya akan mulai dengan membahas mengapa kita mungkin menginginkan kompiler JIT baru untuk JVM yang ditulis di Jawa, dan setelah itu saya akan menunjukkan bahwa tidak ada yang istimewa dalam hal ini, seperti yang mungkin Anda pikirkan, dengan memecah tugas menjadi perakitan compiler, menggunakan, dan menunjukkan bahwa bahwa kodenya sama dengan aplikasi lainnya. </p><br><p>  Saya akan menyentuh sedikit teori, dan kemudian saya akan menunjukkan bagaimana itu diterapkan selama seluruh proses kompilasi dari bytecode ke kode mesin.  Saya juga akan menunjukkan beberapa detail, dan pada akhirnya kita akan berbicara tentang manfaat dari fitur ini selain mengimplementasikan <em>Java di Java</em> untuk kepentingannya sendiri. </p><br><p>  Saya akan menggunakan tangkapan layar kode di Eclipse, alih-alih meluncurkannya selama presentasi, untuk menghindari masalah koding langsung yang tidak terhindarkan. </p><br><h2 id="chto-takoe-jit-kompilyator">  Apa itu kompiler JIT? </h2><br><p>  Saya yakin banyak dari Anda yang tahu apa itu kompiler JIT, tetapi saya masih akan menyentuh dasar-dasarnya sehingga tidak ada yang duduk di sini takut untuk menanyakan pertanyaan utama ini. </p><br><p> Ketika Anda menjalankan perintah <code>javac</code> atau <em>compile-on-save</em> dalam IDE, program Java Anda mengkompilasi dari kode Java ke bytecode JVM, yang merupakan representasi biner dari program tersebut.  Ini lebih kompak dan sederhana daripada kode sumber Java.  Namun, prosesor reguler laptop atau server Anda tidak bisa hanya menjalankan bytecode JVM. </p><br><p>  Untuk pengoperasian program Anda, JVM mengartikan bytecode ini.  Penerjemah biasanya jauh lebih lambat daripada kode mesin yang berjalan pada prosesor.  Untuk alasan ini, JVM, ketika program sedang berjalan, dapat meluncurkan kompiler lain yang mengubah bytecode Anda menjadi kode mesin, yang sudah dapat dieksekusi prosesor. </p><br><p>  Kompiler ini, biasanya jauh lebih canggih daripada <code>javac</code> , melakukan optimasi kompleks untuk menghasilkan kode mesin berkualitas tinggi sebagai hasilnya. </p><br><h2 id="zachem-pisat-jit-kompilyator-na-java">  Mengapa menulis kompiler JIT di Java? </h2><br><p>  Sampai saat ini, implementasi JVM yang disebut <em>OpenJDK</em> mencakup dua kompiler JIT utama.  Kompiler klien, yang dikenal sebagai <em>C1</em> , dirancang untuk operasi yang lebih cepat, tetapi pada saat yang sama menghasilkan kode yang kurang dioptimalkan.  Kompiler server, yang dikenal sebagai <em>opto</em> atau <em>C2</em> , membutuhkan sedikit lebih banyak waktu untuk bekerja, tetapi menghasilkan kode yang lebih optimal. </p><br><p>  Idenya adalah bahwa kompiler klien lebih cocok untuk aplikasi desktop, di mana jeda panjang dalam kompiler JIT tidak diinginkan, dan kompiler server untuk aplikasi server lama-bermain, yang bisa menghabiskan lebih banyak waktu kompilasi. </p><br><p>  Hari ini mereka dapat digabungkan sehingga kode pertama kali dikompilasi oleh C1, dan kemudian, jika terus dieksekusi secara intensif dan masuk akal untuk menghabiskan waktu tambahan, - C2.  Ini disebut <em>kompilasi berjenjang</em> . </p><br><p>  Mari kita bahas C2, kompiler server yang melakukan lebih banyak optimasi. </p><br><p>  Kami dapat mengkloning OpenJDK dari mirror di <em>GitHub</em> , atau hanya membuka pohon proyek di situs. </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/dmlloyd</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openjdk.git</span></span></code> </pre> <br><p>  Kode C2 ada di <em>openjdk / hotspot / src / share / vm / opto</em> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/c2.png" alt="Kode Sumber C2"></p><br><p>  Pertama-tama, perlu dicatat bahwa C2 ditulis dalam <em>C ++</em> .  Tentu saja, ini bukan sesuatu yang buruk, tetapi ada beberapa kelemahan.  C ++ adalah bahasa yang tidak aman.  Ini berarti bahwa kesalahan dalam C ++ dapat crash VM.  Alasan untuk ini mungkin karena usia kode, tetapi kode C2 C ++ telah menjadi sangat sulit untuk dipertahankan dan dikembangkan. </p><br><p>  Salah satu tokoh kunci di balik kompiler C2, Cliff Click mengatakan bahwa dia tidak akan pernah lagi menulis VM di C ++, dan kami mendengar tim <em>Twitter</em> JVM mengatakan bahwa C2 menjadi stagnan dan perlu diganti karena suatu alasan kesulitan pengembangan lebih lanjut. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-1.jpeg" alt="Presentasi Klik Tebing"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-2.png" alt="Yang tidak ingin dilakukan Cliff Click lagi"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.youtube.com/watch?v=Hqw57GJSrac</a> </p><br><p>  Jadi, kembali ke pertanyaan, apa ini di Jawa yang dapat membantu menyelesaikan masalah ini?  Hal yang sama yang memberikan penulisan program di Java bukannya C ++.  Ini mungkin keamanan (pengecualian bukan crash, tidak ada kebocoran memori nyata atau petunjuk menggantung), <em>pembantu yang</em> baik (debugger, profiler, dan alat-alat seperti <em>VisualVM</em> ), dukungan IDE yang baik, dll. </p><br><p>  Anda mungkin berpikir: <em>Bagaimana saya bisa menulis sesuatu seperti kompiler Java JIT?</em>  , dan ini hanya dimungkinkan dalam bahasa pemrograman sistem tingkat rendah seperti C ++.  Dalam presentasi ini, saya berharap dapat meyakinkan Anda bahwa ini sama sekali tidak!  Pada dasarnya, kompiler JIT seharusnya hanya menerima bytecode JVM dan memberikan kode mesin - Anda memberinya <code>byte[]</code> pada input, dan Anda juga ingin mendapatkan <code>byte[]</code> .  Dibutuhkan banyak pekerjaan rumit untuk melakukan ini, tetapi tidak mempengaruhi level sistem, dan karena itu tidak memerlukan bahasa <em>sistem</em> seperti C atau C ++. </p><br><h2 id="nastroyka-graal">  Pengaturan Graal </h2><br><p>  Hal pertama yang kita butuhkan adalah Java 9. Antarmuka Graal yang disebut <em>JVMCI digunakan</em> ditambahkan ke Jawa sebagai bagian dari <em>Antarmuka JVM Compiler</em> <em>JV</em> <em>243 Java-Level,</em> dan versi pertama yang memasukkannya adalah Java 9. Saya menggunakan <em>9 + 181</em> .  Dalam hal ada persyaratan khusus, ada port (backports) untuk Java 8. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> export JAVA_HOME=`pwd`/jdk9 <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=<span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> java <span class="hljs-literal"><span class="hljs-literal">-version</span></span> java version <span class="hljs-string"><span class="hljs-string">"9"</span></span> Java(TM) SE Runtime Environment (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>) Java HotSpot(TM) <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-Bit</span></span> Server VM (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>, mixed mode)</code> </pre> <br><p>  Hal berikutnya yang kita butuhkan adalah sistem build yang disebut <code>mx</code> .  Ini agak mirip <em>Maven</em> atau <em>Gradle</em> , tetapi kemungkinan besar Anda tidak akan memilihnya untuk aplikasi Anda.  Ini mengimplementasikan fungsionalitas tertentu untuk mendukung beberapa kasus penggunaan yang kompleks, tetapi kami hanya akan menggunakannya untuk rakitan sederhana. </p><br><p>  Anda dapat mengkloning <code>mx</code> dengan GitHub.  Saya menggunakan komit <code>#7353064</code> .  Sekarang tambahkan saja executable ke path. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/mx.git <span class="hljs-variable"><span class="hljs-variable">$</span></span> cd mx; git checkout <span class="hljs-number"><span class="hljs-number">7353064</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=`pwd`/mx:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br><p>  Sekarang kita perlu mengkloning Graal itu sendiri.  Saya menggunakan distribusi yang disebut <em>GraalVM</em> versi <em>0.28.2</em> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/graal.git -<span class="hljs-literal"><span class="hljs-literal">-branch</span></span> vm<span class="hljs-literal"><span class="hljs-literal">-enterprise</span></span><span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span></code> </pre> <br><p>  Repositori ini berisi proyek-proyek lain yang tidak kami minati, jadi kami pergi saja ke sub-proyek <em>kompiler</em> , yang merupakan kompiler Graal JIT, dan kompilasi menggunakan <code>mx</code> . </p><br><pre> <code class="hljs ruby">$ cd graal/compiler $ mx build</code> </pre> <br><p>  Untuk bekerja dengan kode Graal saya akan menggunakan <em>IDE Eclipse</em> .  Saya menggunakan Eclipse 4.7.1.  <code>mx</code> dapat menghasilkan file proyek Eclipse untuk kita. </p><br><pre> <code class="hljs ruby">$ mx eclipseinit</code> </pre> <br><p>  Untuk membuka direktori <em>graal</em> sebagai <em>ruang kerja,</em> Anda perlu menjalankan <em>File, Import ..., General, proyek yang ada</em> dan pilih direktori <em>graal lagi</em> .  Jika Anda tidak menjalankan Eclipse di Java 9, Anda mungkin perlu melampirkan sumber JDK. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/eclipse.png" alt="Graal dalam Eclipse"></p><br><p>  Bagus  Sekarang semuanya sudah siap, mari kita lihat cara kerjanya.  Kami akan menggunakan kode yang sangat sederhana ini. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { workload(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre> <br><p>  Pertama, kita kompilasi kode <code>javac</code> ini, dan kemudian jalankan JVM.  Pertama, saya akan menunjukkan kepada Anda bagaimana kompiler C2 JIT standar bekerja.  Untuk melakukan ini, kami <code>-XX:+PrintCompilation</code> menetapkan beberapa flag: <code>-XX:+PrintCompilation</code> , yang diperlukan untuk JVM untuk menulis log ketika menyusun metode, dan <code>-XX:CompileOnly=Demo::workload</code> , sehingga hanya metode ini yang dikompilasi.  Jika tidak, maka terlalu banyak informasi akan ditampilkan, dan JVM akan lebih pintar dari yang kita butuhkan, dan akan mengoptimalkan kode yang ingin kita lihat. </p><br><pre> <code class="hljs ruby">$ javac Demo.java $ java \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>+PrintCompilation \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">113</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><p>  Saya tidak akan menjelaskan ini secara rinci, tetapi saya hanya akan mengatakan bahwa ini adalah output log yang menunjukkan bahwa metode <code>workload</code> telah dikompilasi. </p><br><p>  Sekarang, sebagai kompiler JIT Java 9 JVM kami, kami menggunakan Graal yang baru dikompilasi.  Untuk melakukan ini, tambahkan beberapa flag lagi. </p><br><p>  <code>--module-path=...</code> dan <code>--upgrade-module-path=...</code> tambahkan Graal ke <em>path modul</em> .  Biarkan saya mengingatkan Anda bahwa <em>lintasan modul</em> muncul di Java 9 sebagai bagian dari sistem modul <em>Jigsaw</em> , dan untuk tujuan kami, kami dapat mempertimbangkannya dengan analogi dengan <em>classpath</em> . </p><br><p>  Kita memerlukan <code>-XX:+UnlockExperimentalVMOptions</code> karena fakta bahwa JVMCI (antarmuka yang digunakan oleh Graal) dalam versi ini adalah fitur eksperimental. </p><br><p>  Bendera <code>-XX:+EnableJVMCI</code> diperlukan untuk mengatakan bahwa kami ingin menggunakan JVMCI, dan <code>-XX:+UseJVMCICompiler</code> - untuk mengaktifkan dan menginstal kompiler JIT baru. </p><br><p>  Agar tidak menyulitkan contoh, dan, alih-alih menggunakan C1 dalam hubungannya dengan JVMCI, hanya memiliki kompiler JVMCI, tentukan flag <code>-XX:-TieredCompilation</code> , yang akan menonaktifkan kompilasi bertahap. </p><br><p>  Seperti sebelumnya, kami menetapkan flag <code>-XX:+PrintCompilation</code> dan <code>-XX:CompileOnly=Demo::workload</code> . </p><br><p>  Seperti pada contoh sebelumnya, kita melihat bahwa satu metode dikompilasi.  Tapi, kali ini, untuk kompilasi kami menggunakan Graal yang baru saja dirakit.  Untuk sekarang, anggap saja kata-kataku. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">583</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><h2 id="interfeys-kompilyatora-jvm">  Antarmuka JVM Compiler </h2><br><p>  Tidakkah Anda berpikir bahwa kami melakukan sesuatu yang sangat tidak biasa?  Kami memiliki JVM yang terinstal, dan kami mengganti kompiler JIT dengan yang baru dikompilasi tanpa mengubah apa pun di JVM itu sendiri.  Fitur ini disediakan oleh antarmuka JVM baru yang disebut JVMCI, <em>antarmuka kompiler JVM</em> , yang, seperti yang saya katakan di atas, adalah <em>JEP 243</em> dan datang di Java 9. </p><br><p>  Idenya mirip dengan beberapa teknologi JVM lain yang ada. </p><br><p>  Mungkin Anda pernah menemukan pemrosesan kode sumber tambahan di <code>javac</code> menggunakan <em>API pemrosesan anotasi Java</em> .  Mekanisme ini memungkinkan untuk mengidentifikasi anotasi dan model kode sumber di mana mereka digunakan, dan untuk membuat file baru berdasarkan mereka. </p><br><p>  Juga, Anda mungkin telah menggunakan pemrosesan bytecode tambahan di JVM menggunakan <em>agen Java</em> .  Mekanisme ini memungkinkan Anda untuk memodifikasi bytecode Java dengan memotongnya saat boot. </p><br><p>  Gagasan JVMCI serupa.  Ini memungkinkan Anda untuk menghubungkan kompiler Java JIT Anda sendiri yang ditulis dalam Java. </p><br><p>  Sekarang saya ingin mengatakan beberapa kata tentang bagaimana saya akan menunjukkan kode selama presentasi ini.  Pertama, untuk memahami gagasan itu, saya akan menunjukkan beberapa pengidentifikasi dan logika yang disederhanakan dalam bentuk teks pada slide, dan setelah itu saya akan beralih ke tangkapan layar Eclipse dan menunjukkan kode sebenarnya, yang dapat sedikit lebih rumit, tetapi gagasan utama akan tetap sama.  Bagian utama dari presentasi ini dimaksudkan untuk menunjukkan bahwa sangat mungkin untuk bekerja dengan kode proyek yang sebenarnya, dan karena itu saya tidak ingin menyembunyikannya, walaupun itu bisa agak rumit. </p><br><p>  Mulai sekarang, saya mulai menghilangkan pendapat bahwa Anda mungkin memiliki kompiler JIT yang sangat rumit. </p><br><p>  Apa yang diterima oleh kompiler JIT untuk input?  Ia menerima bytecode dari metode yang akan dikompilasi.  Dan bytecode, seperti namanya, hanyalah sebuah array byte. </p><br><p>  Apa yang dihasilkan oleh kompiler JIT?  Ini memberikan kode mesin dari metode ini.  Kode mesin juga hanya array byte. </p><br><p>  Akibatnya, antarmuka yang harus diimplementasikan saat menulis kompiler JIT baru untuk menanamkannya di JVM akan terlihat seperti ini. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] compileMethod(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytecode); }</code> </pre> <br><p>  Oleh karena itu, jika Anda tidak dapat membayangkan bagaimana Java dapat melakukan sesuatu yang tingkat rendah seperti kompilasi JIT ke dalam kode mesin, sekarang Anda dapat melihat bahwa ini bukan pekerjaan tingkat rendah.  Benar?  Ini hanya fungsi dari <code>byte[]</code> ke <code>byte[]</code> . </p><br><p>  Pada kenyataannya, semuanya agak lebih rumit.  Hanya bytecode tidak cukup - kita juga memerlukan beberapa informasi lebih lanjut, seperti jumlah variabel lokal, ukuran stack yang diperlukan, dan informasi yang dikumpulkan oleh profiler juru bahasa untuk memahami bagaimana kode dijalankan pada kenyataannya.  Oleh karena itu, bayangkan input dalam bentuk <code>CompilationRequest</code> , yang akan memberi tahu kami tentang <code>JavaMethod</code> yang perlu dikompilasi dan memberikan semua informasi yang diperlukan. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilationRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">JavaMethod </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaMethod</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getCode(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxLocals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxStackSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ProfilingInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfilingInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... }</code> </pre> <br><p>  Juga, antarmuka tidak memerlukan pengembalian kode yang dikompilasi.  Sebaliknya, API lain digunakan untuk menginstal kode mesin di JVM. </p><br><pre> <code class="java hljs">HotSpot.installCode(targetCode);</code> </pre> <br><p>  Sekarang, untuk menulis kompiler JIT baru untuk JVM, Anda hanya perlu mengimplementasikan antarmuka ini.  Kami mendapatkan informasi tentang metode yang perlu dikompilasi, dan kami harus mengompilasinya menjadi kode mesin dan memanggil <code>installCode</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ HotSpot.installCode(...); } }</code> </pre> <br><p>  Mari kita beralih ke Eclipse IDE dengan Graal dan melihat beberapa antarmuka dan kelas nyata.  Seperti yang disebutkan sebelumnya, mereka akan sedikit lebih rumit, tetapi tidak banyak. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/jvmci-compiler-interface.png" alt="JVMCICompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-1.png" alt="HotSpotGraalCompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-2.png" alt="compileMethod"></p><br><p>  Sekarang saya ingin menunjukkan bahwa kita dapat membuat perubahan ke Graal, dan segera menggunakannya di Jawa 9. Saya akan menambahkan pesan log baru yang akan ditampilkan ketika mengkompilasi metode menggunakan Graal.  Tambahkan ke metode antarmuka yang diimplementasikan, yang disebut oleh JVMCI. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(<span class="hljs-string"><span class="hljs-string">"Going to compile "</span></span> + request.getMethod().getName()); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-3.png" alt="Kompilasi"></p><br><p>  Untuk saat ini, nonaktifkan kompilasi logging di HotSpot.  Sekarang kita dapat melihat pesan kita dari versi kompiler yang dimodifikasi. </p><br><pre> <code class="java hljs">$ java \ --<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ --upgrade-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ -XX:+UnlockExperimentalVMOptions \ -XX:+EnableJVMCI \ -XX:+UseJVMCICompiler \ -XX:-TieredCompilation \ -XX:CompileOnly=Demo::workload \ Demo Going to compile workload</code> </pre> <br><p>  Jika Anda mencoba mengulanginya sendiri, Anda akan melihat bahwa Anda bahkan tidak perlu menjalankan sistem build kami - <code>mx build</code> .  Cukup, normal untuk Eclipse, <em>kompilasi pada save</em> .  Dan tentunya kita tidak perlu membangun kembali JVM itu sendiri.  Kami cukup menyematkan kompiler yang dimodifikasi di JVM yang ada. </p><br><h2 id="graf-graal">  Hitung Graal </h2><br><p>  Nah, kita tahu bahwa Graal mengubah satu <code>byte[]</code> ke <code>byte[]</code> lain <code>byte[]</code> .  Sekarang mari kita bicara tentang teori dan struktur data yang dia gunakan, karena  mereka sedikit tidak biasa bahkan untuk kompiler. </p><br><p>  Pada dasarnya, kompiler menangani program Anda.  Untuk ini, program harus disajikan dalam bentuk semacam struktur data.  Salah satu opsi adalah bytecode dan daftar instruksi serupa, tetapi mereka tidak terlalu ekspresif. </p><br><p>  Sebagai gantinya, Graal menggunakan grafik untuk mewakili program Anda.  Jika kita mengambil operator penjumlahan sederhana yang merangkum dua variabel lokal, maka grafik akan menyertakan satu simpul untuk memuat setiap variabel, satu simpul untuk penjumlahan, dan dua tepi yang menunjukkan bahwa hasil memuat variabel lokal adalah input ke operator penjumlahan. </p><br><p>  Ini kadang-kadang disebut <em>grafik ketergantungan program</em> . </p><br><p>  Memiliki ekspresi bentuk <code>x + y</code> kami memperoleh node untuk variabel lokal <code>x</code> dan <code>y</code> , dan simpul dari jumlah mereka. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/data-graph.png" alt="Grafik aliran data"></p><br><p>  Tepi biru pada grafik ini menunjukkan arah aliran data dari membaca variabel lokal hingga menjumlahkan. </p><br><p>  Juga, kita dapat menggunakan edge untuk mencerminkan urutan eksekusi program.  Jika, alih-alih membaca variabel lokal, kami memanggil metode, maka kami harus mengingat urutan panggilan, dan kami tidak dapat mengatur ulang mereka (tanpa mengetahui tentang kode di dalamnya).  Untuk melakukan ini, ada tepi tambahan yang menentukan urutan ini.  Mereka ditampilkan dalam warna merah. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/control-graph.png" alt="Grafik aliran kontrol"></p><br><p>  Jadi, grafik Graal, pada kenyataannya, adalah dua grafik yang digabungkan menjadi satu.  Node-node itu sama, tetapi beberapa sisi mengindikasikan arah aliran data, sementara yang lain menunjukkan transfer kontrol di antara mereka. </p><br><p>  Untuk melihat grafik Graal, Anda dapat menggunakan alat yang disebut <em>IdealGraphVisualiser</em> atau <em>IGV</em> .  Startup dilakukan menggunakan perintah <code>mx igv</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/igv.png" alt="IdealGraphVisualiser"></p><br><p>  Setelah itu, jalankan JVM dengan flag <code>-Dgraal.Dump</code> . </p><br><p>  Aliran data sederhana dapat dilihat dengan menulis ekspresi sederhana. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average.png" alt="Aritmatika berarti igv"></p><br><p>  Anda dapat melihat bagaimana parameter <code>0</code> ( <code>P(0</code> ) dan <code>1</code> ( <code>P(1)</code> ) pergi ke input dari operasi penjumlahan, yang, bersama dengan konstanta <code>2</code> ( <code>C(2)</code> ) pergi ke input dari operasi pembagian, setelah itu nilai ini dikembalikan. </p><br><p>  Untuk melihat aliran data dan kontrol yang lebih kompleks, kami memperkenalkan siklus. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; values.length; n++) { sum += values[n]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum / values.length; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop.png" alt="Aritmatika berarti igv dengan siklus"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop-detail.png" alt="Medium Aritmatika Detail IGV dengan Loop"></p><br><p>  Dalam hal ini, kita memiliki simpul awal dan akhir loop, membaca elemen array, dan membaca panjang array.  Seperti sebelumnya, garis biru menunjukkan arah aliran data, dan garis merah menunjukkan aliran kontrol. </p><br><p>  Sekarang Anda dapat melihat mengapa struktur data ini kadang-kadang disebut <em>lautan node</em> atau <em>sup node</em> . </p><br><p>  Saya ingin mengatakan bahwa C2 menggunakan struktur data yang sangat mirip, dan, pada kenyataannya, C2 yang mempopulerkan gagasan penyusun <em>lautan simpul</em> , jadi ini bukan inovasi Graal. </p><br><p>  Saya tidak akan menunjukkan proses pembuatan grafik ini sampai bagian selanjutnya dari presentasi, tetapi ketika Graal menerima program dalam format ini, optimasi dan kompilasi dilakukan dengan memodifikasi struktur data ini.  Dan ini adalah salah satu alasan mengapa menulis kompiler JIT di Jawa masuk akal.  Java adalah bahasa berorientasi objek, dan grafik adalah kumpulan objek yang dihubungkan oleh tepi dalam bentuk tautan. </p><br><h2 id="ot-baytkoda-k-mashinnomu-kodu">  Dari bytecode ke kode mesin </h2><br><p>  Mari kita lihat bagaimana ide-ide ini terlihat dalam praktek, dan ikuti beberapa langkah dari proses kompilasi. </p><br><h3 id="poluchenie-baytkoda">  Mendapatkan Bytecode </h3><br><p>  Kompilasi dimulai dengan bytecode.  Mari kita kembali ke contoh penjumlahan kecil kami. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><p>  Kami akan menampilkan bytecode yang diterima pada input tepat sebelum dimulainya kompilasi. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(request.getMethod().getName() + <span class="hljs-string"><span class="hljs-string">" bytecode: "</span></span> + Arrays.toString(request.getMethod().getCode())); ... } }</code> </pre> <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">workload</span></span> bytecode: [<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>]</code> </pre> <br><p>  Seperti yang Anda lihat, input ke compiler adalah bytecode. </p><br><h3 id="parser-baytkoda-i-postroitel-grafa">  Bytecode parser dan pembuat grafik </h3><br><p>  <em>Builder</em> , yang menganggap array byte ini sebagai bytecode JVM, mengubahnya menjadi grafik Graal.  Ini adalah semacam <em>interpretasi abstrak</em> - pembangun menafsirkan bytecode Java, tetapi, alih-alih memberikan nilai, memanipulasi ujung bebas tepi dan secara bertahap menghubungkannya satu sama lain. </p><br><p>  Mari kita manfaatkan fakta bahwa Graal ditulis di Jawa dan lihat cara kerjanya menggunakan alat navigasi Eclipse.  Kita tahu bahwa dalam contoh kita ada simpul tambahan, jadi mari kita cari di mana simpul itu dibuat. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-1.png" alt="Addnode"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-2.png" alt="Cari Panggilan, AddNode.create"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-3.png" alt="Parser"></p><br><p>  Dapat dilihat bahwa mereka dibuat oleh parser bytecode, dan ini membawa kita ke <code>IADD</code> pemrosesan <code>IADD</code> ( <code>96</code> , yang kita lihat dalam array input yang dicetak). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">genArithmeticOp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaKind kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode)</span></span></span><span class="hljs-function"> </span></span>{ ValueNode y = frameState.pop(kind); ValueNode x = frameState.pop(kind); ValueNode v; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (opcode) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LADD: v = genIntegerAdd(x, y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; ... } frameState.push(kind, append(v)); }</code> </pre> <br><p>  Saya katakan di atas bahwa ini adalah interpretasi abstrak, karena  semua ini sangat mirip dengan penerjemah bytecode.  Jika itu adalah juru JVM nyata, maka itu akan mengambil dua nilai dari stack, melakukan penambahan, dan mengembalikan hasilnya.  Dalam hal ini, kami menghapus dua node dari stack, yang, ketika program dimulai, akan menjadi perhitungan, tambahkan, yang merupakan hasil dari penjumlahan, node baru untuk penambahan, dan letakkan di stack. </p><br><p>  Dengan demikian grafik dibangun Graal. </p><br><h3 id="poluchenie-mashinnogo-koda">  Mendapatkan kode mesin </h3><br><p>  Untuk mengonversi grafik Graal ke kode mesin, Anda perlu membuat byte untuk semua simpulnya.  Ini dilakukan secara terpisah untuk setiap node dengan memanggil metode <code>generate</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Generator gen)</span></span></span><span class="hljs-function"> </span></span>{ gen.emitAdd(a, b); }</code> </pre> <br><p>  Saya ulangi, di sini kita bekerja pada tingkat abstraksi yang sangat tinggi.  Kami memiliki kelas yang dengannya kami mengeluarkan instruksi kode mesin tanpa merinci cara kerjanya. </p><br><p>  <code>emitAdd</code>       ,          , ,  ,       .      . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>       ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Register dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> encode = prefixAndEncode(dst.encoding); emitByte(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); emitByte(<span class="hljs-number"><span class="hljs-number">0xC0</span></span> | encode); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emitByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ data.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/incl.png" alt=" incl  "></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-byte.png" alt=" "></p><br><p>  ,    ,     <code>ByteBuffer</code> ‚Äî    . </p><br><h3 id="vyhodnoy-mashinnyy-kod">    </h3><br><p>               ‚Äî       . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... System.err.println(method.getName() + <span class="hljs-string"><span class="hljs-string">" machine code: "</span></span> + Arrays.toString(result.getTargetCode())); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/machine-code.png" alt="  "></p><br><p>           .    HotSpot.     .     OpenJDK, , -,     JVM,      . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cd openjdk/hotspot/src/share/tools/hsdis <span class="hljs-variable"><span class="hljs-variable">$</span></span> curl <span class="hljs-literal"><span class="hljs-literal">-O</span></span> http://ftp.heanet.ie/mirrors/gnu/binutils/binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> tar <span class="hljs-literal"><span class="hljs-literal">-xzf</span></span> binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> make BINUTILS=binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span> ARCH=amd64 CFLAGS=<span class="hljs-literal"><span class="hljs-literal">-Wno</span></span><span class="hljs-literal"><span class="hljs-literal">-error</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> cp build/macosx<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>/hsdis<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>.dylib ../../../../../..</code> </pre> <br><p>      : <code>-XX:+UnlockDiagnosticVMOptions</code>  <code>-XX:+PrintAssembly</code> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockDiagnosticVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintAssembly \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo</code> </pre> <br><p>             . </p><br><pre> <code class="hljs perl">workload machine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] ... <span class="hljs-number"><span class="hljs-number">0x000000010f71cda0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda5</span></span>: add %edx,%esi ;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0xcba8da9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x0000000102b74006 ; {poll_return} 0x000000010f71cdaf: vzeroupper 0x000000010f71cdb2: retq</span></span></code> </pre> <br><p> .  ,           .    <code>generate</code>   ,         . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddNode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... gen.emitSub(op1, op2, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) ... <span class="hljs-comment"><span class="hljs-comment">// changed from emitAdd } }</span></span></code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-add.png" alt="  AddNode"></p><br><p>    ,  ,      ,      . </p><br><pre> <code class="hljs perl">workload mechine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] <span class="hljs-number"><span class="hljs-number">0x0000000107f451a0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a5</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edx</span></span></span><span class="hljs-function">,%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esi</span></span></span><span class="hljs-function"> </span></span>;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0x1db81a9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x000000010618d006 ; {poll_return} 0x0000000107f451af: vzeroupper 0x0000000107f451b2: retq</span></span></code> </pre> <br><p> ,   ? Graal     ;         ;       ;    .  ,       Graal. </p><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>] ‚Üí [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">...</span></span>]</code> </pre> <br><h2 id="optimizaciya">  </h2><br><p>  ,     ,        .       Graal  ,    . </p><br><p> <em> </em> ‚Äî          .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Graph graph)</span></span></span></span>; }</code> </pre> <br><h3 id="kanonikalizaciya-canonicalisation">  (canonicalisation) </h3><br><p> <em></em>      .       ,       ,      <em> </em> ( <em>constant folding</em> )   . </p><br><p>       ‚Äî       <code>canonical</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> ,  ,    ,      .                  ‚Äî    .    <code>-(-x)</code>  <code>x</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NegateNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> NegateNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((NegateNode) value).getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/negate-node.png" alt="findSynonym  NegateNode"></p><br><p>       Graal   . ,       . </p><br><p>           Java,       <code>canonical</code> . </p><br><h3 id="global-value-numbering"> Global value numbering </h3><br><p> <em>Global value numbering (GVN)</em> ‚Äî       .    <code>a + b</code>    ,   ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) * (a + b); }</code> </pre> <br><p> Graal     .   ‚Äî        .   GVN         .        <em>hash map</em>  ,  ,  . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn.png" alt="Global value numbering"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-1.png" alt=" global value numbering"></p><br><p>    ,   <em></em> ‚Äî  ,      ,     -  .  ,  ,  ,       ,      ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (getA() + getB()) * (getA() + getB()); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-2.png" alt=",     global value numbered"></p><br><h3 id="ukrupnenie-blokirovok-lock-coarsening">   (lock coarsening) </h3><br><p>     .               <em></em> . ,     ,      ,   <em></em> ( <em>inlining</em> ). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } }</code> </pre> <br><p>   ,   , , , . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; monitor.exit(); monitor.enter(); counter++; monitor.exit(); }</code> </pre> <br><p>                    .    <em> </em> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; counter++; monitor.exit(); }</code> </pre> <br><p>  Graal       <code>LockEliminationPhase</code> .   <code>run</code>      ,         .  ,        ,           . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StructuredGraph graph)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (monitorExitNode monitorExitNode : graph.getNodes(MonitorExitNode.class)) { FixedNode next = monitorExitNode.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> monitorEnterNode) { AccessmonitorNode monitorEnterNode = (AccessmonitorNode) next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (monitorEnterNode.object() ## monitorExitNode.object()) { monitorExitNode.remove(); monitorEnterNode.remove(); } } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination.png" alt=" "></p><br><p>            , , ,      ,          <code>2</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter += <span class="hljs-number"><span class="hljs-number">2</span></span>; monitor.exit(); }</code> </pre> <br><p>    IGV   .  ,   ,       \   ,  , ,        <code>2</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-before.png" alt="  "></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-after.png" alt="  "></p><br><h2 id="ne-zatronutye-prakticheskie-aspekty">     </h2><br><p>   Graal   ,  ,      ,          . , , ,          . </p><br><p>       Graal   ,  , ,         ,    ,  ,    . </p><br><h3 id="naznachenie-registrov">   </h3><br><p>    Graal      ,   ,  .        ?          ,      ? </p><br><p> ,  ,    .      .       ,      , ,   ,    .        ,  ,  ,             , ,  . </p><br><p>        <em> </em> ( <em>register allocation</em> ). Graal ,    JIT-,    ‚Äî <em>  </em> ( <em>linear scan algorithm</em> ). </p><br><h3 id="dispetcherizaciya">  </h3><br><p>    ,     ,   ,        -    ,         . </p><br><p> ,       ,   , ,         (..     ),        . ,    ,     . </p><br><p>    <em> </em> ( <em>graph scheduling</em> ).       .       ,          .       ,      , ,        . </p><br><p>                ,     . </p><br><h2 id="v-kakih-sluchayah-ispolzovat-graal">     Graal? </h2><br><p>        , ,   , Graal ‚Äî   ,       <em>Oracle</em> .      ,    Graal? </p><br><h3 id="kompilyator-nizhnego-urovnya-final-tier-compiler">    (final-tier compiler) </h3><br><p> C  JVMCI Graal    <em>  </em>  HotSpot ‚Äî ,     .     (   HotSpot)   Graal    ,    . </p><br><p> <em>Twitter</em>       Graal   ,    Java 9           .       : <code>-XX:+UseJVMCICompiler</code>  . </p><br><p>    JVMCI   ,      Graal   JVM.    (deploy) -  JVM,      Graal.      Java-,   Graal,       JVM. </p><br><p>  OpenJDK   <em>Metropolis</em>       JVM   Java. Graal        . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/metropolis.png" alt=" Metropolis"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://cr.openjdk.java.net/\~jrose/metropolis/Metropolis-Proposal.html</a> </p><br><h3 id="polzovatelskie-optimizacii">   </h3><br><p> Graal    .    Graal   JVM,     Graal   .           ,  Graal       . ,     -     ,    ,                 JNI. </p><br><p> Charles Nutter      <em>JRuby</em>         Graal       Ruby. ,        - . </p><br><h3 id="aot-ahead-of-time-kompilyaciya"> AOT (ahead-of-time)  </h3><br><p> Graal ‚Äî    Java. JVMCI  ,  Graal,    ,     ,    Graal     .  ,     Graal    ,     JIT-. </p><br><p>     JIT-  AOT-      ,  Graal     .       AOT   Graal. </p><br><p> Java 9              JIT-,     .        JVM,          . </p><br><p> AOT Java 9     Graal,       Linux.            ,  ,            . </p><br><p>    . <em>SubstrateVM</em> ‚Äî  AOT-,   Java-    JVM  . ,     - (statically linked)  .    JVM  ,         .     SubstrateVM  Graal.          ( <em>just-in-time</em> ) SubstrateVM, ,   Graal  .   Graal AOT-  . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> javac Hello.java <span class="hljs-variable"><span class="hljs-variable">$</span></span> graalvm<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span>/bin/native<span class="hljs-literal"><span class="hljs-literal">-image</span></span> Hello classlist: <span class="hljs-number"><span class="hljs-number">966.44</span></span> ms (cap): <span class="hljs-number"><span class="hljs-number">804.46</span></span> ms setup: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">514.31</span></span> ms (typeflow): <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">580.70</span></span> ms (objects): <span class="hljs-number"><span class="hljs-number">719.04</span></span> ms (features): <span class="hljs-number"><span class="hljs-number">16.27</span></span> ms analysis: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">422.58</span></span> ms universe: <span class="hljs-number"><span class="hljs-number">262.09</span></span> ms (parse): <span class="hljs-number"><span class="hljs-number">528.44</span></span> ms (inline): <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">259.94</span></span> ms (compile): <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">716.20</span></span> ms compile: <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">817.97</span></span> ms image: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">070.29</span></span> ms debuginfo: <span class="hljs-number"><span class="hljs-number">672.64</span></span> ms write: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">797.45</span></span> ms [<span class="hljs-type"><span class="hljs-type">total</span></span>]: <span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">907.56</span></span> ms <span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-literal"><span class="hljs-literal">-lh</span></span> hello <span class="hljs-literal"><span class="hljs-literal">-rwxr</span></span><span class="hljs-literal"><span class="hljs-literal">-xr</span></span><span class="hljs-literal"><span class="hljs-literal">-x</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> chrisseaton staff <span class="hljs-number"><span class="hljs-number">6.6</span></span>M <span class="hljs-number"><span class="hljs-number">4</span></span> Oct <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> hello <span class="hljs-variable"><span class="hljs-variable">$</span></span> file ./hello ./hellojava: Mach<span class="hljs-literal"><span class="hljs-literal">-O</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-bit</span></span> executable x86_64 <span class="hljs-variable"><span class="hljs-variable">$</span></span> time ./hello Hello! real <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">010</span></span>s user <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s</code> </pre> <br><h3 id="truffle"> Truffle </h3><br><p>     Graal      <em>Truffle</em> . Truffle ‚Äî         JVM. </p><br><p>  ,   JVM,  ,   JIT-   (,    ,   ,  JIT- JVM    ,        ). Truffle    ‚Äî       ,   ,  Truffle, ,              <em> </em> ( <em>partial evaluation</em> ). </p><br><p>         ,             <em> </em> ( <em>inlining</em> )  <em> </em> ( <em>constant folding</em> )      . Graal       ,  Truffle       . </p><br><p>       Graal ‚Äî  Truffle.       Ruby,   <em>TruffleRuby</em>    Truffle , , Graal. TruffleRuby ‚Äî     Ruby,   10   , ,  ,        . </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/graalvm/truffleruby</a> </p><br><h2 id="vyvody">  Kesimpulan </h2><br><p>  ,      ,   ,   JIT- Java         . JIT-   ,          , , -           . ,  ,   .   JIT-    ,   <code>byte[]</code>  JVM  <code>byte[]</code>  . </p><br><p>  ,       Java.           ,   C++. </p><br><p> Java- Graal   - .   ,    ,            . </p><br><p>          .        ,        Eclipse     .           (definitions),     ..    . </p><br><p>          JIT      JIT- JVM,   <em>JITWatch</em> ,   ,        Graal     ,   . ,   ,  -       ,     Graal     JVM.         IDE,       <em>hello-world</em> . </p><br><p>         SubstrateVM  Truffle,   Graal,     ,     Java  .     ,   Graal    Java.  ,    ,   -  <em>LLVM</em> ,    , ,   ,     . </p><br><p> , ,       Graal      JVM.  Karena JVMCI   Java 9, Graal      ,  ,    Java-. </p><br><p> Graal ‚Äî        .    ,      Graal.    ,      ! </p><br><hr><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">More information about TruffleRuby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Low Overhead Polling For Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Top 10 Things To Do With GraalVM</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ruby Objects as C Structs and Vice Versa</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Understanding How Graal Works ‚Äî a Java JIT Compiler Written in Java</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Flip-Flops ‚Äî the 1-in-10-million operator</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Deoptimizing Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Very High Performance C Extensions For JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Optimising Small Data Structures in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pushing Pixels with JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Tracing With Zero Overhead in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">How Method Dispatch Works in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">A Truffle/Graal High Performance Backend for JRuby</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id419637/">https://habr.com/ru/post/id419637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id419623/index.html">"SHE": bagaimana kami menghasilkan gambar kecerdasan buatan</a></li>
<li><a href="../id419625/index.html">Ikhtisar fitur PHP7 favorit saya</a></li>
<li><a href="../id419627/index.html">Kami mencari pembicara di Moscow Data Science Major</a></li>
<li><a href="../id419633/index.html">Sekarang semua daftar sertifikat root utama dipercaya oleh Let's Encrypt</a></li>
<li><a href="../id419635/index.html">Rilis versi stabil dari Dart 2.0 dan Platform Web Dart</a></li>
<li><a href="../id419641/index.html">Membuat C # AI Sederhana di Unity</a></li>
<li><a href="../id419643/index.html">Konferensi Rekayasa Perangkat Lunak EPAM Minsk: Wujudkan</a></li>
<li><a href="../id419647/index.html">Seminar ‚ÄúBlack Friday dalam e-commerce. Rahasia Bertahan Hidup, 16 Agustus, Moskow</a></li>
<li><a href="../id419649/index.html">Sedikit tentang kucing, atau yang CAT kami pilih untuk sinkronisasi podcast</a></li>
<li><a href="../id419651/index.html">Baik GA maupun YM. Bagaimana kami membuat clickstream kami sendiri</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>