<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚯 💅🏾 🔣 Obtener Spring Bean del contexto de aplicación de terceros correctamente 📴 🥠 🔵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Buenas tardes, Khabrovites! 

 En este artículo, propongo discutir uno de los problemas que a menudo se encuentran en los proyectos que usan el marco ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Obtener Spring Bean del contexto de aplicación de terceros correctamente</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472716/">  Buenas tardes, Khabrovites! <br><br>  En este artículo, propongo discutir uno de los problemas que a menudo se encuentran en los proyectos que usan el marco Spring.  El problema descrito en este artículo surge debido a uno de los errores típicos en las configuraciones de resorte.  No es necesario intentar cometer tal error en la configuración y, por lo tanto, este error es bastante común. <br><a name="habracut"></a><br><h3>  Planteamiento del problema </h3><br>  El problema presentado en este artículo está relacionado con la configuración incorrecta de beans en el contexto de aplicación actual, que se toman de otros contextos de aplicación.  Tal problema puede surgir en una aplicación industrial grande, que consiste en muchos frascos, cada uno de los cuales tiene su propio contexto de aplicación que contiene frijoles de primavera. <br><br>  Como resultado de una configuración incorrecta, obtenemos varias copias de beans con un estado impredecible, incluso si tienen el alcance singleton.  Además, la copia irreflexiva de beans puede conducir al hecho de que se crearán más de una docena de copias de todos los beans de cualquier jar en la aplicación, que está plagada de problemas de rendimiento de la aplicación y un aumento en el tiempo de inicio de la aplicación. <br><br><h3>  Un ejemplo de uso de un bean desde un contexto de aplicación externa en el actual </h3><br>  Imagine que estamos desarrollando uno de los módulos de aplicación, en el que hay muchos otros módulos, y que cada uno de ellos tiene su propio contexto de aplicación.  Dicha aplicación debe tener un módulo en el que se creen instancias del contexto de aplicación de todos los módulos de aplicación. <br><br><img src="https://habrastorage.org/webt/cj/rv/up/cjrvupro3dfswnrsg1uxgxfma1a.png" height="300" width="300"><br><br>  Supongamos que, en el contexto de la aplicación de uno de los módulos externos, se crea una instancia del bean de la clase NumberGenerator, que queremos obtener en nuestro módulo.  Supongamos también que la clase NumberGenerator se encuentra en el paquete org.example.kruchon.generators, que almacena algunas clases que generan valores. <br><br><img src="https://habrastorage.org/webt/jx/s5/nx/jxs5nx1jehc6xiq_xzgxym8vxni.png" height="400" width="400"><br><br>  Este bean tiene un estado: el campo int count. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.example.kruchon.calculators <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NumberGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count++; } }</code> </pre> <br>  Se crea una instancia de este bean en la subconfiguración GeneratorsConfiguration. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GeneratorsConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> NumberGenerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numberGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NumberGenerator(); } ... }</code> </pre> <br>  También en el contexto de la aplicación externa, hay una configuración principal en la que se importan todas las subconfiguraciones del módulo externo. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>({GeneratorsConfiguration.class, ...}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExternalContextConfiguration</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br>  Ahora daré algunos ejemplos en los que el bean singleton de la clase NumberGenerator está configurado incorrectamente en la configuración del contexto de la aplicación actual. <br><br><h3>  Configuración incorrecta 1. Importar la configuración principal del contexto de la aplicación externa </h3><br>  La peor decisión que podría ser. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>(ExternalContextConfiguration.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentContextConfiguration</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><ul><li>  La aplicación vuelve a crear todas las instancias de beans desde el contexto de la aplicación externa.  En otras palabras, se crea una copia de todo el módulo externo, lo que afecta el consumo de memoria, el rendimiento y el tiempo de inicio de la aplicación. </li><li>  Obtenga una copia de NumberGenerator en el contexto actual de la aplicación.  Una copia de NumberGenerator tiene su propio valor para el campo de recuento, inconsistente con la primera instancia de NumberGenerator.  Esta inconsistencia da lugar a errores difíciles de depurar en la aplicación. </li></ul><br><h3>  Configuración incorrecta 2. Subconfiguración de importación del contexto de aplicación externa </h3><br>  La segunda opción es incorrecta y a menudo se encuentra en la práctica. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>(GeneratorsConfiguration.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentContextConfiguration</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br>  En esta realización, ya no se crea una copia completa del módulo externo, sin embargo, nuevamente obtenemos el segundo bean de la clase NumberGenerator. <br><br><h3>  Configuración incorrecta 3. Busque la inyección directamente en el bean, donde queremos usar NumberGenerator </h3><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> NumberGenerator numberGenerator; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ApplicationContext externalApplicationContext = getExternalContext(); numberGenerator = externalApplicationContext.getBean(NumberGenerator.class); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Order </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Order order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Order(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id = numberGenerator.next(); order.setId(id); order.setCreatedDate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> order; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ApplicationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getExternalContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ ... } }</code> </pre> <br>  En este método, la duplicación de un bean que tiene el alcance singleton puede considerarse resuelta.  De hecho, ahora reutilizamos el bean de otro contexto de aplicación y no lo recreamos. <br><br>  Pero de esta manera: <br><br><ol><li>  Complica la clase desarrollada y sus pruebas unitarias. </li><li>  Excluye la implementación automática del bean de la clase NumberGenerator en los beans del módulo actual. </li><li>  No es habitual usar lookUp para inyectar un bean singleton en casos generales. </li></ol><br>  Por lo tanto, dicha solución es más una solución torpe que una solución racional a un problema. <br><br>  Considere cómo configurar correctamente un bean desde un contexto de aplicación externa. <br><br><h3>  Solución 1. Obtenga el bean desde el contexto de la aplicación externa en la configuración </h3><br>  Este método es muy similar al 3er ejemplo de una configuración incorrecta con una diferencia: obtenemos un bean haciendo una búsqueda desde el contexto externo en la configuración, y no directamente en el bean. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentContextConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> NumberGenerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numberGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ApplicationContext externalApplicationContext = getExternalContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> externalApplicationContext.getBean(NumberGenerator.class); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ApplicationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getExternalContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ ... } }</code> </pre> <br>  Ahora podemos incrustar automáticamente este bean en beans desde nuestro propio módulo. <br><br><h3>  Solución 2. Haga que el contexto de la aplicación externa sea primario </h3><br>  Es probable que la funcionalidad del módulo actual amplíe la funcionalidad del externo.  Puede haber un caso cuando en uno de los módulos externos se desarrollan beans auxiliares comunes a toda la aplicación, y en otros módulos se usan estos beans.  En este caso, es lógico indicar que el módulo externo es padre del anterior.  En este caso, todo el bean del módulo principal se puede usar en el módulo actual, y luego el <i>bean del módulo principal no necesita configurarse</i> en la configuración del contexto de la aplicación actual. <br><br>  Es posible especificar una relación principal al crear una instancia de contexto utilizando el constructor con el parámetro principal: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AbstractApplicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ApplicationContext parent)</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br>  O usa el setter: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setParent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ApplicationContext parent)</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br>  Si el contexto de la aplicación se declara en xml, podemos usar el constructor: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClassPathXmlApplicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] configLocations, ApplicationContext parent)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BeansException </span></span>{ ... }</code> </pre> <br><h3>  Conclusión </h3><br>  Por lo tanto, tenga cuidado al configurar beans de primavera, siga las recomendaciones dadas en el artículo e intente no copiar los beans que tienen alcance singleton.  Estaré encantado de responder a sus preguntas! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472716/">https://habr.com/ru/post/472716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472690/index.html">Novedades de Zabbix 4.4</a></li>
<li><a href="../472694/index.html">Más que Ceph: MCS Block Cloud Storage</a></li>
<li><a href="../472702/index.html">JH Rainwater "Cómo pastar gatos": razas de programadores y características de su cría</a></li>
<li><a href="../472708/index.html">Imperva reveló detalles técnicos del hack de Cloud WAF</a></li>
<li><a href="../472714/index.html">Dónde buscar trabajadores y no enamorarse del trabajador front-end: Telegram, Slack y no solo</a></li>
<li><a href="../472720/index.html">ERP no funciona ... ¿Cuál es la alternativa? o justo a tiempo. Para Rusia?</a></li>
<li><a href="../472724/index.html">Introducción a skydive.network</a></li>
<li><a href="../472726/index.html">Mejora de la inmunidad al ruido Arduino</a></li>
<li><a href="../472730/index.html">Ivanovo! Mitap en honor del décimo aniversario de Node.js</a></li>
<li><a href="../472736/index.html">Webinar abierto "Introducción a la automatización de pruebas de aplicaciones móviles en Selenium y Appium"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>