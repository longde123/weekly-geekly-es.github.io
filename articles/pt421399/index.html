<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§öüèº ü§¶üèæ üì± An√°lise do Backdoor do Outlook do Cybergroup Turla ü§ß üçÅ üêÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Turla (Snake, Uroboros) √© um grupo de espionagem cibern√©tica que ganhou fama em 2008 ap√≥s invadir objetos protegidos, incluindo a rede do Comando Cent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise do Backdoor do Outlook do Cybergroup Turla</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/421399/"><p>  Turla (Snake, Uroboros) √© um grupo de espionagem cibern√©tica que ganhou fama em 2008 ap√≥s invadir objetos protegidos, incluindo a rede do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Comando Central das For√ßas Armadas dos EUA</a> .  Desde ent√£o, ele √© especialista em ataques a instala√ß√µes militares e ag√™ncias diplom√°ticas em todo o mundo.  V√≠timas famosas incluem o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Minist√©rio das Rela√ß√µes Exteriores da Finl√¢ndia</a> em 2013, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">empresa de defesa su√≠√ßa RUAG</a> de 2014 a 2016.  e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o governo alem√£o</a> no final de 2017 - in√≠cio de 2018. </p><br><p>  Ap√≥s o √∫ltimo incidente, v√°rios meios de comunica√ß√£o publicaram informa√ß√µes sobre os m√©todos dos invasores - usando anexos de email para controlar malware e transferir dados roubados do sistema.  No entanto, nenhuma informa√ß√£o t√©cnica foi fornecida sobre o backdoor.  Neste relat√≥rio, publicamos a an√°lise do backdoor Turla, que foi gerenciado usando anexos PDF em email. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l_/db/ws/l_dbws8skuoavwqn1vorwdhobgo.jpeg"></div><a name="habracut"></a><br><p>  Segundo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relatos da m√≠dia</a> , v√°rios computadores do Minist√©rio das Rela√ß√µes Exteriores da Alemanha foram infectados com uma porta dos fundos.  Aparentemente, o ataque come√ßou em 2016 e foi descoberto pelos servi√ßos de seguran√ßa no final de 2017. Inicialmente, os atacantes comprometeram a Escola Superior de Administra√ß√£o P√∫blica Federal (Hochschule des Bundes), ap√≥s o que se mudaram para dentro da sua rede at√© obterem acesso √† rede do Minist√©rio das Rela√ß√µes Exteriores em mar√ßo de 2017. .  Os operadores da Turla tiveram acesso a alguns dados confidenciais (por exemplo, o e-mail dos funcion√°rios do Minist√©rio das Rela√ß√µes Exteriores da Alemanha) por cerca de um ano. </p><br><p>  Nossa investiga√ß√£o tamb√©m revela que esse malware direcionado ao Microsoft Outlook foi usado contra v√°rios departamentos pol√≠ticos e militares.  Garantimos que os minist√©rios das Rela√ß√µes Exteriores dos outros dois pa√≠ses europeus e o principal contratado de defesa tamb√©m estivessem comprometidos.  Nossa investiga√ß√£o nos permitiu estabelecer dezenas de endere√ßos de e-mail registrados pelos operadores da Turla para esta campanha e usados ‚Äã‚Äãpara obter dados de v√≠timas exfiltradas. </p><br><h2>  1. Pontos-chave </h2><br><p>  O backdoor do Outlook do Grupo Turla tem duas fun√ß√µes. </p><br><p>  Em primeiro lugar, √© o roubo de cartas enviadas que s√£o encaminhadas ao atacante.  Afeta principalmente o Microsoft Outlook, mas tamb√©m √© relevante para o The Bat!, Popular na Europa Oriental. </p><br><p>  Em segundo lugar, o uso de letras como uma camada de transporte de seu protocolo C&amp;C.  Os arquivos solicitados atrav√©s do comando backdoor s√£o filtrados em documentos PDF criados especialmente como um anexo √†s cartas.  Os comandos de backdoor tamb√©m s√£o enviados em anexos PDF.  Isso permite sigilo.  √â importante observar que os invasores n√£o exploram nenhuma vulnerabilidade nos leitores de PDF ou no Microsoft Outlook.  Software malicioso pode decodificar dados de documentos PDF e interpret√°-los como comandos. </p><br><p>  Os objetivos da campanha s√£o t√≠picos de Turla.  Identificamos v√°rias ag√™ncias governamentais europeias e empresas de defesa comprometidas por esse backdoor.  √â prov√°vel que os invasores o usem para garantir a persist√™ncia em redes de acesso restrito, onde firewalls bem configurados ou outras ferramentas de seguran√ßa de rede bloqueiam efetivamente as comunica√ß√µes tradicionais com servidores C&amp;C via HTTP (S).  A figura abaixo lista as linhas de c√≥digo backdoor que mencionam alguns dom√≠nios de n√≠vel superior do governo.  mfa √© o dom√≠nio do Minist√©rio das Rela√ß√µes Exteriores, .gouv √© um subdom√≠nio do governo franc√™s (.gouv.fr), ocse √© a Organiza√ß√£o para Seguran√ßa e Coopera√ß√£o na Europa. </p><br><img src="https://habrastorage.org/webt/xt/ix/e9/xtixe9vxop-os9ktobaea5qqdbu.png"><br><p>  <i>Figura 1. Dom√≠nios associados aos servi√ßos p√∫blicos encontrados no c√≥digo Malvari</i> </p><br><p>  Com base nos dados de an√°lise e telemetria, descobrimos que esse backdoor est√° distribu√≠do em estado selvagem desde pelo menos 2013.  Como sempre com Turla, n√£o podemos focar nos carimbos de data e hora da compila√ß√£o, pois eles geralmente s√£o falsificados.  No entanto, acreditamos que as primeiras vers√µes foram compiladas antes de 2013, pois a vers√£o deste ano j√° estava bastante avan√ßada.  Depois disso, encontramos uma vers√£o mais semelhante √† base, cuja compila√ß√£o foi datada de 2009.  Determinar a data exata do lan√ßamento ainda n√£o √© poss√≠vel.  A linha do tempo abaixo √© baseada em nossa telemetria e dados de c√≥digo aberto: </p><br><p>  <b>2009</b> : carimbo de data / hora da compila√ß√£o (pode ser falso) da vers√£o base do backdoor do Outlook.  Apenas instant√¢neo do conte√∫do do email. <br>  <b>2013</b> : Melhorado: o backdoor pode executar comandos.  Eles s√£o enviados por email no formato XML. <br>  <b>2013</b> : a √∫ltima vers√£o conhecida direcionada ao The Bat! .. <br>  <b>2016</b> : Melhorado: as equipes s√£o enviadas como anexos em documentos PDF criados especialmente. <br>  <b>2017</b> : Melhorado: um backdoor pode criar documentos PDF para filtrar dados por um invasor. <br>  <b>Mar√ßo de 2018</b> : comprometimento de relat√≥rios da rede do governo alem√£o. <br>  <b>Abril de 2018</b> : Aprimorado: o Backdoor pode executar comandos do PowerShell usando o Empire PSInject. </p><br><h2>  2. Arquitetura global </h2><br><p>  Nas vers√µes recentes, o backdoor √© uma DLL aut√¥noma, na qual h√° c√≥digo para auto-instala√ß√£o e intera√ß√£o com os clientes de email Outlook e The Bat !, mesmo que apenas a instala√ß√£o do Outlook seja implementada.  Pode ser facilmente descartado por qualquer componente Turla que permita executar processos adicionais. </p><br><p>  Nesta se√ß√£o, nossa an√°lise √© baseada em uma amostra divulgada no primeiro semestre de 2017.  Informa√ß√µes sobre amostras mais antigas ou mais recentes podem ser inclu√≠das. </p><br><h3>  2.1  Instala√ß√£o </h3><br><p>  Para estabelecer um backdoor, os invasores exportam uma DLL chamada Install ou a registram no regsvr32.exe.  O argumento √© o cliente de email de destino.  A figura abaixo mostra os valores poss√≠veis.  Nas vers√µes mais recentes, apenas a instala√ß√£o do Outlook √© implementada. </p><br><img src="https://habrastorage.org/webt/9g/8r/qm/9g8rqm3z7keq_phkhvlztwzwtyo.png"><br><p>  <i>Figura 2. Poss√≠veis argumentos de instala√ß√£o</i> </p><br><p>  Como n√£o h√° caminho codificado, o arquivo DLL pode estar localizado em qualquer lugar do disco. </p><br><h4>  2.1.1  Microsoft Outlook </h4><br><p>  Os desenvolvedores do Turla confiam no seq√ºestro de objetos COM para garantir a persist√™ncia do malware.  Este √© um m√©todo bem conhecido usado na natureza por muitos anos, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">inclusive pelo grupo Turla</a> .  A ess√™ncia do m√©todo √© redirecionar o objeto COM usado pelo aplicativo de destino, modificando a entrada CLSID correspondente no registro do Windows. </p><br><p>  No nosso caso, as seguintes altera√ß√µes foram feitas no registro do Windows: </p><br><pre><code class="hljs powershell">HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>} = Mail Plugin HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}\InprocServer32 = [<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-type"><span class="hljs-type">to</span></span> <span class="hljs-type"><span class="hljs-type">the</span></span> <span class="hljs-type"><span class="hljs-type">backdoor</span></span> <span class="hljs-type"><span class="hljs-type">DLL</span></span>] HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}\InprocServer32\ThreadingModel = Apartment HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">84</span></span>DA0A92<span class="hljs-literal"><span class="hljs-literal">-25E0</span></span><span class="hljs-literal"><span class="hljs-literal">-11D3</span></span><span class="hljs-literal"><span class="hljs-literal">-B9F7</span></span><span class="hljs-literal"><span class="hljs-literal">-00C04F4C8F5D</span></span>}\TreatAs = {<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}</code> </pre> <br><p>  <code>{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D}</code> - capturado CLSID.  Corresponde ao Gerenciador de Protocolos do Outlook e, em teoria, carrega a DLL leg√≠tima do Outlook <code>OLMAPI32.DLL</code> .  <code>{49CBB1C7-97D1-485A-9EC1-A26065633066}</code> n√£o <code>{49CBB1C7-97D1-485A-9EC1-A26065633066}</code> associado a nenhum software conhecido.  Este CLSID √© arbitr√°rio e √© usado apenas como um espa√ßo reservado para o redirecionamento COM. </p><br><p>  Quando a modifica√ß√£o for conclu√≠da, a DLL de backdoor ser√° carregada sempre que o Outlook carregar seu objeto COM.  De acordo com nossas observa√ß√µes, isso acontece durante a inicializa√ß√£o do Outlook. </p><br><p>  O redirecionamento COM n√£o requer direitos de administrador, porque se aplica apenas ao usu√°rio atual.  Existem medidas de prote√ß√£o para impedir redirecionamentos maliciosos.  De acordo com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MSDN</a> : "No Windows Vista e Windows Server 2008, se o n√≠vel de integridade do processo estiver acima da m√©dia, o tempo de execu√ß√£o COM ignora a configura√ß√£o COM do usu√°rio e acessa apenas a configura√ß√£o COM para cada m√°quina". </p><br><p>  O processo do Outlook √© executado com integridade m√©dia, como mostra a imagem abaixo.  Portanto, ele n√£o est√° protegido contra o encaminhamento de COM para cada usu√°rio. </p><br><img src="https://habrastorage.org/webt/q4/uq/zt/q4uqzt_g3c6vgonoluf_7ttrqpw.png"><br><p>  <i>Figura 3. N√≠vel de integridade do processo do Outlook</i> </p><br><p>  Por fim, o uso da captura de objetos COM permite que o backdoor evite a detec√ß√£o, pois o caminho para o backdoor ( <code>C:\Users\User\Documents\mapid.tlb</code> em nosso exemplo) n√£o aparece na lista de plug-ins, como mostra a figura a seguir. </p><br><img src="https://habrastorage.org/webt/4l/cj/s3/4lcjs3tai1gd5gopfekwd7skjra.png"><br><p>  <i>Figura 4. Lista de plugins do Outlook - mapid.tlb n√£o aparece</i> </p><br><p>  Mesmo que o programa malicioso n√£o apare√ßa na lista de complementos, a API padr√£o da Microsoft - MAPI (Messaging Application Programming Interface) √© usada para interagir com o Outlook. </p><br><h4>  2.1.2  O morcego! </h4><br><p>  Conforme especificado na cronologia, as vers√µes mais recentes do backdoor n√£o incluem mais o c√≥digo de registro para o plug-in The Bat! .. No entanto, todo o c√≥digo para gerenciar caixas de correio e mensagens ainda existe.  Se necess√°rio, pode ser configurado manualmente. </p><br><p>  Para se registrar como um plugin para The Bat!  o malware modificou o <code>%appdata%\The Bat!\Mail\TBPlugin.INI</code> .  Esta √© uma maneira leg√≠tima de registrar um plug-in para o The Bat!, Alguns plug-ins (por exemplo, antispam) tamb√©m o usam. </p><br><p>  Depois de se registrar toda vez que voc√™ inicia o The Bat!  a DLL de backdoor √© chamada.  A figura abaixo mostra como a DLL implementa a exporta√ß√£o necess√°ria para plug-ins. </p><br><img src="https://habrastorage.org/webt/xq/x7/zs/xqx7zsv5pwjjmhonegcsmpmnwx0.png"><br><p>  <i>Figura 5. Exporta√ß√£o padr√£o para o plug-in The Bat!</i> </p><br><h3>  2.2  Intera√ß√£o com o cliente de email </h3><br><p>  A intera√ß√£o com o cliente de email depende do objetivo. </p><br><h4>  2.2.1  Microsoft Outlook </h4><br><p>  A Microsoft oferece suporte √† MAPI (Messaging Application Programming Interface), que permite que os aplicativos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">interajam com o Outlook</a> .  O backdoor Turla usa essa API para acessar e gerenciar as caixas de correio de um usu√°rio / usu√°rios de um sistema comprometido. </p><br><p>  Primeiro, o backdoor se conecta ao sistema de mensagens usando o MAPILogonEx, conforme mostrado na figura. </p><br><img src="https://habrastorage.org/webt/nf/fp/u1/nffpu1duhw9u7rmxytdm1chwpey.png"><br><p>  <i>Figura 6. Logon MAPI</i> </p><br><p>  O segundo par√¢metro (lpszProfileName) est√° vazio, o sinalizador <code>MAPI_USE_DEFAULT</code> est√° <code>MAPI_USE_DEFAULT</code> .  De acordo com a documenta√ß√£o: "O subsistema de mensagens deve substituir o nome do perfil padr√£o para o par√¢metro lpszProfileName. O sinalizador MAPI_EXPLICIT_PROFILE √© ignorado, a menos que lpszProfileName seja NULL ou vazio." </p><br><p>  Por outro lado, o sinalizador <code>MAPI_NEW_SESSION</code> n√£o <code>MAPI_NEW_SESSION</code> definido.  De acordo com a documenta√ß√£o: "O par√¢metro <code>lpszProfileName</code> ignorado se uma sess√£o anterior chamada MapiLogonEx existir com o sinalizador <code>MAPI_ALLOW_OTHERS</code> e se o sinalizador <code>MAPI_NEW_SESSION</code> n√£o <code>MAPI_NEW_SESSION</code> definido." </p><br><p>  Em nossa opini√£o, o Outlook abre uma sess√£o padr√£o com o sinalizador <code>MAPI_ALLOW_OTHERS</code> .  Assim, o backdoor usar√° uma sess√£o aberta anteriormente para obter acesso ao perfil padr√£o da caixa de correio.  Isso explica a falta de uma solicita√ß√£o de nome de usu√°rio e senha ao inicializar o plug-in backdoor. </p><br><p>  Feito isso, o backdoor obter√° acesso √† caixa de correio e poder√° gerenci√°-la facilmente usando outras fun√ß√µes MAPI.  Ele ir√° percorrer v√°rios armazenamentos de mensagens, analisar letras e adicionar retornos de chamada √†s mensagens recebidas e enviadas.  O arquivo de log exibe este processo (nome de usu√°rio e endere√ßo alterados): </p><br><pre> <code class="hljs pgsql">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; ========= Analyzing msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Service <span class="hljs-type"><span class="hljs-type">name</span></span>:MSUPST MS Pst <span class="hljs-type"><span class="hljs-type">path</span></span>:C:\Users\[username]\Documents\Outlook Files\[email address].pst Wait main <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> count = <span class="hljs-number"><span class="hljs-number">46</span></span> This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> message store PUSH store <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> list &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _____________ FOLDERS _____________ Setting sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> folders <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> stores. ========Process msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Account: [email address] Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Outbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store. Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Inbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store.</code> </pre> <br><p>  Ele configura um retorno de chamada em cada caixa de entrada e caixa de <code>HrAllocAdviseSink</code> usando a fun√ß√£o <code>HrAllocAdviseSink</code> , conforme mostrado. </p><br><img src="https://habrastorage.org/webt/ud/df/js/uddfjs5ub7qj9n3gxlxslirppcq.png"><br><p>  <i>Figura 7. Registrando um retorno de chamada na caixa de sa√≠da</i> </p><br><p>  <b>2.2.1.1</b>  <b>Caixa de entrada de retorno de chamada</b> </p><br><p>  O retorno de chamada na caixa de entrada registra os metadados da mensagem recebida, incluindo endere√ßos de remetente e destinat√°rio, nomes de assunto e anexo.  Exemplo abaixo (ortografia do desenvolvedor salva): </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">RECIVE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt;{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: sender@example.com To: receiver@example.net Cc: Bcc: Subj: Mail subject Att: an_attachment.pdf }</code> </pre> <br><p>  Em seguida, ele analisa a carta e os anexos sobre o assunto das equipes dos atacantes.  Esta fun√ß√£o √© descrita na se√ß√£o 2.3. </p><br><p>  Por fim, ele intercepta as notifica√ß√µes de falha na entrega verificando as mensagens recebidas com o endere√ßo de email da operadora.  Qualquer carta contendo o endere√ßo do operador ser√° rejeitada.  Isso pode causar problemas se a v√≠tima suspeitar que algo est√° errado e entrar em contato com o servi√ßo de suporte sem ver as respostas. </p><br><p>  <b>2.2.1.2</b>  <b>Retorno de chamada na caixa de sa√≠da</b> </p><br><p>  Como na caixa de entrada, a caixa de sa√≠da registra os metadados de todos os emails enviados.  O seguinte registro √© gerado (endere√ßo do operador alterado): </p><br><pre> <code class="hljs css">21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SEND</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: To: recipient@example.com Cc: Bcc: Subj: My title Att: [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"last_presentation.pdf"</span></span> } 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Sending</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ENTRYID</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Message ENTRYID]</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">was</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">send</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">To</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[redacted]</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">gmx</span></span>[.]<span class="hljs-keyword"><span class="hljs-keyword">com</span></span> From: Subj: My title <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Set last time. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Spawned thread for cleaning up outgoing messages (id <span class="hljs-number"><span class="hljs-number">2848</span></span>) <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Ending work, client: Outlook <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of messages to remove: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Message ENTRYID: [Message ENTRYID] <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> DeleteMessages executed successfully. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of not removed messages: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Voc√™ pode perceber que encaminha todas as mensagens <code>[‚Ä¶]@gmx[.]com</code> para o endere√ßo dos atacantes, <code>[‚Ä¶]@gmx[.]com</code> .  GMX - um popular servi√ßo de e-mail gratuito;  os atacantes provavelmente o escolheram, porque as organiza√ß√µes geralmente n√£o bloqueiam o dom√≠nio gmx.com. </p><br><p>  Esse endere√ßo de e-mail est√° codificado na amostra que estudamos, como mostra a imagem abaixo.  No entanto, ele pode ser atualizado usando uma das fun√ß√µes de backdoor.  Os invasores parecem estar registrando pelo menos um endere√ßo de email para cada destino <br>  organiza√ß√µes que usam o formato <code>firstname.lastname@gmx[.]com</code> com o nome do funcion√°rio real.  Isso evita a detec√ß√£o, pois geralmente √© dif√≠cil distinguir esse endere√ßo da caixa de correio pessoal de um funcion√°rio real.  No momento da an√°lise da amostra em junho de 2018, o endere√ßo n√£o estava dispon√≠vel. </p><br><img src="https://habrastorage.org/webt/9c/tr/-d/9ctr-dcusp0p35kcuhiqw4pypns.png"><br><p>  <i>Figura 8. Endere√ßo embutido dos operadores</i> </p><br><p>  O backdoor envia relat√≥rios para o endere√ßo dos operadores em determinados intervalos.  O relat√≥rio inclui identificadores exclusivos, incluindo o endere√ßo MAC, o arquivo de log completo e os resultados do comando, se houver.  Em seguida, criptografa os dados usando MISTY1, conforme descrito mais adiante na se√ß√£o 2.3.2.2, e cria um arquivo PDF v√°lido com conte√∫do criptografado.  Antes desse blob de dados criptografados, o documento cont√©m uma imagem em branco 1x1 em jpeg, codificada em um programa malicioso.  Isso permite criar um PDF v√°lido que, quando aberto, exibe apenas uma p√°gina em branco. </p><br><p>  Por fim, o backdoor anexa o PDF e envia um email aos atacantes.  A figura abaixo √© um exemplo de arquivo PDF criado por um backdoor. </p><br><img src="https://habrastorage.org/webt/d4/6f/yx/d46fyxd9n7e-ziu9jwjxdtedqke.png"><br><p>  <i>Figura 9. In√≠cio de um documento PDF criado por um backdoor para filtrar dados</i> </p><br><p>  O relat√≥rio √© enviado usando a fun√ß√£o de retorno de chamada na caixa de sa√≠da.  Isso significa que a carta sair√° ao mesmo tempo que o envio de mensagens leg√≠timas do usu√°rio.  O backdoor n√£o pode enviar cartas com dados roubados em um momento incomum para o usu√°rio e, portanto, evita a detec√ß√£o.  Gra√ßas √† furtividade, esse mecanismo de controle e controle √© muito dif√≠cil de detectar na natureza. </p><br><h4>  2.2.2  Disfar√ßando o comportamento malicioso do usu√°rio </h4><br><p>  Como o backdoor age quando o usu√°rio trabalha com o computador e o Outlook, o malware tenta ocultar atividades maliciosas, por exemplo, mensagens recebidas dos operadores. </p><br><p>  Primeiro, um backdoor sempre exclui as mensagens enviadas ou recebidas dos operadores.  Conforme mostrado na figura abaixo, por alguns segundos, voc√™ pode ver que uma nova mensagem apareceu, mas que n√£o aparece na caixa de correio. </p><br><img src="https://habrastorage.org/webt/o7/pc/wh/o7pcwhrtwemk2qfqrfdtgjb6p0o.png"><br><p>  <i>Figura 10. Mensagem n√£o lida</i> </p><br><p>  Em segundo lugar, o backdoor intercepta a <code>CreateWindowsEx</code> , conforme mostrado nas figuras abaixo.  Isso impede a cria√ß√£o de janelas como o NetUIHWND que o Outlook usa para notifica√ß√µes que aparecem no canto inferior direito da tela. </p><br><img src="https://habrastorage.org/webt/7y/wn/xq/7ywnxqshbevin9-ncsw8lhprkvo.png"><br><p>  <i>Figura 11. Configurando a captura da fun√ß√£o CreateWindowsEx</i> </p><br><img src="https://habrastorage.org/webt/ki/1_/zr/ki1_zrks5vaspkm-bpz2j-z9asu.png"><br><p>  <i>Figura 12. Interceptar CreateWindowsEx</i> </p><br><p>  A figura abaixo mostra um exemplo da janela NetUIHWND, que geralmente √© exibida na √°rea de trabalho quando uma nova mensagem √© recebida.  Como resultado da intercepta√ß√£o de <code>CreateWindowEx</code> , uma notifica√ß√£o n√£o √© exibida quando os atacantes enviam uma carta para o backdoor. </p><br><img src="https://habrastorage.org/webt/bd/5n/3b/bd5n3bq_pijmhlosvf6muvjcyjq.png"><br><p>  <i>Figura 13. Notifica√ß√£o de nova mensagem</i> </p><br><h4>  2.2.3  O morcego! </h4><br><p>  Apesar do fato de que a fun√ß√£o de registro do plugin para o The Bat!  n√£o existe mais, h√° um c√≥digo herdado que executa as mesmas fun√ß√µes do Outlook usando a API The Bat! </p><br><p>  Conforme mostrado na figura a seguir, o backdoor usa o canal de comunica√ß√£o com o The Bat !, para receber informa√ß√µes do usu√°rio, ler e enviar cartas.  No entanto, todas as outras fun√ß√µes, por exemplo, usadas para registrar mensagens ou executar comandos, s√£o id√™nticas ao Outlook. </p><br><img src="https://habrastorage.org/webt/iy/qb/ub/iyqbubrelp4uwudy8n4gby7n6lq.png"><br><p>  <i>Figura 14. O canal Bat!</i> </p><br><h3>  2.3  Backdoor </h3><br><p>  Conforme mostrado na se√ß√£o anterior, o malware pode processar e filtrar mensagens.  Ao mesmo tempo, √© um backdoor totalmente funcional, controlado por email, que pode funcionar independentemente de qualquer outro componente Turla.  O backdoor n√£o precisa de uma conex√£o permanente com a Internet e pode funcionar em qualquer computador que envie mensagens para endere√ßos externos.  Isso √© √∫til em redes estritamente controladas, por exemplo, usando a filtragem do tr√°fego da Internet.  Al√©m disso, mesmo se o endere√ßo de e-mail do invasor estiver inativo, ele poder√° recuperar o controle enviando um comando de um endere√ßo diferente.  Nesse caso, a carta tamb√©m estar√° oculta do usu√°rio, pois conter√° comandos interpretados pela porta dos fundos.  Portanto, um backdoor √© t√£o tolerante a falhas quanto um rootkit que verifica o tr√°fego de rede recebido. </p><br><h4>  2.3.1  Formato pdf </h4><br><p>  No in√≠cio de 2018, v√°rios meios de comunica√ß√£o afirmaram que os operadores da Turla usam anexos de email para gerenciar computadores infectados.  A m√≠dia estava certa.  Uma an√°lise do backdoor do Turla Outlook revelou como ele envia e interpreta comandos. </p><br><p>  Os comandos s√£o enviados por email usando anexos PDF criados especialmente.  N√£o foi poss√≠vel encontrar um exemplo real de PDF com comandos, mas provavelmente esses s√£o documentos PDF v√°lidos, al√©m de arquivos PDF criados pelo backdoor para exfiltra√ß√£o. </p><br><p>  A partir de documentos PDF, um backdoor pode restaurar o que os operadores chamam de cont√™iner em revistas.  Este √© um blob com um formato especial que cont√©m comandos criptografados para o backdoor.  A figura abaixo mostra o procedimento para remover este cont√™iner.  Tecnicamente, o aplicativo n√£o precisa ser um documento PDF v√°lido.  O √∫nico requisito √© que ele inclua o cont√™iner no formato correto. </p><br><img src="https://habrastorage.org/webt/hb/r_/yf/hbr_yfy47qewou5f_tqbrpdn5ck.png"><br><p>  <i>Figura 15. Extraindo o cont√™iner de comandos do PDF</i> </p><br><p>  O cont√™iner possui uma estrutura complexa com muitas verifica√ß√µes diferentes.  Ele poderia ser projetado para evitar erros de comunica√ß√£o, mas acreditamos que a estrutura foi criada principalmente para combater a engenharia reversa.  A estrutura do cont√™iner √© mostrada na figura abaixo. </p><br><img src="https://habrastorage.org/webt/ud/aa/6w/udaa6wvubnjskhmfrgsoalfke70.png"><br><p>  <i>Figura 16. Estrutura do cont√™iner de comando</i> </p><br><p>  Imediatamente antes do vetor de inicializa√ß√£o, h√° uma lista de descritores de comando.  Diferentes valores de ID s√£o apresentados na tabela: </p><br><img src="https://habrastorage.org/webt/jy/sg/5o/jysg5opuoyhwir5hre-xi9quhxq.png"><br><p><br>  Os descritores de identifica√ß√£o 2 e 4 s√£o usados ‚Äã‚Äãpara extrair as fun√ß√µes de criptografia e descompress√£o, conforme mostrado na figura a seguir.  No entanto, o programa malicioso implementa apenas um algoritmo de criptografia e um algoritmo de compacta√ß√£o.  Assim, o √∫nico objetivo desses campos √© complicar a an√°lise do backdoor. </p><br><img src="https://habrastorage.org/webt/h8/sh/gu/h8shgunmwafcbx6h1shccn9-ndo.png"><br><p>  <i>Figura 17. Fun√ß√µes offset de descompacta√ß√£o e descriptografia</i> </p><br><p>  As equipes est√£o na √∫ltima parte da estrutura.  Eles s√£o criptografados usando MISTY1 e compactados com bzip2.  Pode haver muitos comandos diferentes no mesmo arquivo PDF e cada um pode ter v√°rios argumentos. </p><br><h4>  2.3.2  Criptografia </h4><br><p>  Aqui, descrevemos os algoritmos de criptografia usados. </p><br><p>  <b>2.3.2.1</b>  <b>Criptografia XOR</b> </p><br><p>  Parte do cont√™iner (come√ßando com o primeiro CRC32) √© criptografada com o XOR com o fluxo de bytes gerado pela fun√ß√£o definida pelo usu√°rio.  √â preciso uma semente, que √© passada para <code>srand</code> para gerar um segundo n√∫mero chamando rand.  A segunda semente √© usada na fun√ß√£o mostrada abaixo como um argumento para os dados no XOR. </p><br><pre> <code class="hljs powershell">int __usercall F_bytestream_xor<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;eax&gt;(unsigned int len<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;edx&gt;, int ciphertext<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;ecx&gt;, unsigned int seed) { unsigned int v3; // ebx int v4; // esi unsigned int v5; // edi int result; // eax unsigned int v7; // ecx char *v8; // edx unsigned int v9; // esi byte key[<span class="hljs-number"><span class="hljs-number">512</span></span>]; // [<span class="hljs-type"><span class="hljs-type">esp</span></span>+<span class="hljs-type"><span class="hljs-type">Ch</span></span>] [<span class="hljs-type"><span class="hljs-type">ebp</span></span>-<span class="hljs-number"><span class="hljs-number">204</span></span><span class="hljs-type"><span class="hljs-type">h</span></span>] char *v11; // [<span class="hljs-type"><span class="hljs-type">esp</span></span>+<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-type"><span class="hljs-type">Ch</span></span>] [<span class="hljs-type"><span class="hljs-type">ebp</span></span>-<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-type"><span class="hljs-type">h</span></span>] v3 = len; v11 = (char *)ciphertext; srand(seed); v4 = <span class="hljs-number"><span class="hljs-number">0</span></span>; v5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { result = rand(); *(_DWORD *)&amp;key[<span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-type"><span class="hljs-type">v5</span></span>++] = result; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v5 &lt; <span class="hljs-number"><span class="hljs-number">128</span></span> ); v7 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !v3 ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; v8 = v11; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { v8[<span class="hljs-type"><span class="hljs-type">v7</span></span>] ^= key[<span class="hljs-type"><span class="hljs-type">v4</span></span>]; v9 = v4 + <span class="hljs-number"><span class="hljs-number">1</span></span>; result = -(v9 &lt; <span class="hljs-number"><span class="hljs-number">512</span></span>); v4 = result &amp; v9; ++v7; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v7 &lt; v3 ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  <strong>2.3.2.2</strong>  <strong>MISTY1</strong> </p><br><p>  Os desenvolvedores da Turla preferem usar algoritmos de criptografia menos comuns ou modificados em suas backdoors: </p><br><ul><li>  em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">carbono e cobra</a> - CAST-128 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gazer</a> - implementa√ß√£o personalizada de RSA </li><li>  em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mosquito</a> - Blum Blum Shub como um gerador de n√∫meros aleat√≥rios para fluxo de bytes XOR </li><li>  no rootkit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Uroburos</a> - uma vers√£o modificada do ThreeFish </li></ul><br><p>  No backdoor do Outlook, eles implementaram o MISTY1, um algoritmo de criptografia sim√©trica desenvolvido pelos cript√≥grafos da Mitsubishi Electric em 1995.  Possui as seguintes propriedades: </p><br><ul><li>  √© sim√©trico </li><li>  tem uma chave de 128 bits </li><li>  usa duas tabelas pr√©-computadas: s7 (128 bytes) e s9 (2048 bytes) </li><li>  usa tr√™s fun√ß√µes: FL, FO, FI <br>  o FL executa algumas opera√ß√µes XOR entre escrita de bytes e chave estendida <br>  o FO executa opera√ß√µes XOR entre o registro e a chave estendida e tamb√©m usa FI <br>  o FI realiza expans√£o n√£o linear usando s7 e s9 </li><li>  opera com blocos de 64 bits </li><li>  executa oito ciclos (ciclo - chame a fun√ß√£o FO) </li><li>  usa cifra Feistel </li></ul><br><img src="https://habrastorage.org/webt/jf/d4/_i/jfd4_iplej2iexnsc2pkxkeracy.png"><br><p>  <em>Figura 18. MISTY1</em> </p><br><img src="https://habrastorage.org/webt/08/qc/_h/08qc_hxb2xju1yxbfsqmizuocwy.png"><br><p>  <em>Figura 19. Oito ciclos para criptografia de bloco</em> </p><br><p>  Os desenvolvedores do Turla modificaram levemente o algoritmo: </p><br><ul><li>  adicionamos duas opera√ß√µes XOR √† fun√ß√£o FI, como mostra a figura abaixo </li><li>  Uma chave de 128 bits √© gerada a partir de duas chaves de 1024 bits codificadas mais um vetor de inicializa√ß√£o de 2048 bits </li><li>  tabelas alteradas s7 e s9.  Isso interrompe a opera√ß√£o de todas as ferramentas que reconhecem algoritmos criptogr√°ficos com base nos valores da tabela s.  As tabelas s modificadas e originais cont√™m os mesmos valores, foram simplesmente embaralhadas </li></ul><br><img src="https://habrastorage.org/webt/74/ge/qg/74geqg_tqugk_mgizdhn07hrcp0.png"><br><p>  <em>Figura 20. Compara√ß√£o de fun√ß√µes FI (original √† esquerda, desenvolvimento de Turla √† direita)</em> </p><br><h4 id="233-funkcii">  2.3.3  Fun√ß√µes </h4><br><p>  O backdoor possui muitas fun√ß√µes, desde a extra√ß√£o de arquivos at√© a execu√ß√£o de comandos.  A descri√ß√£o de v√°rias fun√ß√µes est√° na tabela abaixo. </p><br><img src="https://habrastorage.org/webt/zk/ij/od/zkijodwltfd9en0cxuya189_758.png"><br><p><br>  Para a fun√ß√£o 0x29, os desenvolvedores do Turla copiaram o c√≥digo do projeto Empire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PSInject</a> .  Isso permite que voc√™ execute o c√≥digo do PowerShell em um arquivo execut√°vel especial chamado PowerShell Runner sem chamar o <code>powershell.exe</code> .  A principal vantagem √© que o malware ainda pode executar comandos do PowerShell, mesmo que o arquivo <code>powershell.exe</code> esteja bloqueado em um computador comprometido. </p><br><p>  Depois de analisar o backdoor, conseguimos criar um documento PDF que pode ser interpretado com sucesso por um programa malicioso.  A figura a seguir mostra a execu√ß√£o do MessageBox e o lan√ßamento da calculadora ( <code>calc.exe</code> ) ap√≥s o Outlook receber um email contendo este PDF.  Isso demonstra que o backdoor, provavelmente destinado a receber comandos em anexos PDF, √© funcional e pode ser controlado por qualquer pessoa que entenda esse formato personalizado. </p><br><img src="https://habrastorage.org/webt/-t/xc/lr/-txclr3f050ahxdxykqgnimnr5g.png"><br><p>  <em>Figura 21. Executando os comandos especificados no documento PDF</em> </p><br><h3 id="24-dopolnitelnye-funkcii">  2.4  Fun√ß√µes adicionais </h3><br><p>  Al√©m dos recursos de backdoor implementados como um plug-in para o cliente de email, o malware tem outras fun√ß√µes. </p><br><h4 id="241-virtualnaya-faylovaya-sistema">  2.4.1  Sistema de arquivos virtual </h4><br><p>  O programa malicioso n√£o usa nenhum arquivo de configura√ß√£o, mas suporta um pequeno sistema de arquivos virtual na <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\</code> registro do Windows <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\</code> .  Outros backdoors da Turla, como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gazer</a> , tamb√©m armazenam o sistema de arquivos virtual no registro do Windows.  Conseguimos determinar alguns valores do registro, conforme mostrado na tabela a seguir. </p><br><img src="https://habrastorage.org/webt/gi/g-/wt/gig-wt39jwfeznw0kpe7qjzvhpm.png"><br><h4 id="242-zhurnaly">  2.4.2  Revistas </h4><br><p>  Como mencionado anteriormente, o programa salva um di√°rio, que √© enviado regularmente ao operador por e-mail em um documento PDF especialmente criado.  Ele √© armazenado em <code>%appdata%/Microsoft/Windows/scawrdot.db</code> e √© criptografado usando uma chave XOR de 512 bytes codificada.  O arquivo de log √© limpo ap√≥s cada exfiltra√ß√£o para os operadores.  Assim, durante o exame forense, seria imposs√≠vel ver todas as a√ß√µes passadas do backdoor, apenas as √∫ltimas. </p><br><p>  Os logs s√£o bastante informativos, pois permitem aos operadores da Turla rastrear a√ß√µes de backdoor.  A figura abaixo mostra um exemplo de um log descriptografado. </p><br><img src="https://habrastorage.org/webt/yo/q_/z6/yoq_z6lfqy5b3ozw3f4lh6reqr4.png"><br><p>  <em>Figura 22. Arquivo de log descriptografado</em> </p><br><h2 id="3-vyvody">  3. Conclus√µes </h2><br><p>  O relat√≥rio mostrou que os desenvolvedores da Turla t√™m id√©ias suficientes ao desenvolver backdoors.  At√© onde sabemos, Turla √© o √∫nico grupo de espionagem cibern√©tica que atualmente usa um backdoor totalmente gerenciado por email, ou melhor, anexos em PDF. </p><br><p>  O backdoor Turla n√£o √© o primeiro a usar a caixa de correio real da v√≠tima para receber comandos e extrair dados.  No entanto, esse √© o primeiro backdoor a ser aprendido usando a API padr√£o (MAPI) para interagir com o Microsoft Outlook.  Esta √© uma melhoria significativa em compara√ß√£o com a vers√£o anterior que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estudamos</a> , que usava o Outlook Express.  Por outro lado, o novo backdoor Turla funciona mesmo com as vers√µes mais recentes do Outlook. </p><br><p>   ,  ,     ,         ,  Turla   .      ,   Uroburos,      . </p><br><p>   ,         Turla,  ,    .     ,  ,     .  ,      -   ,        . </p><br><p>    ,     PDF-,     Turla,      ,     . </p><br><p>  ESET     Turla,        . </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> . </p><br><h2 id="4-indikatory-komprometacii"> 4.   </h2><br><h3 id="41-heshi">  4.1  Hashes </h3><br><p> 8A7E2399A61EC025C15D06ECDD9B7B37D6245EC2 ‚Äî  Win32/Turla.N;   (GMT) 2013-06-28 14:15:54 <br> F992ABE8A67120667A01B88CD5BF11CA39D491A0 ‚Äî  Win32/Turla.AW; GMT 2014-12-03 20:50:08 <br> CF943895684C6FF8D1E922A76B71A188CFB371D7 ‚Äî  Win32/Turla.R; GMT 2014-12-03 20:44:27 <br> 851DFFA6CD611DC70C9A0D5B487FF00BC3853F30 ‚Äî  Win32/Turla.DA; GMT 2016-09-15 08:14:47 </p><br><h3 id="42-imena-faylov"> 4.2.   </h3><br><p> %appdata%/Microsoft/Windows/scawrdot.db <br> %appdata%/Microsoft/Windows/flobcsnd.dat <br> mapid.tlb </p><br><h3 id="43-klyuchi-reestra"> 4.3.   </h3><br><p> HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\ <br> HKCU\Software\Classes\CLSID{49CBB1C7-97D1-485A-9EC1-A26065633066} <br> HKCU\Software\Classes\CLSID{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D} </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt421399/">https://habr.com/ru/post/pt421399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt421389/index.html">Separa√ß√£o de poderes administrativos em Zimbra</a></li>
<li><a href="../pt421391/index.html">HackThings - um grande hackathon na Internet das coisas de 7 a 9 de setembro na Skoltech</a></li>
<li><a href="../pt421393/index.html">Cesta de Mailchimp abandonada: um guia para os pregui√ßosos</a></li>
<li><a href="../pt421395/index.html">Relat√≥rio do Clube de Roma 2018, cap√≠tulo 3.7: ‚ÄúClima: boas not√≠cias, mas grandes problemas‚Äù</a></li>
<li><a href="../pt421397/index.html">Inicie o Mini AI Cup # 3. Batalha mec√¢nica em espa√ßos confinados</a></li>
<li><a href="../pt421401/index.html">Anatomia de sistemas de recomenda√ß√£o. Parte dois</a></li>
<li><a href="../pt421403/index.html">Semana de Seguran√ßa 32: Drama Fortnite-Android</a></li>
<li><a href="../pt421407/index.html">Reuni√£o t√©cnica em S√£o Petersburgo, 13 de setembro - Como fazer grandes altera√ß√µes no back-end</a></li>
<li><a href="../pt421409/index.html">Coisas de espi√£o: mantenha um segredo</a></li>
<li><a href="../pt421411/index.html">Introdu√ß√£o aos m√≥dulos Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>