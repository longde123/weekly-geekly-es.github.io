<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§–ğŸ¾ ğŸ–•ğŸ½ â™Œï¸ 1ä¸ªCPUæ ¸å¿ƒä¸Šçš„1M HTTP rpsã€‚ DPDKä»£æ›¿nginx + linuxå†…æ ¸TCP / IP ğŸ§‘ğŸ¿â€ğŸ¤â€ğŸ§‘ğŸ¿ ğŸ¶ ğŸ‘¨ğŸ¼â€ğŸ”§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘æƒ³è°ˆè°ˆè¯¸å¦‚DPDKä¹‹ç±»çš„ä¸œè¥¿-è¿™æ˜¯ä¸€ä¸ªç»•è¿‡å†…æ ¸ä½¿ç”¨ç½‘ç»œçš„æ¡†æ¶ã€‚ å³ æ‚¨å¯ä»¥ç›´æ¥ä»userland \å†™å…¥ä»¥è¯»å–ç½‘å¡çš„é˜Ÿåˆ—ï¼Œè€Œæ— éœ€ä»»ä½•ç³»ç»Ÿè°ƒç”¨ã€‚ è¿™æ ·å¯ä»¥ä¸ºæ‚¨èŠ‚çœå¤§é‡çš„å¤åˆ¶å¼€é”€ã€‚ ä½œä¸ºç¤ºä¾‹ï¼Œæˆ‘å°†ç¼–å†™ä¸€ä¸ªé€šè¿‡httpæä¾›æµ‹è¯•é¡µå¹¶å°†å…¶é€Ÿåº¦ä¸nginxè¿›è¡Œæ¯”è¾ƒçš„åº”ç”¨ç¨‹åºã€‚ 

 å¯ä»¥åœ¨æ­¤å¤„ä¸‹è½½DPDKã€‚ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>1ä¸ªCPUæ ¸å¿ƒä¸Šçš„1M HTTP rpsã€‚ DPDKä»£æ›¿nginx + linuxå†…æ ¸TCP / IP</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416651/"> æˆ‘æƒ³è°ˆè°ˆè¯¸å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DPDKä¹‹</a>ç±»çš„ä¸œè¥¿-è¿™æ˜¯ä¸€ä¸ªç»•è¿‡å†…æ ¸ä½¿ç”¨ç½‘ç»œçš„æ¡†æ¶ã€‚ å³ æ‚¨å¯ä»¥ç›´æ¥ä»userland \å†™å…¥ä»¥è¯»å–ç½‘å¡çš„é˜Ÿåˆ—ï¼Œè€Œæ— éœ€ä»»ä½•ç³»ç»Ÿè°ƒç”¨ã€‚ è¿™æ ·å¯ä»¥ä¸ºæ‚¨èŠ‚çœå¤§é‡çš„å¤åˆ¶å¼€é”€ã€‚ ä½œä¸ºç¤ºä¾‹ï¼Œæˆ‘å°†ç¼–å†™ä¸€ä¸ªé€šè¿‡httpæä¾›æµ‹è¯•é¡µå¹¶å°†å…¶é€Ÿåº¦ä¸nginxè¿›è¡Œæ¯”è¾ƒçš„åº”ç”¨ç¨‹åºã€‚ <br><a name="habracut"></a><br> å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>ä¸‹è½½DPDKã€‚ ä¸è¦é€‰æ‹©ç¨³å®š-åœ¨EC2ä¸Šå®ƒå¯¹æˆ‘ä¸èµ·ä½œç”¨ï¼Œéœ€è¦18.05-ä¸€åˆ‡éƒ½ä»å®ƒå¼€å§‹ã€‚ å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç³»ç»Ÿä¸­</a>ä¿ç•™<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¤§é‡é¡µé¢</a>ä»¥ä¾›æ¡†æ¶æ­£å¸¸è¿è¡Œã€‚ åŸåˆ™ä¸Šï¼Œå¯ä»¥å¯åŠ¨æµ‹è¯•åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”å¯ä»¥é€‰æ‹©ä¸ä½¿ç”¨å¤§é¡µé¢æ¥å·¥ä½œï¼Œä½†æ˜¯æˆ‘æ€»æ˜¯å°†å®ƒä»¬åŒ…æ‹¬åœ¨å†…ã€‚  *ä¸è¦å¿˜è®°åœ¨grub-mkconfigä¹‹åæ‰§è¡Œupdate-grub *å®Œæˆå¤§é¡µé¢åï¼Œç«‹å³è½¬åˆ°./usertools/dpdk-setup.py-è¿™ä¸œè¥¿å°†æ”¶é›†å¹¶é…ç½®å…¶ä»–æ‰€æœ‰å†…å®¹ã€‚ åœ¨Googleä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æœ‰å…³å»ºè®®æ”¶é›†å’Œè®¾ç½®æŸäº›å†…å®¹ä»¥ç»•è¿‡dpdk-setup.pyçš„è¯´æ˜-è¯·å‹¿è¿™æ ·åšã€‚ å¥½å§ï¼Œæ‚¨åªèƒ½å’Œæˆ‘ä¸€èµ·åšï¼Œè€Œæˆ‘æ²¡æœ‰ä½¿ç”¨dpdk-setup.pyï¼Œä½†æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚ ç®€è¦åœ°è¯´ï¼Œdpdk-setup.pyä¸­çš„åŠ¨ä½œåºåˆ—ï¼š <br><br><ul><li> å»ºç«‹x86_x64 Linux </li><li> åŠ è½½igb uioå†…æ ¸æ¨¡å— </li><li> å°†å¤§é¡µé¢æ˜ å°„åˆ°/ mnt / huge </li><li> åœ¨uioä¸­ç»‘å®šæ‰€éœ€çš„nicï¼ˆä¸è¦å¿˜äº†å…ˆå…³é—­ifconfig ethXï¼‰ </li></ul><br> ä¹‹åï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨ç›®å½•ä¸­è¿è¡Œmakeæ¥æ„å»ºç¤ºä¾‹ã€‚ åªéœ€è¦åˆ›å»ºä¸€ä¸ªç¯å¢ƒå˜é‡RTE_SDKå³å¯æŒ‡å‘å¸¦æœ‰DPDKçš„ç›®å½•ã€‚ <br><br>  <a href="">è¿™é‡Œ</a>æ˜¯å®Œæ•´çš„ç¤ºä¾‹ä»£ç ã€‚ å®ƒç”±åˆå§‹åŒ–ï¼Œtcp / ipåŸå§‹ç‰ˆæœ¬çš„å®ç°å’ŒåŸå§‹httpè§£æå™¨ç»„æˆã€‚ è®©æˆ‘ä»¬ä»åˆå§‹åŒ–å¼€å§‹ã€‚ <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">** argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret; <span class="hljs-comment"><span class="hljs-comment">//  dpdk ret = rte_eal_init(argc, argv); if (ret &lt; 0) { rte_panic("Cannot init EAL\n"); } //  memory pool g_packet_mbuf_pool = rte_pktmbuf_pool_create("mbuf_pool", 131071, 32, 0, RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id()); if (g_packet_mbuf_pool == NULL) { rte_exit(EXIT_FAILURE, "Cannot init mbuf pool\n"); } g_tcp_state_pool = rte_mempool_create("tcp_state_pool", 65535, sizeof(struct tcp_state), 0, 0, NULL, NULL, NULL, NULL, rte_socket_id(), 0); if (g_tcp_state_pool == NULL) { rte_exit(EXIT_FAILURE, "Cannot init tcp_state pool\n"); } //  hash table struct rte_hash_parameters hash_params = { .entries = 64536, .key_len = sizeof(struct tcp_key), .socket_id = rte_socket_id(), .hash_func_init_val = 0, .name = "tcp clients table" }; g_clients = rte_hash_create(&amp;hash_params); if (g_clients == NULL) { rte_exit(EXIT_FAILURE, "No hash table created\n"); } //    1     uint8_t nb_ports = rte_eth_dev_count(); if (nb_ports == 0) { rte_exit(EXIT_FAILURE, "No Ethernet ports - bye\n"); } if (nb_ports &gt; 1) { rte_exit(EXIT_FAILURE, "Not implemented. Too much ports\n"); } //     struct rte_eth_conf port_conf = { .rxmode = { .split_hdr_size = 0, .header_split = 0, /**&lt; Header Split disabled */ .hw_ip_checksum = 0, /**&lt; IP checksum offload disabled */ .hw_vlan_filter = 0, /**&lt; VLAN filtering disabled */ .jumbo_frame = 0, /**&lt; Jumbo Frame Support disabled */ .hw_strip_crc = 0, /**&lt; CRC stripped by hardware */ }, .txmode = { .mq_mode = ETH_MQ_TX_NONE, }, }; //          port_conf.txmode.offloads |= DEV_TX_OFFLOAD_IPV4_CKSUM; port_conf.txmode.offloads |= DEV_TX_OFFLOAD_TCP_CKSUM; ret = rte_eth_dev_configure(0, RX_QUEUE_COUNT, TX_QUEUE_COUNT, &amp;port_conf); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "Cannot configure device: err=%d\n", ret); } //     for (uint16_t j=0; j&lt;RX_QUEUE_COUNT; ++j) { ret = rte_eth_rx_queue_setup(0, j, 1024, rte_eth_dev_socket_id(0), NULL, g_packet_mbuf_pool); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_rx_queue_setup:err=%d\n", ret); } } //    struct rte_eth_txconf txconf = { .offloads = port_conf.txmode.offloads, }; for (uint16_t j=0; j&lt;TX_QUEUE_COUNT; ++j) { ret = rte_eth_tx_queue_setup(0, j, 1024, rte_eth_dev_socket_id(0), &amp;txconf); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_tx_queue_setup:err=%d\n", ret); } } // NIC ret = rte_eth_dev_start(0); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_dev_start:err=%d\n", ret); } //   lcore_hello(NULL); return 0; }</span></span></code> </pre> <br> é‚£æ—¶ï¼Œå½“æˆ‘ä»¬é€šè¿‡dpdk-setup.pyå°†é€‰å®šçš„ç½‘ç»œæ¥å£ç»‘å®šåˆ°dpdké©±åŠ¨ç¨‹åºæ—¶ï¼Œè¯¥ç½‘ç»œæ¥å£å°†ä¸å†å¯ä¾›å†…æ ¸è®¿é—®ã€‚ æ­¤åï¼Œç½‘å¡å°†æŠŠé€šè¿‡DMAåˆ°è¾¾æ­¤æ¥å£çš„æ‰€æœ‰æ•°æ®åŒ…è®°å½•åœ¨æˆ‘ä»¬æä¾›ç»™å®ƒçš„é˜Ÿåˆ—ä¸­ã€‚ <br><br> è¿™æ˜¯æ•°æ®åŒ…å¤„ç†å¾ªç¯ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rte_mbuf</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packets</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAX_PACKETS</span></span></span><span class="hljs-class">];</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> rx_current_queue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//  unsigned packet_count = rte_eth_rx_burst(0, (++rx_current_queue) % RX_QUEUE_COUNT, packets, MAX_PACKETS); for (unsigned j=0; j&lt;packet_count; ++j) { struct rte_mbuf* m = packets[j]; //   ethernet  struct ether_hdr* eth_header = rte_pktmbuf_mtod(m, struct ether_hdr*); //  IP  if (RTE_ETH_IS_IPV4_HDR(m-&gt;packet_type)) { do { //   if (rte_pktmbuf_data_len(m) &lt; sizeof(struct ether_hdr) + sizeof(struct ipv4_hdr) + sizeof(struct tcp_hdr)) { TRACE; break; } struct ipv4_hdr* ip_header = (struct ipv4_hdr*)((char*)eth_header + sizeof(struct ether_hdr)); if ((ip_header-&gt;next_proto_id != 0x6) || (ip_header-&gt;version_ihl != 0x45)) { TRACE; break; } if (ip_header-&gt;dst_addr != MY_IP_ADDRESS) { TRACE; break; } if (rte_pktmbuf_data_len(m) &lt; htons(ip_header-&gt;total_length) + sizeof(struct ether_hdr)) { TRACE; break; } if (htons(ip_header-&gt;total_length) &lt; sizeof(struct ipv4_hdr) + sizeof(struct tcp_hdr)) { TRACE; break; } struct tcp_hdr* tcp_header = (struct tcp_hdr*)((char*)ip_header + sizeof(struct ipv4_hdr)); size_t tcp_header_size = (tcp_header-&gt;data_off &gt;&gt; 4) * 4; if (rte_pktmbuf_data_len(m) &lt; sizeof(struct ether_hdr) + sizeof(struct ipv4_hdr) + tcp_header_size) { TRACE; break; } if (tcp_header-&gt;dst_port != 0x5000) { TRACE; break; } size_t data_size = htons(ip_header-&gt;total_length) - sizeof(struct ipv4_hdr) - tcp_header_size; void* data = (char*)tcp_header + tcp_header_size; //     hash table struct tcp_key key = { .ip = ip_header-&gt;src_addr, .port = tcp_header-&gt;src_port }; //    tcp process_tcp(m, tcp_header, &amp;key, data, data_size); } while(0); } else if (eth_header-&gt;ether_type == 0x0608) // ARP { //     -       ARP- do { if (rte_pktmbuf_data_len(m) &lt; sizeof(struct arp) + sizeof(struct ether_hdr)) { TRACE; break; } struct arp* arp_packet = (struct arp*)((char*)eth_header + sizeof(struct ether_hdr)); if (arp_packet-&gt;opcode != 0x100) { TRACE; break; } if (arp_packet-&gt;dst_pr_add != MY_IP_ADDRESS) { TRACE; break; } send_arp_response(arp_packet); } while(0); } else { TRACE; } rte_pktmbuf_free(m); } }</span></span></code> </pre> <br>  rte_eth_rx_burstå‡½æ•°ç”¨äºä»é˜Ÿåˆ—ä¸­è¯»å–æ•°æ®åŒ…ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰å†…å®¹ï¼Œå®ƒå°†è¯»å–æ•°æ®åŒ…å¹¶å°†å…¶æ”¾å…¥æ•°ç»„ä¸­ã€‚ å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»ä½•å†…å®¹ï¼Œå°†è¿”å›0ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¿…é¡»ç«‹å³å†æ¬¡è°ƒç”¨å®ƒã€‚ æ˜¯çš„ï¼Œå¦‚æœå½“å‰ç½‘ç»œä¸Šæ²¡æœ‰æ•°æ®ï¼Œè¿™ç§æ–¹æ³•å°†â€œ CPUæ—¶é—´â€â€œèŠ±è´¹â€ä¸ºé›¶ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å·²ç»ä½¿ç”¨äº†dpdkï¼Œåˆ™è®¤ä¸ºæƒ…å†µå¹¶éå¦‚æ­¤ã€‚  *é‡è¦çš„æ˜¯ï¼Œè¯¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‡½æ•°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</a> ï¼Œæ— æ³•ä»ä¸åŒè¿›ç¨‹ä¸­çš„åŒä¸€é˜Ÿåˆ—ä¸­è¯»å–*å¤„ç†åŒ…åï¼Œå¿…é¡»è°ƒç”¨rte_pktmbuf_freeã€‚ è¦å‘é€æ•°æ®åŒ…ï¼Œå¯ä»¥ä½¿ç”¨rte_eth_tx_burstå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†ä»rte_pktmbuf_allocæ¥æ”¶çš„rte_mbufæ”¾å…¥ç½‘å¡é˜Ÿåˆ—ä¸­ã€‚ <br><br> åˆ†è§£åŒ…å¤´åï¼Œæœ‰å¿…è¦å»ºç«‹ä¸€ä¸ªtcpä¼šè¯ã€‚  tcpåè®®å……æ»¡äº†å„ç§ç‰¹æ®Šæƒ…å†µï¼Œç‰¹æ®Šæƒ…å†µå’Œæ‹’ç»æœåŠ¡çš„å±é™©ã€‚ å¯¹äºæœ‰ç»éªŒçš„å¼€å‘äººå‘˜æ¥è¯´ï¼Œæˆ–å¤šæˆ–å°‘å®Œæ•´çš„tcpçš„å®ç°æ˜¯ä¸€ä¸ªæå¥½çš„ç»ƒä¹ ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œæ‰€æè¿°çš„æ¡†æ¶ä¸­å¹¶æœªåŒ…å«è¯¥tcpã€‚ åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œä»…æ‰§è¡Œäº†tcpå³å¯è¿›è¡Œæµ‹è¯•ã€‚ åŸºäº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">dpdkæä¾›</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å“ˆå¸Œè¡¨</a>å®ç°ä¼šè¯è¡¨ï¼Œè®¾ç½®å’Œæ–­å¼€tcpè¿æ¥ï¼Œå‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œè€Œæ— éœ€è€ƒè™‘ä¸¢å¤±å’Œæ•°æ®åŒ…é‡æ–°æ’åºã€‚  dpdkçš„å“ˆå¸Œè¡¨æœ‰ä¸€ä¸ªé‡è¦é™åˆ¶ï¼Œæ‚¨å¯ä»¥è¯»å–ä½†ä¸èƒ½å†™å…¥å¤šä¸ªçº¿ç¨‹ã€‚ è¯¥ç¤ºä¾‹æ˜¯å•çº¿ç¨‹çš„ï¼Œæ­¤é—®é¢˜åœ¨è¿™é‡Œå¹¶ä¸é‡è¦ï¼Œå¦‚æœè¦åœ¨å¤šä¸ªå†…æ ¸ä¸Šå¤„ç†æµé‡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨RSSï¼Œå‘é€å“ˆå¸Œè¡¨ï¼Œå¹¶ä¸”å¯ä»¥ä¸é˜»å¡ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">TCPå®æ–½</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">tatic </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_tcp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct rte_mbuf* m, struct tcp_hdr* tcp_header, struct tcp_key* key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data_size)</span></span></span><span class="hljs-function"> </span></span>{ TRACE; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_state</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rte_hash_lookup_data(g_clients, key, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)&amp;state) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//Documentaion lies!!! { TRACE; if ((tcp_header-&gt;tcp_flags &amp; 0x2) != 0) // SYN { TRACE; struct ether_hdr* eth_header = rte_pktmbuf_mtod(m, struct ether_hdr*); if (rte_mempool_get(g_tcp_state_pool, (void**)&amp;state) &lt; 0) { ERROR("tcp state alloc fail"); return; } memcpy(&amp;state-&gt;tcp_template, &amp;g_tcp_packet_template, sizeof(g_tcp_packet_template)); memcpy(&amp;state-&gt;tcp_template.eth.d_addr, &amp;eth_header-&gt;s_addr, 6); state-&gt;tcp_template.ip.dst_addr = key-&gt;ip; state-&gt;tcp_template.tcp.dst_port = key-&gt;port; state-&gt;remote_seq = htonl(tcp_header-&gt;sent_seq); #pragma GCC diagnostic push #pragma GCC diagnostic ignored "-Wpointer-to-int-cast" state-&gt;my_seq_start = (uint32_t)state; // not very secure. #pragma GCC diagnostic pop state-&gt;fin_sent = 0; state-&gt;http.state = HTTP_START; state-&gt;http.request_url_size = 0; //not thread safe! only one core used if (rte_hash_add_key_data(g_clients, key, state) == 0) { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 12, &amp;new_tcp_header); if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_start); state-&gt;my_seq_sent = state-&gt;my_seq_start+1; ++state-&gt;remote_seq; new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); new_tcp_header-&gt;tcp_flags = 0x12; // mss = 1380, no window scaling uint8_t options[12] = {0x02, 0x04, 0x05, 0x64, 0x03, 0x03, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01}; memcpy((uint8_t*)new_tcp_header + sizeof(struct tcp_hdr), options, 12); new_tcp_header-&gt;data_off = 0x80; send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp synack"); } } else { ERROR("can't add connection to table"); rte_mempool_put(g_tcp_state_pool, state); } } else { ERROR("lost connection"); } return; } if ((tcp_header-&gt;tcp_flags &amp; 0x2) != 0) // SYN retransmit { //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); return process_tcp(m, tcp_header, key, data, data_size); } } if ((tcp_header-&gt;tcp_flags &amp; 0x10) != 0) // ACK { TRACE; uint32_t ack_delta = htonl(tcp_header-&gt;recv_ack) - state-&gt;my_seq_start; uint32_t my_max_ack_delta = state-&gt;my_seq_sent - state-&gt;my_seq_start; if (ack_delta == 0) { if ((data_size == 0) &amp;&amp; (tcp_header-&gt;tcp_flags == 0x10)) { ERROR("need to retransmit. not supported"); } } else if (ack_delta &lt;= my_max_ack_delta) { state-&gt;my_seq_start += ack_delta; } else { ERROR("ack on unsent seq"); } } if (data_size &gt; 0) { TRACE; uint32_t packet_seq = htonl(tcp_header-&gt;sent_seq); if (state-&gt;remote_seq == packet_seq) { feed_http(data, data_size, state); state-&gt;remote_seq += data_size; } else if (state-&gt;remote_seq-1 == packet_seq) // keepalive { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 0, &amp;new_tcp_header); if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp ack keepalive"); } } else { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, state-&gt;http.last_message_size, &amp;new_tcp_header); TRACE; if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent - state-&gt;http.last_message_size); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); memcpy((char*)new_tcp_header+sizeof(struct tcp_hdr), &amp;state-&gt;http.last_message, state-&gt;http.last_message_size); send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp fin ack"); } //ERROR("my bad tcp stack implementation((("); } } if ((tcp_header-&gt;tcp_flags &amp; 0x04) != 0) // RST { TRACE; //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); } } else if ((tcp_header-&gt;tcp_flags &amp; 0x01) != 0) // FIN { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 0, &amp;new_tcp_header); TRACE; if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq + 1); if (!state-&gt;fin_sent) { TRACE; new_tcp_header-&gt;tcp_flags = 0x11; // !@#$ the last ack } send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp fin ack"); } //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); } } }</span></span></code> </pre> <br></div></div><br>  httpè§£æå™¨ä»…æ”¯æŒGETä»é‚£é‡Œè¯»å–URLï¼Œå¹¶è¿”å›å¸¦æœ‰è¯·æ±‚URLçš„htmlã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">HTTPè§£æå™¨</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">feed_http</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data_size, struct tcp_state* state)</span></span></span><span class="hljs-function"> </span></span>{ TRACE; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> remaining_data = data_size; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* current = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)data; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http_state</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (http-&gt;state == HTTP_BAD_STATE) { TRACE; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (remaining_data &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(http-&gt;state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_START: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'G'</span></span>) { http-&gt;state = HTTP_READ_G; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_G: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'E'</span></span>) { http-&gt;state = HTTP_READ_E; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_E: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'T'</span></span>) { http-&gt;state = HTTP_READ_T; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_T: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">' '</span></span>) { http-&gt;state = HTTP_READ_SPACE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_SPACE: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current != <span class="hljs-string"><span class="hljs-string">' '</span></span>) { http-&gt;request_url[http-&gt;request_url_size] = *current; ++http-&gt;request_url_size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (http-&gt;request_url_size &gt; MAX_URL_SIZE) { http-&gt;state = HTTP_BAD_STATE; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; http-&gt;request_url[http-&gt;request_url_size] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_URL: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R1; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_R1: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { http-&gt;state = HTTP_READ_N1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_N1: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R2; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_R2: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { TRACE; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> content_length[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(content_length, <span class="hljs-string"><span class="hljs-string">"%lu"</span></span>, g_http_part2_size - <span class="hljs-number"><span class="hljs-number">4</span></span> + http-&gt;request_url_size + g_http_part3_size); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> content_length_size = <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(content_length); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> total_data_size = g_http_part1_size + g_http_part2_size + g_http_part3_size + http-&gt;request_url_size + content_length_size; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_hdr</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_header</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rte_mbuf</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build_packet</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">total_data_size</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_header</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (packet != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { tcp_header-&gt;rx_win = TX_WINDOW_SIZE; tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq + data_size); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> KEEPALIVE state-&gt;my_seq_sent += total_data_size; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> state-&gt;my_seq_sent += total_data_size + 1; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//+1 for FIN tcp_header-&gt;tcp_flags = 0x11; state-&gt;fin_sent = 1; #endif char* new_data = (char*)tcp_header + sizeof(struct tcp_hdr); memcpy(new_data, g_http_part1, g_http_part1_size); new_data += g_http_part1_size; memcpy(new_data, content_length, content_length_size); new_data += content_length_size; memcpy(new_data, g_http_part2, g_http_part2_size); new_data += g_http_part2_size; memcpy(new_data, http-&gt;request_url, http-&gt;request_url_size); new_data += http-&gt;request_url_size; memcpy(new_data, g_http_part3, g_http_part3_size); memcpy(&amp;http-&gt;last_message, (char*)tcp_header+sizeof(struct tcp_hdr), total_data_size); http-&gt;last_message_size = total_data_size; send_packet(tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp data"); } http-&gt;state = HTTP_START; http-&gt;request_url_size = 0; } else if (*current == '\r') { http-&gt;state = HTTP_READ_R1; } else { http-&gt;state = HTTP_READ_URL; } break; } default: { ERROR("bad http state"); return; } } if (http-&gt;state == HTTP_BAD_STATE) { return; } --remaining_data; ++current; } }</span></span></span></span></code> </pre> <br></div></div><br> å‡†å¤‡å¥½ç¤ºä¾‹åï¼Œå¯ä»¥å°†æ€§èƒ½ä¸nginxè¿›è¡Œæ¯”è¾ƒã€‚ å› ä¸º æˆ‘æ— æ³•åœ¨å®¶é‡Œç»„è£…ä¸€ä¸ªçœŸæ­£çš„æ¶å­ï¼Œæˆ‘ä½¿ç”¨äº†Amazon EC2ã€‚  EC2åœ¨æµ‹è¯•ä¸­è¿›è¡Œäº†æ›´æ­£-æˆ‘ä¸å¾—ä¸æ”¾å¼ƒConnectionï¼šå…³é—­è¯·æ±‚ï¼Œå› ä¸º åœ¨æµ‹è¯•å¼€å§‹å‡ ç§’é’Ÿåï¼ŒSYNæ•°æ®åŒ…ä»¥300k rpsçš„é€Ÿç‡å¼€å§‹ä¸‹é™ã€‚ æ˜¾ç„¶ï¼Œå­˜åœ¨é’ˆå¯¹SYNæ´ªæ°´çš„æŸç§ä¿æŠ¤ï¼Œå› æ­¤ä½¿è¯·æ±‚ä¿æŒæ´»åŠ¨çŠ¶æ€ã€‚ åœ¨EC2ä¸Šï¼Œdpdkä¸é€‚ç”¨äºæ‰€æœ‰å®ä¾‹ï¼Œä¾‹å¦‚ï¼Œåœ¨m1.mediumä¸Šå®ƒä¸èµ·ä½œç”¨ã€‚ æ”¯æ¶åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨äº†1ä¸ªå®ä¾‹r4.8xlargeå’Œ2ä¸ªå®ä¾‹r4.8xlargeæ¥åˆ›å»ºè´Ÿè½½ã€‚ å®ƒä»¬é€šè¿‡ä¸“ç”¨VPCå­ç½‘åœ¨é…’åº—ç½‘ç»œæ¥å£ä¸Šè¿›è¡Œé€šä¿¡ã€‚ æˆ‘å°è¯•åŠ è½½ä¸åŒçš„å®ç”¨ç¨‹åºï¼šabï¼Œwrkï¼Œh2loadï¼Œsiegeã€‚ æœ€æ–¹ä¾¿çš„æ˜¯wrkï¼Œå› ä¸º  abæ˜¯å•çº¿ç¨‹çš„ï¼Œå¹¶ä¸”å¦‚æœç½‘ç»œä¸Šå­˜åœ¨é”™è¯¯ï¼Œåˆ™ä¼šç”Ÿæˆå¤±çœŸçš„ç»Ÿè®¡ä¿¡æ¯ã€‚ <br><br> åœ¨EC2ä¸­æœ‰å¤§é‡æµé‡æ—¶ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°ä¸€å®šæ•°é‡çš„ä¸¢å¼ƒï¼Œå¯¹äºæ™®é€šåº”ç”¨æ¥è¯´è¿™æ˜¯ä¸å¯è§çš„ï¼Œä½†æ˜¯åœ¨abçš„æƒ…å†µä¸‹ï¼Œä»»ä½•é‡ä¼ éƒ½ä¼šå ç”¨æ€»æ—¶é—´å’Œabï¼Œå› æ­¤æ¯ç§’å¹³å‡è¯·æ±‚æ•°çš„æ•°æ®ä¸åˆé€‚ã€‚ ä¸‹é™çš„åŸå› æ˜¯ä¸€ä¸ªå•ç‹¬çš„è°œï¼Œéœ€è¦è§£å†³ï¼Œä½†æ˜¯ï¼Œä¸ä»…åœ¨ä½¿ç”¨dpdkæ—¶å­˜åœ¨é—®é¢˜ï¼Œè€Œä¸”åœ¨ä½¿ç”¨nginxæ—¶ä¹Ÿå­˜åœ¨é—®é¢˜ï¼Œè¿™è¡¨æ˜è¿™ä¼¼ä¹å¹¶ä¸æ˜¯é”™è¯¯çš„ä¾‹å­ã€‚ <br><br> æˆ‘åˆ†ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œäº†æµ‹è¯•ï¼Œé¦–å…ˆåœ¨1ä¸ªå®ä¾‹ä¸Šè¿è¡Œwrkï¼Œç„¶ååœ¨2ä¸ªä¸Šè¿è¡Œã€‚ å¦‚æœ2ä¸ªå®ä¾‹çš„æ€»æ€§èƒ½ä¸º1ï¼Œåˆ™æ„å‘³ç€æˆ‘æ²¡æœ‰é‡åˆ°wrkæœ¬èº«çš„æ€§èƒ½ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">dpdkç¤ºä¾‹åœ¨r4.8xlargeä¸Šçš„æµ‹è¯•ç»“æœ</b> <div class="spoiler_text"> å¯åŠ¨wrk c 1å®ä¾‹ <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 32.19ms 63.43ms 817.26ms 85.01% <br> Req/Sec 15.97k 4.04k 113.97k 93.47% <br> Latency Distribution <br> 50% 2.58ms <br> 75% 17.57ms <br> 90% 134.94ms <br> 99% 206.03ms <br> 10278064 requests in 10.10s, 1.70GB read <br> Socket errors: connect 0, read 17, write 0, timeout 0 <br> Requests/sec: 1017645.11 <br> Transfer/sec: 172.75MB</code> <br> åŒæ—¶ä»2ä¸ªå®ä¾‹è¿è¡Œwrk <br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 67.28ms 119.20ms 1.64s 88.90% <br> Req/Sec 7.99k 4.58k 132.62k 96.67% <br> Latency Distribution <br> 50% 2.31ms <br> 75% 103.45ms <br> 90% 191.51ms <br> 99% 563.56ms <br> 5160076 requests in 10.10s, 0.86GB read <br> Socket errors: connect 0, read 2364, write 0, timeout 1 <br> Requests/sec: 510894.92 <br> Transfer/sec: 86.73MB <br> <br> root@ip-172-30-0-225:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 74.87ms 148.64ms 1.64s 93.45% <br> Req/Sec 8.22k 2.59k 42.51k 81.21% <br> Latency Distribution <br> 50% 2.41ms <br> 75% 110.42ms <br> 90% 190.66ms <br> 99% 739.67ms <br> 5298083 requests in 10.10s, 0.88GB read <br> Socket errors: connect 0, read 0, write 0, timeout 148 <br> Requests/sec: 524543.67 <br> Transfer/sec: 89.04MB</code> <br> </div></div><br><div class="spoiler">  <b class="spoiler_title">Nginxç»™å‡ºäº†è¿™æ ·çš„ç»“æœ</b> <div class="spoiler_text"> å¯åŠ¨wrk c 1å®ä¾‹ <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 14.36ms 56.41ms 1.92s 95.26% <br> Req/Sec 15.27k 3.30k 72.23k 83.53% <br> Latency Distribution <br> 50% 3.38ms <br> 75% 6.82ms <br> 90% 10.95ms <br> 99% 234.99ms <br> 9813464 requests in 10.10s, 2.12GB read <br> Socket errors: connect 0, read 1, write 0, timeout 3 <br> Requests/sec: 971665.79 <br> Transfer/sec: 214.94MB</code> <br> <br> åŒæ—¶ä»2ä¸ªå®ä¾‹è¿è¡Œwrk <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 52.91ms 82.19ms 1.04s 82.93% <br> Req/Sec 8.05k 3.09k 55.62k 89.11% <br> Latency Distribution <br> 50% 3.66ms <br> 75% 94.87ms <br> 90% 171.83ms <br> 99% 354.26ms <br> 5179253 requests in 10.10s, 1.12GB read <br> Socket errors: connect 0, read 134, write 0, timeout 0 <br> Requests/sec: 512799.10 <br> Transfer/sec: 113.43MB <br> <br> root@ip-172-30-0-225:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 64.38ms 121.56ms 1.67s 90.32% <br> Req/Sec 7.30k 2.54k 34.94k 82.10% <br> Latency Distribution <br> 50% 3.68ms <br> 75% 103.32ms <br> 90% 184.05ms <br> 99% 561.31ms <br> 4692290 requests in 10.10s, 1.01GB read <br> Socket errors: connect 0, read 2, write 0, timeout 21 <br> Requests/sec: 464566.93 <br> Transfer/sec: 102.77MB</code> <br> </div></div><br><div class="spoiler">  <b class="spoiler_title">Nginxé…ç½®</b> <div class="spoiler_text"> ç”¨æˆ·www-data; <br>  worker_processesè‡ªåŠ¨ï¼› <br>  pid /run/nginx.pid; <br>  worker_rlimit_nofile 50000; <br> äº‹ä»¶{ <br>  worker_connections 10000; <br>  } <br>  http { <br> å‘é€æ–‡ä»¶ <br>  tcp_nopush on; <br>  tcp_nodelay; <br>  keepalive_timeout 65; <br>  types_hash_max_size 2048; <br><br> åŒ…æ‹¬/etc/nginx/mime.types; <br>  default_typeæ–‡æœ¬/çº¯æ–‡æœ¬ï¼› <br><br>  error_log /var/log/nginx/error.log; <br>  access_logå…³é—­ï¼› <br><br> æœåŠ¡å™¨{ <br> ç›‘å¬80 default_server backlog = 10000å¤ç”¨ç«¯å£; <br> ä½ç½®/ { <br> è¿”å›200â€œ answer.padding _____________________________________________________________â€ï¼› <br>  } <br>  } <br>  } <br></div></div><br> æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨ä¸¤ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ¯ç§’éƒ½èƒ½æ”¶åˆ°çº¦100ä¸‡ä¸ªè¯·æ±‚ï¼Œåªæœ‰nginxä¸ºæ­¤ä½¿ç”¨äº†å…¨éƒ¨32ä¸ªcpuï¼Œè€Œdpdkä»…ä½¿ç”¨äº†ä¸€ä¸ªã€‚ ä¹Ÿè®¸EC2å†æ¬¡æ”¾äº†ä¸€ä¸ªå°çŒªï¼Œ1M rpsæ˜¯ç½‘ç»œçš„é™åˆ¶ï¼Œä½†æ˜¯å³ä½¿è¿™æ ·ï¼Œç»“æœä¹Ÿä¸ä¼šæœ‰å¤ªå¤§çš„å¤±çœŸï¼Œå› ä¸ºåœ¨ç¤ºä¾‹ä¸­å¢åŠ äº†<i>forï¼ˆint x = 0; x &lt;100; ++ xï¼‰httpä¹‹</i>ç±»çš„å»¶è¿Ÿ<i>â†’</i>åœ¨å‘é€æ•°æ®åŒ…ä¹‹å‰ï¼Œ <i>request_url [0] ='a'+ï¼ˆhttp-&gt; request_url [0]ï¼…10ï¼‰</i> ï¼Œå®ƒå·²ç»é™ä½äº†rpsï¼Œè¿™æ„å‘³ç€å‡ ä¹æ‰€æœ‰çš„cpuåŠ è½½éƒ½éå¸¸æœ‰ç”¨ã€‚ <br><br> åœ¨å®éªŒè¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªè°œï¼Œæˆ‘ä»ç„¶æ— æ³•è§£å†³ã€‚ å¦‚æœå¯ç”¨æ ¡éªŒå’Œå¸è½½ï¼Œå³ç”±ç½‘å¡æœ¬èº«ä¸ºipå’Œtcpæ ‡å¤´è®¡ç®—æ ¡éªŒå’Œï¼Œåˆ™æ€»ä½“æ€§èƒ½ä¼šä¸‹é™ï¼Œå¹¶ä¸”å»¶è¿Ÿä¼šå¢åŠ ã€‚ <br> è¿™æ˜¯å¯ç”¨å¸è½½çš„å¼€å§‹ <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 5.91ms 614.33us 28.35ms 96.17% <br> Req/Sec 10.48k 1.51k 69.89k 98.78% <br> Latency Distribution <br> 50% 5.91ms <br> 75% 6.01ms <br> 90% 6.19ms <br> 99% 6.99ms <br> 6738296 requests in 10.10s, 1.12GB read <br> Requests/sec: 667140.71 <br> Transfer/sec: 113.25MB</code> <br> <br> è¿™ä¸CPUä¸Šçš„æ ¡éªŒå’Œ <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 32.19ms 63.43ms 817.26ms 85.01% <br> Req/Sec 15.97k 4.04k 113.97k 93.47% <br> Latency Distribution <br> 50% 2.58ms <br> 75% 17.57ms <br> 90% 134.94ms <br> 99% 206.03ms <br> 10278064 requests in 10.10s, 1.70GB read <br> Socket errors: connect 0, read 17, write 0, timeout 0 <br> Requests/sec: 1017645.11 <br> Transfer/sec: 172.75MB</code> <br> <br> å¥½çš„ï¼Œæˆ‘å¯ä»¥é€šè¿‡ç½‘å¡å˜æ…¢çš„äº‹å®æ¥è§£é‡Šæ€§èƒ½ä¸‹é™ï¼Œå°½ç®¡è¿™å¾ˆå¥‡æ€ªï¼Œä½†å®ƒåº”è¯¥åŠ é€Ÿã€‚ ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆåœ¨å»¶è¿Ÿå›¾ä¸Šè®¡ç®—æ ¡éªŒå’Œæ—¶ï¼Œç»“æœå´å‡ ä¹æ’å®šç­‰äº6msï¼Œå¦‚æœæ‚¨ä½¿ç”¨cpuï¼Œé‚£ä¹ˆå®ƒä¼šä»2.5msæµ®åŠ¨åˆ°817msï¼Ÿ é€šè¿‡å…·æœ‰ç›´æ¥è¿æ¥çš„éè™šæ‹Ÿç«‹åœºå°†å¤§å¤§ç®€åŒ–è¿™é¡¹ä»»åŠ¡ï¼Œä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘æ²¡æœ‰è¿™æ ·åšã€‚  DPDKæœ¬èº«å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰ç½‘å¡ï¼Œåœ¨ä½¿ç”¨å®ƒä¹‹å‰ï¼Œæ‚¨éœ€è¦æ£€æŸ¥ä¸€ä¸‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆ—è¡¨</a> ã€‚ <br><br> æœ€åæ˜¯ä¸€é¡¹è°ƒæŸ¥ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN416651/">https://habr.com/ru/post/zh-CN416651/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN416639/index.html">å¤å…´å…ˆé”‹è®¿è°ˆ</a></li>
<li><a href="../zh-CN416641/index.html">å¼€å‘ç§»åŠ¨åº”ç”¨ç¨‹åºç•Œé¢çš„è¿‡ç¨‹çš„8ä¸ªé˜¶æ®µ</a></li>
<li><a href="../zh-CN416643/index.html">åä¸ªæ­¥éª¤åœ¨Kubernetesä¸Šåœ¨AWSä¸Šéƒ¨ç½²Elasticsearch</a></li>
<li><a href="../zh-CN416645/index.html">MISã€‚ ç ”ç©¶æ¨¡å¼</a></li>
<li><a href="../zh-CN416647/index.html">æ”¿åºœæœºæ„æ˜¯å¦æ¢¦æƒ³ç€ç”µåŠ›é£é™©ï¼Ÿ</a></li>
<li><a href="../zh-CN416653/index.html">å›¾ä¹¦é¦†æ’åº</a></li>
<li><a href="../zh-CN416657/index.html">ä¸‰åˆ†ä¹‹äºŒçš„å·²ç”¨å­˜å‚¨å¡åŒ…å«ä»¥å‰æ‰€æœ‰è€…çš„ä¸ªäººæ•°æ®</a></li>
<li><a href="../zh-CN416659/index.html">ç”±äºé›¶å·¥ç»æµçš„æ•°å­—æ”¯ä»˜é‡å°†è¾¾åˆ°1.2ä¸‡äº¿ç¾å…ƒ</a></li>
<li><a href="../zh-CN416661/index.html">ç§»åŠ¨é“¶è¡Œçš„ç”¨æˆ·å’Œæä¾›å•†åº”è€ƒè™‘å“ªäº›è¶‹åŠ¿</a></li>
<li><a href="../zh-CN416665/index.html">é€šè¿‡Sonatype Nexus Repository OSSé‡ç”¨ç§æœ‰Androidåº“</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>