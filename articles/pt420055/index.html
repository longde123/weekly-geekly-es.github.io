<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤üèø üëΩ üë®‚Äçüöí Teoria e pr√°tica de backups com Borg üöü üçç ‚ô†Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para nossa grande surpresa, n√£o havia um √∫nico material sobre a maravilhosa ferramenta Open Source para backup de dados - Borg (n√£o confunda com o pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teoria e pr√°tica de backups com Borg</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/420055/"><img src="https://habrastorage.org/webt/xx/7w/tn/xx7wtnr5mv7mjndz-uzowsql58o.png"><br><br>  Para nossa grande surpresa, n√£o havia um √∫nico material sobre a maravilhosa ferramenta Open Source para backup de dados - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Borg</a> <i>(n√£o confunda com o progenitor de mesmo nome Kubernetes!)</i> .  Como o usamos na produ√ß√£o h√° mais de um ano, neste artigo, compartilharei as "impress√µes" que obtivemos sobre a Borg. <a name="habracut"></a><br><br><h2>  Antecedentes: Experi√™ncia com Bacula e Bareos </h2><br>  Em 2017, est√°vamos cansados ‚Äã‚Äãde Bacula e Bareos, que usamos desde o in√≠cio de nossa atividade (ou seja, cerca de 9 anos de produ√ß√£o na √©poca).  Porque  Durante a opera√ß√£o, acumulamos muito descontentamento: <br><br><ul><li>  O SD (Daemon de Armazenamento) congela.  Se voc√™ configurou o paralelismo, a manuten√ß√£o do SD se tornar√° mais complicada e seu congelamento bloquear√° outros backups dentro do cronograma e a possibilidade de recupera√ß√£o. </li><li>  √â necess√°rio gerar configura√ß√µes para o cliente e o diretor.  Mesmo se automatizarmos isso (no nosso caso, Chef, Ansible e nosso pr√≥prio desenvolvimento foram usados ‚Äã‚Äãem momentos diferentes), precisamos monitorar que o diretor, ap√≥s sua <i>recarga,</i> realmente pegou a configura√ß√£o.  Isso √© rastreado apenas na sa√≠da do comando <i>reload</i> e na chamada de <i>mensagens</i> ap√≥s (para obter o pr√≥prio texto do erro). </li><li>  Agende backups.  Os desenvolvedores do Bacula decidiram seguir seu pr√≥prio caminho e escreveram seu pr√≥prio formato de programa√ß√£o, que voc√™ n√£o pode simplesmente analisar ou converter para outro.  Aqui est√£o exemplos de agendamentos de backup padr√£o em nossas instala√ß√µes antigas: <ul><li>  Backup completo di√°rio √†s quartas-feiras e incremental em outros dias: <br> <code>Run = Level=Full Pool="Foobar-low7" wed at 18:00 <br> Run = Level=Incremental Pool="Foobar-low7" at 18:00</code> </li> <li>  Backup completo de arquivos wal 2 vezes por m√™s e incremento a cada hora: <br> <code>Run = Level=Full FullPool=CustomerWALPool 1st fri at 01:45 <br> Run = Level=Full FullPool=CustomerWALPool 3rd fri at 01:45 <br> Run = Level=Incremental FullPool=CustomerWALPool IncrementalPool=CustomerWALPool on hourly</code> </li> <li>  O <code>schedule</code> gerado para todas as ocasi√µes (em diferentes dias da semana a cada 2 horas) chegamos a 1665 ... por causa do que Bacula / Bareos periodicamente enlouquecia. </li></ul></li><li>  O Bacula-fd (e bareos-fd) possui diret√≥rios com muitos dados (por exemplo, 40 TB, dos quais 35 TB cont√™m arquivos grandes [100 + MB], e os 5 TB restantes cont√™m arquivos pequenos [1 KB a 100 MB ]) come√ßa um vazamento lento de mem√≥ria, o que √© uma situa√ß√£o muito desagrad√°vel na produ√ß√£o. <br><br><img src="https://habrastorage.org/webt/eu/33/ao/eu33aocunyesaxcwtlyzzim_eha.png"></li><li>  Em backups com um grande n√∫mero de arquivos, o Bacula e o Bareos dependem muito do desempenho do DBMS usado.  Que unidades possui?  Com que habilidade voc√™ sabe como ajust√°-la a essas necessidades espec√≠ficas?  E no banco de dados, a prop√≥sito, uma (!) Tabela n√£o particion√°vel √© criada com uma lista de todos os arquivos em todos os backups e a segunda - com uma lista de todos os caminhos em todos os backups.  Se voc√™ n√£o estiver pronto para alocar pelo menos 8 GB de RAM para a base + 40 GB de SSD para o servidor de backup - prepare-se imediatamente para os freios. </li><li>  A depend√™ncia do banco de dados merece mais um ponto.  Bacula / Bareos para cada arquivo pergunta ao diretor se j√° existe um arquivo.  O diretor, √© claro, rastreia o banco de dados, as tabelas muito grandes ... Acontece que o backup pode ser bloqueado simplesmente pelo fato de v√°rios backups pesados ‚Äã‚Äãterem iniciado ao mesmo tempo - mesmo que o diff tenha v√°rios megabytes. </li></ul><br><img src="https://habrastorage.org/webt/nh/iw/dz/nhiwdzn69dvunjisjzcwcy1fyna.png"><br><br>  Seria injusto dizer que nenhum problema foi resolvido, mas chegamos ao ponto em que est√°vamos realmente cansados ‚Äã‚Äãde v√°rias solu√ß√µes alternativas e quer√≠amos uma solu√ß√£o confi√°vel "aqui e agora". <br><br>  Bacula / Bareos funcionam muito bem com um pequeno n√∫mero (10 a 30) de trabalhos uniformes.  Alguma coisa quebrou uma vez por semana?  Est√° tudo bem: eles deram a tarefa ao oficial de servi√ßo (ou outro engenheiro) - eles a consertaram.  No entanto, temos projetos em que o n√∫mero de trabalhos √© de centenas e o n√∫mero de arquivos neles √© de centenas de milhares.  Como resultado, 5 minutos por semana para corrigir o backup (sem contar v√°rias horas de configura√ß√µes antes disso) come√ßaram a se multiplicar.  Tudo isso levou ao fato de que 2 horas por dia eram necess√°rias para corrigir backups em todos os projetos, porque literalmente em todos os lugares havia algo insignificante ou seriamente danificado. <br><br>  Algu√©m pode pensar que um engenheiro dedicado dedicado a isso deve fazer backups.  Certamente, ele ser√° o mais barbudo e severo poss√≠vel e, pelo seu olhar, os backups s√£o reparados instantaneamente, enquanto ele bebe calmamente o caf√©.  E essa id√©ia pode ser verdadeira de alguma forma ... Mas sempre existe um mas.  Nem todos podem se dar ao luxo de reparar e monitorar backups 24 horas por dia, e mais ainda - um engenheiro alocado para esses fins.  Temos certeza de que √© melhor gastar essas 2 horas por dia em algo mais produtivo e √∫til.  Portanto, passamos √† busca de solu√ß√µes alternativas que ‚Äúsimplesmente funcionem‚Äù. <br><br><h2>  Borg como uma nova maneira </h2><br>  A busca por outras op√ß√µes de c√≥digo aberto foi espalhada ao longo do tempo, por isso √© dif√≠cil estimar os custos totais, mas em um ponto (no ano passado), nossa aten√ß√£o se voltou para o " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">her√≥i da</a> ocasi√£o" - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BorgBackup</a> (ou simplesmente Borg).  Em parte, isso foi facilitado pela experi√™ncia real de seu uso por um de nossos engenheiros (no local de trabalho anterior). <br><br>  O Borg √© escrito em Python (vers√£o&gt; = 3.4.0 √© necess√°ria) e c√≥digo exigente de desempenho (compacta√ß√£o, criptografia, etc.) √© implementado em C / Cython.  Distribu√≠do sob uma licen√ßa BSD gratuita (3 cl√°usulas).  Ele suporta muitas plataformas, incluindo Linux, * BSD, macOS, bem como no n√≠vel experimental Cygwin e Linux Subsystem do Windows 10. Para instalar o BorgBackup, os pacotes est√£o dispon√≠veis para distribui√ß√µes populares do Linux e outros sistemas operacionais, bem como c√≥digos-fonte, que tamb√©m podem ser instalados via pip, - informa√ß√µes mais detalhadas sobre isso podem ser encontradas na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto</a> . <br><br>  Por que Borg nos subornou tanto?  Aqui est√£o suas principais vantagens: <br><br><ul><li>  <b>Desduplica√ß√£o</b> : real e muito eficaz (exemplos abaixo).  Os arquivos em um √∫nico reposit√≥rio Borg (ou seja, um diret√≥rio especial em um formato espec√≠fico para Borg) s√£o divididos em blocos de n megabytes e os blocos Borg repetidos s√£o deduplicados.  A desduplica√ß√£o ocorre precisamente antes da compacta√ß√£o. </li><li>  <b>Compacta√ß√£o</b> : ap√≥s a desduplica√ß√£o, os dados tamb√©m s√£o compactados.  Diferentes algoritmos de compacta√ß√£o est√£o dispon√≠veis: lz4, lzma, zlib, zstd.  O recurso padr√£o de qualquer backup, mas isso n√£o √© menos √∫til. </li><li>  <b>Trabalhar no SSH</b> : backups da Borg para um servidor remoto via SSH.  No lado do servidor, voc√™ s√≥ precisa instalar o Borg e √© isso!  A partir daqui, vantagens como seguran√ßa e criptografia se seguem imediatamente.  Voc√™ pode configurar o acesso apenas por chaves e, al√©m disso, a execu√ß√£o de Borg de apenas um de seus comandos ao entrar no servidor.  Por exemplo, assim: <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc‚Ä¶</code> </pre> </li><li>  √â entregue no PPA (usamos principalmente o Ubuntu) e em um <b>bin√°rio est√°tico</b> .  O Borg na forma de um bin√°rio est√°tico torna poss√≠vel execut√°-lo em quase todos os lugares onde h√° pelo menos um glibc minimamente moderno.  (Mas n√£o em todos os lugares - por exemplo, n√£o foi poss√≠vel iniciar no CentOS 5.) </li><li>  <b>Limpeza</b> flex√≠vel <b>de backups antigos</b> .  Voc√™ pode definir o armazenamento dos √∫ltimos n backups e 2 backups por hora / dia / semana.  Neste √∫ltimo caso, o √∫ltimo backup no final da semana ser√° deixado.  As condi√ß√µes podem ser combinadas armazenando 7 backups di√°rios nos √∫ltimos 7 dias e 4 backups semanais. </li></ul><br>  A transi√ß√£o para Borg come√ßou lentamente em pequenos projetos.  No in√≠cio, eram scripts cron simples que faziam seu trabalho todos os dias.  Isso durou cerca de seis meses.  Durante esse per√≠odo, tivemos que fazer backups v√°rias vezes ... e acabou que o Borg n√£o precisou ser reparado literalmente!  Porque  Como o princ√≠pio simples funciona aqui: "Quanto mais simples o mecanismo, menos lugares onde ele se romper√°". <br><br><h2>  Pr√°tica: como fazer backup com o Borg? </h2><br>  Considere um exemplo simples de cria√ß√£o de um backup: <br><br><ol><li>  Fa√ßa o download do bin√°rio da vers√£o mais recente no servidor de backup e na m√°quina que iremos fazer backup no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio oficial</a> : <br><br><pre> <code class="bash hljs">sudo wget https://github.com/borgbackup/borg/releases/download/1.1.6/borg-linux64 -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg sudo chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg</code> </pre> <br>  <i><b>Nota</b> : Se voc√™ usar uma m√°quina local para o teste como fonte e como receptor, toda a diferen√ßa estar√° apenas no URI, que passaremos adiante, mas lembramos que o backup precisa ser armazenado separadamente e n√£o na mesma m√°quina.</i> </li><li>  No servidor de backup, crie o usu√°rio <code>borg</code> : <br><br><pre> <code class="bash hljs">sudo useradd -m borg</code> </pre> <br>  Simples: sem grupos e com um shell padr√£o, mas sempre com um diret√≥rio inicial. </li><li>  Uma chave SSH √© gerada no cliente: <br><br><pre> <code class="bash hljs">ssh-keygen</code> </pre> </li><li>  No servidor, adicione a chave gerada ao usu√°rio <code>borg</code> : <br><br><pre> <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> / bin local / Borg servir" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf / XmSVWfF7PfjGlbKW00MJ63zal / E / mxm + vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU / JNU0jITLx + vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk / QmteOOclzx684t9d6BhMvFE9w9r + c76aVBIdbEyrkloiYd + vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44 / Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam + 9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y + IQM7fbDR'&gt; ~ Borg / .ssh <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> </pre> </li><li>  Inicializamos o <i>reposit√≥rio borg</i> no servidor a partir do cliente: <br><br><pre> <code class="bash hljs">ssh borg@172.17.0.3 hostname <span class="hljs-comment"><span class="hljs-comment">#     borg init -e none borg@172.17.0.3:MyBorgRepo</span></span></code> </pre> <br>  A op√ß√£o <code>-e</code> √© usada para selecionar o m√©todo de criptografia para o reposit√≥rio (sim, voc√™ tamb√©m pode criptografar cada reposit√≥rio com sua senha!).  Nesse caso, porque  este √© um exemplo, n√£o usamos criptografia.  <code>MyBorgRepo</code> √© o nome do diret√≥rio em que o <i>borg repo</i> estar√° (voc√™ n√£o precisa cri√°-lo com anteced√™ncia - o Borg far√° tudo sozinho). </li><li>  Inicie o primeiro backup usando o Borg: <br><br><pre> <code class="bash hljs">borg create --stats --list borg@172.17.0.3:MyBorgRepo::<span class="hljs-string"><span class="hljs-string">"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</span></span> /etc /root</code> </pre> <br>  Sobre as teclas: <br><ul><li>  <code>--stats</code> e <code>--list</code> nos fornecem estat√≠sticas sobre backup e arquivos que entraram nele; </li><li>  <code>borg@172.17.0.3:MyBorgRepo</code> - tudo est√° claro aqui, este √© o nosso servidor e diret√≥rio.  E o que vem pela m√°gica? .. </li><li>  <code>::"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</code> √© o nome do arquivo dentro do reposit√≥rio.  √â arbitr√°rio, mas seguimos o formato <code>_-timestamp</code> (timestamp no formato Python). </li></ul></li></ol><br>  O que vem a seguir?  Obviamente, veja o que aconteceu com nosso backup!  Lista de arquivos dentro do reposit√≥rio: <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg list MyBorgRepo/ Warning: Attempting to access a previously unknown unencrypted repository! Do you want to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>? [yN] y MyFirstBackup-2018-08-04_16:55:53 Sat, 2018-08-04 16:55:54 [89f7b5bccfb1ed2d72c8b84b1baf477a8220955c72e7fcf0ecc6cd5a9943d78d]</code> </pre> <br>  Vemos um backup com um carimbo de data e hora e como Borg nos pergunta se realmente queremos acessar um reposit√≥rio n√£o criptografado em que nunca estivemos antes. <br><br>  N√≥s olhamos para a lista de arquivos: <br><br><pre> <code class="bash hljs">borg list MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53</code> </pre> <br>  N√≥s obtemos o arquivo do backup (voc√™ tamb√©m pode todo o diret√≥rio): <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg extract MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53 etc/hostname borg@b3e51b9ed2c2:~$ ll etc/hostname -rw-r--r-- 1 borg borg 13 Aug 4 16:27 etc/hostname</code> </pre> <br>  Parab√©ns, seu primeiro backup da Borg est√° pronto! <br><br><h2>  Pr√°tica: automatize isso [com o GitLab]! </h2><br>  Depois de agrupar tudo isso em scripts, configuramos backups manualmente de maneira semelhante em aproximadamente 40 hosts.  Percebendo que Borg realmente funciona, eles come√ßaram a transferir projetos cada vez maiores ... <br><br>  E aqui estamos diante do que est√° em Bareos, mas n√£o no Borg!  A saber: WebUI ou algum tipo de local centralizado para configurar backups.  E realmente esperamos que este seja um fen√¥meno tempor√°rio, mas at√© agora tivemos que resolver alguma coisa.  Pesquisando as ferramentas prontas e reunindo-nos em uma videoconfer√™ncia, come√ßamos a trabalhar.  Havia uma √≥tima id√©ia de integrar o Borg aos nossos servi√ßos internos, como fizemos anteriormente com o Bacula (o pr√≥prio Bacula retirou a lista de trabalhos de nossa API centralizada, na qual t√≠nhamos nossa pr√≥pria interface integrada com outras configura√ß√µes do projeto).  Pensamos em como faz√™-lo, esbo√ßamos um plano de como e onde constru√≠-lo, mas ... Agora s√£o necess√°rios backups normais, mas n√£o h√° lugares para se fazer planos de tempo grandiosos.  O que fazer <br><br>  As perguntas e os requisitos foram aproximadamente os seguintes: <br><br><ul><li>  O que usar como gerenciamento de backup centralizado? </li><li>  O que qualquer administrador Linux pode fazer? </li><li>  O que um gerente que mostra uma programa√ß√£o de backup para os clientes pode entender e configurar? </li><li>  O que uma tarefa agendada faz no seu sistema todos os dias? </li><li>  O que n√£o ser√° dif√≠cil de configurar e n√£o quebrar√°? </li></ul><br>  A resposta foi √≥bvia: esse √© o bom e velho crond, que heroicamente cumpre seu dever todos os dias.  Simples.  N√£o congela.  At√© o gerente que √© do Unix para ‚Äúvoc√™‚Äù pode consertar isso. <br><br>  Ent√£o crontab, mas onde voc√™ guarda tudo isso?  √â sempre o momento de ir para a m√°quina do projeto e editar o arquivo com as m√£os?  Claro que n√£o.  Podemos colocar nossa programa√ß√£o no reposit√≥rio Git e configurar o GitLab Runner, que por commit o atualizar√° no host. <br><br>  <i><b>Nota</b> : Foi o GitLab que foi escolhido como uma ferramenta de automa√ß√£o, porque √© conveniente para a tarefa e, no nosso caso, est√° em quase todos os lugares.</i>  <i>Mas devo dizer que ele n√£o √© de forma alguma uma necessidade.</i> <br><br>  Voc√™ pode expandir o crontab para backups por uma ferramenta de automa√ß√£o familiar ou geralmente manualmente (em pequenos projetos ou instala√ß√µes dom√©sticas). <br><br>  Ent√£o, aqui est√° o que voc√™ precisa para automa√ß√£o simples: <br><br>  1. <b>GitLab e um reposit√≥rio</b> , no qual, para come√ßar, haver√° dois arquivos: <br><br><ul><li>  <code>schedule</code> - agenda de backup </li><li>  <code>borg_backup_files.sh</code> - um script simples para fazer backup de arquivos (como no exemplo acima). </li></ul><br>  Exemplo de <code>schedule</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># WARNING! CRONTAB MANAGED FROM GITLAB CI RUNNER IN ${CI_PROJECT_URL} # CI_COMMIT_SHA: ${CI_COMMIT_SHA} # Branch/tag: ${CI_COMMIT_REF_NAME} # Timestamp: ${TIMESTAMP} PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin # MyRemoteHost 0 0 * * * ${CI_PROJECT_DIR}/borg_backup_files.sh 'SYSTEM /etc,/opt'</span></span></code> </pre> <br>  As vari√°veis ‚Äã‚Äãde IC s√£o usadas para verificar se a atualiza√ß√£o do crontab foi bem-sucedida e <code>CI_PROJECT_DIR</code> √© o diret√≥rio no qual o reposit√≥rio estar√° ap√≥s a clonagem do corredor.  A √∫ltima linha indica que o backup √© realizado todos os dias √† meia-noite. <br><br>  Exemplo <code>borg_backup_files.sh</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash BORG_SERVER="borg@10.100.1.1" NAMEOFBACKUP=${1} DIRS=${2} REPOSITORY="${BORG_SERVER}:$(hostname)-${NAMEOFBACKUP}" borg create --list -v --stats \ $REPOSITORY::"files-{now:%Y-%m-%d_%H:%M:%S}" \ $(echo $DIRS | tr ',' ' ') || \ echo "borg create failed"</span></span></code> </pre> <br>  <i>O primeiro</i> argumento aqui √© o nome do backup e o <i>segundo</i> √© a lista de diret√≥rios para o backup, separados por v√≠rgulas.  A rigor, uma lista tamb√©m pode ser um conjunto de arquivos separados. <br><br>  2. <b>GitLab Runner</b> , executando na m√°quina que precisa ser copiada e bloqueado apenas para as tarefas deste reposit√≥rio. <br><br>  3. <b>O pr√≥prio script de IC</b> , implementado pelo <code>.gitlab-ci.yml</code> : <br><br><pre> <code class="hljs pgsql">stages: - deploy Deploy: stage: deploy script: - export <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>=$(<span class="hljs-type"><span class="hljs-type">date</span></span> <span class="hljs-string"><span class="hljs-string">'+%Y.%m.%d %H:%M:%S'</span></span>) - cat schedule | envsubst | crontab - tags: - borg-backup</code> </pre> <br>  4. A <b>chave SSH</b> para o usu√°rio <code>gitlab-runner</code> com acesso ao servidor de <code>gitlab-runner</code> (no exemplo, √© 10.100.1.1).  Por padr√£o, ele deve estar no diret√≥rio inicial do <code>.ssh/id_rsa</code> ( <code>gitlab-runner</code> ). <br><br>  5. <b>O usu√°rio <code>borg</code></b> no mesmo 10.100.1.1 com acesso apenas ao comando <code>borg serve</code> : <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc2EAA...</code> </pre> <br>  Agora, quando voc√™ se comprometer com o reposit√≥rio Runner, ele preencher√° o conte√∫do do crontab.  E quando chegar o tempo de resposta do cron, ser√° realizado um backup dos diret√≥rios <code>/etc</code> e <code>/opt</code> , que estar√° no servidor de backup no diret√≥rio <code>MyHostname-SYSTEM</code> do servidor 10.100.1.1. <br><br><img src="https://habrastorage.org/webt/ud/n7/wb/udn7wbd4vqknfq6cguw5wmi7tcq.png"><br><br><h2>  Em vez de uma conclus√£o: o que mais voc√™ pode fazer? </h2><br>  O uso de Borg nisso, √© claro, n√£o termina a√≠.  Aqui est√£o algumas id√©ias para futuras implementa√ß√µes, algumas das quais j√° implementamos em casa: <br><br><ul><li>  <b>Adicione scripts universais</b> para diferentes backups, que no final da execu√ß√£o executam <code>borg_backup_files.sh</code> , direcionados ao diret√≥rio com o resultado de seu trabalho.  Por exemplo, voc√™ pode fazer backup de PostgreSQL (pg_basebackup), MySQL (innobackupex), GitLab (trabalho de rake interno, criando um arquivo morto). </li><li>  <b>Host central com <i>agendamento</i> para backup</b> .  N√£o configurar em cada host GitLab Runner?  Deixe-o sozinho no servidor de backup e o crontab na inicializa√ß√£o transfere o script de backup para a m√°quina e o executa l√°.  Para isso, √© claro, voc√™ precisar√° do usu√°rio <code>borg</code> na m√°quina cliente e no <code>ssh-agent</code> , para n√£o colocar a chave do servidor de backup em cada m√°quina. </li><li>  <b>Monitoramento</b>  Onde sem ele!  Os alertas sobre um backup conclu√≠do incorretamente devem ser. </li><li>  <b>Limpando o reposit√≥rio borg de arquivos antigos.</b>  Apesar da boa desduplica√ß√£o, os backups antigos ainda precisam ser limpos.  Para fazer isso, voc√™ pode fazer uma chamada para <code>borg prune</code> no final do script de backup. </li><li>  <b>Interface da Web</b> para o agendamento.  Ser√° √∫til se editar o crontab manualmente ou na interface da Web n√£o parecer s√≥lido / desconfort√°vel para voc√™. </li><li>  <b>Gr√°ficos de pizza</b> .  Alguns gr√°ficos para uma representa√ß√£o visual da porcentagem de backups conclu√≠dos com sucesso, seu tempo de execu√ß√£o e a largura do canal "comido".  N√£o √© √† toa que escrevi que n√£o h√° WebUI suficiente, como no Bareos ... </li><li>  <b>A√ß√µes simples</b> que eu gostaria de receber por um bot√£o: iniciar um backup sob demanda, restaurar em uma m√°quina etc. </li></ul><br>  E no final, gostaria de adicionar um exemplo da efic√°cia da desduplica√ß√£o em um backup real de trabalho dos arquivos WAL do PostgreSQL em um ambiente de produ√ß√£o: <br><br><pre> <code class="bash hljs">borg@backup ~ $ borg info PROJECT-PG-WAL Repository ID: 177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Location: /mnt/borg/PROJECT-PG-WAL Encrypted: No Cache: /mnt/borg/.cache/borg/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Security dir: /mnt/borg/.config/borg/security/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 ------------------------------------------------------------------------------ Original size Compressed size Deduplicated size All archives: 6.68 TB 6.70 TB 19.74 GB Unique chunks Total chunks Chunk index: 11708 3230099</code> </pre> <br>  S√£o 65 dias de backup dos arquivos WAL que s√£o feitos a cada hora.  Ao usar Bacula / Bareos, ou seja,  sem desduplica√ß√£o, obter√≠amos 6,7 TB de dados.  Basta pensar: podemos armazenar quase 7 terabytes de dados passados ‚Äã‚Äãpelo PostgreSQL, apenas 20 GB de espa√ßo ocupado. <br><br><h2>  PS </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Teoria e pr√°tica de atualiza√ß√µes aut√¥nomas no Ubuntu</a> ‚Äù; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Junior, que no primeiro dia de trabalho excluiu o banco de dados da produ√ß√£o</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Acelerando a inicializa√ß√£o de grandes bancos de dados com o Kubernetes</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt420055/">https://habr.com/ru/post/pt420055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt420041/index.html">Guerra TypeScript ou Enum Conquest</a></li>
<li><a href="../pt420045/index.html">Dep√≥sito para a data: como me foi permitido andar pelo data center RUVDS no territ√≥rio da usina espacial</a></li>
<li><a href="../pt420049/index.html">O livro "O homem est√° falando. Evolu√ß√£o e Linguagem</a></li>
<li><a href="../pt420051/index.html">[DotNetBook] Span, Mem√≥ria e ReadOnlyMemory</a></li>
<li><a href="../pt420053/index.html">Veeam Academy para desenvolvedores de C #: nova temporada</a></li>
<li><a href="../pt420057/index.html">8 regras para um freelancer de sucesso</a></li>
<li><a href="../pt420059/index.html">Agora sou l√≠der de equipe, mas por que estou t√£o doente? Dicas pr√°ticas</a></li>
<li><a href="../pt420061/index.html">Avaliamos os processos na equipe de desenvolvimento com base em dados objetivos</a></li>
<li><a href="../pt420063/index.html">"Santo" Timlid e seus seguidores</a></li>
<li><a href="../pt420065/index.html">Comunica√ß√£o como zona de desempenho do trabalho em equipe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>