<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÖ üë®üèª üö¨ Acc√©l√©ration SQLAlchemy pour les astronautes architecturaux ‚òùÔ∏è üêÖ üï¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habr, ceci est un rapport de l'ing√©nieur logiciel Alexei Starkov lors de la conf√©rence Moscow Python Conf ++ 2018 √† Moscou. Vid√©o √† la fin du post.  B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Acc√©l√©ration SQLAlchemy pour les astronautes architecturaux</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/430818/"><img src="https://habrastorage.org/webt/nk/mr/3o/nkmr3o45oaha-8h6n1elhxx3nai.png"><br><blockquote> Habr, ceci est un rapport de l'ing√©nieur logiciel Alexei Starkov lors de la conf√©rence Moscow Python Conf ++ 2018 √† Moscou.  Vid√©o √† la fin du post. </blockquote>  Bonjour √† tous!  Je m'appelle Alexei Starkov - c'est moi, dans mes meilleures ann√©es, je travaille dans une usine. <br>  Maintenant, je travaille chez Qrator Labs.  En gros, toute ma vie, j'ai √©tudi√© le C et le C ++ - j'adore Alexandrescu, The Gang of Four, les principes de SOLID - c'est tout.  Ce qui fait de moi un astronaute architectural.  J'√©cris du Python depuis quelques ann√©es parce que j'aime √ßa. <br><br>  En fait, qui sont les ¬´cosmonautes architecturaux¬ª?  La premi√®re fois que j'ai rencontr√© ce terme avec Joel Spolsky, vous l'avez probablement lu.  Il d√©crit les ¬´astronautes¬ª comme des gens qui veulent construire une architecture id√©ale qui tient √† l'abstraction, √† l'abstraction, √† l'abstraction, qui devient de plus en plus g√©n√©rale.  En fin de compte, ces niveaux vont si haut qu'ils d√©crivent tous les programmes possibles, mais ne r√©solvent aucun probl√®me pratique.  En ce moment, "l'astronaute" (c'est la derni√®re fois que ce terme est entour√© de guillemets) manque d'air et il meurt. <br><br>  J'ai √©galement des tendances vers l'exploration spatiale architecturale, mais dans ce rapport, je vais parler un peu de la fa√ßon dont cela m'a mordu et ne m'a pas permis de construire un syst√®me avec les performances n√©cessaires.  L'essentiel est de savoir comment je l'ai surmont√©. <br><br>  R√©sum√© de mon rapport: √©tait / √©tait. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/wj/_u/7c/wj_u7c0h2uaody3dj48xsbytsb4.png"><br><br>  Une augmentation de milliers et de millions de fois.  Quand j'ai fait cette diapositive, la seule pens√©e que j'avais √©tait "Comment?" <br><br><img src="https://habrastorage.org/webt/of/cb/q_/ofcbq_bd033u4wh31hzexjkstfc.png"><br><br>  O√π pourrais-je tant bousiller?  Si vous ne voulez pas foirer comme moi, lisez la suite. <br><br><img src="https://habrastorage.org/webt/md/ni/gt/mdnigtyu3igzmlqmcf89isptecc.png"><br><br>  Je vais parler du syst√®me de configuration.  Le syst√®me de configuration est un outil interne dans Qrator Labs qui stocke les configurations pour le Software Defined Network (SDN) - notre r√©seau de filtrage.  Il s'engage √† synchroniser la configuration entre les composants et √† surveiller son √©tat. <br><br><img src="https://habrastorage.org/webt/xz/kg/zr/xzkgzr2wrphmvslxnx3v2qezxta.png"><br><br>  En quoi consiste-t-il, en bref,?  Nous avons une base de donn√©es qui stocke un instantan√© de notre configuration pour l'ensemble du r√©seau, et nous avons un serveur qui traite les commandes qui lui parviennent et modifie en quelque sorte la configuration. <br><br>  Nos administrateurs techniques et nos clients viennent sur ce serveur et via la console, via les API de point d'extr√©mit√©, les API REST, JSON RPC et d'autres choses, √©mettent des commandes vers le serveur, ce qui modifie notre configuration. <br><br>  Les √©quipes peuvent √™tre tr√®s simples ou plus compliqu√©es.  Ensuite, nous avons un certain ensemble de r√©cepteurs qui composent notre SDN et le serveur envoie la configuration √† ces r√©cepteurs.  Cela semble assez simple.  Fondamentalement, je vais parler de cette partie. <br><br><img src="https://habrastorage.org/webt/yp/uq/c7/ypuqc7pzaeqvmbzsrksb9gefq-w.png"><br><br>  Puisque c'est elle qui est li√©e √† la base de donn√©es et √† l'alchimie. <br><br><img src="https://habrastorage.org/webt/qg/sz/np/qgsznprvrp4smdpbuoxopevxxt4.png"><br><br>  Quelle est la particularit√© de ce syst√®me?  C'est assez petit - m√©diocre.  Des centaines de milliers, voire des millions, d'entit√©s sont stock√©es dans cette base de donn√©es.  La particularit√© est que le graphe des relations entre entit√©s est assez complexe.  Il existe plusieurs hi√©rarchies d'h√©ritage entre les entit√©s, il y a des inclusions, il y a simplement des d√©pendances entre elles.  Toutes ces restrictions sont d√©termin√©es par la logique m√©tier et nous devons nous y conformer. <br><br>  Le rapport des demandes d'√©criture aux demandes de lecture est d'environ 15: 1.  Ici, c'est clair: il y a beaucoup de commandes pour changer la configuration et une fois dans un certain laps de temps, nous avons pouss√© la configuration aux points finaux. <br><br>  MySQL est utilis√© en interne - il est √©galement disponible dans d'autres produits de notre soci√©t√©, nous avons une expertise assez s√©rieuse sur cette base de donn√©es, il y a des gens qui peuvent travailler avec elle: construire un sch√©ma de donn√©es, concevoir des requ√™tes et tout le reste.  Par cons√©quent, nous avons pris MySQL comme une base de donn√©es relationnelle universelle. <br><br><img src="https://habrastorage.org/webt/x0/xs/ae/x0xsae3wqaqw4dfth-y8q7i3tqk.png"><br><br>  Quel √©tait le probl√®me apr√®s avoir con√ßu ce syst√®me?  L'ex√©cution d'une commande a dur√© de une √† trente secondes, selon la complexit√© de l'√©quipe.  En cons√©quence, le retard dans l'ex√©cution a atteint cinq minutes.  Une √©quipe est arriv√©e - 30 secondes, la seconde et ainsi de suite, une pile de accumul√©s - un retard de 5 minutes. <br><br>  Le retard dans l'application de la configuration peut aller jusqu'√† dix minutes.  Il a √©t√© d√©cid√© que cela ne nous suffisait pas et qu'une optimisation √©tait n√©cessaire. <br><br><img src="https://habrastorage.org/webt/ah/6t/fj/ah6tfjmleq-fzvoecldzw5qxxu0.png"><br><br>  Tout d'abord, avant de proc√©der √† toute optimisation, il est n√©cessaire de mener une enqu√™te et de d√©couvrir en fait quel est le probl√®me. <br><br><img src="https://habrastorage.org/webt/nu/wf/g6/nuwfg6v2hg2jangw6agmu9i6bw0.png"><br><br>  Il s'est av√©r√© que nous n'avions pas l'√©l√©ment le plus important pour l'enqu√™te - nous n'avions pas de t√©l√©m√©trie.  Par cons√©quent, si vous concevez une sorte de syst√®me, tout d'abord, au stade de la conception, mettez-y de la t√©l√©m√©trie.  M√™me si le syst√®me est initialement petit, puis un peu plus, puis encore plus - √† la fin, tout le monde arrive √† une situation o√π vous devez regarder des pistes, mais il n'y a pas de t√©l√©m√©trie. <br><br><img src="https://habrastorage.org/webt/eh/ws/3t/ehws3tezqmrdlvfcljs1pxbttgm.png"><br><br>  Que faire ensuite si vous n'avez pas de t√©l√©m√©trie?  Vous pouvez analyser les journaux.  Ici, des scripts assez simples parcourent nos journaux et les transforment en un tel tableau, illustrant les temps d'ex√©cution des commandes les plus rapides, les plus lents et les plus moyens.  √Ä partir d'ici, nous pouvons d√©j√† voir dans quels endroits nous avons des gags: quelles √©quipes mettent plus de temps √† ex√©cuter, lesquelles plus rapidement. <br><br><img src="https://habrastorage.org/webt/m6/0a/gc/m60agccykga4hl82ktrjfjglzqq.png"><br><br>  La seule chose √† noter est que lors de l'analyse des journaux, nous ne consid√©rons que le temps d'ex√©cution de ces commandes sur le serveur.  Il s'agit de la premi√®re √©tape - celle marqu√©e comme t2.  t1 - c'est ainsi que le client verra le temps d'ex√©cution de notre √©quipe: mise en file d'attente, attente, ex√©cution sur le serveur.  Ce temps sera plus long, nous optimisons donc le temps t2, puis utilisons le temps t1 pour d√©terminer si nous avons atteint l'objectif. <br><br>  t1 est la m√©trique de qualit√© de notre performance. <br><br><img src="https://habrastorage.org/webt/dx/dd/05/dxdd05sisxq1ciu6nu-na0zons8.png"><br><br>  En cons√©quence, c'est ainsi que nous avons profil√© toutes les √©quipes - c'est-√†-dire que nous avons pris le journal du serveur, l'avons parcouru √† travers nos scripts, regard√© et identifi√© les composants qui fonctionnaient le plus lentement.  Le serveur est construit de mani√®re assez modulaire, un composant distinct est responsable de chaque commande, et nous pouvons profiler les composants individuellement - et faire des tests de performances pour eux.  Nous avons donc eu ici une classe - pour chaque composant probl√©matique que nous avons √©crit dans lequel dans code_under_test () nous avons fait une activit√© d√©crivant l'utilisation au combat du composant.  Et il y avait deux m√©thodes: profile () et bench ().  Le premier appelle cProfile, montrant combien de fois ce qui a √©t√© appel√©, o√π se trouvent les goulots d'√©tranglement. <br><br>  bench () a √©t√© ex√©cut√© plusieurs fois et a consid√©r√© diff√©rentes mesures pour nous - c'est ainsi que nous avons √©valu√© les performances. <br><br>  Mais il s'est av√©r√© que ce n'est pas le probl√®me! <br><br><img src="https://habrastorage.org/webt/wz/r8/-p/wzr8-pc9epal61cjoraog7bkvxc.png"><br><br>  Le principal probl√®me √©tait le nombre de requ√™tes de base de donn√©es.  Il y avait beaucoup de demandes, et pour comprendre pourquoi il y en avait tellement, regardons comment tout √©tait organis√©. <br><br><img src="https://habrastorage.org/webt/bg/r0/rz/bgr0rzhohcouyykpc3raznbi4rq.png"><br><br>  Devant nous est un morceau d'un circuit simple repr√©sentant nos r√©cepteurs, pr√©sent√© sous la forme de la classe R√©cepteur.  Ils sont unis dans un groupe - groupe r√©cepteur.  Et, en cons√©quence, il existe certains plans de configuration - des tranches de la configuration, qui sont un sous-ensemble des configurations qui sont responsables d'un ¬´r√¥le¬ª de ce r√©cepteur.  Par exemple, pour le routage - plan de routage.  Les plaines avec des r√©cepteurs peuvent √™tre connect√©es dans n'importe quel ordre - c'est-√†-dire qu'il s'agit d'une relation plusieurs-√†-plusieurs. <br><br>  Ceci est une partie du grand sch√©ma que je pr√©sente ici afin que les exemples puissent √™tre mieux compris. <br><br>  Que veut faire chaque cosmonaute architectural lorsqu'il voit l'API de quelqu'un d'autre?  Il veut le cacher, r√©sumer et √©crire son interface afin de pouvoir supprimer cette API, ou plut√¥t la cacher. <br><br><img src="https://habrastorage.org/webt/nq/zq/7-/nqzq7-zlnbxkkmy7mywbp8lqvq4.png"><br><br>  En cons√©quence, il existe une API d'alchimie ¬´sale¬ª, dans laquelle il y a, en fait, des mappeurs et notre classe ¬´pure¬ª - Receiver, dans laquelle une certaine configuration est stock√©e et il existe des m√©thodes: load (), save (), delete ().  Et toutes les autres classes qui lui sont associ√©es.  Nous obtenons un graphique des objets Python, en quelque sorte connect√©s les uns aux autres - chacun d'eux a une m√©thode load (), save (), delete (), qui fait r√©f√©rence au mappeur d'alchimie, qui, √† son tour, appelle l'API. <br><br><img src="https://habrastorage.org/webt/cs/bo/lr/csbolr6uozuvbxhimmqik_llgak.png"><br><br>  La mise en ≈ìuvre ici est tr√®s simple.  Nous avons une m√©thode de chargement qui fait une requ√™te dans la base de donn√©es et pour chaque objet re√ßu cr√©e son propre objet Python.  Il existe une m√©thode de sauvegarde qui effectue l'op√©ration inverse - elle recherche s'il y a un objet dans la base de donn√©es √† l'aide de la cl√© primaire, sinon - elle cr√©e, ajoute, puis nous enregistrons l'√©tat de cet objet.  supprimer sur la cl√© primaire re√ßoit et supprime l'objet de la base de donn√©es. <br><br><img src="https://habrastorage.org/webt/fl/hq/lp/flhqlp2vg6srgo7wswpbowrlq6e.png"><br><br>  Le probl√®me principal est imm√©diatement visible - c'est la cartographie.  D'abord, nous le faisons une fois de l'objet Python au mappeur, puis du mappeur √† la base.  Le mappage suppl√©mentaire est un ou deux appels, ce qui n'est peut-√™tre pas encore si effrayant.  Le probl√®me principal √©tait la synchronisation manuelle.  Nous avons deux objets de notre interface ¬´propre¬ª et l'un d'eux change l'attribut - comment voyons-nous que l'attribut a chang√© dans l'autre?  Pas question.  Il est n√©cessaire de fusionner les modifications dans la base de donn√©es et d'obtenir l'attribut dans un autre objet.  Bien s√ªr, si nous savons que les objets sont pr√©sents dans le m√™me contexte, nous pouvons en quelque sorte suivre cela.  Mais si nous avons deux sessions dans des endroits diff√©rents - uniquement via la base, ou bloquons la base en m√©moire, ce que nous n'avons pas fait. <br><br>  Ce chargement / enregistrement / suppression est un autre mappeur qui duplique compl√®tement l'int√©rieur de l'alchimie, qui est bien √©crit et test√©.  Cet outil a de nombreuses ann√©es, il y a beaucoup d'aide sur Internet et sa duplication n'est pas tr√®s bonne non plus. <br><br>  Vous voyez l'ic√¥ne dans le coin sup√©rieur droit?  Je vais donc marquer les diapositives sur lesquelles quelque chose est fait pour la "puret√©", pour augmenter le niveau d'abstraction, pour l'astronautique architecturale.  Autrement dit, les diapositives sans cette ic√¥ne sont pragmatiques et ennuyeuses, sans int√©r√™t et ne peuvent pas √™tre lues. <br><br>  Que faire si de nombreuses requ√™tes sont lentes.  Combien?  En fait beaucoup.  Imaginez une cha√Æne d'h√©ritage: un objet, il a un parent, celui-ci a un autre parent.  Nous synchronisons l'objet enfant - pour ce faire, vous devez d'abord synchroniser les parents.  Pour synchroniser un parent, vous devez synchroniser son parent.  Eh bien, tout le monde √©tait synchronis√©.  En fait, selon la fa√ßon dont nous avons construit le graphe, nous pourrions parcourir et synchroniser tous ces objets cent fois - d'o√π un grand nombre de requ√™tes. <br><br><img src="https://habrastorage.org/webt/zo/n7/uh/zon7uhhtngwjd5rnaztxexuatsu.png"><br><br>  Qu'avons-nous fait?  Nous avons pris toute notre logique m√©tier et l'avons coinc√©e dans le mappeur.  Tous les autres objets ici ont √©galement fusionn√© avec les mappeurs, et notre API enti√®re, toute la couche d'abstraction des donn√©es, s'est av√©r√©e sale. <br><br><img src="https://habrastorage.org/webt/qn/4a/fz/qn4afzy7q6yrh0t-yw4r4m6c9se.png"><br><br>  Voici √† quoi cela ressemble en Python - notre mappeur a une sorte de logique m√©tier, il y a une description d√©clarative de cette plaque l√†.  Les colonnes sont r√©pertori√©es, les relations.  Ici, nous avons une telle classe. <br><br><img src="https://habrastorage.org/webt/ez/ud/sg/ezudsgqk1b9domctg8sdvzh4uj8.png"><br><br>  Bien s√ªr, du point de vue de tout astronaute, une API sale est un inconv√©nient.  Logique m√©tier dans une description d√©clarative de la base.  Les sch√©mas sont m√©lang√©s avec la logique m√©tier.  Ouf.  Laid. <br><br>  La description du circuit est encombr√©e.  C'est en fait un probl√®me - si la logique m√©tier n'a pas deux lignes, mais un plus grand volume, alors dans cette classe, nous devons faire d√©filer ou rechercher tr√®s longtemps afin d'obtenir des descriptions sp√©cifiques.  Avant cela, tout √©tait beau: √† un endroit la description de la base, d√©clarative, la description des sch√©mas, √† un autre endroit la logique m√©tier.  Et puis le circuit est encombr√©. <br><br>  Mais, d'autre part, nous obtenons imm√©diatement les m√©canismes de l'alchimie: unit√© de travail, qui vous permet de suivre quels objets sont sales et quels relais doivent √™tre mis √† jour;  nous obtenons une relation qui nous permet de nous d√©barrasser des questions suppl√©mentaires dans la base de donn√©es, sans nous assurer que les collections pertinentes sont remplies;  et la carte d'identit√© qui nous a le plus aid√©s.  La carte d'identit√© garantit que deux objets Python seront le m√™me objet Python s'ils ont la m√™me cl√© primaire. <br><br>  En cons√©quence, nous avons imm√©diatement r√©duit la complexit√© √† lin√©aire. <br><br><img src="https://habrastorage.org/webt/j4/ek/x8/j4ekx8dvwphpdavetrxejd1uvxg.png"><br><br>  Ce sont des r√©sultats interm√©diaires.  Les performances ont imm√©diatement augment√© de 10 fois, le nombre de requ√™tes vers la base de donn√©es a diminu√© d'environ 40 √† 80 fois et le RPS est pass√© √† 1 √† 5.  Et bien.  Mais l'API est sale.  Que faire <br><br><img src="https://habrastorage.org/webt/kj/po/hs/kjpohswqs8svlzroeizbub0tpmk.png"><br><br>  Mixins.  Nous prenons la logique m√©tier, nous la supprimons √† nouveau de notre mappeur, mais pour qu'il n'y ait plus de mappage, nous h√©riterons de notre mappeur d'alchimie de notre mix.  Pourquoi pas l'inverse?  Cela ne fonctionnera pas en alchimie, elle jurera et dira: "Vous avez deux classes diff√©rentes faisant r√©f√©rence √† une tablette, il n'y a pas de polyformisme - allez d'ici."  Et donc - c'est possible. <br><br>  Ainsi, nous avons une description d√©clarative dans le mappeur, qui est h√©rit√©e du mixin et re√ßoit toute la logique m√©tier.  Tr√®s confortable.  Et le reste des classes sont exactement les m√™mes.  Il semblerait - cool, tout est propre.  Mais il y a une mise en garde - les connexions et les relais restent √† l'int√©rieur de l'alchimie, et lorsque nous avons, disons, rejoint par une table secondaire de plaque interm√©diaire, le mappeur de cette plaque sera en quelque sorte pr√©sent dans le code client, ce qui n'est pas tr√®s beau. <br><br>  L'alchimie n'aurait pas √©t√© un cadre aussi bon et c√©l√®bre si elle ne m'avait pas donn√© l'occasion de lutter contre cela. <br><br><img src="https://habrastorage.org/webt/g6/dz/gg/g6dzggup-pvokdl7h4mguhedazc.png"><br><br>  √Ä quoi ressemble un mixin.  Il a une logique m√©tier, des mappeurs s√©par√©ment, une description d√©clarative de la plaque.  Les connexions restent dans l'alchimie, mais la logique m√©tier est distincte. <br><br>  √Ä quoi ressemble le plan g√©n√©ral? <br><br><img src="https://habrastorage.org/webt/xl/1c/eh/xl1cehyjtaoqytk_gz5h-wbc5we.png"><br><br>  Nous avons un fichier avec un sch√©ma dans lequel toutes nos classes d√©claratives sont collect√©es - appelons-le schema.py.  Et nous avons des entit√©s dans la logique m√©tier, s√©par√©ment.  Et, ces entit√©s sont h√©rit√©es √† l'int√©rieur du fichier de sch√©ma - nous √©crivons une classe distincte pour chaque entit√© et l'h√©ritons dans le sch√©ma.  Ainsi, la logique m√©tier r√©side dans un tas, le sch√©ma dans un autre et ils peuvent √™tre modifi√©s ind√©pendamment. <br><br><img src="https://habrastorage.org/webt/rj/cl/ql/rjclqll79e8wcjwkjfxova8hhpe.png"><br><br>  Comme exemple d'am√©lioration, nous consid√©rerons un sch√©ma simple de deux √©tiquettes: r√©cepteurs (table Receiver) et tranches de la configuration (table ReceiverPlanes).  Des tranches de configuration plusieurs √† un sont associ√©es √† l'√©tiquette du r√©cepteur.  Il n'y a rien de particuli√®rement compliqu√©. <br><br>  Afin de cacher les relations au sein de l'interface ¬´sale¬ª de l'alchimie, nous utilisons des relations et des collections. <br><br><img src="https://habrastorage.org/webt/mz/ih/qg/mzihqg-lfqb8vhflbkxjpf8igp8.png"><br><br>  Ils nous permettent de masquer nos mappeurs du code client. <br><br><img src="https://habrastorage.org/webt/y8/qc/v1/y8qcv1qj8_jq3y_pn-2xw-t6bji.png"><br><br>  En particulier, deux collections tr√®s utiles sont association_proxy et attribute_mapped_collection.  Nous les utilisons ensemble.  Comment fonctionne la relation classique en alchimie: nous avons une relation - il s'agit d'une certaine collection, liste, cartographes.  Les mappeurs sont des objets de relation distants.  Attribute_mapped_collection vous permet de remplacer cette liste par un dict, les cl√©s dans lesquelles seront certains des attributs des mappeurs, et les valeurs sont les mappeurs eux-m√™mes. <br><br>  Ceci est la premi√®re √©tape. <br><br><img src="https://habrastorage.org/webt/ho/tj/tt/hotjtty0hmg99f_kquecwyo4ms4.png"><br><br>  La deuxi√®me √©tape, nous faisons association_proxy sur cette relation.  Cela nous permet de ne pas transmettre le mappeur √† la collection, mais de transmettre une valeur qui sera utilis√©e ult√©rieurement pour initialiser notre mappeur, ReceiverPlanes. <br><br>  Ici, nous avons lambda, dans lequel nous transmettons la cl√© et la valeur.  La cl√© devient le nom de la tranche de configuration et la valeur la valeur de la tranche de configuration.  Par cons√©quent, dans le code client, tout ressemble √† ceci. <br><br><img src="https://habrastorage.org/webt/ko/00/s7/ko00s71bgaxu6i-h_baocnnqz-w.png"><br><br>  Nous avons simplement mis une sorte de dict√©e dans une sorte de dictionnaire.  Tout fonctionne: pas de mappeurs, pas d'alchimie, pas de bases de donn√©es. <br><br>  Certes, il y a des pi√®ges. <br><br><img src="https://habrastorage.org/webt/ux/ji/uy/uxjiuybsymdbtrvqlazqhckdv8c.png"><br><br>  Si nous attribuons deux ou plusieurs valeurs diff√©rentes √† la m√™me cl√© deux fois - lambda est appel√© pour chacun de ces √©l√©ments, un objet est cr√©√© - un mappeur.  Et, selon la structure du syst√®me, cela peut entra√Æner diverses cons√©quences, allant de ¬´simples violations des constantes¬ª √† des cons√©quences impr√©visibles.  Par exemple, vous avez en quelque sorte supprim√© un objet de la collection, mais il y est rest√©: vous n'en avez supprim√© qu'un.  Quand j'ai commenc√©, j'ai tu√© beaucoup de temps sur de telles choses. <br><br>  Et une petite synchronisation implicite.  Association_proxy et attribute_mapped_collection peuvent √™tre un peu retard√©s: lorsque nous cr√©ons un objet mappeur, il est ajout√© √† la base de donn√©es, mais il n'est pas encore pr√©sent dans l'attribut collection.  Il n'y appara√Ætra que lorsque l'attribut expirera dans cette session.  √Ä son expiration, une nouvelle synchronisation avec la base de donn√©es aura lieu et y arrivera. <br><br>  Pour surmonter cela, nous avons utilis√© nos propres collections auto-√©crites.  Ce n'est m√™me pas de l'alchimie - vous pouvez simplement cr√©er votre propre collection pour surmonter tout cela. <br><br><img src="https://habrastorage.org/webt/bk/l6/ya/bkl6yaerwagttjp6qprlfbsdpaw.png"><br><br>  Il y a plus de code et la partie la plus importante est mise en √©vidence.  Nous avons une certaine collection qui h√©rite de la cartographie mutable - c'est un dict, dans les cl√©s duquel vous pouvez changer les valeurs.  Et il existe une m√©thode _get_plane_obj - pour obtenir l'objet tranche de configuration. <br><br>  Ici, nous faisons des choses simples - nous essayons de l'obtenir par nom, par une cl√© primaire et, si ce n'est pas le cas, nous cr√©ons et renvoyons cet objet. <br><br>  Ensuite, nous red√©finissons seulement deux m√©thodes: __setitem__ et __getitem__ <br>  Dans __setitem__, nous mettons ces objets dans notre collection, en relation.  La seule chose est que nous attribuons de la valeur √† la toute fin.  Ainsi, nous impl√©mentons le m√™me m√©canisme que association_proxy - passez la valeur, dictez-la, et elle est affect√©e √† l'attribut correspondant. <br><br>  __getitem__ fait la manipulation inverse.  Il re√ßoit par cl√© un objet du relais et retourne son attribut.  Il y a aussi un petit pi√®ge ici - si vous mettez en cache la collection √† l'int√©rieur de notre cartographie, il est possible de se d√©synchroniser un peu.  Parce que lorsque l'attribut de la collection expire en alchimie, la collection est remplac√©e par une autre, apr√®s expiration.  Par cons√©quent, nous pouvons conserver la r√©f√©rence √† l'ancienne collection et ne pas savoir que l'ancienne a expir√© et qu'une nouvelle est d√©j√† apparue.  Par cons√©quent, dans la derni√®re partie, nous allons directement √† l'instance d'alchimie, encore une fois, nous obtenons la collection via __getattr__ et nous faisons __getitem__ avec.  Autrement dit, nous ne pouvons pas mettre en cache la collection Planes ici. <br><br><img src="https://habrastorage.org/webt/_0/l6/tt/_0l6tt3pcdjmsxlwy2hivf1b4ty.png"><br><br>  Comment cette collection gifle-t-elle nos mixins?  Comme d'habitude - configurez un attribut de collection.  Le seul endroit int√©ressant est que lorsque nous chargeons une instance √† partir de la base de donn√©es, la m√©thode __init__ n'est pas appel√©e.  Tous les attributs sont substitu√©s ex post. <br><br>  Alchemy propose un d√©corateur reconstructeur standard, qui vous permet de marquer une m√©thode comme √©tant appel√©e apr√®s le chargement d'un objet √† partir de la base de donn√©es.  Et juste au moment du d√©marrage, nous devons initialiser notre collection.  Le moi n'est que cet exemple.  L'utilisation est exactement la m√™me que dans l'exemple pr√©c√©dent. <br><br><img src="https://habrastorage.org/webt/qe/yr/h4/qeyrh4fd3cmfpm8-exbfd1rwpkw.png"><br><br>  Mais dans notre sch√©ma, les oreilles de la base de donn√©es sont toujours visibles - c'est la configuration.  Quel type de configuration?  Est-ce varchar ou blob?  En fait, le client n'est pas int√©ress√©.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il doit travailler avec des entit√©s abstraites de son niveau. Pour cela, l'alchimie propose une d√©coration de type. </font></font><br><br><img src="https://habrastorage.org/webt/ds/lc/ic/dslcicbf3yrljfchfwbxhcucleq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple simple. Notre base de donn√©es stocke IPAddress sous forme de varchar. Nous utilisons la classe TypeDecorator, qui fait partie de l'alchimie, qui permet, d'une part, d'indiquer quel type de base de donn√©es sous-jacent sera utilis√© pour ce type et, d'autre part, de d√©finir deux param√®tres: process_bind_param convertissant la valeur en type de base de donn√©es et process_result_value lorsque nous √©valuons √† partir du type de base de donn√©es, convertissez en un objet Python.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'attribut from address prend le type python IPAddress. Et nous pouvons √† la fois appeler des m√©thodes de ce type, et lui affecter des objets de ce type, et tout fonctionne pour nous. Et il est stock√© dans la base de donn√©es ... Je ne sais pas ce qui est stock√©, varchar (45), mais nous pouvons remplacer cette ligne et le blob sera stock√©. Ou si un type natif prend en charge les adresses IP, vous pouvez l'utiliser. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code client ne d√©pend pas de cela, il n'a pas besoin d'√™tre r√©√©crit. </font></font><br><br><img src="https://habrastorage.org/webt/xb/m5/uu/xbm5uu_ryeji94kthsv0rp2ogdw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une autre chose int√©ressante est que nous avons une version. Nous voulons que d√®s que nous changeons d'objet, la version augmente imm√©diatement. Nous avons un compteur de versions, nous avons chang√© d'objet - il a chang√©, la version a augment√©. Nous le faisons automatiquement pour ne pas oublier.</font></font><br><br><img src="https://habrastorage.org/webt/zy/g5/ro/zyg5rofkv1ibi-yb-kuv3kikbww.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour cela, nous avons utilis√© des √©v√©nements. Les √©v√©nements sont des √©v√©nements qui se produisent √† diff√©rentes √©tapes de la vie d'un mappeur et ils peuvent √™tre d√©clench√©s lorsque les attributs changent, lorsqu'une entit√© passe d'un √©tat √† un autre, par exemple, ¬´cr√©√©¬ª, ¬´enregistr√© dans la base de donn√©es¬ª, ¬´charg√© √† partir de la base de donn√©es¬ª, ¬´supprim√©¬ª; et √©galement - lors d'√©v√©nements de niveau session, avant que le code sql ne soit √©mis dans la base de donn√©es, avant la validation, apr√®s la validation et √©galement apr√®s la restauration. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alchemy nous permet d'affecter des gestionnaires √† tous ces √©v√©nements, mais l'ordre dans lequel les gestionnaires sont ex√©cut√©s pour le m√™me √©v√©nement n'est pas garanti. Autrement dit, il est sp√©cifique, mais on ne sait pas lequel. Par cons√©quent, si l'ordre d'ex√©cution est important pour vous, vous devez faire un m√©canisme d'enregistrement. </font></font><br><br><img src="https://habrastorage.org/webt/wb/h2/w1/wbh2w1k4s4y6jqemt4oatlknwug.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici un exemple. Trois √©v√©nements sont utilis√©s ici:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on_before_flush - avant que le code SQL ne soit √©mis dans la base de donn√©es, nous passons en revue tous les objets que l'alchimie a marqu√©s comme sales dans cette session et v√©rifions si cet objet est modifi√© ou non. Pourquoi est-ce n√©cessaire si l'alchimie a d√©j√† tout marqu√©? L'alchimie marque un objet sale d√®s qu'un attribut a chang√©. Si nous attribuons la m√™me valeur √† cet attribut qu'il avait, il sera marqu√© comme sale. Il existe une m√©thode de session is_modified pour cela - elle est utilis√©e en interne, je ne l'ai pas dessin√©e. De plus, du point de vue de notre s√©mantique, du point de vue de notre logique m√©tier, m√™me si l'attribut a chang√©, l'objet peut rester inchang√©. Par exemple, il existe une certaine liste dans laquelle deux √©l√©ments sont √©chang√©s - du point de vue de l'alchimie, l'attribut a chang√©, mais cela n'a pas d'importance pour la logique m√©tier si, disons,une sorte.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et, √† la fin, nous appelons une autre m√©thode sp√©cifique √† chaque objet pour comprendre si l'objet est modifi√© ou non. Et nous les ajoutons √† une certaine variable associ√©e √† la session que nous avons cr√©√©e nous-m√™mes - c'est notre variable dirty_instances, dans laquelle nous ajoutons cet objet. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©v√©nement suivant se produit avant le commit - before_commit. Ici aussi, il y a un petit pi√®ge: si pour la transaction enti√®re nous n'avons pas eu un seul flush, alors flush sera appel√© avant le commit - dans mon cas, le gestionnaire a √©t√© appel√© avant le commit avant flush. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme vous pouvez le voir, ce que nous avons fait dans le paragraphe pr√©c√©dent peut ne pas nous aider et session.dirty_instances sera vide. Par cons√©quent, √† l'int√©rieur du gestionnaire, nous effectuons √† nouveau le vidage afin que tous les gestionnaires soient appel√©s avant le vidage et incr√©mentons simplement la version d'une unit√©.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after_commit, after_soft_rollback - apr√®s le commit, nous le nettoyons juste pour qu'il n'y ait pas d'exc√®s la prochaine fois. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainsi, vous voyez - cette m√©thode install_handler installe des gestionnaires pour trois √©v√©nements √† la fois. En tant que classe, nous passons la session ici, car il s'agit d'un √©v√©nement de son niveau. </font></font><br><br><img src="https://habrastorage.org/webt/oi/w8/pk/oiw8pkhgdpx7shz7rqrovfmg6lk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien ici. Je vous rappellerai ce que nous avons accompli - vitesse de 30 √† 40 secondes pour les √©quipes complexes et grandes. Pas du tout, certains ont √©t√© achev√©s en une seconde, d'autres en 200 millisecondes, comme vous pouvez le voir sur RPS. Les requ√™tes de base de donn√©es ont commenc√© √† √™tre compt√©es par centaines. </font></font><br><br><img src="https://habrastorage.org/webt/7p/wk/qo/7pwkqo4-g_hksl5m_cqoo3xph5y.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le r√©sultat est un syst√®me assez √©quilibr√©. Il y avait cependant une mise en garde. Certaines demandes viennent de nous par lots, √©missions. Autrement dit, environ 30 demandes arrivent et chacune d'elles est comme √ßa! (le haut-parleur montre le pouce)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si nous les traitons une seconde √† la fois, la derni√®re demande dans la file d'attente fonctionnera pendant 30 secondes. Le premier, les deux seconds, etc. </font></font><br><br><img src="https://habrastorage.org/webt/ut/br/gl/utbrglrwurgv0uux2yk8eme4owg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par cons√©quent, nous devons encore acc√©l√©rer. Que ferons-nous? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, l'alchimie a deux parties. Le premier est une abstraction sur une base de donn√©es SQL appel√©e SQLAlchemy Core. Le second est ORM, le mappage r√©el entre la base de donn√©es relationnelle et la repr√©sentation d'objet. En cons√©quence, le noyau d'alchimie co√Øncide √† peu pr√®s avec sql - si vous connaissez ce dernier, vous n'aurez pas de probl√®mes avec le noyau. Si vous ne connaissez pas sql - apprenez sql. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De plus, le noyau repr√©sente le plus petit surco√ªt. Il n'y a pratiquement pas de pompage - les requ√™tes sont g√©n√©r√©es √† l'aide du g√©n√©rateur de requ√™tes, puis ex√©cut√©es. Les frais g√©n√©raux sur dbapi sont minimes.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous pouvons construire des demandes de toute complexit√©, de tout type, nous pouvons les optimiser pour la t√¢che. Autrement dit, si dans le cas g√©n√©ral, ORM ne se soucie pas de la fa√ßon dont le sch√©ma de base de donn√©es est construit - il y a une description des tables, il g√©n√®re des requ√™tes, sans savoir que dans ce cas, par exemple, il sera optimal de s√©lectionner d'ici, dans un autre - √† partir de l√†, tel appliquer le filtre, et l√† - un autre, alors ici, nous pouvons faire des demandes pour la t√¢che. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'inconv√©nient est que nous sommes √† nouveau arriv√©s √† la synchronisation manuelle. Tous les √©v√©nements, relais - tout cela dans le noyau ne fonctionne pas. Nous avons fait une s√©lection, des objets nous sont arriv√©s, nous avons fait quelque chose avec eux, puis mis √† jour, ins√©r√© ... vous devez incr√©menter la version avec vos mains, v√©rifier les constantes vous-m√™me. Core ne permet pas de faire tout cela de mani√®re pratique, √† un niveau √©lev√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, nous ne vivons pas le premier jour.</font></font><br><br><img src="https://habrastorage.org/webt/qx/kk/bx/qxkkbxwleeqwvdukaghimiat7sw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un cas d'utilisation simple. Chaque mappeur contient en interne un objet __table__, qui est utilis√© dans le noyau. Ensuite, vous voyez - nous prenons la s√©lection habituelle, listons les colonnes, joignons deux plaques, indiquons la gauche et la droite, indiquons par quelle condition nous la joignons, eh bien, pour le go√ªt, nous ajoutons un ordre d'achat. Ensuite, nous introduisons cette requ√™te g√©n√©r√©e dans la session et elle nous est renvoy√©e, dans laquelle les objets de type tap sont index√©s √† la fois par nom de colonne et par num√©ro. Le num√©ro correspond √† l'ordre dans lequel ils sont r√©pertori√©s dans la s√©lection. </font></font><br><br><img src="https://habrastorage.org/webt/r2/uq/f4/r2uqf4wn-wa-cvigivokusan6um.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est devenu beaucoup mieux. Dans le pire des cas, les performances sont tomb√©es √† 2-4 secondes, la demande la plus complexe et la plus longue contenait 14 commandes et RPS 10-15. C'est solide. </font></font><br><br><img src="https://habrastorage.org/webt/m9/8d/mw/m98dmwpmo0trjpw3vta7dylmryw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce que je voudrais dire en conclusion.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne produisez pas d'entit√©s l√† o√π elles ne sont pas n√©cessaires - ne vissez pas la v√¥tre l√† o√π elle est pr√™te. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisez SQLA ORM - c'est un outil tr√®s pratique qui vous permet de suivre des √©v√©nements √† un niveau √©lev√©, de r√©pondre √† divers √©v√©nements li√©s √† la base de donn√©es, de cacher toutes les oreilles de l'alchimie. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si tout le reste √©choue, les performances ne sont pas suffisantes - utilisez SQLA Core. </font><font style="vertical-align: inherit;">C'est encore mieux que d'utiliser du SQL brut pur car il fournit une abstraction relationnelle sur la base de donn√©es. </font><font style="vertical-align: inherit;">√âchappe automatiquement les param√®tres, fonctionne correctement les classeurs, peu importe la base de donn√©es qui s'y trouve - elle peut √™tre modifi√©e et Core prend en charge diff√©rents dialectes.</font></font> C'est tr√®s pratique. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C'est tout ce que je voulais vous dire aujourd'hui. </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/flA2lEl2a0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr430818/">https://habr.com/ru/post/fr430818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr430804/index.html">Les batteries Tesla / Panasonic sont les batteries de v√©hicules √©lectriques les plus abordables du march√©</a></li>
<li><a href="../fr430806/index.html">Nous avons commenc√© √† apprendre l'anglais - √©crit une application: EWM - exp√©rience dans la cr√©ation d'un projet de formation</a></li>
<li><a href="../fr430808/index.html">Th√©orie des conf√©renciers: 16 documents sur le fonctionnement des conf√©renciers et des conf√©renciers</a></li>
<li><a href="../fr430810/index.html">Test de charge avec criquet. 2e partie</a></li>
<li><a href="../fr430812/index.html">Qu'est-ce que developer.android.com parle de RecyclerView</a></li>
<li><a href="../fr430820/index.html">Black Friday 2018 - VDS √† Moscou et Amsterdam</a></li>
<li><a href="../fr430822/index.html">S√©curit√© de l'information de l'Internet des objets: qui est la chose et qui est le ma√Ætre?</a></li>
<li><a href="../fr430824/index.html">Rechercher un objet endommag√© par num√©ro de page endommag√© dans MS SQL Server 2005</a></li>
<li><a href="../fr430826/index.html">Comment d√©velopper un gestionnaire de d√©veloppement</a></li>
<li><a href="../fr430828/index.html">Exp√©rience dans l'utilisation d'√©crans LCD bas√©s sur les produits MELT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>