<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèΩ üòÉ üõ°Ô∏è My Internet of Things: Guest Castle (Parte 2) ü§ï üèúÔ∏è üå•Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola gt ¬°Todo con la venida y el pasado! 
 Contin√∫o la historia de c√≥mo conect√© la cerradura de la puerta a Internet. Haga clic aqu√≠ . 
 Muchas gracia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>My Internet of Things: Guest Castle (Parte 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/382677/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola gt ¬°Todo con la venida y el pasado! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contin√∫o la historia de c√≥mo conect√© la cerradura de la puerta a Internet. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haga clic aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muchas gracias a todos por los comentarios. Realmente hay soluciones listas para usar, pero tambi√©n hay una serie de matices que no me permitieron usarlas. Un apartamento todav√≠a no es un hotel, por lo que descartamos los castillos especializados de hotel de inmediato. Cerraduras de llave, antenas para NFC, para no asustar a los vecinos, tampoco lo consideramos. Tampoco se puede usar ninguna tarjeta, ficha u otro medio f√≠sico, se entiende que no hay forma de transferirlos a un invitado antes de que abra la puerta.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kevo, August o Lockitron no pudieron ser utilizados, porque se basan en el tipo de cerradura americana (cerrojo), que no est√° muy bien instalado en una puerta de acero de 65-70 mm de espesor. Nuestra elecci√≥n es el CISA electromec√°nico para puertas blindadas, con un precio de alrededor de 500 euros (a√∫n no comprado, porque es caro). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y lo m√°s importante, quiero hacer algo con mis propias manos, no ser ego√≠sta por el bien de las corrientes de hobby.</font></font><br>
<img src="https://habrastorage.org/files/12f/2b5/6a3/12f2b56a3cae496d9f3717839e37cea1.JPG"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perm√≠tame recordarle que el controlador de bloqueo est√° ubicado detr√°s de NAT en la red dom√©stica local y, por lo tanto, no tiene sentido crear un servidor web en Arduin; no hay forma de acceder a √©l desde Internet. El servidor est√° escrito en Python usando el marco Twisted, se ejecuta en Linux en otro lugar donde hay una direcci√≥n IP real, y el controlador se conecta a √©l y espera los comandos. </font></font><br>
<img src="https://habrastorage.org/files/c3a/803/92b/c3a80392b83f4a0382e764ad8afa142e.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora quiero hablar sobre la l√≥gica del trabajo y la criptograf√≠a. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No encontr√© algo que encriptara el tr√°fico de Arduina, porque las comunicaciones del castillo y el servidor pasar√°n por canales abiertos con tr√°fico sin encriptar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el primer prototipo, us√© MD5, ahora lo cambi√© a SHA-1, aqu√≠ en esta biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cryptosuite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Consume menos memoria y ya hay una funci√≥n HMAC preparada.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clave es una contrase√±a de hasta 30 caracteres ASCII, almacenada en la memoria EEPROM del controlador. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el primer prototipo, la misma contrase√±a se almacen√≥ expl√≠citamente en el servidor, lo que por supuesto no es seguridad. El segundo prototipo requer√≠a dos contrase√±as. El primero es autenticar el bloqueo cuando se conecta al servidor, no puede abrir el bloqueo con esta contrase√±a, es necesario para que solo los bloqueos correctos puedan conectarse al servidor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El bloqueo se conecta al servidor y, en primer lugar, le dice su identificador. El servidor verifica en la base de datos si existe dicho bloqueo, y si lo hay, env√≠a una secuencia ASCII generada aleatoriamente en respuesta. El candado lo "firma" con una contrase√±a y devuelve el hash. El servidor compara el hash recibido con lo que calcul√≥ por s√≠ mismo, y si coinciden, autorizar√° al controlador conectado como un "bloqueo".</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De lo contrario, la conexi√≥n se restablece. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La segunda contrase√±a ya es una clave digital; no est√° almacenada en el servidor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funciona de la siguiente manera: la aplicaci√≥n del usuario llama a trav√©s de la funci√≥n SOAP en el servidor, indica la ID de la cerradura y el comando que desea enviarle. Como resultado, la funci√≥n devuelve la ID de solicitud. El servidor reenv√≠a este comando al controlador, el controlador env√≠a una secuencia ASCII generada aleatoriamente en respuesta y espera la respuesta "correcta" durante un par de segundos. A continuaci√≥n, la aplicaci√≥n de usuario debe obtenerla del servidor, a trav√©s del mismo SOAP mediante el ID de la solicitud, firmarla con una clave digital y enviarla de vuelta. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador compara el hash recibido con el calculado por s√≠ mismo y, si coinciden, ejecuta el comando recibido anteriormente, que se informa al servidor.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tiempo para confirmar el comando est√° limitado a 2 segundos, si no se recibe respuesta durante este tiempo, el controlador ignora el comando recibido anteriormente. Si los hashes no coinciden, el comando tambi√©n se ignora. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, trato de protegerme del ataque "hombre en el medio", que es muy f√°cil de organizar en los cables de mi proveedor. La conexi√≥n all√≠ es simple, no hay contrase√±as ni certificados, es suficiente para cortar el par trenzado en el escudo, apretarlo en ambos lados, enchufarlo a la red desde el lado del apartamento con la direcci√≥n IP del servidor de comandos, emular el bloqueo en el otro extremo (tambi√©n escrib√≠ un script para emulaci√≥n en el pit√≥n para la depuraci√≥n) ), habiendo organizado un "cortafuegos" con escuchas telef√≥nicas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este sentido, en mi opini√≥n, el castillo result√≥ estar bastante protegido.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluso piratear el servidor de comandos y robar su base de datos con contrase√±as para la autorizaci√≥n del bloqueo no causar√° muchos problemas, ya que no pueden abrir el bloqueo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo queda tratar con los invitados. Estos son los requisitos No. 6-8 del primer art√≠culo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los teclados, proxies, RFID y NFC no son una opci√≥n, lo anterior escribi√≥ por qu√©. Pero casi todos tienen un tel√©fono inteligente y todos los tel√©fonos inteligentes tienen Bluetooth, ¬°la elecci√≥n es obvia! </font></font><br>
<img src="https://habrastorage.org/files/d2a/1bd/1b0/d2a1bd1b0a2a4f81a906fba3e2640b5e.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el primer prototipo, un invitado estaba asociado con un √∫nico c√≥digo de acceso. En la base de datos del servidor para este c√≥digo se almacenaron la ID de la cerradura, la fecha y hora del comienzo y el final del acceso del invitado, bueno, un campo de texto para el nombre legible por el humano del invitado.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un invitado se acerca a la cerradura, inicia una aplicaci√≥n m√≥vil en su tel√©fono inteligente, env√≠a un c√≥digo de acceso por Bluetooth al controlador, llega un mensaje del controlador al servidor que indica que un invitado se ha acercado a √©l con un cierto c√≥digo de acceso. El servidor lo compara con la base de datos, y si el invitado correcto lleg√≥ en el momento correcto en el lugar correcto, env√≠a el comando para abrir el bloqueo. De hecho, en lugar del c√≥digo de acceso claro, el invitado enviar√° un hash HMAC firmado con un "sello temporal" (una representaci√≥n de cadena del tiempo Unix dividido por 30 con la parte fraccional descartada). El servidor para la verificaci√≥n realiza una solicitud a la base de datos con una selecci√≥n de todos los c√≥digos de acceso actualmente v√°lidos para un bloqueo dado, luego lo itera y calcula un HMAC similar para ellos, si encuentra una coincidencia, env√≠a un comando para abrir,Si la b√∫squeda de c√≥digos de acceso finaliza antes de que se pueda encontrar una coincidencia, se env√≠a una respuesta negativa al candado al intentar abrirlo.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema es que la clave digital para dicha autorizaci√≥n ten√≠a que almacenarse en el servidor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tuve que complicar la autorizaci√≥n de "invitado" para el segundo prototipo. El c√≥digo de acceso de invitado ahora consta de dos claves, llam√©moslas "servidor" y "privado". El servidor es necesario para establecer una cuenta de invitado en el servidor y privado para abrir el bloqueo. La sala del servidor se almacenar√° expl√≠citamente en el servidor, y desde la privada solo habr√° un hash, pero no uno simple, sino un HMAC con una llave digital para la cerradura. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora la sesi√≥n de autorizaci√≥n de invitado se ve as√≠: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. La aplicaci√≥n de invitado env√≠a la clave del "servidor" al controlador (como en el primer prototipo, su hash) y </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. El servidor la verifica de la misma manera, pero en lugar del comando abierto env√≠a el hash de la clave privada.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. El controlador compara el hash de la clave privada recibida del servidor con la calculada de forma independiente y, si coincide, se abre el bloqueo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, el servidor no almacena nada que pueda abrir el bloqueo. No funcionar√° generar el hash deseado sin conocer la clave digital. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El mismo Bluetooth tambi√©n se utiliza para el acceso "maestro" sin Internet. El controlador recibe comandos a trav√©s de √©l, responde con un c√≥digo √∫nico, que debe firmarse con la clave digital correcta durante 2 segundos.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A trav√©s de √©l, quiero hacer la configuraci√≥n b√°sica del controlador. </font><font style="vertical-align: inherit;">El propietario presiona un bot√≥n especial en el controlador, despu√©s de lo cual comienza a aceptar un conjunto extendido de comandos, como configurar la ID de bloqueo, las claves secretas, la direcci√≥n del puerto del servidor, la configuraci√≥n de red, etc. </font><font style="vertical-align: inherit;">Pero en Adruin se acab√≥ la memoria y el boceto no encaja. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final, una breve demostraci√≥n del trabajo.</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.youtube.com/embed/dfSnXt631KQ%3Ffeature%3Doembed&amp;usg=ALkJrhiWqfmR42jgYOJ1hZfi036A2886vA" frameborder="0" allowfullscreen=""></iframe></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es382677/">https://habr.com/ru/post/es382677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es382665/index.html">Estrategias y t√°cticas de email marketing. Parte 1</a></li>
<li><a href="../es382667/index.html">Intel anuncia el primer procesador port√°til Xeon</a></li>
<li><a href="../es382669/index.html">Un limpiador. Lucha contra el software inmundo</a></li>
<li><a href="../es382673/index.html">Aibo Robot Perro Mortalidad</a></li>
<li><a href="../es382675/index.html">Perezosos gigantes del pasado podr√≠an poner l√≠neas de metro</a></li>
<li><a href="../es382679/index.html">Los astr√≥nomos pudieron obtener im√°genes del lago de lava en la superficie de Io, el sat√©lite de J√∫piter</a></li>
<li><a href="../es382681/index.html">5 horas de acercamiento de Soyuz a la EEI - en un video de medio minuto en YouTube</a></li>
<li><a href="../es382685/index.html">Mira mas alla del horizonte</a></li>
<li><a href="../es382687/index.html">Los cient√≠ficos del CERN est√°n preparando un "campo de fuerza" para proteger a los astronautas de la radiaci√≥n</a></li>
<li><a href="../es382689/index.html">Controlamos la iluminaci√≥n del apartamento (NooLite, Raspberry Pi y WebIOPi)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>