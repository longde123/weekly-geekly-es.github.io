<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌒 😷 🚨 Utilisation de la bibliothèque FPC InternetPCools dans Delphi 👃 👨🏿‍🏭 🧜🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En fait, l'article est un peu plus large - il décrit un moyen d'utiliser de manière transparente de nombreuses autres bibliothèques (et pas seulement ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utilisation de la bibliothèque FPC InternetPCools dans Delphi</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415617/">  En fait, l'article est un peu plus large - il décrit un moyen d'utiliser de manière <i>transparente de</i> nombreuses autres bibliothèques (et pas seulement du monde de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Free Pascal</a> ), et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">InternetTools a été</a> choisi en raison de sa propriété remarquable - c'est le cas quand (étonnamment) est manquant Version Delphi avec les mêmes fonctionnalités et facilité d'utilisation. <br><br>  Cette bibliothèque est conçue pour extraire des informations (analyse) de documents Web (XML et HTML), vous permettant d'utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des langages de requête de haut niveau</a> tels que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">XPath</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">XQuery</a> pour indiquer les données requises et, en option, offrant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un accès direct</a> à éléments d'un arbre construit sur le document. <br><a name="habracut"></a><br><h2>  Introduction aux InternetTools </h2><br>  D'autres éléments seront illustrés sur la base d'une tâche assez simple, ce qui implique d'obtenir les éléments des listes à puces et numérotées de cet article qui contiennent des liens, pour lesquels, si vous regardez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> , un si petit code suffit (il est construit sur la base de l'avant-dernier exemple avec de petites modifications sans principes) ): <br><br><a name="FirstTask"></a><pre><code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> xquery; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ArticleURL = <span class="hljs-string"><span class="hljs-string">'https://habr.com/post/415617'</span></span>; ListXPath = <span class="hljs-string"><span class="hljs-string">'//div[@class="post__body post__body_full"]//li[a]'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ListValue: IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ListValue <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xqvalue(ArticleURL).retrieve.map(ListXPath) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln(ListValue.toString); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  Cependant, maintenant ce code compact et orienté objet ne peut être écrit qu'en Free Pascal, mais nous devons être en mesure d'utiliser tout ce que cette bibliothèque fournit dans une application Delphi, et de préférence dans un style similaire, avec les mêmes commodités;  Il est également important de noter qu'InternetTools est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sûr pour les threads</a> (y accéder est autorisé à partir de plusieurs threads en même temps), donc notre option devrait le fournir. <br><br><h2>  Méthodes d'implémentation </h2><br>  Si vous abordez la tâche le plus loin possible, il y a plusieurs façons d'utiliser quelque chose écrit dans une autre <abbr title="Langage de programmation">langue</abbr> - ils formeront 3 grands groupes: <br><br><ol><li>  Placer la bibliothèque dans un <b>processus séparé</b> , dont le fichier exécutable est créé par les forces, dans ce cas, <abbr title="Compilateur pascal gratuit">FPC</abbr> .  Cette méthode peut également être divisée en deux catégories pour une communication réseau possible: <br><ul><li>  Le domaine de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">communication interprocessus est</a> limité à un seul ordinateur.  Les moyens les plus productifs (niveau conditionnellement bas), destinés à ce type d'échange, incluent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la mémoire partagée</a> et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">canaux sans nom</a> . </li><li>  Les processus sont accessibles via le réseau - cela est fourni par des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">canaux nommés</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RPC</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DCOM</a> , etc. </li></ul></li><li>  Encapsulation d'une bibliothèque dans une <b>DLL</b> (ci-après parfois dénommée «bibliothèque dynamique»), travaillant, par définition, dans le cadre d'un processus unique.  Bien que les objets COM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">puissent être placés</a> dans des DLL, l'article considérera une méthode plus simple et moins longue, qui offre, avec tout cela, le même confort lors de l'appel des fonctionnalités de la bibliothèque. </li><li>  <b>Portage</b>  Comme dans les cas précédents, la pertinence de cette approche - réécrire du code dans une autre langue - est déterminée par l'équilibre entre ses avantages et ses inconvénients, mais dans la situation avec InternetTools, les inconvénients du portage sont beaucoup plus importants, à savoir: en raison de la quantité considérable de code de bibliothèque, vous devrez effectuer un travail très sérieux (même en tenant compte de la similitude des langages de programmation), et aussi périodiquement, en raison du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">développement du portable</a> , la tâche de transférer les corrections et les nouvelles fonctionnalités vers Delphi apparaîtra. </li></ol><br><h2>  Dll </h2><br>  De plus, afin de donner au lecteur la possibilité de ressentir la différence, il existe 2 options qui se distinguent par la commodité de leur utilisation. <br><br><h3>  Implémentation "classique" </h3><br>  Essayons de commencer à utiliser InternetTools dans un style procédural dicté par la nature même d'une bibliothèque dynamique qui ne peut exporter que des fonctions et des procédures;  nous allons rendre la façon de communiquer avec la DLL similaire à WinAPI, lorsque le handle d'une certaine ressource est d'abord demandé, après quoi un travail utile est effectué, puis le handle résultant est détruit (fermé).  Il n'est pas nécessaire de considérer cette option comme un modèle dans tout - elle est choisie uniquement pour la démonstration et la comparaison ultérieure avec la seconde - une sorte de parent pauvre. <br><br>  La composition et la propriété des fichiers de la solution proposée ressembleront à ceci (les flèches indiquent les dépendances): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dt/uv/8p/dtuv8pkm7bwa0_rvgnkhxouoc5i.png" alt="La composition des fichiers de l'implémentation &quot;classique&quot;" width="600"></div><br><br><h4>  Module InternetTools.Types </h4><br>  Étant donné que les deux langages - Delphi et Free Pascal - sont très similaires dans ce cas, il est très raisonnable de sélectionner un tel module commun contenant les types utilisés dans la liste d'exportation DLL, afin de ne pas dupliquer leur définition dans l'application <code>InternetToolsUsage</code> . , qui inclut des prototypes de fonctionnalités d'une bibliothèque dynamique: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> InternetTools.Types; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TXQHandle = Integer; <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  Dans cette implémentation, un seul type timide est défini, mais à l'avenir, le module «mûrira» et son utilité deviendra indéniable. <br><br><h4>  Bibliothèque dynamique InternetTools </h4><br>  La composition des procédures et fonctions de la DLL est choisie pour être minimale, mais suffisante pour la mise en œuvre de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tâche</a> ci-dessus: <br><br><a name="ClassicLibrary"></a><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">library</span></span> InternetTools; <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> InternetTools.Types; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenDocument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URL: WideString)</span></span></span><span class="hljs-function">:</span></span> TXQHandle; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloseHandle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Handle: TXQHandle)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Handle: TXQHandle; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> XQuery: WideString)</span></span></span><span class="hljs-function">:</span></span> TXQHandle; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Count</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Handle: TXQHandle)</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValueByIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Handle: TXQHandle; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Index</span></span></span></span><span class="hljs-function"><span class="hljs-params">: Integer)</span></span></span><span class="hljs-function">:</span></span> WideString; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exports</span></span> OpenDocument, CloseHandle, Map, Count, ValueByIndex; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  En raison de la nature démo de l'implémentation actuelle, le code complet n'est pas donné - beaucoup plus important est de savoir comment cette API la plus simple sera utilisée plus tard.  Ici, vous n'avez tout simplement pas besoin d'oublier l'exigence de sécurité des threads, qui, bien que cela nécessitera des efforts, mais ce ne sera pas quelque chose de compliqué. <br><br><h4>  InternetToolsUsage Application </h4><br>  Grâce aux préparatifs précédents, il est devenu possible de réécrire l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple de liste</a> dans Delphi: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">program</span></span> InternetToolsUsage; ... <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> InternetTools.Types; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DLLName = <span class="hljs-string"><span class="hljs-string">'InternetTools.dll'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenDocument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URL: WideString)</span></span></span><span class="hljs-function">:</span></span> TXQHandle; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> DLLName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloseHandle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Handle: TXQHandle)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> DLLName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Handle: TXQHandle; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> XQuery: WideString)</span></span></span><span class="hljs-function">:</span></span> TXQHandle; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> DLLName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Count</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Handle: TXQHandle)</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> DLLName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValueByIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Handle: TXQHandle; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Index</span></span></span></span><span class="hljs-function"><span class="hljs-params">: Integer)</span></span></span><span class="hljs-function">:</span></span> WideString; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> DLLName; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ArticleURL = <span class="hljs-string"><span class="hljs-string">'https://habr.com/post/415617'</span></span>; ListXPath = <span class="hljs-string"><span class="hljs-string">'//div[@class="post__body post__body_full"]//li[a]'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RootHandle, ListHandle: TXQHandle; I: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> RootHandle := OpenDocument(ArticleURL); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ListHandle := Map(RootHandle, ListXPath); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> I := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count(ListHandle) - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln( ValueByIndex(ListHandle, I) ); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> CloseHandle(ListHandle); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> CloseHandle(RootHandle); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ReadLn; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  Si vous ne prenez pas en compte les prototypes de fonctions et procédures de la bibliothèque dynamique, vous ne pouvez pas dire que le code est catastrophiquement plus lourd par rapport à la version sur Free Pascal, mais que si nous compliquons un peu la tâche et essayons de filtrer certains éléments et d'afficher les adresses de liens contenues dans restant: <br><br><a name="SecondTask"></a><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> xquery; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ArticleURL = <span class="hljs-string"><span class="hljs-string">'https://habr.com/post/415617'</span></span>; ListXPath = <span class="hljs-string"><span class="hljs-string">'//div[@class="post__body post__body_full"]//li[a]'</span></span>; HrefXPath = <span class="hljs-string"><span class="hljs-string">'./a/@href'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ListValue, HrefValue: IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ListValue <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xqvalue(ArticleURL).retrieve.map(ListXPath) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-comment"><span class="hljs-comment">{   }</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> HrefValue <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ListValue.map(HrefXPath) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln(HrefValue.toString); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  Il est possible de le faire avec la DLL API actuelle, mais la verbosité du résultat est déjà très élevée, ce qui réduit non seulement considérablement la lisibilité du code, mais aussi (et non moins important) l'éloigne de ce qui précède: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">program</span></span> InternetToolsUsage; ... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ArticleURL = <span class="hljs-string"><span class="hljs-string">'https://habr.com/post/415617'</span></span>; ListXPath = <span class="hljs-string"><span class="hljs-string">'//div[@class="post__body post__body_full"]//li[a]'</span></span>; HrefXPath = <span class="hljs-string"><span class="hljs-string">'./a/@href'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RootHandle, ListHandle, HrefHandle: TXQHandle; I, J: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> RootHandle := OpenDocument(ArticleURL); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ListHandle := Map(RootHandle, ListXPath); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> I := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count(ListHandle) - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-comment"><span class="hljs-comment">{   }</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> HrefHandle := Map(ListHandle, HrefXPath); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> J := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count(HrefHandle) - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln( ValueByIndex(HrefHandle, J) ); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> CloseHandle(HrefHandle); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> CloseHandle(ListHandle); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> CloseHandle(RootHandle); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ReadLn; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  De toute évidence - dans des cas réels et plus complexes, le volume d'écriture ne fera que croître rapidement, et nous allons donc passer à une solution qui est exempte de tels problèmes. <br><br><h3>  Implémentation de l'interface </h3><br>  Le style procédural de travailler avec la bibliothèque, comme on vient de le montrer, est possible, mais présente des inconvénients importants.  Étant donné que la DLL en tant que telle prend en charge l'utilisation d'interfaces (comme les types de données reçus et renvoyés), vous pouvez organiser le travail avec InternetTools de la même manière pratique que lorsque vous l'utilisez avec Free Pascal.  Dans ce cas, il est souhaitable de modifier légèrement la composition des fichiers afin de répartir la déclaration et l'implémentation des interfaces dans des modules séparés: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ik/48/ki/ik48kioqk2f51pxpdscpsid-auo.png" alt="La composition des fichiers d'implémentation de l'interface" width="600"></div><br>  Comme précédemment, nous examinerons chacun des fichiers en séquence. <br><br><h4>  Module InternetTools.Types </h4><br>  Déclare les interfaces à implémenter dans la DLL: <br><br><a name="InternetTools_Types"></a><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> InternetTools.Types; <span class="hljs-meta"><span class="hljs-meta">{$IFDEF FPC}</span></span> <span class="hljs-meta"><span class="hljs-meta">{$MODE Delphi}</span></span> <span class="hljs-meta"><span class="hljs-meta">{$ENDIF}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> IXQValue = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>; IXQValueEnumerator = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> [<span class="hljs-string"><span class="hljs-string">'{781B23DC-E8E8-4490-97EE-2332B3736466}'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveNext</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCurrent</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Current: IXQValue <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetCurrent; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; IXQValue = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> [<span class="hljs-string"><span class="hljs-string">'{DCE33144-A75F-4C53-8D25-6D9BD78B91E4}'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEnumerator</span></span></span><span class="hljs-function">:</span></span> IXQValueEnumerator; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URL: WideString)</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> XQuery: WideString)</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">:</span></span> WideString; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  Les directives de compilation conditionnelle sont nécessaires en raison de l'utilisation du module inchangé dans les projets Delphi et FPC. <br><br>  L'interface <code>IXQValueEnumerator</code> en principe facultative, cependant, afin de pouvoir utiliser des boucles de la forme " <code>for ... in ...</code> " comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple</a> , vous ne pouvez pas vous en passer;  la deuxième interface est la principale et est un wrapper analogique sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>IXQValue</code></a> d'InternetTools (il a été spécialement conçu du même nom pour faciliter la corrélation du futur code Delphi avec la documentation de la bibliothèque sur Free Pascal).  Si nous considérons le module en termes de modèles de conception, les interfaces déclarées sont des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">adaptateurs</a> , bien qu'avec une petite fonctionnalité - leur implémentation est située dans une bibliothèque dynamique. <br><br>  La nécessité de définir le type d'appel <code>safecall</code> pour toutes les méthodes est bien décrite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  L'obligation d'utiliser <code>WideString</code> au lieu de chaînes «natives» ne sera pas non plus étayée, car le sujet de l'échange de structures de données dynamiques avec des DLL dépasse le cadre de cet article. <br><br><h4>  Module InternetTools.Realization </h4><br>  La première en termes d'importance et de volume - c'est lui qui, comme le reflète le titre, contiendra l'implémentation des interfaces de la précédente: pour chacune d'elles, la seule classe <code>TXQValue</code> se voit <code>TXQValue</code> , dont les méthodes sont si simples que presque toutes consistent en une seule ligne de code (c'est assez attendu, car toutes les fonctionnalités nécessaires sont déjà contenues dans la bibliothèque - ici, il vous suffit d'y accéder): <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> InternetTools.Realization; <span class="hljs-meta"><span class="hljs-meta">{$MODE Delphi}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> xquery, InternetTools.Types; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> IOriginalXQValue = xquery.IXQValue; <span class="hljs-title"><span class="hljs-title">TXQValue</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TInterfacedObject, IXQValue, IXQValueEnumerator) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FOriginalXQValue: IOriginalXQValue; FEnumerator: TXQValueEnumerator; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveNext</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCurrent</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEnumerator</span></span></span><span class="hljs-function">:</span></span> IXQValueEnumerator; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URL: WideString)</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> XQuery: WideString)</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">:</span></span> WideString; <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">reintroduce</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> OriginalXQValue: IOriginalXQValue)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">overload</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SafeCallException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExceptObject: TObject; ExceptAddr: CodePointer)</span></span></span><span class="hljs-function">:</span></span> HResult; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> sysutils, comobj, w32internetaccess; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXQValue</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveNext</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := FEnumerator.MoveNext; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXQValue</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCurrent</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := TXQValue.Create(FEnumerator.Current); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXQValue</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEnumerator</span></span></span><span class="hljs-function">:</span></span> IXQValueEnumerator; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FEnumerator := FOriginalXQValue.GetEnumerator; Result := Self; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXQValue</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenURL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URL: WideString)</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FOriginalXQValue := xqvalue(URL).retrieve; Result := Self; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXQValue</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> XQuery: WideString)</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := TXQValue.Create( FOriginalXQValue.map(XQuery) ); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXQValue</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">:</span></span> WideString; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := FOriginalXQValue.toJoinedString(LineEnding); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXQValue</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> OriginalXQValue: IOriginalXQValue)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FOriginalXQValue := OriginalXQValue; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXQValue</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SafeCallException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExceptObject: TObject; ExceptAddr: CodePointer)</span></span></span><span class="hljs-function">:</span></span> HResult; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := HandleSafeCallException(ExceptObject, ExceptAddr, GUID_NULL, ExceptObject.ClassName, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  Cela vaut la peine de s'arrêter à la méthode <code>SafeCallException</code> - son blocage, dans l'ensemble, n'est pas vital ( <code>TXQValue</code> performances <code>TXQValue</code> n'en souffriront pas), cependant, le code donné ici vous permet de passer le texte d'exception du côté Delphi qui se produira dans les méthodes de safecall (détails, encore une fois, se trouve dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> récent). <br><br>  Cette solution, en plus de tout le reste, est <code>IXQValue</code> threads - à condition que <code>IXQValue</code> reçue, par exemple via <code>OpenURL</code> , ne soit pas transmise entre les threads.  Cela est dû au fait que la mise en œuvre de l'interface ne redirige que les appels vers les InternetTools déjà thread-safe. <br><br><h4>  Bibliothèque dynamique InternetTools </h4><br>  En raison du travail effectué dans les modules ci-dessus, il suffit que la DLL exporte une seule fonction (comparer avec l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">option</a> où le style procédural a été utilisé): <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">library</span></span> InternetTools; <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> InternetTools.Types, InternetTools.Realization; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetXQValue</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := TXQValue.Create; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exports</span></span> GetXQValue; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> SetMultiByteConversionCodePage(CP_UTF8); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  L'appel à la procédure <code>SetMultiByteConversionCodePage</code> conçu pour fonctionner correctement avec les chaînes Unicode. <br><br><h4>  InternetToolsUsage Application </h4><br>  Si nous formalisons maintenant la solution Delphi de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple initial</a> sur la base des interfaces proposées, elle ne différera guère de celle de Free Pascal, ce qui signifie que la tâche définie au tout début de l'article peut être considérée comme terminée: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">program</span></span> InternetToolsUsage; ... <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> System.Win.ComObj, InternetTools.Types; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DLLName = <span class="hljs-string"><span class="hljs-string">'InternetTools.dll'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetXQValue</span></span></span><span class="hljs-function">:</span></span> IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> DLLName; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ArticleURL = <span class="hljs-string"><span class="hljs-string">'https://habr.com/post/415617'</span></span>; ListXPath = <span class="hljs-string"><span class="hljs-string">'//div[@class="post__body post__body_full"]//li[a]'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ListValue: IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ListValue <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> GetXQValue.OpenURL(ArticleURL).Map(ListXPath) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln(ListValue.ToString); ReadLn; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  Le module <code>System.Win.ComObj</code> n'est pas connecté accidentellement - sans lui, le texte de toutes les exceptions safecall deviendra une «exception dans la méthode safecall» sans visage, et avec lui la valeur d'origine générée dans la DLL. <br><br>  Un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple</a> légèrement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compliqué</a> a également des différences minimes sur Delphi: <br><br><pre> <code class="delphi hljs">... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ArticleURL = <span class="hljs-string"><span class="hljs-string">'https://habr.com/post/415617'</span></span>; ListXPath = <span class="hljs-string"><span class="hljs-string">'//div[@class="post__body post__body_full"]//li[a]'</span></span>; HrefXPath = <span class="hljs-string"><span class="hljs-string">'./a/@href'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ListValue, HrefValue: IXQValue; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ListValue <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> GetXQValue.OpenURL(ArticleURL).Map(ListXPath) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-comment"><span class="hljs-comment">{   }</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> HrefValue <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ListValue.Map(HrefXPath) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln(HrefValue.ToString); ReadLn; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br><h4>  Les fonctionnalités restantes de la bibliothèque </h4><br>  Si vous regardez toutes les capacités de l'interface <a href="">IXQValue</a> d'InternetTools, vous verrez que l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interface correspondante</a> d' <code>InternetTools.Types</code> définit seulement 2 méthodes ( <code>Map</code> et <code>ToString</code> ) de l'ensemble riche;  ajouter le reste que le lecteur juge nécessaire dans son cas particulier s'effectue exactement de la même manière et simplement: les méthodes nécessaires sont écrites dans <code>InternetTools.Types</code> , après quoi elles sont construites dans le module <code>InternetTools.Realization</code> avec du code (le plus souvent sur une seule ligne). <br><br>  Si vous devez utiliser une fonctionnalité légèrement différente, par exemple, la gestion des cookies, la séquence des étapes est très similaire: <br><br><ol><li>  Une nouvelle interface est <code>InternetTools.Types</code> dans <code>InternetTools.Types</code> : <br><br><pre> <code class="delphi hljs">... ICookies = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> [<span class="hljs-string"><span class="hljs-string">'{21D0CC9A-204D-44D2-AF00-98E9E04412CD}'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URL, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Name</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Value: WideString)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ...</code> </pre> </li><li>  Il est ensuite implémenté dans le module <code>InternetTools.Realization</code> : <br><br><pre> <code class="delphi hljs">... <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-title"><span class="hljs-title">TCookies</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TInterfacedObject, ICookies) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URL, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Name</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Value: WideString)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">safecall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SafeCallException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExceptObject: TObject; ExceptAddr: CodePointer)</span></span></span><span class="hljs-function">:</span></span> HResult; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> ..., internetaccess; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TCookies</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URL, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Name</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Value: WideString)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> defaultInternet.cookies.setCookie( decodeURL(URL).host, decodeURL(URL).path, <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>, Value, [] ); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TCookies</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> defaultInternet.cookies.clear; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ...</code> </pre> </li><li>  Après cela, une nouvelle fonction exportée est retournée à la DLL qui renvoie cette interface: <br><br><pre> <code class="delphi hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCookies</span></span></span><span class="hljs-function">:</span></span> ICookies; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := TCookies.Create; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exports</span></span> ..., GetCookies; ...</code> </pre> </li></ol><br><h4>  Libération de ressources </h4><br>  Bien que la bibliothèque InternetTools soit basée sur des interfaces qui contrôlent automatiquement la durée de vie, il existe une nuance non évidente qui semblerait entraîner des fuites de mémoire - si vous exécutez la prochaine application console (créée sur Delphi, rien ne changera dans le cas de FPC), puis à chaque fois que vous appuyez sur la touche entrée, la mémoire consommée par le processus augmente: <br><br><pre> <code class="delphi hljs">... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ArticleURL = <span class="hljs-string"><span class="hljs-string">'https://habr.com/post/415617'</span></span>; TitleXPath = <span class="hljs-string"><span class="hljs-string">'//head/title'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> I: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> I := <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Writeln( GetXQValue.OpenURL(ArticleURL).Map(TitleXPath).ToString ); Readln; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  Il n'y a pas d'erreur avec l'utilisation des interfaces ici.  Le problème est qu'InternetTools ne libère pas ses ressources internes allouées pendant l'analyse du document (dans la méthode <code>OpenURL</code> ) - cela doit être fait <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">explicitement une</a> fois le travail avec lui terminé;  à ces fins, le module de bibliothèque <code>xquery</code> fournit la procédure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>freeThreadVars</code></a> , dont l'appel à partir d'une application Delphi peut être logiquement assuré en développant la liste d'exportation DLL: <br><br><pre> <code class="delphi hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FreeResources</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> freeThreadVars; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exports</span></span> ..., FreeResources; ...</code> </pre> <br>  Après son utilisation, la perte de ressources s'arrêtera: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> I := <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Writeln( GetXQValue.OpenURL(ArticleURL).Map(TitleXPath).ToString ); FreeResources; Readln; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  Il est important de comprendre ce qui suit - un appel à <code>FreeResources</code> conduit au fait que toutes les interfaces précédemment reçues <code>FreeResources</code> sens et toute tentative de les utiliser est inacceptable. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415617/">https://habr.com/ru/post/fr415617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415601/index.html">Cluster Kubernetes HA avec containerd. Ou y a-t-il une vie sans docker?</a></li>
<li><a href="../fr415605/index.html">Comment nous avons économisé le traitement des cartes avec Exadata</a></li>
<li><a href="../fr415611/index.html">PKI: bibliothèques GCrypt et KSBA comme alternative à OpenSSL avec prise en charge de la cryptographie russe. Continuation</a></li>
<li><a href="../fr415613/index.html">Pourquoi vous ne devriez pas acheter de lustres à LED</a></li>
<li><a href="../fr415615/index.html">Interaction avec le serveur via l'API dans iOS sur Swift 3. Partie 2</a></li>
<li><a href="../fr415619/index.html">Apple et Samsung terminent une guerre des brevets de 7 ans</a></li>
<li><a href="../fr415621/index.html">Système de surveillance minière</a></li>
<li><a href="../fr415623/index.html">La dynamique du vol vertical d'un avion plus léger que l'air</a></li>
<li><a href="../fr415625/index.html">Kubernetes: webinaire (4 juillet à 19h30) et intensif (3-5 août)</a></li>
<li><a href="../fr415627/index.html">Comment (pas) vous devez être un connard: l'histoire d'un directeur technique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>