<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎯 ✉️ 🍔 Comment ajouter des chèques à NoVerify sans écrire une seule ligne de code Go 🐹 🥨 👩🏼‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fonctionnalité de tueur est apparue dans l'analyseur statique NoVerify : une façon déclarative de décrire les inspections qui ne nécessitent pas d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment ajouter des chèques à NoVerify sans écrire une seule ligne de code Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vk/blog/473718/"><p>  Une fonctionnalité de tueur est apparue dans l'analyseur statique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NoVerify</a> : une façon déclarative de décrire les inspections qui ne nécessitent pas de programmation Go ni de compilation de code. </p><br><p>  Pour vous intriguer, je vais vous montrer une description d'une inspection simple mais utile: </p><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> duplicated sub-expressions inside boolean expression */</span></span> $x &amp;&amp; $x;</code> </pre> <br><p>  Cette inspection trouve toutes les expressions logiques <code>&amp;&amp;</code> où les opérandes gauche et droit sont identiques. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NoVerify</a> est un analyseur statique pour PHP écrit en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Go</a> .  Vous pouvez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lire</a> dans l'article « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NoVerify: Linter pour PHP de l'équipe VKontakte</a> ».  Et dans cette revue, je parlerai de la nouvelle fonctionnalité et de la façon dont nous y sommes arrivés. </p><br><p><img src="https://habrastorage.org/webt/gv/ru/74/gvru74yeqcbjdphiuwj4tieehoq.png"></p><a name="habracut"></a><br><h1 id="predposylki">  Contexte </h1><br><p>  Quand même pour une simple nouvelle vérification vous avez besoin d'écrire quelques dizaines de lignes de code sur Go, vous commencez à vous demander: est-ce possible autrement? </p><br><p>  Sur Go, nous avons écrit l'inférence de type, l'ensemble du pipeline du linter, le cache de métadonnées et de nombreux autres éléments importants sans lesquels NoVerify est impossible.  Ces composants sont uniques, mais les tâches comme «interdire d'appeler une fonction X avec un ensemble d'arguments Y» ne le font pas.  Juste pour ces tâches simples, le mécanisme des règles dynamiques a été ajouté. </p><br><p>  Les règles dynamiques vous permettent de séparer les composants internes complexes de la résolution de problèmes typiques.  Le fichier de définition peut être stocké et versionné séparément - il peut être édité par des personnes qui ne sont pas liées au développement de NoVerify lui-même.  Chaque règle met en œuvre une inspection de code (que nous appellerons parfois vérification). </p><br><p>  Oui, si nous avons un langage pour décrire ces règles, vous pouvez toujours écrire un modèle sémantiquement incorrect ou ignorer certaines restrictions de type - et cela conduit à des faux positifs.  Néanmoins, la course aux données ou le déréférencement du pointeur <code>nil</code> travers le langage des règles n'est pas entré. </p><br><h1 id="yazyk-opisaniya-shablonov">  Langage de description du modèle </h1><br><p>  Le langage de description est syntaxiquement compatible avec PHP.  Cela simplifie son étude et permet également d'éditer des fichiers de règles en utilisant le même PhpStorm. </p><br><p>  Au tout début du fichier de règles, il est recommandé d'insérer une directive apaisant votre IDE préféré: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** *      , *        PHP-. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@noinspection</span></span></span><span class="hljs-comment"> ALL */</span></span> <span class="hljs-comment"><span class="hljs-comment">// ...  —   .</span></span></code> </pre> <br><p>  Ma première expérience avec la syntaxe et les filtres possibles pour les modèles a été <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">phpgrep</a> .  Il peut être utile en soi, mais dans NoVerify, il est devenu encore plus intéressant, car il a désormais accès aux informations de type. </p><br><p>  Certains de mes collègues ont déjà essayé phpgrep dans leur travail, et c'était un autre argument en faveur du choix d'une telle <a href="">syntaxe</a> . </p><br><p>  Phpgrep lui-même est une adaptation gogrep pour PHP (vous pouvez également être intéressé par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cgrep</a> ).  En utilisant ce programme, vous pouvez rechercher du code via des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">modèles de syntaxe</a> . </p><br><p>  Une alternative serait la syntaxe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">structurelle de recherche et de remplacement</a> (SSR) de PhpStorm.  Les avantages sont évidents - il s'agit d'un format existant, mais j'ai découvert cette fonctionnalité après avoir implémenté phpgrep.  Vous pouvez bien sûr fournir une explication technique: il existe une syntaxe incompatible avec PHP et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notre analyseur</a> ne la maîtrisera pas, mais cette "vraie" raison convaincante a été découverte après avoir écrit le vélo. </p><br><div class="spoiler">  <b class="spoiler_title">En fait, il y avait une autre option</b> <div class="spoiler_text"><hr><br><p>  Il pourrait être nécessaire d'afficher un modèle avec du code PHP presque un à un - ou d'aller dans l'autre sens: inventer un nouveau langage, par exemple avec la syntaxe des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">expressions S.</a> </p><br><pre> <code class="plaintext hljs">PHP-like Lisp-like ----------------------------- $x = $y | (expr = $x $y) fn($x, 1) | (expr call fn $x 1)          : (or (expr == (type string (expr)) (expr)) (expr == (expr) (type string (expr))))</code> </pre> <br><p>  Au final, j'ai pensé que la lisibilité des modèles est toujours importante, et nous pouvons ajouter des filtres via les attributs phpdoc. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">clang-query</a> est un exemple d'une idée similaire, mais il utilise une syntaxe plus traditionnelle. </p><br><hr></div></div><br><h1 id="sozdayom-i-zapuskaem-svoyu-diagnostiku">  Nous créons et exécutons nos propres diagnostics! </h1><br><p>  Essayons d'implémenter nos nouveaux diagnostics pour l'analyseur. </p><br><p>  Pour ce faire, vous devez installer NoVerify.  Prenez la <a href="">version binaire</a> si vous n'avez pas de chaîne d'outils Go dans le système (si vous en avez une, vous pouvez tout compiler à partir de la source). </p><br><div class="scrollable-table"><table><tbody><tr><td>  Si vous n'installez pas NoVerify, vous pouvez continuer à lire plus loin, mais faites semblant de reproduire les étapes répertoriées et admirez le résultat! <br></td></tr></tbody></table></div><br><h2 id="postanovka-zadachi">  Énoncé du problème </h2><br><p>  PHP a de nombreuses fonctions intéressantes, dont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parse_str</a> .  Sa signature: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   encoded_string,     //   URL,      //   (  ,    result). parse_str ( string $encoded_string [, array &amp;$result ] ) : void</span></span></code> </pre> <br><p>  Vous comprendrez ce qui ne va pas ici si vous regardez cet exemple dans la documentation: </p><br><pre> <code class="php hljs">$str = <span class="hljs-string"><span class="hljs-string">"first=value&amp;arr[]=foo+bar&amp;arr[]=baz"</span></span>; parse_str($str); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $first; <span class="hljs-comment"><span class="hljs-comment">// value echo $arr[0]; // foo bar echo $arr[1]; // baz</span></span></code> </pre> <br><p>  Mmm, les paramètres de la chaîne étaient dans la portée actuelle.  Pour éviter cela, nous aurons besoin dans notre nouveau test d'utiliser le deuxième paramètre de la fonction, <code>$result</code> , pour que le résultat soit écrit dans ce tableau. </p><br><h2 id="sozdanie-svoey-diagnostiki">  Créez vos propres diagnostics </h2><br><p>  Créez le fichier <code>myrules.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> parse_str without second argument */</span></span> parse_str($_);</code> </pre> <br><p>  Le fichier de règles en général est une liste d'expressions au niveau supérieur, chacune étant interprétée comme un modèle phpgrep.  Un commentaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">phpdoc</a> spécial est attendu pour chacun de ces modèles.  Un seul attribut est requis - une catégorie d'erreur avec un texte d'avertissement. </p><br><p>  Il y a maintenant quatre niveaux au total: <code>error</code> , <code>warning</code> , <code>info</code> et <code>maybe</code> - <code>maybe</code> .  Les deux premiers sont critiques: le linter retournera un code différent de zéro après l'exécution si au moins une des règles critiques fonctionne.  Après l'attribut lui-même, un texte d'avertissement sera émis par le linter en cas de déclenchement du modèle. </p><br><p>  Le modèle que nous avons écrit utilise <code>$_</code> - il s'agit d'une variable de modèle sans nom.  Nous pourrions l'appeler, par exemple, <code>$x</code> , mais comme nous ne faisons rien avec cette variable, nous pouvons lui donner un nom «vide».  La différence entre les variables de modèle et les variables PHP est que les premières coïncident avec absolument n'importe quelle expression, et pas seulement avec une variable «littérale».  C'est pratique: nous devons souvent chercher des expressions inconnues plutôt que des variables spécifiques. </p><br><h2 id="zapusk-novoy-diagnostiki">  Démarrage d'un nouveau diagnostic </h2><br><p>  Créez un petit fichier de test pour le débogage, <code>test.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ parse_str($x); <span class="hljs-comment"><span class="hljs-comment">//      }</span></span></code> </pre> <br><p>  Ensuite, exécutez NoVerify avec nos règles sur ce fichier: </p><br><pre> <code class="bash hljs">$ noverify -rules myrules.php test.php</code> </pre> <br><p>  Notre avertissement ressemblera à ceci: </p><br><pre> <code class="plaintext hljs">WARNING myrules.php:4: parse_str without second argument at test.php:4 parse_str($x); ^^^^^^^^^^^^^</code> </pre> <br><p>  Le nom de la vérification par défaut est le nom du fichier de règles et la ligne qui définit cette vérification.  Dans notre cas, c'est <code>myrules.php:4</code> . </p><br><p>  Vous pouvez définir votre nom à l'aide de l' <code>@name &lt;name&gt;</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Exemple @Name</b> <div class="spoiler_text"><hr><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@name</span></span></span><span class="hljs-comment"> parseStrResult * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> parse_str without second argument */</span></span> parse_str($_);</code> </pre> <br><pre> <code class="plaintext hljs">WARNING parseStrResult: parse_str without second argument at test.php:4 parse_str($x); ^^^^^^^^^^^^^</code> </pre> <br><p>  Les règles nommées succombent aux lois des autres diagnostics: </p><br><ul><li>  Peut être désactivé via <code>-exclude-checks</code> </li><li>  <code>-critical</code> niveau de <code>-critical</code> peut être redéfini via <code>-critical</code> </li></ul><br><hr></div></div><br><h1 id="rabota-s-tipami">  Travailler avec des types </h1><br><p>  L'exemple précédent est bon pour hello world - mais souvent nous devons connaître les types d'expressions afin de réduire le nombre d'opérations de diagnostic </p><br><p>  Par exemple, pour la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">in_array,</a> nous demandons l'argument <code>$strict=true</code> lorsque le premier argument ( <code>$needle</code> ) est de type chaîne. </p><br><p>  Pour cela, nous avons des filtres de résultats. </p><br><p>  Un tel filtre est <code>@type &lt;type&gt; &lt;var&gt;</code> .  Il vous permet de supprimer tout ce qui ne correspond pas aux types énumérés. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> 3rd arg of in_array must be true when comparing strings * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> string $needle */</span></span> in_array($needle, $_);</code> </pre> <br><p>  Ici, nous avons donné le nom du premier argument à l'appel <code>in_array</code> pour lui <code>in_array</code> un filtre de type.  Un avertissement ne sera émis que lorsque le type de <code>$needle</code> est une <code>string</code> . </p><br><p>  Les jeux de filtres peuvent être combinés avec l'opérateur <code>@or</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *     -. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> strings must be compared using '===' operator * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> string $x * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@or</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> string $y */</span></span> $x == $y;</code> </pre> <br><p>  Dans l'exemple ci-dessus, le modèle ne correspondra qu'à ces expressions <code>==</code> , où l'un des opérandes est de type <code>string</code> .  On peut supposer que sans <code>@or</code> tous les filtres sont combinés via <code>@and</code> , mais cela n'a pas besoin d'être explicitement indiqué. </p><br><h1 id="ogranichivaem-oblast-deystviya-diagnostiki">  Limiter la portée du diagnostic </h1><br><p>  Pour chaque test, vous pouvez spécifier <code>@scope &lt;name&gt;</code> : </p><br><ul><li>  <code>@scope all</code> - la valeur par défaut, la validation fonctionne partout; </li><li>  <code>@scope root</code> - lancement uniquement au niveau supérieur; </li><li>  <code>@scope local</code> - s'exécute uniquement à l'intérieur des fonctions et méthodes. </li></ul><br><p>  Supposons que nous voulons signaler un <code>return</code> dehors du corps de la fonction.  En PHP, cela a parfois du sens - par exemple, lorsqu'un fichier est connecté à partir d'une fonction ... Mais dans cet article, nous condamnons cela. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> don't use return outside of functions * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@scope</span></span></span><span class="hljs-comment"> root */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $_;</code> </pre> <br><p>  Voyons comment cette règle va se comporter: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"NOT OK"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Gives a warning class C { public function m() { return "ALSO OK"; } }</span></span></code> </pre> <br><p>  De même, vous pouvez demander d'utiliser <code>*_once</code> au lieu d' <code>require</code> et <code>include</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@maybe</span></span></span><span class="hljs-comment"> prefer require_once over require * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@scope</span></span></span><span class="hljs-comment"> root */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $_; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@maybe</span></span></span><span class="hljs-comment"> prefer include_once over include * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@scope</span></span></span><span class="hljs-comment"> root */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $_;</code> </pre> <br><blockquote>  Désormais, lors de l'appariement des motifs, les parenthèses ne sont pas prises en compte de manière assez cohérente.  Le modèle <code>(($x))</code> ne trouvera pas «toutes les expressions entre crochets», mais simplement toutes les expressions, en ignorant les crochets.  Cependant, <code>$x+$y*$z</code> et <code>($x+$y)*$z</code> se comportent comme ils le devraient.  Cette fonctionnalité provient des difficultés de travail avec les jetons <code>(</code> et <code>)</code> , mais il est possible que l'ordre soit restauré dans l'une des prochaines versions. </blockquote><br><h1 id="gruppirovanie-shablonov">  Modèles de regroupement </h1><br><p>  Lorsque la duplication des commentaires phpdoc apparaît sur les modèles, la possibilité de combiner des modèles vient à la rescousse. </p><br><p>  Un exemple simple pour démontrer: </p><br><div class="scrollable-table"><table><tbody><tr><th>  Était </th><th>  C'est devenu (avec groupement) </th></tr><tr><td><pre> / ** @mais ne pas utiliser exit ou mourir * /
 mourir ($ _);<font></font>
<font></font>
 / ** @mais ne pas utiliser exit ou mourir * /
 exit ($ _);
</pre></td><td><pre> / ** @mais ne pas utiliser exit ou mourir * /
 {
   mourir ($ _);
   exit ($ _);
 }
</pre></td></tr></tbody></table></div><br><p>  Imaginez maintenant combien il serait désagréable de décrire une règle dans l'exemple suivant sans cette fonctionnalité! </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> don't compare arrays with numeric types * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> array $x * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> int|float $y * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@or</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> int|float $x * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> array $y */</span></span> { $x &gt; $y; $x &lt; $y; $x &gt;= $y; $x &lt;= $y; $x == $y; }</code> </pre> <br><p>  Le format d'enregistrement spécifié dans l'article n'est qu'une des options proposées.  Si vous souhaitez participer au choix, alors vous avez une telle opportunité: vous devez mettre +1 aux offres que vous aimez plus que les autres.  Pour plus de détails, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cliquez ici</a> . </p><br><h1 id="kak-integrirovany-dinamicheskie-pravila">  Comment les règles dynamiques sont intégrées </h1><br><p><img src="https://habrastorage.org/webt/1l/hl/x4/1lhlx4vcasmxii4zhwf6fmzlgn8.jpeg"></p><br><p>  Au moment du lancement, NoVerify essaie de trouver le fichier de règles spécifié dans l'argument de <code>rules</code> . </p><br><p>  Ensuite, ce fichier est analysé comme un script PHP normal, et à partir de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AST</a> résultant, un ensemble d'objets de règle avec des modèles phpgrep liés à eux est collecté. </p><br><p>  Ensuite, l'analyseur démarre le travail selon le schéma habituel - la seule différence est que pour certaines sections de code vérifiées, il démarre un ensemble de règles liées.  Si la règle est déclenchée, un avertissement s'affiche. </p><br><p>  Le succès est considéré comme la mise en correspondance du modèle phpgrep et le passage d'au moins un des ensembles de filtres (ils sont séparés par <code>@or</code> ). </p><br><p>  À ce stade, le mécanisme de règles ne ralentit pas de manière significative le fonctionnement du linter, même s'il y a beaucoup de règles dynamiques. </p><br><h2 id="algoritm-matchinga">  Algorithme de correspondance </h2><br><p>  Avec l'approche naïve, pour chaque nœud AST, nous devons appliquer toutes les règles dynamiques.  Il s'agit d'une implémentation très inefficace, car la plupart du travail sera fait en vain: de nombreux modèles ont un préfixe spécifique par lequel nous pouvons regrouper les règles. </p><br><p>  Ceci est similaire à l'idée de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">appariement parallèle</a> , mais au lieu de construire honnêtement le NFA, nous ne «parallélisons» que la première étape des calculs. </p><br><p>  Considérez ceci avec un exemple avec trois règles: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> duplicated then/else parts of ternary */</span></span> $_ ? $x : $x; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> don't call explode with delim="" */</span></span> explode(<span class="hljs-string"><span class="hljs-string">""</span></span>, ${<span class="hljs-string"><span class="hljs-string">"*"</span></span>}); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@maybe</span></span></span><span class="hljs-comment"> suspicious empty body of the if statement */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_);</code> </pre> <br><p>  Si nous avons N éléments et M règles, avec une approche naïve nous avons N * M opérations à effectuer.  En théorie, cette complexité peut être réduite à linéaire et obtenir <code>O(N)</code> - si vous combinez tous les modèles en un seul et effectuez la correspondance comme elle le fait, par exemple, le package <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">regexp</a> de Go. </p><br><p>  Cependant, dans la pratique, je me suis jusqu'à présent concentré sur la mise en œuvre partielle de cette approche.  Il permettra de répartir les règles du fichier ci-dessus en trois catégories, et aux éléments AST auxquels aucune règle ne correspond, d'attribuer une quatrième catégorie vide.  Pour cette raison, pas plus d'une règle n'est exécutée pour chaque élément. </p><br><p>  Si nous avons des milliers de règles et que nous ressentons un ralentissement significatif, l'algorithme sera finalisé.  En attendant, la simplicité de la solution et l'accélération qui en résulte me conviennent. </p><br><h2 id="muki-vybora-ili-nemnogo-o-forme-zapisi-type">  Le tourment du choix, ou un peu sur la <code>@type</code> type </h2><br><div class="scrollable-table"><table><tbody><tr><td>  Tâche: sélectionner une bonne syntaxe pour les filtres dans les annotations phpdoc. <br></td></tr></tbody></table></div><br><p>  La syntaxe actuelle duplique <code>@var</code> et <code>@var</code> , mais nous pouvons avoir besoin de nouveaux opérateurs, par exemple, "le type n'est pas égal".  Imaginez à quoi cela pourrait ressembler. </p><br><p>  Nous avons au moins deux priorités importantes: </p><br><ol><li>  La syntaxe lisible et concise des annotations. </li><li>  Le soutien le plus élevé possible de l'IDE sans effort supplémentaire. </li></ol><br><p>  Pour PhpStorm, il existe un plugin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">php-annotations</a> qui ajoute l'auto-complétion, la transition vers les classes d'annotation et d'autres utilités pour travailler avec des commentaires phpdoc. </p><br><p>  La priorité (2) signifie en pratique que vous prenez des décisions qui ne contredisent pas les attentes de l'IDE et des plugins.  Par exemple, vous pouvez faire des annotations dans un format que le plugin php-annotations peut reconnaître: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Type is a filter that checks that $value * satisfies the given type constraints. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Annotation</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Filter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** Variable name that is being filtered */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $value; <span class="hljs-comment"><span class="hljs-comment">/** Check that value type is equal to $type */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $type; <span class="hljs-comment"><span class="hljs-comment">/** Check that value text is equal to $text */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $text; }</code> </pre> <br><p>  Ensuite, appliquer un filtre aux types ressemblerait à ceci: </p><br><pre> <code class="plaintext hljs">@Type($needle, eq=string) @Type($x, not_eq=Foo)</code> </pre> <br><p>  Les utilisateurs pourraient aller à la définition du <code>Filter</code> , une liste des paramètres possibles (type / texte / etc) serait demandée. </p><br><p>  Méthodes d'enregistrement alternatives, dont certaines ont été suggérées par des collègues: </p><br><pre> <code class="plaintext hljs">@type string $needle @type !Foo $x @type $needle == string @type $x != Foo @type(==) string $needle @type(!=) Foo $x @type($needle) == string @type($x) != Foo @filter type($needle) == string @filter type($x) != Foo</code> </pre> <br><p>  Ensuite, nous avons été un peu distraits et avons oublié que tout était à l'intérieur de phpdoc, et cela est apparu: </p><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">eq</span></span> string (<span class="hljs-name"><span class="hljs-name">typeof</span></span> $needle)) (<span class="hljs-name"><span class="hljs-name">neq</span></span> Foo (<span class="hljs-name"><span class="hljs-name">typeof</span></span> $x))</code> </pre> <br><p>  Bien que l'option avec enregistrement postfix pour le plaisir ait également été émise.  Un langage pour décrire les contraintes de type et de valeur pourrait être appelé sixième: </p><br><pre> <code class="plaintext hljs">@eval string $needle typeof = @eval Foo $x typeof &lt;&gt;</code> </pre> <br><p>  La recherche de la meilleure option n'est pas encore terminée ... </p><br><h1 id="sravnenie-rasshiryaemosti-s-phan">  Comparaison d'extensibilité avec Phan </h1><br><p>  Comme l'un des avantages de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Phan</a> , l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Analyse statique du code PHP en utilisant l'exemple de PHPStan, Phan et Psalm</a> " indique l'extensibilité. </p><br><p>  Voici ce qui a été implémenté dans l'exemple de plugin: </p><br><blockquote>  Nous voulions évaluer dans quelle mesure notre code est prêt pour PHP 7.3 (en particulier, pour savoir s'il a des constantes insensibles à la casse).  Nous étions presque sûrs qu'il n'y avait pas de telles constantes, mais tout pouvait arriver en 12 ans - cela devrait être vérifié.  Et nous avons écrit un plugin pour Phan qui jurerait si le troisième paramètre était utilisé dans define (). </blockquote><p>  Voici à quoi ressemble le code du plugin (le formatage est optimisé pour la largeur): </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Phan</span></span>\<span class="hljs-title"><span class="hljs-title">AST</span></span>\<span class="hljs-title"><span class="hljs-title">ContextNode</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Phan</span></span>\<span class="hljs-title"><span class="hljs-title">CodeBase</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Phan</span></span>\<span class="hljs-title"><span class="hljs-title">Language</span></span>\<span class="hljs-title"><span class="hljs-title">Context</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Phan</span></span>\<span class="hljs-title"><span class="hljs-title">Language</span></span>\<span class="hljs-title"><span class="hljs-title">Element</span></span>\<span class="hljs-title"><span class="hljs-title">Func</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Phan</span></span>\<span class="hljs-title"><span class="hljs-title">PluginV2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Phan</span></span>\<span class="hljs-title"><span class="hljs-title">PluginV2</span></span>\<span class="hljs-title"><span class="hljs-title">AnalyzeFunctionCallCapability</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ast</span></span>\<span class="hljs-title"><span class="hljs-title">Node</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefineThirdParamTrue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PluginV2</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzeFunctionCallCapability</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAnalyzeFunctionCallClosures</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CodeBase $code_base)</span></span></span><span class="hljs-function"> </span></span>{ $def = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CodeBase $cb, Context $ctx, Func $fn, $args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($args) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emitIssue( $cb, $ctx, <span class="hljs-string"><span class="hljs-string">'PhanDefineCaseInsensitiv'</span></span>, <span class="hljs-string"><span class="hljs-string">'define with 3 arguments'</span></span>, [] ); }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'define'</span></span> =&gt; $def]; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefineThirdParamTrue();</code> </pre> <br><p>  Et voici comment cela pourrait être fait dans NoVerify: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@warning</span></span></span><span class="hljs-comment"> define with 3 arguments */</span></span> define($_, $_, $_);</code> </pre> <br><p>  Nous voulions obtenir à peu près le même résultat - afin que les choses triviales puissent être faites aussi simplement que possible. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><ul><li>  Essayez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NoVerify</a> dans votre projet. </li><li>  Si vous avez des idées d'améliorations ou de rapports de bogues, faites <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">-nous part de vos commentaires</a> . </li><li>  Si vous souhaitez participer au développement, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bienvenue</a> ! </li></ul><br><h1 id="ssylki-poleznye-materialy">  Liens, documents utiles </h1><br><p>  Des liens importants sont rassemblés ici, dont certains ont peut-être déjà été mentionnés dans l'article, mais pour plus de clarté et de commodité, je les ai rassemblés en un seul endroit. </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'article sur NoVerify sur Habré</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'article sur phpgrep sur Habré</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Phpgrep talk video avec IT Nights</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gogrep</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lancer la</a> recherche de code par des modèles de syntaxe </li><li>  Concept de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sélecteurs</a> ESLint <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AST</a> similaire aux modèles de syntaxe </li></ul><br><p>  Si vous avez besoin de plus d'exemples de règles pouvant être implémentées, vous pouvez jeter un œil aux <a href="">tests NoVerify</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473718/">https://habr.com/ru/post/fr473718/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473706/index.html">Zoia: CMS réactif léger pour un développement rapide de sites Web</a></li>
<li><a href="../fr473708/index.html">Voiture électrique faite maison - tout n'est pas ce que vous pensez</a></li>
<li><a href="../fr473710/index.html">Les principes de documentation et de localisation, ou comment obtenir une bonne localisation à moindre coût</a></li>
<li><a href="../fr473714/index.html">Comment je suis arrivé à la spécification formelle d'un processeur RISC-V en F #</a></li>
<li><a href="../fr473716/index.html">Widgets pilotés par la souris. Glissez et déposez dans la fenêtre</a></li>
<li><a href="../fr473720/index.html">Deux façons de réaliser des tests unitaires fiables</a></li>
<li><a href="../fr473722/index.html">Isolement à distance, anxiété et dépression</a></li>
<li><a href="../fr473726/index.html">Il ne suffit pas de savoir ce que sont Mutex, Semaphore et async / wait. Vous devez tout savoir des quanta</a></li>
<li><a href="../fr473728/index.html">Mise en œuvre typique de la surveillance. Nikolay Sivko</a></li>
<li><a href="../fr473732/index.html">L'histoire de la fraude dans la construction d'un réseau câblé sous l'Arctique pour 1 milliard de dollars</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>