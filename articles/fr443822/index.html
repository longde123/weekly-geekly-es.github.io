<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👍🏾 👩🏿‍🤝‍👩🏻 👩🏿‍🎤 Orchestre de performance 🚷 🅾️ 😓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il n'est pas faux de dire que le meilleur des gens 
 prendre de la joie par la souffrance. 
 Ludwig van Beethoven 





 Je m'appelle Sergey, je trava...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Orchestre de performance</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yamoney/blog/443822/"><p>  <em>Il n'est pas faux de dire que le meilleur des gens</em> <em><br></em>  <em>prendre de la joie par la souffrance.</em> <em><br></em>  <em>Ludwig van Beethoven</em> </p><br><p><img src="https://habrastorage.org/webt/9k/ht/xx/9khtxxwiwqsesccfpb5n2sbrnwo.jpeg"></p><br><p>  Je m'appelle Sergey, je travaille chez Yandex.Money dans une équipe de recherche sur la performance.  Je veux vous raconter le début d'une histoire sur notre chemin vers l'orchestration - comment nous avons choisi les instruments et ce que nous avons pris en compte.  Tous les événements de l'article se déroulent en temps réel, alors vous, chers lecteurs, suivez presque en direct l'évolution de la situation. </p><a name="habracut"></a><br><h2 id="zachem-nam-dirizhyor-v-komande">  Pourquoi avons-nous besoin d'un chef d'orchestre dans l'équipe? </h2><br><p>  Qui est chef d'orchestre?  Du fr.  diriger - gérer, diriger, diriger - dans le monde de la musique - c'est une personne, le leader de l'apprentissage et de la performance de la musique d'ensemble.  Dans notre cas, cet endroit est occupé par des systèmes d'orchestration et d'automatisation. </p><br><p>  Leur rôle n'est pas différent de celui du chef d'orchestre en musique - ils sont nécessaires pour aider l'équipe, diriger et organiser sa pièce. </p><br><p>  En règle générale, une équipe a un certain ensemble de capacités - appelons-les serveurs sur lesquels ils mettent en œuvre leurs projets. </p><br><p>  L'approche pour obtenir et exploiter ces serveurs est diverse.  Quelques exemples: </p><br><ul><li>  L'équipe demande par exemple au groupe d'opération de lui fournir des ressources avec certains paramètres. </li><li>  Le groupe d'exploitation leur fournit la quantité requise - nuage ou métal nu («métal nu») - et s'engage à les maintenir en bon état selon le SLA.  L'ajustement est également effectué par l'équipe des opérations. </li><li>  L'équipe ne reçoit que des ressources cloud ou bare metal du groupe d'opérations; elle effectue ses propres paramètres. </li><li>  L'équipe elle-même «achète» des ressources et les soutient / les configure de manière totalement indépendante. </li></ul><br><p>  Notre équipe utilise des serveurs qui doivent être pris en charge - mettre à jour le système d'exploitation, installer de nouveaux packages, etc. </p><br><p>  Pour nous, nous les avons distingués en deux types principaux: </p><br><ul><li>  groupe de réservoirs </li><li>  groupe de service. </li></ul><br><p>  Le groupe de chars se compose d'hôtes avec Yandex.Tank. </p><br><p>  Le groupe de services comprend tout ce qui concerne la maintenance - ce sont divers services pour fournir une assistance pour le cycle de publication, générer des rapports automatiques, etc. </p><br><p>  À un moment donné, il était devenu gênant de gérer tout cela manuellement, et nous avons pensé à automatiser l'ensemble du processus, en commençant par le «chargement» des serveurs et en terminant par le développement, la mise en page et le lancement de notre service interne. </p><br><h2 id="pochemu-dirizhyor-nuzhen-dazhe-esli-orkestr-sam-umeet-igrat">  Pourquoi un chef d'orchestre est-il nécessaire, même si l'orchestre lui-même peut jouer? </h2><br><p>  Pour commencer, nous avons maîtrisé Ansible et avons commencé à «verser» nos serveurs bare metal pour être moins dépendants des administrateurs système - tout le monde y gagne, nous acquérons de nouvelles compétences et décharge les administrateurs de la partie du travail qu'ils ont toujours sans nous.  Nous nous efforçons de développer notre équipe en dehors de notre spécialité et de notre autonomie autant que possible. </p><br><p>  La société travaille avec Ansible depuis longtemps déjà installée et réglementée, nous avons donc facilement intégré notre solution dans ce processus. </p><br><p>  L'hébergement comprend désormais trois rôles Ansible: </p><br><ul><li>  le premier rôle installe le système d'exploitation, </li><li>  le deuxième déroule les paramètres de base de l'hôte, l'autorisation LDAP, par exemple, </li><li>  et le troisième installe Yandex.Tank et les dépendances associées dans le conteneur Docker. </li></ul><br><p>  Passons aux services que nous utilisons au sein de l'équipe. </p><br><p> Pour nos tâches, nous utilisons également Kotlin et Python, et un peu plus Golang.  Pour unifier le développement et le déploiement de nos services, nous avons décidé de les emballer dans des containers dockers.  Cela donne la liberté de choisir un langage de programmation et régule en même temps le format de livraison uniforme de son application. </p><br><h3 id="nebolshaya-remarka-pro-ipv6-v-docker">  Une petite remarque sur ipv6 dans Docker </h3><br><p>  Certains des services avec lesquels nous interagissons ne sont disponibles que via ipv6, j'ai donc dû trouver comment créer ipv6 pour les conteneurs. </p><br><p>  Selon la documentation d'ipv6 sur le site officiel de Docker, ipv6 est activé en ajoutant des paramètres à daemon.json: </p><br><pre><code class="plaintext hljs">{ "ipv6": true, "fixed-cidr-v6": "2001:db8:1::/64" }</code> </pre> <br><p>  Dans ce cas, le fournisseur doit émettre le sous-réseau ipv6, que vous <code>fixed-cidr-v6.</code> dans <code>fixed-cidr-v6.</code> <br>  Cependant, nous avons choisi une autre option - ipv6 NAT, et voici pourquoi: </p><br><ul><li>  Docker <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne peut plus être utilisé</a> uniquement avec ipv6. </li><li>  La présence d'une adresse routable à l'échelle mondiale dans chaque conteneur signifie que tous les ports (même ceux non publiés) deviennent accessibles à tous si aucun filtrage supplémentaire n'est effectué. </li><li>  proxy de l'espace utilisateur pour la publication des ports, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">iptables pour ipv4 uniquement</a> . </li></ul><br><p>  ipv6 NAT est un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conteneur docker</a> qui gère lui-même les règles dans ip6tables et les modifie lorsqu'un nouveau conteneur est ajouté. </p><br><p>  Pour que cette solution fonctionne correctement, un certain nombre de manipulations ont dû être effectuées.  Assurez-vous d'initialiser ip6table_nat sur le système.  La présence d'un module installé dans le système ne garantit pas qu'au démarrage le module sera chargé dans le noyau.  Nous sommes tombés sur ce problème lorsque nous avons eu cette erreur lors du démarrage d'un conteneur avec NAT sur un nouvel hôte: </p><br><pre> <code class="plaintext hljs">2019/01/22 14:59:54 running [/sbin/ip6tables -t filter -N DOCKER --wait]: exit status 3: modprobe: can't change directory to '/lib/modules': No such file or directory ip6tables v1.6.2: can't initialize ip6tables table `filter': Table does not exist (do you need to insmod?)</code> </pre> <br><p>  Le problème a été résolu après avoir ajouté l'initialisation au rôle Ansible à l'aide du module modprobe et l'avoir chargé au démarrage à l'aide de lineinfile: </p><br><pre> <code class="plaintext hljs">- name: Add ip6table_nat module modprobe: name: ip6table_nat state: present - name: Add ip6table_nat to boot lineinfile: path: /etc/modules line: 'ip6table_nat'</code> </pre> <br><p>  À propos, il y a un bon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> sur Haber, qui décrit brièvement et clairement les avantages et les inconvénients d'une méthode particulière pour travailler avec ipv6 dans docker. </p><br><p>  Mais revenons à notre question posée au début: <br>  <strong>Pourquoi un chef d'orchestre est-il nécessaire, même si l'orchestre lui-même peut jouer?</strong> </p><br><p>  Maintenant, tout le monde sait jouer dans notre équipe: </p><br><ul><li>  le processus de "remplissage" des serveurs est créé, </li><li>  le développement et le déploiement des services sont unifiés. </li></ul><br><p>  Une question raisonnable se pose: comment déployer, mettre à jour, contrôler nos services dans des conteneurs Docker de manière efficace et aussi automatisée que possible? </p><br><p>  Malgré le fait que chaque membre de l'orchestre connaisse sa propre part, il peut s'égarer, s'éloigner de l'idée originale.  Ici, nous arrivons au fait que sans chef d'orchestre, notre orchestre ne pourra pas répéter et jouer de manière harmonieuse.  Le chef d'orchestre est responsable de tous les paramètres de performance, pour s'assurer que tout est uni par un rythme et une humeur uniques. </p><br><h2 id="kak-s-minimalnymi-vlozheniyami-poluchit-horoshego-dirizhera">  Comment obtenir un bon conducteur avec un investissement minimal? </h2><br><p>  Le thème de l'orchestration est bien développé sur le marché.  Mais d'abord, parlons des outils de support qui peuvent aider le chef d'orchestre. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Consul</a> est un système qui fournit deux fonctions principales: </p><br><ul><li>  découverte de service </li><li>  stockage de valeurs-clés distribué. </li></ul><br><p>  Dans notre orchestre, le consul sera responsable de l'enregistrement des services et du stockage de leurs configurations.  Il existe deux options d'inscription: </p><br><ul><li>  Actif - c'est lorsque le service lui-même s'enregistre à l'aide de l'API HTTP; </li><li>  Passif - le service doit être enregistré manuellement. </li></ul><br><p>  Vault est un référentiel qui standardise et unifie le stockage sécurisé et utilise des secrets - mots de passe, certificats. <br>  Voici les avantages que nous retirerons de cet outil: </p><br><ul><li>  Un centre unique pour créer et garder des secrets, gérer leur cycle de vie via l'API HTTP. </li><li>  Transit Secrets Engine - cryptage-décryptage des données sans les enregistrer.  La capacité de transmettre des données sous forme cryptée via des canaux de communication non sécurisés. </li><li>  Stratégies d'accès faciles à configurer. </li><li>  Auditez l'accès aux secrets. </li><li>  Possibilité de créer votre propre CA (autorité de certification) pour gérer les certificats auto-signés au sein de votre infrastructure. </li></ul><br><p>  Compte tenu de toutes nos exigences, deux options convenaient au rôle de chef d'orchestre - Kubernetes et Nomad. </p><br><h4 id="kubernetes">  Kubernetes </h4><br><p>  Combien d'articles et de livres ont déjà été écrits sur lui (celui- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ci</a> , par exemple), des rapports ont dit que j'écrirai en bref - c'est une moissonneuse-batteuse universelle qui peut faire presque n'importe quoi.  Le payer n'est pas toujours facile à configurer et à prendre en charge un cluster sur Kubernetes. </p><br><h4 id="nomad">  Nomade </h4><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'outil provient</a> de HashiCorp, une entreprise connue pour le consul et le coffre-fort mentionnés ci-dessus. </p><br><p>  Nomad nous a semblé plutôt simple à installer et à configurer que Kubernetes.  Un fichier binaire fonctionne à la fois en mode serveur et en mode client.  En même temps, Nomad couvre toute la liste des tâches que nous voulons qu'il résout: gestion de cluster, ordonnanceur rapide, support multi-centre.  De plus, lorsque vous utilisez consul et vault, nous bénéficions d'une intégration plus étroite pour orchestrer nos services. </p><br><p>  Ce qui est maintenant au travail: </p><br><ul><li>  préparé les serveurs pour le déploiement de Consul, </li><li>  la configuration du cluster nomade sera saisie dans Consul, avec laquelle le nomade devra être déployé automatiquement, </li><li>  En parallèle, nous installerons le coffre-fort pour garder les secrets. </li></ul><br><p>  La question dans la salle est de savoir s'il vaut la peine d'avoir un chef d'orchestre pour de telles tâches, ou un orchestre est-il bon sans lui?  Dites-nous dans les commentaires ce que vous en pensez. </p><br><hr><br><p>  Abonnez-vous à notre blog et restez en contact - nous vous dirons bientôt ce qui s'est finalement passé et si nous avons configuré le cluster nomade, comme nous le voulions. </p><br><p>  Visitez notre salon de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">discussion</a> confortable sur les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">télégrammes</a> où vous pouvez toujours demander des conseils, aider vos collègues et simplement parler de la recherche de performances et plus encore. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443822/">https://habr.com/ru/post/fr443822/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443812/index.html">Comment implémenter un langage de programmation en JavaScript. Partie 2: interprète</a></li>
<li><a href="../fr443814/index.html">Donner est mon "ancienne entreprise"</a></li>
<li><a href="../fr443816/index.html">Le ministère des Communications insiste sur un seul opérateur 5G</a></li>
<li><a href="../fr443818/index.html">Résumé des événements informatiques de mars (deuxième partie)</a></li>
<li><a href="../fr443820/index.html">Comment l'aéroport de Fukuoka a découvert quelles mesures seraient efficaces pour réduire les files d'attente</a></li>
<li><a href="../fr443824/index.html">5 raisons de passer à l'impression 3D de produits métalliques</a></li>
<li><a href="../fr443826/index.html">Empêcher l'obsolescence du matériel pédagogique</a></li>
<li><a href="../fr443828/index.html">Les origines de la culture de démarrage: comment les premières réussites ont façonné l'état moderne de l'industrie technologique</a></li>
<li><a href="../fr443830/index.html">Tesla a présenté le nouveau modèle Y - détails, photos de la présentation et impressions du parcours d'essai</a></li>
<li><a href="../fr443834/index.html">Runet au tournant du millénaire: qu'en retenez-vous?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>