<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüëß‚Äçüë¶ üíî ‚ûñ Toko Online Sisi Klien Blazor: Bagian 1 - Oidc otorisasi (oauth2) + Server Identitas4 üâê üë©‚Äç‚ù§Ô∏è‚Äçüë© ü§ûüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! Jadi ya, di artikel terakhir saya, saya mencoba membuat Daftar Todo di Blazor Wasm dan puas. Sekarang saya memutuskan untuk mengambil sesu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Toko Online Sisi Klien Blazor: Bagian 1 - Oidc otorisasi (oauth2) + Server Identitas4</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484596/"><img src="https://habrastorage.org/webt/0d/by/eu/0dbyeudmd_chabkph5lsogj4gnm.png"><br>  Halo, Habr!  Jadi ya, di artikel terakhir saya, saya mencoba membuat Daftar Todo di Blazor Wasm dan puas.  Sekarang saya memutuskan untuk mengambil sesuatu dengan serius, untuk mencobanya.  Saya akan membuat UI SPA sederhana di Blazor untuk toko online fiksi sederhana.  Sedekat mungkin untuk memerangi opsi penggunaan.  Untuk memulainya, saya akan mencatat otorisasi pengguna dan pemisahan mereka dengan peran, yaitu, sehingga administrator dan pengguna biasa melihat antarmuka yang sedikit berbeda.  Saya juga mengumpulkan semua ini dalam gambar buruh pelabuhan dan mengunggahnya ke register buruh pelabuhan.  Untuk detailnya, selamat datang di kucing. <a name="habracut"></a><br><br><h2>  Isi </h2><br><ul><li>  <a href="https://habr.com/ru/post/463197/">Blazor + MVVM = Silverlight menyerang balik karena kejahatan kuno tidak terkalahkan</a> <br></li><li>  <a href="https://habr.com/ru/post/484596/">Toko Online Sisi Klien Blazor: Bagian 1 - Oidc otorisasi (oauth2) + Server Identitas4</a> <br></li><li>  <a href="https://habr.com/ru/post/484782/">Toko Online Sisi Klien Blazor: Bagian 2 - CI / CD</a> </li></ul><br><br>
<h2>  Referensi </h2><br>  <a href="https://gitlab.com/VictorWinbringer/blazoreshop" rel="nofollow">Kode sumber</a> <br>  <a href="https://hub.docker.com/u/victorcallidus" rel="nofollow">Gambar Pendaftaran Docker</a> <br><br><h2>  Luncurkan </h2><br>  Diperlukan bahwa Anda sudah memiliki buruh pelabuhan yang diinstal dengan <a href="https://docs.docker.com/install/" rel="nofollow">susunan</a> buruh pelabuhan ( <a href="https://docs.docker.com/install/" rel="nofollow">tyk</a> ) dan Internet terhubung karena Anda perlu mengunduh gambar saya. <br><br>  Untuk membuat sertifikat yang diperlukan agar layanan microser berfungsi, instal <a href="https://dotnet.microsoft.com/download/dotnet-core" rel="nofollow">.net core</a> dan jalankan perintah ini di Windows PowerShell. <br><br><pre><code class="bash hljs">dotnet --info dotnet dev-certs https --trust dotnet dev-certs https -ep <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:APPDATA\ASP.NET\Https\blazor-eshop-api.pfx -p 1234Qwert dotnet dev-certs https -ep <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:APPDATA\ASP.NET\Https\blazor-eshop-spa-angular.pfx -p 1234Qwert dotnet dev-certs https -ep <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:APPDATA\ASP.NET\Https\blazor-eshop-spa-blazor.pfx -p 1234Qwert dotnet dev-certs https -ep <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:APPDATA\ASP.NET\Https\blazor-eshop-sso.pfx -p 1234Qwert</code> </pre> <br><br>  Untuk memulai proyek, Anda perlu mengunduh file <a href="" rel="nofollow">docker-compose.yml</a> (atau menyalin kontennya ke file dengan nama yang sama) dan menjalankan perintah docker-compose up di direktori tempat file ini berada.  Layanan microser adalah mendengarkan alamat <br>  <b><a href="https://localhost:8000/" rel="nofollow">https: // localhost: 8000</a></b> <br>  <b><a href="https://localhost:8001/" rel="nofollow">https: // localhost: 8001</a></b> <br>  <b><a href="https://localhost:8002/" rel="nofollow">https: // localhost: 8002</a></b> <br>  dan <b><a href="https://localhost:8003/" rel="nofollow">https: // localhost: 8003</a></b> . <br><br><h2>  Perpustakaan untuk mengotorisasi klien WASM di browser </h2><br>  Instal <a href="https://www.nuget.org/packages/Sotsera.Blazor.Oidc/" rel="nofollow">www.nuget.org/packages/Sotsera.Blazor.Oidc</a> dan <a href="https://www.nuget.org/packages/Sotsera.Blazor.Oidc/" rel="nofollow">nikmati</a> hidup <br><br><h2>  Konfigurasikan Identity Server4 </h2><br>  Secara umum, saya mengambil server yang sudah jadi dan baru saja menambahkan pengaturan untuk klien SPA saya di sana.  Menyiapkan Identity Server4 sendiri berada di luar cakupan artikel ini karena ini tentang Blazor.  Jika Anda tertarik, Anda dapat melihat sumber saya. <br><br>  Tambahkan klien kami ke daftar klien yang tersedia <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Client { ClientId = <span class="hljs-string"><span class="hljs-string">"spaBlazorClient"</span></span>, ClientName = <span class="hljs-string"><span class="hljs-string">"SPA Blazor Client"</span></span>, RequireClientSecret = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, RequireConsent = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, RedirectUris = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{clientsUrl[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"SpaBlazor"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">/oidc/callbacks/authentication-redirect"</span></span>, <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{clientsUrl[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"SpaBlazor"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">/_content/Sotsera.Blazor.Oidc/silent-renew.html"</span></span>, <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{clientsUrl[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"SpaBlazor"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>, }, PostLogoutRedirectUris = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{clientsUrl[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"SpaBlazor"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">/oidc/callbacks/logout-redirect"</span></span>, <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{clientsUrl[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"SpaBlazor"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>, }, AllowedCorsOrigins = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{clientsUrl[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"SpaBlazor"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>, }, AllowedGrantTypes = GrantTypes.Code, AllowedScopes = { <span class="hljs-string"><span class="hljs-string">"openid"</span></span>, <span class="hljs-string"><span class="hljs-string">"profile"</span></span>, <span class="hljs-string"><span class="hljs-string">"email"</span></span>, <span class="hljs-string"><span class="hljs-string">"api"</span></span> }, AllowOfflineAccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, RefreshTokenUsage = TokenUsage.ReUse }</code> </pre><br>  Untuk mendapatkan lebih banyak peran dalam token JWT, kami menerapkan IProfileService kami <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IdentityModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IdentityServer4.Models; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IdentityServer4.Services; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Identity; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.eShopOnContainers.Services.Identity.API.Models; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IdentityModel.Tokens.Jwt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Security.Claims; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Microsoft.eShopOnContainers.Services.Identity.API.Services</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProfileService</span></span> : <span class="hljs-title"><span class="hljs-title">IProfileService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> UserManager&lt;ApplicationUser&gt; _userManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProfileService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UserManager&lt;ApplicationUser&gt; userManager</span></span></span><span class="hljs-function">)</span></span> { _userManager = userManager; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProfileDataAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ProfileDataRequestContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subject = context.Subject ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(context.Subject)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subjectId = subject.Claims.Where(x =&gt; x.Type == <span class="hljs-string"><span class="hljs-string">"sub"</span></span>).FirstOrDefault().Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.FindByIdAsync(subjectId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"Invalid subject identifier"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claims = GetClaimsFromUser(user); context.IssuedClaims = claims.ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> roles = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.GetRolesAsync(user); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> role <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> roles) { context.IssuedClaims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Role, role)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsActiveAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IsActiveContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subject = context.Subject ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(context.Subject)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subjectId = subject.Claims.Where(x =&gt; x.Type == <span class="hljs-string"><span class="hljs-string">"sub"</span></span>).FirstOrDefault().Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.FindByIdAsync(subjectId); context.IsActive = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_userManager.SupportsUserSecurityStamp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> security_stamp = subject.Claims.Where(c =&gt; c.Type == <span class="hljs-string"><span class="hljs-string">"security_stamp"</span></span>).Select(c =&gt; c.Value).SingleOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (security_stamp != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db_security_stamp = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.GetSecurityStampAsync(user); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (db_security_stamp != security_stamp) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } context.IsActive = !user.LockoutEnabled || !user.LockoutEnd.HasValue || user.LockoutEnd &lt;= DateTime.Now; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerable&lt;Claim&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetClaimsFromUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ApplicationUser user</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Claim&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Subject, user.Id), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.PreferredUserName, user.UserName), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtRegisteredClaimNames.UniqueName, user.UserName) }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.Name)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, user.Name)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.LastName)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"last_name"</span></span>, user.LastName)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.CardNumber)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"card_number"</span></span>, user.CardNumber)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.CardHolderName)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"card_holder"</span></span>, user.CardHolderName)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.SecurityNumber)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"card_security_number"</span></span>, user.SecurityNumber)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.Expiration)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"card_expiration"</span></span>, user.Expiration)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.City)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"address_city"</span></span>, user.City)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.Country)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"address_country"</span></span>, user.Country)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.State)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"address_state"</span></span>, user.State)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.Street)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"address_street"</span></span>, user.Street)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.ZipCode)) claims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"address_zip_code"</span></span>, user.ZipCode)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_userManager.SupportsUserEmail) { claims.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Email, user.Email), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.EmailVerified, user.EmailConfirmed ? <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-string"><span class="hljs-string">"false"</span></span>, ClaimValueTypes.Boolean) }); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_userManager.SupportsUserPhoneNumber &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(user.PhoneNumber)) { claims.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.PhoneNumber, user.PhoneNumber), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.PhoneNumberVerified, user.PhoneNumberConfirmed ? <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-string"><span class="hljs-string">"false"</span></span>, ClaimValueTypes.Boolean) }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> claims; } } }</code> </pre><br>  Di sini seluruh titik dalam potongan kode ini <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> roles = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.GetRolesAsync(user); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> role <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> roles) { context.IssuedClaims.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Role, role)); }</code> </pre> <br>  dan tambahkan ke asp.net <br><br><pre> <code class="cs hljs">services.AddIdentityServer().AddProfileService&lt;ProfileService&gt;()</code> </pre> <br><h2>  Pembuatan proyek </h2><br>  Di sini saya memilih ASP.NET Core yang di-host karena sangat mudah bagi saya untuk mentransfer pengaturan.  Lebih mudah untuk merakit gambar buruh pelabuhan.  Anda juga dapat meng-host nginx jika diinginkan di dalam wadah. <br><br><img src="https://habrastorage.org/webt/eh/ez/5e/ehez5ei_v0untezw-n132dvrhb4.png"><br><br><img src="https://habrastorage.org/webt/i1/0a/sc/i10ascbtjvdueaqdyzvsmhl5yfu.png"><br><br><h2>  Mentransfer pengaturan dari file konfigurasi dan variabel lingkungan </h2><br><h3>  Sisi server </h3><br>  Tambahkan model pengaturan <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConfigModel</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SsoUri { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ApiUri { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; }</code> </pre><br>  Daftarkan di Startup.cs <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddMvc(); services.AddResponseCompression(opts =&gt; { opts.MimeTypes = ResponseCompressionDefaults.MimeTypes.Concat( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"application/octet-stream"</span></span> }); }); services.Configure&lt;ConfigModel&gt;(Configuration); }</code> </pre><br>  Lulus ke klien sebagai json <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BlazorEShop.Shared.Presentation; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.Options; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BlazorEShop.Spa.BlazorWasm.Server.Controllers</span></span> { [Route(<span class="hljs-string"><span class="hljs-string">"api/v1/config"</span></span>)] [ApiController] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConfigController</span></span> : <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IOptionsSnapshot&lt;ConfigModel&gt; _configuration; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IOptionsSnapshot&lt;ConfigModel&gt; configuration</span></span></span><span class="hljs-function">)</span></span> { _configuration = configuration; } <span class="hljs-comment"><span class="hljs-comment">// GET: api/&lt;controller&gt; [HttpGet] public ConfigModel Get() { return _configuration.Value; } } }</span></span></code> </pre><br><h3>  Sisi klien </h3><br>  Kami mendapatkan pengaturan dari server dan menambahkannya ke wadah DI kami <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net.Http; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BlazorEShop.Shared.Presentation; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Blazor.Hosting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Components; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.DependencyInjection; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BlazorEShop.Spa.BlazorWasm.Client</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Task.Run(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { ConfigModel cfg = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = BlazorWebAssemblyHost.CreateDefaultBuilder().Build(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = host.Services.CreateScope()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nm = scope.ServiceProvider.GetRequiredService&lt;NavigationManager&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uri = nm.BaseUri; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"BASE URI: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{uri}</span></span></span><span class="hljs-string">"</span></span>); cfg = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetConfig(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(uri.EndsWith(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'/'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">) ? uri : uri + </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"/"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">api/v1/config"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> BlazorWebAssemblyHost .CreateDefaultBuilder() .ConfigureServices(x =&gt; x.AddScoped&lt;ConfigModel&gt;(y =&gt; cfg)) .UseBlazorStartup&lt;Startup&gt;() .Build() .StartAsync() .ContinueWith((a, b) =&gt; Console.WriteLine(a.Exception), <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"END MAIN"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ConfigModel&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cfg = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client .GetJsonAsync&lt;ConfigModel&gt;(url); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cfg; } } }</code> </pre><br>  Karena Blazor Wasm tidak mendukung async void Main, dan upaya untuk mendapatkan Hasil dari Tugas menyebabkan kebuntuan karena kami hanya memiliki satu utas, kami harus membungkus semuanya dalam Task.Run (async () =&gt; {}); <br><br><h2>  Mengaktifkan pustaka oidc (oauth2) di sisi klien </h2><br>  Kami memanggil services.AddOidc dengan pengaturan yang kami terima dari server di dalam ConfigModel. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Components.Builder; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.DependencyInjection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Sotsera.Blazor.Oidc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net.Http; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BlazorEShop.Shared.Presentation; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Components; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BlazorEShop.Spa.BlazorWasm.Client</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Startup</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> provider = services.BuildServiceProvider(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cfg = provider.GetService&lt;ConfigModel&gt;(); services.AddOidc(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(cfg.SsoUri), (settings, siteUri) =&gt; { settings.UseDefaultCallbackUris(siteUri); settings.ClientId = <span class="hljs-string"><span class="hljs-string">"spaBlazorClient"</span></span>; settings.ResponseType = <span class="hljs-string"><span class="hljs-string">"code"</span></span>; settings.Scope = <span class="hljs-string"><span class="hljs-string">"openid profile email api"</span></span>; settings.UseRedirectToCallerAfterAuthenticationRedirect(); settings.UseRedirectToCallerAfterLogoutRedirect(); settings.MinimumLogeLevel = Microsoft.Extensions.Logging.LogLevel.Information; settings.LoadUserInfo = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; settings.FilterProtocolClaims = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; settings.MonitorSession = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; settings.StorageType = Sotsera.Blazor.Oidc.Configuration.Model.StorageType.LocalStorage; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IComponentsApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { app.AddComponent&lt;App&gt;(<span class="hljs-string"><span class="hljs-string">"app"</span></span>); } } }</code> </pre><br><h2>  Mengkonfigurasi komponen utama App.razor </h2><br>  App.blazor -Ubah itu sehingga pengguna yang berwenang dan tidak sah melihat teks yang berbeda dan bahwa rute dari perpustakaan untuk oidc terhubung <br><br><pre> <code class="cs hljs">@<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BlazorEShop.Shared.Presentation @<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Components @<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.DependencyInjection @<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Sotsera.Blazor.Oidc @inject IUserManager UserManager &lt;Router AppAssembly=<span class="hljs-string"><span class="hljs-string">"@typeof(Program).Assembly"</span></span> AdditionalAssemblies=<span class="hljs-string"><span class="hljs-string">"new[] { typeof(IUserManager).Assembly }"</span></span>&gt; &lt;Found Context=<span class="hljs-string"><span class="hljs-string">"routeData"</span></span>&gt; &lt;AuthorizeRouteView RouteData=<span class="hljs-string"><span class="hljs-string">"@routeData"</span></span> DefaultLayout=<span class="hljs-string"><span class="hljs-string">"@typeof(MainLayout)"</span></span>&gt; &lt;NotAuthorized&gt; &lt;h3&gt;Sorry&lt;/h3&gt; &lt;p&gt;You<span class="hljs-string"><span class="hljs-string">'re not authorized to reach this page.&lt;/p&gt; &lt;p&gt;You may need to log in as a different user.&lt;/p&gt; &lt;/NotAuthorized&gt; &lt;Authorizing&gt; &lt;h3&gt;Authentication in progress&lt;/h3&gt; &lt;/Authorizing&gt; &lt;/AuthorizeRouteView&gt; &lt;/Found&gt; &lt;NotFound&gt; &lt;CascadingAuthenticationState&gt; &lt;LayoutView Layout="@typeof(MainLayout)"&gt; &lt;h3&gt;Sorry&lt;/h3&gt; &lt;p&gt;Sorry, there'</span></span>s nothing at <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> address.&lt;/p&gt; &lt;/LayoutView&gt; &lt;/CascadingAuthenticationState&gt; &lt;/NotFound&gt; &lt;/Router&gt;</code> </pre><br><h2>  Login dan keluar pengguna </h2><br>  Manajemen pengguna dilakukan melalui antarmuka IUserManager.  Itu bisa didapat dari wadah DI.  Sebagai contoh: <br><br><pre> <code class="cs hljs">@inject IUserManager UserManager @<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Sotsera.Blazor.Oidc @<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.DependencyInjection &lt;AuthorizeView&gt; &lt;Authorized&gt; &lt;span <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"login-display-name mr-3"</span></span>&gt; Hello, @context.User.Identity.Name! &lt;/span&gt; &lt;button type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"btn btn-primary btn-sm"</span></span> @onclick=<span class="hljs-string"><span class="hljs-string">"LogoutRedirect"</span></span>&gt; Log <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> &lt;/button&gt; &lt;/Authorized&gt; &lt;NotAuthorized&gt; &lt;button type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"btn btn-primary btn-sm"</span></span> @onclick=<span class="hljs-string"><span class="hljs-string">"LoginRedirect"</span></span>&gt; Log <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;/button&gt; &lt;/NotAuthorized&gt; &lt;/AuthorizeView&gt; @code { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoginRedirect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UserManager.BeginAuthenticationAsync(p =&gt; p.WithRedirect()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogoutRedirect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UserManager.BeginLogoutAsync(p =&gt; p.WithRedirect()); }</code> </pre><br><h2>  Tampilan berbagai informasi untuk pengguna resmi dan tidak resmi </h2><br>  Sekarang, di bagian mana pun dari aplikasi, menggunakan AuthorizeView, Anda dapat menentukan area yang hanya akan dilihat oleh pengguna yang berwenang.  Anda juga dapat menggunakan Peran untuk menentukan pengguna dengan peran apa mereka dapat melihat konten ini. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AuthorizeView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Roles</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin, administrator"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authorized</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>User Info<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>@context.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @foreach (var c in context.User.Claims) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>@c.Type : @c.Value : @string.Join(";", c.Properties.Select(x =&gt; $"{x.Key} : {x.Value}"))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authorized</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NotAuthorized</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>       admin   administrator<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NotAuthorized</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AuthorizeView</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h2>  Akses ke halaman tertentu tergantung pada otorisasi dan peran pengguna </h2><br>  Semuanya menjadi atribut standar Otorisasi.  Tentu saja, Anda sebaiknya melakukan pemeriksaan hak pengguna di sisi server juga. <br><br>  Halaman yang hanya dapat diakses oleh pengguna yang berwenang dengan peran apa pun <br><br><pre> <code class="xml hljs">@page "/user" @attribute [Authorize] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>     <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Halaman yang hanya dapat diakses oleh pengguna resmi yang memiliki peran admin atau bos <br><br><pre> <code class="xml hljs">@page "/admin" @attribute [Authorize(Roles="admin, boss")] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>      admin  boss<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h2>  Panggilan API </h2><br>  Untuk melakukan ini, gunakan OidcHttpClient yang dapat diperoleh dari wadah DI.  Secara otomatis meletakkan token pengguna saat ini dalam permintaan.  Sebagai contoh: <br><br><pre> <code class="cs hljs">@page <span class="hljs-string"><span class="hljs-string">"/fetchdata"</span></span> @inject Sotsera.Blazor.Oidc.OidcHttpClient Http @inject BlazorEShop.Shared.Presentation.ConfigModel Config @<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BlazorEShop.Shared.Presentation &lt;h1&gt;Weather forecast&lt;/h1&gt; &lt;p&gt;This component demonstrates fetching data <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the server.&lt;/p&gt; @<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (products == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { &lt;p&gt;&lt;em&gt;Loading...&lt;/em&gt;&lt;/p&gt; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { &lt;table <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"table"</span></span>&gt; &lt;thead&gt; &lt;tr&gt; &lt;th&gt;Id&lt;/th&gt; &lt;th&gt;Version&lt;/th&gt; &lt;/tr&gt; &lt;/thead&gt; &lt;tbody&gt; @<span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> products.Value) { &lt;tr&gt; &lt;td&gt;@product.Id&lt;/td&gt; &lt;td&gt;@product.Version&lt;/td&gt; &lt;/tr&gt; } &lt;/tbody&gt; &lt;/table&gt; } @code { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PageResultModel&lt;ProductModel&gt; products; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnInitializedAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uri = Config.ApiUri; products = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Http.GetJsonAsync&lt;PageResultModel&lt;ProductModel&gt;&gt;(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(uri.EndsWith(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'/'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">) ? uri : uri + </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"/"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">api/v1/products?take=100&amp;skip;=0"</span></span>); } }</code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id484596/">https://habr.com/ru/post/id484596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id484584/index.html">Mengapa kita memerlukan manajer dalam proyek TI dan apa yang akan terjadi ketika tidak</a></li>
<li><a href="../id484586/index.html">Bekerja dengan IPv6 di PHP</a></li>
<li><a href="../id484588/index.html">Model manajemen program otomatis</a></li>
<li><a href="../id484590/index.html">Sehingga anak laki-laki tidak malu untuk menunjukkan</a></li>
<li><a href="../id484592/index.html">Intisari bahan-bahan segar dari dunia front-end untuk minggu terakhir No. 398 (13-19 Januari 2020)</a></li>
<li><a href="../id484600/index.html">Microsoft Menyalakan Konferensi Teknis Tur Praha</a></li>
<li><a href="../id484602/index.html">Buku ‚ÄúPengembangan aplikasi seluler di C # untuk iOS dan Android‚Äù</a></li>
<li><a href="../id484604/index.html">Tahun Baru, Peramban Baru: Microsoft Edge Keluar dari Penilaian Awal dan Sekarang Tersedia untuk Diunduh</a></li>
<li><a href="../id484610/index.html">Selamat tinggal kode bersih</a></li>
<li><a href="../id484612/index.html">Optimasi waktu pembuatan proyek</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>