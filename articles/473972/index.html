<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüé® üë®üèª‚Äçüîß üßñüèΩ Por orden de desarrolladores integrados: buscando errores en Amazon FreeRTOS üî¥ üï∂Ô∏è üíØ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todos los que programan microcontroladores probablemente conozcan FreeRTOS, o al menos hayan escuchado sobre este sistema operativo. Los chicos de Ama...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Por orden de desarrolladores integrados: buscando errores en Amazon FreeRTOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/473972/">  Todos los que programan microcontroladores probablemente conozcan FreeRTOS, o al menos hayan escuchado sobre este sistema operativo.  Los chicos de Amazon decidieron expandir las capacidades de este sistema operativo para trabajar con los servicios de Internet de las cosas de AWS: as√≠ es como apareci√≥ Amazon FreeRTOS.  A nosotros, los desarrolladores del analizador de c√≥digo PVS-Studio, se nos pidi√≥ que revis√°ramos estos proyectos por correo y en los comentarios debajo de los art√≠culos.  Bueno, preguntaste, lo hicimos.  Lo que sali√≥ de eso - sigue leyendo. <br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8d2/efa/d2f/8d2efad2f7885ec13add7368f6d2ff96.png" alt="Figura 3"></div><a name="habracut"></a><br><h2>  Un poco sobre proyectos </h2><br>  Para comenzar, te contar√© un poco sobre el "padre" del proyecto verificado: FreeRTOS (puedes encontrar el c√≥digo fuente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ).  Como dice Wikipedia, FreeRTOS es un sistema operativo multitarea en tiempo real para sistemas integrados. <br><br>  Fue escrito en el viejo C, lo cual no es sorprendente: este sistema operativo deber√≠a funcionar en condiciones t√≠picas de los microcontroladores: baja potencia de c√≥mputo, una peque√±a cantidad de RAM y similares.  El lenguaje C le permite trabajar con recursos en un nivel bajo y tiene un alto rendimiento, por lo que es el m√°s adecuado para el desarrollo de dicho sistema operativo. <br><br>  Ahora volvamos a Amazon, que no se queda quieto y se desarrolla en varias √°reas prometedoras.  Por ejemplo, Amazon est√° desarrollando el motor AAA de Amazon Lumberyard, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tambi√©n probamos</a> . <br><br>  Una de esas √°reas es Internet de las cosas (Internet de las cosas, IoT).  Para desarrollarse en esta √°rea, Amazon decidi√≥ escribir su propio sistema operativo, y tomaron el n√∫cleo FreeRTOS como base. <br><br>  El sistema resultante, Amazon FreeRTOS, se posiciona como "proporcionando la capacidad de conectarse de forma segura a los servicios web de Amazon, como AWS IoT Core o AWS IoT Greengrass".  El c√≥digo fuente de este proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se almacena</a> en Github. <br><br>  En este art√≠culo, examinaremos si hay errores en FreeRTOS, as√≠ como qu√© tan seguro es el sistema operativo de Amazon en t√©rminos de an√°lisis de c√≥digo est√°tico. <br><br><h2>  ¬øC√≥mo estuvo el cheque? </h2><br>  El c√≥digo se verific√≥ utilizando una herramienta de b√∫squeda autom√°tica de errores: analizador de c√≥digo est√°tico PVS-Studio.  Es capaz de detectar errores en programas escritos en C, C ++, C # y Java. <br><br>  Antes de comenzar el an√°lisis, es necesario ensamblar el proyecto, por lo que me asegurar√© de tener todas las dependencias necesarias y todo est√° en orden con el proyecto.  Hay varias formas de verificar un proyecto, por ejemplo, utilizando un sistema de monitoreo de compilaci√≥n.  Hice el an√°lisis usando el complemento para Visual Studio: es bueno que los repositorios de ambos proyectos tengan un conjunto de archivos de proyecto que faciliten la compilaci√≥n en Windows. <br><br>  Todo lo que se necesitaba para m√≠ era recopilar los proyectos para asegurarme de que hab√≠a todo lo necesario para la verificaci√≥n.  A continuaci√≥n, lanc√© el an√°lisis y ¬°listo!  - delante de m√≠ hay un informe analizador listo para usar. <br><br>  Las bibliotecas de terceros incluidas en estos proyectos tambi√©n pueden contener errores y, por supuesto, tambi√©n pueden afectar el funcionamiento del programa.  Sin embargo, los exclu√≠ del an√°lisis en aras de la pureza de la narraci√≥n. <br><br>  Entonces, se analizan los proyectos, se reciben informes, se escriben errores interesantes.  ¬°Es hora de pasar a su an√°lisis! <br><br><h2>  Lo que esconde FreeRTOS </h2><br>  Inicialmente, esperaba escribir dos art√≠culos separados: uno para cada sistema operativo.  Ya me frot√© las manos, prepar√°ndome para escribir un buen art√≠culo sobre FreeRTOS.  Anticip√°ndome a la detecci√≥n de al menos un par de errores jugosos (como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CWE-457</a> ), mir√© ansiosamente las pocas advertencias del analizador, y ... y nada.  No encontr√© ning√∫n error interesante. <br><br>  Muchas advertencias que emiti√≥ el analizador no eran relevantes para FreeRTOS.  Por ejemplo, tales advertencias eran deficiencias de 64 bits, como <i>enviar</i> <i>size_t</i> a <i>uint32_t</i> .  Esto se debe al hecho de que FreeRTOS est√° dise√±ado para funcionar en dispositivos con un tama√±o de puntero de no m√°s de 32 bits. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Revis√©</a> cuidadosamente todas las advertencias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V1027</a> relacionadas con lanzamientos entre punteros a estructuras no relacionadas.  Si las estructuras reducibles tienen la misma alineaci√≥n, tal lanzamiento no es un error.  ¬°Y no encontr√© un solo elenco peligroso! <br><br>  Todos los dem√°s lugares sospechosos estaban relacionados con el estilo de codificaci√≥n o estaban equipados con un comentario que explicaba por qu√© esto se hace exactamente aqu√≠ y por qu√© esto no es un error. <br><br>  En general, quiero contactar a los desarrolladores de FreeRTOS.  ¬°Ustedes son realmente geniales!  Casi nunca conocimos proyectos tan limpios y de alta calidad como los suyos.  Y me complaci√≥ mucho leer c√≥digo limpio, ordenado y bien documentado.  Me quito el sombrero ante ti. <br><br>  Aunque no pude encontrar ning√∫n error interesante ese d√≠a, entend√≠ que no me detendr√≠a all√≠.  Iba a casa con la firme convicci√≥n de que se encontrar√≠a algo interesante en la versi√≥n de Amazon 100%, y que ma√±ana definitivamente recoger√≠a suficientes errores para el art√≠culo.  Como probablemente habr√°s adivinado, ten√≠a raz√≥n. <br><br><h2>  Lo que esconde Amazon FreeRTOS </h2><br>  La versi√≥n de Amazon del sistema result√≥ ser ... para decirlo suavemente, un poco peor.  El legado de FreeRTOS se ha mantenido igual de limpio, pero las nuevas revisiones resultaron ser bastante interesantes. <br><br>  En algunos lugares, la l√≥gica del programa fue violada, en alg√∫n lugar funcion√≥ incorrectamente con punteros.  En algunos lugares, el c√≥digo podr√≠a conducir a un comportamiento indefinido, pero en alg√∫n lugar el programador simplemente no sab√≠a sobre el patr√≥n de error que cometi√≥.  Incluso encontr√© algunas vulnerabilidades potenciales graves. <br><br>  Algo que retras√© con la introducci√≥n.  ¬°Comencemos a analizar los errores! <br><br><h3>  Infracci√≥n l√≥gica del programa </h3><br>  Comencemos con las √°reas problem√°ticas, que indican claramente que el programa no se ejecuta exactamente como esperaba el programador.  El primer lugar ser√° el trabajo sospechoso con una matriz: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Pool of request and associated response buffers, * handles, and configurations. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> _requestPool_t _requestPool = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _scheduleAsyncRequest(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reqIndex, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currentRange) { .... <span class="hljs-comment"><span class="hljs-comment">/* Set the user private data to use in the asynchronous callback context. */</span></span> _requestPool.pRequestDatas[reqIndex].pConnHandle = &amp;_connHandle; _requestPool.pRequestDatas[reqIndex].pConnConfig = &amp;_connConfig; _requestPool.pRequestDatas[reqIndex].reqNum = reqIndex; _requestPool.pRequestDatas[reqIndex].currRange = currentRange; _requestPool.pRequestDatas[reqIndex].currDownloaded = <span class="hljs-number"><span class="hljs-number">0</span></span>; _requestPool.pRequestDatas[reqIndex].numReqBytes = numReqBytes; .... _requestPool.pRequestDatas-&gt;scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  PVS-Studio emiti√≥ dos advertencias para este c√≥digo: <br><br><ul><li>  V619 La matriz '_requestPool.pRequestDatas' se est√° utilizando como puntero a un solo objeto.  iot_demo_https_s3_download_async.c 973 </li><li>  V574 El puntero '_requestPool.pRequestDatas' se usa simult√°neamente como una matriz y como un puntero a un solo objeto.  Verifique las l√≠neas: 931, 973. iot_demo_https_s3_download_async.c 973 </li></ul><br>  Por si acaso, d√©jame recordarte: el nombre de la matriz es un puntero a su primer elemento.  Es decir, si <i>_requestPool.pRequestDatas</i> es una matriz de estructuras, entonces <i>_requestPool.pRequestDatas [i] .scheduled</i> es el acceso al miembro <i>programado</i> de la <i>i-</i> √©sima estructura de la matriz.  Y si escribe <i>_requestPool.pRequestDatas-&gt; Scheduled</i> , esto significar√° acceso al miembro <i>programado</i> de la primera estructura de la matriz. <br><br>  Esto es lo que sucede en el fragmento de c√≥digo anterior.  La √∫ltima l√≠nea siempre cambia el valor solo para un miembro de la primera estructura de la matriz.  Por s√≠ misma, esta llamada ya es sospechosa, pero la situaci√≥n aqu√≠ es a√∫n m√°s obvia: en todo el cuerpo de la funci√≥n, el <i>√≠ndice</i> accede a la matriz <i>_requestPool.pRequestDatas</i> , y solo al final de la operaci√≥n de indexaci√≥n se olvid√≥ de aplicarse. <br><br>  Seg√∫n tengo entendido, la √∫ltima l√≠nea deber√≠a verse as√≠: <br><br><pre> <code class="cpp hljs">_requestPool.pRequestDatas[reqIndex].scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br>  El siguiente error radica en una peque√±a funci√≥n, por lo que lo dar√© en su totalidad: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Return true if the string " pcString" is found * inside the token pxTok in JSON file pcJson. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BaseType_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvGGDJsoneq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcJson, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">jsmntok_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pxTok, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcString )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ulStringSize = ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;end - ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;start; BaseType_t xStatus = pdFALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pxTok-&gt;type == JSMN_STRING ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>( pcString ) == ulStringSize ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>( &amp;pcJson[ pxTok-&gt;start ], <span class="hljs-comment"><span class="hljs-comment">// &lt;= pcString, ulStringSize ) == 0 ) { xStatus = pdTRUE; } } } return xStatus; }</span></span></code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V642 [CWE-197] Guardar el resultado de la funci√≥n 'strncmp' dentro de la variable de tipo 'corto' es inapropiado.  Los bits significativos podr√≠an perderse rompiendo la l√≥gica del programa.  aws_greengrass_discovery.c 637 <br><br>  Echemos un vistazo a la definici√≥n de la funci√≥n strncmp: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strncmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count )</span></span></span></span>;</code> </pre> <br>  En el ejemplo, un resultado de tipo <i>int</i> , cuyo tama√±o es de 32 bits, se convierte en una variable de tipo <i>int16_t</i> .  Con tal conversi√≥n de "estrechamiento", se perder√°n los bits m√°s significativos del valor de retorno.  Por ejemplo, si la funci√≥n <i>strncmp</i> devuelve <i>0x00010000</i> , la se <i>perder√°</i> durante la conversi√≥n y se cumplir√° la condici√≥n. <br><br>  De hecho, es extra√±o ver tal yeso en una condici√≥n.  ¬øPor qu√© incluso hacerlo si puedes comparar <i>int</i> normal con cero?  Por otro lado, si el programador quer√≠a conscientemente que la funci√≥n volviera a veces <i>verdadera</i> , incluso si no deber√≠a, entonces ¬øpor qu√© este comentario no describe este comportamiento complicado?  Pero entonces esto ya es un marcador.  En general, me inclino a creer que esto es un error.  Que piensas <br><br><h3>  Comportamiento indefinido y punteros </h3><br>  Ahora habr√° un ejemplo bastante grande.  Oculta la posible desreferenciaci√≥n de un puntero nulo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _networkReceiveCallback(....) { IotHttpsReturnCode_t status = IOT_HTTPS_OK; _httpsResponse_t* pCurrentHttpsResponse = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; IotLink_t* pQItem = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">/* Get the response from the response queue. */</span></span> IotMutex_Lock(&amp;(pHttpsConnection-&gt;connectionMutex)); pQItem = IotDeQueue_PeekHead(&amp;(pHttpsConnection-&gt;respQ)); IotMutex_Unlock(&amp;(pHttpsConnection-&gt;connectionMutex)); <span class="hljs-comment"><span class="hljs-comment">/* If the receive callback is invoked * and there is no response expected, * then this a violation of the HTTP/1.1 protocol. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pQItem == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { IotLogError(....); fatalDisconnect = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; status = IOT_HTTPS_NETWORK_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> iotCleanup; } .... iotCleanup : <span class="hljs-comment"><span class="hljs-comment">/* Report errors back to the application. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != IOT_HTTPS_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pCurrentHttpsResponse-&gt;isAsync &amp;&amp; pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback) { pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback(....); } pCurrentHttpsResponse-&gt;syncStatus = status; } .... }</code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V522 [CWE-690] Puede haber una desreferenciaci√≥n de un puntero nulo potencial 'pCurrentHttpsResponse'.  iot_https_client.c 1184 <br><br>  Las desreferencias de problemas est√°n en la parte inferior <i>si</i> .  Veamos que pasa aqu√≠. <br><br>  Al comienzo de la funci√≥n, las <i>variables</i> <i>pCurrentHttpsResponse</i> y <i>pQItem se</i> inicializan en <i>NULL</i> , y la variable de <i>estado</i> se <i>inicializa</i> en <i>IOT_HTTPS_OK</i> , lo que significa que todo funciona sin problemas. <br><br>  A continuaci√≥n, a <i>pQItem se le</i> asigna el valor devuelto por la funci√≥n <i>IotDeQueue_PeekHead</i> , que devuelve un puntero al comienzo de una cola doblemente conectada. <br><br>  ¬øQu√© pasa si la cola est√° vac√≠a?  En este caso, la funci√≥n <i>IotDeQueue_PeekHead</i> devolver√° <i>NULL</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotDeQueue_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotDeQueue_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pQueue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IotListDouble_PeekHead(pQueue); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotListDouble_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotListDouble_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pList)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* @[declare_linear_containers_list_double_peekhead] */</span></span></span><span class="hljs-function"> </span></span>{ IotLink_t* pHead = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pList != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IotListDouble_IsEmpty(pList) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { pHead = pList-&gt;pNext; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pHead; }</code> </pre> <br>  A continuaci√≥n, <i>se</i> cumple la condici√≥n <i>pQItem == NULL</i> y el flujo de control <i>pasa</i> por <i>goto</i> a la parte inferior del cuerpo de la funci√≥n.  En este momento, el puntero <i>pCurrentHttpsResponse</i> permanecer√° nulo y el <i>estado</i> ya no ser√° igual a <i>IOT_HTTPS_OK</i> .  Como resultado, caeremos en esa misma rama <i>si</i> , y ... ¬°broads!  Las consecuencias de esta desreferenciaci√≥n usted mismo lo sabe. <br><br>  Esta bien  Fue un ejemplo ligeramente adornado.  Ahora les traigo a su atenci√≥n un potencial de referencia muy simple y comprensible: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PKI_mbedTLSSignatureToPkcs11Signature</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxSignaturePKCS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxMbedSignature )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xReturn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> * pxNextLength; <span class="hljs-comment"><span class="hljs-comment">/* The 4th byte contains the length of the R component */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ucSigComponentLength = pxMbedSignature[ <span class="hljs-number"><span class="hljs-number">3</span></span> ]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if( ( pxSignaturePKCS == NULL ) || ( pxMbedSignature == NULL ) ) { xReturn = FAILURE; } .... }</span></span></code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V595 [CWE-476] El puntero 'pxMbedSignature' se utiliz√≥ antes de que se verificara contra nullptr.  L√≠neas de verificaci√≥n: 52, 54. iot_pki_utils.c 52 <br><br>  Esta funci√≥n obtiene dos punteros a <i>uint8_t</i> .  Ambos punteros se comprueban para <i>NULL</i> , lo cual es una buena pr√°ctica, tales situaciones deben resolverse de inmediato. <br><br>  Pero aqu√≠ est√° la mala suerte: para el momento en que <i>pxMbedSignature</i> est√© marcado, ya se habr√° desreferenciado literalmente una l√≠nea arriba.  Ta-daa! <br><br>  Otro ejemplo de c√≥digo especulativo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">CK_RV </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vAppendSHA256AlgorithmIdentifierSequence</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x32ByteHashedMessage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x51ByteHashOidBuffer )</span></span></span><span class="hljs-function"> </span></span>{ CK_RV xResult = CKR_OK; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> xOidSequence[] = pkcs11STUFF_APPENDED_TO_RSA_SIG; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( x32ByteHashedMessage == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) || ( x51ByteHashOidBuffer == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) ) { xResult = CKR_ARGUMENTS_BAD; } <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( x51ByteHashOidBuffer, xOidSequence, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( &amp;x51ByteHashOidBuffer[ <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ], x32ByteHashedMessage, <span class="hljs-number"><span class="hljs-number">32</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xResult; }</code> </pre> <br>  <b>Advertencias de PVS-Studio:</b> <br><br><ul><li>  V1004 [CWE-628] El puntero 'x51ByteHashOidBuffer' se us√≥ de forma insegura despu√©s de que se verific√≥ contra nullptr.  L√≠neas de verificaci√≥n: 275, 280. iot_pkcs11.c 280 </li><li>  V1004 [CWE-628] El puntero 'x32ByteHashedMessage' se us√≥ de forma insegura despu√©s de que se verific√≥ contra nullptr.  L√≠neas de verificaci√≥n: 275, 281. iot_pkcs11.c 281 </li></ul><br>  El analizador advierte que los par√°metros de funci√≥n que son punteros se usan de forma insegura despu√©s de que se han probado para <i>NULL</i> .  De hecho, los argumentos est√°n marcados, pero si alguno de ellos resulta <i>NULO</i> , no se toman medidas, excepto escribir en <i>xResult</i> .  Este c√≥digo parece decir: "S√≠, eso significa que los argumentos resultaron ser malos.  Lo escribiremos ahora, mientras contin√∫as, contin√∫a ". <br><br>  En <i>pocas palabras</i> : <i>NULL se</i> pasar√° a <i>memcpy</i> .  ¬øQu√© puede venir de esto?  ¬øD√≥nde se copiar√°n los valores y cu√°les?  De hecho, adivinar sobre esto no vale la pena, porque  La norma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">establece claramente</a> que tal llamada conduce a un comportamiento indefinido (ver p√°rrafo 1). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf7/7d6/856/cf77d6856666f6a1529a1744832bd5bf.png" alt="Figura 2"></div><br><br>  El informe del analizador todav√≠a contiene ejemplos de operaciones incorrectas con punteros que encontr√© en Amazon FreeRTOS, pero creo que los ejemplos dados ya son suficientes para mostrarle las capacidades de PVS-Studio para detectar tales errores.  Considera algo nuevo. <br><br><h3>  ¬°VERDADERO! = 1 </h3><br>  Varios errores que encontr√© estaban relacionados con un patr√≥n, que, desafortunadamente, a menudo se olvida. <br><br>  El hecho es que el tipo <i>bool</i> (de C ++) es diferente del tipo <i>BOOL</i> (generalmente usado en C).  El primero solo puede contener <i>verdadero</i> o <i>falso</i> .  El segundo es un typedef de alg√∫n tipo entero ( <i>int</i> , <i>long</i> , etc.).  Para √©l, "falso" es el valor <i>0</i> , y "verdadero" es cualquier valor que no sea cero. <br><br>  Como no hay un tipo booleano incorporado en C, estas constantes se definen por conveniencia: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FALSE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TRUE 1</span></span></code> </pre> <br>  Ahora considere un ejemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mbedtls_hardware_poll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* output, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* olen)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lStatus = MBEDTLS_ERR_ENTROPY_SOURCE_FAILED; HCRYPTPROV hProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Unferenced parameter. */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)data; <span class="hljs-comment"><span class="hljs-comment">/* * This is port-specific for the Windows simulator, * so just use Crypto API. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptAcquireContextA( &amp;hProv, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptGenRandom(hProv, len, output)) { lStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; *olen = len; } CryptReleaseContext(hProv, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lStatus; }</code> </pre> <br>  <b>Advertencias de PVS-Studio:</b> <br><br><ul><li>  V676 [CWE-253] Es incorrecto comparar la variable de tipo BOOL con TRUE.  aws_entropy_hardware_poll.c 48 </li><li>  V676 [CWE-253] Es incorrecto comparar la variable de tipo BOOL con TRUE.  La expresi√≥n correcta es: 'FALSE! = CryptGenRandom (hProv, len, output)'.  aws_entropy_hardware_poll.c 51 </li></ul><br>  ¬øEncontr√≥ un error?  Y lo es :) Funciones <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i>CryptAcquireContextA</i></a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i>CryptGenRandom</i></a> son funciones est√°ndar del encabezado <i>wincrypt.h</i> .  Si tiene √©xito, devuelven un valor distinto de cero.  Enfatizo - <i>no es cero</i> .  Entonces, te√≥ricamente, este puede ser cualquier valor que no sea cero: <i>1</i> , <i>314</i> , <i>42</i> , <i>420</i> . <br><br>  Aparentemente, el programador que escribi√≥ la funci√≥n del ejemplo no lo pens√≥, y como resultado, los valores obtenidos se comparan con la unidad. <br><br>  ¬øCon qu√© probabilidad se <i>cumple</i> la condici√≥n <i>TRUE == CryptGenRandom (....)</i> ?  Es dificil de decir.  Tal vez <i>CryptGenRandom</i> devuelve una unidad con m√°s frecuencia que otros valores, y tal vez siempre devuelve solo uno.  No podemos estar seguros: la implementaci√≥n de esta funci√≥n criptogr√°fica est√° oculta a los ojos de los programadores mortales :) <br><br>  Es importante recordar que tales comparaciones son potencialmente peligrosas.  Y en lugar de: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == GetBOOL())</code> </pre> <br>  use una opci√≥n m√°s segura: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FALSE != GetBOOL())</code> </pre> <br><h3>  Problemas de optimizaci√≥n </h3><br>  Se han asociado varias advertencias del analizador con construcciones de ejecuci√≥n lenta.  Por ejemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">"/"</span></span>); .... }</code> </pre> <br>  <b>Advertencia de PVS-Studio:</b> V817 Es m√°s eficiente buscar el car√°cter '/' en lugar de una cadena.  iot_demo_https_common.c 205 <br><br>  Breve y claramente, ¬øno es as√≠?  La funci√≥n <i>strstr</i> aqu√≠ se usa para buscar solo un car√°cter, que se pasa al par√°metro como una cadena (est√° entre comillas dobles). <br><br>  Este lugar puede ser potencialmente optimizado reemplazando <i>strstr</i> con <i>strchr</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); .... }</code> </pre> <br>  Entonces la b√∫squeda funcionar√° un poco m√°s r√°pido.  Un poco, pero agradable. <br><br>  Tales optimizaciones son, por supuesto, buenas, y el analizador ha encontrado otro lugar que puede optimizarse mucho m√°s notablemente: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vRunOTAUpdateDemo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { .... xConnectInfo.cleanSession = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; xConnectInfo.clientIdentifierLength = (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(clientcredentialIOT_THING_NAME); xConnectInfo.pClientIdentifier = clientcredentialIOT_THING_NAME; .... } }</code> </pre> <br>  <b>Advertencia PVS-Studio:</b> V814 Disminuci√≥n del rendimiento.  La funci√≥n 'strlen' se llam√≥ varias veces dentro del cuerpo de un bucle.  aws_iot_ota_update_demo.c 235 <br><br>  Hmmm ... Dentro del bucle, en cada iteraci√≥n, se llama <i>strlen</i> , que cada vez calcula la longitud de la misma l√≠nea.  No es la operaci√≥n m√°s eficiente :) <br><br>  Echemos un vistazo a la definici√≥n de <i>clientcredentialIOT_THING_NAME</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * @brief Host name. * * @todo Set this to the unique name of your IoT Thing. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> clientcredentialIOT_THING_NAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span></span></code> </pre> <br>  Se le solicita al usuario que ingrese el nombre de su dispositivo aqu√≠.  Por defecto, est√° vac√≠o, y en este caso, todo est√° bien.  Pero, ¬øqu√© pasa si el usuario quiere ingresar un nombre largo y hermoso all√≠?  Por ejemplo, me encantar√≠a llamar a mi creaci√≥n " <i>La m√°quina de caf√© apasionada y sofisticada BarBarista-N061E The Ultimate Edition</i> ".  ¬øTe imaginas cu√°l ser√≠a mi sorpresa si despu√©s de eso mi hermosa cafetera comenzara a funcionar un poco m√°s despacio?  L√≠o! <br><br>  Para corregir el error, <i>strlen</i> debe eliminarse del cuerpo del bucle.  Despu√©s de todo, el nombre del dispositivo no cambia mientras se ejecuta el programa.  Ehhh, aqu√≠ ser√≠a <i>constexpr</i> de C ++ ... <br><br>  Vale, vale, lo admito: aqu√≠ estaba un poco engrosado.  Como se√±al√≥ mi colega Andrei Karpov, los compiladores modernos saben qu√© <i>es strlen</i> y √©l observ√≥ personalmente c√≥mo simplemente usan una constante en c√≥digo binario, si entienden que la longitud de la cadena no puede cambiar.  Por lo tanto, existe una alta probabilidad de que en el modo de compilaci√≥n de la versi√≥n de lanzamiento, en lugar del c√°lculo real de la longitud de la cadena, simplemente se use un valor calculado previamente.  Sin embargo, esto no siempre funciona, por lo que escribir dicho c√≥digo no es una buena pr√°ctica. <br><br><h2>  Algunas palabras sobre MISRA </h2><br>  El analizador PVS-Studio tiene un gran conjunto de reglas que le permiten verificar que su c√≥digo cumpla con los est√°ndares MISRA C y MISRA C ++.  ¬øCu√°les son estos est√°ndares? <br><br>  MISRA es el est√°ndar de codificaci√≥n para sistemas integrados altamente receptivos.  Contiene un conjunto de reglas y pautas estrictas para escribir c√≥digo y configurar el proceso de desarrollo.  Hay bastantes de estas reglas, y est√°n destinadas no solo a eliminar errores graves, sino tambi√©n a varios "olores de c√≥digo", as√≠ como a escribir el c√≥digo m√°s comprensible y legible. <br><br>  Por lo tanto, seguir el est√°ndar MISRA no solo ayuda a evitar errores y vulnerabilidades, sino tambi√©n significativamente, ¬°significativamente!  - reducir la probabilidad de que ocurran en un c√≥digo existente. <br><br>  MISRA se utiliza en las industrias aeroespacial, m√©dica, automotriz y militar, donde la vida humana depende de la calidad del software incorporado. <br><br>  Aparentemente, los desarrolladores de Amazon FreeRTOS conocen este est√°ndar y, en su mayor parte, lo siguen.  As√≠ es: si est√° escribiendo un sistema operativo de base amplia para sistemas integrados, debe pensar en la seguridad. <br><br>  Sin embargo, encontr√© bastantes violaciones del est√°ndar MISRA.  No dar√© aqu√≠ ejemplos de reglas como ‚Äúno usar uni√≥n‚Äù o ‚Äúuna funci√≥n debe tener solo un retorno al final del cuerpo‚Äù; desafortunadamente, no son espectaculares, como la mayor√≠a de las reglas de MISRA.  Ser√° mejor que le d√© ejemplos de infracciones que podr√≠an tener graves consecuencias. <br><br>  Comencemos con las macros: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FreeRTOS_ms_to_tick(ms) ( ( ms * configTICK_RATE_HZ + 500 ) / 1000 )</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SOCKETS_htonl( ulIn ) ( ( uint32_t ) \ ( ( ( ulIn &amp; 0xFF ) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 24 ) | ( ( ulIn &amp; 0xFF00 ) &lt;&lt; 8 ) \ | ( ( ulIn &amp; 0xFF0000 ) &gt;&gt; 8 ) | ( ( ulIn &amp; 0xFF000000 ) &gt;&gt; 24 ) ) )</span></span></span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEFT_ROTATE( x, c ) ( ( x </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; c ) | ( x &gt;&gt; ( 32 - c ) ) )</span></span></span></span></code> </pre> <br>  <b>Advertencias de PVS-Studio:</b> <br><br><ul><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro y sus par√°metros deben encerrarse entre par√©ntesis.  Considere inspeccionar el par√°metro 'ms' de la macro 'FreeRTOS_ms_to_tick'.  FreeRTOS_IP.h 201 </li><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro y sus par√°metros deben encerrarse entre par√©ntesis.  Considere inspeccionar el par√°metro 'ulIn' de la macro 'SOCKETS_htonl'.  iot_secure_sockets.h 512 </li><li>  V2546 [MISRA C 20.7] La ‚Äã‚Äãmacro y sus par√°metros deben encerrarse entre par√©ntesis.  Considere inspeccionar los par√°metros 'x', 'c' de la macro 'LEFT_ROTATE'.  iot_device_metrics.c 90 </li></ul><br>  S√≠, esto es exactamente lo que pensabas.  Los par√°metros de estas macros no est√°n entre par√©ntesis.  Si alguien escribe accidentalmente algo como <br><br><pre> <code class="cpp hljs">val = LEFT_ROTATE(A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span>, B);</code> </pre> <br>  entonces dicha macro de "llamada" se abrir√° en: <br><br><pre> <code class="cpp hljs">val = ( ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; B ) | ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; ( <span class="hljs-number"><span class="hljs-number">32</span></span> - B ) ) );</code> </pre> <br>  ¬øRecuerdas las prioridades de las operaciones?  Primero, se realiza un desplazamiento a nivel de bits, y solo despu√©s de que se realiza un "o" a nivel de bits.  Por lo tanto, se violar√° la l√≥gica del programa.  Un ejemplo m√°s simple: ¬øqu√© sucede si la expresi√≥n " <i>x + y</i> " se pasa a la macro <i>FreeRTOS_ms_to_tick</i> ?  Uno de los objetivos principales de MISRA es prevenir la ocurrencia de tales situaciones. <br><br>  Alguien puede objetar: ‚Äúsi tienes programadores que no saben sobre esto, ¬°entonces ning√∫n est√°ndar te salvar√°!‚Äù Y no estar√© de acuerdo con esto.  Los programadores tambi√©n son personas, y no importa cu√°n experimentada sea una persona, √©l tambi√©n puede cansarse y cometer un error al final de la jornada laboral.  Esta es una de las razones por las que MISRA recomienda encarecidamente el uso de herramientas de an√°lisis automatizadas para validar que un proyecto cumpla con el est√°ndar. <br><br>  Me dirijo a los desarrolladores de Amazon FreeRTOS: PVS-Studio encontr√≥ 12 macros inseguras m√°s, por lo que tienes m√°s cuidado all√≠ con ellas :) <br><br>  Otra violaci√≥n interesante de MISRA: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Callback for an asynchronous request to notify * that the response is complete. * * @param[in] 0pPrivData - User private data configured * with the HTTPS Client library request configuration. * @param[in] respHandle - Identifier for the current response finished. * @param[in] rc - Return code from the HTTPS Client Library * signaling a possible error. * @param[in] status - The HTTP response status. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _responseCompleteCallback(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pPrivData, IotHttpsResponseHandle_t respHandle, IotHttpsReturnCode_t rc, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> status) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* pUploadSuccess = (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>*)pPrivData; <span class="hljs-comment"><span class="hljs-comment">/* When the remote server response with 200 OK, the file was successfully uploaded. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == IOT_HTTPS_STATUS_OK) { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Post to the semaphore that the upload is finished. */</span></span> IotSemaphore_Post(&amp;(_uploadFinishedSem)); }</code> </pre> <br>  ¬øPuedes encontrar el error t√∫ mismo? <br><br>  <b>Advertencia de PVS-Studio:</b> V2537 [MISRA C 2.7] Las funciones no deben tener par√°metros no utilizados.  Considere inspeccionar el par√°metro: 'rc'.  iot_demo_https_s3_upload_async.c 234 <br><br>  Mire m√°s de cerca: el par√°metro <i>rc</i> no se usa en ninguna parte del cuerpo de la funci√≥n.  Adem√°s, en el comentario sobre la funci√≥n se escribe expl√≠citamente que este par√°metro es el c√≥digo de retorno de otra funci√≥n y que puede indicar un error.  Entonces, ¬øpor qu√© este par√°metro no se procesa de ninguna manera?  Claramente hay algo mal aqu√≠. <br><br>  Sin embargo, incluso sin tales comentarios, los par√°metros no utilizados a menudo indican l√≥gica de programa rota.  De lo contrario, ¬øpor qu√© se necesitan en la firma de la funci√≥n? <br><br>  Aqu√≠ he dado una peque√±a funci√≥n que es muy adecuada para un ejemplo en el art√≠culo.  Adem√°s de ella, encontr√© 10 par√°metros m√°s sin usar.  Muchos de ellos se usan en funciones m√°s grandes, y encontrarlos no es lo m√°s f√°cil. <br><br>  Es sospechoso que no se hayan encontrado antes.  De hecho, los compiladores pueden detectar f√°cilmente tales casos. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b80/6c7/bb9/b806c7bb94c335ce2712e9b46cffc560.png" alt="Figura 1"></div><br><br><h2>  Conclusi√≥n </h2><br>  Estas no eran todas las √°reas problem√°ticas encontradas por el analizador, pero el art√≠culo ya era bastante extenso.  Espero que, gracias a √©l, los desarrolladores de Amazon FreeRTOS puedan corregir algunas deficiencias y tal vez incluso quieran <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">probar PVS-Studio por</a> su cuenta.  De esta forma, ser√° posible estudiar las advertencias m√°s a fondo y, de hecho, trabajar con una interfaz conveniente es mucho m√°s f√°cil que mirar un informe de texto. <br><br>  ¬°Gracias por leer nuestros art√≠culos!  Nos vemos en el pr√≥ximo n√∫mero: D <br><br>  PD: Dio la casualidad de que este art√≠culo fue publicado el 31 de octubre.  ¬°Por lo tanto, les deseo a todos un feliz Halloween! <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Si desea compartir este art√≠culo con una audiencia de habla inglesa, utilice el enlace a la traducci√≥n: George Gribkov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">A petici√≥n de los desarrolladores integrados: detecci√≥n de errores en Amazon FreeRTOS</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/473972/">https://habr.com/ru/post/473972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../473956/index.html">Informaci√≥n secreta de una compa√±√≠a telef√≥nica de traficantes de drogas</a></li>
<li><a href="../473958/index.html">Japoneses de NICT introdujeron un cluster de fibra funcional con un ancho de banda de 1 Pbit / s</a></li>
<li><a href="../473960/index.html">Estrategias de localizaci√≥n de contenido</a></li>
<li><a href="../473962/index.html">El modo oscuro ahora est√° en todas partes. ¬øEs tan √∫til? (al final de la encuesta posterior)</a></li>
<li><a href="../473966/index.html">A petici√≥n de los desarrolladores integrados: detecci√≥n de errores en Amazon FreeRTOS</a></li>
<li><a href="../473974/index.html">Intercom'19: una conferencia sobre automatizaci√≥n de comunicaciones de Voximplant se llevar√° a cabo el 14 de noviembre</a></li>
<li><a href="../473976/index.html">AWS Elasticsearch: producto fundamentalmente defectuoso</a></li>
<li><a href="../473978/index.html">Tal dolor, tal dolor, caja registradora como servicio 2: 0</a></li>
<li><a href="../473980/index.html">La tecnolog√≠a y el mundo real: 4 nuevas empresas que est√°n cambiando el futuro del dise√±o de interiores</a></li>
<li><a href="../473982/index.html">NB-IoT: ¬øc√≥mo funciona? Parte 3: SCEF: una √∫nica ventana de acceso a los servicios del operador</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>