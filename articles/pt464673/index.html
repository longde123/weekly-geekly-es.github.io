<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÉè üë©üèæ‚Äçü§ù‚Äçüë©üèº üëãüèæ TinyFL - driver de lanterna de microcontrolador üîò üíáüèæ ‚úäüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Habr! 


 Quero contar uma hist√≥ria sobre como entrei nas m√£os de um farol chin√™s em um LED Cree XM-L e o que aconteceu a seguir. 



 Antecedentes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TinyFL - driver de lanterna de microcontrolador</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464673/"><p>  Oi Habr! </p><br><p>  Quero contar uma hist√≥ria sobre como entrei nas m√£os de um farol chin√™s em um LED Cree XM-L e o que aconteceu a seguir. </p><br><p><img src="https://habrastorage.org/webt/ec/vx/uq/ecvxuq8hlp8-x_b6iacutkxyrmo.jpeg"></p><a name="habracut"></a><br><h2 id="predystoriya">  Antecedentes </h2><br><p>  Era uma vez, eu pedi uma lanterna com um LED brilhante de um site chin√™s.  A lanterna acabou sendo bastante ergon√¥mica (embora pudesse ser mais f√°cil), mas seu motorista deixou muito a desejar. </p><br><p>  Brilhou bastante, mas o motorista tinha apenas tr√™s modos - muito brilhante, brilhante e estrobosc√≥pico, alternando entre os quais era feito com o toque de um bot√£o.  Para ligar e desligar a lanterna, era necess√°rio selecionar esses tr√™s modos de cada vez.  Al√©m disso, essa lanterna, quando ligada, descarregou a bateria at√© o fim - ent√£o um par de minhas 18650 latas entrou em descarga profunda. </p><br><p>  Tudo isso era desconfort√°vel e irritante, ent√£o, em algum momento, decidi fazer o meu motorista para isso, que ser√° a hist√≥ria seguinte. </p><br><div class="spoiler">  <b class="spoiler_title">Lanterna com um driver antigo</b> <div class="spoiler_text"><p>  <em>Aqui est√° uma lanterna, provavelmente muitos j√° lidaram com</em> <br><img src="https://habrastorage.org/webt/lp/8j/cy/lp8jcyodmsrehdop-qawqouaw-g.jpeg"></p><br><p>  <em>Parece que o driver original</em> <br><img src="https://habrastorage.org/webt/g-/cr/-w/g-cr-w88dmljau5oknxtpcxbrmu.jpeg"></p></div></div><br><h2 id="tehnicheskoe-zadanie">  Termos de Refer√™ncia </h2><br><p>  Como voc√™ sabe, para obter um bom resultado, qualquer desenvolvimento deve ter boas especifica√ß√µes t√©cnicas, por isso tentarei formul√°-lo por mim mesmo.  Portanto, o motorista deve: </p><br><ul><li>  Para poder ligar / desligar pressionando rapidamente um bot√£o (um bot√£o sem fixa√ß√£o).  Talvez essa seja a principal raz√£o pela qual tudo isso come√ßou. </li><li>  Tenha um controle de brilho suave (cont√≠nuo), desde o mais brilhante - "turbo" at√© "luar" quando o diodo estiver pouco iluminado.  O brilho deve mudar uniformemente. </li><li>  Lembre-se do brilho definido para o tempo livre. </li><li>  Monitore a carga da bateria, avisando quando estiver quase descarregada (cerca de 3,3V) e desligando quando estiver completamente descarregada (cerca de 2,9V).  Para baterias diferentes, esses par√¢metros podem ser diferentes.  Consequentemente, a tens√£o operacional deve estar na faixa de 2,7 a 4,5V. </li><li>  Tem 2 modos especiais - farol de emerg√™ncia e estrobosc√≥pio (bem, por que n√£o?) </li><li>  Para poder ligar / desligar o LED traseiro (isso √© verdade ao andar de bicicleta √† noite, √© algo como uma luz indicadora). </li><li>  Tenha prote√ß√£o contra polaridade reversa e eletricidade est√°tica.  N√£o necessariamente, mas ser√° uma boa adi√ß√£o, porque no escuro voc√™ pode colocar a bateria do lado errado. </li><li>  Seja menor que o tamanho do driver original, mas tenha a mesma pegada.  O motorista chin√™s √© simplesmente enorme, tornando-o maior n√£o ser√° f√°cil. </li></ul><br><p>  Bem, se a lanterna estiver modificada, por que n√£o montar um carregador com um conector micro-USB?  Eu sempre tenho um cabo e um carregamento USB √† m√£o e preciso procurar uma fonte de alimenta√ß√£o nativa. </p><br><h2 id="zhelezo">  Ferro </h2><br><p>  Eu tenho alguma experi√™ncia com o Arduino, por isso foi decidido fazer um driver na fam√≠lia AVR MK.  Eles s√£o amplamente dispon√≠veis, f√°ceis de programar e t√™m modos de baixo consumo de energia (suspens√£o). </p><br><p>  O microcontrolador Attiny13a foi escolhido como o "c√©rebro" do motorista - √© um dos Atmel MCs mais baratos (agora absorvidos pelo Microchip), tem tudo a bordo - um GPIO para conectar um bot√£o e um LED, um temporizador para gerar um sinal PWM, um ADC para medir tens√£o e EEPROM para salvar os par√¢metros.  Apenas 1 KB de mem√≥ria flash est√° dispon√≠vel (mas quanto √© necess√°rio para uma lanterna), al√©m de 64 B de RAM e a mesma quantidade de EEPROM. <br>  O Attiny13 est√° dispon√≠vel em v√°rias op√ß√µes de caixa, em particular no DIP-8, que podem ser inseridas diretamente em uma t√°bua de p√£o regular com um passo de 2,54 mm. </p><br><p>  Como apenas 3 fios v√£o da parte de tr√°s √† cabe√ßa da lanterna, o bot√£o √© for√ßado a encurtar at√© o ch√£o (sobre a impossibilidade de encurtar para mais - mais tarde), voc√™ ter√° que ligar o LED mais - o que significa que voc√™ precisa de um poste de canal P.  Eu peguei o AO3401 como um transistor, mas voc√™ pode usar o SI2323, √© mais caro, mas tem menos resist√™ncia de canal aberto (40 mOhm, enquanto o AO3401 tem 60 mOhm, a 4,5 V), portanto, o driver aquece menos. </p><br><p>  <em>Das palavras √†s a√ß√µes, coleciono em uma t√°bua de p√£o uma vers√£o preliminar</em> <br><img src="https://habrastorage.org/webt/6g/tx/89/6gtx89n9apulzr9kwouv9v-vkn8.jpeg"></p><br><p>  Atualmente, ele √© alimentado diretamente pelo programador, com uma tens√£o de 5 V (na verdade menor devido a perdas no cabo USB).  Em vez do LED, o XM-L at√© o momento colocou um LED regular nas pernas e colocou um transistor fraco com uma tens√£o de limiar alta. <br>  Em seguida, no programa Altium Designer, foi desenhado um diagrama, que eu suplementei com prote√ß√£o contra polaridade reversa e ESD. </p><br><p><img src="https://habrastorage.org/webt/nt/cv/re/ntcvrepefjh36tyfclmcwze_e4o.png"></p><br><div class="spoiler">  <b class="spoiler_title">Descri√ß√£o detalhada e finalidade de todos os componentes</b> <div class="spoiler_text"><h4 id="obyazatelnye-komponenty">  Pr√©-requisitos: </h4><br><p>  U1 - Microcontrolador Attiny13a no pacote 8S1 (√≠ndice SSU) </p><br><p>  C1 - capacitor de desacoplamento para alimenta√ß√£o do microcontrolador, deve estar na regi√£o de 0,1 microfarads, caso 1206 ou 0805, coeficiente de temperatura X7R </p><br><p>  R1-R2 √© um divisor de resistor para medir a tens√£o da bateria, qualquer classifica√ß√£o pode ser definida, aqui a rela√ß√£o principal (750K / 220K, rela√ß√£o de divis√£o 4,41) e a corrente de fuga, que ser√° maior se as classifica√ß√µes forem aumentadas (na corrente √© de cerca de 4 ŒºA).  Como um ION interno √© usado (1,1 V, de acordo com a folha de dados, pode estar entre 1,0 V - 1,2 V), a tens√£o m√°xima na sa√≠da do divisor n√£o deve ser maior que 1 V. Com um divisor 750/220, a tens√£o m√°xima permitida na entrada do divisor ser√° de 4,41 V, o que mais do que suficiente para todos os tipos de baterias de l√≠tio. <br>  Eu calculei o divisor usando esta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">calculadora</a> . </p><br><p>  R3 - protege a sa√≠da da porta do microcontrolador de um curto-circuito (se PB1 for repentinamente puxado para o VCC, uma grande corrente fluir√° atrav√©s do pino e o MC poder√° queimar) </p><br><p>  R4 - puxar o RESET MK para ligar, sem ele, √© poss√≠vel reiniciar a partir de captadores. </p><br><p>  Q1 - Transistor de efeito de campo de canal P no pacote SOT-23, instalei o AO3401, mas qualquer outro com uma pinagem adequada (por exemplo, SI2323) </p><br><p>  R7 √© um resistor limitador de corrente.  Como a porta do transistor possui uma certa capacidade, ao carregar essa capacidade, uma grande corrente pode passar atrav√©s do pino e o pino pode falhar.  Voc√™ pode configur√°-lo na regi√£o de 100-220 Ohms (n√£o deve mais ser, o transistor come√ßar√° a ficar em um estado semi-fechado por um longo tempo e, como resultado, aquecer√° mais). </p><br><p>  R6 - obturador do resistor para alimenta√ß√£o.  No caso de PB0 entrar em um estado de alta imped√¢ncia, a l√≥gica 1 ser√° instalada atrav√©s desse resistor na porta Q1 e o transistor ser√° fechado.  Isso pode ocorrer devido a um erro no c√≥digo ou no modo de programa√ß√£o. </p><br><p>  D2 - diodo "travado" - permite que a tens√£o "caia" (quando o LED acende por um curto per√≠odo para brilho total) para alimentar o MK do capacitor por um tempo, mas tamb√©m protege contra polaridade reversa. <br>  Voc√™ pode colocar qualquer diodo Schottky no pacote SOD323 com uma queda de tens√£o m√≠nima, coloquei BAT60. </p><br><p>  Inicialmente, a prote√ß√£o contra polaridade reversa da fonte de alimenta√ß√£o era feita no transistor de efeito de campo (isso pode ser visto nas placas feitas por pilhagem).  Um recurso desagrad√°vel surgiu ap√≥s a fia√ß√£o - quando a carga foi ligada, ocorreu uma queda de tens√£o e o MK reiniciou, pois o trabalhador de campo n√£o limita a corrente na dire√ß√£o oposta.  No come√ßo, soldei um capacitor eletrol√≠tico de 200 uF entre o VCC e o GND, mas n√£o gostei dessa solu√ß√£o devido ao seu tamanho.  Eu tive que soldar o transistor e colocar um diodo em seu lugar, pois o SOT-23 e o SOD-323 t√™m dimens√µes semelhantes. </p><br><p>  Total, no circuito, existem apenas 10 componentes necess√°rios para a instala√ß√£o. </p><br><h4 id="neobyazatelnye-komponenty">  Componentes opcionais: </h4><br><p>  R5 e D1 s√£o respons√°veis ‚Äã‚Äãpela luz de fundo (LED2).  A classifica√ß√£o m√≠nima de R5 √© 100 ohms.  Quanto maior a classifica√ß√£o, mais fraco o LED traseiro fica aceso (acende no modo constante, sem PWM).  D1 - qualquer LED no caso 1206, eu coloquei verde, porque  visualmente eles s√£o mais brilhantes nas mesmas correntes do que outros. </p><br><p>  D3 e D4 s√£o diodos de prote√ß√£o (TVS), usei PESD5V0 (5.0V) no pacote SOD323.  D3 protege contra sobretens√£o por energia, D4 - por um bot√£o.  Se o bot√£o estiver coberto por uma membrana, n√£o haver√° um significado especial nela.  Provavelmente vale a pena usar diodos de prote√ß√£o bidirecionais; caso contr√°rio, quando a polaridade for revertida, a corrente fluir√° atrav√©s deles e eles queimar√£o (consulte o CVC de um diodo de prote√ß√£o bidirecional). </p><br><p>  C2 - um capacitor de t√¢ntalo no caso A (semelhante a 1206), faz sentido configur√°-lo quando o driver estiver inst√°vel (a tens√£o de alimenta√ß√£o pode ser comprimida nas altas correntes de comuta√ß√£o do LED) </p><br><p>  Todos os resistores do tamanho 0603 (para mim, esse √© um limite adequado para solda manual) </p></div></div><br><p>  Tudo est√° claro com os componentes, voc√™ pode fazer uma placa de circuito impresso de acordo com o esquema acima. <br>  A primeira coisa a fazer √© construir um modelo 3D da futura placa, juntamente com os furos - IMHO, no Altium Designer, esta √© a maneira mais conveniente de determinar a geometria da PCB. <br>  Eu medi as dimens√µes do driver antigo e seus orif√≠cios de montagem - a placa deve ser anexada a eles, mas com dimens√µes menores (para versatilidade, de repente voc√™ precisa constru√≠-la em outro lugar). <br>  Um m√≠nimo razo√°vel aqui ficou em torno de 25x12,5 mm (propor√ß√£o 2: 1), com dois orif√≠cios com um di√¢metro de 2 mm para fixa√ß√£o na carca√ßa da l√¢mpada com parafusos nativos. </p><br><p>  Fiz um modelo 3D no SolidWorks e depois exportei para o Altium Designer como STEP. <br>  Depois coloquei os componentes na placa, fiz os contatos nos cantos (√© mais conveniente e mais f√°cil soldar o ch√£o), Attiny13 colocado no centro, o transistor mais pr√≥ximo dos contatos do LED. <br>  Espalhei as faixas de for√ßa, coloquei os componentes restantes e separamos as faixas de sinal.  Por conveni√™ncia de conectar a mem√≥ria, criei contatos separados, que duplicam os contatos da bateria. <br>  Fiz toda a fia√ß√£o (com exce√ß√£o de um jumper) na camada superior - para poder fazer uma placa em casa com o LUT. <br>  A largura m√≠nima dos caminhos do sinal √© de 0,254 mm / 10 mil; os de pot√™ncia t√™m largura m√°xima sempre que poss√≠vel. </p><br><p>  <em>√â assim que a placa com fio fica no Altium Designer</em> <br><img src="https://habrastorage.org/webt/yu/i4/bo/yui4bosmzwqjagvmj_clljr09ck.png"></p><br><p>  O Altium Designer tem a oportunidade de ver como a placa ficar√° em 3D (para isso, voc√™ precisa de modelos para todos os componentes, alguns dos quais voc√™ teve que construir por conta pr√≥pria). <br>  Talvez algu√©m aqui diga que o modo 3D n√£o √© necess√°rio para o rastreador, mas, para mim, pessoalmente, √© uma fun√ß√£o conveniente que facilita a coloca√ß√£o de componentes para facilitar a soldagem. </p><br><p><img src="https://habrastorage.org/webt/my/jk/1r/myjk1rvgvm50odtu4iy77czuy3i.png"></p><br><p>  No momento da reda√ß√£o deste artigo, foram feitas tr√™s vers√µes do quadro - a primeira para LUT, a segunda para fabrica√ß√£o industrial e a terceira final com algumas corre√ß√µes. </p><br><h2 id="izgotovlenie-plat">  Tomada de placa </h2><br><h3 id="samodelnyy-sposob">  Maneira caseira </h3><br><p>  LUT - tecnologia de passar a laser, um m√©todo para produzir placas de circuito usando gravura em uma m√°scara obtida pela convers√£o de toner de papel em cobre.  Esse m√©todo √© √≥timo para placas simples de um lado, como este driver. <br>  A rede possui muitos artigos sobre essa tecnologia, portanto n√£o entrarei em detalhes, mas apenas mostrarei brevemente como fa√ßo. </p><br><p>  Primeiro, voc√™ precisa preparar um modelo que ser√° impresso em papel t√©rmico.  Eu exporto a camada top_layer para PDF, recebo uma imagem vetorial. </p><br><p><img src="https://habrastorage.org/webt/lq/f3/dm/lqf3dmub3ivxcx3y32uijk9dy2a.png"></p><br><p>  Como a placa √© pequena, faz sentido pegar um peda√ßo de PCB com dimens√µes v√°rias vezes maiores e fazer o que a ind√∫stria chama de pain√©is. <br>  Para esses fins, o CorelDraw √© muito conveniente, mas voc√™ pode usar qualquer outro editor de vetores. <br>  Coloco c√≥pias dos modelos no documento, fa√ßo intervalos de 0,5 a 1 mm entre as placas (depende do m√©todo de separa√ß√£o, mais adiante), as placas devem estar localizadas simetricamente - caso contr√°rio, ser√° dif√≠cil separ√°-las. </p><br><p>  Pego um peda√ßo de PCB unilateral com dimens√µes ligeiramente maiores que o painel montado, limpo e desengordurante (prefiro esfregar com uma borracha e depois com √°lcool).  Imprimo um modelo para gravar em papel t√©rmico (aqui √© importante n√£o esquecer de espelhar o modelo). <br>  Com a ajuda de um ferro e a paci√™ncia, afagando suavemente no papel, eu o traduzo para textolite.  Espero at√© esfriar e, com cuidado, retiro o papel. <br>  √Åreas livres de cobre (n√£o revestidas com toner) podem ser envernizadas ou coladas (quanto menor a √°rea de cobre, mais r√°pida ser√° a rea√ß√£o de ataque). </p><br><p>  <em>Um painel t√£o dom√©stico - um grande n√∫mero de placas pode compensar defeitos de fabrica√ß√£o</em> <br><img src="https://habrastorage.org/webt/ob/f-/fk/obf-fkjp7lq5fcrxrr_x7rprgw8.jpeg"></p><br><p>  Veneno as placas com √°cido c√≠trico em uma solu√ß√£o de per√≥xido de hidrog√™nio, essa √© a maneira mais acess√≠vel, embora seja bastante lenta. <br>  As propor√ß√µes s√£o as seguintes: para 100 ml de per√≥xido a 3% s√£o 30 g de √°cido c√≠trico e cerca de 5 g de sal, tudo √© misturado e vertido em um recipiente com textolito. <br>  O aquecimento da solu√ß√£o acelerar√° a rea√ß√£o, mas poder√° causar a descolagem do toner. </p><br><p>  <em>Magia qu√≠mica desconhecida come√ßa: o cobre √© coberto por bolhas e a solu√ß√£o assume uma tonalidade azul</em> <br><img src="https://habrastorage.org/webt/bc/jh/pz/bcjhpzjgqcrcmqq1wr8j_def1yw.jpeg"></p><br><p>  Depois de algum tempo, pego a placa gravada e limpo o toner.  Como n√£o consigo lav√°-lo com solventes, removo-o mecanicamente com papel de esmeril de gr√£o fino. </p><br><p>  Agora resta estanhar a placa - isso ajudar√° na solda e proteger√° o cobre da oxida√ß√£o e facilitar√° a solda.  Prefiro estanhar com a liga Rose - essa liga derrete a uma temperatura de cerca de 95 graus, o que permite que seja estanhada em √°gua fervente (sim, talvez n√£o seja a composi√ß√£o mais confi√°vel para estanhar, mas para placas de circuito caseiras). </p><br><p><img src="https://habrastorage.org/webt/a5/fs/lk/a5fslka8zacdyhd2mrfad4irlx0.jpeg"></p><br><p>  Ap√≥s estanhar, perfuro uma prancha (para contatos, uso brocas de metal duro f1.0, para jumpers - f0.7), perfuro com uma dremel por falta de outra ferramenta.  N√£o gosto de cortar text√≥lito por causa da poeira, portanto, ap√≥s a perfura√ß√£o, corto as t√°buas com uma faca de escrit√≥rio - em ambos os lados fa√ßo v√°rios cortes em uma linha e depois a corto.  Isso lembra o m√©todo de corte em V usado na ind√∫stria, apenas h√° uma incis√£o feita por um moinho. </p><br><p>  <em>Parece uma placa pronta para soldar</em> <br><img src="https://habrastorage.org/webt/xw/3v/6n/xw3v6ns0nrje-n8saj5gobrvces.jpeg"></p><br><p>  Quando a placa estiver pronta, voc√™ poder√° come√ßar a conectar os componentes.  Primeiro, soldo um pouco (resistores 0603), depois tudo o mais.  Como os resistores s√£o adjacentes ao MK, a soldagem na ordem inversa pode ser problem√°tica.  Ap√≥s a solda, verifico se h√° um curto-circuito na alimenta√ß√£o do driver, ap√≥s o qual j√° √© poss√≠vel iniciar o firmware MK. </p><br><p>  <em>Drivers prontos para baixar o firmware</em> <br><img src="https://habrastorage.org/webt/4u/au/jk/4uaujk48pqllmzplxcxuy_yfig8.jpeg"></p><br><h3 id="promyshlennyy-sposob">  Maneira industrial </h3><br><p>  O LUT √© r√°pido e acess√≠vel, mas a tecnologia tem suas desvantagens (como quase todos os m√©todos de fabrica√ß√£o de PP ‚Äúdom√©sticos‚Äù).  √â problem√°tico fazer uma placa de dupla face, as faixas podem ser gravadas e voc√™ s√≥ pode sonhar em metalizar os orif√≠cios. </p><br><p>  Felizmente, os empreendedores chineses h√° muito oferecem servi√ßos para a fabrica√ß√£o de placas de circuito impresso de forma industrial. <br>  Curiosamente, uma placa de camada √∫nica chinesa custar√° mais do que uma placa de duas camadas, ent√£o decidi adicionar uma segunda camada (inferior) √† placa de circuito impresso.  Os caminhos de energia e o solo s√£o duplicados nessa camada.  Al√©m disso, tornou-se poss√≠vel fazer um dissipador de calor a partir do transistor (pol√≠gonos de cobre na camada inferior), o que permitir√° ao motorista trabalhar em correntes mais altas. </p><br><p>  <em>A camada inferior do quadro no Altium Designer</em> <br><img src="https://habrastorage.org/webt/x0/hf/b9/x0hfb9uk6flm6d7pat30fzm9lyu.png"></p><br><p>  Para este projeto, decidi pedir uma placa de circuito impresso no site da PcbWay.  O site possui uma calculadora conveniente para calcular o custo das placas, dependendo de seus par√¢metros, tamanhos e quantidade.  Ap√≥s calcular o custo, baixei o arquivo gerber criado anteriormente no Altium Designer, os chineses o verificaram e a placa foi para a produ√ß√£o. </p><br><p>  Fazer um conjunto de 10 placas TinyFL me custou US $ 5.  Ao registrar um novo usu√°rio, um desconto de US $ 5 √© concedido no primeiro pedido, por isso paguei apenas pelo frete, que tamb√©m custa algo em torno de US $ 5. <br>  Nesse site, h√° a oportunidade de colocar o projeto em dom√≠nio p√∫blico; portanto, se algu√©m quiser solicitar esses pain√©is, voc√™ pode simplesmente adicionar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esse projeto</a> √† cesta. </p><br><p>  Depois de algumas semanas, as mesmas diretorias vieram at√© mim, apenas <del>  bonita </del>  fabricado industrialmente.  Eles s√≥ podem ser descompactados e preenchidos com o firmware. </p><br><p><img src="https://habrastorage.org/webt/lp/j7/jk/lpj7jktyacb_h-atbtpze-9qzcw.jpeg"></p><br><h2 id="programma-proshivka">  Programa (firmware) </h2><br><p>  A principal dificuldade que surgiu ao escrever o firmware do driver, est√° associada ao tamanho extremamente pequeno da mem√≥ria flash - o Attiny13 possui apenas 1024 bytes. <br>  Al√©m disso, como a mudan√ßa de brilho √© suave, uma tarefa n√£o trivial era alter√°-la uniformemente - para isso, tivemos que fazer a corre√ß√£o gama. </p><br><h4 id="algoritm-upravleniya-drayverom">  Algoritmo de controle do motorista </h4><br><p>  O motorista liga com um breve toque no bot√£o, e desliga por ele. <br>  O modo de brilho selecionado √© armazenado durante o desligamento. </p><br><p>  Se durante a opera√ß√£o voc√™ pressionar duas vezes um bot√£o (clique duplo), o LED adicional ser√° ligado / desligado. <br>  Com uma press√£o longa durante a opera√ß√£o, o brilho da l√¢mpada muda gradualmente.  Pressionar repetidamente muda de dire√ß√£o (mais forte / mais fraco). </p><br><p>  O driver verifica periodicamente a voltagem da bateria e, se for menor que os valores definidos, avisa o usu√°rio sobre uma descarga e depois desliga para evitar uma descarga profunda. </p><br><div class="spoiler">  <b class="spoiler_title">Uma descri√ß√£o mais detalhada do algoritmo do driver</b> <div class="spoiler_text"><ol><li>  Quando a energia √© fornecida ao MK, os perif√©ricos s√£o configurados e o MK entra em suspens√£o (se STARTSLEEP estiver definido).  Quando a energia √© fornecida ao driver, os dois LEDs piscam um certo n√∫mero de vezes se STARTBLINKS estiver definido. </li><li>  Dormir  Attiny13 adormece no modo de desligamento (este √© o modo mais econ√¥mico, de acordo com a folha de dados, o consumo de MK ser√° de ~ 1 ŒºA), do qual s√≥ pode sair por qualquer interrup√ß√£o.  Nesse caso, √© uma interrup√ß√£o INT0 - pressionando um bot√£o (configurando PC1 para 0 l√≥gico). <br>  No PC1, uma flex√£o interna fraca deve ser ativada.  O ADC e o comparador s√£o os principais consumidores de corrente de toda a periferia e, portanto, tamb√©m precisam ser desligados.  Durante o sono, o conte√∫do dos registradores e da RAM √© armazenado; portanto, a EEPROM n√£o √© necess√°ria para lembrar o brilho. </li><li>  Ap√≥s o sono, os perif√©ricos e o PWM s√£o ligados e o driver entra em um ciclo sem fim, no qual o bot√£o √© monitorado e a voltagem da bateria √© verificada periodicamente. </li><li>  Se o bot√£o for pressionado, a hora √© pressionada. <br>  4.1  Se a press√£o for curta, √© esperado um clique duplo (se BTN_DBCLICK estiver definido). <br>  Se fosse, os comutadores LED2 adicionais <br>  Caso contr√°rio, v√° para o passo 2 (suspens√£o) <br>  4.2  Se a press√£o for longa (maior que BTN_ONOFF_DELAY) - o modo de controle de brilho ser√° ativado.  Neste modo: <br><ul><li>  A dire√ß√£o da mudan√ßa √© invertida (mais / menos) e a% de preenchimento PWM muda enquanto o bot√£o √© pressionado. </li><li>   /  (RATE_MAX / RATE_MIN),   ; </li><li>   n- (AUXMODES_DELAY)     ,   .    ‚Äî  (   25 ,  8 )    (     50,  1 ).        ,     -    . </li></ul></li><li>       ‚Äî    ADC2,     . <br><ul><li>      BAT_WARNING ‚Äì   </li><li>   BAT_WARNING ‚Äì    ,    . -     . ,         5 . </li><li>   BAT_SHUTDOWN ‚Äî    .2 (). </li></ul></li></ol></div></div><br><h4 id="upravlenie-yarkostyu-svetodioda">    </h4><br><p>  ,      ‚Äî   ,     -     ,  . -    ,     ,       .     P-  ,        ,    ‚Äî ,  .               . <br>      rate, 255 rate = 100% . <br>    1.2      1,     1200000/256 = 4.7 .     (  ),         (,   ,  ,   ).  ,      9.6 (CKSEL[1:0]=10, CKDIV8=1)  4.8  (CKSEL[1:0]=01, CKDIV8=1),      8   4  ,       . </p><br><p> ,         ,         .     ,      (      )      ,         ,  ,               1.5 ,   2        (   Cree XM-L   ‚Äî 3 ). <br>               ,     (rate=255)     3.          ,        .   ,    RATE_MAX     .   ,     SI2323DS      4 ,     2 ,     . </p><br><h4 id="gamma-korrekciya"> - </h4><br><p>      .     ,   5-10%       ,     75-100%      .     ,   n   ,  ,            ,        . </p><br><p>   ,          -.    ,       1      12   .       ,      rate_step_array.  , ,       . </p><br><h4 id="kontrol-napryazheniya-batarei">    </h4><br><p>  n- (      BAT_PERIOD)    .   ,    VIN      R1-R2,       PB4 (  ADC2   ). </p><br><p>        ,    ,      Vref,          1.1 .        ‚Äî     ,      (,  1.1       1023  255,   8- ).   ,        6   ,  255     1.1 ,   4.33  (  4.03),      . </p><br><p>     ,        .    BAT_WARNING       (  ,    ‚Äî    BAT_INFO_STEP,   ),    BAT_SHUTDOWN  . <br>         , ..    ,      . </p><br><p> ,     ,      . ,   4.03  R1 = 1M  R2 = 330,    R = 1330K     4  = 3 . <br>      ()    1 .      ,    ,     (  -       ‚Äî  ). </p><br><h4 id="vnesenie-izmeneniy-v-proshivku">     </h4><br><p>   ,       Arduino    C/C++. <br>      ,          (defines)   flashlight.h. <br>        Arduino IDE   Attiny13(a)  Atmel Studio ‚Äì   ,  Arduino IDE,   . </p><br><div class="spoiler"> <b class="spoiler_title">Arduino IDE</b> <div class="spoiler_text"><p>      Attiny13  IDE.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . <br>      Tools&gt;Board Attiny13(a)    Tools&gt;Frequency 1.2MHz. <br> ""      .ino,       ‚Äî      .   ,   ‚Äî      Arduino IDE.       - ,    .cpp. <br>       ,  ,          *.hex.        . </p></div></div><br><div class="spoiler"> <b class="spoiler_title">Atmel Studio</b> <div class="spoiler_text"><p>    IDE    flashlight.atsln,   ‚Äî   flashlight.h   ()  flashlight.cpp   . <br>         ‚Äî    . <br>        F7,   ( ,   ,  ).   debug  flashlight.hex,        . </p></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><p>          USBASP     AVRDUDEPROG.      GUI   avrdude,      ‚Äî      .       (   Attiny13(a),    Fuses    read.   ,      ,   .     programm,      .       flashlight.h </p><br><p> Para fazer upload do firmware, v√° para a guia Programa, selecione o arquivo de firmware compilado no formato HEX (flashlight.hex) na linha Flash e clique em Programa.  O status do firmware ser√° exibido na janela abaixo.  Se o download n√£o for bem-sucedido, pode ser um mau contato, acontece. Vale a pena tentar novamente.  A prop√≥sito, por esse motivo, o par√¢metro STARTBLINKS foi estabelecido - um √∫nico piscar de LED2 no momento de fornecer energia ao motorista serve como uma indica√ß√£o do contato do motorista com o programador. <br>  Em vez do USBASP, voc√™ pode usar o Arduino para baixar o firmware, mais detalhes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> </p><br><p>  <em>Programador USBASP conectado ao driver atrav√©s de um clipe com um loop</em> <br><img src="https://habrastorage.org/webt/7f/b2/sy/7fb2syr5zqnwqejhoqpxqqa_-vw.jpeg"></p><br><p>  Para conectar o USBASP a um tinka, eu uso um clipe para um SOIC de 8 pinos.  N√£o √© um dispositivo muito conveniente, voc√™ precisa atormentar 10 minutos antes de capturar o contato (talvez eu tenha encontrado um clipe com defeito).  Tamb√©m existem adaptadores SOIC-DIP nos quais o microcircuito √© inserido antes da soldagem e o firmware √© derramado - essa op√ß√£o √© mais conveniente, mas a capacidade de programar o circuito do driver √© perdida (ou seja, atualiza o firmware ap√≥s a soldagem do MK na placa). <br>  Se tudo isso n√£o estiver l√°, voc√™ poder√° simplesmente soldar os fios nos terminais do MK, que ser√£o conectados ao Arduino. </p></div></div><br><h4 id="kalibrovka">  Calibra√ß√£o </h4><br><p>  As correntes que passam pelo driver e pelo LED n√£o devem exceder os valores m√°ximos.  Para o LED XM-L, isso √© 3 A, para o driver depende do transistor usado, por exemplo, para SI2323, a corrente m√°xima √© de cerca de 4 A, mas √© melhor operar em correntes mais baixas devido ao aquecimento excessivo.  Para reduzir a corrente com brilho m√°ximo, √© usado o par√¢metro RATE_MAX (#define RATE_MAX xx, em que xx √© o brilho m√°ximo de 0 a 255). <br>  A calibra√ß√£o do ADC n√£o √© um procedimento obrigat√≥rio, mas se voc√™ deseja que o driver monitore com precis√£o a tens√£o limite, ser√° necess√°rio mexer nela. </p><br><p>  Os c√°lculos n√£o fornecer√£o alta precis√£o das medi√ß√µes, pois, primeiro, os resistores podem variar dentro da toler√¢ncia (geralmente de 1 a 5%) e, segundo, o √≠on interno pode ter uma dispers√£o de 1,0 a 1,2 V. <br>  Portanto, a √∫nica maneira aceit√°vel √© definir o valor nas unidades ADC (BAT_WARNING e BAT_SHUTDOWN), selecionando-o experimentalmente para o desejado.  Para fazer isso, voc√™ precisar√° de paci√™ncia, um programador e uma fonte de energia ajust√°vel. <br>  Defino o valor BAT_PERIOD como 1000 no firmware (verificando a tens√£o uma vez por segundo) e reduzi gradualmente a tens√£o de alimenta√ß√£o.  Quando o motorista come√ßou a avisar sobre a descarga, deixei o valor atual de BAT_WARNING conforme necess√°rio. <br>  Essa n√£o √© a maneira mais conveniente, talvez no futuro voc√™ precise executar um procedimento de calibra√ß√£o autom√°tica salvando os valores na EEPROM. </p><br><h2 id="sborka-fonarika">  Lanterna de montagem </h2><br><p>  Quando a placa estiver pronta e o firmware inundado, voc√™ poder√° finalmente coloc√°-la no lugar do driver antigo.  Tirei a solda do driver antigo e soldei um novo em seu lugar. </p><br><div class="spoiler">  <b class="spoiler_title">O novo driver est√° conectado em vez do antigo, de acordo com este esquema</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ar/7c/6j/ar7c6jgy4zprzi6crl9aogualo8.png"></p></div></div><br><p>  Depois de verificar se havia um curto-circuito na fonte de alimenta√ß√£o, conectei a fonte de alimenta√ß√£o e verifiquei a operabilidade.  Depois montei a placa de carregamento (TP4056), para isso tive que fazer um furo no conector de carregamento com um pouco de dremel e fix√°-lo com cola quente (era importante que a cola n√£o ca√≠sse no conector, seria dif√≠cil tir√°-lo dali). </p><br><p>  N√£o prendi a placa com parafusos, porque a rosca do estojo quebrou devido a tor√ß√µes repetidas, mas simplesmente derramou cola sobre ela, tamb√©m colou os fios nos locais de solda para que n√£o se desgastassem.  Decidi cobrir o motorista e o carregador com verniz acr√≠lico incolor, isso deve ajudar contra a corros√£o. </p><br><p><img src="https://habrastorage.org/webt/5g/qs/do/5gqsdoxgldinymg3njvlpsmnxz8.jpeg"></p><br><h2 id="testirovanie-i-raschet-stoimosti-izgotovleniya">  Teste e c√°lculo de custos de fabrica√ß√£o </h2><br><p>  Ap√≥s todas as opera√ß√µes, foi poss√≠vel come√ßar a testar os drivers.  A corrente foi medida com um mult√≠metro convencional, conectando-o ao circuito aberto da fonte de alimenta√ß√£o. </p><br><p>  Consumo de energia do driver antigo (medido em 4,04 V): </p><br><ol><li>  Durante o sono - n√£o medido </li><li>  Modo m√°ximo: 0,60 A </li><li>  Modo m√©dio: 0,30 A </li><li>  Estrobosc√≥pio: 0,28 A </li></ol><br><p>  Consumo de energia do novo driver (medido em 4,0 V): </p><br><ol><li>  No modo de suspens√£o, consome cerca de 4 ŒºA, o que √© muito menor do que a corrente de descarga autom√°tica de uma bateria de √≠ons de l√≠tio.  A corrente principal neste modo flui atrav√©s de um divisor de resistor. </li><li>  No modo m√≠nimo, o ‚Äúluar‚Äù √© de cerca de 5-7 mA, se assumirmos que a capacidade de uma c√©lula 18650 √© de cerca de 2500 mA * h, obteremos cerca de <strong>20 dias de opera√ß√£o cont√≠nua</strong> .  O pr√≥prio MK consome em algum lugar de 1,2 a 1,5 mA (a uma frequ√™ncia operacional de 1,2 MHz). </li><li>  No modo m√°ximo, "turbo" - consome cerca de 1,5 A; nesse modo, ele funciona por cerca de uma hora e meia.  O LED nessas correntes come√ßa a ficar muito quente; portanto, este modo n√£o se destina √† opera√ß√£o a longo prazo. </li><li>  Farol de emerg√™ncia - consome uma m√©dia de cerca de 80 mA; nesse modo, a lanterna funciona at√© 30 horas. </li><li>  Estrobosc√≥pio - consome cerca de 0,35 A, trabalha at√© 6 horas. </li></ol><br><h4 id="cena-voprosa">  Pre√ßo de emiss√£o </h4><br><p>  Se voc√™ comprar componentes no Chip e Deep, ser√£o produzidos cerca de 100 rublos (60 rublos Attiny13, ~ 40 rublos no restante do p√≥ solto).  Faz sentido encomendar da China, se v√°rias pe√ßas forem feitas - ent√£o, em termos de uma pe√ßa, ser√° mais barato, os chineses geralmente vendem em lotes de 10 pe√ßas ou mais. <br>  As taxas ser√£o liberadas a um pre√ßo na regi√£o de 300 rublos por 10 pe√ßas (sem entrega), se encomendadas na China. <br>  A fia√ß√£o e piscando um driver leva cerca de uma hora. </p><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  A lanterna chinesa se tornou muito mais conveniente, embora agora eu tenha reclama√ß√µes sobre sua mec√¢nica - a parte frontal √© muito pesada e o foco n√£o √© realmente necess√°rio. <br>  No futuro, pretendo fazer uma vers√£o desse driver para lanternas com um bot√£o liga / desliga (com fixa√ß√£o).  √â verdade que estou confuso com a abund√¢ncia de tais projetos.  Voc√™ acha que vale a pena fazer outro? </p><br><p>  <em>Driver de close-up (vers√£o 2_t)</em> <br><img src="https://habrastorage.org/webt/2f/sd/sl/2fsdslzywcu7izjgclyshshwjvy.jpeg"></p><br><p>  <strong>UPD</strong> : Adicionado suporte para o Arduino IDE. </p><br><p>  O c√≥digo fonte do firmware, o circuito e a fia√ß√£o da placa est√£o agora no github, voc√™ pode baix√°-lo aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/madcatdev/tinyfl_t</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt464673/">https://habr.com/ru/post/pt464673/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt464657/index.html">Cornija el√©trica para engenharia reversa AM82TV</a></li>
<li><a href="../pt464659/index.html">Seguran√ßa de aplicativos ou Como incorporar seguran√ßa no desenvolvimento personalizado. Experi√™ncia pessoal na AGIMA</a></li>
<li><a href="../pt464661/index.html">A quem confiar o projeto de instala√ß√µes t√©cnicas de reequipamento e reconstru√ß√£o</a></li>
<li><a href="../pt464665/index.html">Particionando no SQL Server</a></li>
<li><a href="../pt464671/index.html">Receba SMS regulares para mensageiros instant√¢neos Viber e Telegram (usando gateways GoIP)</a></li>
<li><a href="../pt464675/index.html">An√°lise dos mecanismos de localiza√ß√£o da interface do aplicativo no Splunk</a></li>
<li><a href="../pt464677/index.html">Investimentos na bolsa de valores e custos associados: quanto custam os servi√ßos de uma corretora</a></li>
<li><a href="../pt464679/index.html">Voxgun - um servi√ßo para criar conte√∫do de v√≠deo profissional sem nenhum esfor√ßo extra</a></li>
<li><a href="../pt464685/index.html">Tel√©grafo √≥ptico, rede de microondas e torre Tesla: torres de comunica√ß√£o incomuns</a></li>
<li><a href="../pt464687/index.html">Se voc√™ quer salvar o mundo, o veganismo n√£o √© uma op√ß√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>