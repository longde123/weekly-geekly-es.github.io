<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤖 💡 ❤️ Mains libres, mais pas un téléphone. Maison obéissante quand il n'y a pas assez de mains 😏 🧑🏿 🖨️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, communauté! 

 J'avais envie de jouer à nouveau avec le microcontrôleur et de faire quelque chose d'utile. Le but a été formé presque immédia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mains libres, mais pas un téléphone. Maison obéissante quand il n'y a pas assez de mains</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/408745/">  Bonjour, communauté! <br><br>  J'avais envie de jouer à nouveau avec le microcontrôleur et de faire quelque chose d'utile.  Le but a été formé presque immédiatement, car quelque chose m'a dérangé dans l'appartement. <br><br>  Comme vous le savez, une table d'ordinateur est une table à manger pour regarder Drobyshevsky ou lire Giktayms / Green Cat / etc.  en même temps que le dîner.  Mais il y a un problème - je sors généralement de la cuisine avec les <b>deux</b> mains occupées, et aussi le dos, <s>car les tasses sont empilées en 3 morceaux.</s>  Allumez et éteignez la lumière dans la cuisine (triple interrupteur - cuisine / salle de bain / WC) est l'épaule, le nez, l'auriculaire.  Autrement dit, il est gênant en aucune façon, mais il est impossible de le réorganiser.  Il y avait une tâche à gérer d'une manière ou d'une autre à distance. <br><br>  Tous les capteurs de présence et de passage ont été immédiatement écartés - pas cette précision, il n'y a aucun contrôle par la volonté du propriétaire.  La solution se trouve dans le contrôle du son, la voix.  Je dirai tout de suite que je n'avais pas prévu de faire de reconnaissance vocale, ce n'est pas nécessaire ici.  La lumière allumée par la pop a été décrite dans Radio 80, mais je ne voulais pas faire ça.  Il s'est avéré une sorte de mains libres lorsque les mains sont occupées.  Les détails sont connus. <br><a name="habracut"></a><br><h3>  Partie matériel. </h3><br>  Il y avait une carte avec Atmega32 avec du quartz et des périphériques <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SEM0007M-32A</a> et une dispersion d'électronique. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/65f/1a8/7e9/65f1a87e9d6aad209f747a4419cab7ad.jpg" width="40%" alt="image"></div><br>  Il y avait un microphone et un amplificateur opérationnel.  Pour la sortie, il y a un transistor dans un boîtier sot32 sur la carte, il y a aussi un relais de 7 ampères.  Tout est assemblé poussé dans un coffret pour cartes de visite, le relais est mis en parallèle avec l'interrupteur, le microphone est caché sous la prise.  Le schéma est banal, je ne l'ai même pas dessiné.  Une seule entrée analogique et une sortie MK discrète sont utilisées.  SEM est redondant, mais pour l'instant, laissez-le. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/3c0/69f/b83/3c069fb831046a304627595be0730b70.jpg" width="350" alt="image"></div>  <i>Carte et fils non assemblés.</i>  <i>Puis il l'a refait plus précisément.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/7ed/8ee/f59/7ed8eef59421665c5cef7009768a8a46.jpg" width="300" alt="image"></div>  <i>L'interrupteur lui-même, le microphone n'est pas visible sous la prise démontée.</i> <br><br><h3>  Recherchez un algorithme. </h3><br>  Objectif: le capteur doit répondre à un mot, par exemple, « <i>lumière!</i>  »Avec un minimum de code. <br>  Tâche: identifier le mot de commande sur fond de bruit, de coups et de clics possibles avec le même commutateur.  C'est-à-dire que seule l'analyse d'amplitude ne convient pas, et l'analyse spectrale a montré qu'il y a trop d'harmoniques dans le mot et bien sûr elles changent.  Il était donc nécessaire de rechercher une solution simple, mais avec une immunité au bruit acceptable.  Vous pouvez faire plusieurs filtres temps-fréquence et une comparaison avec un échantillon du mot, mais vous n'avez pas besoin de vous occuper de la reconnaissance.  Il a été décidé d'analyser la présence d'un seul son de voyelle, par exemple le son «E» ou «E». <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/a55/5e2/6cf/a555e26cf616bfab31872bce1794d612.png" alt="image"></div>  <i>Le son est "E".</i>  <i>De nombreuses harmoniques sont visibles, de ce fait, l'analyse est difficile.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/18e/d5c/ab8/18ed5cab8307bf96a2fb8d2ae77e64dd.png" alt="image"></div>  <i>Le son est "A."</i>  <i>Le spectre a l'air plus propre, il y a une fréquence principale.</i> <br><br><h3>  Partie logiciel </h3><br>  Afin de connaître les composantes spectrales du signal, vous pouvez utiliser des filtres numériques.  Il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bon programme sur</a> Internet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pour créer des filtres numériques FIR et IIR</a> et calculer leurs coefficients - c'est clair et le code C est automatiquement généré. <br><br><div class="spoiler">  <b class="spoiler_title">Mais j'ai refusé les filtres numériques</b> <div class="spoiler_text">  Pour un filtrage acceptable (4 ordres ou plus), de nombreux coefficients ont été obtenus, et même un flottant.  Comme ça, plus tous les calculs de filtre dans le flotteur: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ACoef[NCoef+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { <span class="hljs-number"><span class="hljs-number">0.00000347268864059354</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.00001389075456237415</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.00002083613184356122</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.00001389075456237415</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000347268864059354</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> BCoef[NCoef+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { <span class="hljs-number"><span class="hljs-number">1.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-7.09708794063733790000</span></span>, <span class="hljs-number"><span class="hljs-number">22.77454294680684300000</span></span>, <span class="hljs-number"><span class="hljs-number">-43.03321836036351300000</span></span>, <span class="hljs-number"><span class="hljs-number">52.29813665034108500000</span></span>, <span class="hljs-number"><span class="hljs-number">-41.84199842886619100000</span></span>, <span class="hljs-number"><span class="hljs-number">21.53121088556695300000</span></span>, <span class="hljs-number"><span class="hljs-number">-6.52398963450972500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.89383378261285684000</span></span> };</code> </pre> <br>  Le microcontrôleur aurait pu le faire, mais il y aurait eu des problèmes de débogage - il n'est pas facile de déplacer les limites du filtre - ce sont de nouveaux coefficients à calculer. </div></div><br>  Après quelques recherches, je me suis installé sur la transformée de Fourier monofréquence en ligne.  C'est-à-dire que la transformée de Fourier discrète classique, effectuée à l'arrivée de chaque échantillon du signal avec une fréquence d'échantillonnage (1600 Hz), il n'y a pas de passage à travers les fréquences, il n'y a qu'une seule fréquence, il est donc facile de la configurer via RS-232 lors de la mise en service.  En conséquence, l'analyse a été effectuée pour une fréquence de 128 Hz. <br><br>  En raison de courts échantillons (blocs) et d'une fenêtre rectangulaire, la résolution en fréquence est faible, ce qui donne une sensibilité sélective dans la plage 114 ... 140 Hz, <u>et c'est le filtre P que je voulais obtenir.</u> <br><br>  Vous devez d'abord comprendre où le signal de commande vocale commence à <s>crier</s> .  Pour ce faire, tout d'abord, un niveau de signal nul est calculé, par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lissage exponentiel</a> avec une constante de lissage 1/64.  Le code est ci-dessous. <br><br><div class="spoiler">  <b class="spoiler_title">Une partie du code temporisateur pour le traitement du signal.</b>  <b class="spoiler_title">Fréquence de la minuterie 1600 Hz</b> <div class="spoiler_text">  Le signal se normalise à la moyenne.  Pour déterminer le niveau d'intensité sonore, les valeurs absolues du signal sont également moyennées avec une constante de 1/16, pour le filtrage passe-haut des demi-ondes de signal individuelles (il s'agit d'un analogue de RMS, mais plus facile à calculer).  Le dépassement de ce niveau au-dessus du seuil est le début d'une commande vocale et une analyse séquentielle de 5 blocs de 135 échantillons (84,3 ms) commence. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Timer 0 output compare interrupt service routine interrupt [TIM0_COMP] void timer0_comp_isr(void) { a = adc_data[0] &lt;&lt; 2 ; //       4   . a0 = (a0*63 + a+ 63) &gt;&gt; 6; // .   "0".   10%  150  ae = (int)(a - a0); // a = ae; //      . ae = abs(ae); if (ae &lt; 32) { //      ae = 0; }; d = (int)((15 * (long int) d + ae + 15) &gt;&gt; 4); //  .  //   10%  35  if (d &gt; 100) { //    if (snd == 0) { Yz=0; snd++; } //    PORTB.1 = 1; //      }; .....</span></span></code> </pre></div></div><br>  La figure ci-dessous montre le signal, le niveau du signal, le seuil et 5 blocs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/bc9/b82/572/bc9b82572bd90ddb993e5933489e5f5b.png" alt="image"></div><br><h3>  Protection contre les interférences </h3><br>  Le signal est divisé en blocs pour protéger contre une impulsion - un clic ou un coup.  L'impulsion, comme vous le savez, a une réponse en fréquence uniforme, c'est-à-dire que dans n'importe quelle bande de fréquence, il y aura un résultat non nul et probablement au-dessus du seuil.  Mais les <s>cheveux sont longs, mais l'</s> impulsion de <s>l'esprit</s> est courte.  Autrement dit, il n'y aura plus d'impulsion dans le bloc suivant, ce qui signifie que le niveau dans la bande de fréquences sera inférieur au seuil.  Simultanément avec cet avantage, les blocs courts donnent une <u>faible résolution</u> en fréquence.  Par conséquent, certaines différences de fréquence dans le signal tombent toujours dans la ligne de fréquence sélectionnée. <br><br><h3>  Conversion de fréquence </h3><br>  Dans chaque bloc, une transformée de Fourier à fréquence unique est effectuée pour une fréquence f. <br><br>  Traditionnellement, pour accélérer les calculs, les fonctions sin et cos sont tabulées et mises à l'échelle à -127 .. + 127. <br>  L'indice <code>si(ps)</code> tableau <code>si(ps)</code> est calculé à partir de l'argument sin (2 * π * f * t / T), bien sûr avec un bouclage à l'intérieur de la même période.  L'index <code>pc</code> pour cos (2 * π * f * t / T) est simplement poussé de 12 positions vers l'avant dans le même tableau <code>si</code> . <br><br>  Résultat <b>Y</b> - le niveau de la raie spectrale est obtenu comme la somme des valeurs absolues des parties réelles et imaginaires pendant un bloc. <div class="spoiler">  <b class="spoiler_title">Alors</b> <div class="spoiler_text">  dans le bon sens, vous devez faire la somme des carrés et de la racine, mais c'est terrible pour un MK 8 bits. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Dans le même minuteur:</b> <div class="spoiler_text"><pre> <code class="cs hljs"> a_si = (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (a * si[ps]) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-comment"><span class="hljs-comment">// a*sin a_co = (long int) (a * si[pc]) &gt;&gt; 4; // a*cos Ysi = Ysi + a_si ; // Yco = Yco + a_co; Y = (labs(Ysi) + labs(Yco)) &gt;&gt; 7; //   128    int    rs-232.</span></span></code> </pre></div></div><br>  À la fin de chaque bloc, <b>Y est</b> comparé à un seuil, le nombre de blocs est calculé qui dépasse les blocs déclenchés par seuil.  Après les expériences, il s'est avéré que le nombre minimum de blocs déclenchés est de 3 sur 5. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/499/6b1/cbe/4996b1cbe7750d3b010e9b430f391e67.png" alt="image"></div>  <i>Un exemple d'intensité spectrale en blocs avec une commande vocale.</i>  <i>L'équipe est passée.</i> <br><br>  Trois blocs déclenchés ou plus sont interprétés comme une commande correctement reçue.  Le signal à la sortie discrète du MK est inversé, allumant ou éteignant la lumière.  Puisque toute l'analyse a lieu à l'intérieur des blocs, il n'y a pas de retard de fonctionnement après le dernier bloc. <br><br>  Le temps de calcul est d'environ 1600 cycles, la minuterie est appelée tous les 9000 cycles, donc la charge du MK est faible - il y a de la place pour d'autres expériences de reconnaissance.  Ou vous pouvez faire une solution complète de tailles plus petites et sur un MK faible. <br><br>  L'exactitude des algorithmes a été contrôlée par l'échange des variables nécessaires (log) via RS-232 avec le programme sur VBasic.  La fréquence f et les seuils sont stockés dans eeprom. <br><br>  En conséquence: le capteur s'est avéré très pratique, il répond aux mots de " <i>A</i> ", par exemple, <b>" <i>Waaau</i> ", " <i>Taaam</i> ", " <i>Laite</i> ", " <i>Miaaa</i> ", " <i>Yao-Yao</i> "</b> .  Le volume est courant pour la conversation humaine.  Le mot « <i>Lit</i> » refuse obstinément d'écouter.  Clics, frappant aux portes, marches, verser de l'eau ignore.  Vous pouvez maintenant marcher avec des tasses et des assiettes pleines mains)). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr408745/">https://habr.com/ru/post/fr408745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr408735/index.html">Le robot humanoïde à 800 $ n'était pas de la taille d'un être humain. Désolé ...</a></li>
<li><a href="../fr408737/index.html">Balances intelligentes QardioBase 2: de mieux en mieux</a></li>
<li><a href="../fr408739/index.html">La photosynthèse supraconductrice ou comment vider le cheval sphérique sous vide</a></li>
<li><a href="../fr408741/index.html">Pionnier du processeur Qualcomm Centriq 2400. Un tueur Intel?</a></li>
<li><a href="../fr408743/index.html">Le plus petit ordinateur portable de jeu GPD WIN - De quoi est-il capable et qui en a besoin?</a></li>
<li><a href="../fr408747/index.html">L'apparition du nouveau rover, le premier vol de Falcon Heavy, doute de la fiabilité de Dragon et Starliner</a></li>
<li><a href="../fr408749/index.html">Joyeux anniversaire, souris d'ordinateur</a></li>
<li><a href="../fr408751/index.html">Amazon présente la plate-forme de développement 3D, VR et AR</a></li>
<li><a href="../fr408753/index.html">Message à l'intelligence artificielle peu amicale</a></li>
<li><a href="../fr408755/index.html">Comment planifier la journée de travail parfaite en fonction de la façon dont vous dormez</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>