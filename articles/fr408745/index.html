<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ñ üí° ‚ù§Ô∏è Mains libres, mais pas un t√©l√©phone. Maison ob√©issante quand il n'y a pas assez de mains üòè üßëüèø üñ®Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, communaut√©! 

 J'avais envie de jouer √† nouveau avec le microcontr√¥leur et de faire quelque chose d'utile. Le but a √©t√© form√© presque imm√©dia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mains libres, mais pas un t√©l√©phone. Maison ob√©issante quand il n'y a pas assez de mains</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/408745/">  Bonjour, communaut√©! <br><br>  J'avais envie de jouer √† nouveau avec le microcontr√¥leur et de faire quelque chose d'utile.  Le but a √©t√© form√© presque imm√©diatement, car quelque chose m'a d√©rang√© dans l'appartement. <br><br>  Comme vous le savez, une table d'ordinateur est une table √† manger pour regarder Drobyshevsky ou lire Giktayms / Green Cat / etc.  en m√™me temps que le d√Æner.  Mais il y a un probl√®me - je sors g√©n√©ralement de la cuisine avec les <b>deux</b> mains occup√©es, et aussi le dos, <s>car les tasses sont empil√©es en 3 morceaux.</s>  Allumez et √©teignez la lumi√®re dans la cuisine (triple interrupteur - cuisine / salle de bain / WC) est l'√©paule, le nez, l'auriculaire.  Autrement dit, il est g√™nant en aucune fa√ßon, mais il est impossible de le r√©organiser.  Il y avait une t√¢che √† g√©rer d'une mani√®re ou d'une autre √† distance. <br><br>  Tous les capteurs de pr√©sence et de passage ont √©t√© imm√©diatement √©cart√©s - pas cette pr√©cision, il n'y a aucun contr√¥le par la volont√© du propri√©taire.  La solution se trouve dans le contr√¥le du son, la voix.  Je dirai tout de suite que je n'avais pas pr√©vu de faire de reconnaissance vocale, ce n'est pas n√©cessaire ici.  La lumi√®re allum√©e par la pop a √©t√© d√©crite dans Radio 80, mais je ne voulais pas faire √ßa.  Il s'est av√©r√© une sorte de mains libres lorsque les mains sont occup√©es.  Les d√©tails sont connus. <br><a name="habracut"></a><br><h3>  Partie mat√©riel. </h3><br>  Il y avait une carte avec Atmega32 avec du quartz et des p√©riph√©riques <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SEM0007M-32A</a> et une dispersion d'√©lectronique. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/65f/1a8/7e9/65f1a87e9d6aad209f747a4419cab7ad.jpg" width="40%" alt="image"></div><br>  Il y avait un microphone et un amplificateur op√©rationnel.  Pour la sortie, il y a un transistor dans un bo√Ætier sot32 sur la carte, il y a aussi un relais de 7 amp√®res.  Tout est assembl√© pouss√© dans un coffret pour cartes de visite, le relais est mis en parall√®le avec l'interrupteur, le microphone est cach√© sous la prise.  Le sch√©ma est banal, je ne l'ai m√™me pas dessin√©.  Une seule entr√©e analogique et une sortie MK discr√®te sont utilis√©es.  SEM est redondant, mais pour l'instant, laissez-le. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/3c0/69f/b83/3c069fb831046a304627595be0730b70.jpg" width="350" alt="image"></div>  <i>Carte et fils non assembl√©s.</i>  <i>Puis il l'a refait plus pr√©cis√©ment.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/7ed/8ee/f59/7ed8eef59421665c5cef7009768a8a46.jpg" width="300" alt="image"></div>  <i>L'interrupteur lui-m√™me, le microphone n'est pas visible sous la prise d√©mont√©e.</i> <br><br><h3>  Recherchez un algorithme. </h3><br>  Objectif: le capteur doit r√©pondre √† un mot, par exemple, ¬´ <i>lumi√®re!</i>  ¬ªAvec un minimum de code. <br>  T√¢che: identifier le mot de commande sur fond de bruit, de coups et de clics possibles avec le m√™me commutateur.  C'est-√†-dire que seule l'analyse d'amplitude ne convient pas, et l'analyse spectrale a montr√© qu'il y a trop d'harmoniques dans le mot et bien s√ªr elles changent.  Il √©tait donc n√©cessaire de rechercher une solution simple, mais avec une immunit√© au bruit acceptable.  Vous pouvez faire plusieurs filtres temps-fr√©quence et une comparaison avec un √©chantillon du mot, mais vous n'avez pas besoin de vous occuper de la reconnaissance.  Il a √©t√© d√©cid√© d'analyser la pr√©sence d'un seul son de voyelle, par exemple le son ¬´E¬ª ou ¬´E¬ª. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/a55/5e2/6cf/a555e26cf616bfab31872bce1794d612.png" alt="image"></div>  <i>Le son est "E".</i>  <i>De nombreuses harmoniques sont visibles, de ce fait, l'analyse est difficile.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/18e/d5c/ab8/18ed5cab8307bf96a2fb8d2ae77e64dd.png" alt="image"></div>  <i>Le son est "A."</i>  <i>Le spectre a l'air plus propre, il y a une fr√©quence principale.</i> <br><br><h3>  Partie logiciel </h3><br>  Afin de conna√Ætre les composantes spectrales du signal, vous pouvez utiliser des filtres num√©riques.  Il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bon programme sur</a> Internet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pour cr√©er des filtres num√©riques FIR et IIR</a> et calculer leurs coefficients - c'est clair et le code C est automatiquement g√©n√©r√©. <br><br><div class="spoiler">  <b class="spoiler_title">Mais j'ai refus√© les filtres num√©riques</b> <div class="spoiler_text">  Pour un filtrage acceptable (4 ordres ou plus), de nombreux coefficients ont √©t√© obtenus, et m√™me un flottant.  Comme √ßa, plus tous les calculs de filtre dans le flotteur: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ACoef[NCoef+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { <span class="hljs-number"><span class="hljs-number">0.00000347268864059354</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.00001389075456237415</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.00002083613184356122</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.00001389075456237415</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000347268864059354</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> BCoef[NCoef+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { <span class="hljs-number"><span class="hljs-number">1.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-7.09708794063733790000</span></span>, <span class="hljs-number"><span class="hljs-number">22.77454294680684300000</span></span>, <span class="hljs-number"><span class="hljs-number">-43.03321836036351300000</span></span>, <span class="hljs-number"><span class="hljs-number">52.29813665034108500000</span></span>, <span class="hljs-number"><span class="hljs-number">-41.84199842886619100000</span></span>, <span class="hljs-number"><span class="hljs-number">21.53121088556695300000</span></span>, <span class="hljs-number"><span class="hljs-number">-6.52398963450972500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.89383378261285684000</span></span> };</code> </pre> <br>  Le microcontr√¥leur aurait pu le faire, mais il y aurait eu des probl√®mes de d√©bogage - il n'est pas facile de d√©placer les limites du filtre - ce sont de nouveaux coefficients √† calculer. </div></div><br>  Apr√®s quelques recherches, je me suis install√© sur la transform√©e de Fourier monofr√©quence en ligne.  C'est-√†-dire que la transform√©e de Fourier discr√®te classique, effectu√©e √† l'arriv√©e de chaque √©chantillon du signal avec une fr√©quence d'√©chantillonnage (1600 Hz), il n'y a pas de passage √† travers les fr√©quences, il n'y a qu'une seule fr√©quence, il est donc facile de la configurer via RS-232 lors de la mise en service.  En cons√©quence, l'analyse a √©t√© effectu√©e pour une fr√©quence de 128 Hz. <br><br>  En raison de courts √©chantillons (blocs) et d'une fen√™tre rectangulaire, la r√©solution en fr√©quence est faible, ce qui donne une sensibilit√© s√©lective dans la plage 114 ... 140 Hz, <u>et c'est le filtre P que je voulais obtenir.</u> <br><br>  Vous devez d'abord comprendre o√π le signal de commande vocale commence √† <s>crier</s> .  Pour ce faire, tout d'abord, un niveau de signal nul est calcul√©, par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lissage exponentiel</a> avec une constante de lissage 1/64.  Le code est ci-dessous. <br><br><div class="spoiler">  <b class="spoiler_title">Une partie du code temporisateur pour le traitement du signal.</b>  <b class="spoiler_title">Fr√©quence de la minuterie 1600 Hz</b> <div class="spoiler_text">  Le signal se normalise √† la moyenne.  Pour d√©terminer le niveau d'intensit√© sonore, les valeurs absolues du signal sont √©galement moyenn√©es avec une constante de 1/16, pour le filtrage passe-haut des demi-ondes de signal individuelles (il s'agit d'un analogue de RMS, mais plus facile √† calculer).  Le d√©passement de ce niveau au-dessus du seuil est le d√©but d'une commande vocale et une analyse s√©quentielle de 5 blocs de 135 √©chantillons (84,3 ms) commence. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Timer 0 output compare interrupt service routine interrupt [TIM0_COMP] void timer0_comp_isr(void) { a = adc_data[0] &lt;&lt; 2 ; //       4   . a0 = (a0*63 + a+ 63) &gt;&gt; 6; // .   "0".   10%  150  ae = (int)(a - a0); // a = ae; //      . ae = abs(ae); if (ae &lt; 32) { //      ae = 0; }; d = (int)((15 * (long int) d + ae + 15) &gt;&gt; 4); //  .  //   10%  35  if (d &gt; 100) { //    if (snd == 0) { Yz=0; snd++; } //    PORTB.1 = 1; //      }; .....</span></span></code> </pre></div></div><br>  La figure ci-dessous montre le signal, le niveau du signal, le seuil et 5 blocs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/bc9/b82/572/bc9b82572bd90ddb993e5933489e5f5b.png" alt="image"></div><br><h3>  Protection contre les interf√©rences </h3><br>  Le signal est divis√© en blocs pour prot√©ger contre une impulsion - un clic ou un coup.  L'impulsion, comme vous le savez, a une r√©ponse en fr√©quence uniforme, c'est-√†-dire que dans n'importe quelle bande de fr√©quence, il y aura un r√©sultat non nul et probablement au-dessus du seuil.  Mais les <s>cheveux sont longs, mais l'</s> impulsion de <s>l'esprit</s> est courte.  Autrement dit, il n'y aura plus d'impulsion dans le bloc suivant, ce qui signifie que le niveau dans la bande de fr√©quences sera inf√©rieur au seuil.  Simultan√©ment avec cet avantage, les blocs courts donnent une <u>faible r√©solution</u> en fr√©quence.  Par cons√©quent, certaines diff√©rences de fr√©quence dans le signal tombent toujours dans la ligne de fr√©quence s√©lectionn√©e. <br><br><h3>  Conversion de fr√©quence </h3><br>  Dans chaque bloc, une transform√©e de Fourier √† fr√©quence unique est effectu√©e pour une fr√©quence f. <br><br>  Traditionnellement, pour acc√©l√©rer les calculs, les fonctions sin et cos sont tabul√©es et mises √† l'√©chelle √† -127 .. + 127. <br>  L'indice <code>si(ps)</code> tableau <code>si(ps)</code> est calcul√© √† partir de l'argument sin (2 * œÄ * f * t / T), bien s√ªr avec un bouclage √† l'int√©rieur de la m√™me p√©riode.  L'index <code>pc</code> pour cos (2 * œÄ * f * t / T) est simplement pouss√© de 12 positions vers l'avant dans le m√™me tableau <code>si</code> . <br><br>  R√©sultat <b>Y</b> - le niveau de la raie spectrale est obtenu comme la somme des valeurs absolues des parties r√©elles et imaginaires pendant un bloc. <div class="spoiler">  <b class="spoiler_title">Alors</b> <div class="spoiler_text">  dans le bon sens, vous devez faire la somme des carr√©s et de la racine, mais c'est terrible pour un MK 8 bits. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Dans le m√™me minuteur:</b> <div class="spoiler_text"><pre> <code class="cs hljs"> a_si = (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (a * si[ps]) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-comment"><span class="hljs-comment">// a*sin a_co = (long int) (a * si[pc]) &gt;&gt; 4; // a*cos Ysi = Ysi + a_si ; // Yco = Yco + a_co; Y = (labs(Ysi) + labs(Yco)) &gt;&gt; 7; //   128    int    rs-232.</span></span></code> </pre></div></div><br>  √Ä la fin de chaque bloc, <b>Y est</b> compar√© √† un seuil, le nombre de blocs est calcul√© qui d√©passe les blocs d√©clench√©s par seuil.  Apr√®s les exp√©riences, il s'est av√©r√© que le nombre minimum de blocs d√©clench√©s est de 3 sur 5. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/499/6b1/cbe/4996b1cbe7750d3b010e9b430f391e67.png" alt="image"></div>  <i>Un exemple d'intensit√© spectrale en blocs avec une commande vocale.</i>  <i>L'√©quipe est pass√©e.</i> <br><br>  Trois blocs d√©clench√©s ou plus sont interpr√©t√©s comme une commande correctement re√ßue.  Le signal √† la sortie discr√®te du MK est invers√©, allumant ou √©teignant la lumi√®re.  Puisque toute l'analyse a lieu √† l'int√©rieur des blocs, il n'y a pas de retard de fonctionnement apr√®s le dernier bloc. <br><br>  Le temps de calcul est d'environ 1600 cycles, la minuterie est appel√©e tous les 9000 cycles, donc la charge du MK est faible - il y a de la place pour d'autres exp√©riences de reconnaissance.  Ou vous pouvez faire une solution compl√®te de tailles plus petites et sur un MK faible. <br><br>  L'exactitude des algorithmes a √©t√© contr√¥l√©e par l'√©change des variables n√©cessaires (log) via RS-232 avec le programme sur VBasic.  La fr√©quence f et les seuils sont stock√©s dans eeprom. <br><br>  En cons√©quence: le capteur s'est av√©r√© tr√®s pratique, il r√©pond aux mots de " <i>A</i> ", par exemple, <b>" <i>Waaau</i> ", " <i>Taaam</i> ", " <i>Laite</i> ", " <i>Miaaa</i> ", " <i>Yao-Yao</i> "</b> .  Le volume est courant pour la conversation humaine.  Le mot ¬´ <i>Lit</i> ¬ª refuse obstin√©ment d'√©couter.  Clics, frappant aux portes, marches, verser de l'eau ignore.  Vous pouvez maintenant marcher avec des tasses et des assiettes pleines mains)). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr408745/">https://habr.com/ru/post/fr408745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr408735/index.html">Le robot humano√Øde √† 800 $ n'√©tait pas de la taille d'un √™tre humain. D√©sol√© ...</a></li>
<li><a href="../fr408737/index.html">Balances intelligentes QardioBase 2: de mieux en mieux</a></li>
<li><a href="../fr408739/index.html">La photosynth√®se supraconductrice ou comment vider le cheval sph√©rique sous vide</a></li>
<li><a href="../fr408741/index.html">Pionnier du processeur Qualcomm Centriq 2400. Un tueur Intel?</a></li>
<li><a href="../fr408743/index.html">Le plus petit ordinateur portable de jeu GPD WIN - De quoi est-il capable et qui en a besoin?</a></li>
<li><a href="../fr408747/index.html">L'apparition du nouveau rover, le premier vol de Falcon Heavy, doute de la fiabilit√© de Dragon et Starliner</a></li>
<li><a href="../fr408749/index.html">Joyeux anniversaire, souris d'ordinateur</a></li>
<li><a href="../fr408751/index.html">Amazon pr√©sente la plate-forme de d√©veloppement 3D, VR et AR</a></li>
<li><a href="../fr408753/index.html">Message √† l'intelligence artificielle peu amicale</a></li>
<li><a href="../fr408755/index.html">Comment planifier la journ√©e de travail parfaite en fonction de la fa√ßon dont vous dormez</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>