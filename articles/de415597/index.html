<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💳 👩🏾‍🤝‍👨🏽 🙆🏼 Postfix - amavisd-new ohne localhost oder Mailserver auf neue Weise 👨🏼‍💻 🐋 👨🏾‍🤝‍👨🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es gibt viele Anweisungen, wie Sie den Mailserver auf einer Reihe von Postfix - amavisd-new - dovecot erhöhen können. Und die überwiegende Mehrheit vo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Postfix - amavisd-new ohne localhost oder Mailserver auf neue Weise</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415597/">  Es gibt viele Anweisungen, wie Sie den Mailserver auf einer Reihe von Postfix - amavisd-new - dovecot erhöhen können.  Und die überwiegende Mehrheit von ihnen wiederholt sich fast wörtlich, einschließlich Fehlern und Ungenauigkeiten. <br><br>  Es scheint mir langweilig, gedankenlos Tasten zu drücken, deshalb habe ich beschlossen, die Standardkonfiguration zu optimieren: Was ist, wenn ich die Interaktion von Postfix und amavisd-new nicht über localhost, sondern auf einem Unix-Socket aufbaue? <br><br>  Wie sich herausstellte, ist nicht alles so einfach, aber ich habe es geschafft!  Anleitung und Patch unter dem Schnitt. <br><a name="habracut"></a><br>  Ehrlich gesagt mag ich im Allgemeinen keine Interaktion durch localhost innerhalb derselben Maschine.  Wenn Sie den Datenaustausch zwischen zwei Anwendungen organisieren möchten, ist dies viel korrekter, sicherer und weniger ressourcenintensiv, wenn Sie dies über einen Unix-Socket im Dateisystem tun.  Darüber hinaus können Sie auf diese Weise den Schutz (mithilfe von Rechten im Dateisystem) auch dann organisieren, wenn er auf Anwendungs- oder Protokollebene nicht vorhanden ist. <br><br>  Der E-Mail-Pfad in der besprochenen Gruppe sieht also folgendermaßen aus: <br><br><img src="https://habrastorage.org/webt/2a/yj/lx/2ayjlxnatjoqpaofqg3trbsi9sc.png"><br><br>  Es stellt sich heraus, dass wir zwei Verbindungen organisieren müssen: beim Übertragen zur Filterung und bei der Rückkehr zum MTA.  Da der Socket vom Listener erstellt wird, ist er im ersten Fall amavisd und im zweiten - postfix. <br><br>  Beginnen wir mit dem zweiten, weil er einfacher und besser beschrieben ist.  Damit postfix einen Listening-Socket erstellen kann, müssen Sie in der zweiten Spalte von master.cf (Typenspalte) nur Unix und nicht Inet angeben.  In diesem Fall definiert die erste Spalte den Pfad und den Dateinamen des Sockets. <br><br>  Da Postfix-Prozesse in Chroot funktionieren (dies kann für einen bestimmten Prozess deaktiviert werden, ist es aber nicht wert), müssen Sie einen Ordner im Postfix-Ausgangsverzeichnis erstellen: / var / spool / postfix.  Es wird beide Steckdosen haben: <br><br><pre><code class="bash hljs">mkdir /var/spool/postfix/amavis chown amavis:postfix /var/spool/postfix/amavis chmod 770 /var/spool/postfix/amavis</code> </pre> <br>  Gut und Postfix Konfiguration: <br><br><pre> <code class="hljs powershell">amavis/postfix<span class="hljs-operator"><span class="hljs-operator">-in</span></span> unix y - y - - smtpd <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_client_restrictions=<span class="hljs-variable"><span class="hljs-variable">$local_clients_only</span></span> <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_helo_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_sender_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_recipient_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_milters=</code> </pre><br>  Die spezifischen Optionen hängen von Ihrer Einstellung ab. Dies ist meine Option. <br><br>  Es gibt zwei Probleme: <br><br><ol><li>  Der Pfad ist relativ zu / var / spool / postfix / private, für das sehr strenge Berechtigungen gelten. </li><li>  Ich bin mir nicht sicher, ob dies für alle Distributionen zutrifft, aber für Ubuntu.  Es ist besser, die Rechte an dem Ordner nicht zu berühren (die Sockets aller Postfix-Dienste sind vorhanden), sondern nur einen Symlink zu erstellen. </li><li>  Zusätzlich zum Socket erstellt postfix auch eine PID-Datei für den Prozess, deren Name automatisch von der Maske vom Typ $ generiert wird. $ Name.  Wobei Typ gleich Unix ist und der Name aus der ersten Spalte von master.cf stammt.  Es stellt sich heraus, dass unux.amavis / postfix-in, d.h.  Datei in einem Unterordner.  Er selbst wird es nicht schaffen und mit einem Fehler fallen. </li></ol><br>  Also ersetzen wir Krücken: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /var/spool/postfix/private ln -s ../amavis . mkdir /var/spool/postfix/pid/unix.amavis</code> </pre><br>  Nicht sehr schön, aber nicht destruktiv für die reguläre Ordnerstruktur des Pakets. <br><br>  Wir starten postfix neu und stellen sicher, dass die Socket-Datei im Ordner amavis und die PID-Datei in pid / unix.amavis angezeigt wird.  Leider sind die Rechte für den Socket 666, aber die Rechte für den Ordner, den Sie zuvor erstellt haben, schützen die Datei vor unnötigen Augen. <br><br>  Sie können die Arbeit mit dem Befehl überprüfen: <br><br><pre> <code class="bash hljs">netcat -U /var/spool/postfix/amavis/postfix-in 220 mail.example.ru ESMTP Postfix</code> </pre><br>  Nun, sie haben es geschafft.  Nun zu amavisd. <br><br>  Konfigurieren Sie zunächst den E-Mail-Rückgabepfad über den Unix-Socket von Postfix.  Dies funktioniert sofort: <br><br><pre> <code class="perl hljs">$forward_method = <span class="hljs-string"><span class="hljs-string">'smtp:/var/spool/postfix/amavis/postfix-in'</span></span>; $notify_method = \$forward_method;</code> </pre><br>  Nun, jetzt ist es am schwierigsten, Steckdosen in amavisd einzurichten.  Die Lösung kann im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Internet gefunden werden</a> , dort wird jedoch vorgeschlagen, einen einzelnen Socket zu verwenden, der durch den Parameter $ unix_socketname angegeben wird.  Ich wollte auch mein eigenes amavisd-neues Protokoll (AM.PDP) und E-Mail-Empfang über Sockets. <br><br>  Die Standardkonfigurationsdatei enthält einen Verweis auf die Direktive @listen_sockets, es gibt jedoch keine Beschreibung dafür.  Aber es ist in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Versionshinweisen</a> , auch mit Beispielen!  Es gibt zwar nur eine Steckdose, aber was hindert Sie daran, es zu versuchen? <br><br>  OK, aber wie wird das Protokoll für den Socket festgelegt (das in der Richtlinienbank angegeben ist)?  In allen Beispielen schreiben sie einfach SOCK.  In Analogie zu Inet-Sockets (Sie können dort den Host-Port angeben) schlug ich vor, den vollständigen Pfad zur Socket-Datei anzugeben.  Folgendes ist passiert: <br><br><pre> <code class="perl hljs">$unix_socketname = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; $inet_socket_bind = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; $inet_socket_port = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; @listen_sockets = (<span class="hljs-string"><span class="hljs-string">'/var/lib/amavis/amavisd.sock'</span></span>, <span class="hljs-string"><span class="hljs-string">'/var/spool/postfix/amavis/amavis-in.sock'</span></span>); $unix_socket_mode = <span class="hljs-number"><span class="hljs-number">0660</span></span>; %interface_policy = ( <span class="hljs-string"><span class="hljs-string">'/var/lib/amavis/amavisd.sock'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'AM.PDP-SOCK'</span></span>, <span class="hljs-string"><span class="hljs-string">'/var/spool/postfix/amavis/amavis-in.sock'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'LMTP-SOCK'</span></span> ); $policy_bank{<span class="hljs-string"><span class="hljs-string">'LMTP-SOCK'</span></span>} = { <span class="hljs-string"><span class="hljs-string">protocol =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'LMTP'</span></span> }; $policy_bank{<span class="hljs-string"><span class="hljs-string">'AM.PDP-SOCK'</span></span>} = { <span class="hljs-string"><span class="hljs-string">protocol =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'AM.PDP'</span></span>, <span class="hljs-string"><span class="hljs-string">auth_required_release =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment"># don't require secret-id for release };</span></span></code> </pre><br>  Neustart, Überprüfung - tatsächlich wurden beide Sockets erstellt!  Sieg  Nicht wirklich, wenn Sie versuchen, eine Verbindung zum Socket herzustellen, passiert nichts und es wird ein Fehler in das Protokoll geschrieben, dass das Protokoll nicht dafür definiert ist.  Es stellt sich heraus, dass die Policenbank für sie nicht gilt. <br><br>  Wie so?  Ich musste zum Code gehen. <br><br>  Diese Kampagne brachte zwei Neuigkeiten - wie immer, gut und schlecht.  Das Gute ist, dass die Annahme bezüglich% interface_policy richtig war: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment"># load policy banks according to my socket (destination), # then check for allowed access from the peer (client/source) # sub access_is_allowed($;$$$$) { my($unix_socket_path, $src_addr, $src_port, $dst_addr, $dst_port) = @_; my(@bank_names); if (defined $unix_socket_path) { push(@bank_names, $interface_policy{"SOCK"}); push(@bank_names, $interface_policy{$unix_socket_path}); } elsif (defined $dst_addr &amp;&amp; defined $dst_port) { $dst_addr = '['.lc($dst_addr).']' if $dst_addr =~ /:[0-9a-f]*:/i; # IPv6? push(@bank_names, $interface_policy{$dst_port}); push(@bank_names, $interface_policy{"$dst_addr:$dst_port"}); } load_policy_bank($_) for @bank_names;</span></span></code> </pre><br>  Das Schlimme ist, dass $ unix_socket_path leer in diese Funktion kommt.  Es wird wie folgt gefüllt: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $is_ux = $sock &amp;&amp; $sock-&gt;UNIVERSAL::can(<span class="hljs-string"><span class="hljs-string">'NS_proto'</span></span>) &amp;&amp; $sock-&gt;NS_proto eq <span class="hljs-string"><span class="hljs-string">'UNIX'</span></span>;</code> </pre><br>  Und beide Eigenschaften sind dort leer. <br><br>  Eine Untersuchung der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> schlug diese Option vor: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $unix_socket_path = $sock-&gt;hostpath();</code> </pre><br>  Und es hat funktioniert!  Ready .patch kann hier gesagt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">werden</a> . <br><br>  Da ist der letzte Schliff.  Da amavisd einen eigenen Socket mit Rechten nur für sich selbst erstellt und wir den Zugriff auf den Rest verweigert haben (was wahr ist), müssen wir der amavis-Gruppe Postfix hinzufügen, damit sie in den Socket schreiben kann: <br><br><pre> <code class="bash hljs">gpasswd -a postfix amavis</code> </pre><br>  Fertig. <br><br>  PS: Ich habe den Patch und die Beschreibung des Problems von Mark Martinec per E-Mail gesendet, da ich auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Website</a> keine Erwähnung des Bug-Trackers gefunden habe.  Ich habe noch keine Antwort erhalten, aber ich zähle nicht wirklich darauf - das Projekt sieht aufgegeben aus (die letzte Veröffentlichung vor mehr als zwei Jahren). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de415597/">https://habr.com/ru/post/de415597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de415587/index.html">StereoPi - unsere Hardware zum Studium von Computer Vision, Drohnen und Robotern</a></li>
<li><a href="../de415589/index.html">"Ein bisschen mehr über PD": US-amerikanische TV-Unternehmen werden den Verkauf von Kunden-Geodaten einstellen</a></li>
<li><a href="../de415591/index.html">Apple Engineers Trap MacBook Pro Tastaturfalle</a></li>
<li><a href="../de415593/index.html">6 Jahre später eine neue Version der legendären Crash-Distribution Hiren's BootCD</a></li>
<li><a href="../de415595/index.html">Methoden zur Erhöhung der Spielerbindung am Beispiel von SLOT-Spielen: Teil 1</a></li>
<li><a href="../de415599/index.html">Indien will auch Helium-3 bekommen</a></li>
<li><a href="../de415601/index.html">Kubernetes HA-Cluster mit Containerd. Oder gibt es ein Leben ohne Hafenarbeiter?</a></li>
<li><a href="../de415605/index.html">Wie wir die Kartenverarbeitung mit Exadata gespeichert haben</a></li>
<li><a href="../de415611/index.html">PKI: GCrypt- und KSBA-Bibliotheken als Alternative zu OpenSSL mit Unterstützung für die russische Kryptographie. Fortsetzung</a></li>
<li><a href="../de415613/index.html">Warum sollten Sie keine LED-Kronleuchter kaufen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>