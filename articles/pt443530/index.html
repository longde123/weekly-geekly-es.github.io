<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç∞ üï§ üêí Evolu√ß√£o da infraestrutura de banco de dados: do banco de dados e aplicativos em um servidor √† replica√ß√£o de streaming üòñ üíü üåó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! 

 Meu nome √© Anton Markelov, sou engenheiro de opera√ß√µes da United Traders. Estamos envolvidos em projetos de uma maneira ou de outra, rela...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Evolu√ß√£o da infraestrutura de banco de dados: do banco de dados e aplicativos em um servidor √† replica√ß√£o de streaming</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/utex/blog/443530/"><img src="https://habrastorage.org/webt/9o/uy/bk/9ouybky85gzjccvemkc882t32ws.png"><br><br>  Ol√° Habr! <br><br>  Meu nome √© Anton Markelov, sou engenheiro de opera√ß√µes da United Traders.  Estamos envolvidos em projetos de uma maneira ou de outra, relacionados a investimentos, trocas e outros assuntos financeiros.  N√£o somos uma empresa muito grande, cerca de 30 engenheiros de desenvolvimento, as escalas s√£o adequadas - um pouco menos de uma centena de servidores.  Durante o crescimento quantitativo e qualitativo de nossa infraestrutura, a solu√ß√£o cl√°ssica ‚Äúmantemos o aplicativo e seu banco de dados no mesmo servidor‚Äù deixou de nos servir tanto em termos de confiabilidade quanto de velocidade.  Por parte dos analistas, havia a necessidade de criar consultas entre bancos de dados, o departamento de opera√ß√µes estava cansado de mexer com backup e monitorar um grande n√∫mero de servidores de banco de dados.  Al√©m disso, o armazenamento do estado na mesma m√°quina que o pr√≥prio aplicativo reduziu bastante a flexibilidade do planejamento de recursos e a resili√™ncia da infraestrutura. <br><br>  O processo de transi√ß√£o para a arquitetura atual foi evolutivo, v√°rias solu√ß√µes foram testadas para fornecer uma interface conveniente para desenvolvedores e analistas e aumentar a confiabilidade e a capacidade de gerenciamento de toda essa economia.  Eu quero falar sobre os principais est√°gios da moderniza√ß√£o de nossos DBMSs, a qual rake chegamos e quais decis√µes tomamos, como resultado de um ambiente independente tolerante a falhas que fornece meios convenientes de intera√ß√£o para engenheiros, desenvolvedores e analistas de opera√ß√£o.  Espero que nossa experi√™ncia seja √∫til para engenheiros de empresas da nossa escala. <br><br>  Este artigo √© um resumo do meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio</a> na confer√™ncia UPTIMEDAY, talvez o formato de v√≠deo seja mais confort√°vel para algu√©m, embora o escritor seja um pouco melhor com minhas m√£os do que um orador. <br><br>  O "Homem dos Flocos de Neve" com KDPV foi descaradamente <i>emprestado</i> de Maxim Dorofeev. <br><a name="habracut"></a><br><h2>  Doen√ßas do crescimento </h2><br>  Temos uma arquitetura de microsservi√ßo, os servi√ßos s√£o escritos principalmente em Java ou Kotlin usando a estrutura Spring.  Ao lado de cada microsservi√ßo h√° uma base do PostgreSQL, tudo √© coberto pelo nginx na parte superior para fornecer acesso.  Um microsservi√ßo t√≠pico √© um aplicativo no Spring Boot que grava seus dados no PostgreSQL (parte dos aplicativos ao mesmo tempo e no ClickHouse), se comunica com os vizinhos pelo Kafka e possui alguns pontos de extremidade REST ou GraphQL para comunica√ß√£o com o mundo externo. <br><br><img src="https://habrastorage.org/webt/43/s1/aq/43s1aq-9ggmakbk3dygl8ox9bna.png"><br><br>  Anteriormente, quando √©ramos muito pequenos, mantiv√≠amos v√°rios servidores no DigitalOcean, Kafka ainda n√£o estava l√°, toda a comunica√ß√£o era atrav√©s do REST.  Ou seja, pegamos uma gota, instalamos Java, PostgreSQL, nginx l√°, lan√ßamos o Zabbix l√° para que ele monitore os recursos do servidor e a disponibilidade dos pontos de extremidade do servi√ßo.  Eles implantaram tudo com a ajuda da Ansible, t√≠nhamos cartilhas padronizadas, quatro a cinco pap√©is implementados em todo o servi√ßo.  Contanto que tiv√©ssemos, relativamente falando, 6 servidores em produ√ß√£o e 3 em teste - voc√™ poderia, de alguma forma, conviver com ele. <br>  Ent√£o, a fase de desenvolvimento ativo come√ßou, o n√∫mero de aplicativos cresceu, dez microsservi√ßos transformados em quarenta, suas funcionalidades come√ßaram a mudar, al√©m da integra√ß√£o com sistemas externos, como CRM, sites de clientes e similares.  Temos a primeira dor.  Alguns aplicativos come√ßaram a consumir mais recursos, pararam de entrar nos servidores existentes, obtivemos got√≠culas, arrastamos os aplicativos para frente e para tr√°s e pegamos muitas m√£os.  Doeu muito - ningu√©m gosta de est√∫pido trabalho mec√¢nico -, eu queria decidir rapidamente.  Por isso, fomos de frente - pegamos apenas 3 grandes servidores dedicados em vez de 10 got√≠culas na nuvem.  Isso encerrou o problema por um tempo, mas ficou √≥bvio que era hora de definir op√ß√µes para algum tipo de orquestra√ß√£o e reequil√≠brio de servidores.  Come√ßamos a olhar atentamente para solu√ß√µes como DC / OS e Kubernetes e aumentar gradualmente nossa experi√™ncia nessa √°rea. <br><br>  Na mesma √©poca, t√≠nhamos um departamento anal√≠tico, que precisava fazer solicita√ß√µes dif√≠ceis regularmente, preparar relat√≥rios, ter pain√©is bonitos e isso nos trouxe uma segunda dor.  Em primeiro lugar, os analistas carregaram muito a base e, em segundo lugar, precisavam de consultas entre bancos de dados, porque  cada microsservi√ßo mantinha uma fatia de dados bastante estreita.  Testamos v√°rios sistemas; no in√≠cio, tentamos resolver tudo isso atrav√©s da replica√ß√£o em n√≠vel de tabela (ela estava no nono PostgreSQL, n√£o havia replica√ß√£o l√≥gica pronta para uso), mas os trabalhos resultantes baseados em pglogical, Presto, Slony-I e Bucardo n√£o o fizeram completamente. arranjado.  Por exemplo, o pglogical n√£o suportava a migra√ß√£o - uma nova vers√£o do microsservi√ßo foi lan√ßada, a estrutura do banco de dados mudou, o pr√≥prio Java mudou a estrutura usando o Flyway e, nas r√©plicas do pglogical, tudo precisa ser alterado manualmente.  Caso contr√°rio, algo estava faltando ou era muito dif√≠cil. <br><br><h2>  Super escravo </h2><br>  Como resultado da pesquisa, nasceu uma solu√ß√£o simples e brutal chamada Superslave: pegamos um servidor separado, configuramos um escravo para cada servidor de produ√ß√£o em portas diferentes e criamos um banco de dados virtual que combina os bancos de dados dos escravos via postgres_fdw (inv√≥lucro de dados externos).  Ou seja, tudo isso foi implementado por meio do postgres padr√£o, sem a introdu√ß√£o de entidades adicionais, de maneira simples e confi√°vel: com uma √∫nica solicita√ß√£o, foi poss√≠vel obter dados de v√°rios bancos de dados.  Demos essa base virtual aos analistas.  Uma vantagem adicional √© que a r√©plica somente leitura, mesmo com um erro nos direitos de acesso, n√£o conseguiu gravar nada l√°. <br><br><img src="https://habrastorage.org/webt/uf/j7/2i/ufj72i581hu3b_s5cep3cy_dk60.png"><br><br>  Pegamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Redash</a> para visualiza√ß√£o, ele sabe desenhar gr√°ficos, executar solicita√ß√µes de acordo com um cronograma, por exemplo, uma vez por dia, e possui um sistema de direitos pesado, ent√£o deixamos analistas e desenvolvedores irem at√© l√°. <br><br><img src="https://habrastorage.org/webt/wq/jo/gj/wqjogjc5ovjcfxz9b6nqa_g71nm.png"><br><br>  Paralelamente, o crescimento continuou, Kafka apareceu na infraestrutura como um barramento e ClickHouse para armazenamento de an√°lises.  Eles s√£o facilmente agrupados fora da caixa, nosso super escravo contra o fundo deles parecia um f√≥ssil desajeitado.  Al√©m disso, o PostgreSQL, de fato, permaneceu o √∫nico estado que precisava ser arrastado ap√≥s o aplicativo (se ainda tivesse que ser transferido para outro servidor), e realmente quer√≠amos que um aplicativo sem estado se envolvesse em experimentos com Kubernetes e ele. plataformas semelhantes. <br><br>  Come√ßamos a procurar uma solu√ß√£o que atenda aos seguintes requisitos: <br><br><ul><li>  toler√¢ncia a falhas: quando N servidores caem, o cluster continua funcionando; </li><li>  para aplicativos, tudo deve permanecer como antes, sem altera√ß√µes no c√≥digo; </li><li>  facilidade de implanta√ß√£o e gerenciamento; </li><li>  menos camadas de abstra√ß√£o sobre o PostgreSQL regular; </li><li>  idealmente, balanceamento de carga para que nem todas as solicita√ß√µes sejam enviadas para um servidor; </li><li>  Idealmente, est√° escrito em uma linguagem familiar. </li></ul><br>  N√£o havia muitos candidatos: <br><br><ul><li>  replica√ß√£o de streaming padr√£o (repmgr, Patroni, Stolon); </li><li>  replica√ß√£o baseada em gatilho (Londiste, Slony); </li><li>  replica√ß√£o de consulta da camada intermedi√°ria (pgpool-II); </li><li>  replica√ß√£o s√≠ncrona com v√°rios servidores principais (Bucardo). </li></ul><br>  Em grande parte, j√° tivemos experi√™ncias ruins durante a constru√ß√£o da base, ent√£o Patroni e Stolon permaneceram.  Patroni √© escrito em Python, Stolon in Go, temos experi√™ncia suficiente em ambos os idiomas.  Al√©m disso, eles t√™m arquitetura e funcionalidade semelhantes; portanto, a escolha foi feita por raz√µes subjetivas: o Patroni foi desenvolvido por Zalando e tentamos trabalhar com o projeto Nakadi (API REST para Kafka), onde encontramos uma grave falta de documenta√ß√£o. <br><br><h2>  Stolon </h2><br><img src="https://habrastorage.org/webt/z5/af/hf/z5afhfobk43vpt0x2dmryf0gt50.png"><br><br>  A arquitetura do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Stolon √©</a> bastante simples: existem N servidores, com a ajuda do etcd / consul, um l√≠der √© selecionado, o PostgreSQL √© iniciado no modo assistente e √© replicado para outros servidores.  Em seguida, os proxies stolon acessam esse mestre do PostgreSQL, fingindo ser aplicativos com postgres comuns, e os clientes acessam esses proxies.  No caso de desaparecimento de um mestre, ocorrem reelei√ß√µes, algu√©m se torna mestre e o restante fica em espera.  Existem poucas camadas de abstra√ß√£o, o PostgreSQL √© instalado como de costume, a √∫nica ressalva √© que a configura√ß√£o do PostgreSQL √© armazenada no etcd e √© configurada de maneira um pouco diferente. <br><br>  Ao testar o cluster, detectamos alguns problemas: <br><br><ul><li>  Stolon n√£o sabe trabalhar em cima do ZooKeeper, apenas c√¥nsul ou etcd; </li><li>  O etcd √© muito sens√≠vel ao IO.  Se voc√™ mant√©m o PostgreSQL e o etcd no mesmo servidor, definitivamente precisa de SSDs r√°pidos; </li><li>  mesmo no SSD, √© necess√°rio configurar os tempos limites do etcd, caso contr√°rio, tudo ser√° interrompido sob carga - o cluster pensar√° que o mestre caiu e quebrar√° constantemente as conex√µes; </li><li>  Por padr√£o, max_connections no PostgreSQL √© pequeno (200), voc√™ precisa aument√°-lo para suas necessidades; </li><li>  um cluster de tr√™s etcd sobreviver√° √† morte de apenas um servidor; idealmente, voc√™ precisa ter uma configura√ß√£o, por exemplo, 5 etcd + 3 Stolon; </li><li>  fora da caixa, todas as conex√µes v√£o para o mestre, os escravos n√£o s√£o acess√≠veis para a conex√£o. </li></ul><br>  Como todas as conex√µes com o PostgreSQL v√£o para o assistente, novamente encontramos um problema com solicita√ß√µes anal√≠ticas pesadas.  O etcd √†s vezes reagiu dolorosamente √† alta carga no mestre e o trocou.  E alternar o assistente est√° sempre interrompendo as conex√µes.  A solicita√ß√£o foi reiniciada, tudo come√ßou novamente.  Para uma solu√ß√£o alternativa, foi escrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um script Python</a> que solicitou endere√ßos stolonctl de escravos ativos e gerou uma configura√ß√£o para o HAProxy, redirecionando solicita√ß√µes para eles. <br><br><img src="https://habrastorage.org/webt/k6/er/ds/k6erds-_gyudfmyruuzpmw0oudm.png"><br><br>  A imagem a seguir foi mostrada: solicita√ß√µes de aplicativos v√£o para a porta stolon-proxy, que os redireciona para o mestre, e solicita√ß√µes de analistas (sempre s√£o somente leitura) v√£o para a porta HAProxy, que as lan√ßa para algum escravo. <br><br>  Al√©m disso, literalmente hoje, um PR foi adotado na Stolon, o que permitiu o envio de informa√ß√µes sobre inst√¢ncias do Stolon para uma descoberta de servi√ßo de terceiros. <br><br><img src="https://habrastorage.org/webt/o-/al/k_/o-alk_xqmlva498z1yav5nbooze.png"><br><br>  No que diz respeito √†s m√©tricas de velocidade de resposta do aplicativo, a transi√ß√£o para um cluster remoto n√£o teve um impacto significativo no desempenho, o tempo m√©dio de resposta n√£o mudou.  A lat√™ncia resultante da rede, aparentemente, foi compensada pelo fato de o banco de dados agora estar em um servidor dedicado. <br><br>  O Stolon sem problemas sobrevive a uma falha do assistente (perda do servidor, perda de rede, perda de disco), quando o servidor ganha vida - ele redefine automaticamente a r√©plica.  O ponto mais fraco do Stolon √© o etcd, falhas nele colocam o cluster.  Tivemos um acidente t√≠pico: um cluster de tr√™s n√≥s etcd, dois foram cortados.  Tudo, o quorum foi quebrado, etcd entrou em status n√£o √≠ntegro, o cluster Stolon n√£o aceita nenhuma conex√£o, incluindo solicita√ß√µes do stolonctl.  Esquema de recupera√ß√£o: transforme o etcd no servidor sobrevivente em um cluster de n√≥ √∫nico e adicione os membros novamente.  Conclus√£o: para sobreviver √† morte de dois servidores, voc√™ deve ter pelo menos 5 inst√¢ncias etcd. <br><br><h2>  Monitorando e capturando erros </h2><br>  Com o crescimento da infraestrutura e a complexidade dos microsservi√ßos, eu queria coletar mais informa√ß√µes sobre o que est√° acontecendo dentro do aplicativo e da m√°quina Java.  N√£o conseguimos adaptar o Zabbix ao novo ambiente: √© muito inconveniente nas condi√ß√µes de uma infraestrutura em mudan√ßa.  Eu tive que moer muletas atrav√©s da API ou subir com as m√£os, o que √© ainda pior.  Seu banco de dados √© pouco adaptado a cargas pesadas e, em geral, √© muito inconveniente colocar tudo isso em um banco de dados relacional. <br><br>  Como resultado, escolhemos o Prometheus para monitoramento.  Ele tem um atuador pronto para aplica√ß√µes Spring para fornecer m√©tricas; para a Kafka, eles ferraram o JMX Exporter, que tamb√©m fornece m√©tricas de maneira confort√°vel.  Os exportadores que n√£o foram encontrados ‚Äúna caixa‚Äù, escrevemos em Python, existem cerca de dez deles.  N√≥s visualizamos Grafana, coletamos os logs com Graylog (j√° que ele agora suporta Beats). <br><br>  Usamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sentry</a> para coletar erros.  Ele escreve tudo de forma estruturada, desenha gr√°ficos, mostra o que aconteceu com mais frequ√™ncia e com menos frequ√™ncia.  Geralmente, os desenvolvedores v√£o imediatamente para o Sentry imediatamente ap√≥s a implanta√ß√£o, verificam se h√° algum pico ou precisam urgentemente ser revertidos.  Acontece que ele rapidamente captura erros sem selecionar os logs. <br><br>  Por enquanto, se o formato dos artigos se adequar aos leitores, continuaremos a falar sobre nossa infraestrutura, ainda h√° muita divers√£o: solu√ß√µes Kafka e anal√≠ticas para eventos que passam por ela, canal CI / CD para aplicativos do Windows e aventuras com o Openshift. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt443530/">https://habr.com/ru/post/pt443530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt443520/index.html">Escolhendo um carro para um especialista em TI ou dicas para bules de uma chaleira</a></li>
<li><a href="../pt443522/index.html">Hospedagem: op√ß√µes, compara√ß√µes, estat√≠sticas do usu√°rio</a></li>
<li><a href="../pt443524/index.html">Fa√ßa voc√™ mesmo anima√ß√µes em Flash no Unity3D. Parte Um, L√≠rico</a></li>
<li><a href="../pt443526/index.html">Dos algoritmos ao c√¢ncer: palestras da Escola de Bioinform√°tica</a></li>
<li><a href="../pt443528/index.html">Amazon lan√ßou o Open Distro for Elasticsearch</a></li>
<li><a href="../pt443532/index.html">5 recursos de p√≥s met√°licos para impress√£o 3D</a></li>
<li><a href="../pt443534/index.html">Compute Express Link - Interconex√£o para Big Data</a></li>
<li><a href="../pt443542/index.html">Ponto de verifica√ß√£o gratuito Introdu√ß√£o Curso gratuito R80.20</a></li>
<li><a href="../pt443544/index.html">Perfil de mem√≥ria no STM32 e outros microcontroladores: an√°lise de tamanho de pilha est√°tica</a></li>
<li><a href="../pt443548/index.html">Psicologia do consumidor moderno ou o que nos ajuda a tomar uma decis√£o de compra</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>