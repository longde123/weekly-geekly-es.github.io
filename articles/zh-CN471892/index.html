<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ˜¿ ğŸ‘©ğŸ¾â€âš–ï¸ ğŸ” æˆ‘ä»¬SREå·¥ä½œæ—¥çš„6ä¸ªå®ç”¨æ•…äº‹ ğŸ§œğŸ» ğŸ¥‹ ğŸ–ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ç°ä»£WebåŸºç¡€ç»“æ„ç”±è®¸å¤šç”¨äºå„ç§ç›®çš„çš„ç»„ä»¶ç»„æˆï¼Œè¿™äº›ç»„ä»¶å…·æœ‰æ˜æ˜¾çš„è”ç³»ï¼Œå¹¶ä¸”ç›¸äº’ä¹‹é—´çš„è”ç³»å¹¶ä¸ååˆ†ç´§å¯†ã€‚ å½“è¿è¡Œä½¿ç”¨ä¸åŒè½¯ä»¶å †æ ˆçš„åº”ç”¨ç¨‹åºæ—¶ï¼Œè¿™ä¸€ç‚¹å°¤å…¶æ˜æ˜¾ï¼Œéšç€å¾®æœåŠ¡çš„å‡ºç°ï¼Œå®ƒå®é™…ä¸Šåœ¨æ¯ä¸ªæ­¥éª¤ä¸­éƒ½å¼€å§‹å‘ç”Ÿã€‚ å¤–éƒ¨å› ç´ ï¼ˆç¬¬ä¸‰æ–¹APIï¼ŒæœåŠ¡ç­‰ï¼‰è¢«æ·»åŠ åˆ°å¸¸è§„çš„â€œä¹è¶£â€ä¸­ï¼Œè¿™ä½¿æœ¬æ¥å·²ç»å¾ˆå›°éš¾çš„æƒ…å†µå˜å¾—æ›´åŠ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘ä»¬SREå·¥ä½œæ—¥çš„6ä¸ªå®ç”¨æ•…äº‹</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/471892/"><img src="https://habrastorage.org/webt/7_/c-/_w/7_c-_wura080ohc4zdfyq6ummtw.png"><br><br> ç°ä»£WebåŸºç¡€ç»“æ„ç”±è®¸å¤šç”¨äºå„ç§ç›®çš„çš„ç»„ä»¶ç»„æˆï¼Œè¿™äº›ç»„ä»¶å…·æœ‰æ˜æ˜¾çš„è”ç³»ï¼Œå¹¶ä¸”ç›¸äº’ä¹‹é—´çš„è”ç³»å¹¶ä¸ååˆ†ç´§å¯†ã€‚ å½“è¿è¡Œä½¿ç”¨ä¸åŒè½¯ä»¶å †æ ˆçš„åº”ç”¨ç¨‹åºæ—¶ï¼Œè¿™ä¸€ç‚¹å°¤å…¶æ˜æ˜¾ï¼Œéšç€å¾®æœåŠ¡çš„å‡ºç°ï¼Œå®ƒå®é™…ä¸Šåœ¨æ¯ä¸ªæ­¥éª¤ä¸­éƒ½å¼€å§‹å‘ç”Ÿã€‚ å¤–éƒ¨å› ç´ ï¼ˆç¬¬ä¸‰æ–¹APIï¼ŒæœåŠ¡ç­‰ï¼‰è¢«æ·»åŠ åˆ°å¸¸è§„çš„â€œä¹è¶£â€ä¸­ï¼Œè¿™ä½¿æœ¬æ¥å·²ç»å¾ˆå›°éš¾çš„æƒ…å†µå˜å¾—æ›´åŠ å¤æ‚ã€‚ <br><br> é€šå¸¸ï¼Œå³ä½¿å°†è¿™äº›åº”ç”¨ç¨‹åºä¸é€šç”¨çš„ä½“ç³»ç»“æ„æ€æƒ³å’Œè§£å†³æ–¹æ¡ˆç»“åˆåœ¨ä¸€èµ·ï¼Œè¦æ¶ˆé™¤å®ƒä»¬ä¸­çš„ä¸å¯»å¸¸é—®é¢˜ï¼Œé€šå¸¸ä¹Ÿè¦èµ°éä¸‹ä¸€ä¸ªé™Œç”Ÿçš„é¢†åŸŸã€‚ è¿™äº›é—®é¢˜æ˜¯å¦å‘ç”Ÿåªæ˜¯æ—¶é—´é—®é¢˜ã€‚ è¿™äº›æ˜¯æœ¬æ–‡ä¸“é—¨é’ˆå¯¹æˆ‘ä»¬æœ€æ–°å®è·µçš„ç¤ºä¾‹ã€‚ æ¼”å‘˜ï¼šGolangï¼ŒSentryï¼ŒRabbitMQï¼Œnginxï¼ŒPostgreSQLç­‰ã€‚ <a name="habracut"></a><br><br><h2> å†å²ç¬¬ä¸€  Golangå’ŒHTTP / 2 </h2><br> è¿è¡Œå¯¹Webåº”ç”¨ç¨‹åºæ‰§è¡Œè®¸å¤šHTTPè¯·æ±‚çš„åŸºå‡†æµ‹è¯•ä¼šå¯¼è‡´æ„å¤–ç»“æœã€‚ åœ¨åŸºå‡†æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªç®€å•çš„Goåº”ç”¨ç¨‹åºè½¬åˆ°äº†ä½äºingress / openrestyä¹‹åçš„å¦ä¸€ä¸ªGoåº”ç”¨ç¨‹åºã€‚ å¯ç”¨HTTP / 2åï¼Œå¯¹äºæŸäº›è¯·æ±‚ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°ä»£ç 400çš„é”™è¯¯ï¼›è¦äº†è§£æ­¤è¡Œä¸ºçš„åŸå› ï¼Œæˆ‘ä»¬ä»é“¾çš„æœ€è¿œç«¯åˆ é™¤äº†Goåº”ç”¨ç¨‹åºï¼Œå¹¶åœ¨Ingressä¸­åˆ›å»ºäº†ä¸€ä¸ªç®€å•ä½ç½®ï¼Œè¯¥ä½ç½®å§‹ç»ˆè¿”å›200ã€‚è¯¥è¡Œä¸ºæœªæ›´æ”¹ï¼ <cut></cut><br><br> ç„¶åå†³å®šåœ¨Kubernetesç¯å¢ƒä¹‹å¤–çš„å…¶ä»–ç¡¬ä»¶ä¸Šé‡ç°è„šæœ¬ã€‚ ç»“æœæ˜¯ç”Ÿæˆäº†ä¸€ä¸ªMakefileï¼Œå€ŸåŠ©å®ƒå¯åŠ¨äº†ä¸¤ä¸ªå®¹å™¨ï¼šä¸€ä¸ªæ˜¯Apacheä¸­çš„åŸºå‡†-è¿›å…¥nginxçš„åŸºå‡†ï¼Œå¦ä¸€ä¸ªæ˜¯Apacheä¸­çš„åŸºå‡†ã€‚ ä¸¤è€…éƒ½ä½¿ç”¨è‡ªç­¾åè¯ä¹¦æ¥ä¾¦å¬HTTP / 2ã€‚ æœ€ç»ˆæ“ä½œæ—¶é—´è¯·å‚è§æ­¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://github.com/flant/examples/tree/master/2019/09-">å­˜å‚¨åº“</a> ã€‚ <br><br> ä½¿ç”¨<code>concurrency=200</code>è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼š <br><br>  1.1ã€‚  Nginxï¼š <br><br><pre> <code class="plaintext hljs">Completed 0 requests Completed 1000 requests Completed 2000 requests Completed 3000 requests Completed 4000 requests Completed 5000 requests Completed 6000 requests Completed 7000 requests Completed 8000 requests Completed 9000 requests ----- Bench results begin ----- Requests per second: 10336.09 Failed requests: 1623 ----- Bench results end -----</code> </pre> <br>  1.2ã€‚ é˜¿å¸•å¥‡ï¼š <br><br><pre> <code class="plaintext hljs">â€¦ ----- Bench results begin ----- Requests per second: 11427.60 Failed requests: 0 ----- Bench results end -----</code> </pre> <br> æˆ‘ä»¬å‡è®¾è¿™é‡Œçš„é‡ç‚¹æ˜¯åœ¨Apacheä¸­ä¸å¤ªä¸¥æ ¼çš„HTTP / 2å®ç°ã€‚ <br><br> è®©æˆ‘ä»¬å°è¯•<code>concurrency=1000</code> ï¼š <br><br>  2.1ã€‚  Nginxï¼š <br><br><pre> <code class="plaintext hljs">â€¦ ----- Bench results begin ----- Requests per second: 11274.92 Failed requests: 4205 ----- Bench results end -----</code> </pre> <br>  2.2ã€‚ é˜¿å¸•å¥‡ï¼š <br><br><pre> <code class="plaintext hljs">â€¦ ----- Bench results begin ----- Requests per second: 11211.48 Failed requests: 5 ----- Bench results end -----</code> </pre> <br> åŒæ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ç»“æœ<i>å¹¶éæ¯æ¬¡</i>éƒ½<i>é‡ç°</i> ï¼šæŸäº›å¯åŠ¨é¡ºåˆ©é€šè¿‡ã€‚ <br><br> åœ¨Golangé¡¹ç›®çš„githubä¸Šæœç´¢é—®é¢˜å¯¼è‡´äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ï¼ƒ25009</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ï¼ƒ32441</a> ã€‚ é€šè¿‡å®ƒä»¬ï¼Œæˆ‘ä»¬è¿›å…¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PR 903</a> ï¼šé»˜è®¤æƒ…å†µä¸‹åœ¨Goä¸­ç¦ç”¨HTTP / 2ï¼ <br><br> åœ¨ä¸æ·±å…¥ç ”ç©¶ä¸Šè¿°WebæœåŠ¡å™¨çš„ä½“ç³»ç»“æ„çš„æƒ…å†µä¸‹è§£é‡ŠåŸºå‡†æµ‹è¯•ç»“æœéå¸¸å›°éš¾ã€‚ åœ¨ç‰¹å®šæƒ…å†µä¸‹ï¼Œä¸ºæŒ‡å®šæœåŠ¡ç¦ç”¨HTTP / 2å°±è¶³å¤Ÿäº†ã€‚ <br><br><h2> å†å²2å· æ—§çš„symfonyå’Œå“¨å…µ </h2><br> åœ¨å…¶ä¸­ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œéå¸¸æ—§ç‰ˆæœ¬çš„symfony PHPæ¡†æ¶ï¼ˆv2.3ï¼‰ä»åœ¨è¿è¡Œã€‚ åœ¨å·¥å…·ç®±ä¸­å°†æ—§çš„Ravenå®¢æˆ·ç«¯å’ŒPHPè‡ªå†™ç±»é™„åŠ åˆ°è¯¥å·¥å…·åŒ…ä¸Šï¼Œè¿™ä½¿è°ƒè¯•å˜å¾—æœ‰äº›å¤æ‚ã€‚ <br><br> åœ¨å°†Kubernetesä¸­çš„ä¸€é¡¹æœåŠ¡è½¬ç§»åˆ°Sentryï¼ˆç”¨äºè·Ÿè¸ªè¯¥é¡¹ç›®åº”ç”¨ç¨‹åºä¸­çš„é”™è¯¯ï¼‰ä¹‹åï¼Œäº‹ä»¶çªç„¶åœæ­¢äº†ã€‚ ä¸ºäº†é‡ç°æ­¤è¡Œä¸ºï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Sentryç½‘ç«™ä¸Šçš„ç¤ºä¾‹ï¼Œé‡‡ç”¨äº†ä¸¤ä¸ªé€‰é¡¹å¹¶ä»Sentryè®¾ç½®ä¸­å¤åˆ¶äº†DSNã€‚ ä»è§†è§‰ä¸Šçœ‹ï¼Œä¸€åˆ‡æ­£å¸¸ï¼šé”™è¯¯æ¶ˆæ¯ï¼ˆæ®è¯´ï¼‰æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å‘é€çš„ã€‚ <br><br>  JavaScriptæ£€æŸ¥é€‰é¡¹ï¼š <br><br><pre> <code class="javascript hljs">&lt;!DOCTYPE html&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"https://browser.sentry-cdn.com/5.6.3/bundle.min.js"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">integrity</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"sha384-/Cqa/8kaWn7emdqIBLk3AkFMAHBk0LObErtMhO+hr52CntkaurEnihPmqYj3uJho"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">crossorigin</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"anonymous"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"><span class="xml"><span class="undefined"> </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">JavaScript in Body</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"demo"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">A Paragraph.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"myFunction()"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Try it</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> Sentry.init({ </span></span><span class="hljs-attr"><span class="xml"><span class="javascript"><span class="hljs-attr">dsn</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12'</span></span></span></span><span class="xml"><span class="javascript"> }); </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">try</span></span></span></span><span class="xml"><span class="javascript"> { </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">throw</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">Error</span></span></span></span><span class="xml"><span class="javascript">(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'Caught'</span></span></span></span><span class="xml"><span class="javascript">); } </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">catch</span></span></span></span><span class="xml"><span class="javascript"> (err) { Sentry.captureException(err); } </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br> åŒæ ·åœ¨Pythonä¸­ï¼š <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sentry_sdk <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> init, capture_message init(<span class="hljs-string"><span class="hljs-string">"http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12"</span></span>) capture_message(<span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Will create an event. raise ValueError()</span></span></code> </pre> <br> ä½†æ˜¯ï¼Œä»–ä»¬æ²¡æœ‰è¿›å…¥å“¨å…µã€‚ å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šäº§ç”Ÿå‘é€æ¶ˆæ¯çš„é”™è§‰ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¼šç«‹å³ä¸ºè¯¥é—®é¢˜ç”Ÿæˆä¸€ä¸ªå“ˆå¸Œã€‚ <br><br> ç»“æœï¼Œè¯¥é—®é¢˜å¾—ä»¥éå¸¸ç®€å•åœ°è§£å†³ï¼šäº‹ä»¶å‘é€åˆ°HTTPï¼Œè€ŒSentryæœåŠ¡ä»…ä¾¦å¬HTTPSã€‚ æä¾›äº†ä»HTTPåˆ°HTTPSçš„é‡å®šå‘ï¼Œä½†æ˜¯æ—§å®¢æˆ·ç«¯ï¼ˆsymfonyç«¯çš„ä»£ç ï¼‰æ— æ³•éµå¾ªé‡å®šå‘ï¼Œè¿™äº›å¤©é»˜è®¤æƒ…å†µä¸‹æ‚¨ä¸å¸Œæœ›è¿™æ ·åšã€‚ <br><br><h2> å†å²ç¬¬3å·ã€‚  RabbitMQå’Œç¬¬ä¸‰æ–¹ä»£ç† </h2><br> åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼ŒEvotoräº‘ç”¨äºè¿æ¥æ”¶é“¶æœºã€‚ å®é™…ä¸Šï¼Œå®ƒå¯ä»¥ä½œä¸ºä»£ç†ä½¿ç”¨ï¼šæ¥è‡ªEvotorçš„POSTè¯·æ±‚ç›´æ¥é€šè¿‡é€šè¿‡WebSocketè¿æ¥å®ç°çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">STOMPæ’ä»¶</a>ç›´æ¥å‘é€åˆ°RabbitMQã€‚ <br><br> å…¶ä¸­ä¸€åå¼€å‘äººå‘˜ä½¿ç”¨Postmanå‘å‡ºäº†æµ‹è¯•è¯·æ±‚ï¼Œå¹¶æ”¶åˆ°äº†<code>200 OK</code>çš„é¢„æœŸå“åº”ï¼Œä½†æ˜¯ï¼Œé€šè¿‡äº‘è¿›è¡Œçš„è¯·æ±‚å¯¼è‡´æ„å¤–çš„<code>405 Method Not Allowed</code> ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">200 OK</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-2 pod_name: nginx-2bpt7 container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:42:50+00:00 request_id: 1271dba228f0943ab2df0196ff0d7f67 user: client address: 100.200.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.eeeeffff111:1.onlinecassa:55556666/get request_query: referrer: user_agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36 content_kind: cacheable namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 2538 nginx_upstream_response_time: 0.008 nginx_upstream_status: 200 bytes_received: 757 bytes_sent: 1254 request_time: 0 status: 200 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">405æ–¹æ³•ä¸å…è®¸</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-1 pod_name: nginx-4xx6h container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:46:26+00:00 request_id: b8dd789604864c95b4af499ed6805630 user: client address: 200.100.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get request_query: referrer: user_agent: ru.evotor.proxy/37 content_kind: cache-headers-not-present namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 134 nginx_upstream_response_time: 0.004 nginx_upstream_status: 405 bytes_received: 878 bytes_sent: 137 request_time: 0 status: 405 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">æ¥è‡ªEvotorçš„Tcpdumpè¯·æ±‚</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">200.100.300.400.21519 &gt; 100.200.400.300: Flags [P.], cksum 0x8e29 (correct), seq 1:879, ack 1, win 221, options [nop,nop,TS val 2313007107 ecr 79097074], length 878: HTTP, length: 878 POST /api/queues//vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 device-model: ST-5 device-os: android Accept-Encoding: gzip content-type: application/json; charset=utf-8 connection: close accept: application/json x-original-forwarded-for: 10.11.12.13 originhost: rmq-review.kube-dev.client.domain x-original-uri: /api/v2/apps/e114-aaef-bbbb-beee-abadada44ae/requests x-scheme: https accept-encoding: gzip user-agent: ru.evotor.proxy/37 Authorization: Basic X-Evotor-Store-Uuid: 20180417-73DC-40C9-80B7-00E990B77D2D X-Evotor-Device-Uuid: 20190909-A47B-40EA-806A-F7BC33833270 X-Evotor-User-Id: 01-000000000147888 Content-Length: 58 Host: rmq-review.kube-dev.client.domain {"count":1,"encoding":"auto","ackmode":"ack_requeue_true"}[!http] 12:53:30.095385 IP (tos 0x0, ttl 64, id 5512, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [.], cksum 0xfa81 (incorrect -&gt; 0x3c87), seq 1, ack 879, win 60, options [nop,nop,TS val 79097122 ecr 2313007107], length 0 12:53:30.096876 IP (tos 0x0, ttl 64, id 5513, offset 0, flags [DF], proto TCP (6), length 189) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [P.], cksum 0xfb0a (incorrect -&gt; 0x03b9), seq 1:138, ack 879, win 60, options [nop,nop,TS val 79097123 ecr 2313007107], length 137: HTTP, length: 137 HTTP/1.1 405 Method Not Allowed Date: Tue, 10 Sep 2019 10:53:30 GMT Content-Length: 0 Connection: close allow: HEAD, GET, OPTIONS</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">curlå‘å‡ºçš„tcpdumpè¯·æ±‚</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">777.10.74.11.61211 &gt; 100.200.400.300:80: Flags [P.], cksum 0x32a8 (correct), seq 1:397, ack 1, win 2052, options [nop,nop,TS val 734012594 ecr 4012360530], length 396: HTTP, length: 396 POST /api/queues/%2Fvhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 Host: rmq-review.kube-dev.client.domain User-Agent: curl/7.54.0 Authorization: Basic = Content-Type: application/json Accept: application/json Content-Length: 58 {"count":1,"ackmode":"ack_requeue_true","encoding":"auto"}[!http] 12:40:11.001442 IP (tos 0x0, ttl 64, id 50844, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [.], cksum 0x2d01 (incorrect -&gt; 0xfa25), seq 1, ack 397, win 59, options [nop,nop,TS val 4012360590 ecr 734012594], length 0 12:40:11.017065 IP (tos 0x0, ttl 64, id 50845, offset 0, flags [DF], proto TCP (6), length 2621) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [P.], cksum 0x370a (incorrect -&gt; 0x6872), seq 1:2570, ack 397, win 59, options [nop,nop,TS val 4012360605 ecr 734012594], length 2569: HTTP, length: 2569 HTTP/1.1 200 OK Date: Tue, 10 Sep 2019 10:40:11 GMT Content-Type: application/json Content-Length: 2348 Connection: keep-alive Vary: Accept-Encoding cache-control: no-cache vary: accept, accept-encoding, origin</code> </pre> </div></div><br> è®­ç»ƒæœ‰ç´ çš„å·¥ç¨‹å¸ˆçš„çœ¼ç›ç«‹å³çœ‹åˆ°äº†åŒºåˆ«ï¼š <br><br><ul><li>  curlï¼š <code>POST /api/queues/%2Fclientâ€¦</code> </li><li>  Evotorï¼š <code>POST /api/queues//clientâ€¦</code> </li></ul><br> é—®é¢˜æ˜¯ï¼Œåœ¨ä¸€ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ— æ³•ç†è§£çš„ï¼ˆå¯¹äºRabbitMQï¼‰ <code>//vhost</code> ï¼Œè€Œåœ¨å¦ä¸€ç§æƒ…å†µä¸‹ï¼Œ <code>%2Fvhost</code> ï¼Œè¿™æ˜¯åœ¨ä»¥ä¸‹æƒ…å†µä¸‹çš„é¢„æœŸè¡Œä¸ºï¼š <br><br><pre> <code class="plaintext hljs"># rabbitmqctl list_vhosts Listing vhosts ... /vhost</code> </pre> <br> åœ¨æœ‰å…³æ­¤ä¸»é¢˜çš„RabbitMQé¡¹ç›®ä¸­ï¼Œå¼€å‘äººå‘˜è¯´æ˜ï¼š <br><br><blockquote> æˆ‘ä»¬ä¸ä¼šæ›¿æ¢ï¼…-encodingã€‚ è¿™æ˜¯URLè·¯å¾„ç¼–ç çš„æ ‡å‡†æ–¹æ³•ï¼Œå¹¶ä¸”å·²ç»å­˜åœ¨äº†å¾ˆé•¿æ—¶é—´ã€‚ å‡è®¾åŸºäºHTTPçš„å·¥å…·ä¸­çš„ï¼…-encodingå°†ä¼šæ¶ˆå¤±ï¼Œå› ä¸ºå³ä½¿æ˜¯æœ€æµè¡Œçš„æ¡†æ¶ï¼Œå‡è®¾æ­¤ç±»URLè·¯å¾„æ˜¯â€œæ¶æ„çš„â€ä¹Ÿæ˜¯è¿‘è§†å’Œå¹¼ç¨šçš„ã€‚ å¯ä»¥å°†é»˜è®¤è™šæ‹Ÿä¸»æœºå<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ›´æ”¹ä¸ºä»»ä½•å€¼</a> ï¼ˆä¾‹å¦‚ï¼Œä¸ä½¿ç”¨æ–œæ æˆ–ä»»ä½•å…¶ä»–éœ€è¦ï¼…-encodingçš„å­—ç¬¦ï¼‰ï¼Œå¹¶ä¸”è‡³å°‘ä½¿ç”¨RabbitMQçš„Pivotal BOSHç‰ˆæœ¬æ—¶ï¼Œæ— è®ºå¦‚ä½•åœ¨éƒ¨ç½²æ—¶éƒ½å°†é»˜è®¤è™šæ‹Ÿä¸»æœºåˆ é™¤ã€‚ </blockquote><br> è¯¥é—®é¢˜æ— éœ€æˆ‘ä»¬çš„å·¥ç¨‹å¸ˆè¿›ä¸€æ­¥å‚ä¸å³å¯è§£å†³ï¼ˆä¸ä»–ä»¬è”ç³»åï¼Œåœ¨Evotoræ–¹é¢ï¼‰ã€‚ <br><br><h2> å†å²ç¬¬4å·  PostgreSQLä¸­çš„åŸºå›  </h2><br>  PostgreSQLæœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç´¢å¼•ï¼Œç»å¸¸è¢«é—å¿˜ã€‚ è¿™ä¸ªæ•…äº‹å§‹äºå¯¹åº”ç”¨ç¨‹åºåˆ¹è½¦çš„æŠ±æ€¨ã€‚ åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ€è¿‘çš„æ–‡ç« ä¸­ï¼Œ</a>æˆ‘ä»¬å·²ç»ç»™å‡ºäº†åˆ†ææ­¤ç±»æƒ…å†µæ—¶çš„è¿‘ä¼¼å·¥ä½œæµç¤ºä¾‹ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„APM- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Atatus-</a>æ˜¾ç¤ºäº†ä»¥ä¸‹å›¾ç‰‡ï¼š <br><br><img src="https://habrastorage.org/webt/t9/yy/gz/t9yygzwma4valcmjnpt-lbfxpdi.png"><br><br> åœ¨ä¸Šåˆ10ç‚¹ï¼Œåº”ç”¨ç¨‹åºèŠ±è´¹åœ¨å¤„ç†æ•°æ®åº“ä¸Šçš„æ—¶é—´ä¼šå¢åŠ ã€‚ ä¸å‡ºæ‰€æ–™ï¼ŒåŸå› åœ¨äºDBMSå“åº”ç¼“æ…¢ã€‚ å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œåˆ†ææŸ¥è¯¢ï¼Œè¯†åˆ«é—®é¢˜åŒºåŸŸå’Œâ€œæ‚¬æŒ‚â€ç´¢å¼•æ˜¯å¯ä»¥ç†è§£çš„ä¾‹ç¨‹ã€‚ æˆ‘ä»¬ä½¿ç”¨çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">okometer</a>æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¾ˆå¤š</a>å¸®åŠ©ï¼šæ—¢æœ‰ç”¨äºç›‘è§†æœåŠ¡å™¨çŠ¶æ€çš„æ ‡å‡†é¢æ¿ï¼Œåˆæœ‰<i>å¿«é€Ÿ</i>æ„å»ºæˆ‘ä»¬è‡ªå·±çš„åŠŸèƒ½çš„èƒ½åŠ›-è¾“å‡ºæœ‰é—®é¢˜çš„æŒ‡æ ‡ï¼š <br><br><img src="https://habrastorage.org/webt/5r/8h/2p/5r8h2pfgbo_rxewvzgf_3jyjcii.png"><br><br>  CPUè´Ÿè½½å›¾è¡¨æ˜å…¶ä¸­ä¸€ä¸ªæ•°æ®åº“å·²100ï¼…åŠ è½½ã€‚ æ€ä¹ˆäº† æ–°çš„PostgreSQLé¢æ¿å°†æç¤ºï¼š <br><br><img src="https://habrastorage.org/webt/i0/pq/de/i0pqdejoizrp518mnsnguoljkdg.png"><br><br> é—®é¢˜çš„åŸå› æ˜¯æ˜¾è€Œæ˜“è§çš„-CPUçš„ä¸»è¦ä½¿ç”¨è€…ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u.id = ? &amp; u.field_1 = ? <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> u.field_2 <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%somestring%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> u.id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> ?</code> </pre> <br> è€ƒè™‘åˆ°æœ‰é—®é¢˜çš„æŸ¥è¯¢çš„å·¥ä½œè®¡åˆ’ï¼Œæˆ‘ä»¬å‘ç°æŒ‰è¡¨çš„ç´¢å¼•å­—æ®µè¿›è¡Œè¿‡æ»¤çš„é€‰æ‹©èŒƒå›´å¤ªå¤§ï¼šæ•°æ®åº“é€šè¿‡<code>id</code>å’Œ<code>field_1</code>æ¥æ”¶äº†è¶…è¿‡7ä¸‡è¡Œï¼Œç„¶ååœ¨å…¶ä¸­æœç´¢ä¸€ä¸ªå­å­—ç¬¦ä¸²ã€‚ äº‹å®è¯æ˜ï¼Œ <code>LIKE</code>å­—ç¬¦ä¸²çš„<code>LIKE</code>ä¼šè¿­ä»£å¤§é‡æ–‡æœ¬æ•°æ®ï¼Œè¿™ä¼šå¯¼è‡´æŸ¥è¯¢æ‰§è¡Œé€Ÿåº¦ä¸¥é‡ä¸‹é™ï¼Œå¹¶å¢åŠ CPUè´Ÿè½½ã€‚ <br><br>  <i>åœ¨è¿™é‡Œæ‚¨å¯ä»¥æ­£ç¡®åœ°æ³¨æ„åˆ°ï¼Œæ²¡æœ‰æ’é™¤ä½“ç³»ç»“æ„é—®é¢˜ï¼ˆéœ€è¦åº”ç”¨ç¨‹åºé€»è¾‘æ›´æ­£ï¼Œç”šè‡³éœ€è¦å…¨æ–‡æœ¬å¼•æ“...ï¼‰ï¼Œä½†æ˜¯æ²¡æœ‰æ—¶é—´è¿›è¡Œè¿”å·¥ï¼Œä½†æ˜¯åº”è¯¥åœ¨15åˆ†é’Ÿä¹‹å‰å°±å¯ä»¥å¾ˆå¿«åœ°è¿›è¡Œå·¥ä½œã€‚</i>  <i>åŒæ—¶ï¼Œæœç´¢è¯å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼ˆä¸ºä»€ä¹ˆä¸åœ¨å•ç‹¬çš„å­—æ®µä¸­å‘¢ï¼Ÿ..ï¼‰ï¼Œè¯¥æ ‡è¯†ç¬¦ç”Ÿæˆè¡Œå•ä½ã€‚</i>  <i>å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨æ­¤æ–‡æœ¬å­—æ®µä¸Šç¼–å†™ç´¢å¼•ï¼Œåˆ™æ‰€æœ‰å…¶ä»–å­—æ®µå°†å˜å¾—ä¸å¿…è¦ã€‚</i> <br><br> å½“å‰çš„æœ€ç»ˆè§£å†³æ–¹æ¡ˆæ˜¯ä¸º<code>field_2</code>æ·»åŠ ä¸€ä¸ªGINç´¢å¼•ã€‚ é‚£å°±æ˜¯ä»Šå¤©çš„è‹±é›„-åŒæ ·çš„â€œç²¾çµâ€ã€‚ ç®€è€Œè¨€ä¹‹ï¼ŒGINæ˜¯ä¸€ç§åœ¨å…¨æ–‡æœç´¢ä¸­è¡¨ç°å‡ºè‰²çš„ç´¢å¼•ï¼Œå¯ä»¥ä»è´¨é‡ä¸ŠåŠ å¿«ç´¢å¼•çš„é€Ÿåº¦ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™ä»½ç²¾å½©çš„èµ„æ–™ä¸­</a>é˜…è¯»æœ‰å…³å®ƒçš„æ›´å¤šä¿¡æ¯ã€‚ <br><br><img src="https://habrastorage.org/webt/sm/lw/qd/smlwqdjwdystzwexf0rfz-hk6qq.png"><br><br> å¦‚æ‚¨æ‰€è§ï¼Œæ­¤ç®€å•çš„æ“ä½œå¯ä»¥æ¶ˆé™¤é¢å¤–çš„è´Ÿæ‹…ï¼Œå¹¶ä¸ºå®¢æˆ·èŠ‚çœé‡‘é’±ã€‚ <br><br><h2> å†å²5å· åœ¨Nginxä¸­ç¼“å­˜s3 </h2><br> é•¿æœŸä»¥æ¥ï¼Œä¸S3å…¼å®¹çš„äº‘å­˜å‚¨ä¸€ç›´è¢«è®¸å¤šé¡¹ç›®æ‰€é‡‡ç”¨çš„æŠ€æœ¯ç‰¢ç‰¢åœ°åˆ—åœ¨æŠ€æœ¯æ¸…å•ä¸­ã€‚ å¦‚æœæ‚¨éœ€è¦ç”¨äºç«™ç‚¹æˆ–ç¥ç»ç½‘ç»œæ•°æ®çš„å¯é å›¾åƒå­˜å‚¨ï¼Œé‚£ä¹ˆAmazon S3æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ å­˜å‚¨çš„å¯é æ€§å’Œé«˜æ•°æ®å¯ç”¨æ€§ï¼ˆå¹¶ä¸”ä¸éœ€è¦â€œå›´å¢™â€ï¼‰ä»¤äººç€è¿·ã€‚ <br><br> ä½†æ˜¯ï¼Œæœ‰æ—¶æ˜¯ä¸ºäº†çœé’±-å› ä¸ºé€šå¸¸S3çš„è´¹ç”¨ç”¨äºè¯·æ±‚å’Œæµé‡-ä¸€ä¸ªå¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨å­˜å‚¨è®¾å¤‡å‰é¢å®‰è£…ä¸€ä¸ªç¼“å­˜ä»£ç†æœåŠ¡å™¨ã€‚ è¿™ç§æ–¹æ³•å¯ä»¥é™ä½æˆæœ¬ï¼Œä¾‹å¦‚ï¼Œæ¶‰åŠåˆ°ç”¨æˆ·å¤´åƒï¼Œæ¯ä¸ªé¡µé¢ä¸Šéƒ½æœ‰å¾ˆå¤šã€‚ <br><br> ä¼¼ä¹æ¯”ä½¿ç”¨nginxå¹¶è®¾ç½®å…·æœ‰ç¼“å­˜ï¼Œé‡æ–°éªŒè¯ï¼Œåå°æ›´æ–°å’Œå…¶ä»–äºŒåä¸€ç‚¹çš„ä»£ç†è¦å®¹æ˜“å¾—å¤šï¼Ÿ ä½†æ˜¯ï¼Œä¸å…¶ä»–åœ°æ–¹ä¸€æ ·ï¼Œæœ‰äº›ç»†å¾®å·®åˆ«... <br><br> è¿™ç§å…·æœ‰ç¼“å­˜çš„ä»£ç†çš„å¤§è‡´é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="plaintext hljs">proxy_cache_key $uri; proxy_cache_methods GET HEAD; proxy_cache_lock on; proxy_cache_revalidate on; proxy_cache_background_update on; proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_503 http_504; proxy_cache_valid 200 1h; location ~ ^/(?&lt;bucket&gt;avatars|images)/(?&lt;filename&gt;.+)$ { set $upstream $bucket.s3.amazonaws.com; proxy_pass http://$upstream/$filename; proxy_set_header Host $upstream; proxy_cache aws; proxy_cache_valid 200 1h; proxy_cache_valid 404 60s; }</code> </pre> <br> æ€»çš„æ¥è¯´ï¼Œå®ƒå¯ä»¥æ­£å¸¸å·¥ä½œï¼šæ˜¾ç¤ºå›¾ç‰‡ï¼Œä½¿ç”¨ç¼“å­˜ä¸€åˆ‡æ­£å¸¸â€¦â€¦ä½†æ˜¯ï¼ŒAWS S3å®¢æˆ·ç«¯å‡ºç°äº†é—®é¢˜ã€‚ ç‰¹åˆ«æ˜¯ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">aws-sdk-php</a>çš„å®¢æˆ·ç«¯åœæ­¢å·¥ä½œã€‚ å¯¹nginxæ—¥å¿—çš„åˆ†æè¡¨æ˜ï¼Œä¸Šæ¸¸è¿”å›äº†HEADè¯·æ±‚çš„403ä»£ç ï¼Œå¹¶ä¸”å“åº”åŒ…å«ä¸€ä¸ªç‰¹å®šé”™è¯¯ï¼š <code>SignatureDoesNotMatch</code> ã€‚ å½“æˆ‘ä»¬çœ‹åˆ°nginxå‘ä¸Šæ¸¸å‘å‡ºGETè¯·æ±‚æ—¶ï¼Œä¸€åˆ‡å°±ç»ªã€‚ <br><br> äº‹å®æ˜¯S3å®¢æˆ·ç«¯å¯¹æ¯ä¸ªè¯·æ±‚è¿›è¡Œç­¾åï¼Œç„¶åæœåŠ¡å™¨æ£€æŸ¥æ­¤ç­¾åã€‚ åœ¨ç®€å•ä»£ç†çš„æƒ…å†µä¸‹ï¼Œä¸€åˆ‡æ­£å¸¸ï¼šè¯·æ±‚æœªæ›´æ”¹åœ°åˆ°è¾¾æœåŠ¡å™¨ã€‚ ä½†æ˜¯ï¼Œå¯ç”¨ç¼“å­˜åï¼Œnginxå°†å¼€å§‹ä¼˜åŒ–åç«¯çš„å·¥ä½œå¹¶å°†HEADè¯·æ±‚æ›¿æ¢ä¸ºGETã€‚ é€»è¾‘å¾ˆç®€å•ï¼šæœ€å¥½å…ˆæ£€ç´¢å¹¶ä¿å­˜æ•´ä¸ªå¯¹è±¡ï¼Œç„¶åå†ä»ç¼“å­˜ä¸­æ£€ç´¢æ‰€æœ‰HEADè¯·æ±‚ã€‚ ä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œç”±äºè¯¥è¯·æ±‚å·²ç­¾åï¼Œå› æ­¤æ— æ³•ä¿®æ”¹ã€‚ <br><br> æœ¬è´¨ä¸Šæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š <br><br><ol><li> ä¸è¦é€šè¿‡ä»£ç†æ¥é©±åŠ¨S3å®¢æˆ·ç«¯ï¼› </li><li> å¦‚æœéœ€è¦ï¼Œè¯·å…³é—­<code>proxy_cache_convert_head</code>é€‰é¡¹ï¼Œç„¶åå°†<code>$request_method</code>æ·»åŠ åˆ°ç¼“å­˜é”®ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œnginxå°†â€œæŒ‰åŸæ ·â€å‘é€HEADè¯·æ±‚å¹¶åˆ†åˆ«ç¼“å­˜å¯¹å®ƒä»¬çš„å“åº”ã€‚ </li></ol><br><h2> å†å²6å·  DDoSå’ŒGoogleç”¨æˆ·å†…å®¹ </h2><br> ç›´åˆ°æ˜ŸæœŸå¤©æ™šä¸Šæ‰é¢„ç¤ºç€é—®é¢˜-çªç„¶ï¼  -è¾¹ç¼˜æœåŠ¡å™¨ä¸Šçš„ç¼“å­˜å¤±æ•ˆé˜Ÿåˆ—å°šæœªå¢åŠ ï¼Œè¿™å°†æµé‡æä¾›ç»™å®é™…ç”¨æˆ·ã€‚ è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥‡æ€ªçš„ç—‡çŠ¶ï¼šæ¯•ç«Ÿï¼Œç¼“å­˜æ˜¯åœ¨å†…å­˜ä¸­å®ç°çš„ï¼Œå¹¶ä¸ä¸ç¡¬ç›˜é©±åŠ¨å™¨ç»‘å®šã€‚ åœ¨ä½¿ç”¨çš„ä½“ç³»ç»“æ„ä¸­åˆ·æ–°ç¼“å­˜æ˜¯ä¸€ç§å»‰ä»·çš„æ“ä½œï¼Œå› æ­¤ä»…åœ¨è´Ÿè½½å¾ˆé«˜çš„æƒ…å†µä¸‹æ‰ä¼šå‡ºç°æ­¤é”™è¯¯ã€‚ ç›¸åŒæœåŠ¡å™¨å¼€å§‹é€šçŸ¥å‡ºç°500ä¸ªé”™è¯¯<i>ï¼ˆä¸‹å›¾ä¸­çš„çº¢çº¿å°–å³°ï¼‰</i>è¿™ä¸€äº‹å®è¯å®äº†è¿™ä¸€ç‚¹ã€‚ <br><br><img src="https://habrastorage.org/webt/3-/cr/ec/3-crecmpt9kbmt7o_6gujxwiru0.png"><br><br> å¦‚æ­¤æ€¥å‰§çš„é£™å‡å¯¼è‡´CPUè¶…æ”¯ï¼š <br><br><img src="https://habrastorage.org/webt/2t/vn/cw/2tvncw9vkrti9ysqmil7bmcztk0.png"><br><br> å¿«é€Ÿåˆ†æè¡¨æ˜ï¼Œè¯·æ±‚æ²¡æœ‰åˆ°è¾¾ä¸»åŸŸï¼Œä½†æ˜¯ä»æ—¥å¿—ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°å®ƒä»¬ä½äºé»˜è®¤çš„è™šæ‹Ÿä¸»æœºä¸­ã€‚ ä¸€è·¯ä¸Šï¼Œäº‹å®è¯æ˜ï¼Œæœ‰è®¸å¤šç¾å›½ç”¨æˆ·æ¥åˆ°äº†ä¿„ç½—æ–¯èµ„æºã€‚ è¿™ç§æƒ…å†µæ€»æ˜¯ç«‹å³å¼•èµ·ç–‘é—®ã€‚ <br><br> ä»nginxæ—¥å¿—ä¸­æ”¶é›†æ•°æ®åï¼Œæˆ‘ä»¬å‘ç°æˆ‘ä»¬æ­£åœ¨å¤„ç†æŸä¸ªåƒµå°¸ç½‘ç»œï¼š <br><br><pre> <code class="plaintext hljs">35.222.30.127 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?ITPDH=XHJI" HTTP/1.1 301 178 "http://example.ru/ORQHYGJES" "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?ITPDH=XHJI" "redirect=http://www.example.ru/?ITPDH=XHJI" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?REVQSD=VQPYFLAJZ" HTTP/1.1 301 178 "http://www.usatoday.com/search/results?q=MLAJSBZAK" "Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?REVQSD=VQPYFLAJZ" "redirect=http://www.example.ru/?REVQSD=VQPYFLAJZ" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?MPYGEXB=OMJ" HTTP/1.1 301 178 "http://engadget.search.aol.com/search?q=MIWTYEDX" "Mozilla/5.0 (Windows; U; Windows NT 6.1; en; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?MPYGEXB=OMJ" "redirect=http://www.example.ru/?MPYGEXB=OMJ" ancient=1 cipher=- "LM=-;EXP=-;CC=-"</code> </pre> <br> æ—¥å¿—ä¸­è·Ÿè¸ªäº†ä¸€ä¸ªå¯ä»¥ç†è§£çš„æ¨¡å¼ï¼š <br><br><ul><li> çœŸæ­£çš„ç”¨æˆ·ä»£ç†ï¼› </li><li> å¯¹å¸¦æœ‰éšæœºGETå‚æ•°çš„æ ¹URLçš„è¯·æ±‚ï¼Œä»¥é¿å…è¿›å…¥ç¼“å­˜ï¼› </li><li> å¼•èæ¥æºç½‘å€è¡¨ç¤ºè¯¥è¯·æ±‚æ¥è‡ªæœç´¢å¼•æ“ã€‚ </li></ul><br> æˆ‘ä»¬æ”¶é›†åœ°å€å¹¶éªŒè¯å®ƒä»¬çš„éš¶å±å…³ç³»-å®ƒä»¬éƒ½å±äº<code>googleusercontent.com</code> ï¼Œå…·æœ‰ä¸¤ä¸ªå­ç½‘ï¼ˆ107.178.192.0/18å’Œ34.64.0.0/10ï¼‰ã€‚ è¿™äº›å­ç½‘åŒ…å«GCEè™šæ‹Ÿæœºå’Œå„ç§æœåŠ¡ï¼Œä¾‹å¦‚é¡µé¢ç¿»è¯‘ã€‚ <br><br> å¹¸è¿çš„æ˜¯ï¼Œæ”»å‡»å¹¶æ²¡æœ‰æŒç»­é‚£ä¹ˆé•¿æ—¶é—´ï¼ˆå¤§çº¦ä¸€ä¸ªå°æ—¶ï¼‰ï¼Œå¹¶é€æ¸å‡å°‘äº†ã€‚  Googleå†…éƒ¨çš„ä¿æŠ¤æ€§ç®—æ³•ä¼¼ä¹å·²ç»å¥æ•ˆï¼Œå› æ­¤è¯¥é—®é¢˜å·²â€œè‡ªè¡Œè§£å†³â€ã€‚ <br><br> è¿™æ¬¡æ”»å‡»æ²¡æœ‰ç ´åæ€§ï¼Œä½†å¯¹æœªæ¥æå‡ºäº†æœ‰ç”¨çš„é—®é¢˜ï¼š <br><br><ul><li> ä¸ºä»€ä¹ˆæŠ—DDoSä¸èµ·ä½œç”¨ï¼Ÿ ä½¿ç”¨äº†å¤–éƒ¨æœåŠ¡ï¼Œæˆ‘ä»¬å‘å…¶å‘é€äº†ç›¸åº”çš„è¯·æ±‚ã€‚ ä½†æ˜¯ï¼Œæœ‰å¾ˆå¤šåœ°å€... </li><li> å°†æ¥å¦‚ä½•ä¿æŠ¤è‡ªå·±å…å—æ­¤ä¾µå®³ï¼Ÿ åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œç”šè‡³å¯ä»¥é€‰æ‹©å…³é—­åœ°ç†åŒºåŸŸçš„è®¿é—®æƒé™ã€‚ </li></ul><br><h2> èšè‹¯ä¹™çƒ¯ </h2><br> å¦è¯·å‚é˜…æˆ‘ä»¬çš„åšå®¢ï¼š <br><br><ul><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»ä½¿ç”¨Kubernetesçš„ç”Ÿæ´»å¼€å§‹ï¼šè¥¿ç­ç‰™äººå¦‚ä½•ä¸æŠ±æ€¨HTTPæœåŠ¡å™¨</a> â€ï¼› </li><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes [åŠå…¶è§£å†³æ–¹æ¡ˆ]æ“ä½œä¸­çš„6ä¸ªæœ‰è¶£çš„ç³»ç»Ÿé”™è¯¯</a> â€ï¼› </li><li>  â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…³äºLinuxç½‘ç»œå­ç³»ç»Ÿçš„3ç§å¼‚å¸¸æƒ…å†µ</a> ã€‚â€ </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN471892/">https://habr.com/ru/post/zh-CN471892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN471878/index.html">å¦‚ä½•åœ¨æœ¬ä½“ç½‘ç»œä¸Šä¸ºWebAssemblyç¼–å†™æ™ºèƒ½åˆçº¦ï¼Ÿ ç¬¬1éƒ¨åˆ†ï¼šé“é”ˆ</a></li>
<li><a href="../zh-CN471882/index.html">GitHubä¸Šçš„PHPäº‹ä»¶ï¼Œå‘è¨€äººå’Œç»„ç»‡è€…çš„å¼€æ”¾åˆ—è¡¨</a></li>
<li><a href="../zh-CN471884/index.html">10ä¸ªå…è´¹çš„ApexSQLå®ç”¨ç¨‹åºï¼Œç”¨äºç®¡ç†Microsoft SQL Serveræ•°æ®åº“</a></li>
<li><a href="../zh-CN471886/index.html">VMmanager 6ï¼šå¼•å…¥ç›’å­å¹¶ä¸ä¸Šä¸€ä»£äº§å“è¿›è¡Œæ¯”è¾ƒ</a></li>
<li><a href="../zh-CN471890/index.html">å˜å¼‚æ¨ç†-å®ƒæ˜¯ä»€ä¹ˆï¼Œå®ƒåƒä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="../zh-CN471896/index.html">å†…éƒ¨å‰§æœ¬ã€‚ æ–°çš„Ansible Engine 2.9ä¸­çš„ç½‘ç»œåŠŸèƒ½</a></li>
<li><a href="../zh-CN471904/index.html">HPE InfoSightçš„èµ„æºè§„åˆ’å¸ˆ</a></li>
<li><a href="../zh-CN471906/index.html">ä¼˜åŒ–ä¸å½“çš„å±é™©</a></li>
<li><a href="../zh-CN471908/index.html">ç´ æ•°çš„æ„å¤–ä¹‹ç¾</a></li>
<li><a href="../zh-CN471912/index.html">å­¦ä¹ è‹±è¯­ï¼šæ‰©å¤§è¯æ±‡é‡çš„7ç§å®ç”¨æ–¹æ³•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>