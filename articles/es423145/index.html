<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüíº üö∂üèª ü•ß Extensi√≥n PHP y Kotlin Native. Tercera parte, probablemente final üôéüèº ‚è∫Ô∏è üë©üèº‚Äçü§ù‚Äçüë©üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En la primera parte , se cuentan cosas bastante b√°sicas sobre la configuraci√≥n de herramientas y conceptos generales. 

 La segunda parte trata , por ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Extensi√≥n PHP y Kotlin Native. Tercera parte, probablemente final</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/alfa/blog/423145/"><img align="right" src="https://habrastorage.org/webt/o7/db/cw/o7dbcwsbe8kad4jkw84guc_2n4m.png">  En la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primera parte</a> , se cuentan cosas bastante b√°sicas sobre la configuraci√≥n de herramientas y conceptos generales. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La segunda parte trata</a> , por as√≠ decirlo, del primer acercamiento al proyectil, ideas, planes, planes. <br><br>  En este art√≠culo habr√° un poco m√°s de hardcore sobre C y K / N interope, muchas macros, dolor, desesperanza y "rayos de bondad".  Por supuesto, habr√° un cap√≠tulo con una historia sobre logros (no te alabar√°s a ti mismo ... y, como beneficio adicional, una historia sobre un fakap √©pico. <br><a name="habracut"></a><br>  <b>Descargo de responsabilidad:</b> todo lo siguiente se considera en el contexto de escribir una biblioteca para PHP. <br><br><h2>  Cap√≠tulo uno  Interope ingenuo </h2><br>  C√≥mo usar las funciones K / N en C se describe en la primera parte del ciclo.  En consecuencia, aqu√≠ describir√© c√≥mo usar las funciones C en K / N. <br><br>  <a href="">La documentaci√≥n oficial es</a> bastante taca√±a y concisa, sin embargo, para proyectos simples, es suficiente. <br><br>  En resumen, debe crear un archivo especial con la extensi√≥n <b>.def</b> y especificar los archivos de encabezado necesarios. <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">headers</span></span> = php.h</code> </pre> <br>  Luego, alim√©ntelo a un programa llamado <b>cinterop</b> . <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># cinterop -def php.def -o php</span></span></code> </pre><br>  En la salida, obtendr√° la biblioteca <b>libphp.klib</b> que contiene el c√≥digo de bits llvm y varias metainformaciones. <br><br>  Luego, puede usar de manera segura las funciones y macros descritas en el archivo de encabezado ( <code>#define</code> ), sin olvidar conectar la biblioteca en la etapa de compilaci√≥n. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># kotlinc -opt -produce static ${SOURCES} -l libphp.klib -o myLib</span></span></code> </pre><br>  Pero hay un matiz.  Y no uno. <br><br><h3>  En la forma descrita anteriormente, la biblioteca no se ensamblar√° </h3><br>  Por qu√©  Pero porque las siguientes l√≠neas est√°n presentes en php.h: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_version.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend_sort.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_compat.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend_API.h"</span></span></span></span></code> </pre><br>  Aqu√≠ debe tenerse en cuenta que llvm todav√≠a est√° involucrado en la compilaci√≥n de la biblioteca, y tiene el modificador <b>-I</b> , y cinterop tiene el <b>modificador -copt</b> .  Bueno, entiendes el punto.  Como resultado, dicho comando es suficiente para compilar <b>php.h.</b> <br><br><pre> <code class="hljs mel"># cinterop -def my.def -o myLib -I${PHP_LIB_ROOT} -copt -I${PHP_LIB_ROOT} \ -copt -I${PHP_LIB_ROOT}/main \ -copt -I${PHP_LIB_ROOT}/Zend \ -copt -I${PHP_LIB_ROOT}/TSRM</code> </pre><br><h3>  Macros  Te amo y te odio  No, solo lo odio. </h3><br>  Todo lo que necesita saber sobre <code>#define</code> en t√©rminos de interopero C&gt; K / N es <br><blockquote>  Cada macro de C que se expande a una constante se representa como propiedad de Kotlin.  Otras macros no son compatibles. </blockquote><br>  Y luego recordamos que la extensi√≥n PHP es una macro en una macro y maneja una macro e intenta no llorar. <br><br>  Pero no todo es tan malo.  Para solucionar esta situaci√≥n, los desarrolladores de K / N proporcionaron un rollo de cinta aislante azul para adjuntar al archivo def de <b>declaraciones personalizadas</b> .  Se ve as√≠ (por ejemplo, tome la macro <code>Z_TYPE_P</code> ) <br><br><pre> <code class="cpp hljs">headers = php.h --- <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> zend_uchar __zp_get_arg_type(zval *z_value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Z_TYPE_P(z_value); }</code> </pre> <br>  Ahora en el c√≥digo K / N ser√° posible usar la funci√≥n <code>__zp_get_arg_type</code> <br><br><h2>  CAPITULO DOS  PHP INI-settings o una macro sub-sub. </h2><br>  Este es un "rayo de bien" hacia el c√≥digo fuente de PHP. <br><br>  Hay 4 macros para extraer configuraciones: <br><br><pre> <code class="cpp hljs">INI_INT(val) INI_FLT(val) INI_STR(val) INI_BOOL(val)</code> </pre><br>  Donde <code>val</code> es una cadena con el nombre de la configuraci√≥n. <br><br>  Ahora veamos el ejemplo de <code>INI_STR</code> para ver c√≥mo se define esta macro. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> INI_STR(name) zend_ini_string_ex((name), sizeof(name)-1, 0, NULL)</span></span></code> </pre> <br>  ¬øYa has notado su "defecto fatal"? <br><br>  Si no, d√©jame decirte: esta es la funci√≥n <code>sizeof</code> .  Cuando usa la macro directamente, entonces todo est√° bien: <br><br><pre> <code class="cpp hljs">php_printf(<span class="hljs-string"><span class="hljs-string">"The value is : %s"</span></span>, INI_STR(<span class="hljs-string"><span class="hljs-string">"my.ini"</span></span>));</code> </pre> <br>  Cuando lo usa a trav√©s de una funci√≥n proxy de un archivo <b>.def</b> , el carro se convierte en una calabaza, y <b>sizeof (name)</b> devuelve el tama√±o del puntero.  Jaque mate nativo de Kotlin. <br><br>  De hecho, solo hay dos opciones para evadir. <br><br><ol><li>  No use macros, sino funciones a las que est√°n adjuntas. </li><li>  Funciones de envoltura de c√≥digo duro para cada configuraci√≥n requerida. </li></ol><br>  La primera opci√≥n es mejor para todos que la segunda, excepto por un punto: nadie garantizar√° que la macrodeclaraci√≥n no cambie.  Por lo tanto, para mi proyecto, yo, con un sentimiento de profunda insatisfacci√≥n, eleg√≠ la segunda opci√≥n. <br><br><h2>  Cap√≠tulo tres  Depuraci√≥n?  ¬øQu√© debate? </h2><br><h3>  Acto 1 - Interoperabilidad. </h3><br>  En un momento, despu√©s de adjuntar la cinta azul al archivo def de 20 funciones proxy consecutivas, recib√≠ un error maravilloso. <br><br><pre> <code class="hljs powershell">Exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> thread <span class="hljs-string"><span class="hljs-string">"main"</span></span> java.lang.Error: /tmp/tmp399964332777824085.c:<span class="hljs-number"><span class="hljs-number">103</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>: error: too many arguments to <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">2</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">have</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">3</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UtilsKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ensureNoCompileErrors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Utils.kt:137)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexDeclarations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Indexer.kt:902)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildNativeIndexImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Indexer.kt:892)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeIndexKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildNativeIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NativeIndex.kt:56)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jvm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processCLib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:283)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jvm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:38)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cli</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilities</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InteropCompilerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invokeInterop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InteropCompiler.kt:100)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cli</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilities</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:29)</span></span></span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m_/sg/xb/m_sgxb-qifca4cx1tccuvbxa6ra.png"></div><br>  Comente sobre la mitad, vuelva a compilar, si se repite el comentario sobre la mitad del resto, recopilamos ... Y dado que el proceso de compilaci√≥n de los encabezados es lo suficientemente largo ... (s√≠, parec√≠a m√°s r√°pido que subir una docena de archivos de origen y meticulosamente, con una lupa, reconciliar). <br><br>  El segundo "rayo del bien" va hacia JetBrains. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q0/9u/dd/q09uddpi04rrxoc76xnk5meecow.png"></div><br><h3>  Acto 2 - tiempo de ejecuci√≥n. </h3><br>  Me sale un <b>error de segmentaci√≥n en</b> tiempo de ejecuci√≥n.  Pues bien, sucede.  Estoy subiendo al depurador.  Ummm ... STA? <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Program</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">received</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">signal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SIGSEGV</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Segmentation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fault</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">kfun</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:kotlinx.cinterop.toKString</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">kotlinx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">cinterop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">CPointer</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">kotlinx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">cinterop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">ByteVarOf</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">kotlin</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Byte</span></span>&gt;&gt;.()<span class="hljs-keyword"><span class="hljs-keyword">kotlin</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">String</span></span> () at /opt/buildAgent/work/<span class="hljs-number"><span class="hljs-number">4</span></span>d622a065c544371/Interop/Runtime/src/main/kotlin/kotlinx/cinterop/Utils.kt:<span class="hljs-number"><span class="hljs-number">402</span></span> <span class="hljs-number"><span class="hljs-number">402</span></span> /opt/buildAgent/work/<span class="hljs-number"><span class="hljs-number">4</span></span>d622a065c544371/Interop/Runtime/src/main/kotlin/kotlinx/cinterop/Utils.kt: No such file or directory.</code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cr/nq/ek/crnqekwr9fheufvuxcc9ixhnsjc.png"></div><br><h2>  Cap√≠tulo cuatro  Vert√≠ t√© en tu t√© para que puedas beber t√© mientras bebes t√©. </h2><br>  Aqu√≠ es necesario decir c√≥mo funciona esa basura que hago. <br><br>  Escribe un DSL que describe la futura extensi√≥n de PHP, escribe c√≥digo K / N con la implementaci√≥n de funciones, clases y m√©todos, luego ejecuta <code>make</code> y, milagrosamente, obtiene una biblioteca preparada que se puede conectar a PHP. <br><br>  El montaje se puede dividir en 4 etapas: <br><br><ol><li>  Crear una capa entre C y K / N (el mismo <code>cinterop</code> ) </li><li>  Generaci√≥n de c√≥digo de extensi√≥n C </li><li>  Compilar una biblioteca con l√≥gica </li><li>  Compilar la biblioteca de destino </li></ol><br>  El objetivo es agregar la capacidad de crear instancias de una clase PHP en c√≥digo K / N.  Por ejemplo, para que la clase pueda definir el m√©todo <code>getInstance()</code> .  Y quiero hacerlo para que sea conveniente de usar. <br><br>  En C, este problema se resuelve una o dos veces. <br><br><pre> <code class="cpp hljs">zval *obj = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(zval)); object_init_ex(obj, myClass);</code> </pre> <br>  Parecer√≠a simple: <code>myClass</code> y transfi√©relo a K / N, pero aqu√≠ est√° <code>myClass</code> ... <br><br>  Pero <code>myClass</code> es una variable global del tipo <code>zend_class_entry*</code> , declarada en el c√≥digo C del proyecto y con un nombre desconocido de antemano. <br><br>  Cu√≠date las manos.  <code>myClass</code> compilar la biblioteca a partir del c√≥digo K / N, en el que habr√° una funci√≥n que necesita tener acceso a <code>myClass</code> , que se define en el c√≥digo C generado, pero no compilado, desde el cual se llamar√° a esta funci√≥n. <br><br>  Finalmente, la implementaci√≥n de esta funcionalidad llev√≥ a la adici√≥n de dos nuevos artefactos: <b>.h</b> y <b>.kt</b> en la etapa de generaci√≥n de c√≥digo, la complicaci√≥n de la etapa cinterop y el √©pico phakap, del que hablar√© al final. <br><br><h2>  Cap√≠tulo cinco  ¬øQu√© hay en mi nombre? </h2><br>  El cuento de por qu√©: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ArgumentType</span></span> { PHP_STRING, PHP_LONG, PHP_DOUBLE, PHP_NULL, ... }</code> </pre> <br>  mejor que: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArgumentType</span></span></span><span class="hljs-class"> {</span></span> STRING, LONG, DOUBLE, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... }</code> </pre> <br>  S√≠, ni siquiera hay necesidad de explicarlo.  Esto es en lo que <code>ArgumentType.NULL</code> convierte en el archivo de encabezado de la biblioteca Kotlin: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> extension_kt_kref_php_extension_dsl_ArgumentType (*get)(); <span class="hljs-comment"><span class="hljs-comment">/* enum entry for NULL. */</span></span> } <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre> <br>  Y as√≠ es como gcc reacciona a esto. <br><br><pre> <code class="hljs pgsql">/root/simpleExtension/phpmodule/extension_kt_api.h:<span class="hljs-number"><span class="hljs-number">113</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>: error: expected identifier <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'('</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-string"><span class="hljs-string">'void'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; ^</code> </pre><br>  La cortina!  Cuidado con los nombres. <br><br><h2>  El pen√∫ltimo cap√≠tulo.  No te alabar√°s a ti mismo, nadie lo alabar√°. </h2><br>  En general, he logrado mis objetivos.  Inmerso en el tema, el "marco" para escribir extensiones PHP en Kotlin Native, en general, est√° listo.  Queda por agregar algo, no la m√°s cr√≠tica, funcionalidad y pulido. <br><br>  El proyecto en s√≠ y, espero, buena documentaci√≥n para √©l, se puede ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en el github</a> . <br><br>  ¬øQu√© puedo decir sobre K / N?  Solo bueno  Escribir en √©l es un placer, y peque√±os bancos de arena y asperezas pueden atribuirse al hecho de que ni siquiera ha salido de la cuna :) <br><br><h2>  El ultimo capitulo.  Rayos del bien, sin comillas. </h2><br>  Y ahora, absolutamente en serio y con profundo respeto, quiero agradecer a los muchachos de JetBrains y a los residentes del canal suelto Kotlin Native.  Eres super! <br><br>  Y un agradecimiento especial a <b>Nicholas Igotti</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tn/gr/px/tngrpxjotuvwziojqifyaxff5-y.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d1/5r/sn/d15rsndzgsxzin-aeglanekvtv4.png"></div><br><h2>  Bono  Epic Fakap. </h2><br>  El contexto se describe en el cuarto cap√≠tulo. <br><br>  En realidad, cuando todo se agreg√≥ a un estado en el que se compil√≥ sin errores, surgi√≥ un problema: durante las pruebas, PHP se abri√≥ para m√≠ desde un lado completamente desconocido. <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># php -dextension=./phpmodule/modules/extension.so -r </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"var_dump(ExampleClass::getInstance());"</span></span></span><span class="hljs-meta"> *RECURSION* #</span></span></code> </pre><br>  "¬°Figas!"  - Pens√©, me met√≠ en el c√≥digo fuente de PHP y encontr√© esa pieza. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IS_OBJECT: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Z_IS_RECURSIVE_P(struc)) { PUTS(<span class="hljs-string"><span class="hljs-string">"*RECURSION*\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  Agregar depuraci√≥n: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%u"</span></span>, Z_IS_RECURSIVE_P(struc))</code> </pre> <br>  conducido a: <br><br><pre> <code class="hljs pgsql">undefined symbol: Z_IS_RECURSIVE_P <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">Unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  "¬°Figas!"  Pens√© de nuevo. <br><br>  En ese momento, cuando supuse mirar el php.h (7.1.8) realmente utilizado en el host de Linux, y no el que se extrajo del github del brunch maestro (7.3.x), pas√≥ un d√≠a.  Directamente avergonzado. <br><br>  Pero, como result√≥, no era una bobina. <br><br>  El c√≥digo de verificaci√≥n de recursi√≥n correcto, en todas las etapas de la vida del objeto que control√©, inform√≥ que todo deber√≠a funcionar.  Y esto significa que debes mirar cuidadosamente esos lugares que no controlo.  Hubo exactamente una de esas cosas, en la que mi objeto se devuelve a la funci√≥n <code>var_dump</code> <br><br><pre> <code class="cpp hljs">RETURN_OBJ( example_symbols()-&gt;kotlin.root.php.extension.proxy.objectToZval( example_symbols()-&gt;kotlin.root.exampleclass.getInstance(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>) ) )</code> </pre> <br>  Abra la macro RETURN_OBJ hasta el final.  ¬°Quita de los monitores nerviosa y embarazada! <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">1</span></span>) RETURN_OBJ(r) <span class="hljs-number"><span class="hljs-number">2</span></span>) { RETVAL_OBJ(r); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">3</span></span>) { ZVAL_OBJ(return_value, r); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); Z_OBJ_P(__z) = (r); Z_TYPE_INFO_P(__z) = IS_OBJECT_EX; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">5</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); Z_OBJ(*(__z)) = (r); Z_TYPE_INFO(*(__z)) = (IS_OBJECT | (IS_TYPE_REFCOUNTED &lt;&lt; Z_TYPE_FLAGS_SHIFT)); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">6</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); (*(__z)).value.obj = (r); (*(__z)).u1.type_info = (<span class="hljs-number"><span class="hljs-number">8</span></span> | ((<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  Aqu√≠ entonces me sent√≠ avergonzado por segunda vez.  Yo, completamente en mi ojo azul, <code>zval*</code> a donde <code>zend_object*</code> esperando y pas√© casi dos d√≠as buscando el error. <br><br>  ¬°Gracias a todos Kotlin!  :) <br><br>  PS.  Si hay un alma amable que lee mi torpe ingl√©s y corrige la documentaci√≥n, no habr√° l√≠mite para mi gratitud. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es423145/">https://habr.com/ru/post/es423145/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es423135/index.html">Feliz D√≠a del Programador: varios dise√±adores de robots educativos para ni√±os</a></li>
<li><a href="../es423137/index.html">Extensiones de navegador GitHub para aumentar su productividad.</a></li>
<li><a href="../es423139/index.html">Hole in the Fence, gerentes e ingenieros efectivos</a></li>
<li><a href="../es423141/index.html">Claude Shannon: c√≥mo un genio resuelve problemas</a></li>
<li><a href="../es423143/index.html">Octubre Slerm: Intensivo en Kubernetes</a></li>
<li><a href="../es423147/index.html">Sobre la estrategia y el formato de almacenamiento en la era Hadoop</a></li>
<li><a href="../es423149/index.html">Comparaci√≥n directa de los m√©todos de correcci√≥n de la miop√≠a con l√°ser o lo que paga al elegir ReLEx SMILE</a></li>
<li><a href="../es423151/index.html">Objetos globales en PHP</a></li>
<li><a href="../es423153/index.html">Gu√≠a de Node.js, Parte 2: JavaScript, V8, algunos trucos de desarrollo</a></li>
<li><a href="../es423155/index.html">Curso MIT "Seguridad de sistemas inform√°ticos". Lecci√≥n 8: Modelo de seguridad de red, parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>