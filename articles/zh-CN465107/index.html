<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏘️ 🧓🏾 📣 混沌工程：故意破坏的艺术。 第二部分 🤫 🆕 👌🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="注意事项 佩雷夫 ：本材料是AWS技术传播者Adrian Hornsby撰写的精彩文章的系列，这些文章着眼于简单明确地解释旨在减轻IT系统故障后果的实验的重要性。 



 “如果您未能准备计划，那么您计划失败。” -本杰明·富兰克林 
 在本系列文章的第一部分中 ，我介绍了混沌工程学的概念，并解释...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>混沌工程：故意破坏的艺术。 第二部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/465107/">  <i><b>注意事项</b></i>  <i><b>佩雷夫</b></i>  <i>：本材料是AWS技术传播者Adrian Hornsby撰写的精彩文章的系列，这些文章着眼于简单明确地解释旨在减轻IT系统故障后果的实验的重要性。</i> <br><br><img src="https://habrastorage.org/webt/tn/na/uh/tnnauhgdmrxlor2xjlgtars0tje.jpeg"><br><br><blockquote>  “如果您未能准备计划，那么您计划失败。”  -本杰明·富兰克林 </blockquote><br> 在本系列文章的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第一部分中</a> ，我介绍了混沌工程学的概念，并解释了混沌工程学如何在缺陷导致生产崩溃之前帮助发现和修复系统中的缺陷。 它还谈到了混沌工程如何促进组织内部积极的文化变革。 <br><br> 在第一部分的结尾，我答应谈论“将故障引入系统的工具和方法”。  head，我的脑子对此有自己的计划，在本文中，我将尝试回答人们最想提出的混乱工程问题： <b>首先要打破什么？</b> <a name="habracut"></a><br><br> 好问题！ 但是，他似乎并不在意这只熊猫... <br><br><img src="https://habrastorage.org/webt/hg/kt/qn/hgktqnmprfoiqlmweqc_uvzeb6e.gif"><br>  <i>不要惹乱熊猫！</i> <br><br>  <b>简短答案</b> ：针对请求路径上的关键服务。 <br><br>  <b>一个长而又可理解的答案</b> ：要了解从哪里开始进行混乱实验，请注意以下三个方面： <br><br><ol><li> 查看<b>故障历史</b>并确定模式； </li><li> 决定<b>关键的依赖</b> ; </li><li> 使用所谓的。  <b>过度自信效应</b> 。 </li></ol><br> 这很有趣，但是具有同样成功的这一部分可以称为<i>“自我知识和启蒙之旅”。</i> 在其中，我们将开始使用一些很酷的工具。 <br><br><h2>  1.答案在于过去 </h2><br> 如果您还记得的话，我在第一部分中介绍了错误更正（COE）的概念-我们用来分析错误的方法：技术，过程或组织中的失误-了解其原因并防止将来重复。 通常，这应该开始。 <br><br><blockquote>  “要了解现在，您需要了解过去。”  -卡尔·萨根（Karl Sagan） </blockquote><br> 查看失败的历史记录，将标签放入SOE或postmortem'ah中并进行分类。 确定通常会导致问题的常见模式，并针对每个SOE询问以下问题： <br><br>  <b>“是否可以预见到这一点，因此可以通过引入故障来防止？”</b> <br><br> 我回想起我职业生涯初期的一次失败。 如果我们进行几个简单的混乱实验，可以很容易地避免这种情况： <br><br><blockquote> 在正常情况下，后端实例响应来自<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">负载平衡器（ELB</a> ）的运行状况检查。  ELB使用这些检查将请求重定向到运行状况良好的实例。 当事实证明某个实例“不健康”时，ELB停止向其发送请求。 一次，成功的营销活动之后，流量增加，后端开始对健康检查的响应速度比平常慢。 应该说这些健康检查是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">深层的</a> ，即检查了依赖状态。 <br><br> 但是，有一阵子一切都井然有序。 <br><br> 然后，已经处于相当紧张的状况，其中一个实例开始执行ETL类别中的非关键性定期cron任务。 高流量和cronjob的结合使CPU利用率几乎提高了100％。 处理器超负荷进一步减慢了运行状况检查的响应速度，以至于ELB认为该实例遇到问题。 如预期的那样，平衡器停止向其分配流量，这进而导致该组中其余实例的负载增加。 <br><br> 突然，所有其他实例也开始无法通过运行状况检查。 <br><br> 启动新实例需要下载和安装软件包，并且花费的时间比自动缩放组中的ELB断开连接所需的时间长得多。 显然，整个过程很快就达到了临界点，申请失败了。 </blockquote><br> 然后我们永远了解以下几点： <br><br><ul><li> 要在长时间创建新实例时安装软件，最好优先采用不变方法和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Golden AMI</a> 。 </li><li> 在困难的情况下，应优先执行对健康检查和ELB的响应-您要做的最后一件事是使其余实例的生活变得困难。 </li><li> 健康检查的本地缓存（甚至几秒钟）很有帮助。 </li><li> 在困难的情况下，请勿运行cron任务和其他非关键过程-为最重要的任务节省资源。 </li><li> 自动缩放时，请使用较小的实例。 一组10个小副本要比4个大副本好； 如果发生故障，第一种情况是10％的流量分布在9个点上，第二种情况是25％的流量分布在三个点上。 </li></ul><br> 那么， <b>是否可以预见到这一点，因此可以通过引入问题来防止这种情况发生？</b> <br><br>  <b>是的</b> ，有几种方式。 <br><br> 首先，通过使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>stress-ng</code></a>或<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>cpuburn</code></a>工具模拟CPU的高利用率： <br><br><pre> <code class="bash hljs">❯ stress-ng --matrix 1 -t 60s</code> </pre> <br><img src="https://habrastorage.org/webt/d0/yt/if/d0ytifjietazwzk_l1odvcnmlfy.png"><br>  <i>压力</i> <br><br> 其次，使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>wrk</code></a>和其他类似实用程序重载实例： <br><br><pre> <code class="bash hljs">❯ wrk -t12 -c400 -d20s http://127.0.0.1/api/health</code> </pre> <br><img src="https://habrastorage.org/webt/zy/_2/wg/zy_2wgotuymrdqb15r4zv6b8d-s.png"><br><br> 这些实验相对简单，但是它们可以提供很好的思考机会，而不必经历真正失败的压力。 <br><br> 但是， <b>不要停在那里</b> 。 尝试在测试环境中重现故障，并检查对以下问题的回答：“ <b>是否可以预见到这种情况，因此可以通过引入故障来防止这种情况发生？”</b>  ”。 这是一个混沌实验中的微型混沌实验，用于测试假设，但从失败开始。 <br><br><img src="https://habrastorage.org/webt/d2/pz/6-/d2pz6-x-zv8k6kct4ffpm1tzw50.jpeg"><br>  <i>这是一个梦想，还是真的发生了？</i> <br><br> 因此，研究故障的历史记录，分析<b>COE</b> ，根据“损坏半径”（或更确切地说，根据受影响的客户数量）对它们进行标记和分类，然后寻找模式。 问问自己，是否可以通过引入问题来预见并避免这种情况。 检查您的答案。 <br><br> 然后切换到范围最大的最常见模式。 <br><br><h2>  2.构建依赖关系图 </h2><br> 花点时间考虑一下您的应用程序。 是否有一个清晰的依赖关系图？ 您知道发生故障时会对他们产生什么影响吗？ <br><br> 如果您对应用程序的代码不太熟悉或代码太大，则可能很难理解代码的功能及其依赖关系。 了解这些依赖性及其对应用程序和用户的可能影响对于了解从何处开始进行混乱工程至关重要：破坏半径最大的组件将是起点。 <br><br> 识别和记录依赖关系称为“ <i>依赖关系映射”</i> 。 通常，对于具有广泛代码库的应用程序，使用用于分析代码<i>（代码分析）</i>和检测<i>（工具）的工具来执行</i> 。 您还可以通过监视网络流量来构建地图。 <br><br> 但是，并不是所有的依赖项都是相同的（这使过程更加复杂）。 有些是<b>至关重要的</b> ，有些是<b>次要的</b> <i>（至少在理论上是这样，因为崩溃通常是由被视为非关键的依赖关系问题导致的）</i> 。 <br><br> 没有关键的依赖关系，服务将无法正常工作。 非严重的依赖关系“ <b>不应该</b> ”在发生故障时对服务产生影响。 要处理依赖关系，您需要对应用程序使用的API有清晰的了解。 它可能比听起来复杂得多-至少对于大型应用程序而言。 <br><br> 首先对所有API进行排序。 突出最<b>重要和</b>最<b>关键的</b> 。 从代码存储库中获取<b>依赖项</b> ，检查<b>连接日志</b> ，然后查看<b>文档</b> （当然，如果存在的话，否则将会遇到更多问题）。 使用工具进行<b>性能分析和跟踪</b> ，过滤外部调用。 <br><br> 您可以使用<code>netstat</code>程序，它是一个命令行实用程序，用于显示系统上所有网络连接（活动套接字）的列表。 例如，要显示所有当前连接，请键入： <br><br><pre> <code class="bash hljs">❯ netstat -a | more</code> </pre> <br><img src="https://habrastorage.org/webt/kc/4g/np/kc4gnphuxb_jw4yxdoyds5iwr4g.png"><br><br> 在AWS中，您可以使用流日志VPC-一种允许您收集有关去往或来自VPC上网络接口的IP流量的信息的方法。 这样的日志可以帮助完成其他任务，例如，找到某些流量为何未到达实例的答案。 <br><br> 您还可以使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWS X-Ray</a> 。  X-Ray使您可以在请求通过应用程序时获得详细的“端” <i>（端对端）</i>概述，还可以构建应用程序基本组件的映射。 如果需要识别依赖关系，这将非常方便。 <br><br><img src="https://habrastorage.org/webt/uz/5d/zs/uz5dzsxizx7kkw0kc2esx048zha.png"><br>  <i>AWS X-Ray控制台</i> <br><br> 网络依赖关系图只是部分解决方案。 是的，它显示了哪个应用程序与哪个应用程序关联，但是还存在其他依赖项。 <br><br> 许多应用程序使用DNS连接到依赖项，而其他应用程序可以使用服务发现机制，甚至可以使用配置文件中的硬编码IP地址（例如，在<code>/etc/hosts</code> ）。 <br><br> 例如，您可以使用<code>iptables</code>创建<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">黑洞DNS，</a>然后看看有什么坏处。 为此，请输入以下命令： <br><br><pre> <code class="bash hljs">❯ iptables -I OUTPUT -p udp --dport 53 -j REJECT -m comment --comment <span class="hljs-string"><span class="hljs-string">"Reject DNS"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/v4/57/8v/v4578vfcnxqj7zqqzujcz_kruhm.png"><br>  <i>黑洞DNS</i> <br><br> 如果您在<code>/etc/hosts</code>或其他配置文件中找不到您一无所知的IP地址（是的，不幸的是，这种情况发生了）， <code>iptables</code>可以再次解决。 假设您找到<code>8.8.8.8</code> ，却不知道这是Google的公共DNS服务器的地址。 使用<code>iptables</code>可以使用以下命令关闭到该地址的传入和传出流量： <br><br><pre> <code class="bash hljs">❯ iptables -A INPUT -s 8.8.8.8 -j DROP -m comment --comment <span class="hljs-string"><span class="hljs-string">"Reject from 8.8.8.8"</span></span> ❯ iptables -A OUTPUT -d 8.8.8.8 -j DROP -m comment --comment <span class="hljs-string"><span class="hljs-string">"Reject to 8.8.8.8"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/xc/-q/sw/xc-qswdeohmrg2885g4cmgwat-8.png"><br>  <i>关闭访问</i> <br><br> 第一条规则会丢弃来自Google的公共DNS的所有数据包： <code>ping</code>有效，但不会返回数据包。 第二条规则会丢弃所有来自您系统的，朝向Google的公共DNS方向的数据包-响应<code>ping</code> <i>操作，</i>我们将<i>拒绝“操作”</i> 。 <br><br>  <i>注意：在这种情况下，最好使用<code>whois 8.8.8.8</code> ，但这只是一个例子。</i> <br><br> 由于使用TCP和UDP的所有内容实际上都取决于IP，因此您甚至可以更深入地了解它。 在大多数情况下，IP与ARP绑定。 不要忘记防火墙... <br><br><img src="https://habrastorage.org/webt/k7/rw/mp/k7rwmpx4rrj3-pbwpbbh3ivrzuk.png"><br>  <i>如果您选择红色药丸，您将留在仙境，我将向您展示兔子洞的深度”</i> <br><br> 一种更激进的方法是逐一<b>关闭</b>汽车，看看发生了什么……成为“混乱的猴子”。 当然，许多生产系统并不是针对这种粗暴的攻击而设计的，但至少可以在测试环境中进行尝试。 <br><br> 建立依赖关系图通常是一项很长的工作。 我最近与一位客户交谈，我花了近两年的时间开发了一种工具，该工具以半自动模式生成了数百个微服务和团队的依赖关系图。 <br><br> 但是，结果非常有趣且有用。 您将学到很多有关系统，其依赖性和操作的知识。 再次，请耐心：旅程本身是至关重要的。 <br><br><h2>  3.当心傲慢 </h2><br><blockquote>  “任何梦想的人都相信这一点。”  -妖怪 </blockquote><br> 您听说过<b>过度自信</b>的<b>后果</b>吗？ <br><br> 根据Wikipedia的说法，过度自信的后果是“一种认知失真，其中一个人对自己的行为和决策的信心远远高于这些判断的客观准确性，尤其是在信心水平相对较高时。” <br><br><img src="https://habrastorage.org/webt/vi/hp/4d/vihp4ddzqlozpqxsqk61y3p0lwi.png"><br>  <i>基于本能和经验...</i> <br><br> 根据我自己的经验，我可以说这种失真是从哪里开始进行混沌工程的一个很好的暗示。 <br><br> 当心自信的操作员： <br><br><blockquote> 查理：“这件事已经五年没倒了，一切都很好！” <br> 失败：“等等……我会很快！” </blockquote><br> 由于各种因素影响的自信心造成的偏见是一种阴险甚至危险的事情。 当团队成员将自己的灵魂投入某种技术或花费大量时间进行“修复”时，尤其如此。 <br><br><h2> 总结一下 </h2><br> 寻找混沌工程的起点总是会产生比预期更多的结果，而开始四处走动的团队却忽视了（混沌） <b>工程</b>更全球化和更有趣的本质- <b>科学方法</b>的创造性应用以及设计，开发的<b>经验证据</b> ，（软件）系统的运行，维护和改进。 <br><br> 至此，第二部分结束。 请发表评论，分享意见或只是鼓掌欢迎。  <s>在下一部分中，我将<b>真正</b>研究引入系统故障的工具和技术。</s>  <s>直到-再见！</s>  <b>更新</b> （12月19日）： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第三部分</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">翻译已</a>可用。 <br><br><h2> 译者的PS </h2><br> 另请参阅我们的博客： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">混沌工程：故意破坏的艺术。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第1部分</a> ” <i>（关于混沌工程的概念以及如何在导致生产失败之前发现/修复问题）</i> ； </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">混沌工程：故意破坏的艺术。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第3部分</a> ” <i>（混乱的工程实践，包括故障介绍和为此的现有工具）</i> ； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes如何提供高可用性</a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">监控和Kubernetes（审查和视频报告）</a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在Kubernetes中进行了kube-proxy和主机不可访问性的实验</a> 。” </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN465107/">https://habr.com/ru/post/zh-CN465107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN465093/index.html">机器学习技巧-在Keras中使用多种模型</a></li>
<li><a href="../zh-CN465095/index.html">教育展：面向数字专业初学者的讲座和竞赛</a></li>
<li><a href="../zh-CN465097/index.html">Java中联合类型的实现</a></li>
<li><a href="../zh-CN465101/index.html">您的完美测试员</a></li>
<li><a href="../zh-CN465103/index.html">如何成为网络律师</a></li>
<li><a href="../zh-CN465109/index.html">功课：Pebaro的儿童工具包</a></li>
<li><a href="../zh-CN465111/index.html">完全匿名：我们保护家用路由器</a></li>
<li><a href="../zh-CN465113/index.html">招聘中。 2019年寒冷的夏天</a></li>
<li><a href="../zh-CN465119/index.html">您睡不着编码：如何组建团队并为黑客马拉松做准备？</a></li>
<li><a href="../zh-CN465121/index.html">像杜罗夫一样：加勒比海的“黄金护照”和离岸投降的初创企业</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>