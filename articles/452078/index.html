<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìØ üë¥üèª üëçüèø Reserva de Kubernetes: existe üîó üëâüèæ üï∫üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mi nombre es Sergey, soy de ITSumma y quiero contarte c√≥mo abordamos la reserva en Kubernetes. Recientemente, he estado haciendo mucho trabajo de ases...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reserva de Kubernetes: existe</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/452078/">  Mi nombre es Sergey, soy de ITSumma y quiero contarte c√≥mo abordamos la reserva en Kubernetes.  Recientemente, he estado haciendo mucho trabajo de asesoramiento sobre la implementaci√≥n de una variedad de soluciones de desarrollo para varios equipos, y, en particular, trabajo de cerca en proyectos que utilizan K8.  En la conferencia Uptime day 4, que se dedic√≥ a la redundancia en arquitecturas complejas, hice una presentaci√≥n sobre un cubo redundante, y aqu√≠ est√° su recuento gratuito.  Solo advertir√© de antemano que √©l no es una gu√≠a directa de acci√≥n, sino m√°s bien una generalizaci√≥n de pensamientos sobre este tema. <br><br><img src="https://habrastorage.org/webt/fi/pj/ox/fipjoxmwx-hrd0tvm0_bvgjaa-e.jpeg"><br><br>  En principio, el monitoreo y la redundancia son las dos herramientas principales para aumentar la capacidad de recuperaci√≥n de cualquier proyecto.  Pero en el cubo, todo se equilibra por s√≠ solo, usted dice, todo se escala por s√≠ mismo, y si algo sucede, se elevar√° por s√≠ mismo ... Es decir, durante el primer estudio superficial del tema, Internet me respondi√≥ la pregunta "¬øC√≥mo funciona el respaldo de K8?" ? "  Mucha gente piensa que un cubo es una cosa tan m√°gica que elimina todos los problemas de infraestructura y hace que el proyecto nunca se caiga.  Pero ... el mundo no es lo que parece. <br><a name="habracut"></a><br>  ¬øC√≥mo abordamos el proceso de copia de seguridad antes?  Ten√≠amos plataformas id√©nticas para la colocaci√≥n: o eran m√°quinas virtuales o servidores de hierro, a los que aplicamos tres pr√°cticas b√°sicas: <br><br><ol><li>  sincronizaci√≥n de c√≥digo y est√°tica </li><li>  sincronizaci√≥n de configuraci√≥n </li><li>  replicaci√≥n de bases de datos </li></ol><br>  Y listo: en cualquier momento cambiamos al sitio de reserva, todos estamos felices, nos levantamos, no estamos de acuerdo. <br><br><img src="https://habrastorage.org/webt/mw/ym/zw/mwymzwrfdl9vsaf_hg-wm3wvphm.jpeg"><br><br>  ¬øY qu√© nos ofrecen para aumentar la disponibilidad constante de nuestra aplicaci√≥n kubernetes?  Lo primero que dice la documentaci√≥n no oficial es poner muchas m√°quinas, hacer muchos maestros: su n√∫mero debe satisfacer las condiciones para lograr un qu√≥rum dentro del cl√∫ster, y para que etcd, api, MC, planificador se generen en cada uno de los maestros ... Y, al parecer, todo est√° bien : cuando varios nodos de trabajo o maestros fallan, nuestro cl√∫ster se reequilibrar√° y la aplicaci√≥n continuar√° funcionando.  ¬°Parece magia otra vez!  Pero a menudo nuestro cl√∫ster se encuentra dentro del mismo centro de datos y esto puede causar ciertas preguntas.  ¬øQu√© pasa si una excavadora lleg√≥ y desenterr√≥ un cable, cay√≥ un rayo y hubo una inundaci√≥n universal?  Todo est√° cubierto, nuestro grupo ya no existe.  ¬øC√≥mo abordar la reserva teniendo en cuenta este lado del problema? <br><br>  En primer lugar, debe tener otro cl√∫ster en la reserva activa, es decir, un cl√∫ster al que pueda cambiar en cualquier momento.  Adem√°s, desde el punto de vista del cubo, las infraestructuras deben ser completamente id√©nticas.  Es decir, si hay complementos no est√°ndar para trabajar con el sistema de archivos, soluciones personalizadas para el ingreso, deben ser completamente id√©nticos en sus dos (o tres, o diez, hay suficiente dinero y la fuerza de los administradores).  Es necesario definir claramente dos conjuntos de aplicaciones (despliegue'ov, statefulset'ov, daemonset'ov, cronjob'ov, etc.): cu√°les de ellas pueden trabajar constantemente en una reserva y cu√°les son mejores para no comenzar antes del cambio directo. <br><br>  Entonces, ¬ønuestro grupo de respaldo debe ser completamente id√©ntico a nuestro grupo de combate?  No  Anteriormente, en el marco de trabajar con proyectos monol√≠ticos, con infraestructura de hierro, manten√≠amos un entorno casi completamente id√©ntico, pero en el marco del cubo, creo que esto no deber√≠a ser as√≠.  Veamos por qu√©. <br><br>  Por ejemplo, comencemos con las entidades b√°sicas de kubernetes, implementaciones, que deben ser id√©nticas.  Deben lanzarse aplicaciones que puedan interceptar el procesamiento del tr√°fico en cualquier momento y permitir que nuestro proyecto contin√∫e vivo.  Si estamos hablando de archivos de configuraci√≥n, entonces debemos mirar aqu√≠ si deber√≠an ser id√©nticos o no.  Es decir, si nosotros, personas inteligentes, no usamos ninguna sustancia prohibida y no mantenemos la base en K8, entonces debemos tener configuraciones de acceso en los mapas de configuraci√≥n para la base de combate (cuyo proceso de respaldo se construye por separado).  En consecuencia, para garantizar el acceso a la instancia de la base de datos de respaldo, debemos tener un archivo de configuraci√≥n separado (mapa de configuraci√≥n).  Exactamente de la misma manera que trabajamos con secretos: contrase√±as para acceder a la base de datos, claves de API;  en cualquier momento, ya sea un secreto de combate o uno de reserva, puede trabajar con nosotros.  En total, ya tenemos dos entidades kubernetes cuyas versiones de respaldo no deber√≠an ser id√©nticas a las de combate.  La siguiente entidad en la que vale la pena detenerse es cronjob.  ¬°Cronjobs en reserva no debe ser id√©ntico al conjunto de clusters de producci√≥n de cronjob!  Si levantamos el cl√∫ster de respaldo y lo levantamos completamente con todo el trabajo cron habilitado, entonces, por ejemplo, las personas recibir√°n dos cartas suyas al mismo tiempo en lugar de una.  O alg√∫n tipo de sincronizaci√≥n de datos con fuentes externas tendr√° lugar dos veces, respectivamente, comenzamos a lastimar, llorar, gritar y maldecir. <br><br><img src="https://habrastorage.org/webt/m3/n2/yx/m3n2yxmvocsvsfiavdmevq4vx18.jpeg"><br><br>  Pero, ¬øc√≥mo nos ofrecen las personas de Internet para organizar un cl√∫ster de respaldo?  La segunda respuesta m√°s popular despu√©s de "¬øpor qu√©?"  - uso de la Federaci√≥n de Kubernetes. <br><br>  Que es esto  Esto es, digamos, un gran meta cluster.  Si imaginamos la arquitectura del cubo, donde tenemos un maestro, varios nodos, desde el punto de vista de la federaci√≥n, tambi√©n tenemos un maestro y varios nodos, solo cada nodo es un cl√∫ster separado.  Es decir, trabajamos con las mismas entidades, con las mismas primitivas que con un √∫nico cubo, pero giramos y giramos no nuestras m√°quinas f√≠sicas, sino grupos completos.  En el marco de la federaci√≥n, estamos en completa sincronizaci√≥n de recursos federales de padres a descendientes.  Por ejemplo, si lanzamos alguna implementaci√≥n a trav√©s de la federaci√≥n, se implementar√° en cada uno de nuestros grupos subsidiarios.  Si tomamos un mapa de configuraci√≥n, el secreto es llevarlo a la federaci√≥n; se extender√° a todos nuestros grupos secundarios;  Al mismo tiempo, la federaci√≥n nos permite personalizar nuestros recursos para los ni√±os.  Es decir, tomamos un mapa de configuraci√≥n, lo implementamos a trav√©s de la federaci√≥n y luego, si necesitamos arreglar algo en grupos espec√≠ficos, vamos a editar en un grupo separado, y este cambio no se sincronizar√° en ning√∫n lado. <br><br>  La Federaci√≥n Kubernetes no es hace mucho tiempo una herramienta existente, y no es compatible con el conjunto completo de recursos que K8s mismo proporciona: en el momento de la publicaci√≥n de una de las primeras versiones de la documentaci√≥n, se refer√≠a a admitir solo mapas de configuraci√≥n, implementaci√≥n para conjunto de r√©plicas, ingreso.  Los secretos no eran compatibles, el trabajo con volumen tampoco era compatible.  Conjunto demasiado limitado.  Especialmente si nos gusta divertirnos, por ejemplo, a trav√©s de la definici√≥n personalizada de recursos para transferir nuestros propios recursos a los kubernetes, no los empujaremos a la federaci√≥n.  Es decir, como si fuera ... una decisi√≥n muy similar a la verdad, pero nos hace peri√≥dicamente pegarnos un tiro en el pie.  Por otro lado, la federaci√≥n le permite administrar de manera flexible nuestro conjunto de r√©plicas.  Por ejemplo, queremos que se inicien 10 r√©plicas de nuestra aplicaci√≥n; de manera predeterminada, la federaci√≥n dividir√° este n√∫mero proporcionalmente entre el n√∫mero de cl√∫steres.  ¬°Y todo esto tambi√©n se puede configurar!  Es decir, puede especificar que necesita mantener 6 r√©plicas de nuestra aplicaci√≥n en el cl√∫ster de combate, y solo 4 r√©plicas de nuestra aplicaci√≥n en el cl√∫ster de respaldo, para ahorrar recursos o para su propio entretenimiento.  Lo cual tambi√©n es bastante conveniente.  Pero con la federaci√≥n tenemos que usar algunas soluciones nuevas, terminar algo sobre la marcha y obligarnos a pensar un poco m√°s ... <br><br>  ¬øEs posible abordar el proceso de reservar un cubo de alguna manera m√°s simple?  ¬øQu√© herramientas tenemos en absoluto? <br><br>  En primer lugar, siempre tenemos alg√∫n tipo de sistema ci / cd, es decir, no damos vueltas manualmente, no escribimos crear / aplicar en los servidores.  El sistema genera yaml'ics para nuestros contenedores. <br><br>  En segundo lugar, hay varios grupos, tenemos uno o varios registros (si somos inteligentes), que tambi√©n tomamos y reservamos.  Y hay una maravillosa utilidad kubectl que puede funcionar con m√∫ltiples cl√∫steres simult√°neamente. <br><br><img src="https://habrastorage.org/webt/vs/ib/ed/vsibeda9uobcn8jtrfztjkln3ag.jpeg"><br><br>  Entonces: en mi opini√≥n, la soluci√≥n m√°s simple y correcta para construir un cl√∫ster de respaldo es una implementaci√≥n paralela primitiva.  Hay alg√∫n tipo de tuber√≠a en el sistema ci / cd;  Primero construimos nuestros contenedores, probamos y desarrollamos aplicaciones a trav√©s de kubectl a varios cl√∫steres independientes.  Podemos construir c√°lculos simult√°neos en varios grupos.  En consecuencia, tambi√©n decidimos entregar configuraciones en esta etapa.  Puedes predefinir el conjunto de configuraciones para nuestro cl√∫ster de combate, el conjunto de configuraciones para el cl√∫ster de respaldo y en el nivel ci / cd del sistema, pasar el pro-ambiente al pro-cl√∫ster, el entorno de respaldo al cl√∫ster de respaldo.  En comparaci√≥n con la federaci√≥n, no es necesario ir despu√©s de definir un recurso federal para cada grupo de ni√±os y redefinir algo.  Hicimos esto de antemano.  Qu√© buenos compa√±eros somos. <br><br>  Pero ... hay ... escrib√≠, existe la "ra√≠z de todo mal", pero en realidad hay dos de ellos.  El primero es el sistema de archivos.  Hay alg√∫n tipo de PV, o usamos almacenamiento externo.  Si almacenamos archivos dentro del cl√∫ster, entonces debemos seguir las viejas pr√°cticas que quedaron desde el momento de las infraestructuras de hierro: por ejemplo, sincronizar con lsync.  Bueno, o cualquier otra muleta que prefieras personalmente.  Rodamos todo a otros autos y vivimos. <br><br>  En segundo lugar, y, de hecho, un obst√°culo a√∫n m√°s importante es la base de datos.  Si somos personas inteligentes y no mantenemos la base de datos en el cubo, entonces el proceso de hacer una copia de seguridad de los datos de acuerdo con el mismo esquema anterior es la replicaci√≥n maestro-esclavo, luego, al cambiar, nos pondremos al d√≠a con la r√©plica y viviremos bien.  Pero si mantenemos nuestra base de datos dentro del cl√∫ster, entonces, en principio, hay muchas soluciones listas para organizar la misma r√©plica maestro-esclavo, muchas soluciones para elevar la base de datos dentro del cubo. <br>  Ya se han le√≠do mil millones de informes sobre copias de seguridad de bases de datos, se han escrito mil millones de art√≠culos, de hecho, no se necesita nada nuevo aqu√≠.  En general, sigue tu sue√±o, vive como quieras, inventa algunas muletas complicadas tambi√©n, pero aseg√∫rate de pensar en c√≥mo reservar todo esto. <br><br>  Y ahora sobre c√≥mo, en principio, tendremos el proceso de cambiar al sitio de respaldo en caso de incendio.  Primero, implementamos aplicaciones sin estado en paralelo.  No afectan la l√≥gica de negocios de nuestras aplicaciones, nuestro proyecto, podemos mantener constantemente dos conjuntos de aplicaciones en ejecuci√≥n y pueden comenzar a recibir tr√°fico.  Es muy importante en el proceso de cambiar al sitio de respaldo para ver definitivamente si las configuraciones deben redefinirse  Por ejemplo, tenemos un cl√∫ster de kubernetes, hay un cl√∫ster de kubernetes de respaldo, hay una base de datos maestra externa y hay una base de datos maestra de respaldo.  Tenemos cuatro opciones sobre c√≥mo estas aplicaciones en el producto pueden comenzar a interactuar entre s√≠.  Nuestra base puede cambiar, y resulta que necesitamos cambiar el tr√°fico a la nueva base en el cl√∫ster prod, o podemos obtener el cl√∫ster y movernos a la reserva, pero seguimos trabajando con la base pro, bueno, la tercera opci√≥n, cuando la tenemos , luego se arruina, y cambiamos ambas aplicaciones, redefinimos nuestra configuraci√≥n para que las nuevas aplicaciones ya funcionen con la nueva base de datos. <br><br>  Bueno, en realidad, ¬øqu√© conclusiones se pueden sacar de todo esto? <br><br><img src="https://habrastorage.org/webt/rl/81/0a/rl810a1jyyc78gkz0cop0gjzhma.jpeg"><br><br>  La primera conclusi√≥n: vivir bien con una reserva.  Pero caro  Pero idealmente, viviendo con m√°s de una reserva.  Idealmente, generalmente necesita vivir con varias reservas.  En primer lugar, la reserva debe estar al menos no en un DC, y en segundo lugar, al menos, en otro hoster.  A menudo suced√≠a, y en mi pr√°ctica lo fue.  Desafortunadamente, no puedo nombrar los proyectos, justo cuando hubo un incendio en el centro de datos ... Estoy as√≠: ¬°nos estamos cambiando a la reserva!  Y los servidores de respaldo en el mismo bastidor estaban ... <br><br>  O imagine que Amazon fue prohibido en Rusia (y eso fue).  Y todo: ¬øla sensaci√≥n del hecho de que en otro Amazonas se encuentra nuestra reserva?  Tampoco est√° disponible.  Entonces repito: mantenemos la reserva, al menos, en otro DC, y preferiblemente con otro host. <br><br>  La segunda conclusi√≥n: si su aplicaci√≥n se comunica con algunas fuentes externas (puede ser una base de datos o una API externa), aseg√∫rese de definirla como un servicio con un Endpoint externo para que no tenga que volver a repararla en el momento del cambio 15 de sus aplicaciones que tocan la misma base.  Defina la base de datos como un servicio separado, util√≠cela como si estuviera dentro de su cl√∫ster: si tiene una base de datos, cambie la direcci√≥n IP en un lugar y contin√∫e viviendo felizmente. <br><br>  Y finalmente: me encanta el "cubo", as√≠ como los experimentos con √©l.  Tambi√©n me gusta compartir los resultados de estos experimentos y, en general, mi experiencia personal.  Por lo tanto, grab√© una serie de seminarios web sobre K8, bien en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nuestro canal de YouTube</a> para m√°s detalles. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452078/">https://habr.com/ru/post/452078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452066/index.html">Excelsior JET suspende el desarrollo de su compilador AOT despu√©s de 18 a√±os de trabajo</a></li>
<li><a href="../452068/index.html">12. Check Point Getting Started R80.20. Registros e informes</a></li>
<li><a href="../452072/index.html">Implementamos CircularRevealAnimation en Flutter y simult√°neamente publicamos la biblioteca en pub.dev</a></li>
<li><a href="../452074/index.html">El primer juego sobre la unidad o lo que me llev√≥ seis meses.</a></li>
<li><a href="../452076/index.html">Rompiendo el navegador UC</a></li>
<li><a href="../452082/index.html">Flujo flexible de actualizaciones en la aplicaci√≥n: acelerar el proceso de actualizaci√≥n de aplicaciones en Android</a></li>
<li><a href="../452086/index.html">Qu√© hay en mi p√≠xel para ti: crear nanop√≠xeles usando metasuperficies de plasm√≥n</a></li>
<li><a href="../452088/index.html">Reconocimiento de carreteras mediante segmentaci√≥n sem√°ntica.</a></li>
<li><a href="../452090/index.html">Crear un generador de rompecabezas procesal</a></li>
<li><a href="../452092/index.html">Actualizaciones en la aplicaci√≥n: acelerar las actualizaciones de aplicaciones de Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>