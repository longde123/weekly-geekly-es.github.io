<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßÄ üß¢ ‚ôüÔ∏è Lutter pour les ressources, partie 5: Partir de z√©ro ü§® üë©üèª‚Äçüíº ü¶ã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous continuons d'√©tudier les cgroups. Dans Red Hat Enterprise Linux 7, ils sont activ√©s par d√©faut, car il utilise systemd, et lui, √† son tour, a d√©j...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lutter pour les ressources, partie 5: Partir de z√©ro</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redhatrussia/blog/429064/"> Nous continuons d'√©tudier les cgroups.  Dans Red Hat Enterprise Linux 7, ils sont activ√©s par d√©faut, car il utilise systemd, et lui, √† son tour, a d√©j√† des groupes de contr√¥le int√©gr√©s.  Avec Red Hat, Red Hat Enterprise Linux 6 est un peu diff√©rent.  En fait, les contr√¥leurs cgroups √©taient initialement l√†, mais cette version a √©t√© publi√©e, rappelez-vous en janvier 2010, c'est-√†-dire il y a quelques si√®cles en termes d'ann√©es informatiques. <br><br><img src="https://habrastorage.org/webt/7y/lx/mw/7ylxmwyn3vgxxrj7b6utthzftwk.png" width="100%"><br><br>  Cependant, les cgroups dans Red Hat Enterprise Linux 6 sont capables de bien plus encore aujourd'hui, ce que nous allons illustrer aujourd'hui. <br><a name="habracut"></a><br>  Analysons les capacit√©s des cgroups dans Red Hat Enterprise Linux 6 √† l'aide d'un exemple purement hypoth√©tique, enti√®rement bas√© sur des √©v√©nements r√©els.  Mais pour commencer, par tradition, une petite digression. <br><br>  Il n'y a jamais eu autant de probl√®mes de s√©curit√© informatique qu'aujourd'hui.  Ce n'est pas surprenant, car aujourd'hui, non seulement tous les ordinateurs et t√©l√©phones sont connect√©s au r√©seau, mais aussi des r√©frig√©rateurs, des aspirateurs et un tas d'autres choses - la port√©e des menaces du r√©seau est tout simplement immense.  Et la lutte contre ces menaces, en r√®gle g√©n√©rale, commence imm√©diatement sur tous les fronts.  Installation rapide des correctifs de s√©curit√©?  Oui, bien s√ªr!  Renforcer la s√©curit√© du syst√®me - pare-feu, SELinux, authentification intelligente, est-ce tout?  Bien s√ªr!  Scanners antivirus sur les machines Linux?  Eh bien, comment dire ... <br><br>  Sur les machines Linux, les analyseurs antivirus font parfois plus de mal que de bien.  Cependant, les agents de s√©curit√© ont leurs propres raisons, et ils vous demandent souvent d'ex√©cuter des analyses antivirus r√©guli√®rement, sans vraiment penser √† leur solidit√© d'un point de vue technique.  Et c'est une r√©alit√© √† laquelle on doit faire face et √† laquelle, t√¥t ou tard, presque n'importe quel sp√©cialiste informatique doit faire face. <br><br>  Le deuxi√®me point est que Red Hat Enterprise Linux 7 est bien s√ªr √† la mode, avanc√© et cool, mais beaucoup utilisent toujours Red Hat Enterprise Linux 6 et ne pensent pas √† le refuser.  En fait, c'est pourquoi les gens choisissent Red Hat - vous pouvez vous asseoir sur la m√™me version pendant des ann√©es et avoir toujours tous les derniers correctifs, mises √† jour et support. <br><br>  Revenons √† notre exemple ... Imaginez qu'il y a un gars du nom de Jerry.  Jerry travaille dans un grand bureau et est responsable du serveur Red Hat Enterprise Linux 6. Il est enti√®rement satisfait de la fa√ßon dont ils fonctionnent, et il n'a pas besoin de nouveaux probl√®mes ni de probl√®mes. <br><br>  Mais ensuite, les gars du service de s√©curit√© d√©cident que sur tous ses serveurs, vous devez mettre une chose appel√©e ScanIT.  Et puisque cette chose v√©rifiera p√©riodiquement les disques et la m√©moire pour les virus et autres logiciels malveillants, elle a besoin d'un acc√®s root complet. <br><br>  Jerry soupire, pose sa guitare et va mettre ScanIT sur une machine de test.  Il se r√©v√®le assez rapidement ceci: <br><br><ul><li>  Lors d'une analyse antivirus, scanit (c'est un script pour d√©marrer le processus) consomme tout le temps processeur qu'il peut atteindre.  Et cela affecte tr√®s mal le travail de la machine de test - une fois que Jerry ne pouvait m√™me pas l'atteindre sur ssh. </li><li>  De plus, le processus scanit consomme de la m√©moire de temps en temps comme s'il √©tait en lui-m√™me.  En cons√©quence, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OOM Killer</a> se r√©veille et commence √† tuer tous les processus autres que scanit lui-m√™me. </li></ul><br>  En g√©n√©ral, quelque chose doit √™tre fait avec cela. <br><br>  Jerry prend la guitare et, jouant le Grateful Dead, commence √† r√©fl√©chir.  Assez rapidement, il lui vint √† l'esprit que les m√™mes groupes de contr√¥le de Red Hat Enterprise Linux 7 pourraient probablement aider ici, √† propos desquels un ami nomm√© Alex r√©sonna dans ses oreilles.  Jerry √©teint √† nouveau sa guitare et se met √† lire les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">quais</a> envoy√©s par Alex <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur Red Hat Enterprise Linux 6</a> .  Il s'av√®re que la premi√®re chose dont il a besoin est libcgroup. <br><br>  Il n'y a pas de libcgroup sur la machine de test, donc Jerry commence √† l'installer: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-7/wt/dk/-7wtdk4uuvnhwypqp9oblrgtx60.png"></div><br><br>  En outre, Jerry comprend deux services qui sont n√©cessaires pour le travail des groupes de contr√¥le permanents (persistants): <br><br><ul><li>  cgconfig - fournit une interface plus ou moins simple pour travailler avec des arbres de groupe de contr√¥le.  Jerry pourrait certainement monter et configurer des groupes de contr√¥le manuellement, mais pourquoi, si vous pouvez gagner du temps? </li><li>  cgred - cette chose est un moteur de r√®gles cgroup: quand un processus d√©marre, ce service le place dans l'un ou l'autre cgroup selon les r√®gles sp√©cifi√©es. </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/i-/4c/gai-4cqblbowiy66etcfkm9wxlc.png"></div><br><br>  Apr√®s avoir install√© et configur√© tout cela, Jerry peut enfin proc√©der directement au probl√®me lui-m√™me.  Apr√®s m√ªre r√©flexion, il prend la d√©cision suivante: <br><br><ul><li>  scanit et ses processus enfants ne devraient pas consommer plus de 20% des ressources CPU.  En fait, encore moins - pas plus de 20% des ressources d'un c≈ìur de processeur, m√™me sur une machine multic≈ìur.  Dans les groupes de contr√¥le, cela se fait en utilisant des quotas CPU. </li><li>  En ce qui concerne la m√©moire, scanit et ses processus enfants ne devraient pas consommer plus de 512 Mo de m√©moire syst√®me.  S'ils franchissent cette ligne, le syst√®me devrait les tuer, et pas d'autres processus. </li></ul><br><h3>  Pas besoin de me dire quoi faire! </h3><br>  Jerry devra g√©rer deux ensembles de fichiers de configuration: <br><ul><li>  /etc/cgconfig.conf - G√©n√©r√© automatiquement lors de l'installation de libcgroup. </li><li>  /etc/cgrules.conf - contient un ensemble de r√®gles d'ensemble de r√®gles, selon lesquelles cgred trie les processus en cours d'ex√©cution par groupes de cgroups. </li></ul><br>  Voici √† quoi ressemble le fichier cgconfig.conf par d√©faut: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jk/7-/ie/jk7-ie0pclu29d7uourgo6mjq6c.png"></div><br><br>  Jerry aurait pu lui apporter directement les modifications n√©cessaires, mais il est pr√©f√©rable d'utiliser des fichiers de configuration pour cela.  Comment √ßa marche?  Si vous placez (eng. Drop-in - drop) dans le dossier /etc/cgconfig.d n'importe quel fichier avec l'extension .conf, le syst√®me le traitera et apportera les modifications appropri√©es √† la configuration.  C'est pratique car vous pouvez cr√©er des drop-ins pour diff√©rentes t√¢ches et les ajouter ou les supprimer de la configuration en utilisant les outils que vous pr√©f√©rez (par exemple, Ansible, eh bien, c'est toujours un blog Red Hat). <br><br>  Jerry cr√©e d'abord un fichier de d√©p√¥t pour le CPU: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/li/w6/8u/liw68uvhsmfnz2dwet4g_9rfmhs.png"></div><br><br>  Nous regardons ce que nous avons ici et comment cela fonctionne. <br><br>  Le mot-cl√© group d√©finit simplement le nom du nouveau cgroup, dans notre cas, scanit.  √Ä l'int√©rieur des accolades, nous sp√©cifions les contr√¥les cgroup que nous voulons utiliser.  Ici, cpu.cfs_period_us et cpu.cfs_quota_us, ils vous permettent de d√©finir les limites appropri√©es dans Completely Fair Scheduler, le planificateur de noyau utilis√© par d√©faut dans Red Hat Enterprise Linux 6. Voyons ce qui est √©crit √† leur sujet dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Guide de gestion des ressources Red Hat Enterprise Linux 6</a> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wr/jp/zx/wrjpzxiksqg-3eos3ammagjg_di.png"></div><br><br>  En d'autres termes, Jerry a √©crit ceci dans son drop-in: ¬´Pour chaque processus li√© √† cgroup nomm√© scanit, v√©rifiez une fois par seconde la quantit√© de ressources CPU allou√©es.  Si la dur√©e totale du processeur pour tous les processus de ce groupe est sup√©rieure √† 200 000 millisecondes, arr√™tez compl√®tement de donner du temps processeur √† ces processus. "  Eh bien, c'est-√†-dire √† allouer √† tous les processus du groupe de contr√¥le scanit, ainsi qu'√† leurs processus enfants, au total pas plus de 20% du temps processeur. <br><br>  Apr√®s avoir red√©marr√© cgconfig, le serveur mettra √† jour la configuration, et si vous entrez dans le syst√®me de fichiers, nous verrons que scanit est maintenant situ√© dans le r√©pertoire du contr√¥leur CPU: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2u/is/z9/2uisz9gmmcpjaaqi7zjgauw-pwa.png"></div><br><br>  Bien s√ªr, c'est bien, mais nous devons toujours pousser scanit lui-m√™me dans ce groupe de contr√¥le.  Crged est utile ici, par d√©faut, il ressemble √† ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sm/-d/t5/sm-dt5oeb5xqypbyfgdytjagrci.png"></div><br><br>  L'utilisation de ce fichier est plus ou moins simple.  Cependant, pour cela, nous devrons √©diter directement le fichier cgrules.conf, car le m√©canisme de d√©p√¥t n'est pas pris en charge ici.  Nous indiquons l'utilisateur ou le groupe propri√©taire du processus, ainsi que le nom du processus sp√©cifique - si vous le souhaitez -, ainsi qu'un contr√¥leur personnalis√© et un groupe de destination de groupe de contr√¥le. <br><br>  Dans notre exemple, au lieu du v√©ritable scanner antivirus scanit, nous utilisons un script qui est √©galement appel√© scanit, mais qui √©mule simplement la charge.  Sans cgroup, tout ressemble √† ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rz/9e/jr/rz9ejrq2hvosc8tx6qygwtlprju.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zg/_q/5w/zg_q5wnmcxzrirruk73ium-l4xg.png"></div><br><br>  Le CPU est enti√®rement occup√©, principalement par l'espace utilisateur et un peu de syst√®me. <br><br>  Jerry se gratte la barbe.  Il d√©marre vi et, en utilisant exactement un index, apporte quelques modifications et red√©marre le d√©mon cgred: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dn/sq/br/dnsqbrojxhtx0holtc3i-5f6uco.png"></div><br><br>  Ensuite, il lance manuellement scanit ...: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qa/o2/um/qao2umbcrsuefcn1n9m1jtrojtq.png"></div><br><br>  Et - bravo!  Victoire <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ik/vi/mr/ikvimrn0d_pkujdyjdaefnxzgsa.png"></div><br><br>  Comme vous pouvez le voir, nos processus d'√©mulation de charge (processus enfants de scanits) consomment maintenant un total de 20% des ressources CPU, principalement dans l'espace utilisateur et un peu dans le syst√®me.  Donc, ce fichu antivirus ne chargera plus la voiture √† la folie compl√®te. <br><br><h3>  Rappelez-vous quelle est la prochaine √©tape? </h3><br>  R√©joui du succ√®s, Jerry a presque oubli√© sa m√©moire.  Mais ensuite, il se souvient encore et red√©marre vi pour corriger son fichier de configuration. <br><br>  Il y ajoute maintenant deux param√®tres concernant la m√©moire: <br><ul><li>  Memory.limit_in_bytes - max.  La quantit√© de RAM que tous les processus du groupe de contr√¥le scanit peuvent utiliser.  Et hors espace de swap.  Jerry le limite √† 256 Mo </li><li>  Memory.memsw.limit_in_bytes - max.  Volume de RAM, plus espace dans le fichier d'√©change, qui peut √™tre allou√© √† tous les processus du groupe de contr√¥le scanit, au total.  Si ce seuil est d√©pass√©, les processus seront tu√©s par le tueur OOM.  Jerry le fixe √† 512 Mo. </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d9/ey/p7/d9eyp7j01qhdzrc_xughbzsatny.png"></div><br><br>  Oh non!  Qu'est-ce qui ne va pas? <br><br>  Jerry regarde en haut et voit que les processus enfants scanit sont toujours en cours d'ex√©cution.  √âtant donn√© que ce groupe de contr√¥le est actuellement utilis√©, Jerry ne peut pas d√©marrer le service.  Par cons√©quent, il tue manuellement les processus enfants et red√©marre ces services. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8t/er/fb/8terfbxnn3mp4bb-nrdmeasb1s4.png"></div><br><br>  Maintenant, une petite modification dans cgred.conf: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sr/ma/zs/srmazsl7k259dze13dcnjtij_ae.png"></div><br><br>  Pour v√©rifier, Jerry ex√©cute plusieurs t√¢ches scanit √† la fois, afin que le tueur OOM fonctionne √† coup s√ªr. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mv/cf/m7/mvcfm7gxz5b_l2ylpptrp5skseo.png"></div><br><br>  Jerry regarde ensuite le journal syst√®me et hoche la t√™te avec satisfaction - scanit ne peut plus laisser la m√©moire en quantit√© en toute impunit√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rf/n-/gc/rfn-gcg6nk2lwjz5aelxw6lt9ue.png"></div><br><br>  Nous esp√©rons que notre s√©rie d'articles cgroups vous a aid√© √† comprendre de quoi il s'agit, comment l'utiliser dans Red Hat Enterprise Linux 7, comment le cr√©er dans Red Hat Enterprise Linux 6 et comment l'utiliser dans votre environnement. <br><br><ul><li>  Partie 1 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/423051</a> </li><li>  Partie 2 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/424367</a> </li><li>  Partie 3 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/425803</a> </li><li>  Partie 4 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/427413</a> </li><li>  Partie 6 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/430748</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr429064/">https://habr.com/ru/post/fr429064/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr429054/index.html">Trouvez N diff√©rences. Exp√©rience de test de mise en page Tinkoff.ru</a></li>
<li><a href="../fr429056/index.html">La physique, pas la biologie, rend le vieillissement in√©vitable</a></li>
<li><a href="../fr429058/index.html">Utilisation de Retrofit 2 dans une application Android</a></li>
<li><a href="../fr429060/index.html">Le concept d'un esprit id√©al. AI universelle</a></li>
<li><a href="../fr429062/index.html">Apprivoiser la multidiffusion</a></li>
<li><a href="../fr429066/index.html">Comment l'√©quipage de l'a√©ronef se pr√©pare au d√©part</a></li>
<li><a href="../fr429068/index.html">Un poste tr√®s corporate: ouverture √† Moscou ou pourquoi les 10 et 11 novembre sont de bons jours pour acheter de l'√©lectronique</a></li>
<li><a href="../fr429070/index.html">Linux ne peut pas √™tre charg√© sur de nouveaux MacBook en raison de la puce T2</a></li>
<li><a href="../fr429072/index.html">Pourquoi Kodak est mort et Fujifilm s'est √©panoui: l'histoire de deux cin√©astes</a></li>
<li><a href="../fr429074/index.html">Bonnes actions pour Google Money: nouveau d√©fi d'impact sur l'IA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>