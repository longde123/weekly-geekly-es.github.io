<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Servidor de impresi贸n tolerante a fallas de Windows   </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un administrador real puede dormir tranquilo solo cuando todo est谩 respaldado, monitoreado y duplicado. O cuando trabaja en un buen equipo, donde siem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor de impresi贸n tolerante a fallas de Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414369/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/7x/lk/zl/7xlkzlpjw2oft9qotypwjalwdmy.png"></a> <br>  Un administrador real puede dormir tranquilo solo cuando todo est谩 respaldado, monitoreado y duplicado.  <s>O cuando trabaja en un buen equipo, donde siempre puedes culpar a los dem谩s.</s> <br>  Dio la casualidad de que uso principalmente productos de Microsoft en mi trabajo y puedo decir que la compa帽铆a se toma en serio la copia de seguridad de sus servicios: Active Directory, Exchange DAG, SQL Always On, DFSR, etc.  Como en otros lugares, hay implementaciones muy elegantes y exitosas, as铆 como obviamente inconvenientes y dif铆ciles.  Tambi茅n hay una soluci贸n para el servicio de impresi贸n, pero requiere agrupaci贸n basada en Hyper-V.  Y quer铆a una soluci贸n simple "lista para usar", que no requiera financiamiento adicional.  Windows 2012 R2 se tom贸 como base, pero lo m谩s probable es que el mismo esquema funcione sin problemas en cualquier versi贸n de servidor que comience con Windows 2008, e incluso en los sistemas operativos cliente de Vista y superior (隆hola a los fan谩ticos que ahorran el presupuesto!).  A qui茅n le importa: le pido un gato. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Descargo de responsabilidad</b> <div class="spoiler_text">  <s>Para respetar el trabajo de los indios,</s> dado que la audiencia de Habr es principalmente de habla rusa y para facilitar a los administradores principiantes, los ejemplos utilizan la versi贸n rusa de la interfaz de Windows.  Los enlaces, donde sea posible, tambi茅n conducen a recursos en ruso. <br></div></div><br><br><h2>  Poco de teor铆a </h2><br>  Cualquiera a quien no le guste la teor铆a y quiera hacer clic m谩s r谩pido con el mouse y el teclado puede pasar directamente a la siguiente parte. <br>  Como se mencion贸 anteriormente, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recomendaci贸n oficial de</a> hoy es una soluci贸n que usa la agrupaci贸n y virtualizaci贸n de Hyper-V.  Adem谩s, nada impide garantizar la tolerancia a fallos del servicio de impresi贸n a nivel del sistema de virtualizaci贸n, y no necesariamente Hyper-V, pero tales soluciones cuestan dinero. <br>  Realmente quer铆a algo similar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DHCP Failover</a> , pero para el papel de un servidor de impresi贸n. <br>  No se encontr贸 nada adecuado en Internet en general y en el Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en particular</a> , y tuve que inventarlo yo mismo. <br><br>  <b>La esencia de la idea en un p谩rrafo.</b> <br>  La soluci贸n que se describe a continuaci贸n se basa en la utilidad BrintBrm, que forma parte de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">distribuci贸n</a> est谩ndar de Windows <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">y ha reemplazado a printmig</a> . <br>  El servidor en espera funciona en modo de espera y sincroniza la configuraci贸n con el servidor principal con la frecuencia especificada utilizando esta utilidad.  Para los clientes, se cre贸 un CNAME con un peque帽o TTL en DNS, haciendo referencia al servidor principal.  En el caso de una falla del servidor primario, el administrador corrige CNAME cambiando los clientes al servidor de respaldo.  Eso, de hecho, es todo. <br>  Si el tema es interesante y quiero familiarizarme con los baches que ya est谩n llenos de m铆 y las formas de evitar el rastrillo, siga a continuaci贸n. <br><br><h2>  Antes de comenzar, o lo que necesita saber sobre PrintBrm </h2><br>  Entonces, 驴qu茅 es esta utilidad PrintBrm, cuyo objetivo principal es servir al servidor de impresi贸n? <br><ul><li>  Bien mantenido  Tiene una implementaci贸n de GUI llamada <i>Print Migration</i> y se puede iniciar desde <i>el</i> complemento <i>Print Management</i> .  La versi贸n GUI es menos funcional y tiene problemas con el puerto de puertos. </li><li>  Atento  De manera predeterminada, maneja las ACL de la impresora del servidor de impresi贸n.  En otras palabras, si permit铆a imprimir en la impresora \\ printserver \ printer1 solo para los empleados que son miembros del grupo de <i>contabilidad</i> AD, entonces esta restricci贸n se tendr谩 en cuenta para la importaci贸n / exportaci贸n.  O no lo har谩, si coloca la tecla <i>-NOACL</i> .  Sin embargo, la ACL del servidor de impresi贸n en s铆 no se procesa independientemente de la clave. </li><li>  Moody  En el momento de importar par谩metros desde un archivo, el servidor de destino debe tener al menos una impresora compartida; de lo contrario, obtendr谩 un error. </li><li>  Gentil.  Perdi贸 ver espacios en la ruta del archivo.  Al ver las comillas que enmarcan ese camino, est谩 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">molesto</a> y da un error 0x8007007b. </li><li>  Modesto.  Si el archivo especificado ya existe al intentar exportar la configuraci贸n, no puede sobrescribirlo, es t铆mido preguntar y tambi茅n termina con un error. </li><li>  Misterioso  Siempre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">devuelve un c贸digo de salida de 0</a> .  Resulta que el programa perfecto. <br></li><li>  Apto para pensar.  Se puede congelar en la etapa de 100% minutos durante 5, y a veces m谩s.  Pero luego piensa y termina el trabajo (a menos que, por supuesto, tenga la paciencia de no presionar Ctrl + C). </li><li>  De repente y contradictorio.  Puede organizar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tales sorpresas</a> . </li><li>  Inteligente  Puede reasignar controladores de origen a otros.  Por ejemplo, al usar un archivo XML, puede especificar que todos los controladores de HP Universal Printing PCL 5 en el archivo guardado en el servidor de destino deben reasignarse a HP Universal Printing PCL 6. No lo he usado en la pr谩ctica, pero puede ser 煤til para alguien. </li><li>  Rebelde  No podr铆a usarlo para transferir configuraciones entre dominios sin confianza, incluso con el interruptor -NOACL.  O no puede hacerlo en principio, o mi magia no es lo suficientemente fuerte. </li><li>  Puede conocer mejor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> , pero para aquellos valientes que no dudan en preguntar directamente, hay una clave /? <br></li></ul><br><br>  Admito que algunas caracter铆sticas las ignor茅 inmerecidamente.  Quiz谩s en Windows 10/2016 ella comenz贸 a comportarse de manera diferente.  Si hay informaci贸n, por favor comparta. <br><br><h2>  Preparaci贸n del medio ambiente </h2><br>  Se supone que ya ha implementado Active Directory y conoce al menos 3 formas de deshabilitarlo y al menos 2 de ellos han sido probados en la pr谩ctica. <br><br><div class="spoiler">  <b class="spoiler_title">Algunas letras</b> <div class="spoiler_text">  Partiendo del tema del art铆culo, noto que me gusta el pedido, y estoy a favor del hecho de que cada impresora de red y MFP tiene una etiqueta que corresponde a su nombre de red.  Esto simplifica el trabajo de los empleados de TI cuando intentan averiguar por parte del usuario en qu茅 impresora de <s>fotos de</s> gatos en particular se imprimen informes anal铆ticos importantes en tonos 谩cidos t贸xicos en lugar de delicados pistachos.  <s>Es mejor pegar esas pegatinas en la parte inferior de la impresora, para que todos est茅n m谩s interesados y m谩s divertidos.</s> <br>  Tambi茅n me gusta cuando cada impresora de red est谩 registrada en la zona DNS interna.  Un servidor DHCP basado en Windows <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">puede hacer</a> esto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">f谩cilmente</a> . <br>  Por ejemplo, el nombre de la impresora puede tener el formato msk-prn001 o sale-printer023, y los nombres de puerto para estas impresoras en el servidor de impresi贸n se denominan exactamente igual.  Pero esta es mi preferencia personal, estoy listo para escuchar las objeciones en los comentarios. <br></div></div><br>  Asumiremos que todas las impresoras est谩n conectadas en red y disponibles para imprimir desde los servidores de impresi贸n primario y de respaldo.  Deje que estos servidores se llamen <i>prn-srv01</i> y <i>prn-srv02</i> respectivamente. <br>  Los servidores de dominio en Windows Server no inferiores a 2008 son adecuados como servidores de impresi贸n. En principio, los sistemas operativos cliente que comienzan con Vista tambi茅n son adecuados, si realmente desea ahorrar algo de dinero.  El ejemplo usa Windows 2012 R2.  Es muy recomendable instalar todas las actualizaciones necesarias del sistema operativo antes de configurar los servidores y las m谩quinas cliente. <br><br>  Usted mismo, por supuesto, entiende, pero el l铆mite a煤n requiere atenci贸n: si los servidores de impresi贸n son virtuales, entonces deben distribuirse a diferentes servidores f铆sicos, de lo contrario nuestra conmutaci贸n por error simplemente se convertir谩 en un error. <br><br>  En <i>prn-srv01</i> y <i>prn-srv02</i> , se debe agregar la funci贸n del servidor de impresi贸n.  Es m谩s conveniente para m铆 usar el cmdlet de PowerShell: <br> <code>Install-WindowsFeature Print-Services</code> <br> <br>  Adem谩s, se debe aplicar un ajuste de registro en los servidores de impresi贸n, que corrige el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">error 0  00000709</a> cuando las m谩quinas cliente acceden al servidor de impresi贸n a trav茅s de CNAME.  Puede hacer esto con el comando del art铆culo en el enlace de arriba: <br> <code>reg add HKLM\SYSTEM\CurrentControlSet\Control\Print /v DnsOnWire /t REG_DWORD /d 1</code> <br>  Despu茅s de aplicar el comando, debe reiniciar el servicio <i>Administrador de impresi贸n</i> . <br>  Le recomiendo que asigne una unidad organizativa separada para los servidores de impresi贸n y distribuya esta configuraci贸n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">con GPP</a> . <br><br>  Iniciamos el complemento DNS en el controlador de dominio y habilitamos la pantalla extendida: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/t_/sg/w1/t_sgw1pf6fazbhihj-4yjxzivfc.png"><br></div></div><br>  Se necesita un mapeo avanzado para poder establecer TTL para los registros creados. <br>  En DNS, cree un registro de <i>impresi贸n</i> CNAME que haga referencia a <i>prn-srv01</i> con un valor TTL de 5 minutos: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bx/oe/0y/bxoe0yjyj5pmar4utycfqjfnnba.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/w_/tz/dj/w_tzdj66enutsmeuw5wwajzmrww.png"><br></div></div><br>  Las m谩quinas cliente deben usar este nombre para conectarse al servidor de impresi贸n.  Es decir  el cliente se conectar谩 a las direcciones \\ print \ printer01, \\ print \ printer02, etc. <br>  Cuanto m谩s bajo sea el valor TTL, m谩s a menudo los clientes actualizar谩n el registro y antes "comprender谩n" que necesitan cambiar a otro servidor de impresi贸n.  5 minutos son suficientes para m铆. <br>  Al establecer el valor demasiado bajo, genera tr谩fico DNS en su red, <s>y al especificar una o dos horas, enfatiza su tolerancia al estr茅s y sus nervios fuertes</s> . <br>  Una forma alternativa de agregar un registro CNAME con PowerShell: <br> <code>Import-Module DnsServer <br> Add-DnsServerResourceRecordCName -Name "print" -HostNameAlias "prn-srv01.lab.net" -ZoneName "lab.net" -TimeToLive 00:05:00 <br></code> <br>  (Por supuesto, cambiamos lab.net a su contoso.local o lo que sea) <br><br>  Tenga en cuenta que si tiene varios sitios de AD, la actualizaci贸n de los registros DNS en todas las ubicaciones llevar谩 m谩s tiempo debido a la replicaci贸n entre sitios.  Puede forzar el proceso con el <i>comando repadmin / syncall</i> . <br><br>  Mediante la Pol铆tica de grupo, permitimos que los usuarios comunes instalen controladores desde el servidor de impresi贸n.  C贸mo hacer esto se describe en detalle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> . <br><br>  Cree una cuenta de servicio en AD (la llam茅 svc-printsync) con una caducidad de contrase帽a ilimitada: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/aw/b8/-i/awb8-irvpqwtgz7_hqh5zziclxu.png"><br></div></div><br>  De acuerdo con los requisitos de PrintBrm, esta cuenta debe tener todos los derechos en el servidor de impresi贸n, por lo que la agregamos al <s>dominio de los administradores para que todo funcione con seguridad y escribamos la contrase帽a en el campo de descripci贸n para no olvidar el</s> grupo de <i>administradores</i> locales en <i>prn-srv01</i> y <i>prn-srv02</i> ( por ejemplo, usando <i>el</i> complemento de <i>Administraci贸n de computadoras</i> ). <br><br><h2>  Configure el primer servidor </h2><br>  Si ya se han agregado todas las impresoras necesarias en la impresora principal, puede pasar inmediatamente a la secci贸n sobre la configuraci贸n del segundo servidor. <br><br>  Usando <i>el</i> complemento <i>Print Management</i> , agregamos controladores para las impresoras necesarias al servidor: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c0/_b/fl/c0_bflidme6egcqqpjsu8fmhkay.png"><br></div></div><br>  Se inicia el asistente de instalaci贸n del controlador.  Es intuitivo, puede resolverlo usted mismo.  Solo prestar茅 atenci贸n al momento con poca profundidad. <br>  Porque  Como Windows 2012R2 solo est谩 disponible en la versi贸n x64, los controladores tambi茅n deben ser x64.  Si los clientes con versiones x86 de Windows se conectar谩n al servidor de impresi贸n, no olvide marcar la casilla correspondiente: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kk/1r/be/kk1rbe46et1lxpumhlwjt4dgqvu.png"><br></div></div><br>  Algunos kits de controladores contienen un archivo inf com煤n para los sistemas x86 y x64, mientras que otros tienen una separaci贸n. <br><br><div class="spoiler">  <b class="spoiler_title">Algunas letras m谩s</b> <div class="spoiler_text">  Muchos controladores vienen en forma de un instalador, pero dado que estos instaladores ponen mucha basura junto con los controladores, trato de seguir el principio de "necesario y suficiente" y agregar controladores manualmente, como se describi贸 anteriormente. <br>  Adem谩s, en aras de la coherencia, me esfuerzo por utilizar la versi贸n Universal de los controladores al m谩ximo (casi todos los proveedores normales lo tienen).  Pero a veces puede ser un problema.  Entonces, una vez que encontr茅 un error en una de las versiones de HP Universal Printing PCL 6, en el que un documento PDF a trav茅s de EasyPrint en una sesi贸n RDP se imprimi贸 de espejo a izquierda de derecha a derecha. <br>  Tambi茅n puede mirar hacia los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">controladores v4</a> . <br></div></div><br><br>  Cuando se agreguen todos los controladores necesarios, trataremos con puertos e impresoras.  Puede agregarlos manualmente desde el mismo complemento, pero le recomiendo crear un archivo CSV en Excel y alimentarlo a un script de PowerShell.  Por supuesto, nada impide que Excel use cualquier otro editor de hojas de c谩lculo o bloc de notas en general.  Lo principal es que el separador y la codificaci贸n especificados en el script corresponden al separador y la codificaci贸n en el archivo CSV. <br>  Tambi茅n tenga en cuenta que el nombre del controlador en el archivo CSV debe ser exactamente el mismo que se especifica en el complemento <i>Administraci贸n de</i> impresi贸n. <br><div class="spoiler">  <b class="spoiler_title">Copiar y pegar al rescate</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lt/-u/k3/lt-uk31frw4ashg6sqfxptrx6us.png"><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Archivo CSV de muestra</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/f9/wp/cj/f9wpcjsmlydppavwxh9ed4bn51m.png"><br></div></div><br><br>  Aunque escrib铆 anteriormente que me gusta cuando todas las impresoras tienen nombres de red unificados, el ejemplo (campo de <i>direcci贸n de impresora</i> ) usa una vinagreta de direcciones IP y nombres en caso de que <s>no</s> tenga orden en su red un poco m谩s tarde. <br><br>  Guarde esta tabla en formato CSV: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1e/qq/4i/1eqq4iw3hfbsjfge8mcetyerlfg.png"><br>  <i><b>Nota</b></i>  <i>A pesar de que las comas se indican como separadores en el campo "Tipo de archivo", Excel ha hecho un punto y coma como separador.</i>  <i>Probablemente sea m谩s interesante y m谩s divertido.</i> <br></div></div><br>  Y aqu铆 est谩 el gui贸n en s铆: <br><div class="spoiler">  <b class="spoiler_title">CreatePrintersFromCsv.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#    $InputFile = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\Printers.csv'</span></span> #      CSV- $Printers = (Import-Csv $InputFile -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -Encoding Default) #          ForEach ($Printer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Printers) { #       $PrinterName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $ShareName = $Printer.<span class="hljs-string"><span class="hljs-string">'  '</span></span> $DriverName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $PrinterAddr = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $Comment = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> $Location = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> #  Add-PrinterPort -Name $PrinterAddr -PrinterHostAddress $PrinterAddr -SNMP <span class="hljs-number"><span class="hljs-number">1</span></span> -SNMPCommunity <span class="hljs-string"><span class="hljs-string">'public'</span></span> #  Add-Printer -Name $PrinterName -DriverName $DriverName -PortName $PrinterAddr -Comment $Comment -Location $Location #   Set-Printer -Name $PrinterName -Shared $True -Published $False -ShareName $ShareName }</code> </pre><br></div></div><br>  Si el car谩cter de tabulaci贸n se usa como delimitador en su CSV, entonces en el script debe establecer <i>-Delimiter "` t "</i> <br><br>  Tenga en cuenta que si una impresora no est谩 disponible desde el servidor mientras se ejecuta la secuencia de comandos, agregarla al servidor de impresi贸n llevar谩 m谩s tiempo (2-3 minutos en lugar de unos segundos) <br><br>  El resultado del gui贸n: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fj/jd/-t/fjjd-tcfaowketxq9u7av7yzfzk.png"><br></div></div><br><br>  Para asegurarse de que todo funcione en esta etapa, agregue una impresora compartida a cualquiera de las m谩quinas cliente desde el servidor de impresi贸n principal utilizando el CNAME creado anteriormente (por ejemplo, \\ print \ printer01) e intente imprimir algo en 茅l.  <s>Para este prop贸sito, la frase "Preved, soy un pedazo de papel", escrita en negrita Arial con un tama帽o 200, es la m谩s adecuada para este prop贸sito.</s> <br><br><h2>  Configurar un segundo servidor </h2><br><blockquote>  Un artista copia, un gran artista roba (Pablo Picasso) </blockquote><br>  Nuestro <i>prn-srv02</i> a煤n no ha alcanzado el nivel de gran artista, por lo que nos limitaremos a copiar.  <s>Aunque ... es posible con un movimiento de mu帽eca ...</s> <br><br>  Creamos y compartimos al menos una impresora, de lo contrario PrintBrm dar谩 un error.  Puede hacer una falsificaci贸n, pero es importante no elegir el controlador o puerto incorrecto.  Por ejemplo, una impresora con un controlador Microsoft XPS Document Writer o un puerto FILE no se puede compartir. <br><br>  Creamos un script de sincronizaci贸n simple.  Prefiero PowerShell, pero nadie proh铆be hacer un archivo por lotes de tubo caliente. <br><br><div class="spoiler">  <b class="spoiler_title">PrintSync.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#   PrintBrm $ProgramPath = <span class="hljs-string"><span class="hljs-string">'C:\Windows\System32\Spool\Tools\PrintBrm.exe'</span></span> #    $SourceServer = <span class="hljs-string"><span class="hljs-string">'prn-srv01'</span></span> $DestServer = <span class="hljs-string"><span class="hljs-string">'prn-srv02'</span></span> #,   .     , ..  PrintBrm       $ConfigFilePath = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\prn-config.printerExport'</span></span> #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $SourceServer -f $ConfigFilePath -b"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $DestServer -f $ConfigFilePath -r -o force"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #   Del $ConfigFilePath</code> </pre><br></div></div><br><br>  Ponemos el script en un lugar apartado (en el ejemplo es <i>C: \ Scripts</i> ) y creamos una tarea en el Programador. <br>  Ejecutaremos desde la cuenta svc-printsync creada anteriormente con los permisos m谩s altos: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sp/ax/9w/spax9w_u6llu5ekhxh6ezfq8zdi.png"><br></div></div><br>  Determine la frecuencia de ejecuci贸n por usted mismo.  Suficiente para m铆 una vez al d铆a: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m8/a5/hm/m8a5hm3qm5dosyvvd8uivsrdeaq.png"><br></div></div><br>  En la pesta帽a Acciones, cree una nueva acci贸n de inicio de PowerShell: <br> <code>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</code> <br>  Como argumentos, establecemos la ruta al script con los siguientes par谩metros: <br> <code>C:\Scripts\PrintSync.ps1 -NonInteractive -WindowStyle Hidden -ExecutionPolicy Bypass</code> <br> <div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c2/dw/zi/c2dwzipe2ifr6vstp2qgpvr-cc4.png"><br></div></div><br>  Dejamos el resto de los par谩metros de la tarea en las pesta帽as <i>Condiciones</i> y <i>Par谩metros</i> de forma predeterminada. <br>  Al guardar la tarea, se solicitar谩 una contrase帽a para la cuenta <i>svc-printsync</i> .  驴No lo olvidaste?  Si ya lo ha olvidado (el art铆culo es largo), entonces <s>todo se hizo en vano y la vida no tuvo 茅xito.</s> Rein铆cielo utilizando el complemento ADUC o de otra manera conveniente <s>y especif铆quelo ya en el campo de descripci贸n para que sea m谩s tranquilo</s> . <br><br><div class="spoiler">  <b class="spoiler_title">Nota</b> <div class="spoiler_text">  El trabajo no tiene que ejecutarse en el servidor de impresi贸n de respaldo.  Si tiene un servidor separado para ejecutar rutinas, puede crear una tarea en 茅l.  En este caso, la cuenta <i>svc-printsync</i> debe tener derecho a iniciar sesi贸n como un trabajo por lotes en este servidor.  De manera predeterminada, el grupo local <i>Operadores de respaldo</i> tiene este derecho, y si esto no se cambia en su entorno, simplemente incluya la cuenta de servicio en el grupo de operadores de archivo del servidor en el que se ejecutar谩 la tarea. <br></div></div><br><br>  Por primera vez, comenzamos la tarea manualmente y esperamos su finalizaci贸n. <br>  Para mi zool贸gico, donde hay alrededor de 50 impresoras de diferentes tipos, tanto en peligro como recientemente creadas, el procedimiento de sincronizaci贸n dura aproximadamente 10 minutos.  El archivo al mismo tiempo pesa casi 1 GB. <br>  Para acelerar el proceso de importaci贸n / exportaci贸n, puede usar el <i>modificador -NOBIN</i> , que se encarga de copiar los controladores.  Tiene sentido cuando la flota de impresoras consta de los mismos modelos y los controladores necesarios est谩n instalados en todos los servidores. <br><br>  Una vez completado, ejecute el complemento <i>Visor de eventos</i> , vaya a la secci贸n <i>Registros de aplicaciones y servicios</i> , abra el <i>registro de</i> <i>Microsoft \ Microsoft \ PrintBRM \ Administrator</i> y <i>anal铆celo</i> en busca de errores y advertencias.  <s>Y si hay demasiados, es m谩s probable que limpiemos la revista para que nuestros ojos no se calmen.</s> <br><br>  Encontr茅 los c贸digos 20, 22, 80 y 81. Por ejemplo, <br><div class="spoiler">  <b class="spoiler_title">tal</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/be/sx/7u/besx7uy6lxapuzrxj3_mrsg9agc.png"><br></div></div><br>  Como queda claro en el texto, hubo un problema al transferir un controlador espec铆fico.  Mirando a trav茅s del registro, hacemos una lista de controladores problem谩ticos y los colocamos en el servidor de respaldo con nuestras manos, o los reemplazamos con otros que no son reacios a viajar.  Solo tuve problemas con HP, Kyocera y Konica Minolta, no se detectaron errores para los controladores de otros fabricantes (tal vez porque son mejores, o tal vez porque simplemente no los tenemos). <br>  Como resultado, debe lograr la misma lista de impresoras en los servidores primario y de respaldo y la ausencia de errores y advertencias en los registros. <br><br><h2>  Cambiar a reserva </h2><br>  <s>Bajo el golpe de las hachas y el molido de los tenedores, cerramos la puerta de nuestra oficina y apagamos el tel茅fono.</s>  Ejecute el complemento DNS y edite el registro CNAME para que apunte al servidor de respaldo: <br><div class="spoiler">  <b class="spoiler_title">haga clic</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3n/kh/p5/3nkhp5g6apvxj1ejoheth9hlcfu.png"><br></div></div><br>  Despu茅s de un tiempo (驴qu茅 pusiste en TTL all铆?), Los <s>gritos amenazantes disminuir谩n, las</s> m谩quinas <s>del</s> cliente cambiar谩n a prn-srv02 <s>y la puerta con el tel茅fono se puede desbloquear</s> . <br><br><h2>  Regresa </h2><br>  Si durante la recuperaci贸n del servidor principal en la copia de seguridad hubo cambios de configuraci贸n que deben guardarse, comenzamos la sincronizaci贸n en la direcci贸n opuesta.  Para hacer esto, en el script <i>PrintSync.ps1</i> anterior <i>,</i> intercambiamos los valores de las variables <i>$ SourceServer</i> y <i>$ DestServer</i> .  Despu茅s de transferir los cambios, no olvide devolver estos valores, de lo contrario, todos los cambios en la configuraci贸n de la impresora en <i>prn-srv01</i> ser谩n <i>barridos</i> sin piedad todas las noches por la mala voluntad del destino. <br>  En el complemento DNS, configure <i>print</i> para el registro CNAME como el valor del nodo de destino prn-srv01, y todo volver谩 al punto de partida. <br><br><h2>  Cual es el resultado? </h2><br>  Tormentosos aplausos del liderazgo, arrojando al administrador en sus brazos, aumentando el salario (para el autor del art铆culo: honesto 10% del aumento) ... <br>  Bueno, algunos pensamientos en la direcci贸n de orientaci贸n de mayor belleza. <br><br>  Desafortunadamente, no hay suficientes milagros para todos, y esta soluci贸n no es una conmutaci贸n por error completa.  Si en el momento del colapso del servidor de impresi贸n principal hay colas de impresi贸n no vac铆as, entonces su contenido probablemente desaparecer谩 en el aire y alguien tendr谩 que repetir el env铆o para imprimir. <br><br>  Pero ser谩 muy conveniente para los usuarios realizar de manera transparente el mantenimiento de rutina de los servidores de impresi贸n. <br><div class="spoiler">  <b class="spoiler_title">驴Sigues las recomendaciones de Microsoft?</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/s9/dr/bm/s9drbmkdazxkxaswuw4flitnsoi.jpeg"><br></div></div><br><br>  Los fan谩ticos de la automatizaci贸n pueden ir m谩s all谩 y crear un script que reciba nombres de servidor con un intervalo de sincronizaci贸n en la entrada y realice el resto de la configuraci贸n en s铆: crea una cuenta de servicio si es necesario, una tarea en el programador, etc. <br><br>  Los gur煤s de supervisi贸n agregar谩n la supervisi贸n de la tarea de sincronizaci贸n y los errores en los registros. <br><br>  Los amantes de cavar m谩s profundo pueden pensar en la sincronizaci贸n bidireccional en el esp铆ritu de la replicaci贸n AD con cambios de seguimiento de tiempo para cada impresora.  隆PrintBrm no ayudar谩 aqu铆, pero nadie ha cancelado PowerShell! <br><br>  La guinda del pastel ser谩 la instalaci贸n autom谩tica de impresoras en m谩quinas cliente que utilizan GPP, dirigidas al grupo AD.  Agregue el usuario al grupo y la impresora deseada vuela hacia 茅l.  Es cierto, esta es otra historia que va m谩s all谩 del alcance del art铆culo. <br><br>  Espero para alguien que mi publicaci贸n sea 煤til.  Les deseo a todos menos problemas t茅cnicos y espero preguntas y sugerencias en los comentarios. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es414369/">https://habr.com/ru/post/es414369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es414357/index.html">Utilizamos la API web de Bluetooth para conectar el monitor de frecuencia card铆aca y desarrollar la aplicaci贸n usando Vue.js</a></li>
<li><a href="../es414359/index.html">Interacci贸n con el servidor a trav茅s de la API en iOS en Swift 3. Parte 1</a></li>
<li><a href="../es414361/index.html">Unity3D: Arquitectura de juego, Objetos de secuencias de comandos, Singletones</a></li>
<li><a href="../es414363/index.html">El resumen de materiales frescos del mundo del front-end para la 煤ltima semana No. 319 (11 al 17 de junio de 2018)</a></li>
<li><a href="../es414367/index.html">Galopando en tres a帽os: lo que puede ser interesante volver a leer en el blog HashFlare</a></li>
<li><a href="../es414371/index.html">Clase escolar y un peque帽o boceto de ingenier铆a social.</a></li>
<li><a href="../es414373/index.html">Dise帽o asincr贸nico / en espera de JavaScript: fortalezas, dificultades y patrones de uso</a></li>
<li><a href="../es414375/index.html">Comandos para trabajar con la consola de JavaScript en navegadores y aumentar la productividad del programador</a></li>
<li><a href="../es414377/index.html">Innovaciones de literales de objetos en JavaScript ES6</a></li>
<li><a href="../es414379/index.html">"Los que est谩n dispuestos a intercambiar libertad por seguridad no son dignos de libertad ni de seguridad" (fuente original)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>