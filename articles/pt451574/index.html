<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🏫 🗡️ 💅🏽 Desenvolva um utilitário no GraalVM 💍 🏟️ 👨🏿‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Declaração do problema 


 Periodicamente, tenho a tarefa de compartilhar arquivos em uma rede local, por exemplo, com um colega do projeto. 


 Pode ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desenvolva um utilitário no GraalVM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451574/"><h2 id="postanovka-zadachi">  Declaração do problema </h2><br><p>  Periodicamente, tenho a tarefa de compartilhar arquivos em uma rede local, por exemplo, com um colega do projeto. </p><br><p>  Pode haver muitas soluções para isso - Samba / FTP / scp.  Você pode simplesmente enviar o arquivo para um local público como o Google Drive, anexá-lo a uma tarefa no Jira ou até enviá-lo por e-mail. </p><br><p>  Mas tudo isso, em um grau ou outro, é inflexível, em algum lugar requer ajuste preliminar e tem suas próprias limitações (por exemplo, o tamanho máximo do investimento). </p><br><p>  E você quer algo mais leve e flexível. </p><br><p>  Sempre fiquei agradavelmente surpreso com a oportunidade no Linux, usando os meios disponíveis, de criar rapidamente uma solução prática. </p><br><p>  Digamos, eu frequentemente resolvia a tarefa mencionada usando o python do sistema com a seguinte linha única </p><br><pre><code class="bash hljs">$ python3 -mhttp.server Serving HTTP on 0.0.0.0 port 8000 ...</code> </pre> <br><p>  Este comando inicia o servidor da web na pasta atual e permite obter uma lista de arquivos e baixá-los através da interface da web.  Mais dessas coisas podem ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">despejadas aqui</a> . </p><a name="habracut"></a><br><p>  Existem vários inconvenientes.  Agora, para transferir o link de download para um colega, você precisa saber o seu endereço IP na rede. </p><br><p>  É conveniente usar o comando </p><br><pre> <code class="bash hljs">$ ifconfig -a</code> </pre> <br><p>  E, a partir da lista resultante de interfaces de rede, selecione a apropriada e componha manualmente um link no formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http: // IP: 8000</a> , que você pode enviar. </p><br><p>  Segunda inconveniência: este servidor é de thread único.  Isso significa que, embora um de seus colegas faça o download do arquivo, o segundo nem será capaz de baixar a lista de arquivos. </p><br><p>  Terceiro, é inflexível.  Se você precisar transferir apenas um arquivo, ele abrirá a pasta inteira, ou seja,  você precisará executar esses gestos (e depois limpar o lixo): </p><br><pre> <code class="bash hljs">$ mkdir tmp1 $ cp file.zip tmp1 $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tmp1 $ python3 -mhttp.server</code> </pre> <br><p>  O quarto inconveniente - não há maneira <em>fácil</em> de baixar todo o conteúdo de uma pasta. </p><br><p>  Para transferir o conteúdo de uma pasta, eles geralmente usam uma técnica chamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tar pipe</a> . </p><br><p>  Eles fazem algo assim: </p><br><pre> <code class="bash hljs">$ ssh user@host <span class="hljs-string"><span class="hljs-string">'cd /path/to/source &amp;&amp; tar cf - .'</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/destination &amp;&amp; tar xvf -</code> </pre> <br><p>  Se de repente não estiver claro, explicarei como funciona.  A primeira parte do comando <code>tar cf - .</code>  cria um arquivo morto do conteúdo da pasta atual e grava na saída padrão.  Além disso, essa saída é transmitida por canal através de um canal ssh seguro para a entrada de um <code>tar xvf -</code> semelhante <code>tar xvf -</code> que executa o procedimento oposto, ou seja,  lê a entrada padrão e descompacta na pasta atual.  De fato, o arquivo morto é transferido, mas sem a criação de um arquivo intermediário! </p><br><p>  A inconveniência dessa abordagem também é óbvia.  Precisamos de acesso ssh de uma máquina para outra, e isso quase nunca é feito no caso geral. </p><br><p>  É possível alcançar todas as opções acima, mas sem os problemas descritos? </p><br><p>  Então, é hora de formalizar o que construiremos: </p><br><ol><li>  Programa fácil de instalar (binário estático) </li><li>  O que permitirá que você transfira um arquivo e uma pasta com todo o conteúdo </li><li>  Com compressão opcional </li><li>  O que permite que o host baixe o (s) arquivo (s) usando apenas ferramentas * nix padrão (wget / curl / tar) </li><li>  O programa imediatamente após o lançamento emitirá os comandos exatos para fazer o download </li></ol><br><h2 id="reshenie">  Solução </h2><br><p>  Na conferência do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JEEConf</a> , da qual participei há pouco tempo, o tópico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Graal</a> foi levantado repetidamente.  O assunto está longe de ser novo, mas para mim foi um gatilho finalmente sentir essa fera com minha própria mão. </p><br><p>  Para aqueles que ainda não estão no tópico (existe realmente algo assim ainda? OO), deixe-me lembrá-lo de que o GraalVM é uma JVM tão bombeada da Oracle com recursos adicionais, sendo os mais visíveis: </p><br><ol><li>  JVM Polyglot - a capacidade de executar perfeitamente Java, Javascript, Python, Ruby, R, etc.  código </li><li>  Suporte para compilação AOT - compilando Java diretamente no binário nativo </li><li>  Um recurso menos notável, mas muito interessante - o compilador C2 foi reescrito do C ++ para o Java, a fim de facilitar o seu desenvolvimento.  Isso já produziu resultados visíveis.  Esse compilador faz muito mais otimizações no estágio de conversão do bytecode Java em código nativo.  Por exemplo, ele é capaz de eliminar com mais eficiência as alocações.  O Twitter conseguiu reduzir o consumo de CPU em 11% apenas ativando essa configuração, que em sua escala proporcionou uma economia notável de recursos (e dinheiro). </li></ol><br><p>  Você pode atualizar a idéia de Graal, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste artigo</a> . </p><br><p>  Como escreveremos em Java, o recurso mais relevante para nós será a compilação AOT. </p><br><p>  Na verdade, o resultado do desenvolvimento é apresentado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste repositório do Github</a> . </p><br><p>  Exemplo de uso para transferir um único arquivo: </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/report.pdf'</span></span> To download the file please use one of the commands below: curl http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> curl http://192.168.0.179:17777/dl?z --compressed &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl?z | gunzip &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span></code> </pre> <br><p>  Um exemplo de uso ao transferir o conteúdo de uma pasta (todos os arquivos, incluindo os anexados!): </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/folder'</span></span> To download the files please use one of the commands below. NB! All files will be placed into current folder! curl http://192.168.0.179:17777/dl | tar -xvf - wget -O- http://192.168.0.179:17777/dl | tar -xvf - curl http://192.168.0.179:17777/dl?z | tar -xzvf - wget -O- http://192.168.0.179:17777/dl?z | tar -xzvf -</code> </pre> <br><p>  Sim, tão simples! </p><br><p>  Observe - o próprio programa determina o endereço IP correto no qual os arquivos estarão disponíveis para download. </p><br><h2 id="nablyudeniya--razmyshleniya">  Observações / Pensamentos </h2><br><p>  É claro que um dos objetivos na criação do programa era a sua compacidade.  E aqui está o resultado alcançado: </p><br><pre> <code class="bash hljs">$ du -hs `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> serv` 2.4M /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/serv</code> </pre> <br><p>  Incrivelmente, toda a JVM, junto com o código do aplicativo, se encaixa em alguns miseráveis ​​megabytes!  Claro, tudo está um pouco errado, mas mais sobre isso mais tarde. </p><br><p>  De fato, o compilador Graal produz um binário ligeiramente maior que 7 megabytes de tamanho.  Eu decidi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">comprimir</a> ainda <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais com o UPX</a> . </p><br><p>  Isso acabou sendo uma boa ideia, pois o tempo de lançamento aumentou enquanto era muito insignificante: </p><br><p>  Opção descompactada: </p><br><pre> <code class="bash hljs">$ time ./build/com.cmlteam.serv.serv -v 0.1 real 0m0.001s user 0m0.001s sys 0m0.000s</code> </pre> <br><p>  Comprimido: </p><br><pre> <code class="bash hljs">$ time ./build/serv -v 0.1 real 0m0.021s user 0m0.021s sys 0m0.000s</code> </pre> <br><p>  Para comparação, o tempo de lançamento da "maneira tradicional": </p><br><pre> <code class="bash hljs">$ time java -cp <span class="hljs-string"><span class="hljs-string">"/home/xonix/proj/serv/target/classes:/home/xonix/.m2/repository/commons-cli/commons-cli/1.4/commons-cli-1.4.jar:/home/xonix/.m2/repository/org/apache/commons/commons-compress/1.18/commons-compress-1.18.jar"</span></span> com.cmlteam.serv.Serv -v 0.1 real 0m0.040s user 0m0.030s sys 0m0.019s</code> </pre> <br><p>  Como você pode ver, duas vezes mais lento que a versão UPX. </p><br><p>  Em geral, um tempo de início curto é um dos pontos fortes do GraalVM.  Isso, além do baixo consumo de memória, leva a um entusiasmo significativo com o uso dessa tecnologia para microsserviços e sem servidor. </p><br><p>  Tentei tornar o programa lógico o mínimo possível e usar o mínimo de bibliotecas.  Em princípio, essa abordagem geralmente é justificada e, nesse caso, eu tinha preocupações de que a adição de dependências de terceiros de terceiros aumentasse significativamente o arquivo de programa resultante. </p><br><p>  Por exemplo, é por isso que não usei uma dependência de terceiros para um servidor da Web Java (e há muitas para todos os gostos e cores), mas usei a implementação JDK de um servidor da web <code>com.sun.net.httpserver.*</code> Pacote.  Na verdade, o uso do pacote <code>com.sun.*</code> É considerado uma <code>com.sun.*</code> , mas considero isso permitido neste caso, pois estou compilando o código nativo e, portanto, não há dúvida de compatibilidade entre a JVM. </p><br><p>  No entanto, meus medos foram completamente em vão.  No programa, usei duas dependências por conveniência </p><br><ol><li>  <code>commons-cli</code> - para analisar argumentos de linha de comando </li><li>  <code>commons-compress</code> - para gerar um tarball de pasta e uma compressão gzip opcional </li></ol><br><p>  Ao mesmo tempo, o tamanho do arquivo aumentou um pouco.  Atrevo-me a sugerir que o compilador Graal é muito inteligente para não colocar todos os jar-nicks de plug-in no arquivo executável, mas apenas o código deles que é realmente usado pelo código do aplicativo. </p><br><p>  A compilação no código Graal nativo é realizada pelo utilitário de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">imagem nativa</a> .  Vale ressaltar que esse processo consome muitos recursos.  Digamos, na minha configuração não tão lenta com uma CPU Intel 7700K integrada, esse processo leva 19 segundos.  Portanto, recomendo que, ao desenvolver, execute o programa como de costume (via java) e colete o binário na fase final. </p><br><h2 id="vyvody">  Conclusões </h2><br><p>  Parece-me que o experimento foi muito bem-sucedido.  Ao desenvolver o uso do kit de ferramentas Graal, não encontrei nenhum problema intransponível ou mesmo significativo.  Tudo funcionou de forma previsível e estável.  Embora, quase certamente, tudo não seja tão tranquilo se você tentar criar algo mais complexo dessa maneira, por exemplo, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aplicativo no Spring Boot</a> .  No entanto, várias plataformas já foram apresentadas nas quais o suporte nativo ao Graal é declarado.  Entre eles estão <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Micronaut</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Microprofile</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Quarkus</a> . </p><br><p>  Quanto ao desenvolvimento do projeto, uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lista de melhorias</a> planejadas para a versão 0.2 já está pronta.  Além disso, no momento, a montagem do binário final é implementada apenas para Linux x64.  Espero que essa omissão seja corrigida no futuro, principalmente porque o compilador de <code>native-image</code> da Graal suporta MacOS e Windows.  Infelizmente, ainda não suporta compilação cruzada, o que poderia facilitar muito as coisas. </p><br><p>  Espero que o utilitário apresentado seja útil para pelo menos alguém da respeitável comunidade habr.  Ficarei duplamente feliz se houver quem queira contribuir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">com o projeto</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt451574/">https://habr.com/ru/post/pt451574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt451560/index.html">Caro cliente, é por isso que essa mudança levou tanto tempo.</a></li>
<li><a href="../pt451562/index.html">Como escapar de uma seita?</a></li>
<li><a href="../pt451566/index.html">Operation TaskMasters: Como expomos as organizações atacantes do grupo cibernético na Rússia e na CEI</a></li>
<li><a href="../pt451570/index.html">Mudar-se para a França para trabalhar: salários, vistos e currículos</a></li>
<li><a href="../pt451572/index.html">Tendências da Tecnologia de Desenvolvimento Web 2019</a></li>
<li><a href="../pt451576/index.html">O livro "Nosso código. Artesanato, profissão, arte "</a></li>
<li><a href="../pt451580/index.html">MODX Digest # 5 (22 de abril a 13 de maio de 2019)</a></li>
<li><a href="../pt451582/index.html">Marketing de conteúdo em inglês: 5 números importantes para ajudar as startups</a></li>
<li><a href="../pt451586/index.html">Bem-vindo à transmissão BD & DWH Raiffeisen MeetUp UPD</a></li>
<li><a href="../pt451588/index.html">Nota de teste de integração usando Jenkins no Kubernetes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>