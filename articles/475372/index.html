<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüöí üë®üèø‚Äç‚öïÔ∏è üôèüèΩ Dominio front-end basado en TLS 1.3 üôÜüèΩ üïê üòó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 

 Los modernos sistemas de filtrado de contenido corporativo de fabricantes tan eminentes como Cisco, BlueCoat y FireEye tienen mucho en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dominio front-end basado en TLS 1.3</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475372/"><h3>  Introduccion </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bn/0p/mv/bn0pmvrdjnyzw-hr4glj5lekpmk.png"></div><br>  Los modernos sistemas de filtrado de contenido corporativo de fabricantes tan eminentes como Cisco, BlueCoat y FireEye tienen mucho en com√∫n con sus contrapartes m√°s potentes: sistemas DPI que se est√°n implementando intensamente a nivel nacional.  La esencia del trabajo de ambos es buscar el tr√°fico de Internet entrante y saliente y, sobre la base de listas en blanco y negro, tomar la decisi√≥n de prohibir la conexi√≥n a Internet.  Y dado que ambos se basan en principios similares en los fundamentos de su trabajo, las formas de eludirlos tambi√©n tendr√°n mucho en com√∫n. <br><br>  Una de las tecnolog√≠as que permite evitar de manera bastante eficiente tanto el DPI como los sistemas corporativos es la tecnolog√≠a de dominio frontal.  Su esencia radica en el hecho de que vamos a un recurso bloqueado, escondi√©ndonos detr√°s de otro dominio p√∫blico, con una buena reputaci√≥n, que obviamente no ser√° bloqueado por ning√∫n sistema, por ejemplo google.com. <br><br>  Ya se han escrito muchos art√≠culos sobre esta tecnolog√≠a y se han dado muchos ejemplos.  Sin embargo, las tecnolog√≠as DNS sobre HTTPS y SNI cifrado, as√≠ como las tecnolog√≠as discutidas recientemente, as√≠ como la nueva versi√≥n del protocolo TLS 1.3, brindan la oportunidad de considerar otra variante del dominio frontal. <br><a name="habracut"></a><br><h3>  Nos ocupamos de la tecnolog√≠a. </h3><br>  Primero, decidamos un poco sobre los conceptos b√°sicos para que todos comprendan qui√©n es qui√©n y por qu√© se necesita todo esto.  Mencionamos el mecanismo eSNI, cuyo trabajo se discutir√° m√°s adelante.  El mecanismo eSNI (Indicaci√≥n de nombre de servidor encriptado) es una versi√≥n segura de SNI, disponible solo para el protocolo TLS 1.3.  El punto principal es cifrar, incluida la informaci√≥n sobre a qu√© dominio se env√≠a la solicitud. <br><br>  Ahora veamos c√≥mo funciona el mecanismo eSNI en la pr√°ctica. <br><br>  Supongamos que tenemos un recurso de Internet que est√° bloqueado por una soluci√≥n DPI moderna (tome, por ejemplo, el famoso rastreador de torrents - rutracker.nl).  Cuando intentamos acceder al sitio del rastreador de torrents, vemos el c√≥digo auxiliar est√°ndar del proveedor de que el recurso est√° bloqueado: <br><br><img src="https://habrastorage.org/webt/hj/rt/kd/hjrtkdnlahnohjgs-tq-jzfctnu.png"><br><br>  En el sitio web de ILV, este dominio aparece en la lista de paradas: <br><br><img src="https://habrastorage.org/webt/4g/2m/k0/4g2mk0d4ks6xzbvmvv0za-vt16y.png"><br><br>  Cuando solicita whois, puede ver que el dominio en s√≠ est√° "oculto" detr√°s del proveedor de la nube Cloudflare. <br><br><img src="https://habrastorage.org/webt/my/wa/ki/mywakijkqem9a32jtmwyb0tcwfs.png"><br><br>  Pero a diferencia de los "especialistas" de ILV, los empleados m√°s expertos en tecnolog√≠a (o ense√±ados por la amarga experiencia de nuestro famoso regulador) no prohibieron est√∫pidamente el sitio por direcci√≥n IP, sino que ingresaron el nombre de dominio en la lista de parada.  Esto es f√°cil de verificar si observa qu√© otros dominios se esconden detr√°s de la misma direcci√≥n IP, visite uno de ellos y vea que el acceso no est√° bloqueado: <br><br><img src="https://habrastorage.org/webt/dk/j2/gk/dkj2gkveuqcbwkbumlrebfznt8u.png"><br><br>  ¬øPero c√≥mo sucede?  ¬øC√≥mo descubre el proveedor de DPI a qu√© dominios va mi navegador, porque todas las comunicaciones se realizan a trav√©s del protocolo https y parece que todav√≠a no notamos la sustituci√≥n de certificados https desde la l√≠nea de acceso?  ¬øEs clarividente o me est√° siguiendo? <br><br>  Intentemos responder esta pregunta observando el tr√°fico a trav√©s de wireshark <br><br><img src="https://habrastorage.org/webt/c1/k2/9e/c1k29ehqnytwfvw8udk-m6mkv6q.png"><br><br>  La captura de pantalla muestra que primero el navegador recibe la direcci√≥n IP del servidor a trav√©s de DNS, luego hay un protocolo de enlace TCP est√°ndar con el servidor de destino y luego el navegador intenta establecer una conexi√≥n SSL al servidor.  Para hacer esto, env√≠a el paquete Hello Client SSL, que contiene el nombre del dominio de origen en texto claro.  Este campo es requerido por el servidor front-end cloudflare para enrutar correctamente la conexi√≥n.  Aqu√≠ es donde el proveedor DPI nos atrapa, rompiendo nuestra conexi√≥n.  Al mismo tiempo, no recibimos ning√∫n c√≥digo auxiliar del proveedor, y vemos un error est√°ndar del navegador como si el sitio estuviera desconectado o simplemente no funciona: <br><br><img src="https://habrastorage.org/webt/tn/8h/fa/tn8hfavie40wl2qqiogrdqrxptw.png"><br><br>  Ahora habilitemos el mecanismo eSNI en el navegador, como se describe en las instrucciones para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://miketabor.com/enable-dns-over-">Firefox</a> : <br>  Para hacer esto, abrimos la p√°gina de configuraci√≥n de Firefox <b>sobre: ‚Äã‚Äãconfig</b> y activamos la siguiente configuraci√≥n: <br><br><pre><code class="plaintext hljs">network.trr.mode = 2; network.trr.uri = https://mozilla.cloudflare-dns.com/dns-query network.security.esni.enabled = true</code> </pre> <br>  Despu√©s de eso, verificaremos la correcci√≥n de la configuraci√≥n en el sitio web de Cloudflare usando el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> e intentaremos enfocar nuevamente con nuestro rastreador de torrents. <br><br><img src="https://habrastorage.org/webt/p6/o3/o-/p6o3o-zt1k8yqi4ht_rcrxugyfg.png"><br><br>  Voila  Nuestro rastreador favorito se abri√≥ sin ninguna VPN o proxy.  Veamos ahora el vertedero de tr√°fico en Wirehark, lo que sucedi√≥. <br><br><img src="https://habrastorage.org/webt/ll/az/gj/llazgjig0xbha6ndnlvj0nqvziw.png"><br><br>  Esta vez, el paquete hello del cliente SSL no contiene expl√≠citamente el dominio de destino, sino que apareci√≥ un nuevo campo en el paquete - encrypted_server_name - aqu√≠ es donde est√° contenido el valor de rutracker.nl, y solo el servidor front-end cloudflare puede descifrar este campo.  Y si es as√≠, el proveedor DPI no tiene m√°s remedio que lavarse las manos y permitir ese tr√°fico.  Pero no hay otras opciones con cifrado. <br><br>  Entonces, ¬øc√≥mo funciona la tecnolog√≠a en el navegador?  Ahora intentemos aplicarlo para cosas m√°s espec√≠ficas e interesantes.  Y para empezar, ense√±aremos el mismo curl para usar eSNI para trabajar con TLS 1.3, y al mismo tiempo veremos c√≥mo funciona el dominio front-end basado en eSNI. <br><br><h3>  Dominio Front End con eSNI </h3><br>  Debido al hecho de que curl usa la biblioteca est√°ndar de openssl para conectarse a trav√©s de https, en primer lugar, debemos proporcionar soporte eSNI all√≠.  Todav√≠a no hay soporte para eSNI en las ramas maestras de openssl, por lo que debemos descargar la rama especial de openssl, compilarla e instalarla. <br><br>  Clonamos el repositorio del github y compilamos como de costumbre: <br><br><pre> <code class="plaintext hljs">$ git clone https://github.com/sftcd/openssl $ cd openssl $ ./config $ make $ cd esnistuff $ make</code> </pre><br>  A continuaci√≥n, clonamos el repositorio con curl y configuramos su compilaci√≥n utilizando nuestra biblioteca openssl ensamblada: <br><br><pre> <code class="plaintext hljs">$ cd $HOME/code $ git clone https://github.com/niallor/curl.git curl-esni $ cd curl-esni $ export LD_LIBRARY_PATH=/opt/openssl $ ./buildconf $ LDFLAGS="-L/opt/openssl" ./configure --with-ssl=/opt/openssl --enable-esni --enable-debug</code> </pre><br>  Es importante indicar correctamente todos los directorios donde se encuentra openssl (en nuestro caso, es / opt / openssl /) y asegurarse de que el proceso de configuraci√≥n no tenga errores. <br><br>  En caso de configuraci√≥n exitosa, veremos la l√≠nea: <br><br>  <b>ADVERTENCIA: esni ESNI habilitado pero marcado EXPERIMENTAL.</b>  <b>¬°Usar con precauci√≥n!</b> <br><br><pre> <code class="plaintext hljs">$ make</code> </pre> <br>  Despu√©s de compilar con √©xito el paquete, utilizaremos un archivo bash openssl especial para configurar y ejecutar curl.  C√≥pielo al directorio con curl por conveniencia: <br><br><pre> <code class="plaintext hljs">cp /opt/openssl/esnistuff/curl-esni</code> </pre> <br>  y ejecute una solicitud https de prueba al servidor cloudflare, mientras escribe simult√°neamente paquetes DNS y TLS en Wireshark. <br><br><pre> <code class="plaintext hljs">$ ESNI_COVER="www.hello-rkn.ru" ./curl-esni https://cloudflare.com/</code> </pre> <br>  En la respuesta del servidor, adem√°s de mucha informaci√≥n de depuraci√≥n de openssl y curl, obtenemos una respuesta HTTP con el c√≥digo 301 de cloudflare. <br><br><pre> <code class="plaintext hljs">HTTP/1.1 301 Moved Permanently &lt; Date: Sun, 03 Nov 2019 13:12:55 GMT &lt; Transfer-Encoding: chunked &lt; Connection: keep-alive &lt; Cache-Control: max-age=3600 &lt; Expires: Sun, 03 Nov 2019 14:12:55 GMT &lt; Location: https://www.cloudflare.com/</code> </pre><br>  lo que indica que nuestra solicitud fue entregada con √©xito al servidor de destino, escuchada y procesada. <br><br>  Ahora echemos un vistazo al vertedero de tr√°fico en wireshark, es decir  lo que vio el proveedor DPI en este caso. <br><br><img src="https://habrastorage.org/webt/sp/va/-o/spva-ogjvtwlfyiea9vg4n8qbla.png"><br><br>  Se puede ver que el primer rizo se dirigi√≥ al servidor DNS para obtener la clave p√∫blica eSNI para el servidor cloudflare: solicitud DNS TXT a _esni.cloudflare.com (paquete No. 13).  Luego, utilizando la biblioteca openssl, curl envi√≥ una solicitud TLS 1.3 al servidor cloudflare en el que el campo SNI se cifr√≥ con la clave p√∫blica obtenida en el paso anterior (paquete No. 22).  <b>Pero, adem√°s del campo eSNI, como parte del paquete SSL-hello, tambi√©n se insert√≥ un campo con el SNI abierto habitual, que podemos especificar en cualquier orden (en este caso, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.hello-rkn.ru</a> ).</b> <br><br>  Este campo del SNI abierto no se tuvo en cuenta al procesar en servidores cloudflare y fue solo un disfraz para el DPI del proveedor.  El servidor cloudflare recibi√≥ nuestro paquete ssl-hello, descifr√≥ el eSNI, extrajo el SNI original de all√≠ y lo proces√≥ como si nada hubiera pasado (hizo todo exactamente como estaba planeado durante el desarrollo del eSNI). <br><br>  Lo √∫nico en este caso es que puede aferrarse en t√©rminos de DPI, la consulta DNS principal en _esni.cloudflare.com.  Pero abrimos la consulta DNS solo para mostrar c√≥mo funciona este mecanismo desde adentro. <br><br>  Para finalmente eliminar el suelo de debajo del DPI, utilizamos el mecanismo de DNS sobre HTTPS ya mencionado.  Una peque√±a explicaci√≥n, DOH, un protocolo que te permite protegerte de un hombre en medio del ataque enviando una consulta DNS a trav√©s de HTTPS. <br><br>  Volveremos a ejecutar la solicitud, pero esta vez obtendremos las claves p√∫blicas eSNI utilizando el protocolo https, no el DNS: <br><br><pre> <code class="plaintext hljs">ESNI_COVER="www.hello-rkn.ru" DOH_URL=https://mozilla.cloudflare-dns.com/dns-query ./curl-esni https://cloudflare.com/</code> </pre> <br>  El volcado de tr√°fico de solicitud se presenta en la siguiente captura de pantalla: <br><br><img src="https://habrastorage.org/webt/qz/0m/ky/qz0mky5bwnmguhwleqennudeupc.png"><br><br>  Se ve que el primer curl accede al servidor mozilla.cloudflare-dns.com usando el protocolo DoH (conexi√≥n https al servidor 104.16.249.249) para obtener valores de clave p√∫blica para el cifrado SNI de ellos, y luego al servidor de destino, escondi√©ndose bajo el dominio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.hello-rkn.ru</a> . <br><br>  Adem√°s del Mozilla.cloudflare-dns.com resolver DoH especificado anteriormente, podemos utilizar otros servicios DoH populares, por ejemplo, de la famosa corporaci√≥n malvada. <br>  Ejecutamos la siguiente solicitud: <br><br><pre> <code class="plaintext hljs">ESNI_COVER="www.kremlin.ru" DOH_URL=https://dns.google/dns-query ./curl-esni https://rutracker.nl/</code> </pre> <br>  Y obtenemos la respuesta: <br><br><pre> <code class="plaintext hljs">&lt; HTTP/1.1 301 Moved Permanently &lt; Date: Sun, 03 Nov 2019 14:10:22 GMT &lt; Content-Type: text/html &lt; Transfer-Encoding: chunked &lt; Connection: keep-alive &lt; Set-Cookie: __cfduid=da0144d982437e77b0b37af7d00438b1a1572790222; expires=Mon, 02-Nov-20 14:10:22 GMT; path=/; domain=.rutracker.nl; HttpOnly; Secure &lt; Location: https://rutracker.nl/forum/index.php &lt; CF-Cache-Status: DYNAMIC &lt; Expect-CT: max-age=604800, report-uri="https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct" &lt; Server: cloudflare &lt; CF-RAY: 52feee696f42d891-CPH</code> </pre><br><img src="https://habrastorage.org/webt/dk/xk/b-/dkxkb-cudflzhgaxaebb1xhd9bw.png"><br><br>  En este caso, recurrimos al servidor bloqueado rutracker.nl, usando el dns.google DoH resolver (no hay error tipogr√°fico, ahora la famosa corporaci√≥n tiene su propio dominio de primer nivel) y nos cubrimos con otro dominio, que est√° estrictamente prohibido por todos los DPI para bloquear por miedo a la pena de muerte.  Seg√∫n la respuesta, puede comprender que nuestra solicitud se proces√≥ con √©xito. <br><br>  Como verificaci√≥n adicional de que el DPI del proveedor responde a un SNI abierto, que pasamos como una cubierta, podemos ejecutar una solicitud a rutracker.nl detr√°s de alg√∫n otro recurso prohibido, por ejemplo, otro rastreador de torrents "bueno": <br><br><pre> <code class="plaintext hljs">$ ESNI_COVER="rutor.info" DOH_URL=https://dns.google/dns-query ./curl-esni https://rutracker.nl/</code> </pre> <br>  No recibiremos una respuesta del servidor, ya que  nuestra solicitud ser√° bloqueada por el sistema DPI. <br><br><h3>  Una peque√±a conclusi√≥n a la primera parte. </h3><br>  Entonces, pudimos mostrar la salud de eSNI usando openssl y curl y probar el funcionamiento del front-end basado en dominio basado en eSNI.  Del mismo modo, podemos adaptar nuestras herramientas favoritas utilizando la biblioteca openssl para trabajar "bajo cubierta" de otros dominios.  M√°s sobre esto en nuestros pr√≥ximos art√≠culos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475372/">https://habr.com/ru/post/475372/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475354/index.html">Feliz d√≠a del especialista en seguridad</a></li>
<li><a href="../475358/index.html">An√°lisis salarial en el sector de TI de Armenia m√°s vacantes abiertas en las empresas de TI TOP10</a></li>
<li><a href="../475366/index.html">Droidcon London 2019: nuevas tendencias y los informes m√°s interesantes</a></li>
<li><a href="../475368/index.html">C√≥mo calcular la efectividad de la publicidad</a></li>
<li><a href="../475370/index.html">Algoritmo de Kahan: c√≥mo obtener la diferencia exacta de productos</a></li>
<li><a href="../475378/index.html">"No podemos dejar los derechos de datos personales a grandes empresas" - ex editor jefe de Wired UK sobre el futuro de la tecnolog√≠a</a></li>
<li><a href="../475382/index.html">¬øC√≥mo implementamos WebAssembly en Yandex.Maps y por qu√© dejamos JavaScript?</a></li>
<li><a href="../475384/index.html">¬øQu√© hay de nuevo en Spring Boot 2.2?</a></li>
<li><a href="../475386/index.html">Precauci√≥n, FAS: c√≥mo no violar la Ley de Publicidad. Memo del anunciante</a></li>
<li><a href="../475388/index.html">Semana de seguridad 46: micr√≥fonos, l√°ser y seguridad de m√°quinas capacitadas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>