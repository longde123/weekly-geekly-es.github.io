<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî∫ üë®üèº‚Äçüé® ü§πüèª Una aguja en una pila de sesiones, o un bytecode de expresi√≥n regular üö† üê© üëºüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="17 mil millones de eventos, 60 millones de sesiones de usuarios y una gran cantidad de fechas virtuales tienen lugar en Badoo diariamente. Cada evento...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Una aguja en una pila de sesiones, o un bytecode de expresi√≥n regular</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/433054/"><p><img src="https://habrastorage.org/webt/kz/rl/nu/kzrlnugblhii_j4jrsqzdk9fsgo.jpeg"></p><br><p>  17 mil millones de eventos, 60 millones de sesiones de usuarios y una gran cantidad de fechas virtuales tienen lugar en Badoo diariamente.  Cada evento se almacena perfectamente en bases de datos relacionales para su posterior an√°lisis en SQL y m√°s all√°. </p><br><p>  Bases de datos transaccionales distribuidas modernas con docenas de terabytes de datos: un verdadero milagro de la ingenier√≠a.  Pero SQL, como la encarnaci√≥n del √°lgebra relacional en la mayor√≠a de las implementaciones est√°ndar, todav√≠a no nos permite formular consultas en t√©rminos de tuplas ordenadas. </p><br><p>  En el √∫ltimo art√≠culo de la serie sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√°quinas</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">virtuales</a> , hablar√© sobre un enfoque alternativo para encontrar sesiones interesantes: el motor de expresi√≥n regular ( <a href="">Pig Match</a> ), que se define para secuencias de eventos. </p><br><p>  ¬°La m√°quina virtual, el c√≥digo de bytes y el compilador se incluyen de forma gratuita! </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Primera parte, introductoria</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Segunda parte, optimizaci√≥n</a> <br>  Tercera parte, aplicada (actual) </p><br><h1 id="o-sobytiyah-i-sessiyah">  Sobre eventos y sesiones </h1><br><p>  Supongamos que ya tenemos un almac√©n de datos que le permite ver de forma r√°pida y secuencial los eventos de cada una de las sesiones de usuario. </p><br><p> Queremos encontrar sesiones por solicitudes como "contar todas las sesiones donde hay una subsecuencia espec√≠fica de eventos", "buscar partes de una sesi√≥n descritas por un patr√≥n determinado", "devolver la parte de la sesi√≥n que ocurri√≥ despu√©s de un patr√≥n determinado" o "contar cu√°ntas sesiones alcanzaron ciertas partes plantilla ".  Esto puede ser √∫til para una variedad de tipos de an√°lisis: b√∫squeda de sesiones sospechosas, an√°lisis de embudos, etc. </p><br><p>  Las subsecuencias deseadas deben de alguna manera ser descritas.  En su forma m√°s simple, esta tarea es similar a encontrar una subcadena en un texto;  queremos tener una herramienta m√°s poderosa: expresiones regulares.  Las implementaciones modernas de motores de expresi√≥n regular utilizan con mayor frecuencia (¬°lo adivinaste!) M√°quinas virtuales. </p><br><p>  La creaci√≥n de peque√±as m√°quinas virtuales para emparejar sesiones con expresiones regulares se discutir√° a continuaci√≥n.  Pero primero, aclararemos las definiciones. </p><br><p>  <em>Un evento</em> consta de un tipo de evento, tiempo, contexto y un conjunto de atributos espec√≠ficos para cada tipo. </p><br><p>  <em>El tipo</em> y el <em>contexto de</em> cada evento son enteros de listas predefinidas.  Si todo est√° claro con los tipos de eventos, entonces el contexto es, por ejemplo, el n√∫mero de la pantalla en la que ocurri√≥ el evento dado. </p><br><p>  <em>Un atributo de</em> evento es un entero arbitrario cuyo significado est√° determinado por el tipo de evento.  Un evento puede no tener atributos, o puede haber varios. </p><br><p>  <em>Una sesi√≥n</em> es una secuencia de eventos ordenados por tiempo. </p><br><p>  Pero finalmente vamos al grano.  El zumbido, como dicen, disminuy√≥ y sal√≠ al escenario. </p><br><h1 id="sravnivaem-po-bumazhke">  Compara en una hoja de papel </h1><br><p><img src="https://habrastorage.org/webt/gu/ec/dw/guecdwuc3rhjl1oc6cvuk-4ec9k.jpeg"></p><br><p>  Una caracter√≠stica de esta m√°quina virtual es la pasividad con respecto a los eventos de entrada.  No queremos mantener toda la sesi√≥n en la memoria y permitir que la m√°quina virtual cambie independientemente de un evento a otro.  En cambio, alimentaremos los eventos de la sesi√≥n a la m√°quina virtual uno por uno. </p><br><p>  Definamos las funciones de la interfaz: </p><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">matcher *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *bytecode)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">match_result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(matcher *m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> event)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(matcher *matcher)</span></span></span></span>;</code> </pre> <br><p>  Si todo est√° claro con las funciones matcher_create y matcher_destroy, vale la pena comentar matcher_accept.  La funci√≥n matcher_accept recibe una instancia de la m√°quina virtual y el siguiente evento (32 bits, donde 16 bits para el tipo de evento y 16 bits para el contexto), y devuelve un c√≥digo que explica qu√© debe hacer el c√≥digo del usuario a continuaci√≥n: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> match_result { <span class="hljs-comment"><span class="hljs-comment">//       MATCH_NEXT, //    ,      MATCH_OK, //       ,      MATCH_FAIL, //     MATCH_ERROR, } match_result;</span></span></code> </pre><br><p>  C√≥digos de operaci√≥n de m√°quinas virtuales: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> matcher_opcode { <span class="hljs-comment"><span class="hljs-comment">//  ,      OP_ABORT, //      ( -  ) OP_NAME, //     ( -  ) OP_SCREEN, //    OP_NEXT, //    OP_MATCH, } matcher_opcode;</span></span></code> </pre><br><p>  El bucle principal de una m√°quina virtual: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">match_result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(matcher *m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> next_event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NEXT_OP() \ (*m-&gt;ip++) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NEXT_ARG() \ ((void)(m-&gt;ip += 2), (m-&gt;ip[-2] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 8) + m-&gt;ip[-1]) for (;;) { uint8_t instruction = NEXT_OP(); switch (instruction) { case OP_ABORT:{ return MATCH_ERROR; } case OP_NAME:{ uint16_t name = NEXT_ARG(); if (event_name(next_event) != name) return MATCH_FAIL; break; } case OP_SCREEN:{ uint16_t screen = NEXT_ARG(); if (event_screen(next_event) != screen) return MATCH_FAIL; break; } case OP_NEXT:{ return MATCH_NEXT; } case OP_MATCH:{ return MATCH_OK; } default:{ return MATCH_ERROR; } } } #undef NEXT_OP #undef NEXT_ARG }</span></span></span></span></code> </pre> <br><p>  En esta versi√≥n simple, nuestra m√°quina virtual coincide secuencialmente con el patr√≥n descrito por bytecode con los eventos entrantes.  Como tal, esto simplemente no es una comparaci√≥n muy concisa de los <em>prefijos de</em> dos l√≠neas: la plantilla deseada y la l√≠nea de entrada. </p><br><p>  Los prefijos son prefijos, pero queremos encontrar los patrones deseados no solo al principio, sino tambi√©n en un lugar arbitrario de la sesi√≥n.  La soluci√≥n ingenua es reiniciar la coincidencia de cada evento de sesi√≥n.  Pero esto implica una visualizaci√≥n m√∫ltiple de cada uno de los eventos y comer beb√©s algor√≠tmicos. </p><br><p>  <a href="">El ejemplo</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primer art√≠culo de la</a> serie, en efecto, simula reiniciar una partida usando la reversi√≥n (retroceso en ingl√©s).  El c√≥digo en el ejemplo parece, por supuesto, m√°s delgado que el que se da aqu√≠, pero el problema no ha desaparecido: cada uno de los eventos tendr√° que verificarse muchas veces. </p><br><p>  No puedes vivir as√≠. </p><br><h1 id="ya-esche-raz-ya-i-snova-ya">  Yo, yo otra vez y yo otra vez </h1><br><p><img src="https://habrastorage.org/webt/bq/ue/gt/bquegtp3mpd4rxv65f1fk-svdjk.jpeg"></p><br><p>  Una vez m√°s, describamos el problema: debemos hacer coincidir la plantilla con los eventos entrantes, comenzando por cada uno de los eventos comenzando una nueva comparaci√≥n.  Entonces, ¬øpor qu√© no hacemos exactamente eso?  ¬°Deje que la m√°quina virtual camine sobre los eventos entrantes en varios hilos! </p><br><p>  Para hacer esto, necesitamos obtener una nueva entidad: una secuencia.  Cada hilo almacena un solo puntero - a la instrucci√≥n actual: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matcher_thread</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *ip; } matcher_thread;</code> </pre><br><p>  Naturalmente, ahora en la m√°quina virtual en s√≠ no almacenaremos el puntero expl√≠cito.  Ser√° reemplazado por dos listas de hilos (m√°s sobre ellos a continuaci√≥n): </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matcher</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *bytecode; <span class="hljs-comment"><span class="hljs-comment">/* Threads to be processed using the current event */</span></span> matcher_thread current_threads[MAX_THREAD_NUM]; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> current_thread_num; <span class="hljs-comment"><span class="hljs-comment">/* Threads to be processed using the event to follow */</span></span> matcher_thread next_threads[MAX_THREAD_NUM]; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> next_thread_num; } matcher;</code> </pre><br><p>  Y aqu√≠ est√° el bucle principal actualizado: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">match_result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(matcher *m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> next_event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NEXT_OP(thread) \ (*(thread).ip++) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NEXT_ARG(thread) \ ((void)((thread).ip += 2), ((thread).ip[-2] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 8) + (thread).ip[-1]) /*         - */ add_current_thread(m, initial_thread(m)); //         for (size_t thread_i = 0; thread_i &lt; m-&gt;current_thread_num; thread_i++ ) { matcher_thread current_thread = m-&gt;current_threads[thread_i]; bool thread_done = false; while (!thread_done) { uint8_t instruction = NEXT_OP(current_thread); switch (instruction) { case OP_ABORT:{ return MATCH_ERROR; } case OP_NAME:{ uint16_t name = NEXT_ARG(current_thread); //  ,      ,    //     next_threads,    if (event_name(next_event) != name) thread_done = true; break; } case OP_SCREEN:{ uint16_t screen = NEXT_ARG(current_thread); if (event_screen(next_event) != screen) thread_done = true; break; } case OP_NEXT:{ //    , ..      // next_threads add_next_thread(m, current_thread); thread_done = true; break; } case OP_MATCH:{ return MATCH_OK; } default:{ return MATCH_ERROR; } } } } /*      ,    */ swap_current_and_next(m); return MATCH_NEXT; #undef NEXT_OP #undef NEXT_ARG }</span></span></span></span></code> </pre><br><p>  En cada evento recibido, primero agregamos un nuevo hilo a la lista current_threads, verificando la plantilla desde el principio, luego de lo cual comenzamos a rastrear la lista current_threads, siguiendo cada puntero siguiendo las instrucciones. </p><br><p>  Si se encuentra una instrucci√≥n NEXT, el subproceso se coloca en la lista next_threads, es decir, espera a que se reciba el pr√≥ximo evento. </p><br><p>  Si el patr√≥n de hilo no coincide con el evento recibido, dicho hilo simplemente no se agrega a la lista next_threads. </p><br><p>  La instrucci√≥n MATCH sale inmediatamente de la funci√≥n, informando un c√≥digo de retorno que el patr√≥n coincide con la sesi√≥n. </p><br><p>  Al finalizar el rastreo de la lista de subprocesos, se intercambian las listas actuales y siguientes. </p><br><p>  En realidad, eso es todo.  Podemos decir que literalmente estamos haciendo lo que quer√≠amos: al mismo tiempo estamos verificando varias plantillas, lanzando un nuevo proceso de coincidencia para cada uno de los eventos de la sesi√≥n. </p><br><h1 id="mnozhestvennye-lichnosti-i-vetvleniya-v-shablonah">  M√∫ltiples identidades y ramas en plantillas </h1><br><p><img src="https://habrastorage.org/webt/8l/gv/-e/8lgv-e5bp1xhv0ksukeacrhasaq.jpeg"></p><br><p>  La b√∫squeda de una plantilla que describa una secuencia lineal de eventos es, por supuesto, √∫til, pero queremos obtener expresiones regulares completas.  Y los flujos que creamos en la etapa anterior tambi√©n son √∫tiles aqu√≠. </p><br><p>  Supongamos que queremos encontrar una secuencia de dos o tres eventos que nos interesen, algo as√≠ como una expresi√≥n regular en l√≠neas: "a? Bc".  En esta secuencia, el s√≠mbolo "a" es opcional.  ¬øC√≥mo expresarlo en bytecode?  F√°cil! </p><br><p>  Podemos comenzar <em>dos</em> hilos, uno para cada caso: con el s√≠mbolo "a" y sin √©l.  Para hacer esto, presentamos una instrucci√≥n adicional (del tipo SPLIT addr1, addr2), que inicia dos hilos desde las direcciones especificadas.  Adem√°s de SPLIT, JUMP tambi√©n es √∫til para nosotros, que simplemente contin√∫a la ejecuci√≥n con la instrucci√≥n especificada en el argumento directo: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> matcher_opcode { OP_ABORT, OP_NAME, OP_SCREEN, OP_NEXT, <span class="hljs-comment"><span class="hljs-comment">//     OP_JUMP, //         OP_SPLIT, OP_MATCH, //     OP_NUMBER_OF_OPS, } matcher_opcode;</span></span></code> </pre> <br><p>  El ciclo en s√≠ y el resto de las instrucciones no cambian, solo presentamos dos nuevos controladores: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ... case OP_JUMP:{ /*   ,      */ uint16_t offset = NEXT_ARG(current_thread); add_current_thread(m, create_thread(m, offset)); break; } case OP_SPLIT:{ /*        */ uint16_t left_offset = NEXT_ARG(current_thread); uint16_t right_offset = NEXT_ARG(current_thread); add_current_thread(m, create_thread(m, left_offset)); add_current_thread(m, create_thread(m, right_offset)); break; } // ...</span></span></code> </pre><br><p>  Tenga en cuenta que las instrucciones agregan hilos a la lista actual, es decir, contin√∫an funcionando en el contexto del evento actual.  El hilo dentro del cual se produjo la rama no entra en la lista de los siguientes hilos. </p><br><p>  Lo m√°s sorprendente de esta m√°quina virtual de expresi√≥n regular es que nuestros hilos y este par de instrucciones son suficientes para expresar casi todas las construcciones generalmente aceptadas cuando se combinan cadenas. </p><br><h1 id="regulyarnye-vyrazheniya-na-sobytiyah">  Expresiones regulares sobre eventos. </h1><br><p>  Ahora que tenemos una m√°quina virtual adecuada y herramientas para ello, podemos manejar la sintaxis de nuestras expresiones regulares. </p><br><p>  La grabaci√≥n manual de c√≥digos de operaci√≥n para programas m√°s serios se cansa r√°pidamente.  La √∫ltima vez, no hice un analizador completo, pero el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">usuario</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">verdadero</a> mostr√≥ las capacidades de su biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">raddsl usando el</a> mini lenguaje <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PigletC</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">como</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejemplo</a> .  Estaba tan impresionado con la brevedad del c√≥digo que, con la ayuda de raddsl, escrib√≠ un peque√±o compilador de expresiones regulares de cadenas en cien o doscientos en Python.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El compilador</a> y las instrucciones para su uso est√°n en GitHub.  El resultado del compilador en lenguaje ensamblador es entendido por una utilidad que lee dos archivos (un programa para una m√°quina virtual y una lista de eventos de sesi√≥n para verificaci√≥n). </p><br><p>  Para empezar, nos restringimos al tipo y al contexto del evento.  El tipo de evento se denota con un solo n√∫mero;  si necesita especificar un contexto, especif√≠quelo con dos puntos.  El ejemplo m√°s simple: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "13" # ,     13 NEXT NAME 13 MATCH</code> </pre> <br><p>  Ahora un ejemplo con contexto: </p><br><pre> <code class="plaintext hljs">python regexp/regexp.py "13:12" #  13,  12 NEXT NAME 13 SCREEN 12 MATCH</code> </pre> <br><p>  Los sucesivos eventos deben estar separados de alguna manera (por ejemplo, por espacios): </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "13 11 10:9" 08:40:52 NEXT NAME 13 NEXT NAME 11 NEXT NAME 10 SCREEN 9 MATCH</code> </pre> <br><p>  Plantilla m√°s interesante: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "12|13" SPLIT L0 L1 L0: NEXT NAME 12 JUMP L2 L1: NEXT NAME 13 L2: MATCH</code> </pre> <br><p>  Presta atenci√≥n a las l√≠neas que terminan con dos puntos.  Estas son las etiquetas.  La instrucci√≥n SPLIT crea dos subprocesos que contin√∫an la ejecuci√≥n desde las etiquetas L0 y L1, y JUMP al final de la primera rama de ejecuci√≥n simplemente contin√∫a hasta el final de la rama. </p><br><p>  Puede elegir entre cadenas de expresiones m√°s verdaderamente agrupando subsecuencias entre par√©ntesis: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "(1 2 3)|4" SPLIT L0 L1 L0: NEXT NAME 1 NEXT NAME 2 NEXT NAME 3 JUMP L2 L1: NEXT NAME 4 L2: MATCH</code> </pre> <br><p>  Un evento arbitrario se indica con un punto: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py ". 1" NEXT NEXT NAME 1 MATCH</code> </pre> <br><p>  Si queremos mostrar que la subsecuencia es opcional, le ponemos un signo de interrogaci√≥n: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "1 2 3? 4" NEXT NAME 1 NEXT NAME 2 SPLIT L0 L1 L0: NEXT NAME 3 L1: NEXT NAME 4 MATCH</code> </pre> <br><p>  Por supuesto, las repeticiones regulares m√∫ltiples (m√°s o asterisco) tambi√©n son comunes en las expresiones regulares: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "1+ 2" L0: NEXT NAME 1 SPLIT L0 L1 L1: NEXT NAME 2 MATCH</code> </pre> <br><p>  Aqu√≠ simplemente ejecutamos la instrucci√≥n SPLIT muchas veces, comenzando nuevos hilos en cada ciclo. </p><br><p>  Del mismo modo con un asterisco: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "1* 2" L0: SPLIT L1 L2 L1: NEXT NAME 1 JUMP L0 L2: NEXT NAME 2 MATCH</code> </pre> <br><p><img src="https://habrastorage.org/webt/g-/ud/3s/g-ud3s00i4ccyhf4lp5huusjlyu.jpeg"></p><br><h1 id="perspektiva">  Perspectiva </h1><br><p>  Otras extensiones a la m√°quina virtual descrita pueden ser √∫tiles. </p><br><p>  Por ejemplo, se puede expandir f√°cilmente al verificar los atributos del evento.  Para un sistema real, supongo que usar una sintaxis como "1: 2 {3: 4, 5:&gt; 3}", que significa: evento 1 en el contexto 2 con el atributo 3 que tiene el valor 4 y el valor del atributo 5 mayor que 3. Aqu√≠ los atributos simplemente puede pasarlo en una matriz a la funci√≥n matcher_accept. </p><br><p>  Si tambi√©n pasa el intervalo de tiempo entre eventos a matcher_accept, puede agregar una sintaxis al lenguaje de plantilla que le permite omitir el tiempo entre eventos: "1 mindelta (120) 2", que significar√°: evento 1, entonces el intervalo es de al menos 120 segundos, evento 2 Combinado con la preservaci√≥n de una subsecuencia, esto le permite recopilar informaci√≥n sobre el comportamiento del usuario entre dos subsecuencias de eventos. </p><br><p>  Otras cosas √∫tiles que son relativamente f√°ciles de agregar son: almacenar subsecuencias de expresiones regulares, separar los operadores de asterisco codiciosos y ordinarios y m√°s, y as√≠ sucesivamente.  En t√©rminos de la teor√≠a de los aut√≥matas, nuestra m√°quina virtual es un aut√≥mata finito no determinista, para cuya implementaci√≥n no es dif√≠cil hacer tales cosas. </p><br><h1 id="zaklyuchenie">  Conclusi√≥n </h1><br><p>  Nuestro sistema est√° desarrollado para interfaces de usuario r√°pidas, por lo tanto, el motor de almacenamiento de la sesi√≥n est√° escrito y optimizado espec√≠ficamente para el paso por todas las sesiones.  Todos los miles de millones de eventos divididos en sesiones se comparan con patrones en segundos en un solo servidor. </p><br><p>  Si la velocidad no es tan cr√≠tica para usted, entonces se puede dise√±ar un sistema similar como una extensi√≥n para un sistema de almacenamiento de datos m√°s est√°ndar, como una base de datos relacional tradicional o un sistema de archivos distribuido. </p><br><p>  Por cierto, en las √∫ltimas versiones del <a href="">est√°ndar SQL</a> ya apareci√≥ <a href="">una</a> caracter√≠stica similar a la descrita en el art√≠culo, y las bases de datos individuales ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Oracle</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vertica</a> ) ya lo han implementado.  Yandex ClickHouse, a su vez, implementa su propio lenguaje tipo SQL, pero tambi√©n tiene <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">funciones similares</a> . </p><br><p>  Distrayendo eventos y expresiones regulares, quiero repetir que la aplicabilidad de las m√°quinas virtuales es mucho m√°s amplia de lo que parece a primera vista.  Esta t√©cnica es adecuada y ampliamente utilizada en todos los casos en que es necesario distinguir claramente entre las primitivas que el motor del sistema comprende y el subsistema "frontal", es decir, por ejemplo, alg√∫n lenguaje DSL o de programaci√≥n. </p><br><p>  Esto concluye una serie de art√≠culos sobre los diversos usos de los int√©rpretes de c√≥digo de bytes y las m√°quinas virtuales.  Espero que a los lectores de Habr les haya gustado la serie y, por supuesto, estar√© encantado de responder cualquier pregunta sobre el tema. </p><br><h1 id="neformalnyy-spisok-literatury">  Referencias informales </h1><br><p>  Los int√©rpretes de c√≥digo de bytes para lenguajes de programaci√≥n son un tema espec√≠fico, y hay relativamente poca literatura sobre ellos.  Personalmente, me gust√≥ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el</a> libro de Ian Craig, Virtual Machines, aunque describe no tanto la implementaci√≥n de int√©rpretes como m√°quinas abstractas, modelos matem√°ticos que subyacen a varios lenguajes de programaci√≥n. </p><br><p>  En un sentido m√°s amplio, otro libro est√° dedicado a las m√°quinas virtuales: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"M√°quinas virtuales: plataformas flexibles para sistemas y procesos"</a> ("M√°quinas virtuales: plataformas vers√°tiles para sistemas y procesos").  Esta es una introducci√≥n a las diversas aplicaciones de virtualizaci√≥n, que abarca la virtualizaci√≥n de lenguajes, procesos y arquitecturas inform√°ticas en general. </p><br><p>  Los aspectos pr√°cticos del desarrollo de motores de expresi√≥n regular rara vez se discuten en la popular literatura del compilador.  Pig Match y el ejemplo del primer art√≠culo se basan en ideas de una sorprendente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">serie de art√≠culos de</a> Russ Cox, uno de los desarrolladores del motor Google RE2. </p><br><p>  La teor√≠a de las expresiones regulares se presenta en todos los libros de texto acad√©micos en compiladores.  Es costumbre referirse al famoso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Libro del Drag√≥n"</a> , pero recomendar√≠a comenzar con el enlace de arriba. </p><br><p>  Mientras trabajaba en este art√≠culo, utilic√© por primera vez un sistema interesante para el r√°pido desarrollo de compiladores para Python <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">raddsl</a> , que pertenece al bol√≠grafo del usuario <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">true-grue</a> (¬°gracias, Peter!).  Si se enfrenta a la tarea de crear prototipos de un lenguaje o desarrollar r√°pidamente alg√∫n tipo de DSL, debe prestarle atenci√≥n. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433054/">https://habr.com/ru/post/es433054/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433044/index.html">El c√≥digo fuente de OpenJDK contiene demasiadas palabras malas</a></li>
<li><a href="../es433046/index.html">Toda la verdad sobre RTOS. Art√≠culo # 25. Canales de datos: introducci√≥n y servicios b√°sicos</a></li>
<li><a href="../es433048/index.html">C√≥mo 2019 cambiar√° las tiendas rusas</a></li>
<li><a href="../es433050/index.html">De un dise√±ador de aviones a un programador en un a√±o, o c√≥mo convertirse en un Jedi</a></li>
<li><a href="../es433052/index.html">snap & flatpack - tragedia de comunidades</a></li>
<li><a href="../es433056/index.html">El Ministerio de Comunicaciones endurece las reglas para el software con elementos de origen extranjero</a></li>
<li><a href="../es433058/index.html">Quinteto como entidad b√°sica para describir un √°rea tem√°tica</a></li>
<li><a href="../es433060/index.html">Por qu√© no creo microbenchmarks</a></li>
<li><a href="../es433062/index.html">AXIS P1367 versus IDIS DC-B3303X: Comparar c√°maras CCTV</a></li>
<li><a href="../es433064/index.html">Gesti√≥n de incidentes: "no puede darse por vencido" o el arte de colocar comas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>