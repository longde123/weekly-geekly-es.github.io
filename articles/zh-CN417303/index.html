<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📨 🥨 🏇🏽 破解以支持Windows Android耳机按钮 🤧 ⛺️ 🥚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="几乎每天我都会在智能手机上听音乐，并使用耳机上的控制按钮。 但是我总是不喜欢一件事。 我回到家，继续聆听，耳机连接到我的家用PC，然后按钮突然停止工作。 

 当然，我用谷歌搜索了这个问题的解决方案。 不幸的是，在Windows上并没有太支持此功能。 几分钟的搜索仅在Stack Overflow上模...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>破解以支持Windows Android耳机按钮</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417303/">几乎每天我都会在智能手机上听音乐，并使用耳机上的控制按钮。 但是我总是不喜欢一件事。 我回到家，继续聆听，耳机连接到我的家用PC，然后按钮突然停止工作。 <br><br> 当然，我用谷歌搜索了这个问题的解决方案。 不幸的是，在Windows上并没有太支持此功能。 几分钟的搜索仅在Stack Overflow上模糊地提及了声卡和一些人发出的消息，指出在笔记本电脑上一切正常。 <br><br> 这并没有吓到我-我决定接受这个问题，这是一个有趣的挑战：如果根本没有硬件支持，可以创建某种程序来激活控制按钮吗？ 答案是可以的。 这是在半小时内完成操作的方法。 <br><a name="habracut"></a><br><h1>  Android耳机按钮如何工作 </h1><br> 首先要了解的是耳机按钮如何工作。 在互联网上进行的快速搜索从Android文档中找到了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此规范</a> 。 那里有一张图表。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2c1/882/895/2c18828956a43cf35e9576f48733abc0.png"><br><br> 如您所知，当您按下耳机上的按钮时，其中一个电阻器上的电路会闭合。 特别值得注意的是电阻为0欧姆的按钮A（播放/暂停/挂钩），即麦克风短路。 如果我们能够检测到麦克风短路，则可以确定按下“播放/暂停”按钮。 <br><br><h1> 假设检验 </h1><br> 在开始编程之前，我想原则上检查我们推理的合理性。 也就是说，可以通过按下“播放/暂停”按钮来确定来自麦克风的信号。 幸运的是，为此只需在计算机上录制声音并查看结果就足够了。 我启动了Audacity，在录制过程中按下了播放/暂停按钮-并收到了这样的信号。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/441/8d1/43a/4418d143a264981f60181740773525e8.png"><br>  <i><font color="gray">宾果</font></i> <br><br> 如您所见，按下按钮显然会反映在波形中：突然下降到-1，然后突然过渡到1，然后逐渐下降到0。根据规范，从直觉上讲，我认为信号会跳到1并保持在那里，直到释放按钮为止，但是实际上，它看起来有所不同。 尽管如此，如果您从麦克风捕获音频流，仍然很容易检测到此类图片。 <br><br><h1> 使用Python进行声音捕捉 </h1><br> 知道了检测耳机上按钮按下的方式后，您可以想到主要目标：如何使用耳机按钮在桌面上控制播放器。 <br><br> 第一步是检测按钮单击。 为此，您需要从麦克风获取音频流，并发现我们之前看到的独特签名。 为简单起见，我们在Python中实现该解决方案。 在Internet上进行了另一个小型搜索之后，我发现了一个名为sounddevice的程序包，该程序包使您可以从最困难的部分中进行抽象-从麦克风捕获真实的音频。 <br><br> 一点点编码即可为我们提供以下内容： <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sounddevice <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sd SAMPLE_RATE = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-comment"><span class="hljs-comment"># Sample rate for our input stream BLOCK_SIZE = 100 # Number of samples before we trigger a processing callback class HeadsetButtonController: def process_frames(self, indata, frames, time, status): mean = sum([y for x in indata[:] for y in x])/len(indata[:]) print(mean) def __init__(self): self.stream = sd.InputStream( samplerate=SAMPLE_RATE, blocksize=BLOCK_SIZE, channels=1, callback=self.process_frames ) self.stream.start() if __name__ == '__main__': controller = HeadsetButtonController() while True: pass</span></span></code> </pre> <br> 这样的代码连续产生每批样品的平均值。 我们将采样率设置为1000，这对于声音处理来说是非常小的（通常使用44100），但是我们实际上并不需要太多的准确性。 块大小确定缓冲区中有多少样本触发回调。 同样，我们将值设置得很低。 块大小为100，采样率为1000，实际上意味着每秒触发10次，每次调用仅处理100个采样。 <br><br><h1> 按钮点击检测：可能太容易了 </h1><br> 现在，我们捕获音频流，并且可以实现检测按钮按下的真实机制。 回想一下，每按一次，信号会跳至1。 这建议了最简单的检测方法：如果<i>N</i>个连续的块的信号值大于0.9，即单击。 <br><br> 我们在函数中实现算法： <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sounddevice <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sd SAMPLE_RATE = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-comment"><span class="hljs-comment"># Sample rate for our input stream BLOCK_SIZE = 100 # Number of samples before we trigger a processing callback PRESS_SECONDS = 0.2 # Number of seconds button should be held to register press PRESS_SAMPLE_THRESHOLD = 0.9 # Signal amplitude to register as a button press BLOCKS_TO_PRESS = (SAMPLE_RATE/BLOCK_SIZE) * PRESS_SECONDS ... def process_frames(self, indata, frames, time, status): mean = sum([y for x in indata[:] for y in x])/len(indata[:]) if mean &lt; PRESS_SAMPLE_THRESHOLD: self.times_pressed += 1 if self.times_pressed &gt; BLOCKS_TO_PRESS and not self.is_held: # The button was pressed! self.is_held = True else: self.is_held = False self.times_pressed = 0 ...</span></span></code> </pre> <br> 实际上，我们启动了一个内部计数器，其中有多少个已处理的块满足阈值要求（将其简单地设置为0.9），可提供不可避免的样本噪声。 如果该块不满足要求，则将计数器重置-然后重新开始。  <code>is_held</code>变量监视触发器，以便在不释放按钮时不重复注册它们。 <br><br><h1>  Windows播放控制 </h1><br> 现在只剩下替换注释<i>“按下了按钮！”</i> 。 在Windows中控制音频播放。  Google再次弄清楚如何做到这一点：事实证明，您可以通过使用相应的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">虚拟按键代码</a>模拟击键来控制播放。 <br><br> 事实证明，使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">pywin32</a>软件包来模拟击键非常容易，该软件包只是Windows API的Python外壳。 放在一起，我们可以创建以下函数： <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> win32api <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> win32con VK_MEDIA_PLAY_PAUSE = <span class="hljs-number"><span class="hljs-number">0xB3</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggle_play</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> win32api.keybd_event(VK_MEDIA_PLAY_PAUSE, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br> 而我们做到了！ 在注释<i>“按下按钮！”</i>的代码处<code>toggle_play</code>函数<i>。</i>  ，可让您使用Android耳机上的按钮控制Windows中的任何媒体播放器。 <br><br> 测试表明，该代码运行良好。 按下按钮时，Android和Windows功能的唯一区别是稍有延迟，但可以忍受。 <br><br><img src="https://habrastorage.org/webt/ee/0p/xs/ee0pxsnctd0niuy9xz6owimfwlq.gif"><br>  <i><font color="gray">所以发生了什么</font></i> <br><br>  Python脚本由51行组成，这些行可激活Windows上Android耳机上的按钮。 该项目的最终源代码<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在Github上</a> 。 <br><br><h1> 等等，还不止这些！ </h1><br> 在愉快地使用该程序几个小时后，我注意到了一个严重的问题： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f32/634/dfa/f32634dfadf2c3def8b838e54ae893ff.png"><br><br> 该程序几乎占用了30％的CPU！ 显然，在长时间的工作中这是不可接受的，需要做一些事情。 查看代码，我意识到主线程在主循环中处于空闲状态，尽管那里什么也没有发生。 最合乎逻辑的解决方案是永远永远使线程安乐死：由于回调是自动调用的，因此我们仍然不需要循环。 <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sleep <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: controller = HeadsetButtonController() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>)</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/772/cfc/082/772cfc082d4e852beb43ed4faa5c92ac.png"><br><br> 我也不想在每次计算机启动后手动运行Python脚本。 幸运的是，Windows版Python附带了一个名为pythonw.exe的有用实用程序，该实用程序无需连接终端即可启动守护进程。 我们在<i>Microsoft \ Windows \ Start Menu \ Programs \ Startup</i>目录中放置此过程的快捷方式，将我们的脚本指定为第一个参数-然后该应用程序自动启动并在后台安静地运行。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN417303/">https://habr.com/ru/post/zh-CN417303/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN417293/index.html">云中的密码恢复和主存储，或Zimbra 8.8.9的新增功能</a></li>
<li><a href="../zh-CN417295/index.html">我如何编写标准的C ++ 11库，或者为什么boost如此令人恐惧。 第三章</a></li>
<li><a href="../zh-CN417297/index.html">恐惧和厌恶威胁情报或8个TI实用技巧</a></li>
<li><a href="../zh-CN417299/index.html">在线，离线和P2P：如何在俄罗斯购买比特币</a></li>
<li><a href="../zh-CN417301/index.html">平稳释放配方：PMy注意</a></li>
<li><a href="../zh-CN417305/index.html">《创世纪》在线：后台外观</a></li>
<li><a href="../zh-CN417307/index.html">青光眼-没有听说过她吗？ 认识连续无声视觉杀手</a></li>
<li><a href="../zh-CN417309/index.html">幸运的是，ITSM经理：未来的职业如何帮助扩大服务台边界</a></li>
<li><a href="../zh-CN417311/index.html">基于循环神经网络创建一个机器人参加AI mini Cup 2018</a></li>
<li><a href="../zh-CN417315/index.html">Dropbox中的数据库开发。 从一个全球MySQL数据库到数千台服务器的路径</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>