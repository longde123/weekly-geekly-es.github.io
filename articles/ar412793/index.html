<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍⚕️ 👴 🧝🏻 MassTransit و Saga و RabbitMQ لتطبيق مدير العمليات 🔐 🍅 🧓🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ذات مرة ، واجهنا مهمة أتمتة عمليات سير العمل المختلفة في شركة كبيرة. بالنسبة لنا ، كان هذا يعني تجميع حوالي 10 أنظمة في وقت الإطلاق. علاوة على ذلك ، ك...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MassTransit و Saga و RabbitMQ لتطبيق مدير العمليات</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/412793/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ذات مرة ، واجهنا مهمة أتمتة عمليات سير العمل المختلفة في شركة كبيرة.  بالنسبة لنا ، كان هذا يعني تجميع حوالي 10 أنظمة في وقت الإطلاق.  علاوة على ذلك ، كان يجب توصيل كل شيء بشكل غير متزامن ، وقابل للتوسع ، وموثوق. </p><br><p style=";text-align:right;direction:rtl">  يمكن وصف العملية المبسطة بأنها سلسلة من الإجراءات في أنظمة مختلفة ، والتي لا يمكن أن تكون مؤتمتة بالكامل ، لأنها تتطلب مشاركة بشرية.  على سبيل المثال ، لتحديد إجراءات معينة أو التنسيق الأولي ، وهو أمر ضروري للانتقال إلى المرحلة التالية من العملية. </p><br><p style=";text-align:right;direction:rtl">  لحل هذه المشكلة ، قررنا استخدام بنية المراسلة عبر ناقل البيانات ، و MassTransit مع Saga بالتزامن مع RabbitMQ يناسبنا تمامًا. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/8f9/896/b2a/8f9896b2aade49a732cf10b63b8276ec.jpg" alt="الصورة"><a name="habracut"></a></p><h2 style=";text-align:right;direction:rtl">  كيف تبدو ساجا؟ </h2><br>  Saga عبارة عن تطبيق لقالب إدارة العمليات من كتاب <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">قوالب تكامل تطبيق Enterprise</a> ، والذي يسمح لك بوصف العملية كآلة حالة.  يصل حدث عند المدخل ، وتقوم Saga بسلسلة من الإجراءات.  في نفس الوقت ، في أي مرحلة من مراحل Saga ، قد يكون قرار الشخص مطلوبًا.  ثم تقوم بإنشاء مهمة في أداة التتبع و "تغفو" لفترة غير محددة ، في انتظار أحداث جديدة. <br><p style=";text-align:right;direction:rtl">  تستند Saga على <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Automatonymous</a> .  يوصف بشكل صريح في فئة موروثة من MassTransitStateMachine &lt;&gt;.  بالنسبة إلى Saga ، تحتاج إلى وصف جميع الحالات والأحداث المتخذة والإجراءات المتخذة عند حدوث أحداث معينة.  يتم تخزين الحالة الحالية في قاعدة البيانات. </p><br><p style=";text-align:right;direction:rtl">  أولاً ، نصف جميع حالات وأحداث ساجا ونمنحهم أسماء مفهومة.  يبدو هذا: </p><br><pre style=";text-align:right;direction:rtl"><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateMachine</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingTaskCreated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingTaskTakedToWork { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingDecisionAboutTask { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State Rejected { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;IStartWorkflowCommand&gt; StartWorkflowCommandReceived { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskCreatedNotification&gt; TaskCreated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskTakedToWorkNotification&gt; TaskTakedToWork { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskDeclinedNotification&gt; TaskDeclined { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskApprovedNotification&gt; TaskApproved { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildStateMachine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InstanceState(x =&gt; x.CurrentState); Event(() =&gt; StartWorkflowCommandReceived, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId) .SelectId(context =&gt; context.Message.CorrelationId)); Event(() =&gt; TaskCreated, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskTakedToWork, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskDeclined, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskApproved, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  لقد أطلقنا فئة جزئية ، حيث نعلن قائمة بجميع الحالات والأحداث ، وأسلوب BuildStateMachine ، الذي يصف علاقة الأحداث مع Saga.  للقيام بذلك ، يتم تمرير معلمة خاصة CorrelationId في كل حدث - وهذا هو التوجيه ، الذي يعمل بين جميع الأنظمة المتصلة وأنظمة المراقبة. </p><br><p style=";text-align:right;direction:rtl">  وبالتالي ، إذا ظهرت أي مشاكل ، فيمكننا استعادة الصورة الكاملة لما يحدث بالسجلات من جميع الأنظمة المتصلة.  نرسل CorrelationId في رسائل من Saga ، وترسلها الأنظمة مرة أخرى في الإشعارات حتى نتمكن من ربط الرسالة بساجا محددة. </p><br><p style=";text-align:right;direction:rtl">  فيما يلي مثال لفئة آلة الدولة نفسها: </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed partial <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> StateMachine : MassTransitStateMachine&lt;WorkflowSaga&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> StateMachine() { BuildStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">Initially</span></span>(WhenStartWorkflowCommandReceived()); During(AwaitingTaskCreatedInPlanner, WhenTaskCreated()); During(AwaitingTaskTakedToWork, WhenTaskTakedToWork()); During(AwaitingDecisionAboutTask, WhenTaskApproved(), WhenTaskDeclined()); } private EventActivityBinder&lt;WorkflowSaga, IStartWorkflowCommand&gt; WhenStartWorkflowCommandReceived() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(StartWorkflowCommandReceived) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.SaveConfigurationRequestInfo(ctx.Data)) .Send(TaskManagerQueue, ctx =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CreateTaskCommand(ctx.Instance)) .TransitionTo(AwaitingTaskCreated); } private EventActivityBinder&lt;WorkflowSaga, TaskCreatedNotification&gt; WhenTaskCreated() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(DPORPApproveTaskCreatedInPlanner) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.SaveCreatedTaskInfo(ctx.Data)) .Send(MailServiceQueue, ctx =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NotifyRequestAuthorThatWorkflowStarted(ctx.Instance)) .TransitionTo(AwaitingTaskTakedToWork); } private EventActivityBinder&lt;WorkflowSaga, TaskTakedToWorkNotification&gt; WhenTaskTakedToWork() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskTakedToWork) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsTakedToWork(ctx.Data)) .TransitionTo(AwaitingDecisionAboutTask); } private EventActivityBinder&lt;WorkflowSaga, TaskApprovedNotification&gt; WhenTaskApproved() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskApproved) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsApproved(ctx.Data)) .Finalize(); } private EventActivityBinder&lt;WorkflowSaga, TaskDeclinedNotification&gt; WhenTaskDeclined() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskDeclined) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsDeclined(ctx.Data)) .TransitionTo(Rejected); } }</code> </pre><br><p style=";text-align:right;direction:rtl">  يصف المنشئ الولايات.  يتم استقبال كل حدث بطريقة منفصلة من أجل الحفاظ على سهولة القراءة.  يتم تنفيذ المنطق الكامل لبناء الرسائل في الرسائل نفسها ، وإلا ، مع التعقيد المتزايد للنظام ، تتضخم ساجا بسرعة كبيرة. </p><br><p style=";text-align:right;direction:rtl">  يجب توخي الحذر عند وضع الاتفاقيات والحفاظ على سهولة القراءة.  بسبب حتمية C # ، من الصعب جدًا الإعلان عن وصف للحالات والأفعال فيه.  حتى بالنسبة لآلات الحالة البسيطة ، يبدأ الجحيم الحقيقي. </p><br><p style=";text-align:right;direction:rtl">  الآن بضع كلمات حول SagaInstance.  SagaInstance هي فئة موروثة من SagaStateMachineInstance.  يتكون من كائنات وحقول تميز جهاز الحالة.  تقريبا ، هذه هي ذكرى ساجا.  نقوم بتخزين جميع بيانات Saga التي ستحتاجها طوال حياتها.  أيضا في هذا الفصل يتم وصف منطق التغييرات في هذه البيانات في سياق العمل. </p><br><p style=";text-align:right;direction:rtl">  هنا مثال: </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WorkflowSaga : SagaStateMachineInstance , ISagaWithState , ICreatedOnOffset , IModifiedOnOffset , ICreatedBy&lt;string&gt; , IModifiedBy&lt;string&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Guid CorrelationId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string CurrentState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string InitialRequestViewUrl { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestAuthor { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestText { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> byte[] RowVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string CreatedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string ModifiedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset CreatedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset ModifiedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset CompletedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> virtual ICollection&lt;RelatedTask&gt; RelatedTasks { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveGabrielConfigurationRequestInfo( ICreateGabrielConfigurationRequestCommand command) { CorrelationId = command.CorrelationId; RequestNumber = command.RequestNumber; RequestAuthor = command.Author; RequestText = command.RequestText; InitialRequestViewUrl = command.InitialRequestViewUrl; CreatedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveCreatedTaskInfo(ITaskCreationInfo taskCreationInfo) { RelatedPlannerTasks.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RelatedPlannerTask(taskCreationInfo)); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsTakedToWork(ITaskUpdatedInfo taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.TakedToWork); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsApproved(TaskApprovedNotification taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.Completed, taskInfo.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); CompletedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsDeclined(TaskDeclinedNotification taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.Declined, taskInfo.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); CompletedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } private <span class="hljs-type"><span class="hljs-type">void</span></span> UpdateTaskInfo(ITaskUpdatedInfo taskInfo, TaskStatus taskStatus, string <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { var task = RelatedTasks.Single(t =&gt; t.Number == taskInfo.Number); task.ModifiedBy = taskInfo.TaskModifiedBy; task.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>; task.Status = taskStatus; } }</code> </pre><br><p style=";text-align:right;direction:rtl">  يوضح أحد الأمثلة أنه في SagaInstance CorrelationId يتم تخزينه لربط الأحداث مع Saga و CurrentState لتخزين الحالة الحالية لـ Saga. </p><br><h2 style=";text-align:right;direction:rtl">  معالجة الخطأ </h2><br><p style=";text-align:right;direction:rtl">  ماذا يحدث ل Saga إذا حدث خطأ أثناء معالجة الرسالة؟  هذه قضية مهمة ، لأن الجميع يريد أن تظل آلة الدولة ثابتة ، حتى لو حدث خطأ ما.  ومع MassTransit ، ساجا على ما يرام. </p><br><p style=";text-align:right;direction:rtl">  كما لاحظت بالفعل ، في الأمثلة أعلاه ، لا توجد كتلة واحدة لتجربة الصيد للتعامل مع الاستثناءات.  والسبب بسيط: ليس هناك حاجة إليها.  في حالة حدوث استثناء أثناء معالجة الرسالة ، يتم إرجاع الرسالة إلى قائمة الانتظار ويتم إرجاع جميع التغييرات.  نظرًا لأننا نقوم بجميع عمليات التلاعب بالبيانات في نفس معاملة Saga ، فلن يتم إغلاق المعاملة. </p><br><p style=";text-align:right;direction:rtl">  بشكل عام ، التلاعب بشيء غير Saga في Saga نفسها هو ممارسة سيئة.  وفقًا لكتاب "قوالب التكامل لتطبيقات المؤسسة" ، يجب أن يظل مدير العمليات نحيفًا وغبيًا قدر الإمكان: ما عليك سوى إعطاء الأوامر للأنظمة ومراقبة الحالة ، ولكن لا يجب عليه فعل أي شيء. </p><br><p style=";text-align:right;direction:rtl">  بالطبع ، هناك سيناريوهات أكثر تعقيدًا عندما تحتاج إلى تنفيذ بعض إجراءات التعويض للتعامل مع الاستثناءات.  ثم يتم استخدام معالج جهاز الحالة ".Catch" لالتقاط استثناء من نوع معين ثم تنفيذ منطق التعويض. </p><br><p style=";text-align:right;direction:rtl">  وإذا كنت بحاجة فقط إلى التعهد باستثناء ، فمن الأفضل استخدام مراقب (مراقب). </p><br><p style=";text-align:right;direction:rtl">  تخيل الآن الموقف الذي قمنا فيه بالفعل بتنفيذ الأمر إرسال أثناء معالجة الرسالة ، وبعد ذلك حدث استثناء.  ماذا سيحدث للأمر المرسل في هذه الخطوة؟  بعد كل شيء ، لا يمكن إرجاع كل ما طار؟  ولكن هنا يعتقد أن كل شيء. </p><br><p style=";text-align:right;direction:rtl">  عند تكوين الناقل ، يمكنك تمكين خيار UseInMemoryOutbox.  يسمح لك هذا الخيار بعدم إرسال رسائل حتى تكتمل الخطوة الحالية.  في حالة حدوث استثناء ، لن يتم إرسال الرسائل على الإطلاق.  هنا مقتطف من الوثائق: </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs pgsql">/// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Includes an outbox <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the consume <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span>, which delays outgoing messages <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span> /// <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the pipeline <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the outbox <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>. At this <span class="hljs-type"><span class="hljs-type">point</span></span>, the message execution pipeline should be /// nearly complete <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> the ack remaining. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> an <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> thrown, the messages are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> sent/published. /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="configurator"&gt;The pipe configurator&lt;/param&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> UseInMemoryOutbox(this IConsumePipeConfigurator configurator)</code> </pre> <br><h2 style=";text-align:right;direction:rtl">  الاختبارات </h2><br><p style=";text-align:right;direction:rtl">  للوهلة الأولى ، لا يزال اختبار آلة الحالة غير المتزامنة متعة.  ولكن هنا كل شيء على ما يرام.  يوفر MassTransit إطارًا جيدًا لكتابة اختبار يلبي تمامًا جميع احتياجاتنا لاختبار جهاز الدولة. </p><br><p style=";text-align:right;direction:rtl">  يوفر الإطار لـ InMemory تنفيذ ناقل البيانات (InMemoryTestHarness) ، والذي يسمح لك بإرسال واستقبال الرسائل التي تتجاوز RabbitMQ أو قائمة انتظار أخرى. </p><br><p style=";text-align:right;direction:rtl">  حسنًا ، كمثال: </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs pgsql">[TestFixture] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SagaTests : TestFixtureBase { protected const string HostName = "HostName"; protected InMemoryTestHarness Harness; protected StateMachine StateMachine; protected StateMachineSagaTestHarness&lt;GabrielConfigurationRequestSaga, StateMachine&gt; Saga; [SetUp] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SetUp() { StateMachine = (StateMachine)Kernel. <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>&lt;MassTransitStateMachine&lt;WorkflowSaga&gt;&gt;(); Harness = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> InMemoryTestHarness(HostName); Saga = Harness .StateMachineSaga&lt;WorkflowSaga, StateMachine&gt;(StateMachine); } [TearDown] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TearDown() { await Harness.Stop(); } protected async Task&lt;WorkflowSaga&gt; InitializeSaga() { await Harness.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); var command = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TestStartWorkflowCommand { CorrelationId = SagaId, Author = RequestAuthor, InitialRequestViewUrl = InitialRequestViewUrl, RequestText = RequestText, RequestNumber = RequestNumber, }; await Harness.InputQueueSendEndpoint .Send&lt;IStartWorkflowCommand&gt;(command); //    ,  consume    , // ,  Saga  ,    <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(Harness.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;IStartWorkflowCommand&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); var currentSaga = Saga.Created.Contains(SagaId); currentSaga.RelatedPlannerTasks = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;RelatedPlannerTask&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSaga; } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task CheckCurrntStateWhenStartWorkflowCommand() { var saga = await InitializeSaga(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsNotNull(saga); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(StateMachine .AwaitingORDTApproveTaskCreatedInPlanner.Name, saga.CurrentState); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WhenTaskCreated : SagaTestsBase { private async Task&lt;WorkflowSaga&gt; InitializeState() { var saga = await InitializeSaga(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); saga.CurrentState = StateMachine.AwaitingTaskCreated.Name; InitializeRelatedTask(saga); await SendTaskCreatedNotification(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(Harness.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;TaskCreatedNotification&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> saga; } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task SaveWorkflowDataWhenTaskCreated() { var saga = await InitializeState(); var taskInfo = saga.RelatedPlannerTasks .First(task =&gt; task.PlannerTaskType == PlannerTaskType.DPORPApprove); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskNumber, taskInfo.Number); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskUrl, taskInfo.TaskUrl); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(SagaId, taskInfo.SagaCorrelationId); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskStatus.Created, taskInfo.Status); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, taskInfo.ModifiedBy); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(saga.CurrentState, StateMachine.AwaitingTaskTakedToWork.Name); } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task SendsMailWhenTaskCreated() { var mailConsumer = Harness .Consumer&lt;MockConsumer&lt;ISendEmailMessageWithTemplateCommand&gt;&gt; (RabbitMqRouting.QueueNames .SendEmailsQueueName); await InitializeState(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(mailConsumer.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;ISendEmailMessageWithTemplateCommand&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); } private async Task SendTaskCreatedNotification() { await Harness.InputQueueSendEndpoint .Send(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TaskCreatedNotification { TaskUrl = TaskUrl, Number = TaskNumber, TaskModifiedBy = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, CorrelationId = SagaId }); } }</code> </pre><br><p style=";text-align:right;direction:rtl">  تعمل الاختبارات بسرعة كبيرة.  على سبيل المثال ، على كمبيوتر مطور واحد ، يستغرق 850 اختبارًا حوالي 21 ثانية. </p><br><h2 style=";text-align:right;direction:rtl">  نصائح مفيدة </h2><br><p style=";text-align:right;direction:rtl">  في الختام ، نقدم قائمة من النصائح المفيدة بناءً على تجربتنا. </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  من الأفضل وضع العقود ومخططات اتصالات الحافلات في كتلة خاصة.  لذلك لن يكون لديك اختلافات في الأسماء على جانبي الإرسال والاستقبال.  يمكنك أيضًا وضع ثوابت مع قوائم الانتظار والمضيفين في الكتلة.  Nuget قابل للتخصيص في اليوم الواحد.  كما تدعم بعض عناصر التحكم بالمصادر nuget ، هناك قنوات خاصة مدفوعة الأجر. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  افهم الاختلافات بين الإرسال والنشر.  استخدم إرسال إذا كان لديك مشترك واحد وكنت تعرف بالضبط اسم قائمة الانتظار التي ترسل إليها الأمر.  تم تصميم النشر لإرسال تنبيهات البث.  التفاصيل على <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">الرابط</a> . </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  إذا كنت بحاجة إلى إنشاء رسالة طلب / استجابة ، فمن الأفضل إضافة اسم قائمة الانتظار للاستجابة للعقد بدلاً من استخدام مخطط الطلب / الاستجابة من MassTransit ، والذي يقترح MassTransit نفسه تجنبه.  لأن هذا يقلل بشكل كبير من الموثوقية.  أنت تخسر كل مزايا التزامن.  ولكن إذا كنت لا تزال بحاجة إلى الحصول على إجابة في وقت محدود ، فمن الأفضل استخدام مكالمة مباشرة.  من الأفضل كتابة هذا في نفس الكتاب ، "قوالب تكامل تطبيق Enterprise". </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  يجب أن تكون الملحمة رقيقة.  حاول حمل كل المنطق الثقيل إلى أنظمة أخرى.  ويجب أن تقفز ساجا عبر الولايات وتبعثر الرسائل إلى اليسار واليمين. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  إضافة إلى كافة الرسائل CorrelationId ، والتي سيتم تشغيلها بين الأنظمة.  لذلك من الأسهل بكثير تحليل السجلات وربط جميع الرسائل في صورة واحدة.  يفعل Masstransit نفس الشيء.  تتم إضافة CorrelationId إلى الرسائل عند الوراثة من واجهة CorrelatedBy. <br></p><br>  قم بإعداد السجلات والمراقبة في أنظمتك ، فلن يضر ذلك أبدًا.  تجربتنا في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هذه المقالة</a> . <br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar412793/">https://habr.com/ru/post/ar412793/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar412783/index.html">تثبيت وكيل MTProto Telegram من المصدر على Centos 7</a></li>
<li><a href="../ar412785/index.html">ماجستير في الإدارة والعمل المستقل. القصة في ثلاثة أجزاء</a></li>
<li><a href="../ar412787/index.html">تضمين Git في نظام تطوير المشاريع</a></li>
<li><a href="../ar412789/index.html">"المساعدة في العمل": كيفية جعل برامج الدردشة أكثر ذكاءً</a></li>
<li><a href="../ar412791/index.html">تحسين أداء نظام المراقبة بالفيديو ومنع الأعطال</a></li>
<li><a href="../ar412795/index.html">ودعنا نستخلص استنتاجات من مناقشة مقال "ما هو الخطأ في عودة Geektimes إلى Habr"</a></li>
<li><a href="../ar412797/index.html">حول مخاطر CDN والخدمات والخطوط من Google</a></li>
<li><a href="../ar412799/index.html">دائما على اتصال: Mango Talker - messenger and softphone</a></li>
<li><a href="../ar412801/index.html">دراسة: المتسللون يسرقون الملايين من الدولارات بسبب انخفاض أمان تبادل العملات المشفرة</a></li>
<li><a href="../ar412803/index.html">نظرة أعمق على مختلف منصات العقود الذكية</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>