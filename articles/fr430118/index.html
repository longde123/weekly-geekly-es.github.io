<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç± ü¶ê ‚ÅâÔ∏è Unity3D: Modifier le d√©l√©gu√© d'application iOS üíà üêÆ üñïüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je pense que beaucoup dans le processus de d√©veloppement d'un jeu pour iOS ont d√ª faire face au fait qu'il devient n√©cessaire d'utiliser l'une ou l'au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unity3D: Modifier le d√©l√©gu√© d'application iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430118/">  Je pense que beaucoup dans le processus de d√©veloppement d'un jeu pour iOS ont d√ª faire face au fait qu'il devient n√©cessaire d'utiliser l'une ou l'autre des fonctionnalit√©s natives.  Concernant Unity3D, de nombreux probl√®mes peuvent survenir dans ce probl√®me: pour impl√©menter une sorte de fonctionnalit√©, vous devez vous tourner vers des plugins natifs √©crits en Objective-C.  Quelqu'un en ce moment d√©sesp√®re imm√©diatement et abandonne l'id√©e.  Quelqu'un recherche des solutions toutes faites dans AssetStore ou dans les forums, en esp√©rant qu'une solution toute faite existe d√©j√†.  S'il n'y a pas de solutions toutes faites, alors les plus persistants d'entre nous ne voient pas d'autre moyen que de plonger dans l'ab√Æme de la programmation iOS et de l'interaction Unity3D avec le code Objective-C. <br><br>  Ceux qui choisissent la derni√®re voie (bien que, je pense, ils le savent eux-m√™mes), seront confront√©s √† de nombreux probl√®mes sur cette voie difficile et √©pineuse: <br><br><ul><li>  iOS est un √©cosyst√®me absolument inconnu et isol√©, se d√©veloppant √† sa mani√®re.  Au minimum, vous devrez consacrer beaucoup de temps √† comprendre comment vous pouvez acc√©der √† l'application et o√π, dans les profondeurs du projet Xcode g√©n√©r√© automatiquement, se trouve le code permettant au moteur Unity3D d'interagir avec le composant natif de l'application. </li><li>  Objective-C est un langage de programmation assez distinct et peu semblable.  Et lorsqu'il s'agit d'interagir avec le code C ++ de l'application Unity3D, le ¬´dialecte¬ª de ce langage, appel√© Objective-C ++, entre en sc√®ne.  Il y a tr√®s peu d'informations sur lui, la plupart √©tant anciennes et archivistiques. </li><li>  Le protocole d'interaction entre Unity3D et l'application iOS est mal d√©crit.  Vous devez vous fier uniquement aux tutoriels des passionn√©s de r√©seau qui √©crivent comment d√©velopper le plugin natif le plus simple.  Dans le m√™me temps, peu de gens abordent des probl√®mes plus profonds et des probl√®mes d√©coulant de la n√©cessit√© de faire quelque chose de compliqu√©. </li></ul><br>  Ceux qui veulent en savoir plus sur les m√©canismes d'interaction d'Unity3D avec une application iOS, s'il vous pla√Æt, sous cat. <br><a name="habracut"></a><br>  Afin de clarifier le goulot d'√©tranglement √©tanche de l'interaction d'Unity3D avec le code natif, cet article d√©crit les aspects d'interaction d'un d√©l√©gu√© d'application iOS avec le code Unity3D, avec quels outils C ++ et Objective-C il est impl√©ment√©, et comment modifier le d√©l√©gu√© d'application vous-m√™me.  Ces informations peuvent √™tre utiles √† la fois pour une meilleure compr√©hension des m√©canismes de liaison Unity3D + iOS et pour une utilisation pratique. <br><br><h3>  Interaction entre iOS et l'application </h3><br>  En guise d'introduction, regardons comment l'interaction de l'application avec le syst√®me est impl√©ment√©e dans iOS et vice versa.  Sch√©matiquement, le lancement d'une application iOS ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/jd/vm/oi/jdvmoimtygqdsc095abusfopdao.png" alt="image"><br><br>  Pour √©tudier ce m√©canisme du point de vue du code, une nouvelle application cr√©√©e dans Xcode √† l'aide du mod√®le ¬´Single View App¬ª convient. <br><br><img src="https://habrastorage.org/webt/du/_z/75/du_z75efp4bdgv_fvb02x-mjfis.png"><br><br>  En choisissant ce mod√®le, la sortie vous donnera l'application iOS la plus simple qui peut fonctionner sur un appareil ou un √©mulateur et afficher un √©cran blanc.  Xcode cr√©era utilement un projet dans lequel il n'y aura que 5 fichiers avec le code source (dont 2 √©tant des fichiers d'en-t√™te .h) et plusieurs fichiers auxiliaires qui ne nous int√©ressent pas (composition, configs, ic√¥nes). <br><br><img src="https://habrastorage.org/webt/jt/mz/ov/jtmzov95oshddmprhby9wkqigve.png"><br><br>  Voyons de quoi sont responsables les fichiers de code source: <br><br><ul><li>  <i>ViewController.m</i> / <i>ViewController.h</i> - codes source pas tr√®s int√©ressants pour nous.  √âtant donn√© que votre application a une vue (qui n'est pas repr√©sent√©e par du code, mais en utilisant le Storyboard), vous aurez besoin de la classe Controller, qui contr√¥lera cette vue.  En g√©n√©ral, de cette fa√ßon, Xcode lui-m√™me nous encourage √† utiliser le mod√®le MVC.  Le projet qui g√©n√®re Unity3D n'aura pas ces fichiers source. </li><li>  <i>AppDelegate.m</i> / <i>AppDelegate.h</i> est le d√©l√©gu√© de votre application.  Point d'int√©r√™t dans l'application o√π commence le travail du code d'application personnalis√©. </li><li>  <i>main.m</i> - le point de d√©part de l'application.  √Ä la mani√®re de toute application C / C ++, il contient la fonction principale, avec laquelle le programme d√©marre. </li></ul><br>  Voyons maintenant le code commen√ßant par le fichier <i>main.m</i> : <br><br><pre><code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * argv[]) { <span class="hljs-comment"><span class="hljs-comment">//1 @autoreleasepool { //2 return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class])); // 3 } }</span></span></code> </pre> <br>  Avec la ligne 1, tout est clair et sans explication, passons √† la ligne 2. Il indique que le cycle de vie de l'application se produira √† l'int√©rieur du pool Autorelease.  L'utilisation du pool de lib√©ration automatique nous indique que nous confierons la gestion de la m√©moire de l'application √† ce pool particulier, c'est-√†-dire qu'il traitera les probl√®mes lorsqu'il sera n√©cessaire de lib√©rer de la m√©moire pour une variable particuli√®re.  L'histoire de la gestion de la m√©moire sur iOS d√©passe le cadre de cette histoire, il est donc inutile de se plonger dans ce sujet.  Pour ceux qui sont int√©ress√©s par ce sujet, vous pouvez trouver, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . <br><br>  Passons √† la ligne 3. Il appelle la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UIApplicationMain</a> .  Les param√®tres de d√©marrage du programme (argc, argv) lui sont transmis.  Ensuite, dans cette fonction, il est indiqu√© quelle classe utiliser comme classe principale de l'application, son instance est cr√©√©e.  Enfin, il est indiqu√© quelle classe utiliser comme d√©l√©gu√© d'application, son instance est cr√©√©e, les connexions entre l'instance de classe d'application et son d√©l√©gu√© sont configur√©es. <br><br>  Dans notre exemple, nil est pass√© en tant que classe qui repr√©sentera l'instance d'application - en gros, l'analogue local est nul.  En plus de nil, vous pouvez y passer une classe sp√©cifique h√©rit√©e de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UIApplication</a> .  Si nil est sp√©cifi√©, alors UIApplication sera utilis√©e.  Cette classe est un point centralis√© pour g√©rer et coordonner le travail d'une application sur iOS et est un singleton.  Avec lui, vous pouvez apprendre presque tout sur l'√©tat actuel de l'application, les notifications, les fen√™tres, les √©v√©nements survenus dans le syst√®me lui-m√™me qui affectent cette application et bien plus encore.  Cette classe n'h√©rite presque jamais.  Nous nous attarderons sur la cr√©ation de la classe Application Delegate plus en d√©tail. <br><br><h3>  Cr√©er un d√©l√©gu√© d'application </h3><br>  Une indication de la classe √† utiliser en tant que d√©l√©gu√© d'application se produit dans un appel de fonction <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSStringFromClass</span></span>([AppDelegate <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>])</code> </pre> <br>  Analysons cet appel en plusieurs parties. <br><br><pre> <code class="objectivec hljs">[AppDelegate <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cette construction</a> renvoie un objet de la classe AppDelegate (qui est d√©clar√©e dans AppDelegate.h / .m) et la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NSStringFromClass</a> renvoie le nom de la classe sous forme de cha√Æne.  Nous passons simplement le nom de cha√Æne de la classe √† cr√©er et √† utiliser en tant que d√©l√©gu√© de la fonction UIApplicationMain.  Pour une meilleure compr√©hension, la ligne 3 du fichier <i>main.m</i> pourrait √™tre remplac√©e par ce qui suit: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIApplicationMain</span></span>(argc, argv, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-string"><span class="hljs-string">@"AppDelegate"</span></span>);</code> </pre> <br>  Et le r√©sultat de sa mise en ≈ìuvre serait identique √† la version originale.  Apparemment, les d√©veloppeurs ont d√©cid√© d'adopter cette approche afin de ne pas utiliser de constante de cha√Æne.  Avec une approche standard, si vous renommez une classe d√©l√©gu√©e, l'analyseur g√©n√©rera imm√©diatement une erreur.  Dans le cas de l'utilisation de la ligne habituelle, le code sera compil√© avec succ√®s et vous ne recevrez une erreur qu'en d√©marrant l'application. <br><br>  Un m√©canisme similaire pour cr√©er une classe, en utilisant uniquement le nom de cha√Æne de la classe, peut vous rappeler Reflection from C #.  Objective-C et son runtime sont beaucoup plus puissants que Reflection en C #.  C'est un point assez important dans le contexte de cet article, mais il faudrait beaucoup de temps pour d√©crire toutes les fonctionnalit√©s.  Cependant, nous rencontrerons toujours la ¬´r√©flexion¬ª dans l'objectif-C ci-dessous.  Reste √† comprendre le concept de d√©l√©gu√© d'application et ses fonctions. <br><br><h3>  D√©l√©gu√© d'application </h3><br>  Toutes les interactions de l'application avec iOS se produisent dans la classe UIApplication.  Cette classe assume de nombreuses responsabilit√©s - informe sur l'origine des √©v√©nements, l'√©tat de l'application et bien plus encore.  Pour la plupart, son r√¥le est de notifier.  Mais quand quelque chose se passe dans le syst√®me, nous devrions √™tre en mesure de r√©agir d'une mani√®re ou d'une autre √† ce changement, d'effectuer une sorte de fonctionnalit√© personnalis√©e.  Si une instance de la classe UIApplication fait cela, cette pratique commencera √† ressembler √† une approche appel√©e l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">objet divin</a> .  Par cons√©quent, il vaut la peine de penser √† lib√©rer cette classe d'une partie de ses responsabilit√©s. <br><br>  C'est √† ces fins que l'√©cosyst√®me iOS utilise une chose telle qu'un d√©l√©gu√© d'application.  D'apr√®s le nom lui-m√™me, nous pouvons conclure que nous avons affaire √† un mod√®le de conception tel que la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©l√©gation</a> .  En bref, nous transf√©rons simplement la responsabilit√© du traitement de la r√©ponse √† certains √©v√©nements de l'application au d√©l√©gu√© de l'application.  √Ä cet effet, dans notre exemple, la classe AppDelegate a √©t√© cr√©√©e dans laquelle nous pouvons √©crire des fonctionnalit√©s personnalis√©es, tout en laissant la classe UIApplication fonctionner en mode bo√Æte noire.  Cette approche peut sembler controvers√©e √† quelqu'un en termes de beaut√© de la conception de l'architecture, mais les auteurs iOS eux-m√™mes nous poussent √† cette approche et la grande majorit√© des d√©veloppeurs (sinon tous) l'utilisent. <br><br>  Pour v√©rifier visuellement √† quelle fr√©quence pendant le travail de l'application le d√©l√©gu√© d'application re√ßoit un message particulier, jetez un ≈ìil au sch√©ma: <br><br><img src="https://habrastorage.org/webt/md/61/bc/md61bc9my4focy1suoy5qn9om2s.png" alt="image"><br><br>  Les rectangles jaunes indiquent les appels de l'une ou l'autre m√©thode d√©l√©gu√©e en r√©ponse √† certains √©v√©nements de la vie de l'application (cycle de vie de l'application).  Ce diagramme illustre uniquement les √©v√©nements li√©s aux modifications de l'√©tat de l'application et n'affiche pas de nombreux autres aspects de la responsabilit√© du d√©l√©gu√©, tels que l'acceptation des notifications ou l'interaction avec les frameworks. <br><br>  Voici quelques exemples o√π nous pourrions avoir besoin d'acc√©der √† un d√©l√©gu√© d'application de Unity3D: <br><br><ol><li>  gestion des notifications push et locales </li><li>  journalisation des √©v√©nements de lancement d'application dans l'analytique </li><li>  d√©termination de la fa√ßon de lancer l'application - ¬´nettoyer¬ª ou quitter l'arri√®re-plan </li><li>  comment l'application a √©t√© lanc√©e - par tach pour la notification, en utilisant les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">actions rapides de l'√©cran d'accueil</a> ou simplement par tach sur incon </li><li>  interaction avec WatchKit ou HealthKit </li><li>  ouverture et traitement des URL √† partir d'une autre application.  Si cette URL s'applique √† votre application, vous pouvez la traiter dans votre application au lieu de laisser le syst√®me ouvrir cette URL dans un navigateur </li></ol><br>  Ce n'est pas toute la liste des sc√©narios.  De plus, il convient de noter que le d√©l√©gu√© modifie de nombreux syst√®mes d'analyse et de publicit√© dans ses plugins natifs. <br><br><h3>  Comment Unity3D impl√©mente un d√©l√©gu√© d'application </h3><br>  Examinons maintenant le projet Xcode g√©n√©r√© par Unity3D et d√©couvrons comment le d√©l√©gu√© d'application est impl√©ment√© dans Unity3D.  Lors de la construction pour la plate-forme iOS, Unity3D g√©n√®re automatiquement un projet Xcode pour vous, qui utilise beaucoup de code standard.  Ce code de mod√®le inclut √©galement le code de d√©l√©gu√© d'application.  Dans tout projet g√©n√©r√©, vous pouvez trouver les fichiers <i>UnityAppController.h</i> et <i>UnityAppController.mm</i> .  Ces fichiers contiennent le code de la classe UnityAppController qui nous int√©resse. <br><br>  En fait, Unity3D utilise une version modifi√©e du mod√®le ¬´Application vue unique¬ª.  Dans ce mod√®le uniquement, Unity3D utilise le d√©l√©gu√© d'application non seulement pour g√©rer les √©v√©nements iOS, mais aussi pour initialiser le moteur lui-m√™me, pr√©parer les composants graphiques, et bien plus encore.  C'est tr√®s facile √† comprendre si vous regardez la m√©thode. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)application:(<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span>*)application didFinishLaunchingWithOptions:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span>*)launchOptions</code> </pre><br>  dans le code de la classe UnityAppController.  Cette m√©thode est appel√©e au moment de l'initialisation de l'application, lorsque vous pouvez transf√©rer le contr√¥le vers votre code personnalis√©.  Dans cette m√©thode, par exemple, vous pouvez trouver les lignes suivantes: <br><br><pre> <code class="objectivec hljs">UnityInitApplicationNoGraphics([[[<span class="hljs-built_in"><span class="hljs-built_in">NSBundle</span></span> mainBundle] bundlePath] UTF8String]); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> selectRenderingAPI]; [UnityRenderingView InitializeForAPI: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.renderingAPI]; _window = [[<span class="hljs-built_in"><span class="hljs-built_in">UIWindow</span></span> alloc] initWithFrame: [<span class="hljs-built_in"><span class="hljs-built_in">UIScreen</span></span> mainScreen].bounds]; _unityView = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> createUnityView]; [DisplayManager Initialize]; _mainDisplay = [DisplayManager Instance].mainDisplay; [_mainDisplay createWithWindow: _window andView: _unityView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> createUI]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> preStartUnity];</code> </pre><br>  Sans m√™me entrer dans les d√©tails de ce que font ces d√©fis, vous pouvez deviner qu'ils sont li√©s √† la pr√©paration d'Unity3D pour le travail.  Il s'av√®re que le sc√©nario suivant: <br><br><ol><li>  La fonction principale est appel√©e depuis <i>main.mm</i> </li><li>  Les classes d'instance de l'application et de son d√©l√©gu√© sont cr√©√©es. </li><li>  Le d√©l√©gu√© d'application pr√©pare et lance le moteur Unity3D </li><li>  Votre code personnalis√© commence √† fonctionner.  Si vous utilisez il2cpp, votre code est traduit de C # en IL puis en code C ++, qui p√©n√®tre directement dans le projet Xcode. </li></ol><br>  Ce script semble assez simple et logique, mais il entra√Æne un probl√®me potentiel: comment pouvons-nous modifier le d√©l√©gu√© d'application si nous n'avons pas acc√®s au code source lorsque nous travaillons dans Unity3D? <br><br><h3>  Unity3D affect√© pour modifier le d√©l√©gu√© d'application </h3><br>  Nous pouvons jeter un ≈ìil aux fichiers <i>AppDelegateListener.mm/.h</i> .  Ils contiennent des macros qui vous permettent d'enregistrer n'importe quelle classe comme √©couteur d'√©v√©nements pour le d√©l√©gu√© d'application.  C'est une bonne approche, nous n'avons pas besoin de modifier le code existant, mais simplement d'en ajouter un nouveau.  Mais il pr√©sente un inconv√©nient important: tous les √©v√©nements d'application ne sont pas pris en charge et il n'y a aucun moyen d'obtenir des informations sur le lancement de l'application. <br><br>  La solution la plus √©vidente, cependant, inacceptable est de modifier le code source d√©l√©gu√© √† la main apr√®s que Unity3D ait construit le projet Xcode.  Le probl√®me avec cette approche est √©vident - l'option est appropri√©e si vous faites des assemblages avec vos mains et que vous n'√™tes pas confus par la n√©cessit√© de modifier le code manuellement apr√®s chaque assemblage.  Dans le cas de l'utilisation de g√©n√©rateurs (Unity Cloud Build ou toute autre machine de g√©n√©ration), cette option est absolument inacceptable.  √Ä ces fins, les d√©veloppeurs Unity3D nous ont laiss√© une faille. <br><br>  Le fichier <i>UnityAppController.h</i> , <i>en</i> plus de d√©clarer des variables et des m√©thodes, contient √©galement une d√©finition de macro: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define IMPL_APP_CONTROLLER_SUBCLASS(ClassName) ...</span></span></code> </pre> <br>  Cette macro permet simplement de remplacer le d√©l√©gu√© d'application.  Pour ce faire, vous devez suivre quelques √©tapes simples: <br><br><ol><li>  √âcrivez votre propre d√©l√©gu√© d'application dans Objective-C </li><li>  Quelque part dans le code source, ajoutez la ligne suivante <pre> <code class="objectivec hljs">IMPL_APP_CONTROLLER_SUBCLASS(___)</code> </pre> </li><li>  Mettez cette source dans le dossier Plugins / iOS de votre projet Unity3D </li></ol><br>  Vous allez maintenant recevoir un projet dans lequel le d√©l√©gu√© d'application Unity3D standard sera remplac√© par votre projet personnalis√©. <br><br><h3>  Comment fonctionne la macro de remplacement de d√©l√©gu√© </h3><br>  Regardons le code source complet de la macro: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define IMPL_APP_CONTROLLER_SUBCLASS(ClassName) ... @interface ClassName(OverrideAppDelegate) \ { \ } \ +(void)load; \ @end \ @implementation ClassName(OverrideAppDelegate) \ +(void)load \ { \ extern const char* AppControllerClassName; \ AppControllerClassName = #ClassName; \ } \ @end</span></span></code> </pre> <br>  L'utilisation de cette macro dans votre source ajoutera le code d√©crit dans la macro au corps de votre source au stade de la compilation.  Cette macro effectue les op√©rations suivantes.  Tout d'abord, il ajoutera la m√©thode de chargement √† l'interface de votre classe.  Une interface dans le contexte d'Objective-C peut √™tre consid√©r√©e comme un ensemble de champs et de m√©thodes publics.  En C #, une m√©thode de chargement statique appara√Ætra dans votre classe qui ne renvoie rien.  Ensuite, l'impl√©mentation de cette m√©thode de chargement sera ajout√©e au code de votre classe.  Dans cette m√©thode, la variable AppControllerClassName sera d√©clar√©e, qui est un tableau de type char, puis une valeur sera affect√©e √† cette variable.  Cette valeur est le nom de cha√Æne de votre classe.  De toute √©vidence, ces informations ne sont pas suffisantes pour comprendre le m√©canisme de fonctionnement de cette macro, par cons√©quent, nous devons comprendre ce qu'est cette m√©thode de ¬´chargement¬ª et pourquoi une variable est d√©clar√©e. <br><br>  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> indique que la charge est une m√©thode sp√©ciale qui est appel√©e une fois pour chaque classe (en particulier la classe, pas ses instances) au tout d√©but du lancement de l'application, avant m√™me que la fonction principale soit appel√©e.  L'environnement d'ex√©cution Objective-c (runtime) au d√©marrage de l'application enregistrera toutes les classes qui seront utilis√©es pendant le fonctionnement de l'application et appellera la m√©thode de chargement, si elle est impl√©ment√©e.  Il s'av√®re que m√™me avant le d√©but de tout code dans notre application, la variable AppControllerClassName sera ajout√©e √† votre classe. <br><br>  Ensuite, vous pourriez penser: "Et quel est l'int√©r√™t d'avoir cette variable si elle est d√©clar√©e dans la m√©thode et sera supprim√©e de la m√©moire lorsque vous quittez cette m√©thode?".  La r√©ponse √† cette question se situe un peu au-del√† des limites de l'Objectif-C. <br><br><h3>  Et o√π est C ++? </h3><br>  Jetons un autre regard sur la d√©claration de cette variable <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* AppControllerClassName;</code> </pre> <br>  La seule chose qui peut √™tre incompr√©hensible dans cette d√©claration est le modificateur extern.  Si vous essayez d'utiliser ce modificateur en Objective-C pur, alors Xcode lancera une erreur.  Le fait est que ce modificateur ne fait pas partie d'Objective-C, il est impl√©ment√© en C ++.  Objective-C peut √™tre d√©crit assez succinctement en disant qu'il s'agit d'un "langage C avec des classes".  C'est une extension du langage C et permet une utilisation illimit√©e du code C entrecoup√© de code Objective-C. <br><br>  Cependant, pour utiliser extern et d'autres fonctionnalit√©s C ++, vous devez faire un tour - utilisez Objective-C ++.  Il n'y a pratiquement aucune information sur ce langage, car c'est juste du code Objective-C qui permet l'insertion de code C ++.  Pour que le compilateur consid√®re que certains fichiers source doivent √™tre compil√©s en Objective-C ++, et non en Objective-C, il vous suffit de changer l'extension de ce fichier de <i>.m</i> en <i>.mm</i> . <br><br>  Le modificateur extern lui-m√™me est utilis√© pour d√©clarer une variable globale.  Plus pr√©cis√©ment, pour dire au compilateur ¬´Croyez-moi, une telle variable existe, mais sa m√©moire n'a pas √©t√© allou√©e ici, mais dans une autre source.  Et elle a aussi une valeur, je vous le garantis. ¬ª  Ainsi, notre ligne de code cr√©e simplement une variable globale et y stocke le nom de notre classe personnalis√©e.  Il ne reste plus qu'√† comprendre o√π cette variable peut √™tre utilis√©e. <br><br><h3>  Retour √† la page principale </h3><br>  Nous rappelons ce qui a √©t√© dit pr√©c√©demment - le d√©l√©gu√© d'application est cr√©√© en sp√©cifiant le nom de classe.  Si le d√©l√©gu√© a √©t√© cr√©√© en utilisant la valeur constante [classe myClass] dans le mod√®le de projet Xcode normal, alors, apparemment, les gars de Unity ont d√©cid√© que cette valeur devrait √™tre envelopp√©e dans une variable.  En utilisant la m√©thode de poke scientifique, nous prenons le projet Xcode g√©n√©r√© par Unity3D et allons dans le fichier <i>main.mm.</i> <br><br>  On y voit du code plus complexe qu'auparavant, une partie de ce code est manquante car inutile: <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// WARNING: this MUST be c decl (NSString ctor will be called after +load, so we cant really change its value) const char* AppControllerClassName = "UnityAppController"; int main(int argc, char* argv[]) { ... UIApplicationMain(argc, argv, nil, [NSString stringWithUTF8String: AppControllerClassName]); } return 0; }</span></span></code> </pre> <br>  Ici, nous voyons la d√©claration de cette tr√®s variable, et la cr√©ation du d√©l√©gu√© d'application avec son aide. <br>  Si nous avons cr√©√© un d√©l√©gu√© personnalis√©, la variable n√©cessaire existe et compte d√©j√† - le nom de notre classe.  La d√©claration et l'initialisation de la variable avant la fonction principale garantit qu'elle a une valeur par d√©faut - UnityAppController. <br><br>  Maintenant, avec cette d√©cision, tout devrait √™tre tr√®s clair. <br><br><h3>  Probl√®me de macro </h3><br>  Bien s√ªr, pour la grande majorit√© des situations, l'utilisation de cette macro est une excellente solution.  Mais il convient de noter qu'il y a un gros √©cueil: vous ne pouvez pas avoir plus d'un d√©l√©gu√© personnalis√©.  Cela se produit car si 2 classes ou plus utilisent la macro IMPL_APP_CONTROLLER_SUBCLASS (ClassName), alors pour la premi√®re d'entre elles, la valeur de la variable dont nous avons besoin sera affect√©e et les autres affectations seront ignor√©es.  Et cette variable est une cha√Æne, c'est-√†-dire qu'elle ne peut pas √™tre affect√©e √† plus d'une valeur. <br><br>  Vous pourriez penser que ce probl√®me est d√©g√©n√©r√© et peu probable dans la pratique.  Mais, cet article ne se serait pas produit si un tel probl√®me ne s'√©tait pas vraiment produit, et m√™me dans des circonstances tr√®s √©tranges.  La situation peut √™tre la suivante.  Vous avez un projet dans lequel vous utilisez de nombreux services d'analyse et de publicit√©.  Beaucoup de ces services ont des composants Objective-C.  Ils sont dans votre projet depuis longtemps et vous ne connaissez pas les probl√®mes avec eux.  Ici, vous devez √©crire un d√©l√©gu√© personnalis√©.  Vous utilisez une macro magique con√ßue pour vous √©viter des probl√®mes, construire un projet et obtenir un rapport sur le succ√®s de l'assemblage.  Ex√©cutez le projet sur l'appareil et votre fonctionnalit√© ne fonctionne pas et vous ne recevez pas une seule erreur. <br><br>  Et le probl√®me peut √™tre que l'un des plugins publicitaires ou d'analyse utilise la m√™me macro.  Par exemple, dans le plugin d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AppsFlyer,</a> cette macro est utilis√©e. <br><br><h3>  Quelle est la valeur de la variable externe dans le cas de d√©clarations multiples? </h3><br>  Il est int√©ressant de savoir si la m√™me variable externe est d√©clar√©e dans plusieurs fichiers, et ils sont initialis√©s √† la mani√®re de notre macro (dans la m√©thode de chargement), alors comment comprendre la valeur que prendra la variable?  Pour comprendre le mod√®le, une application de test simple a √©t√© cr√©√©e, dont le code peut √™tre trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  L'essence de l'application est simple.  Il existe 2 classes A et B, dans les deux classes, la variable externe AexternVar est d√©clar√©e, une valeur sp√©cifique lui est affect√©e.  Les valeurs de la variable dans les classes sont d√©finies diff√©remment.  Dans la fonction principale, la valeur de cette variable est enregistr√©e.  Il a √©t√© constat√© exp√©rimentalement que la valeur de la variable d√©pend de l'ordre dans lequel les sources sont ajout√©es au projet.  L'ordre dans lequel le runtime Objective-C enregistre les classes pendant l'ex√©cution de l'application en d√©pend.  Si vous souhaitez r√©p√©ter l'exp√©rience, ouvrez le projet et s√©lectionnez l'onglet Build Phases dans les param√®tres du projet.  √âtant donn√© que le projet est test et petit, il ne dispose que de 8 codes sources.  Tous sont pr√©sents dans l'onglet G√©n√©rer des phases de la liste Compiler les sources. <br><br><img src="https://habrastorage.org/webt/oi/ly/ln/oilylnhxdyjg3cvgcrj5nzhjvwy.png"><br><br>  Si dans cette liste la source de la classe A est sup√©rieure √† la source de la classe B, alors la variable prendra une valeur de la classe B. Sinon, la variable prendra une valeur de la classe A. <br><br>  Imaginez simplement combien de probl√®mes cela peut th√©oriquement causer est une petite nuance.  Surtout si le projet est √©norme, g√©n√©r√© automatiquement et que vous ne savez pas dans quelles classes une telle variable est d√©clar√©e. <br><br><h3>  R√©solution de probl√®mes </h3><br>  Plus t√¥t dans l'article, il a √©t√© dit qu'Objective-C donnera une longueur d'avance √† la r√©flexion C #.  Plus pr√©cis√©ment, pour r√©soudre notre probl√®me, vous pouvez utiliser le m√©canisme appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">m√©thode Swizzling</a> .  L'essence de ce m√©canisme est que nous avons la possibilit√© de remplacer l'impl√©mentation d'une m√©thode d'une classe par une autre lors de l'application.  Ainsi, nous pouvons remplacer la m√©thode d'int√©r√™t dans UnityAppController par une m√©thode personnalis√©e.  Nous prenons l'impl√©mentation existante et compl√©tons le code dont nous avons besoin.  Nous √©crivons du code qui remplace l'impl√©mentation existante de la m√©thode par celle dont nous avons besoin.  Pendant le travail de l'application, le d√©l√©gu√© utilisant la macro fonctionnera comme auparavant, appelant l'impl√©mentation de base d'UnityAppController, et l√†, notre m√©thode personnalis√©e entrera en jeu et nous obtiendrons le r√©sultat souhait√©.  Cette approche est bien √©crite et illustr√©e dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> .  Avec cette technique, nous pouvons cr√©er une classe auxiliaire - un analogue d'un d√©l√©gu√© personnalis√©.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans cette classe, nous √©crirons tout le code personnalis√©, faisant de la classe personnalis√©e une sorte de Wrapper pour appeler la fonctionnalit√© des autres classes. </font><font style="vertical-align: inherit;">Cette approche fonctionnera, mais elle est extr√™mement implicite en raison du fait qu'il est difficile de savoir o√π la m√©thode est remplac√©e et quelles cons√©quences elle entra√Ænera.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Une autre solution au probl√®me </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'aspect principal du probl√®me qui s'est produit est qu'il y a beaucoup de d√©l√©gu√©s personnalis√©s, ou vous ne pouvez en avoir qu'un, ou le remplacer partiellement par un second. </font><font style="vertical-align: inherit;">Dans le m√™me temps, il n'y a aucun moyen de s'assurer que le code des d√©l√©gu√©s personnalis√©s ne se glisse pas dans diff√©rents fichiers source. </font><font style="vertical-align: inherit;">Il s'av√®re que la situation peut √™tre consid√©r√©e comme une r√©f√©rence lorsqu'il n'y a qu'un seul d√©l√©gu√© dans l'application, vous devez pouvoir cr√©er autant de classes personnalis√©es que vous le souhaitez, tandis qu'aucune de ces classes n'utilise la macro pour √©viter les probl√®mes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La chose est petite, il reste √† d√©terminer comment cela peut √™tre fait en utilisant Unity3D, tout en laissant la possibilit√© de construire un projet √† l'aide d'une machine de construction. </font><font style="vertical-align: inherit;">L'algorithme de solution est le suivant:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous √©crivons des d√©l√©gu√©s personnalis√©s dans la quantit√© requise, divisant la logique des plugins en diff√©rentes classes, observant les principes de SOLID et ne recourant pas √† la sophistication. </font></font></li><li>       UnityAppController   XCode      .         UnityAppController   . </li><li>    UnityAppController     Unity . </li><li>     XCode     UnityAppController  ,       </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©l√©ment le plus difficile de cette liste est sans aucun doute le dernier. Cependant, cette fonctionnalit√© peut √™tre impl√©ment√©e dans Unity3D √† l'aide du script de g√©n√©ration post-processus. Un tel script a √©t√© √©crit une belle nuit, vous pouvez le regarder </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce post-processus est assez simple √† utiliser, choisissez-le dans un projet Unity. Regardez dans la fen√™tre Inspecteur et voyez l√† un champ appel√© NewDelegateFile. Faites glisser et d√©posez votre UnityAppController modifi√© dans ce champ et enregistrez.</font></font><br><br><img src="https://habrastorage.org/webt/zs/sb/l2/zssbl2ttito42xsbqwcpqzqfezs.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de la construction d'un projet iOS, le d√©l√©gu√© standard sera remplac√© par un d√©l√©gu√© modifi√© et aucune intervention manuelle n'est requise. </font><font style="vertical-align: inherit;">D√©sormais, lorsque vous ajoutez de nouveaux d√©l√©gu√©s personnalis√©s au projet, il vous suffit de modifier l'option UnityAppController qui tra√Æne dans votre projet Unity.</font></font><br><br><h4>  PS </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Merci √† tous ceux qui sont arriv√©s √† la fin, l'article s'est av√©r√© extr√™mement long. </font><font style="vertical-align: inherit;">J'esp√®re que les informations peintes vous seront utiles.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr430118/">https://habr.com/ru/post/fr430118/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr430106/index.html">Nouveau √† XYZprinting √† IMTS 2018: imprimantes 3D et robots</a></li>
<li><a href="../fr430108/index.html">Pourquoi le "jeune technicien" ne pourra pas construire un laser</a></li>
<li><a href="../fr430112/index.html">Comment nous avons appris √† une voiture √† parler avec des millions de personnes</a></li>
<li><a href="../fr430114/index.html">Comment cr√©er des m√©canismes de jeu fiables dans Excel. 2e partie</a></li>
<li><a href="../fr430116/index.html">Les ordinateurs √©crivent de la prose, mais restent inf√©rieurs aux gens. Pourquoi?</a></li>
<li><a href="../fr430120/index.html">Apprivoisez la b√™te. Ce √† quoi nous avons √©t√© confront√©s lors du d√©veloppement d'une application d'agenda personnel sur React Native</a></li>
<li><a href="../fr430122/index.html">Le workaholism est une condition douloureuse dont il n'est pas habituel de parler.</a></li>
<li><a href="../fr430126/index.html">Une autre liste de projets √† pratiquer</a></li>
<li><a href="../fr430128/index.html">D√©veloppement par le test: am√©liorer les comp√©tences</a></li>
<li><a href="../fr430132/index.html">Ce que nous avons appris sur la s√©curit√© Intel ME ces derni√®res ann√©es: 7 faits sur le myst√©rieux sous-syst√®me</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>