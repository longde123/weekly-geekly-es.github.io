<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕙 💪🏼 🌊 Tester votre infrastructure en tant que code avec Pulumi. 2e partie 🥥 ☹️ 🚽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous. Aujourd'hui, nous partageons avec vous la dernière partie de l'article «Tester l'infrastructure en tant que code à l'aide de Pulumi» ,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tester votre infrastructure en tant que code avec Pulumi. 2e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/463637/">  Bonjour à tous.  Aujourd'hui, nous partageons avec vous la dernière partie de l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«Tester l'infrastructure en tant que code à l'aide de Pulumi»</a> , dont une traduction a été préparée spécifiquement pour les étudiants du cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«DevOps Practices and Tools»</a> . <br><br><img src="https://habrastorage.org/webt/g4/jj/lj/g4jjljt7hq9sghcsyni-lkchyqc.png"><br><br><h3>  Test de déploiement </h3><br>  Le style de test testé est une approche puissante; il nous permet de tester une boîte blanche pour vérifier l'intérieur de notre code d'infrastructure.  Cependant, cela limite quelque peu ce que nous pouvons vérifier.  Les tests sont effectués sur la base du plan de déploiement en mémoire créé par Pulumi avant le déploiement direct et, par conséquent, le déploiement lui-même ne peut pas être testé.  Pour de tels cas, Pulumi dispose d'un cadre de test d'intégration.  Et ces deux approches fonctionnent très bien ensemble! <br><a name="habracut"></a><br>  Le framework de test d'intégration Pulumi est écrit en Go, et c'est avec son aide que nous testons la plupart de notre code interne.  Si l'approche de test unitaire discutée précédemment ressemblait davantage à un test de boîte blanche, alors le test d'intégration est une boîte noire.  (Il existe également des options pour des tests internes approfondis.) Ce cadre a été créé afin de prendre le programme Pulumi complet et d'effectuer diverses opérations de cycle de vie pour lui, telles que le déploiement d'une nouvelle pile à partir de zéro, la mise à jour avec des variantes et la suppression, éventuellement plusieurs fois.  Nous les exécutons régulièrement (par exemple, la nuit) et comme tests de résistance. <br><br>  (Nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nous efforçons de garantir</a> que des capacités de test d'intégration similaires sont dans le SDK de la langue maternelle. Vous pouvez utiliser le framework de test d'intégration Go quelle que soit la langue dans laquelle votre programme Pulumi est écrit). <br><br>  En exécutant le programme à l'aide de ce cadre, vous pouvez vérifier les éléments suivants: <br><br><ul><li>  Le code de votre projet est syntaxiquement correct et fonctionne sans erreur. </li><li>  Les paramètres de configuration de la pile et des secrets fonctionnent et sont interprétés correctement. </li><li>  Votre projet peut être déployé avec succès dans votre fournisseur de cloud choisi. </li><li>  Votre projet peut être mis à niveau avec succès de l'état initial vers N autres états. </li><li>  Votre projet peut être détruit et supprimé avec succès de votre fournisseur de cloud. </li></ul><br>  Comme nous le verrons bientôt, ce cadre peut également être utilisé pour effectuer la validation d'exécution. <br><br><h4>  Test d'intégration simple </h4><br>  Pour voir cela en action, nous allons regarder le <code>pulumi/examples</code> , car notre équipe et la communauté Pulumi l'utilisent pour tester leur propre pool de requêtes, de validations et de builds nocturnes. <br><br>  Vous trouverez ci-dessous un test simplifié de notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple, qui effectue le provisionnement du compartiment S3 et de certains autres objets</a> : <br><br><h4>  example_test.go: </h4><br><pre> <code class="javascript hljs">package test <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"path"</span></span> <span class="hljs-string"><span class="hljs-string">"testing"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/pulumi/pulumi/pkg/testing/integration"</span></span> ) func TestExamples(t *testing.T) { <span class="hljs-attr"><span class="hljs-attr">awsRegion</span></span> := os.Getenv(<span class="hljs-string"><span class="hljs-string">"AWS_REGION"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> awsRegion == <span class="hljs-string"><span class="hljs-string">""</span></span> { awsRegion = <span class="hljs-string"><span class="hljs-string">"us-west-1"</span></span> } cwd, <span class="hljs-attr"><span class="hljs-attr">_</span></span> := os.Getwd() integration.ProgramTest(t, &amp;integration.ProgramTestOptions{ <span class="hljs-attr"><span class="hljs-attr">Quick</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">SkipRefresh</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">Dir</span></span>: path.Join(cwd, <span class="hljs-string"><span class="hljs-string">".."</span></span>, <span class="hljs-string"><span class="hljs-string">".."</span></span>, <span class="hljs-string"><span class="hljs-string">"aws-js-s3-folder"</span></span>), <span class="hljs-attr"><span class="hljs-attr">Config</span></span>: map[string]string{ <span class="hljs-string"><span class="hljs-string">"aws:region"</span></span>: awsRegion, }, }) }</code> </pre> <br>  Ce test passe par le cycle de vie de base de la création, de la modification et de la destruction de la pile pour le <code>aws-js-s3-folder</code> .  Il faudra environ une minute pour signaler le test réussi: <br><br><pre> <code class="javascript hljs">$ go test . PASS ok ... <span class="hljs-number"><span class="hljs-number">43.993</span></span>s</code> </pre> <br>  Il existe de nombreuses options pour personnaliser le comportement de ces tests.  Voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">structure</a> <code>ProgramTestOptions</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pour une</a> liste complète des options.  Par exemple, vous pouvez configurer le point de terminaison Jaeger pour tracer ( <code>Tracing</code> ), indiquer que vous vous attendez à ce que le test <code>ExpectFailure</code> lors d'un test négatif ( <code>ExpectFailure</code> ), appliquer une série de «modifications» au programme pour des transitions d'état successives ( <code>EditDirs</code> ), et bien plus encore.  Voyons comment les utiliser pour vérifier le déploiement des applications. <br><br><h4>  Vérification des propriétés des ressources </h4><br>  L'intégration mentionnée ci-dessus garantit que notre programme "fonctionne" - il ne plante pas.  Mais que se passe-t-il si nous voulons vérifier les propriétés de la pile résultante?  Par exemple, que certains types de ressources ont été (ou n'étaient pas) préparés et qu'ils ont certains attributs. <br><br>  Le paramètre <code>ExtraRuntimeValidation</code> pour <code>ExtraRuntimeValidation</code> nous permet de regarder l'état enregistré par Pulumi après le déploiement (état post-déploiement) afin que nous puissions faire des vérifications supplémentaires.  Cela inclut un instantané complet de l'état de la pile résultante, y compris la configuration, les valeurs de sortie exportées, toutes les ressources et leurs valeurs de propriété, ainsi que toutes les dépendances entre les ressources. <br><br>  Pour voir un exemple de base de cela, vérifions que notre programme crée un <b>compartiment S3</b> : <br><br><pre> <code class="javascript hljs"> integration.ProgramTest(t, &amp;integration.ProgramTestOptions{ <span class="hljs-comment"><span class="hljs-comment">// as before... ExtraRuntimeValidation: func(t *testing.T, stack integration.RuntimeValidationStackInfo) { var foundBuckets int for _, res := range stack.Deployment.Resources { if res.Type == "aws:s3/bucket:Bucket" { foundBuckets++ } } assert.Equal(t, 1, foundBuckets, "Expected to find a single AWS S3 Bucket") }, })</span></span></code> </pre> <br>  Maintenant, lorsque nous exécutons le test go, il passera non seulement par la batterie de tests de cycle de vie, mais aussi, après avoir déployé avec succès la pile, il effectuera une vérification supplémentaire de l'état résultant. <br><br><h3>  Tests d'exécution </h3><br>  Jusqu'à présent, tous les tests ont porté exclusivement sur le comportement de déploiement et sur le modèle de ressource Pulumi.  Et si vous voulez vérifier que votre infrastructure préparée fonctionne vraiment?  Par exemple, que la machine virtuelle fonctionne, le compartiment S3 contient ce que nous attendons, etc. <br><br>  Vous avez peut-être déjà compris comment procéder: l'option <code>ExtraRuntimeValidation</code> pour <code>ProgramTestOptions</code> est une excellente opportunité pour cela.  À ce stade, vous exécutez un test Go arbitraire avec accès à l'état complet des ressources de votre programme.  Cet état comprend des informations telles que les adresses IP des machines virtuelles, les URL et tout ce qui est nécessaire pour une interaction réelle avec les applications et l'infrastructure cloud reçues. <br><br>  Par exemple, notre programme de test exporte une propriété de <code>websiteUrl</code> appelée <code>websiteUrl</code> , qui est l'URL complète à laquelle nous pouvons obtenir le <code>index document</code> personnalisé.  Bien que nous puissions fouiller dans le fichier d'état pour trouver le <code>bucket</code> et lire directement cette propriété, dans de nombreux cas, nos piles exportent des propriétés utiles, telles que celle-ci, qui nous sont pratiques pour vérifier: <br><br><pre> <code class="javascript hljs">integration.ProgramTest(t, &amp;integration.ProgramTestOptions{ <span class="hljs-comment"><span class="hljs-comment">// as before ... ExtraRuntimeValidation: func(t *testing.T, stack integration.RuntimeValidationStackInfo) { url := "http://" + stack.Outputs["websiteUrl"].(string) resp, err := http.Get(url) if !assert.NoError(t, err) { return } if !assert.Equal(t, 200, resp.StatusCode) { return } defer resp.Body.Close() body, err := ioutil.ReadAll(resp.Body) if !assert.NoError(t, err) { return } assert.Contains(t, string(body), "Hello, Pulumi!") }, })</span></span></code> </pre> <br>  Comme nos précédentes vérifications d'exécution, cette vérification sera effectuée immédiatement après avoir augmenté la pile, et tout cela en réponse à un simple appel à <code>go test</code> .  Et ce n'est que la pointe de l'iceberg - toutes les fonctionnalités de test Go que vous pouvez écrire dans le code sont disponibles. <br><br><h3>  Intégration continue des infrastructures </h3><br>  Il est bon de pouvoir exécuter des tests sur un ordinateur portable lorsque de nombreuses modifications sont apportées à l'infrastructure pour les tester avant de les envoyer aux revues de code.  Mais nous et bon nombre de nos clients testons l'infrastructure à différentes étapes du cycle de vie du développement: <br><br><ul><li>  Dans chaque pool ouvert, la demande de test avant la fusion. </li><li>  En réponse à chaque validation, vérifiez à nouveau que la fusion a été effectuée correctement. </li><li>  Périodiquement, par exemple, la nuit ou chaque semaine pour des tests supplémentaires. </li><li>  Dans le cadre de tests de performances ou de tests de stress, qui sont généralement effectués sur une longue période et exécutent des tests en parallèle et / ou déploient le même programme plusieurs fois. </li></ul><br>  Pour chacun d'eux, Pulumi prend en charge l'intégration avec votre système d'intégration continue préféré.  Avec une intégration continue, cela vous offre la même couverture de test pour votre infrastructure que pour les logiciels d'application. <br><br>  Pulumi prend en charge les systèmes CI courants.  En voici quelques uns: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Services de code AWS</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Azure DevOps</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CircleCI</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Actions Github</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gitlab ci</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google Cloud Build</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Travis</a> </li></ul><br>  Pour plus d'informations, consultez la documentation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">livraison continue</a> . <br><br><h3>  Environnements éphémères </h3><br>  Une fonctionnalité très puissante qui s'ouvre est la possibilité de déployer des environnements éphémères uniquement à des fins de test d'acceptation.  Le concept de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet et de pile</a> Pulumi est conçu pour déployer et démolir facilement des environnements complètement isolés et indépendants, le tout en quelques commandes CLI simples ou via un cadre de test d'intégration. <br><br>  Si vous utilisez GitHub, Pulumi propose l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">application GitHub</a> , qui vous aidera à connecter les tests d'acceptation au pool de demandes à l'intérieur de votre pipeline CI.  Installez simplement l'application dans le référentiel GitHub, et Pulumi ajoutera des informations sur l'aperçu de l'infrastructure, les mises à jour et les résultats des tests à votre CI et à votre pool de demandes: <br><br><img src="https://habrastorage.org/webt/bg/tw/gd/bgtwgdjexhumpc3jct7ier8uc6k.png"><br><br>  Lorsque vous utilisez Pulumi pour vos tests d'acceptation de base, vous disposerez de nouvelles capacités d'automatisation qui amélioreront les performances de l'équipe et donneront confiance dans la qualité des changements. <br><br><h3>  Résumé </h3><br>  Dans cet article, nous avons vu que lors de l'utilisation de langages de programmation à usage général, de nombreuses méthodes de développement de logiciels qui étaient utiles dans le développement de nos applications deviennent disponibles pour nous.  Ils incluent les tests unitaires, les tests d'intégration et leur interaction pour effectuer des tests d'exécution approfondis.  Les tests sont faciles à exécuter à la demande ou dans votre système CI. <br><br>  <b>Pulumi</b> est un logiciel open source, il est gratuit à utiliser et fonctionne avec vos langages de programmation et nuages ​​préférés - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essayez-le aujourd'hui</a> ! <br><br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La première partie</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr463637/">https://habr.com/ru/post/fr463637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr463623/index.html">Nous sommes sélectionnés dans la jungle des tests: nous construisons à courte distance des luminaires aux tests</a></li>
<li><a href="../fr463625/index.html">Surveillance du réseau et détection de l'activité réseau anormale à l'aide des solutions Flowmon Networks</a></li>
<li><a href="../fr463627/index.html">Bibliothèque de générateur de code assembleur pour microcontrôleurs AVR. Partie 4</a></li>
<li><a href="../fr463629/index.html">Configuration de NextCloud + ONLYOFFICE sur le même serveur à l'aide de Docker</a></li>
<li><a href="../fr463631/index.html">Dialogues sur les lettres</a></li>
<li><a href="../fr463639/index.html">Eh bien Apple BLEee</a></li>
<li><a href="../fr463647/index.html">Vidéos et rapports avec SmartMail Meetup: Frontend</a></li>
<li><a href="../fr463649/index.html">Note analytique. Révision de l'ordonnance du ministère de l'Énergie de la Fédération de Russie du 6 novembre 2018 N 1015</a></li>
<li><a href="../fr463651/index.html">Mathématiques discrètes pour WMS: algorithme de compression des marchandises dans les cellules (partie 2)</a></li>
<li><a href="../fr463653/index.html">Limitations des jeux 16 bits et de leur recréation dans Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>