<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ù§Ô∏è üõåüèº üêÉ Por qu√© y c√≥mo escondemos las placas de los autos en los avisos de Avito üò± üîÉ ‚úãüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola A fines del a√±o pasado, comenzamos a ocultar autom√°ticamente los n√∫meros de veh√≠culos en fotograf√≠as en las tarjetas de anuncio de Avito. Sobre p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Por qu√© y c√≥mo escondemos las placas de los autos en los avisos de Avito</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/447286/">  Hola  A fines del a√±o pasado, comenzamos a ocultar autom√°ticamente los n√∫meros de veh√≠culos en fotograf√≠as en las tarjetas de anuncio de Avito.  Sobre por qu√© hicimos esto, y cu√°les son las formas de resolver tales problemas, lea el art√≠culo. <br><br><img src="https://habrastorage.org/webt/fr/0p/vx/fr0pvxzrkfbjqpvdeeu3-hfp4z8.png" alt="¬°Esconde mi plato!"><br><a name="habracut"></a><br><h4>  Desaf√≠o </h4><br>  En Avito en 2018, se vendieron 2.5 millones de autom√≥viles.  Esto es casi 7000 por d√≠a.  Todos los anuncios a la venta necesitan una ilustraci√≥n: una foto de un autom√≥vil.  Pero por el n√∫mero de estado en √©l, puede encontrar mucha informaci√≥n adicional sobre el autom√≥vil.  Y algunos de nuestros usuarios intentan cerrar la placa por su cuenta. <br><table><tbody><tr><td><img src="https://habrastorage.org/webt/ti/u9/yl/tiu9ylusazwgoyouuhvbd3iephi.png" alt="imagen"></td><td><img src="https://habrastorage.org/webt/tf/8x/6l/tf8x6lq0j4cnyytbzn4pbwalky8.png" alt="imagen"></td></tr><tr><td><img src="https://habrastorage.org/webt/t-/mz/ig/t-mzigkjjc00g-w_b2vx4sz0vy8.png" alt="imagen"></td><td><img src="https://habrastorage.org/webt/rq/gu/31/rqgu31h8n1j4n08z2wu6oqfzwlo.png" alt="imagen"></td></tr><tr><td colspan="2"><img src="https://habrastorage.org/webt/55/9b/rb/559brbhsq8xldsnln_umbwjqldw.png" alt="prototipo para ilustraci√≥n al comienzo del art√≠culo"></td></tr></tbody></table><br>  Las razones por las cuales los usuarios desean ocultar el n√∫mero de placa pueden ser diferentes.  Por nuestra parte, queremos ayudarlos a proteger sus datos.  Y tratamos de mejorar los procesos de venta y compra para los usuarios.  Por ejemplo, un servicio de n√∫meros an√≥nimos ha estado trabajando con nosotros durante mucho tiempo: cuando vende un autom√≥vil, se crea un n√∫mero celular temporal para usted.  Bueno, para proteger los datos en las placas, anonimizamos las fotos. <br><br><img src="https://habrastorage.org/webt/ol/-o/ii/ol-oiivyox1f2cogwd2pzf1jz9y.png" alt="imagen"><br><br><h4>  Resumen de la soluci√≥n </h4><br>  Para automatizar el proceso de protecci√≥n de las fotos de los usuarios, puede usar redes neuronales convolucionales para detectar un pol√≠gono con una placa de matr√≠cula. <br>  Ahora, para la detecci√≥n de objetos, se utilizan arquitecturas de dos grupos: redes de dos etapas, por ejemplo, Faster RCNN y Mask RCNN;  Single-Stage (Singleshot) - SSD, YOLO, RetinaNet.  La detecci√≥n de un objeto es la derivaci√≥n de las cuatro coordenadas del rect√°ngulo en el que se inscribe el objeto de inter√©s. <br><br><img src="https://habrastorage.org/webt/-g/bz/p4/-gbzp4vk0cj2uwknc1qeavh8roy.png" alt="imagen"><br><br>  Las redes mencionadas anteriormente pueden encontrar muchos objetos de diferentes clases en im√°genes, lo que ya es redundante para resolver el problema de b√∫squeda de matr√≠culas, porque generalmente solo tenemos un autom√≥vil en las im√°genes (hay excepciones cuando las personas toman fotograf√≠as de su autom√≥vil vendido y su vecino aleatorio) , pero esto ocurre muy raramente, por lo que esto podr√≠a descuidarse). <br><br>  Otra caracter√≠stica de estas redes es que, por defecto, producen un cuadro delimitador con lados paralelos a los ejes de coordenadas.  Esto sucede porque se utiliza un conjunto de tipos predefinidos de marcos rectangulares llamados cuadros de anclaje para la detecci√≥n.  M√°s precisamente, primero usando una red convolucional (por ejemplo, resnet34), se obtiene una matriz de atributos de la imagen.  Luego, para cada subconjunto de atributos obtenidos usando la ventana deslizante, se produce una clasificaci√≥n: hay un objeto para el cuadro de anclaje k o no, y se realiza una regresi√≥n en las cuatro coordenadas del marco, que ajustan su posici√≥n. <br>  Lea m√°s sobre esto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br><img src="https://habrastorage.org/webt/ew/er/dq/ewerdqloqogwqhsp8kauzmwzwtq.png" alt="imagen"><br><br>  Despu√©s de eso, hay dos cabezas m√°s: <br><br><img src="https://habrastorage.org/webt/be/9j/ib/be9jibquo3xic6fi-3dof-ivyq4.png" alt="no es la imagen m√°s original de la arquitectura"><br><br>  uno para clasificar el objeto (perro / gato / planta, etc.), <br>  el segundo (regresor de bbox): para la regresi√≥n de las coordenadas del marco obtenido en el paso anterior para aumentar la relaci√≥n del √°rea del objeto al √°rea del marco. <br><br>  Para predecir el marco de boxeo girado, debe cambiar el regresor de bbox para que tambi√©n obtenga el √°ngulo de rotaci√≥n del marco.  Si esto no se hace, entonces resultar√° de alguna manera. <br><br><img src="https://habrastorage.org/webt/c0/4p/5d/c04p5dcpnl02xrgbvapzycdtboe.png" alt="imagen"><br><br>  Adem√°s del Faster R-CNN de dos etapas, hay detectores de una etapa, como RetinaNet.  Se diferencia de la arquitectura anterior en que predice inmediatamente la clase y el marco, sin la etapa preliminar de proponer secciones de la imagen que pueden contener objetos.  Para predecir las m√°scaras rotadas, tambi√©n debe cambiar el encabezado de la subred del cuadro. <br><br><img src="https://habrastorage.org/webt/uu/_w/qx/uu_wqxel27ctxz39s_trbw4be88.png" alt="imagen"><br><br>  Un ejemplo de arquitecturas existentes para predecir cuadros delimitadores rotados es DRBOX.  Esta red no utiliza la etapa preliminar de la propuesta de la regi√≥n, como en RCNN m√°s r√°pido; por lo tanto, es una modificaci√≥n de los m√©todos de una etapa.  Para entrenar esta red, se usa K rotado en ciertos √°ngulos.  La red predice las probabilidades de que cada uno de K rbox contenga el objeto objetivo, las coordenadas, el tama√±o de bbox y el √°ngulo de rotaci√≥n. <br><br><img src="https://habrastorage.org/webt/oq/a4/yo/oqa4yonbchbbmkcu9mjsj7nmmfm.png" alt="imagen"><br><br>  Modificar la arquitectura y volver a entrenar una de las redes consideradas en los datos con cuadros delimitadores rotados es una tarea realizable.  Pero nuestro objetivo se puede lograr m√°s f√°cilmente, porque el alcance de la red que tenemos es mucho m√°s limitado, solo para ocultar las placas. <br>  Por lo tanto, decidimos comenzar con una red simple para predecir los cuatro puntos del n√∫mero y, posteriormente, ser√° posible complicar la arquitectura. <br><br><h4>  Datos </h4><br>  El ensamblaje del conjunto de datos se divide en dos pasos: para recolectar im√°genes de autom√≥viles y marcar el √°rea con la placa de matr√≠cula.  La primera tarea ya se ha resuelto en nuestra infraestructura: almacenamos cuidadosamente todos los anuncios que se han colocado en Avito.  Para resolver el segundo problema, usamos Toloka.  En <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">toloka.yandex.ru/requester</a> creamos una tarea: <br><blockquote>  La tarea dada una fotograf√≠a del coche.  Es necesario resaltar la matr√≠cula del autom√≥vil utilizando un cuadr√°ngulo.  En este caso, el n√∫mero de estado debe asignarse con la mayor precisi√≥n posible. </blockquote><img src="https://habrastorage.org/webt/mk/vl/j4/mkvlj4d7k8bsg_xkke1gkcsrxuy.png" alt="imagen"><br><br>  Con Toloka, puede crear tareas para marcar datos.  Por ejemplo, eval√∫e la calidad de los resultados de b√∫squeda, marque diferentes clases de objetos (textos e im√°genes), marque videos, etc.  Los usuarios de Toloka los realizar√°n, por la tarifa que usted cobra.  Por ejemplo, en nuestro caso, los tolokers deben resaltar el vertedero con el n√∫mero de placa del autom√≥vil en la foto.  En general, es muy conveniente para marcar un gran conjunto de datos, pero obtener alta calidad es bastante dif√≠cil.  Hay muchos robots en la multitud, cuya tarea es obtener dinero de usted dando respuestas al azar o utilizando alg√∫n tipo de estrategia.  Para contrarrestar estos bots hay un sistema de reglas y controles.  La verificaci√≥n principal es la mezcla de preguntas de control: usted marca manualmente parte de las tareas utilizando la interfaz Toloki y luego las mezcla en la tarea principal.  Si el marcado a menudo se confunde en las preguntas de control, lo bloquea y no tiene en cuenta el marcado. <br><br>  Para la tarea de clasificaci√≥n, es muy simple determinar si el marcado es incorrecto o no, y para el problema de resaltar una regi√≥n, no es tan simple.  La forma cl√°sica es contar IoU. <br><br><img src="https://habrastorage.org/webt/fw/r2/ye/fwr2yeqbrlk1-skjy2udjx04y2e.png" alt="imagen"><br><br>  Si esta proporci√≥n es inferior a un cierto umbral para varias tareas, dicho usuario se bloquea.  Sin embargo, para dos cuadr√°ngulos arbitrarios, calcular IoU no es tan simple, especialmente porque en Tolok es necesario implementar esto en JavaScript.  Hicimos un peque√±o truco, y creemos que el usuario no se equivoc√≥ si para cada punto del pol√≠gono fuente en un vecindario peque√±o hay un punto marcado con un escriba.  Tambi√©n hay una regla de respuesta r√°pida para bloquear usuarios que responden demasiado r√°pido, captcha, discrepancia con la opini√≥n de la mayor√≠a, etc.  Una vez configuradas estas reglas, puede esperar un marcado bastante bueno, pero si realmente necesita un marcado complejo y de alta calidad, debe contratar espec√≠ficamente a escritores independientes.  Como resultado, nuestro conjunto de datos ascendi√≥ a 4k im√°genes marcadas, y todo cost√≥ $ 28 en Tolok. <br><br><h4>  Modelo </h4><br>  Ahora hagamos una red para predecir los cuatro puntos del √°rea.  Obtendremos los signos usando resnet18 (11.7M par√°metros versus 21.8M par√°metros para resnet34), luego haremos una cabeza para la regresi√≥n a cuatro puntos (ocho coordenadas) y una cabeza para la clasificaci√≥n si hay una placa en la imagen o no.  Se necesita la segunda cabeza, porque en los anuncios para la venta de autom√≥viles, no todas las fotos con autom√≥viles.  La foto puede ser un detalle del autom√≥vil. <br><br><img src="https://habrastorage.org/webt/wz/qc/5s/wzqc5spmzueaqptlw6hiknobayo.png" alt="imagen"><br><br>  Similar a nosotros, por supuesto, no es necesario detectarlo. <br><br>  Entrenamos dos objetivos al mismo tiempo agregando al conjunto de datos una foto sin una placa con un cuadro delimitador (0,0,0,0,0,0,0,0,0) y un valor para el clasificador "imagen con / sin placa" - (0, 1) <br><br>  Luego puede crear una funci√≥n de p√©rdida √∫nica para ambos objetivos como la suma de las siguientes p√©rdidas.  Para la regresi√≥n a las coordenadas del pol√≠gono de matr√≠cula, usamos una p√©rdida L1 suave. <br><br><img src="https://habrastorage.org/webt/6s/v7/yu/6sv7yus_w9o4d1xmqfhbnsenotc.png" alt="imagen"><br><br>  Se puede interpretar como una combinaci√≥n de L1 y L2, que se comporta como L1 cuando el valor absoluto del argumento es grande y como L2 cuando el valor del argumento es cercano a cero.  Para la clasificaci√≥n, utilizamos softmax y p√©rdida por crossentrop√≠a.  El extractor de funciones es resnet18, usamos pesos pre-entrenados en ImageNet, luego entrenaremos m√°s el extractor y los cabezales en nuestro conjunto de datos.  En este problema, utilizamos el framework mxnet, ya que es el principal para la visi√≥n por computadora en Avito.  En general, la arquitectura de microservicio le permite no estar vinculado a un marco espec√≠fico, pero cuando tiene una base de c√≥digo grande, es mejor usarlo y no volver a escribir el mismo c√≥digo. <br><br>  Habiendo recibido una calidad aceptable en nuestro conjunto de datos, recurrimos a los dise√±adores para obtener una placa con el logotipo de Avito.  Al principio intentamos hacerlo nosotros mismos, por supuesto, pero no se ve√≠a muy hermoso.  A continuaci√≥n, debe cambiar el brillo de la placa de matr√≠cula de Avito al brillo del √°rea original con la placa de matr√≠cula y puede superponer el logotipo en la imagen. <br><br><img src="https://habrastorage.org/webt/3j/gr/bz/3jgrbzhv3y9sldjmbm5hlfmhlo8.png" alt="imagen"><br><br><h4>  Lanzamiento en prod </h4><br>  El problema de la reproducibilidad de los resultados, el soporte y el desarrollo de proyectos, resuelto con alg√∫n error en el mundo del desarrollo de backend y frontend, sigue abierto cuando se requiere el uso de modelos de aprendizaje autom√°tico.  Probablemente ten√≠as que entender el modelo de c√≥digo heredado.  Es bueno si el archivo L√©ame tiene enlaces a art√≠culos o repositorios de c√≥digo abierto en los que se bas√≥ la soluci√≥n.  El script para iniciar el reentrenamiento puede fallar con errores, por ejemplo, la versi√≥n de cudnn ha cambiado, y esa versi√≥n de tensorflow ya no funciona con esta versi√≥n de cudnn, y cudnn ya no funciona con esta versi√≥n de controladores nvidia.  Quiz√°s para el entrenamiento usamos un iterador de acuerdo con los datos, y para probar en producci√≥n otro.  Esto puede continuar por bastante tiempo.  En general, existen problemas de reproducibilidad. <br><br>  Intentamos eliminarlos utilizando el entorno nvidia-docker para modelos de entrenamiento, tiene todas las dependencias necesarias para cuda, y tambi√©n instalamos dependencias para python all√≠.  La versi√≥n de la biblioteca con un iterador de acuerdo con los datos, los aumentos y los modelos de inferencia es com√∫n para la etapa de capacitaci√≥n / experimentaci√≥n y para la producci√≥n.  Por lo tanto, para entrenar el modelo en nuevos datos, debe bombear el repositorio al servidor, ejecutar el script de shell que recopilar√° el entorno de Docker, dentro del cual se levantar√° el cuaderno Jupyter.  En el interior, tendr√° todas las computadoras port√°tiles para capacitaci√≥n y pruebas, que ciertamente no fallar√°n con un error debido al entorno.  Es mejor, por supuesto, tener un archivo train.py, pero la pr√°ctica muestra que siempre debe mirar con los ojos lo que el modelo le da y cambiar algo en el proceso de aprendizaje, por lo que al final a√∫n ejecutar√° jupyter. <br><br>  Los pesos de los modelos se almacenan en git lfs: esta es una tecnolog√≠a especial para almacenar archivos grandes en un git. Antes de eso, us√°bamos artefactos, pero usar git lfs es m√°s conveniente, porque al descargar el repositorio con el servicio, obtienes de inmediato la versi√≥n actual de la balanza, como en la producci√≥n.  Las pruebas autom√°ticas se escriben para la inferencia del modelo, por lo que no podr√° implementar un servicio con pesos que no los superen.  El servicio en s√≠ se inicia en la ventana acoplable dentro de la infraestructura de microservicios en el cl√∫ster de kubernetes.  Para controlar el rendimiento, utilizamos grafana.  Despu√©s de la implementaci√≥n, aumentamos gradualmente la carga en las instancias de servicio con un nuevo modelo.  Al implementar una nueva funci√≥n, creamos pruebas a / b y emitimos un veredicto sobre el destino futuro de la funci√≥n, en base a pruebas estad√≠sticas. <br><br>  Como resultado: lanzamos el glosado de n√∫meros en anuncios en la categor√≠a autom√°tica para comerciantes privados, el percentil 95 del tiempo de procesamiento de una imagen para ocultar el n√∫mero es de 250 ms. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447286/">https://habr.com/ru/post/447286/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447276/index.html">¬øQu√© es la biblioteca ITIL y por qu√© su empresa la necesita?</a></li>
<li><a href="../447278/index.html">Estonia est√° tratando de usar la IA en la justicia</a></li>
<li><a href="../447280/index.html">Nivelar cuentas de juegos en China: un negocio serio y un dolor de cabeza para los desarrolladores</a></li>
<li><a href="../447282/index.html">Errores de programadores de sistemas y aplicaciones atrapados en la interfaz (art√≠culo eliminado)</a></li>
<li><a href="../447284/index.html">Actualice las herramientas web y Azure en Visual Studio 2019</a></li>
<li><a href="../447288/index.html">Top 5 monedas estables. Todo lo que necesitas saber</a></li>
<li><a href="../447290/index.html">Doctor paseos, paseos</a></li>
<li><a href="../447292/index.html">14 nuevos productos en Visual Studio 2019</a></li>
<li><a href="../447294/index.html">Live Share ahora incluido con Visual Studio 2019</a></li>
<li><a href="../447298/index.html">Gesti√≥n del conocimiento a trav√©s de modelos de competencia.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>