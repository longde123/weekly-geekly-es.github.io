<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤾🏾 🙅🏼 🗑️ Raucher Black Box 📒 🚪 👨🏽‍🎤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Viele Menschen rauchen zu viel, besonders wenn sie süchtig nach etwas sind und nicht bemerken, wie sie eine Zigarette nach der anderen rauchen. In der...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Raucher Black Box</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402867/">  Viele Menschen rauchen zu viel, besonders wenn sie süchtig nach etwas sind und nicht bemerken, wie sie eine Zigarette nach der anderen rauchen.  In der Black Box des Rauchers (CJK) können Sie die nächste Zigarette erst nach Ablauf einer bestimmten Zeit nehmen.  In diesem Artikel werde ich auf einige Details eingehen, die für andere Entwicklungen nützlich sein können, insbesondere den nicht so bekannten Teensy LC-Controller (Arduino-Familie). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mRDSiEAsiAI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  <b>Die Mechanik</b> <br><br>  ChYAK-Details werden auf einem 3D-Drucker gedruckt und nach dem Zusammenbau des unteren, mittleren und oberen Teils zusammengeklebt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/353/eb5/369/353eb5369a304723be064ac6e07722e9.jpg"></div><br><br>  Der Verriegelungsmechanismus ist elektromechanisch, während die grundlegenden Verriegelungsfunktionen rein mechanisch realisiert werden. Dies macht es schwierig, den NJC durch Manipulieren der Lücken und Entfernen der Batterien zu knacken. <br><br>  Das Verriegelungssystem besteht aus einem Gestell mit Zähnen und einer bistabilen Ratsche, die es dem Tablett ermöglicht, sich nur in Schließrichtung zu bewegen.  Bei Erreichen einer vorbestimmten Zeitspanne macht das Servo eine einzelne Bewegung hin und her und drückt die Ratsche, die in den zweiten stabilen Zustand "offen" versetzt ist.  Der FCKW bleibt geöffnet, bis der Benutzer das Fach mechanisch herauszieht.  Im ausgefahrenen Zustand drückt das Tablett auf die Ratsche und versetzt sie wieder in den gespannten Zustand. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a0b/9a1/c0e/a0b9a1c0eaf74795b582073f40f55b93.jpg"></div><br><br>  Der Lader besteht aus einer Trommel mit 4 Aussparungen für Zigaretten.  Um zu vermeiden, dass versucht wird, eine Zigarette durch den Lader zu bekommen, erlaubt der Ratschenmechanismus keine Bewegung in die entgegengesetzte Richtung, von deren Seite die Stoßstangen hergestellt sind. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/69b/1af/cb9/69b1afcb91214e94a40b24be99f6895e.jpg"></div><br><br>  Auf dem oberen Deckel wurden Schlitze angebracht, mit denen Sie mögliche Verzerrungen von Zigaretten in der Schachtel beseitigen und Tabakchips ausschütteln können. <br><br>  <b>Schnittstelle</b> <br><br>  Um die Zeit, die Anzahl der Zigaretten in CHYAK und die Anzahl der herausgenommenen Zigaretten zu steuern, wird das OLED-Display überwacht.  Es wird fast immer ausgeschaltet, um die Batterie nicht zu entladen, und nur durch ein Signal des zentralen kapazitiven Sensors eingeschaltet, das ausgelöst wird, wenn eine Hand zum CHYAK gebracht wird, oder durch ein Signal vom Knopf beim Laden von Zigaretten.  Eine weitere Taste erfasst den Moment, in dem das Fach geschlossen wird, und startet den nächsten Verzögerungszyklus.  Zwei zusätzliche kapazitive Sensoren befinden sich an der Rückwand und dienen zur Einstellung der Zigarettenzähler (z. B. beim Batteriewechsel erforderlich). <br><br>  <b>Elektronik</b> <br><br>  Der Mikrocontroller ist ein Teensy LC.  Dieses Arduino-ähnliche Gerät, das mit den meisten Arduino-Bibliotheken kompatibel ist, wurde ausgewählt, weil es kapazitive Sensoren (Touch Sense Interface (TSI)) unterstützt.  Die Sensoren sind so empfindlich, dass sie die erhobene Hand in einem Abstand von einem Zentimeter leicht fühlen.  Teensy LC verfügt über den sogenannten LLWU-Modus. In diesem Modus befinden sich alle Module mit Ausnahme des 1-kHz-Oszillators im Ruhemodus.  Sie können diesen Ruhemodus auf vier Arten verlassen: a) einen Interrupt vom kapazitiven Sensor erhalten, b) einen Interrupt vom Pin erhalten, c) einen Überlauf des 1-kHz-Zählers (Low-Power-Timer, LPTMR) erhalten, d) einen Interrupt vom Alarm erhalten. <br><br>  Hier war der Autor in Schwierigkeiten: In den ursprünglichen Plänen war es vorgesehen, TSI zum Aufwachen zu verwenden, wenn eine Hand präsentiert wurde, und LPTMR für periodische Unterbrechungen, um die TSI-Werte (abhängig von den Umgebungsbedingungen) und die Zeitsteuerung anzupassen.  Es stellte sich jedoch heraus, dass LPTMR für die Funktion von TSI verwendet wird und dementsprechend nicht als Zeitzähler verwendet werden kann.  (Der LPTMR-Überlauf-Interrupt löst die Hardware für TSI aus und muss natürlich schnell sein, um den Sensor zu überwachen. Normalerweise ist dieser Zähler auf minus eins voreingestellt, damit TSI mit der höchstmöglichen Frequenz von 1 kHz abgefragt wird.) <br><br>  Eine andere Möglichkeit wäre die Verwendung des RTC-Alarminterrupts. Fakt ist jedoch, dass Tenncy LC keine Echtzeituhr (RTC) hat.  Vielmehr befindet sich RTC im Prozessor selbst, aber es gibt keine Verkabelung für RTC-Quarz auf der Platine.  Der Prozessorentwickler hat jedoch eine Lücke für die Erkundigung von Köpfen hinterlassen.  Der 1-kHz-Oszillator (der im Ruhemodus arbeitet) kann als Quelle für die RTC-Register der Steuerung verwendet werden.  Dann stellt sich heraus, dass RTC nicht Sekundenintervalle zählen kann (wie bei Verwendung von Quarz bei 32 kHz), sondern 32 Sekunden bei Verwendung eines 1-kHz-Oszillators.  Diese Genauigkeit reicht natürlich nicht aus.  Aber es gibt einen Ausweg. <br><br>  So funktioniert es: <br><br>  Es gibt ein RTC Time Prescaler Register (RTC_TPR).  Dieses 16-Bit-Register zählt die Impulse des Oszillators.  Wenn es überläuft, erhöht sich das RTC-Zeitsekundenregister (RTC_TSR) um eins.  Im klassischen Modus sind dies die Sekunden, die mit dem RTC-Zeitalarmregister (RTC_TAR) verglichen werden. Wenn sie zusammenfallen, wird ein Alarminterrupt generiert.  Bei Verwendung von normalem 32-kHz-Quarz ist RTC_TSR nicht vorinstalliert, sondern wird jedes Mal von Null gezählt (32768 bis Überlauf (Sekunden)).  Wenn wir jedoch jedes Mal RTC_TSR voreingestellt haben und berücksichtigen, dass wir einen langsamen 1-kHz-Oszillator haben, können wir einen Alarminterrupt mit einer Genauigkeit von bis zu Millisekunden erhalten (ohne Berücksichtigung der Ungenauigkeit des Oszillators selbst).  Natürlich sollte auch RTC_TAR entsprechend neu berechnet werden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/719/cc7/057/719cc7057df74632be110832ac93d99b.png"></div><br><br>  Wenn wir beispielsweise den Zeitraum auf 87 Sekunden einstellen möchten, müssen wir 2 in RTC_TSR (2 * 32768 = 65536 ms = 65,536 s), 2 in RTC_TAR und 32768- (87 * 1000-65536) = 11304 in RTC_TSR schreiben.  Dann vergehen 32,768-11,304 = 21,464 Sekunden vor dem ersten RTC_TPR-Überlauf, und es werden zwei vollständige Zyklen 2 * 32,768 = 65,536 hinzugefügt, was nur 21,464 + 65,536 = 87 Sekunden entspricht <br>  Im Allgemeinen so: <br><br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> seconds )</span></span></span><span class="hljs-function"> </span></span>{ RTC_SR = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//disable RTC RTC_TPR=32768-(seconds*1000%32768); RTC_TSR=0; //RTC counter RTC_SR = RTC_SR_TCE; //enable RTC RTC_TAR = seconds*1000/32768; }</span></span></code> </pre> <br>  Und selbst wir können die Gesamtzeit (bis zu einem Fehler von 1 kHz des Oszillators) überwachen, wenn beispielsweise zu Beginn des Programms alle RTC-Register Null waren: <br><br><pre> <code class="hljs lisp">timeEllapsed=(<span class="hljs-name"><span class="hljs-name">RTC_TSR*32768+RTC_TPR</span></span>)/1000</code> </pre> <br>  Die Genauigkeit des 1-kHz-Oszillators ist gering, aber für unsere Zwecke wird es ausreichen.  Es ist zu beachten, dass beim Starten eines neuen Alarms die RTC-Register geändert werden. Wenn Sie also die Zeit überwachen müssen, müssen diese vor dem Start des Alarms gespeichert werden. Nach dem Beenden des Alarminterrupts werden sie unter Berücksichtigung der im Ruhezustand verbrachten Zeit erneut neu berechnet.  Ich habe es hier ausführlich beschrieben: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">über RTC für Teency LC</a> <br><br>  Bei CJC misst und speichert ein Interrupt alle 10 Minuten den Signalpegel von kapazitiven Sensoren, wenn keine Hand vorhanden ist.  Dies geschieht, um Änderungen in den Signalen bei ihrer Annäherung zuverlässig verfolgen zu können.  Bei einem Hintergrund von ~ 500 Einheiten verwenden wir einen Überschuss von ~ 20 Einheiten. Dies ermöglicht es, die Hand in einem Abstand von 5-10 mm zu fühlen.  Der Hintergrundpegel hängt von Temperatur und Luftfeuchtigkeit ab. Aus Gründen der Zuverlässigkeit sollte er regelmäßig angepasst werden.  Ich glaube, dies ist ein Fehler bei den Prozessorentwicklern.  Warum haben sie es nicht möglich gemacht, gleichzeitig von TSI und einem anderen Zähler mit geringem Stromverbrauch geweckt zu werden (es muss nur ein weiteres Register hinzugefügt werden), da eine regelmäßige Anpassung der TSI-Werte fast obligatorisch ist, selbst wenn Sie keinen Timer für andere Zwecke benötigen! <br><br>  Nun zum Energieverbrauch.  Im LLWU-Schlafmodus verbraucht der Teensy LC etwa 15 uA, wenn kein Bodykit vorhanden ist.  Wir mussten ein anderes OLED-Display und ein Servo anschließen.  Beide Geräte haben auch im passiven Zustand große Leckströme. <br><br>  Mit OLED ist alles einfach. Dies ist das Adafruit 0,96-Zoll-Monochrom-128x64-OLED-Display. Es wird mit 3,3 V betrieben, verbraucht im eingeschalteten Zustand Strom von etwa 20 mA (abhängig von der Anzahl der beteiligten Pixel) und wird von SPI gesteuert.  Das heißt, schließen Sie einfach den Stromeingang an den 20-Milliampere-Ausgang des Teensy LC an (Teency hat verschiedene Arten von Ausgängen) und fertig.  Wenn alle schlafen, wird dieser Ausgang einfach in den 3. Zustand versetzt und der Strom fließt nicht durch die Anzeige. Beim Aufwecken wird der Ausgang in den hohen Ausgangszustand versetzt und wird für die Anzeige zu Vcc. <br><br>  Servo ist etwas komplizierter.  Servo im Standby-Modus verbraucht einen Strom von ca. 2 mA, was natürlich nicht akzeptabel ist.  Daher müssen Sie es im Schlaf vollständig ausschalten.  Im Gegensatz zum klassischen Arduin verfügt Teensy LC über eine relativ kleine Auswahl an Netzteilen: entweder 1,7-3,3 V direkt angeschlossen oder 2,6-5,5 V (bei eingeschaltetem internen Spannungsregler).  Normalerweise arbeiten zugängliche Servos mit mindestens 1S Lipo, und dies sind 3,3-4,2 V. Daher müssen drei Standardbatterien in Reihe geschaltet werden, um 3,3 (Entladung) bis 4,6 V (neu) zu haben.  Bei den meisten Servos liegt 3,3 V an der Betriebsgrenze, sodass Teensy-Ausgänge nicht direkt verwendet werden können (wie bei OLED).  Ja, und der Strom während der Drehung beträgt ungefähr 50 mA, was für den Teensy LC etwas viel ist.  Daher wird das Servo über einen MOSFET eingeschaltet: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d87/121/7a3/d871217a39f04ecfb537dff032ac7fb1.png"></div><br><br>  Mit dieser Einbeziehung scheint es nicht sicher zu sein, da beim Ausschalten des MOSFET die Spannung am PWM-Strg-Eingang 3,3 V überschreitet und die Tennsy LC-Eingänge nicht 5 V tolerant sind (im Gegensatz zum klassischen Arduin).  Sie sollten sich jedoch nicht davor fürchten, sich daran zu erinnern, dass die aktuelle PWM-Steuerung sehr klein ist und Sie sich nicht vor der Begrenzungsdiode am Prozessoreingang fürchten müssen (der Grund für die Unzulässigkeit, Vcc + 0,5 zu überschreiten, liegt in Strömen, die mit den Strömen der geschlossenen Diode vergleichbar sind) Er wird nicht einmal im offenen Zustand sein. <br><br>  In CHYAK verwende ich HK282 mit einem Schwellenwert von 3,3 V (nur weil ich es hatte).  Eine Art Servo mit niedrigerer Spannung und geringer Leistung kann gemäß dem für OLED verwendeten Schema direkt von den Teensy-Ausgängen gespeist werden. <br><br>  Infolgedessen stellte sich heraus, dass der Strom im Schlafmodus etwa 50 uA betrug, wahrscheinlich war es möglich, ihn noch weiter zu reduzieren, aber ich entschied, dass dies ausreichte (wenn die Batterien nur schlafen, sollten sie länger als 4 Jahre halten: 2000 mAh / 0,05 mA). <br><br>  <b>Technisch</b> <br><br>  Gedruckt auf einem Monoprice Ultimate 3D-Drucker, PLA-Kunststoff, 0,4 mm Düse, 0,2 mm Schicht.  Für Details des Verriegelungsmechanismus eine 0,1 mm Schicht für Genauigkeit.  Die Federn werden auch auf einem 3D-Drucker gedruckt.  Lange tippen.  Zum Beispiel wurde der mittlere Teil (er hat viele Innenteile und Doppelwände für Elektronik und Drähte) 20 Stunden lang gedruckt.  Es wurde mit Cyan-Acrylat-Kleber zusammengeklebt.  Wenn etwas im Inneren kaputt geht, ist es unmöglich zu erkennen (Schutz vor Maniacs-Rauchern), müssen Sie es wie ein Sparschwein zerbrechen und erneut drucken (ein Argument für 3D-Drucker).  Zeichnungen und Animationen werden in SolidWorks, der AtmelStudio-Entwicklungsumgebung, erstellt (ja, AVR (teency) wird wie Arduino sofort über VisualMicro unterstützt). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de402867/">https://habr.com/ru/post/de402867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de402853/index.html">Die dritte Welle von Blockchain-Lösungen bringt die CAT-Technologie</a></li>
<li><a href="../de402859/index.html">Laptops im Dienst der Polizei</a></li>
<li><a href="../de402861/index.html">Erstes Mal: ​​zur Premiere des Films</a></li>
<li><a href="../de402863/index.html">Ein ehrlicher Mustervertrag als Mechanismus zur Selbstregulierung der Öffentlichkeitsarbeit</a></li>
<li><a href="../de402865/index.html">Zwei Flüge einer Falcon 9-Etappe in einem Video</a></li>
<li><a href="../de402869/index.html">Unmodische trendige Tracker: Samsung, Polar, Withings, die nicht erwartet wurden</a></li>
<li><a href="../de402871/index.html">So eröffnen Sie eine Bank in Europa: Lizenzierung und Blockchain</a></li>
<li><a href="../de402873/index.html">Das Buch "Stirb nicht! Essen im Kampf ums Leben "</a></li>
<li><a href="../de402875/index.html">Matrizen für CCTV-Kameras. Worauf ist zu achten?</a></li>
<li><a href="../de402877/index.html">Schokoladendrucker Präsentation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>