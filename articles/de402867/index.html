<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æüèæ üôÖüèº üóëÔ∏è Raucher Black Box üìí üö™ üë®üèΩ‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Viele Menschen rauchen zu viel, besonders wenn sie s√ºchtig nach etwas sind und nicht bemerken, wie sie eine Zigarette nach der anderen rauchen. In der...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Raucher Black Box</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402867/">  Viele Menschen rauchen zu viel, besonders wenn sie s√ºchtig nach etwas sind und nicht bemerken, wie sie eine Zigarette nach der anderen rauchen.  In der Black Box des Rauchers (CJK) k√∂nnen Sie die n√§chste Zigarette erst nach Ablauf einer bestimmten Zeit nehmen.  In diesem Artikel werde ich auf einige Details eingehen, die f√ºr andere Entwicklungen n√ºtzlich sein k√∂nnen, insbesondere den nicht so bekannten Teensy LC-Controller (Arduino-Familie). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mRDSiEAsiAI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  <b>Die Mechanik</b> <br><br>  ChYAK-Details werden auf einem 3D-Drucker gedruckt und nach dem Zusammenbau des unteren, mittleren und oberen Teils zusammengeklebt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/353/eb5/369/353eb5369a304723be064ac6e07722e9.jpg"></div><br><br>  Der Verriegelungsmechanismus ist elektromechanisch, w√§hrend die grundlegenden Verriegelungsfunktionen rein mechanisch realisiert werden. Dies macht es schwierig, den NJC durch Manipulieren der L√ºcken und Entfernen der Batterien zu knacken. <br><br>  Das Verriegelungssystem besteht aus einem Gestell mit Z√§hnen und einer bistabilen Ratsche, die es dem Tablett erm√∂glicht, sich nur in Schlie√ürichtung zu bewegen.  Bei Erreichen einer vorbestimmten Zeitspanne macht das Servo eine einzelne Bewegung hin und her und dr√ºckt die Ratsche, die in den zweiten stabilen Zustand "offen" versetzt ist.  Der FCKW bleibt ge√∂ffnet, bis der Benutzer das Fach mechanisch herauszieht.  Im ausgefahrenen Zustand dr√ºckt das Tablett auf die Ratsche und versetzt sie wieder in den gespannten Zustand. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a0b/9a1/c0e/a0b9a1c0eaf74795b582073f40f55b93.jpg"></div><br><br>  Der Lader besteht aus einer Trommel mit 4 Aussparungen f√ºr Zigaretten.  Um zu vermeiden, dass versucht wird, eine Zigarette durch den Lader zu bekommen, erlaubt der Ratschenmechanismus keine Bewegung in die entgegengesetzte Richtung, von deren Seite die Sto√üstangen hergestellt sind. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/69b/1af/cb9/69b1afcb91214e94a40b24be99f6895e.jpg"></div><br><br>  Auf dem oberen Deckel wurden Schlitze angebracht, mit denen Sie m√∂gliche Verzerrungen von Zigaretten in der Schachtel beseitigen und Tabakchips aussch√ºtteln k√∂nnen. <br><br>  <b>Schnittstelle</b> <br><br>  Um die Zeit, die Anzahl der Zigaretten in CHYAK und die Anzahl der herausgenommenen Zigaretten zu steuern, wird das OLED-Display √ºberwacht.  Es wird fast immer ausgeschaltet, um die Batterie nicht zu entladen, und nur durch ein Signal des zentralen kapazitiven Sensors eingeschaltet, das ausgel√∂st wird, wenn eine Hand zum CHYAK gebracht wird, oder durch ein Signal vom Knopf beim Laden von Zigaretten.  Eine weitere Taste erfasst den Moment, in dem das Fach geschlossen wird, und startet den n√§chsten Verz√∂gerungszyklus.  Zwei zus√§tzliche kapazitive Sensoren befinden sich an der R√ºckwand und dienen zur Einstellung der Zigarettenz√§hler (z. B. beim Batteriewechsel erforderlich). <br><br>  <b>Elektronik</b> <br><br>  Der Mikrocontroller ist ein Teensy LC.  Dieses Arduino-√§hnliche Ger√§t, das mit den meisten Arduino-Bibliotheken kompatibel ist, wurde ausgew√§hlt, weil es kapazitive Sensoren (Touch Sense Interface (TSI)) unterst√ºtzt.  Die Sensoren sind so empfindlich, dass sie die erhobene Hand in einem Abstand von einem Zentimeter leicht f√ºhlen.  Teensy LC verf√ºgt √ºber den sogenannten LLWU-Modus. In diesem Modus befinden sich alle Module mit Ausnahme des 1-kHz-Oszillators im Ruhemodus.  Sie k√∂nnen diesen Ruhemodus auf vier Arten verlassen: a) einen Interrupt vom kapazitiven Sensor erhalten, b) einen Interrupt vom Pin erhalten, c) einen √úberlauf des 1-kHz-Z√§hlers (Low-Power-Timer, LPTMR) erhalten, d) einen Interrupt vom Alarm erhalten. <br><br>  Hier war der Autor in Schwierigkeiten: In den urspr√ºnglichen Pl√§nen war es vorgesehen, TSI zum Aufwachen zu verwenden, wenn eine Hand pr√§sentiert wurde, und LPTMR f√ºr periodische Unterbrechungen, um die TSI-Werte (abh√§ngig von den Umgebungsbedingungen) und die Zeitsteuerung anzupassen.  Es stellte sich jedoch heraus, dass LPTMR f√ºr die Funktion von TSI verwendet wird und dementsprechend nicht als Zeitz√§hler verwendet werden kann.  (Der LPTMR-√úberlauf-Interrupt l√∂st die Hardware f√ºr TSI aus und muss nat√ºrlich schnell sein, um den Sensor zu √ºberwachen. Normalerweise ist dieser Z√§hler auf minus eins voreingestellt, damit TSI mit der h√∂chstm√∂glichen Frequenz von 1 kHz abgefragt wird.) <br><br>  Eine andere M√∂glichkeit w√§re die Verwendung des RTC-Alarminterrupts. Fakt ist jedoch, dass Tenncy LC keine Echtzeituhr (RTC) hat.  Vielmehr befindet sich RTC im Prozessor selbst, aber es gibt keine Verkabelung f√ºr RTC-Quarz auf der Platine.  Der Prozessorentwickler hat jedoch eine L√ºcke f√ºr die Erkundigung von K√∂pfen hinterlassen.  Der 1-kHz-Oszillator (der im Ruhemodus arbeitet) kann als Quelle f√ºr die RTC-Register der Steuerung verwendet werden.  Dann stellt sich heraus, dass RTC nicht Sekundenintervalle z√§hlen kann (wie bei Verwendung von Quarz bei 32 kHz), sondern 32 Sekunden bei Verwendung eines 1-kHz-Oszillators.  Diese Genauigkeit reicht nat√ºrlich nicht aus.  Aber es gibt einen Ausweg. <br><br>  So funktioniert es: <br><br>  Es gibt ein RTC Time Prescaler Register (RTC_TPR).  Dieses 16-Bit-Register z√§hlt die Impulse des Oszillators.  Wenn es √ºberl√§uft, erh√∂ht sich das RTC-Zeitsekundenregister (RTC_TSR) um eins.  Im klassischen Modus sind dies die Sekunden, die mit dem RTC-Zeitalarmregister (RTC_TAR) verglichen werden. Wenn sie zusammenfallen, wird ein Alarminterrupt generiert.  Bei Verwendung von normalem 32-kHz-Quarz ist RTC_TSR nicht vorinstalliert, sondern wird jedes Mal von Null gez√§hlt (32768 bis √úberlauf (Sekunden)).  Wenn wir jedoch jedes Mal RTC_TSR voreingestellt haben und ber√ºcksichtigen, dass wir einen langsamen 1-kHz-Oszillator haben, k√∂nnen wir einen Alarminterrupt mit einer Genauigkeit von bis zu Millisekunden erhalten (ohne Ber√ºcksichtigung der Ungenauigkeit des Oszillators selbst).  Nat√ºrlich sollte auch RTC_TAR entsprechend neu berechnet werden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/719/cc7/057/719cc7057df74632be110832ac93d99b.png"></div><br><br>  Wenn wir beispielsweise den Zeitraum auf 87 Sekunden einstellen m√∂chten, m√ºssen wir 2 in RTC_TSR (2 * 32768 = 65536 ms = 65,536 s), 2 in RTC_TAR und 32768- (87 * 1000-65536) = 11304 in RTC_TSR schreiben.  Dann vergehen 32,768-11,304 = 21,464 Sekunden vor dem ersten RTC_TPR-√úberlauf, und es werden zwei vollst√§ndige Zyklen 2 * 32,768 = 65,536 hinzugef√ºgt, was nur 21,464 + 65,536 = 87 Sekunden entspricht <br>  Im Allgemeinen so: <br><br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> seconds )</span></span></span><span class="hljs-function"> </span></span>{ RTC_SR = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//disable RTC RTC_TPR=32768-(seconds*1000%32768); RTC_TSR=0; //RTC counter RTC_SR = RTC_SR_TCE; //enable RTC RTC_TAR = seconds*1000/32768; }</span></span></code> </pre> <br>  Und selbst wir k√∂nnen die Gesamtzeit (bis zu einem Fehler von 1 kHz des Oszillators) √ºberwachen, wenn beispielsweise zu Beginn des Programms alle RTC-Register Null waren: <br><br><pre> <code class="hljs lisp">timeEllapsed=(<span class="hljs-name"><span class="hljs-name">RTC_TSR*32768+RTC_TPR</span></span>)/1000</code> </pre> <br>  Die Genauigkeit des 1-kHz-Oszillators ist gering, aber f√ºr unsere Zwecke wird es ausreichen.  Es ist zu beachten, dass beim Starten eines neuen Alarms die RTC-Register ge√§ndert werden. Wenn Sie also die Zeit √ºberwachen m√ºssen, m√ºssen diese vor dem Start des Alarms gespeichert werden. Nach dem Beenden des Alarminterrupts werden sie unter Ber√ºcksichtigung der im Ruhezustand verbrachten Zeit erneut neu berechnet.  Ich habe es hier ausf√ºhrlich beschrieben: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√ºber RTC f√ºr Teency LC</a> <br><br>  Bei CJC misst und speichert ein Interrupt alle 10 Minuten den Signalpegel von kapazitiven Sensoren, wenn keine Hand vorhanden ist.  Dies geschieht, um √Ñnderungen in den Signalen bei ihrer Ann√§herung zuverl√§ssig verfolgen zu k√∂nnen.  Bei einem Hintergrund von ~ 500 Einheiten verwenden wir einen √úberschuss von ~ 20 Einheiten. Dies erm√∂glicht es, die Hand in einem Abstand von 5-10 mm zu f√ºhlen.  Der Hintergrundpegel h√§ngt von Temperatur und Luftfeuchtigkeit ab. Aus Gr√ºnden der Zuverl√§ssigkeit sollte er regelm√§√üig angepasst werden.  Ich glaube, dies ist ein Fehler bei den Prozessorentwicklern.  Warum haben sie es nicht m√∂glich gemacht, gleichzeitig von TSI und einem anderen Z√§hler mit geringem Stromverbrauch geweckt zu werden (es muss nur ein weiteres Register hinzugef√ºgt werden), da eine regelm√§√üige Anpassung der TSI-Werte fast obligatorisch ist, selbst wenn Sie keinen Timer f√ºr andere Zwecke ben√∂tigen! <br><br>  Nun zum Energieverbrauch.  Im LLWU-Schlafmodus verbraucht der Teensy LC etwa 15 uA, wenn kein Bodykit vorhanden ist.  Wir mussten ein anderes OLED-Display und ein Servo anschlie√üen.  Beide Ger√§te haben auch im passiven Zustand gro√üe Leckstr√∂me. <br><br>  Mit OLED ist alles einfach. Dies ist das Adafruit 0,96-Zoll-Monochrom-128x64-OLED-Display. Es wird mit 3,3 V betrieben, verbraucht im eingeschalteten Zustand Strom von etwa 20 mA (abh√§ngig von der Anzahl der beteiligten Pixel) und wird von SPI gesteuert.  Das hei√üt, schlie√üen Sie einfach den Stromeingang an den 20-Milliampere-Ausgang des Teensy LC an (Teency hat verschiedene Arten von Ausg√§ngen) und fertig.  Wenn alle schlafen, wird dieser Ausgang einfach in den 3. Zustand versetzt und der Strom flie√üt nicht durch die Anzeige. Beim Aufwecken wird der Ausgang in den hohen Ausgangszustand versetzt und wird f√ºr die Anzeige zu Vcc. <br><br>  Servo ist etwas komplizierter.  Servo im Standby-Modus verbraucht einen Strom von ca. 2 mA, was nat√ºrlich nicht akzeptabel ist.  Daher m√ºssen Sie es im Schlaf vollst√§ndig ausschalten.  Im Gegensatz zum klassischen Arduin verf√ºgt Teensy LC √ºber eine relativ kleine Auswahl an Netzteilen: entweder 1,7-3,3 V direkt angeschlossen oder 2,6-5,5 V (bei eingeschaltetem internen Spannungsregler).  Normalerweise arbeiten zug√§ngliche Servos mit mindestens 1S Lipo, und dies sind 3,3-4,2 V. Daher m√ºssen drei Standardbatterien in Reihe geschaltet werden, um 3,3 (Entladung) bis 4,6 V (neu) zu haben.  Bei den meisten Servos liegt 3,3 V an der Betriebsgrenze, sodass Teensy-Ausg√§nge nicht direkt verwendet werden k√∂nnen (wie bei OLED).  Ja, und der Strom w√§hrend der Drehung betr√§gt ungef√§hr 50 mA, was f√ºr den Teensy LC etwas viel ist.  Daher wird das Servo √ºber einen MOSFET eingeschaltet: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d87/121/7a3/d871217a39f04ecfb537dff032ac7fb1.png"></div><br><br>  Mit dieser Einbeziehung scheint es nicht sicher zu sein, da beim Ausschalten des MOSFET die Spannung am PWM-Strg-Eingang 3,3 V √ºberschreitet und die Tennsy LC-Eing√§nge nicht 5 V tolerant sind (im Gegensatz zum klassischen Arduin).  Sie sollten sich jedoch nicht davor f√ºrchten, sich daran zu erinnern, dass die aktuelle PWM-Steuerung sehr klein ist und Sie sich nicht vor der Begrenzungsdiode am Prozessoreingang f√ºrchten m√ºssen (der Grund f√ºr die Unzul√§ssigkeit, Vcc + 0,5 zu √ºberschreiten, liegt in Str√∂men, die mit den Str√∂men der geschlossenen Diode vergleichbar sind) Er wird nicht einmal im offenen Zustand sein. <br><br>  In CHYAK verwende ich HK282 mit einem Schwellenwert von 3,3 V (nur weil ich es hatte).  Eine Art Servo mit niedrigerer Spannung und geringer Leistung kann gem√§√ü dem f√ºr OLED verwendeten Schema direkt von den Teensy-Ausg√§ngen gespeist werden. <br><br>  Infolgedessen stellte sich heraus, dass der Strom im Schlafmodus etwa 50 uA betrug, wahrscheinlich war es m√∂glich, ihn noch weiter zu reduzieren, aber ich entschied, dass dies ausreichte (wenn die Batterien nur schlafen, sollten sie l√§nger als 4 Jahre halten: 2000 mAh / 0,05 mA). <br><br>  <b>Technisch</b> <br><br>  Gedruckt auf einem Monoprice Ultimate 3D-Drucker, PLA-Kunststoff, 0,4 mm D√ºse, 0,2 mm Schicht.  F√ºr Details des Verriegelungsmechanismus eine 0,1 mm Schicht f√ºr Genauigkeit.  Die Federn werden auch auf einem 3D-Drucker gedruckt.  Lange tippen.  Zum Beispiel wurde der mittlere Teil (er hat viele Innenteile und Doppelw√§nde f√ºr Elektronik und Dr√§hte) 20 Stunden lang gedruckt.  Es wurde mit Cyan-Acrylat-Kleber zusammengeklebt.  Wenn etwas im Inneren kaputt geht, ist es unm√∂glich zu erkennen (Schutz vor Maniacs-Rauchern), m√ºssen Sie es wie ein Sparschwein zerbrechen und erneut drucken (ein Argument f√ºr 3D-Drucker).  Zeichnungen und Animationen werden in SolidWorks, der AtmelStudio-Entwicklungsumgebung, erstellt (ja, AVR (teency) wird wie Arduino sofort √ºber VisualMicro unterst√ºtzt). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de402867/">https://habr.com/ru/post/de402867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de402853/index.html">Die dritte Welle von Blockchain-L√∂sungen bringt die CAT-Technologie</a></li>
<li><a href="../de402859/index.html">Laptops im Dienst der Polizei</a></li>
<li><a href="../de402861/index.html">Erstes Mal: ‚Äã‚Äãzur Premiere des Films</a></li>
<li><a href="../de402863/index.html">Ein ehrlicher Mustervertrag als Mechanismus zur Selbstregulierung der √ñffentlichkeitsarbeit</a></li>
<li><a href="../de402865/index.html">Zwei Fl√ºge einer Falcon 9-Etappe in einem Video</a></li>
<li><a href="../de402869/index.html">Unmodische trendige Tracker: Samsung, Polar, Withings, die nicht erwartet wurden</a></li>
<li><a href="../de402871/index.html">So er√∂ffnen Sie eine Bank in Europa: Lizenzierung und Blockchain</a></li>
<li><a href="../de402873/index.html">Das Buch "Stirb nicht! Essen im Kampf ums Leben "</a></li>
<li><a href="../de402875/index.html">Matrizen f√ºr CCTV-Kameras. Worauf ist zu achten?</a></li>
<li><a href="../de402877/index.html">Schokoladendrucker Pr√§sentation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>