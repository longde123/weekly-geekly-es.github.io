<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóûÔ∏è üë®üèø‚Äçü§ù‚Äçüë®üèª üôáüèº Pas un seul ORM üçæ üàÅ üî°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pas un seul ORM 


 Bonjour √† tous! Je suis en charge du d√©partement D√©veloppement Partenaires du service de r√©servation d'h√¥tel Ostrovok.ru . Dans ce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pas un seul ORM</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/447706/"><h1 id="ne-ormom-edinym">  Pas un seul ORM </h1><br><p>  Bonjour √† tous!  Je suis en charge du d√©partement D√©veloppement Partenaires du service de r√©servation d'h√¥tel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ostrovok.ru</a> .  Dans cet article, je voudrais parler de la fa√ßon dont nous avons utilis√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Django ORM</a> sur un projet. </p><br><p>  En fait, je trompais, le nom aurait d√ª √™tre " <del>  Pas </del>  ORM single ". Si vous vous demandez pourquoi j'ai √©crit ceci, ainsi que si: </p><br><ul><li> Vous avez Django sur la pile, et vous voulez extraire le maximum d'ORM, pas seulement <code>Model.objects.all()</code> , </li><li>  Vous souhaitez transf√©rer une partie de la logique m√©tier au niveau de la base de donn√©es, </li><li>  Ou voulez-vous savoir pourquoi l'excuse la plus fr√©quente pour les d√©veloppeurs de B2B.Ostrovok.ru est <em>"si historiquement"</em> , </li></ul><br><p>  ... bienvenue au chat. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/66b/308/b1c/66b308b1cd5afefead46ef7bffdbbddf.jpg" alt="cdpv"></p><a name="habracut"></a><br><p>  En 2014, nous avons lanc√© B2B.Ostrovok.ru - un service de r√©servation en ligne d'h√¥tels, de transferts, de voitures et d'autres services de voyage pour les professionnels du march√© du tourisme (agents de voyages, op√©rateurs et entreprises). </p><br><p>  En B2B, nous avons con√ßu et utilis√© avec succ√®s un mod√®le d'ordre abstrait bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>GenericForeignKey</code></a> - meta order - <code>MetaOrder</code> . </p><br><p>  Une m√©ta-commande est une entit√© abstraite qui peut √™tre utilis√©e quel que soit le type de commande auquel elle appartient: un h√¥tel ( <code>Hotel</code> ), un service suppl√©mentaire ( <code>Upsell</code> ) ou une voiture ( <code>Car</code> ).  √Ä l'avenir, d'autres types peuvent appara√Ætre. </p><br><p>  Cela n'a pas toujours √©t√© le cas.  Lorsque le service B2B a √©t√© lanc√©, seuls les h√¥tels pouvaient √™tre r√©serv√©s via celui-ci et toute la logique commerciale √©tait concentr√©e sur eux.  De nombreux champs ont √©t√© cr√©√©s, par exemple, pour afficher les taux de change du montant des ventes et du montant du remboursement de la r√©servation.  Au fil du temps, nous avons r√©alis√© la meilleure fa√ßon de stocker et de r√©utiliser ces donn√©es, compte tenu des m√©ta-commandes.  Mais le code entier n'a pas pu √™tre r√©√©crit, et une partie de cet h√©ritage est entr√©e dans la nouvelle architecture.  En fait, cela a conduit √† des difficult√©s dans les calculs, qui utilisent plusieurs types de commandes.  Que faire - donc <em>historiquement</em> ... </p><br><p>  Mon objectif est de montrer la puissance de Django ORM dans notre exemple. </p><br><h2 id="predystoriya">  Contexte </h2><br><p>  Pour planifier leurs d√©penses, nos clients B2B manquaient vraiment d'informations sur le montant qu'ils doivent payer maintenant / demain / plus tard, s'ils ont des dettes sur les commandes et quelle est sa taille, ainsi que combien ils peuvent d√©penser davantage dans leurs limites.  Nous avons d√©cid√© d'afficher ces informations sous la forme d'un tableau de bord - une telle prise simple avec un diagramme clair. </p><br><p><img src="https://habrastorage.org/webt/2a/rj/yo/2arjyoaa9_xfe8ddcaz5qn4w5mu.gif" alt="dash1"><br>  <em>(toutes les valeurs sont test√©es et ne s'appliquent pas √† un partenaire sp√©cifique)</em> </p><br><p>  √Ä premi√®re vue, tout est assez simple - nous filtrons toutes les commandes du partenaire, les r√©sumons et les affichons. </p><br><h2 id="varianty-resheniya">  Options de solution </h2><br><p>  Une petite explication sur la fa√ßon dont nous faisons les calculs.  Nous sommes une entreprise internationale, nos partenaires de diff√©rents pays effectuent des op√©rations - achat et revente de r√©servations - dans diff√©rentes devises.  De plus, ils doivent recevoir les √©tats financiers dans la devise choisie (g√©n√©ralement locale).  Il serait stupide et peu pratique de stocker toutes les donn√©es possibles sur les taux de toutes les devises, vous devez donc choisir une devise de r√©f√©rence, par exemple le rouble.  Ainsi, vous pouvez enregistrer les taux de toutes les devises uniquement sur le rouble.  Ainsi, lorsqu'un partenaire souhaite recevoir un r√©capitulatif, nous convertissons les montants au taux fix√© au moment de la vente. </p><br><h3 id="v-lob">  "Dans le front" </h3><br><p>  En fait, c'est <code>Model.objects.all()</code> et la boucle de conditions: </p><br><div class="spoiler">  <b class="spoiler_title">Model.objects.all () avec conditions</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partner_id)</span></span></span><span class="hljs-function">:</span></span> today = dt.date.today() <span class="hljs-comment"><span class="hljs-comment"># query_get_one -    partner = query_get_one(Partner.objects.filter(id=partner_id)) #    -  query = MetaOrder.objects.filter(partner=partner) result = defaultdict(Decimal) for morder in query: #  ,     #     payment_pending = morder.get_payment_pending() payment_due = morder.get_payment_due() #        # (     ) payable = morder.get_payable_in_cur() #       if payment_pending &gt; today: result['payment_pending'] += payable # ,     if payment_pending &lt; today and payment_due &gt; today: result['payment_due'] += payable return result</span></span></code> </pre> </div></div><br><p>  Cette requ√™te renvoie un g√©n√©rateur qui contient potentiellement plusieurs centaines de r√©servations.  Une demande √† la base de donn√©es sera faite pour chacune de ces r√©servations, et donc le cycle se d√©roulera tr√®s longtemps. </p><br><p>  Vous pouvez acc√©l√©rer un peu les choses en ajoutant la m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>prefetch_related</code></a> : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># object -      GenericForeignKey. query = query.prefetch_related('object')</span></span></code> </pre> <br><p>  Ensuite, il y aura un peu moins de requ√™tes vers la base de donn√©es ( <code>GenericForeignKey</code> sur <code>GenericForeignKey</code> ), mais √† la fin nous nous arr√™terons √† leur nombre, car la requ√™te vers la base de donn√©es sera toujours effectu√©e √† chaque it√©ration de la boucle. </p><br><p>  La m√©thode de <code>output</code> peut (et devrait) √™tre mise en cache, mais le premier appel remplit toujours l'ordre d'une minute, ce qui est totalement inacceptable. </p><br><p>  Voici les r√©sultats de cette approche: </p><br><p><img src="https://habrastorage.org/webt/yz/ur/wq/yzurwquhxoeqczgncqi66je8570.png" alt="timing_before"></p><br><p>  Le temps de r√©ponse moyen est de 4 secondes et les pics atteignent 21 secondes.  Assez longtemps. </p><br><p>  Nous n'avons pas d√©ploy√© le tableau de bord pour tous les partenaires, et donc nous n'avons pas eu beaucoup de demandes pour cela, mais il suffit quand m√™me de comprendre que cette approche n'est pas efficace. </p><br><p><img src="https://habrastorage.org/webt/f0/rz/yn/f0rzynfsqypr3z0mh1cnwoi6ee0.png" alt="count_before"><br>  <em>Les nombres en bas √† droite sont le nombre de requ√™tes: minimum, maximum, moyenne, total.</em> </p><br><h3 id="s-umom">  Sagement </h3><br><p>  Le prototype du front √©tait bon pour comprendre la complexit√© de la t√¢che, mais pas optimal pour une utilisation.  Nous avons d√©cid√© qu'il serait beaucoup plus rapide et moins gourmand en ressources de faire plusieurs requ√™tes complexes dans la base de donn√©es que de nombreuses requ√™tes simples. </p><br><h4 id="plan-zaprosa">  Plan de demande </h4><br><p>  Les traits larges du plan de requ√™te peuvent √™tre d√©crits comme suit: </p><br><ul><li>  collecter les commandes selon les conditions initiales, </li><li>  pr√©parer les champs pour le calcul par <code>annotate</code> , </li><li>  calculer les valeurs des champs </li><li>  faire des <code>aggregate</code> par le montant et la quantit√© </li></ul><br><h4 id="nachalnye-usloviya">  Conditions initiales </h4><br><p>  Les partenaires qui visitent le site ne peuvent voir des informations que sur leur contrat. </p><br><pre> <code class="python hljs">partner = query_get_one(Partner.objects.filter(id=partner_id))</code> </pre> <br><p>  Dans le cas o√π nous ne voulons pas afficher de nouveaux types de commandes / r√©servations, nous avons seulement besoin de filtrer celles prises en charge: </p><br><pre> <code class="python hljs">query = MetaOrder.objects.filter( partner=partner, content_type__in=[ Hotel.get_content_type(), Car.get_content_type(), Upsell.get_content_type(), ] )</code> </pre> <br><p>  Le statut de la commande est important (en savoir plus sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Q</code></a> ): </p><br><pre> <code class="python hljs">query = query.filter( Q(hotel__status__in=[<span class="hljs-string"><span class="hljs-string">'completed'</span></span>, <span class="hljs-string"><span class="hljs-string">'cancelled'</span></span>]) <span class="hljs-comment"><span class="hljs-comment">#     ,    # | Q(car__status__in=[...]) )</span></span></code> </pre> <br><p>  Nous utilisons √©galement souvent des demandes pr√©d√©finies, par exemple, pour exclure toutes les commandes qui ne peuvent pas √™tre pay√©es.  Il y a beaucoup de logique m√©tier, ce qui n'est pas tr√®s int√©ressant pour nous dans le cadre de cet article, mais en substance ce ne sont que des filtres suppl√©mentaires.  Une m√©thode qui renvoie une requ√™te pr√©par√©e pourrait ressembler √† ceci: </p><br><pre> <code class="python hljs">query = MetaOrder.exclude_non_payable_metaorders(query)</code> </pre> <br><p>  Comme vous pouvez le voir, il s'agit d'une m√©thode de classe qui retournera √©galement un <code>QuerySet</code> . </p><br><p>  Nous pr√©parerons √©galement quelques variables pour les constructions conditionnelles et pour stocker les r√©sultats des calculs: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing.decimal <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Decimal today = dt.date.today() result = defaultdict(Decimal)</code> </pre> <br><h4 id="podgotovka-poley-annotatehttpsdocsdjangoprojectcomen21refmodelsquerysetsannotate">  Pr√©paration du terrain ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>annotate</code></a> ) </h4><br><p>  √âtant donn√© que nous devons nous r√©f√©rer aux champs en fonction du type de commande, nous utiliserons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Coalesce</code></a> .  Ainsi, nous pouvons r√©sumer n'importe quel nombre de nouveaux types de commandes dans un seul champ. </p><br><p>  Voici la premi√®re partie du bloc d' <code>annotate</code> : </p><br><div class="spoiler">  <b class="spoiler_title">Annoter d'abord</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     , #      from app.helpers.numbers import ZERO, ONE query_annoted = query.annotate( _payment_pending=Coalesce( 'hotel__payment_pending', 'car__payment_pending', 'upsell__payment_pending', ), _payment_due=Coalesce( 'hotel__payment_due', 'car__payment_due', 'upsell__payment_due', ), _refund=Coalesce( 'hotel__refund', Value(ZERO) ), _refund_currency_rate=Coalesce( 'hotel__refund_currency_rate', Value(ONE) ), _sell=Coalesce( 'hotel__sell', Value(ZERO) ), _sell_currency_rate=Coalesce( 'hotel__sell_currency_rate', Value(ONE) ), )</span></span></code> </pre> </div></div><br><p>  <code>Coalesce</code> travaille ici avec fracas, car les commandes d'h√¥tel ont plusieurs propri√©t√©s sp√©ciales, et dans tous les autres cas (services suppl√©mentaires et voitures), ces propri√©t√©s ne sont pas importantes pour nous.  C'est ainsi que la <code>Value(ZERO)</code> pour les montants et la <code>Value(ONE)</code> pour les taux de change apparaissent.  <code>ZERO</code> et <code>ONE</code> sont <code>Decimal('0')</code> et <code>Decimal(1)</code> , uniquement sous forme de constantes.  Une approche amateur, mais dans notre projet c'est accept√© comme √ßa. </p><br><p>  Vous pourriez avoir une question, pourquoi ne pas mettre certains champs d'un niveau dans une m√©ta-commande?  Par exemple, <code>payment_pending</code> , qui est partout.  En effet, au fil du temps, nous transf√©rons ces champs dans une m√©ta-commande, mais maintenant le code fonctionne bien, de telles t√¢ches ne sont pas notre priorit√©. </p><br><h4 id="esche-odna-podgotovka-i-raschety">  Une autre pr√©paration et calculs </h4><br><p>  Maintenant, nous devons faire quelques calculs avec les montants que nous avons re√ßus dans le dernier bloc d' <code>annotate</code> .  Notez qu'ici, vous n'avez plus besoin d'√™tre li√© au type de commande (sauf une exception). </p><br><div class="spoiler">  <b class="spoiler_title">Deuxi√®me annoter</b> <div class="spoiler_text"><pre> <code class="python hljs">.annotate( <span class="hljs-comment"><span class="hljs-comment">#  _base     _sell_base=( F('_sell') * F('_sell_currency_rate') ), _refund_base=( F('_refund') * F('_refund_currency_rate') ), _payable_base=( F('_sell_base') - F('_refund_base') ), _reporting_currency_rate=Case( When( content_type=Hotel.get_content_type(), then=RawSQL( '(hotel.currency_data-&gt;&gt;%s)::numeric', (partner.reporting_currency,), ), ), output_field=DecimalField(), default=Decimal('1'), ), )</span></span></code> </pre> </div></div><br><p>  La partie la plus int√©ressante de ce bloc est le champ <code>_reporting_currency_rate</code> , ou le taux de change vers la devise de r√©f√©rence au moment de la vente.  Les donn√©es sur les taux de change de toutes les devises vers la devise de r√©f√©rence pour une commande d'h√¥tel sont stock√©es dans <code>currency_data</code> .  C'est juste JSON.  Pourquoi gardons-nous cela?  <em>C'est historiquement le cas</em> . </p><br><p>  Et ici, il semblerait, pourquoi ne pas utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>F</code></a> et remplacer la valeur de la devise du contrat?  Autrement dit, ce serait cool si vous pouviez faire ceci: </p><br><pre> <code class="python hljs">F(<span class="hljs-string"><span class="hljs-string">f'currency_data__</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{partner.reporting_currency}</span></span></span><span class="hljs-string">'</span></span>)</code> </pre> <br><p>  Mais les <code>f-strings</code> ne <code>f-strings</code> pas prises en charge en <code>F</code>  Bien que le fait que Django ORM ait d√©j√† la capacit√© d'acc√©der aux champs json imbriqu√©s est tr√®s agr√©able - <code>F('currency_data__USD')</code> . </p><br><p>  Et le dernier bloc <code>annotate</code> est le calcul <code>_payable_in_cur</code> , qui sera r√©sum√© pour toutes les commandes.  Cette valeur doit √™tre dans la devise du contrat. </p><br><p><img src="https://habrastorage.org/webt/3g/hi/rd/3ghirdq4rnexrp2vnhwucju7rkw.png" alt="dash2"></p><br><pre> <code class="python hljs">.annotate( _payable_in_cur=( F(<span class="hljs-string"><span class="hljs-string">'_payable_base'</span></span>) / F(<span class="hljs-string"><span class="hljs-string">'_reporting_currency_rate'</span></span>) ) )</code> </pre> <br><p>  La particularit√© de la m√©thode <code>annotate</code> est qu'elle g√©n√®re beaucoup de constructions <code>SELECT something AS something_else</code> qui ne sont pas directement impliqu√©es dans la requ√™te.  Cela peut √™tre vu en d√©chargeant la requ√™te SQL - <code>query.__str__()</code> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Voici √† quoi ressemble le</a> code SQL g√©n√©r√© par Django ORM pour <code>base_query_annotated</code> .  Vous devez le lire assez souvent pour comprendre o√π vous pouvez optimiser votre requ√™te. </p><br><h4 id="zaklyuchitelnye-podschety">  Calculs finaux </h4><br><p>  Il y aura un petit wrapper pour l' <code>aggregate</code> , de sorte qu'√† l'avenir, si le partenaire a besoin d'une autre m√©trique, il puisse √™tre facilement ajout√©. </p><br><p><img src="https://habrastorage.org/webt/ky/qm/pi/kyqmpiht-jwpwuripuf6wlfiqv0.png" alt="dash3"></p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_data_from_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query: QuerySet)</span></span></span><span class="hljs-function"> -&gt; Decimal:</span></span> result = query.aggregate( _sum_payable=Sum(F(<span class="hljs-string"><span class="hljs-string">'_payable_in_cur'</span></span>)), ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result[<span class="hljs-string"><span class="hljs-string">'_sum_payable'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ZERO</code> </pre> <br><p>  Et encore une chose - c'est le dernier filtrage par condition commerciale, par exemple, nous avons besoin de toutes les commandes qui devront √™tre pay√©es bient√¥t. </p><br><p><img src="https://habrastorage.org/webt/xz/rj/ss/xzrjssl1barwnpvtegjkg1tkvs0.png" alt="dash4"></p><br><pre> <code class="python hljs">before_payment_pending_query = _get_data_from_query( base_query_annotated.filter(_payment_pending__gt=today) )</code> </pre> <br><h4 id="otladka-i-proverka">  D√©bogage et v√©rification </h4><br><p>  Un moyen tr√®s pratique de v√©rifier l'exactitude de la demande cr√©√©e est de la comparer avec une version plus lisible des calculs. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> morder <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> query: payable = morder.get_payable_in_cur() payment_pending = morder.get_payment_pending() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> payment_pending &gt; today: result[<span class="hljs-string"><span class="hljs-string">'payment_pending'</span></span>] += payable</code> </pre> <br><p>  Connaissez-vous la m√©thode du "front"? </p><br><h3 id="finalnyy-kod">  Code final </h3><br><p>  En cons√©quence, nous avons obtenu quelque chose comme ceci: </p><br><div class="spoiler">  <b class="spoiler_title">Code final</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_data_from_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query: QuerySet)</span></span></span><span class="hljs-function"> -&gt; tuple:</span></span> result = query.aggregate( _sum_payable=Sum(F(<span class="hljs-string"><span class="hljs-string">'_payable_in_cur'</span></span>)), ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result[<span class="hljs-string"><span class="hljs-string">'_sum_payable'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ZERO <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partner_id: int)</span></span></span><span class="hljs-function">:</span></span> today = dt.date.today() partner = query_get_one(Partner.objects.filter(id=partner_id)) query = MetaOrder.objects.filter(partner=partner, content_type__in=[ Hotel.get_content_type(), Car.get_content_type(), Upsell.get_content_type(), ]) result = defaultdict(Decimal) query_annoted = query.annotate( _payment_pending=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__payment_pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'car__payment_pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'upsell__payment_pending'</span></span>, ), _payment_due=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__payment_due'</span></span>, <span class="hljs-string"><span class="hljs-string">'car__payment_due'</span></span>, <span class="hljs-string"><span class="hljs-string">'upsell__payment_due'</span></span>, ), _refund=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__refund'</span></span>, Value(ZERO) ), _refund_currency_rate=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__refund_currency_rate'</span></span>, Value(Decimal(<span class="hljs-string"><span class="hljs-string">'1'</span></span>)) ), _sell=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__sell'</span></span>, Value(ZERO) ), _sell_currency_rate=Coalesce( <span class="hljs-string"><span class="hljs-string">'hotel__sell_currency_rate'</span></span>, Value(Decimal(<span class="hljs-string"><span class="hljs-string">'1'</span></span>)) ), ).annotate( <span class="hljs-comment"><span class="hljs-comment"># Calculated fields _sell_base=( F('_sell') * F('_sell_currency_rate') ), _refund_base=( F('_refund') * F('_refund_currency_rate') ), _payable_base=( F('_sell_base') - F('_refund_base') ), _reporting_currency_rate=Case( # Only hotels have currency_data, therefore we need a # check and default value When( content_type=Hotel.get_content_type(), then=RawSQL( '(hotel.currency_data-&gt;&gt;%s)::numeric', (partner.reporting_currency,), ), ), output_field=DecimalField(), default=Decimal('1'), ), ) .annotate( _payable_in_cur=( F('_payable_base') / F('_reporting_currency_rate') ) ) before_payment_pending_query = _get_data_from_query( base_query_annotated.filter(_payment_pending__gt=today) ) after_payment_pending_before_payment_due_query = _get_data_from_query( base_query_annotated.filter( Q(_payment_pending__lte=today) &amp; Q(_payment_due__gt=today) ) )</span></span></code> </pre></div></div><br><p>  Voici comment cela fonctionne maintenant: </p><br><p><img src="https://habrastorage.org/webt/xg/1i/rf/xg1irfnazuk-rqk14wdlxn32nhi.png" alt="timing_after"></p><br><p><img src="https://habrastorage.org/webt/mt/k7/cq/mtk7cqefuzlx96roihjpgvpeaz8.png" alt="count_after"></p><br><h2 id="vyvody">  Conclusions </h2><br><p>  Apr√®s avoir r√©√©crit et optimis√© la logique, nous avons r√©ussi √† g√©rer assez rapidement les mesures d'affiliation et √† r√©duire consid√©rablement le nombre de requ√™tes dans la base de donn√©es.  La solution s'est av√©r√©e bonne et nous r√©utiliserons cette logique dans d'autres parties du projet.  ORM est notre tout. </p><br><p>  √âcrivez des commentaires, posez des questions - nous essaierons de r√©pondre!  Je vous remercie! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447706/">https://habr.com/ru/post/fr447706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447696/index.html">Pourquoi les villes s'opposent √† Amazon Go, les premiers magasins non cash</a></li>
<li><a href="../fr447698/index.html">Poudlard rouge: acad√©micien sans dipl√¥me</a></li>
<li><a href="../fr447700/index.html">La flexibilit√© √©motionnelle est la cl√© de la croissance personnelle.</a></li>
<li><a href="../fr447702/index.html">Le cercle math√©matique id√©al n'existe pas</a></li>
<li><a href="../fr447704/index.html">Escalade d'Elbrus - Reconnaissance au combat. Partie technique 1. Registres, piles et autres d√©tails techniques</a></li>
<li><a href="../fr447708/index.html">Yandex a remis aux jeunes scientifiques et leaders scientifiques les premiers prix Ilya Segalovich</a></li>
<li><a href="../fr447712/index.html">Salut, SaaS | Russian SaaS 2018 - r√©sultats</a></li>
<li><a href="../fr447714/index.html">Sur l'application de la th√©orie des processus ARMA dans la pratique de l'ing√©nierie</a></li>
<li><a href="../fr447716/index.html">Unit√©: dessinez plusieurs barres de vie en un seul appel</a></li>
<li><a href="../fr447718/index.html">Tout se passera comme pr√©vu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>