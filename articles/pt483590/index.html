<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüç≥ ‚úíÔ∏è ‚úãüèø Procure pelo erro FDCAN que n√£o √© üë† üëÜüèø üëé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sempre trabalhando com o CAN era simples, mas algo deu errado (no dispositivo no KDPV) ... 



 Recentemente, muitas vezes eu consigo usar o microcont...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Procure pelo erro FDCAN que n√£o √©</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483590/">  Sempre trabalhando com o CAN era simples, mas algo deu errado (no dispositivo no KDPV) ... <br><br><img src="https://habrastorage.org/webt/ky/xj/cf/kyxjcfi0o7ycyw6h-9n4_iucezk.png" alt="imagem"><br><br>  Recentemente, muitas vezes eu consigo usar o microcontrolador STM32H750VB e em um dispositivo eu precisava usar o barramento CAN, mas a primeira tentativa que fiz <s>mostrou toda a minha autoconfian√ßa</s> deu um resultado estranho.  A hist√≥ria √© descrita abaixo. <br><a name="habracut"></a><br>  Ent√£o, primeiro sobre circuitos.  No KDPV, ele √© circulado em verde, √© claro, o culpado √© o microcontrolador, n√£o h√° nada complicado com o CAN - ele √© conectado de acordo com <br><br><img src="https://habrastorage.org/webt/wa/fu/-v/wafu-vni4ogihvcyx6yljc3w18m.png" alt="imagem"><br><br>  O MAX3051 √© usado como camada f√≠sica (bem, eu gosto ..), assim: <br><br><img src="https://habrastorage.org/webt/h-/tr/q3/h-trq3qw6uj20y0wsvcbe24vxhi.png" alt="imagem"><br><br>  Anteriormente, em vez do STM32H750VB, o STM32F107 estava no mesmo sistema, mas o velho n√£o conseguia lidar com as tarefas e foi decidido substitu√≠-lo por um mais moderno <s>e jovem</s> . <br><br>  Mas aqui est√° a m√° sorte - o microcontrolador antigo possu√≠a o bxCAN e o novo j√° possu√≠a o FDCAN.  Embora existam diferen√ßas, mas do ponto de vista do c√≥digo (e trabalho - os dispositivos no barramento s√£o antigos): a substitui√ß√£o √© muito simples.  Para quem desejar, voc√™ pode comparar: <br><div class="scrollable-table"><table><tbody><tr><th>  Was </th><th>  Tornou-se </th></tr><tr><td><pre>  MX_CAN1_Init (); </pre></td><td><pre>  MX_FDCAN1_Init (); </pre></td></tr><tr><td><pre>     hcan1.Instance = CAN1;
     hcan1.Init.Prescaler = 4;
     hcan1.Init.Mode = CAN_MODE_NORMAL;
     hcan1.Init.SyncJumpWidth = CAN_SJW_4TQ;
     hcan1.Init.TimeSeg1 = CAN_BS1_15TQ;
     hcan1.Init.TimeSeg2 = CAN_BS2_2TQ;
     hcan1.Init.TimeTriggeredMode = DISABLE;
     hcan1.Init.AutoBusOff = ENABLE;
     hcan1.Init.AutoWakeUp = DISABLE;
     hcan1.Init.AutoRetransmission = DISABLE;
     hcan1.Init.ReceiveFifoLocked = DISABLE;
     hcan1.Init.TransmitFifoPriority = DISABLE; </pre></td><td><pre>   hfdcan1.Instance = FDCAN1;
   hfdcan1.Init.FrameFormat = FDCAN_FRAME_FD_NO_BRS;
   hfdcan1.Init.Mode = FDCAN_MODE_NORMAL;
   hfdcan1.Init.AutoRetransmission = ENABLE;
   hfdcan1.Init.TransmitPause = DISABLE;
   hfdcan1.Init.ProtocolException = ENABLE;
   hfdcan1.Init.NominalPrescaler = 1;
   hfdcan1.Init.NominalSyncJumpWidth = 3;
   hfdcan1.Init.NominalTimeSeg1 = 11;
   hfdcan1.Init.NominalTimeSeg2 = 4;
   hfdcan1.Init.DataPrescaler = 1;
   hfdcan1.Init.DataSyncJumpWidth = 3;
   hfdcan1.Init.DataTimeSeg1 = 11;
   hfdcan1.Init.DataTimeSeg2 = 4;
   hfdcan1.Init.MessageRAMOffset = 64;
   hfdcan1.Init.StdFiltersNbr = 0;
   hfdcan1.Init.ExtFiltersNbr = 0;
   hfdcan1.Init.RxFifo0ElmtsNbr = 4;
   hfdcan1.Init.RxFifo0ElmtSize = FDCAN_DATA_BYTES_8;
   hfdcan1.Init.RxFifo1ElmtsNbr = 4;
   hfdcan1.Init.RxFifo1ElmtSize = FDCAN_DATA_BYTES_8;
   hfdcan1.Init.RxBuffersNbr = 4;
   hfdcan1.Init.RxBufferSize = FDCAN_DATA_BYTES_8;
   hfdcan1.Init.TxEventsNbr = 4;
</pre></td></tr><tr><td><pre>  if (HAL_CAN_Init (&amp; hcan1)! = HAL_OK) { </pre></td><td><pre>  if (HAL_FDCAN_Start (&amp; hfdcan1)! = HAL_OK) { </pre></td></tr></tbody></table></div><br>  Em geral, diferen√ßas cosm√©ticas.  E me pareceu que funcionaria de uma s√≥ vez e corretamente. <br><br>  No entanto, n√£o funcionou imediatamente ... <br><br>  O controlador CAN n√£o p√¥de definir um n√≠vel dominante e entrou no estado Bus-Off, e nenhum dado foi recebido do barramento (apesar do fato de outro dispositivo no barramento enviar pacotes de forma est√°vel duas vezes por segundo). <br><br>  Bem, pensei, a linha de depura√ß√£o chegou e soldou a fia√ß√£o nas linhas CAN-RX e CAN-TX (na verdade, visualizar o pr√≥prio barramento parecia l√≥gico - o dispositivo estava silencioso e o outro dispositivo conectado enviou pacotes <s>, conforme acordado</s> ). <br><br>  Depois disso, o modo FDCAN_MODE_BUS_MONITORING foi ativado pela primeira vez.  E eis que vi imediatamente pacotes do √¥nibus!  (Nesse modo, o controlador CAN apenas escuta dados, mas n√£o transmite nada).  T√£o bom ... <br><br>  Em seguida, o modo FDCAN_MODE_EXTERNAL_LOOPBACK foi ativado (nesse modo, pelo contr√°rio, apenas ouvimos a n√≥s mesmos, mas depois transferimos tudo para o barramento).  E nas linhas CAN_RX e CAN_TX todos os pacotes de dados apareceram - ambos enviados pelo pr√≥prio dispositivo e recebidos do barramento, aqui em <br>  Na figura abaixo (dados em cinza TX do microcontrolador, linha de dados laranja RX), eles s√£o vis√≠veis como picos: <br><br><img src="https://habrastorage.org/webt/qb/m3/f_/qbm3f_fo_u8j8aan5_aduaido4a.png" alt="imagem"><br><br>  Assim, ap√≥s esse experimento, ficou claro que o circuito est√° funcionando corretamente, o controlador CAN no microprocessador pode receber e transmitir dados. <br><br>  No entanto, ao tentar receber e transmitir dados simultaneamente, o sistema ainda se tornou Bus-Off com um erro no registro de controle de erros (registro de status do protocolo FDCAN (FDCAN_PSR)) LEC [2: 0] = 5 - o que significa da folha de dados Bit0Error: a transmiss√£o de uma mensagem (ou bit de reconhecimento ou erro ativo <br>  flag ou overload flag), o dispositivo queria enviar um n√≠vel dominante (bit de dados ou identificador) <br>  valor l√≥gico 0), mas o valor do barramento monitorado era recessivo ... <br><br>  Ap√≥s dois dias de tormento (est√° claro qual √© o erro, mas n√£o est√° claro como corrigi-lo) e um estudo cuidadoso da folha de dados, erratas e um monte de c√≥digos e manuais de terceiros, a <s>ilumina√ß√£o</s> chegou ao meu entendimento - estou fazendo tudo certo, mas n√£o est√° funcionando! <br><br>  Bem, pensei, talvez o problema esteja na tecnologia e ... substituiu o pr√≥prio microcontrolador (por outro do mesmo lote).  E ... funcionou!  Bem, isto √©, aqui sem <s>dan√ßar com um pandeiro de</s> problemas, com o c√≥digo fonte e como deve ser a primeira vez. <br><br><h4>  Breve resumo </h4><br>  Aparentemente, um esp√©cime t√£o astuto apareceu.  Mas, por outro lado, consegui me aprofundar no trabalho da FDCAN em geral, que pode ser atribu√≠do √†s vantagens.  E aos pontos negativos ... E a eles pode ser atribu√≠do o tempo perdido (o controlador p√¥de ser anexado a outro projeto) e o entendimento de que os controladores modernos s√£o buggy <s>com for√ßa terr√≠vel</s> tamb√©m <s>√©</s> moderno (ou √© tamb√©m uma vantagem?). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt483590/">https://habr.com/ru/post/pt483590/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt483578/index.html">Not√≠cias do mundo do OpenStreetMap n¬∫ 493 (24.12.2019 - 12.30.2019)</a></li>
<li><a href="../pt483580/index.html">VIM - Este n√£o √© apenas um editor, √© uma integra√ß√£o com todo o seu ambiente de trabalho</a></li>
<li><a href="../pt483584/index.html">Transferindo um back-end PHP para o barramento de fluxos Redis e escolhendo uma biblioteca independente das estruturas</a></li>
<li><a href="../pt483586/index.html">No√ß√µes b√°sicas de trabalho com o zmq em python, criando um armazenamento simples de chave / valor</a></li>
<li><a href="../pt483588/index.html">Como tentar bloquear qualquer site usando ILV</a></li>
<li><a href="../pt483594/index.html">Economia futura para f√≠sicos</a></li>
<li><a href="../pt483598/index.html">Ovos de P√°scoa ainda mais musicais: continuamos a falar de presentes para ouvintes atentos</a></li>
<li><a href="../pt483600/index.html">Liberte seu Android</a></li>
<li><a href="../pt483602/index.html">Confer√™ncia DefCon 27: Nos bastidores da cria√ß√£o de crach√°s eletr√¥nicos Parte 2</a></li>
<li><a href="../pt483604/index.html">Ir√≠dio: recebe e decodifica sinais de constela√ß√£o de sat√©lites em casa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>