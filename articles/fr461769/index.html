<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛔️ 😐 ☝🏾 Comment j'ai rendu la webcam Javascript (presque) inutile 🤚🏻 👨🏾‍🚀 🙎🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je souhaite partager mes tentatives de streaming vidéo via des sockets Web sans utiliser de plug-ins de navigateur tiers tels que Ad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai rendu la webcam Javascript (presque) inutile</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461769/"> Dans cet article, je souhaite partager mes tentatives de streaming vidéo via des sockets Web sans utiliser de plug-ins de navigateur tiers tels que Adobe Flash Player.  Qu'est-il advenu de cette lecture. <br><a name="habracut"></a><br>  Adobe Flash - anciennement Macromedia Flash, est une plate-forme pour créer des applications qui s'exécutent dans un navigateur Web.  Avant la mise en œuvre de l'API Media Stream, c'était presque la seule plate-forme pour diffuser des vidéos et de la voix à partir d'une webcam, ainsi que pour créer diverses conférences et discussions dans un navigateur.  Le protocole de transmission d'informations sur les médias RTMP (Real Time Messaging Protocol) a en fait été fermé pendant longtemps, ce qui signifie: si vous souhaitez augmenter votre service de streaming, veuillez utiliser le logiciel d'Adobe lui-même - Adobe Media Server (AMS). <br><br>  Après un certain temps en 2012, Adobe a «abandonné et craché» la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">spécification du</a> protocole RTMP, qui contenait des erreurs et, en fait, n'était pas complète.  À ce moment-là, les développeurs ont commencé à implémenter ce protocole, de sorte que le serveur Wowza est apparu.  En 2011, Adobe a déposé une plainte contre Wowza pour l'utilisation illégale de brevets liés au RTMP, après 4 ans, le conflit a été résolu par le monde. <br><br>  La plate-forme Adobe Flash existe depuis plus de 20 ans, pendant ce temps, de nombreuses vulnérabilités critiques ont été découvertes, elles ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">promis</a> de cesser de prendre en charge d'ici 2020, il n'y a donc pas tant d'alternatives pour le service de streaming. <br><br>  Pour mon projet, j'ai immédiatement décidé d'abandonner complètement l'utilisation de Flash dans le navigateur.  La raison principale que j'ai indiquée ci-dessus, Flash n'est pas du tout pris en charge sur les plates-formes mobiles et je ne voulais vraiment pas déployer Adobe Flash pour le développement sur Windows (émulateur Wine).  J'ai donc commencé à écrire un client en JavaScript.  Ce ne sera qu'un prototype, car j'ai appris plus tard que le streaming peut être fait beaucoup plus efficacement sur la base de p2p, seulement j'aurai des pairs - serveur - pairs, mais plus à ce sujet une autre fois, car il n'est pas encore prêt. <br><br>  Pour commencer, nous avons besoin du serveur websockets lui-même.  J'ai fait le plus simple basé sur le package go mélodie: <br><br><div class="spoiler">  <b class="spoiler_title">Code serveur</b> <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"errors"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/go-chi/chi"</span></span> <span class="hljs-string"><span class="hljs-string">"gopkg.in/olahol/melody.v1"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { r := chi.NewRouter() m := melody.New() m.Config.MaxMessageSize = <span class="hljs-number"><span class="hljs-number">204800</span></span> r.Get(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { http.ServeFile(w, r, <span class="hljs-string"><span class="hljs-string">"public/index.html"</span></span>) }) r.Get(<span class="hljs-string"><span class="hljs-string">"/ws"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { m.HandleRequest(w, r) }) <span class="hljs-comment"><span class="hljs-comment">//    m.HandleMessageBinary(func(s *melody.Session, msg []byte) { m.BroadcastBinary(msg) }) log.Println("Starting server...") http.ListenAndServe(":3000", r) }</span></span></code> </pre> <br></div></div><br>  Côté client (côté diffusion), vous devez d'abord accéder à la caméra.  Cela se fait via l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API MediaStream</a> . <br><br>  Nous obtenons l'accès (résolution) à la caméra / au microphone via l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API Media Devices</a> .  Cette API fournit la méthode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MediaDevices.getUserMedia ()</a> , qui affiche une fenêtre contextuelle.  une fenêtre demandant à l'utilisateur l'autorisation d'accéder à la caméra et / ou au microphone.  Je voudrais noter que j'ai mené toutes les expériences dans Google Chrome, mais je pense que dans Firefox, tout fonctionnera à peu près de la même manière. <br><br>  Ensuite, getUserMedia () renvoie une promesse, dans laquelle un objet MediaStream est transmis - un flux de données vidéo et audio.  Nous affectons cet objet à la propriété de l'élément vidéo dans src.  Code: <br><br><div class="spoiler">  <b class="spoiler_title">Côté diffusion</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;style&gt; #videoObjectHtml5ApiServer { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">320</span></span>px; height: <span class="hljs-number"><span class="hljs-number">240</span></span>px; background: #<span class="hljs-number"><span class="hljs-number">666</span></span>; } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/style&gt; &lt;/</span></span>head&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!--    ""     --&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">autoplay</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"videoObjectHtml5ApiServer"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"application/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">var</span></span></span></span><span class="xml"><span class="javascript"> video = </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">document</span></span></span></span><span class="xml"><span class="javascript">.getElementById(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'videoObjectHtml5ApiServer'</span></span></span></span><span class="xml"><span class="javascript">); </span></span><span class="hljs-comment"><span class="xml"><span class="javascript"><span class="hljs-comment">//   MediaDevices API,      (    ) // getUserMedia  ,           video    if (navigator.mediaDevices.getUserMedia) { navigator.mediaDevices.getUserMedia({video: true}).then(function (stream) { //     video ,        video.srcObject = stream; }); } </span></span></span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br></div></div><br>  Pour diffuser un flux vidéo via des sockets, vous devez en quelque sorte le coder quelque part, le mettre en mémoire tampon et le transmettre en plusieurs parties.  Le flux vidéo brut ne peut pas être transmis via des sockets Web.  C'est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">là que l'API MediaRecorder</a> vient à la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rescousse</a> .  Cette API vous permet d'encoder et de diviser un flux en morceaux.  Je fais du codage pour compresser le flux vidéo, afin de pouvoir conduire moins d'octets sur le réseau.  Après avoir éclaté en morceaux, il est possible d'envoyer chaque pièce sur websocket.  Code: <br><br><div class="spoiler">  <b class="spoiler_title">Nous encodons le flux vidéo, le battons en morceaux</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;style&gt; #videoObjectHtml5ApiServer { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">320</span></span>px; height: <span class="hljs-number"><span class="hljs-number">240</span></span>px; background: #<span class="hljs-number"><span class="hljs-number">666</span></span>; } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/style&gt; &lt;/</span></span>head&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!--    ""     --&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">autoplay</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"videoObjectHtml5ApiServer"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"application/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">var</span></span></span></span><span class="xml"><span class="javascript"> video = </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">document</span></span></span></span><span class="xml"><span class="javascript">.getElementById(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'videoObjectHtml5ApiServer'</span></span></span></span><span class="xml"><span class="javascript">); </span></span><span class="hljs-comment"><span class="xml"><span class="javascript"><span class="hljs-comment">//   MediaDevices API,      (    ) // getUserMedia  ,           video    if (navigator.mediaDevices.getUserMedia) { navigator.mediaDevices.getUserMedia({video: true}).then(function (stream) { //     video ,        video.srcObject = s; var recorderOptions = { mimeType: 'video/webm; codecs=vp8' //      webm  vp8 }, mediaRecorder = new MediaRecorder(s, recorderOptions ); //  MediaRecorder mediaRecorder.ondataavailable = function(e) { if (e.data &amp;&amp; e.data.size &gt; 0) { //     e.data } } mediaRecorder.start(100); //      100   }); } </span></span></span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br></div></div><br>  Ajoutez maintenant le transfert sur les websockets.  Étonnamment, cela ne nécessite qu'un objet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WebSocket</a> .  Il n'a que deux méthodes d'envoi et de fermeture.  Les noms parlent d'eux-mêmes.  Code étendu: <br><br><div class="spoiler">  <b class="spoiler_title">Nous transmettons le flux vidéo au serveur</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;style&gt; #videoObjectHtml5ApiServer { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">320</span></span>px; height: <span class="hljs-number"><span class="hljs-number">240</span></span>px; background: #<span class="hljs-number"><span class="hljs-number">666</span></span>; } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/style&gt; &lt;/</span></span>head&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!--    ""     --&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">autoplay</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"videoObjectHtml5ApiServer"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"application/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">var</span></span></span></span><span class="xml"><span class="javascript"> video = </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">document</span></span></span></span><span class="xml"><span class="javascript">.getElementById(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'videoObjectHtml5ApiServer'</span></span></span></span><span class="xml"><span class="javascript">); </span></span><span class="hljs-comment"><span class="xml"><span class="javascript"><span class="hljs-comment">//   MediaDevices API,      (    ) // getUserMedia  ,           video    if (navigator.mediaDevices.getUserMedia) { navigator.mediaDevices.getUserMedia({video: true}).then(function (stream) { //     video ,        video.srcObject = s; var recorderOptions = { mimeType: 'video/webm; codecs=vp8' //      webm  vp8 }, mediaRecorder = new MediaRecorder(s, recorderOptions ), //  MediaRecorder socket = new WebSocket('ws://127.0.0.1:3000/ws'); mediaRecorder.ondataavailable = function(e) { if (e.data &amp;&amp; e.data.size &gt; 0) { //     e.data socket.send(e.data); } } mediaRecorder.start(100); //      100   }).catch(function (err) { console.log(err); }); } </span></span></span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br></div></div><br>  Le côté diffusion est prêt!  Essayons maintenant de prendre un flux vidéo et de le montrer sur le client.  De quoi avons-nous besoin pour cela?  Tout d'abord, bien sûr, une connexion socket.  Nous raccrochons un "écouteur" sur l'objet WebSocket, souscrivons à l'événement "message".  Ayant reçu une donnée binaire, notre serveur la diffuse aux abonnés, c'est-à-dire aux clients.  Dans le même temps, la fonction de rappel liée à l '«écouteur» de l'événement «message» est déclenchée sur le client, l'objet lui-même est passé dans l'argument de la fonction - un morceau du flux vidéo codé par vp8. <br><br><div class="spoiler">  <b class="spoiler_title">Nous acceptons un flux vidéo</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;style&gt; #videoObjectHtml5ApiServer { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">320</span></span>px; height: <span class="hljs-number"><span class="hljs-number">240</span></span>px; background: #<span class="hljs-number"><span class="hljs-number">666</span></span>; } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/style&gt; &lt;/</span></span>head&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!--    ""     --&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">autoplay</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"videoObjectHtml5ApiServer"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"application/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">var</span></span></span></span><span class="xml"><span class="javascript"> video = </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">document</span></span></span></span><span class="xml"><span class="javascript">.getElementById(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'videoObjectHtml5ApiServer'</span></span></span></span><span class="xml"><span class="javascript">), socket = </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> WebSocket(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'ws://127.0.0.1:3000/ws'</span></span></span></span><span class="xml"><span class="javascript">), arrayOfBlobs = []; socket.addEventListener(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'message'</span></span></span></span><span class="xml"><span class="javascript">, </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function"> (</span></span></span><span class="hljs-params"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params">event</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">) </span></span></span></span><span class="xml"><span class="javascript">{ </span></span><span class="hljs-comment"><span class="xml"><span class="javascript"><span class="hljs-comment">// ""     arrayOfBlobs.push(event.data); //     readChunk(); }); </span></span></span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br></div></div><br>  Pendant longtemps, j'ai essayé de comprendre pourquoi il était impossible d'envoyer immédiatement les éléments reçus à l'élément vidéo pour la lecture, mais cela s'est avéré impossible, bien sûr, vous devez d'abord placer le morceau dans un tampon spécial attaché à l'élément vidéo, et seulement alors, il commencera à lire le flux vidéo.  Pour ce faire, vous avez besoin de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API MediaSource</a> et de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API FileReader</a> . <br><br>  MediaSource agit comme une sorte d'intermédiaire entre l'objet de lecture multimédia et la source de ce flux multimédia.  L'objet MediaSource contient un tampon enfichable pour la source de flux vidéo / audio.  Une caractéristique est que le tampon ne peut contenir que des données Uint8, FileReader est donc requis pour créer un tel tampon.  Jetez un œil au code et il deviendra plus clair: <br><br><div class="spoiler">  <b class="spoiler_title">Lire le flux vidéo</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;style&gt; #videoObjectHtml5ApiServer { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">320</span></span>px; height: <span class="hljs-number"><span class="hljs-number">240</span></span>px; background: #<span class="hljs-number"><span class="hljs-number">666</span></span>; } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/style&gt; &lt;/</span></span>head&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!--    ""     --&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">autoplay</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"videoObjectHtml5ApiServer"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">video</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"application/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">var</span></span></span></span><span class="xml"><span class="javascript"> video = </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">document</span></span></span></span><span class="xml"><span class="javascript">.getElementById(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'videoObjectHtml5ApiServer'</span></span></span></span><span class="xml"><span class="javascript">), socket = </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> WebSocket(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'ws://127.0.0.1:3000/ws'</span></span></span></span><span class="xml"><span class="javascript">), mediaSource = </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> MediaSource(), </span></span><span class="hljs-comment"><span class="xml"><span class="javascript"><span class="hljs-comment">//  MediaSource vid2url = URL.createObjectURL(mediaSource), //   URL      arrayOfBlobs = [], sourceBuffer = null; // ,  - socket.addEventListener('message', function (event) { // ""     arrayOfBlobs.push(event.data); //     readChunk(); }); //   MediaSource   ,      // /  //   ,   ,        //     ,       mediaSource.addEventListener('sourceopen', function() { var mediaSource = this; sourceBuffer = mediaSource.addSourceBuffer("video/webm; codecs=\"vp8\""); }); function readChunk() { var reader = new FileReader(); reader.onload = function(e) { //   FileReader  ,      //  ""   Uint8Array ( Blob)   ,  //  ,       / sourceBuffer.appendBuffer(new Uint8Array(e.target.result)); reader.onload = null; } reader.readAsArrayBuffer(arrayOfBlobs.shift()); } </span></span></span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br></div></div><br>  Le prototype du service de streaming est prêt.  Le principal inconvénient est que la lecture vidéo sera à 100 ms derrière le côté de transmission, nous le définissons nous-mêmes lors du fractionnement du flux vidéo avant de l'envoyer au serveur.  De plus, lorsque j'ai vérifié sur mon ordinateur portable, j'ai progressivement accumulé un décalage entre les côtés émetteur et récepteur, ce qui était clairement visible.  J'ai commencé à chercher des moyens de surmonter cette lacune, et ... je suis tombé sur l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API RTCPeerConnection</a> , qui vous permet de transférer un flux vidéo sans astuces comme diviser un flux en morceaux.  Le décalage accumulé, je pense, est dû au fait que dans le navigateur, avant le transfert, chaque morceau est transcodé au format webm.  Je n'ai pas creusé plus loin, mais j'ai commencé à étudier WebRTC, je pense aux résultats de mes recherches, j'écrirai un article séparé si je trouve cette communauté intéressante. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461769/">https://habr.com/ru/post/fr461769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461759/index.html">Écoute des communications VoIP cryptées</a></li>
<li><a href="../fr461761/index.html">DPKI: remédier aux inconvénients de l'ICP centralisée avec la blockchain</a></li>
<li><a href="../fr461763/index.html">Les agences de publicité peuvent-elles tuer des entreprises au début du voyage</a></li>
<li><a href="../fr461765/index.html">Nous traversons des k8 avec Kafka, économisons des conteneurs, échappons aux déchets dans Ansible: les 10 meilleurs rapports de DevOops 2018</a></li>
<li><a href="../fr461767/index.html">Algorithme de moteur de recherche SVLAB</a></li>
<li><a href="../fr461771/index.html">Dites non au silence: de la pépinière au bureau</a></li>
<li><a href="../fr461773/index.html">Airtest IDE - une nouvelle façon de tester l'automatisation des jeux mobiles?</a></li>
<li><a href="../fr461775/index.html">3 cas pour utiliser Celery dans une application Django</a></li>
<li><a href="../fr461779/index.html">80% des données de votre entreprise ne vous sont pas accessibles. Que faire à ce sujet?</a></li>
<li><a href="../fr461781/index.html">"Ycombinator Startup School 2019." Vidéo des trois premières semaines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>