<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÅ üë©üèΩ‚Äçüîß üßîüèø Lo que aprend√≠ al probar 200,000 l√≠neas de c√≥digo de infraestructura ü§µüèª üê™ ‚õπüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El enfoque de IaC (Infraestructura como c√≥digo) consiste no solo en el c√≥digo que se almacena en el repositorio, sino tambi√©n en las personas y los pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lo que aprend√≠ al probar 200,000 l√≠neas de c√≥digo de infraestructura</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467171/"><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  El <strong>enfoque de IaC</strong> (Infraestructura como c√≥digo) consiste no solo en el c√≥digo que se almacena en el repositorio, sino tambi√©n en las personas y los procesos que rodean este c√≥digo.  ¬øEs posible reutilizar enfoques desde el desarrollo de software hasta la gesti√≥n y la descripci√≥n de la infraestructura?  No ser√° superfluo tener esta idea en mente mientras lees el art√≠culo. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versi√≥n rusa</a> </p><a name="habracut"></a><br><p>  Esta es una transcripci√≥n de mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">actuaci√≥n</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DevopsConf 2019-05-28</a> . </p><br><div class="spoiler">  <b class="spoiler_title">Diapositivas y videos</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versi√≥n rusa</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versi√≥n rusa</a> </li><li>  Carrera en seco 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video (RU) de DINS DevOps TARDE 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Diapositivas</a> </li></ul></div></div><br><h1 id="infrastructure-as-bash-history">  Infraestructura como historia bash </h1><br><p><img src="https://habrastorage.org/webt/i_/yl/fm/i_ylfms8w-9pgisnujlu-iv1u3y.png"></p><br><p>  Supongamos que viene a un nuevo proyecto y le dicen: "tenemos <em>Infraestructura como C√≥digo</em> ".  En realidad, resulta que la <em>Infraestructura como bash history</em> o, por ejemplo, la <em>Documentaci√≥n como bash history</em> .  Esta es una situaci√≥n muy real, por ejemplo, Denis Lysenko describi√≥ un caso similar en su discurso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥mo reemplazar toda la infraestructura y comenzar a dormir en paz</a> , cont√≥ c√≥mo, desde la historia de Bash, obtuvieron una infraestructura delgada en el proyecto. </p><br><p>  Si lo desea, puede decir que <em>Infraestructura como historial de bash</em> es como el c√≥digo: </p><br><ol><li>  <em>reproducibilidad</em> : puede tomar el historial de bash, ejecutar comandos desde all√≠, tal vez, por cierto, obtendr√° una configuraci√≥n de trabajo en la salida. </li><li>  <em>versionado</em> : sabes qui√©n entr√≥ y qu√© hizo, una vez m√°s, no el hecho de que esto te llevar√° a una configuraci√≥n de trabajo en la salida. </li><li>  <em>historia</em> : historia de qui√©n hizo qu√©.  solo que no puedes usarlo si pierdes el servidor. </li></ol><br><p>  Que hacer </p><br><h1 id="infrastructure-as-code">  Infraestructura como c√≥digo </h1><br><p><img src="https://habrastorage.org/webt/gm/3e/wf/gm3ewf7g3w72takvuffsxhcbgoy.png"></p><br><p>  Incluso un caso tan extra√±o como <em>Infraestructura como bash history</em> puede ser arrastrado por los o√≠dos a <em>Infraestructura como C√≥digo</em> , pero cuando queremos hacer algo m√°s complicado que el antiguo servidor LAMP, llegaremos a la conclusi√≥n de que este c√≥digo necesita ser modificado, modificado, modificado de alguna manera .  Adem√°s, nos gustar√≠a considerar paralelos entre <em>Infraestructura como C√≥digo</em> y desarrollo de software. </p><br><h2 id="dry">  SECO </h2><br><p><img src="https://habrastorage.org/webt/rx/qa/vf/rxqavfjxrtmtwkjzzq4prr72oao.png"></p><br><p>  En el proyecto de desarrollo de almacenamiento, hab√≠a una subtarea para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">configurar peri√≥dicamente SDS</a> : estamos lanzando una nueva versi√≥n: debe implementarse para realizar m√°s pruebas.  La tarea es extremadamente simple: </p><br><ul><li>  ven aqu√≠ por ssh y ejecuta el comando. </li><li>  copia el archivo all√≠. </li><li>  Aqu√≠ hay un ajuste a la configuraci√≥n. </li><li>  comenzar el servicio all√≠ </li><li>  ... </li><li>  BENEFICIOS! </li></ul><br><p>  Bash es m√°s que suficiente para la l√≥gica descrita, especialmente en las primeras etapas de un proyecto cuando reci√©n comienza.  No est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mal que uses bash</a> , pero con el tiempo se te pedir√° que implementes algo similar, pero ligeramente diferente.  Lo primero que viene a la mente: copiar y pegar.  Y ahora tenemos dos scripts muy similares que hacen casi lo mismo.  Con el tiempo, el n√∫mero de scripts ha crecido, y nos enfrentamos al hecho de que existe una cierta l√≥gica comercial para implementar la instalaci√≥n, que debe sincronizarse entre diferentes scripts, es bastante dif√≠cil. </p><br><p><img src="https://habrastorage.org/webt/-u/ep/cv/-uepcvi1kjsnruflehy0noydk1k.png"></p><br><p>  Resulta que hay una pr√°ctica SECA (No te repitas).  La idea es reutilizar el c√≥digo existente.  Suena simple, pero no lleg√≥ a esto de inmediato.  En nuestro caso, era una idea com√∫n: separar las configuraciones de los scripts.  Es decir  La l√≥gica de negocios de c√≥mo la instalaci√≥n se implementa por separado, las configuraciones por separado. </p><br><h2 id="solid-for-cfm">  S√ìLIDO para CFM </h2><br><p><img src="https://habrastorage.org/webt/kt/7f/ba/kt7fbazyy0arjwrnlwgoynqbvqg.png"></p><br><p>  Con el tiempo, el proyecto creci√≥ y una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extensi√≥n natural</a> fue la aparici√≥n de Ansible.  La raz√≥n principal de su aparici√≥n es la presencia de experiencia en el equipo y que bash no est√° destinado a una l√≥gica compleja.  Ansible tambi√©n comenz√≥ a contener una l√≥gica compleja.  Para que la l√≥gica compleja no se convierta en caos, existen principios para organizar el c√≥digo <em>SOLID</em> en el desarrollo de software. Por ejemplo, Grigory Petrov en su informe "¬øPor qu√© necesita una marca personal?" Plante√≥ la pregunta de que una persona est√° dise√±ada de tal manera que es m√°s f√°cil operar con alg√∫n tipo de entidades sociales, en el desarrollo de software estos son objetos.  Si combina estas dos ideas y contin√∫a desarroll√°ndolas, notar√° que tambi√©n puede usar <em>SOLID</em> en la descripci√≥n de la infraestructura para que sea m√°s f√°cil mantener y modificar esta l√≥gica en el futuro. </p><br><h3 id="the-single-responsibility-principle">  El principio de responsabilidad √∫nica </h3><br><p><img src="https://habrastorage.org/webt/yh/h7/kg/yhh7kgr1jal27ddvpeydqxcmzog.png"></p><br><p>  <em>Cada clase realiza solo una tarea.</em> </p><br><p>  No es necesario mezclar c√≥digo y hacer monstruos monol√≠ticos de pasta divina.  La infraestructura debe consistir en ladrillos simples.  Resulta que si divide el libro de jugadas de Ansible en peque√±as piezas, lee los roles de Ansible, entonces son m√°s f√°ciles de mantener. </p><br><h3 id="the-open-closed-principle">  Los principios abiertos y cerrados </h3><br><p><img src="https://habrastorage.org/webt/g6/ym/qn/g6ymqn8vohwbewqx7hgixuiuuf8.png"></p><br><p>  <em>El principio de apertura / cierre.</em> </p><br><ul><li>  <em>Abierto para expansi√≥n: significa que el comportamiento de una entidad puede expandirse creando nuevos tipos de entidades.</em> </li><li>  <em>Cerrado por cambio: como resultado de expandir el comportamiento de una entidad, no se deben realizar cambios en el c√≥digo que utiliza estas entidades.</em> </li></ul><br><p>  Inicialmente, implementamos la infraestructura de prueba en m√°quinas virtuales, pero debido al hecho de que la l√≥gica de implementaci√≥n del negocio era independiente de la implementaci√≥n, agregamos f√°cilmente un rollo a bare-metall. </p><br><h3 id="the-liskov-substitution-principle">  El principio de sustituci√≥n de Liskov </h3><br><p><img src="https://habrastorage.org/webt/1x/-4/am/1x-4am1tjecrhxx3jm7bfur00oy.png"></p><br><p>  <em>El principio de sustituci√≥n de Barbara Liskov.</em>  <em>los objetos en el programa deben ser reemplazables con instancias de sus subtipos sin cambiar la correcci√≥n del programa</em> </p><br><p>  Si observa de manera m√°s amplia, no es una caracter√≠stica de ning√∫n proyecto en particular que puede aplicar <em>SOLID</em> , generalmente se trata de CFM, por ejemplo, en otro proyecto que necesita implementar una aplicaci√≥n Java en caja sobre varios Java, servidores de aplicaciones, bases de datos, SO, etc.  Para este ejemplo, considerar√© otros principios <em>S√ìLIDOS</em> . </p><br><p>  En nuestro caso, como parte del equipo de infraestructura, existe un acuerdo de que si instalamos el rol de imbjava u oraclejava, entonces tenemos un ejecutable binario de Java.  Esto es necesario porque  los roles superiores dependen de este comportamiento; esperan que Java est√© presente.  Al mismo tiempo, esto nos permite reemplazar una implementaci√≥n / versi√≥n de java con otra sin cambiar la l√≥gica de implementaci√≥n de la aplicaci√≥n. </p><br><p>  El problema aqu√≠ radica en el hecho de que en Ansible es imposible implementar tales, como resultado, algunos acuerdos aparecen dentro del equipo. </p><br><h3 id="the-interface-segregation-principle">  El principio de segregaci√≥n de interfaz </h3><br><p><img src="https://habrastorage.org/webt/v2/9r/wa/v29rwalnqryarhrwe-_r8jvx0go.png"></p><br><p>  <em>El principio de separaci√≥n de interfaz ‚Äúmuchas interfaces dise√±adas espec√≠ficamente para clientes son mejores que una √∫nica interfaz de uso general.</em> </p><br><p>  Inicialmente, intentamos poner toda la variaci√≥n en la implementaci√≥n de la aplicaci√≥n en un libro de jugadas Ansible, pero fue dif√≠cil de admitir, y el enfoque cuando tenemos una interfaz fuera (el cliente espera el puerto 443) se especifica, luego, para una implementaci√≥n espec√≠fica, puede construir la infraestructura a partir de ladrillos separados. </p><br><h3 id="the-dependency-inversion-principle">  El principio de inversi√≥n de dependencia </h3><br><p><img src="https://habrastorage.org/webt/ee/ip/e8/eeipe8nr7hbjx18yxtoxsekwlfy.png"></p><br><p>  <em>El principio de inversi√≥n de dependencia.</em>  <em>Los m√≥dulos de nivel superior no deben depender de los m√≥dulos de nivel inferior.</em>  <em>Ambos tipos de m√≥dulos deber√≠an depender de abstracciones.</em>  <em>Las abstracciones no deber√≠an depender de los detalles.</em>  <em>Los detalles deben depender de las abstracciones.</em> </p><br><p>  Aqu√≠ el ejemplo se basar√° en antipatr√≥n. </p><br><ol><li>  Uno de los clientes ten√≠a una nube privada. </li><li>  Dentro de la nube, pedimos m√°quinas virtuales. </li><li>  Pero en vista de las caracter√≠sticas de la nube, la implementaci√≥n de la aplicaci√≥n estaba vinculada a qu√© hipervisor estaba la VM. </li></ol><br><p>  Es decir  l√≥gica de implementaci√≥n de aplicaciones de alto nivel, las dependencias fluyeron a los niveles inferiores del hipervisor, y esto signific√≥ problemas al reutilizar esta l√≥gica.  <em><strong>No hagas eso.</strong></em> </p><br><h1 id="interaction">  Interacci√≥n </h1><br><p><img src="https://habrastorage.org/webt/rd/7_/8r/rd7_8rtprcz4xjkuhctjppbkcuu.png"></p><br><p>  La infraestructura como c√≥digo no solo se trata del c√≥digo, sino tambi√©n de la relaci√≥n entre el c√≥digo y una persona, sobre las interacciones entre los desarrolladores de la infraestructura. </p><br><h2 id="bus-factor">  Factor de bus </h2><br><p><img src="https://habrastorage.org/webt/p5/4-/wh/p54-whkhcglorvk_dlt0b1jpajy.png"></p><br><p>  Supongamos que tienes a Vasya en el proyecto.  Vasya sabe todo sobre su infraestructura, ¬øqu√© suceder√° si Vasya desaparece repentinamente?  Esta es una situaci√≥n muy real, porque puede ser atropellada por un autob√∫s.  A veces esto sucede.  Si esto sucede y el conocimiento sobre el c√≥digo, su estructura, c√≥mo funciona, las apariencias y las contrase√±as no se distribuyen en el equipo, puede encontrar una serie de situaciones desagradables.  Se pueden usar varios enfoques para minimizar estos riesgos y distribuir el conocimiento dentro del equipo. </p><br><h2 id="pair-devopsing">  Par devopsing </h2><br><p><img src="https://habrastorage.org/webt/6q/0l/t0/6q0lt0afzbkpivxxp4uvryxgake.png"></p><br><p>  No es como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una broma</a> que los administradores bebieron cerveza, cambiaron las contrase√±as, sino un an√°logo de la programaci√≥n de pares.  Es decir  dos ingenieros se sientan en una computadora, un teclado y comienzan a configurar su infraestructura juntos: configurar el servidor, escribir el rol Ansible, etc.  Suena bien, pero no funcion√≥ para nosotros.  Pero los casos especiales de esta pr√°ctica funcionaron.  Lleg√≥ un nuevo empleado, su mentor toma una tarea real con √©l, trabaja, transfiere conocimiento. </p><br><p>  Otro caso especial es una llamada de incidente.  Durante el problema, un grupo de personas en servicio e involucradas se re√∫ne, se nombra a un l√≠der, que comparte su pantalla y expresa el tren del pensamiento.  Otros participantes siguen el pensamiento del l√≠der, esp√≠an trucos desde la consola, verifican que no hayan perdido una l√≠nea en el registro y aprenden cosas nuevas sobre el sistema.  Este enfoque funcion√≥ en lugar de no. </p><br><h2 id="code-review">  Revisi√≥n de c√≥digo </h2><br><p><img src="https://habrastorage.org/webt/wk/u6/vn/wku6vntzzsquckgu58n1_r3tg-i.png"></p><br><p>  Subjetivamente, de manera m√°s eficiente, la difusi√≥n del conocimiento sobre la infraestructura y c√≥mo se organiz√≥ se llev√≥ a cabo mediante la revisi√≥n del c√≥digo: </p><br><ul><li>  La infraestructura se describe por c√≥digo en el repositorio. </li><li>  Los cambios ocurren en una rama separada. </li><li>  Con una solicitud de fusi√≥n, puede ver el delta de cambios en la infraestructura. </li></ul><br><p>  Lo m√°s destacado aqu√≠ fue que los revisores fueron seleccionados por turnos, de acuerdo con el cronograma, es decir,  con cierta probabilidad subir√°s a una nueva pieza de infraestructura. </p><br><h3 id="code-style">  Estilo de c√≥digo </h3><br><p><img src="https://habrastorage.org/webt/qa/fz/ju/qafzju1vc86llmvcc1m4urpfa7c.png"></p><br><p>  Con el tiempo, las disputas comenzaron a aparecer durante la revisi√≥n, ya que  los revisores ten√≠an su propio estilo y la capacidad de rotaci√≥n de los revisores los apilaron con diferentes estilos: 2 espacios o 4, camelCase o snake_case.  Implementar esto no funcion√≥ de inmediato. </p><br><ul><li>  La primera idea fue recomendar el uso de linter, porque todos los mismos ingenieros, todos inteligentes.  Pero diferentes editores, sistema operativo, no es conveniente </li><li>  Esto se convirti√≥ en un bot, que para cada commit se comprometi√≥ con la problem√°tica escrita en holgura y aplic√≥ la salida de linter.  Pero en la mayor√≠a de los casos, se encontraron asuntos m√°s importantes y el c√≥digo no se solucion√≥. </li></ul><br><h3 id="green-build-master">  Maestro de construcci√≥n verde </h3><br><p><img src="https://habrastorage.org/webt/lw/ow/xi/lwowxis0izoohgthm9db7nheih4.png"></p><br><p>  El tiempo pasa y llegamos a la conclusi√≥n de que no debe permitir confirmaciones que no pasen ciertas pruebas al maestro.  Voila!  inventamos el Green Build Master, que se ha practicado durante mucho tiempo en el desarrollo de software: </p><br><ul><li>  El desarrollo est√° en una rama separada. </li><li>  Las pruebas se ejecutan en este hilo. </li><li>  Si las pruebas fallan, el c√≥digo no entrar√° en el asistente. </li></ul><br><p>  Tomar esta decisi√≥n fue muy doloroso porque  caus√≥ mucha controversia, pero vali√≥ la pena, porque  Las solicitudes de fusiones comenzaron a llegar a la revisi√≥n sin desacuerdos en cuanto al estilo y con el tiempo, el n√∫mero de √°reas problem√°ticas comenz√≥ a disminuir. </p><br><h1 id="iac-testing">  Prueba IaC </h1><br><p><img src="https://habrastorage.org/webt/ah/dg/sa/ahdgsaecxtevlwnv9ozcoiypkq8.png"></p><br><p>  Adem√°s de la verificaci√≥n de estilo, puede usar otras cosas, por ejemplo, para verificar que su infraestructura realmente se pueda implementar.  O compruebe que los cambios en la infraestructura no provocar√°n una p√©rdida de dinero.  ¬øPor qu√© podr√≠a ser necesario?  La pregunta es compleja y filos√≥fica, es mejor responder con la historia de que de alguna manera hubo un autoescalador en Powershell que no verific√≥ las condiciones l√≠mite =&gt; se crearon m√°s m√°quinas virtuales de las necesarias =&gt; el cliente gast√≥ m√°s dinero de lo planeado.  No es lo suficientemente agradable, pero ser√≠a bastante realista detectar este error en etapas anteriores. </p><br><p>  Uno puede preguntar, ¬øpor qu√© hacer que la infraestructura compleja sea a√∫n m√°s dif√≠cil?  Las pruebas para la infraestructura, as√≠ como para el c√≥digo, no se tratan de simplificaci√≥n, sino de saber c√≥mo deber√≠a funcionar su infraestructura. </p><br><h2 id="iac-testing-pyramid">  Pir√°mide de pruebas IaC </h2><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><h3 id="iac-testing-static-analysis">  Prueba IaC: an√°lisis est√°tico </h3><br><p>  Si despliega de inmediato toda la infraestructura y verifica que funciona, puede resultar que toma mucho tiempo y requiere mucho tiempo.  Por lo tanto, la base debe ser algo que funcione r√°pidamente, es mucho y cubre muchos lugares primitivos. </p><br><h4 id="bash-is-tricky">  Bash es complicado </h4><br><p>  Aqu√≠ hay un ejemplo trivial.  seleccione todos los archivos en el directorio actual y c√≥pielos en otra ubicaci√≥n.  Lo primero que viene a la mente: </p><br><pre><code class="plaintext hljs">for i in * ; do cp $i /some/path/$i.bak done</code> </pre> <br><p>  Pero, ¬øqu√© pasa si hay un espacio en el nombre del archivo?  Bueno, de acuerdo, somos inteligentes, podemos usar comillas: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp "$i" "/some/path/$i.bak" ; done</code> </pre> <br><p>  Bien hecho?  no!  ¬øQu√© pasa si no hay nada en el directorio, es decir?  Globbing no funcionar√°. </p><br><pre> <code class="plaintext hljs">find . -type f -exec mv -v {} dst/{}.bak \;</code> </pre> <br><p>  Ahora bien hecho?  no ... Olvid√© que el nombre del archivo puede ser <code>\n</code> . </p><br><pre> <code class="plaintext hljs">touch x mv x "$(printf "foo\nbar")" find . -type f -print0 | xargs -0 mv -t /path/to/target-dir</code> </pre> <br><h4 id="static-analysis-tools">  Herramientas de an√°lisis est√°tico </h4><br><p>  El problema del paso anterior podr√≠a detectarse cuando olvidamos las comillas, para esto en la naturaleza hay muchas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">herramientas de Shellcheck</a> , hay muchas de ellas, y lo m√°s probable es que pueda encontrar un revestimiento para su pila bajo su IDE. </p><br><div class="scrollable-table"><table><thead><tr><th>  Idioma </th><th>  Herramienta </th></tr></thead><tbody><tr><td>  golpe </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Shellcheck</a> </td></tr><tr><td>  Rub√≠ </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Rubocop</a> </td></tr><tr><td>  pit√≥n </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pylint</a> </td></tr><tr><td>  ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pelusa</a> </td></tr></tbody></table></div><br><h3 id="iac-testing-unit-tests">  Prueba IaC: Pruebas unitarias </h3><br><p><img src="https://habrastorage.org/webt/pn/wx/av/pnwxavylqxfmvcc-oynjhjmsq-a.png"></p><br><p>  Como vimos en el ejemplo anterior, linter no es omnipotente y no puede se√±alar todas las √°reas problem√°ticas.  Adem√°s, por analog√≠a con las pruebas en el desarrollo de software, podemos recordar pruebas unitarias.  Entonces <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">shunit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">junit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rspec</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pytest</a> vienen inmediatamente a la mente.  ¬øPero qu√© hacer con ansible, chef, saltstack y otros como ellos? </p><br><p>  Al principio, hablamos de <em>SOLID</em> y del hecho de que nuestra infraestructura deber√≠a consistir en peque√±os ladrillos.  Su hora ha llegado. </p><br><ol><li>  La infraestructura se tritura en peque√±os ladrillos, por ejemplo, roles Ansible. </li><li>  Se est√° desarrollando alg√∫n tipo de entorno, ya sea Docker o VM. </li><li>  Aplicamos nuestro rol Ansible a este entorno de prueba. </li><li>  Verificamos que todo funcion√≥ como esperamos (ejecutamos las pruebas). </li><li>  Decidimos ok o no ok. </li></ol><br><h4 id="iac-testing-unit-testing-tools">  Pruebas IaC: herramientas de pruebas unitarias </h4><br><p>  La pregunta es, ¬øqu√© son las pruebas para CFM?  puede ejecutar el script cursi, o puede usar soluciones preparadas para esto: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Herramienta </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Testinfra</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Inspec</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Serverspec</a> </td></tr><tr><td>  pila de sal </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Goss</a> </td></tr></tbody></table></div><br><p>  Ejemplo para testinfra, verificamos que los usuarios <code>test1</code> , <code>test2</code> existen y est√°n en el grupo <code>sshusers</code> : </p><br><pre> <code class="plaintext hljs">def test_default_users(host): users = ['test1', 'test2' ] for login in users: assert host.user(login).exists assert 'sshusers' in host.user(login).groups</code> </pre> <br><p>  Que elegir  La pregunta es compleja y ambigua, aqu√≠ hay un ejemplo de un cambio en los proyectos en github para 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/aj/vm/0w/ajvm0wr0cno5a0kchi0z-jwyyxy.png"></p><br><h4 id="iac-testing-frameworks">  Marcos de prueba de IaC </h4><br><p>  ¬øHay c√≥mo poner todo junto y correr?  Puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tomar y hacer todo usted mismo</a> si tiene un n√∫mero suficiente de ingenieros.  Y puede tomar soluciones preparadas, aunque no hay muchas: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Herramienta </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mol√©cula</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cocina de prueba</a> </td></tr><tr><td>  Terraforma </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Terratest</a> </td></tr></tbody></table></div><br><p>  Un ejemplo de cambio en proyectos en github para 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/bj/lb/02/bjlb02mi6tympyzdjjxef3_8bhq.png"></p><br><h4 id="molecule-vs-testkitchen">  Mol√©cula vs.  Testkitchen </h4><br><p><img src="https://habrastorage.org/webt/vx/2e/dt/vx2edtvvuquxyw-4yf81zmk6s9c.png"></p><br><p>  Inicialmente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">intentamos usar testkitchen</a> : </p><br><ol><li>  Crear m√°quinas virtuales en paralelo. </li><li>  Aplicar Roles Ansibles. </li><li>  Alejar la inspecci√≥n. </li></ol><br><p>  Para 25-35 roles, esto funcion√≥ durante 40-70 minutos, que fue mucho tiempo. </p><br><p><img src="https://habrastorage.org/webt/i-/9j/cl/i-9jclmr4x36ag1e8ppzk_d-_b0.png"></p><br><p>  El siguiente paso fue cambiar a jenkins / docker / ansible / mol√©cula.  Idiol√≥gicamente, todo es igual </p><br><ol><li>  Playbooks de pelusa. </li><li>  Derramar roles. </li><li>  Ejecutar contenedor </li><li>  Aplicar Roles Ansibles. </li><li>  Aleja a testinfra. </li><li>  Verifica la idempotencia. </li></ol><br><p><img src="https://habrastorage.org/webt/zz/je/kf/zzjekf-i8wckzdeslzlrbkmmxhg.png"></p><br><p>  Una regla para 40 roles y pruebas para una docena comenz√≥ a tomar unos 15 minutos. </p><br><p><img src="https://habrastorage.org/webt/pn/6p/qe/pn6pqelxwb7dbaapkefv80ccxra.png"></p><br><p>  Lo que debe elegir depende de muchos factores, como la pila utilizada, la experiencia en el equipo, etc.  aqu√≠ todos deciden c√≥mo cerrar el problema de las pruebas unitarias </p><br><h3 id="iac-testing-integration-tests">  Pruebas IaC: Pruebas de integraci√≥n </h3><br><p><img src="https://habrastorage.org/webt/yt/jf/br/ytjfbruwxfanxl15sxcfyg_gz1g.png"></p><br><p>  En la siguiente etapa de la pir√°mide de pruebas de infraestructura, aparecer√°n pruebas de integraci√≥n.  Son similares a las pruebas unitarias: </p><br><ol><li>  La infraestructura se aplasta en peque√±os ladrillos, como los roles de Ansible. </li><li>  Se est√° desarrollando alg√∫n tipo de entorno, ya sea Docker o VM. </li><li>  Hay <strong>muchos</strong> roles de Ansible aplicados a este entorno de prueba. </li><li>  Verificamos que todo funcion√≥ como esperamos (ejecutamos las pruebas). </li><li>  Decidimos ok o no ok. </li></ol><br><p>  En t√©rminos generales, no verificamos la operabilidad de un elemento individual del sistema como en las pruebas unitarias, verificamos c√≥mo se configura el servidor en su conjunto. </p><br><h3 id="iac-testing-end-to-end-tests">  Pruebas IaC: pruebas de extremo a extremo </h3><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><p>  En la parte superior de la pir√°mide nos encontramos con las pruebas de extremo a extremo.  Es decir  no verificamos la operaci√≥n de un servidor separado, un script separado, un ladrillo separado de nuestra infraestructura.  Verificamos que muchos servidores est√©n combinados, nuestra infraestructura funciona como esperamos.  Desafortunadamente, no vi ninguna soluci√≥n de caja preparada, probablemente porque  la infraestructura es a menudo √∫nica y dif√≠cil de crear y crea un marco para probarla.  Como resultado, todos crean su propia soluci√≥n.  Hay demanda, pero no hay respuesta.  Por lo tanto, les dir√© lo que hay para motivar a otros a sonar pensamientos o meterme la nariz, que todo fue inventado mucho antes que nosotros. </p><br><p><img src="https://habrastorage.org/webt/us/xz/rl/usxzrlzt8unudguhf9b89d83dfm.png"></p><br><p>  Un proyecto con una rica historia.  Usado en grandes organizaciones y probablemente cada uno de ustedes se cruza indirectamente.  La aplicaci√≥n admite muchas bases de datos, integraciones, etc., etc.  Saber c√≥mo puede verse la infraestructura de esta manera es una gran cantidad de archivos compuestos por docker, y saber qu√© pruebas ejecutar en qu√© entorno es jenkins. </p><br><p><img src="https://habrastorage.org/webt/an/l2/ev/anl2ev_lxlsnegrxpulghdw9jxw.png"></p><br><p>  Este esquema funcion√≥ durante mucho tiempo, hasta que, como parte del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estudio</a> , intentamos transferirlo a Openshift.  Los contenedores se mantuvieron igual, pero el entorno de lanzamiento ha cambiado (hola DRY nuevamente). </p><br><p><img src="https://habrastorage.org/webt/sh/sg/ud/shsgudbrhuqpazrpikcacxskzrm.png"></p><br><p>  La idea de la investigaci√≥n fue m√°s all√°, y en OpenShift existi√≥ tal cosa de APB (Ansible Playbook Bundle) que le permite acumular conocimiento en el contenedor sobre c√≥mo implementar la infraestructura.  Es decir  Hay un punto de conocimiento reproducible y comprobable de c√≥mo implementar la infraestructura. </p><br><p><img src="https://habrastorage.org/webt/l_/cw/ho/l_cwho8ftxhtnmuekhjlsfllctg.png"></p><br><p>  Todo esto sonaba bien, hasta que nos enterramos en una infraestructura heterog√©nea: necesit√°bamos Windows para las pruebas.  Como resultado, el conocimiento sobre d√≥nde implementar y probar est√° en jenkins. </p><br><h1 id="conclusion">  Conclusi√≥n </h1><br><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  Infraestructura como C√≥digo es </p><br><ul><li>  El c√≥digo en el repositorio. </li><li>  La interacci√≥n de las personas. </li><li>  Pruebas de infraestructura. </li></ul><br><div class="spoiler">  <b class="spoiler_title">enlaces</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versi√≥n en ingl√©s</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Publicaci√≥n cruzada de un blog personal</a> </li><li>  Carrera en seco 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video (RU) de DINS DevOps TARDE 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lecciones aprendidas al escribir m√°s de 300,000 l√≠neas de c√≥digo de infraestructura</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">versi√≥n de texto</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Integrando la infraestructura como c√≥digo en una tuber√≠a de entrega continua</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Probar la infraestructura como c√≥digo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desarrollo efectivo y mantenimiento de roles Ansible</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬°Ansible no es una fiesta para ti!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Idempotente ansioso</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467171/">https://habr.com/ru/post/467171/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467155/index.html">Mejores pr√°cticas para contenedores de Kubernetes: controles de salud</a></li>
<li><a href="../467161/index.html">Aplicaci√≥n web en Kotlin + Spring Boot + Vue.js</a></li>
<li><a href="../467163/index.html">C√≥mo migrar a la nube en dos horas gracias a Kubernetes y la automatizaci√≥n</a></li>
<li><a href="../467165/index.html">Siguiendo los pasos del movimiento ruso Scala. Parte 2</a></li>
<li><a href="../467169/index.html">Lecciones aprendidas de las pruebas M√°s de 200,000 l√≠neas de C√≥digo de Infraestructura</a></li>
<li><a href="../467173/index.html">Arquitecto implementaci√≥n segura de ERP</a></li>
<li><a href="../467175/index.html">Piensa dos veces antes de usar motores de juego</a></li>
<li><a href="../467177/index.html">Consejos de marketing de Tarantino: qu√© papel juegan los pies y por qu√© hacer el jab√≥n Uma Thurman</a></li>
<li><a href="../467179/index.html">Samsung Compiler Bootcamp: ense√±ar a crear "programas de programaci√≥n"</a></li>
<li><a href="../467181/index.html">Intentando crear un an√°logo ASH para PostgreSQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>