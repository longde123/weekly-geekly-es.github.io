<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘©ğŸ» ğŸ‘¨ğŸ¾â€ğŸ”¬ ğŸ›¡ï¸ æ§åˆ¶è®ºä¹å›¢ã€‚ äº‘ä¸­å…·æœ‰.NET Coreåº”ç”¨ç¨‹åºçš„Dockerå®¹å™¨ç¼–æ’ ã€°ï¸ ğŸ‘– â›¹ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸ºäº†ç¡®ä¿è´Ÿè½½å¹³è¡¡ï¼Œå¯ä¼¸ç¼©æ€§å¹¶æé«˜å®¹é”™èƒ½åŠ›ï¼Œå¯ä»¥ä½¿ç”¨è¾…åŠ©å·¥å…·-ç¼–æ’å™¨ã€‚ å…¶ä¸­ï¼ŒKubernetesæœåŠ¡ç°åœ¨éå¸¸å—æ¬¢è¿ã€‚ åœ¨å®è·µä¸­å°è¯•æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†å…¶éƒ¨ç½²åœ¨äº‘ä¸­ï¼Œæˆ‘ä»¬ä»Šå¤©å°†è¿™æ ·åšã€‚ 





 æ³¨æ„ï¼šæˆ‘ä»¬å°†ç»§ç»­é˜…è¯»Hackeræ‚å¿—çš„æ–‡ç« çš„å®Œæ•´ç‰ˆæœ¬ç³»åˆ—ã€‚ ä½œè€…çš„æ‹¼å†™å’Œæ ‡ç‚¹ç¬¦å·å¾—ä»¥ä¿å­˜ã€‚ 
 å±•å¼€AKS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æ§åˆ¶è®ºä¹å›¢ã€‚ äº‘ä¸­å…·æœ‰.NET Coreåº”ç”¨ç¨‹åºçš„Dockerå®¹å™¨ç¼–æ’</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/435870/"><p> ä¸ºäº†ç¡®ä¿è´Ÿè½½å¹³è¡¡ï¼Œå¯ä¼¸ç¼©æ€§å¹¶æé«˜å®¹é”™èƒ½åŠ›ï¼Œå¯ä»¥ä½¿ç”¨è¾…åŠ©å·¥å…·-ç¼–æ’å™¨ã€‚ å…¶ä¸­ï¼ŒKubernetesæœåŠ¡ç°åœ¨éå¸¸å—æ¬¢è¿ã€‚ åœ¨å®è·µä¸­å°è¯•æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†å…¶éƒ¨ç½²åœ¨äº‘ä¸­ï¼Œæˆ‘ä»¬ä»Šå¤©å°†è¿™æ ·åšã€‚ </p><br><p><img src="https://habrastorage.org/webt/rx/3u/wn/rx3uwnjkkqp-6azxt-1cso7gbkc.jpeg"><a name="habracut"></a></p><br><p>  <em>æ³¨æ„ï¼šæˆ‘ä»¬å°†ç»§ç»­é˜…è¯»Hackeræ‚å¿—çš„æ–‡ç« çš„å®Œæ•´ç‰ˆæœ¬ç³»åˆ—ã€‚</em>  <em>ä½œè€…çš„æ‹¼å†™å’Œæ ‡ç‚¹ç¬¦å·å¾—ä»¥ä¿å­˜ã€‚</em> </p><br><h2> å±•å¼€AKS </h2><br><p> æˆ‘ä»¬è½¬åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Azureé—¨æˆ·</a> ï¼Œå•å‡»â€œåˆ›å»ºèµ„æºâ€ï¼Œç„¶åæ‰¾åˆ°åä¸ºKubernetes Serviceçš„æœåŠ¡ã€‚ </p><br><p> é€‰æ‹©åç§°å¹¶æ ¹æ®æ‚¨çš„å–œå¥½æ·»åŠ DNSå‰ç¼€ã€‚ åç§°ä¼šå½±å“æ‚¨è®¿é—®ç¾¤é›†çš„æ–¹å¼ï¼Œä½†å‰ç¼€ä¼šå½±å“å…¶FQDNåœ°å€ã€‚ </p><br><p><img src="https://habrastorage.org/webt/fl/yt/vb/flytvbkzq8gmeefi7dqyhpkhqlm.png"></p><br><p> ç›®å‰ï¼Œæœ€ä¾¿å®œçš„è™šæ‹Ÿæœºæ¯æœˆçš„è´¹ç”¨ä»…ä¸º30ç¾å…ƒã€‚ </p><br><p> ç¬¬äºŒæ­¥æ˜¯åˆ›å»ºæœåŠ¡ä¸»ä½“ã€‚ æœåŠ¡ä¸»ä½“æ˜¯ä¸€ç§æœåŠ¡å¸æˆ·ï¼Œå¯ä»¥åœ¨å…¶ä¸­æ‰§è¡ŒæŸäº›ç‰¹å®šä»»åŠ¡ã€‚ ä¼˜ç‚¹æ˜¯å¯ä»¥é™åˆ¶è¯¥å¸æˆ·çš„æƒé™ã€‚ æ­¤å¤–ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„æ­¤ç±»å¸æˆ·ï¼ˆè€Œæ™®é€šå¸æˆ·çš„æ•°é‡å—è®¢é˜…é™åˆ¶ï¼‰ã€‚ æ‚¨å¯ä»¥åœ¨Active Directoryä¸­çš„â€œåº”ç”¨ç¨‹åºæ³¨å†Œâ€ä¸­æ‰¾åˆ°åˆ›å»ºçš„æœåŠ¡ä¸»ä½“å¸æˆ·ã€‚ </p><br><img src="https://habrastorage.org/webt/9z/de/ml/9zdemlhwxmhnbcf0zg7stsmn1lc.png"><br><p>  RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰æ˜¯é™åˆ¶æˆ–æä¾›å¯¹ç‰¹å®šèµ„æºï¼ˆæˆ–èµ„æºç»„ï¼‰çš„è®¿é—®çš„èƒ½åŠ›ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨å¯ä»¥åŒºåˆ†æ‚¨çš„è®¢é˜…ä¸­çš„å“ªäº›ç”¨æˆ·å…·æœ‰è®¿é—®æƒé™ï¼Œå“ªäº›æ²¡æœ‰ã€‚ </p><br><img src="https://habrastorage.org/webt/9j/np/bw/9jnpbwgfkbqaydmumcpnlfroonk.png"><br><p> ç›®å‰ï¼Œæ­¤è¿‡ç¨‹å¤§çº¦éœ€è¦20åˆ†é’Ÿï¼Œä½†æ‰€æœ‰è¿‡ç¨‹éƒ½å¯èƒ½å–å†³äºé…ç½®ã€‚ </p><br><p> é€šè¿‡ä»¥ä¸‹é“¾æ¥æŸ¥æ‰¾å®˜æ–¹æŒ‡å— <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨é—¨æˆ·åˆ›å»ºAKSé›†ç¾¤</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨CLIåˆ›å»ºAKSé›†ç¾¤</a> </p><br><p> è¦å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦Azureå‘½ä»¤è¡Œ-CLIï¼ˆå‘½ä»¤è¡Œç•Œé¢ï¼‰ã€‚ å®ƒæ—¢å¯ä»¥å®‰è£…åœ¨Windowsä¸‹ï¼Œä¹Ÿå¯ä»¥å®‰è£…åœ¨macOSæˆ–Linuxä¸‹ã€‚ å°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘æ›´å–œæ¬¢ä½¿ç”¨Azure Cloud Shellã€‚ è¿™æ˜¯ä»åŠ è½½åˆ°æµè§ˆå™¨çš„Azureé—¨æˆ·é¡µé¢è¿è¡Œçš„å‘½ä»¤è¡Œã€‚ è¦å·¥ä½œï¼Œå®ƒéœ€è¦åˆ›å»ºçš„Blobå­˜å‚¨ã€‚ å®ƒçš„æˆæœ¬æ˜¯æ¯æœˆå‡ ç¾åˆ†ï¼Œå› æ­¤æˆ‘ä¸æƒ³æ‹…å¿ƒåœ¨æ±½è½¦ä¸Šå®‰è£…CLIã€‚ </p><br><p>  Kubernetesæ”¯æŒå¤šç§å®¹å™¨æŠ€æœ¯ï¼Œä½†è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æœ€å—æ¬¢è¿çš„å®¹å™¨æŠ€æœ¯-Dockerã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker.hub</a>å…è®¸<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‚¨</a>å…è´¹å­˜å‚¨ä¸€ä¸ªç§æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker</a>æ˜ åƒã€‚ å¦‚æœæ‚¨éœ€è¦æ›´å¤šï¼Œå¯ä»¥å°†å®ƒä»¬æ”¾åœ¨é’±ä¸Šã€‚ ä½†æ˜¯ä¸ºäº†èµšé’±ï¼Œå¯ä»¥å°†ç§æœ‰dockeræ˜ åƒæ”¾ç½®åœ¨Azureå®¹å™¨æ³¨å†Œè¡¨ä¸­ã€‚ ç°åœ¨ä»·æ ¼ä»æ¯æœˆ5ç¾å…ƒèµ·ï¼ˆåŸºæœ¬SKUï¼‰ã€‚ </p><br><p>æˆ‘åˆ›å»ºäº†ä¸€ä¸ªåä¸ºmyserviceçš„ACRæœåŠ¡ã€‚ å¦‚æœæ‚¨è¿˜å†³å®šä½¿ç”¨ACRï¼Œåˆ™åœ¨åˆ›å»ºæœåŠ¡æ—¶å°†éœ€è¦è·å–å…¶å¯†é’¥ã€‚ </p><br><img src="https://habrastorage.org/webt/nd/pi/_o/ndpi_oxqlsx4kk8q9vmtepkhiwu.png"><br><p> ç„¶åï¼Œå¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ç™»å½•ï¼š </p><br><pre><code class="plaintext hljs">docker login myservice.azurecr.io</code> </pre> <br><p> è¾“å…¥ä»é—¨æˆ·è·å–çš„ç”¨æˆ·åï¼ˆmyserviceï¼‰å’Œå¯†ç ï¼ˆPJSeyO9 = lCMRDI7dGkz68wjhFGRGxSY3ï¼‰ </p><br><p> ç°åœ¨ï¼Œé€šè¿‡è½¬åˆ°è¯¥é¡¹ç›®çš„ç›®å½•ï¼Œå¯ä»¥åœ¨ä½¿ç”¨æ‰€éœ€æ ‡ç­¾æ ‡è®°å›¾åƒçš„åŒæ—¶æ„å»ºå›¾åƒã€‚ ç„¶åå°†å…¶å‘é€åˆ°äº‘æœåŠ¡ï¼š </p><br><pre> <code class="plaintext hljs">docker build -t myservice.azurecr.io/myservice . docker push myservice.azurecr.io/myservice</code> </pre> <br><h2> æœºå¯†ï¼Œæœºå¯†...æˆ‘ä»¬æä¾›å¯¹å›¾åƒçš„è®¿é—®å¹¶ä¿å­˜è®¾ç½®ã€‚ </h2><br><p> ä½¿ç”¨å·²éƒ¨ç½²çš„AKSæ—¶ï¼Œæ‚¨éœ€è¦è·å¾—ä»–çš„è£èª‰ã€‚ å¦åˆ™ï¼Œkubectlå‘½ä»¤å°†ä¸ä¼šæ‰§è¡Œã€‚ è¦è®¿é—®AKSï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š </p><br><pre> <code class="plaintext hljs">az aks get-credentials --resource-group KubernetesGroup --name verycoolcluster</code> </pre> <br><p> ä¸ºäº†è®¿é—®ç§æœ‰å®¹å™¨ä¸­ä½äºdockerå­˜å‚¨åº“ä¸­çš„dockeræ˜ åƒï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªå¯†é’¥ã€‚ å¦‚æœæ‚¨æœ‰å…¬å¼€çš„å›¾ç‰‡ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ã€‚ </p><br><p> è¦åˆ›å»ºæœºå¯†æ–‡ä»¶ï¼Œå¿…é¡»è¿è¡Œä»¥ä¸‹æ ¼å¼çš„å‘½ä»¤ï¼š </p><br><pre> <code class="plaintext hljs">kubectl create secret docker-registry regcred --docker-server=&lt;your-registry-server&gt; --docker-username=&lt;your-name&gt; --docker-password=&lt;your-pword&gt; --docker-email=&lt;your-email&gt;</code> </pre> <br><p> å¦‚æœæ‚¨çš„æ˜ åƒä½äºdockerå­˜å‚¨åº“ä¸­ï¼Œåˆ™&lt;your-registry-server&gt;çš„å€¼ä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://index.docker.io/v1/</a> </p><br><p> å¯¹äºAzureå®¹å™¨æ³¨å†Œè¡¨ï¼ŒFQDNå°†ä¸º&lt;registry-name&gt; .azurecr.io </p><br><p> ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦ä¸ºæˆ‘çš„å®¹å™¨åˆ›å»ºä¸€ä¸ªç§˜å¯†ï¼Œæˆ‘åšäº†ï¼š </p><br><pre> <code class="plaintext hljs">kubectl create secret docker-registry regcred --docker-server="myservice.azurecr.io" --docker-username="myservice" --docker-password="PJSeyO9=lCMRDI7dGkz68wjhFGRGxSY3" --docker-email="asommer@yandex.ru"</code> </pre> <br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹åˆ›å»ºçš„æœºå¯†æ–‡ä»¶çš„å†…å®¹ï¼š </p><br><pre> <code class="plaintext hljs">kubectl get secret regcred --output=yaml</code> </pre> <br><h1> èµ„è®¯ </h1><br><p> å¦‚æœä½¿ç”¨AKSï¼Œåˆ™ä¸èƒ½åˆ›å»ºæœºå¯†æ–‡ä»¶ï¼Œè€Œå¯ä»¥é€šè¿‡æ‰§è¡Œç‰¹æ®Šè„šæœ¬ä»¥å¦ä¸€ç§æ–¹å¼å‘AKSæœåŠ¡æä¾›å¯¹ACRæœåŠ¡çš„è®¿é—®ã€‚ æ‚¨å¯ä»¥ä»ä»¥ä¸‹é¡µé¢è·å–å®ƒï¼š </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é€šè¿‡Azure Kubernetes Serviceä½¿ç”¨Azureå®¹å™¨æ³¨å†Œè¡¨è¿›è¡Œèº«ä»½éªŒè¯</a> </p><br><pre> <code class="plaintext hljs">#!/bin/bash AKS_RESOURCE_GROUP=KubernetesGroup AKS_CLUSTER_NAME=verycoolcluster ACR_RESOURCE_GROUP=MyACRGroup ACR_NAME=myservice # Get the id of the service principal configured for AKS CLIENT_ID=$(az aks show --resource-group $AKS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --query "servicePrincipalProfile.clientId" --output tsv) # Get the ACR registry resource id ACR_ID=$(az acr show --name $ACR_NAME --resource-group $ACR_RESOURCE_GROUP --query "id" --output tsv) # Create role assignment az role assignment create --assignee $CLIENT_ID --role Reader --scope $ACR_ID</code> </pre> <br><p> æ‚¨å¯ä»¥ç®€å•åœ°ä¿®æ”¹AKS <em>*å’ŒACR</em> *å˜é‡çš„å€¼ï¼Œç„¶åå¤åˆ¶è„šæœ¬å¹¶å°†å…¶ç²˜è´´åˆ°Azure CLIæˆ–Cloud Shellä¸­ã€‚ </p><br><p>  KubernetesåŒ…å«ä¸€ä¸ªå®‰å…¨çš„å‡­è¯å­˜å‚¨ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è®¾ç½®åˆ›å»ºæ–‡ä»¶ï¼Œå¹¶ä¸”å¾ˆéš¾ä»å¤–éƒ¨è®¿é—®è¿™äº›è®¾ç½®ã€‚ è¯¥æ–‡ä»¶é€šå¸¸åŒ…å«æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å’ŒæŸç§ä¿¡ç”¨ã€‚ å¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰æ­¤ç±»ä¿¡æ¯ï¼ˆæ˜¯å—ï¼Ÿï¼‰ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ã€‚ </p><br><p> ä¸ºäº†ä»å‘½ä»¤è¡Œåˆ›å»ºè®¾ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è€ƒè™‘viå‘½ä»¤ã€‚ </p><br><pre> <code class="plaintext hljs">vi &lt; &gt;</code> </pre> <br><p> å¦‚æœæ–‡ä»¶ä¸¢å¤±æˆ–æ‰“å¼€ç°æœ‰æ–‡ä»¶ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ </p><br><p> ä¸ºäº†ä¿å­˜è¾“å…¥çš„æ›´æ”¹ï¼Œè¯·æŒ‰ESCï¼Œç„¶åæŒ‰ZZ </p><br><p> ä¸ºäº†ç®€å•é€€å‡ºè€Œä¸ä¿å­˜ESCï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šqï¼ </p><br><p> ä¸€ä¸ªéå¸¸ç®€çŸ­çš„æè¿°ï¼Œä½†æ˜¯è¶³å¤Ÿäº†ã€‚ æˆ‘å¯ä»¥è¡¥å……ä¸€ç‚¹ï¼ŒInserté”®éå¸¸æœ‰ç”¨ã€‚ </p><br><p> å› æ­¤ï¼Œé€šè¿‡Azure Cloud Shellï¼Œåˆ›å»ºä¸€ä¸ªå…·æœ‰ä»»æ„åç§°ï¼ˆä¾‹å¦‚appsettings.jsonï¼‰å’Œæ‰€éœ€å†…å®¹çš„æ–‡ä»¶ã€‚ è®©æˆ‘ä»¬æ‰¿è®¤è¿™æ ·çš„ï¼š </p><br><pre> <code class="plaintext hljs">{ "ConnectionString": "some secret string goes there" }</code> </pre> <br><p> åœ¨æ‰§è¡Œå‘½ä»¤ä¹‹åï¼š </p><br><pre> <code class="plaintext hljs">kubectl create secret generic secret-appsettings --from-file=/home/youraccount/appsettings.json</code> </pre> <br><p> æ­¤å‘½ä»¤å°†ä½¿ç”¨ç§°ä¸ºsecret-appsettingsçš„è®¾ç½®åˆ›å»ºä¸€ä¸ªç§˜å¯† <br> æ‚¨å¯ä»¥ä½¿ç”¨pwdå‘½ä»¤æ‰¾å‡ºæ›¿æ¢/ home / youraccountçš„è·¯å¾„ </p><br><h2> åˆ›å»ºéƒ¨ç½² </h2><br><p> éƒ¨ç½²æ˜¯é’ˆå¯¹æ— çŠ¶æ€æœåŠ¡çš„ã€‚ å®ƒä»¬æè¿°äº†å¦‚ä½•åˆ›å»ºPodså’ŒReplicaSetï¼Œä»¥åŠå¦‚ä½•æ›´æ–°å®ƒä»¬ã€‚  Podæ˜¯åœ¨ç›¸åŒç¯å¢ƒä¸­å·¥ä½œçš„ä¸€ç»„å®¹å™¨ï¼ˆæˆ–å•ä¸ªå®¹å™¨ï¼‰ã€‚  ReplicaSetçš„ç›®çš„æ˜¯æ§åˆ¶æŒ‡å®šæ•°é‡çš„Podå°†è¢«å¯åŠ¨å¹¶æŒç»­å·¥ä½œã€‚ <br> åŸºäºå…ˆå‰åˆ›å»ºçš„å†…å®¹ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªdeploy.yamlæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åˆ›å»º3ä¸ªå­ç›®å½•ã€‚ è¯¥æ–‡ä»¶åŒ…å«ä»¥ä¸‹ä»£ç ï¼ˆæˆ‘æé†’æ‚¨yamlä¸­çš„ç©ºæ ¼éå¸¸é‡è¦ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">apiVersion: apps/v1beta1 kind: Deployment metadata: name: mydeployment spec: replicas: 3 minReadySeconds: 10 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 maxSurge: 1 template: metadata: labels: app: myapp spec: containers: - name: app image: myservice.azurecr.io/myservice:latest ports: - containerPort: 80 name: http protocol: TCP imagePullPolicy: Always env: - name: "ASPNETCORE_ENVIRONMENT" value: "Production" volumeMounts: - name: secrets mountPath: /app/secrets readOnly: true imagePullSecrets: - name: regcred volumes: - name: secrets secret: secretName: secret-appsettings</code> </pre> <br><p> è€ƒè™‘ä»£ç ã€‚ å¼€å¤´æè¿°äº†å‰¯æœ¬æ•°å’Œæ›´æ–°ç­–ç•¥ã€‚ ç„¶åï¼Œä¸ºéƒ¨ç½²æŒ‡å®šåç§°ï¼ˆmyappï¼‰ï¼Œå¹¶æŒ‡ç¤ºå¯¹å®¹å™¨æ˜ åƒçš„å¼•ç”¨ã€‚ ç«¯å£å·²æ³¨å†Œã€‚  80æ˜¯httpçš„æ ‡å‡†ç«¯å£ã€‚ æ¥ä¸‹æ¥æ˜¯ASP.NET Coreç¯å¢ƒè®¾ç½®ã€‚ ç„¶åå®‰è£…ç§æœ‰dockeræ˜ åƒçš„ä¿¡èª‰å’Œæˆ‘ä»¬æœ€è¿‘åˆ›å»ºçš„ç§˜å¯†åº”ç”¨ç¨‹åºè®¾ç½®ã€‚ </p><br><pre> <code class="plaintext hljs"> strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 maxSurge: 1</code> </pre> <br><p> è¿™ä¸€éƒ¨åˆ†è´Ÿè´£å‡çº§è¿‡ç¨‹ã€‚  maxSurge-æ›´æ–°æ—¶åˆ›å»ºçš„ç‚‰è†›æ•°é‡è¶…å‡ºç°æœ‰ç‚‰è†›æ•°é‡ï¼ˆä»¥å•ä½æˆ–ç™¾åˆ†æ¯”ä¸ºå•ä½ï¼‰ã€‚  maxUnavailable-åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å¯èƒ½æ— æ³•ä½¿ç”¨çš„ç‚‰åºŠçš„æœ€å¤§æ•°é‡ã€‚ <br> å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºéƒ¨ç½²ï¼š </p><br><pre> <code class="plaintext hljs">kubectl apply -f deploy.yaml</code> </pre> <br><h2> è®¤è¯†å…¥å£ </h2><br><p> ä¸ºäº†æä¾›å¯¹ç¾¤é›†æœåŠ¡çš„è®¿é—®å¹¶ç»„ç»‡è´Ÿè½½å¹³è¡¡ï¼Œä½¿ç”¨äº†ç§°ä¸ºå…¥å£çš„æœåŠ¡ã€‚ ä¸€ä¸ªæ¯”è¾ƒæµè¡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯åŸºäºnginxçš„å…¥å£ã€‚ å®‰è£…å®ƒçš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ç§°ä¸ºhelmçš„Kubernetesè½¯ä»¶åŒ…ç®¡ç†å™¨ã€‚  Azure Cloud Shellçš„ä¼˜åŠ¿åœ¨äºå·²ç»åœ¨å…¶ä¸­å®‰è£…äº†å¤´ç›”ã€‚ è¦å®‰è£…nginx-ingressï¼Œè¿˜éœ€è¦åšäº›ä»€ä¹ˆã€‚ è¾“å…¥ï¼š </p><br><pre> <code class="plaintext hljs">helm init</code> </pre> <br><p> ç­‰ä¸€ä¸‹ç„¶åæ‰§è¡Œï¼š </p><br><pre> <code class="plaintext hljs">helm install stable/nginx-ingress --namespace kube-system --set rbac.create=false</code> </pre> <br><h2> ä½¿ç”¨LetsEncryptåˆ›å»ºSSLè¯ä¹¦ </h2><br><p> ç”±äºSSLè¯ä¹¦ç»‘å®šåˆ°æŸäº›åŸŸåï¼Œå› æ­¤æˆ‘ä»¬å°†è®¾ç½®DNSèµ„æºåç§°ã€‚ </p><br><p> è¿è¡Œä»¥ä¸‹å‘½ä»¤å¹¶è·å–å¤–éƒ¨IP </p><br><pre> <code class="plaintext hljs">kubectl get service -l app=nginx-ingress --namespace kube-system</code> </pre> <br><p> åœ¨ä»¥ä¸‹è„šæœ¬ä¸­ç”¨IPå’Œæˆ‘ä»¬ä¸ºå­åŸŸå‘æ˜çš„åç§° </p><br><pre> <code class="plaintext hljs">#!/bin/bash # Public IP address of your ingress controller IP="168.63.19.2" # Name to associate with public IP address DNSNAME="myservice-ingress" # Get the resource-id of the public ip PUBLICIPID=$(az network public-ip list --query "[?ipAddress!=null]|[?contains(ipAddress, '$IP')].[id]" --output tsv) # Update public ip address with DNS name az network public-ip update --ids $PUBLICIPID --dns-name $DNSNAME</code> </pre> <br><p> æˆ‘ä»¬åªéœ€å¤åˆ¶æ­¤è„šæœ¬ï¼Œç„¶åå°†å…¶ç²˜è´´åˆ°å‘½ä»¤è¡Œä¸­å¹¶ä»¥è¿™ç§æ–¹å¼æ‰§è¡Œå³å¯ã€‚ ä½œä¸ºå­åŸŸçš„åç§°ï¼Œæˆ‘è®¾ç½®äº†ä¸€ä¸ªéå¸¸â€œåŸå§‹â€çš„åç§°-myservice-ingress </p><br><p> é€šè¿‡å°†ä»¥ä¸‹è„šæœ¬å¤åˆ¶å¹¶ç²˜è´´åˆ°å‘½ä»¤è¡Œä¸­ï¼Œä»¥ç›¸åŒçš„æ–¹å¼å®‰è£…è¯ä¹¦ç®¡ç†å™¨ã€‚ åœ¨è¿™é‡Œï¼Œç”šè‡³æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„éœ€è¦æ”¹å˜ã€‚ </p><br><pre> <code class="plaintext hljs">helm install \ --name cert-manager \ --namespace kube-system \ stable/cert-manager \ --set ingressShim.defaultIssuerName=letsencrypt-prod \ --set ingressShim.defaultIssuerKind=ClusterIssuer \ --set rbac.create=false \ --set serviceAccount.create=false</code> </pre> <br><h1> èµ„è®¯ </h1><br><p> å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰RBACçš„é›†ç¾¤ï¼Œé‚£ä¹ˆè„šæœ¬å°†æœ‰æ‰€ä¸åŒã€‚ </p><br><pre> <code class="plaintext hljs">helm install stable/cert-manager --set ingressShim.defaultIssuerName=letsencrypt-staging --set ingressShim.defaultIssuerKind=ClusterIssuer</code> </pre> <br><p> å¦‚æœè¯ä¹¦æ–‡ä»¶å¯ç”¨ï¼Œåˆ™å¯ä»¥å°†å…¶æ·»åŠ å¦‚ä¸‹ï¼š </p><br><pre> <code class="plaintext hljs">kubectl create secret tls tls-secret --cert CERT.crt --key KEY-FOR-CERT.key</code> </pre> <br><p> ä½†æ˜¯ï¼Œç”±äºæˆ‘ä»¬æ²¡æœ‰ç­¾åçš„CAè¯ä¹¦ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»ç”¨é“ƒé¼“è·³èˆä¸€äº›ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨åä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">LetsEncrypt</a>çš„å…è´¹æœåŠ¡åˆ›å»ºä¸€ä¸ªCAã€‚  LetsEncryptæ˜¯ä¸€ä¸ªå…è´¹é¢å‘è¯ä¹¦çš„è¯ä¹¦é¢å‘æœºæ„ã€‚ è¿™æ ·ä¸€ä¸ªæ— ç§çš„ç»„ç»‡ï¼Œå…¶ç›®æ ‡æ˜¯ä¿æŠ¤Internetã€‚ </p><br><p> å› æ­¤ï¼Œåˆ›å»ºcluster-issuer.yamlæ–‡ä»¶ï¼Œå…¶ä¸­æè¿°äº†é¢å‘è¯ä¹¦çš„ç»„ç»‡ã€‚ </p><br><pre> <code class="plaintext hljs">apiVersion: certmanager.k8s.io/v1alpha1 kind: ClusterIssuer metadata: name: letsencrypt-prod spec: acme: server: https://acme-v02.api.letsencrypt.org/directory email: youeemail@yourdomain.ru privateKeySecretRef: name: letsencrypt-prod http01: {}</code> </pre> <br><p> æ‚¨åªéœ€è¦ç”¨æ‚¨çš„åœ°å€æ›¿æ¢ç”µå­é‚®ä»¶ï¼Œå°±å¯ä»¥ï¼š </p><br><pre> <code class="plaintext hljs">kubectl apply -f cluster-issuer.yaml</code> </pre> <br><p> ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºcertificate.yamlè¯ä¹¦æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æŒ‡å®šåˆ›å»ºçš„ClusterIssuerçš„åç§°ä»¥åŠè¯¥è¯ä¹¦æ‰“ç®—ä½¿ç”¨çš„åŸŸ-myservice-ingress.westeurope.cloudapp.azure.com </p><br><pre> <code class="plaintext hljs">apiVersion: certmanager.k8s.io/v1alpha1 kind: Certificate metadata: name: tls-prod-secret spec: secretName: tls-prod-secret dnsNames: - myservice-ingress.westeurope.cloudapp.azure.com acme: config: - http01: ingressClass: nginx domains: - myservice-ingress.westeurope.cloudapp.azure.com issuerRef: name: letsencrypt-prod kind: ClusterIssuer</code> </pre> <br><p> æˆ‘ä»¬æ‰§è¡Œï¼š </p><br><pre> <code class="plaintext hljs">kubectl apply -f certificate.yaml</code> </pre> <br><h2> æœåŠ¡åˆ›å»ºå’Œå…¥å£ </h2><br><p>  Kuberneteså¯ä»¥åˆ›å»ºå››ç§ä¸åŒç±»å‹çš„æœåŠ¡ã€‚ <br> é»˜è®¤æœåŠ¡æ˜¯ClusterIPã€‚ ä»…å¯ä»¥é€šè¿‡å†…éƒ¨IPä»ç¾¤é›†è®¿é—®æ­¤æœåŠ¡ã€‚ </p><br><p>  NodePortè‡ªåŠ¨åˆ›å»ºClusterIPæœåŠ¡ã€‚ å¯ä»¥é€šè¿‡ä»¥ä¸‹é€”å¾„ä»å¤–éƒ¨è®¿é—®NodePortï¼š <br></p><p> é€šè¿‡LoadBalancerè´Ÿè½½å¹³è¡¡å™¨å¯ä»¥ä»å¤–éƒ¨è®¿é—®æœåŠ¡ï¼Œä»è€Œè‡ªåŠ¨åˆ›å»ºNodePortå’ŒClusterIPæœåŠ¡ã€‚ </p><br><p>  ExternalNameå°†æœåŠ¡ä¸å¤–éƒ¨åç§°å…³è”ã€‚ </p><br><p> åŸºæœ¬æœåŠ¡è¶³ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼š </p><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: Service metadata: name: myservice spec: type: ClusterIP ports: - port: 80 name: http targetPort: http selector: app: myapp</code> </pre> <br><p> ä½¿ç”¨é€‰æ‹©å™¨çš„å€¼ï¼Œæˆ‘ä»¬æŒ‡ç¤ºéƒ¨ç½²çš„åç§°ã€‚ <br> å‰©ä¸‹çš„å°±æ˜¯åˆ›å»ºæœåŠ¡ </p><br><pre> <code class="plaintext hljs">kubectl apply -f service.yaml</code> </pre> <br><p> æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå…¥å£ï¼Œåœ¨æœ¬æ–‡ä¸­æˆ‘å·²ç»å‘æ‚¨ä»‹ç»äº†ä¸€ç‚¹ã€‚ åœ¨yamlä¸­ï¼Œæˆ‘ä»¬å°†æŒ‡å®šcluster-issuerçš„åç§°å’Œè¯ä¹¦ã€‚ æˆ‘ä»¬ä¹‹å‰åˆ›å»ºäº†å®ƒä»¬ã€‚ </p><br><pre> <code class="plaintext hljs">apiVersion: extensions/v1beta1 kind: Ingress metadata: name: myingress annotations: kubernetes.io/ingress.class: nginx certmanager.k8s.io/cluster-issuer: letsencrypt-prod nginx.ingress.kubernetes.io/rewrite-target: / spec: tls: - hosts: - myservice-ingress.westeurope.cloudapp.azure.com secretName: tls-prod-secret rules: - host: myservice-ingress.westeurope.cloudapp.azure.com http: paths: - path: / backend: serviceName: myservice servicePort: 80</code> </pre> <br><p> ä½¿ç”¨ç›¸åŒçš„kubectl applyå‘½ä»¤åˆ›å»ºå…¥å£åçš„ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬çš„å¾®æœåŠ¡åº”å¯åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://myservice-ingress.westeurope.cloudapp.azure.comä¸Šä½¿ç”¨</a> ã€‚ é€šè¿‡å•å‡»æµè§ˆå™¨åœ°å€æ ä¸Šhttpsæ—è¾¹çš„é”ï¼Œå¯ä»¥éªŒè¯è¯ä¹¦æ˜¯å¦æœ‰æ•ˆå¹¶ç”±CAé¢å‘ã€‚ </p><br><img src="https://habrastorage.org/webt/kj/e2/gz/kje2gzpczlirmrm5fpmnjigkcxc.png"><br><br> æˆ‘ä»¬æé†’æ‚¨ï¼Œè¿™æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ã€Šé»‘å®¢ã€‹æ‚å¿—ä¸Šæ–‡ç« </a>çš„å®Œæ•´ç‰ˆã€‚ å®ƒçš„ä½œè€…æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é˜¿åˆ—å…‹è°¢Â·ç´¢é»˜</a> ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Alexey Sommerï¼‰</a> ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN435870/">https://habr.com/ru/post/zh-CN435870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN435858/index.html">å…·æœ‰æ—¶é—´åŒæ­¥åŠŸèƒ½çš„å¯ç¼–ç¨‹ç¡¬ä»¶TOTPå¯†é’¥</a></li>
<li><a href="../zh-CN435862/index.html">æ¶ˆè´¹ç”µå­äº§å“åäººå ‚ï¼šæœ€è¿‘50å¹´æœ€ä½³äº§å“çš„æ•…äº‹ï¼Œç¬¬4éƒ¨åˆ†</a></li>
<li><a href="../zh-CN435864/index.html">æ˜ å°„Nettyçš„è¯·æ±‚</a></li>
<li><a href="../zh-CN435866/index.html">å‘å¸ƒITï¼šä½œä¸ºSXSW 2019éŸ³ä¹èŠ‚çš„ä¸€éƒ¨åˆ†æ¨å‡ºäº§å“å’ŒæœåŠ¡çš„æ–°å¹³å°</a></li>
<li><a href="../zh-CN435868/index.html">Slush 2018.é¢„è§ˆæ—¥</a></li>
<li><a href="../zh-CN435872/index.html">Zigç¼–ç¨‹è¯­è¨€</a></li>
<li><a href="../zh-CN435876/index.html">Firefoxæµè§ˆå™¨çš„è¯¦ç»†è®¾ç½®</a></li>
<li><a href="../zh-CN435878/index.html">ä¸šä½™å¼€æº-3å¹´çš„ç»éªŒæ•™è®­</a></li>
<li><a href="../zh-CN435880/index.html">æ— éœ€é•¿é”å³å¯æ›´æ”¹PostgreSQLè¡¨çš„æ¶æ„ã€‚ Yandexè®²åº§</a></li>
<li><a href="../zh-CN435882/index.html">å°ç±³Mi Box Sè¯„æµ‹å’Œä¸Mi Box 3çš„æ¯”è¾ƒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>