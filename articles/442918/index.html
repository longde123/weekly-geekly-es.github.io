<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöø üìñ üêö Gu√≠a para implementar modelos de aprendizaje autom√°tico en un entorno de producci√≥n como API utilizando Flask üî† üë©üèº‚Äçüç≥ üë©üèæ‚Äçü§ù‚Äçüë©üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Amigos, a finales de marzo estamos lanzando una nueva transmisi√≥n en el curso "Data Scientist" . Y en este momento, estamos comenzando a compartir mat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gu√≠a para implementar modelos de aprendizaje autom√°tico en un entorno de producci√≥n como API utilizando Flask</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/442918/">  Amigos, a finales de marzo estamos lanzando una nueva transmisi√≥n en el curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Data Scientist"</a> .  Y en este momento, estamos comenzando a compartir material √∫til sobre el curso con usted. <br><br>  <b>Introduccion</b> <br><br>  Recordando la experiencia temprana de mi pasi√≥n por el aprendizaje autom√°tico (ML), puedo decir que se hizo un gran esfuerzo para construir un modelo realmente bueno.  Consult√© con expertos en este campo para comprender c√≥mo mejorar mi modelo, pens√© en las funciones necesarias, trat√© de asegurarme de que se tuvieran en cuenta todos los consejos que propusieron.  Pero a√∫n as√≠ me encontr√© con un problema. <br><br>  ¬øC√≥mo implementar el modelo en un proyecto real?  No ten√≠a ideas sobre este puntaje.  Toda la literatura que estudi√© hasta este punto se centr√≥ solo en mejorar los modelos.  No vi el siguiente paso en su desarrollo. <br><br><img src="https://habrastorage.org/webt/dp/dc/yl/dpdcylcyxdnyzfasmeoxefjf-e8.png"><br><br>  Es por eso que estoy escribiendo esta gu√≠a ahora.  Quiero que enfrentes el problema que encontr√© en mi tiempo, pero pude resolverlo r√°pidamente.  Hacia el final de este art√≠culo, le mostrar√© c√≥mo implementar un modelo de aprendizaje autom√°tico utilizando el marco Flask en Python. <a name="habracut"></a><br><br>  <b>Contenido</b> <br><br><ol><li>  Opciones de implementaci√≥n para modelos de aprendizaje autom√°tico. </li><li>  ¬øQu√© es una API? </li><li>  Instalaci√≥n del entorno Python e informaci√≥n b√°sica sobre Flask. </li><li>  Crear un modelo de aprendizaje autom√°tico. </li><li>  Guardar modelos de aprendizaje autom√°tico: serializaci√≥n y deserializaci√≥n. </li><li>  Crear una API usando Flask. </li></ol><br>  <b>Opciones de implementaci√≥n para modelos de aprendizaje autom√°tico.</b> <b><br></b> <br>  En la mayor√≠a de los casos, el uso real de modelos de aprendizaje autom√°tico es una parte central del desarrollo, incluso si es solo un peque√±o componente de un sistema automatizado de distribuci√≥n de correo electr√≥nico o chatbot.  A veces hay momentos en que las barreras para la implementaci√≥n parecen insuperables. <br><br>  Por ejemplo, la mayor√≠a de los especialistas en ML utilizan R o Python para su investigaci√≥n cient√≠fica.  Sin embargo, los ingenieros de software que usan una pila de tecnolog√≠a completamente diferente ser√°n consumidores de estos modelos.  Hay dos opciones que pueden resolver este problema: <br><br>  <b>Opci√≥n 1: vuelva a escribir todo el c√≥digo en el idioma con el que trabajan los ingenieros de desarrollo.</b>  Suena l√≥gico, pero lleva mucho tiempo y esfuerzo replicar los modelos desarrollados.  Al final, resulta solo una p√©rdida de tiempo.  La mayor√≠a de los lenguajes, como JavaScript, no tienen bibliotecas convenientes para trabajar con ML.  Por lo tanto, ser√° una soluci√≥n racional no utilizar esta opci√≥n. <br><br>  <b>Opci√≥n 2: usar la API.</b>  Las API de red resolvieron el problema de trabajar con aplicaciones en diferentes idiomas.  Si el desarrollador front-end necesita usar su modelo de aprendizaje autom√°tico para crear una aplicaci√≥n web sobre la base, solo necesita obtener la URL del servidor de destino que discute la API. <br><br>  <b>¬øQu√© es una API?</b> <br><br>  En palabras simples, la API (Application Programming Interface) es un tipo de contrato entre dos programas, que dice que si un programa de usuario proporciona datos de entrada en un formato espec√≠fico, el programa desarrollador (API) los pasa a trav√©s de s√≠ mismo y proporciona al usuario datos de salida. <br><br>  Podr√° leer un par de art√≠culos por su cuenta, que describen bien por qu√© la API es una opci√≥n bastante popular entre los desarrolladores. <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Historial de API</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Introducci√≥n a la API</a> </li></ul><br>  La mayor√≠a de los grandes proveedores de servicios en la nube y las empresas m√°s peque√±as y centradas en el aprendizaje autom√°tico proporcionan API listas para usar.  Satisfacen las necesidades de los desarrolladores que no entienden el aprendizaje autom√°tico, pero desean integrar esta tecnolog√≠a en sus soluciones. <br><br>  Por ejemplo, uno de estos proveedores de API es Google con su <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API de Google Vision</a> . <br><br>  Todo lo que el desarrollador debe hacer es simplemente llamar a la API REST (Representational State Transfer) utilizando el SDK proporcionado por Google.  Vea lo que puede hacer con la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API de Google Vision</a> . <br><br>  Suena genial, ¬øverdad?  En este art√≠culo, descubriremos c√≥mo crear su propia API utilizando Flask, un marco de Python. <br><br>  <i><b>Nota</b></i> : Flask no es el √∫nico marco de red para este prop√≥sito.  Tambi√©n hay Django, Falcon, Hug y muchos otros que no se mencionan en este art√≠culo.  Por ejemplo, para R hay un paquete llamado <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fontanero</a></i> <br><br>  <b>Instalaci√≥n del entorno Python e informaci√≥n b√°sica sobre Flask.</b> <br><br>  <b>1) Crear un entorno virtual usando Anaconda.</b>  Si necesita crear su propio entorno virtual para Python y mantener el estado de dependencias necesario, Anaconda ofrece buenas soluciones para esto.  A continuaci√≥n funcionar√° con la l√≠nea de comando. <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠</a> encontrar√°s el instalador de <i>miniconda</i> para Python; </li><li><code>wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh</code> </li> <li> <code>bash Miniconda3-latest-Linux-x86_64.sh</code> </li> <li>  Sigue la secuencia de preguntas. </li><li> <code>source .bashrc</code> </li> <li>  Si escribe: <code>conda</code> , puede ver una lista de comandos disponibles y ayuda. </li><li>  Para crear un nuevo entorno, escriba: <code>conda create --name &lt;environment-name&gt; python=3.6</code> </li><li>  Siga los pasos que se le pedir√° que haga y al final ingrese: <code>source activate &lt;environment-name&gt;</code> </li><li>  Instale los paquetes Python requeridos.  Los m√°s importantes son <i>frasco</i> y <i>gunicorn.</i> </li></ul><br>  <b>2) Intentaremos crear nuestra sencilla aplicaci√≥n Flask "Hello world" usando <i>gunicorn</i> .</b> <br><br><ul><li>  Abra su editor de texto favorito y cree el archivo <code>hello-world.py</code> en la carpeta </li><li>  Escribe el siguiente c√≥digo: </li></ul><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Filename: hello-world.py """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask app = Flask(__name__) @app.route(<span class="hljs-string"><span class="hljs-string">'/users/&lt;string:username&gt;'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello_world</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(username=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello {}!"</span></span>.format(username))</code> </pre> <br><ul><li>  Guarde el archivo y regrese a la terminal. </li><li>  Para iniciar la API, ejecute en la terminal: <code>gunicorn --bind 0.0.0.0:8000 hello-world:app</code> </li><li>  Si obtiene lo siguiente, entonces est√° en el camino correcto: </li></ul><br><img src="https://habrastorage.org/webt/fl/69/hj/fl69hjmljbp5ezgivwxa6o-b73k.jpeg"><br><br><ul><li>  En el navegador, ingrese lo siguiente: <code>https://localhost:8000/users/any-name</code> <br></li></ul><br><img src="https://habrastorage.org/webt/8i/gj/v-/8igjv-h34rhxj6rie9rbffgdda8.jpeg"><br><br>  ¬°Hurra!  ¬°Escribiste tu primer programa Flask!  Como ya tiene cierta experiencia con estos sencillos pasos, podemos crear puntos finales de red a los que se pueda acceder localmente. <br><br>  Usando Flask podemos envolver nuestros modelos y usarlos como una API web.  Si queremos crear aplicaciones de red m√°s complejas (por ejemplo, en JavaScript), debemos agregar algunos cambios. <br><br>  <b>Crear un modelo de aprendizaje autom√°tico.</b> <br><br><ul><li>  Para comenzar, echemos un vistazo a la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">competencia de</a> aprendizaje autom√°tico de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Competencia de predicci√≥n de pr√©stamos</a> .  El objetivo principal es establecer una tuber√≠a de preprocesamiento y crear modelos ML para facilitar la tarea de predicci√≥n durante la implementaci√≥n. </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.externals <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> joblib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.model_selection <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> train_test_split, GridSearchCV <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.base <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BaseEstimator, TransformerMixin <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.ensemble <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RandomForestClassifier <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.pipeline <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> make_pipeline <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> warnings warnings.filterwarnings(<span class="hljs-string"><span class="hljs-string">"ignore"</span></span>)</code> </pre> <br><ul><li>  Guarde el conjunto de datos en la carpeta: </li></ul><br><pre> <code class="python hljs">!ls /home/pratos/Side-Project/av_articles/flask_api/data/</code> </pre> <br><pre> <code class="python hljs">test.csv training.csv</code> </pre> <br><pre> <code class="python hljs">data = pd.read_csv(<span class="hljs-string"><span class="hljs-string">'../data/training.csv'</span></span>)</code> </pre> <br><pre> <code class="python hljs">list(data.columns)</code> </pre> <br><pre> <code class="python hljs">[<span class="hljs-string"><span class="hljs-string">'Loan_ID'</span></span>, <span class="hljs-string"><span class="hljs-string">'Gender'</span></span>, <span class="hljs-string"><span class="hljs-string">'Married'</span></span>, <span class="hljs-string"><span class="hljs-string">'Dependents'</span></span>, <span class="hljs-string"><span class="hljs-string">'Education'</span></span>, <span class="hljs-string"><span class="hljs-string">'Self_Employed'</span></span>, <span class="hljs-string"><span class="hljs-string">'ApplicantIncome'</span></span>, <span class="hljs-string"><span class="hljs-string">'CoapplicantIncome'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoanAmount'</span></span>, <span class="hljs-string"><span class="hljs-string">'Loan_Amount_Term'</span></span>, <span class="hljs-string"><span class="hljs-string">'Credit_History'</span></span>, <span class="hljs-string"><span class="hljs-string">'Property_Area'</span></span>, <span class="hljs-string"><span class="hljs-string">'Loan_Status'</span></span>]</code> </pre> <br><pre> <code class="python hljs">data.shape</code> </pre> <br><br><pre> <code class="python hljs">(<span class="hljs-number"><span class="hljs-number">614</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>)</code> </pre>  ul&gt; <br>  Encuentre los valores nulo / Nan en las columnas: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data.columns: print(<span class="hljs-string"><span class="hljs-string">"The number of null values in:{} == {}"</span></span>.format(_, data[_].isnull().sum()))</code> </pre> <br><br><pre> <code class="python hljs">The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Loan_ID == <span class="hljs-number"><span class="hljs-number">0</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Gender == <span class="hljs-number"><span class="hljs-number">13</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Married == <span class="hljs-number"><span class="hljs-number">3</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Dependents == <span class="hljs-number"><span class="hljs-number">15</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Education == <span class="hljs-number"><span class="hljs-number">0</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Self_Employed == <span class="hljs-number"><span class="hljs-number">32</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:ApplicantIncome == <span class="hljs-number"><span class="hljs-number">0</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:CoapplicantIncome == <span class="hljs-number"><span class="hljs-number">0</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:LoanAmount == <span class="hljs-number"><span class="hljs-number">22</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Loan_Amount_Term == <span class="hljs-number"><span class="hljs-number">14</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Credit_History == <span class="hljs-number"><span class="hljs-number">50</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Property_Area == <span class="hljs-number"><span class="hljs-number">0</span></span> The number of null values <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Loan_Status == <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><ul><li>  El siguiente paso es crear conjuntos de datos para capacitaci√≥n y pruebas: </li></ul><br><pre> <code class="python hljs">red_var = [<span class="hljs-string"><span class="hljs-string">'Gender'</span></span>,<span class="hljs-string"><span class="hljs-string">'Married'</span></span>,<span class="hljs-string"><span class="hljs-string">'Dependents'</span></span>,<span class="hljs-string"><span class="hljs-string">'Education'</span></span>,<span class="hljs-string"><span class="hljs-string">'Self_Employed'</span></span>,<span class="hljs-string"><span class="hljs-string">'ApplicantIncome'</span></span>,<span class="hljs-string"><span class="hljs-string">'CoapplicantIncome'</span></span>,\ <span class="hljs-string"><span class="hljs-string">'LoanAmount'</span></span>,<span class="hljs-string"><span class="hljs-string">'Loan_Amount_Term'</span></span>,<span class="hljs-string"><span class="hljs-string">'Credit_History'</span></span>,<span class="hljs-string"><span class="hljs-string">'Property_Area'</span></span>] X_train, X_test, y_train, y_test = train_test_split(data[pred_var], data[<span class="hljs-string"><span class="hljs-string">'Loan_Status'</span></span>], \ test_size=<span class="hljs-number"><span class="hljs-number">0.25</span></span>, random_state=<span class="hljs-number"><span class="hljs-number">42</span></span>)</code> </pre> <br><ul><li>  Para asegurarnos de que todos los pasos de preprocesamiento se completen correctamente, incluso despu√©s de que hayamos experimentado, y no nos hayamos perdido nada durante la predicci√≥n, crearemos nuestro propio evaluador de Scikit-learn para preprocesamiento (estimador de pre-procesamiento de Scikit-learn) . </li></ul><br>  Para entender c√≥mo lo creamos, lea lo <a href="">siguiente</a> . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.base <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BaseEstimator, TransformerMixin <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreProcessing</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseEstimator, TransformerMixin)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Custom Pre-Processing estimator for our use-case """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, df)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Regular transform() that is a help for training, validation &amp; testing datasets (NOTE: The operations performed here are the ones that we did prior to this cell) """</span></span> pred_var = [<span class="hljs-string"><span class="hljs-string">'Gender'</span></span>,<span class="hljs-string"><span class="hljs-string">'Married'</span></span>,<span class="hljs-string"><span class="hljs-string">'Dependents'</span></span>,<span class="hljs-string"><span class="hljs-string">'Education'</span></span>,<span class="hljs-string"><span class="hljs-string">'Self_Employed'</span></span>,<span class="hljs-string"><span class="hljs-string">'ApplicantIncome'</span></span>,\ <span class="hljs-string"><span class="hljs-string">'CoapplicantIncome'</span></span>,<span class="hljs-string"><span class="hljs-string">'LoanAmount'</span></span>,<span class="hljs-string"><span class="hljs-string">'Loan_Amount_Term'</span></span>,<span class="hljs-string"><span class="hljs-string">'Credit_History'</span></span>,<span class="hljs-string"><span class="hljs-string">'Property_Area'</span></span>] df = df[pred_var] df[<span class="hljs-string"><span class="hljs-string">'Dependents'</span></span>] = df[<span class="hljs-string"><span class="hljs-string">'Dependents'</span></span>].fillna(<span class="hljs-number"><span class="hljs-number">0</span></span>) df[<span class="hljs-string"><span class="hljs-string">'Self_Employed'</span></span>] = df[<span class="hljs-string"><span class="hljs-string">'Self_Employed'</span></span>].fillna(<span class="hljs-string"><span class="hljs-string">'No'</span></span>) df[<span class="hljs-string"><span class="hljs-string">'Loan_Amount_Term'</span></span>] = df[<span class="hljs-string"><span class="hljs-string">'Loan_Amount_Term'</span></span>].fillna(self.term_mean_) df[<span class="hljs-string"><span class="hljs-string">'Credit_History'</span></span>] = df[<span class="hljs-string"><span class="hljs-string">'Credit_History'</span></span>].fillna(<span class="hljs-number"><span class="hljs-number">1</span></span>) df[<span class="hljs-string"><span class="hljs-string">'Married'</span></span>] = df[<span class="hljs-string"><span class="hljs-string">'Married'</span></span>].fillna(<span class="hljs-string"><span class="hljs-string">'No'</span></span>) df[<span class="hljs-string"><span class="hljs-string">'Gender'</span></span>] = df[<span class="hljs-string"><span class="hljs-string">'Gender'</span></span>].fillna(<span class="hljs-string"><span class="hljs-string">'Male'</span></span>) df[<span class="hljs-string"><span class="hljs-string">'LoanAmount'</span></span>] = df[<span class="hljs-string"><span class="hljs-string">'LoanAmount'</span></span>].fillna(self.amt_mean_) gender_values = {<span class="hljs-string"><span class="hljs-string">'Female'</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'Male'</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>} married_values = {<span class="hljs-string"><span class="hljs-string">'No'</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'Yes'</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>} education_values = {<span class="hljs-string"><span class="hljs-string">'Graduate'</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'Not Graduate'</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>} employed_values = {<span class="hljs-string"><span class="hljs-string">'No'</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'Yes'</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>} property_values = {<span class="hljs-string"><span class="hljs-string">'Rural'</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'Urban'</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'Semiurban'</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>} dependent_values = {<span class="hljs-string"><span class="hljs-string">'3+'</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'0'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'2'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>} df.replace({<span class="hljs-string"><span class="hljs-string">'Gender'</span></span>: gender_values, <span class="hljs-string"><span class="hljs-string">'Married'</span></span>: married_values, <span class="hljs-string"><span class="hljs-string">'Education'</span></span>: education_values, \ <span class="hljs-string"><span class="hljs-string">'Self_Employed'</span></span>: employed_values, <span class="hljs-string"><span class="hljs-string">'Property_Area'</span></span>: property_values, \ <span class="hljs-string"><span class="hljs-string">'Dependents'</span></span>: dependent_values}, inplace=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> df.as_matrix() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, df, y=None, **fit_params)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Fitting the Training dataset &amp; calculating the required values from train eg: We will need the mean of X_train['Loan_Amount_Term'] that will be used in transformation of X_test """</span></span> self.term_mean_ = df[<span class="hljs-string"><span class="hljs-string">'Loan_Amount_Term'</span></span>].mean() self.amt_mean_ = df[<span class="hljs-string"><span class="hljs-string">'LoanAmount'</span></span>].mean() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self</code> </pre> <br><ul><li>  Convierta <code>y_train</code> y <code>y_test</code> en <code>np.array</code> : </li></ul><br><pre> <code class="python hljs">y_train = y_train.replace({<span class="hljs-string"><span class="hljs-string">'Y'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'N'</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}).as_matrix() y_test = y_test.replace({<span class="hljs-string"><span class="hljs-string">'Y'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'N'</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}).as_matrix()</code> </pre> <br>  Creemos una tuber√≠a para asegurarnos de que todos los pasos de preprocesamiento que hacemos son el trabajo del evaluador de scikit-learn. <br><br><pre> <code class="python hljs">pipe = make_pipeline(PreProcessing(), RandomForestClassifier())</code> </pre> <br><pre> <code class="python hljs">pipe</code> </pre> <br><pre> <code class="python hljs">Pipeline(memory=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, steps=[(<span class="hljs-string"><span class="hljs-string">'preprocessing'</span></span>, PreProcessing()), (<span class="hljs-string"><span class="hljs-string">'randomforestclassifier'</span></span>, RandomForestClassifier(bootstrap=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, class_weight=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, criterion=<span class="hljs-string"><span class="hljs-string">'gini'</span></span>, max_depth=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, max_features=<span class="hljs-string"><span class="hljs-string">'auto'</span></span>, max_leaf_nodes=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, min_impurity_decrease=<span class="hljs-number"><span class="hljs-number">0.0</span></span>, min_impurity_split=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, min_samples_leaf=<span class="hljs-number"><span class="hljs-number">1</span></span>, min_samples_split=<span class="hljs-number"><span class="hljs-number">2</span></span>, min_weight_fraction_leaf=<span class="hljs-number"><span class="hljs-number">0.0</span></span>, n_estimators=<span class="hljs-number"><span class="hljs-number">10</span></span>, n_jobs=<span class="hljs-number"><span class="hljs-number">1</span></span>, oob_score=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, random_state=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">0</span></span>, warm_start=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>))])</code> </pre> <br>  Para buscar hiperpar√°metros adecuados (grado para objetos polinomiales y alfa para un borde), haremos una b√∫squeda de cuadr√≠cula (B√∫squeda de cuadr√≠cula): <br><br><ul><li>  Defina param_grid: </li></ul><br><pre> <code class="python hljs">param_grid = {<span class="hljs-string"><span class="hljs-string">"randomforestclassifier__n_estimators"</span></span> : [<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>], <span class="hljs-string"><span class="hljs-string">"randomforestclassifier__max_depth"</span></span> : [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>], <span class="hljs-string"><span class="hljs-string">"randomforestclassifier__max_leaf_nodes"</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>], <span class="hljs-string"><span class="hljs-string">"randomforestclassifier__min_impurity_split"</span></span>: [<span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.2</span></span>, <span class="hljs-number"><span class="hljs-number">0.3</span></span>]}</code> </pre> <br><ul><li>  Inicia la b√∫squeda de cuadr√≠cula: </li></ul><br><pre> <code class="python hljs">grid = GridSearchCV(pipe, param_grid=param_grid, cv=<span class="hljs-number"><span class="hljs-number">3</span></span>)</code> </pre> <br><ul><li>  Ajustamos los datos de entrenamiento para el estimador de tuber√≠a: </li></ul><br><pre> <code class="python hljs">grid.fit(X_train, y_train)</code> </pre> <br><pre> <code class="python hljs">GridSearchCV(cv=<span class="hljs-number"><span class="hljs-number">3</span></span>, error_score=<span class="hljs-string"><span class="hljs-string">'raise'</span></span>, estimator=Pipeline(memory=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, steps=[(<span class="hljs-string"><span class="hljs-string">'preprocessing'</span></span>, PreProcessing()), (<span class="hljs-string"><span class="hljs-string">'randomforestclassifier'</span></span>, RandomForestClassifier(bootstrap=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, class_weight=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, criterion=<span class="hljs-string"><span class="hljs-string">'gini'</span></span>, max_depth=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, max_features=<span class="hljs-string"><span class="hljs-string">'auto'</span></span>, max_leaf_nodes=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, min_impurity_decrease=<span class="hljs-number"><span class="hljs-number">0.0</span></span>, min_impu..._jobs=<span class="hljs-number"><span class="hljs-number">1</span></span>, oob_score=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, random_state=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">0</span></span>, warm_start=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>))]), fit_params=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, iid=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, n_jobs=<span class="hljs-number"><span class="hljs-number">1</span></span>, param_grid={<span class="hljs-string"><span class="hljs-string">'randomforestclassifier__n_estimators'</span></span>: [<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>], <span class="hljs-string"><span class="hljs-string">'randomforestclassifier__max_leaf_nodes'</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>], <span class="hljs-string"><span class="hljs-string">'randomforestclassifier__min_impurity_split'</span></span>: [<span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.2</span></span>, <span class="hljs-number"><span class="hljs-number">0.3</span></span>], <span class="hljs-string"><span class="hljs-string">'randomforestclassifier__max_depth'</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>]}, pre_dispatch=<span class="hljs-string"><span class="hljs-string">'2*n_jobs'</span></span>, refit=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, return_train_score=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, scoring=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><ul><li>  Veamos qu√© par√°metro eligi√≥ la b√∫squeda en la cuadr√≠cula: </li></ul><br><pre> <code class="python hljs">print(<span class="hljs-string"><span class="hljs-string">"Best parameters: {}"</span></span>.format(grid.best_params_))</code> </pre> <br><pre> <code class="python hljs">Best parameters: {<span class="hljs-string"><span class="hljs-string">'randomforestclassifier__n_estimators'</span></span>: <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-string"><span class="hljs-string">'randomforestclassifier__max_leaf_nodes'</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">'randomforestclassifier__min_impurity_split'</span></span>: <span class="hljs-number"><span class="hljs-number">0.2</span></span>, <span class="hljs-string"><span class="hljs-string">'randomforestclassifier__max_depth'</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>}</code> </pre> <br><ul><li>  Calcular: </li></ul><br><pre> <code class="python hljs">print(<span class="hljs-string"><span class="hljs-string">"Validation set score: {:.2f}"</span></span>.format(grid.score(X_test, y_test)))</code> </pre><br><pre> <code class="python hljs">Validation set score: <span class="hljs-number"><span class="hljs-number">0.79</span></span></code> </pre><br><ul><li>  Descargue la suite de prueba: </li></ul><br><pre> <code class="python hljs">test_df = pd.read_csv(<span class="hljs-string"><span class="hljs-string">'../data/test.csv'</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">"utf-8-sig"</span></span>) test_df = test_df.head()</code> </pre> <br><pre> <code class="python hljs">grid.predict(test_df)</code> </pre> <br><pre> <code class="python hljs">array([<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>])</code> </pre> <br>  Nuestra cartera se ve lo suficientemente buena como para pasar al siguiente paso importante: serializar el modelo de aprendizaje autom√°tico. <br><br>  <b>Guardar un modelo de aprendizaje autom√°tico: serializaci√≥n y deserializaci√≥n.</b> <br><br><blockquote>  "En inform√°tica, en el contexto del almacenamiento de datos, la serializaci√≥n es el proceso de traducir estructuras de datos o estados de objetos a un formato almacenado (por ejemplo, un archivo o memoria intermedia) y luego reconstruirlo en el mismo entorno inform√°tico u otro". </blockquote><br><br>  En Python, el decapado es la forma est√°ndar de almacenar objetos y recuperarlos m√°s tarde en su estado original.  Para hacerlo m√°s claro, dar√© un ejemplo simple: <br><br><pre> <code class="python hljs">list_to_pickle = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'here'</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-string"><span class="hljs-string">'walker'</span></span>] <span class="hljs-comment"><span class="hljs-comment">#Pickling the list import pickle list_pickle = pickle.dumps(list_to_pickle)</span></span></code> </pre> <br><pre> <code class="python hljs">list_pickle</code> </pre> <br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">b'\x80\x03]q\x00(K\x01X\x04\x00\x00\x00hereq\x01K{X\x06\x00\x00\x00walkerq\x02e.'</span></span></code> </pre> <br>  Luego volvemos a descargar el objeto enlatado: <br><br><pre> <code class="python hljs">loaded_pickle = pickle.loads(list_pickle)</code> </pre> <br><pre> <code class="python hljs">loaded_pickle</code> </pre> <br><pre> <code class="python hljs">[<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'here'</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-string"><span class="hljs-string">'walker'</span></span>]</code> </pre> <br>  Podemos guardar objetos enlatados en un archivo y usarlos.  Este m√©todo es similar a la creaci√≥n de archivos <code>.rda</code> , como en la programaci√≥n R, por ejemplo. <br><br>  <i><b>Nota:</b></i> puede que a algunos no les guste este m√©todo de preservaci√≥n para la serializaci√≥n.  Una alternativa podr√≠a ser <code>h5py</code> . <br><br>  Tenemos una clase personalizada (Clase) que debemos importar mientras se realiza el entrenamiento, por lo que utilizaremos el m√≥dulo de <code>dill</code> para empacar el evaluador de clase con el objeto de cuadr√≠cula. <br><br>  Es aconsejable crear un archivo <code>training.py</code> separado que contenga todo el c√≥digo para entrenar el modelo.  (Un ejemplo se puede ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ). <br><br><ul><li>  Instalar <code>dill</code> </li></ul><br><pre> <code class="python hljs">!pip install dill</code> </pre> <br><pre> <code class="python hljs">Requirement already satisfied: dill <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /home/pratos/miniconda3/envs/ordermanagement/lib/python3<span class="hljs-number"><span class="hljs-number">.5</span></span>/site-packages</code> </pre> <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dill <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pickle filename = <span class="hljs-string"><span class="hljs-string">'model_v1.pk'</span></span></code> </pre> <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'../flask_api/models/'</span></span>+filename, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> file: pickle.dump(grid, file)</code> </pre> <br>  El modelo se guardar√° en el directorio seleccionado anteriormente.  Una vez que el modelo se despedaza, se puede envolver en una envoltura de matraz.  Sin embargo, antes de esto, debe asegurarse de que el archivo enlatado funcione.  Volvamos a cargarlo y hagamos una predicci√≥n: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'../flask_api/models/'</span></span>+filename ,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: loaded_model = pickle.load(f)</code> </pre> <br><pre> <code class="python hljs">loaded_model.predict(test_df)</code> </pre> <br><pre> <code class="python hljs">array([<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>])</code> </pre> <br>  Dado que seguimos los pasos de preprocesamiento para que los datos reci√©n llegados sean parte de la tuber√≠a, solo necesitamos ejecutar predic ().  Con la biblioteca scikit-learn, es bastante sencillo trabajar con tuber√≠as.  Los tasadores y las tuber√≠as se encargan de su tiempo y nervios, incluso si la implementaci√≥n inicial parece salvaje. <br><br>  <b>Crear una API usando Flask</b> <br><br>  Mantengamos la estructura de carpetas lo m√°s simple posible: <br><br><img src="https://habrastorage.org/webt/y4/hm/2p/y4hm2pao2sje1zdmwe4t8cnjvhg.png"><br><br>  Hay tres partes importantes para crear un contenedor para la funci√≥n <code>apicall()</code> : <br><br><ul><li>  Recibir datos de <code>request</code> (para lo cual se realizar√° un pron√≥stico); </li><li>  Cargando un tasador enlatado; </li><li>  Traducci√≥n de nuestras previsiones en formato JSON y recepci√≥n de un <code>status code: 200</code> respuesta <code>status code: 200</code> ; </li></ul><br>  Los mensajes HTTP se crean a partir del encabezado y el cuerpo.  En general, el contenido del cuerpo principal se transmite en formato JSON.  Enviaremos ( <code>POST url-endpoint/</code> ) datos entrantes como un paquete para recibir pron√≥sticos. <br><br>  <i><b>Nota:</b></i> Puede enviar texto plano, XML, cvs o una imagen directamente para intercambiar el formato, sin embargo, es preferible utilizar JSON en nuestro caso. <br><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Filename: server.py """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.externals <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> joblib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask, jsonify, request app = Flask(__name__) @app.route(<span class="hljs-string"><span class="hljs-string">'/predict'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apicall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""API Call Pandas dataframe (sent as a payload) from API Call """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: test_json = request.get_json() test = pd.read_json(test_json, orient=<span class="hljs-string"><span class="hljs-string">'records'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#To resolve the issue of TypeError: Cannot compare types 'ndarray(dtype=int64)' and 'str' test['Dependents'] = [str(x) for x in list(test['Dependents'])] #Getting the Loan_IDs separated out loan_ids = test['Loan_ID'] except Exception as e: raise e clf = 'model_v1.pk' if test.empty: return(bad_request()) else: #Load the saved model print("Loading the model...") loaded_model = None with open('./models/'+clf,'rb') as f: loaded_model = pickle.load(f) print("The model has been loaded...doing predictions now...") predictions = loaded_model.predict(test) """Add the predictions as Series to a new pandas dataframe OR Depending on the use-case, the entire test data appended with the new files """ prediction_series = list(pd.Series(predictions)) final_predictions = pd.DataFrame(list(zip(loan_ids, prediction_series))) """We can be as creative in sending the responses. But we need to send the response codes as well. """ responses = jsonify(predictions=final_predictions.to_json(orient="records")) responses.status_code = 200 return (responses)</span></span></code> </pre> <br>  Despu√©s de la ejecuci√≥n, ingrese: <code>gunicorn --bind 0.0.0.0:8000 server:app</code> <br>  Generemos datos para el pron√≥stico y una cola para ejecutar la API localmente en <code>https:0.0.0.0:8000/predict</code> <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests</code> </pre> <br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Setting the headers to send and accept json responses """</span></span> header = {<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, \ <span class="hljs-string"><span class="hljs-string">'Accept'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>} <span class="hljs-string"><span class="hljs-string">"""Reading test batch """</span></span> df = pd.read_csv(<span class="hljs-string"><span class="hljs-string">'../data/test.csv'</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">"utf-8-sig"</span></span>) df = df.head() <span class="hljs-string"><span class="hljs-string">"""Converting Pandas Dataframe to json """</span></span> data = df.to_json(orient=<span class="hljs-string"><span class="hljs-string">'records'</span></span>)</code> </pre> <br><pre> <code class="python hljs">data</code> </pre> <br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">'[{"Loan_ID":"LP001015","Gender":"Male","Married":"Yes","Dependents":"0","Education":"Graduate","Self_Employed":"No","ApplicantIncome":5720,"CoapplicantIncome":0,"LoanAmount":110.0,"Loan_Amount_Term":360.0,"Credit_History":1.0,"Property_Area":"Urban"},{"Loan_ID":"LP001022","Gender":"Male","Married":"Yes","Dependents":"1","Education":"Graduate","Self_Employed":"No","ApplicantIncome":3076,"CoapplicantIncome":1500,"LoanAmount":126.0,"Loan_Amount_Term":360.0,"Credit_History":1.0,"Property_Area":"Urban"},{"Loan_ID":"LP001031","Gender":"Male","Married":"Yes","Dependents":"2","Education":"Graduate","Self_Employed":"No","ApplicantIncome":5000,"CoapplicantIncome":1800,"LoanAmount":208.0,"Loan_Amount_Term":360.0,"Credit_History":1.0,"Property_Area":"Urban"},{"Loan_ID":"LP001035","Gender":"Male","Married":"Yes","Dependents":"2","Education":"Graduate","Self_Employed":"No","ApplicantIncome":2340,"CoapplicantIncome":2546,"LoanAmount":100.0,"Loan_Amount_Term":360.0,"Credit_History":null,"Property_Area":"Urban"},{"Loan_ID":"LP001051","Gender":"Male","Married":"No","Dependents":"0","Education":"Not Graduate","Self_Employed":"No","ApplicantIncome":3276,"CoapplicantIncome":0,"LoanAmount":78.0,"Loan_Amount_Term":360.0,"Credit_History":1.0,"Property_Area":"Urban"}]'</span></span></code> </pre> <br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""POST &lt;url&gt;/predict """</span></span> resp = requests.post(<span class="hljs-string"><span class="hljs-string">"http://0.0.0.0:8000/predict"</span></span>, \ data = json.dumps(data),\ headers= header)</code> </pre> <br><pre> <code class="python hljs">resp.status_code</code> </pre> <br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">200</span></span></code> </pre> <br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""The final response we get is as follows: """</span></span> resp.json()</code> </pre> <br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'predictions'</span></span>: <span class="hljs-string"><span class="hljs-string">'[{"0":"LP001015","1":1},{...</span></span></code> </pre><br>  <b>Conclusi√≥n</b> <br><br>  En este art√≠culo, hemos recorrido solo la mitad del camino, creando una API funcional que ofrece pron√≥sticos, y nos hemos acercado un paso m√°s a la integraci√≥n de soluciones de ML directamente en aplicaciones desarrolladas.  Hemos creado una API bastante simple que ayudar√° a crear prototipos del producto y lo har√° realmente funcional, pero para enviarlo a producci√≥n, debe realizar algunos ajustes que ya no est√°n en el campo del aprendizaje autom√°tico. <br><br>  Hay algunas cosas a tener en cuenta al crear la API: <br><br><ul><li>  Crear una API de calidad a partir de un c√≥digo de espagueti es casi imposible, por lo tanto, use su conocimiento en aprendizaje autom√°tico para crear una API √∫til y conveniente. </li><li>  Intente usar el control de versiones para modelos y c√≥digo API.  Tenga en cuenta que Flask no proporciona soporte para herramientas de control de versiones.  Guardar y rastrear modelos ML es una tarea dif√≠cil, encuentre una manera conveniente para usted.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠</a> hay un art√≠culo que habla sobre c√≥mo hacer esto. </li><li>  Debido a las caracter√≠sticas espec√≠ficas de los modelos de aprendizaje de scikit, debe asegurarse de que el evaluador y el c√≥digo de capacitaci√≥n est√©n uno al lado del otro (si est√° utilizando un evaluador personalizado para el preprocesamiento u otras tareas similares).  Por lo tanto, el modelo enlatado tendr√° un evaluador de clase al lado. </li></ul><br>  El siguiente paso l√≥gico es crear mecanismos para implementar tal API en una peque√±a m√°quina virtual.  Hay varias formas de hacer esto, pero las cubriremos en el pr√≥ximo art√≠culo. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥digo y explicaci√≥n de este art√≠culo.</a> <br><br>  <b>Fuentes utiles:</b> <br><br>  [1] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">No conserve sus datos.</a> <br>  [2] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Construcci√≥n de transformadores compatibles con Scikit Learn</a> . <br>  [3] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Usando jsonify en Flask</a> . <br>  [4] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Flask-QuickStart.</a> <br><br>  Aqu√≠ hay tal material.  Suscr√≠base a nosotros si le gust√≥ la publicaci√≥n e inscr√≠base en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">seminario web abierto y</a> gratuito sobre el tema: "Algoritmos de clasificaci√≥n m√©trica", que tendr√° lugar el 12 de marzo el desarrollador y cient√≠fico de datos con 5 a√±os de experiencia: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Alexander Nikitin</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/442918/">https://habr.com/ru/post/442918/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442906/index.html">¬øHay vida en el mercado ruso de sistemas operativos? Descripci√≥n general del sistema operativo ruso popular</a></li>
<li><a href="../442910/index.html">¬øPor qu√© necesitamos an√°lisis avanzados en SIBUR?</a></li>
<li><a href="../442912/index.html">Rally contra el aislamiento de Runet</a></li>
<li><a href="../442914/index.html">Battle royale: secretos de dise√±o del g√©nero de juegos m√°s popular</a></li>
<li><a href="../442916/index.html">¬øSon relevantes las estaciones de radio FM pirateadas hoy?</a></li>
<li><a href="../442920/index.html">Coroutines :: experiencia pr√°ctica</a></li>
<li><a href="../442922/index.html">Misi√≥n lunar "Bereshit" - caracter√≠sticas del dispositivo, una serie de maniobras y el camino m√°s largo hacia la luna</a></li>
<li><a href="../442924/index.html">Salpicadura de textura de terreno avanzada</a></li>
<li><a href="../442926/index.html">"Alboroto del rat√≥n" en luz infrarroja: la introducci√≥n de nanopart√≠culas en la regi√≥n subretiniana del ojo del rat√≥n</a></li>
<li><a href="../442928/index.html">Escribir un c√≥digo flexible usando SOLID</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>