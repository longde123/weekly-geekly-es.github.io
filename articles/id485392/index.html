<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚ÄçüöÄ üì≤ üç¢ Bot telegram yang memonitor domain üìã üôá üéë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo untuk penghuni Habr. 

 Dalam proses belajar PHP, saya datang dengan ide untuk berlatih menulis beberapa bot dalam PHP, tanpa menggunakan kerangk...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot telegram yang memonitor domain</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485392/">  Halo untuk penghuni Habr. <br><br>  Dalam proses belajar PHP, saya datang dengan ide untuk berlatih menulis beberapa bot dalam PHP, tanpa menggunakan kerangka kerja. <br><br>  Pilihan jatuh pada bot, yang akan menerima informasi tentang masa pakai domain (whois), kemudian mendapatkan tanggal pendaftaran dari sana dan menambahkan domain ini ke basis data (mysql), dengan selanjutnya mengikat pengguna dan pemberitahuan di telegram. <br><br>  Kode sumber di repositori <a href="https://github.com/Mazay98/botDomain" rel="nofollow">saya</a> di gita. <br><br>  Saya ingin menggunakan struktur <a href="https://habr.com/ru/post/150267/">MVC</a> , yang menurut <b>saya</b> tidak sepenuhnya benar, karena pandangan tidak terlibat dan ini tidak bisa lagi disebut mvc, tapi oh well ... <br><a name="habracut"></a><br><h3>  Struktur aplikasi </h3><br><img src="https://habrastorage.org/webt/tw/8v/ve/tw8vveeoxgfy1mcy7td3grjbjgq.png"><br><br>  <b>Controllers</b> - Tautan yang menghubungkan model dan logika aplikasi. <br>  <b>Model</b> - File "logika bisnis" dari aplikasi (saya mencoba "menjejalkan" seluruh sql di sini). <br>  <b>Core</b> - Aplikasi "core" file. <br>  <b>Perpustakaan</b> - Perpustakaan menggunakan perpustakaan untuk mem-parsing informasi nama domain. <br><br><h3>  Routing </h3><br>  File perutean (routes.php) terletak di direktori <i>inti</i> . <br>  2 alamat ditambahkan dalam aplikasi: <br><br>  <b>/ bot</b> - <a href="https://core.telegram.org/bots/api" rel="nofollow">Telegramm pergi</a> ke alamat ini (Anda perlu mengatur <a href="https://core.telegram.org/bots/api" rel="nofollow">webhook</a> ke alamat uri / bot ini). <br>  <b>/ check</b> - Di alamat ini, <a href="https://ru.wikipedia.org/wiki/Wget" rel="nofollow">wget istirahat</a> dengan cron 1 per hari (pukul 12), lebih lanjut tentang itu nanti. <br><br><h3>  Botcontroller </h3><br>  Setelah transisi ke pengontrol ini, kami mendapatkan nilai dari isi permintaan <b>POST</b> , dan mendekode sebagai array. <br><br><pre><code class="php hljs">json_decode(file_get_contents(<span class="hljs-string"><span class="hljs-string">'php://input'</span></span>), JSON_OBJECT_AS_ARRAY);</code> </pre> <br>  <a href="https://www.php.net/manual/ru/wrappers.php.php" rel="nofollow"><i>php: // input</i></a> - dapatkan isi permintaan POST <br><br><h3>  Checkercontroller </h3><br>  Setelah transisi ke pengontrol ini, skrip dipicu yang memeriksa semua domain dan sertifikat ssl yang ditambahkan untuk kedaluwarsa, dengan interval: <br><br><ul><li>  <i>tanggal saat ini</i> </li><li>  <u>2 hari</u> </li><li>  <i>7 hari</i> </li><li>  <i>30 hari</i> </li></ul><br>  Dan mengirimkan pemberitahuan jika tanggal kedaluwarsa domain dan sertifikat ssl berakhir. <br><br><h3>  Menambahkan Pengguna </h3><br>  Ketika pengguna menulis pesan ke bot telegram webhook, mengirimkannya ke situs web kami, maka kami menerima pesan dalam format json, yang perlu kami dekode dan konversikan ke array untuk pekerjaan lebih lanjut. <br><br><img src="https://habrastorage.org/webt/jv/t0/ui/jvt0uivydq_3yk_uw60gctyiklw.png"><br><br>  Kami akan bekerja dengan susunan <b>pesan.</b> <br><br>  Dapatkan dari <b>pesan</b> array <b>['chat']</b> : <b>id</b> , <b>first_name</b> <br>  dimana: <br><br>  <b>id</b> - <b>id</b> obrolan <br>  <b>first_name</b> - Nama pengguna <br><br>  Dan dari susunan <b>pesan ['teks']</b> , kita mendapatkan perintah yang dikirim oleh pengguna. <br><br>  Kami menemukan pengguna di tabel pengguna, jika dia tidak ada, buat <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   $sql= "SELECT user_id FROM users WHERE chat_id=?"; $stmt = $db-&gt;prepare($sql); $stmt-&gt;execute([$chat_id]); $rows = $stmt-&gt;fetch(PDO::FETCH_ASSOC); return (int)$rows['user_id'];</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   $sql = 'INSERT INTO users (user_name, chat_id) VALUES (:user_name, :chat_id)'; $insert = $db-&gt;prepare($sql); $insert-&gt;execute([':user_name' =&gt; $name, ':chat_id' =&gt; $chat_id]); return true;</span></span></code> </pre><br><h3>  Menambahkan Domain dan SSL </h3><br>  Saat mengirim perintah <i>/ addDomain url</i> ke bot, kami mendapatkan url domain dari perintah dan mendapatkan data pendaftaran domain menggunakan <a href="https://github.com/regru/php-whois" rel="nofollow">pustaka ini</a> . <br><br><h4>  Dapatkan domainnya </h4><br>  Kami mendapatkan jawaban dalam bentuk teks: <br><br><img src="https://habrastorage.org/webt/ca/re/sf/caresfp0wregwz5rdtxbdbofhao.png"><br><br>  Dengan menggunakan <a href="https://www.php.net/manual/ru/function.preg-match.php" rel="nofollow">ekspresi reguler</a> , kami mendapatkan tanggal pendaftaran domain darinya. <br><br><pre> <code class="php hljs">preg_match(<span class="hljs-string"><span class="hljs-string">'/Registry\sExpiry\sDate:\s(.*)\\r/'</span></span>, $date, $matches); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]){ preg_match(<span class="hljs-string"><span class="hljs-string">'/paid-till:\s*(.*)\\n/'</span></span>, $date, $matches); } $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;formatDate($matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>];</code> </pre><br><h4>  Dapatkan SSL </h4><br>  Saya memutuskan untuk mendapatkan sertifikat SSL menggunakan <a href="https://ru.wikipedia.org/wiki/OpenSSL" rel="nofollow">openssl</a> untuk linux. <br><br><pre> <code class="php hljs">$getDomainSSL = shell_exec(<span class="hljs-string"><span class="hljs-string">"echo | openssl s_client -servername $url -connect $url:443 2&gt;/dev/null | openssl x509 -noout -dates"</span></span>); preg_match(<span class="hljs-string"><span class="hljs-string">'~notAfter=(\w+)\s(\d+)\s.+\s(\d+)~'</span></span>, $getDomainSSL, $matches); $date = $matches[<span class="hljs-number"><span class="hljs-number">2</span></span>].$matches[<span class="hljs-number"><span class="hljs-number">1</span></span>].$matches[<span class="hljs-number"><span class="hljs-number">3</span></span>]; $date = date(<span class="hljs-string"><span class="hljs-string">"Ymd"</span></span>, strtotime($date)); $date = str_replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>,<span class="hljs-string"><span class="hljs-string">'-'</span></span>,$date); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $date;</code> </pre><br>  Jadi kita mendapatkan: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> | openssl s_client -servername google.com -connect google.com:443 2&gt;/dev/null | openssl x509 -noout -dates notBefore=Jan 7 15:47:12 2020 GMT notAfter=Mar 31 15:47:12 2020 GMT</code> </pre><br>  Parsing hasilnya menggunakan ekspresi reguler <br><br><pre> <code class="php hljs">preg_match(<span class="hljs-string"><span class="hljs-string">'~notAfter=(\w+)\s(\d+)\s.+\s(\d+)~'</span></span>, $getDomainSSL, $matches);</code> </pre> <br><img src="https://habrastorage.org/webt/fq/ua/t6/fquat6iqosjwx9bpw5uttjcnto0.png"><br><br>  Tetap hanya menambahkan data ke tabel. <br><br><pre> <code class="php hljs">$sql = <span class="hljs-string"><span class="hljs-string">'INSERT INTO domains (domain_name, date_start, date_end, date_end_ssl) VALUES (:domain_name, :date_start, :date_end, :date_end_ssl)'</span></span>; $insert = $db-&gt;prepare($sql); $insert-&gt;execute([<span class="hljs-string"><span class="hljs-string">':domain_name'</span></span> =&gt; $url, <span class="hljs-string"><span class="hljs-string">':date_end'</span></span> =&gt; $exp, <span class="hljs-string"><span class="hljs-string">':date_end_ssl'</span></span> =&gt; $ssl_date]);</code> </pre><br><h3>  Kami mengikat domain dan ssl ke pengguna </h3><br>  Data yang diperoleh hanya perlu direkam dalam <a href="https://metanit.com/sql/tutorial/1.3.php" rel="nofollow">tabel perantara</a> agar tidak "menggandakan" domain. <br><br><pre> <code class="php hljs">$sql = <span class="hljs-string"><span class="hljs-string">'INSERT INTO domain_users (user_id, domain_id) VALUES (:user_id, :domain_id)'</span></span>; $insert = $db-&gt;prepare($sql); $insert-&gt;execute([<span class="hljs-string"><span class="hljs-string">':user_id'</span></span> =&gt; $user_id, <span class="hljs-string"><span class="hljs-string">':domain_id'</span></span> =&gt; $domain_id]);</code> </pre><br><h3>  Memeriksa Tanggal Berakhir Domain </h3><br>  Ketika wget pergi ke alamat / periksa, semua domain dan sertifikat ssl dengan tanggal kedaluwarsa dipilih, dan jika ada, itu mengirim pesan obrolan yang mengikat domain ini. <br><br><pre> <code class="php hljs">$db = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db; $sql= <span class="hljs-string"><span class="hljs-string">" SELECT user_name, chat_id, domain_name, date_end FROM domain_users JOIN users USING (user_id) JOIN domains USING (domain_id) WHERE ( domains.date_end = CURDATE() OR domains.date_end = CURDATE() + INTERVAL 2 DAY OR domains.date_end = CURDATE() + INTERVAL 7 DAY OR domains.date_end = CURDATE() + INTERVAL 30 DAY ) "</span></span>; $stmt = $db-&gt;prepare($sql); $stmt-&gt;execute(); $rows = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);</code> </pre><br><h3>  CRON </h3><br>  <a href="https://help.ubuntu.ru/wiki/cron" rel="nofollow">Mahkota</a> dalam proyek ini diperlukan untuk mengatur transisi ke alamat '/ centang', setiap hari pukul 12:00. <br><br><pre> <code class="bash hljs">crontab -e 0 12 * * * wget url/check</code> </pre><br><h3>  Proxy Tor </h3><br>  Beberapa kata tentang mengirim pesan ke telegram. <br><br>  Sayangnya, di wilayah negara saya (Rusia), mereka memblokir telegram, termasuk apinya. <br>  Saya harus menggunakan proxy, pilihan saya jatuh pada <a href="https://wiki.archlinux.org/index.php/Tor_(%25D0%25A0%25D1%2583%25D1%2581%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9)" rel="nofollow">proxy</a> (sejak proyek terakhir). <br><br>  Itu hanya perlu diinstal. <br><br><pre> <code class="bash hljs">sudo apt-get install tor</code> </pre> <br>  Kemudian proxy akan tersedia di port 9050. <br><br><pre> <code class="php hljs">curl_setopt($myCurl, CURLOPT_PROXYTYPE, <span class="hljs-number"><span class="hljs-number">7</span></span>); curl_setopt($myCurl, CURLOPT_PROXY, <span class="hljs-string"><span class="hljs-string">"127.0.0.1:9050"</span></span>);</code> </pre><br>  Terima kasih semua telah membaca artikel ini! <br><br>  Ini adalah artikel pertama saya, jadi jangan menilai dengan ketat :) <br><br>  Mengomentari posting ini, saya dengan senang hati akan menerima kritik. <br><br>  Kode sumber proyek di repositori github <a href="https://github.com/Mazay98/botDomain" rel="nofollow">saya</a> :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id485392/">https://habr.com/ru/post/id485392/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id485380/index.html">Craft dan Sukses TI</a></li>
<li><a href="../id485384/index.html">NeurIPS 2019: Tren ML yang akan bersama kita untuk dekade berikutnya</a></li>
<li><a href="../id485386/index.html">Microbrows ada di mana-mana. Tapi apa yang kita ketahui tentang mereka?</a></li>
<li><a href="../id485388/index.html">Aturan, menderita, tersenyum</a></li>
<li><a href="../id485390/index.html">Kompetisi hibah mikro sumber terbuka untuk proyek data terbuka</a></li>
<li><a href="../id485394/index.html">Bagaimana infrastruktur Internet lahir</a></li>
<li><a href="../id485396/index.html">Pemeriksaan Kesehatan Regu: Mengukur Kesehatan Tim</a></li>
<li><a href="../id485398/index.html">PostgreSQL Antipatterns: tekan kamus di JOIN berat</a></li>
<li><a href="../id485404/index.html">Kami menyadari efek visual dari film "The Matrix"</a></li>
<li><a href="../id485416/index.html">Cara praktis untuk memetakan data di Kotlin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>