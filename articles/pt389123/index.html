<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÖ üå™Ô∏è üõ£Ô∏è M√©todos para depurar software de microcontrolador em uma unidade el√©trica üïó üöµüèº üôÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como depurar programas de microcontroladores? O JTAG √© obtido, o oscilosc√≥pio √© de alguns dias / semanas e o programa √© depurado. Essa ser√° uma respos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>M√©todos para depurar software de microcontrolador em uma unidade el√©trica</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/npf_vektor/blog/389123/"><img src="https://habrastorage.org/files/95f/7de/cb5/95f7decb5aa64618b6ad35270c2e753f.JPG" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como depurar programas de microcontroladores? O JTAG √© obtido, o oscilosc√≥pio √© de alguns dias / semanas e o programa √© depurado. Essa ser√° uma resposta t√≠pica e, na maioria dos casos, estar√° correta ... Mas nem sempre. Os microcontroladores resolvem problemas muito diferentes e, neste artigo, consideraremos o que fazer se voc√™ precisar desenvolver um software pesado de baixo n√≠vel para controlar qualquer equipamento el√©trico de pot√™ncia, por exemplo, conversores de frequ√™ncia para motores el√©tricos, conversores de carga de bateria DC / DC para trens, corretores de energia, servos e etc. Equipamento, onde fluem kiloamperes e kilovolts PWM, onde √© contado cada comuta√ß√£o das chaves do inversor IGBT, onde o tempo de resposta do microcontrolador a uma situa√ß√£o anormal √© medido em microssegundos e o pr√≥prio equipamento em caixas seladas √© instalado e operado em algum lugar nas f√°bricas de Yakutia.Se voc√™ quiser saber quais recursos isso imp√µe aos m√©todos de depura√ß√£o, seja bem-vindo ao gato.</font></font><br>
<a name="habracut"></a><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recursos de sistemas de controle de depura√ß√£o</font></font></h1><br>
<img src="https://habrastorage.org/files/b75/1ed/df5/b751eddf52ae41f4afbb776f6c31055c.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quais s√£o os recursos dos microcontroladores (MK) de depura√ß√£o que executam essas tarefas? </font><font style="vertical-align: inherit;">Primeiro, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quando o MK trabalha com equipamentos de energia, ele n√£o pode ser parado.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O MK, com a ajuda do PWM, controla as teclas de for√ßa, regula muitos valores em seus corredores - correntes das fases do motor, tens√£o do link CC, velocidade, posi√ß√£o do corpo de trabalho, etc. Se voc√™ parar o MK enquanto trabalha no ponto de interrup√ß√£o, na melhor das hip√≥teses o equipamento ser√° desligado devido √† prote√ß√£o do hardware e, na pior das hip√≥teses, tudo simplesmente explodir√° (se os interruptores permanecerem na posi√ß√£o "um" ou com um ciclo de trabalho). Portanto, a maneira cl√°ssica de depura√ß√£o √© "percorrer as etapas com o depurador" nessas tarefas. Portanto, voc√™ pode executar apenas sobre a mesa ‚Äúm√≥dulos de software completamente n√£o processados ‚Äã‚Äãantes da primeira inclus√£o em equipamentos reais.</font></font><br>
<br>
<img src="https://habrastorage.org/files/0ec/67d/061/0ec67d061c1d4bdc86b3c0fff1a21003.png" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em segundo lugar, essa √© a complexidade do software de baixo n√≠vel. O tamanho da se√ß√£o do c√≥digo do programa .text √© de 50-200 Kbytes para o c√≥digo do programa que controla exclusivamente o hardware (sem drivers de comunica√ß√£o de alto n√≠vel etc.) - essa √© uma situa√ß√£o t√≠pica para um microcontrolador de algum servoconversor industrial. Portanto, microcontroladores da s√©rie motorcontrol s√£o usados ‚Äã‚Äãpara essas tarefas, que combinam ao mesmo tempo perif√©ricos muito desenvolvidos, alto desempenho e um tamanho de mem√≥ria relativamente grande (para MK). Como exemplo de MKs importados, podem ser citados os MK MK32 de 32 bits da s√©rie Texas Instruments C2000, do chip dom√©stico K1921VK01T do NIIET OJSC. O software para esse MK geralmente cont√©m dezenas ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">centenas de milhares de linhas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo C / C ++ otimizado perfeito, que simplesmente n√£o pode ser depurado ‚Äúpiscando um LED‚Äù, ‚Äúimprimindo no UART‚Äù ou observando a opera√ß√£o das pernas de um oscilosc√≥pio externo. </font></font><br>
<br>
<img src="https://habrastorage.org/files/e1a/d3e/2e5/e1ad3e2e5e394042886eb06b707c14f7.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em terceiro lugar, o controlador do sistema de controle de acionamento el√©trico geralmente fica dentro do conversor de energia, cuja caixa est√° fechada e √†s vezes at√© selada. Portanto, o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acesso via JTAG j√° √© um grande problema, mesmo que</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seja para firmware (com a energia desligada). E um problema ainda mais s√©rio √© a depura√ß√£o JTAG com a energia ligada. Aqui, o JTAG necessariamente isolado galvanicamente e √† prova de ru√≠do deve ser usado (usamos para o MK TI JTAG SAURIS com isolamento galv√¢nico interno - caro, mas funciona). </font></font><br>
<br>
<img src="https://habrastorage.org/files/e0c/89b/f08/e0c89bf08ca143d1a7f1760ca39b7dc2.png" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quarto, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nenhum sistema operacional!</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podemos prever como algumas pessoas t√™m a ideia "bem, j√° que voc√™ tem uma tarefa t√£o dif√≠cil, coloque um microcontrolador normal no Linux e escreva aplicativos regulares para ele, atualizando o software a partir de uma unidade flash". Os sistemas de controle de equipamentos de energia s√£o sistemas muito dif√≠ceis em tempo real. N√£o que o Linux, nem todos os sistemas operacionais especializados em tempo real sejam adequados para essas tarefas. Por exemplo, a interrup√ß√£o do ADC atrav√©s da leitura e da m√©dia dos dados anal√≥gicos pode ser causada com uma frequ√™ncia de at√© 100 kHz. Ao mesmo tempo, ele conter√° apenas uma d√∫zia ou duas linhas de c√≥digo - coleta de dados de canais anal√≥gicos, algumas verifica√ß√µes das prote√ß√µes de alta velocidade e sa√≠da - tudo, nada mais a fazer. Se voc√™ instruir essa interrup√ß√£o a algum agendador de tarefas do SO, simplesmente sua pr√≥pria execu√ß√£o consumir√° mais recursos. Sem mencionar que, em particular,para Linux, em vez de um chip MK, voc√™ precisa colocar mais dois na placa - RAM externa e mem√≥ria flash, alocando um monte de pernas de cristal preciosas, usar uma placa de seis camadas para a fia√ß√£o apropriada, obter um tempo de inicializa√ß√£o enorme do MK (√†s vezes com falta de energia ou um timer de vigil√¢ncia) comece a trabalhar antes que o mecanismo pare!), tenha problemas com a integridade do sistema de arquivos e muito mais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, a quinta caracter√≠stica - sistemas de controle de baixo n√≠vel para acionamentos el√©tricos e outros equipamentos de energia (em contraste com tarefas de comunica√ß√£o em diferentes interfaces, CLPs, controladores de todos os tipos de alarmes, controles remotos, etc.) implementam principalmente algoritmos de sistema de controle autom√°tico. Ou seja: a metade do software consiste em v√°rios tipos de estruturas fechadas com controladores PID, blocos de satura√ß√£o, zonas mortas, tabelas de depend√™ncia uma da outra, filtros, observadores, ajustadores de intensidade, planejadores de movimento e outros. Os c√°lculos nesse software s√£o realizados com uma certa frequ√™ncia - digamos, a uma frequ√™ncia de 10 kHz, uma interrup√ß√£o √© acionada e calcula todos os blocos listados, que juntos formam a estrutura de controle de equipamento necess√°ria. Nesses algoritmos, a depura√ß√£o passo a passo n√£o ajuda - na maioria das vezes, a cada etapa, cada m√≥dulo gera o queo que se espera dele - de fato, todos esses filtros, reguladores etc. j√° foram depurados h√° anos e h√° poucas surpresas por l√°.</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os problemas surgem durante a opera√ß√£o de toda a estrutura como um todo - cada unidade trabalha individualmente e o processo regulat√≥rio desejado n√£o ocorre conforme o esperado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . E os problemas acabam no ajuste de centenas de par√¢metros e coeficientes desses blocos, bem como na estrutura montada a partir deles - pode acontecer que voc√™ precise adicionar um novo circuito de estabiliza√ß√£o em algum lugar, adicionar um bloco de previs√£o, restri√ß√µes, etc. Portanto, essa √© outra "pedra no jardim" das mensagens de depura√ß√£o passo a passo e de impress√£o: voc√™ precisa depurar com mais frequ√™ncia do que o c√≥digo do programa, mas a estrutura de controle autom√°tica montada. Se algu√©m tem pouca id√©ia do que √© (estrutura), ent√£o aqui est√° a estrutura mais simples de um controle vetorial sem sensor de um motor s√≠ncrono:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/bfd/b52/e6d/bfdb52e6d24c4d4ab7fac47a46fc8dd6.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, cada caixa cont√©m algumas f√≥rmulas e, √†s vezes, um m√≥dulo em uma d√∫zia ou duas p√°ginas de c√≥digo. </font><font style="vertical-align: inherit;">O m√≥dulo possui entradas / sa√≠das, al√©m de algumas vari√°veis ‚Äã‚Äãde estado (por exemplo, a parte integrante do controlador PI e assim por diante). </font><font style="vertical-align: inherit;">Quem desejar tamb√©m poder√° ver uma estrutura semelhante na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p√°gina da Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Como o sistema de controle est√° fechado, a opera√ß√£o incorreta de uma unidade (ou a configura√ß√£o incorreta) leva √† inoperabilidade de toda a estrutura. </font><font style="vertical-align: inherit;">E descobrir exatamente onde est√° o problema - isso √© outra tarefa.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como depurar?</font></font></h1><br>
<img src="https://habrastorage.org/files/ff6/921/70e/ff692170e60d460ba420efd360713681.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, o que fazer, como depurar? Um oscilosc√≥pio externo? N√£o vai ajudar. O oscilosc√≥pio, √© claro, √© necess√°rio para depurar alguns problemas puramente de hardware, mas eles s√≥ podem ver os valores de entrada e sa√≠da do microcontrolador, e centenas de vari√°veis ‚Äã‚Äãdentro da estrutura permanecer√£o nos bastidores. Bem, voc√™ ver√° que a corrente de fase do motor treme estranhamente e a tens√£o de sa√≠da do inversor treme estranhamente. E por que - qual bloco dentro do software MK leva a isso (ou um motor ou sensor de posi√ß√£o ou outra coisa leva a essa curva) - permanece incerto. </font></font><br>
<br>
<img src="https://habrastorage.org/files/cb4/56d/195/cb456d1959b148e18c758a60bcbf4b1d.png" align="right"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo? Sim, esta √© uma boa ajuda.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na maioria das vezes, o desenvolvimento de estruturas de gerenciamento complexas come√ßa com a modelagem. Em termos de TAU e na forma de equa√ß√µes diferenciais, o objeto de controle √© descrito, o sistema de controle proposto √© constru√≠do (como na figura acima, por exemplo), e tudo isso √© realizado ... bem, quem ama o que, mas o padr√£o de fato √© o Simulink Matlab. Nele, voc√™ pode "desenhar" uma estrutura juntamente com um modelo do objeto de controle, usando "loose" na forma de integradores, somadores, fun√ß√µes de transi√ß√£o etc. Voc√™ pode usar seu pacote para modelar circuitos el√©tricos, onde existem chaves IGBT prontas, motores el√©tricos, resistores, capacitores e muito mais, dando √† merc√™ dos programadores do matlab a implementa√ß√£o do desenho na forma de equa√ß√µes diferenciais e desenhar a pr√≥pria estrutura de controle na forma de "folhas soltas".E voc√™ pode escrever todos os blocos necess√°rios no matlab em C. Este m√©todo √© conveniente, pois o c√≥digo do programa depurado no matlab pode ser simplesmente copiado para o microcontrolador. Geralmente, esta etapa segue sempre o ‚Äúdesenho‚Äù, quando a estrutura do sistema de controle ap√≥s um trabalho aproximado de pesquisa em modelagem √© mais ou menos formada. Mas frequentemente os par√¢metros do objeto s√£o desconhecidos a priori, ou s√£o conhecidos de maneira imprecisa - nunca antes o software que trabalha no modelo come√ßou a funcionar bem no objeto tamb√©m. Tamb√©m √© imposs√≠vel colocar "tudo" no modelo - transistores de comuta√ß√£o transit√≥ria, satura√ß√£o do circuito magn√©tico, correntes de Foucault, acoplamento capacitivo, par√¢metros flutuantes da temperatura e de exemplo a exemplo, interfer√™ncia aqui e ali ... E √†s vezes o objeto de regula√ß√£o √© t√£o complicado,que √© mais f√°cil desenvolver uma estrutura de controle diretamente na instala√ß√£o.</font></font><br>
<blockquote><i>,                 ,   ()  -    .        ,        ,     ¬´¬ª  ‚Äì      ,    ,       - ? (   ‚Äì  ,   ¬´  ¬ª,   ).</i></blockquote><br>
<br>
<img src="https://habrastorage.org/files/87d/3fa/b55/87d3fab5514c4539abcba708c6601d24.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° tamb√©m v√°rios produtos que permitem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"desenhar" programas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diretamente para microcontroladores. Incluindo o mesmo Matlab, √© poss√≠vel gerar c√≥digo C para marcas famosas MK, com base no modelo do Simulink. Alegadamente, voc√™ pode desenhar e depurar a estrutura desenhada do sistema de controle no computador do modelo e carreg√°-la no MK - e pronto, vamos l√°! E mesmo esses ambientes permitem depurar estruturas de controle desenhadas diretamente dentro do MK, observar vari√°veis ‚Äã‚Äãetc., e nos sites de tais produtos h√° v√°rios projetos de demonstra√ß√£o para os sistemas mais complexos que s√£o "programados" dessa maneira. Mas como todos os projetos reais ainda est√£o sendo programados com "m√£os" por algum motivo, podemos adivinhar que algo est√° errado com "desenhar". Mas aqui √© at√© dif√≠cil descrever o que exatamente, quando n√£o √©, √© tudo. O principal argumento contra</font></font><b>‚Äì        </b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Voc√™ pressiona um bot√£o em um ambiente de "bem-estar" e espera que o gerador de c√≥digo fa√ßa o resto por voc√™. Para alguns sistemas simples, nos quais o desempenho do MK est√° "por tr√°s dos olhos", o cronograma de desenvolvimento √© muito pequeno e ningu√©m sabe como programar na empresa que iniciou o projeto ... ent√£o sim, voc√™ provavelmente pode tentar "desenhar" o programa. Mas se n√£o funcionar como deveria, ou tiver alguma falha muito espec√≠fica, n√£o haver√° mais chance de depura√ß√£o. E para uma tarefa complexa, em que mesmo quando programar com m√£os com desempenho MK sempre √© um problema, o desenho n√£o √© adequado simplesmente por falta de recursos - qualquer linguagem de programa√ß√£o que seja de n√≠vel superior (muito superior ao desenho) gera c√≥digo de m√°quina menos ideal. E as otimiza√ß√µes de baixo n√≠vel que um programador C fariaesse sistema n√£o ser√° capaz de fazer (calcular blocos da mesma estrutura com rel√≥gio diferente, usando os valores em cache do seno e do cosseno, substituindo as fun√ß√µes de divis√£o pela multiplica√ß√£o por um valor pr√©-preparado ou coisas realmente complicadas, como</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tais</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> etc). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, voc√™ deve escrever seu software e escrever em C.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E de uma maneira ou de outra, voc√™ precisa depurar seu software, e isso √© necess√°rio no objeto. Provavelmente, todo mundo neste ponto do artigo j√° entendeu que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a estrutura de controle pode ser depurada apenas visualizando os oscilogramas de vari√°veis ‚Äã‚Äãinternas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou seja, visualizando os gr√°ficos no tempo, como essa ou aquela vari√°vel em C muda - digamos, ‚Äúa sa√≠da desse bloco, o quinto da esquerda, simultaneamente com as entradas do terceiro da direita‚Äù. Obtendo fotos como esta:</font></font><br>
 <div style="text-align:center;"><img src="https://habrastorage.org/files/0e0/2cc/c45/0e02ccc455504d699a7f8dfc02617634.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E isso s√≥ pode ser feito por meio do pr√≥prio microcontrolador. Voc√™ n√£o pode simplesmente pegar e colocar a interface de comunica√ß√£o r√°pida externa e enviar "up" o valor de alguma vari√°vel, o mais r√°pido poss√≠vel, e criar um gr√°fico no sistema de n√≠vel superior. Como nenhuma interface de comunica√ß√£o MK ter√° tempo para fazer isso com a frequ√™ncia com a qual transit√≥rios regulados ocorrem. E se voc√™ tiver sucesso, todos os recursos do MK ir√£o para a manuten√ß√£o dessa interface de comunica√ß√£o. Portanto, eles fazem isso - eles </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gravam a forma de onda na RAM do MK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apenas em uma matriz. Geralmente, muitos pontos n√£o s√£o necess√°rios - basta pegar o momento certo para escrever exatamente os dados: coloque o gatilho certo no in√≠cio da grava√ß√£o. E ent√£o voc√™ pode ver o que esses ou aqueles blocos do sistema de controle estavam divulgando no momento da falha, como estava se desenvolvendo, o que o MK estava tentando fazer. Obviamente, todas as vari√°veis ‚Äã‚Äãn√£o podem ser osciladas de uma s√≥ vez - mas, na pr√°tica, existem suficientes, digamos, quatro matrizes de 256 pontos cada - uma esp√©cie de oscilosc√≥pio de quatro canais usando MK. Se o equipamento n√£o funcionar mais de uma vez por semana, a depura√ß√£o n√£o √© um problema - em um experimento, examinamos essas 4 vari√°veis, no pr√≥ximo substitu√≠mos metade pelas outras, examinamos novamente ... at√© encontrar uma unidade com defeito ou at√© remover tudo o que acontece todos os quarteir√µes e n√£o deixe de ver as "imagens", arranhando o lugar que pensa o que ...</font></font><br>
<br>
<img src="https://habrastorage.org/files/e35/ad1/99c/e35ad199c3054cf88227b00e60ea4e42.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como filmar esses oscilogramas? Que software pode fazer isso? Que interface de comunica√ß√£o isso encaminha? Na verdade, a Texas Instruments √©, portanto, l√≠der na produ√ß√£o de microcontroladores de controle de motor, pois fez tudo para isso: Code Composer Studio (seu ambiente de desenvolvimento) mais MK em tempo real. O modo em tempo real √© quando, atrav√©s do JTAG, o ambiente de desenvolvimento pode solicitar e gravar dados na mem√≥ria RAM do MK sem par√°-lo. Mesmo n√£o apenas sem parar, mas sem a menor interrup√ß√£o em seu trabalho. Este modo est√° dispon√≠vel em todos os MKs da s√©rie C2000, mas requer o JTAG caro e r√°pido para us√°-lo, que o suporta. Mas, al√©m do pr√≥prio modo, o MK deve ter algo correspondente na parte traseira do cabo: o ambiente de desenvolvimento do Code Composer Studio √© capaz de criar formas de onda prontas para uso.Al√©m disso, no modo mais simples, quando o usu√°rio define o nome da vari√°vel C e v√™ sua mudan√ßa no tempo no gr√°fico, o ambiente solicita dados com a frequ√™ncia com que pode (geralmente boa, se o Hertz 10) e no modo de exibir o array na mem√≥ria em forma de onda - ou seja, exatamente o que √© descrito acima.</font></font><b> ,     ,      ,  Code Composer Studio  JTAG       .</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao mesmo tempo, o dispositivo pode continuar funcionando como se nada tivesse acontecido. Essa ferramenta foi usada com sucesso por mais de dez anos e, de fato, essa ideologia de depura√ß√£o (ao que parece, mas posso estar errada) foi proposta pelo Texas. Em todos os seus projetos de demonstra√ß√£o, h√° um m√≥dulo datalogger (que registra matrizes de formas de onda) e os manuais descrevem como us√°-lo. A prop√≥sito, aqui voc√™ precisa jogar uma pedra no jardim do BRA√áO. Eles tamb√©m t√™m um modo em tempo real, e nessa arquitetura existem MKs que podem controlar motores el√©tricos. No entanto, em nenhum ambiente de desenvolvimento, deparei-me com uma fun√ß√£o gr√°fica, mesmo que o modo em tempo real seja suportado. Por exemplo, no Keil √© amado por todos, √© at√© imposs√≠vel alterar normalmente o valor de uma vari√°vel em um MK em execu√ß√£o - ele √© atualizado constantemente,e o novo valor inserido pelo usu√°rio na janela √© apagado ... Sem mencionar nenhum gr√°fico l√°. Talvez algu√©m nos coment√°rios sugira uma op√ß√£o de trabalho? Ou √© "ningu√©m precisa" e, portanto, n√£o funciona?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas h√° um problema com esse m√©todo de depura√ß√£o, mesmo atrav√©s do Code Composer Studio. </font><font style="vertical-align: inherit;">E esse problema √© JTAG. </font><font style="vertical-align: inherit;">Como foi dito, seu conector nem sempre est√° dispon√≠vel e, na maioria das vezes, em equipamentos em execu√ß√£o e nem sequer est√° dispon√≠vel. </font><font style="vertical-align: inherit;">E, francamente, n√£o √© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muito confort√°vel sentar-se a alguns metros do conversor de megawatts, assistir seus oscilogramas de trabalho</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e muito concentrado e concentrado para percorrer o bot√£o "parar" do microcontrolador com o mouse, e se um dedo tremer ao longo do caminho? </font><font style="vertical-align: inherit;">Voc√™ sabe como o touchpad √© defeituoso ao usar um PWM poderoso? </font><font style="vertical-align: inherit;">E se o ambiente falhar? </font><font style="vertical-align: inherit;">E o JTAG? </font><font style="vertical-align: inherit;">Tudo, broads?</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Babakh comum</font></font></b><div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/files/de8/e31/f38/de8e31f38400412aaa02056649add98c.jpg"></div><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, os oscilogramas no ambiente de desenvolvimento s√£o exibidos nos valores "como est√£o" em C, sem nenhuma escala, em diferentes janelas dos gr√°ficos, sem unidades de medida personalizadas (lembre-se de que neste gr√°fico 0,342 s√£o volts, eles devem ser multiplicados na mente por 540 para obter unidades f√≠sicas, e aqui 1,2 s√£o amperes com uma escala de 800A). </font><font style="vertical-align: inherit;">E desconfort√°vel e assustador. </font><font style="vertical-align: inherit;">E, no entanto, nem todos os MKs e ambientes de desenvolvimento podem assistir a oscilogramas! </font><font style="vertical-align: inherit;">De repente o seu n√£o √© o Texas? </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, decidimos inventar outra maneira.</font></font></b><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nossa decis√£o</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, se n√£o precisamos de depura√ß√£o passo a passo, qual √© o problema? </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Substitu√≠mos tudo o que fazemos atrav√©s do JTAG por qualquer outra interface de comunica√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font><b><font style="vertical-align: inherit;">criamos</font></b><font style="vertical-align: inherit;"> nosso pr√≥prio shell de n√≠vel superior, que cria os gr√°ficos da maneira que queremos. </font><font style="vertical-align: inherit;">Lucro!</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/64f/f8d/f37/64ff8df373724e92af81eb389bc1becc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o n√≥s fizemos. Interface de comunica√ß√£o que escolhemos CAN, protocolo - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CANopen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Porque O CAN √© uma interface de comunica√ß√£o industrial muito boa, resistente a ru√≠dos, possui arbitragem de hardware, acesso n√£o destrutivo ao barramento, confirma√ß√£o de hardware dos pacotes e, ao mesmo tempo - apenas dois fios e terra. Isso √© melhor que todos os RSs e menos monstruoso que a Ethernet (que √© bastante ex√≥tica no controle de motor MK). Por que abrir? Na verdade, existem dois protocolos comuns para o CAN, que s√£o o J1939 (‚Äúautomotivo‚Äù) e o CANopen (m√°quinas-ferramenta, automa√ß√£o, sensores, etc.). N√£o h√° muita diferen√ßa entre eles, mas o CANopen nos pareceu mais flex√≠vel, ent√£o o implementamos em nossa pr√≥pria pilha (driver). Quem n√£o sabe nada sobre o CANopen - sua principal fun√ß√£o, como muitos protocolos para o MK, √© fornecer acesso ao dicion√°rio de objetos (lista de vari√°veis ‚Äã‚Äãno C MK) em um endere√ßo espec√≠fico. Isso pode ser feito de duas maneiras principais:Mensagens SDO do tipo solicita√ß√£o-resposta, bem como mensagens DOP na forma de valores de envio constantes por timer ou evento (define o n√≠vel superior do que enviar e quando). Existem tamb√©m v√°rios servi√ßos de servi√ßo, como mensagens de emerg√™ncia, mensagens sobre a presen√ßa de dispositivos na rede (pulsa√ß√£o), etc. N√£o √© necess√°rio um assistente na rede: quem deseja - envia, a quem deseja - aceita.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/files/5e6/c70/423/5e6c70423a3840419cb3b46741987eb4.png" align="left"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Criamos a pilha CANopen n√£o apenas para MK, mas tamb√©m para o computador na forma de uma biblioteca. E j√° em sua base, o Windows escreveu seu pr√≥prio ambiente de n√≠vel superior. Primeiro, eles simplesmente acessaram as vari√°veis ‚Äã‚Äãdo dicion√°rio de objetos para que fosse poss√≠vel examinar e alterar as configura√ß√µes do sistema de controle (e existem centenas delas, a prop√≥sito!), Ent√£o eles criaram gr√°ficos consultando periodicamente o par√¢metro do dicion√°rio de objetos na rede e adicionaram o carregamento de formas de onda de matrizes MK (al√©m disso, a escolha do que oscilografar tamb√©m √© feita a partir de objetos vari√°veis ‚Äã‚Äãdo dicion√°rio). </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temos tudo a mesma coisa que fornece depura√ß√£o atrav√©s do JTAG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ou n√£o? N√£o, porque eu tamb√©m precisava da fun√ß√£o de atualizar o software via CAN. Apesar da presen√ßa de um gerenciador de inicializa√ß√£o CAN no Texas MK, decidimos fazer o nosso pr√≥prio, j√° que o padr√£o n√£o era o CANopen e poderia interferir na opera√ß√£o de outros dispositivos na rede enquanto costur√°vamos um, assim como os dispositivos poderiam interferir no firmware. Al√©m disso, houve problemas com a corre√ß√£o de erros e a perda de mensagens (embora o CAN seja muito bom, √†s vezes falha e o firmware √© uma coisa muito importante para n√£o fazer a verifica√ß√£o ou tentar enviar novamente um peda√ßo quebrado). Portanto, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementamos nosso ‚Äúprogramador‚Äù na rede CAN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas dentro da estrutura do protocolo CANOpen. Agora √© tudo. Agora fomos capazes de abandonar completamente o JTAG, usando-o apenas uma vez, para programar um novo MK.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, essa abordagem abriu novos horizontes de depura√ß√£o que n√£o t√≠nhamos visto antes. Como criamos o ambiente de n√≠vel superior de olho n√£o apenas nos programadores, mas tamb√©m nas ‚Äúpessoas comuns‚Äù, criamos todos os par√¢metros em nomes de idioma russo e documentamos o instalador de cada par√¢metro (a documenta√ß√£o n√£o √© o ambiente, mas o dispositivo, √© claro). E foi ben√©fico - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agora, se houver algum problema com a unidade, voc√™ n√£o precisa "puxar" o desenvolvedor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a equipe de atendimento ao cliente, em alguns casos, pode diagnosticar problemas de forma independente. Agora podemos receber um e-mail como ‚ÄúNossa unidade come√ßou a emitir sons estranhos √†s vezes; olhei para o oscilograma do sensor de posi√ß√£o, foi o que vi (foto). Eu verifiquei o aterramento da tela, ela caiu, soldou e tudo funcionou como deveria! ‚Äù E absolutamente n√£o h√° necessidade de ir a qualquer lugar ou voar! A segunda "descoberta" - se houver algum problema, pedimos ao cliente que conecte o computador ao equipamento e forne√ßa controle remoto da √°rea de trabalho pela Internet - lan√ßamos nosso ambiente de n√≠vel superior, oscilamos tudo, corrigimos os par√¢metros / firmware / dizemos que ele quebrou - lucro! Novamente, voc√™ n√£o precisa ir a lugar nenhum (o principal √© que a Internet esteja nas instala√ß√µes, pelo menos atrav√©s de uma rede celular).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao longo dos anos, esse programa de n√≠vel superior adquiriu pequenas fun√ß√µes, como cogumelos (um processo natural para o software que eles usam). Isso inclui trabalhar com o log de falha do dispositivo, salvar / carregar uma pepita de todos os par√¢metros em um arquivo no computador, configurar o painel de controle do dispositivo como um "painel de controle", manter registros de rede em um arquivo e retornar o tr√°fego de rede CAN por TCP / IP, e firmware / parametriza√ß√£o m√∫ltiplos autom√°ticos de dispositivos semelhantes na rede (se houver dezenas de dispositivos, piscar tudo com as m√£os √© pregui√ßoso, voc√™ precisa de um script), etc.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/files/9ba/78c/d12/9ba78cd1202b435f810aa132a0f3299e.png" align="left"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, agora alguma publicidade. Agora, ela j√° √© uma ferramenta muito poderosa (n√≥s a chamamos de UniCON), que em algumas tarefas parece mais funcional do que um software similar de marcas famosas para configurar suas unidades e dispositivos. Al√©m disso, ele n√£o est√° ligado a um dispositivo espec√≠fico - voc√™ pode configurar pelo menos uma unidade el√©trica, pelo menos um fog√£o, pelo menos um carregador - apenas o dicion√°rio de objetos √© alterado. Agora, em nossa empresa, n√£o vemos a oportunidade de concluir com √™xito um novo projeto complexo sem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nossas ferramentas de depura√ß√£o CANopen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Para trabalhar com o UniCON, basta incorporar nossa pilha CANopen no MK, ap√≥s o que o MK se transforma em um laborat√≥rio digital. Temos certeza de que todas as empresas que fabricam sistemas de controle s√©rios no MK possuem ferramentas de depura√ß√£o semelhantes. Por√©m, oferecemos nossa solu√ß√£o CANopen na forma de um produto de software independente, pois √© universalmente implementada em termos de independ√™ncia das fun√ß√µes do dispositivo. Atualmente, implementamos a pilha CANopen com as fun√ß√µes avan√ßadas descritas para o Texas Instruments C2000 MK, seus microcontroladores ARM (por exemplo, a fam√≠lia Concerto) e para o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K1921VK01T do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> NIIET OJSC. Portanto, se voc√™ precisar desenvolver um sistema de controle para um acionamento el√©trico ou outro objeto de controle complexo, convidamos voc√™ a cooperar.</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos coment√°rios, aguardamos cr√≠ticas do formul√°rio "Portanto, existe *** - faz o mesmo e de gra√ßa". Como procuramos ferramentas de depura√ß√£o semelhantes para funcionalidade do ARM por um longo tempo, chegamos a encontrar ambientes de desenvolvimento famosos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: Gra√ßas aos coment√°rios de   </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indemsys</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,   </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">olekl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e   </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LeonidLenin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encontramos fun√ß√µes de gr√°ficos em ambientes de desenvolvimento para ARM Keil e STMStudio ao trabalhar com o SWD. </font><font style="vertical-align: inherit;">No entanto, eles n√£o sabem como exibir uma matriz de dados da mem√≥ria MK na forma de um gr√°fico, que √© exatamente o necess√°rio para observar os processos velozes dos sistemas de controle (mas o STMStudio pode exibir gr√°ficos com um tempo de amostragem de cerca de 1 ms usando o cache de dados). </font><font style="vertical-align: inherit;">Tamb√©m interessante √© a ferramenta NXP FreeMaster - na descri√ß√£o e no prop√≥sito, √© muito semelhante ao nosso desenvolvimento UniCON, mas com caracter√≠sticas pr√≥prias. </font><font style="vertical-align: inherit;">Al√©m disso, o Segger J-Link possui sua pr√≥pria ferramenta de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exibi√ß√£o de forma de onda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt389123/">https://habr.com/ru/post/pt389123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt389113/index.html">O SSD mais espa√ßoso do mundo: 13 TB da Fixstars</a></li>
<li><a href="../pt389115/index.html">Prop√µe-se que √≥rg√£os e tecidos humanos para transplante sejam cultivados em animais.</a></li>
<li><a href="../pt389117/index.html">A impressora Ripple Maker 3D transfere a imagem ou o texto desejado para a superf√≠cie da espuma de caf√©</a></li>
<li><a href="../pt389119/index.html">Adicionando e configurando o banco de dados 1C ao servidor</a></li>
<li><a href="../pt389121/index.html">O Firefox 46 suportar√° v√°rios monitores com diferentes densidades de pixel</a></li>
<li><a href="../pt389125/index.html">Galactoseismologia: como gal√°xias an√£s constitu√≠das por mat√©ria escura deixam vest√≠gios no g√°s interestelar</a></li>
<li><a href="../pt389127/index.html">Marketing agressivo ou como a motiva√ß√£o de um arco brilhante no pulso ("enfeites") difere da motiva√ß√£o de uma pulseira de fitness</a></li>
<li><a href="../pt389129/index.html">Novo microcontrolador dom√©stico de controle de motor K1921VK01T da OJSC NIIET</a></li>
<li><a href="../pt389133/index.html">C√£es reconhecem emo√ß√µes humanas atrav√©s de v√°rios sentidos</a></li>
<li><a href="../pt389139/index.html">Drinky √© um rob√¥ amigo que est√° sempre l√°</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>