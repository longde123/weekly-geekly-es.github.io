<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏸 📔 👲🏻 Cara menggunakan systemd-nspawn untuk memulihkan sistem Linux 🏕️ 👔 🧘🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Terjemahan artikel disiapkan khusus untuk siswa kursus Administrator Linux . 




 Kami berurusan dengan kemampuan systemd untuk menjalankan kontainer...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara menggunakan systemd-nspawn untuk memulihkan sistem Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/470497/">  <b><i>Terjemahan artikel disiapkan khusus untuk siswa kursus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Administrator Linux</a> .</i></b> <br><br><img src="https://habrastorage.org/webt/89/hr/ul/89hrulhpdopce09kual8rabdjm4.png"><br><br><hr><br>  <i>Kami berurusan dengan kemampuan <b>systemd</b> untuk menjalankan kontainer untuk memulihkan sistem file root dari sistem yang rusak.</i> <i><br><br></i>  <i>Selama sistem GNU / Linux ada, administrator sistem perlu memulihkan dari kerusakan pada sistem file root, perubahan konfigurasi yang tidak disengaja, atau situasi lain yang mencegah sistem memuat ke keadaan "normal".</i> <br><a name="habracut"></a><br>  Biasanya, distribusi Linux menawarkan satu atau lebih opsi menu saat boot (misalnya, dalam menu GRUB) yang dapat digunakan untuk memperbaiki sistem yang rusak;  seringkali mereka mem-boot sistem dalam mode pengguna tunggal dengan penutupan sebagian besar layanan sistem.  Dalam kasus terburuk, pengguna dapat mengubah baris perintah kernel di bootloader untuk menggunakan shell standar sebagai proses init (PID 1).  Metode ini adalah yang paling kompleks dan sarat dengan kesulitan yang dapat menyebabkan hilangnya waktu dan frustrasi, sementara sistem perlu dipulihkan. <br><br>  Yang paling penting, semua metode ini mengasumsikan bahwa sistem yang rusak memiliki semacam konsol fisik, tetapi di era komputasi awan ini tidak dapat lagi diandalkan.  Tanpa konsol fisik, hanya ada beberapa opsi (jika masih tersedia) untuk mempengaruhi proses boot dengan cara ini.  Bahkan mesin fisik dapat berubah menjadi perangkat built-in kecil yang tidak memiliki konsol yang mudah digunakan, dan menemukan kabel yang tepat dan adaptor port serial dan mengatur emulator terminal, semuanya untuk menggunakan konsol pada port serial dalam keadaan darurat seringkali cukup rumit. <br><br>  Ketika sistem lain tersedia (dengan arsitektur yang sama dan konfigurasi yang umumnya serupa), cara umum untuk menyederhanakan proses pemulihan adalah dengan menghapus perangkat penyimpanan dari sistem yang rusak dan menghubungkannya ke sistem kerja sebagai perangkat sekunder.  Pada sistem fisik, ini biasanya mudah, dan sebagian besar platform komputasi awan juga dapat mendukung ini, karena mereka memungkinkan Anda untuk me-mount volume root dari instance yang rusak dalam contoh lain. <br><br>  Setelah sistem file root terhubung ke sistem lain, masalah sistem file korupsi diselesaikan menggunakan <b>fsck</b> dan alat-alat lainnya.  Memecahkan masalah kesalahan konfigurasi, paket yang rusak, atau masalah lain bisa lebih sulit karena mereka mengharuskan Anda untuk memasang sistem file dan menemukan serta memodifikasi file atau basis data konfigurasi yang benar. <br><br><h3>  Menggunakan systemd </h3><br>  Sebelum munculnya <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">systemd,</a></b> cara untuk memperbaiki konfigurasi dalam praktek adalah mengedit file konfigurasi menggunakan editor teks.  Menemukan file yang diperlukan dan memahami isinya adalah tugas terpisah yang berada di luar cakupan artikel ini. <br><br>  Ketika sistem GNU / Linux menggunakan <b>systemd</b> , banyak perubahan konfigurasi paling baik dilakukan dengan menggunakan alat yang disediakannya - misalnya, mengaktifkan atau menonaktifkan layanan memerlukan membuat atau menghapus tautan simbolis di berbagai tempat.  Alat <b>systemctl</b> digunakan untuk membuat perubahan ini, tetapi penggunaannya membutuhkan <b>systemd</b> instance untuk bekerja dan mendengarkan permintaan (melalui D-Bus).  Ketika sistem file root dipasang sebagai sistem file tambahan di komputer lain, instans systemd yang berfungsi tidak dapat digunakan untuk melakukan perubahan ini. <br><br>  Manual start dari systemd dari sistem target juga tidak praktis, karena ia dirancang sebagai proses PID 1 untuk mengontrol semua proses lainnya, yang mungkin bertentangan dengan instance yang sudah berjalan dalam sistem yang digunakan untuk koreksi. <br><br>  Untungnya, <b>systemd</b> memiliki kemampuan untuk menjalankan kontainer - sistem GNU / Linux yang dienkapsulasi sepenuhnya dengan PID 1 dan lingkungannya sendiri, yang menggunakan berbagai fungsi namespace yang ditawarkan oleh kernel Linux.  Tidak seperti alat-alat seperti Docker dan Rocket, <b>systemd</b> tidak memerlukan gambar kontainer untuk menjalankan kontainer;  ia dapat menjalankannya dengan hak akses root di mana saja di sistem file yang ada.  Ini dilakukan dengan menggunakan alat <b>systemd-nspawn</b> , yang akan membuat ruang nama sistem yang diperlukan dan memulai proses awal dalam wadah dan kemudian menyediakan konsol.  Tidak seperti <b>chroot</b> , yang hanya mengubah akar yang terlihat dari sistem file, jenis wadah ini akan memiliki namespace sistem file yang terpisah, sistem file yang sesuai dipasang di <b>/ dev</b> , <b>/ run</b> dan <b>/ proc</b> , serta proses namespace dan IPC yang terpisah.  Kunjungi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sumber daya</a> <b>systemd-nspawn</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">utama</a> untuk mempelajari lebih lanjut tentang fitur-fiturnya. <br><br><h3>  Contoh untuk menunjukkan cara kerjanya </h3><br>  Dalam contoh ini, perangkat penyimpanan yang berisi sistem file root dari sistem yang rusak terhubung ke sistem yang sedang berjalan, di mana ia muncul sebagai <b>/ dev / vdc</b> .  Nama perangkat akan bervariasi tergantung pada jumlah perangkat penyimpanan yang ada, jenis perangkat dan metode yang digunakan untuk menghubungkannya ke sistem.  Sistem file root dapat menggunakan seluruh perangkat penyimpanan atau berada di partisi di dalam perangkat;  karena konfigurasi yang paling umum (sederhana) menempatkan sistem file root di partisi pertama perangkat, <b>/ dev / vdc1</b> akan digunakan dalam contoh ini.  <i>Pastikan untuk mengganti nama perangkat dalam perintah di bawah ini dengan nama perangkat yang benar dari sistem Anda</i> . <br><br>  Sistem file root yang rusak juga bisa lebih kompleks daripada sistem file terpisah pada perangkat;  itu bisa berupa volume dalam LVM atau pada set perangkat yang digabungkan dalam array RAID.  Dalam kasus ini, Anda harus menyelesaikan langkah-langkah yang diperlukan untuk membuat dan mengaktifkan perangkat logis yang berisi sistem file sebelum tersedia untuk pemasangan.  Sekali lagi, langkah-langkah ini berada di luar cakupan artikel ini. <br><br><h3>  Persiapan yang diperlukan </h3><br>  Pertama, pastikan alat systemd-nspawn diinstal - sebagian besar distribusi GNU / Linux tidak menginstalnya secara default.  Ini disediakan oleh paket systemd-container di sebagian besar distribusi, jadi gunakan manajer paket distribusi Anda untuk menginstalnya.  Instruksi dalam contoh ini diuji menggunakan Debian 9, tetapi harus bekerja sama pada setiap distribusi GNU / Linux modern. <br><br>  Menggunakan perintah di bawah ini hampir pasti membutuhkan hak akses root, jadi Anda harus masuk sebagai root, menggunakan sudo untuk mendapatkan shell dengan hak akses root, atau menambahkan awalan sudo ke setiap perintah. <br><br><h3>  Periksa dan pasang sistem file </h3><br>  Pertama gunakan fsck untuk memeriksa struktur dan isi sistem file target: <br><br><pre><code class="bash hljs">$ fsck /dev/vdc1</code> </pre> <br>  Jika ia menemukan masalah dengan sistem file, jawab pertanyaan sesuai untuk memperbaikinya.  Jika sistem file rusak parah, itu tidak dapat diperbaiki, dalam hal ini Anda harus mencari cara lain untuk mengekstrak isinya. <br><br>  Sekarang buat direktori sementara dan pasang sistem file target ke dalamnya: <br><br><pre> <code class="bash hljs">$ mkdir /tmp/target-rescue $ mount /dev/vdc1 /tmp/target-rescue</code> </pre> <br>  Ketika sistem file dipasang, jalankan wadah dengan itu sebagai sistem file root: <br><br><pre> <code class="bash hljs">$ systemd-nspawn --directory /tmp/target-rescue --boot -- --unit rescue.target</code> </pre> <br>  Argumen baris perintah untuk memulai wadah: <br><br><ul><li>  <b>--directory / tmp / target-rescue</b> menyediakan path ke sistem file root kontainer. </li><li>  <b>--boot</b> mencari program inisialisasi yang sesuai di sistem file root dari wadah dan memulainya, meneruskan parameter ke sana dari baris perintah.  Dalam contoh ini, sistem target juga menggunakan <b>systemd</b> sebagai PID 1 dari proses, jadi parameter lainnya adalah untuknya.  Jika sistem target yang Anda pulihkan menggunakan beberapa alat lain sebagai PID 1 dari proses, Anda perlu mengkonfigurasi pengaturan yang sesuai. </li><li>  - Pisahkan parameter untuk <b>systemd-nspawn</b> dari yang dimaksudkan untuk PID 1 dari proses wadah. </li><li>  <b>--unit rescue.target</b> memberi tahu <b>systemd</b> dalam wadah nama target yang harus dicapainya selama proses boot.  Untuk menyederhanakan operasi pemulihan pada sistem target, boot dalam mode "pemulihan", bukan dalam mode multi-pengguna normal. </li></ul><br>  Jika semuanya berjalan dengan baik, Anda akan melihat output yang terlihat seperti ini: <br><br><pre> <code class="bash hljs">Spawning container target-rescue on /tmp/target-rescue. Press ^] three <span class="hljs-built_in"><span class="hljs-built_in">times</span></span> within 1s to <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> container. systemd 232 running <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD +IDN) Detected virtualization systemd-nspawn. Detected architecture arm. Welcome to Debian GNU/Linux 9 (Stretch)! Set hostname to &lt;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>&gt;. Failed to install release agent, ignoring: No such file or directory [ OK ] Reached target Swap. [ OK ] Listening on Journal Socket (/dev/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>). [ OK ] Started Dispatch Password Requests to Console Directory Watch. [ OK ] Reached target Encrypted Volumes. [ OK ] Created slice System Slice. Mounting POSIX Message Queue File System... [ OK ] Listening on Journal Socket. Starting Set the console keyboard layout... Starting Restore / save the current clock... Starting Journal Service... Starting Remount Root and Kernel File Systems... [ OK ] Mounted POSIX Message Queue File System. [ OK ] Started Journal Service. [ OK ] Started Remount Root and Kernel File Systems. Starting Flush Journal to Persistent Storage... [ OK ] Started Restore / save the current clock. [ OK ] Started Flush Journal to Persistent Storage. [ OK ] Started Set the console keyboard layout. [ OK ] Reached target Local File Systems (Pre). [ OK ] Reached target Local File Systems. Starting Create Volatile Files and Directories... [ OK ] Started Create Volatile Files and Directories. [ OK ] Reached target System Time Synchronized. Starting Update UTMP about System Boot/Shutdown... [ OK ] Started Update UTMP about System Boot/Shutdown. [ OK ] Reached target System Initialization. [ OK ] Started Rescue Shell. [ OK ] Reached target Rescue Mode. Starting Update UTMP about System Runlevel Changes... [ OK ] Started Update UTMP about System Runlevel Changes. You are <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rescue mode. After logging <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-string"><span class="hljs-string">"journalctl -xb"</span></span> to view system logs, <span class="hljs-string"><span class="hljs-string">"systemctl reboot"</span></span> to reboot, <span class="hljs-string"><span class="hljs-string">"systemctl default"</span></span> or ^D to boot into default mode. Give root password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> maintenance (or press Control-D to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>):</code> </pre> <br>  Dalam output ini, Anda dapat melihat bahwa <b>systemd</b> mulai sebagai proses init dalam wadah dan menentukan bahwa itu berjalan di dalam wadah sehingga dapat menyesuaikan perilakunya.  Untuk membawa wadah ke kondisi kerja, berbagai file unit diluncurkan, kemudian kata sandi root dari sistem target diminta.  Anda dapat memasukkan kata sandi root di sini jika Anda ingin meminta shell dengan hak akses root, atau Anda dapat menekan <b>Ctrl + D</b> untuk melanjutkan proses startup, yang akan menampilkan prompt login konsol yang biasa. <br><br>  Saat Anda membuat perubahan yang diperlukan pada sistem target, tekan <b>Ctrl +]</b> tiga kali berturut-turut;  ini akan menutup wadah dan mengembalikan Anda ke cangkang asli.  Dari sana, Anda dapat melakukan pembersihan dengan melepas sistem file dari sistem target dan menghapus direktori sementara: <br><br><pre> <code class="bash hljs">$ umount /tmp/target-rescue $ rmdir /tmp/target-rescue</code> </pre> <br>  Itu saja!  Sekarang Anda dapat menghapus perangkat penyimpanan sistem target dan mengembalikannya. <br><br>  Gagasan menggunakan <b>systemd-nspawn</b> dengan cara ini, terutama <b>opsi --boot</b> , berasal dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pertanyaan yang</a> <i>diposting di StackExchange.</i>  <i>Terima kasih kepada Shibumi dan kirbyfan64sos untuk jawaban yang bermanfaat untuk pertanyaan ini!</i> <br><br><h2>  Sumber Daya Linux Lebih Banyak </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apa itu Linux?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apa itu kontainer di Linux?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Linux Cheat Sheet Lanjutan</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Linux Cheat Sheet Perintah</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SELinux cheat sheet</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Linux Cheat Sheet Linux</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Artikel Linux terbaru kami</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id470497/">https://habr.com/ru/post/id470497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id470479/index.html">Mengapa melacak cookie berbahaya jika Anda tidak menyembunyikan apa pun</a></li>
<li><a href="../id470483/index.html">Laboratorium Teknologi Azure di Moskow</a></li>
<li><a href="../id470487/index.html">Kompetisi teknologi Radiofest-2019</a></li>
<li><a href="../id470489/index.html">Minggu Keamanan 41: Lebih Banyak Kerentanan dalam Kartu SIM, Dekripsi PDF</a></li>
<li><a href="../id470491/index.html">Melalui duri ke permainan mimpi - kemajuan dan evolusi makhluk</a></li>
<li><a href="../id470499/index.html">Cara menggunakan interupsi dalam Unity Animator secara maksimal</a></li>
<li><a href="../id470501/index.html">Monad "Pembaca" via async / tunggu di C #</a></li>
<li><a href="../id470503/index.html">Pengguna dan Otorisasi Kubernetes RBAC</a></li>
<li><a href="../id470511/index.html">TI di Armenia: sektor strategis dan bidang teknologi di negara ini</a></li>
<li><a href="../id470513/index.html">Bagaimana saya menemukan rumah pintar yang didominasi oleh botnet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>