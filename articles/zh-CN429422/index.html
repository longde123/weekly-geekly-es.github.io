<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨â€ğŸš€ ğŸ¥ ğŸŒ  UHCIæˆ–ç¬¬ä¸€ä¸ªUSB ğŸ‘ğŸ¿ ğŸ“‚ ğŸ“¯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ç¾å¥½çš„ä¸€å¤©ï¼Œäº²çˆ±çš„è¯»è€…ï¼ æˆ‘è¢«è¦æ±‚å†™æœ‰å…³UHCIçš„æ–‡ç« -å¥½å§ï¼Œæˆ‘å†™ã€‚ 

 ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ²¡æœ‰è¶³å¤Ÿçš„é©±åŠ¨ç¨‹åºç¼–å†™æŠ€èƒ½å’Œç¡¬ä»¶çš„é˜…è¯»æ–‡æ¡£ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°æœ¬æ–‡å¾ˆæœ‰ç”¨ã€‚ ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šæ‚¨è¦ä¸ºå°å‹PCç¼–å†™OSï¼Œä»¥ä½¿æŸäº›Windowsæˆ–å…¶ä»–Linuxå‘è¡Œç‰ˆä¸ä¸‹è½½ç¡¬ä»¶ï¼Œå¹¶ä¸”å°†å…¶æ‰€æœ‰åŠŸèƒ½ä¸“ç”¨äºæ‚¨è‡ªå·±çš„ç›®çš„ã€‚ 

 ä»€...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>UHCIæˆ–ç¬¬ä¸€ä¸ªUSB</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429422/"><img src="https://habrastorage.org/webt/89/wk/ye/89wkyeuwi_jbnzlge2bawtlabum.png"><br><br> ç¾å¥½çš„ä¸€å¤©ï¼Œäº²çˆ±çš„è¯»è€…ï¼ æˆ‘è¢«è¦æ±‚å†™æœ‰å…³UHCIçš„æ–‡ç« -å¥½å§ï¼Œæˆ‘å†™ã€‚ <br><br> ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ²¡æœ‰è¶³å¤Ÿçš„é©±åŠ¨ç¨‹åºç¼–å†™æŠ€èƒ½å’Œç¡¬ä»¶çš„é˜…è¯»æ–‡æ¡£ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°æœ¬æ–‡å¾ˆæœ‰ç”¨ã€‚ ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šæ‚¨è¦ä¸ºå°å‹PCç¼–å†™OSï¼Œä»¥ä½¿æŸäº›Windowsæˆ–å…¶ä»–Linuxå‘è¡Œç‰ˆä¸ä¸‹è½½ç¡¬ä»¶ï¼Œå¹¶ä¸”å°†å…¶æ‰€æœ‰åŠŸèƒ½ä¸“ç”¨äºæ‚¨è‡ªå·±çš„ç›®çš„ã€‚ <br><a name="habracut"></a><br><h2> ä»€ä¹ˆæ˜¯UHCIï¼Ÿ </h2><br> æˆ‘æƒ³ï¼Œä¸ºäº†é¿å…å†æ¬¡è°ˆè®ºä»€ä¹ˆå’Œä¸ºä»€ä¹ˆè¿™ä¸ªè¯é¢˜ï¼Œè¯·ç•™ä¸‹æˆ‘ä»¥å‰æœ‰å…³EHCIçš„æ–‡ç« çš„é“¾æ¥ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œæˆ³</a> <br>  UHCI-é€šç”¨ä¸»æœºæ§åˆ¶å™¨æ¥å£ï¼Œä½œä¸ºPCIè®¾å¤‡è¿è¡Œï¼Œä½†æ˜¯ä¸EHCIä¸åŒï¼Œå®ƒä½¿ç”¨ç«¯å£è€Œä¸æ˜¯MMIOï¼ˆå†…å­˜æ˜ å°„çš„IOï¼‰ã€‚ <br><br><img src="https://habrastorage.org/webt/nk/bl/--/nkbl--cqrxvs21lcitfothfcw4k.png"><br><br><h2> ä»¥ä¸‹ä½¿ç”¨çš„æœ¯è¯­ </h2><br><ul><li>  USBé©±åŠ¨ç¨‹åºï¼ˆUSBDï¼‰-USBé©±åŠ¨ç¨‹åºæœ¬èº« </li><li>  HCï¼ˆä¸»æœºæ§åˆ¶å™¨ï¼‰-ä¸»æœºæ§åˆ¶å™¨ï¼Œæˆ–è€…ä»…ä»…æ˜¯æˆ‘ä»¬çš„UHCI </li><li> ä¸»æœºæ§åˆ¶å™¨é©±åŠ¨ç¨‹åºï¼ˆHCDï¼‰-è¿æ¥ç¡¬ä»¶å’ŒUSBDçš„é©±åŠ¨ç¨‹åº </li><li>  USBè®¾å¤‡-USBè®¾å¤‡æœ¬èº« </li></ul><br><h2> æ•°æ®ä¼ è¾“ç±»å‹ </h2><br> ç­‰æ—¶-ç­‰æ—¶ä¼ è¾“ï¼Œå…·æœ‰ç»™å®šçš„æ•°æ®ä¼ è¾“é¢‘ç‡ã€‚ å®ƒå¯ä»¥ç”¨äºä¾‹å¦‚USBéº¦å…‹é£ç­‰ã€‚ <br><br> ä¸­æ–­-ä»è®¾å¤‡è¿›è¡Œå°çš„è‡ªå‘æ•°æ®ä¼ è¾“ã€‚ ä¸­æ–­ä¼ è¾“ç±»å‹æ”¯æŒéœ€è¦å¯é¢„æµ‹çš„æœåŠ¡é—´éš”ä½†ä¸ä¸€å®šæä¾›å¯é¢„æµ‹çš„æ•°æ®æµçš„è®¾å¤‡ã€‚ é€šå¸¸ç”¨äºè¯¸å¦‚é”®ç›˜å’Œå®šç‚¹è®¾å¤‡ä¹‹ç±»çš„è®¾å¤‡ï¼Œè¿™äº›è®¾å¤‡å¯èƒ½ä¸ä¼šé•¿æ—¶é—´æä¾›æ•°æ®ï¼Œä½†æ˜¯åœ¨æœ‰æ•°æ®è¦å‘é€æ—¶éœ€è¦å¿«é€Ÿå“åº”ã€‚ <br><br> æ§åˆ¶-æœ‰å…³è®¾å¤‡çŠ¶æ€ï¼ŒçŠ¶æ€å’Œé…ç½®çš„ä¿¡æ¯çš„ä¼ è¾“ç±»å‹ã€‚ æ§åˆ¶ä¼ è¾“ç±»å‹ç”¨äºæä¾›ä»ä¸»æœºåˆ°USBè®¾å¤‡çš„æ§åˆ¶é€šé“ã€‚ æ§åˆ¶ä¼ è¾“å§‹ç»ˆç”±è®¾ç½®é˜¶æ®µï¼Œé›¶ä¸ªæˆ–å¤šä¸ªæ•°æ®é˜¶æ®µä»¥åŠçŠ¶æ€é˜¶æ®µç»„æˆã€‚ å¿…é¡»ä»¥FIFOæ¨¡å¼å¤„ç†å‘ç»™å®šç«¯ç‚¹çš„æ§åˆ¶ä¼ è¾“ã€‚ å¦‚æœå°†æ§åˆ¶æƒä¼ é€’ç»™åŒä¸€ç«¯ç‚¹ï¼Œåˆ™äº¤ç»‡ä¼šå¯¼è‡´ä¸å¯é¢„æµ‹çš„è¡Œä¸ºã€‚ <br><br> æ‰¹é‡-æ•°æ®æ•°ç»„çš„ä¼ è¾“ç±»å‹ã€‚ ä¾‹å¦‚ï¼Œåœ¨MassStorageè®¾å¤‡ä¸­ä½¿ç”¨ã€‚ <br><br><img src="https://habrastorage.org/webt/j1/d5/4a/j1d54aqfs0iicr_-dfpmkwx8d_e.png"><br><br> è¿™å°±æ˜¯1msæ—¶é—´åˆ†å¸ƒçš„æ ·å­-å¤„ç†ä¸€å¸§ã€‚ <br><br><h2> æ—¶é—´åˆ†é… </h2><br> ä¸»æœºæ§åˆ¶å™¨é€šè¿‡æ¯1 msç”Ÿæˆä¸€ä¸ªå¸§å¼€å§‹ï¼ˆSOFï¼‰æ•°æ®åŒ…æ¥æ”¯æŒå®æ—¶æ•°æ®ä¼ é€’ã€‚ å½“ä¸»æœºæ§åˆ¶å™¨ä¸­çš„SOFè®¡æ•°å™¨åˆ°æœŸæ—¶ï¼Œå°†ç”Ÿæˆä¸€ä¸ªSOFæ•°æ®åŒ…ï¼ˆå›¾3ï¼‰ã€‚ ä¸»æœºæ§åˆ¶å™¨å°†SOFè®¡æ•°å™¨åˆå§‹åŒ–ä¸º1 msçš„å¸§æ—¶é—´ã€‚ é€šè¿‡å¯¹SOFæ›´æ”¹å¯„å­˜å™¨è¿›è¡Œç¼–ç¨‹ï¼Œå¯ä»¥å¯¹æ­¤å€¼ï¼ˆä»¥åŠå¸§æ—¶é—´æ®µï¼‰è¿›è¡Œå°çš„æ›´æ”¹ã€‚ å¦‚æœéœ€è¦ï¼Œæ­¤åŠŸèƒ½ä½¿æ‚¨å¯ä»¥å¯¹å¸§æ—¶é—´æ®µè¿›è¡Œè¾ƒå°çš„æ›´æ”¹ï¼Œä»¥åœ¨æ•´ä¸ªUSBç³»ç»Ÿä¸­ä¿æŒå®æ—¶åŒæ­¥ã€‚ <br><br> ä¸»æœºæ§åˆ¶å™¨åœ¨æ¯ä¸ªSOFæ•°æ®åŒ…ä¸­åŒ…å«å¸§å·ã€‚ è¯¥å¸§å·å®æ—¶å”¯ä¸€åœ°ç¡®å®šå¸§å‘¨æœŸã€‚ å½“ä¸»æœºæ§åˆ¶å™¨å¼€å§‹ä¸‹ä¸€ä¸ªå¸§æ—¶é—´å¹¶ç”Ÿæˆå…·æœ‰ç›¸åº”å¸§å·çš„å¦ä¸€ä¸ªSOFæ•°æ®åŒ…æ—¶ï¼Œå¸§ç»“æŸæ¡ä»¶ï¼ˆEOFï¼‰å‘ç”Ÿåœ¨1 msæ—¶é—´é—´éš”çš„ç»“å°¾ã€‚ åœ¨å¸§å‘¨æœŸä¸­ï¼Œæ•°æ®ä½œä¸ºä¿¡æ¯åŒ…ä¼ è¾“ã€‚ å¸§æ—¶é—´æ®µç”±ä¸»æœºæ§åˆ¶å™¨ä¸¥æ ¼æ‰§è¡Œï¼Œå¹¶ä¸”å½“å‰å¸§ä¸­çš„æ•°æ®åŒ…ä¸èƒ½è¶…å‡ºEOFï¼ˆè¯·å‚è§USBè§„èŒƒçš„ç¬¬11ç« ï¼‰ã€‚ ä¸»æœºæ§åˆ¶å™¨æ”¯æŒå¸§ä¹‹é—´çš„å®æ—¶æ•°æ®ä¼ è¾“åŒæ­¥ï¼Œé“¾æ¥å¸§å·ä»¥æ‰§è¡Œå¸§åˆ—è¡¨ä¸­çš„ç‰¹å®šæ¡ç›®ã€‚ ä¸»æœºæ§åˆ¶å™¨çš„å¸§è®¡æ•°å™¨ç”Ÿæˆä¸€ä¸ªå¸§å·ï¼ˆ11ä½å€¼ï¼‰ï¼Œå¹¶å°†å…¶åŒ…æ‹¬åœ¨æ¯ä¸ªSOFæ•°æ®åŒ…ä¸­ã€‚ è®¡æ•°å™¨é€šè¿‡å¯„å­˜å™¨ç¼–ç¨‹ï¼Œæ¯ä¸ªå¸§å‘¨æœŸé€’å¢ã€‚ ä¸»æœºæ§åˆ¶å™¨ä½¿ç”¨å¸§å·çš„ä½10ä½ä½œä¸ºå…·æœ‰1024å¸§çš„å¸§åˆ—è¡¨ä¸­çš„ç´¢å¼•ï¼Œè¯¥ç´¢å¼•å­˜å‚¨åœ¨ç³»ç»Ÿå†…å­˜ä¸­ã€‚ å› æ­¤ï¼Œç”±äºå¸§è®¡æ•°å™¨æ§åˆ¶ä»å¸§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæ¡ç›®ï¼Œå› æ­¤ä¸»æœºæ§åˆ¶å™¨åœ¨ç»™å®šå¸§å‘¨æœŸå†…å¤„ç†åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®ã€‚ ä¸»æœºæ§åˆ¶å™¨å°†æ‰©å±•åˆ°æ¯ä¸ªæ–°å¸§çš„å¸§åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªæ¡ç›®ã€‚ è¿™ç¡®ä¿äº†åœ¨ç‰¹å®šå¸§ä¸­æ‰§è¡ŒåŒæ­¥ä¼ è¾“ã€‚ <br><br> å›¾3ï¼š <br><br><img src="https://habrastorage.org/webt/d8/pj/iw/d8pjiwyjanx3yse7tmmtnyeooqe.png"><br><br><h2>  UHCIç»“æ„ </h2><br> ä¸€åˆ‡éƒ½ä¸EHCIå®Œå…¨ç›¸åŒã€‚ å‘HCè¯·æ±‚çš„ç¤ºä¾‹ï¼š <br><br><img src="https://habrastorage.org/webt/io/1d/sm/io1dsmtielklqhm84nhekufybj4.png"><br><br><h2> é…ç½®å’Œè®¿é—®UHCI </h2><br> å› æ­¤ï¼Œæ­£å¦‚æˆ‘ä¹‹å‰æ‰€è¯´ï¼ŒUHCIé€šè¿‡ç«¯å£å·¥ä½œï¼Œå› æ­¤ä»PCIæˆ‘ä»¬éœ€è¦æ‰¾å‡ºUHCIå¯„å­˜å™¨çš„åŸºç¡€ã€‚ <br><br><img src="https://habrastorage.org/webt/gz/ql/3f/gzql3fejuar2ko92q8dnok-ehpi.png"><br><br> åœ¨åç§»é‡0x20å¤„æœ‰4ä¸ªå­—èŠ‚-IO Baseã€‚ å…³äºIO Baseï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å¯„å­˜å™¨ï¼š <br><br><img src="https://habrastorage.org/webt/jk/a5/od/jka5odl_cbgmqxcdsix8e-1tkl0.png"><br><br><h2>  UHCIå¯„å­˜å™¨ </h2><br><ul><li>  USBCMDæ˜¯ç”¨äºæ§åˆ¶HCçš„å¯„å­˜å™¨ã€‚ ä½ï¼š <ul><li> ä½6æ˜¯æ ‡å¿—ï¼Œè¡¨æ˜è®¾å¤‡å·²æˆåŠŸé…ç½®å’Œåˆå§‹åŒ–ã€‚ </li><li> ä½1-HCå¤ä½ã€‚ è®¾ç½®ä¸ºé‡ç½®HCã€‚ </li><li> ä½0-è¿è¡Œ/åœæ­¢ã€‚ æ˜¾ç¤ºHCçŠ¶æ€ã€‚  1-æœ‰æ•ˆï¼Œ0-å¦ã€‚ </li></ul></li><li>  USBSTS-çŠ¶æ€å¯„å­˜å™¨ã€‚ ä½ï¼š <ul><li> ä½5-HCåœæ­¢ã€‚ å‘ç”Ÿé”™è¯¯ï¼Œæˆ–è€…æ§åˆ¶å™¨å·²æˆåŠŸå®ŒæˆHCå¤ä½ã€‚ </li><li> ä½4-ä¸»æœºæ§åˆ¶å™¨è¿›ç¨‹é”™è¯¯ã€‚ å½“å‘ç”Ÿä¸¥é‡é”™è¯¯å¹¶ä¸”HCæ— æ³•ç»§ç»­æ’é˜Ÿå’ŒTDæ—¶ï¼Œè¯¥ä½ç½®1ã€‚ </li><li> ä½3-ä¸»æœºç³»ç»Ÿé”™è¯¯ã€‚  PCIé”™è¯¯ã€‚ </li><li> ä½1-é”™è¯¯ä¸­æ–­ã€‚ è¡¨ç¤ºå·²å‘ç”Ÿé”™è¯¯ï¼Œå¹¶ä¸”HCäº§ç”Ÿäº†ä¸­æ–­ã€‚ </li><li> ä½0-ä¸­æ–­ã€‚ è¡¨ç¤ºHCäº§ç”Ÿäº†ä¸€ä¸ªä¸­æ–­ã€‚ </li></ul></li><li>  USBINTR-ä¸­æ–­è®¾ç½®å¯„å­˜å™¨ã€‚ ä½ï¼š <ul><li> ä½2-IOC-å®Œæˆä¸­æ–­-åœ¨äº‹åŠ¡ç»“æŸæ—¶ç”Ÿæˆä¸€ä¸ªä¸­æ–­ã€‚ </li></ul></li><li>  FRNUM-å½“å‰å¸§çš„ç¼–å·ï¼ˆå°†å…¶å–å€¼ä¸º0x3FFï¼Œä»¥è·å–æ­£ç¡®çš„å€¼ï¼‰ã€‚ </li><li>  FLBASEADD-å¸§åˆ—è¡¨åŸºåœ°å€-å¸§åˆ—è¡¨çš„åœ°å€ã€‚ </li><li>  PORTSC-ç«¯å£çŠ¶æ€å’Œæ§åˆ¶-çŠ¶æ€å’Œç«¯å£æ§åˆ¶å¯„å­˜å™¨ã€‚ ä½ï¼š <ul><li> ä½9-ç«¯å£å¤ä½-1-è¦å¤ä½çš„ç«¯å£ã€‚ </li><li> ä½8-æŒ‡ç¤ºå°†ä½é€Ÿè®¾å¤‡è¿æ¥åˆ°ç«¯å£ </li><li> ä½3-æŒ‡ç¤ºç«¯å£æ‰“å¼€çŠ¶æ€å·²æ›´æ”¹ </li><li> ä½2-æŒ‡ç¤ºç«¯å£æ˜¯å¦å¯ç”¨ </li><li> ä½1-æŒ‡ç¤ºè®¾å¤‡çš„çŠ¶æ€å·²è¿æ¥åˆ°ç«¯å£ </li><li> ä½0-æŒ‡ç¤ºè®¾å¤‡å·²è¿æ¥åˆ°ç«¯å£ã€‚ </li></ul></li></ul><br><h2> ç»“æ„ä½“ </h2><br><h3> æ¡†æ¶åˆ—è¡¨æŒ‡é’ˆ </h3><br><img src="https://habrastorage.org/webt/oc/y8/a6/ocy8a6is-xd60i9bxmtdjjyqcdy.png"><br><br><h3> ä¼ è¾“è§£ç å™¨ </h3><br><img src="https://habrastorage.org/webt/jz/sh/bl/jzshblpig4inzxxtzkzxlmvsvq8.png"><br><br><h5>  TDæ§åˆ¶ä¸çŠ¶æ€ </h5>  ã€‚ ä½ï¼š <br><ul><li> ä½28-27-é”™è¯¯è®¡æ•°å™¨ï¼Œç±»ä¼¼äºEHCIã€‚ </li><li><ul><li> ä½26-1 =ä½é€Ÿè®¾å¤‡ï¼Œ0 =å…¨é€Ÿè®¾å¤‡ã€‚ </li><li> ä½25-1 =ç­‰æ—¶TD </li><li>  Bit 24-å›½é™…å¥¥å§”ä¼š </li><li> ä½23-16-çŠ¶æ€ï¼š </li><li> ä½23-è¡¨ç¤ºå®ƒæ˜¯æ´»åŠ¨çš„TD </li><li>  Bit 22-åœè½¬ </li><li> ä½21-æ•°æ®ç¼“å†²åŒºé”™è¯¯ </li><li> ç¬¬20ä½-æ£€æµ‹åˆ°å£°éŸ³ä¸ç¨³ </li><li>  Bit 19-NAK </li></ul></li><li> ä½10-0ï¼šä¸»æœºæ§åˆ¶å™¨ä¼ è¾“çš„å­—èŠ‚æ•°ã€‚ </li></ul><br><h5>  TDä»£å¸ </h5><br><ul><li> ä½31:21-Max Packet Lenï¼Œç±»ä¼¼äºEHCI </li><li> ä½19-æ•°æ®åˆ‡æ¢ï¼Œç±»ä¼¼äºEHCI </li><li> ä½18:15-ç«¯ç‚¹å· </li><li> ä½18:14-è®¾å¤‡åœ°å€ </li><li> ä½7ï¼š0-PIDã€‚ è¾“å…¥= 0x69ï¼Œè¾“å‡º= 0xE1ï¼Œè®¾ç½®= 0x2D </li></ul><br><h3> é˜Ÿåˆ—å¤´ </h3><br><img src="https://habrastorage.org/webt/-4/pb/ia/-4pbiakp01iozcmkne4q1tums4i.png"><br><br><h2> ä»£å· </h2><br> åˆå§‹åŒ–å’Œé…ç½®HCï¼š <br><br><pre><code class="cpp hljs">PciBar bar; PciGetBar(&amp;bar, id, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (~bar.flags &amp; PCI_BAR_IO) { <span class="hljs-comment"><span class="hljs-comment">// Only Port I/O supported return; } unsigned int ioAddr = bar.u.port; UhciController *hc = VMAlloc(sizeof(UhciController)); hc-&gt;ioAddr = ioAddr; hc-&gt;frameList = VMAlloc(1024 * sizeof(u32) + 8292); hc-&gt;frameList = ((int)hc-&gt;frameList / 4096) * 4096 + 4096; hc-&gt;qhPool = (UhciQH *)VMAlloc(sizeof(UhciQH) * MAX_QH + 8292); hc-&gt;qhPool = ((int)hc-&gt;qhPool / 4096) * 4096 + 4096; hc-&gt;tdPool = (UhciTD *)VMAlloc(sizeof(UhciTD) * MAX_TD + 8292); hc-&gt;tdPool = ((int)hc-&gt;tdPool / 4096) * 4096 + 4096; memset(hc-&gt;qhPool, 0, sizeof(UhciQH) * MAX_QH); memset(hc-&gt;tdPool, 0, sizeof(UhciTD) * MAX_TD); memset(hc-&gt;frameList, 0, 4 * 1024); // Frame list setup UhciQH *qh = UhciAllocQH(hc); qh-&gt;head = TD_PTR_TERMINATE; qh-&gt;element = TD_PTR_TERMINATE; qh-&gt;transfer = 0; qh-&gt;qhLink.prev = &amp;qh-&gt;qhLink; qh-&gt;qhLink.next = &amp;qh-&gt;qhLink; hc-&gt;asyncQH = qh; for (uint i = 0; i &lt; 1024; ++i) hc-&gt;frameList[i] = 2 | (u32)(uintptr_t)qh; IoWrite16(hc-&gt;ioAddr + REG_INTR, 0); IoWrite16(hc-&gt;ioAddr + REG_CMD, IoRead16(hc-&gt;ioAddr + REG_CMD)&amp;(~1)); unsigned short cfg = PciRead16(id, 4); PciWrite16(id, 4, cfg &amp; (~1)); PciWrite16(id, 0x20, (short)-1); unsigned short size = ~(PciRead16(id, 0x20)&amp;(~3)) + 1; PciWrite16(id, 0x20, hc-&gt;ioAddr); PciWrite16(id, 4, cfg | 5); // Disable Legacy Support IoWrite16(hc-&gt;ioAddr + REG_LEGSUP, 0x8f00); // Disable interrupts IoWrite16(hc-&gt;ioAddr + REG_INTR, 0); // Assign frame list IoWrite16(hc-&gt;ioAddr + REG_FRNUM, 0); IoWrite32(hc-&gt;ioAddr + REG_FRBASEADD, (int)hc-&gt;frameList); IoWrite16(hc-&gt;ioAddr + REG_SOFMOD, 0x40); // Clear status IoWrite16(hc-&gt;ioAddr + REG_STS, 0xffff); // Enable controller IoWrite16(hc-&gt;ioAddr + REG_CMD, 0x1); // Probe devices UhciProbe(hc, size);</span></span></code> </pre> <br> ç«¯ç‚¹å’Œæ§åˆ¶è¯·æ±‚ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ------------------------------------------------------------------------------------------------ static void UhciDevControl(UsbDevice *dev, UsbTransfer *t) { UhciController *hc = (UhciController *)dev-&gt;hc; UsbDevReq *req = t-&gt;req; // Determine transfer properties uint speed = dev-&gt;speed; uint addr = dev-&gt;addr; uint endp = 0; uint maxSize = dev-&gt;maxPacketSize; uint type = req-&gt;type; uint len = req-&gt;len; // Create queue of transfer descriptors UhciTD *td = UhciAllocTD(hc); if (!td) { return; } UhciTD *head = td; UhciTD *prev = 0; // Setup packet uint toggle = 0; uint packetType = TD_PACKET_SETUP; uint packetSize = sizeof(UsbDevReq); UhciInitTD(td, prev, speed, addr, endp, toggle, packetType, packetSize, req); prev = td; // Data in/out packets packetType = type &amp; RT_DEV_TO_HOST ? TD_PACKET_IN : TD_PACKET_OUT; u8 *it = (u8 *)t-&gt;data; u8 *end = it + len; while (it &lt; end) { td = UhciAllocTD(hc); if (!td) { return; } toggle ^= 1; packetSize = end - it; if (packetSize &gt; maxSize) { packetSize = maxSize; } UhciInitTD(td, prev, speed, addr, endp, toggle, packetType, packetSize, it); it += packetSize; prev = td; } // Status packet td = UhciAllocTD(hc); if (!td) { return; } toggle = 1; packetType = type &amp; RT_DEV_TO_HOST ? TD_PACKET_OUT : TD_PACKET_IN; UhciInitTD(td, prev, speed, addr, endp, toggle, packetType, 0, 0); // Initialize queue head UhciQH *qh = UhciAllocQH(hc); UhciInitQH(qh, t, head); // Wait until queue has been processed UhciInsertQH(hc, qh); UhciWaitForQH(hc, qh); } // ------------------------------------------------------------------------------------------------ static void UhciDevIntr(UsbDevice *dev, UsbTransfer *t) { UhciController *hc = (UhciController *)dev-&gt;hc; // Determine transfer properties uint speed = dev-&gt;speed; uint addr = dev-&gt;addr; uint endp = t-&gt;endp-&gt;desc-&gt;addr &amp; 0xf; // Create queue of transfer descriptors UhciTD *td = UhciAllocTD(hc); if (!td) { t-&gt;success = false; t-&gt;complete = true; return; } UhciTD *head = td; UhciTD *prev = 0; // Data in/out packets uint toggle = t-&gt;endp-&gt;toggle; uint packetType = TD_PACKET_IN; //Here for compiler, on some last expression hadn't worked if (t-&gt;endp-&gt;desc-&gt;addr &amp; 0x80) packetType = TD_PACKET_IN; else packetType = TD_PACKET_OUT; uint packetSize = t-&gt;len; UhciInitTD(td, prev, speed, addr, endp, toggle, packetType, packetSize, t-&gt;data); // Initialize queue head UhciQH *qh = UhciAllocQH(hc); UhciInitQH(qh, t, head); // Schedule queue UhciInsertQH(hc, qh); if(t-&gt;w) UhciWaitForQH(hc, qh); }</span></span></code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN429422/">https://habr.com/ru/post/zh-CN429422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486156/index.html">Como eu ensinei, e depois escrevi um manual de treinamento em Python</a></li>
<li><a href="../pt486158/index.html">VisualizaÃ§Ã£o da traduÃ§Ã£o automÃ¡tica neural (modelos seq2seq com mecanismo de atenÃ§Ã£o)</a></li>
<li><a href="../pt486164/index.html">CoronavÃ­rus 2019-nCoV. Perguntas frequentes sobre proteÃ§Ã£o respiratÃ³ria e desinfecÃ§Ã£o</a></li>
<li><a href="../pt486174/index.html">Tenho rotatividade zero</a></li>
<li><a href="../zh-CN429420/index.html">PlayStation Classicä½¿ç”¨PCSX ReARMedä»¿çœŸå™¨è¿›è¡Œæ“ä½œï¼Œæ— ä¸“æœ‰è§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="../zh-CN429424/index.html">æˆ´å§†å‹’å’Œåšä¸–çš„Robotaxiå°†äº®ç›¸åŠ åˆ©ç¦å°¼äºš</a></li>
<li><a href="../zh-CN429426/index.html">QGISå’Œç“·ç –å‡ºå£</a></li>
<li><a href="../zh-CN429448/index.html">æˆ‘ä»¬åœ¨LabVIEWä¸­ç¼–å†™FPGAåŠ è½½å™¨ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN429450/index.html">Rustä¸­çš„é€šç”¨ç¼–ç¨‹æŠ€æœ¯ï¼šæˆ‘ä»¬å¦‚ä½•å°†Exonumä»Ironè½¬æ¢ä¸ºactix-web</a></li>
<li><a href="../zh-CN429452/index.html">äº”è§’å¤§æ¥¼å¼€å§‹è§£å¯†å…¶ä»–äººçš„æ¶æ„è½¯ä»¶</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>