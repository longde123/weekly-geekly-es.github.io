<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèø üë©üèæ‚Äçüíª üë®‚Äç‚öïÔ∏è So diagnostizieren Sie SDK-Integrationsprobleme. Die Erfahrung des SDK-Entwicklungsteams von Yandex Mobile Ads üôä üí± ü§Ωüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo allerseits! Mein Name ist Dmitry Fisko, ich entwickle das Yandex Mobile Ads SDK. Unsere Bibliothek wurde entwickelt, um mobile Anwendungen auf d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So diagnostizieren Sie SDK-Integrationsprobleme. Die Erfahrung des SDK-Entwicklungsteams von Yandex Mobile Ads</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/460597/"> Hallo allerseits!  Mein Name ist Dmitry Fisko, ich entwickle das Yandex Mobile Ads SDK.  Unsere Bibliothek wurde entwickelt, um mobile Anwendungen auf den Android- und iOS-Plattformen zu monetarisieren.  Heute m√∂chte ich Ihnen erz√§hlen, wie wir die Analyse komplexer SDK-Integrationsfehler in Android-Anwendungen vereinfacht haben.  Vielleicht ist unsere Erfahrung f√ºr Sie n√ºtzlich. <br><br>  Unsere Benutzer - Entwickler mobiler Anwendungen - lesen die Dokumentation nicht immer, daher finden sie manchmal komplizierte M√∂glichkeiten zur Verwendung des SDK.  Eine falsche Integration kann die Effektivit√§t der Werbung und damit das Einkommen des Entwicklers verringern.  Um Entwicklern die Monetarisierung von Anwendungen zu erleichtern, haben wir ein proaktives √úberwachungssystem entwickelt, das die Leistung einer mobilen Anwendung analysiert.  Wenn wir durch √úberwachung etwas √ºber das Problem erfahren, setzen wir uns mit den Entwicklern in Verbindung und helfen ihnen, die Ursache des Problems zu finden und es zu l√∂sen. <br><br>  Leider k√∂nnen nicht alle SDK-Integrationsfehler durch √úberwachung identifiziert werden.  In einem solchen Fall wenden wir uns an den Partner, um die Einzelheiten der Integration zu kl√§ren.  Dann versuchen wir, die Ursache der Probleme zu ermitteln und sie zu l√∂sen.  Wenn selbst diese Informationen nicht ausreichen, um die Fehlerursache zu ermitteln, bitten wir den Partner um Erlaubnis, die Anwendung r√ºckentwickeln zu d√ºrfen.  Nach der Erlaubnis beginnen wir, die Arbeit des Werbe-SDK in der Anwendung als Black Box zu betrachten.  Wir zeigen die Netzwerkaktivit√§t √ºber einen Proxy an, √ºberpr√ºfen die Anzeige von Werbeansichten √ºber den Layout-Inspektor usw. <br><a name="habracut"></a><br>  Das Anzeigen der Netzwerkaktivit√§t einer Anwendung ab Android 7.0 ist problematisch, da das System standardm√§√üig den vom Benutzer festgelegten Zertifikaten nicht vertraut.  Die Installation des Zertifikats ist erforderlich, um den SSL-Verkehr der Anwendung √ºber einen Proxy anzuzeigen.  Das Problem wird entweder durch Starten der Anwendung auf Android-Versionen vor 7.0 oder durch Hinzuf√ºgen von network_security_config zur Anwendung behoben, z. B. √ºber Apktool.  Sie k√∂nnen die Anzeige von Werbeansichten √ºber das Dienstprogramm Layout Inspector anzeigen, indem Sie die Anwendung auf einem Emulator oder einem Ger√§t ausf√ºhren.  In diesem Fall m√ºssen Sie die Datei AndroidManifest.xml √§ndern, indem Sie das Attribut <i>debuggable = true</i> √ºber Apktool hinzuf√ºgen. <br><br>  Wenn die Black-Box-Methode nicht ausreicht und das Problem nicht reproduziert werden kann, k√∂nnen Sie sich die Logik der Anwendung ansehen.  Zu diesem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zweck</a> k√∂nnen Sie APK-Dekompilierungsdienstprogramme wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JADX</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bytecode Viewer verwenden</a> .  Oft nimmt dieser Ansatz jedoch zu viel Zeit in Anspruch und f√ºhrt nicht immer zu einem Ergebnis.  Um schnell zu verstehen, wie die Anwendung das SDK von innen verwendet, haben wir ein Skript erstellt, um eine neue SDK-Implementierung durch eine bereits erstellte Anwendung zu ersetzen. <br><br><h3>  <b>Installieren einer neuen SDK-Implementierung in einer Anwendung</b> </h3><br>  Durch √Ñndern des SDK-Codes k√∂nnen Sie beliebigen Code √ºber die Klassen der ge√§nderten SDK-Version in die Anwendung einbetten und beispielsweise den zus√§tzlichen Protokollierungsmodus aktivieren.  Der Operationsalgorithmus ist wie folgt.  Skript: <br><br><ol><li>  zerlegt Anwendungs-DEX-Dateien in smali; </li><li>  konvertiert die JAR-Datei der neuen Version des SDK in smali; </li><li>  ersetzt die Implementierung von smali SDK-Dateien in smali-Anwendungsdateien; </li><li>  Setzt die Anwendung mit der neuen Version des SDK wieder zusammen. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gw/rk/ku/gwrkku0cnnnauln9jie1wiim09s.png" width="700"></div><br><h3>  <b><font color="#fd181d">D</font> Assemblieren von Anwendungs-DEX-Dateien in smali</b> </h3><br>  Sie m√ºssen die Anwendung zerlegen und in kleinere Einheiten aufteilen, damit Sie den Code der SDK-Klassen √§ndern k√∂nnen, ohne den Anwendungscode zu √§ndern.  Wie gehe ich mit der zusammengestellten Anwendung um?  Zerlegen Sie DEX in kleine Dateien. <br><br>  In Android speichert die Anwendung den Code in DEX-Dateien.  Sie k√∂nnen sie √ºber das Dienstprogramm zum Entpacken aus der Anwendung extrahieren, da APK ein regul√§res Archiv mit strukturiertem Inhalt ist.  DEX-Dateien haben im Vergleich zu JARs ein Bin√§rformat f√ºr dichteres Code-Packaging.  Aufgrund der bin√§ren Natur von DEX ist es unmenschlich, daher ist es irrational, das DEX selbst zu √§ndern.  Das erste, was mir in den Sinn kommt, ist das Dekompilieren von DEX in Java.  Eine solche Konvertierung ist m√∂glich, aber nicht trivial und tritt bei Verlust der Funktionalit√§t des Codes auf.  Daher werden wir die √úbersetzung in Smali-Code verwenden.  Durch die Konvertierung in smali k√∂nnen Sie Anweisungen von DEX in lesbarer Form genau √ºbertragen und anschlie√üend in funktionsf√§higen Code konvertieren. <br><br>  Durch Aufrufen des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dienstprogramms smali</a> wird DEX in eine Reihe von Klassen im smali-Code konvertiert.  In diesem Fall bleibt die anf√§ngliche Anordnung der Klassen nach Unterpaketen erhalten. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ur/_q/rx/ur_qrxcls0qgsqkc9uv39q_vohy.png" width="600"></div><br><h3>  <b>Konvertieren des neuen SDK in smali</b> </h3><br>  Wir werden eine Ersatz-SDK-Version vorbereiten.  Um die Reproduzierbarkeit des Problems zu gew√§hrleisten, erstellen wir eine Version des SDK mit aktivierter Protokollierung, die auf derselben Version basiert, die bereits in die Anwendung integriert ist.  Eine der einfachsten M√∂glichkeiten, die verbundene Version des Yandex Mobile Ads SDK in der Anwendung herauszufinden, besteht darin, den Inhalt der Methode in der Klasse MobileAds.getLibraryVersion () √ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Apk Analizer</a> in Android Studio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">anzuzeigen</a> .  Nachdem wir die verwendete Version des Werbe-SDK herausgefunden haben, wechseln wir zum Zweig dieser Version und sammeln die Bibliotheksversion mit zus√§tzlicher Protokollierung.  Als Ergebnis erhalten wir eine AAR-Datei.  Es enth√§lt Ressourcen und Bibliothekscode.  In der AAR-Datei interessiert uns nur der Code in der JAR-Datei, da unser SDK keine externen Ressourcen enth√§lt: Alle Ressourcen werden direkt in den Code eingef√ºgt oder stammen aus dem Backend.  Das Fehlen von Ressourcendateien vereinfacht die Integration des SDK in die IDE ohne die Unterst√ºtzung moderner Build-Systeme. <br><br>  Um die Version des SDK in der Anwendung in eine neue zu √§ndern, bringen wir den AAR in den gleichen Zustand wie die disassemblierte Anwendung, dh, vom AAR erhalten wir eine Reihe von Smali-Dateien.  Die Konvertierung erfolgt entlang der Kette: AAR ‚Üí JAR ‚Üí DEX ‚Üí SMALI: <br><br><ol><li>  Aus AAR extrahieren wir mit dem Dienstprogramm unzip die JAR mit dem Code. </li><li>  Wir konvertieren JAR √ºber das Dienstprogramm dxdump aus den Android SDK-Tools in DEX. </li><li>  Wir erhalten die Dateien im Smali-Code mit dem Dienstprogramm smali mit der DEX-Datei als Parameter. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x-/ma/il/x-mailcf2mefqvmdacff6dcha7m.png" width="630"></div><br><h3>  <b>SDK-Implementierung</b> </h3><br>  Nachdem wir kleine Dateien der Anwendung und des SDK mit Protokollen erhalten haben, ersetzen wir die SDK-Implementierung durch eine neue.  Dann erstellen wir die Anwendung neu.  Bei der √úbertragung an smali behalten die resultierenden Klassen ihren Standort durch Unterpakete bei.  Wenn das Paket bekannt ist, in dem sich die SDK-Klassen befinden, ist es daher einfach, die Bibliotheksklasse von den Anwendungsklassen zu unterscheiden.  SDK-Klassen k√∂nnen auf mehrere DEXs verteilt werden.  Daher unterscheidet sich der Algorithmus, durch den die SDK-Implementierung ersetzt wird, f√ºr eine Anwendung mit einer oder mehreren DEX-Dateien. <br><br><h3>  <b><font color="#fd181d">Und der</font> Algorithmus zum Ersetzen der SDK-Implementierung in einer Anwendung durch ein DEX</b> </h3><br>  In einer einzelnen DEX-Anwendung kopieren wir einfach die neuen SDK-Smali-Klassen √ºber alle Anwendungsklassen und generieren ein modifiziertes DEX.  Sie k√∂nnen eine DEX-Datei mit dem Dienstprogramm baksmali erstellen.  Das Verzeichnis mit den Paketdateien der Klassen im Smali-Code wird dem Dienstprogramm eingegeben.  Nachdem wir die kombinierten smali-Dateien der Anwendung und des neuen SDK durch baksmali durchlaufen haben, erhalten wir eine modifizierte DEX-Datei mit der ge√§nderten SDK-Logik. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qy/5m/jk/qy5mjkuhcnfyec681wkio0w4fda.png" width="370"></div><br><h3>  <b><font color="#fd181d">Und der</font> Algorithmus zum Ersetzen der SDK-Implementierung in einer Anwendung durch MultiDex</b> </h3><br>  F√ºgen Sie f√ºr eine Anwendung mit MultiDex dem neuen DEX ein separates SDK hinzu und entfernen Sie die vorherige Version des SDK aus den √ºbrigen DEX-Dateien der Anwendung.  Durch Hinzuf√ºgen einer neuen Version des SDK zu einzelnen DEXs wird die Beschr√§nkung der Anzahl der Methoden im DEX-Format umgangen.  MultiDex l√§dt die hinzugef√ºgte DEX-Datei automatisch mit dem SDK-Code, wenn sie korrekt benannt ist.  MultiDex sucht nacheinander nach DEX-Dateien, wobei der Index am Ende der Datei verwendet wird: zuerst dex1, dann dex2 - und so weiter. Wenn Sie die Datei mit einem inkrementellen Index benennen, l√§dt MultiDex sie automatisch in die virtuelle Maschine.  Daher werden wir √ºber baksmali DEX-Dateien basierend auf zuvor empfangenen Anwendungs-smali-Dateien generieren, jedoch mit gel√∂schten Klassen der alten SDK-Version.  Sammeln Sie au√üerdem eine zus√§tzliche DEX-Datei mit einer ge√§nderten Version des SDK, indem Sie den Index im Namen der DEX-Datei erh√∂hen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7w/if/qj/7wifqjuneamhnw7wae86arkwu7w.png" width="530"></div><br><h3>  <b>Erstellen Sie die Anwendung mit der neuen Version des SDK neu</b> </h3><br>  Wir haben Anwendungs-DEX-Dateien mit einer modifizierten Version des SDK.  Die Sache ist klein: Wir werden die DEX-Dateien in der urspr√ºnglich entpackten APK-Datei der Anwendung durch die ge√§nderten DEX-Dateien ersetzen.  Durch Aufrufen des Befehls zip erhalten wir die endg√ºltige Version der APK, die noch signiert werden muss.  Wir werden mit dem Debug-Schl√ºssel √ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">apksigner signieren,</a> damit die Anwendung auf dem Ger√§t installiert werden kann.  Die Anwendung mit der ge√§nderten SDK-Logik ist bereit. <br><br><h3>  <b><font color="#fd181d">N</font> Speichern</b> </h3><br>  Der Algorithmus funktioniert in den meisten F√§llen, aber manchmal funktioniert er nicht, um die SDK-Implementierung in der Anwendung zu ersetzen.  Die Gr√ºnde daf√ºr: <br><br><ol><li>  Verschleierung ProGuard.  Die Regeln in der Consumer-Datei der Bibliothek verhindern, dass ProGuard die SDK-Klassen verschiebt.  Wenn der Entwickler diese Anweisungen jedoch abbricht, kann ein Teil der Bibliotheksklassen ihr Paket √§ndern.  In diesem Fall funktioniert der Algorithmus nicht, da das Skript den Speicherort der Klassen des alten SDK nicht findet. </li><li>  Einschr√§nkung des DEX-Formats.  Wenn der gesamte Code in der Anwendung in einer DEX-Datei gespeichert ist, ist die Grenze der verwendeten Methoden fast vollst√§ndig ausgesch√∂pft.  Wenn Sie eine SDK-Version in einer Anwendung durch eine Version mit zus√§tzlicher Protokollierung ersetzen, erh√∂ht sich die Anzahl der Methoden.  Das Limit wird √ºberschritten.  Im DEX-Format betr√§gt das Limit 2 ^ 16. </li><li>  Sch√ºtzen Sie Ihre Anwendung vor √Ñnderungen.  Die Anwendung verf√ºgt √ºber integrierte Mechanismen zur Bek√§mpfung von √Ñnderungen.  Zum Beispiel durch Validierung der Anwendungssignatur.  Durch √Ñndern der APK √§ndern wir entsprechend ihre Signatur.  Wenn die Anwendung gestartet wird, vergleicht sie die Signatur mit der Referenz und l√∂st eine Ausnahme aus.  Es ist besonders schwierig, diese Pr√ºfung zu entfernen, wenn sie im nativen Teil platziert ist. </li></ol><br><h3>  <b><font color="#fd181d">Und</font> Togas</b> </h3><br>  Wir haben die im Artikel beschriebenen Schritte mit einem einfachen Bash-Skript automatisiert.  Das Skript weist Fehler auf, beschleunigt jedoch die Analyse komplexer Probleme bei der Integration des SDK in Partneranwendungen erheblich.  Wir verwenden diesen Ansatz jedoch selten, da wir in fr√ºheren Phasen h√§ufig eine L√∂sung finden. <br><br>  Von der Konvertierung in smali erhalten Sie zus√§tzliche Vorteile: Mit smali-Dateien k√∂nnen Sie die Anwendung ohne Quelle debuggen.  Um mit dem Debuggen zu beginnen, m√ºssen Sie in Android Studio ein Projekt basierend auf den Smali-Dateien der Anwendung generieren und den Debugger an den gew√ºnschten Prozess anh√§ngen.  Weitere Details finden Sie in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Artikel</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de460597/">https://habr.com/ru/post/de460597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de460577/index.html">Es lebe der K√∂nig: grausame Welt der Hierarchie in einem Rudel streunender Hunde</a></li>
<li><a href="../de460587/index.html">Funkmodul f√ºr kapazitiven Bodenfeuchtesensor am nRF52832</a></li>
<li><a href="../de460589/index.html">Schreiben eines einfachen neuronalen Netzwerks mit Mathematik und Numpy</a></li>
<li><a href="../de460591/index.html">Root auf einem Tenda Nova MW6-Router erhalten</a></li>
<li><a href="../de460593/index.html">"Universal" im Entwicklungsteam: Nutzen oder Schaden?</a></li>
<li><a href="../de460599/index.html">Nachrichten aus der Welt von OpenStreetMap Nr. 468 (07/02/2019 - 08/07/2019)</a></li>
<li><a href="../de460603/index.html">V2G. Elektroautos werden dazu beitragen, die Produktion und den Verbrauch von Strom auszugleichen</a></li>
<li><a href="../de460605/index.html">Automatisches Fotostudio, Teil 1</a></li>
<li><a href="../de460607/index.html">Offensive Security App Store mit Hacking-Tools von Android</a></li>
<li><a href="../de460611/index.html">Failover: Perfektionismus ruiniert uns und ... Faulheit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>