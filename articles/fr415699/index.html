<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§µüèº üç¨ üåÜ Trois courtes histoires de registre Windows üßö üì¨ üìô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, chers lecteurs. 

 Le registre est l'un des syst√®mes Windows les plus visibles et les plus importants. Il n'y a presque personne qui n'ait en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Trois courtes histoires de registre Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/kaspersky/blog/415699/">  Bonjour, chers lecteurs. <br><br>  Le registre est l'un des syst√®mes Windows les plus visibles et les plus importants.  Il n'y a presque personne qui n'ait entendu parler de lui.  Programmant sous Windows depuis environ 20 ans, je pensais tout savoir sur lui.  Mais de temps en temps, quelque chose de nouveau appara√Æt qui me montre √† quel point je me trompais.  Par cons√©quent, aujourd'hui, je veux vous parler des fa√ßons inhabituelles de travailler avec le registre que j'ai rencontr√©es lors de recherches sur les rootkits et qui m'ont surpris. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/ae/nr/pbaenrjbdncrwdoqvjdxvj4i2bw.png"></div><a name="habracut"></a><br><h2>  La premi√®re histoire.  Noms des valeurs et cl√©s de registre </h2><br>  Nous savons tous que sous Windows, il existe des r√®gles pour nommer les objets, qu'il s'agisse de fichiers, de r√©pertoires ou de cl√©s de registre.  Les noms de fichiers ne peuvent pas contenir le caract√®re ¬´\¬ª.  Les noms ne peuvent pas √™tre vides.  Les noms ont des restrictions de longueur, etc. <br><br>  Involontairement, nous √©tendons ces restrictions √† tous les syst√®mes Windows et les respectons lorsque nous travaillons avec le registre.  Et c'est l√† que r√©side notre erreur.  Il existe √©tonnamment peu de restrictions sur le registre lors de la cr√©ation de noms.  Par exemple, dans le nom des valeurs, vous pouvez utiliser le caract√®re "\" <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/p_/wg/mw/p_wgmwlgimtqj6vclgogspff19y.png"></div><br>  Surpris?  Non?  Alors que direz-vous si je vous montre que le symbole ¬´\ 0¬ª peut √™tre utilis√© dans le nom d'une valeur?  Oui, oui, exactement le caract√®re nul.  Celui qui est traditionnellement utilis√© pour indiquer la fin d'une ligne. <br><br>  Pour cela, nous avons besoin de la fonction NtSetValueKey export√©e depuis ntdll.dll <br><br><pre><code class="cpp hljs">HKEY hKey = <span class="hljs-number"><span class="hljs-number">0</span></span>; RegOpenKeyA( HKEY_LOCAL_MACHINE, <span class="hljs-string"><span class="hljs-string">"Software\\Microsoft\\Windows\\CurrentVersion\\Run"</span></span>, &amp;hKey); UNICODE_STRING uName; uName.Buffer = <span class="hljs-string"><span class="hljs-string">L"Test\0Zero"</span></span>; uName.MaxLen = uName.Length = <span class="hljs-number"><span class="hljs-number">9</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>); NTSTATUS status = <span class="hljs-number"><span class="hljs-number">0</span></span>; status = NtSetValueKey( hKey, &amp;uName, <span class="hljs-number"><span class="hljs-number">0</span></span>, REG_SZ, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)lpData, DataSize); RegCloseKey(hKey);</code> </pre> <br>  Pour ex√©cuter la fonction NtSetValueKey, vous devez disposer des droits d'administrateur.  Par cons√©quent, une valeur avec le nom Test \ 0Zero appara√Ætra dans votre registre. <br><br>  Certains d√©veloppeurs Microsoft seront √©galement surpris, car l'√©diteur de registre standard ne peut pas afficher une valeur de registre aussi inhabituelle. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/66/zi/zp/66zizpvsxtkhxhbuglu4xymqla8.png"></div><br><h2>  Deuxi√®me histoire </h2><br>  La deuxi√®me histoire que je vais vous raconter aujourd'hui s'est produite en 2013. <br><br>  Au d√©but une petite digression.  Chez Kaspersky Lab, je fais partie de l'√©quipe qui cr√©e, entre autres, Kaspersky Rescue Disk.  Pour gu√©rir Windows sous Linux, nous devons analyser les fichiers de registre nous-m√™mes.  Et pour v√©rifier le bon fonctionnement de ce m√©canisme, nous utilisons de nombreux tests.  Parmi eux, il y en a un assez simple: <br><br><ul><li>  Sous Windows, nous √©crivons des valeurs de test dans le registre. </li><li>  Copiez le fichier de ruche du Registre dans le r√©pertoire de test. </li><li>  Nous d√©marrons le programme qui effectue la suppression des valeurs de test. </li><li>  Nous chargeons la douille modifi√©e dans le registre pour v√©rifier la suppression. </li></ul><br>  Et un beau jour, nous avons mis √† jour le banc de test Windows vers la version 8.1, et le test a cess√© de supprimer les valeurs de test.  Comment, j'ai √©t√© surpris.  J'ai copi√© le fichier avec la ruche de registre sur mon ordinateur de travail - aucune valeur!  Ma premi√®re pens√©e: je dois ajouter des cl√©s modifi√©es au test Flush.  Ajout d'un appel √† RegFlushKey, red√©marrage du test - aucune valeur! <br><br>  Est-ce que RegFlushKey ne fonctionne pas, je pensais.  Mais il s'est av√©r√© que je n'avais que partiellement raison. <br><br>  L'astuce √©tait que dans Windows 8.1, Microsoft a chang√© le m√©canisme d'enregistrement des modifications dans le registre.  Auparavant, toutes les modifications du registre √©taient accumul√©es en m√©moire, puis, lorsque la cl√© √©tait ferm√©e, lorsque RegFlushKey √©tait ex√©cut√© ou apr√®s un certain temps, le syst√®me enregistrait les modifications dans le fichier ruche du registre.  Dans Windows 8.1, les modifications au lieu du fichier de bush de registre sont enregistr√©es dans des fichiers du m√™me nom avec les extensions .LOG, .LOG1 et .LOG2, et mon code ignorait ces fichiers √† cette √©poque. <br><br>  Dans ces fichiers, les modifications s'accumulent pendant environ une heure.  Et ce n'est qu'apr√®s cela que Windows commence √† int√©grer les modifications dans le fichier principal.  Cette t√¢che est appel√©e rapprochement et d√©marre soit toutes les 40 minutes, soit √† la fermeture de Windows.  L'appel de la fonction RegFlushKey ne d√©clenche pas la t√¢che de rapprochement.  Pour forcer le d√©marrage de la t√¢che d'int√©gration de modification, vous devez appeler ZwSetSystemInformation avec l'argument non document√© SystemRegistryReconciliationInformation. <br><br><pre> <code class="cpp hljs">ZwSetSystemInformation( <span class="hljs-number"><span class="hljs-number">0x9b</span></span>, <span class="hljs-comment"><span class="hljs-comment">//SystemRegistryReconciliationInformation NULL, 0);</span></span></code> </pre><br>  Pour ex√©cuter la fonction ZwSetSystemInformation, vous devez disposer des droits d'administrateur.  Et l'architecture du fichier ex√©cutable doit correspondre √† l'architecture du syst√®me.  L'appel de cette fonction √† partir d'un programme 32 bits sur Windows 64 bits √©chouera. <br><br><h2>  Troisi√®me histoire </h2><br>  Il y a quelque temps, nous avons d√©couvert un rootkit qui prescrivait le lancement de son pilote dans le registre.  Nos produits ont supprim√© les cl√©s de registre correspondantes, mais apr√®s le red√©marrage, les cl√©s √©taient √† leur place.  On dirait qu'il met ses fonctions de rappel sur les changements de registre et restaure ses cl√©s apr√®s nos changements, pensais-je.  Mais il s'est av√©r√© que non.  Plus pr√©cis√©ment, oui.  Le rootkit a d√©fini des fonctions de rappel, mais elles n'avaient rien √† voir avec la t√¢che de r√©cup√©ration de cl√©.  Tout a √©t√© rendu plus simple et plus √©l√©gant. <br><br>  Le pilote rootkit, au d√©marrage, a renomm√© le fichier de la ruche du Registre SYSTEM en HARDWARE.  J'ai cr√©√© mon fichier SYSTEM et enregistr√© p√©riodiquement la branche HKLM / System √† l'aide de la fonction RegSaveKey.  Lors de la sauvegarde, il a restaur√© ses cl√©s.  Lors du red√©marrage de Windows, le syst√®me a charg√© le fichier SYSTEM et lanc√© le pilote rootkit.  C'est beau?  Sympa. <br><br><h3>  Recherch√© </h3><br>  PS Ici, nous recherchons un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©veloppeur-chercheur</a> dans une √©quipe qui scie un moteur anti-spam, et nous avons √©galement besoin d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un ing√©nieur de test</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415699/">https://habr.com/ru/post/fr415699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415685/index.html">Divulgation de la m√©moire du noyau dans le syst√®me d'exploitation moderne</a></li>
<li><a href="../fr415687/index.html">Fintech Digest: la Banque centrale oblige les banques √† v√©rifier les appareils clients √† partir desquels l'argent est transf√©r√©</a></li>
<li><a href="../fr415689/index.html">Nous jouons bataille navale sur BGP</a></li>
<li><a href="../fr415691/index.html">Comparaison de tri Exchange</a></li>
<li><a href="../fr415695/index.html">Google a admis qu'il voulait √©galement acheter GitHub</a></li>
<li><a href="../fr415701/index.html">Top 10: les meilleurs articles du Joker 2017</a></li>
<li><a href="../fr415705/index.html">Les pirates ont compromis les r√©f√©rentiels Gentoo Linux sur GitHub</a></li>
<li><a href="../fr415707/index.html">Richard Hamming: Chapitre 18. Mod√©lisation - I</a></li>
<li><a href="../fr415709/index.html">7 p√©ch√©s du propri√©taire du produit</a></li>
<li><a href="../fr415713/index.html">Programmation PHP orient√©e aspect</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>