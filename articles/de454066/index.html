<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññ üëÑ üõ¨ So beenden Sie das Vergessen von Indizes und √ºberpr√ºfen den Ausf√ºhrungsplan in Tests üôçüèª üêµ üë©‚Äç‚ù§Ô∏è‚Äçüë®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einiger Zeit passierte mir eine unangenehme Geschichte, die als Ausl√∂ser f√ºr ein kleines Projekt auf dem Github diente und zu diesem Artikel f√ºhrt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So beenden Sie das Vergessen von Indizes und √ºberpr√ºfen den Ausf√ºhrungsplan in Tests</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/454066/"><img src="https://habrastorage.org/webt/cb/kk/ps/cbkkpswi947gczpzqmwkyh2pwmm.jpeg" alt="cdpv"><br><br>  Vor einiger Zeit passierte mir eine unangenehme Geschichte, die als Ausl√∂ser f√ºr ein kleines Projekt auf dem Github diente und zu diesem Artikel f√ºhrte. <br><br>  Ein typischer Tag, eine normale Freigabe: Alle Aufgaben werden von unserem QS-Ingenieur auf und ab √ºberpr√ºft, sodass wir mit der Ruhe der heiligen Kuh auf die B√ºhne ‚Äûrollen‚Äú.  Die Anwendung verh√§lt sich in den Protokollen gut - Stille.  Wir entscheiden uns f√ºr einen Wechsel (Stage &lt;-&gt; Prod).  Wir wechseln, schauen uns die Ger√§te an ... <br><br>  Es dauert ein paar Minuten, der Flug ist stabil.  Der QS-Techniker f√ºhrt einen Rauchtest durch und stellt fest, dass die Anwendung auf unnat√ºrliche Weise langsamer wird.  Wir schreiben ab, um die Caches aufzuw√§rmen. <br><br>  Ein paar Minuten vergehen, die erste Beschwerde aus der ersten Zeile: Die Daten werden sehr lange von den Clients heruntergeladen, die Anwendung wird langsamer, die Antwort dauert lange usw.  Wir machen uns langsam Sorgen ... wir schauen uns die Protokolle an, wir suchen nach m√∂glichen Gr√ºnden. <br><a name="habracut"></a><br>  Ein paar Minuten sp√§ter kommt ein Brief von DB-Administratoren.  Sie schreiben, dass die Ausf√ºhrungszeit von Abfragen an die Datenbank (im Folgenden als Datenbank bezeichnet) alle m√∂glichen Grenzen √ºberschritten hat und gegen unendlich tendiert. <br><br>  Ich √∂ffne die √úberwachung (ich benutze <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JavaMelody</a> ) und finde diese Anfragen.  Ich starte PGAdmin, ich reproduziere.  Wirklich lang.  Ich f√ºge "EXPLAIN" hinzu, ich schaue mir den Ausf√ºhrungsplan an ... wir haben die Indizes vergessen. <br><br><h2>  Warum reicht die Code√ºberpr√ºfung nicht aus? </h2><br>  Dieser Vorfall hat mich viel gelehrt.  Ja, ich habe das Feuer f√ºr eine Stunde ‚Äûgel√∂scht‚Äú und auf irgendeine Weise den richtigen Index direkt auf dem Produkt erstellt (vergessen Sie nicht die Option CONCURRENTLY): <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> CONCURRENTLY <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ix_pets_name <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pets_table (name_column);</code> </pre> <br>  Stimmen Sie zu, dies war gleichbedeutend mit einer Bereitstellung mit Ausfallzeiten.  F√ºr die Anwendung, an der ich arbeite, ist dies nicht akzeptabel. <br><br>  Ich habe Schlussfolgerungen gezogen und der Checkliste einen besonderen Fettdruck f√ºr die Code√ºberpr√ºfung hinzugef√ºgt: Wenn ich sehe, dass w√§hrend des Entwicklungsprozesses eine der Repository-Klassen hinzugef√ºgt / ge√§ndert wurde, √ºberpr√ºfe ich SQL-Migrationen auf das Vorhandensein eines Skripts, das den Index dort erstellt und √§ndert.  Wenn er nicht da ist, schreibe ich dem Autor eine Frage: Ist er sicher, dass der Index hier nicht ben√∂tigt wird? <br><br>  Es ist wahrscheinlich, dass ein Index nicht ben√∂tigt wird, wenn nur wenige Daten vorhanden sind. Wenn wir jedoch mit einer Tabelle arbeiten, in der die Anzahl der Zeilen in Millionen gez√§hlt wird, kann ein Indexfehler schwerwiegend werden und zu der am Anfang des Artikels beschriebenen Geschichte f√ºhren. <br><br>  In diesem Fall bitte ich den Autor der Pull-Anfrage (im Folgenden: PR), 100% sicher zu sein, dass die von ihm in HQL geschriebene Abfrage zumindest teilweise vom Index abgedeckt wird (Index-Scan wird verwendet).  Daf√ºr hat der Entwickler: <br><br><ol><li>  Startet die Anwendung </li><li>  Suche nach konvertierten (HQL -&gt; SQL) Abfragen in den Protokollen </li><li>  √∂ffnet PGAdmin oder ein anderes Datenbankverwaltungstool </li><li>  generiert in der lokalen Datenbank eine Datenmenge, die f√ºr Tests akzeptabel ist (mindestens 10K - 20K Datens√§tze), um niemanden bei ihren Experimenten zu st√∂ren </li><li>  erf√ºllt die Anfrage </li><li>  fordert Ausf√ºhrungsplan an </li><li>  studiert es sorgf√§ltig und zieht entsprechende Schlussfolgerungen </li><li>  F√ºgt den Index hinzu / √§ndert ihn, um sicherzustellen, dass der Ausf√ºhrungsplan dazu passt </li><li>  meldet sich in PR ab, dass die Anforderungsabdeckung √ºberpr√ºft wurde </li><li>  Wenn ich die Risiken und die Schwere der Anfrage fachm√§nnisch einsch√§tze, kann ich ihre Ma√ünahmen √ºberpr√ºfen </li></ol><br>  Viele Routinema√ünahmen und der menschliche Faktor, aber f√ºr einige Zeit war ich zufrieden und habe damit gelebt. <br><br><h2>  Auf dem Weg nach Hause </h2><br>  Sie sagen, es sei zumindest manchmal sehr n√ºtzlich, von der Arbeit zu gehen, ohne unterwegs Musik / Podcasts zu h√∂ren.  Wenn Sie zu diesem Zeitpunkt nur an das Leben denken, k√∂nnen Sie zu interessanten Schlussfolgerungen und Ideen kommen. <br><br>  Eines Tages ging ich nach Hause und dachte dar√ºber nach, was an diesem Tag passiert war.  Es gab einige √úberpr√ºfungen, ich √ºberpr√ºfte jede mit einer Checkliste und f√ºhrte eine Reihe von oben beschriebenen Aktionen durch.  Ich wurde damals so m√ºde, dachte ich, was zur H√∂lle?  Ist es unm√∂glich, dies automatisch zu tun? .. Ich machte einen schnellen Schritt und wollte diese Idee schnell ‚Äûabschneiden‚Äú. <br><br><h2>  Erkl√§rung des Problems </h2><br>  Was ist f√ºr den Entwickler im Ausf√ºhrungsplan am wichtigsten? <br>  Nat√ºrlich scannen Sie gro√üe Datenmengen, die durch das Fehlen eines Index verursacht werden. <br><br>  Daher war es notwendig, einen Test durchzuf√ºhren, der: <br><br><ol><li>  Wird in einer Datenbank mit einer √§hnlichen Konfiguration wie das Produkt ausgef√ºhrt </li><li>  F√§ngt eine Datenbankabfrage ab, die von einem JPA-Repository (Ruhezustand) erstellt wurde. </li><li>  Ruft den Ausf√ºhrungsplan ab </li><li>  Parsit-Ausf√ºhrungsplan, der in einer f√ºr √úberpr√ºfungen geeigneten Datenstruktur angeordnet ist </li><li>  √úberpr√ºft die Erwartungen mithilfe einer praktischen Reihe von Assert-Methoden.  Zum Beispiel wird dieser seq-Scan nicht verwendet. </li></ol><br><br>  Es war notwendig, diese Hypothese schnell zu testen, indem ein Prototyp erstellt wurde. <br><br><h2>  L√∂sungsarchitektur </h2><br><img src="https://habrastorage.org/webt/6e/2i/bz/6e2ibz7cl8roycahqee4yb1lqqq.png" alt="checkinx Architektur"><br><br>  Das erste Problem, das gel√∂st werden sollte, war der Start des Tests in einer realen Datenbank, die der Version und den Einstellungen mit der auf dem Produkt verwendeten entspricht. <br><br>  Dank <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker &amp; TestContainers</a> l√∂sen sie dieses Problem. <br><br>  SqlInterceptor, ExecutionPlanQuery, ExecutionPlanParse und AssertService sind die Schnittstellen, die ich derzeit f√ºr Postgres implementiert habe.  Es ist geplant, f√ºr andere Datenbanken zu implementieren.  Wenn Sie teilnehmen m√∂chten - willkommen.  Der Code ist in Kotlin geschrieben. <br><br>  All dies zusammen habe ich auf GitHub gepostet und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">checkinx-utils</a> aufgerufen.  Sie m√ºssen dies nicht wiederholen. Verbinden Sie einfach die Abh√§ngigkeit mit checkinx in maven / gradle und verwenden Sie praktische Asserts.  Wie das geht, werde ich weiter unten n√§her beschreiben. <br><br><h3>  Beschreibung der Interaktion von CheckInx-Komponenten </h3><br><h4>  ProxyDataSource </h4><br>  Das erste Problem, das gel√∂st werden sollte, war das Abfangen von Datenbankabfragen, die zur Ausf√ºhrung bereit waren.  Bereits mit den festgelegten Parametern, ohne Fragen usw. <br><br>  Dazu m√ºssen Sie die reale dataSource in einen bestimmten Proxy einbinden, damit Sie sie in die Pipeline f√ºr die Ausf√ºhrung von Abfragen integrieren und entsprechend abfangen k√∂nnen. <br><br>  Eine solche ProxyDataSource wurde bereits von vielen implementiert.  Ich habe die vorgefertigte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ttddyy-</a> L√∂sung verwendet, mit der ich meinen Listener installieren kann, um die von mir ben√∂tigte Anforderung abzufangen. <br><br>  Ich ersetze die Quell-DataSource durch die DataSourceWrapper-Klasse (BeanPostProcessor). <br><br><h4>  SqlInterceptor </h4><br>  Tats√§chlich legt die Methode start () den Listener in proxyDataSource fest und f√§ngt ab, Anforderungen abzufangen und in der Liste der internen Anweisungen zu speichern.  Die stop () -Methode entfernt jeweils den installierten Listener. <br><br><h4>  ExecutionPlanQuery </h4><br>  Hier wird die urspr√ºngliche Anforderung in eine Anforderung f√ºr einen Ausf√ºhrungsplan umgewandelt.  Im Fall von Postgres ist dies eine Erg√§nzung zum Abfrage-Schl√ºsselwort "EXPLAIN". <br><br>  Ferner wird diese Abfrage von Testcontainern in derselben Datenbank ausgef√ºhrt und ein "roher" Ausf√ºhrungsplan (Liste der Zeilen) zur√ºckgegeben. <br><br><h4>  ExecutionPlanParser </h4><br>  Es ist unpraktisch, mit einem rohen Ausf√ºhrungsplan zu arbeiten.  Deshalb analysiere ich es in einen Baum, der aus Knoten besteht (PlanNode). <br><br>  Lassen Sie uns die PlanNode-Felder anhand eines Beispiels eines echten ExecutionPlan analysieren: <br><br><pre> <code class="sql hljs">Index Scan using ix_pets_age on pets  (cost=0.29..8.77 rows=1 width=36) Index Cond: (age &lt; 10) Filter: ((name)::text = 'Jack'::text)</code> </pre> <br><div class="scrollable-table"><table><tbody><tr><th>  Eigentum </th><th>  Beispiel </th><th>  Beschreibung </th></tr><tr><td>  raw: String </td><td>  Index-Scan mit ix_pets_age f√ºr Haustiere (Kosten = 0,29..8,77 Zeilen = 1 Breite = 36) </td><td>  Quellzeichenfolge </td></tr><tr><td>  Tabelle: String? </td><td>  Haustiere <br></td><td>  Tabellenname </td></tr><tr><td>  Ziel: String? </td><td>  ix_pets_age </td><td>  Indexname </td></tr><tr><td>  Abdeckung: String? </td><td>  Index-Scan </td><td>  Abdeckung </td></tr><tr><td>  CoverageLevel </td><td>  Die H√§lfte </td><td>  Beschichtungsabstraktion (NULL, H√ÑLFTE, VOLL) </td></tr><tr><td>  Kinder: MutableList &lt;PlanNode&gt; </td><td>  - - </td><td>  untergeordnete Knoten </td></tr><tr><td>  Eigenschaften: MutableList &lt;Pair &lt;String, String &gt;&gt; </td><td>  <i>Schl√ºssel</i> : Index Cond, <i>Wert</i> : (Alter &lt;10); <br>  <i>Schl√ºssel</i> : Filter, <i>Wert</i> : ((Name) :: Text = 'Jack' :: Text) <br></td><td>  Eigenschaften </td></tr><tr><td>  andere: MutableList &lt;String&gt; </td><td>  - - </td><td>  All das konnte in der aktuellen Version von checkinx nicht erkannt werden </td></tr></tbody></table></div><br><h4>  AssertService </h4><br>  Es ist bereits m√∂glich, normal mit der vom Parser zur√ºckgegebenen Datenstruktur zu arbeiten.  CheckInxAssertService ist eine Reihe von √úberpr√ºfungen des oben beschriebenen PlanNode-Baums.  Es erm√∂glicht Ihnen, Ihre eigenen Lambdas von Schecks zu setzen oder die meiner Meinung nach vordefinierten, die beliebtesten zu verwenden.  Zum Beispiel, damit Ihre Abfrage keinen Seq-Scan enth√§lt oder Sie sicherstellen m√∂chten, dass ein bestimmter Index verwendet / nicht verwendet wird. <br><br><h4>  Coveragelevel </h4><br>  Sehr wichtige Aufz√§hlung, ich werde es separat beschreiben: <br><div class="scrollable-table"><table><tbody><tr><th>  Wert </th><th>  Beschreibung </th></tr><tr><td>  NOT_USING <br></td><td>  pr√ºft, ob ein bestimmtes Ziel (Index) nicht verwendet wird <br></td></tr><tr><td>  NULL <br></td><td>  Index nicht verwendet (Seq Scan) <br></td></tr><tr><td>  Die H√§lfte <br></td><td>  Teilabdeckung der Abfrage nach Index (Index-Scan).  Beispielsweise wird eine Suche nach Index durchgef√ºhrt, die resultierenden Daten beziehen sich jedoch auf eine Tabelle <br></td></tr><tr><td>  VOLL <br></td><td>  vollst√§ndige Abdeckung der Abfrage nach Index (Nur Index-Scan) <br></td></tr><tr><td>  UNBEKANNT <br></td><td>  unbekannte Abdeckung.  Aus irgendeinem Grund war es nicht m√∂glich, es zu installieren. <br></td></tr></tbody></table></div><br>  Als n√§chstes sehen wir uns einige Anwendungsbeispiele an. <br><br><h2>  Testbeispiele mit CheckInx </h2><br>  Ich habe ein separates Projekt f√ºr die GitHub- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Checkinx-Demo durchgef√ºhrt</a> , in dem ich ein JPA-Repository f√ºr die Haustier-Tabelle implementiert und Tests f√ºr dieses Repository durchgef√ºhrt habe, um die Abdeckung, Indizes usw. zu √ºberpr√ºfen.  Es wird n√ºtzlich sein, dort als Ausgangspunkt zu betrachten. <br><br>  Sie k√∂nnten einen Test wie diesen haben: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFindByLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {  <span class="hljs-comment"><span class="hljs-comment">// ARRANGE  val location = "Moscow"  //   ,      10-20.  //   TestNG      @BeforeClass  IntRange(1, 10000).forEach {      val pet = Pet()      pet.id = UUID.randomUUID()      pet.age = it      pet.location = "Saint Petersburg"      pet.name = "Jack-$it"      repository.save(pet)  }  // ACT  //     sqlInterceptor.startInterception()  //    val pets = repository.findByLocation(location)  //    sqlInterceptor.stopInterception()  // ASSERT  //         assertEquals(1, sqlInterceptor.statements.size.toLong())  // ,    ix_pets_location    (Index Scan)  checkInxAssertService.assertCoverage(CoverageLevel.HALF, "ix_pets_location", sqlInterceptor.statements[0])  //        ,      Seq Scan,        checkInxAssertService.assertCoverage(CoverageLevel.HALF, sqlInterceptor.statements[0])  // ...  ,      checkInxAssertService.assertPlan(plan) {          it.coverageLevel.level &lt; CoverageLevel.FULL.level      } }</span></span></code> </pre> <br>  Der Umsetzungsplan k√∂nnte wie folgt aussehen: <br><br><pre> <code class="sql hljs">Index Scan using ix_pets_location on pets pet0_  (cost=0.29..4.30 rows=1 width=46) Index Cond: ((location)::text = 'Moscow'::text)</code> </pre> <br>  ... oder so, wenn wir den Index vergessen haben (Tests werden rot): <br><br><pre> <code class="sql hljs">Seq Scan on pets pet0_  (cost=0.00..19.00 rows=4 width=84) Filter: ((location)::text = 'Moscow'::text)</code> </pre> <br>  In meinem Projekt verwende ich meistens die einfachste Behauptung, die besagt, dass der Ausf√ºhrungsplan keinen Seq-Scan enth√§lt: <br><br><pre> <code class="kotlin hljs">checkInxAssertService.assertCoverage(CoverageLevel.HALF, sqlInterceptor.statements[<span class="hljs-number"><span class="hljs-number">0</span></span>])</code> </pre> <br>  Das Vorhandensein eines solchen Tests legt nahe, dass ich zumindest den Umsetzungsplan studiert habe. <br>  Au√üerdem wird das Projektmanagement expliziter und die Dokumentierbarkeit und Vorhersagbarkeit des Codes erh√∂ht. <br><br><div class="spoiler">  <b class="spoiler_title">Erfahrener Modus</b> <div class="spoiler_text">  Ich empfehle die Verwendung von CheckInxAssertService, aber bei Bedarf k√∂nnen Sie den analysierten Baum (ExecutionPlanParser) selbst umgehen oder im Allgemeinen den rohen Ausf√ºhrungsplan (das Ergebnis der Ausf√ºhrung von ExecutionPlanQuery) analysieren. <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFindByLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {  <span class="hljs-comment"><span class="hljs-comment">// ARRANGE  val location = "Moscow"  // ACT  //     sqlInterceptor.startInterception()  //    val pets = repository.findByLocation(location)  //    sqlInterceptor.stopInterception()  // ASSERT  //  ""    val executionPlan = executionPlanQuery.execute(sqlInterceptor.statements[0])  //    -   val plan = executionPlanParser.parse(executionPlan)  assertNotNull(plan)  // ...     val rootNode = plan.rootPlanNode  assertEquals("Index Scan", rootNode.coverage)  assertEquals("ix_pets_location", rootNode.target)  assertEquals("pets pet0_", rootNode.table) }</span></span></code> </pre> </div></div><br><br><h2>  Verbindung zum Projekt </h2><br>  In meinem Projekt habe ich solche Tests einer separaten Gruppe zugeordnet und sie als intensive Integrationstests bezeichnet. <br><br>  Das Anschlie√üen und Starten von checkinx-utils ist einfach genug.  Beginnen wir mit dem Build-Skript. <br><br>  Verbinden Sie zuerst das Repository.  Eines Tages werde ich checkinx auf maven hochladen, aber jetzt kannst du Artefakte nur von GitHub √ºber jitpack herunterladen. <br><br><pre> <code class="plaintext hljs">repositories { // ...  maven { url 'https://jitpack.io' } }</code> </pre> <br>  F√ºgen Sie als N√§chstes die Abh√§ngigkeit hinzu: <br><br><pre> <code class="plaintext hljs">dependencies { // ...  implementation 'com.github.tinkoffcreditsystems:checkinx-utils:0.2.0' }</code> </pre> <br>  Wir vervollst√§ndigen die Verbindung durch Hinzuf√ºgen der Konfiguration.  Derzeit wird nur Postgres unterst√ºtzt. <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Profile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"test"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@ImportAutoConfiguration(classes = [PostgresConfig::class])</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckInxConfig</span></span></span></span></code> </pre> <br>  Achten Sie auf das Testprofil.  Andernfalls finden Sie ProxyDataSource in Ihrem Produkt. <br><br>  PostgresConfig verbindet mehrere Beans: <br><br><ol><li>  DataSourceWrapper </li><li>  PostgresInterceptor </li><li>  PostgresExecutionPlanParser </li><li>  PostgresExecutionPlanQuery </li><li>  CheckInxAssertServiceImpl </li></ol><br>  Wenn Sie eine Anpassung ben√∂tigen, die die aktuelle API nicht bietet, k√∂nnen Sie jederzeit eine der Beans durch Ihre Implementierung ersetzen. <br><br><h2>  Bekannte Probleme </h2><br>  Manchmal kann ein DataSourceWrapper die urspr√ºngliche dataSource aufgrund des Spring CGLIB-Proxys nicht ersetzen.  In diesem Fall kommt keine DataSource zu BeanPostProcessor, sondern zu ScopedProxyFactoryBean, und es gibt Probleme bei der Typpr√ºfung. <br><br>  Die einfachste L√∂sung w√§re, HikariDataSource manuell f√ºr Tests zu erstellen.  Dann wird Ihre Konfiguration wie folgt sein: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Profile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"test"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@ImportAutoConfiguration(classes = [PostgresConfig::class])</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckInxConfig</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Primary</span></span>  <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>  <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"spring.datasource"</span></span></span><span class="hljs-meta">)</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: DataSource {      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DataSourceBuilder.create()          .type(HikariDataSource::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">i</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/i</span></span></span><span class="hljs-class">&gt;)          .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build</span></span></span></span>()  }  <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>  <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"spring.datasource.configuration"</span></span></span><span class="hljs-meta">)</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(properties: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">DataSourceProperties</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: HikariDataSource {      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> properties.initializeDataSourceBuilder()          .type(HikariDataSource::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">i</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/i</span></span></span><span class="hljs-class">&gt;)          .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build</span></span></span></span>()  } }</code> </pre> <br><br><h2>  Entwicklungspl√§ne </h2><br><ol><li>  Ich w√ºrde gerne verstehen, ob jemand anders als ich das braucht?  Erstellen Sie dazu eine Umfrage.  Ich werde gerne ehrlich antworten. </li><li>  Sehen Sie, was Sie wirklich brauchen, und erweitern Sie die Standardliste der Assert-Methoden. </li><li>  Schreiben Sie Implementierungen f√ºr andere Datenbanken. </li><li>  Die Konstruktion von sqlInterceptor.statements [0] sieht nicht sehr offensichtlich aus, ich m√∂chte sie verbessern. </li></ol><br>  Ich w√ºrde mich freuen, wenn jemand mitmachen und durch das √úben in Kotlin etwas Anerkennung gewinnen m√∂chte. <br><br><h2>  Fazit </h2><br>  Ich bin mir sicher, dass es Kommentare geben wird: <i>Es ist unm√∂glich vorherzusagen, wie sich der Abfrageplaner auf dem Produkt verh√§lt, alles h√§ngt von den gesammelten Statistiken ab</i> . <br><br>  In der Tat ein Planer.  Mithilfe der zuvor gesammelten Statistiken kann ein anderer Plan als der getestete erstellt werden.  Die Bedeutung ist etwas anders. <br><br>  Die Aufgabe des Planers ist es, die Anfrage zu verbessern, nicht zu verschlechtern.  Daher wird er ohne ersichtlichen Grund Seq Scan nicht pl√∂tzlich verwenden, aber Sie k√∂nnen es unwissentlich. <br><br>  Sie ben√∂tigen CheckInx, damit Sie beim Schreiben eines Tests nicht vergessen, den Ausf√ºhrungsplan f√ºr Abfragen zu studieren und die M√∂glichkeit der Erstellung eines Index in Betracht zu ziehen, oder umgekehrt. Zeigen Sie mit einem Test deutlich, dass hier keine Indizes ben√∂tigt werden und Sie mit Seq Scan zufrieden sind.  Dies w√ºrde Ihnen unn√∂tige Fragen bei der Code√ºberpr√ºfung ersparen. <br><br><h2>  Referenzen </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/TinkoffCreditSystems/checkinx-utils</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/dsemyriazhko/checkinx-demo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/ttddyy/datasource-proxy</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://mvnrepository.com/artifact/org.testcontainers/postgresql</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/javamelody/javamelody/wiki</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de454066/">https://habr.com/ru/post/de454066/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de454056/index.html">So verbinden Sie Kubernetes-Cluster in verschiedenen Rechenzentren</a></li>
<li><a href="../de454058/index.html">Praktisches Tool zum Messen von C # -Code</a></li>
<li><a href="../de454060/index.html">Ein unerwarteter Blick auf geschwindigkeitsunabh√§ngige asynchrone Schaltungen</a></li>
<li><a href="../de454062/index.html">Unternehmenstelefon - wie ein Schweizer Messer: f√ºr Inventar, Chat, Supportanrufe und Anfragen</a></li>
<li><a href="../de454064/index.html">Die unerz√§hlte Geschichte der KI</a></li>
<li><a href="../de454070/index.html">Ein Monorad f√ºr den Pendelverkehr w√§hlen</a></li>
<li><a href="../de454072/index.html">F√ºnf gr√∂√üte Beispiele f√ºr L√ºgen in Bezug auf 5G</a></li>
<li><a href="../de454074/index.html">DynamicData: Dynamische Sammlungen, MVVM-Architektur und reaktive Erweiterungen</a></li>
<li><a href="../de454076/index.html">DotNext 2019 Piter: kleiner Bericht</a></li>
<li><a href="../de454078/index.html">"Mobile Inhalte" kostenlos, ohne SMS und Registrierung. Details zum Megaphonbetrug</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>