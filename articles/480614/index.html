<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£üèª ü§£ üë©üèΩ‚Äçüç≥ ENUM r√°pido ü§¥üèæ üë®‚Äçüîß üë©üèª‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="tl; dr 
 github.com/QratorLabs/fastenum 


pip install fast-enum  
 ¬øPor qu√© es necesaria la enumeraci√≥n? 
 (si lo sabe todo, vaya a la secci√≥n "Enume...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ENUM r√°pido</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/480614/"><h4>  tl; dr </h4><br>  <a href="https://github.com/QratorLabs/fastenum">github.com/QratorLabs/fastenum</a> <br><pre><code class="bash hljs">pip install fast-enum</code> </pre> <br><h3>  ¬øPor qu√© es necesaria la enumeraci√≥n? </h3><br>  (si lo sabe todo, vaya a la secci√≥n "Enumeraciones en la biblioteca est√°ndar") <br><br>  Imagine que necesita describir un conjunto de todos los estados posibles de entidades en su propio modelo de base de datos.  Lo m√°s probable es que tome un mont√≥n de constantes definidas directamente en el espacio de nombres del m√≥dulo: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># /path/to/package/static.py: INITIAL = 0 PROCESSING = 1 PROCESSED = 2 DECLINED = 3 RETURNED = 4 ...</span></span></code> </pre> <br>  ... o como atributos de clase est√°tica: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModelStates</span></span></span><span class="hljs-class">:</span></span> INITIAL = <span class="hljs-number"><span class="hljs-number">0</span></span> PROCESSING = <span class="hljs-number"><span class="hljs-number">1</span></span> PROCESSED = <span class="hljs-number"><span class="hljs-number">2</span></span> DECLINED = <span class="hljs-number"><span class="hljs-number">3</span></span> RETURNED = <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  Este enfoque ayudar√° a referirse a estos estados por nombres mnemot√©cnicos, mientras que en su repositorio ser√°n enteros comunes.  Por lo tanto, al mismo tiempo, elimina los n√∫meros m√°gicos dispersos en diferentes partes del c√≥digo, al mismo tiempo que lo hace m√°s legible e informativo. <br><br>  Sin embargo, tanto la constante del m√≥dulo como la clase con atributos est√°ticos adolecen de la naturaleza intr√≠nseca de los objetos de Python: todos son mutables (mutables).  Puede asignar accidentalmente un valor a su constante en tiempo de ejecuci√≥n, y depurar y deshacer objetos rotos es una aventura separada.  Por lo tanto, es posible que desee que el conjunto de constantes no cambie en el sentido de que el n√∫mero de constantes declaradas y sus valores a los que est√°n asignados no cambiar√°n durante la ejecuci√≥n del programa. <br><a name="habracut"></a><br>  Para hacer esto, puede intentar organizarlos en tuplas con nombre usando <code>namedtuple()</code> , como en el ejemplo: <br><pre> <code class="python hljs">MyModelStates = namedtuple(<span class="hljs-string"><span class="hljs-string">'MyModelStates'</span></span>, (<span class="hljs-string"><span class="hljs-string">'INITIAL'</span></span>, <span class="hljs-string"><span class="hljs-string">'PROCESSING'</span></span>, <span class="hljs-string"><span class="hljs-string">'PROCESSED'</span></span>, <span class="hljs-string"><span class="hljs-string">'DECLINED'</span></span>, <span class="hljs-string"><span class="hljs-string">'RETURNED'</span></span>)) EntityStates = MyModelStates(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)</code> </pre> <br>  Pero esto no se ve muy ordenado y legible, y los objetos con nombre de <code>namedtuple</code> , a su vez, no son muy extensibles.  Supongamos que tiene una interfaz de usuario que muestra todos estos estados.  Puede usar sus constantes en m√≥dulos, una clase con atributos o tuplas con nombre para representarlas (las dos √∫ltimas son m√°s f√°ciles de representar ya que estamos hablando de esto).  Pero dicho c√≥digo no permite proporcionar al usuario una descripci√≥n adecuada para cada estado que defina.  Adem√°s, si planea implementar el multiling√ºismo y el soporte de i18n en su interfaz de usuario, se dar√° cuenta de lo r√°pido que completar todas las traducciones de estas descripciones se vuelve una tarea incre√≠blemente tediosa.  Hacer coincidir los nombres de los estados no necesariamente significar√° hacer coincidir la descripci√≥n, lo que significa que no puede simplemente asignar todos sus estados <code>INITIAL</code> a la misma descripci√≥n en <code>gettext</code> .  En cambio, su constante toma la siguiente forma: <br><pre> <code class="python hljs">INITIAL = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'My_MODEL_INITIAL_STATE'</span></span>)</code> </pre> <br>  O tu clase se vuelve as√≠: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModelStates</span></span></span><span class="hljs-class">:</span></span> INITIAL = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span></span>)</code> </pre> <br>  Finalmente, la tupla nombrada se convierte en: <br><pre> <code class="python hljs">EntityStates = MyModelStates((<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span></span>), ...)</code> </pre><br>  Ya no est√° mal: ahora garantiza que tanto el valor de estado como el c√≥digo auxiliar de traducci√≥n se muestren en los idiomas admitidos por la IU.  Pero puede notar que el c√≥digo que usa estas asignaciones se ha convertido en un desastre.  Cada vez que intente asignar un valor de entidad, debe extraer el valor con el √≠ndice 0 de la pantalla que est√° utilizando: <br><br><pre> <code class="python hljs">my_entity.state = INITIAL[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre>  o <pre> <code class="python hljs">my_entity.state = MyModelStates.INITIAL[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre>  o <pre> <code class="python hljs">my_entity.state = EntityStates.INITIAL[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br>  Y as√≠ sucesivamente.  Recuerde que los dos primeros enfoques que usan constantes y atributos de clase, respectivamente, sufren de mutabilidad. <br><br><h4>  Y las transferencias vienen en nuestra ayuda. </h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyEntityStates</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Enum)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, val, description)</span></span></span><span class="hljs-function">:</span></span> self.val = val self.description = description INITIAL = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span></span>) PROCESSING = (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_BEING_PROCESSED_STATE'</span></span>) PROCESSED = (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_PROCESSED_STATE'</span></span>) DECLINED = (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_DECLINED_STATE'</span></span>) RETURNED = (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'MY_MODEL_RETURNED_STATE'</span></span>)</code> </pre> <br>  Eso es todo  Ahora puede iterar f√°cilmente sobre la lista en su render (sintaxis Jinja2): <br><pre> <code class="python hljs">{% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MyEntityState %} &lt;option value=‚Äù{{ state.val }}‚Äù&gt;{{ _(state.description) }}&lt;/option&gt; {% endfor %}</code> </pre> <br>  Una enumeraci√≥n es inmutable tanto para un conjunto de elementos: no puede definir un nuevo miembro de una enumeraci√≥n en tiempo de ejecuci√≥n y no puede eliminar un miembro ya definido, y para los valores de elementos que almacena, no puede [volver] a asignar valores de atributo ni eliminar un atributo. <br><br>  En su c√≥digo, simplemente asigna valores a sus entidades, as√≠: <br><pre> <code class="python hljs">my_entity.state = MyEntityStates.INITIAL.val</code> </pre> <br>  Todo es lo suficientemente claro, informativo y extensible.  Para esto utilizamos enumeraciones. <br><br><h3>  ¬øC√≥mo podr√≠amos hacerlo m√°s r√°pido? </h3><br>  La enumeraci√≥n de la biblioteca est√°ndar es bastante lenta, por lo que nos preguntamos: ¬øpodemos acelerarla?  Al final result√≥ que, podemos, a saber, la implementaci√≥n de nuestra enumeraci√≥n: <br><br><ul><li>  Tres veces m√°s r√°pido en el acceso a la enumeraci√≥n de miembros; </li><li>  ~ 8.5 m√°s r√°pido al acceder al atributo ( <code>name</code> , <code>value</code> ) de un miembro; </li><li>  3 veces m√°s r√°pido al acceder a un miembro por valor (llame al constructor de la enumeraci√≥n <code>MyEnum(value))</code> ; </li><li>  1.5 veces m√°s r√°pido al acceder a un miembro por su nombre (como en el <code>MyEnum[name]</code> ). </li></ul><br>  Los tipos y objetos en Python son din√°micos.  Pero hay herramientas para limitar la naturaleza din√°mica de los objetos.  Puede obtener un aumento significativo del rendimiento con <code>__slots__</code> .  Tambi√©n es posible que aumente la velocidad si evita usar descriptores de datos cuando sea posible, pero debe considerar la posibilidad de un aumento significativo en la complejidad de la aplicaci√≥n. <br><br><h4>  Tragamonedas </h4><br>  Por ejemplo, puede usar una declaraci√≥n de clase usando <code>__slots__</code> ; en este caso, todas las instancias de clases tendr√°n solo un conjunto limitado de propiedades declaradas en <code>__slots__</code> y todas las <code>__slots__</code> clases primarias. <br><br><h4>  Descriptores </h4><br>  Por defecto, el int√©rprete de Python devuelve el valor del atributo del objeto directamente (al mismo tiempo, estipulamos que en este caso el valor tambi√©n es un objeto de Python, y no, por ejemplo, sin signo largo en t√©rminos del lenguaje C): <br> <code>value = my_obj.attribute #        ,      .</code> <br> <br>  Seg√∫n el modelo de datos de Python, si el valor del atributo es un objeto que implementa el protocolo descriptor, cuando intente obtener el valor de este atributo, el int√©rprete primero encontrar√° una referencia al objeto al que se refiere la propiedad y luego llamar√° al m√©todo especial <code>__get__</code> , que se pasar√° a nuestro objeto original como argumento: <br><pre> <code class="python hljs">obj_attribute = my_obj.attribute obj_attribute_value = obj_attribute.__get__(my_obj)</code> </pre> <br><h4>  Enumeraciones en la biblioteca est√°ndar </h4><br>  Al menos las propiedades de <code>name</code> y <code>value</code> de los miembros de la implementaci√≥n de enumeraci√≥n est√°ndar se declaran como <code>types.DynamicClassAttribute</code> .  Esto significa que cuando intente obtener los valores de <code>name</code> y <code>value</code> , suceder√° lo siguiente: <br><br><pre> <code class="python hljs">one_value = StdEnum.ONE.value <span class="hljs-comment"><span class="hljs-comment">#        #   ,      one_value_attribute = StdEnum.ONE.value one_value = one_value_attribute.__get__(StdEnum.ONE)</span></span></code> </pre> <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,  __get__     (  python3.7): def __get__(self, instance, ownerclass=None): if instance is None: if self.__isabstractmethod__: return self raise AttributeError() elif self.fget is None: raise AttributeError("unreadable attribute") return self.fget(instance)</span></span></code> </pre> <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   DynamicClassAttribute     `name`  `value`   __get__()  : @DynamicClassAttribute def name(self): """The name of the Enum member.""" return self._name_ @DynamicClassAttribute def value(self): """The value of the Enum member.""" return self._value_</span></span></code> </pre> <br>  Por lo tanto, la secuencia completa de llamadas se puede representar mediante el siguiente pseudoc√≥digo: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(enum_member, attrname)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#        __dict__,        -     return getattr(enum_member, f'_{attrnme}_') def get_name_value(enum_member): name_descriptor = get_descriptor(enum_member, 'name') if enum_member is None: if name_descriptor.__isabstractmethod__: return name_descriptor raise AttributeError() elif name_descriptor.fget is None: raise AttributeError("unreadable attribute") return get_func(enum_member, 'name')</span></span></code> </pre> <br>  Escribimos un script simple que demuestra el resultado descrito anteriormente: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> enum <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Enum <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StdEnum</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Enum)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value, description)</span></span></span><span class="hljs-function">:</span></span> self.v = value self.description = description A = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'One'</span></span> B = <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'Two'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> StdEnum.A.name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pycallgraph <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PyCallGraph <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pycallgraph.output <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> GraphvizOutput graphviz = GraphvizOutput(output_file=<span class="hljs-string"><span class="hljs-string">'stdenum.png'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> PyCallGraph(output=graphviz): v = get_name()</code> </pre> <br>  Y despu√©s de la ejecuci√≥n, el script nos dio la siguiente imagen: <br><img src="https://habrastorage.org/webt/op/ff/m7/opffm7k3v2rgako7xufgkgqtcek.png"><br><br>  Esto muestra que cada vez que accede a los atributos de <code>name</code> y <code>value</code> de los miembros de enumeraci√≥n desde la biblioteca est√°ndar, se llama a un identificador.  Este descriptor, a su vez, finaliza con una llamada de la clase <code>Enum</code> de la biblioteca est√°ndar del m√©todo de <code>def name(self)</code> , decorada con el descriptor. <br><br>  Compare con nuestro FastEnum: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> fast_enum <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FastEnum <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyNewEnum</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=FastEnum)</span></span></span><span class="hljs-class">:</span></span> A = <span class="hljs-number"><span class="hljs-number">1</span></span> B = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MyNewEnum.A.name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pycallgraph <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PyCallGraph <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pycallgraph.output <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> GraphvizOutput graphviz = GraphvizOutput(output_file=<span class="hljs-string"><span class="hljs-string">'fastenum.png'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> PyCallGraph(output=graphviz): v = get_name()</code> </pre> <br>  Lo que se puede ver en la siguiente imagen: <br><img src="https://habrastorage.org/webt/le/ck/td/lecktd3dtx71oi3dmlyax7qyogu.png"><br><br>  Todo esto realmente sucede dentro de la implementaci√≥n de enumeraci√≥n est√°ndar cada vez que accede a las propiedades de <code>name</code> y <code>value</code> de sus miembros.  Esta es tambi√©n la raz√≥n por la cual nuestra implementaci√≥n es m√°s r√°pida. <br><br>  <b>La implementaci√≥n de enumeraciones en la biblioteca est√°ndar de Python utiliza muchas llamadas a objetos que implementan el protocolo descriptor de datos.</b>  Cuando intentamos usar la implementaci√≥n de enumeraci√≥n est√°ndar en nuestros proyectos, notamos inmediatamente cu√°ntos descriptores de datos se llamaban por <code>name</code> y <code>value</code> . <br>  Y dado que las enumeraciones se usaron ampliamente en todo el c√≥digo, el rendimiento resultante fue bajo. <br><br>  Adem√°s, la clase Enum est√°ndar contiene varios atributos auxiliares "protegidos": <br><ul><li>  <code>_member_names_</code> : una lista que contiene todos los nombres de los miembros de la enumeraci√≥n; </li><li>  <code>_member_map_</code> - <code>OrderedDict</code> , que asigna el nombre de un miembro de enumeraci√≥n a su valor; </li><li>  <code>_value2member_map_</code> : un diccionario que contiene coincidencias en la direcci√≥n opuesta: los valores de los miembros de la enumeraci√≥n a los miembros correspondientes de la enumeraci√≥n. </li></ul><br>  La b√∫squeda en el diccionario es lenta, ya que cada llamada conduce al c√°lculo de la funci√≥n hash (a menos, por supuesto, que el resultado se almacene en cach√© por separado, lo que no siempre es posible para el c√≥digo no administrado) y a la b√∫squeda en la tabla hash, lo que hace que estos diccionarios no sean una base √≥ptima para las enumeraciones.  Incluso la b√∫squeda de miembros de enumeraci√≥n (como en <code>StdEnum.MEMBER</code> ) en s√≠ misma es una b√∫squeda de diccionario. <br><br><h4>  Nuestro enfoque </h4><br>  Creamos nuestra implementaci√≥n de enumeraciones teniendo en cuenta las enumeraciones elegantes en C y las enumeraciones extensibles hermosas en Java.  Las principales funciones que quer√≠amos implementar en casa fueron las siguientes: <br><br><ul><li>  la enumeraci√≥n debe ser lo m√°s est√°tica posible;  "Est√°tico" aqu√≠ significa lo siguiente: si algo puede calcularse solo una vez y durante el anuncio, entonces debe calcularse en este momento (y solo en este momento); </li><li>  es imposible heredar de una enumeraci√≥n (debe ser una clase "final") si la clase heredada define nuevos miembros de la enumeraci√≥n; esto es cierto para la implementaci√≥n en la biblioteca est√°ndar, con la excepci√≥n de que la herencia est√° prohibida all√≠, incluso si la clase heredada no define nuevos miembros; </li><li>  la enumeraci√≥n debe tener un amplio alcance para la expansi√≥n (atributos adicionales, m√©todos, etc.) </li></ul><br>  Utilizamos la b√∫squeda de diccionario en el √∫nico caso: esta es la asignaci√≥n inversa del valor del <code>value</code> a un miembro de enumeraci√≥n.  Todos los dem√°s c√°lculos se realizan solo una vez durante la declaraci√≥n de clase (donde las metaclases se utilizan para configurar la creaci√≥n de tipos). <br>  A diferencia de la biblioteca est√°ndar, solo procesamos el primer valor despu√©s del signo <code>=</code> en la declaraci√≥n de clase como valor de miembro: <br>  <code>A = 1, 'One'</code> en la biblioteca est√°ndar, toda la tupla <code>1, "One"</code> considera como el valor del <code>value</code> ; <br>  <code>A: 'MyEnum' = 1, 'One'</code> en nuestra implementaci√≥n, solo <code>1</code> considera como un valor de <code>value</code> . <br><br>  Se logra una mayor aceleraci√≥n mediante el uso de <code>__slots__</code> donde sea posible.  En las clases de Python declaradas con <code>__slots__</code> , el atributo <code>__dict__</code> no se crea en las <code>__dict__</code> , que contiene la asignaci√≥n de nombres de atributos a sus valores (por lo tanto, no puede declarar ninguna propiedad de la instancia que no se mencione en <code>__slots__</code> ).  Adem√°s, se accede a los valores de los atributos definidos en <code>__slots__</code> en un desplazamiento constante en el puntero de instancia de objeto.  Este es el acceso de alta velocidad a las propiedades porque evita los c√°lculos hash y los escaneos de tablas hash. <br><br><h3>  ¬øCu√°les son las fichas extra? </h3><br>  FastEnum no es compatible con ninguna versi√≥n de Python anterior a 3.6 porque universalmente usa anotaciones de tipo implementadas en Python 3.6.  Se puede suponer que la instalaci√≥n del m√≥dulo de <code>typing</code> desde PyPi ayudar√°.  La respuesta corta es no.  La implementaci√≥n utiliza PEP-484 para los argumentos de algunas funciones, m√©todos y punteros al tipo de retorno, por lo que no se admite ninguna versi√≥n anterior a Python 3.5 debido a la incompatibilidad de sintaxis.  Pero, de nuevo, la primera l√≠nea de c√≥digo en la metaclase <code>__new__</code> usa la sintaxis PEP-526 para indicar el tipo de variable.  Entonces Python 3.5 tampoco funcionar√°.  Puede portar la implementaci√≥n a versiones anteriores, aunque en Qrator Labs tendemos a usar anotaciones de tipo siempre que sea posible, ya que esto ayuda mucho en el desarrollo de proyectos complejos.  Bueno, al final!  No desea quedarse atascado en Python antes de la versi√≥n 3.6, ya que en las versiones m√°s recientes no hay incompatibilidad con su c√≥digo existente (siempre que no est√© usando Python 2), y se ha realizado mucho trabajo en la implementaci√≥n de <code>asyncio</code> comparaci√≥n con 3.5, en nuestra opini√≥n, vale la pena una actualizaci√≥n inmediata. <br><br>  Esto, a su vez, hace que la importaci√≥n especial de <code>auto</code> innecesaria, a diferencia de la biblioteca est√°ndar.  Simplemente indica que el miembro de la enumeraci√≥n ser√° una instancia de esta enumeraci√≥n sin proporcionar ning√∫n valor, y el valor se generar√° autom√°ticamente para usted.  Aunque Python 3.6 es suficiente para trabajar con FastEnum, tenga en cuenta que la preservaci√≥n del orden de las teclas en los diccionarios se introdujo solo en Python 3.7 (y no utilizamos <code>OrderedDict</code> por separado para el caso 3.6).  No conocemos ning√∫n ejemplo en el que el orden de valores generado autom√°ticamente sea importante, ya que suponemos que si el desarrollador proporcion√≥ al entorno la tarea de generar y asignar un valor a un miembro de enumeraci√≥n, entonces el valor en s√≠ no es tan importante para √©l.  Sin embargo, si a√∫n no se ha cambiado a Python 3.7, se lo advertimos. <br><br>  Aquellos que necesitan que sus enumeraciones comiencen desde 0 (cero) en lugar del valor predeterminado (1) pueden hacerlo utilizando un atributo especial al declarar la enumeraci√≥n <code>_ZERO_VALUED</code> , que no se almacenar√° en la clase resultante. <br><br>  Sin embargo, existen algunas restricciones: todos los nombres de los miembros de la enumeraci√≥n deben estar escritos en letras MAY√öSCULAS; de lo contrario, la metaclase no los procesar√°. <br><br>  Finalmente, puede declarar una clase base para sus enumeraciones (tenga en cuenta que la clase base puede usar la metaclase en s√≠ misma, por lo que no necesita proporcionar la metaclase a todas las subclases), solo defina la l√≥gica general (atributos y m√©todos) en esta clase y no defina los miembros de la enumeraci√≥n (para que la clase no se "finalice").  Despu√©s de que pueda declarar tantas clases heredadas de esta clase como desee, y los propios herederos tendr√°n la misma l√≥gica. <br><br><h3>  Alias ‚Äã‚Äãy c√≥mo pueden ayudar </h3><br>  Supongamos que tiene c√≥digo usando: <br><pre> <code class="python hljs">package_a.some_lib_enum.MyEnum</code> </pre> <br>  Y que la clase MyEnum se declara de la siguiente manera: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyEnum</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=FastEnum)</span></span></span><span class="hljs-class">:</span></span> ONE: <span class="hljs-string"><span class="hljs-string">'MyEnum'</span></span> TWO: <span class="hljs-string"><span class="hljs-string">'MyEnum'</span></span></code> </pre> <br>  Ahora, ha decidido que desea refactorizar y transferir la lista a otro paquete.  Creas algo como esto: <br><pre> <code class="python hljs">package_b.some_lib_enum.MyMovedEnum</code> </pre> <br>  Donde MyMovedEnum se declara as√≠: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyMovedEnum</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(MyEnum)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br>  Ahora est√° listo para la etapa en la que la transferencia ubicada en la direcci√≥n anterior se considera obsoleta.  Reescribe las importaciones y las llamadas de esta enumeraci√≥n para que ahora se use el nuevo nombre de esta enumeraci√≥n (su alias); puede estar seguro de que todos los miembros de esta enumeraci√≥n se declaran realmente en la clase con el nombre anterior.  En la documentaci√≥n de su proyecto, declara que <code>MyEnum</code> desuso y se eliminar√° del c√≥digo en el futuro.  Por ejemplo, en la pr√≥xima versi√≥n.  Suponga que su c√≥digo almacena sus objetos con atributos que contienen miembros de enumeraci√≥n usando <code>pickle</code> .  En este punto, usa <code>MyMovedEnum</code> en su c√≥digo, pero internamente, todos los miembros de enumeraci√≥n siguen siendo instancias de <code>MyEnum</code> .  Su pr√≥ximo paso es intercambiar las declaraciones de <code>MyEnum</code> y <code>MyMovedEnum</code> para que <code>MyMovedEnum</code> no sea una subclase de <code>MyEnum</code> y <code>MyEnum</code> todos sus miembros;  <code>MyEnum</code> , por otro lado, ahora no declara ning√∫n miembro, sino que se convierte en un alias (subclase) de <code>MyMovedEnum</code> . <br><br>  Eso es todo  Cuando reinicie sus aplicaciones en la etapa de <code>unpickle</code> todos los miembros de la enumeraci√≥n se volver√°n a declarar como instancias de <code>MyMovedEnum</code> y se asociar√°n con esta nueva clase.  En el momento en que est√© seguro de que todos sus objetos almacenados, por ejemplo, en la base de datos, han sido re-deserializados (y posiblemente serializados nuevamente y almacenados en el repositorio), puede lanzar una nueva versi√≥n, en la que previamente se marc√≥ como una clase obsoleta <code>MyEnum</code> puede declararse m√°s innecesario y eliminarse de la base del c√≥digo. <br><br>  Pru√©belo usted mismo: <a href="https://github.com/QratorLabs/fastenum">github.com/QratorLabs/fastenum</a> , <a href="https://pypi.org/project/fast-enum/">pypi.org/project/fast-enum</a> . <br>  Los profesionales en karma van al autor FastEnum - <a href="https://habr.com/en/users/santjagocorkez/" class="user_link">santjagocorkez</a> . <br><br>  UPD: en la versi√≥n 1.3.0, se hizo posible heredar de clases existentes, por ejemplo, <code>int</code> , <code>float</code> , <code>str</code> .  Los miembros de tales enumeraciones pasan con √©xito la prueba de igualdad a un objeto limpio con el mismo valor ( <code>IntEnum.MEMBER == int(value_given_to_member)</code> ) y, por supuesto, que son instancias de estas clases heredadas.  Esto, a su vez, permite que el miembro de la enumeraci√≥n heredado de <code>int</code> sea ‚Äã‚Äãun argumento directo para <code>sys.exit()</code> como el c√≥digo de retorno del int√©rprete de Python. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/480614/">https://habr.com/ru/post/480614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../480600/index.html">Enum m√°s r√°pido</a></li>
<li><a href="../480606/index.html">Cinco ideas m√°s sobre c√≥mo actualizar sus habilidades como desarrollador front-end (diciembre de 2019)</a></li>
<li><a href="../480608/index.html">Rust supera a C ++ con los resultados del juego de referencia</a></li>
<li><a href="../480610/index.html">C ++ vtables. Parte 2 (herencia virtual + c√≥digo generado por compilador)</a></li>
<li><a href="../480612/index.html">Realice estos cambios para cumplir con los est√°ndares de accesibilidad del dise√±o web.</a></li>
<li><a href="../480618/index.html">Juego electr√≥nico Tic Tac Toe. ¬øA qu√© he venido?</a></li>
<li><a href="../480620/index.html">SD-WAN y DNA para ayudar al administrador: caracter√≠sticas de arquitecturas y pr√°ctica</a></li>
<li><a href="../480622/index.html">C√≥mo usar la capacidad de almacenamiento disponible correctamente</a></li>
<li><a href="../480626/index.html">Herencia de sistemas y procesos heredados o Los primeros 90 d√≠as en el rol de CTO</a></li>
<li><a href="../480642/index.html">Introducci√≥n a los ELF de Linux: comprensi√≥n y an√°lisis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>