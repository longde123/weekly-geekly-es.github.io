<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗓️ 👩‍❤️‍💋‍👩 🐐 Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind 📴 🧘🏾 🙌🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article explique comment configurer un serveur de messagerie moderne. 
 Postfix + Dovecot. SPF + DKIM + rDNS. Avec IPv6. 
 Avec le cryptage TLS. A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-interfaces + SpamAssassin-learn + Bind</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413689/">  Cet article explique comment configurer un serveur de messagerie moderne. <br>  Postfix + Dovecot.  SPF + DKIM + rDNS.  Avec IPv6. <br>  Avec le cryptage TLS.  Avec prise en charge de plusieurs domaines - partie avec un vrai certificat SSL. <br>  Avec protection anti-spam et indice anti-spam élevé sur les autres serveurs de messagerie. <br>  Avec prise en charge de plusieurs interfaces physiques. <br>  Avec OpenVPN, qui se connecte via IPv4, et qui donne IPv6. <br><br>  Si vous ne souhaitez pas apprendre toutes ces technologies, mais souhaitez configurer un tel serveur, cet article est pour vous. <br><br>  Il n'y a aucune tentative d'expliquer chaque détail de l'article.  L'explication va à ce qui n'est pas configuré de manière standard ou qui est important du point de vue du consommateur. <br><a name="habracut"></a><br>  La motivation pour mettre en place un serveur de messagerie est mon vieux rêve.  Cela peut sembler idiot, mais à mon humble avis, c'est bien mieux que de rêver d'une nouvelle voiture de votre marque préférée. <br><br>  La motivation pour configurer IPv6 est de deux.  Les informaticiens doivent constamment apprendre de nouvelles technologies pour survivre.  Je voudrais apporter ma modeste contribution à la lutte contre la censure. <br><br>  La motivation de la configuration d'OpenVPN est uniquement pour que IPv6 fonctionne sur la machine locale. <br>  La motivation pour la mise en place de plusieurs interfaces physiques est que sur mon serveur une interface est "lente mais illimitée" et l'autre "rapide, mais avec un tarif". <br><br>  La motivation pour la configuration des paramètres de liaison est que mon fournisseur fournit un serveur DNS instable, et Google se bloque également.  Je veux un serveur DNS stable pour un usage personnel. <br><br>  Motivation pour écrire un article - un brouillon a été écrit il y a 10 mois, et je l'ai déjà examiné deux fois.  Si même l'auteur en a régulièrement besoin, il y a de fortes chances que d'autres en aient besoin. <br><br>  Il n'y a pas de solution universelle pour le serveur de messagerie.  Mais j’essaierai d’écrire quelque chose comme «fais-le comme ça et puis, quand tout fonctionnera comme il faut - jette l’excédent». <br><br>  Il existe un serveur de colocation de tech.ru.  Il est possible de comparer avec OVH, Hetzner, AWS.  Pour résoudre ce problème, la coopération avec tech.ru sera beaucoup plus efficace. <br><br>  Debian 9 est installée sur le serveur. <br><br>  Sur le serveur, il y a 2 interfaces `eno1` et` eno2`.  Le premier est illimité et le second est rapide, respectivement. <br><br>  Il y a 3 adresses IP statiques, XX.XX.XX.X0 et XX.XX.XX.X1 et XX.XX.XX.X2 sur l'interface «eno1» et XX.XX.XX.X5 sur l'interface «eno2». <br><br>  Il y a XXXX: XXXX: XXXX: XXXX :: / 64 un pool d'adresses IPv6 qui sont attribuées à l'interface `eno1` et à partir de celui-ci XXXX: XXXX: XXXX: XXXX: 1: 2 :: / 96 à ma demande affecté à` eno2`. <br><br>  Il existe 3 domaines `domain1.com`,` domain2.com`, `domain3.com`.  Pour «domaine1.com» et «domaine3.com», il existe un certificat SSL. <br><br>  Il existe un compte Google auquel vous souhaitez lier la boîte aux lettres `vasya.pupkin @ domain1.com` (recevoir du courrier et envoyer du courrier directement depuis l'interface gmail). <br>  Il devrait y avoir une boîte aux lettres «support @ domain2.com», une copie du courrier dont je veux voir dans mon gmail.  Et il est rarement possible d'envoyer quelque chose au nom de «support @ domain2.com» via l'interface Web. <br><br>  Il devrait y avoir une boîte aux lettres «ivanov @ domain3.com», qu'Ivanov utilisera depuis son iPhone. <br><br>  Les lettres envoyées doivent être conformes à toutes les exigences anti-spam actuelles. <br>  Il devrait y avoir le plus haut niveau de cryptage fourni sur les réseaux publics. <br>  Il doit y avoir une prise en charge IPv6 pour l'envoi et la réception d'e-mails. <br>  Il doit y avoir un SpamAssassin qui ne supprimera jamais les e-mails.  Et il rebondira ou sautera ou enverra le dossier Spam à IMAP. <br>  L'apprentissage automatique de SpamAssassin doit être configuré: si je déplace la lettre dans le dossier Spam, j'en tirerai des leçons;  si je déplace la lettre du dossier Spam, j'en tirerai des enseignements.  Résultats d'apprentissage de SpamAssassin - devraient affecter la portée du message dans le dossier Spam. <br>  Les scripts Php devraient pouvoir envoyer des messages au nom de n'importe quel domaine sur ce serveur. <br>  Il devrait y avoir un service openvpn avec la possibilité d'utiliser IPv6 sur un client qui n'a pas IPv6. <br><br>  Vous devez d'abord configurer les interfaces et le routage, y compris IPv6. <br>  Ensuite, vous devrez configurer OpenVPN, qui se connectera via IPv4 et fournira au client une adresse IPv6 statique réelle.  Ce client aura accès à tous les services IPv6 sur le serveur et à toutes les ressources IPv6 sur Internet. <br>  Ensuite, il sera nécessaire de configurer Postfix pour envoyer des lettres + SPF + DKIM + rDNS et d'autres bagatelles similaires. <br>  Ensuite, vous devrez configurer Dovecot et configurer Multidomain. <br>  Ensuite, vous devrez configurer SpamAssassin et configurer la formation. <br>  Enfin, installez Bind. <br><br><h2>  ============== Multi-interfaces ============== </h2><br>  Pour configurer les interfaces, vous devez l'enregistrer dans "/ etc / network / interfaces". <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># The loopback network interface auto lo iface lo inet loopback # The primary network interface allow-hotplug eno1 iface eno1 inet static address XX.XX.XX.X0/24 gateway XX.XX.XX.1 dns-nameservers 127.0.0.1 213.248.1.6 post-up ip route add XX.XX.XX.0/24 dev eno1 src XX.XX.XX.X0 table eno1t post-up ip route add default via XX.XX.XX.1 table eno1t post-up ip rule add table eno1t from XX.XX.XX.X0 post-up ip rule add table eno1t to XX.XX.XX.X0 auto eno1:1 iface eno1:1 inet static address XX.XX.XX.X1 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X1 post-up ip rule add table eno1t to XX.XX.XX.X1 post-up ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t post-down ip route del 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t auto eno1:2 iface eno1:2 inet static address XX.XX.XX.X2 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X2 post-up ip rule add table eno1t to XX.XX.XX.X2 iface eno1 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1::/64 gateway X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">:1 up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1/64 dev $IFACE up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:2/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:2/64 dev $IFACE # The secondary network interface allow-hotplug eno2 iface eno2 inet static address XX.XX.XX.X5 netmask 255.255.255.0 post-up ip route add XX.XX.XX.0/24 dev eno2 src XX.XX.XX.X5 table eno2t post-up ip route add default via XX.XX.XX.1 table eno2t post-up ip rule add table eno2t from XX.XX.XX.X5 post-up ip rule add table eno2t to XX.XX.XX.X5 post-up ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X5 table eno2t post-down ip route del 10.8.0.0/24 dev tun0 src XX.XX.XX.X5 table eno2t iface eno2 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2::/96 up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:1/64 dev $IFACE up ip -6 addr add X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:2/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:1/64 dev $IFACE down ip -6 addr del X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:2:1:2/64 dev $IFACE # OpenVPN network iface tun0 inet6 static address X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:3::/80</span></span></code> </pre> <br>  Ces paramètres peuvent être appliqués sur n'importe quel serveur de tech.ru (avec un peu de coordination avec le support) et cela fonctionnera immédiatement comme il se doit. <br><br>  Si l'expérience de la mise en place de choses similaires pour Hetzner, OVH - il petite amie.  Plus dur. <br><br>  eno1 est le nom de la carte réseau # 1 (lente mais illimitée). <br>  eno2 est le nom de la carte réseau # 2 (rapide, mais avec un tarif). <br>  tun0 est le nom de la carte réseau virtuelle d'OpenVPN. <br>  XX.XX.XX.X0 - IPv4 # 1 sur eno1. <br>  XX.XX.XX.X1 - IPv4 # 2 sur eno1. <br>  XX.XX.XX.X2 - IPv4 # 3 sur eno1. <br>  XX.XX.XX.X5 - IPv4 # 1 sur eno2. <br>  XX.XX.XX.1 - Passerelle IPv4. <br>  XXXX: XXXX: XXXX: XXXX :: / 64 - IPv6 à l'ensemble du serveur. <br>  XXXX: XXXX: XXXX: XXXX: 1: 2 :: / 96 - IPv6 pour eno2, tout le reste va à eno1 de l'extérieur. <br>  XXXX: XXXX: XXXX: XXXX :: 1 - Passerelle IPv6 (il convient de noter que vous pouvez / devez vous faire un ami ici. Indiquez le commutateur IPv6). <br>  dns-nameservers - 127.0.0.1 sont spécifiés (car la liaison est installée localement) et 213.248.1.6 (cela vient de tech.ru). <br><br>  «Table eno1t» et «table eno2t» - la signification de ces règles d'itinéraire est que le trafic passant par eno1 -&gt; le traverse et que le trafic passant par eno2 -&gt; le traverse.  Et les connexions initiées par le serveur passeraient par eno1. <br><br><pre> <code class="bash hljs">ip route add default via XX.XX.XX.1 table eno1t</code> </pre> <br>  Avec cette commande, nous définissons que tout trafic incompréhensible tombant sous n'importe quelle règle avec «table eno1t» marqué -&gt; envoyer à l'interface eno1. <br><br><pre> <code class="bash hljs">ip route add XX.XX.XX.0/24 dev eno1 src XX.XX.XX.X0 table eno1t</code> </pre> <br>  Avec cette commande, nous définissons ce qui dirige tout trafic lancé par le serveur vers l'interface eno1. <br><br><pre> <code class="bash hljs">ip rule add table eno1t from XX.XX.XX.X0 ip rule add table eno1t to XX.XX.XX.X0</code> </pre> <br>  Avec cette commande, nous définissons nous-mêmes les règles de marquage du trafic. <br><br><pre> <code class="bash hljs">auto eno1:2 iface eno1:2 inet static address XX.XX.XX.X2 netmask 255.255.255.0 post-up ip rule add table eno1t from XX.XX.XX.X2 post-up ip rule add table eno1t to XX.XX.XX.X2</code> </pre> <br>  Ce bloc définit le deuxième IPv4 pour l'interface eno1. <br><br><pre> <code class="bash hljs">ip route add 10.8.0.0/24 dev tun0 src XX.XX.XX.X1 table eno1t</code> </pre> <br>  Avec cette commande, nous définissons la route des clients OpenVPN vers IPv4 local sauf XX.XX.XX.X0. <br>  Pourquoi cette commande est suffisante pour tous les IPv4 - je ne comprends toujours pas. <br><br><pre> <code class="bash hljs">iface eno1 inet6 static address XXXX:XXXX:XXXX:XXXX:1:1::/64 gateway XXXX:XXXX:XXXX:XXXX::1</code> </pre> <br>  Ceci nous avons placé l'adresse pour l'interface elle-même.  Le serveur l'utilisera comme adresse "sortante".  Ne sera plus utilisé. <br><br>  Pourquoi est-il indiqué ": 1: 1 ::" si compliqué?  Cet OpenVPN a fonctionné correctement et uniquement pour cela.  Plus d'informations à ce sujet plus tard. <br><br>  Sur le sujet de la passerelle - c'est ainsi que cela fonctionne.  Mais dans le bon sens - ici, vous devez spécifier le commutateur IPv6 auquel le serveur est connecté. <br><br>  Cependant, pour une raison quelconque, IPv6 cesse de fonctionner si je le fais.  C'est peut-être quelques problèmes tech.ru. <br><br><pre> <code class="bash hljs">ip -6 addr add XXXX:XXXX:XXXX:XXXX:1:1:1:1/64 dev <span class="hljs-variable"><span class="hljs-variable">$IFACE</span></span></code> </pre> <br>  Cela ajoute des adresses IPv6 à l'interface.  Si vous avez besoin d'une centaine d'adresses, cela signifie une centaine de lignes dans ce fichier. <br><br><pre> <code class="bash hljs">iface eno1 inet6 static address XXXX:XXXX:XXXX:XXXX:1:1::/64 ... iface eno2 inet6 static address XXXX:XXXX:XXXX:XXXX:1:2::/96 ... iface tun0 inet6 static address XXXX:XXXX:XXXX:XXXX:1:3::/80</code> </pre> <br><blockquote>  A marqué les adresses et les sous-réseaux de toutes les interfaces pour que ce soit clair. <br>  eno1 - il doit être "/ 64" - car il s'agit de l'ensemble de notre pool d'adresses. <br>  tun0 - le sous-réseau doit être plus grand que eno1.  Sinon, vous ne pouvez pas configurer la passerelle IPv6 pour les clients OpenVPN. <br>  eno2 - le sous-réseau doit être plus grand que tun0.  Sinon, les clients OpenVPN ne pourront pas obtenir les adresses IPv6 locales. <br>  Pour plus de clarté, j'ai choisi l'étape de sous-réseau 16, mais vous pouvez même prendre l'étape «1» si vous le souhaitez. <br>  En conséquence, 64 + 16 = 80 et 80 + 16 = 96. <br><br>  Pour encore plus de clarté: <br>  XXXX: XXXX: XXXX: XXXX: 1: 1: YYYY: YYYY - ce sont des adresses qui doivent être attribuées à des sites ou services spécifiques sur l'interface eno1. <br>  XXXX: XXXX: XXXX: XXXX: 1: 2: YYYY: YYYY - ce sont des adresses qui doivent être attribuées à des sites ou services spécifiques sur l'interface eno2. <br>  XXXX: XXXX: XXXX: XXXX: 1: 3: YYYY: YYYY sont des adresses qui doivent être attribuées aux clients OpenVPN ou utilisées comme adresses de service OpenVPN. </blockquote><br><br>  Pour configurer le réseau - il devrait être possible de redémarrer le serveur. <br>  Les modifications IPv4 sont récupérées lors de l'exécution (assurez-vous de les envelopper à l'écran - sinon cette commande supprimera simplement le réseau sur le serveur): <br><br><pre> <code class="bash hljs">/etc/init.d/networking restart</code> </pre> <br>  Dans le fichier "/ etc / iproute2 / rt_tables" ajoutez à la fin: <br><br><pre> <code class="bash hljs">100 eno1t 101 eno2t</code> </pre> <br>  Sans cela, vous ne pouvez pas utiliser de tables personnalisées dans le fichier "/ etc / network / interfaces". <br>  Les nombres doivent être uniques et inférieurs à 65535. <br><br>  Les changements d'IPv6 changent facilement sans redémarrer, mais pour cela, vous devez apprendre au moins trois commandes: <br><br><pre> <code class="bash hljs">ip -6 addr ... ip -6 route ... ip -6 neigh ...</code> </pre> <br>  Configuration de "/etc/sysctl.conf" <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Uncomment the next line to enable packet forwarding for IPv4 net.ipv4.ip_forward = 1 # Do not accept ICMP redirects (prevent MITM attacks) net.ipv4.conf.all.accept_redirects = 0 net.ipv6.conf.all.accept_redirects = 0 # Do not send ICMP redirects (we are not a router) net.ipv4.conf.all.send_redirects = 0 # For receiving ARP replies net.ipv4.conf.all.arp_filter = 0 net.ipv4.conf.default.arp_filter = 0 # For sending ARP net.ipv4.conf.all.arp_announce = 0 net.ipv4.conf.default.arp_announce = 0 # Enable IPv6 net.ipv6.conf.all.disable_ipv6 = 0 net.ipv6.conf.default.disable_ipv6 = 0 net.ipv6.conf.lo.disable_ipv6 = 0 # IPv6 configuration net.ipv6.conf.all.autoconf = 1 net.ipv6.conf.all.accept_ra = 0 # For OpenVPN net.ipv6.conf.all.forwarding = 1 net.ipv6.conf.all.proxy_ndp = 1 # For nginx on boot net.ipv6.ip_nonlocal_bind = 1</span></span></code> </pre> <br>  Ce sont les paramètres sysctl de mon serveur.  Je note l'important. <br><br><pre> <code class="bash hljs">net.ipv4.ip_forward = 1</code> </pre> <br>  Sans cela, OpenVPN ne fonctionnera en aucune façon. <br><br><pre> <code class="bash hljs">net.ipv6.ip_nonlocal_bind = 1</code> </pre> <br>  Quiconque essaie de lier IPv6 (par exemple nginx) juste après que l'interface est en place recevra une erreur.  Qu'une telle adresse n'est pas disponible. <br><br>  Pour éviter une telle situation, un tel réglage est effectué. <br><br><pre> <code class="bash hljs">net.ipv6.conf.all.forwarding = 1 net.ipv6.conf.all.proxy_ndp = 1</code> </pre> <br>  Sans ces paramètres IPv6, le trafic provenant du client OpenVPN ne va pas dans le monde. <br><br>  D'autres paramètres ne sont pas pertinents ou je ne me souviens pas pourquoi ils le sont. <br>  Mais juste au cas où, je laisse "tel quel". <br><br>  Pour que les modifications de ce fichier soient récupérées sans redémarrer le serveur, vous devez exécuter la commande: <br><br><pre> <code class="bash hljs">sysctl -p</code> </pre> <br>  Plus de détails sur les règles "table": <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/post/108690</a> <br><br><h2>  ============== OpenVPN ============== </h2><br>  OpenVPN IPv4 ne fonctionne pas sans iptables. <br><br>  J'ai ces iptables pour VPN: <br><br><pre> <code class="bash hljs">iptables -A INPUT -p udp -s YY.YY.YY.YY --dport 1194 -j ACCEPT iptables -A FORWARD -i tun0 -o eno1 -j ACCEPT iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j SNAT --to-source XX.XX.XX.X0 <span class="hljs-comment"><span class="hljs-comment">##iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j MASQUERADE iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP iptables -A FORWARD -p udp --dport 1194 -j DROP</span></span></code> </pre> <br>  YY.YY.YY.YY est mon adresse IPv4 statique de la machine locale. <br>  10.8.0.0/24 - Réseau openvpn IPv4.  Adresses IPv4 pour les clients openvpn. <br>  La séquence de règles est importante. <br><br><pre> <code class="bash hljs">iptables -A INPUT -p udp -s YY.YY.YY.YY --dport 1194 -j ACCEPT iptables -A FORWARD -i tun0 -o eno1 -j ACCEPT ... iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP iptables -A FORWARD -p udp --dport 1194 -j DROP</code> </pre> <br>  Il s'agit d'une limitation afin que seul je puisse utiliser OpenVPN à partir de mon adresse IP statique. <br><br><pre> <code class="bash hljs">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j SNAT --to-source XX.XX.XX.X0 --  -- iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eno1 -j MASQUERADE</code> </pre> <br>  Pour transférer des paquets IPv4 entre des clients OpenVPN et Internet, vous devez enregistrer l'une de ces commandes. <br><br>  Pour différents cas, l'une des options ne convient pas. <br>  Les deux équipes conviennent à mon cas. <br>  Après avoir lu la documentation, j'ai choisi la première option, car elle consomme moins de CPU. <br><br>  Pour que tous les paramètres iptables soient récupérés après le redémarrage - vous devez les enregistrer quelque part. <br><br><pre> <code class="bash hljs">iptables-save &gt; /etc/iptables/rules.v4 ip6tables-save &gt; /etc/iptables/rules.v6</code> </pre> <br>  Ces noms n'ont pas été choisis par hasard.  Le package iptables-persistent les utilise. <br><br><pre> <code class="bash hljs">apt-get install iptables-persistent</code> </pre> <br>  Installation du package OpenVPN principal: <br><br><pre> <code class="bash hljs">apt-get install openvpn easy-rsa</code> </pre> <br>  Configurez un modèle de certificats (remplacez vos valeurs): <br><br><pre> <code class="bash hljs">make-cadir ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca ln -s openssl-1.0.0.cnf openssl.cnf</code> </pre> <br>  Modifions les paramètres du modèle de certificat: <br><br><pre> <code class="bash hljs">mcedit vars</code> </pre> <br><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># These are the default values for fields # which will be placed in the certificate. # Don't leave any of these fields blank. export KEY_COUNTRY="RU" export KEY_PROVINCE="Krasnodar" export KEY_CITY="Dinskaya" export KEY_ORG="Own" export KEY_EMAIL="admin@domain1.com" export KEY_OU="VPN" # X509 Subject Field export KEY_NAME="server" ...</span></span></code> </pre> <br>  Créez un certificat de serveur: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./clean-all ./build-ca ./build-key-server server ./build-dh openvpn --genkey --secret keys/ta.key</code> </pre> <br>  Nous préparerons l'opportunité de créer les fichiers "client-name.opvn" résultants: <br><br><pre> <code class="bash hljs">mkdir -p ~/client-configs/files chmod 700 ~/client-configs/files cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf ~/client-configs/base.conf mcedit ~/client-configs/base.conf</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Client mode client # Interface tunnel type dev tun # TCP protocol proto tcp-client # Address/Port of VPN server remote XX.XX.XX.X0 1194 # Don't bind to local port/address nobind # Don't need to re-read keys and re-create tun at restart persist-key persist-tun # Remote peer must have a signed certificate remote-cert-tls server ns-cert-type server # Enable compression comp-lzo # Custom ns-cert-type server tls-auth ta.key 1 cipher DES-EDE3-CBC</span></span></code> </pre> <br>  Nous préparerons un script qui assemblera tous les fichiers en un seul fichier opvn. <br><br><pre> <code class="bash hljs">mcedit ~/client-configs/make_config.sh chmod 700 ~/client-configs/make_config.sh</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # First argument: Client identifier KEY_DIR=~/openvpn-ca/keys OUTPUT_DIR=~/client-configs/files BASE_CONFIG=~/client-configs/base.conf cat ${BASE_CONFIG} \ &lt;(echo -e '&lt;ca&gt;') \ ${KEY_DIR}/ca.crt \ &lt;(echo -e '&lt;/ca&gt;\n&lt;cert&gt;') \ ${KEY_DIR}/${1}.crt \ &lt;(echo -e '&lt;/cert&gt;\n&lt;key&gt;') \ ${KEY_DIR}/${1}.key \ &lt;(echo -e '&lt;/key&gt;\n&lt;tls-auth&gt;') \ ${KEY_DIR}/ta.key \ &lt;(echo -e '&lt;/tls-auth&gt;') \ &gt; ${OUTPUT_DIR}/${1}.ovpn</span></span></code> </pre> <br>  Nous créons le premier client OpenVPN: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./build-key client-name <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/client-configs ./make_config.sh client-name</code> </pre> <br>  Le fichier "~ / client-configs / files / client-name.ovpn" est envoyé au client. <br><br>  Pour les clients iOS, vous devrez faire l'astuce: <br>  Le contenu de la balise tls-auth doit être sans commentaire. <br>  Et mettez également "key-direction 1" juste avant la balise "tls-auth". <br><br>  Configurez la configuration du serveur OpenVPN: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/openvpn-ca/keys cp ca.crt ca.key server.crt server.key ta.key dh2048.pem /etc/openvpn gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | tee /etc/openvpn/server.conf mcedit /etc/openvpn/server.conf</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Listen port port 1194 # Protocol proto tcp-server # IP tunnel dev tun0 tun-ipv6 push tun-ipv6 # Master certificate ca ca.crt # Server certificate cert server.crt # Server private key key server.key # Diffie-Hellman parameters dh dh2048.pem # Allow clients to communicate with each other client-to-client # Client config dir client-config-dir /etc/openvpn/ccd # Run client-specific script on connection and disconnection script-security 2 client-connect "/usr/bin/sudo -u root /etc/openvpn/server-clientconnect.sh" client-disconnect "/usr/bin/sudo -u root /etc/openvpn/server-clientdisconnect.sh" # Server mode and client subnets server 10.8.0.0 255.255.255.0 server-ipv6 X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:3::/80 topology subnet # IPv6 routes push "route-ipv6 X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">:/64" push "route-ipv6 2000::/3" # DNS (for Windows) # These are OpenDNS push "dhcp-option DNS 208.67.222.222" push "dhcp-option DNS 208.67.220.220" # Configure all clients to redirect their default network gateway through the VPN push "redirect-gateway def1 bypass-dhcp" push "redirect-gateway ipv6" #For iOS # Don't need to re-read keys and re-create tun at restart persist-key persist-tun # Ping every 10s. Timeout of 120s. keepalive 10 120 # Enable compression comp-lzo # User and group user vpn group vpn # Log a short status status openvpn-status.log # Logging verbosity ##verb 4 # Custom config tls-auth ta.key 0 cipher DES-EDE3-CBC</span></span></code> </pre> <br>  Ceci est nécessaire afin de définir une adresse statique pour chaque client (pas nécessaire, mais j'utilise): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Client config dir client-config-dir /etc/openvpn/ccd</span></span></code> </pre> <br>  Le détail le plus difficile et le plus important. <br><br>  Malheureusement, OpenVPN n'est pas encore en mesure de configurer indépendamment la passerelle IPv6 pour les clients. <br>  Nous devons le transmettre manuellement pour chaque client. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Run client-specific script on connection and disconnection script-security 2 client-connect "/usr/bin/sudo -u root /etc/openvpn/server-clientconnect.sh" client-disconnect "/usr/bin/sudo -u root /etc/openvpn/server-clientdisconnect.sh"</span></span></code> </pre> <br>  Fichier "/etc/openvpn/server-clientconnect.sh": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Check client variables if [ -z "$ifconfig_pool_remote_ip" ] || [ -z "$common_name" ]; then echo "Missing environment variable." exit 1 fi # Load server variables . /etc/openvpn/variables ipv6="" # Find out if there is a specific config with fixed IPv6 for this client if [ -f "/etc/openvpn/ccd/$common_name" ]; then # Get fixed IPv6 from client config file ipv6=$(sed -nr 's/^.*ifconfig-ipv6-push[ \t]+([0-9a-fA-F\\:]+).*$/\1/p' "/etc/openvpn/ccd/$common_name") echo $ipv6 fi # Get IPv6 from IPv4 if [ -z "$ipv6" ]; then ipp=$(echo "$ifconfig_pool_remote_ip" | cut -d. -f4) if ! [ "$ipp" -ge 2 -a "$ipp" -le 254 ] 2&gt;/dev/null; then echo "Invalid IPv4 part." exit 1 fi hexipp=$(printf '%x' $ipp) ipv6="$prefix$hexipp" fi # Create proxy rule /sbin/ip -6 neigh add proxy $ipv6 dev eno1</span></span></code> </pre> <br><br>  Fichier "/etc/openvpn/server-clientdisconnect.sh": <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Check client variables if [ -z "$ifconfig_pool_remote_ip" ] || [ -z "$common_name" ]; then echo "Missing environment variable." exit 1 fi # Load server variables . /etc/openvpn/variables ipv6="" # Find out if there is a specific config with fixed IPv6 for this client if [ -f "/etc/openvpn/ccd/$common_name" ]; then # Get fixed IPv6 from client config file ipv6=$(sed -nr 's/^.*ifconfig-ipv6-push[ \t]+([0-9a-fA-F\\:]+).*$/\1/p' "/etc/openvpn/ccd/$common_name") fi # Get IPv6 from IPv4 if [ -z "$ipv6" ]; then ipp=$(echo "$ifconfig_pool_remote_ip" | cut -d. -f4) if ! [ "$ipp" -ge 2 -a "$ipp" -le 254 ] 2&gt;/dev/null; then echo "Invalid IPv4 part." exit 1 fi hexipp=$(printf '%x' $ipp) ipv6="$prefix$hexipp" fi # Delete proxy rule /sbin/ip -6 neigh del proxy $ipv6 dev eno1</span></span></code> </pre> <br>  Les deux scripts utilisent le fichier "/ etc / openvpn / variables": <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Subnet prefix=X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">2: # netmask prefixlen=112</span></span></code> </pre> <br>  Pourquoi est-il écrit ici - j'ai du mal à m'en souvenir. <br><br>  Maintenant, il semble étrange masque de réseau = 112 (à droite, il devrait y avoir 96). <br>  Et le préfixe est bizarre, ne correspond pas au réseau tun0. <br>  Mais d'accord, je le laisse "tel quel". <br><br><pre> <code class="bash hljs">cipher DES-EDE3-CBC</code> </pre> <br>  C'est un amateur - j'ai choisi cette méthode de cryptage de la connexion. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">En savoir plus sur la configuration d'OpenvPN IPv4.</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">En savoir plus sur la configuration d'OpenVPN IPv6.</a> <br><br><h2>  ============== Postfix ============== </h2><br>  Installation du package principal: <br><br><pre> <code class="bash hljs">apt-get install postfix</code> </pre> <br>  Lors de l'installation, sélectionnez "site Internet". <br><br>  Mon "/etc/postfix/main.cf" ressemble à ceci: <br><br><pre> <code class="bash hljs">smtpd_banner = <span class="hljs-variable"><span class="hljs-variable">$myhostname</span></span> ESMTP <span class="hljs-variable"><span class="hljs-variable">$mail_name</span></span> (Debian/GNU) biff = no <span class="hljs-comment"><span class="hljs-comment"># appending .domain is the MUA's job. append_dot_mydomain = no readme_directory = no # See http://www.postfix.org/COMPATIBILITY_README.html -- default to 2 on # fresh installs. compatibility_level = 2 # TLS parameters smtpd_tls_cert_file=/etc/ssl/domain1.com.2018.chained.crt smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key smtpd_use_tls=yes smtpd_tls_auth_only = yes smtp_bind_address = XX.XX.XX.X0 smtp_bind_address6 = X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">X</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">XXX:</span></span></span><span class="hljs-comment">1:1:1:1 smtp_tls_security_level = may smtp_tls_ciphers = export smtp_tls_protocols = !SSLv2, !SSLv3 smtp_tls_loglevel = 1 smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination myhostname = domain1.com alias_maps = hash:/etc/aliases alias_database = hash:/etc/aliases myorigin = domain1.com mydestination = localhost relayhost = mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 mailbox_size_limit = 0 recipient_delimiter = + inet_interfaces = all inet_protocols = ipv4 internal_mail_filter_classes = bounce # Storage type virtual_transport = lmtp:unix:private/dovecot-lmtp virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf # SMTP-Auth settings smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes smtpd_recipient_restrictions = permit_sasl_authenticated, permit_mynetworks, #reject_invalid_hostname, #reject_unknown_recipient_domain, reject_unauth_destination, reject_rbl_client sbl.spamhaus.org, check_policy_service unix:private/policyd-spf smtpd_helo_restrictions = #reject_invalid_helo_hostname, #reject_non_fqdn_helo_hostname, reject_unknown_helo_hostname smtpd_client_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_non_fqdn_helo_hostname, permit # SPF policyd-spf_time_limit = 3600 # OpenDKIM milter_default_action = accept milter_protocol = 6 smtpd_milters = unix:var/run/opendkim/opendkim.sock non_smtpd_milters = unix:var/run/opendkim/opendkim.sock # IP address per domain sender_dependent_default_transport_maps = pcre:/etc/postfix/sdd_transport.pcre</span></span></code> </pre> <br>  Examinons les détails de cette config. <br><br><pre> <code class="bash hljs">smtpd_tls_cert_file=/etc/ssl/domain1.com.2018.chained.crt smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key</code> </pre> <br><br><hr><blockquote><div class="spoiler">  <b class="spoiler_title">Selon les citoyens de Khabrovsk, ce bloc contient «de la désinformation et des fausses thèses».</b> <div class="spoiler_text">  Seulement 8 ans après le début de ma carrière, j'ai commencé à comprendre le fonctionnement de SSL. <br><br>  Par conséquent, je me permettrai de décrire comment utiliser SSL (sans répondre aux questions «Comment ça marche?» Et «Pourquoi ça marche?»). <br><br>  La base du cryptage moderne est la création d'une paire de clés (deux très longues lignes de caractères). <br><br>  Une «clé» est privée, l'autre est «publique».  Nous gardons la clé privée très soigneusement en secret.  Nous distribuons la clé publique à tout le monde. <br><br>  À l'aide d'une clé publique, vous pouvez crypter une chaîne de texte afin que seul le propriétaire de la clé privée puisse décrypter. <br>  Eh bien, c'est tout le fondement de la technologie. <br><br>  Étape # 1 - Sites https. <br>  Lors de l'accès au site, le navigateur apprend du serveur Web que le site est https et demande donc une clé publique. <br>  Le serveur Web donne la clé publique.  À l'aide de la clé publique, le navigateur crypte la demande http et l'envoie. <br>  Le contenu de la requête http ne peut être lu que par une personne possédant une clé privée, c'est-à-dire uniquement le serveur vers lequel l'appel est effectué. <br>  La requête Http contient au moins un URI.  Par conséquent, si le pays tente de restreindre l'accès non pas à l'ensemble du site, mais à une page spécifique, cela ne peut pas être fait pour les sites https. <br><br>  L'étape # 2 est la réponse chiffrée. <br>  Le serveur Web fournit une réponse qui peut être facilement lue en cours de route. <br>  La solution est extrêmement simple - le navigateur génère localement la même paire de clés privée-publique pour chaque site https. <br>  Et en même temps que la demande de clé publique du site, il envoie sa clé publique locale. <br>  Le serveur Web s'en souvient et, lors de l'envoi de la réponse http, crypte avec cette clé publique d'un client spécifique. <br>  Désormais, la réponse http ne peut être déchiffrée que par le propriétaire de la clé privée du navigateur du client (c'est-à-dire le client lui-même). <br><br>  Étape numéro 3 - établir une connexion sécurisée via un canal public. <br>  Dans l'exemple n ° 2, il existe une vulnérabilité - rien n'empêche les sympathisants d'intercepter la requête http et de modifier les informations de clé publique. <br>  Ainsi, l'intermédiaire verra presque tout le contenu des messages envoyés et reçus jusqu'à ce que le canal de communication change. <br>  Lutter contre cela est extrêmement simple - il suffit d'envoyer la clé publique du navigateur sous forme de message crypté avec la clé publique du serveur Web. <br>  Le serveur Web envoie alors d'abord une réponse du type "votre clé publique est comme ça" et crypte ce message avec la même clé publique. <br>  Le navigateur regarde la réponse - si le message "votre clé publique est comme ça" est reçu - alors c'est une garantie à 100% que ce canal de communication est sûr. <br>  Est-ce sûr? <br>  La création d'un tel canal de communication sécurisé se fait à une vitesse ping * 2.  Par exemple, 20 ms. <br>  Un attaquant doit disposer à l'avance d'une des clés privées de l'une des parties.  Ou récupérez une clé privée pendant quelques millisecondes. <br>  Le piratage d'une clé privée moderne prendra des décennies sur un supercalculateur. <br><br>  Étape # 4 - base de données publique des clés publiques. <br>  De toute évidence, dans toute cette histoire, il existe une possibilité pour un attaquant assis sur le canal de communication entre le client et le serveur. <br>  L'opportunité pour le client est présentée par le serveur, et le serveur est présenté par le client.  Et émuler une paire de clés dans les deux sens. <br>  L'attaquant verra alors tout le trafic et pourra "éditer" le trafic. <br>  Par exemple, changez l'adresse où envoyer de l'argent ou copiez le mot de passe de la banque en ligne ou bloquez le contenu «répréhensible». <br>  Pour combattre de tels attaquants, ils ont créé une base de données publique avec des clés publiques pour chaque site https. <br>  Chaque navigateur "connaît" l'existence d'environ 200 de ces bases de données.  Ceci est préinstallé dans chaque navigateur. <br>  La «connaissance» est sauvegardée par une clé publique pour chaque certificat.  Autrement dit, il est impossible de simuler une connexion avec chaque autorité de certification spécifique. <br><br>  Maintenant, il existe une compréhension simple de l'utilisation de SSL pour https. <br>  Si vous bougez votre cerveau, il deviendra clair comment les services spéciaux peuvent casser quelque chose dans cette conception.  Mais cela leur coûtera d'énormes efforts. <br>  Et les organisations plus petites que la NSA ou la CIA - il est presque impossible de casser le niveau de protection existant, même pour vip. <br><br>  J'ajouterai également des informations sur les connexions ssh.  Il n'y a pas de clés publiques, que faire.  Le problème est résolu de deux manières. <br>  Option de mot de passe Ssh: <br>  Lors de la première connexion, le client ssh doit avertir que nous avons ici une nouvelle clé publique du serveur ssh. <br>  Et avec d'autres connexions, si l'avertissement «une nouvelle clé publique du serveur ssh» apparaît, cela signifie qu'ils essaient de vous écouter. <br>  Ou à la première connexion, vous avez été écouté, et maintenant vous parlez au serveur sans intermédiaires. <br>  En fait, du fait que le fait de l'écoute électronique est facilement, rapidement et sans effort révélé, cette attaque n'est utilisée que dans des cas spéciaux pour un client spécifique. <br><br>  Option clé ssh: <br>  Nous prenons un lecteur flash, écrivons une clé privée pour le serveur ssh dessus (pour cela, il y a des termes et un tas de nuances importantes, mais j'écris un programme éducatif, pas des instructions d'utilisation). <br>  Nous laissons la clé publique sur la machine où sera le client ssh et nous la gardons également secrète. <br>  Nous apportons le lecteur flash au serveur, collons, copions la clé privée et brûlons le lecteur flash et dispersons la poussière dans le vent (ou du moins formatez-le avec des zéros). <br>  C'est tout - après une telle opération, il sera impossible de casser une telle connexion ssh.  Bien sûr, sur 10 ans, vous pouvez voir le trafic sur un supercalculateur - mais c'est une autre histoire. <br><br>  Je m'excuse pour l'offtopic. <br></div></div></blockquote>  Alors maintenant que la théorie est connue.  Je vais vous parler du déroulement de la création d'un certificat SSL. <br><br>  En utilisant "openssl genrsa", nous créons une clé privée et des "blancs" pour la clé publique. <br>  Nous envoyons les «blancs» à une société tierce, à laquelle nous payons environ 9 $ pour le certificat le plus simple. <br><br>  Dans quelques heures, nous recevons de cette société tierce notre clé «publique» et un autre jeu de plusieurs clés publiques. <br><br>  Pourquoi une société tierce devrait-elle payer pour la délivrance de ma clé publique - une question distincte, nous ne l'examinerons pas ici. <br><br>  Maintenant, la signification de l’inscription est claire: <br><br><pre> <code class="plaintext hljs">smtpd_tls_key_file=/etc/ssl/domain1.com.2018.key</code> </pre> <br>  Dans le dossier "/ etc / ssl" tous les fichiers pour les questions SSL sont stockés. <br>  domain1.com - nom de domaine. <br>  2018 est l'année de la création des clés. <br>  "Clé" - désignation que le fichier est une clé privée. <br><br>  Et la signification de ce fichier: <br><br>  smtpd_tls_cert_file = / etc / ssl / domain1.com.2018.chained.crt <br>  domain1.com - nom de domaine. <br>  2018 est l'année de la création des clés. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enchaîné - une désignation qu'il existe une chaîne de clés publiques (la première est notre clé publique et le reste est ce qui est venu de la société qui a émis la clé publique). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crt - désignation qu'il existe un certificat prêt (clé publique avec explications techniques).</font></font><br><br><pre> <code class="bash hljs">smtp_bind_address = XX.XX.XX.X0 smtp_bind_address6 = XXXX:XXXX:XXXX:XXXX:1:1:1:1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce paramètre n'est pas utilisé dans ce cas, mais est écrit à titre d'exemple. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parce qu'une erreur dans ce paramètre entraînera l'envoi de spam depuis votre serveur (sans votre volonté). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prouvez ensuite à tout le monde que vous n'êtes pas à blâmer.</font></font><br><br><pre> <code class="bash hljs">recipient_delimiter = +</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beaucoup ne le savent peut-être pas, c'est donc un symbole standard pour le pâturage, et cela est pris en charge par la plupart des serveurs de messagerie modernes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par exemple, si vous avez une boîte aux lettres «username@gmail.com», essayez de l'envoyer à «username+spam@gmail.com» - voyez ce qui se passe.</font></font><br><br><pre> <code class="bash hljs">inet_protocols = ipv4</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce sera peut-être déroutant. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais ce n'est pas juste. </font><font style="vertical-align: inherit;">Chaque nouveau domaine est par défaut uniquement IPv4, puis j'active IPv6 pour chacun individuellement.</font></font><br><br><pre> <code class="bash hljs">virtual_transport = lmtp:unix:private/dovecot-lmtp virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici, nous définissons que tout le courrier entrant est envoyé à pigeonnier. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et les règles pour le domaine, la boîte aux lettres, l'alias - regardez dans la base de données. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postfix/mysql-virtual-mailbox-domains.cf</font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT 1 FROM virtual_domains WHERE name=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /etc/postfix/mysql-virtual-mailbox-maps.cf </font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT 1 FROM virtual_users WHERE email=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /etc/postfix/mysql-virtual-alias-maps.cf </font></font><br><br><pre> <code class="bash hljs">user = usermail password = mailpassword hosts = 127.0.0.1 dbname = servermail query = SELECT destination FROM virtual_aliases WHERE <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>=<span class="hljs-string"><span class="hljs-string">'%s'</span></span></code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SMTP-Auth settings smtpd_sasl_type = dovecot smtpd_sasl_path = private/auth smtpd_sasl_auth_enable = yes</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postfix sait maintenant que vous ne pouvez accepter le courrier que pour un envoi ultérieur par autorisation avec dovecot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je ne comprends vraiment pas pourquoi cela est reproduit ici. </font><font style="vertical-align: inherit;">Nous avons déjà indiqué dans virtual_transport tout ce qui est nécessaire. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais le système postfix est très ancien - ce sont probablement les châteaux d'autrefois.</font></font><br><br><pre> <code class="bash hljs">smtpd_recipient_restrictions = ... smtpd_helo_restrictions = ... smtpd_client_restrictions = ...</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceci est configuré pour chaque serveur de messagerie à sa manière. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai 3 serveurs de messagerie à ma disposition et ces paramètres sont très différents en raison des différentes exigences d'utilisation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous devez configurer soigneusement - sinon le spam vous inondera ou pire, le spam vous inondera.</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SPF policyd-spf_time_limit = 3600</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuration d'un type de plugin lié à la vérification SPF des messages entrants. </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># OpenDKIM milter_default_action = accept milter_protocol = 6 smtpd_milters = unix:var/run/opendkim/opendkim.sock non_smtpd_milters = unix:var/run/opendkim/opendkim.sock</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En configurant toutes les lettres sortantes, nous devons fournir une signature DKIM. </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># IP address per domain sender_dependent_default_transport_maps = pcre:/etc/postfix/sdd_transport.pcre</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit d'un détail clé dans le routage des e-mails lors de l'envoi d'e-mails à partir de scripts php. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/postfix/sdd_transport.pcre":</font></font><br><br><pre> <code class="bash hljs">/^www-domain1@domain1\.com$/ domain1: /^www-domain2@domain1\.com$/ domain2: /^www-domain3@domain1\.com$/ domain3: /@domain1\.com$/ domain1: /@domain2\.com$/ domain2: /@domain3\.com$/ domain3:</code> </pre> <br><blockquote>  —  .  — ,   . <br> Postfix     —        . <br><br>     postfix    —    «master.cf». <br><br>  4, 5, 6 —  .       —    . <br>     php       «from».      . <br><br>     —       nginx+fpm. <br><br>  —       linux-user .    fpm-pool. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fpm-pool utilise n'importe quelle version de php (c'est génial lorsque vous pouvez utiliser une version différente de php et même un php.ini différent sur le même serveur pour les sites voisins). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainsi, un utilisateur Linux particulier "www-domain2" a un site domain2.com. </font><font style="vertical-align: inherit;">Ce site a un code pour envoyer des lettres sans spécifier le champ from. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainsi, même dans ce cas, les lettres disparaîtront correctement et n'entreront jamais dans le spam.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mon "/etc/postfix/master.cf" ressemble à ceci: </font></font><br><br><pre> <code class="bash hljs">... smtp inet n - y - - smtpd -o content_filter=spamassassin ... submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject ... policyd-spf unix - nn - 0 spawn user=policyd-spf argv=/usr/bin/policyd-spf spamassassin unix - nn - - pipe user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span class="hljs-variable"><span class="hljs-variable">${sender}</span></span> <span class="hljs-variable"><span class="hljs-variable">${recipient}</span></span> ... domain1 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X1 -o smtp_helo_name=domain1.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:1:1 -o syslog_name=postfix-domain1 domain2 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X5 -o smtp_helo_name=domain2.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:2:1:1 -o syslog_name=postfix-domain2 domain3 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X2 -o smtp_helo_name=domain3 -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:5:1 -o syslog_name=postfix-domain3</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le fichier n'est pas complètement fourni - il est déjà très volumineux. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'a noté que ce qui a été changé.</font></font><br><br><pre> <code class="bash hljs">smtp inet n - y - - smtpd -o content_filter=spamassassin ... spamassassin unix - nn - - pipe user=spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f <span class="hljs-variable"><span class="hljs-variable">${sender}</span></span> <span class="hljs-variable"><span class="hljs-variable">${recipient}</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ce sont les paramètres liés au spamassasin, à ce sujet plus tard. </font></font><br><br><pre> <code class="bash hljs">submission inet n - y - - smtpd -o syslog_name=postfix/submission -o smtpd_tls_security_level=encrypt -o smtpd_sasl_auth_enable=yes -o smtpd_client_restrictions=permit_sasl_authenticated,reject</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous vous permettons de vous connecter au serveur de messagerie via le port 587. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour ce faire, assurez-vous de vous connecter.</font></font><br><br><pre> <code class="bash hljs">policyd-spf unix - nn - 0 spawn user=policyd-spf argv=/usr/bin/policyd-spf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Activez la vérification SPF. </font></font><br><br><pre> <code class="bash hljs">apt-get install postfix-policyd-spf-python</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Installez le package pour les vérifications SPF ci-dessus. </font></font><br><br><pre> <code class="bash hljs">domain1 unix - - n - - smtp -o smtp_bind_address=XX.XX.XX.X1 -o smtp_helo_name=domain1.com -o inet_protocols=all -o smtp_bind_address6=XXXX:XXXX:XXXX:XXXX:1:1:1:1 -o syslog_name=postfix-domain1</code> </pre> <br><blockquote>    .          IPv4/IPv6 . <br><br>    rDNS. rDNS —   -   IP . <br>         ,  helo   rDNS  ,    email. <br><br>  helo    ,      —   . <br><br> Helo   rDNS —    . <br>        IP . <br>  OVH —      rDNS. <br>  tech.ru —    . <br>  AWS —    . <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Inet_protocols" et "smtp_bind_address6" - c'est ainsi que nous activons la prise en charge IPv6. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour IPv6, vous devez également enregistrer rDNS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Syslog_name" - et ceci pour la commodité de la lecture des journaux.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recommande d'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acheter des certificats </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">ici</font></a><font style="vertical-align: inherit;"> . </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise en place d'un tas de postfix + pigeonnier ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration SPF.</font></font></a> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Dovecot ============== </font></font></h2><br><pre> <code class="bash hljs">apt-get install dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql dovecot-antispam</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurez mysql, installez les packages eux-mêmes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/10-auth.conf"</font></font><br><br><pre> <code class="bash hljs">disable_plaintext_auth = yes auth_mechanisms = plain login</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'autorisation est uniquement cryptée. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/10-mail.conf"</font></font><br><br><pre> <code class="bash hljs">mail_location = maildir:/var/mail/vhosts/%d/%n</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici, nous indiquons l'emplacement des lettres. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je veux qu'ils soient stockés dans des fichiers et regroupés par domaine. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/10-master.conf"</font></font><br><br><pre> <code class="bash hljs">service imap-login { inet_listener imap { port = 0 } inet_listener imaps { address = XX.XX.XX.X1, XX.XX.XX.X2, XX.XX.XX.X5, [XXXX:XXXX:XXXX:XXXX:1:1:1:1], [XXXX:XXXX:XXXX:XXXX:1:2:1:1], [XXXX:XXXX:XXXX:XXXX:1:1:5:1] port = 993 ssl = yes } } service pop3-login { inet_listener pop3 { port = 0 } inet_listener pop3s { address = XX.XX.XX.X1, XX.XX.XX.X2, XX.XX.XX.X5, [XXXX:XXXX:XXXX:XXXX:1:1:1:1], [XXXX:XXXX:XXXX:XXXX:1:2:1:1], [XXXX:XXXX:XXXX:XXXX:1:1:5:1] port = 995 ssl = yes } } service lmtp { unix_listener /var/spool/postfix/private/dovecot-lmtp { mode = 0600 user = postfix group = postfix } } service imap { } service pop3 { } service auth { unix_listener auth-userdb { mode = 0600 user = vmail } unix_listener /var/spool/postfix/private/auth { mode = 0666 user = postfix group = postfix } user = dovecot } service auth-worker { user = vmail } service dict { unix_listener dict { } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit du fichier de paramètres principal de pigeonnier. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici, nous déconnectons les connexions non sécurisées. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et activez des connexions sécurisées. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/10-ssl.conf"</font></font><br><br><pre> <code class="bash hljs">ssl = required ssl_cert = &lt;/etc/nginx/ssl/domain1.com.2018.chained.crt ssl_key = &lt;/etc/nginx/ssl/domain1.com.2018.key <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> XX.XX.XX.X5 { ssl_cert = &lt;/etc/nginx/ssl/domain2.com.2018.chained.crt ssl_key = &lt;/etc/nginx/ssl/domain2.com.2018.key }</code> </pre> <br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurez ssl. </font><font style="vertical-align: inherit;">Nous indiquons que SSL est requis. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et le certificat lui-même. </font><font style="vertical-align: inherit;">Et un détail important est la directive «locale». </font><font style="vertical-align: inherit;">Indique lors de la connexion à quel IPv4 local - quel certificat SSL utiliser. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par ailleurs, IPv6 n'est pas configuré ici, je corrigerai cette omission en tant que thread plus tard. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XX.XX.XX.X5 (domaine2) - aucun certificat. </font><font style="vertical-align: inherit;">Pour connecter des clients, vous devez spécifier domain1.com. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XX.XX.XX.X2 (domaine3) - il existe un certificat, vous pouvez spécifier domaine1.com ou domaine3.com pour connecter les clients.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fichier "/etc/dovecot/conf.d/15-lda.conf" </font></font><br><br><pre> <code class="bash hljs">protocol lda { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> sieve }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela sera nécessaire à l'avenir pour spamassassin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/20-imap.conf"</font></font><br><br><pre> <code class="bash hljs">protocol imap { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> antispam }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit d'un plugin antispam. </font><font style="vertical-align: inherit;">Il est nécessaire pour la formation de spamassasin au moment du transfert vers / depuis le dossier Spam. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/20-pop3.conf"</font></font><br><br><pre> <code class="bash hljs">protocol pop3 { }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un tel fichier l'est. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/20-lmtp.conf"</font></font><br><br><pre> <code class="bash hljs">protocol lmtp { mail_plugins = <span class="hljs-variable"><span class="hljs-variable">$mail_plugins</span></span> sieve postmaster_address = admin@domain1.com }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurez lmtp. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/90-antispam.conf"</font></font><br><br><pre> <code class="bash hljs">plugin { antispam_backend = pipe antispam_trash = Trash;trash antispam_spam = Junk;Spam;SPAM antispam_pipe_program_spam_arg = --spam antispam_pipe_program_notspam_arg = --ham antispam_pipe_program = /usr/bin/sa-learn antispam_pipe_program_args = --username=%Lu }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paramètres d'entraînement Spamassasin au moment du transfert vers / depuis le dossier Spam. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/90-sieve.conf"</font></font><br><br><pre> <code class="bash hljs">plugin { sieve = ~/.dovecot.sieve sieve_dir = ~/sieve sieve_after = /var/lib/dovecot/sieve/default.sieve }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un fichier qui indique quoi faire avec les e-mails entrants. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/var/lib/dovecot/sieve/default.sieve"</font></font><br><br><pre> <code class="bash hljs">require [<span class="hljs-string"><span class="hljs-string">"fileinto"</span></span>, <span class="hljs-string"><span class="hljs-string">"mailbox"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> header :contains <span class="hljs-string"><span class="hljs-string">"X-Spam-Flag"</span></span> <span class="hljs-string"><span class="hljs-string">"YES"</span></span> { fileinto :create <span class="hljs-string"><span class="hljs-string">"Spam"</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est nécessaire de compiler le fichier: "sievec default.sieve". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/conf.d/auth-sql.conf.ext"</font></font><br><br><pre> <code class="bash hljs">passdb { driver = sql args = /etc/dovecot/dovecot-sql.conf.ext } userdb { driver = static args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spécification des fichiers SQL pour l'autorisation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et le fichier lui-même est un moyen d'autorisation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/dovecot-sql.conf.ext"</font></font><br><br><pre> <code class="bash hljs">driver = mysql connect = host=127.0.0.1 dbname=servermail user=usermail password=password default_pass_scheme = SHA512-CRYPT password_query = SELECT email as user, password FROM virtual_users WHERE email=<span class="hljs-string"><span class="hljs-string">'%u'</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela correspond aux mêmes paramètres pour postfix. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/dovecot/dovecot.conf"</font></font><br><pre> <code class="bash hljs">protocols = imap lmtp pop3 listen = *, :: dict { } !include conf.d/*.conf !include_try local.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le fichier de configuration principal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La chose importante est que nous spécifions ici, ajoutons des protocoles.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== SpamAssassin ============== </font></font></h2><br><pre> <code class="bash hljs">apt-get install spamassassin spamc</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Installez les packages. </font></font><br><br><pre> <code class="bash hljs">adduser spamd --disabled-login</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ajoutez un utilisateur au nom duquel. </font></font><br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> spamassassin.service</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Activez le service de téléchargement automatique de spamassassin au démarrage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/ etc / default / spamassassin":</font></font><br><br><pre> <code class="bash hljs">CRON=1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Activez la mise à jour automatique des règles par défaut. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier "/etc/spamassassin/local.cf":</font></font><br><br><pre> <code class="bash hljs">report_safe 0 use_bayes 1 bayes_auto_learn 1 bayes_auto_expire 1 bayes_store_module Mail::SpamAssassin::BayesStore::MySQL bayes_sql_dsn DBI:mysql:sa:localhost:3306 bayes_sql_username sa bayes_sql_password password</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est nécessaire de faire de la base de données «sa» dans mysql avec l'utilisateur «sa» avec le mot de passe «mot de passe» (remplacer par quelque chose d'adéquat). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report_safe - au lieu d'une lettre, un rapport sur le spam sera envoyé. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use_bayes sont des paramètres de machine learning spamassassin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les paramètres de spamassassin restants ont été appliqués plus haut dans l'article. </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le paramètre général est spamassassin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À propos du déplacement de nouveaux e-mails de spam dans le dossier de spam IMAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À propos d'un simple groupe de Dovecot + SpamAssassin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je recommande de lire la théorie de l'apprentissage du spamassasin lors du déplacement de lettres dans des dossiers imap (et je ne le recommande pas pour une utilisation)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Contacter la communauté ============== </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je voudrais également lancer une idée dans la communauté sur la façon d'augmenter le niveau de sécurité des lettres transférées. </font><font style="vertical-align: inherit;">Depuis que je suis tellement plongé dans le sujet du courrier. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afin que l'utilisateur puisse créer une paire de clés sur son client (Outlook, Thunderbird, plugin de navigateur, ...). </font><font style="vertical-align: inherit;">Public et privé. </font><font style="vertical-align: inherit;">Public - envoyer au DNS. </font><font style="vertical-align: inherit;">Privé - enregistrer pour le client. </font><font style="vertical-align: inherit;">Les serveurs de messagerie pourraient utiliser la clé publique pour envoyer à un destinataire spécifique. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et pour vous protéger contre le spam avec de tels e-mails (oui, le serveur de messagerie ne pourra pas voir le contenu) - vous devrez entrer 3 règles:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Signature DKIM réelle obligatoire, SPF obligatoire, rDNS obligatoire. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un réseau de neurones sur le thème de la formation antispam + DB sur celui-ci côté client. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L'algorithme de chiffrement doit être tel que le côté émetteur doit dépenser 100 fois plus de puissance CPU sur le chiffrement que le côté récepteur. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En plus des lettres publiques - pour développer une lettre d'invitation standard "pour commencer la correspondance sécurisée." </font><font style="vertical-align: inherit;">L'un des utilisateurs (boîte aux lettres) envoie une lettre à l'autre boîte aux lettres avec une pièce jointe. </font><font style="vertical-align: inherit;">Dans la lettre, la proposition de texte pour démarrer un canal de communication sécurisé pour la correspondance et la clé publique du propriétaire de la boîte aux lettres (avec la clé privée côté client).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez même créer une paire de clés spécifiquement pour chaque correspondance. L'utilisateur destinataire peut accepter cette offre et envoyer sa clé publique (également faite spécialement pour cette correspondance). Ensuite, le premier utilisateur envoie une lettre de contrôle de service (cryptée avec la clé publique du deuxième utilisateur) - à la réception de laquelle le deuxième utilisateur peut considérer le canal de communication formé comme fiable. Ensuite, le deuxième utilisateur envoie une lettre de contrôle - puis le premier utilisateur peut également considérer le canal formé comme protégé. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour lutter contre l'interception de clés sur la route - il est nécessaire dans le protocole de prévoir la possibilité de transmettre au moins une clé publique à l'aide d'une clé USB. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et surtout, que tout fonctionne (la question est «qui va payer pour ça?»):</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduisez des certificats de messagerie d'une valeur de 10 $ pour 3 ans. </font><font style="vertical-align: inherit;">Ce qui permettra à l'expéditeur d'indiquer en DNS que "mes clés publiques sont là". </font><font style="vertical-align: inherit;">Et ils donneront l'occasion de démarrer une connexion sécurisée. </font><font style="vertical-align: inherit;">En même temps, prenez ces composés gratuitement. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gmail monétise enfin ses utilisateurs. </font><font style="vertical-align: inherit;">Pour 10 $ en 3 ans - le droit de créer des canaux de correspondance sécurisés.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ============== Conclusion ============== </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour tester l'intégralité de l'article, j'allais louer un serveur dédié pendant un mois et acheter un domaine avec un certificat SSL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais les circonstances de la vie se sont développées, ce problème a donc traîné pendant 2 mois. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et lorsque le temps libre est à nouveau apparu - j'ai décidé de publier l'article tel quel, sans risquer que la publication soit retardée d'un an. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il y a beaucoup de questions comme «mais cela n'est pas décrit suffisamment en détail» - alors il y aura probablement des forces pour prendre un serveur dédié avec un nouveau domaine et un nouveau certificat SSL et décrire plus en détail et surtout - identifier tous les détails importants manquants. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'aimerais également recevoir des commentaires sur le sujet des idées sur les certificats de courrier. Si vous aimez l'idée, je vais essayer de trouver la force d'écrire un brouillon pour rfc.</font></font><br><br> <b>     —     . <br>       —     . <br>           .</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413689/">https://habr.com/ru/post/fr413689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413675/index.html">Joker 2018: Club des développeurs Java anonymes</a></li>
<li><a href="../fr413677/index.html">Lancement de ROS sur le robot auto-équilibrant EduMIP</a></li>
<li><a href="../fr413679/index.html">Angulaire 6. PWA. Modules de chargement paresseux. Déploiement automatique dans Firebase</a></li>
<li><a href="../fr413681/index.html">La technique de développement de serveurs hautement fiables sur Go</a></li>
<li><a href="../fr413683/index.html">ILV a débloqué 7 millions d'adresses IP. Rester verrouillé 4 millions</a></li>
<li><a href="../fr413691/index.html">Commencer</a></li>
<li><a href="../fr413693/index.html">Fait à la main: clavier programmable pour le commerce en ligne à faire soi-même</a></li>
<li><a href="../fr413695/index.html">Sécurité de Messenger: pourquoi le stockage de messages sur la blockchain pourrait être une bonne idée</a></li>
<li><a href="../fr413697/index.html">Comment ne pas écrire de code</a></li>
<li><a href="../fr413699/index.html">"Qui remue l'eau - 2": ou tout ce que vous vouliez savoir sur l'osmose inverse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>