<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤šğŸ¾ ğŸ‡ğŸ½ ğŸ” æ–°çš„Postgres_exporter PostgreSQLç›‘è§†åŠŸèƒ½ ğŸ§‘ğŸ¿â€ğŸ¤â€ğŸ§‘ğŸ¾ ğŸŒ§ï¸ â–¶ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸‹åˆå¥½ï¼Œå“ˆä¼¯è¯»è€…ï¼ 


åœ¨æœ‰å…³posgres_exporterçš„ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ ï¼Œæˆ‘è€ƒè™‘äº†å½“æ—¶ä½¿ç”¨æ–°çš„fitchaæ—¶çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå³ç”±ä¸€ä¸ªå¯¼å‡ºå™¨ç›‘è§†ä¸€ç»„å®ä¾‹å’Œ/æˆ–æ•°æ®åº“çš„èƒ½åŠ›ã€‚ ä»–æè¿°äº†ä»–é‡åˆ°çš„é—®é¢˜çš„â€œæŸç¼šâ€ï¼Œä»¥åŠä»–ä½¿å®ƒèµ·ä½œç”¨çš„è§£å†³æ–¹æ³•ã€‚ 
 å› æ­¤ï¼Œåœ¨11æœˆ25æ—¥ï¼Œå‘å¸ƒäº†ä¸‹ä¸€ä¸ªpostgres_e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æ–°çš„Postgres_exporter PostgreSQLç›‘è§†åŠŸèƒ½</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480902/"><p> ä¸‹åˆå¥½ï¼Œå“ˆä¼¯è¯»è€…ï¼ </p><br><p>åœ¨<a href="https://habr.com/ru/post/468573/">æœ‰å…³posgres_exporter</a>çš„ç¬¬ä¸€<a href="https://habr.com/ru/post/468573/">ç¯‡æ–‡ç« ä¸­</a> ï¼Œæˆ‘è€ƒè™‘äº†å½“æ—¶ä½¿ç”¨æ–°çš„fitchaæ—¶çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå³ç”±ä¸€ä¸ªå¯¼å‡ºå™¨ç›‘è§†ä¸€ç»„å®ä¾‹å’Œ/æˆ–æ•°æ®åº“çš„èƒ½åŠ›ã€‚ ä»–æè¿°äº†ä»–é‡åˆ°çš„é—®é¢˜çš„â€œæŸç¼šâ€ï¼Œä»¥åŠä»–ä½¿å®ƒèµ·ä½œç”¨çš„è§£å†³æ–¹æ³•ã€‚ <br> å› æ­¤ï¼Œåœ¨11æœˆ25æ—¥ï¼Œå‘å¸ƒäº†ä¸‹ä¸€ä¸ªpostgres_exporter 0.8.0ç‰ˆæœ¬ã€‚ å®ƒè§£å†³äº†ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æè¿°çš„é—®é¢˜ï¼Œå¹¶ä¸”ç‰¹åˆ«å¥½ï¼Œå®ƒæ·»åŠ äº†æ–°åŠŸèƒ½ã€‚ </p><br><p> æˆ‘è¦ä¸€åªçŒ«... </p><a name="habracut"></a><br><p> é¦–å…ˆï¼Œæˆ‘æƒ³å‘æ‚¨è¯¦ç»†ä»‹ç»postgre_exporterå¹¶ç¼–å†™ä¸€ç§ç®€çŸ­çš„å¿«é€Ÿå…¥é—¨æŒ‡å—ã€‚ è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹è¦ç‚¹ï¼š </p><br><ol><li> ç¯å¢ƒå˜é‡å’Œå¯åŠ¨å‚æ•° </li><li> ä»€ä¹ˆæ˜¯é»˜è®¤æŒ‡æ ‡ï¼Ÿ </li><li> å¦‚ä½•æ·»åŠ è‡ªå·±çš„æŒ‡æ ‡ </li></ol><br><h2 id="opisanie"> å†…å®¹æè¿° </h2><br><p>  <a href="https://github.com/wrouesnel/postgres_exporter" rel="nofollow">postgres_exporter-</a>ä½¿ç”¨Goè¯­è¨€ç¼–å†™çš„å®ç”¨å·¥å…·ï¼Œç”¨äºä»¥PostgreSQLçš„å¯è®¿é—®Prometheusæ ¼å¼æ”¶é›†PostgreSQL DBMSé›†ç¾¤å®ä¾‹çš„åº¦é‡ï¼Œå®ƒæ˜¯å¼€æºçš„ï¼Œå¹¶ä¸”å…è´¹åˆ†å‘ã€‚ </p><br><h2 id="peremennye-okruzheniya-i-argumenty-komandnoy-stroki"> ç¯å¢ƒå˜é‡å’Œå‘½ä»¤è¡Œå‚æ•° </h2><br><p> åŒæ ·ï¼ŒPostgres_exporteræ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œæ‰€æœ‰å‚æ•°éƒ½é€šè¿‡ç¯å¢ƒå˜é‡æˆ–å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™å¯¼å‡ºå™¨ã€‚ åŒæ—¶ï¼Œåªèƒ½é€šè¿‡ç¯å¢ƒå˜é‡æ¥ä¼ é€ç”¨äºè¿æ¥åˆ°DBMSçš„å‚æ•°ã€‚ </p><br><h3 id="peremennye-okruzheniya"> ç¯å¢ƒå˜é‡ </h3><br><p> å¦‚ä¸Šæ‰€è¿°ï¼Œç¯å¢ƒå˜é‡å¯ä»¥åˆ†ä¸ºä¸¤ç»„ã€‚ å‰è€…ä¼ é€’è¿æ¥å­—ç¬¦ä¸²ï¼Œåè€…ä¼ é€’å‘½ä»¤è¡Œå‚æ•°ã€‚ </p><br><p>è®©æˆ‘ä»¬ä»ç¬¬ä¸€ç»„å¼€å§‹ã€‚ è¿™äº›å˜é‡ä»¥å‰ç¼€<code>DATA_SOURCE_</code> ï¼š </p><br><ul><li><p>  DATA_SOURCE_NAME-é»˜è®¤ä½¿ç”¨ã€‚ å…è®¸æ‚¨ä»¥<code>=</code>æ ¼å¼è®°å½•è¿æ¥å­—ç¬¦ä¸²ï¼Œå¹¶ä»¥URIçš„å½¢å¼è®°å½•ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«è¿æ¥çš„ç™»å½•åå’Œå¯†ç ã€‚ <br> ç”¨äºè¿æ¥åˆ°PostgreSQLçš„æœ‰æ•ˆä½œä¸šé€‰é¡¹ï¼š </p><br><ul><li>  <code>postgresql://rolename@dbhost:dbport/datname?sslmode=disable</code> ; </li><li>  <code>postgresql://rolename:rolpass@dbhost:dbport?sslmode=disable&amp;db=datname</code> ; </li><li>  <code>postgresql://rolename:rolpass@?sslmode=disable&amp;dbname=database&amp;host=dbhost&amp;port=dbport</code> ; </li><li>  <code>postgresql://rolename:rolpass@?sslmode=disable&amp;dbname=database&amp;host=/tmp</code> ï¼ˆé€šè¿‡UNIXå¥—æ¥å­—çš„è¿æ¥ï¼Œå–è‡ªPostgreSQLå®ä¾‹çš„unix_socket_directoriesï¼‰ï¼› </li><li>  <code>host=dbhost port=dbport dbname=database user=rolename sslmode=disable</code> ; </li></ul><br><p> å¦‚æœéœ€è¦è¿æ¥åˆ°å¤šä¸ªå®ä¾‹ï¼ˆä¸å…è®¸åœ¨å°æ•°ç‚¹åä½¿ç”¨ç©ºæ ¼ï¼‰ï¼š </p><br><ul><li>  <code>postgresql://rolename@dbhost:dbport/datname?sslmode=disable,postgresql://rolename@dbhost:dbport/datname?sslmode=disable</code> ; </li><li>  <code>sslmode=disable dbname=postgres host=127.0.0.1 port=5434 user=postgres,sslmode=disable dbname=postgres port=5432 user=postgres</code> ã€‚ </li></ul><br></li><li>  DATA_SOURCE_URI-æ›¿ä»£DATA_SOURCE_NAMEã€‚ ä»…å½“æ‚¨æ‰“ç®—è¿æ¥åˆ°å•ä¸ªPostgreSQLå®ä¾‹æ—¶ï¼Œæ­¤é€‰é¡¹æ‰é€‚ç”¨ã€‚ <br> å˜é‡DATA_SOURCE_URIä»¥â€œ dbhostï¼šdbport / dbnameï¼ŸKey = valueâ€çš„å½¢å¼è®¾ç½®ä¸å¸¦ç”¨æˆ·åå’Œå¯†ç çš„URIéƒ¨åˆ†ã€‚ ç”¨æˆ·åå’Œå¯†ç å–è‡ªDATA_SOURCE_USERå’ŒDATA_SOURCE_PASSç¯å¢ƒå˜é‡ï¼Œæˆ–è€…å–è‡ªDATA_SOURCE_USER_FILE DATA_SOURCE_PASS_FILEæ–‡ä»¶ã€‚ <br> å½“ç”¨æˆ·åå’Œå¯†ç å­˜å‚¨åœ¨æ–‡ä»¶ä¸­æ—¶ï¼Œå…¶å†…å®¹å°†è¢«æå–å¹¶é‡æ–°åˆ†é…ç»™å˜é‡DATA_SOURCE_USERå’ŒDATA_SOURCE_PASSã€‚ æ­¤å¤–ï¼Œåœ¨ä»£ç ä¸­ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ”¶é›†åœ¨ä»¥ä¸‹å½¢å¼çš„å®Œæ•´URIä¸­ï¼š <code>"postgresql://" + DATA_SOURCE_USER + ":" + DATA_SOURCE_PASS + "@" + DATA_SOURCE_URI</code> </li><li>  DATA_SOURCE_URI_FILE-ä¸DATA_SOURCE_URIç›¸åŒï¼Œä»…ä»æ–‡ä»¶è¯»å–ï¼› </li><li>  DATA_SOURCE_USER-ä½¿ç”¨DATA_SOURCE_URIæ—¶ï¼Œè®¾ç½®ç”¨äºè¿æ¥åˆ°DBMSçš„ç”¨æˆ·åï¼› </li><li>  DATA_SOURCE_USER_FILE-ä¸DATA_SOURCE_USERç›¸åŒï¼Œä»…ä»æ–‡ä»¶è¯»å–ï¼› </li><li>  DATA_SOURCE_PASS-ä½¿ç”¨DATA_SOURCE_URIæ—¶ï¼Œè®¾ç½®ç”¨äºè¿æ¥åˆ°DBMSçš„ç”¨æˆ·å¯†ç ï¼› </li><li>  DATA_SOURCE_PASS_FILE-ä¸DATA_SOURCE_PASSç›¸åŒï¼Œä»…ä»æ–‡ä»¶;ä¸­è¯»å–ã€‚ </li></ul><br><p> ç¬¬äºŒç»„åŒ…æ‹¬å¯å˜é‡å¤å‚æ•°ã€‚ å³ åœ¨å¯åŠ¨æ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼è®¾ç½®åº”ç”¨ç¨‹åºçš„æ“ä½œå‚æ•°ï¼Œæˆ–è€…åœ¨å¯åŠ¨æ—¶ä½œä¸ºå‚æ•°ä¼ é€’ã€‚ ä»¥å‰ç¼€<code>PG_EXPORTER_</code> ï¼š </p><br><ul><li>  PG_EXPORTER_WEB_LISTEN_ADDRESS-è®¾ç½®å¯¼å‡ºå™¨å°†æ¥æ”¶æ¥è‡ªPrometheusçš„è¯·æ±‚çš„åœ°å€å’Œç«¯å£ã€‚ é»˜è®¤å€¼<code>:9187</code> ; </li><li>  PG_EXPORTER_WEB_TELEMETRY_PATH-ç»™å‡ºåº¦é‡çš„è·¯å¾„ã€‚ é»˜è®¤<code>/metrics</code> ; </li><li>  PG_EXPORTER_DISABLE_DEFAULT_METRICS-é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨æŒ‡æ ‡æ”¶é›†ã€‚ è¿™äº›æŒ‡æ ‡å°†åœ¨ä¸‹é¢çš„äº‹å®ã€‚ ä»…trueæˆ–falseæ¥å—å€¼ã€‚ é»˜è®¤æƒ…å†µä¸‹ä¸ºFalseï¼ˆå…è®¸æŒ‡æ ‡æ”¶é›†ï¼‰ï¼› </li><li>  PG_EXPORTER_DISABLE_SETTINGS_METRICS-ç¦ç”¨ä»pg_settingsè§†å›¾æ”¶é›†æŒ‡æ ‡çš„åŠŸèƒ½ã€‚ è¿™äº›æŒ‡æ ‡å°†åœ¨ä¸‹é¢çš„äº‹å®ã€‚ ä»…trueæˆ–falseæ¥å—å€¼ã€‚ é»˜è®¤æƒ…å†µä¸‹ä¸ºFalseï¼ˆå…è®¸æŒ‡æ ‡æ”¶é›†ï¼‰ï¼› </li><li>  PG_EXPORTER_AUTO_DISCOVER_DATABASES-æ£€æµ‹é›†ç¾¤å®ä¾‹çš„æ‰€æœ‰æ•°æ®åº“ä»¥æ”¶é›†å…¶æŒ‡æ ‡ã€‚ ä»…trueæˆ–falseæ¥å—å€¼ã€‚ é»˜è®¤æƒ…å†µä¸‹ä¸ºfalseï¼ˆä»…åœ¨è¿æ¥å‚æ•°ä¸­æŒ‡å®šçš„æ•°æ®åº“ä¸­æ”¶é›†æŒ‡æ ‡ï¼‰ï¼›å¦åˆ™ä¸ºfalseã€‚ </li><li>  PG_EXPORTER_EXCLUDE_DATABASES-å¦‚æœ<code>PG_EXPORTER_AUTO_DISCOVER_DATABASES=true</code>è¦æ”¶é›†å…¶æŒ‡æ ‡çš„æ•°æ®åº“åˆ—è¡¨ä¸­æ’é™¤è¯¥æ•°æ®åº“ã€‚ è¡¨ç¤ºä»¥é€—å·åˆ†éš”çš„æ•°æ®åº“åç§°åˆ—è¡¨ã€‚ é»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²ã€‚  <strong>é‡è¦æç¤º</strong> ï¼š <br><ul><li> æ¨¡æ¿template0å’Œtemplate1-æ— éœ€æ’é™¤ï¼Œå› æ­¤åœ¨ä»pg_databasesè·å–æ•°æ®åº“åˆ—è¡¨çš„é˜¶æ®µå°†å…¶åˆ‡æ–­ï¼› </li><li> ä¸èƒ½æ’é™¤URIä¸­æŒ‡å®šçš„æ•°æ®åº“ã€‚ </li></ul></li><li>  PG_EXPORTER_EXTEND_QUERY_PATH-åŒ…å«ç”¨æˆ·æŸ¥è¯¢çš„YAMLæ–‡ä»¶çš„è·¯å¾„ã€‚  query.yamlæ–‡ä»¶åŒ…å«ç¤ºä¾‹ã€‚ </li><li>  PG_EXPORTER_CONSTANT_LABELS-æ ‡ç­¾ï¼ˆå¸¸é‡ï¼‰å·²æ·»åŠ åˆ°æ‰€æœ‰æŒ‡æ ‡ã€‚ å®ƒè¢«å†™ä¸ºä¸€ä¸ª<code>=</code>å¯¹<code>=</code>å¯¹çš„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚ </li></ul><br><h3 id="argumenty-komandnoy-stroki"> å‘½ä»¤è¡Œå‚æ•° </h3><br><ul><li>  web.listen-addressä¸PG_EXPORTER_WEB_LISTEN_ADDRESSç›¸åŒï¼› </li><li>  web.telemetry-path-ä¸PG_EXPORTER_WEB_TELEMETRY_PATHç›¸åŒï¼› </li><li>  disable-default-metricsä¸PG_EXPORTER_DISABLE_DEFAULT_METRICSç›¸åŒï¼› </li><li>  disable-settings-metricsä¸PG_EXPORTER_DISABLE_SETTINGS_METRICSç›¸åŒï¼› </li><li> è‡ªåŠ¨å‘ç°æ•°æ®åº“ä¸PG_EXPORTER_AUTO_DISCOVER_DATABASESç›¸åŒï¼› </li><li>  exclude-databasesä¸PG_EXPORTER_EXCLUDE_DATABASESç›¸åŒï¼› </li><li>  extend.query-path-ä¸PG_EXPORTER_EXTEND_QUERY_PATHç›¸åŒï¼› </li><li>  constantLabels-ä¸PG_EXPORTER_CONSTANT_LABELSç›¸åŒï¼› </li><li>  dumpmaps-æ˜¾ç¤ºæŒ‡æ ‡å›¾çš„å†…éƒ¨å†…å®¹ã€‚ ç”¨äºè°ƒè¯•ç”¨æˆ·è¯·æ±‚ã€‚ ä¸å¯åŠ¨åº”ç”¨ç¨‹åºï¼› </li><li>  log.level-è®¾ç½®å¯èƒ½çš„æ—¥å¿—è®°å½•çº§åˆ«ä¹‹ä¸€ï¼š <code>debug</code> ï¼Œ <code>info</code> ï¼Œ <code>warn</code> ï¼Œ <code>error</code> ï¼Œ <code>fatal</code> ï¼› </li><li>  log.format-è®¾ç½®æ—¥å¿—è¾“å‡ºçš„æ–¹æ³•å’Œæ ¼å¼ã€‚ ä¾‹å¦‚ï¼š <code>logger:syslog?appname=bob&amp;local=7</code>æˆ–<code>logger:stdout?json=true</code> ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>logger:stderr</code> ã€‚ </li></ul><br><h2 id="metriki-po-umolchaniyu"> é»˜è®¤æŒ‡æ ‡ </h2><br><p>  <code> -</code>åº¦é‡æ ‡å‡†æ˜¯ä¸€ç»„ç›‘è§†åº¦é‡æ ‡å‡†ï¼Œå®ƒä»¬çš„é›†åˆç›´æ¥åœ¨ä»£ç ä¸­åˆ—å‡ºã€‚ å¯ä»¥é€šè¿‡æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°--disable-default-metricså’Œ/æˆ–--disable-settings-metricsæˆ–å®šä¹‰é€‚å½“çš„ç¯å¢ƒå˜é‡æ¥ç¦ç”¨<code> -</code>çš„æ”¶é›†ã€‚ <br> æˆ‘æ³¨æ„åˆ°ï¼Œåœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œå¯ç”¨è‡ªåŠ¨å‘ç°åè§£å†³äº†ä½¿ç”¨æŒ‡æ ‡çš„é—®é¢˜ï¼Œè¿™æ˜¯å› ä¸ºæŒ‡æ ‡é‡å¤ï¼Œä»è€Œå¯¼è‡´é”™è¯¯ã€‚ </p><br><p> é»˜è®¤æƒ…å†µä¸‹ï¼Œä»¥ä¸‹è§†å›¾ä¸­çš„æŒ‡æ ‡å°†å‘é€åˆ°ç›‘è§†ï¼š </p><br><ul><li>  pg_stat_bgwriter; </li><li>  pg_stat_database; </li><li>  pg_stat_database_conflicts; </li><li>  pg_locks; </li><li>  pg_stat_replication; </li><li>  pg_stat_activity; </li><li>  pg_settingsã€‚ </li></ul><br><p> æ‚¨åº”æ³¨æ„çš„æ˜¯pg_stat_replicationå’Œpg_stat_activityï¼Œå› ä¸ºè¿”å›çš„å­—æ®µé›†å–å†³äºPostgreSQLçš„ç‰ˆæœ¬ã€‚ ä¸ºæ­¤ï¼Œåœ¨å¯¼å‡ºå™¨ä¸­æ£€æŸ¥DBMSç‰ˆæœ¬ï¼Œå¹¶é€‰æ‹©ç›¸åº”çš„è¯·æ±‚ã€‚ æ‚¨ä¸èƒ½åœ¨ç”¨æˆ·æŸ¥è¯¢ä¸­æŒ‡å®šç‰ˆæœ¬ã€‚ å‡å®šç®¡ç†å‘˜äº‹å…ˆçŸ¥é“å°†ç›‘è§†å®ä¾‹çš„ç‰ˆæœ¬ã€‚ å¦‚æœæ‚¨å°è¯•ç”±ä¸€ä¸ªå¯¼å‡ºè€…ä»ä¸åŒç‰ˆæœ¬çš„å®ä¾‹ä¸­æ”¶é›†æŒ‡æ ‡ï¼Œä¹Ÿä¼šå‡ºç°é—®é¢˜ã€‚ <br> ä½¿ç”¨å®ä¾‹è®¾ç½®æŒ‡æ ‡ï¼ˆpg_settingsï¼‰ï¼Œä¸€åˆ‡éƒ½å˜å¾—æ›´åŠ ç®€å•ï¼Œå®ƒä»¬ç”±è¯·æ±‚ç»„æˆï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, setting, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(unit, <span class="hljs-string"><span class="hljs-string">''</span></span>), short_desc, vartype <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_settings <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> vartype <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'bool'</span></span>, <span class="hljs-string"><span class="hljs-string">'integer'</span></span>, <span class="hljs-string"><span class="hljs-string">'real'</span></span>);</code> </pre> <br><p> å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä»…ç”±æ•°å€¼å½¢æˆä¸€ç»„åº¦é‡ã€‚ </p><br><p> æ­¤å¤–ï¼Œæˆ‘ä»¬å°†è€ƒè™‘å‡ºå£å•†çš„ç»“è®ºï¼ŒåŒ…æ‹¬æˆ‘ä»¬å°†å¦‚ä½•ç†è§£ä¸ºä½•ç¡¬ç¼–ç æŒ‡æ ‡å…·æœ‰å…¶å­˜åœ¨æƒã€‚ ä¾‹å¦‚ï¼Œé‡‡ç”¨ä¸¤ä¸ªæŒ‡æ ‡ï¼šshared_bufferså’Œwal_sender_timeoutã€‚ åœ¨å¯¼å‡ºå™¨çš„è¾“å‡ºä¸­ï¼Œå¯¹äºæ¯ä¸ªæŒ‡æ ‡ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸‰è¡Œã€‚ <br> ç¬¬ä¸€è¡Œ-è¡¨ç¤ºæç¤ºï¼Œç”±postgres_exporterä¸­çš„åº¦é‡åç§°ï¼Œæè¿°ï¼ˆpg_settingsè§†å›¾çš„short_descåˆ—ï¼‰ç»„æˆï¼Œå¦‚æœç±»å‹å·²è½¬æ¢ä¸ºåŸºæœ¬ç±»å‹ï¼Œåˆ™æŒ‡ç¤ºå“ªä¸€ä¸ªï¼ˆæ–¹æ‹¬å·ä¸­çš„å€¼ï¼‰ã€‚ <br> ç¬¬äºŒè¡Œç”¨æ™®ç½—ç±³ä¿®æ–¯è¡¨ç¤ºå€¼çš„ç±»å‹ã€‚ ç¬¬ä¸‰è¡Œæ˜¯å¸¦æœ‰ä¸€ç»„æ ‡ç­¾å’Œä¸€ä¸ªæŒ‡å®šå€¼çš„æŒ‡æ ‡ã€‚ </p><br><p> è¿”å›shared_buffersçš„å€¼ã€‚ </p><br><pre> <code class="plaintext hljs"># HELP pg_settings_shared_buffers_bytes Sets the number of shared memory buffers used by the server. [Units converted to bytes.] # TYPE pg_settings_shared_buffers_bytes gauge pg_settings_shared_buffers_bytes{server="127.0.0.1:5432"} 1.34217728e+08</code> </pre> <br><p>  <code>pg_settings_shared_buffers_bytes</code>æŒ‡æ ‡åç§°ã€‚ æ ¹æ®è‰¯å¥½æ ¼å¼çš„è§„åˆ™ï¼Œå®ƒç”±è¡¨çš„åç§°ï¼Œåº¦é‡çš„åç§°å’Œåº¦é‡å•ä½ç»„æˆã€‚ æ¥ä¸‹æ¥æ˜¯pg_settingsè¡¨çš„ç®€çŸ­æè¿°ã€‚ æœ€åï¼ŒæŒ‡ç¤ºåº¦é‡æ ‡å‡†å€¼å·²è½¬æ¢ä¸ºå­—èŠ‚å•ä½ï¼ˆå•ä½è½¬æ¢ä¸ºå­—èŠ‚ï¼‰ã€‚ ä¸ºä»€ä¹ˆå€¼å¾—å…³æ³¨åè€…ï¼Œå› ä¸ºç›´æ¥åœ¨æ•°æ®åº“ä¸­å€¼çœ‹èµ·æ¥æœ‰äº›ä¸åŒï¼Œå³ï¼š </p><br><pre> <code class="sql hljs"> name | setting | unit | short_desc <span class="hljs-comment"><span class="hljs-comment">----------------+---------+------+-------------------------------------------------------------- shared_buffers | 16384 | 8kB | Sets the number of shared memory buffers used by the server.</span></span></code> </pre> <br><p> æˆ‘ä»¬æ‹¥æœ‰çš„é‡åº¦ç±»å‹æ˜¯GAUGEï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥éšæ—¶é—´å–ä»»æ„å€¼ã€‚ åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œå¾®è°ƒæ—¶ï¼Œç¼“å†²åŒºçš„æ•°é‡å¯ä»¥åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šæ”¹å˜ã€‚ <br> æ‚¨å¯ä»¥åœ¨Prometheusæ–‡æ¡£ä¸­äº†è§£æœ‰å…³æŒ‡æ ‡ç±»å‹åŠå…¶å·®å¼‚çš„æ›´å¤šä¿¡æ¯ã€‚ </p><br><p> ä»¥ä¸‹æŒ‡æ ‡æ˜¯wal_sender_timeoutã€‚ æ ¹æ®ä¸ä¸Šè¿°ç›¸åŒçš„åŸç†æ”¶é›†ä¿¡æ¯å­—æ®µã€‚ ä»…åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº¦é‡æ ‡å‡†å€¼æ‰è½¬æ¢ä¸ºç§’ï¼Œå¹¶ä¸”æ•°æ®åº“ä»¥æ¯«ç§’ä¸ºå•ä½å­˜å‚¨ã€‚ ä½¿ç”¨æ­¤åŠŸèƒ½æ—¶ï¼Œåœ¨ç»˜åˆ¶å›¾è¡¨æ—¶éœ€è¦æ ¼å¤–å°å¿ƒã€‚ </p><br><pre> <code class="plaintext hljs"># HELP pg_settings_wal_sender_timeout_seconds Sets the maximum time to wait for WAL replication. [Units converted to seconds.] # TYPE pg_settings_wal_sender_timeout_seconds gauge pg_settings_wal_sender_timeout_seconds{server="127.0.0.1:5432"} 60</code> </pre> <br><p> å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å€¼ï¼š </p><br><pre> <code class="sql hljs">demo=<span class="hljs-comment"><span class="hljs-comment"># SELECT name, setting, COALESCE(unit, ''), short_desc, vartype FROM pg_settings WHERE name='wal_sender_timeout'; name | setting | coalesce | short_desc | vartype --------------------+---------+----------+----------------------------------------------------+--------- wal_sender_timeout | 60000 | ms | Sets the maximum time to wait for WAL replication. | integer</span></span></code> </pre><br><p> æ‰€æœ‰å…·æœ‰å•ä½çš„å€¼éƒ½å‡å°‘ä¸ºä¸¤ç§ç±»å‹ï¼šé‡åº¦å•ä½ä¸ºå­—èŠ‚ï¼› æ—¶é—´æŒ‡æ ‡ä»¥ç§’ä¸ºå•ä½ã€‚ </p><br><h3 id="polzovatelskiy-nabor-metrik"> è‡ªå®šä¹‰æŒ‡æ ‡é›† </h3><br><p> é™¤äº†é»˜è®¤æŒ‡æ ‡ä»¥å¤–ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨è‡ªå·±çš„æŒ‡æ ‡ã€‚ ä¸ºæ­¤ï¼Œåªéœ€é€šè¿‡å‚æ•°--extend.query-path = query.yamlæˆ–é€šè¿‡ç¯å¢ƒå˜é‡PG_EXPORTER_EXTEND_QUERY_PATHè®¾ç½®å¸¦æœ‰ç”¨æˆ·æŸ¥è¯¢çš„æ–‡ä»¶è·¯å¾„ã€‚ <br> é¡¹ç›®å­˜å‚¨åº“å…·æœ‰ä¸€ä¸ªå¸¦æœ‰ç¤ºä¾‹çš„YAMLæ–‡ä»¶ï¼š <a href="" rel="nofollow">querys.yaml</a> </p><br><p> æˆ‘æ³¨æ„åˆ°ï¼Œä¸ä»¥å‰çš„ç‰ˆæœ¬ç›¸æ¯”ï¼Œåœ¨0.8.0ä¸­æ·»åŠ äº†æ–°çš„å¯†é’¥masterå’Œcache_secondsã€‚ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†è®°å½•æ ¼å¼å’Œå­—æ®µçš„ç”¨é€”ã€‚ </p><br><p>  query.yamlæ–‡ä»¶çš„æ ·æœ¬å†…å®¹ </p><br><pre> <code class="plaintext hljs">pg_database: query: "SELECT pg_database.datname, pg_database_size(pg_database.datname) as size_bytes FROM pg_database" master: true cache_seconds: 30 metrics: - datname: usage: "LABEL" description: "Name of the database" - size_bytes: usage: "GAUGE" description: "Disk space used by the database"</code> </pre> <br><p> ä¸Šä¾‹ä¸­çš„é”®å’Œå€¼ï¼š </p><br><ul><li>  <code>pg_database</code>è¯·æ±‚è¿”å›çš„åº¦é‡çš„ä»»æ„å‰ç¼€ï¼ˆå¿…éœ€ï¼‰ï¼› </li><li>  <code>query</code>åŒ…å«ä¸€ä¸ªSQLæŸ¥è¯¢ï¼ˆå¿…éœ€ï¼‰ï¼› </li><li>  <code>master</code>ä»…åœ¨è¿æ¥åˆ°URIæ—¶æŒ‡å®šçš„æ•°æ®åº“ï¼ˆä¸»æ•°æ®åº“ï¼‰ä¸­æ‰§è¡Œè¯·æ±‚ã€‚ ä½¿ç”¨æ ‡å¿—--auto-discover-databaseså¯åŠ¨å¯¼å‡ºå™¨æ—¶éœ€è¦ã€‚ æ¥å—å¯¹æˆ–é”™ã€‚ é»˜è®¤ä¸ºFalseã€‚  ï¼ˆå¯é€‰ï¼‰ï¼› </li><li>  <code>cache_seconds</code>è¿”å›ç¼“å­˜æ•°æ®çš„æ—¶é—´ã€‚ ä»¥ç§’ä¸ºå•ä½è®¾ç½®ï¼› </li><li>  <code>metrics</code> -åŒ…å«æ ‡ç­¾å’ŒæŒ‡æ ‡çš„åˆ—è¡¨ï¼› </li><li>  <code>datname</code> ï¼Œ <code>size_bytes</code>åˆ—è¡¨é¡¹ã€‚ åˆ—è¡¨é¡¹çš„åç§°å¿…é¡»ä¸æŸ¥è¯¢ä¸­åˆ—çš„åç§°åŒ¹é…ï¼› </li><li>  <code>usage</code> -å€¼çš„ç±»å‹ã€‚ æ¥å—COUNTERï¼ŒGAUGEï¼ŒLABLEï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚è§Prometheusæ–‡æ¡£ï¼‰ </li><li>  <code>description</code> -è‡ªå®šä¹‰æŒ‡æ ‡æè¿° </li></ul><br><p> ç¤ºä¾‹è¿”å›æŒ‡æ ‡ï¼š </p><br><pre> <code class="plaintext hljs"># HELP pg_database_size_bytes Disk space used by the database # TYPE pg_database_size_bytes gauge pg_database_size_bytes{datname="dbtest1",server="localhost:5432"} 1.0105503e+07 pg_database_size_bytes{datname="demo",server="localhost:5432"} 2.813719199e+09 pg_database_size_bytes{datname="postgres",server="localhost:5432"} 4.735491e+06 pg_database_size_bytes{datname="template0",server="localhost:5432"} 7.758339e+06 pg_database_size_bytes{datname="template1",server="localhost:5432"} 7.758339e+06</code> </pre><br><h2 id="rezyume"> æ€»ç»“ </h2><br><p> å¥½å§ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œæœ€æ–°ç‰ˆæœ¬çš„postgres_exporter 0.8.0ä¸­åŒ…å«çš„æ‰€æœ‰å†…å®¹ã€‚ åŸºæœ¬ä¸Šï¼Œæ‰€æœ‰æ”¹è¿›éƒ½ä¸ç›‘è§†å¤šä¸ªå®ä¾‹å’Œ/æˆ–ä¸€ä¸ªå®ä¾‹ä¸­çš„å¤šä¸ªæ•°æ®åº“æœ‰å…³ã€‚ </p><br><ul><li>  exclude-databaseså‚æ•°ï¼ˆæ˜¾ç¤ºåœ¨0.6.0ä¸­ï¼‰ä½¿æ‚¨å¯ä»¥ä»è¦ä¸ºå…¶æ”¶é›†æŒ‡æ ‡çš„æ•°æ®åº“åˆ—è¡¨ä¸­æ’é™¤æ•°æ®åº“ã€‚ ä½†æ˜¯æ‚¨ä¸èƒ½æ’é™¤URIè¿æ¥ä¸­æŒ‡å®šçš„æ•°æ®åº“ï¼Œå› ä¸ºå®ƒæ˜¯ä¸»æ•°æ®åº“ã€‚ </li><li> ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°†è‡ªå®šä¹‰æŸ¥è¯¢ä¸auto-discover-databaseså‚æ•°ä¸€èµ·ç”¨äºå…¨å±€è§†å›¾ï¼ˆpg_stat_activityï¼Œpg_stat_databaseç­‰ï¼‰ã€‚ ä¸ºæ­¤ï¼Œæ·»åŠ äº†ä¸€ä¸ªé™„åŠ çš„<strong>master</strong>å­—æ®µï¼ŒæŒ‡ç¤ºä»…åº”åœ¨masteræ•°æ®åº“ä¸­æ‰§è¡Œè¯¥è¯·æ±‚ï¼› </li><li> ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°†é»˜è®¤æŒ‡æ ‡ä¸å‚æ•°auto-discover-databasesä¸€èµ·ä½¿ç”¨ã€‚ </li><li> å¯¹äºç”¨æˆ·è¯·æ±‚ï¼Œå·²æ·»åŠ cache_secondså­—æ®µï¼Œè¯¥å­—æ®µä½¿æ‚¨å¯ä»¥è®¾ç½®æœåŠ¡å™¨å¯¹ç›¸åº”è¯·æ±‚çš„å“åº”å°†è¢«ç¼“å­˜çš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚ </li></ul><br><h2 id="istochniki"> èµ„æ–™æ¥æº </h2><br><ul><li>  <a href="https://prometheus.io/" rel="nofollow">Prometheus</a> [ <a href="https://en.wikipedia.org/wiki/Prometheus_(software)" rel="nofollow">1</a> ]æ˜¯ç”¨äºç›‘è§†å’Œè­¦æŠ¥äº‹ä»¶çš„å¼€æºåº”ç”¨ç¨‹åºã€‚ å®ƒå°†å®æ—¶æŒ‡æ ‡å†™å…¥åˆ°ä½¿ç”¨HTTPè¯·æ±‚æ¨¡å‹æ„å»ºçš„æ—¶é—´åºåˆ—æ•°æ®åº“ä¸­ï¼Œå¹¶å…·æœ‰çµæ´»çš„æŸ¥è¯¢å’Œå®æ—¶è­¦æŠ¥ã€‚ </li><li>  <a href="https://github.com/wrouesnel/postgres_exporter" rel="nofollow">postgres_exporter</a>æ˜¯Prometheusçš„PostgreSQLæŒ‡æ ‡çš„å¯¼å‡ºå™¨ã€‚ <br> æ’°å†™æœ¬æ–‡æ—¶ï¼Œç‰ˆæœ¬ä¸º0.5.1ã€‚ æ”¯æŒçš„PostgreSQL 9.4+ç‰ˆæœ¬ï¼ˆä½†å®è·µè¯æ˜ï¼Œå®ƒé€‚ç”¨äº9.3ï¼‰ã€‚ </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN480902/">https://habr.com/ru/post/zh-CN480902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN480886/index.html">ç¥ç»ç½‘ç»œä¸é»„é‡‘åˆ†å‰²ï¼šç¬¬äºŒæ¬¡</a></li>
<li><a href="../zh-CN480888/index.html">DIYåç¨‹ã€‚ ç¬¬1éƒ¨åˆ†ã€‚æƒ°æ€§å‘ç”Ÿå™¨</a></li>
<li><a href="../zh-CN480890/index.html">ä½¿ç”¨Expressé¢æ¿çš„è°ƒæŸ¥ç»“æœ</a></li>
<li><a href="../zh-CN480892/index.html">æ°”çƒäº’è”ç½‘</a></li>
<li><a href="../zh-CN480900/index.html">å¸¦å›æˆ‘çš„å­©å­ï¼ ï¼ˆN.F.æ•…äº‹ï¼‰</a></li>
<li><a href="../zh-CN480904/index.html">PHPå¾®æœåŠ¡æ¡†æ¶ï¼šSwoftçš„å¼€å‘ç¯å¢ƒ</a></li>
<li><a href="../zh-CN480906/index.html">ç¼–å†™ä¸€ä¸ªç®€å•çš„pythonæ¸¸æˆ</a></li>
<li><a href="../zh-CN480910/index.html">å¦‚ä½•ä¸ºSeleniumæµ‹è¯•åˆ›å»ºåŸºæœ¬æµ‹è¯•ç±»å¹¶é€šè¿‡JUnit RuleChainè¿›è¡Œåˆå§‹åŒ–</a></li>
<li><a href="../zh-CN480912/index.html">å¿«é€Ÿè¡ŒåŠ¨ã€‚ ç¼–å†™TodoMVCã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN480914/index.html">é¢å‘åˆå­¦è€…çš„å¾®æœåŠ¡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>