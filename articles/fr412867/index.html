<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äç‚úàÔ∏è üëèüèº üë®üèº‚Äçüî¨ Comment compiler un fichier DOS COM par le compilateur GCC üöï üëâüèΩ üëè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Article publi√© le 9 d√©cembre 2014 
 Mise √† jour pour 2018: Ren√©Rebe a r√©alis√© une vid√©o int√©ressante bas√©e sur cet article ( partie 2 ) 

 Le week-end...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment compiler un fichier DOS COM par le compilateur GCC</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412867/"> <font color="gray">Article publi√© le 9 d√©cembre 2014</font> <br>  <i>Mise √† jour pour 2018: Ren√©Rebe a r√©alis√© une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o int√©ressante</a> bas√©e sur cet article ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 2</a> )</i> <br><br>  Le week-end dernier, j'ai particip√© √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ludum Dare # 31</a> .  Mais avant m√™me que la conf√©rence ne soit annonc√©e, √† cause de mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©cent passe-temps,</a> je voulais faire un jeu √† l'ancienne sous DOS.  La plate-forme cible est DOSBox.  C'est le moyen le plus pratique pour ex√©cuter des applications DOS, malgr√© le fait que tous les processeurs x86 modernes sont enti√®rement r√©trocompatibles avec les anciens, jusqu'au 8086 16 bits. <br><br>  J'ai cr√©√© et montr√© avec succ√®s le jeu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DOS Defender</a> lors de la conf√©rence.  Le programme fonctionne dans le mode r√©el du 8038 32 bits. Toutes les ressources sont int√©gr√©es dans le fichier COM ex√©cutable, sans d√©pendances externes, donc le jeu entier est emball√© dans un binaire de 10 kilo-octets. <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/skeeto/dosdefender-ld31</a> </li><li>  <a href="">DOSDEF.COM</a> (10 Ko, v1.1.0, fonctionne dans DOSBox) </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ay/na/qs/aynaqsaenvt32x5oa8y7z4fmnfy.gif"></div><a name="habracut"></a><br>  Vous aurez besoin d'un joystick ou d'une manette pour jouer.  J'ai inclus la prise en charge de la souris dans la version de Ludum Dare √† des fins de pr√©sentation, mais je l'ai ensuite supprim√©e car cela ne fonctionnait pas tr√®s bien. <br><br>  La partie la plus int√©ressante techniquement est <b><i>qu'aucun</i> outil de d√©veloppement DOS n'√©tait n√©cessaire pour cr√©er le jeu</b> !  J'ai utilis√© uniquement le compilateur Linux C standard (gcc).  En r√©alit√©, vous ne pouvez m√™me pas cr√©er un d√©fenseur DOS pour DOS.  Je vois DOS uniquement comme une plate-forme embarqu√©e, qui est la seule forme sous laquelle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DOS existe encore aujourd'hui</a> .  Avec DOSBox et DOSEMU, il s'agit d'un ensemble d'outils assez pratique. <br><br>  Si vous n'√™tes int√©ress√© que par la partie pratique du d√©veloppement, allez dans la section ¬´Cheat on GCC¬ª, o√π nous √©crirons le programme DOS COM ¬´Hello, World¬ª avec GCC Linux. <br><br><h1>  Trouver les bons outils </h1><br>  Quand j'ai commenc√© ce projet, je ne pensais pas √† GCC.  En r√©alit√©, je suis all√© de cette fa√ßon lorsque j'ai d√©couvert le paquet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bcc</a> (Bruce's C Compiler) pour Debian, qui collecte des binaires 16 bits pour 8086. Il est utilis√© pour la compilation de chargeurs de d√©marrage x86 et d'autres choses, mais bcc peut √©galement √™tre utilis√© pour compiler des fichiers COM COM DOS.  √áa m'a int√©ress√©. <br><br>  Pour r√©f√©rence: le microprocesseur Intel 8086 16 bits est sorti en 1978.  Il n'avait aucune caract√©ristique bizarre des processeurs modernes: pas de protection de la m√©moire, pas d'instructions en virgule flottante et seulement 1 Mo de RAM adressable.  Tous les ordinateurs de bureau et portables x86 modernes peuvent toujours pr√©tendre √™tre ce processeur 16 bits 8086 il y a quarante ans, avec le m√™me adressage limit√© et tout cela.  Il s'agit d'une compatibilit√© assez ancienne.  Une telle fonction est appel√©e <i>mode r√©el</i> .  Il s'agit du mode dans lequel tous les ordinateurs x86 d√©marrent.  Les syst√®mes d'exploitation modernes passent imm√©diatement en <i>mode prot√©g√©</i> avec un adressage virtuel et un multit√¢che s√©curis√©.  DOS ne l'a pas fait. <br><br>  Malheureusement, bcc n'est pas un compilateur ANSI C. Il prend en charge un sous-ensemble de K&amp;R C, ainsi que le code assembleur x86 int√©gr√©.  Contrairement aux autres compilateurs 8086 C, il n'a pas le concept de pointeurs ¬´√©loign√©s¬ª ou ¬´longs¬ª, donc un code assembleur int√©gr√© est n√©cessaire pour acc√©der √† d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">autres segments de m√©moire</a> (VGA, horloges, etc.).  Remarque: les restes de ces "longs pointeurs" 8086 sont toujours conserv√©s dans l'API Win32: <code>LPSTR</code> , <code>LPWORD</code> , <code>LPDWORD</code> , etc. Cet assembleur int√©gr√© ne se compare m√™me pas √©troitement avec l'assembleur int√©gr√© GCC.  Dans l'assembleur, vous devez charger manuellement les variables √† partir de la pile, et puisque bcc prend en charge deux conventions d'appel diff√©rentes, les variables dans le code doivent √™tre cod√©es en dur conform√©ment √† l'une ou l'autre convention. <br><br>  Compte tenu de ces limites, j'ai d√©cid√© de chercher des alternatives. <br><br><h1>  DJGPP </h1><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DJGPP</a> - Port GCC sous DOS.  Un projet vraiment tr√®s impressionnant qui transf√®re presque tout le POSIX sous DOS.  De nombreux programmes sous DOS sont cr√©√©s sur DJGPP.  Mais il ne cr√©e que des programmes 32 bits pour le mode prot√©g√©.  Si en mode prot√©g√© vous devez travailler avec du mat√©riel (par exemple, VGA), le programme fait des requ√™tes au service de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'interface DOS en mode prot√©g√©</a> (DPMI).  Si je prenais DJGPP, je n'aurais pas pu me limiter √† un seul binaire autonome, car je devrais avoir un serveur DPMI.  Les performances souffrent √©galement des demandes de DPMI. <br><br>  Obtenir les outils n√©cessaires pour DJGPP est pour le moins difficile.  Heureusement, j'ai trouv√© un projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">build-djgpp</a> utile qui ex√©cute tout, au moins sous Linux. <br><br>  Soit il y a eu une grave erreur, soit les binaires officiels de DJGPP ont √©t√© √† nouveau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">infect√©s par le virus</a> , mais lorsque j'ai d√©marr√© mes programmes dans DOSBox, l'erreur ¬´Not COFF: check for virus¬ª est constamment apparue.  Pour v√©rifier davantage que les virus ne sont pas sur ma propre machine, j'ai configur√© l'environnement DJGPP sur mon Raspberry Pi, qui agit comme une salle blanche.  Ce p√©riph√©rique ARM ne peut pas √™tre infect√© par le virus x86.  Et toujours le m√™me probl√®me se posait, et tous les hachages binaires √©taient les m√™mes entre les machines, donc ce n'est pas de ma faute. <br><br>  Donc, √©tant donn√© cela et le probl√®me DPMI, j'ai commenc√© √† chercher plus loin. <br><br><h1>  Fooling gcc </h1><br>  Ce sur quoi je me suis finalement fix√© √©tait l'astuce de "tricher" GCC pour construire des fichiers DOS COM en mode r√©el.  L'astuce fonctionne jusqu'√† 80386 (ce qui est g√©n√©ralement ce dont vous avez besoin).  Le processeur 80386 a √©t√© lanc√© en 1985 et est devenu le premier microprocesseur x86 32 bits.  GCC adh√®re toujours √† cet ensemble d'instructions, m√™me dans les environnements x86-64.  Malheureusement, GCC ne peut en aucun cas produire du code 16 bits, j'ai donc d√ª abandonner l'objectif initial de cr√©er un jeu pour 8086.  Cependant, cela n'a pas d'importance, car la plate-forme DOSBox cible est essentiellement un √©mulateur 80386. <br><br>  En th√©orie, l'astuce devrait √©galement fonctionner dans le compilateur MinGW, mais il existe une erreur de longue date qui l'emp√™che de fonctionner correctement (¬´ne peut pas effectuer d'op√©rations PE sur un fichier de sortie non PE¬ª).  Cependant, vous pouvez le contourner, et je l'ai fait moi-m√™me: vous devez supprimer la directive <code>OUTPUT_FORMAT</code> et ajouter une √©tape <code>objcopy</code> suppl√©mentaire ( <code>objcopy -O binary</code> ). <br><br><h3>  Hello World sur DOS </h3><br>  Pour d√©monstration, nous allons cr√©er le programme COM COM "Hello, World" en utilisant GCC sous Linux. <br><br>  Il y a un obstacle majeur et significatif √† cette m√©thode: <b>il n'y aura pas de biblioth√®que standard</b> .  C'est comme √©crire un syst√®me d'exploitation √† partir de z√©ro, √† l'exception de quelques services fournis par DOS.  Cela signifie pas de <code>printf()</code> ou similaire.  Au lieu de cela, nous demandons √† DOS d'imprimer la cha√Æne sur la console.  La cr√©ation d'une requ√™te DOS n√©cessite une interruption, ce qui signifie du code assembleur en ligne! <br><br>  Le DOS a neuf interruptions: 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x2F.  La chose la plus importante qui nous int√©resse est 0x21, la fonction 0x09 (imprimer une ligne).  Entre DOS et BIOS, il existe des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">milliers de fonctions nomm√©es d'apr√®s ce mod√®le</a> .  Je ne vais pas essayer d'expliquer l'assembleur x86, mais en un mot, le num√©ro de la fonction est coinc√© dans le registre <code>ah</code> - et l'interruption 0x21 se d√©clenche.  La fonction 0x09 prend √©galement un argument - un pointeur vers une ligne pour l'impression, qui est pass√©e dans les registres <code>dx</code> et <code>ds</code> . <br><br>  Voici la fonction <code>print()</code> de l'assembleur en ligne GCC.  Les lignes pass√©es √† cette fonction doivent se terminer par le caract√®re $.  Pourquoi?  Parce que DOS. <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mov $0x09, %%ah\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"int $0x21\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no output */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"d"</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">) : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ah"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; }</code> </pre> <br>  Le code est d√©clar√© <code>volatile</code> car il a un effet secondaire (impression de ligne).  Pour GCC, le code assembleur est opaque et l'optimiseur s'appuie sur les restrictions de sortie / entr√©e / clobber (trois derni√®res lignes).  Pour de tels programmes DOS, tout assembleur int√©gr√© aura des effets secondaires.  C'est parce qu'il est √©crit non pas pour l'optimisation, mais pour l'acc√®s aux ressources mat√©rielles et au DOS - des choses inaccessibles au simple C. <br><br>  Vous devez √©galement prendre soin de l'instruction appelante, car GCC ne sait pas que la m√©moire point√©e par la <code>string</code> a d√©j√† √©t√© lue.  Il est probable qu'un tableau qui prend en charge la cha√Æne devra √©galement √™tre d√©clar√© <code>volatile</code> .  Tout cela laisse pr√©sager l'in√©vitable: toute action dans un tel environnement se transforme en une lutte sans fin avec l'optimiseur.  Toutes ces batailles ne peuvent pas √™tre gagn√©es. <br><br>  Passons maintenant √† la fonction principale.  Son nom n'est pas important en principe, mais j'√©vite de l'appeler <code>main()</code> , car MinGW a des id√©es amusantes sur la fa√ßon de traiter ces caract√®res sp√©cifiquement, m√™me s'ils lui demandent de ne pas le faire. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dosmain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { print(<span class="hljs-string"><span class="hljs-string">"Hello, World!\n$"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  La taille des fichiers COM est limit√©e √† 65279 octets.  En effet, le segment de m√©moire x86 fait 64 Ko et DOS t√©l√©charge simplement les fichiers COM √† l'adresse du segment 0x0100 et s'ex√©cute.  Pas de titres, juste un binaire propre.  √âtant donn√© que le programme COM, en principe, ne peut pas avoir une taille significative, alors aucune mise en page r√©elle (autonome) ne doit se produire, le tout est compil√© comme une seule unit√© de traduction.  Ce sera un appel GCC avec un tas de param√®tres. <br><br><h3>  Options du compilateur </h3><br>  Voici les principales options du compilateur. <br><br> <code>-std=gnu99 -Os -nostdlib -m32 -march=i386 -ffreestanding</code> <br> <br>  Comme les biblioth√®ques standard ne sont pas utilis√©es, la seule diff√©rence entre gnu99 et c99 est les trigraphes d√©sactiv√©s (comme il se doit), et l'assembleur int√©gr√© peut √™tre √©crit en <code>asm</code> au lieu de <code>__asm__</code> .  Ce n'est pas le bac de Newton.  Le projet sera si √©troitement li√© √† GCC que je ne suis toujours pas pr√©occup√© par les extensions de GCC. <br><br>  L'option <code>-Os</code> r√©duit autant que possible le r√©sultat de la compilation.  Le programme fonctionnera donc plus rapidement.  Ceci est important en vue de DOSBox, car l'√©mulateur par d√©faut s'ex√©cute lentement comme une machine des ann√©es 80.  Je veux m'int√©grer dans cette limitation.  Si l'optimiseur cause des probl√®mes, <code>-O0</code> temporairement <code>-O0</code> pour d√©terminer si votre erreur ou l'optimiseur est l√†. <br><br>  Comme vous pouvez le voir, l'optimiseur ne comprend pas que le programme fonctionnera en mode r√©el avec les restrictions d'adressage correspondantes.  <b>Il effectue toutes sortes d'optimisations invalides qui cassent vos programmes parfaitement valides.</b>  Ce n'est pas un bug de GCC, car nous faisons nous-m√™mes des choses folles ici.  J'ai d√ª refaire le code plusieurs fois pour emp√™cher l'optimiseur de casser le programme.  Par exemple, nous avons d√ª √©viter de renvoyer des structures complexes √† partir de fonctions car elles √©taient parfois remplies de d√©chets.  Le vrai danger est que la future version de GCC deviendra encore plus intelligente et cassera encore plus de code.  Voici votre ami <code>volatile</code> . <br><br>  Le param√®tre suivant est <code>-nostdlib</code> , car nous ne pourrons pas lier √† des biblioth√®ques valides, m√™me statiquement. <br><br>  Les param√®tres <code>-m32-march=i386</code> compilateur d'√©mettre le code 80386. Si j'√©crivais le chargeur de d√©marrage pour un ordinateur moderne, la vue sur 80686 serait √©galement normale, mais la DOSBox est 80386. <br><br>  L'argument <code>-ffreestanding</code> requiert que GCC ne <code>-ffreestanding</code> pas de code qui acc√®de aux fonctions d'assistance de la biblioth√®que standard int√©gr√©e.  Parfois, au lieu de travailler r√©ellement sur du code, il produit un code pour appeler une fonction en ligne, en particulier avec des op√©rateurs math√©matiques.  J'ai eu l'un des principaux probl√®mes avec bcc, o√π ce comportement ne peut pas √™tre d√©sactiv√©.  Cette option est le plus souvent utilis√©e lors de l'√©criture de chargeurs de d√©marrage et de noyaux de syst√®me d'exploitation.  Et maintenant les fichiers dos dos .com. <br><br><h3>  Options de l'√©diteur de liens </h3><br>  L' <code>-Wl</code> utilis√©e pour passer des arguments √† l'√©diteur de liens ( <code>ld</code> ).  Nous en avons besoin parce que nous faisons tout en un seul appel au CCG. <br><br><pre> <code class="hljs powershell"><span class="hljs-literal"><span class="hljs-literal">-Wl</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-nmagic</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-script</span></span>=com.ld</code> </pre> <br>  <code>--nmagic</code> d√©sactive l'alignement des pages de section.  Premi√®rement, nous n'en avons pas besoin.  Deuxi√®mement, il gaspille un espace pr√©cieux.  Dans mes tests, cela ne semble pas √™tre une mesure n√©cessaire, mais juste au cas o√π, je laisse cette option. <br><br>  Le param√®tre <code>--script</code> indique que nous voulons utiliser un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script de l'√©diteur de liens</a> sp√©cial.  Cela vous permet de placer avec pr√©cision les sections ( <code>text</code> , <code>data</code> , <code>bss</code> , <code>rodata</code> ) de notre programme.  Voici le script <code>com.ld</code> <br><br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">OUTPUT_FORMAT</span></span>(binary) <span class="hljs-type"><span class="hljs-type">SECTIONS</span></span> { . = <span class="hljs-number"><span class="hljs-number">0x0100</span></span>; .text : { *(.text); } .<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> : { *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">); *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bss</span></span></span><span class="hljs-class">); *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rodata</span></span></span><span class="hljs-class">); } _heap = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ALIGN</span></span></span><span class="hljs-class">(4); }</span></span></code> </pre> <br>  <code>OUTPUT_FORMAT(binary)</code> vous dit de ne pas le mettre dans un fichier ELF (ou PE, etc.).  L'√©diteur de liens doit simplement r√©initialiser le code propre.  Un fichier COM est juste du code propre, c'est-√†-dire que nous donnons la commande √† l'√©diteur de liens pour cr√©er un fichier COM! <br><br>  J'ai dit que les fichiers COM sont t√©l√©charg√©s sur <code>0x0100</code> .  La quatri√®me ligne y d√©place le binaire.  Le premier octet du fichier COM est toujours le premier octet du code, mais sera lanc√© √† partir de ce d√©calage de m√©moire. <br><br>  Ensuite, toutes les sections suivent: <code>text</code> (programme), <code>data</code> ( <code>data</code> statiques), <code>bss</code> (donn√©es avec initialisation z√©ro), <code>rodata</code> (cha√Ænes).  Enfin, je marque la fin du binaire avec le symbole <code>_heap</code> .  Cela nous sera utile plus tard lors de l'√©criture de <code>sbrk()</code> lorsque nous aurons termin√© avec ¬´Hello, World¬ª.  J'ai indiqu√© d'aligner <code>_heap</code> avec 4 octets. <br><br>  Presque termin√©. <br><br><h3>  Lancement du programme </h3><br>  L'√©diteur de liens conna√Æt g√©n√©ralement notre point d'entr√©e ( <code>main</code> ) et le configure pour nous.  Mais puisque nous avons demand√© un probl√®me ¬´binaire¬ª, nous devrons le d√©couvrir nous-m√™mes.  Si la fonction <code>print()</code> est la premi√®re √† s'ex√©cuter, le programme d√©marrera, ce qui est faux.  Le programme a besoin d'une petite rubrique pour commencer. <br><br>  Il y a une option <code>STARTUP</code> dans le script de l'√©diteur de liens pour de telles choses, mais pour plus de simplicit√©, nous allons l'impl√©menter directement dans le programme.  Habituellement, de telles choses sont appel√©es <code>crt0.o</code> ou <code>Boot.o</code> , au cas o√π vous <code>Boot.o</code> dessus quelque part.  Notre code <i>doit</i> commencer par cet assembleur int√©gr√©, avant toutes les inclusions et autres.  DOS effectuera la majeure partie de l'installation pour nous, nous avons juste besoin d'aller au point d'entr√©e. <br><br><pre> <code class="hljs perl">asm (<span class="hljs-string"><span class="hljs-string">".code16gcc\n"</span></span> <span class="hljs-string"><span class="hljs-string">"call dosmain\n"</span></span> <span class="hljs-string"><span class="hljs-string">"mov $0x4C, %ah\n"</span></span> <span class="hljs-string"><span class="hljs-string">"int $0x21\n"</span></span>);</code> </pre> <br>  <code>.code16gcc</code> indique √† l'assembleur que nous allons travailler en mode r√©el, afin qu'il fasse la configuration correcte.  Malgr√© son nom, il <i>ne</i> produira <i>pas de</i> code 16 bits!  Tout d'abord, la fonction <code>dosmain</code> , que nous avons √©crite plus t√¥t, est appel√©e.  Il indique ensuite √† DOS √† l'aide de la fonction 0x4C (¬´terminer avec le code retour¬ª) que nous avons termin√© en passant le code de sortie au registre √† 1 octet (d√©j√† d√©fini par <code>dosmain</code> ).  Cet assembleur int√©gr√© est automatiquement <code>volatile</code> car il n'a pas d'entr√©es et de sorties. <br><br><h3>  Tous ensemble </h3><br>  Voici l'ensemble du programme en C. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">asm</span></span> (<span class="hljs-string"><span class="hljs-string">".code16gcc\n"</span></span> <span class="hljs-string"><span class="hljs-string">"call dosmain\n"</span></span> <span class="hljs-string"><span class="hljs-string">"mov $0x4C,%ah\n"</span></span> <span class="hljs-string"><span class="hljs-string">"int $0x21\n"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mov $0x09, %%ah\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"int $0x21\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no output */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"d"</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">) : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ah"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dosmain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ print(<span class="hljs-string"><span class="hljs-string">"Hello, World!\n$"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Je ne r√©p√©terai pas <code>com.ld</code>  Voici le d√©fi du CCG. <br><br><pre> <code class="hljs powershell">gcc <span class="hljs-literal"><span class="hljs-literal">-std</span></span>=gnu99 <span class="hljs-literal"><span class="hljs-literal">-Os</span></span> <span class="hljs-literal"><span class="hljs-literal">-nostdlib</span></span> <span class="hljs-literal"><span class="hljs-literal">-m32</span></span> <span class="hljs-literal"><span class="hljs-literal">-march</span></span>=i386 <span class="hljs-literal"><span class="hljs-literal">-ffreestanding</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-o</span></span> hello.com <span class="hljs-literal"><span class="hljs-literal">-Wl</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-nmagic</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-script</span></span>=com.ld hello.c</code> </pre> <br>  Et ses tests dans DOSBox: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c5/478/358/4c5478358be0cdd9cc05eafd66bd44d2.png"><br><br>  Ensuite, si vous voulez de beaux graphismes, la seule question est d'appeler l'interruption et d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crire dans la m√©moire VGA</a> .  Si vous voulez du son, utilisez l'interruption du haut-parleur PC.  Je n'ai pas compris comment appeler Sound Blaster.  √Ä partir de ce moment, DOS Defender a grandi. <br><br><h1>  Allocation de m√©moire </h1><br>  Pour couvrir un autre sujet, rappelez-vous que <code>_heap</code> ?  Nous pouvons l'utiliser pour impl√©menter <code>sbrk()</code> et allouer dynamiquement de la m√©moire dans la section principale du programme.  Il s'agit d'un mode r√©el et il n'y a pas de m√©moire virtuelle, nous pouvons donc √©crire sur n'importe quelle m√©moire √† laquelle nous pouvons acc√©der √† tout moment.  Certaines zones sont r√©serv√©es (par exemple, la m√©moire inf√©rieure et sup√©rieure) pour l'√©quipement.  Il n'y a donc pas <i>vraiment</i> besoin d'utiliser sbrk (), mais il est int√©ressant d'essayer. <br><br>  Comme d'habitude sur x86, votre programme et vos partitions sont dans la m√©moire inf√©rieure (0x0100 dans ce cas), et la pile est dans la m√©moire sup√©rieure (dans notre cas, dans la r√©gion 0xffff).  Sur les syst√®mes de type Unix, la m√©moire renvoy√©e par <code>malloc()</code> vient de deux endroits: <code>sbrk()</code> et <code>mmap()</code> .  Ce que fait <code>sbrk()</code> est d'allouer de la m√©moire juste au-dessus des segments programme / donn√©es, en l'incr√©mentant ¬´vers le haut¬ª vers la pile.  Chaque appel √† <code>sbrk()</code> augmentera cet espace (ou le laissera exactement le m√™me).  Cette m√©moire sera g√©r√©e par <code>malloc()</code> et similaires. <br><br>  Voici comment impl√©menter <code>sbrk()</code> dans un programme COM.  Veuillez noter que vous devez d√©finir votre propre <code>size_t</code> , car nous n'avons pas de biblioth√®que standard. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> _heap; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *hbreak = &amp;_heap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sbrk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *ptr = hbreak; hbreak += size; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ptr; }</code> </pre> <br>  Il d√©finit simplement le pointeur sur <code>_heap</code> et l'incr√©mente selon les besoins.  Un peu plus intelligent <code>sbrk()</code> fera √©galement attention √† l'alignement. <br><br>  Une chose int√©ressante s'est produite lors de la cr√©ation de DOS Defender.  J'ai (√† tort) consid√©r√© que la m√©moire de mon <code>sbrk()</code> r√©initialis√©e.  C'√©tait donc apr√®s le premier match.  Cependant, DOS ne r√©initialise pas cette m√©moire entre les programmes.  Quand j'ai recommenc√© le jeu, <i>il a continu√© exactement l√† o√π je m'√©tais arr√™t√©</i> , car les m√™mes structures de donn√©es avec le m√™me contenu ont √©t√© charg√©es en place.  Co√Øncidence assez cool!  Cela fait partie de ce qui rend cette plate-forme int√©gr√©e amusante. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412867/">https://habr.com/ru/post/fr412867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412855/index.html">Les vuln√©rabilit√©s CSRF sont toujours d'actualit√©</a></li>
<li><a href="../fr412859/index.html">Authentification √† deux facteurs dans Windows et chiffrement des donn√©es sans autorit√© de certification ni domaine</a></li>
<li><a href="../fr412861/index.html">Cr√©ation d'une carte de parcours utilisateur pour les nuls</a></li>
<li><a href="../fr412863/index.html">Dialogflower - Google Dialogflow pour Yandex Alice</a></li>
<li><a href="../fr412865/index.html">Comment filmer une cam√©ra Motion Eye sur le Sony Xperia XZ2</a></li>
<li><a href="../fr412869/index.html">Entretien avec un expert en ing√©nierie tissulaire et m√©decine r√©g√©n√©rative, le professeur Tal Tal Dvir</a></li>
<li><a href="../fr412871/index.html">Eclair - Biblioth√®que de journalisation d√©clarative Java Spring</a></li>
<li><a href="../fr412873/index.html">Disques durs g√¢t√©s par le son des haut-parleurs d'ordinateur portable ordinaire</a></li>
<li><a href="../fr412877/index.html">Ruth√©nium (Ru) - le quatri√®me √©l√©ment aux propri√©t√©s ferromagn√©tiques √† temp√©rature ambiante</a></li>
<li><a href="../fr412879/index.html">Num√©ro 24: Formation informatique - probl√®mes et d√©fis actuels des grandes entreprises</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>