<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí™üèª üôè üöÇ La lutte pour les ressources, partie 2: Nous jouons avec les param√®tres de Cgroups üôèüèæ üêØ üïó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous avons commenc√© √† √©tudier les groupes de contr√¥le (Cgroups) dans Red Hat Enterprise Linux 7 - un m√©canisme au niveau du noyau qui vous permet de c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La lutte pour les ressources, partie 2: Nous jouons avec les param√®tres de Cgroups</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redhatrussia/blog/424367/">  Nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commenc√© √† √©tudier les groupes de contr√¥le</a> (Cgroups) dans Red Hat Enterprise Linux 7 - un m√©canisme au niveau du noyau qui vous permet de contr√¥ler l'utilisation des ressources syst√®me, avons bri√®vement pass√© en revue les fondements th√©oriques et passons maintenant √† la pratique de la gestion des ressources CPU, m√©moire et E / S. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mh/c7/4p/mhc74pjs5mq_w3d404hmfmxukfy.png"></div><br>  Cependant, avant de changer quoi que ce soit, il est toujours utile de savoir comment tout est organis√© maintenant. <br><a name="habracut"></a><br>  Il existe deux outils avec lesquels vous pouvez voir l'√©tat des groupes de contr√¥le actifs dans le syst√®me.  Tout d'abord, il s'agit de systemd-cgls - une commande qui affiche une liste arborescente de cgroups et de processus en cours d'ex√©cution.  Sa sortie ressemble √† ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nt/i7/bk/nti7bkd9izxkgviokentn9myehw.png"></div><br>  Ici, nous voyons les groupes de contr√¥le de niveau sup√©rieur: user.slice et system.slice.  Nous n'avons pas de machines virtuelles, par cons√©quent, sous charge, ces groupes de niveau sup√©rieur re√ßoivent 50% des ressources CPU (car la tranche de machine n'est pas active).  Il y a deux tranches enfants dans user.slice: user-1000.slice et user-0.slice.  Les tranches d'utilisateurs sont identifi√©es par l'ID utilisateur (UID), il peut donc √™tre difficile d'identifier le propri√©taire, sauf pour l'ex√©cution de processus.  Dans notre cas, les sessions ssh montrent que l'utilisateur 1000 est mrichter et l'utilisateur 0 est root, respectivement. <br><br>  La deuxi√®me commande que nous utiliserons est systemd-cgtop.  Il montre une image de l'utilisation des ressources en temps r√©el (la sortie de systemd-cgls, soit dit en passant, est √©galement mise √† jour en temps r√©el).  √Ä l'√©cran, cela ressemble √† ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z5/pi/yh/z5piyhlyaj_f0noc3h0cgabpvue.png"></div><br>  Il y a un probl√®me avec systemd-cgtop - il affiche des statistiques uniquement pour les services et tranches pour lesquels la comptabilit√© d'utilisation des ressources est activ√©e.  La comptabilit√© est activ√©e en cr√©ant des fichiers de configuration de d√©p√¥t dans les sous-r√©pertoires appropri√©s dans / etc / systemd / system.  Par exemple, le drop-in dans la capture d'√©cran ci-dessous permet l'utilisation du CPU et de la m√©moire pour le service sshd.  Pour ce faire vous-m√™me, cr√©ez simplement le m√™me drop-in dans un √©diteur de texte.  De plus, la comptabilit√© peut √©galement √™tre activ√©e avec la commande systemctl set-property sshd.service CPUAccounting = true MemoryAccounting = true. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1n/9p/be/1n9pbeounuudbk5qlcqekxadnoo.png"></div><br>  Apr√®s avoir cr√©√© le drop-in, vous devez entrer la commande systemctl daemon-reload, ainsi que la commande systemctl restart &lt;service_name&gt; pour le service correspondant.  En cons√©quence, vous verrez des statistiques sur l'utilisation des ressources, mais cela cr√©era une charge suppl√©mentaire, car les ressources seront √©galement d√©pens√©es pour la comptabilit√©.  Par cons√©quent, la comptabilit√© doit √™tre incluse avec soin et uniquement pour les services et les groupes de contr√¥le qui doivent √™tre contr√¥l√©s de cette mani√®re.  Cependant, souvent au lieu de systemd-cgtop, vous pouvez le faire avec les commandes top ou iotop. <br><br><h3>  Changez les boules CPU pour le plaisir et utilement </h3><br>  Voyons maintenant comment un changement dans la boule du processeur (partages CPU) affecte les performances.  Par exemple, nous aurons deux utilisateurs non privil√©gi√©s et un service syst√®me.  L'utilisateur avec la connexion mrichter a un UID de 1000, qui peut √™tre v√©rifi√© en utilisant le fichier / etc / passwd. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ld/ia/dp/ldiadp_tvevimxoiu1_aiqnko-e.png"></div><br>  Ceci est important car les tranches d'utilisateurs sont nomm√©es par UID et non par nom de compte. <br><br>  Passons maintenant au r√©pertoire de d√©p√¥t et voyons s'il y a d√©j√† quelque chose pour sa tranche. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/77/0b/7n/770b7nqx3kjyuebjwjf8tfcdtgu.png"></div><br>  Non, il n'y a rien.  Bien qu'il y ait autre chose - jetez un ≈ìil aux choses li√©es √† foo.service: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i2/wj/ie/i2wjiei6venywdoook6pvb6qzby.png"></div><br>  Si vous connaissez les fichiers d'unit√© systemd, vous verrez ici un fichier d'unit√© tout √† fait ordinaire qui ex√©cute la commande / usr / bin / sha1sum / dev / zero en tant que service (en d'autres termes, un d√©mon). Pour nous, l'important est que foo prenne litt√©ralement toutes les ressources processeur que le syst√®me lui permettra d'utiliser.  De plus, ici, nous avons un param√®tre drop-in pour le service foo, la valeur des boules CPU est √©gale √† 2048. Par d√©faut, comme vous vous en souvenez, il est utilis√© avec la valeur 1024, donc sous charge foo recevra une double part des ressources CPU dans le system.slice , sa tranche de niveau sup√©rieur parent (puisque foo est un service). <br><br>  Maintenant, ex√©cutez foo via systemctl et voyez ce que la commande sup√©rieure nous montre: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yj/ay/re/yjayreeugvlhzfoyuvsu4jbuopa.png"></div><br>  Puisqu'il n'y a pratiquement aucun autre √©l√©ment fonctionnel dans le syst√®me, le service foo (pid 2848) consomme presque tout le temps processeur d'un processeur. <br><br>  Introduisons maintenant mrichter dans l'√©quation de l'utilisateur.  D'abord, nous lui avons coup√© une boule CPU jusqu'√† 256, puis il se connecte et d√©marre foo.exe, en d'autres termes, le m√™me programme, mais en tant que processus utilisateur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v4/ga/rp/v4garp2tjh-dkxbutnjzjvk-mtc.png"></div><br>  Alors mrichter a lanc√© foo.  Et voici ce que la commande sup√©rieure montre maintenant: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qj/vh/_d/qjvh_d9glhvigqombngeti5xvos.png"></div><br>  √âtrange, hein?  L'utilisateur mrichter semble obtenir environ 10 pour cent du temps processeur, car il a = 256 billes, et foo.service en a jusqu'√† 2048, non? <br><br>  Maintenant, nous introduisons dorf dans l'√©quation.  Il s'agit d'un autre utilisateur ordinaire avec une bille CPU standard √©gale √† 1024. Il ex√©cutera √©galement foo, et encore une fois, nous verrons comment la distribution du temps du processeur va changer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bz/54/lu/bz54lujtxyjcwfqf17sztisnj3e.png"></div><br>  dorf est un utilisateur de la vieille √©cole, il commence juste le processus, sans aucun script intelligent ni rien d'autre.  Et encore une fois, nous regardons la sortie de haut: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ov/mn/bz/ovmnbzbrdvfnhqpz2o4quzkhjb0.png"></div><br>  Alors ... jetons un coup d'≈ìil √† l'arborescence cgroups et essayons de comprendre ce qui est quoi: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1j/qd/wz/1jqdwzweorfw_yrtbl31ga0cfj0.png"></div><br>  Si vous vous souvenez, g√©n√©ralement dans un syst√®me, il existe trois groupes de contr√¥le de niveau sup√©rieur: syst√®me, utilisateur et machine.  Puisqu'il n'y a pas de machines virtuelles dans notre exemple, seules les tranches syst√®me et utilisateur restent.  Chacun d'eux a une CPU-boule de 1024, et donc sous charge, il re√ßoit la moiti√© du temps processeur.  √âtant donn√© que foo.service vit dans System et qu'il n'y a aucun autre candidat pour le temps CPU dans cette tranche, foo.service re√ßoit 50% des ressources CPU. <br><br>  De plus, les utilisateurs dorf et mrichter vivent dans la tranche utilisateur.  La premi√®re balle est 1024, la seconde - 256. Par cons√©quent, dorf obtient quatre fois plus de temps processeur que mrichter.  Voyons maintenant ce que le top montre: foo.service - 50%, dorf - 40%, mrichter - 10%. <br><br>  En traduisant cela dans un langage de cas d'utilisation, nous pouvons dire que dorf a une priorit√© plus √©lev√©e.  Par cons√©quent, les groupes de contr√¥le sont configur√©s de sorte que l'utilisateur mrichter coupe les ressources pendant le temps dont il a besoin.  En effet, apr√®s tout, alors que mrichter √©tait dans le syst√®me seul, il a re√ßu 50% du temps du processeur, car dans la tranche utilisateur, personne d'autre n'a concouru pour les ressources CPU. <br><br>  En fait, les balles CPU sont un moyen de fournir un certain ¬´minimum garanti¬ª de temps processeur, m√™me pour les utilisateurs et les services de priorit√© inf√©rieure. <br><br>  De plus, nous avons un moyen de fixer un quota dur pour les ressources CPU, une certaine limite en chiffres absolus.  Nous le ferons pour l'utilisateur mrichter et verrons comment la distribution des ressources change. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bu/zd/ni/buzdnitn6z8eda2fr7lrhy4vd9q.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s3/uy/os/s3uyosq5pxft-3math1cev5bqiy.png"></div><br>  Maintenant, tuons les t√¢ches de l'utilisateur dorf, et voici ce qui se passe: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sq/bd/4s/sqbd4s0k8hgchpuwnkw06jncqqc.png"></div><br>  Pour mrichter, la limite CPU absolue est de 5%, donc foo.service obtient le reste du temps processeur. <br><br>  Continuez l'intimidation et arr√™tez foo.service: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/y8/8_/y1y88_nywde7vz7aufqa4jxfaqg.png"></div><br>  Ce que nous voyons ici: mrichter a 5% du temps processeur, et les 95% restants du syst√®me sont inactifs.  La moquerie formelle, oui. <br><br>  En fait, cette approche vous permet de pacifier efficacement les services ou les applications qui aiment subitement basculer et tirer toutes les ressources du processeur pour elles-m√™mes au d√©triment des autres processus. <br><br>  Nous avons donc appris √† contr√¥ler la situation actuelle avec les groupes de contr√¥le.  Maintenant, nous creusons un peu plus et voyons comment les cgroup sont impl√©ment√©s au niveau du syst√®me de fichiers virtuel. <br><br>  Le r√©pertoire racine de tous les cgroups en cours d'ex√©cution se trouve dans / sys / fs / cgroup.  Lorsque le syst√®me d√©marre, il se remplit au d√©marrage des services et autres t√¢ches.  Lors du d√©marrage et de l'arr√™t des services, leurs sous-r√©pertoires apparaissent et disparaissent. <br><br>  Dans la capture d'√©cran ci-dessous, nous sommes all√©s dans un sous-r√©pertoire pour le contr√¥leur CPU, √† savoir dans la tranche syst√®me.  Comme vous pouvez le voir, le sous-r√©pertoire de foo n'est pas encore l√†.  Ex√©cutez foo et v√©rifiez quelques √©l√©ments, √† savoir son PID et sa boule de CPU actuelle: <br><br><img src="https://habrastorage.org/webt/l1/ac/ms/l1acmsfmdl-co5sstjuy0lbpo5y.png"><br><br>  Avertissement important: ici, vous pouvez modifier les valeurs √† la vol√©e.  Oui, en th√©orie, √ßa a l'air cool (et en r√©alit√© aussi), mais cela peut se transformer en un gros g√¢chis.  Par cons√©quent, avant de changer quoi que ce soit, pesez soigneusement tout et ne jouez jamais sur des serveurs de combat.  Mais de toute fa√ßon, un syst√®me de fichiers virtuel est quelque chose √† approfondir lorsque vous apprenez comment fonctionnent les groupes de contr√¥le. <br><br><ul><li>  Partie 1 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/423051</a> </li><li>  Partie 3 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/425803</a> </li><li>  Partie 4 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/427413</a> </li><li>  Partie 5 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/429064</a> </li><li>  Partie 6 - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/company/redhatrussia/blog/430748</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr424367/">https://habr.com/ru/post/fr424367/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr424353/index.html">Contexte: le moteur de recherche Internet d'√âtat Spoutnik et son histoire complexe</a></li>
<li><a href="../fr424355/index.html">Moulage par injection: comment √ßa marche</a></li>
<li><a href="../fr424361/index.html">Comment la gamification am√©liore l'exp√©rience utilisateur</a></li>
<li><a href="../fr424363/index.html">"Si vous voulez cr√©er quelque chose de vraiment cool, vous devez creuser plus profond√©ment et savoir comment fonctionne votre code dans le syst√®me, sur le mat√©riel"</a></li>
<li><a href="../fr424365/index.html">Fonctionnement de la trace de pile sur ARM</a></li>
<li><a href="../fr424369/index.html">Mon fichier pr√©f√©r√© dans la base de code Chromium</a></li>
<li><a href="../fr424371/index.html">D√©ployer vCloud Extender</a></li>
<li><a href="../fr424373/index.html">O√π travailler en informatique, num√©ro 1: Voximplant</a></li>
<li><a href="../fr424375/index.html">Examen de la moulureuse sous vide Mayku FormBox: laissez les pi√®ces se propager</a></li>
<li><a href="../fr424377/index.html">Playme TIO Review: DVR √† montage magn√©tique haut de gamme</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>