<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¶ üíµ üë©‚Äç‚úàÔ∏è Informes sobre el estado de almacenamiento utilizando R. Computaci√≥n paralela, gr√°ficos, xlsx, correo electr√≥nico y todo esto üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ‚õ≤Ô∏è üßó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El art√≠culo proporciona c√≥digo para generar informes peri√≥dicos sobre el estado de las unidades de almacenamiento EMC VNX con enfoques alternativos e ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Informes sobre el estado de almacenamiento utilizando R. Computaci√≥n paralela, gr√°ficos, xlsx, correo electr√≥nico y todo esto</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461441/"><p>  El art√≠culo proporciona c√≥digo para generar informes peri√≥dicos sobre el estado de las unidades de almacenamiento <strong>EMC VNX</strong> con enfoques alternativos e historial de creaci√≥n. </p><br><p>  Trat√© de escribir c√≥digo con los comentarios m√°s detallados y un archivo.  Solo sustituya sus contrase√±as.  Tambi√©n se indica el formato de los datos de origen, por lo que me alegrar√° si alguien intenta aplicarlo en casa. </p><br><p><img src="https://habrastorage.org/webt/um/it/no/umitnoobcf6fiyywqho_5gsbvjk.png" alt="Apariencia de gr√°ficos"></p><a name="habracut"></a><br><h2 id="predystoriya">  Antecedentes </h2><br><p>  Puede omitir si no es interesante de d√≥nde provienen las "patas". <br>  Contamos con un centro de datos.  No hay sistemas de almacenamiento muy frescos.  Hay muchos sistemas de almacenamiento, fallas de disco tambi√©n.  Varias veces a la semana, las personas van al centro de datos y cambian las unidades en el sistema de almacenamiento.  La decisi√≥n de reemplazar discos se toma despu√©s de una alarma del sistema " <strong>Reemplazo de disco recomendado</strong> ". </p><br><p>  <em>Nada fuera de lo com√∫n.</em> </p><br><p><img src="https://habrastorage.org/webt/5l/ho/ne/5lhonedh_eha1d0gm2vnzrv2ry4.png" alt="Esta bien"></p><br><p>  Pero recientemente, los LUN individuales recopilados en estos sistemas de almacenamiento y presentados al entorno virtual comenzaron a degradarse gravemente.  Despu√©s de hablar con el soporte t√©cnico del proveedor, qued√≥ claro que los discos ya deber√≠an cambiarse no solo cuando aparece el mensaje de alarma anterior, sino tambi√©n cuando aparece una gran cantidad de otros mensajes de que el sistema no considera errores cr√≠ticos. </p><br><p>  La monitorizaci√≥n SNMP de estos sistemas de almacenamiento no es compatible.  <strong>Debe</strong> usar un software propietario costoso (no lo tenemos) o la utilidad de consola <strong>NaviSECCli</strong> , que debe estar conectada a cada controlador (hay dos) de cada sistema de almacenamiento, pero esto no era muy deseable. </p><br><p>  Se decidi√≥ automatizar la recopilaci√≥n de registros y buscar errores en ellos.  Y la decisi√≥n de reemplazar los discos debe dejarse a los ingenieros responsables en funci√≥n de los resultados del an√°lisis del informe. </p><br><h2 id="pervye-shagi">  Primeros pasos </h2><br><p>  Inicialmente, uno de mis colegas escribi√≥ el c√≥digo de <strong>PowerShell</strong> que hizo lo siguiente: </p><br><ul><li>  Tom√≥ una tabla de entrada que conten√≠a las direcciones IP de los controladores de almacenamiento; </li><li>  el ciclo fue a las direcciones IP de los controladores <em>A</em> , luego a las direcciones IP de los controladores <em>B</em> ; </li><li>  en el proceso, adem√°s los entrevist√© para n√∫meros de serie de discos; </li><li>  proces√≥ todas las l√≠neas de los registros y filtr√≥ el contenido de los mensajes buscados; </li><li>  cre√≥ un objeto <strong>PowerShell</strong> y en sus propiedades analiz√≥ los datos necesarios de las l√≠neas obtenidas anteriormente; </li><li>  fusion√≥ todos los objetos resultantes en una tabla que se emiti√≥ en forma de csv. </li></ul><br><p>  El c√≥digo est√° abajo.  Inmediatamente haga una reserva de que est√° trabajando, pero hemos introducido una soluci√≥n alternativa. </p><br><div class="spoiler">  <b class="spoiler_title">Fuente de PowerShell</b> <div class="spoiler_text"><pre><code class="perl hljs">cd <span class="hljs-string"><span class="hljs-string">'d:\Navisphere CLI\' $csv = "D:\VNX-IP.csv" $Filter1 = "name1" $Filter2 = "name2" $Filter3 = "name3" $Data = import-csv $csv -Delimiter '</span></span>;<span class="hljs-string"><span class="hljs-string">' | Where {$_.cl -EQ $Filter1 -Or $_.cl -EQ $Filter2 -Or $_.cl -EQ $Filter3} | Sort-Object -Property @{Expression={$_.cl}; Ascending=$true}, @{Expression={$_.Name} ;Ascending=$true} #$Filter1 = "nameOfcl" #$Data = import-csv $csv -Delimiter '</span></span>;<span class="hljs-string"><span class="hljs-string">' | Where {$_.Name -EQ $Filter1} $Data | select Name,IP,cl $yStart = (Get-Date).AddDays(-30).ToString('</span></span>yyyy<span class="hljs-string"><span class="hljs-string">') $yEnd = (Get-Date).ToString('</span></span>yyyy<span class="hljs-string"><span class="hljs-string">') $mStart = (Get-Date).AddDays(-30).ToString('</span></span>MM<span class="hljs-string"><span class="hljs-string">') $mEnd = (Get-Date).ToString('</span></span>MM<span class="hljs-string"><span class="hljs-string">') $dStart = (Get-Date).AddDays(-30).ToString('</span></span>dd<span class="hljs-string"><span class="hljs-string">') $dEnd = (Get-Date).ToString('</span></span>dd<span class="hljs-string"><span class="hljs-string">') #$start = (Get-Date).AddDays(-3).ToString('</span></span>MM\/dd\/yy<span class="hljs-string"><span class="hljs-string">') #$end = (Get-Date).ToString('</span></span>MM\/dd\/yy<span class="hljs-string"><span class="hljs-string">') $i = 1 $table = ForEach ($row in $Data) { Write-Host $row.Name -ForegroundColor "Yellow" Write-Host "SP A" Write-Host (Get-Date).ToString('</span></span>HH:mm:ss<span class="hljs-string"><span class="hljs-string">') $txt = .\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getlog -date $mStart/$dStart/$yStart $mEnd/$dEnd/$yEnd | Select-String -Pattern "\(820\)","\(803\)","\(801\)","\(920\)","\(901\)" ForEach ($n in $txt) { $x = $n -Split('</span></span> <span class="hljs-string"><span class="hljs-string">') $disk = $x[3] + "_" + $x[5] + "_" + $x[7].Split("(")[0] $sn = (.\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getdisk $disk -serial)[1] | %{$_ -replace "Serial Number: ",""} | %{$_ -replace "State: ",""} | %{$_ -replace " ",""} New-Object PSObject -Property @{ i = $i cl = $row.cl Storage = $row.Name SP = "A" Date = $x[0] Time = $x[1] Disk = $disk Error = (($n -Split('</span></span>\[<span class="hljs-string"><span class="hljs-string">'))[0] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[1].Trim() eCode = (($n -Split('</span></span>\(<span class="hljs-string"><span class="hljs-string">'))[1] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[0] SN = $sn } $i = $i + 1 } Write-Host "SP B" Write-Host (Get-Date).ToString('</span></span>HH:mm:ss<span class="hljs-string"><span class="hljs-string">') $txt = .\NaviSECCli.exe -scope 0 -h $row.newB -user myusername -password mypassword getlog -date $mStart/$dStart/$yStart $mEnd/$dEnd/$yEnd | Select-String -Pattern "\(820\)","\(803\)","\(801\)","\(920\)","\(901\)" ForEach ($n in $txt) { $x = $n -Split('</span></span> <span class="hljs-string"><span class="hljs-string">') $disk = $x[3] + "_" + $x[5] + "_" + $x[7].Split("(")[0] $sn = (.\NaviSECCli.exe -scope 0 -h $row.newA -user myusername -password mypassword getdisk $disk -serial)[1] | %{$_ -replace "Serial Number: ",""} | %{$_ -replace "State: ",""} | %{$_ -replace " ",""} New-Object PSObject -Property @{ i = $i cl = $row.cl Storage = $row.Name SP = "B" Date = $x[0] Time = $x[1] Disk = $disk Error = (($n -Split('</span></span>\[<span class="hljs-string"><span class="hljs-string">'))[0] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[1].Trim() eCode = (($n -Split('</span></span>\(<span class="hljs-string"><span class="hljs-string">'))[1] -Split('</span></span>\)<span class="hljs-string"><span class="hljs-string">'))[0] SN = $sn } $i = $i + 1 } Write-Host " " } $table | select i,cl,Storage,SP,Date,Time,Disk,Error,eCode,SN | Export-Csv -Path '</span></span>d:\VNX-Errors.csv<span class="hljs-string"><span class="hljs-string">' -NoTypeInformation -UseCulture -Encoding UTF8</span></span></code> </pre> </div></div><br><p>  Todo estaba bien, todo lo que quedaba era agregar un "brillo" en forma de env√≠o autom√°tico de una carta a los colegas interesados ‚Äã‚Äãy un formato m√≠nimo del csv resultante.  Pero (!) Todo este problema funcion√≥ durante mucho tiempo.  Los datos de un mes, por ejemplo, se recopilaron aproximadamente <strong>45 minutos</strong> , lo que no fue muy adecuado, porque adem√°s de los informes regulares, quer√≠a hacer un an√°lisis para el a√±o en curso, y esto ser√≠a mucho tiempo.  Pero "rechazar - oferta".  Ellos comenzaron a pensar. </p><br><p><img src="https://habrastorage.org/webt/jn/85/ts/jn85tsztuso-z7ulzxh2a1jk7yq.jpeg"></p><br><p>  Obviamente, debe optimizar el c√≥digo y habilitar la computaci√≥n paralela.  En <strong>PowerShell</strong> , no tuvimos √©xito en m√°s de 5 subprocesos simult√°neos utilizando el <strong>flujo de trabajo</strong> , y todav√≠a no hemos "fumado" m√©todos alternativos.  Entonces se decidi√≥ tratar de cambiar la l√≥gica del script a <strong>R.</strong>  La utilidad <strong>NaviSECCli</strong> , que puede ejecutarse desde debajo de <strong>R</strong> , hace la encuesta de almacenamiento en el c√≥digo fuente, por lo que la soluci√≥n es bastante adecuada. <br>  Se dice <del>  un par de dias </del>  - hecho! </p><br><p>  Decidimos que en la salida me gustar√≠a recibir un bolet√≠n diario que contenga la <strong>cantidad total de errores</strong> en el texto de la carta, alg√∫n tipo de <strong>cronograma</strong> para la cantidad de accidentes (para que haya algo que mostrar a la gerencia) y tambi√©n <strong>un archivo adjunto</strong> en forma de una tabla xlsx.  Determinamos que en la tabla quiero tener 3 pesta√±as: </p><br><ul><li>  Datos de accidentes durante 3 d√≠as por disco y tipo de accidente </li><li>  Una pesta√±a similar, pero durante 30 d√≠as. </li><li>  Datos sin procesar (si alguien quiere ejecutarlos en Excel) </li></ul><br><h4 id="algoritm-skripta">  Algoritmo de secuencia de comandos </h4><br><p>  <strong>1.</strong> Descargue desde csv los datos disponibles en los controladores; <br>  <strong>2.</strong> ejecutar un ciclo de computaci√≥n paralela para todos los controladores con una b√∫squeda de registros de los mensajes de alarma requeridos; <br>  <strong>3.</strong> combinar los resultados en un marco de datos; <br>  <strong>4.</strong> hacer procesamiento de datos y conversi√≥n; <br>  <strong>5.</strong> generar documento xlsx; <br>  <strong>6.</strong> formamos el horario que guardamos en png; <br>  <strong>7.</strong> formar una carta que contenga los datos recopilados; <br>  <strong>8.</strong> enviar una carta. </p><br><h2 id="proydyom-po-punktam-algoritma">  Veamos los puntos del algoritmo. </h2><br><h3 id="1-zagruzhaem-iz-csv-imeyuschiesya-dannye-po-kontrolleram">  1. Descargue los datos disponibles en los controladores de csv </h3><br><div class="spoiler">  <b class="spoiler_title">Formato de tabla de origen con par√°metros VNX</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># A tibble: 83 x 9 Name IP cl type newA newB oldA oldB cntIP &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 2 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 3 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 4 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 5 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 6 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 7 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 8 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 9 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ 10 XXX 10.***.**~ XclNam~ 5300-1 10.201.1~ 10.201.1~ 10.***.*~ 10.***.*~ 10.***.*~ # ... with 73 more rows</span></span></code> </pre> </div></div><br><p>  Para recopilar informaci√≥n de emergencia, debe conectarse en serie a ambos controladores ( <em>columnas</em> <em>newA</em> y <em>newB</em> ) utilizando el software especializado <em>EMC</em> : <strong>NaviCLI</strong> con ciertas teclas. <br>  Por conveniencia, formateamos la tabla resultante despu√©s de cargarla para que las direcciones IP de ambos controladores est√©n en la misma columna, de modo que pueda hacer un ciclo a lo largo de la lista, y no dos consecutivos.  Hacemos esto usando la funci√≥n de <strong>recopilaci√≥n</strong> .  Los problemas de trabajar con formatos de datos "verticales" u "horizontales" est√°n muy bien descritos en la documentaci√≥n oficial de la biblioteca <strong>tidyverse</strong> .  Puedes leerlo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">aqu√≠</a> . </p><br><p>  Leemos los datos usando la funci√≥n <strong>read_csv2</strong> , tambi√©n determinamos manualmente los tipos de columnas a trav√©s del par√°metro adicional <strong>col_types</strong> .  Esta es una buena pr√°ctica, ya que  En gran medida acelera la carga.  En nuestro caso, esto no es tan importante, porque  El csv original contiene menos de 100 l√≠neas, pero nos acostumbramos a escribir correctamente. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   IP VNX. #         , #   ip        . VNX_ip &lt;- vnxIPfilePath %&gt;% read_csv2( col_types = cols( Name = col_character(), IP = col_character(), cl = col_character(), type = col_character(), newA = col_character(), newB = col_character(), oldA = col_character(), oldB = col_character() ) ) %&gt;% filter(cl %in% productCls) %&gt;% gather(key = "cntName", value = "cntIP", 5:6)</span></span></code> </pre> <br><p>  En la salida, obtenemos dicho marco de datos (las nuevas columnas son <strong>cntName</strong> y <strong>cntIP</strong> ): </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># A tibble: 30 x 8 Name IP cl type oldA oldB cntName cntIP &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 2 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 3 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 4 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 5 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 6 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 7 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 8 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 9 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ 10 XXX 10.***.***.*~ XclNameX 5300~ 10.***.***.~ 10.***.***.~ newA 10.***.***.~ # ... with 20 more rows</span></span></code> </pre> <br><h3 id="2-3-zapuskaem-cherez-parallelnye-vychisleniya-cikl-po-vsem-kontrolleram-s-poiskom-zapisey-o-trebuemyh-avariynyh-soobscheniyah-rezultaty-obedinyaem-v-data-frame">  2-3.  Realizamos un ciclo de c√≥mputos paralelos para todos los controladores con una b√∫squeda de registros de los mensajes de alarma requeridos.  Combina los resultados en un marco de datos </h3><br><p>  El siguiente es el m√°s interesante.  <em>Computaci√≥n paralela</em> . </p><br><p>  En <strong>R hay</strong> varias opciones (m√°s bien, incluso muchas) para la computaci√≥n paralela.  Me gust√≥ m√°s el enlace de las bibliotecas <strong>foreach</strong> y <strong>doParallel</strong> .  Puede leer sobre ellos y otras opciones de computaci√≥n paralela en <strong>R</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">aqu√≠</a> . </p><br><p>  En resumen, tomamos solo <strong>3 pasos</strong> : <br>  <strong>Paso 1</strong>  Registrar n√∫cleos <del>  Esmeralda pura </del>  CPU para trabajar en computaci√≥n paralela a trav√©s de <strong>registerDoParallel</strong> (en nuestro caso, primero detectamos el n√∫mero de n√∫cleos en el caso) </p><br><div class="spoiler">  <b class="spoiler_title">Registrar n√∫cleos de CPU</b> <div class="spoiler_text"><pre> <code class="python hljs">numCores &lt;- detectCores() registerDoParallel(numCores)</code> </pre> </div></div><br><p>  <strong>Paso 2</strong>  Comenzamos el ciclo a trav√©s de <strong>foreach</strong> (no olvide especificar el operador <strong>% dopar%</strong> para que el ciclo se ejecute en paralelo e indique, a trav√©s del par√°metro <strong>.combine, la</strong> forma en que recopilaremos el resultado).  En nuestro caso <strong>.combine = rbind</strong> , porque en la salida de cada bucle tendremos un <strong>marco de datos</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de recuperaci√≥n de la tabla de errores</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      VNX   ip   . #      ,      #   ,      dataframe #  %dopar%   . #    ,   system.time   , #    %dopar%  %do%.      4-5. # system.time({ errors_df &lt;- foreach(i = 1:nrow(VNX_ip), .combine = rbind, .packages = "tidyverse") %dopar% { errors_raw &lt;- system( paste( "NaviSECCli.exe -scope 0 -h", VNX_ip$cntIP[i], "-user myusername -password mypassword getlog -date", bigPeriodForm, currDateForm ), intern = TRUE ) %&gt;% str_subset(pattern = regex(paste0(errorNumbers, collapse = "|"))) #      ,       if (length(errors_raw) &gt; 0) { #     #       , #     , #       . errorsDescr &lt;- errors_raw %&gt;% gsub("(.*\\) )(.*)(\\s+\\[.*)", "\\2", x = .) %&gt;% trimws() %&gt;% gsub('([[:punct:]])|\\s+', '_', .) #           errors &lt;- errors_raw %&gt;% str_split(pattern = "\\s+", simplify = T) %&gt;% as_tibble() %&gt;% mutate(Disk = paste0(V4, "_", V6, "_", V8) %&gt;% gsub( pattern = "\\([0-9]{3}\\)", replacement = "", x = .) ) #  dataframe    data_frame(cl = VNX_ip$cl[i], Storage = VNX_ip$Name[i], Date = errors$V1 %&gt;% as.Date(format = "%m/%d/%Y"), Time = errors$V2, Disk = errors$Disk, Error = errorsDescr, eCode = errors$V8 %&gt;% str_extract(paste0(errorNumbers, collapse = "|")) %&gt;% str_extract("[0-9]+")) %&gt;% mutate(DateTime = as.POSIXct(paste(Date, Time), format = "%Y-%m-%d %H:%M:%S")) } } # })</span></span></code> </pre> </div></div><br><p>  <strong>Paso 3</strong>  <strong>Limpiamos el</strong> cl√∫ster de paralelismo creado a trav√©s de <strong>stopImplicitCluster ()</strong> </p><br><h4 id="chut-podrobnee-po-poluchenii-chitaemoy-tablicy-iz-raw-teksta-oshibok">  Un poco m√°s de detalle sobre c√≥mo obtener una tabla legible del texto de error sin formato </h4><br><p>  En forma de texto, los errores son los siguientes: </p><br><pre> <code class="python hljs">head(errors_raw) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841d1080 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841e1a00 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 8420b600 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 84206900 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">5</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841fc900 10006 "</span></span> [<span class="hljs-number"><span class="hljs-number">6</span></span>] <span class="hljs-string"><span class="hljs-string">"07/13/2019 00:01:46 Bus 0 Enclosure 3 Disk 9(801) Soft SCSI Bus Error [0x00] 841fc000 10006</span></span></code> </pre> <br><p>  Aqu√≠ tenemos valores separados por un espacio que, a primera vista, incluso en <em>csv se</em> insertar√° normalmente.  Pero no es tan simple.  La complejidad de analizar aqu√≠ es que: </p><br><ul><li>  la fecha y la hora tambi√©n est√°n separadas por un espacio (el m√°s peque√±o de los males); </li><li>  el texto del error consta de "palabras", es decir  tambi√©n separados por un espacio; </li><li>  por alguna raz√≥n no hay espacio entre el n√∫mero de disco y el c√≥digo de error (que est√° entre par√©ntesis). <br>  En general, un para√≠so para los amantes de las expresiones regulares :) </li></ul><br><p><img src="https://habrastorage.org/webt/yk/rf/2i/ykrf2irog7eq_o3j3d0-ijnild0.jpeg" alt="Bastardo enfermo"></p><br><p>  No me detendr√© en el an√°lisis, porque es cuesti√≥n de gustos, pero aclarar√© que el texto del error tuvo que separarse, ya que los valores ubicados entre el par√©ntesis de cierre del n√∫mero de error y el corchete de apertura de alg√∫n otro valor.  En un bucle, esta es la variable de <strong>errores</strong> . </p><br><p>  Tambi√©n es un punto interesante que, para la conveniencia de formar el marco de datos final, nosotros, que queremos recorrer las direcciones IP de los controladores, establecemos la secuencia no a trav√©s de la columna con las direcciones IP de los controladores (es decir, <strong>i = VNX_ip $ cntIP</strong> ), sino a trav√©s del n√∫mero de l√≠nea (es decir, e. <strong>i = 1: nrow (VNX_ip)</strong> ).  Esto nos permite agregar el n√∫mero de cl√∫ster y el nombre de almacenamiento a trav√©s de las llamadas <strong>VNX_ip $ cl [i]</strong> y <strong>VNX_ip $ Name [i],</strong> respectivamente, al crear un marco de datos con errores ya analizados.  Sin esto, las uniones tendr√≠an que hacerse, lo que ser√≠a m√°s lento y peor le√≠do en el c√≥digo. </p><br><p>  Al final, obtenemos un marco de datos (para ser sincero, luego <strong>tibble</strong> , pero la diferencia est√° m√°s all√° del alcance del art√≠culo), que contiene todos los datos que necesitamos.  Es decir  en qu√© sistema de almacenamiento, en qu√© disco, cu√°ndo ocurri√≥ el error. </p><br><div class="spoiler">  <b class="spoiler_title">Vista final Marco de datos</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; errors_df <span class="hljs-comment"><span class="hljs-comment"># A tibble: 2,705 x 8 cl Storage Date Time Disk Error eCode DateTime &lt;chr&gt; &lt;chr&gt; &lt;date&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dttm&gt; 1 XclNam~ XStorageN~ 2019-07-18 12:09:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 12:09:55 2 XclNam~ XStorageN~ 2019-07-18 15:09:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 15:09:56 3 XclNam~ XStorageN~ 2019-07-18 16:28:~ 0_1_3 Soft_SCSI_~ 801 2019-07-18 16:28:50 4 XclNam~ XStorageN~ 2019-07-19 06:36:~ 0_1_6 Soft_SCSI_~ 801 2019-07-19 06:36:39 5 XclNam~ XStorageN~ 2019-07-19 20:57:~ 0_1_6 Soft_Media~ 820 2019-07-19 20:57:35 6 XclNam~ XStorageN~ 2019-07-22 11:00:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 11:00:43 7 XclNam~ XStorageN~ 2019-07-22 11:00:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 11:00:44 8 XclNam~ XStorageN~ 2019-07-22 12:02:~ 0_2_~ Soft_SCSI_~ 801 2019-07-22 12:02:31 9 XclNam~ XStorageN~ 2019-07-23 23:29:~ 0_3_8 Soft_SCSI_~ 801 2019-07-23 23:29:49 10 XclNam~ XStorageN~ 2019-07-13 00:01:~ 0_3_9 Soft_SCSI_~ 801 2019-07-13 00:01:46 # ... with 2,695 more rows</span></span></code> </pre> </div></div><br><p>  Lo m√°s inteligente es que el ciclo completo de sondeo paralelo de todos los sistemas de almacenamiento <strong>no</strong> lleva <strong>30 minutos, sino 30 segundos</strong> . </p><br><p>  <em>Gracias a Dios que este no es el caso cuando 30 segundos son demasiado r√°pidos.</em> <br><img src="https://habrastorage.org/webt/pr/nf/u9/prnfu9eet3au2ktv5-uk1vauskk.jpeg" alt="una broma"></p><br><p>  Vale la pena aclarar que el c√≥digo de <strong>PowerShell</strong> tambi√©n recopil√≥ los n√∫meros de serie de los discos de todos los sistemas de almacenamiento en un ciclo, y al momento de reescribir el c√≥digo en <strong>R,</strong> estos datos eran redundantes.  Por lo tanto, la comparaci√≥n del tiempo de ejecuci√≥n no es del todo honesta, pero sigue siendo impresionante. </p><br><h3 id="4-5-obrabotka-i-preobrazovanie-dannyh-formirovanie-xlsx-dokumenta">  4-5.  Procesamiento y conversi√≥n de datos.  Generando un documento xlsx </h3><br><p>  La conversi√≥n de datos para documentos xlsx se redujo al filtrado de la tabla de origen en los √∫ltimos 3 d√≠as, as√≠ como en el √∫ltimo mes y la conversi√≥n de las columnas con los nombres de error al formato "horizontal", de modo que cada tipo de error estaba en una columna separada.  Se escribi√≥ una funci√≥n separada para esto (para no duplicar los mismos pasos 2 veces) </p><br><div class="spoiler">  <b class="spoiler_title">Funci√≥n de filtrado de origen</b> <div class="spoiler_text"><pre> <code class="python hljs">myErrorStats &lt;- function(data, period, orderColname = quo(Soft_Media_Error)) { data %&gt;% filter(Date &gt; period) %&gt;% group_by(cl, Storage, Disk, Error) %&gt;% summarise(count = n()) %&gt;% spread(Error, count, fill = <span class="hljs-number"><span class="hljs-number">0</span></span>) %&gt;% arrange(desc(!!orderColname)) }</code> </pre> </div></div><br><p>  Para mostrar los tipos de errores en una columna separada, la funci√≥n de <strong>propagaci√≥n</strong> se aplic√≥ con la tecla adicional <strong>fill = 0</strong> , con la cual los valores faltantes se completaron con <strong>0</strong> .  Sin esta clave, si alg√∫n d√≠a no hubiera alg√∫n tipo de error, la columna correspondiente tendr√≠a valores de <strong>NA</strong> . </p><br><p>  Adem√°s, en la funci√≥n quer√≠a mantener la capacidad de pasar el nombre de la columna para ordenar como variable, pero al mismo tiempo tener valores predeterminados para esta variable.  Para esto, <strong>se utiliza</strong> la peculiar sintaxis <strong>dplyr</strong> , sobre la cual puede leer m√°s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">aqu√≠</a> . </p><br><p>  En nuestro caso, al definir los par√°metros de una funci√≥n, establecemos uno de ellos en el valor predeterminado y lo <strong>citamos</strong> ( <strong>orderColname = quo (Soft_Media_Error)</strong> ), y luego, cuando se llama, ¬°pone caracteres delante de √©l <strong>!</strong>  para <strong>organizar (desc (!! orderColname))</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">La aparici√≥n de la tabla con errores para el mes.</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; errorsBigPeriod <span class="hljs-comment"><span class="hljs-comment"># A tibble: 77 x 7 cl Storage Disk Hard_SCSI_Bus_E~ Recommend_Disk_~ Soft_Media_Error &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; 1 XclN~ XStora~ 1_1_~ 0 1 64 2 XclN~ XStora~ 0_2_5 0 0 29 3 XclN~ XStora~ 1_1_~ 0 1 29 4 XclN~ XStora~ 0_3_2 0 0 27 5 XclN~ XStora~ 0_3_~ 1 0 25 6 XclN~ XStora~ 1_3_5 0 1 23 7 XclN~ XStora~ 0_2_9 0 0 21 8 XclN~ XStora~ 0_3_4 0 0 14 9 XclN~ XStora~ 0_1_~ 0 0 14 10 XclN~ XStora~ 1_0_1 0 0 12 # ... with 67 more rows, and 1 more variable: Soft_SCSI_Bus_Error &lt;dbl&gt;</span></span></code> </pre> </div></div><br><p>  Analic√© la formaci√≥n del documento xlsx en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo sobre informes sobre el estado de la VM</a> , por lo que no me detendr√© en detalle.  Todo el c√≥digo se da al final del art√≠culo. </p><br><p><img src="https://habrastorage.org/webt/td/7v/vx/td7vvxmj5guiwtxhjyxif4cany8.jpeg"></p><br><p>  Estas son caracter√≠sticas importantes que aumentan la legibilidad del informe: </p><br><ul><li>  Pesta√±as firmadas (por defecto, la m√°s interesante est√° abierta); </li><li>  Nombres de columna resaltados </li><li>  Formateo autom√°tico de todas las columnas para que todo el texto sea legible sin tener que expandir las columnas. </li></ul><br><h3 id="6-formiruem-grafik-kotoryy-sohranyaem-v-png">  6. crea un horario que guardamos en png </h3><br><p>  En el gr√°fico, quer√≠a obtener el n√∫mero total de errores por d√≠a para todos los sistemas de almacenamiento por tipo.  Como herramienta de dibujo, se decidi√≥ utilizar la biblioteca est√°ndar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">ggplot2</a> . </p><br><p>  La primera versi√≥n del gr√°fico mostr√≥ todos los errores en un gr√°fico y se ve√≠a as√≠: </p><br><p><img src="https://habrastorage.org/webt/7t/jc/aj/7tjcajacotjzcoo3y0j9oc2od80.png"></p><br><p>  Los colegas dijeron que result√≥ ilegible. <br><del>  ¬øQu√© iban a entender? </del><br>  Se tomaron en cuenta las <strong>observaciones y</strong> se agreg√≥ la funci√≥n <strong>facet_grid</strong> a las columnas est√°ndar ( <strong>geom_bar</strong> ) para dividir el resultado en gr√°ficos separados por tipo de error. <br>  El resultado final fue adecuado para todos. </p><br><p><img src="https://habrastorage.org/webt/l1/vc/v5/l1vcv5950ji9iymrlyrij0uds3w.png" alt="Calendario resumen"></p><br><div class="spoiler">  <b class="spoiler_title">Preparaci√≥n de datos, gr√°ficos, guardar en archivo</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">####   #### #       errorsTotal &lt;- errors_df %&gt;% group_by(Date, Error) %&gt;% summarise(count = n()) %&gt;% # spread(Error, count, fill = 0) %&gt;% arrange(desc(Date)) #        . #       ,   . plot &lt;- errorsTotal %&gt;% ggplot(aes(x = Date, y = count, fill = Error)) + geom_bar(stat = "identity", width = 0.5, color = "grey") + theme_minimal() + # theme(legend.position="top") + scale_color_grey() + labs(title = "  EMC VNX", subtitle = "        ", fill = " ") + xlab("") + ylab("   ") + scale_fill_brewer(palette = "Spectral") + facet_grid(rows = vars(factor( Error, levels = c( "Soft_SCSI_Bus_Error", "Soft_Media_Error", "Hard_SCSI_Bus_Error", "Recommend_Disk_Replacement" ) ))) # #   # plot #   png,     plot_filePath &lt;- file.path("results", "plot.png") #    png     ggsave(filename = plot_filePath, plot = plot)</span></span></code> </pre> </div></div><br><p>  De lo interesante en la formaci√≥n del horario. </p><br><p>  Quer√≠a que los gr√°ficos estuvieran en cierto orden.  Para hacer esto, el par√°metro de formaci√≥n de filas en <strong>facet_grid</strong> tuvo que transferirse como un factor, o m√°s bien incluso como un <strong>factor ordenado</strong> .  Factor es un formato de datos tan astuto en R, que es un conjunto de valores (en nuestro caso, cadenas, es decir, <strong>caracteres</strong> ), y el conjunto de estos valores est√° estrictamente definido (llamados niveles de factor), e incluso estos niveles est√°n ordenados.  Suena complicado, pero todo encaja si dices que los nombres de los meses son un gran ejemplo de un factor ordenado.  Es decir  sabemos qu√© nombres pueden tener los meses, y tambi√©n sabemos (bueno, espero) que primero llegue enero, luego febrero, luego marzo, etc.  Es sobre el mismo principio que creamos un factor. </p><br><h3 id="7-8-formiruem-pismo-soderzhaschee-sobrannye-dannye-otpravlyaem-pismo">  7-8.  Formamos una carta que contiene los datos recopilados.  Enviar una carta </h3><br><p>  La formaci√≥n y el env√≠o de cartas, as√≠ como la formaci√≥n de tareas en el programador de <strong>Windows</strong> tambi√©n se consider√≥ en el art√≠culo sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informes sobre el estado de VM</a> .  Simplemente ponemos algunas variables en el texto y lo formateamos m√°s o menos claramente.  No olvides el archivo adjunto. </p><br><div class="spoiler">  <b class="spoiler_title">La forma final de la carta.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/w6/rg/fi/w6rgfilewjuf24olnavadpu6zhm.jpeg"></p></div></div><br><h2 id="vyvody">  Conclusiones </h2><br><p>  <strong>Una</strong> vez m√°s, <strong>R</strong> demostr√≥ ser una herramienta universal para realizar tareas cotidianas y visualizar sus resultados.  Y con la computaci√≥n paralela habilitada, esta herramienta tambi√©n se vuelve r√°pida. <br>  La pr√°ctica tambi√©n ha demostrado que <strong>PowerShell</strong> es extremadamente lento para analizar registros y traducirlos a un formato legible. <br>  Muchas gracias a todos los que leyeron tantas cartas hasta el final. </p><br><h4 id="polnostyu-kod-prilozheniya">  C√≥digo de aplicaci√≥n completo </h4><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de aplicaci√≥n R completo</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#### ENV #### #         (    system32) setwd("C:\\Scripts\\VNX_disks_check/") #   library(tidyverse) library(lubridate) library(zoo) library(stringi) library(xlsx) library(mailR) library(foreach) library(doParallel) #### CONST #### #            vnxIPfilePath &lt;- file.path("data", "VNX-IP.csv") #     bigPeriod &lt;- Sys.Date() - 30 #     smallPeriod &lt;- Sys.Date() - 3 #    productCls &lt;- c("name1", "name2", "name3") #   IP VNX. #         , #   ip        . VNX_ip &lt;- vnxIPfilePath %&gt;% read_csv2( col_types = cols( Name = col_character(), IP = col_character(), cl = col_character(), type = col_character(), newA = col_character(), newB = col_character(), oldA = col_character(), oldB = col_character() ) ) %&gt;% filter(cl %in% productCls) %&gt;% gather(key = "cntName", value = "cntIP", 5:6) ####    VNX #### #         (      ) # NaviSECCli.exe -scope 0 -h 10.201.16.15 -user root -password Secrt4yo getlog -date 07/16/2019 07/17/2019 #   ,   . #      ,       errorNumbers &lt;- c("\\(820\\)", "\\(803\\)", "\\(801\\)", "\\(920\\)", "\\(901\\)") ##   ## #         numCores &lt;- detectCores() registerDoParallel(numCores) #    ,   NaviCLI #  1    ,     "" , # ..   ,      ,     . bigPeriodForm &lt;- bigPeriod %&gt;% format(format = "%m/%d/%Y") currDateForm &lt;- (Sys.Date() + 1) %&gt;% format(format = "%m/%d/%Y") #    . #      VNX   ip   . #      ,      #   ,      dataframe #  %dopar%   . #    ,   system.time   , #    %dopar%  %do%.      4-5. # system.time({ errors_df &lt;- foreach(i = 1:nrow(VNX_ip), .combine = rbind, .packages = "tidyverse") %dopar% { errors_raw &lt;- system( paste( "NaviSECCli.exe -scope 0 -h", VNX_ip$cntIP[i], "-user myusername -password mypassword getlog -date", bigPeriodForm, currDateForm ), intern = TRUE ) %&gt;% str_subset(pattern = regex(paste0(errorNumbers, collapse = "|"))) #      ,       if (length(errors_raw) &gt; 0) { #       , #     , #       . errorsDescr &lt;- errors_raw %&gt;% gsub("(.*\\) )(.*)(\\s+\\[.*)", "\\2", x = .) %&gt;% trimws() %&gt;% gsub('([[:punct:]])|\\s+', '_', .) #           errors &lt;- errors_raw %&gt;% str_split(pattern = "\\s+", simplify = T) %&gt;% as_tibble() %&gt;% mutate(Disk = paste0(V4, "_", V6, "_", V8) %&gt;% gsub( pattern = "\\([0-9]{3}\\)", replacement = "", x = .) ) #  dataframe    data_frame(cl = VNX_ip$cl[i], Storage = VNX_ip$Name[i], Date = errors$V1 %&gt;% as.Date(format = "%m/%d/%Y"), Time = errors$V2, Disk = errors$Disk, Error = errorsDescr, eCode = errors$V8 %&gt;% str_extract(paste0(errorNumbers, collapse = "|")) %&gt;% str_extract("[0-9]+")) %&gt;% mutate(DateTime = as.POSIXct(paste(Date, Time), format = "%Y-%m-%d %H:%M:%S")) } } # }) #     .      ,    . stopImplicitCluster() ####  #### #    .    ,     .  . # https://dplyr.tidyverse.org/articles/programming.html myErrorStats &lt;- function(data, period, orderColname = quo(Soft_Media_Error)) { data %&gt;% filter(Date &gt; period) %&gt;% group_by(cl, Storage, Disk, Error) %&gt;% summarise(count = n()) %&gt;% spread(Error, count, fill = 0) %&gt;% arrange(desc(!!orderColname)) } #           .  . errorsBigPeriod &lt;- errors_df %&gt;% myErrorStats(bigPeriod) #             errorsSmallPeriod &lt;- errors_df %&gt;% myErrorStats(smallPeriod) #   ,     errors_filePath &lt;- file.path("results", "VNX_Errors.xlsx") ####  xlsx  #### #    wb&lt;-createWorkbook(type="xlsx") #         TABLE_ROWNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) TABLE_COLNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) + Alignment(wrapText=TRUE, horizontal="ALIGN_CENTER") + Border(color="black", position=c("TOP", "BOTTOM"), pen=c("BORDER_THIN", "BORDER_THICK")) #  t s sheetSmall &lt;- createSheet(wb, sheetName = " 3 ") sheetBig &lt;- createSheet(wb, sheetName = " ") sheetRaw &lt;- createSheet(wb, sheetName = " ") ##   addDataFrame( errorsSmallPeriod %&gt;% as.data.frame(), sheetSmall, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) addDataFrame( errorsBigPeriod %&gt;% as.data.frame(), sheetBig, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) #          DateTime     addDataFrame( errors_df %&gt;% as.data.frame() %&gt;% arrange(desc(DateTime)), sheetRaw, startRow = 1, startColumn = 1, row.names = FALSE, byrow = FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE ) #  ,     autoSizeColumn(sheet = sheetSmall, colIndex=c(1:ncol(errorsSmallPeriod))) autoSizeColumn(sheet = sheetBig, colIndex=c(1:ncol(errorsBigPeriod))) autoSizeColumn(sheet = sheetRaw, colIndex=c(1:ncol(errors_df))) #     .   - . if (file.exists(errors_filePath)) {file.remove(errors_filePath)} #  xlsx  saveWorkbook(wb, errors_filePath) ####   #### #       errorsTotal &lt;- errors_df %&gt;% group_by(Date, Error) %&gt;% summarise(count = n()) %&gt;% # spread(Error, count, fill = 0) %&gt;% arrange(desc(Date)) #         plot &lt;- errorsTotal %&gt;% ggplot(aes(x = Date, y = count, fill = Error)) + geom_bar(stat = "identity", width = 0.5, color = "grey") + theme_minimal() + # theme(legend.position="top") + scale_color_grey() + labs(title = "  EMC VNX", subtitle = "        ", fill = " ") + xlab("") + ylab("   ") + scale_fill_brewer(palette = "Spectral") + facet_grid(rows = vars(factor( Error, levels = c( "Soft_SCSI_Bus_Error", "Soft_Media_Error", "Hard_SCSI_Bus_Error", "Recommend_Disk_Replacement" ) ))) # #   # plot #   png,     plot_filePath &lt;- file.path("results", "plot.png") #    png     ggsave(filename = plot_filePath, plot = plot) ####    #### #    emailRecepientsList &lt;- c("sendall-tech@domain.ru") #      emailParams &lt;- list( from = "login@domain.ru", to = emailRecepientsList, smtpParams = list( host.name = "10.10.10.1", port = 25, user.name = "login@domain.ru", passwd = "mypassword", ssl = FALSE ) ) #     (    ). #     ,          ,     . errorsTotal &lt;- errorsSmallPeriod[-c(1,2,3)] %&gt;% sum() #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  .&lt;/h3&gt; &lt;p&gt;  3    &lt;strong&gt;', errorsTotal, '&lt;/strong&gt;    EMC VNX&lt;/p&gt; &lt;p&gt;       ,      .&lt;/p&gt; &lt;p&gt;  3 : &lt;ul&gt; &lt;li&gt;   3 .   &lt;strong&gt;Soft_Media_Error&lt;/strong&gt;.&lt;/li&gt; &lt;li&gt;  30 .   &lt;strong&gt;Soft_Media_Error&lt;/strong&gt;.&lt;/li&gt; &lt;li&gt; .   &lt;strong&gt;&lt;/strong&gt;.&lt;/li&gt; &lt;/ul&gt;          .   .&lt;/p&gt; &lt;p&gt;&lt;img src="', plot_filePath, '"&gt;&lt;/p&gt; &lt;/html&gt;' ) ####      #### send.mail(from = emailParams$from, to = emailParams$to, subject = "     EMC VNX", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, attach.files = c(errors_filePath), debug = FALSE)</span></span></code> </pre> </div></div><br><h2 id="parametry-okruzheniya-i-versii-ispolzuemogo-po">       </h2><br><ul><li> <strong> </strong> : EMC VNX 5300 </li><li> <strong>    </strong> : NaviCLI-Win-32-x86-en_US-7.31.25.1.29-1 </li><li> <strong>  ,    </strong> : 4*2 CPU, 8 Gb RAM </li></ul><br><div class="spoiler"> <b class="spoiler_title">  R</b> <div class="spoiler_text"><pre> <code class="python hljs">&gt; sessionInfo() R version <span class="hljs-number"><span class="hljs-number">3.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> (<span class="hljs-number"><span class="hljs-number">2019</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span>) Platform: x86_64-w64-mingw32/x64 (<span class="hljs-number"><span class="hljs-number">64</span></span>-bit) Running under: Windows Server <span class="hljs-number"><span class="hljs-number">2012</span></span> R2 x64 (build <span class="hljs-number"><span class="hljs-number">9600</span></span>) Matrix products: default locale: [<span class="hljs-number"><span class="hljs-number">1</span></span>] LC_COLLATE=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> LC_CTYPE=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> LC_MONETARY=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> [<span class="hljs-number"><span class="hljs-number">4</span></span>] LC_NUMERIC=C LC_TIME=Russian_Russia<span class="hljs-number"><span class="hljs-number">.1251</span></span> attached base packages: [<span class="hljs-number"><span class="hljs-number">1</span></span>] parallel stats graphics grDevices utils datasets methods base other attached packages: [<span class="hljs-number"><span class="hljs-number">1</span></span>] taskscheduleR_1<span class="hljs-number"><span class="hljs-number">.4</span></span> pander_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> doParallel_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span> iterators_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> foreach_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> mailR_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>] xlsx_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> stringi_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> zoo_1<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">-6</span></span> lubridate_1<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> wesanderson_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> forcats_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> [<span class="hljs-number"><span class="hljs-number">13</span></span>] stringr_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> dplyr_0<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> purrr_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> readr_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tidyr_0<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> tibble_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> [<span class="hljs-number"><span class="hljs-number">19</span></span>] ggplot2_3<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> tidyverse_1<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> loaded via a namespace (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> attached): [<span class="hljs-number"><span class="hljs-number">1</span></span>] tidyselect_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> reshape2_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> rJava_0<span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span> haven_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> lattice_0<span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">-38</span></span> colorspace_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>] vctrs_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> generics_0<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> utf8_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> rlang_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> R.oo_1<span class="hljs-number"><span class="hljs-number">.22</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> pillar_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> [<span class="hljs-number"><span class="hljs-number">13</span></span>] glue_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> withr_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> R.utils_2<span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> RColorBrewer_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> modelr_0<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> readxl_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">19</span></span>] plyr_1<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> munsell_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> gtable_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> cellranger_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> rvest_0<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> R.methodsS3_1<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">25</span></span>] codetools_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">-16</span></span> labeling_0<span class="hljs-number"><span class="hljs-number">.3</span></span> fansi_0<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> xlsxjars_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> broom_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> Rcpp_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [<span class="hljs-number"><span class="hljs-number">31</span></span>] scales_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> backports_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> jsonlite_1<span class="hljs-number"><span class="hljs-number">.6</span></span> digest_0<span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span> hms_0<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> grid_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> [<span class="hljs-number"><span class="hljs-number">37</span></span>] cli_1<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> tools_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> magrittr_1<span class="hljs-number"><span class="hljs-number">.5</span></span> lazyeval_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> crayon_1<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> pkgconfig_2<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> [<span class="hljs-number"><span class="hljs-number">43</span></span>] zeallot_0<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> data.table_1<span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> xml2_1<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> assertthat_0<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> httr_1<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> rstudioapi_0<span class="hljs-number"><span class="hljs-number">.10</span></span> [<span class="hljs-number"><span class="hljs-number">49</span></span>] R6_2<span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> nlme_3<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">-137</span></span> compiler_3<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/461441/">https://habr.com/ru/post/461441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461431/index.html">"Ama y no le gusta": DNS sobre HTTPS</a></li>
<li><a href="../461433/index.html">Uso de Identity Server 4 en Net Core 3.0</a></li>
<li><a href="../461435/index.html">Reconocimiento de emociones usando una red neuronal convolucional</a></li>
<li><a href="../461437/index.html">370 bombillas</a></li>
<li><a href="../461439/index.html">Inicio de la biblioteca de componentes React y TypeScript</a></li>
<li><a href="../461443/index.html">An√°lisis posterior: lo que se sabe sobre el √∫ltimo ataque a la red del servidor de claves criptogr√°ficas SKS Keyserver</a></li>
<li><a href="../461447/index.html">La √©pica sobre los administradores del sistema como una especie en peligro de extinci√≥n.</a></li>
<li><a href="../461449/index.html">PhpStorm 2019.2: Propiedades tipificadas de PHP 7.4, Buscador duplicado, EditorConfig, Shell Scripts y m√°s</a></li>
<li><a href="../461451/index.html">Mi segundo d√≠a con Haiku: encantado, pero a√∫n no estoy listo para ir</a></li>
<li><a href="../461453/index.html">Aventuras de Baikonur: cohetes, astronautas, lanzamiento de la Uni√≥n MS-13 e Internet espacial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>