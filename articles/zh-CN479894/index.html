<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👉🏼 🤶🏾 🔥 从Hyper-V到VMware，反之亦然：转换虚拟磁盘 👨🏿‍🤝‍👨🏾 👐🏿 📥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="哈Ha！ 

 我不时从实践工程师那里听到一些奇怪的东西：VMDK，VHD和VHDX是完全不同的虚拟磁盘格式，几乎是封闭的，并且很难将它们相互转换。 今天，我将证明事实并非如此，我将弄清楚这些格式如何相互关联，以及从Hyper-V迁移到VMware时如何进行快速转换，反之亦然。 

 有点理论。 从...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>从Hyper-V到VMware，反之亦然：转换虚拟磁盘</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/479894/"><img src="https://habrastorage.org/webt/xs/fo/hq/xsfohqeyqsuronjrbjou2t4hpqw.jpeg"><br><br> 哈Ha！ <br><br> 我不时从实践工程师那里听到一些奇怪的东西：VMDK，VHD和VHDX是完全不同的虚拟磁盘格式，几乎是封闭的，并且很难将它们相互转换。 今天，我将证明事实并非如此，我将弄清楚这些格式如何相互关联，以及从Hyper-V迁移到VMware时如何进行快速转换，反之亦然。 <br><br> 有点理论。 从属性的角度来看，虚拟磁盘分为两种类型： <br><br><ul><li> 薄（动态磁盘）和 </li><li> 厚（固定磁盘）。 其他所有内容-差异，厚置备的延迟清零-只是该主题的变体。 </li></ul><a name="habracut"></a><br> 我不会在此详述。 我只能说，我们将进一步讨论厚磁盘。 <br><br><h3> 光盘格式 </h3><br>  <b>RAW-</b>任何驱动器的“原始”图像。 这是一个常规容器，不包含任何特定的页眉和页脚，并“按原样”表示磁盘映像。 如果使用HEX编辑器打开此类图像，我们将立即看到GPT / MBR和/或文件系统的标题。 完全相同的映像是通过Linux上的dd命令获得的。  RAW在这方面对我们绝对是诚实的。 <br><br><img src="https://habrastorage.org/webt/0o/e8/97/0oe897bapic5h0tljstnmhezofk.png"><br>  <i>RAW文件的开头。</i> <br><br><img src="https://habrastorage.org/webt/d4/6a/-6/d46a-6wkfji6gv7t_i4na83c4is.png"><br>  <i>RAW文件末尾。</i> <br><br>  <b>VMDC。</b>  VMware ESXi是普通的RAW，其中磁盘几何形状在常规文本文件描述符（描述符）中描述。 当我们将虚拟磁盘连接到虚拟机或浏览数据存储上目录的内容时，便会在vSphere Console中看到他的名字。  VMware ESXi对映像不执行任何操作。 绝对是 磁盘自行放置并根据需要扩展。 按照VMware的最佳传统，描述符格式非常简单： <br><br><pre><code class="plaintext hljs"># Disk DescriptorFile version=1 encoding="UTF-8" CID=fffffffe parentCID=ffffffff isNativeSnapshot="no" createType="vmfs"  # Extent description RW 15122560 VMFS "disk-example-flat.vmdk"  # The Disk Data Base #DDB ddb.adapterType = "lsilogic" ddb.geometry.cylinders = "941" ddb.geometry.heads = "255" ddb.geometry.sectors = "63" ddb.longContentID = "4f5dc83d0a5270bee54e2d85fffffffe" ddb.uuid = "60 00 C2 93 b4 38 ed dd-a3 85 88 48 68 40 2f c0" ddb.virtualHWVersion = "13"</code> </pre> <br> 它不仅简单，而且功能强大：足以在描述符文件中做注释，以将虚拟磁盘扩展为任何受支持的值。 这样，您就可以用零填充磁盘或将磁盘标记为薄磁盘，而不必在磁盘头中保留几何信息。 <br><br> 以下是描述符所有部分的一些标准值： <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>部分</b> <br></td><td>  <b>参量</b> <br></td><td>  <b>内容描述</b> <br></td><td>  <b>价值</b> <br></td></tr><tr><td> 标头（＃磁盘描述符文件） <br></td><td> 版本号 <br></td><td> 指定描述符的版本号。 通常不会改变。 <br></td><td>  1（默认） <br></td></tr><tr><td>  Cid <br></td><td> 内容编号 构建快照树涉及的随机32位磁盘标识符。 是子增量磁盘的ParentCID。 <br></td><td> 创建时生成的随机32位值。 <br></td></tr><tr><td>  parentCID <br></td><td> 父驱动器的CID。 如果没有父磁盘，则设置CID_NOPARENT标志（ffffffff）。 <br></td><td>  Ffffffff（CID_NOPARENT） <br> 父驱动器的CID。 <br></td></tr><tr><td>  createType <br></td><td> 指向描述符中描述的磁盘类型的指针（它可能是物理磁盘，差异磁盘，甚至是VMDK磁盘阵列）。 对于ESXi，属性集受到限制。 <br></td><td> 对于ESXi，请使用vmfs（对于虚拟磁盘）或vmfsRawDeviceMap和vmfsPassthroughRawDeviceMap（对于RDM）。 <br></td></tr><tr><td>  isNativeSnapshot <br></td><td> 标记完成快照的方式：VMkernel或存储方式（VAAI）。 <br></td><td> 否（VMkernel）， <br> 是的（VAAI） <br></td></tr><tr><td> 范围（＃范围描述） <br></td><td><br></td><td> 该部分包含驱动器路径，访问类型和大小。 格式： <br>  &lt;访问类型&gt; &lt;大小&gt; &lt;扩展类型&gt; &lt;VMDK文件或设备的路径&gt; &lt;偏移&gt;。 <br></td><td><br></td></tr><tr><td> 访问权限 <br></td><td> 磁盘访问类型。 <br></td><td>  RW（读/写） <br>  RO（只读） <br>  NOACCESS（访问被拒绝）。 <br></td></tr><tr><td> 尺码 <br></td><td> 磁碟大小 <br></td><td> 指示了虚拟磁盘的逻辑扇区数。 它由以下公式计算： <br>  &lt;以字节为单位的大小&gt; / &lt;逻辑扇区的大小&gt; <br>  <a href="https://www.vmware.com/app/vmdk/%3Fsrc%3Dvmdk">在此处</a>阅读有关计算磁盘几何形状的更多信息。 <br></td></tr><tr><td> 范围类型 <br></td><td> 指向磁盘模式的指针。 <br></td><td> 可能有价值 <br> 平，稀疏，零，VMFS，VMFSSPARSE，VMFSRDM，VMFSRAW。 <br></td></tr><tr><td> 档名 <br></td><td>  VMDK文件的路径。 <br></td><td><br></td></tr><tr><td> 偏移量 <br></td><td> 如果需要指定来宾OS数据的起始偏移量，则使用它。 对于虚拟磁盘，通常为0（或未指定）。 对于RDM可能为非零。 <br></td><td> 相对于数据块开始之前磁盘起始位置的字节偏移量。 <br></td></tr><tr><td> 磁盘数据库（＃磁盘数据库） <br></td><td><br></td><td> 描述虚拟磁盘的几何形状。 <br></td><td><br></td></tr><tr><td>  ddb.adapterType <br></td><td>  VM虚拟SCSI适配器的类型。 <br></td><td> 仅支持3种类型： <br>  ide <br> 商业逻辑 <br> 逻辑学 <br><br> 此外，VMware Paravirtual适配器始终标记为lsilogic。 <br></td></tr><tr><td>  ddb.geometry.cylinders <br>  ddb.geometry.heads =“ 255” <br>  ddb.geometry.sectors =“ 63” <br></td><td> 用于描述虚拟磁盘的几何结构的柱面数，磁头数和扇区数。 <br></td><td> 有关计算磁盘几何形状的详细信息在<a href="https://www.vmware.com/app/vmdk/%3Fsrc%3Dvmdk">此处</a> 。 <br></td></tr><tr><td>  ddb.thinProvisioned <br></td><td> 精简磁盘标志。 <br></td><td>  1-磁盘很薄， <br>  0或不存在-厚磁盘 <br></td></tr><tr><td>  ddb.uuid <br></td><td> 描述符ID <br></td><td><br></td></tr><tr><td>  ddb.virtualHWVersion <br></td><td> 虚拟硬件版本 <br></td><td><br></td></tr></tbody></table></div><br> 可以在格式规范中找到所有值的描述： <a href="https://www.vmware.com/app/vmdk/%3Fsrc%3Dvmdk">VMware Virtual Disk Format 1.1</a> <br><br>  <b>Vhd。</b> 厚VHD是相同的RAW，但具有512字节的页脚，用于描述磁盘的几何形状。  Microsoft Hyper-V虚拟机没有单独的描述符文件。 磁盘几何形状的描述需要4个字节。 实际上，从这里开始，磁盘大小限制为2 TB。 <br><br><img src="https://habrastorage.org/webt/r4/_z/04/r4_z04hiog10hoi2l579iyrmd1c.png"><br>  <i>页脚。</i>  <i>磁盘的最后512字节。</i> <br><br> 最有趣的是，如果创建描述符文件并将带有页脚的VHD磁盘滑入ESXi，则VMware虚拟机管理程序将忽略此页脚并将VHD作为本机。 <br><br> 当Storage vMotion将磁盘转换为精简磁盘时，它仅切断该页脚，并且在输出端我们得到相同的RAW，但末尾没有零。 而当转换为厚磁盘时-诚实的RAW。 这是我稍后要演示的内容。 <br><br>  <b>VHDX。</b> 所有磁盘几何信息都存储在虚拟磁盘的前4096 KB中-头区域。 <br><br><img src="https://habrastorage.org/webt/ox/ym/1r/oxym1rx0yugtthlby1q12svpkhy.png"><br>  <i>VHDX厚磁盘的一般方案。</i> <br><br> 这个区域是什么样的？ 它包含标头的两个副本及其日志，BAT和元数据区域很常见。 <br><br><img src="https://habrastorage.org/webt/qo/nj/v6/qonjv68pmpjykfcltu2rijdy7mg.png"><br>  <i>磁盘头的逻辑结构。</i> <br><br> 在时间单位中，只有一个副本头处于活动状态。 如果在读/写操作中计划外中断，则可以提供一定程度的标题容错能力。 每次I / O操作之后，将复制副本并对其进行切换。 <br><br><img src="https://habrastorage.org/webt/co/er/bb/coerbb6uef8wvkb7dsi1kzlcxda.png"><br>  <i>标头区域的布局。</i> <br><br> 要将VHDX转换为RAW，我们只需要剪切前4096 KB。 <br><br><img src="https://habrastorage.org/webt/ri/jk/1-/rijk1-iv3jiez0dicdlns3trqpe.png"><br>  <i>从5 MB开始数据。</i> <br><br> 细心的读者当然会说：好的，Zhenya，但是弱地将RAW转换为VHDX？ 我将回答：取决于文件系统以及它允许​​您将数据写入文件开头的数量。 在NTFS文件系统上手动进行操作，可以通过将文件的开头在MFT中向前移4 MB并将标头附加到该位置来完成。 <br><br>  <a href="https://www.systola.ru/support/kb100005/">vhdxtool.exe</a>实用程序的工作原理相同<a href="https://www.systola.ru/support/kb100005/">。</a> 但是，通过这种转换，我们将无法获得4 MB标头和RAW形式的精美图片。 该磁盘将可见，甚至可以作为VHDX正常工作，但是由于偏移操作，也会出现很多零的“垃圾”。 该驱动器将不会优化。 建议将具有此类磁盘的VM迁移到另一个卷，或通过Convert-VHD或Optimize-VHD cmdlet对其进行优化。 如果不这样做，磁盘将占用更多的空间，并且工作速度可能会更慢。 <br><br> 但是，在从VMware迁移到Hyper-V的情况下，此实用程序必不可少，因为它允许就地转换，而无需字节来读取源磁盘并创建附近的副本。 在首次存储实时迁移时，所有粗糙度将被消除。 <br><br>  <b>结论：</b> VMDK，VHD，VHDX格式的厚磁盘实际上彼此没有太大区别。 它们基于具有各种添加剂的RAW。 使用与文件系统相同的HEX编辑器或OS功能，我们可以在几秒钟内将10 Tb VMDK或VHDX转换为目标虚拟机监控程序磁盘。 <br><br> 让我们看一下VMware Exsi如何处理VHD。 <br><br><ol><li> 作为示例，我使用<a href="">Convert-WindowsImage</a>创建了Windows Server映像，并注入了VMware驱动程序和参数： <br><br><ul><li> 操作系统版本：Windows Server 2019 Standard </li><li> 磁盘类型：固定， </li><li> 磁盘布局：GPT， </li><li> 磁盘大小：30GB。 </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/7dd/463/979/7dd463979b824631f72dc3e07d821d87.png"><br>  <i>注意参数FileSize（实际文件大小）和Size（以VM表示的磁盘大小）。</i>  <i>值之间的差异恰好是512字节-页脚VHD的大小。</i> </li><li> 将驱动器重命名为Win2019-test2-flat.vmdk，以将其加载到ESXi数据存储中。 <br><img src="https://habrastorage.org/getpro/habr/post_images/201/209/3e7/2012093e774ea467727395d88ca66dd6.png"></li><li> 接下来，我在VMware ESXi中使用厚（急速归零）磁盘创建一个空VM，以便自动创建VMDK描述符，而不必手动计算柱面。 <br><br><img src="https://habrastorage.org/webt/_o/7h/3r/_o7h3r7hzjarnxzu2ulhshxmcxw.png"></li><li> 我们通过WinSCP连接到主机并替换现有文件： <br><img src="https://habrastorage.org/webt/jg/i9/hh/jgi9hh7y3kf2baf6nc6dpty-vci.png"><br>  <i>一切都是公平的：页脚到位。</i> </li><li> 打开虚拟机，查看操作系统是否启动，没有任何问题。 仅需安装VMware Tools，这将很简单，因为Convert-WindowsImage允许我们安装设备驱动程序。 <br><br><img src="https://habrastorage.org/webt/hh/td/0b/hhtd0bx6ca4fzhkr_qjl8z1oizq.png"></li><li> 通过Storage vMotion将磁盘移动到另一个Datastore，并将其转换为精简磁盘。 <br><br><img src="https://habrastorage.org/webt/-x/2w/li/-x2wli_oyqrl9qdy4sabgb2ilpg.png"></li><li> 检查大小-磁盘变薄。 <br><br><img src="https://habrastorage.org/webt/_b/m2/vh/_bm2vhobiqdotr59i_t1xbu903c.png"></li><li> 如果我们将其转换回厚磁盘或将VM迁移到文件存储，则会得到最纯净的无标题的RAW。 <br><br><img src="https://habrastorage.org/webt/s6/p4/es/s6p4esa78nxqqwuramt6xyrr7fi.png"><br>  <i>页脚折断。</i> </li></ol><br> 相同的焦点适用于通过dd创建的RAW。 甚至是相反的方向。 这样，您可以看到VMware ESXi接受第三方页脚或RAW光盘。 <br><br> 如果您不想要花样，则可以使用下面的工具。 <br><div class="scrollable-table"><table><tbody><tr><td>  <b>源格式</b> <br></td><td>  <b>目标格式</b> <br></td><td>  <b>工具</b> <br></td><td>  <b>命令示例</b> <br></td></tr><tr><td> 甚高频 <br></td><td> 甚高频 <br></td><td>  vhdxtool.exe <br></td><td>  vhdxtool upgrade -f &lt;文件名&gt; .vhd <br></td></tr><tr><td>  VMDK（原始） <br></td><td> 甚高频 <br></td><td>  vhdtool.exe <br></td><td>  vhdtool /转换&lt;文件名平面&gt; .vmdk <br></td></tr><tr><td>  VMDK（原始） <br></td><td> 甚高频 <br></td><td>  vhdtool.exe <br>  vhdxtool.exe <br></td><td>  vhdtool /转换&lt;文件名平面&gt; .vmdk <br><br></td></tr><tr><td>  VHDX（原始） <br></td><td> 甚高频 <br></td><td></td><td>  vhdxtool upgrade -f &lt;文件名&gt; .vhd <br></td></tr></tbody></table></div><br>  <b>总结一下。</b> 厚虚拟磁盘的不同格式没有太大差异。 位于所有RAW核心的各种“添加剂”。 <br><br> 转换虚拟磁盘格式并不令人恐惧，而且正如我所显示的，有时您可以不用它。 <br><br> 所有这些的主要好处是减少了从Hyper-V到VMware的迁移时间（反之亦然），以及迁移期间VM的停机时间。 在DataLine中，我们将VM停机时间控制在30分钟以内。 记录是虚拟机管理程序之间迁移期间VM停机40秒。 <br><br> 只需记住，在不同的管理程序之间迁移时，仅进行一次转换是不够的。 至少，您必须首先安装目标管理程序的集成组件，删除或禁用源管理程序组件的启动，删除源管理程序的虚拟设备，等等。 但这是一个完全不同的故事，我也可以讲述。 <br><br>  <b>有用的链接：</b> <br><br><ul><li>  <a href="https://habr.com/ru/company/acelab/blog/262517/">habr.com/zh/company/acelab/blog/262517</a> </li><li>  <a href="https://www.vmware.com/app/vmdk/%3Fsrc%3Dvmdk">www.vmware.com/app/vmdk/?src=vmdk</a> </li><li>  <a href="http://faq.sanbarrow.com/index.php%3Faction%3Dartikel%26cat%3D43%26id%3D36%26artlang%3Den">faq.sanbarrow.com/index.php?action=artikel&amp;cat=43&amp;id=36&amp;artlang=zh-CN</a> </li><li>  <a href="http://download.microsoft.com/download/f/f/e/ffef50a5-07dd-4cf8-aaa3-442c0673a029/Virtual%2520Hard%2520Disk%2520Format%2520Spec_10_18_06.doc">download.microsoft.com/download/f/f/e/ffef50a5-07dd-4cf8-aaa3-442c0673a029/Virtual%20Hard%20Disk%20Format%20Spec_10_18_06.doc</a> </li><li>  <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-vhdx/83e061f8-f6e2-4de1-91bd-5d518a43d477">docs.microsoft.com/zh-CN/openspecs/windows_protocols/ms-vhdx/83e061f8-f6e2-4de1-91bd-5d518a43d477</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479894/">https://habr.com/ru/post/zh-CN479894/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479884/index.html">自定义CI / CD for Unity</a></li>
<li><a href="../zh-CN479886/index.html">听觉代替视觉：重新配置大脑神经元以适应黑暗</a></li>
<li><a href="../zh-CN479888/index.html">高速弹性压缩（续）</a></li>
<li><a href="../zh-CN479890/index.html">实施物联网概念的问题和任务</a></li>
<li><a href="../zh-CN479892/index.html">关于Gradle插件，分布式系统中的多线程和监视自动化：Yandex.Money metap的视频</a></li>
<li><a href="../zh-CN479896/index.html">星期六：程序员关于经济学，马克思，列宁和资本的思想</a></li>
<li><a href="../zh-CN479898/index.html">赤裸裸的真相</a></li>
<li><a href="../zh-CN479900/index.html">游戏公司中面向客户的Data Lake</a></li>
<li><a href="../zh-CN479902/index.html">IntelliJ IDEA 2019.3：性能优化和质量改进</a></li>
<li><a href="../zh-CN479904/index.html">什么是NFC及其运作方式。 刷新基础知识？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>