<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåé üëéüèæ üîï Implementasi platform perangkat lunak NAS yang aman ü•ö üèÑ üìΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam artikel sebelumnya , desain platform perangkat lunak NAS dijelaskan. 
 Sudah waktunya untuk mengimplementasikannya. 
 Periksa 


 Pastikan untuk...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implementasi platform perangkat lunak NAS yang aman</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415779/"><p><img src="https://habrastorage.org/getpro/habr/post_images/b93/ed1/af9/b93ed1af987a1fda471d1080d6b804e5.jpg"></p><br><p>  Dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel sebelumnya</a> , desain platform perangkat lunak NAS dijelaskan. <br>  Sudah waktunya untuk mengimplementasikannya. </p><a name="habracut"></a><br><h2 id="proverka">  Periksa </h2><br><p>  Pastikan untuk memeriksa kesehatan kolam sebelum memulai: </p><br><pre><code class="hljs lua">zpool <span class="hljs-built_in"><span class="hljs-built_in">status</span></span> -v</code> </pre> <br><p>  Kolam dan semua disk di dalamnya harus ONLINE. </p><br><p>  Lebih lanjut, saya berasumsi bahwa pada tahap sebelumnya semuanya dilakukan sesuai dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">instruksi</a> , dan itu berhasil, atau Anda sendiri sangat mengerti apa yang Anda lakukan. </p><br><h2 id="udobstva">  Fasilitas </h2><br><p>  Pertama-tama, ada baiknya mengurus manajemen yang nyaman jika Anda tidak melakukan ini sejak awal. <br>  Itu akan diperlukan: </p><br><ul><li>  Server SSH: <code>apt-get install openssh-server</code> .  Jika Anda tidak tahu cara mengkonfigurasi SSH, <del>  melakukan NAS di Linux terlalu dini </del>  Anda dapat membaca fitur penggunaannya dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel ini</a> , lalu menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">salah satu manual</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tmux</a> atau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">layar</a> : <code>apt-get install tmux</code> .  Untuk menyimpan sesi saat masuk melalui SSH dan menggunakan beberapa jendela. </li></ul><br><p>  Setelah menginstal SSH, Anda perlu menambahkan pengguna agar tidak masuk melalui SSH sebagai root (input dinonaktifkan secara default dan Anda tidak perlu mengaktifkannya): </p><br><pre> <code class="bash hljs">zfs create rpool/home/user adduser user cp -a /etc/skel/.[!.]* /home/user chown -R user:user /home/user</code> </pre> <br><p>  Untuk administrasi jarak jauh, ini adalah minimum yang cukup. </p><br><p>  Meskipun demikian, Anda harus tetap menyambungkan keyboard dan monitor  Anda juga perlu melakukan reboot ketika memperbarui kernel dan untuk memastikan bahwa semuanya berfungsi segera setelah memuat. </p><br><p>  Alternatifnya adalah menggunakan Virtual KVM, yang menyediakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">IME</a> .  Ada konsol di sana, meskipun dalam kasus saya ini diimplementasikan sebagai applet Java, yang sangat tidak nyaman. </p><br><h2 id="nastroyka">  Kustomisasi </h2><br><h3 id="podgotovka-kesha">  Persiapan cache </h3><br><p>  Sejauh yang Anda ingat, dalam konfigurasi yang dijelaskan oleh saya ada SSD terpisah di bawah L2ARC, yang belum digunakan, tetapi diambil "untuk pertumbuhan". </p><br><p>  Opsional, tetapi disarankan untuk mengisi SSD ini dengan data acak (dalam kasus Samsung EVO, masih akan diisi dengan nol setelah blkdiscard dijalankan, tetapi tidak pada semua SSD seperti ini): </p><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/urandom of=/dev/disk/by-id/ata-Samsung_SSD_850_EVO bs=4M &amp;&amp; blkdiscard /dev/disk/by-id/ata-Samsung_SSD_850_EVO</code> </pre> <br><h3 id="otklyuchenie-szhatiya-logov">  Menonaktifkan Kompresi Log </h3><br><p>  Di ZFS, kompresi sudah digunakan, karena kompresi log melalui gzip jelas akan berlebihan. <br>  Matikan: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/logrotate.d/* ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> grep -Eq <span class="hljs-string"><span class="hljs-string">"(^|[^#y])compress"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> sed -i -r <span class="hljs-string"><span class="hljs-string">"s/(^|[^#y])(compress)/\1#\2/"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><h3 id="obnovlenie-sistemy">  Pembaruan sistem </h3><br><p>  Semuanya sederhana di sini: </p><br><pre> <code class="bash hljs">apt-get dist-upgrade --yes reboot</code> </pre> <br><h3 id="sozdanie-snepshota-dlya-novogo-sostoyaniya">  Membuat snapshot untuk keadaan baru </h3><br><p>  Setelah mem-boot ulang, untuk memperbaiki kondisi kerja yang baru, Anda perlu menulis ulang snapshot pertama: </p><br><pre> <code class="bash hljs">zfs destroy rpool/ROOT/debian@install zfs snapshot rpool/ROOT/debian@install</code> </pre> <br><h2>  Organisasi sistem file </h2><br><h3 id="podgotovka-razdelov-dlya-slog">  Partisi untuk SLOG </h3><br><p>  Hal pertama yang harus dilakukan untuk mencapai kinerja ZFS normal adalah meletakkan SLOG di SSD. <br>  Biarkan saya mengingatkan Anda bahwa SLOG dalam konfigurasi yang digunakan digandakan pada dua SSD: untuk itu, perangkat pada LUKS-XTS akan dibuat di atas bagian ke-4 dari setiap SSD: </p><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/urandom of=/etc/keys/slog.key bs=1 count=4096 cryptsetup --verbose --cipher <span class="hljs-string"><span class="hljs-string">"aes-xts-plain64:sha512"</span></span> --key-size 512 --key-file /etc/keys/slog.key luksFormat /dev/disk/by-id/ata-Samsung_SSD_850_PRO-part4 cryptsetup --verbose --cipher <span class="hljs-string"><span class="hljs-string">"aes-xts-plain64:sha512"</span></span> --key-size 512 --key-file /etc/keys/slog.key luksFormat /dev/disk/by-id/ata-Micron_1100-part4 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"slog0_crypt1 /dev/disk/by-id/ata-Samsung_SSD_850_PRO-part4 /etc/keys/slog.key luks,discard"</span></span> &gt;&gt; /etc/crypttab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"slog0_crypt2 /dev/disk/by-id/ata-Micron_1100-part4 /etc/keys/slog.key luks,discard"</span></span> &gt;&gt; /etc/crypttab</code> </pre> <br><h3 id="podgotovka-razdelov-dlya-l2arc-i-podkachki">  Partisi untuk L2ARC dan Swap </h3><br><p>  Pertama, Anda perlu membuat partisi di bawah swap dan l2arc: </p><br><pre> <code class="bash hljs">sgdisk -n1:0:48G -t1:8200 -c1:part_swap -n2::196G -t2:8200 -c2:part_l2arc /dev/disk/by-id/ata-Samsung_SSD_850_EVO</code> </pre> <br><p>  Partisi swap dan L2ARC akan dienkripsi pada kunci acak, seperti  setelah reboot, mereka tidak diperlukan dan selalu memungkinkan untuk membuatnya kembali. <br>  Oleh karena itu, dalam crypttab, sebuah baris ditulis untuk mengenkripsi / mendekripsi partisi dalam mode biasa: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> swap_crypt /dev/disk/by-id/ata-Samsung_SSD_850_EVO-part1 /dev/urandom swap,cipher=aes-xts-plain64:sha512,size=512 &gt;&gt; /etc/crypttab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> l2arc_crypt /dev/disk/by-id/ata-Samsung_SSD_850_EVO-part2 /dev/urandom cipher=aes-xts-plain64:sha512,size=512 &gt;&gt; /etc/crypttab</code> </pre> <br><p>  Maka Anda perlu me-restart daemon dan mengaktifkan swap: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'vm.swappiness = 10'</span></span> &gt;&gt; /etc/sysctl.conf sysctl vm.swappiness=10 systemctl daemon-reload systemctl start systemd-cryptsetup@swap_crypt.service <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /dev/mapper/swap_crypt none swap sw,discard 0 0 &gt;&gt; /etc/fstab swapon -av</code> </pre> <br><p>  Karena  <code>swapiness</code> tidak digunakan secara aktif pada SSD, parameter <code>swapiness</code> , yang secara default adalah 60, harus diatur ke 10. </p><br><p>  L2ARC belum digunakan pada tahap ini, tetapi bagian untuk itu sudah siap: </p><br><pre> <code class="bash hljs">$ ls /dev/mapper/ control l2arc_crypt root_crypt1 root_crypt2 slog0_crypt1 slog0_crypt2 swap_crypt tank0_crypt0 tank0_crypt1 tank0_crypt2 tank0_crypt3</code> </pre> <br><h3 id="puly-tankn">  Tangki renangn </h3><br><p>  Penciptaan kolam <code>tank0</code> akan dijelaskan, <code>tank1</code> dibuat dengan analogi. </p><br><p>  Agar tidak membuat partisi yang sama secara manual dan menghindari kesalahan, saya menulis <a href="">skrip</a> untuk membuat partisi terenkripsi untuk kumpulan: </p><br><div class="spoiler">  <b class="spoiler_title">create_crypt_pool.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash KEY_SIZE=512 POOL_NAME="$1" KEY_FILE="/etc/keys/${POOL_NAME}.key" LUKS_PARAMS="--verbose --cipher aes-xts-plain64:sha${KEY_SIZE} --key-size $KEY_SIZE" [ -z "$1" ] &amp;&amp; { echo "Error: pool name empty!" ; exit 1; } shift [ -z "$*" ] &amp;&amp; { echo "Error: devices list empty!" ; exit 1; } echo "Devices: $*" read -p "Is it ok? " a [ "$a" != "y" ] &amp;&amp; { echo "Bye"; exit 1; } dd if=/dev/urandom of=$KEY_FILE bs=1 count=4096 phrase="?" read -s -p "Password: " phrase echo read -s -p "Repeat password: " phrase1 echo [ "$phrase" != "$phrase1" ] &amp;&amp; { echo "Error: passwords is not equal!" ; exit 1; } echo "### $POOL_NAME" &gt;&gt; /etc/crypttab index=0 for i in $*; do echo "$phrase"|cryptsetup $LUKS_PARAMS luksFormat "$i" || exit 1 echo "$phrase"|cryptsetup luksAddKey "$i" $KEY_FILE || exit 1 dev_name="${POOL_NAME}_crypt${index}" echo "${dev_name} $i $KEY_FILE luks" &gt;&gt; /etc/crypttab cryptsetup luksOpen --key-file $KEY_FILE "$i" "$dev_name" || exit 1 index=$((index + 1)) done echo "###" &gt;&gt; /etc/crypttab phrase="=====================================================" phrase1="=================================================" unset phrase unset phrase1</span></span></code> </pre> </div></div><br><p>  Sekarang, menggunakan skrip ini, Anda perlu membuat kumpulan untuk menyimpan data: </p><br><pre> <code class="bash hljs">./create_crypt_pool.sh zpool create -o ashift=12 -O atime=off -O compression=lz4 -O normalization=formD tank0 raidz1 /dev/disk/by-id/dm-name-tank0_crypt*</code> </pre> <br><p>  Untuk catatan tentang parameter <code>ashift=12</code> , lihat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel</a> dan komentar saya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sebelumnya</a> . </p><br><p>  Setelah membuat kumpulan, saya mengeluarkan log-nya di SSD: </p><br><pre> <code class="bash hljs">zpool add tank0 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> mirror /dev/disk/by-id/dm-name-slog0_crypt1 /dev/disk/by-id/dm-name-slog0_crypt2</code> </pre> <br><p>  Di masa depan, dengan OMV diinstal dan dikonfigurasi, dimungkinkan untuk membuat kumpulan melalui GUI: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bu/bc/qj/bubcqjn_frfc3plifb9ehgzxco0.png" alt="Pembuatan ZFS jatuh dalam OMV WEB GUI"></a> </p><br><h3 id="vklyuchenie-importa-pulov-i-avtomontirovaniya-tomov-pri-zagruzke">  Mengaktifkan kumpulan impor dan volume pemasangan otomatis saat boot </h3><br><p>  Untuk menjamin untuk mengaktifkan kumpulan pemasangan otomatis, jalankan perintah berikut: </p><br><pre> <code class="bash hljs">rm /etc/zfs/zpool.cache systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-import-scan.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-mount.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-import-cache.service</code> </pre> <br><p>  Pada tahap ini, konfigurasi subsistem disk selesai. </p><br><h2>  Sistem operasi </h2><br><p>  Langkah pertama adalah menginstal dan mengkonfigurasi OMV untuk akhirnya mendapatkan semacam fondasi untuk NAS. </p><br><h3 id="ustanovka-omv">  Instal OMV </h3><br><p>  OMV akan diinstal sebagai paket deb.  Untuk melakukan ini, dimungkinkan untuk menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">instruksi resmi</a> . </p><br><p>  Skrip <code>add_repo.sh</code> menambahkan repositori OMV Arrakis ke <code>/etc/apt/ sources.list.d</code> sehingga sistem batch melihat repositori. </p><br><div class="spoiler">  <b class="spoiler_title">add_repo.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">cat &lt;&lt;EOF &gt;&gt; /etc/apt/sources.list.d/openmediavault.list deb http://packages.openmediavault.org/public arrakis main <span class="hljs-comment"><span class="hljs-comment"># deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis main ## Uncomment the following line to add software from the proposed repository. # deb http://packages.openmediavault.org/public arrakis-proposed main # deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis-proposed main ## This software is not part of OpenMediaVault, but is offered by third-party ## developers as a service to OpenMediaVault users. deb http://packages.openmediavault.org/public arrakis partner # deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis partner EOF</span></span></code> </pre> </div></div><br><p>  Harap dicatat bahwa dibandingkan dengan aslinya, repositori mitra disertakan. </p><br><p>  Untuk menginstal dan menginisialisasi, Anda harus menjalankan perintah di bawah ini. </p><br><div class="spoiler">  <b class="spoiler_title">Perintah untuk menginstal OMV.</b> <div class="spoiler_text"><pre> <code class="bash hljs">./add_repo.sh <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LANG=C <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> DEBIAN_FRONTEND=noninteractive <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> APT_LISTCHANGES_FRONTEND=none apt-get update apt-get --allow-unauthenticated install openmediavault-keyring apt-get update apt-get --yes --auto-remove --show-upgraded \ --allow-downgrades --allow-change-held-packages \ --no-install-recommends \ --option Dpkg::Options::=<span class="hljs-string"><span class="hljs-string">"--force-confdef"</span></span> \ --option DPkg::Options::=<span class="hljs-string"><span class="hljs-string">"--force-confold"</span></span> \ install postfix openmediavault <span class="hljs-comment"><span class="hljs-comment"># Initialize the system and database. omv-initsystem</span></span></code> </pre> </div></div><br><p>  OMV diinstal.  Ia menggunakan kernelnya sendiri, dan setelah instalasi reboot mungkin diperlukan. </p><br><p>  Setelah reboot, antarmuka OpenMediaVault akan tersedia di port 80 (buka browser di NAS dengan alamat IP): </p><br><p> <a href=""><img src="https://habrastorage.org/webt/eo/sf/ra/eosfraeilpg2dn770ef5bvr-ple.png"></a> </p><br><p>  Nama pengguna / kata sandi default adalah <code>admin/openmediavault</code> . </p><br><h3 id="nastroyka-omv">  Konfigurasikan OMV </h3><br><p>  Lebih lanjut, sebagian besar konfigurasi akan melalui WEB-GUI. </p><br><h4 id="ustanovka-bezopasnogo-soedineniya">  Buat koneksi yang aman </h4><br><p>  Sekarang Anda perlu mengubah kata sandi administrator WEB dan membuat sertifikat untuk NAS agar dapat bekerja pada HTTPS di masa mendatang. </p><br><p>  Kata sandi diubah pada tab <em>"Sistem-&gt; Pengaturan Umum-&gt; Kata Sandi Administrator Web"</em> . <br>  Untuk menghasilkan sertifikat pada tab <em>"Sistem-&gt; Sertifikat-&gt; SSL",</em> pilih <em>"Tambah-&gt; Buat"</em> . </p><br><p>  Sertifikat yang dibuat akan terlihat pada tab yang sama: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ld/6j/_m/ld6j_mgp4tx6auirzlkfnwium2c.png" alt="Sertifikat"></a> </p><br><p>  Setelah membuat sertifikat, pada <em>tab "Sistem-&gt; Pengaturan Umum",</em> aktifkan kotak centang <em>"Aktifkan SSL / TLS"</em> . </p><br><p>  Sertifikat akan diperlukan sebelum konfigurasi selesai.  Versi final akan menggunakan sertifikat yang ditandatangani untuk menghubungi OMV. </p><br><p>  Sekarang Anda harus masuk ke OMV, ke port 443, atau cukup menetapkan <code>https://</code> awalan ke IP di browser. </p><br><p>  Jika Anda berhasil masuk, pada tab <em>"System-&gt; General Settings"</em> Anda harus mengaktifkan kotak centang "Force SSL / TLS". </p><br><p>  <strong>Ubah port 80 dan 443 menjadi 10080 dan 10443</strong> . <br>  Dan coba masuk ke alamat berikut: <code>https://IP_NAS:10443</code> . <br>  Mengubah port penting karena port 80 dan 443 akan menggunakan wadah buruh pelabuhan dengan nginx-reverse-proxy. </p><br><h3 id="pervichnye-nastroyki">  Pengaturan utama </h3><br><p>  Pengaturan minimum yang harus dilakukan terlebih dahulu: </p><br><ul><li>  Pada tab <em>"Sistem-&gt; Tanggal dan Waktu"</em> periksa nilai zona waktu dan atur server NTP. </li><li>  Pada tab <em>"Sistem-&gt; Pemantauan"</em> memungkinkan pengumpulan statistik kinerja. </li><li>  Pada tab <em>"Sistem-&gt; Manajemen Energi"</em> mungkin perlu mematikan "Pemantauan" sehingga OMV tidak mencoba untuk mengendalikan kipas. </li></ul><br><h3 id="set">  Jaringan </h3><br><p>  Jika antarmuka jaringan NAS kedua belum terhubung, sambungkan ke router. </p><br><p>  Lalu: </p><br><ul><li>  Pada <em>tab "System-&gt; Network",</em> atur nama host ke "nas" (atau apa pun yang Anda suka). </li><li>  Atur ikatan untuk antarmuka seperti yang ditunjukkan pada gambar di bawah ini: <em>"System-&gt; Network-&gt; Interfaces-&gt; Add-&gt; Bond"</em> . </li><li>  Tambahkan aturan firewall yang diperlukan pada tab <em>"System-&gt; Network-&gt; Firewall"</em> .  Pertama, akses ke port 10443, 10080, 443, 80, 22 untuk SSH dan izin untuk menerima / mengirim ICMP sudah cukup. </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/rb/fi/ab/rbfiabiimceoohildwosfu_egju.png" alt="Pengaturan ikatan"></a> </p><br><p>  Akibatnya, antarmuka dalam ikatan akan muncul, yang akan dilihat router sebagai satu antarmuka dan menetapkan satu alamat IP: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ag/wr/y8/agwry8ynozq7dhgov16pzzwmrs0.png" alt="Ikatan antarmuka"></a> </p><br><p>  Jika diinginkan, dimungkinkan untuk mengkonfigurasi SSH tambahan dari WEB GUI: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yk/oa/i4/ykoai4l9risd46whpuutbnyi1um.png" alt="Pengaturan ssh"></a> </p><br><h3 id="repozitorii-i-moduli">  Repositori dan modul </h3><br><p>  Pada tab <em>"Sistem-&gt; Perbarui Manajemen-&gt; Pengaturan"</em> nyalakan <em>"Pembaruan yang didukung oleh komunitas</em> . <em>"</em> </p><br><p>  Pertama, tambahkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori tambahan OMV</a> . <br>  Ini dapat dilakukan hanya dengan menginstal plugin atau paket, seperti yang ditunjukkan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">forum</a> . </p><br><p>  Pada halaman <em>"System-&gt; Plugins"</em> Anda perlu menemukan plugin "openmediavault-omvextrasorg" dan menginstalnya. </p><br><p>  Hasilnya, ikon "OMV-Extras" akan muncul di menu sistem (dapat dilihat di tangkapan layar). </p><br><p>  Pergi ke sana dan aktifkan repositori berikut: </p><br><ul><li>  OMV-Extras.org.  Repositori stabil yang berisi banyak plugin. </li><li>  Pengujian OMV-Extras.org.  Beberapa plugin dari repositori ini tidak ada dalam repositori stable. </li><li>  Docker CE.  Sebenarnya, Docker. </li></ul><br><p>  Pada tab <em>"System-&gt; OMV Extras-&gt; Kernel"</em> Anda dapat memilih kernel yang Anda butuhkan, termasuk kernel dari Proxmox (saya tidak menginstalnya sendiri, karena saya belum membutuhkannya, oleh karena itu saya tidak merekomendasikannya): </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dq/se/jq/dqsejqlsyn0x6wdbyfeb2kvlwmc.png"></a> </p><br><p>  Instal plugin yang diperlukan ( <em>cetak</em> <strong>tebal</strong> mutlak, <em>cetak miring</em> - opsional, yang tidak saya instal): </p><br><div class="spoiler">  <b class="spoiler_title">Daftar plugin.</b> <div class="spoiler_text"><ul><li>  openmediavault-apttool.  GUI minimum untuk bekerja dengan sistem batch.  Menambahkan <em>"Layanan-&gt; Apttool"</em> . </li><li>  openmediavault-anacron.  Menambahkan kemampuan untuk bekerja dari GUI dengan penjadwal asinkron.  Menambahkan <em>"System-&gt; Anacron"</em> . </li><li>  openmediavault-backup.  Menyediakan sistem cadangan dalam penyimpanan.  Menambahkan halaman <em>"System-&gt; Backup"</em> . </li><li>  openmediavault-diskstats.  Diperlukan untuk mengumpulkan statistik tentang kinerja disk. </li><li>  <em>openmediavault-dnsmasq</em> .  Memungkinkan Anda menaikkan server DNS dan DHCP di NAS.  Karena saya melakukan ini di router, saya tidak membutuhkannya. </li><li>  <strong>openmediavault-docker-gui</strong> .  Antarmuka manajemen wadah Docker.  Menambahkan <em>"Layanan-&gt; Docker"</em> . </li><li>  <strong>openmediavault-ldap</strong> .  Dukungan untuk otentikasi melalui LDAP.  Menambahkan <em>"Manajemen Hak -&gt; Layanan Direktori"</em> . </li><li>  <em>openmediavault-letsencrypt</em> .  Dukungan untuk Let's Encrypt dari GUI.  Ini tidak diperlukan, karena menggunakan embedding dalam wadah nginx-reverse-proxy. </li><li>  <strong>openmediavault-luksencryption</strong> .  Dukungan enkripsi LUKS.  Diperlukan bahwa disk terenkripsi terlihat di antarmuka OMV.  Menambahkan <em>"Storage-&gt; Enkripsi"</em> . </li><li>  <strong>openmediavault-nut</strong> .  Dukungan UPS.  Menambahkan <em>"Layanan-&gt; UPS"</em> . </li><li>  <strong>openmediavault-omvextrasorg</strong> .  OMV Extras seharusnya sudah diinstal. </li><li>  openmediavault-resetperms.  Memungkinkan Anda mengatur ulang izin dan mengatur ulang daftar kontrol akses di direktori bersama.  Menambahkan <em>"Kontrol Akses -&gt; Direktori Umum -&gt; Atur Ulang Izin"</em> . </li><li>  openmediavault-rute.  Plugin yang berguna untuk manajemen perutean.  Menambahkan <em>"System-&gt; Network-&gt; Static Route"</em> . </li><li>  openmediavault-symlinks.  Memberikan kemampuan untuk membuat tautan simbolik.  Menambahkan halaman <em>"Layanan-&gt; Simbol"</em> . </li><li>  openmediavault-unionfilesystems.  Dukungan UnionFS.  Ini mungkin berguna di masa depan, meskipun buruh pelabuhan menggunakan ZFS sebagai backend.  Menambahkan <em>"Storage-&gt; Union Filesystems"</em> . </li><li>  <em>openmediavault-virtualbox</em> .  Ini dapat digunakan untuk menanamkan kemampuan manajemen mesin virtual di GUI. </li><li>  <strong>openmediavault-zfs</strong> .  Plugin menambahkan dukungan ZFS ke OpenMediaVault.  Setelah instalasi, halaman <em>"Storage-&gt; ZFS"</em> akan muncul. </li></ul></div></div><br><h3 id="diski">  Disk </h3><br><p>  Semua disk yang ada dalam sistem harus terlihat OMV.  Pastikan ini dengan melihat <em>tab "Storage-&gt; Disks"</em> .  Jika tidak semua disk terlihat, jalankan pemindaian. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ju/i3/rs/jui3rsmgmatghluwuk0rknsqfrq.png" alt="Disk dalam sistem"></a> </p><br><p>  Di sana, di semua HDD, caching tulis harus diaktifkan (dengan mengklik pada disk dari daftar dan mengklik tombol "Edit"). </p><br><p>  Pastikan bahwa semua bagian terenkripsi terlihat pada <em>tab "Storage-&gt; Enkripsi"</em> : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dy/nw/kv/dynwkvuhbnglzeqe3sin_vqda7i.png" alt="Partisi terenkripsi"></a> </p><br><p>  Sekarang saatnya mengkonfigurasi SMART, yang diindikasikan sebagai cara untuk meningkatkan keandalan: </p><br><ul><li>  Pergi ke <em>tab "Storage-&gt; SMART-&gt; Settings"</em> .  Nyalakan SMART. </li><li>  Di tempat yang sama, pilih nilai level suhu disk (kritis, biasanya 60 C, dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">rezim suhu optimal disk</a> 15-45 C). </li><li>  Pergi ke <em>tab "Storage-&gt; SMART-&gt; Devices"</em> .  Aktifkan pemantauan untuk setiap drive. <br> <a href=""><img src="https://habrastorage.org/webt/83/r-/dc/83r-dcwtrhth5icaketuw1zlis8.png"></a> </li><li>  Buka <em>tab "Penyimpanan-&gt; SMART-&gt; Tes Terjadwal"</em> .  Tambahkan swa-uji singkat sehari sekali untuk setiap disk dan swa-uji panjang sebulan sekali.  Apalagi, agar periode swa-uji tidak tumpang tindih. <br> <a href=""><img src="https://habrastorage.org/webt/lh/u8/qf/lhu8qffcenb8utgcekfoy_j0oee.png"></a> </li></ul><br><p>  Pada ini, konfigurasi disk dapat dianggap selesai. </p><br><h3 id="faylovye-sistemy-i-obschie-katalogi">  Sistem File dan Direktori Bersama </h3><br><p>  Anda harus membuat sistem file untuk direktori yang telah ditentukan. <br>  Ini dapat dilakukan dari konsol, atau dari antarmuka WEB OMV ( <em>Storage-&gt; ZFS-&gt; Select pool tank0-&gt; Add button -&gt; Filesystem</em> ). </p><br><div class="spoiler">  <b class="spoiler_title">Perintah untuk membuat FS.</b> <div class="spoiler_text"><pre> <code class="hljs sql">zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/books zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/music zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/pictures zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/downloads zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o compression=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/videos</code> </pre> </div></div><br><p>  Hasilnya harus struktur direktori berikut: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ua/uy/yk/uauyykwki2nmmmpj6pe3-lqxrie.png"></a> </p><br><p>  Setelah itu, tambahkan FS yang dibuat sebagai direktori bersama di halaman <em>"Mengelola Hak Akses-&gt; Direktori Umum-&gt; Tambah"</em> . <br>  Harap dicatat bahwa parameter <em>"Device"</em> sama dengan path ke sistem file yang dibuat di ZFS, dan parameter <em>"Path"</em> untuk semua direktori adalah "/". </p><br><p> <a href=""><img src="https://habrastorage.org/webt/xc/9v/da/xc9vdaubqewzyhqfm80k_751fo8.png"></a> </p><br><h3 id="rezervnoe-kopirovanie">  Cadangkan </h3><br><p>  Pencadangan dilakukan oleh dua alat: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Plugin cadangan OMV</a> .  Plugin OMV untuk cadangan sistem. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">zfs-auto-snapshot</a> .  Sebuah skrip untuk secara otomatis membuat snapshot ZFS pada jadwal dan menghapus yang lama. </li></ul><br><p>  Jika Anda menggunakan plugin, kemungkinan besar Anda mendapatkan kesalahan: </p><br><pre> <code class="hljs vhdl">lsblk: /dev/<span class="hljs-keyword"><span class="hljs-keyword">block</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> device</code> </pre> <br><p>  Untuk memperbaikinya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sebagaimana dicatat oleh pengembang OMV</a> dalam "konfigurasi yang sangat tidak standar" ini, akan mungkin untuk menolak plugin dan menggunakan alat ZFS dalam bentuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>zfs send/receive</code></a> . <br>  Atau, tentukan secara spesifik parameter "Root device" dalam bentuk perangkat fisik dari mana unduhan dilakukan. <br>  Lebih nyaman bagi saya untuk menggunakan plugin dan mencadangkan OS dari antarmuka, daripada membingkai sesuatu milik saya sendiri dengan zfs send, jadi saya lebih suka opsi kedua. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/q8/hm/k9/q8hmk9guerk2it7d1xe4tuzvtak.png" alt="Penyiapan cadangan"></a> </p><br><p>  Untuk membuat cadangan berfungsi, pertama buat sistem file <code>tank0/apps/backup</code> melalui ZFS, kemudian di menu <em>"System-&gt; Backup"</em> klik "+" di bidang parameter <em>"Folder publik"</em> dan tambahkan perangkat yang dibuat sebagai target dan bidang <em>"Path"</em> setel ke "/". </p><br><p>  Ada masalah dengan zfs-auto-snapshot juga.  Jika tidak dikonfigurasi, dia akan mengambil gambar setiap jam, setiap hari, setiap minggu, setiap bulan selama satu tahun. <br>  Hasilnya adalah apa yang ada di tangkapan layar: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/af/_j/gw/af_jgw_evodbuhm07iqwpjh-he8.png" alt="Banyak spam dari zfs-auto-snapshot"></a> </p><br><p>  Jika Anda telah menemukan ini, jalankan kode berikut untuk menghapus snapshot otomatis: </p><br><pre> <code class="hljs powershell">zfs list <span class="hljs-literal"><span class="hljs-literal">-t</span></span> snapshot <span class="hljs-literal"><span class="hljs-literal">-o</span></span> name <span class="hljs-literal"><span class="hljs-literal">-S</span></span> creation | grep <span class="hljs-string"><span class="hljs-string">"@zfs-auto-snap"</span></span> | tail <span class="hljs-literal"><span class="hljs-literal">-n</span></span> +<span class="hljs-number"><span class="hljs-number">1500</span></span> | xargs <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> zfs destroy <span class="hljs-literal"><span class="hljs-literal">-vr</span></span></code> </pre> <br><p>  Kemudian konfigurasikan zfs-auto-snapshot untuk berjalan di cron. <br>  Untuk memulai, cukup hapus <code>/etc/cron.hourly/zfs-auto-snapshot</code> jika Anda tidak perlu mengambil gambar setiap jam. </p><br><h3 id="e-mail-uvedomleniya">  Pemberitahuan Email </h3><br><p>  Pemberitahuan melalui email telah diindikasikan sebagai salah satu cara untuk mencapai keandalan. <br>  Karenanya, sekarang Anda perlu mengonfigurasi notifikasi email. <br>  Untuk melakukan ini, daftarkan sebuah kotak di salah satu server publik (baik, atau konfigurasikan sendiri server SMTP, jika Anda benar-benar memiliki alasan untuk melakukan ini). </p><br><p>  Maka Anda harus pergi ke halaman <em>"System-&gt; Notification"</em> dan masukkan: </p><br><ul><li>  Alamat server SMTP. </li><li>  Port server SMTP. </li><li>  Nama pengguna </li><li>  Alamat pengirim (biasanya komponen pertama dari alamat tersebut sesuai dengan namanya). </li><li>  Kata sandi pengguna </li><li>  Di bidang "Penerima", alamat Anda yang biasa digunakan NAS untuk mengirimkan pemberitahuan. </li></ul><br><p>  Sangat disarankan untuk mengaktifkan SSL / TLS. </p><br><p>  Contoh pengaturan untuk Yandex ditunjukkan pada tangkapan layar: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/4j/pb/2m/4jpb2mwgystnu_3yc9vf9l16soo.png" alt="Permintaan Email"></a> </p><br><h2 id="nastroyka-seti-vne-nas">  Pengaturan jaringan di luar NAS </h2><br><h3 id="ip-adres">  Alamat IP </h3><br><p>  Saya menggunakan alamat IP statis putih, yang biayanya ditambah 100 rubel per bulan.  Jika tidak ada keinginan untuk membayar dan alamat Anda dinamis, tetapi tidak untuk NAT, dimungkinkan untuk menyesuaikan catatan DNS eksternal melalui API layanan yang dipilih. <br>  Namun demikian, harus diingat bahwa alamat non-NAT tiba-tiba dapat menjadi alamat NAT: sebagai suatu peraturan, penyedia tidak memberikan jaminan apa pun. </p><br><h3 id="router">  Router </h3><br><p>  Sebagai router, saya memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mikrotik RouterBoard</a> , mirip dengan yang ada di gambar di bawah ini. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ni/mv/a8/nimva8ju1vg2doqcnwd7s0_xcmw.jpeg" alt="Routerboard mikrotik"></a> </p><br><p>  Tiga hal diperlukan pada router: </p><br><ul><li>  Konfigurasikan alamat statis untuk NAS.  Dalam kasus saya, alamat dikeluarkan melalui DHCP, dan saya perlu memastikan bahwa adaptor dengan alamat MAC tertentu selalu mendapatkan alamat IP yang sama.  Di RouterOS, ini dilakukan pada <em>tab "IP-&gt; DHCP Server"</em> dengan tombol <em>"Make static"</em> . </li><li>  Konfigurasikan server DNS sehingga untuk nama "nas", serta nama yang berakhiran ".nas" dan ".NAS.cloudns.cc" (di mana "NAS" adalah zona pada ClouDNS atau layanan serupa) itu memberikan sistem IP.  Di mana melakukan ini di RouterOS ditunjukkan pada gambar di bawah.  Dalam kasus saya, ini diterapkan dengan mencocokkan nama dengan ekspresi reguler: " <code>^.*\.nas$|^nas$|^.*\.NAS.cloudns.cc$</code> " </li><li>  Konfigurasikan penerusan port.  Di RouterOS, ini dilakukan pada <em>tab "IP-&gt; Firewall"</em> , saya tidak akan membahas hal ini lebih lanjut. </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/wu/2d/3n/wu2d3ng2xlqaleslb__9a72vtpo.png" alt="Konfigurasikan DNS di RouterOS"></a> </p><br><h3 id="cloudns">  ClouDNS </h3><br><p>  CLouDNS sederhana.  Buat akun, konfirmasi.  Catatan NS sudah akan terdaftar pada Anda.  Selanjutnya, pengaturan minimal diperlukan. </p><br><p>  Pertama, Anda perlu membuat zona yang diperlukan (zona dengan nama NAS yang disorot merah di tangkapan layar adalah apa yang harus Anda buat dengan nama yang berbeda, tentu saja). </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wj/3k/0u/wj3k0ueaouj9tdslhubqtdz49os.png" alt="Membuat zona di ClouDNS"></a> </p><br><p>  Kedua, di zona ini Anda harus mendaftarkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">A-record</a> berikut: </p><br><ul><li>  <strong>nas</strong> , <strong>www</strong> , <strong>omv</strong> , <strong>control</strong> dan <strong>nama kosong</strong> .  Untuk mengakses antarmuka OMV. </li><li>  <strong>lap</strong> .  Antarmuka PhpLdapAdmin </li><li>  <strong>ssp</strong> .  Antarmuka untuk mengubah kata sandi pengguna. </li><li>  <strong>tes</strong> .  Server uji. </li></ul><br><p>  Nama domain yang tersisa akan ditambahkan saat layanan ditambahkan. <br>  Klik pada zona, lalu <em>"Tambahkan catatan baru"</em> , pilih tipe-A, masukkan nama zona dan alamat IP router di belakang NAS. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ym/9o/s2/ym9os2upazemboftovtmasp3h1u.png" alt="Ingat suatu catatan"></a> </p><br><p>  Kedua, Anda perlu mengakses API.  Di ClouDNS dibayar, jadi Anda harus membayarnya terlebih dahulu.  Di layanan lain, ini gratis.  Jika Anda tahu mana yang lebih baik, dan ini didukung oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Lexicon</a> , silakan tulis di komentar. </p><br><p>  Setelah mendapatkan akses ke API, Anda perlu menambahkan pengguna API baru di sana. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ah/tc/rp/ahtcrpidjt3gvlnuc-udwjj0no8.png" alt="Menambahkan Pengguna API ClouDNS"></a> </p><br><p>   <em>"IP address"</em>   IP :  ,     API.  ,    ,    API,   <strong>auth-id</strong>  <strong>auth-password</strong> .      Lexicon,  . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/z_/6k/yv/z_6kyvkyj9gqlbi_s-dudfoirzs.png"></a> </p><br><p>    ClouDNS . </p><br><h2>   </h2><br><h3 id="nastroyka-docker">  Docker </h3><br><p>     openmediavault-docker-gui,  docker-ce      . </p><br><p> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">docker-compose</a> ,         : </p><br><pre> <code class="bash hljs">apt-get install docker-compose</code> </pre> <br><p>       : </p><br><pre> <code class="bash hljs">zfs create -p /tank0/docker/services</code> </pre> <br><p>  ,       <code>/var/lib/docker</code> .     ( ,   SSD),  ,  ,         . </p><br><p> ..,              <br>   .   . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wn/by/ec/wnbyecyxrlrsf0cssx78zqmoxdu.png"></a> </p><br><p>   ,         . <br>       ,      GUI ,    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">    </a> , ..       ,     . </p><br><p>        <code>/var/lib</code>   : </p><br><pre> <code class="bash hljs">service docker stop zfs create -o com.sun:auto-snapshot=<span class="hljs-literal"><span class="hljs-literal">false</span></span> -p /tank0/docker/lib rm -rf /var/lib/docker ln -s /tank0/docker/lib /var/lib/docker service docker start</code> </pre> <br><p>  : </p><br><pre> <code class="bash hljs">$ ls -l /var/lib/docker lrwxrwxrwx 1 root root 17 Apr 7 12:35 /var/lib/docker -&gt; /tank0/docker/lib</code> </pre> <br><p>     : </p><br><pre> <code class="bash hljs">docker network create docker0</code> </pre> <br><p>     Docker       . </p><br><h3 id="nastroyka-konteynera-s-nginx-reverse-proxy">    nginx-reverse-proxy </h3><br><p>    Docker ,     . </p><br><p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> ,   . </p><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">nginx-proxy</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">letsencrypt-dns</a> . </p><br><p> ,    OMV    10080  10443,        80  443. </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs javascript">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: external: name: docker0 services: nginx-proxy: networks: - docker0 restart: always image: jwilder/nginx-proxy ports: - <span class="hljs-string"><span class="hljs-string">"80:80"</span></span> - <span class="hljs-string"><span class="hljs-string">"443:443"</span></span> volumes: - ./certs:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/certs:ro - ./vhost.d:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/vhost.d - ./html:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>share/nginx/html - <span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>run/docker.sock:<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>docker.sock:ro - ./local-config:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/conf.d - ./nginx.tmpl:<span class="hljs-regexp"><span class="hljs-regexp">/app/</span></span>nginx.tmpl labels: - <span class="hljs-string"><span class="hljs-string">"com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"</span></span> letsencrypt-dns: image: adferrand/letsencrypt-dns volumes: - ./certs/letsencrypt:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>letsencrypt environment: - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_PROVIDER=cloudns"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_OPTIONS=--delegated NAS.cloudns.cc"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD"</span></span></code> </pre> </div></div><br><p>      : </p><br><ul><li> nginx-reverse-proxy ‚Äî c  . </li><li> letsencrypt-dns ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ACME </a> Let's Encrypt. </li></ul><br><p>       nginx-reverse-proxy   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">jwilder/nginx-proxy</a> . </p><br><p> <code>docker0</code> ‚Äî  ,    ,    docker-compose. <br> <code>nginx-proxy</code> ‚Äî   ,  .     docker0.  ,  80  443   ports      (,       ,           docker0,   ). <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>restart: always</code></a> ,       . </p><br><p> : </p><br><ul><li>   <strong><code>certs</code></strong>   <strong><code>/etc/nginx/certs</code></strong> ‚Äî   ,  ,   Let's Encrypt.           ACME . </li><li> <code>./vhost.d:/etc/nginx/vhost.d</code> ‚Äî    .   . </li><li> <code>./html:/usr/share/nginx/html</code> ‚Äî  .     . </li><li> <strong><code>/var/run/docker.sock</code></strong> ,   <strong><code>/tmp/docker.sock</code></strong> ‚Äî      Docker  .    docker-gen   . </li><li> <strong><code>./local-config</code></strong> ,   <strong><code>/etc/nginx/conf.d</code></strong> ‚Äî    nginx.    ,   . </li><li> <strong><code>./nginx.tmpl</code></strong> ,   <strong><code>/app/nginx.tmpl</code></strong> ‚Äî     nginx,   docker-gen  . </li></ul><br><p>  letsencrypt-dns    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">adferrand/letsencrypt-dns</a> .     ACME   Lexicon,     DNS . </p><br><p>   <code>certs/letsencrypt</code>   <code>/etc/letsencrypt</code>  . </p><br><p>   ,        : </p><br><ul><li> <strong><code>LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM</code></strong> ‚Äî   Let's Encrypt.     ,      . </li><li> <strong><code>LEXICON_PROVIDER=cloudns</code></strong> ‚Äî   Lexicon.    ‚Äî <code>cloudns</code> . </li><li> <strong><code>LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD --delegated=NAS.cloudns.cc</code></strong> ‚Äî CLOUDNS_ID        ClouDNS  . CLOUDNS_PASSWORD ‚Äî  ,      API. NAS.cloudns.cc,  NAS ‚Äî   DNS .  cloudns  ,          (cloudns.cc),  ClouDNS API     . </li></ul><br><p>        :      . <br>  ,      ,   ,     ,    Let's encrypt: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ls ./certs/letsencrypt/ accounts archive csr domains.conf keys live renewal renewal<span class="hljs-literal"><span class="hljs-literal">-hooks</span></span></code> </pre> <br><p>  ,      ,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/nginx.tmpl</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">{{ <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentContainer := where <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-comment"><span class="hljs-comment">"ID"</span></span> .<span class="hljs-type"><span class="hljs-type">Docker</span></span>.<span class="hljs-type"><span class="hljs-type">CurrentContainerID</span></span> | first }} {{ define <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> }} {{ if .<span class="hljs-type"><span class="hljs-type">Address</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> we got the containers from swarm and this container<span class="hljs-string"><span class="hljs-string">'s port is published to host, use host IP:PORT */}} {{ if and .Container.Node.ID .Address.HostPort }} # {{ .Container.Node.Name }}/{{ .Container.Name }} server {{ .Container.Node.Address.IP }}:{{ .Address.HostPort }}; {{/* If there is no swarm node or the port is not published on host, use container'</span></span>s <span class="hljs-type"><span class="hljs-type">IP</span></span>:<span class="hljs-type"><span class="hljs-type">PORT</span></span> */}} {{ else if .<span class="hljs-type"><span class="hljs-type">Network</span></span> }} # {{ .<span class="hljs-type"><span class="hljs-type">Container</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> }} server {{ .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }}:{{ .<span class="hljs-type"><span class="hljs-type">Address</span></span>.<span class="hljs-type"><span class="hljs-type">Port</span></span> }}; {{ end }} {{ else if .<span class="hljs-type"><span class="hljs-type">Network</span></span> }} # {{ .<span class="hljs-type"><span class="hljs-type">Container</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> }} {{ if .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }} server {{ .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }} down; {{ else }} server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> down; {{ end }} {{ end }} {{ end }} # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Proto</span></span>, pass it through; otherwise, pass along the # scheme used to connect to this server map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_proto <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_proto { default <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_proto; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>cheme; } # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Port</span></span>, pass it through; otherwise, pass along the # server port the client connected to map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_port <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_port { default <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_port; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>erver_port; } # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">Upgrade</span></span>, set <span class="hljs-type"><span class="hljs-type">Connection</span></span> to <span class="hljs-comment"><span class="hljs-comment">"upgrade"</span></span>; otherwise, delete any # <span class="hljs-type"><span class="hljs-type">Connection</span></span> header that may have been passed to this server map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_upgrade <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_connection { default upgrade; <span class="hljs-string"><span class="hljs-string">''</span></span> close; } # <span class="hljs-type"><span class="hljs-type">Apply</span></span> fix for very long server names server_names_hash_bucket_size <span class="hljs-number"><span class="hljs-number">128</span></span>; # <span class="hljs-type"><span class="hljs-type">Default</span></span> dhparam {{ if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/dhparam/dhparam.pem"</span></span>) }} ssl_dhparam /etc/nginx/dhparam/dhparam.pem; {{ end }} # <span class="hljs-type"><span class="hljs-type">Set</span></span> appropriate <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Ssl</span></span> header map <span class="hljs-string"><span class="hljs-string">$s</span></span>cheme <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_ssl { default off; https on; } gzip_types text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript; log_format vhost <span class="hljs-string"><span class="hljs-string">'$host $remote_addr - $remote_user [$time_local] '</span></span> <span class="hljs-string"><span class="hljs-string">'"$request" $status $body_bytes_sent '</span></span> <span class="hljs-string"><span class="hljs-string">'"$http_referer" "$http_user_agent"'</span></span>; access_log off; {{ if <span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">RESOLVERS</span></span> }} resolver {{ <span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">RESOLVERS</span></span> }}; {{ end }} {{ if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/proxy.conf"</span></span>) }} include /etc/nginx/proxy.conf; {{ else }} # <span class="hljs-type"><span class="hljs-type">HTTP</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> support proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_buffering off; proxy_set_header <span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_host; proxy_set_header <span class="hljs-type"><span class="hljs-type">Upgrade</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_upgrade; proxy_set_header <span class="hljs-type"><span class="hljs-type">Connection</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_connection; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Real</span></span>-<span class="hljs-type"><span class="hljs-type">IP</span></span> <span class="hljs-string"><span class="hljs-string">$r</span></span>emote_addr; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">For</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_add_x_forwarded_for; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Proto</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_proto; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Ssl</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_ssl; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Port</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_port; # <span class="hljs-type"><span class="hljs-type">Mitigate</span></span> httpoxy attack (see <span class="hljs-type"><span class="hljs-type">README</span></span> for details) proxy_set_header <span class="hljs-type"><span class="hljs-type">Proxy</span></span> <span class="hljs-comment"><span class="hljs-comment">""</span></span>; {{ end }} {{ <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 := eq (or (<span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">ENABLE_IPV6</span></span>) <span class="hljs-comment"><span class="hljs-comment">""</span></span>) <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> }} server { server_name _; # <span class="hljs-type"><span class="hljs-type">This</span></span> is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">80</span></span>; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span>; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">503</span></span>; } {{ if (and (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.crt"</span></span>) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.key"</span></span>)) }} server { server_name _; # <span class="hljs-type"><span class="hljs-type">This</span></span> is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">503</span></span>; ssl_session_tickets off; ssl_certificate /etc/nginx/certs/default.crt; ssl_certificate_key /etc/nginx/certs/default.key; } {{ end }} {{ range <span class="hljs-string"><span class="hljs-string">$h</span></span>ost, <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers := groupByMulti <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_HOST"</span></span> <span class="hljs-comment"><span class="hljs-comment">","</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost := trim <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{ <span class="hljs-string"><span class="hljs-string">$i</span></span>s_regexp := hasPrefix <span class="hljs-comment"><span class="hljs-comment">"~"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{ <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name := when <span class="hljs-string"><span class="hljs-string">$i</span></span>s_regexp (sha1 <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} # {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} upstream {{ <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }} { {{ range <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer := <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddrLen := len <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> }} {{ range <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork := <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentContainer.<span class="hljs-type"><span class="hljs-type">Networks</span></span> }} {{ range <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork := <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Networks</span></span> }} {{ if (and (ne <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-comment"><span class="hljs-comment">"ingress"</span></span>) (or (eq <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span>) (eq <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-comment"><span class="hljs-comment">"host"</span></span>))) }} ## <span class="hljs-type"><span class="hljs-type">Can</span></span> be connected with <span class="hljs-comment"><span class="hljs-comment">"{{ $containerNetwork.Name }}"</span></span> network {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> only <span class="hljs-number"><span class="hljs-number">1</span></span> port exposed, use that */}} {{ if eq <span class="hljs-string"><span class="hljs-string">$a</span></span>ddrLen <span class="hljs-number"><span class="hljs-number">1</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress := index <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> }} {{ template <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> (dict <span class="hljs-comment"><span class="hljs-comment">"Container"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer <span class="hljs-comment"><span class="hljs-comment">"Address"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress <span class="hljs-comment"><span class="hljs-comment">"Network"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork) }} {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> more than one port exposed, use the one matching <span class="hljs-type"><span class="hljs-type">VIRTUAL_PORT</span></span> env var, falling back to standard web port <span class="hljs-number"><span class="hljs-number">80</span></span> */}} {{ else }} {{ <span class="hljs-string"><span class="hljs-string">$p</span></span>ort := coalesce <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">VIRTUAL_PORT</span></span> <span class="hljs-comment"><span class="hljs-comment">"80"</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress := where <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> <span class="hljs-comment"><span class="hljs-comment">"Port"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>ort | first }} {{ template <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> (dict <span class="hljs-comment"><span class="hljs-comment">"Container"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer <span class="hljs-comment"><span class="hljs-comment">"Address"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress <span class="hljs-comment"><span class="hljs-comment">"Network"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork) }} {{ end }} {{ else }} # <span class="hljs-type"><span class="hljs-type">Cannot</span></span> connect to network of this container server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> down; {{ end }} {{ end }} {{ end }} {{ end }} } {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_host := or (<span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">DEFAULT_HOST</span></span>) <span class="hljs-comment"><span class="hljs-comment">""</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server := index (dict <span class="hljs-string"><span class="hljs-string">$h</span></span>ost <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_host <span class="hljs-comment"><span class="hljs-comment">"default_server"</span></span>) <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">VIRTUAL_PROTO</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"http"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$p</span></span>roto := trim (or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_PROTO"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"http"</span></span>) }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">NETWORK_ACCESS</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"external"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.NETWORK_ACCESS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"external"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">HTTPS_METHOD</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.HTTPS_METHOD"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">SSL_POLICY</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.SSL_POLICY"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">HSTS</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"max-age=31536000"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>sts := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.HSTS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"max-age=31536000"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">VIRTUAL_ROOT</span></span> <span class="hljs-type"><span class="hljs-type">By</span></span> containers w/ use fastcgi root */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_ROOT"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"/var/www/public"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the first cert name defined by containers w/ the same vhost */}} {{ <span class="hljs-string"><span class="hljs-string">$c</span></span>ertName := (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.CERT_NAME"</span></span>)) }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the best matching cert by name for the vhost. */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := (closest (dir <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs"</span></span>) (printf <span class="hljs-comment"><span class="hljs-comment">"%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost))}} {{/* vhostCert is actually a filename so remove any suffixes since they are added later */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := trimSuffix <span class="hljs-comment"><span class="hljs-comment">".crt"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert }} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := trimSuffix <span class="hljs-comment"><span class="hljs-comment">".key"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert }} {{/* <span class="hljs-type"><span class="hljs-type">Use</span></span> the cert specified on the container or fallback to the best vhost match */}} {{ <span class="hljs-string"><span class="hljs-string">$c</span></span>ert := (coalesce <span class="hljs-string"><span class="hljs-string">$c</span></span>ertName <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert) }} {{ <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https := (and (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"nohttps"</span></span>) (ne <span class="hljs-string"><span class="hljs-string">$c</span></span>ert <span class="hljs-comment"><span class="hljs-comment">""</span></span>) (or (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)))) ) }} {{ if <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https }} {{ if eq <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">301</span></span> https://<span class="hljs-string"><span class="hljs-string">$h</span></span>ost<span class="hljs-string"><span class="hljs-string">$r</span></span>equest_uri; } {{ end }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; {{ if eq <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag <span class="hljs-comment"><span class="hljs-comment">"internal"</span></span> }} # <span class="hljs-type"><span class="hljs-type">Only</span></span> allow traffic from internal clients include /etc/nginx/network_internal.conf; {{ end }} {{ if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Modern"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Old"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">SSLv3</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:DES-CBC3-SHA:HIGH:SEED:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!RSAPSK:!aDH:!aECDH:!EDH-DSS-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!SRP'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-TLS-1-2-2017-01"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:AES128-GCM-SHA256:AES128-SHA256:AES256-GCM-SHA384:AES256-SHA256'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-TLS-1-1-2017-01"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2016-08"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-05"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DES-CBC3-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-03"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA:DES-CBC3-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-02"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA'</span></span>; {{ end }} ssl_prefer_server_ciphers on; ssl_session_timeout <span class="hljs-number"><span class="hljs-number">5</span></span>m; ssl_session_cache shared:<span class="hljs-type"><span class="hljs-type">SSL</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>m; ssl_session_tickets off; {{ if (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) }} ssl_certificate /etc/nginx/certs/letsencrypt/live/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; ssl_certificate_key /etc/nginx/certs/letsencrypt/live/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; {{ else if (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) }} ssl_certificate /etc/nginx/certs/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; ssl_certificate_key /etc/nginx/certs/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.dhparam.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) }} ssl_dhparam {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.dhparam.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.chain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) }} ssl_stapling on; ssl_stapling_verify on; ssl_trusted_certificate {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.chain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert }}; {{ end }} {{ if (and (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"noredirect"</span></span>) (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>sts <span class="hljs-comment"><span class="hljs-comment">"off"</span></span>)) }} add_header <span class="hljs-type"><span class="hljs-type">Strict</span></span>-<span class="hljs-type"><span class="hljs-type">Transport</span></span>-<span class="hljs-type"><span class="hljs-type">Security</span></span> <span class="hljs-comment"><span class="hljs-comment">"{{ trim $hsts }}"</span></span> always; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default"</span></span>) }} include /etc/nginx/vhost.d/default; {{ end }} location / { {{ if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"uwsgi"</span></span> }} include uwsgi_params; uwsgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"fastcgi"</span></span> }} root {{ trim <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root }}; include fastcgi.conf; fastcgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else }} proxy_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} auth_basic <span class="hljs-comment"><span class="hljs-comment">"Restricted {{ $host }}"</span></span>; auth_basic_user_file {{ (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost}}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default_location"</span></span>) }} include /etc/nginx/vhost.d/default_location; {{ end }} } } {{ end }} {{ if or (not <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https) (eq <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"noredirect"</span></span>) }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; {{ if eq <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag <span class="hljs-comment"><span class="hljs-comment">"internal"</span></span> }} # <span class="hljs-type"><span class="hljs-type">Only</span></span> allow traffic from internal clients include /etc/nginx/network_internal.conf; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default"</span></span>) }} include /etc/nginx/vhost.d/default; {{ end }} location / { {{ if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"uwsgi"</span></span> }} include uwsgi_params; uwsgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"fastcgi"</span></span> }} root {{ trim <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root }}; include fastcgi.conf; fastcgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else }} proxy_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} auth_basic <span class="hljs-comment"><span class="hljs-comment">"Restricted {{ $host }}"</span></span>; auth_basic_user_file {{ (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost}}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default_location"</span></span>) }} include /etc/nginx/vhost.d/default_location; {{ end }} } } {{ if (and (not <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.crt"</span></span>) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.key"</span></span>)) }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">500</span></span>; ssl_certificate /etc/nginx/certs/default.crt; ssl_certificate_key /etc/nginx/certs/default.key; } {{ end }} {{ end }} {{ end }}</code> </pre> </div></div><br><p> ,    nginx     <code>/etc/nginx/certs/%s.crt</code>  <code>/etc/nginx/certs/%s.pem</code> ,  %s ‚Äî   (  ‚Äî  ,      ). </p><br><p>        <code>/etc/nginx/certs/letsencrypt/live/%s/{fullchain.pem, privkey.pem}</code> ,            : </p><br><pre> <code class="hljs perl">{{ $is_https := (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $https_method <span class="hljs-string"><span class="hljs-string">"nohttps"</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $cert <span class="hljs-string"><span class="hljs-string">""</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> $cert)) (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> $cert)) ) (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/%s.crt"</span></span> $cert)) (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/%s.key"</span></span> $cert)) ) ) ) }}</code> </pre> <br><p>    ,        <code>domains.conf</code> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/certs/letsencrypt/domains.conf</b> <div class="spoiler_text"><pre> <code class="hljs css">*<span class="hljs-selector-class"><span class="hljs-selector-class">.NAS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cloudns</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NAS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cloudns</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cc</span></span></code> </pre> </div></div><br><p>     .  ,           ,     ,     <code>client_max_body_size</code>     20,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/local-config/max_upload_size.conf</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">client_max_body_size</span></span> <span class="hljs-number"><span class="hljs-number">20G</span></span>;</code> </pre> </div></div><br><p>  ,   : </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up</code> </pre> <br><p>   (   ),  Ctrl+C        : </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up <span class="hljs-literal"><span class="hljs-literal">-d</span></span></code> </pre> <br><h3 id="nastroyka-konteynera-s-testovym-serverom">      </h3><br><p>   ‚Äî   nginx,     . ,       ,     . <br>       ,      NAS. </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> . </p><br><p>   docker-compose : </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/test_nginx/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: docker0 services: nginx-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> image: nginx:alpine expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> - <span class="hljs-number"><span class="hljs-number">443</span></span> environment: - "VIRTUAL_HOST=test.NAS.cloudns.cc" - "VIRTUAL_PROTO=http" - "VIRTUAL_PORT=80" - CERT_NAME=NAS.cloudns.cc networks: - docker0</code> </pre> </div></div><br><p>        : </p><br><ul><li> <code>docker0</code> ‚Äî  .    . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>expose</code></a> ‚Äî    ,   .  ,  80   HTTP  443   HTTPS. </li><li> <code>VIRTUAL_HOST=test.NAS.cloudns.cc</code> ‚Äî      ,   nginx-reverse-proxy      . </li><li> <code>VIRTUAL_PROTO=http</code> ‚Äî    nginx-reverse-proxy     .   ,  HTTP. </li><li> <code>VIRTUAL_PORT=80</code> ‚Äî      nginx-reverse-proxy. </li><li> <code>CERT_NAME=NAS.cloudns.cc</code> ‚Äî   .   ,     ,    . NAS ‚Äî  DNS . </li><li> <code>networks</code> ‚Äî      ,    nginx-reverse-proxy     <code>docker0</code> . </li></ul><br><p>  ,    .  <code>docker-compose up</code> ,    <code>test.NAS.cloudns.cc</code> . </p><br><p>       : </p><br><pre> <code class="bash hljs">$ docker-compose up Creating testnginx_nginx-local_1 Attaching to testnginx_nginx-local_1 nginx-local_1 | 172.22.0.5 - - [29/Jul/2018:15:32:02 +0000] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 612 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537 (KHTML, like Gecko) Chrome/67.0 Safari/537"</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.2.3"</span></span> nginx-local_1 | 2018/07/29 15:32:02 [error] 8<span class="hljs-comment"><span class="hljs-comment">#8: *2 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.22.0.5, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "test.NAS.cloudns.cc", referrer: "https://test.NAS.cloudns.cc/" nginx-local_1 | 172.22.0.5 - - [29/Jul/2018:15:32:02 +0000] "GET /favicon.ico HTTP/1.1" 404 572 "https://test.NAS.cloudns.cc/" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537 (KHTML, like Gecko) Chrome/67.0 Safari/537" "192.168.2.3"</span></span></code> </pre> <br><p>     : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wj/-v/q3/wj-vq3xwns34rsn_tr8zvycwiei.png" alt="Meluncurkan Nginx"></a> </p><br><p> ,  ,    ,    ,   :     . </p><br><p>      ,   Ctrl+C,   <code>docker-compose down</code> . </p><br><h3 id="nastroyka-konteynera-s-local-rpoxy">    local-rpoxy </h3><br><p>   ,      nginx-default  ,     nas, omv        10080  10443   . </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-local/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="bash hljs">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: external: name: docker0 services: nginx-local: restart: always image: nginx:alpine expose: - 80 - 443 environment: - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_HOST=NAS.cloudns.cc,nas,nas.*,www.*,omv.*,nas-controller.nas"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PROTO=http"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PORT=80"</span></span> - CERT_NAME=NAS.cloudns.cc volumes: - ./<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-config:/etc/nginx/conf.d networks: - docker0</code> </pre> </div></div><br><p>   docker-compose    ,        . <br> ,   ,  ,     <code>NAS.cloudns.cc</code> .    ,     NAS    DNS ,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-local/local-config/default.conf</b> <div class="spoiler_text"><pre> <code class="hljs mel"># If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the # scheme used to connect to this server map $http_x_forwarded_proto $proxy_x_forwarded_proto { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> $http_x_forwarded_proto; <span class="hljs-string"><span class="hljs-string">''</span></span> $scheme; } # If we receive X-Forwarded-Port, pass it through; otherwise, pass along the # server port the client connected to map $http_x_forwarded_port $proxy_x_forwarded_port { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> $http_x_forwarded_port; <span class="hljs-string"><span class="hljs-string">''</span></span> $server_port; } # Set appropriate X-Forwarded-Ssl header map $scheme $proxy_x_forwarded_ssl { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> off; https on; } access_log on; error_log on; # HTTP <span class="hljs-number"><span class="hljs-number">1.1</span></span> support proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_buffering off; proxy_set_header Host $http_host; proxy_set_header Upgrade $http_upgrade; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto; proxy_set_header X-Forwarded-Ssl $proxy_x_forwarded_ssl; proxy_set_header X-Forwarded-Port $proxy_x_forwarded_port; # Mitigate httpoxy attack (see README <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details) proxy_set_header Proxy <span class="hljs-string"><span class="hljs-string">""</span></span>; server { server_name _; # This is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">503</span></span>; } server { server_name www.* nas.* omv.* <span class="hljs-string"><span class="hljs-string">""</span></span>; listen <span class="hljs-number"><span class="hljs-number">80</span></span>; location / { proxy_pass https:<span class="hljs-comment"><span class="hljs-comment">//172.21.0.1:10443/; } } # nas-controller server { server_name nas-controller.nas; listen 80 ; location / { proxy_pass https://nas-controller/; } }</span></span></code> </pre> </div></div><br><ul><li> <code>172.21.0.1</code> ‚Äî  .       443,        OMV   HTTPS.        . </li><li> <code>https://nas-controller/</code> ‚Äî -,      IPMI,     nas,   nas-controller.nas,       nas-controller.   . </li></ul><br><h2>    LDAP </h2><br><h3 id="nastroyka-ldap-servera">  LDAP- </h3><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">LDAP-</a> ‚Äî      . <br>     Docker .  ,  ,       . </p><br><p>    LDIF-  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/ldap/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: "2" networks: ldap: docker0: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: docker0 services: <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap: image: "osixia/openldap:1.2.0" hostname: "open-ldap" <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> environment: - "LDAP_ORGANISATION=NAS" - "LDAP_DOMAIN=nas.nas" - "LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD" - "LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD" - "LDAP_TLS=true" - "LDAP_TLS_ENFORCE=false" - "LDAP_TLS_CRT_FILENAME=ldap_server.crt" - "LDAP_TLS_KEY_FILENAME=ldap_server.key" - "LDAP_TLS_CA_CRT_FILENAME=ldap_server.crt" volumes: - ./certs:/container/service/slapd/assets/certs - ./ldap_data/var/lib:/var/lib/ldap - ./ldap_data/etc/ldap/slapd.d:/etc/ldap/slapd.d networks: - ldap ports: - <span class="hljs-number"><span class="hljs-number">172.21</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span> - <span class="hljs-number"><span class="hljs-number">172.21</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>::<span class="hljs-number"><span class="hljs-number">636</span></span>:<span class="hljs-number"><span class="hljs-number">636</span></span> phpldapadmin: image: "osixia/phpldapadmin:0.7.1" hostname: "nas.nas" <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> networks: - ldap - docker0 expose: - <span class="hljs-number"><span class="hljs-number">443</span></span> links: - <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap:<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> volumes: - ./certs:/container/service/phpldapadmin/assets/apache2/certs environment: - VIRTUAL_HOST=ldap.* - VIRTUAL_PORT=<span class="hljs-number"><span class="hljs-number">443</span></span> - VIRTUAL_PROTO=https - CERT_NAME=NAS.cloudns.cc - "PHPLDAPADMIN_LDAP_HOSTS=open-ldap-server" #- "PHPLDAPADMIN_HTTPS=false" - "PHPLDAPADMIN_HTTPS_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_HTTPS_KEY_FILENAME=private/ldap_server.key" - "PHPLDAPADMIN_HTTPS_CA_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT=allow" ldap-ssp: image: openfrontier/ldap-ssp:https volumes: #- ./ssp/mods-enabled/ssl.conf:/etc/apache2/mods-enabled/ssl.conf - /etc/ssl/certs/ssl-cert-snakeoil.pem:/etc/ssl/certs/ssl-cert-snakeoil.pem - /etc/ssl/private/ssl-cert-snakeoil.key:/etc/ssl/private/ssl-cert-snakeoil.key <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> networks: - ldap - docker0 expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> links: - <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap:<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> environment: - VIRTUAL_HOST=ssp.* - VIRTUAL_PORT=<span class="hljs-number"><span class="hljs-number">80</span></span> - VIRTUAL_PROTO=http - CERT_NAME=NAS.cloudns.cc - "LDAP_URL=ldap://open-ldap-server:389" - "LDAP_BINDDN=cn=admin,dc=nas,dc=nas" - "LDAP_BINDPW=ADMIN_PASSWORD" - "LDAP_BASE=ou=users,dc=nas,dc=nas" - "MAIL_FROM=admin@nas.nas" - "PWD_MIN_LENGTH=8" - "PWD_MIN_LOWER=3" - "PWD_MIN_DIGIT=2" - "SMTP_HOST=" - "SMTP_USER=" - "SMTP_PASS="</code> </pre> </div></div><br><p>     : </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>open-ldap</code></a> ‚Äî LDAP-. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>phpldapadmin</code></a> ‚Äî WEB-   .       ,   ... </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>ldap-ssp</code></a> ‚Äî WEB-    . </li></ul><br><p> LDAP-    ,     : </p><br><ul><li> <code>LDAP_ORGANISATION=NAS</code> ‚Äî  .   . </li><li> <code>LDAP_DOMAIN=nas.nas</code> ‚Äî .  .    ,    . </li><li> <code>LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD</code> ‚Äî  . </li><li> <code>LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD</code> ‚Äî   . </li></ul><br><p> -,       "  ",  . </p><br><p> : </p><br><ul><li> <code>/container/service/slapd/assets/certs</code>     <code>certs</code> ‚Äî .   . </li><li> <code>./ldap_data/</code> ‚Äî  ,        .  LDAP   . </li></ul><br><p>      <code>ldap</code> ,    389 ( LDAP)  636 (LDAP  SSL,   )    . </p><br><p> PhpLdapAdmin    :     LDAP   <code>ldap</code>    443   <code>docker0</code> ,  ,      nginx-reverse-proxy. </p><br><p> : </p><br><ul><li> <code>VIRTUAL_HOST=ldap.*</code> ‚Äî ,  nginx-reverse-proxy   . </li><li> <code>VIRTUAL_PORT=443</code> ‚Äî   nginx-reverse-proxy. </li><li> <code>VIRTUAL_PROTO=https</code> ‚Äî   nginx-reverse-proxy. </li><li> <code>CERT_NAME=NAS.cloudns.cc</code> ‚Äî  ,   . </li></ul><br><p>        SSL    . </p><br><p> SSP   HTTP      . <br> ,     ,       . </p><br><p>    ‚Äî             LDAP. </p><br><ul><li> <code>LDAP_URL=ldap://open-ldap-server:389</code> ‚Äî    LDAP  (.  <code>links</code> ). </li><li> <code>LDAP_BINDDN=cn=admin,dc=nas,dc=nas</code> ‚Äî      . </li><li> <code>LDAP_BINDPW=ADMIN_PASSWORD</code> ‚Äî  ,     ,    open-ldap. </li><li> <code>LDAP_BASE=ou=users,dc=nas,dc=nas</code> ‚Äî   ,      . </li></ul><br><p>         LDAP   LDAP : </p><br><pre> <code class="bash hljs">apt-get install ldap-utils ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W -f ldifs/inititialize_ldap.ldif ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W -f ldifs/base.ldif ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,cn=config"</span></span> -W -f ldifs/gitlab_attr.ldif</code> </pre> <br><p>  <code>gitlab_attr.ldif</code>  ,   Gitlab (  )   . <br>         . </p><br><div class="spoiler"> <b class="spoiler_title">  LDAP </b> <div class="spoiler_text"><pre> <code class="bash hljs">$ ldapsearch -x -H ldap://172.21.0.1 -b dc=nas,dc=nas -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W Enter LDAP Password: <span class="hljs-comment"><span class="hljs-comment"># extended LDIF # # LDAPv3 # base &lt;dc=nas,dc=nas&gt; with scope subtree # filter: (objectclass=*) # requesting: ALL # # nas.nas dn: dc=nas,dc=nas objectClass: top objectClass: dcObject objectClass: organization o: NAS dc: nas # admin, nas.nas dn: cn=admin,dc=nas,dc=nas objectClass: simpleSecurityObject objectClass: organizationalRole cn: admin description: LDAP administrator ... # ldap_users, groups, nas.nas dn: cn=ldap_users,ou=groups,dc=nas,dc=nas cn: ldap_users gidNumber: 500 objectClass: posixGroup objectClass: top # search result search: 2 result: 0 Success # numResponses: 12 # numEntries: 11</span></span></code> </pre> </div></div><br><p>    LDAP  .      WEB-. </p><br><h3 id="nastroyka-omv-dlya-vhoda-po-ldap">  OMV    LDAP </h3><br><p>  LDAP    , OMV       :  , ,   ,          ,    ‚Äî  . </p><br><p> LDAP      . </p><br><p>    : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/0e/fq/yp/0efqypb4eevkfvm1dx5hccpxcae.png" alt="Konfigurasikan OMV untuk bekerja dengan LDAP"></a> </p><br><h2>     </h2><br><p>     ,     ,     NAS  USB. <br>          . <br>     NUT  GUI OMV. <br>    <em>"-&gt;"</em> ,  ,      ,  ,  "eaton". </p><br><p>   <em>"  "</em>  : </p><br><pre> <code class="hljs pgsql">driver = usbhid-ups port = auto <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> = "Eaton 9130 700 VA" vendorid = <span class="hljs-number"><span class="hljs-number">0463</span></span> pollinterval = <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br><ul><li> <code>driver = usbhid-ups</code> ‚Äî    USB,    USB HID. </li><li> <code>vendorid</code> ‚Äî    ,      <code>lsusb</code> . </li><li> <code>pollinterval</code> ‚Äî     c. </li></ul><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> . </p><br><p>  <code>lsusb</code> ,     : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># lsusb Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub --&gt; Bus 001 Device 003: ID 0463:ffff MGE UPS Systems UPS Bus 001 Device 004: ID 046b:ff10 American Megatrends, Inc. Virtual Keyboard and Mouse Bus 001 Device 002: ID 046b:ff01 American Megatrends, Inc. Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span></span></code> </pre> <br><p> <em>" "</em>    "  ". <br>    ,    : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/0v/1e/5c/0v1e5ceg5axff7qac7gnqqlv5dc.png" alt="Pengaturan UPS"></a> </p><br><p>     .    ,        . <br>     . </p><br><h2>  Kesimpulan </h2><br><p>       .   ,       ,     ,   ,   . <br>      ‚Äî  . </p><br><p>    -, OMV   . </p><br><p>     WEB-,       ,   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/tb/p3/ja/tbp3jabundd-ifinj76eimw-me0.png"></a> </p><br><p>  Docker     WEB-: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ol/1o/h_/ol1oh_koe2adncdkhh9qozsufkm.png"></a> </p><br><p>  , OMV    . </p><br><p>   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fq/n7/v2/fqn7v20f3vq1ekj7ygcg1jbv2cu.png" alt="Jadwal Penggunaan Jaringan"></a> </p><br><p>   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/52/k4/3e/52k43eckcekf7bxfxqmsbnv4hlm.png" alt="Grafik penggunaan memori"></a> </p><br><p>   CPU: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/qn/e8/ir/qne8ir6ndfbl17zyvzzl5vyexs0.png" alt="Grafik penggunaan CPU"></a> </p><br><h2 id="nerealizovannoe">  </h2><br><ul><li>    ‚Äî   . ,     -  .   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>docker-compose exec</code></a> ,       . </li><li> LDAP      ,     ( SSL ,      ..). </li><li>          ,    ,    . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">ValdikSS</a>      DropbearSSH,   initramfs     .     . </li></ul><br><p>   . <br>  ! </p><br><p><img src="https://habrastorage.org/webt/n0/dy/xy/n0dyxyaz2tzyp5q1vvdskj1fr9c.jpeg"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id415779/">https://habr.com/ru/post/id415779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id415769/index.html">Siapkan peluncuran otomatis uji UI aplikasi Android melalui TeamCity</a></li>
<li><a href="../id415771/index.html">Go Compiler: Aturan Optimasi SSA Deskripsi Bahasa</a></li>
<li><a href="../id415773/index.html">Persyaratan non-fungsional: Skalabilitas</a></li>
<li><a href="../id415775/index.html">Sederhana, tetapi tidak jelas, kiat untuk menyiapkan laporan untuk konferensi keren</a></li>
<li><a href="../id415777/index.html">Kejuaraan pembelajaran mesin pertama dalam pengembangan</a></li>
<li><a href="../id415781/index.html">Mengapa fisikawan berpikir teori string bisa berubah menjadi "teori segalanya"</a></li>
<li><a href="../id415783/index.html">Cakram bintang mengungkapkan kepada kita rahasia kemunculan planet-planet</a></li>
<li><a href="../id415785/index.html">SpaceX mengirimkan robot kecerdasan buatan ke ISS</a></li>
<li><a href="../id415789/index.html">Algoritma Paten untuk Program Komputer</a></li>
<li><a href="../id415791/index.html">Optimalisasi kontrak pintar. Bagaimana Jenis Soliditas Mempengaruhi Biaya Transaksi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>