<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍛 👼🏾 🍃 使用pytest进行Python测试。 第2章，编写测试函数 👏🏿 😮 😻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="返回 下一个 


 您将学习如何将测试组织到类，模块和目录中。 然后，我将向您展示如何使用标记来标记要运行的测试，并讨论内置标记如何帮助您跳过测试并标记测试，以防失败。 最后，我将讨论测试的参数化，该参数化允许使用不同的数据调用测试。 





 本书中的示例是使用Python 3.6和pyte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>使用pytest进行Python测试。 第2章，编写测试函数</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448788/"><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">返回</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">下一个</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  <em>您将学习如何将测试组织到类，模块和目录中。</em>  <em>然后，我将向您展示如何使用标记来标记要运行的测试，并讨论内置标记如何帮助您跳过测试并标记测试，以防失败。</em>  <em>最后，我将讨论测试的参数化，该参数化允许使用不同的数据调用测试。</em> </p><br><p><img src="https://habrastorage.org/webt/hd/--/9w/hd--9w134j0rxhmxftrflbbdopy.png"></p><a name="habracut"></a><br><p> 本书中的示例是使用Python 3.6和pytest 3.2编写的。  pytest 3.2支持Python 2.6、2.7和Python 3.3+。 </p><br><blockquote>本书网页上的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="https://pragprog.com/titles/bopytest/source_code">链接</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="https://pragprog.com/titles/bopytest">pragprog.com</a>上提供了Tasks项目以及本书中显示的所有测试的源代码。 您无需下载源代码即可了解测试代码。 示例中以方便的形式提供了测试代码。 但是，为了跟上项目的任务，或者改编测试示例来测试自己的项目（不费力气！），您必须转到本书的网页并下载工作。 在该书的网页上，有一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="https://pragprog.com/titles/bopytest/errata">勘误</a>信息链接和一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="https://forums.pragprog.com/forums/438">论坛</a> 。 </blockquote><p> 在剧透下方是该系列文章的列表。 </p><br><div class="spoiler">  <b class="spoiler_title">目录</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>引言</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>第1章：pytest入门</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>第2章：编写测试函数</strong></a> （本文） </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>第3章：Pytest固定装置</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>第4章：内置灯具</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>第5章：插件</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>第6章：配置</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>第7章：与其他工具一起使用pytest</strong></a> </li></ul></div></div><br><p> 在上一章中，您运行了pytest。 您了解了如何使用文件和目录运行它以及有多少个选项起作用。 在本章中，您将学习如何在测试Python包的上下文中编写测试函数。 如果您使用pytest测试除Python软件包以外的任何内容，那么本章的大部分内容将对您有所帮助。 </p><br><p> 我们将为Tasks包编写测试。 在执行此操作之前，我将讨论Python分发包的结构及其测试，以及如何使测试能够看到测试包。 然后，我将向您展示如何在测试中使用断言，测试如何处理意外的异常以及测试预期的异常。 </p><br><p> 最后，我们将进行许多测试。 这样，您将学习如何将测试组织到类，模块和目录中。 然后，我将向您展示如何使用标记来标记要运行的测试，并讨论内置标记如何帮助您跳过测试并标记测试，以防失败。 最后，我将讨论测试的参数化，该参数化允许使用不同的数据调用测试。 </p><br><blockquote> <strong><em>译者注：</em></strong> <strong><em>如果您使用的是Python 3.5或3.6，</em></strong>则在第2章中运行测试时，您可能会收到类似以下的消息 <br><img src="https://habrastorage.org/webt/57/eq/4x/57eq4xsrdjfiyxn9g9ihresujc8.jpeg"><br> 通过修复<code>...\code\tasks_proj\src\tasks\tasksdb_tinydb.py</code>并重新安装任务包，可以解决此问题<code>...\code\tasks_proj\src\tasks\tasksdb_tinydb.py</code> <br><pre> <code class="plaintext hljs">$ cd /path/to/code $ pip install ./tasks_proj/`</code> </pre> <br><br> 您<code>eids</code>在模块中<code>doc_ids</code> <code>eids</code>上<code>doc_ids</code>命名参数<code>eids</code>和<code>eids</code>上的<code>eid</code> <code>...\code\tasks_proj\src\tasks\tasksdb_tinydb.py</code> <br><br> 说明请参阅<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处的</a> <code>#83783</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">。</a> </blockquote><br><h2 id="testirovanie-paketa"> 包装测试 </h2><br><p> 要了解如何为Python包编写测试功能，我们将使用第xii页上的Tasks项目中所述的示例Tasks项目。  Tasks是一个Python软件包，其中包含具有相同任务名称的命令行工具。 </p><br><p> 附录4，打包和分发Python项目，第175页，介绍了如何在一个小团队内部或通过PyPI在全球范围内分发您的项目，因此，我将不做任何详细介绍。 但是，让我们快速查看一下Tasks项目中的内容以及不同文件如何适合该项目的测试历史记录。 </p><br><p> 以下是Tasks项目的文件结构： </p><br><pre> <code class="plaintext hljs">tasks_proj/ ├── CHANGELOG.rst ├── LICENSE ├── MANIFEST.in ├── README.rst ├── setup.py ├── src │ └── tasks │ ├── __init__.py │ ├── api.py │ ├── cli.py │ ├── config.py │ ├── tasksdb_pymongo.py │ └── tasksdb_tinydb.py └── tests ├── conftest.py ├── pytest.ini ├── func │ ├── __init__.py │ ├── test_add.py │ └── ... └── unit ├── __init__.py ├── test_task.py └── ...</code> </pre> <br><p> 我提供了项目的完整列表（测试文件的完整列表除外），以指示测试如何适合项目的其余部分，并指向几个测试的关键文件，即<em>conftest.py，pytest.ini</em>和各种<em><code>__init__.py</code></em>文件和<em>setup.py</em> 。 </p><br><p> 所有测试都存储在<em>测试中，</em>并且与<em>src中</em>的包源文件分开。 这不是pytest的要求，但这是最佳实践。 </p><br><p> 所有顶级文件<em>CHANGELOG.rst，LICENSE，README.rst，MANIFEST.in</em>和<em>setup.py</em>在第175页的附录4，打包和分发Python项目中都有更详细的讨论。尽管<em>setup.py</em>对于构建发行版<em>很</em>重要从软件包中下载，以及用于在本地安装软件包的功能，以便可以导入该软件包。 </p><br><p> 功能测试和单元测试分为各自的目录。 这是一个任意决定，不是必需的。 但是，将测试文件组织到几个目录中可以轻松地运行测试的子集。 我喜欢将功能测试和单元测试分开，因为只有在我们有意更改系统功能时，功能测试才会中断，而在重构或实现更改期间，单元测试可能会中断。 </p><br><p> 该项目包含<code>__init__.py</code>文件的两种类型：在<code>src/</code>目录中找到的文件和在<code>tests/</code>找到的文件。  <code>src/tasks/__init__.py</code>告诉Python该目录是一个包。 当有人使用<code>import tasks</code>时，它也充当包的主要接口。 它包含用于从<code>api.py</code>导入某些函数的代码，因此<code>cli.py</code>和我们的测试文件可以访问包函数，例如<code>tasks.add()</code> ，而不是执行<code>task.api.add ()</code> 。  <code>tests/func/__init__.py</code>文件<code>tests/func/__init__.py</code>和<code>tests/unit/__init__.py</code>为空。 他们告诉pytest在一个目录中查找测试目录的根目录和<code>pytest.ini</code>文件。 </p><br><p>  <code>pytest.ini</code>文件是可选的。 它包含整个项目的常规pytest配置。 您的项目最多只能有一个。 它可能包含更改pytest行为的指令，例如，设置将始终使用的参数列表。 您将在第113页的第6章“配置”中了解有关<code>pytest.ini</code>全部信息。 </p><br><p>  conftest.py文件也是可选的。  pytest被视为“本地插件”，并且可能包含挂钩函数和装置。  <em>挂钩函数</em>是一种将代码嵌入pytest运行时的一部分以更改pytest的工作方式的方法。 夹具是在测试功能之前和之后运行的设置和拆卸功能，可用于表示测试使用的资源和数据。  （在第49页的第3章pytest固定装置和在第71页的第4章内置固定装置中讨论了固定装置，在第95页的第5章“插件”中讨论了挂钩函数。）多个子目录中的测试应包含在tests / conftest.py中。 您可以有几个conftest.py文件； 例如，在测试中可以有一个，而在每个测试子目录中可以有一个。 </p><br><p> 如果您尚未这样做，则可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在</a>本书的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">网站</a>上下载该项目的源代码副本。 或者，您可以使用类似的结构来处理项目。 </p><br><p> 这是test_task.py： </p><br><blockquote>  <strong>ch2 / task_proj /测试/单元/ test_task.py</strong> </blockquote><br><pre> <code class="plaintext hljs">"""Test the Task data type.""" # -*- coding: utf-8 -*- from tasks import Task def test_asdict(): """_asdict()   .""" t_task = Task('do something', 'okken', True, 21) t_dict = t_task._asdict() expected = {'summary': 'do something', 'owner': 'okken', 'done': True, 'id': 21} assert t_dict == expected def test_replace(): """replace ()      .""" t_before = Task('finish book', 'brian', False) t_after = t_before._replace(id=10, done=True) t_expected = Task('finish book', 'brian', True, 10) assert t_after == t_expected def test_defaults(): """        .""" t1 = Task() t2 = Task(None, None, False, None) assert t1 == t2 def test_member_access(): """ .field  namedtuple.""" t = Task('buy milk', 'brian') assert t.summary == 'buy milk' assert t.owner == 'brian' assert (t.done, t.id) == (False, None)</code> </pre> <br><p>  <em>test_task.py</em>文件包含以下导入语句： </p><br><pre> <code class="plaintext hljs">from tasks import Task</code> </pre> <br><p> 让测试导入任务或从任务中导入某些东西的最佳方法是使用pip在本地安装任务。 这是可能的，因为有一个setup.py文件可直接调用pip。 </p><br><p> 通过运行<code>pip install .</code>安装任务<code>pip install .</code> 或<code>pip install -e .</code> 从task_proj目录中。 或从上一级目录运行<code>pip install -e tasks_proj</code>另一个选项： </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code $ pip install ./tasks_proj/ $ pip install --no-cache-dir ./tasks_proj/ Processing ./tasks_proj Collecting click (from tasks==0.1.0) Downloading click-6.7-py2.py3-none-any.whl (71kB) ... Collecting tinydb (from tasks==0.1.0) Downloading tinydb-3.4.0.tar.gz Collecting six (from tasks==0.1.0) Downloading six-1.10.0-py2.py3-none-any.whl Installing collected packages: click, tinydb, six, tasks Running setup.py install for tinydb ... done Running setup.py install for tasks ... done Successfully installed click-6.7 six-1.10.0 tasks-0.1.0 tinydb-3.4.0</code> </pre> <br><p> 如果只想运行任务测试，则可以执行此命令。 如果您希望能够在任务安装过程中更改源代码，则需要使用带有-e选项的安装（对于可编辑的“可编辑”）： </p><br><pre> <code class="plaintext hljs">$ pip install -e ./tasks_proj/ Obtaining file:///path/to/code/tasks_proj Requirement already satisfied: click in /path/to/venv/lib/python3.6/site-packages (from tasks==0.1.0) Requirement already satisfied: tinydb in /path/to/venv/lib/python3.6/site-packages (from tasks==0.1.0) Requirement already satisfied: six in /path/to/venv/lib/python3.6/site-packages (from tasks==0.1.0) Installing collected packages: tasks Found existing installation: tasks 0.1.0 Uninstalling tasks-0.1.0: Successfully uninstalled tasks-0.1.0 Running setup.py develop for tasks Successfully installed tasks</code> </pre> <br><p> 现在尝试运行测试： </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch2/tasks_proj/tests/unit $ pytest test_task.py ===================== test session starts ====================== collected 4 items test_task.py .... =================== 4 passed in 0.01 seconds ===================</code> </pre> <br><p> 导入有效！ 现在，其他测试可以安全地使用导入任务。 现在让我们编写一些测试。 </p><br><h2 id="ispolzovanie-operatorov-assert"> 使用断言语句 </h2><br><p> 在编写测试函数时，常规的Python语句assert是报告测试失败的主要工具。  pytest的简单性非常出色。 这就是使许多开发人员在其他框架之上使用pytest的原因。 </p><br><p> 如果您使用任何其他测试平台，则可能会看到各种断言助手功能。 例如，以下是一些形式的assert和assert辅助函数的列表： </p><br><div class="scrollable-table"><table><thead><tr><th>  <strong>pytest</strong> </th><th>  <strong>单元测试</strong> </th></tr></thead><tbody><tr><td> 断言 </td><td>  assertTrue（某物） </td></tr><tr><td> 断言a == b </td><td>  assertEqual（a，b） </td></tr><tr><td> 断言a &lt;= b </td><td>  assertLessEqual（a，b） </td></tr><tr><td>  ... </td><td>  ... </td></tr></tbody></table></div><br><p> 使用pytest，您可以对任何表达式使用assert &lt;表达式&gt;。 如果将表达式转换为bool时其计算结果为False，则测试将失败。 </p><br><p>  pytest包含一个称为断言重写的函数，该函数将拦截断言调用并将其替换为可以告诉您更多有关语句失败原因的信息。 让我们看看如果看到一些语句错误，这种重写有多么有用： </p><br><blockquote>  <strong>ch2 / task_proj /测试/单元/ test_task_fail.py</strong> </blockquote><br><pre> <code class="plaintext hljs">""" the Task type    .""" from tasks import Task def test_task_equality(): """     .""" t1 = Task('sit there', 'brian') t2 = Task('do something', 'okken') assert t1 == t2 def test_dict_equality(): """ ,   dicts,    .""" t1_dict = Task('make sandwich', 'okken')._asdict() t2_dict = Task('make sandwich', 'okkem')._asdict() assert t1_dict == t2_dict</code> </pre> <br><p> 所有这些测试均失败，但是跟踪中的信息很有趣： </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\unit&gt;pytest test_task_fail.py ============================= test session starts ============================= collected 2 items test_task_fail.py FF ================================== FAILURES =================================== _____________________________ test_task_equality ______________________________ def test_task_equality(): """Different tasks should not be equal.""" t1 = Task('sit there', 'brian') t2 = Task('do something', 'okken') &gt; assert t1 == t2 E AssertionError: assert Task(summary=...alse, id=None) == Task(summary='...alse, id=None) E At index 0 diff: 'sit there' != 'do something' E Use -v to get the full diff test_task_fail.py:9: AssertionError _____________________________ test_dict_equality ______________________________ def test_dict_equality(): """Different tasks compared as dicts should not be equal.""" t1_dict = Task('make sandwich', 'okken')._asdict() t2_dict = Task('make sandwich', 'okkem')._asdict() &gt; assert t1_dict == t2_dict E AssertionError: assert OrderedDict([...('id', None)]) == OrderedDict([(...('id', None)]) E Omitting 3 identical items, use -vv to show E Differing items: E {'owner': 'okken'} != {'owner': 'okkem'} E Use -v to get the full diff test_task_fail.py:16: AssertionError ========================== 2 failed in 0.30 seconds ===========================</code> </pre> <br><p> 哇！ 这是很多信息。 对于每个不成功的测试，将显示确切的错误字符串，并带有&gt;失败指针。  E行显示有关断言失败的其他信息，以帮助您了解问题所在。 </p><br><p> 我故意在<code>test_task_equality()</code>放置了两个不匹配<code>test_task_equality()</code> ，但在前面的代码中仅显示了第一个不匹配<code>test_task_equality()</code> 。 根据错误消息中的建议，让我们再次使用<code>-v</code>标志： </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\unit&gt;pytest -v test_task_fail.py ============================= test session starts ============================= collected 2 items test_task_fail.py::test_task_equality FAILED test_task_fail.py::test_dict_equality FAILED ================================== FAILURES =================================== _____________________________ test_task_equality ______________________________ def test_task_equality(): """Different tasks should not be equal.""" t1 = Task('sit there', 'brian') t2 = Task('do something', 'okken') &gt; assert t1 == t2 E AssertionError: assert Task(summary=...alse, id=None) == Task(summary='...alse, id=None) E At index 0 diff: 'sit there' != 'do something' E Full diff: E - Task(summary='sit there', owner='brian', done=False, id=None) E ? ^^^ ^^^ ^^^^ E + Task(summary='do something', owner='okken', done=False, id=None) E ? +++ ^^^ ^^^ ^^^^ test_task_fail.py:9: AssertionError _____________________________ test_dict_equality ______________________________ def test_dict_equality(): """Different tasks compared as dicts should not be equal.""" t1_dict = Task('make sandwich', 'okken')._asdict() t2_dict = Task('make sandwich', 'okkem')._asdict() &gt; assert t1_dict == t2_dict E AssertionError: assert OrderedDict([...('id', None)]) == OrderedDict([(...('id', None)]) E Omitting 3 identical items, use -vv to show E Differing items: E {'owner': 'okken'} != {'owner': 'okkem'} E Full diff: E {'summary': 'make sandwich', E - 'owner': 'okken', E ? ^... E E ...Full output truncated (5 lines hidden), use '-vv' to show test_task_fail.py:16: AssertionError ========================== 2 failed in 0.28 seconds ===========================</code> </pre> <br><p> 好吧，我认为这太酷了！  pytest不仅能够找到这两个差异，而且还向我们确切说明了这些差异在哪里。 这个例子只使用相等断言。 您可以在pytest.org上找到assert语句的更多变体，以及令人惊叹的跟踪调试信息。 </p><br><h2 id="ozhidanie-isklyucheniy-expected-exception"> 预期异常 </h2><br><p>  Tasks API中的多个地方都可能发生异常。 让我们快速看一下<em>task / api.py</em>中的函数： </p><br><pre> <code class="plaintext hljs">def add(task): # type: (Task) -\&gt; int def get(task_id): # type: (int) -\&gt; Task def list_tasks(owner=None): # type: (str|None) -\&gt; list of Task def count(): # type: (None) -\&gt; int def update(task_id, task): # type: (int, Task) -\&gt; None def delete(task_id): # type: (int) -\&gt; None def delete_all(): # type: () -\&gt; None def unique_id(): # type: () -\&gt; int def start_tasks_db(db_path, db_type): # type: (str, str) -\&gt; None def stop_tasks_db(): # type: () -\&gt; None</code> </pre> <br><p>  <em>cli.py中</em>的CLI代码和<em>api.py中</em>的API代码之间<em>就将</em>哪种类型传递给API函数达成了协议。 如果类型不正确，我希望可以在API调用中引发异常。 要确保这些函数在未正确调用的情况下引发异常，请在测试函数中使用错误的类型故意引发TypeError异常，并与pytest.raises（预期的异常）一起使用，例如： </p><br><blockquote>  <strong>ch2 / tasks_proj /测试/func/test_api_exceptions.py</strong> </blockquote><br><pre> <code class="plaintext hljs">"""    -   API.""" import pytest import tasks def test_add_raises(): """add()       param.""" with pytest.raises(TypeError): tasks.add(task='not a Task object')</code> </pre> <br><p> 在<code>test_add_raises()</code> ，使用<code>pytest.raises(TypeError)</code> ：该语句报告下一段代码中的所有内容均应引发TypeError异常。 如果未引发异常，则测试将失败。 如果测试引发另一个异常，则它将失败。 </p><br><p> 我们只是在<code>test_add_raises()</code>检查了异常类型。 您还可以检查排除选项。 对于<code>start_tasks_db(db_path, db_type)</code> ，不仅<em>db_type</em>应该是字符串，而且实际上应该是'tiny'或'mongo'。 您可以通过添加excinfo来检查异常消息是否正确： </p><br><blockquote>  <strong>ch2 / tasks_proj /测试/func/test_api_exceptions.py</strong> </blockquote><br><pre> <code class="plaintext hljs">def test_start_tasks_db_raises(): """,     .""" with pytest.raises(ValueError) as excinfo: tasks.start_tasks_db('some/great/path', 'mysql') exception_msg = excinfo.value.args[0] assert exception_msg == "db_type must be a 'tiny' or 'mongo'"</code> </pre> <br><p> 这使我们可以更仔细地研究此异常。  as之后的变量名（在本例中为excinfo）中填充了异常信息，并且其类型为ExceptionInfo。 </p><br><p> 在我们的例子中，我们要确保第一个（也是唯一的）异常参数与字符串匹配。 </p><br><h2 id="marking-test-functions"> 标记测试功能 </h2><br><p>  pytest提供了一种很酷的机制来将标记放入测试函数中。 一个测试可以有多个标记，并且一个标记可以处于多个测试中。 </p><br><p> 在您看到标记的作用后，标记对您便有意义。 假设我们希望将测试的子集作为快速的“烟雾测试”来了解系统中是否存在严重的差距。 按照惯例，Smoke测试不是全面的，全面的测试套件，而是可以快速运行的选定子集，可为开发人员提供有关系统所有部分运行状况的良好印象。 </p><br><p> 要将烟雾测试套件添加到Tasks项目，您需要为某些测试添加<code>@mark.pytest.smoke</code> 。 让我们将其添加到几个<code>test_api_exceptions.py</code>测试中（请注意， <code>test_api_exceptions.py</code>中没有内置Smoke和<em>get</em>标记；我只是想出了它们）： </p><br><blockquote>  <strong>ch2 / tasks_proj /测试/func/test_api_exceptions.py</strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.mark.smoke def test_list_raises(): """list()       param.""" with pytest.raises(TypeError): tasks.list_tasks(owner=123) @pytest.mark.get @pytest.mark.smoke def test_get_raises(): """get()       param.""" with pytest.raises(TypeError): tasks.get(task_id='123')</code> </pre> <br><p> 现在，我们仅运行那些带有<code>-m marker_name</code>标记的测试： </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests&gt;cd func (venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v -m "smoke" test_api_exceptions.py ============================= test session starts ============================= collected 7 items test_api_exceptions.py::test_list_raises PASSED test_api_exceptions.py::test_get_raises PASSED ============================= 5 tests deselected ============================== =================== 2 passed, 5 deselected in 0.18 seconds ==================== (venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt; (venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v -m "get" test_api_exceptions.py ============================= test session starts ============================= collected 7 items test_api_exceptions.py::test_get_raises PASSED ============================= 6 tests deselected ============================== =================== 1 passed, 6 deselected in 0.13 seconds ====================</code> </pre> <br><p> 请记住， <code>-v</code> <code>--verbose</code>缩写，它使我们能够查看正在运行的测试的名称。 使用-m'smoke'运行两个测试，标记为@ pytest.mark.smoke。 </p><br><p> 使用<code>@pytest.mark.get</code> '将运行一个标记为<code>@pytest.mark.get</code>测试。 很简单 </p><br><p> 一切都变成奇迹，奇迹！  <code>-m</code>之后的表达式可以使用<code>and</code> ， <code>or</code>和<code>not</code>组合多个标记： </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v -m "smoke and get" test_api_exceptions.py ============================= test session starts ============================= collected 7 items test_api_exceptions.py::test_get_raises PASSED ============================= 6 tests deselected ============================== =================== 1 passed, 6 deselected in 0.13 seconds ====================</code> </pre> <br><p> 我们只在<code>smoke</code>并<code>get</code>标记的情况下进行了此测试。 我们可以<code>not</code>使用： </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v -m "smoke and not get" test_api_exceptions.py ============================= test session starts ============================= collected 7 items test_api_exceptions.py::test_list_raises PASSED ============================= 6 tests deselected ============================== =================== 1 passed, 6 deselected in 0.13 seconds ====================</code> </pre> <br><p> 添加<code>@pytest.mark.smoke</code> <code>-m 'smoke and not get'</code>选择一个标记为<code>@pytest.mark.smoke</code>而不是<code>@pytest.mark.get</code> 。 </p><br><h3 id="zapolnenie-smoke-test"> 烟雾测试填充 </h3><br><p> 以前的测试似乎还不是一套合理的<code>smoke test</code> 。 实际上，我们没有触摸数据库，也没有添加任何任务。 当然，必须进行<code>smoke test</code> 。 </p><br><p> 让我们添加一些考虑添加任务的测试，并将其中一个用作<em>烟雾</em>测试套件的一部分： </p><br><blockquote>  <strong>ch2 / task_proj /测试/ func / test_add.py</strong> </blockquote><br><pre> <code class="plaintext hljs">"""  API tasks.add ().""" import pytest import tasks from tasks import Task def test_add_returns_valid_id(): """tasks.add(valid task)    .""" # GIVEN an initialized tasks db # WHEN a new task is added # THEN returned task_id is of type int new_task = Task('do something') task_id = tasks.add(new_task) assert isinstance(task_id, int) @pytest.mark.smoke def test_added_task_has_id_set(): """,   task_id  tasks.add().""" # GIVEN an initialized tasks db # AND a new task is added new_task = Task('sit in chair', owner='me', done=True) task_id = tasks.add(new_task) # WHEN task is retrieved task_from_db = tasks.get(task_id) # THEN task_id matches id field assert task_from_db.id == task_id</code> </pre> <br><p> 这两个测试在初始化的任务数据库上都有GIVEN注释，但是测试中没有初始化的数据库。 我们可以定义夹具来在测试之前初始化数据库，并在测试之后进行清理： </p><br><blockquote>  <strong>ch2 / task_proj /测试/ func / test_add.py</strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.fixture(autouse=True) def initialized_tasks_db(tmpdir): """Connect to db before testing, disconnect after.""" # Setup : start db tasks.start_tasks_db(str(tmpdir), 'tiny') yield #    # Teardown : stop db tasks.stop_tasks_db()</code> </pre> <br><p> 本示例中使用的夹具tmpdir是内置夹具。 您将在第71页的第4章，内置装置中学习有关内置装置的所有信息，并在第49页的第3章pytest装置中学习如何编写自己的装置以及它们如何工作，包括此处使用的autouse参数。 </p><br><p> 测试中使用的自动使用情况表明该文件中的所有测试都将使用fixture。 在每次测试之前执行<code>yield</code>之前的代码； 测试后执行<code>yield</code>之后的代码。 如果需要，yield可以将数据返回到测试。 在接下来的章节中，您将考虑所有这些以及更多内容，但是在这里，我们需要以某种方式配置数据库以进行测试，因此我不再需要等待，而是必须向您展示该设备（当然是设备！）。  （pytest还支持老式的设置和拆卸功能，例如在<strong>unittest</strong>和<strong>鼻子中</strong>使用的功能，但并不那么有趣。但是，如果您感兴趣的话，请参见第183页的附录5 xUnit固定装置。） </p><br><p> 现在让我们推迟对灯具的讨论，然后转到项目的开始并运行我们的<em>烟雾测试套件</em> ： </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;cd .. (venv33) ...\bopytest-code\code\ch2\tasks_proj\tests&gt;cd .. (venv33) ...\bopytest-code\code\ch2\tasks_proj&gt;pytest -v -m "smoke" ============================= test session starts ============================= collected 56 items tests/func/test_add.py::test_added_task_has_id_set PASSED tests/func/test_api_exceptions.py::test_list_raises PASSED tests/func/test_api_exceptions.py::test_get_raises PASSED ============================= 53 tests deselected ============================= =================== 3 passed, 53 deselected in 0.49 seconds ===================</code> </pre> <br><p> 它显示了来自不同文件的标记测试可以一起运行。 </p><br><h2 id="propusk-testov-skipping-tests"> 跳过测试 </h2><br><p> 尽管第31页的标记验证方法中讨论的标记是您选择的名称，但是pytest包含一些有用的内置标记： <code>skip</code> ， <code>skipif</code>和<code>xfail</code> 。 在本节中，我将讨论<code>skip</code>和<code>skipif</code> ，以及下一个<code>-xfail</code> 。 </p><br><p> 使用<code>skip</code>和<code>skipif</code>可以跳过不需要执行的测试。 例如，假设我们不知道<code>tasks.unique_id()</code>应该如何工作。 每个电话应返回不同的号码？    ,       ? </p><br><p> -,    (,        <code>initialized_tasks_db</code> ;     ): </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_unique_id_1.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">"""Test tasks.unique_id().""" import pytest import tasks def test_unique_id(): """ unique_id ()     .""" id_1 = tasks.unique_id() id_2 = tasks.unique_id() assert id_1 != id_2</code> </pre> <br><p>    : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest test_unique_id_1.py ============================= test session starts ============================= collected 1 item test_unique_id_1.py F ================================== FAILURES =================================== _______________________________ test_unique_id ________________________________ def test_unique_id(): """Calling unique_id() twice should return different numbers.""" id_1 = tasks.unique_id() id_2 = tasks.unique_id() &gt; assert id_1 != id_2 E assert 1 != 1 test_unique_id_1.py:11: AssertionError ========================== 1 failed in 0.30 seconds ===========================</code> </pre> <br><p> 嗯  ,  .   API  ,  ,  docstring  """Return an integer that does not exist in the db.""",   <em>  ,     DB</em> .      .       ,   : </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_unique_id_2.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.mark.skip(reason='misunderstood the API') def test_unique_id_1(): """ unique_id ()     .""" id_1 = tasks.unique_id() id_2 = tasks.unique_id() assert id_1 != id_2 def test_unique_id_2(): """unique_id()    id.""" ids = [] ids.append(tasks.add(Task('one'))) ids.append(tasks.add(Task('two'))) ids.append(tasks.add(Task('three'))) #   id uid = tasks.unique_id() # ,        assert uid not in ids</code> </pre> <br><p>  ,   ,   ,   <code>@pytest..skip()</code>    . </p><br><p>  : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_unique_id_2.py ============================= test session starts ============================= collected 2 items test_unique_id_2.py::test_unique_id_1 SKIPPED test_unique_id_2.py::test_unique_id_2 PASSED ===================== 1 passed, 1 skipped in 0.19 seconds =====================</code> </pre> <br><p>  ,   -   ,       ,         0.2.0 .           skipif: </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_unique_id_3.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.mark.skipif(tasks.__version__ &lt; '0.2.0', reason='not supported until version 0.2.0') def test_unique_id_1(): """ unique_id ()     .""" id_1 = tasks.unique_id() id_2 = tasks.unique_id() assert id_1 != id_2</code> </pre> <br><p> ,     <code>skipif()</code> ,      Python.   ,  ,    .      <em>skip</em> ,    <em>skipif</em> .     <em>skip</em> ,     <em>skipif</em> .      ( <em>reason</em> )   <em>skip</em> , <em>skipif</em>  <em>xfail</em> .    : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest test_unique_id_3.py ============================= test session starts ============================= collected 2 items test_unique_id_3.py s. ===================== 1 passed, 1 skipped in 0.20 seconds =====================</code> </pre> <br><p> <code>s.</code> ,     (skipped),    (passed).   ,    -  <code>-v</code> : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_unique_id_3.py ============================= test session starts ============================= collected 2 items test_unique_id_3.py::test_unique_id_1 SKIPPED test_unique_id_3.py::test_unique_id_2 PASSED ===================== 1 passed, 1 skipped in 0.19 seconds =====================</code> </pre> <br><p>       .        <code>-rs</code> : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -rs test_unique_id_3.py ============================= test session starts ============================= collected 2 items test_unique_id_3.py s. =========================== short test summary info =========================== SKIP [1] func\test_unique_id_3.py:8: not supported until version 0.2.0 ===================== 1 passed, 1 skipped in 0.22 seconds =====================</code> </pre> <br><p>  <code>-r chars</code>    : </p><br><pre> <code class="plaintext hljs">$ pytest --help ... -r chars show extra test summary info as specified by chars (     ,  ) (f)ailed, (E)error, (s)skipped, (x)failed, (X)passed, (p)passed, (P)passed with output, (a)all except pP. ...</code> </pre> <br><p>        ,           . </p><br><h2 id="markirovka-testov-ozhidayuschih-sboya">     </h2><br><p>    <code>skip</code>  <code>skipif</code>    ,   .    <code>xfail</code>   pytest   ,  ,    .     <code>unique_id ()</code> ,   <code>xfail</code> : </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_unique_id_4.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.mark.xfail(tasks.__version__ &lt; '0.2.0', reason='not supported until version 0.2.0') def test_unique_id_1(): """ unique_id()     .""" id_1 = tasks.unique_id() id_2 = tasks.unique_id() assert id_1 != id_2 @pytest.mark.xfail() def test_unique_id_is_a_duck(): """ xfail.""" uid = tasks.unique_id() assert uid == 'a duck' @pytest.mark.xfail() def test_unique_id_not_a_duck(): """ xpass.""" uid = tasks.unique_id() assert uid != 'a duck'</code> </pre> <br><p> Running this shows: </p><br><p>    ,   ,   <code>xfail</code> .         == vs.! =.      . </p><br><p>   : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest test_unique_id_4.py ============================= test session starts ============================= collected 4 items test_unique_id_4.py xxX. =============== 1 passed, 2 xfailed, 1 xpassed in 0.36 seconds ================</code> </pre> <br><p> X  XFAIL,   «  ( <em>expected to fail</em> )».  X   XPASS  «,    ,   ( <em>expected to fail but passed.</em> )». </p><br><p> <code>--verbose</code>    : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_unique_id_4.py ============================= test session starts ============================= collected 4 items test_unique_id_4.py::test_unique_id_1 xfail test_unique_id_4.py::test_unique_id_is_a_duck xfail test_unique_id_4.py::test_unique_id_not_a_duck XPASS test_unique_id_4.py::test_unique_id_2 PASSED =============== 1 passed, 2 xfailed, 1 xpassed in 0.36 seconds ================</code> </pre> <br><p>    <em>pytest</em> ,  ,  ,    <code>xfail</code> ,   FAIL.    <em>pytest.ini</em> : </p><br><pre> <code class="plaintext hljs">[pytest] xfail_strict=true</code> </pre> <br><p>    <em>pytest.ini</em>    6, ,  . 113. </p><br><h2 id="vypolnenie-podmnozhestva-testov">    </h2><br><p>    ,         ​​    .       .        , ,          .      ,       .        .    . </p><br><h3 id="a-single-directory"> A Single Directory </h3><br><p>       ,      <em>pytest</em> : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj&gt;pytest tests\func --tb=no ============================= test session starts ============================= collected 50 items tests\func\test_add.py .. tests\func\test_add_variety.py ................................ tests\func\test_api_exceptions.py ....... tests\func\test_unique_id_1.py F tests\func\test_unique_id_2.py s. tests\func\test_unique_id_3.py s. tests\func\test_unique_id_4.py xxX. ==== 1 failed, 44 passed, 2 skipped, 2 xfailed, 1 xpassed in 1.75 seconds =====</code> </pre> <br><p>     ,   <code>-v</code>      ,   . </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj&gt;pytest -v tests\func --tb=no ============================= test session starts =============================</code> </pre> <br><p>  ... </p><br><pre> <code class="plaintext hljs">collected 50 items tests\func\test_add.py::test_add_returns_valid_id PASSED tests\func\test_add.py::test_added_task_has_id_set PASSED tests\func\test_add_variety.py::test_add_1 PASSED tests\func\test_add_variety.py::test_add_2[task0] PASSED tests\func\test_add_variety.py::test_add_2[task1] PASSED tests\func\test_add_variety.py::test_add_2[task2] PASSED tests\func\test_add_variety.py::test_add_2[task3] PASSED tests\func\test_add_variety.py::test_add_3[sleep-None-False] PASSED ... tests\func\test_unique_id_2.py::test_unique_id_1 SKIPPED tests\func\test_unique_id_2.py::test_unique_id_2 PASSED ... tests\func\test_unique_id_4.py::test_unique_id_1 xfail tests\func\test_unique_id_4.py::test_unique_id_is_a_duck xfail tests\func\test_unique_id_4.py::test_unique_id_not_a_duck XPASS tests\func\test_unique_id_4.py::test_unique_id_2 PASSED ==== 1 failed, 44 passed, 2 skipped, 2 xfailed, 1 xpassed in 2.05 seconds =====</code> </pre> <br><p>   ,      . </p><br><h3 id="odinochnyy-test-filemodule">   File/Module </h3><br><p>   ,  ,          pytest: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch2/tasks_proj $ pytest tests/func/test_add.py =========================== test session starts =========================== collected 2 items tests/func/test_add.py .. ======================== 2 passed in 0.05 seconds =========================</code> </pre> <br><p>        . </p><br><h3 id="odinochnaya-testovaya-funkciya">    </h3><br><p>     ,  <code>::</code>    : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch2/tasks_proj $ pytest -v tests/func/test_add.py::test_add_returns_valid_id =========================== test session starts =========================== collected 3 items tests/func/test_add.py::test_add_returns_valid_id PASSED ======================== 1 passed in 0.02 seconds =========================</code> </pre> <br><p>  <code>-v</code> ,  ,    . </p><br><h3 id="odinochnyy-test-class">  Test Class </h3><br><p> Here's an example: </p><br><p>   —    ,     . <br> 这是一个例子： </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/</strong> <code>test_api_exceptions.py</code> </blockquote><br><pre> <code class="plaintext hljs">class TestUpdate(): """    tasks.update().""" def test_bad_id(self): """non-int id   excption.""" with pytest.raises(TypeError): tasks.update(task_id={'dict instead': 1}, task=tasks.Task()) def test_bad_task(self): """A non-Task task   excption.""" with pytest.raises(TypeError): tasks.update(task_id=1, task='not a task')</code> </pre> <br><p>      ,     <code>update()</code> ,     .     ,   ,        <code>::</code> ,      : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj&gt;pytest -v tests/func/test_api_exceptions.py::TestUpdate ============================= test session starts ============================= collected 2 items tests\func\test_api_exceptions.py::TestUpdate::test_bad_id PASSED tests\func\test_api_exceptions.py::TestUpdate::test_bad_task PASSED ========================== 2 passed in 0.12 seconds ===========================</code> </pre> <br><h3 id="a-single-test-method-of-a-test-class"> A Single Test Method of a Test Class </h3><br><p>        ,     —     <code>::</code>   : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch2/tasks_proj $ pytest -v tests/func/test_api_exceptions.py::TestUpdate::test_bad_id ===================== test session starts ====================== collected 1 item tests/func/test_api_exceptions.py::TestUpdate::test_bad_id PASSED =================== 1 passed in 0.03 seconds ===================</code> </pre> <br><blockquote> <strong> ,   </strong> <br><br> ,        , , ,      .   ,        <code>pytest -v</code> . </blockquote><br><h3 id="nabor-testov-na-osnove-bazovogo-imeni-testa">        </h3><br><p>  <code>-k</code>      ,         .       <code>and</code> , <code>or</code>  <code>not</code>  . ,        <code>_raises</code> : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj&gt;pytest -v -k _raises ============================= test session starts ============================= collected 56 items tests/func/test_api_exceptions.py::test_add_raises PASSED tests/func/test_api_exceptions.py::test_list_raises PASSED tests/func/test_api_exceptions.py::test_get_raises PASSED tests/func/test_api_exceptions.py::test_delete_raises PASSED tests/func/test_api_exceptions.py::test_start_tasks_db_raises PASSED ============================= 51 tests deselected ============================= =================== 5 passed, 51 deselected in 0.54 seconds ===================</code> </pre> <br><p>    <code>and</code>  <code>not</code>    <code>test_delete_raises()</code>  : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj&gt;pytest -v -k "_raises and not delete" ============================= test session starts ============================= collected 56 items tests/func/test_api_exceptions.py::test_add_raises PASSED tests/func/test_api_exceptions.py::test_list_raises PASSED tests/func/test_api_exceptions.py::test_get_raises PASSED tests/func/test_api_exceptions.py::test_start_tasks_db_raises PASSED ============================= 52 tests deselected ============================= =================== 4 passed, 52 deselected in 0.44 seconds ===================</code> </pre> <br><p>     ,     , ,         <code>-k</code>     .     ,          ,         . </p><br><h2 id="parametrized-testing-parametrizovannoe-testirovanie"> [Parametrized Testing]:   </h2><br><p>         ,     ,       .                  .  -               pytest,  -    . </p><br><p>    ,     ,      <code>add()</code> : </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_add_variety.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">"""  API tasks.add().""" import pytest import tasks from tasks import Task def test_add_1(): """tasks.get ()  id,   add() works.""" task = Task('breathe', 'BRIAN', True) task_id = tasks.add(task) t_from_db = tasks.get(task_id) # ,  ,    assert equivalent(t_from_db, task) def equivalent(t1, t2): """   .""" #  ,   id return ((t1.summary == t2.summary) and (t1.owner == t2.owner) and (t1.done == t2.done)) @pytest.fixture(autouse=True) def initialized_tasks_db(tmpdir): """    ,  .""" tasks.start_tasks_db(str(tmpdir), 'tiny') yield tasks.stop_tasks_db()</code> </pre> <br><p>    tasks   <code>id</code>   <code>None</code> .           <code>id</code> .       <code>==</code> ,  ,        .   <code>equivalent()</code>  ,   <code>id</code> .  <code>autouse</code> ,  ,    .  ,   : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_add_variety.py::test_add_1 ============================= test session starts ============================= collected 1 item test_add_variety.py::test_add_1 PASSED ========================== 1 passed in 0.69 seconds ===========================</code> </pre> <br><p>   .   ,      .  ,       ?  .    <code>@pytest.mark.parametrize(argnames, argvalues)</code>          , : </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_add_variety.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.mark.parametrize('task', [Task('sleep', done=True), Task('wake', 'brian'), Task('breathe', 'BRIAN', True), Task('exercise', 'BrIaN', False)]) def test_add_2(task): """    .""" task_id = tasks.add(task) t_from_db = tasks.get(task_id) assert equivalent(t_from_db, task)</code> </pre> <br><p>   <code>parametrize()</code> —        — 'task',   .   —   ,         Task. pytest               : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_add_variety.py::test_add_2 ============================= test session starts ============================= collected 4 items test_add_variety.py::test_add_2[task0] PASSED test_add_variety.py::test_add_2[task1] PASSED test_add_variety.py::test_add_2[task2] PASSED test_add_variety.py::test_add_2[task3] PASSED ========================== 4 passed in 0.69 seconds ===========================</code> </pre> <br><p>  <code>parametrize()</code>    .      ,  ,      : </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_add_variety.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.mark.parametrize('summary, owner, done', [('sleep', None, False), ('wake', 'brian', False), ('breathe', 'BRIAN', True), ('eat eggs', 'BrIaN', False), ]) def test_add_3(summary, owner, done): """    .""" task = Task(summary, owner, done) task_id = tasks.add(task) t_from_db = tasks.get(task_id) assert equivalent(t_from_db, task)</code> </pre> <br><p>   ,        pytest,       ,      : </p><br><pre> <code class="plaintext hljs">(venv35) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_add_variety.py::test_add_3 ============================= test session starts ============================= platform win32 -- Python 3.5.2, pytest-3.5.1, py-1.5.3, pluggy-0.6.0 -- cachedir: ..\.pytest_cache rootdir: ...\bopytest-code\code\ch2\tasks_proj\tests, inifile: pytest.ini collected 4 items test_add_variety.py::test_add_3[sleep-None-False] PASSED [ 25%] test_add_variety.py::test_add_3[wake-brian-False] PASSED [ 50%] test_add_variety.py::test_add_3[breathe-BRIAN-True] PASSED [ 75%] test_add_variety.py::test_add_3[eat eggs-BrIaN-False] PASSED [100%] ========================== 4 passed in 0.37 seconds ===========================</code> </pre> <br><p>  ,      ,     pytest,    : </p><br><pre> <code class="plaintext hljs">(venv35) c:\BOOK\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_add_variety.py::test_add_3[sleep-None-False] ============================= test session starts ============================= test_add_variety.py::test_add_3[sleep-None-False] PASSED [100%] ========================== 1 passed in 0.22 seconds ===========================</code> </pre> <br><p>   ,     : </p><br><pre> <code class="plaintext hljs">(venv35) c:\BOOK\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v "test_add_variety.py::test_add_3[eat eggs-BrIaN-False]" ============================= test session starts ============================= collected 1 item test_add_variety.py::test_add_3[eat eggs-BrIaN-False] PASSED [100%] ========================== 1 passed in 0.56 seconds ===========================</code> </pre> <br><p>      ,        : </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_add_variety.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">tasks_to_try = (Task('sleep', done=True), Task('wake', 'brian'), Task('wake', 'brian'), Task('breathe', 'BRIAN', True), Task('exercise', 'BrIaN', False)) @pytest.mark.parametrize('task', tasks_to_try) def test_add_4(task): """ .""" task_id = tasks.add(task) t_from_db = tasks.get(task_id) assert equivalent(t_from_db, task)</code> </pre> <br><p>      .     : </p><br><pre> <code class="plaintext hljs">(venv35) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_add_variety.py::test_add_4 ============================= test session starts ============================= collected 5 items test_add_variety.py::test_add_4[task0] PASSED [ 20%] test_add_variety.py::test_add_4[task1] PASSED [ 40%] test_add_variety.py::test_add_4[task2] PASSED [ 60%] test_add_variety.py::test_add_4[task3] PASSED [ 80%] test_add_variety.py::test_add_4[task4] PASSED [100%] ========================== 5 passed in 0.34 seconds ===========================</code> </pre> <br><p>      ,     .    ,      ids  <code>parametrize()</code> ,          .  <code>ids</code>       ,     . ,         <code>tasks_to_try</code> ,       : </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_add_variety.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">task_ids = ['Task({},{},{})'.format(t.summary, t.owner, t.done) for t in tasks_to_try] @pytest.mark.parametrize('task', tasks_to_try, ids=task_ids) def test_add_5(task): """Demonstrate ids.""" task_id = tasks.add(task) t_from_db = tasks.get(task_id) assert equivalent(t_from_db, task)</code> </pre> <br><p>     ,   : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_add_variety.py::test_add_5 ============================= test session starts ============================= collected 5 items test_add_variety.py::test_add_5[Task(sleep,None,True)] PASSED test_add_variety.py::test_add_5[Task(wake,brian,False)0] PASSED test_add_variety.py::test_add_5[Task(wake,brian,False)1] PASSED test_add_variety.py::test_add_5[Task(breathe,BRIAN,True)] PASSED test_add_variety.py::test_add_5[Task(exercise,BrIaN,False)] PASSED ========================== 5 passed in 0.45 seconds ===========================</code> </pre> <br><p>        : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v "test_add_variety.py::test_add_5[Task(exercise,BrIaN,False)]" ============================= test session starts ============================= collected 1 item test_add_variety.py::test_add_5[Task(exercise,BrIaN,False)] PASSED ========================== 1 passed in 0.21 seconds ===========================</code> </pre> <br><p>       ;          shell.     <code>parametrize()</code>  .               : </p><br><blockquote> <strong>ch2/tasks_proj/tests/func/ <code>test_add_variety.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.mark.parametrize('task', tasks_to_try, ids=task_ids) class TestAdd(): """   .""" def test_equivalent(self, task): """ ,   .""" task_id = tasks.add(task) t_from_db = tasks.get(task_id) assert equivalent(t_from_db, task) def test_valid_id(self, task): """          .""" task_id = tasks.add(task) t_from_db = tasks.get(task_id) assert t_from_db.id == task_id</code> </pre> <br><p>    : </p><br><pre> <code class="plaintext hljs">(venv33) ...\bopytest-code\code\ch2\tasks_proj\tests\func&gt;pytest -v test_add_variety.py::TestAdd ============================= test session starts ============================= collected 10 items test_add_variety.py::TestAdd::test_equivalent[Task(sleep,None,True)] PASSED test_add_variety.py::TestAdd::test_equivalent[Task(wake,brian,False)0] PASSED test_add_variety.py::TestAdd::test_equivalent[Task(wake,brian,False)1] PASSED test_add_variety.py::TestAdd::test_equivalent[Task(breathe,BRIAN,True)] PASSED test_add_variety.py::TestAdd::test_equivalent[Task(exercise,BrIaN,False)] PASSED test_add_variety.py::TestAdd::test_valid_id[Task(sleep,None,True)] PASSED test_add_variety.py::TestAdd::test_valid_id[Task(wake,brian,False)0] PASSED test_add_variety.py::TestAdd::test_valid_id[Task(wake,brian,False)1] PASSED test_add_variety.py::TestAdd::test_valid_id[Task(breathe,BRIAN,True)] PASSED test_add_variety.py::TestAdd::test_valid_id[Task(exercise,BrIaN,False)] PASSED ========================== 10 passed in 1.16 seconds ==========================</code> </pre> <br><p>     ,            <code>@pytest.mark.parametrize()</code> .       <code>pytest.param(&lt;value\&gt;, id="something")</code> : </p><br><p>  : </p><br><pre> <code class="plaintext hljs">(venv35) ...\bopytest-code\code\ch2\tasks_proj\tests\func $ pytest -v test_add_variety.py::test_add_6 ======================================== test session starts ========================================= collected 3 items test_add_variety.py::test_add_6[just summary] PASSED [ 33%] test_add_variety.py::test_add_6[summary\owner] PASSED [ 66%] test_add_variety.py::test_add_6[summary\owner\done] PASSED [100%] ================================ 3 passed, 6 warnings in 0.35 seconds ================================</code> </pre> <br><p>  ,  <code>id</code>       . </p><br><h2 id="uprazhneniya"> 练习题 </h2><br><ol><li>     , <code>task_proj</code> ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-  </a>  ,         <code>pip install /path/to/tasks_proj</code> . </li><li>   . </li><li>  <em>pytest</em>   . </li><li>  <em>pytest</em>   ,  <code>tasks_proj/tests/func</code> .  pytest     ,     .     .  ,    ? </li><li>  xfail      ,     pytest   tests    . </li><li>      <code>tasks.count()</code> ,   .    API  ,     ,  ,    . </li><li>          ?       <code>test_api_exceptions.py</code> . ,      . (   <code>api.py</code>   .) </li></ol><br><h2 id="chto-dalshe"> 接下来是什么 </h2><br><p>         <em>pytest</em> . ,   ,   ,       .         <code>initialized_tasks_db</code> .     /        . </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他们还可以分隔通用代码，以便多个测试功能可以使用相同的设置。</font><font style="vertical-align: inherit;">在下一章中，您将深入研究pytest灯具的美好世界。</font></font></p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">返回</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">下一个</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN448788/">https://habr.com/ru/post/zh-CN448788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN448776/index.html">RxVMS-适用于Flutter应用程序的实用架构</a></li>
<li><a href="../zh-CN448778/index.html">为Visual Studio Enterprise 2019引入时间旅行调试</a></li>
<li><a href="../zh-CN448780/index.html">什么使软件可以赚钱</a></li>
<li><a href="../zh-CN448782/index.html">使用pytest进行Python测试。 pytest入门，第1章</a></li>
<li><a href="../zh-CN448786/index.html">使用pytest进行Python测试。 第3章pytest固定装置</a></li>
<li><a href="../zh-CN448790/index.html">SpaceVIL-用于在.Net Core，.Net Standard和JVM上开发的跨平台GUI框架</a></li>
<li><a href="../zh-CN448796/index.html">使用pytest进行Python测试。 配置，第6章</a></li>
<li><a href="../zh-CN448798/index.html">使用pytest进行Python测试。 将pytest与其他工具结合使用，第7章</a></li>
<li><a href="../zh-CN448800/index.html">使用.vsconfig在整个组织中配置Visual Studio</a></li>
<li><a href="../zh-CN448802/index.html">关于门户网站的思考：在虚幻引擎4中创建门户网站</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>