<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüî¨ üë©‚Äçüîß üë©üèΩ‚Äçü§ù‚Äçüë®üèª Teste de Python com pytest. Usando pytest com outras ferramentas, CAP√çTULO 7 üèÄ üß• üòπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Voltar 


 Normalmente, o pytest n√£o √© usado independentemente, mas em um ambiente de teste com outras ferramentas. Este cap√≠tulo discute outras ferra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teste de Python com pytest. Usando pytest com outras ferramentas, CAP√çTULO 7</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448798/"><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Voltar</a> </p><br><p>  <em>Normalmente, o pytest n√£o √© usado independentemente, mas em um ambiente de teste com outras ferramentas.</em>  <em>Este cap√≠tulo discute outras ferramentas que s√£o frequentemente usadas em conjunto com o pytest para testes eficazes e eficientes.</em>  <em>Embora essa n√£o seja de forma alguma uma lista exaustiva, as ferramentas discutidas aqui fornecer√£o uma id√©ia do sabor do poder de misturar o pytest com outras ferramentas.</em> </p><br><p><img src="https://habrastorage.org/webt/hd/--/9w/hd--9w134j0rxhmxftrflbbdopy.png"></p><a name="habracut"></a><br><p>  Os exemplos deste livro foram escritos usando Python 3.6 e pytest 3.2.  O pytest 3.2 suporta Python 2.6, 2.7 e Python 3.3+. </p><br><blockquote> O c√≥digo-fonte do projeto Tarefas, bem como todos os testes mostrados neste livro, est√£o dispon√≠veis no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="https://pragprog.com/titles/bopytest/source_code">link</a> na p√°gina da Web do livro em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="https://pragprog.com/titles/bopytest">pragprog.com</a> .  Voc√™ n√£o precisa fazer o download do c√≥digo-fonte para entender o c√≥digo de teste;  o c√≥digo de teste √© apresentado de forma conveniente nos exemplos.  Mas, para acompanhar as tarefas do projeto ou adaptar exemplos de teste para testar seu pr√≥prio projeto (suas m√£os est√£o desamarradas!), Voc√™ deve acessar a p√°gina da Web do livro e fazer o download do trabalho.  L√°, na p√°gina do livro, h√° um link para mensagens de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="https://pragprog.com/titles/bopytest/errata">errata</a> e um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="https://forums.pragprog.com/forums/438">f√≥rum de discuss√£o</a> . </blockquote><p>  Sob o spoiler, h√° uma lista de artigos desta s√©rie. </p><br><div class="spoiler">  <b class="spoiler_title">Sum√°rio</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>1. Introdu√ß√£o</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Cap√≠tulo 1: Introdu√ß√£o ao pytest</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Cap√≠tulo 2: Escrevendo fun√ß√µes de teste</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Cap√≠tulo 3: Acess√≥rios Pytest</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Cap√≠tulo 4: Acess√≥rios embutidos</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Cap√≠tulo 5: Plugins</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Cap√≠tulo 6: Configura√ß√£o</strong></a> </li><li>  [ <strong>Cap√≠tulo 7: Usando pytest com outras ferramentas</strong> ] (Este artigo) ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://habr.com/en/post/448798/</a> ) </li></ul></div></div><br><h2 id="pdb-debugging-test-failures">  PDB: falhas de teste de depura√ß√£o </h2><br><p> O m√≥dulo <code>pdb</code> √© um depurador Python na biblioteca padr√£o.  Voc√™ usa <code>--pdb</code> para que o pytest inicie uma sess√£o de depura√ß√£o no ponto de falha.  Vejamos o <code>pdb</code> em a√ß√£o no contexto do projeto Tarefas. </p><br><p>  Em ‚ÄúParametrizando o dispositivo el√©trico‚Äù na p√°gina 64, deixamos o projeto Tarefas com alguns erros: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3/c/tasks_proj $ pytest --tb=no -q .........................................FF.FFFF FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF.FFF........... 42 failed, 54 passed in 4.74 seconds</code> </pre> <br><p>  Antes de <code>pdb</code> como o <code>pdb</code> pode nos ajudar a depurar esse teste, vamos dar uma olhada nas op√ß√µes pytest dispon√≠veis para acelerar a depura√ß√£o dos erros de teste, que examinamos pela primeira vez na se√ß√£o ‚ÄúUsando op√ß√µes‚Äù na p√°gina 9: </p><br><ul><li>  <code>--tb=[auto/long/short/line/native/no]</code> : controla o estilo de rastreamento. </li><li>  <code>-v / --verbose</code> : exibe todos os nomes de teste que foram aprovados ou falharam. </li><li>  <code>-l / --showlocals</code> : exibe vari√°veis ‚Äã‚Äãlocais ao lado do rastreamento de pilha. </li><li>  <code>-lf / --last-failed</code> : Executa apenas testes que falham. </li><li>  <code>-x / --exitfirst</code> : interrompe a sess√£o de teste na primeira falha. </li><li>  <code>--pdb</code> : inicia uma sess√£o de depura√ß√£o interativa no ponto de falha. </li></ul><br><hr><br><p>  <em>Instalando o MongoDB</em> </p><br><hr><br><p>  Conforme mencionado no Cap√≠tulo 3, ‚ÄúAcess√≥rios Pytest‚Äù, na p√°gina 49, a instala√ß√£o do <code>MongoDB</code> e do <code>pymongo</code> √© necess√°ria para executar os testes do MongoDB. </p><br><p>  Testei a vers√£o do Community Server encontrada em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.mongodb.com/download-center</a> .  O pymongo √© instalado com <code>pip</code> : <code>pip install pymongo</code> .  No entanto, este √© o √∫ltimo exemplo de um livro que usa o MongoDB.  Para testar o depurador sem usar o MongoDB, voc√™ pode executar os comandos pytest a partir do <code>code/ch2/</code> , pois esse diret√≥rio tamb√©m cont√©m v√°rios testes com falha. </p><br><hr><br><p>  Acabamos de executar os testes do <code>code/ch3/c</code> para garantir que alguns deles n√£o estejam funcionando.  N√£o vimos tracebacks ou nomes de teste porque <code>--tb=no</code> desativa o rastreamento e n√£o t√≠nhamos <code>--verbose</code> ativado.  Vamos repetir os erros (n√£o mais que tr√™s) com o texto detalhado: </p><br><pre> <code class="plaintext hljs">$ pytest --tb=no --verbose --lf --maxfail=3 ============================= test session starts ============================= collected 96 items / 52 deselected run-last-failure: rerun previous 44 failures tests/func/test_add.py::test_add_returns_valid_id[mongo] ERROR [ 2%] tests/func/test_add.py::test_added_task_has_id_set[mongo] ERROR [ 4%] tests/func/test_add.py::test_add_increases_count[mongo] ERROR [ 6%] =================== 52 deselected, 3 error in 0.72 seconds ====================</code> </pre> <br><p>  Agora sabemos quais testes falharam.  Vejamos apenas um deles, usando <code>-x</code> , ativando o rastreamento, n√£o usando <code>--tb=no</code> e mostrando vari√°veis ‚Äã‚Äãlocais com <code>-l</code> : </p><br><pre> <code class="plaintext hljs">$ pytest -v --lf -l -x ===================== test session starts ====================== run-last-failure: rerun last 42 failures collected 96 items tests/func/test_add.py::test_add_returns_valid_id[mongo] FAILED =========================== FAILURES =========================== _______________ test_add_returns_valid_id[mongo] _______________ tasks_db = None def test_add_returns_valid_id(tasks_db): """tasks.add(&lt;valid task&gt;) should return an integer.""" # GIVEN an initialized tasks db # WHEN a new task is added # THEN returned task_id is of type int new_task = Task('do something') task_id = tasks.add(new_task) &gt; assert isinstance(task_id, int) E AssertionError: assert False E + where False = isinstance(ObjectId('59783baf8204177f24cb1b68'), int) new_task = Task(summary='do something', owner=None, done=False, id=None) task_id = ObjectId('59783baf8204177f24cb1b68') tasks_db = None tests/func/test_add.py:16: AssertionError !!!!!!!!!!!! Interrupted: stopping after 1 failures !!!!!!!!!!!! ===================== 54 tests deselected ====================== =========== 1 failed, 54 deselected in 2.47 seconds ============</code> </pre><br><p>  Muitas vezes, isso √© suficiente para entender por que o teste falhou.  Nesse caso espec√≠fico, √© bastante claro que <code>task_id</code> n√£o <code>task_id</code> um n√∫mero inteiro - √© uma inst√¢ncia do ObjectId.  ObjectId √© o tipo usado pelo MongoDB para identificadores de objeto no banco de dados.  Minha inten√ß√£o com a camada <code>tasksdb_pymongo.py</code> era ocultar certos detalhes da implementa√ß√£o do MongoDB do restante do sistema.  √â claro que, neste caso, n√£o funcionou. </p><br><p>  No entanto, queremos ver como usar o pdb com o pytest, ent√£o vamos imaginar que n√£o est√° claro por que esse teste falhou.  Podemos fazer com que o pytest inicie uma sess√£o de depura√ß√£o e nos inicie no ponto da falha usando <code>--pdb</code> : </p><br><pre> <code class="plaintext hljs">$ pytest -v --lf -x --pdb ===================== test session starts ====================== run-last-failure: rerun last 42 failures collected 96 items tests/func/test_add.py::test_add_returns_valid_id[mongo] FAILED &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; traceback &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; tasks_db = None def test_add_returns_valid_id(tasks_db): """tasks.add(&lt;valid task&gt;) should return an integer.""" # GIVEN an initialized tasks db # WHEN a new task is added # THEN returned task_id is of type int new_task = Task('do something') task_id = tasks.add(new_task) &gt; assert isinstance(task_id, int) E AssertionError: assert False E + where False = isinstance(ObjectId('59783bf48204177f2a786893'), int) tests/func/test_add.py:16: AssertionError &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; entering PDB &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &gt; /path/to/code/ch3/c/tasks_proj/tests/func/test_add.py(16) &gt; test_add_returns_valid_id() -&gt; assert isinstance(task_id, int) (Pdb)</code> </pre> <br><p>  Agora que estamos no prompt (Pdb), temos acesso a todos os recursos interativos de depura√ß√£o de pdb.  Ao visualizar falhas, uso regularmente estes comandos: </p><br><ul><li>  <code>p/print expr</code> : imprime o valor da exp. </li><li>  <code>pp expr</code> : Pretty imprime o valor de expr. </li><li>  <code>l/list</code> : lista o ponto de falha e cinco linhas de c√≥digo acima e abaixo. </li><li>  <code>l/list begin,end</code> : enumera n√∫meros de linha espec√≠ficos. </li><li>  <code>a/args</code> : imprime os argumentos da fun√ß√£o atual com seus valores. </li><li>  <code>u/up</code> : Move um n√≠vel acima do caminho da pilha. </li><li>  <code>d/down</code> : desce um n√≠vel no rastreamento de pilha. </li><li>  <code>q/quit</code> : finaliza uma sess√£o de depura√ß√£o. </li></ul><br><p>  Outros comandos de navega√ß√£o, como step e next, n√£o s√£o muito √∫teis, pois estamos sentados na declara√ß√£o assert.  Voc√™ tamb√©m pode simplesmente inserir nomes de vari√°veis ‚Äã‚Äãe obter valores. </p><br><p>  Voc√™ pode usar <code>p/print expr</code> maneira semelhante √† <code>-l/--showlocals</code> para visualizar os valores em uma fun√ß√£o: </p><br><pre> <code class="plaintext hljs">(Pdb) p new_task Task(summary='do something', owner=None, done=False, id=None) (Pdb) p task_id ObjectId('59783bf48204177f2a786893') (Pdb)</code> </pre> <br><p>  Agora voc√™ pode sair do depurador e continuar testando. </p><br><pre> <code class="plaintext hljs">(Pdb) q !!!!!!!!!!!! Interrupted: stopping after 1 failures !!!!!!!!!!!! ===================== 54 tests deselected ====================== ========== 1 failed, 54 deselected in 123.40 seconds ===========</code> </pre> <br><p>  Se n√£o us√°ssemos <code>-</code> , o pytest abriria novamente o Pdb no pr√≥ximo teste.  Mais informa√ß√µes sobre o uso do m√≥dulo pdb est√£o dispon√≠veis na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Python</a> . </p><br><h2 id="coveragepy-opredelenie-obema-testiruemogo-koda">  Coverage.py: determinando a quantidade de c√≥digo de teste </h2><br><p>  A cobertura do c√≥digo √© um indicador da porcentagem de c√≥digo testado que √© testado por um conjunto de testes.  Quando voc√™ executa testes para o projeto Tarefas, algumas fun√ß√µes de Tarefas s√£o executadas em cada teste, mas n√£o em todos. </p><br><p>  As ferramentas de cobertura de c√≥digo s√£o √≥timas para informar quais partes do sistema s√£o completamente ignoradas pelos testes. </p><br><p>  <code>Coverage.py</code> √© a ferramenta de cobertura Python preferida que mede a cobertura de c√≥digo. </p><br><p>  Voc√™ o utilizar√° para verificar o c√≥digo do projeto Tarefas com pytest. </p><br><p>  Para usar o <code>coverage.py</code> voc√™ precisa instal√°-lo.  N√£o <code>pytest-cov</code> nada instalar um plug-in chamado <code>pytest-cov</code> , que permite chamar a <code>coverage.py</code> do pytest com algumas op√ß√µes adicionais de pytest.  Como a <code>coverage</code> √© uma das depend√™ncias do <code>pytest-cov</code> , basta instalar o <code>pytest-cov</code> e a <code>coverage.py</code> ser√° <code>pytest-cov</code> : </p><br><pre> <code class="plaintext hljs">$ pip install pytest-cov Collecting pytest-cov Using cached pytest_cov-2.5.1-py2.py3-none-any.whl Collecting coverage&gt;=3.7.1 (from pytest-cov) Using cached coverage-4.4.1-cp36-cp36m-macosx_10_10_x86 ... Installing collected packages: coverage, pytest-cov Successfully installed coverage-4.4.1 pytest-cov-2.5.1</code> </pre> <br><p>  Vamos executar o relat√≥rio de cobertura para a segunda vers√£o da tarefa.  Se voc√™ ainda tiver a primeira vers√£o do projeto Tarefas instalada, desinstale-a e instale a vers√£o 2: </p><br><pre> <code class="plaintext hljs">$ pip uninstall tasks Uninstalling tasks-0.1.0: /path/to/venv/bin/tasks /path/to/venv/lib/python3.6/site-packages/tasks.egg-link Proceed (y/n)? y Successfully uninstalled tasks-0.1.0 $ cd /path/to/code/ch7/tasks_proj_v2 $ pip install -e . Obtaining file:///path/to/code/ch7/tasks_proj_v2 ... Installing collected packages: tasks Running setup.py develop for tasks Successfully installed tasks $ pip list ... tasks (0.1.1, /path/to/code/ch7/tasks_proj_v2/src) ...</code> </pre> <br><p>  Agora que a pr√≥xima vers√£o das tarefas est√° instalada, voc√™ pode executar o relat√≥rio de cobertura base: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch7/tasks_proj_v2 $ pytest --cov=src ===================== test session starts ====================== plugins: mock-1.6.2, cov-2.5.1 collected 62 items tests/func/test_add.py ... tests/func/test_add_variety.py ............................ tests/func/test_add_variety2.py ............ tests/func/test_api_exceptions.py ......... tests/func/test_unique_id.py . tests/unit/test_cli.py ..... tests/unit/test_task.py .... ---------- coverage: platform darwin, python 3.6.2-final-0 ----------- Name Stmts Miss Cover -------------------------------------------------- src\tasks\__init__.py 2 0 100% src\tasks\api.py 79 22 72% src\tasks\cli.py 45 14 69% src\tasks\config.py 18 12 33% src\tasks\tasksdb_pymongo.py 74 74 0% src\tasks\tasksdb_tinydb.py 32 4 88% -------------------------------------------------- TOTAL 250 126 50% ================== 62 passed in 0.47 seconds ===================</code> </pre> <br><p>  Como o diret√≥rio atual √© <code>tasks_proj_v2</code> e o c√≥digo-fonte em teste est√° em src, a adi√ß√£o da op√ß√£o <code>--cov=src</code> gera um relat√≥rio de cobertura apenas para esse diret√≥rio em teste. </p><br><p>  Como voc√™ pode ver, alguns arquivos t√™m cobertura muito baixa e at√© 0%.  Estes s√£o lembretes √∫teis: <code>tasksdb_pymongo.py</code> 0% porque desativamos o teste do MongoDB nesta vers√£o.  Alguns deles s√£o bastante baixos.  O projeto certamente ter√° que realizar testes para todas essas √°reas antes de estar pronto para o hor√°rio nobre. </p><br><p>  Acredito que v√°rios arquivos tenham uma porcentagem maior de cobertura: <code>api.py</code> e <code>tasksdb_tinydb.py</code> .  Vamos dar uma olhada em <code>tasksdb_tinydb.py</code> e ver o que est√° faltando.  Eu acho que a melhor maneira de fazer isso √© usar relat√≥rios HTML. </p><br><p>  Se voc√™ executar o <code>--cov-report=html</code> novamente com a op√ß√£o <code>--cov-report=html</code> , um <code>--cov-report=html</code> ser√° gerado: </p><br><pre> <code class="plaintext hljs">$ pytest --cov=src --cov-report=html ===================== test session starts ====================== plugins: mock-1.6.2, cov-2.5.1 collected 62 items tests/func/test_add.py ... tests/func/test_add_variety.py ............................ tests/func/test_add_variety2.py ............ tests/func/test_api_exceptions.py ......... tests/func/test_unique_id.py . tests/unit/test_cli.py ..... tests/unit/test_task.py .... ---------- coverage: platform darwin, python 3.6.2-final-0 ----------- Coverage HTML written to dir htmlcov ================== 62 passed in 0.45 seconds ===================</code> </pre> <br><p>  Voc√™ pode abrir o <code>htmlcov/index.html</code> em um navegador que exibe a sa√≠da na seguinte tela: </p><br><p><img src="https://habrastorage.org/webt/vs/sc/84/vssc84hovxefvf2g65740gu3ll0.png"></p><br><p>  Clicar em <code>tasksdb_tinydb.py</code> exibir√° um relat√≥rio para um arquivo.  A porcentagem de linhas cobertas √© exibida na parte superior do relat√≥rio, mais quantas linhas s√£o cobertas e quantas n√£o, como mostrado na pr√≥xima tela: </p><br><p><img src="https://habrastorage.org/webt/os/pc/-o/ospc-o_yzzdfh1lzllw_1qtilrc.png"></p><br><p>  Rolando para baixo, voc√™ pode ver as linhas ausentes, conforme mostrado na tela a seguir: </p><br><p><img src="https://habrastorage.org/webt/85/rg/lt/85rgltocwrunycedzbeweix4zyc.png"></p><br><p>  Mesmo que essa tela n√£o seja uma p√°gina completa para esse arquivo, basta dizer que: </p><br><ol><li>  N√£o testamos <code>list_tasks()</code> com o conjunto de propriet√°rios. </li><li>  N√£o testamos <code>update()</code> ou <code>delete()</code> . </li><li>  Talvez n√£o <code>unique_id()</code> testando completamente <code>unique_id()</code> . </li></ol><br><p>  √ìtimo.  Podemos inclu√≠-los em nossa lista de testes de tarefas, juntamente com o teste do sistema de configura√ß√£o. </p><br><p>  Embora as ferramentas de cobertura de c√≥digo sejam extremamente √∫teis, buscar 100% de cobertura pode ser perigoso.  Quando voc√™ v√™ um c√≥digo que n√£o est√° sendo testado, isso pode significar a necessidade de um teste.  Mas tamb√©m pode significar que existem algumas fun√ß√µes do sistema que n√£o s√£o necess√°rias e podem ser removidas.  Como todas as ferramentas de desenvolvimento de software, a an√°lise de cobertura de c√≥digo n√£o substitui o pensamento. </p><br><p>  Consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code> coverage.py</code></a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>pytest-cov</code></a> obter mais detalhes. </p><br><h2 id="mock-podmena-chastey-sistemy">  mock: substitui√ß√£o de pe√ßas do sistema </h2><br><p>  O pacote simulado √© usado para substituir partes do sistema para isolar partes do c√≥digo de teste do restante do sistema.  Mock - objetos √†s vezes s√£o chamados de dobras de teste, espi√µes, falsifica√ß√µes ou tocos. </p><br><p>  Entre o seu pr√≥prio dispositivo pytest monkeypatch (descrito em Usando o monkeypatch na p√°gina 85) e o mock, voc√™ deve ter toda a funcionalidade de teste duplo necess√°ria. </p><br><blockquote>  Aten√ß√£o!  Simulado e muito estranho <br>  Se esta √© a primeira vez que voc√™ encontra g√™meos de teste, como zombarias, tocos e espi√µes, prepare-se!  Ser√° muito estranho muito r√°pido, engra√ßado, embora muito impressionante. </blockquote><p>  O pacote <code>mock</code> vem com a biblioteca padr√£o do Python, como <code>unittest.mock</code> desde o Python 3.3.  Nas vers√µes anteriores, ele est√° dispon√≠vel como um pacote separado instalado atrav√©s do PyPI.  Isso significa que voc√™ pode usar a vers√£o <code>mock</code> PyPI do Python 2.6 para a vers√£o mais recente do Python e obter a mesma funcionalidade do √∫ltimo <code>mock</code> Python.  No entanto, para uso com o pytest, um plug-in chamado <code>pytest-mock</code> possui alguns recursos que o tornam minha interface preferida para o sistema de mock. </p><br><p>  Para o projeto Tarefas, usaremos <code>mock</code> para nos ajudar a testar a interface da linha de comandos.  Em Coverage.py: ao determinar quanto c√≥digo est√° sendo testado, na p√°gina 129 voc√™ viu que nosso arquivo <code>cli.py</code> n√£o foi testado.  Vamos come√ßar a consertar isso agora.  Mas vamos falar sobre estrat√©gia primeiro. </p><br><p>  A primeira solu√ß√£o no projeto Tarefas foi fazer a maioria dos testes de funcionalidade por meio do <code>api.py</code>  Portanto, uma solu√ß√£o razo√°vel √© que o teste de linha de comando n√£o precise ser um teste funcional completo.  Podemos ter certeza de que o sistema funcionar√° atrav√©s da CLI se atingirmos o n√≠vel da API √∫mida durante o teste da CLI.  Tamb√©m √© uma solu√ß√£o conveniente que nos permite examinar o moki nesta se√ß√£o. </p><br><p>  A implementa√ß√£o de tarefas da CLI usa um pacote de interface de linha de comando de terceiros.  Existem muitas alternativas para implementar a interface da linha de comandos, incluindo um m√≥dulo embutido no Python <code>argparse</code> .  Um dos motivos pelos quais escolhi o Click √© porque ele inclui um mecanismo de teste que nos ajuda a testar os aplicativos Click.  No entanto, o c√≥digo no <code>cli.py</code> , embora esperemos que seja t√≠pico dos aplicativos Click, n√£o √© √≥bvio. </p><br><p>  Vamos diminuir a velocidade e instalar a terceira vers√£o do Tasks: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ $ pip install -e ch7/tasks_proj_v2 ... Successfully installed tasks</code> </pre> <br><p>  No restante desta se√ß√£o, voc√™ desenvolver√° v√°rios testes para testar a funcionalidade da "lista". <br>  Vamos v√™-lo em a√ß√£o para entender o que vamos verificar: </p><br><blockquote>  <strong><em>Nota do tradutor:</em></strong> Ao usar a plataforma Windows, encontrei v√°rios problemas ao testar a sess√£o abaixo. <br><ol><li>  Uma pasta deve ser criada para o banco de dados denominado <strong><code>tasks_db</code></strong> na pasta do seu usu√°rio.  Por exemplo <code>c:\Users\User_1\tasks_db\</code> <br>  Caso contr√°rio, obteremos - &gt;&gt; FileNotFoundError: [Erro 2] N√£o existe esse arquivo ou diret√≥rio: 'c: \ Users \ User_1 // tasks_db // tasks_db.json' </li><li>  Use aspas duplas em vez de um ap√≥strofo.  Caso contr√°rio, obtenha um erro <br>  'fa√ßa algo √≥timo' <br>  Uso: tarefas adicionam [OPTIONS] RESUMO <br>  Tente "task add -h" para obter ajuda. <br><br>  Erro: obtive argumentos extras inesperados (algo √≥timo ') <br></li></ol><br></blockquote><br><pre> <code class="plaintext hljs">$ tasks list ID owner done summary -- ----- ---- ------- $ tasks add 'do something great' $ tasks add "repeat" -o Brian $ tasks add "again and again" --owner Okken $ tasks list ID owner done summary -- ----- ---- ------- 1 False do something great 2 Brian False repeat 3 Okken False again and again $ tasks list -o Brian ID owner done summary -- ----- ---- ------- 2 Brian False repeat $ tasks list --owner Brian ID owner done summary -- ----- ---- ------- 2 Brian False repeat</code> </pre> <br><p>  Parece bem simples.  O comando <code>tasks list</code> exibe uma lista de todas as tarefas sob o cabe√ßalho. <br>  O t√≠tulo √© impresso mesmo se a lista estiver vazia.  O comando exibe apenas dados de um propriet√°rio, se <code>-o</code> ou <code>--owner</code> .  E como verificamos isso?  Existem muitas maneiras, mas vamos usar o moki. </p><br><p>  Testes que usam MOKs s√£o necessariamente <em>testes de caixa branca</em> , e precisamos examinar o c√≥digo para decidir o que e onde iremos bater.  O principal ponto de entrada est√° aqui: </p><br><blockquote>  ch7 / tasks_proj_v2 / src / tasks / cli.py </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: tasks_cli()</code> </pre> <br><p>  Esta √© apenas uma chamada para <code>tasks_cli()</code> : </p><br><blockquote>  ch7 / tasks_proj_v2 / src / tasks / cli.py </blockquote><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@click.group(context_settings={'help_option_names': ['-h', '--help']}) @click.version_option(version='0.1.1') def tasks_cli(): """Run the tasks application.""" pass</span></span></code> </pre> <br><p>  Obviamente?  N√£o.  Mas espere, fica bom (ou ruim, dependendo do seu ponto de vista).  Aqui est√° um dos comandos da <code>list</code> : </p><br><blockquote>  ch7 / tasks_proj_v2 / src / tasks / cli.py </blockquote><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@tasks_cli.command(name="list", help="list tasks") @click.option('-o', '--owner', default=None, help='list tasks with this owner') def list_tasks(owner): """    .   ,      . """ formatstr = "{: &gt;4} {: &gt;10} {: &gt;5} {}" print(formatstr.format('ID', 'owner', 'done', 'summary')) print(formatstr.format('--', '-----', '----', '-------')) with _tasks_db(): for t in tasks.list_tasks(owner): done = 'True' if t.done else 'False' owner = '' if t.owner is None else t.owner print(formatstr.format( t.id, owner, done, t.summary))</span></span></code> </pre> <br><p>  Quando voc√™ se acostumar a escrever o c√≥digo Click, verifique se esse c√≥digo n√£o √© t√£o ruim.  N√£o vou explicar aqui o que e como funciona nesta fun√ß√£o, pois o desenvolvimento do c√≥digo da linha de comando n√£o √© o foco do livro;  no entanto, embora eu tenha quase certeza absoluta de que tenho esse c√≥digo correto, h√° sempre muito espa√ßo para erro humano.  √â por isso que um bom conjunto de testes automatizados √© importante para garantir que esse recurso funcione corretamente. <br>  Essa fun√ß√£o <code>list_tasks(owner)</code> depende de v√°rias outras fun√ß√µes: <code>tasks_db()</code> , que √© o gerenciador de contexto, e <code>tasks.list_tasks(owner)</code> , que √© a fun√ß√£o da API. </p><br><p>  Vamos usar o <code>mock</code> para colocar fun√ß√µes falsas no <code>tasks_db()</code> e <code>tasks.list_tasks()</code> .  Em seguida, podemos chamar o m√©todo <code>list_tasks</code> por meio da interface da linha de comandos e garantir que ele chame a fun√ß√£o <code>tasks.list_tasks()</code> , que funciona corretamente e processa corretamente o valor de retorno. <br>  Para abafar <code>tasks_db()</code> , vamos ver uma implementa√ß√£o real: </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Voltar</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt448798/">https://habr.com/ru/post/pt448798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt448776/index.html">RxVMS - Uma Arquitetura Pr√°tica para Aplica√ß√µes de Flutter</a></li>
<li><a href="../pt448782/index.html">Teste de Python com pytest. Introdu√ß√£o ao pytest, Cap√≠tulo 1</a></li>
<li><a href="../pt448784/index.html">Novos recursos para autores de extens√£o no Visual Studio 2019 vers√£o 16.1</a></li>
<li><a href="../pt448792/index.html">Teste de Python com pytest. Acess√≥rios Internos, Cap√≠tulo 4</a></li>
<li><a href="../pt448796/index.html">Teste de Python com pytest. Configura√ß√£o, CAP√çTULO 6</a></li>
<li><a href="../pt448802/index.html">Pensando em portais: criando portais no Unreal Engine 4</a></li>
<li><a href="../pt448804/index.html">Preparando-se para o tempo de execu√ß√£o e o not√°rio refor√ßados do macOS</a></li>
<li><a href="../pt448808/index.html">Sobre coisas simples, complicadas. "Dormindo a√ßo". Como lubrificar parafusos enferrujados ou n√£o WD-40 com um √∫nico ...</a></li>
<li><a href="../pt448810/index.html">Como eu peguei um hacker</a></li>
<li><a href="../pt448812/index.html">Miss√£o lunar ‚ÄúBereshit‚Äù - procura a primeira biblioteca lunar ap√≥s o in√≠cio do acidente de sua transportadora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>