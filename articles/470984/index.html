<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ´ üë¥üèª üñ§ An√°lisis de confirmaciones y solicitudes de extracci√≥n en Travis CI, Buddy y AppVeyor utilizando PVS-Studio üí¥ üìõ üë©üèº‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A partir de la versi√≥n 7.04, el analizador PVS-Studio para lenguajes C y C ++ en Linux y macOS tiene una capacidad de prueba para verificar la lista d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lisis de confirmaciones y solicitudes de extracci√≥n en Travis CI, Buddy y AppVeyor utilizando PVS-Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/470984/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac4/d08/0e7/ac4d080e7661626569ef514abe190662.png" alt="Cuadro 11"></div><br>  A partir de la versi√≥n 7.04, el analizador PVS-Studio para lenguajes C y C ++ en Linux y macOS tiene una capacidad de prueba para verificar la lista de archivos especificados.  Usando el nuevo modo, puede configurar el analizador para verificar las confirmaciones y las solicitudes de extracci√≥n.  Este art√≠culo le mostrar√° c√≥mo configurar la comprobaci√≥n de la lista de archivos modificados de un proyecto GitHub en sistemas de CI (integraci√≥n continua) tan populares como Travis CI, Buddy y AppVeyor. <br><a name="habracut"></a><br><h2>  Modo de comprobaci√≥n de la lista de archivos </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PVS-Studio</a> es una herramienta para detectar errores y vulnerabilidades potenciales en el c√≥digo fuente de programas escritos en C, C ++, C # y Java.  Funciona en sistemas de 64 bits en Windows, Linux y macOS. <br><br>  En PVS-Studio versi√≥n 7.04 para Linux y macOS, apareci√≥ el modo de verificar la lista de archivos fuente.  Esto funciona para proyectos cuyo sistema de compilaci√≥n permite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">generar el</a> archivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compile_commands.json</a> .  Es necesario para que el analizador extraiga informaci√≥n sobre la compilaci√≥n de los archivos especificados.  Si su sistema de compilaci√≥n no admite la generaci√≥n del archivo compile_commands.json, puede intentar generar dicho archivo utilizando la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bear</a> . <br><br>  Adem√°s, el modo de verificaci√≥n de la lista de archivos se puede usar junto con el registro de seguimiento de strace de los inicios del compilador (seguimiento de pvs-studio-analyzer).  Para hacer esto, primero deber√° realizar un ensamblaje completo del proyecto y realizar un seguimiento para que el analizador recopile informaci√≥n completa sobre los par√°metros de compilaci√≥n de todos los archivos probados. <br><br>  Sin embargo, esta opci√≥n tiene un inconveniente significativo: deber√° realizar un seguimiento completo del ensamblaje de todo el proyecto en cada inicio, lo que en s√≠ mismo contradice la idea de verificar r√°pidamente la confirmaci√≥n.  O, si el resultado del seguimiento en s√≠ mismo se almacena en cach√©, los inicios posteriores del analizador pueden no estar completos si la estructura de dependencia de los archivos de origen cambia despu√©s del seguimiento (por ejemplo, se agrega un nuevo #include a uno de los archivos de origen). <br><br>  Por lo tanto, no recomendamos utilizar el modo de verificaci√≥n de la lista de archivos con el registro de seguimiento para verificar las confirmaciones o las solicitudes de extracci√≥n.  Si puede hacer un ensamblaje incremental al verificar una confirmaci√≥n, considere usar el modo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">an√°lisis incremental</a> . <br><br>  La lista de archivos fuente para an√°lisis se guarda en un archivo de texto y se transfiere al analizador utilizando el par√°metro <i>-S</i> : <br><br><pre><code class="bash hljs">pvs-studio-analyzer analyze ... -f build/compile_commands.json -S check-list.txt</code> </pre> <br>  En este archivo, se indican las rutas relativas o absolutas a los archivos, y cada nuevo archivo debe estar en una nueva l√≠nea.  Est√° permitido especificar no solo los nombres de los archivos para el an√°lisis, sino tambi√©n varios textos.  El analizador ver√° que este no es un archivo e ignorar√° la l√≠nea.  Esto puede ser √∫til para comentar si los archivos se especifican manualmente.  Sin embargo, a menudo se generar√° una lista de archivos durante el an√°lisis en CI, por ejemplo, estos pueden ser archivos de una solicitud de confirmaci√≥n o extracci√≥n. <br><br>  Ahora, usando este modo, puede verificar r√°pidamente el nuevo c√≥digo antes de que entre en la rama de desarrollo principal.  Para que el sistema de verificaci√≥n responda a las advertencias del analizador, se ha agregado el <i>indicador</i> <i>--indicate-warnings</i> a la <i>utilidad</i> <i>plog-converter</i> : <br><br><pre> <code class="bash hljs">plog-converter ... --indicate-warnings ... -o /path/to/report.tasks ...</code> </pre> <br>  Con este indicador, el convertidor devolver√° un c√≥digo distinto de cero si hay advertencias en el informe del analizador.  Con el c√≥digo de retorno, puede bloquear la solicitud de enlace previo, confirmaci√≥n o extracci√≥n y mostrar el informe del analizador generado en la pantalla, compartir o enviar por correo. <br><br>  <i>Nota</i>  <i>La primera vez que ejecute el an√°lisis de la lista de archivos, se analizar√° todo el proyecto, porque</i>  <i>el analizador necesita generar un archivo de dependencias de los archivos fuente del proyecto a partir de los archivos de encabezado.</i>  <i>Esta es una caracter√≠stica del an√°lisis de archivos C y C ++.</i>  <i>En el futuro, el archivo de dependencia se puede almacenar en cach√© y el analizador lo actualizar√° autom√°ticamente.</i>  <i>La ventaja de verificar las confirmaciones cuando se usa el modo de verificaci√≥n de la lista de archivos sobre el uso del modo de an√°lisis incremental es que solo necesita almacenar en cach√© este archivo, no los archivos de objetos.</i> <br><br><h2>  Principios generales del an√°lisis de solicitud de extracci√≥n </h2><br>  El an√°lisis de todo el proyecto lleva mucho tiempo, por lo que tiene sentido verificar solo una parte del mismo.  El problema es que necesita separar los archivos nuevos del resto de los archivos del proyecto. <br><br>  Considere un ejemplo de un √°rbol de confirmaci√≥n con dos ramas: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Cuadro 5"></div><br><br>  Imaginemos que commit <i>A1</i> contiene una cantidad bastante grande de c√≥digo que ya ha sido probado.  Un poco antes, creamos una rama desde el commit <i>A1</i> y cambiamos algunos archivos. <br><br>  Por supuesto, not√≥ que despu√©s de <i>A1</i> hubo dos commits m√°s, pero tambi√©n fueron fusiones de otras ramas, porque no nos comprometemos en <i>master</i> .  Y ahora ha llegado el momento en que la <i>revisi√≥n est√°</i> lista.  Por lo tanto, <i>apareci√≥</i> una solicitud de extracci√≥n para la fusi√≥n de <i>B3</i> y <i>A3</i> . <br><br>  Por supuesto, uno podr√≠a verificar todo el resultado de su fusi√≥n, pero esto ser√≠a demasiado largo e injustificado, ya que solo se modificaron algunos archivos.  Por lo tanto, es m√°s eficiente analizar solo los cambios. <br><br>  Para hacer esto, obtenemos la diferencia entre las ramas, estando en la CABEZA de la rama de la que queremos fusionarnos en master: <br><br><pre> <code class="bash hljs">git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  <i>$ MERGE_BASE</i> lo consideraremos con m√°s detalle m√°s adelante.  El hecho es que no todos los servicios de CI proporcionan la informaci√≥n necesaria sobre la base para la fusi√≥n, por lo que cada vez que tiene que encontrar nuevas formas de obtener estos datos.  Esto se detallar√° a continuaci√≥n en cada uno de los servicios web descritos. <br><br>  Entonces, obtuvimos la diferencia entre las ramas, o m√°s bien, una lista de nombres de archivos que se han cambiado.  Ahora tenemos que dar el <i>archivo .pvs-pr.list</i> (redirigimos el resultado al anterior) al analizador: <br><br><pre> <code class="bash hljs">pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list</code> </pre> <br>  Despu√©s del an√°lisis, necesitamos convertir el archivo de registro (PVS-Studio.log) en un formato que sea f√°cil de leer: <br><br><pre> <code class="bash hljs">plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Este comando enumerar√° los errores en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">stderr</a> (secuencia de salida de mensaje de error est√°ndar). <br><br>  Solo ahora necesitamos no solo mostrar errores, sino tambi√©n informar a nuestro servicio para el montaje y la prueba de problemas.  Para hacer esto, se agreg√≥ la bandera <i>-W</i> ( <i>--indicate-warnings</i> ) al convertidor.  Si hay al menos una advertencia del analizador, el c√≥digo de retorno de la utilidad <i>plog-converter</i> cambiar√° a 2, lo que, a su vez, informar√° al servicio de CI sobre la presencia de posibles errores en los archivos de solicitud de extracci√≥n. <br><br><h2>  Travis ci </h2><br>  La configuraci√≥n se realiza como un archivo <i>.travis.yml</i> .  Por conveniencia, le aconsejo que coloque todo en un script bash separado con funciones que se <i>invocar√°n</i> desde el archivo <i>.travis.yml</i> ( <i>bash script_name.sh function_name</i> ). <br><br>  Agregaremos el c√≥digo necesario al script <i>bash</i> , para obtener m√°s funcionalidad.  En la secci√≥n de <i>instalaci√≥n</i> , escriba lo siguiente: <br><br><pre> <code class="xml hljs">install: - bash .travis.sh travis_install</code> </pre> <br>  Si ten√≠a alguna instrucci√≥n, puede transferirla al script eliminando guiones. <br><br>  Abra el archivo <i>.travis.sh</i> y agregue la instalaci√≥n del analizador a la funci√≥n <i>travis_install ()</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_install</span></span></span></span>() { wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update -qq sudo apt-get install -qq pvs-studio }</code> </pre> <br>  Ahora agregue el an√°lisis ejecutado a la secci√≥n de <i>script</i> : <br><br><pre> <code class="xml hljs">script: - bash .travis.sh travis_script</code> </pre> <br>  Y en el script bash: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Este c√≥digo debe ejecutarse despu√©s de compilar el proyecto, por ejemplo, si ten√≠a una compilaci√≥n en CMake: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 }</code> </pre> <br>  Resultar√° as√≠: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Probablemente ya haya notado las variables de entorno especificadas <i>$ TRAVIS_PULL_REQUEST</i> y <i>$ TRAVIS_BRANCH</i> .  Travis CI los anuncia por su cuenta: <br><br><ul><li>  <i>$ TRAVIS_PULL_REQUEST</i> almacena el n√∫mero de <i>solicitud de</i> extracci√≥n o <i>falso</i> si es una rama regular; </li><li>  <i>$ TRAVIS_REPO_SLUG</i> almacena el nombre del repositorio del proyecto. </li></ul><br>  El algoritmo de esta funci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9e2/d21/1c5/9e2d211c559a48b4bf144bdd606e4bc7.png" alt="Cuadro 7"></div><br>  Travis CI responde a los c√≥digos de retorno, por lo que la presencia de advertencias le indicar√° al servicio que marque la confirmaci√≥n como que contiene errores. <br><br>  Ahora, echemos un vistazo m√°s de cerca a esta l√≠nea de c√≥digo: <br><br><pre> <code class="bash hljs">git diff --name-only origin/HEAD &gt; .pvs-pr.list</code> </pre> <br>  El hecho es que Travis CI fusiona autom√°ticamente las sucursales durante el an√°lisis de solicitud de extracci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/443/986/1f4/4439861f46637d41119e83f83e2e440b.png" alt="Cuadro 8"></div><br>  Por lo tanto, analizamos <i>A4</i> , no <i>B3-&gt; A3</i> .  Debido a esta caracter√≠stica, necesitamos calcular la diferencia con <i>A3</i> , que es precisamente la parte superior de la rama desde el <i>origen</i> . <br><br>  Quedaba un detalle importante: el almacenamiento en cach√© de las dependencias de los archivos de encabezado en las unidades de traducci√≥n compiladas (* .c, * .cc, * .cpp, etc.).  El analizador calcula estas dependencias en el primer inicio en el modo de verificar la lista de archivos y luego la guarda en el directorio .PVS-Studio.  Travis CI le permite almacenar en cach√© las carpetas, por lo que <i>guardaremos</i> los datos del directorio <i>.PVS-Studio /</i> : <br><br><pre> <code class="xml hljs">cache: directories: - .PVS-Studio/</code> </pre> <br>  Este c√≥digo debe agregarse al archivo <i>.travis.yml</i> .  Este directorio almacena varios datos recopilados despu√©s del an√°lisis, lo que acelerar√° significativamente los lanzamientos posteriores de an√°lisis de listas de archivos o an√°lisis incrementales.  Si esto no se hace, el analizador analizar√° todos los archivos cada vez. <br><br><h2>  Amigo </h2><br>  Al igual que Travis CI, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Buddy</a> ofrece la capacidad de crear y probar autom√°ticamente proyectos que est√°n almacenados en GitHub.  A diferencia de Travis CI, est√° configurado en la interfaz web (el soporte de bash est√° disponible), por lo que no es necesario almacenar archivos de configuraci√≥n en el proyecto. <br><br>  En primer lugar, debemos agregar una nueva acci√≥n a la l√≠nea de ensamblaje: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/75e/2fd/36e/75e2fd36e9a4420ff74256429ff73e0c.gif" alt="Imagen 1"></div><br>  Indicamos el compilador que se utiliz√≥ para construir el proyecto.  Preste atenci√≥n al contenedor acoplable que se instala en esta acci√≥n.  Por ejemplo, hay un contenedor especial para GCC: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/95b/837/7ad/95b8377adbac7e50e55d97c5b318f56c.png" alt="Cuadro 6"></div><br>  Ahora instale PVS-Studio y las utilidades necesarias: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/88e/fba/02b/88efba02b5a4c34f55c4344744812cc7.gif" alt="Imagen 2"></div><br>  Agregue las siguientes l√≠neas al editor: <br><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get -y install wget gnupg jq wget -q -O - https://files.viva64.com/etc/pubkey.txt | apt-key add - wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list apt-get update &amp;&amp; apt-get -y install pvs-studio</code> </pre> <br>  Ahora vaya a la pesta√±a Ejecutar (primer √≠cono) y agregue el siguiente c√≥digo al campo apropiado del editor: <br><br><pre> <code class="bash hljs">pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Si lee la secci√≥n sobre Travs-CI, este c√≥digo ya le es familiar, sin embargo, ahora ha aparecido una nueva etapa: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/615/40f/ec9/61540fec9bc7edf2032a84bdaf5a28fe.png" alt="Cuadro 9"></div><br>  El hecho es que ahora estamos analizando no el resultado de la fusi√≥n, sino el HEAD de la rama desde la que se realiza la solicitud de extracci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Cuadro 10"></div><br>  Por lo tanto, estamos en la confirmaci√≥n condicional <i>B3</i> y necesitamos obtener la diferencia con <i>A3</i> : <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Para determinar <i>A3,</i> use la API de GitHub: <br><br><pre> <code class="bash hljs">https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${USERNAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${REPO}</span></span>/pulls/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span></code> </pre> <br>  Utilizamos las siguientes variables que Buddy proporciona: <br><br><ul><li>  <i>$ BUDDY_EXECUTION_PULL_REQEUST_NO</i> - extraer el n√∫mero de <i>solicitud</i> ; </li><li>  <i>$ BUDDY_REPO_SLUG</i> : combinaci√≥n de nombre de usuario y repositorio (por ejemplo max / test). </li></ul><br>  Ahora guarde los cambios con el bot√≥n a continuaci√≥n y habilite el an√°lisis de solicitud de extracci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/74c/5d6/876/74c5d6876c07c0b2e0c10cdabb8b0f78.gif" alt="Cuadro 3"></div><br>  A diferencia de Travis CI, no necesitamos especificar <i>.pvs-studio</i> para el almacenamiento en cach√©, ya que Buddy almacena autom√°ticamente en cach√© todos los archivos para lanzamientos posteriores.  Por lo tanto, lo √∫ltimo que queda es guardar el inicio de sesi√≥n y la contrase√±a para PVS-Studio en Buddy.  Despu√©s de guardar los cambios, volveremos a Pipeline.  Necesitamos continuar con la configuraci√≥n de las variables y agregar el inicio de sesi√≥n y la clave para PVS-Studio: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb1/816/e3e/eb1816e3e4aff72ad55b187ec1ebf0a2.gif" alt="Cuadro 4"></div><br>  Despu√©s de eso, la aparici√≥n de una nueva solicitud de extracci√≥n o confirmaci√≥n activar√° una verificaci√≥n.  Si la confirmaci√≥n contiene errores, Buddy lo indicar√° en la p√°gina de solicitud de extracci√≥n. <br><br><h2>  Transportador </h2><br>  La configuraci√≥n de AppVeyor es similar a la de Buddy, ya que todo sucede en la interfaz web y no es necesario agregar un archivo * .yml al repositorio del proyecto. <br><br>  Vaya a la pesta√±a Configuraci√≥n en la descripci√≥n general del proyecto: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f11/2fc/576/f112fc576fc1f8bf7552625578093292.png" alt="Cuadro 12"></div><br>  Despl√°cese hacia abajo en esta p√°gina y active el almacenamiento en cach√© para crear solicitudes de extracci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be8/8f3/f34/be88f3f34708075a49bdd13c65f5bc26.png" alt="Cuadro 18"></div><br>  Ahora vaya a la pesta√±a Entorno, donde especificamos la imagen para el ensamblaje y las variables de entorno necesarias: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/453/26a/80c/45326a80c62211c6b29bd16fad1ef0d1.png" alt="Cuadro 19"></div><br>  Si lee las secciones anteriores, est√° familiarizado con estas dos variables: <i>PVS_KEY</i> y <i>PVS_USERNAME</i> .  De lo contrario, le recuerdo que son necesarios para verificar la licencia del analizador PVS-Studio.  En el futuro, los volveremos a encontrar en los scripts de Bash. <br><br>  En la misma p√°gina a continuaci√≥n indicamos la carpeta para el almacenamiento en cach√©: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e2/967/dbf/4e2967dbfb796e2d0104d5b6539be65a.png" alt="Cuadro 15"></div><br>  Si no lo hacemos, analizaremos todo el proyecto en lugar de un par de archivos, pero obtendremos el resultado de los archivos especificados.  Por lo tanto, es importante ingresar el nombre de directorio correcto. <br><br>  Ahora es el momento de verificar el gui√≥n.  Abra la pesta√±a Pruebas y seleccione Script: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5f/dbd/0d6/b5fdbd0d6d448174bc05222fe1965c1c.png" alt="Cuadro 20"></div><br>  Inserte el siguiente c√≥digo en este formulario: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get -y install jq wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update &amp;&amp; sudo apt-get -y install pvs-studio pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Presta atenci√≥n a la siguiente parte del c√≥digo: <br><br><pre> <code class="bash hljs">PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  La asignaci√≥n bastante espec√≠fica del valor del comando pwd a la variable que deber√≠a almacenar este valor predeterminado parece extra√±o a primera vista, sin embargo, explicar√© todo ahora. <br><br>  Mientras configuraba el analizador en AppVeyor, me encontr√© con un comportamiento de analizador extremadamente extra√±o.  Por un lado, todo funcion√≥ correctamente, pero el an√°lisis no comenz√≥.  Pas√© mucho tiempo para notar que estamos en el directorio / home / appveyor / projects / testcalc /, y el analizador est√° seguro de que estamos en / opt / appveyor / build-agent /.  Entonces me di cuenta de que la variable $ PWD est√° mintiendo un poco.  Por esta raz√≥n, actualic√© manualmente su valor antes de comenzar el an√°lisis. <br><br>  Y luego todo, como antes: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0aa/4b9/a33/0aa4b9a3398ce2f52cc8e1df0833f459.png" alt="Cuadro 17"></div><br>  Ahora considere el siguiente fragmento: <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>`</code> </pre> <br>  En √©l, obtenemos la diferencia entre las ramas sobre las cuales se declara la solicitud de extracci√≥n.  Para hacer esto, necesitamos las siguientes variables de entorno: <br><br><ul><li>  $ APPVEYOR_PULL_REQUEST_NUMBER - n√∫mero de solicitud de extracci√≥n; </li><li>  $ APPVEYOR_REPO_NAME: nombre de usuario y repositorio del proyecto. </li></ul><br><h2>  Conclusi√≥n </h2><br>  Por supuesto, no consideramos todos los servicios posibles de integraci√≥n continua, sin embargo, todos ellos tienen caracter√≠sticas de trabajo muy similares entre s√≠.  Con la excepci√≥n del almacenamiento en cach√©, cada servicio hace su propia "bicicleta", por lo que todo es siempre diferente. <br><br>  En alg√∫n lugar, como en Travis-CI, un par de l√≠neas de c√≥digo y almacenamiento en cach√© funcionan perfectamente;  en alg√∫n lugar, como en AppVeyor, solo necesita especificar la carpeta en la configuraci√≥n;  pero en alg√∫n lugar debe crear claves √∫nicas e intentar convencer al sistema para que le brinde la oportunidad de sobrescribir el fragmento almacenado en cach√©.  Por lo tanto, si desea configurar el an√°lisis de solicitudes de extracci√≥n en el servicio de integraci√≥n continua, que no se discuti√≥ anteriormente, primero aseg√∫rese de que no tendr√° problemas con el almacenamiento en cach√©. <br><br>  Gracias por su atencion  Si algo no funciona, no dude en escribirnos en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">apoyo</a> .  Le solicitaremos ayuda. <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Si desea compartir este art√≠culo con una audiencia de habla inglesa, utilice el enlace a la traducci√≥n: Maxim Zvyagintsev.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">An√°lisis de confirmaciones y solicitudes de extracci√≥n en Travis CI, Buddy y AppVeyor utilizando PVS-Studio</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/470984/">https://habr.com/ru/post/470984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../470974/index.html">DNS pasivo en manos del analista</a></li>
<li><a href="../470976/index.html">Canci√≥n de hielo (Empresa sangrienta) y llamas (DevOps e IaC)</a></li>
<li><a href="../470978/index.html">Investigaci√≥n de mercado de analistas: d√≥nde estudian, qu√© herramientas usan y cu√°nto ganan</a></li>
<li><a href="../470980/index.html">Las tareas que los robots de software (RPA) resuelven en el sector bancario</a></li>
<li><a href="../470982/index.html">An√°lisis de confirmaciones y solicitudes de extracci√≥n en Travis CI, Buddy y AppVeyor utilizando PVS-Studio</a></li>
<li><a href="../470988/index.html">El registro est√° abierto para Slerm DevOps en Mosc√∫</a></li>
<li><a href="../470990/index.html">Kit de herramientas de marketing en l√≠nea: 3 aplicaciones para impulsar la comunicaci√≥n visual</a></li>
<li><a href="../470994/index.html">Herencia de JavaScript desde el punto de vista de un nerd aburrido: F√°brica de constructores</a></li>
<li><a href="../470996/index.html">¬øC√≥mo puede una simple etiqueta <img> convertirse en un alto riesgo para una empresa?</a></li>
<li><a href="../470998/index.html">Juguetes de madera, parte diez - 1996</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>