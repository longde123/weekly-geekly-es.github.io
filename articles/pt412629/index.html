<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé° üëáüèΩ üì™ Forma de onda adapt√°vel para o seu servi√ßo de √°udio üê™ üéΩ üôÖüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quando eu precisava configurar um arquivo de √°udio para um √∫nico site de transmiss√£o, al√©m do painel de administra√ß√£o, tamb√©m precisava de um reprodut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Forma de onda adapt√°vel para o seu servi√ßo de √°udio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412629/"><img src="https://habrastorage.org/webt/nw/k4/n3/nwk4n3zrjoklldqz2vfmpq25nzs.gif"><br><br>  Quando eu precisava configurar um arquivo de √°udio para um √∫nico site de transmiss√£o, al√©m do painel de administra√ß√£o, tamb√©m precisava de um reprodutor de √°udio.  A transmiss√£o durou 40 minutos mais duas pausas musicais.  Usar o Waveform em formatos t√£o longos √© especialmente conveniente; portanto, como muitos servi√ßos de m√∫sica, decidi usar essa solu√ß√£o no design do player. <br><br>  Com o planejado futuro redesenho do site e, possivelmente, futuros aplicativos m√≥veis, a forma de onda raster aqui simplesmente se apoiou na barreira.  N√£o √© adapt√°vel, √© extremamente intensivo em recursos para redesenhar se estiver na varredura. <br><a name="habracut"></a><br>  O conhecido SOUNDCLOUD resolveu esse problema em telas pequenas movendo toda a forma de onda em rela√ß√£o ao centro est√°tico.  Mas eu n√£o quero isso. <br><br>  A transmiss√£o de r√°dio foi feita atrav√©s do painel de administra√ß√£o e imediatamente fiz mais c√≥pias compactadas dos arquivos de √°udio atrav√©s do ffmpeg.  Seria tolice desistir de suas capacidades e gerar uma forma de onda. <br><br><h4>  Algoritmo de a√ß√µes: </h4><br>  1. Gera√ß√£o de forma de onda em um tamanho m√≠nimo para armazenamento <br>  2. Tradu√ß√£o em vetor (JSON) <br>  3. Desenhando um jogador para esta matriz <br>  4. Implementa√ß√£o da adaptabilidade: redu√ß√£o uniforme da matriz e retorno √† etapa 3 <br><br><h3>  Gera√ß√£o de forma de onda </h3><br><br>  No momento da implementa√ß√£o dessa abordagem, os camaradas da BBC ainda n√£o haviam divulgado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a</a> sa√≠da em JSON <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em sua utilidade</a> , tanto quanto me lembro.  E, no momento, eu recomendo que voc√™ reconstrua a utilidade deles para remover a sa√≠da in√∫til de n√∫meros negativos e extras.  Antigo sobre canais de testemunha e outras bobagens. <br>  Enquanto isso, continue: <br><br>  Se usarmos o design do meu player (ele √© reduzido em largura aqui), veremos que existem 2 pixels por tira (mais 1 separador de pixels).  Isso significa que 600px fornecer√° 1200px de largura. <br><br><img src="https://habrastorage.org/webt/p9/dk/wf/p9dkwfisywv4-irpqxeyteuqpvw.jpeg"><br><br>  Suponho que no futuro seja extremamente improv√°vel que seja necess√°ria uma apresenta√ß√£o maior do arquivo de √°udio.  Bem, se voc√™ n√£o puxar o design por toda a largura do monitor 4K, pense nisso, mas eu paro em 600x60px. <br><br>  E agora mais perto do c√≥digo: <br><br><pre><code class="php hljs">shell_exec(<span class="hljs-string"><span class="hljs-string">"ffmpeg -y -i '$name.mp3' -filter_complex 'aformat=channel_layouts=mono,compand,showwavespic=s=600x120,crop=in_w:in_h/2:0:0' -c:v png -pix_fmt monob -frames:v 1 '$png_path.png' &gt; /dev/null 2&gt;/dev/null &amp;"</span></span>);</code> </pre> <br>  <i>-filter_complex</i> - conectar filtros <br><br>  <i>aformat</i> - trabalhe com som <br><br>  <i>channel_layouts</i> <br><br>  <i>-mono</i> - modo mono <br><br>  <i>-compand</i> √© um compressor e expansor.  Nesse modo, os sons baixos e altos ser√£o equalizados em volume, o que permite obter uma forma de onda sem picos e sobrecargas nas grava√ß√µes baixas e altas.  A forma de onda, por assim dizer, √© sempre esticada ao m√°ximo. <br><br>  <i>-showwavespic = s = 600x120</i> - s leva o tamanho da imagem. <br><br>  <i>-crop = in_w: in_h / 2: 0: 0</i> - <i>corta</i> a imagem recebida.  Como regra, a resposta de frequ√™ncia de sa√≠da √© espelhada em torno do eixo x.  Portanto, borrifamos, deixando apenas a ponta do iceberg. <br><br>  <i>-c: v png -pix_fmt monob -frames: v 1</i> - formato de imagem de sa√≠da, paleta de cores bw e apenas o primeiro quadro (n√£o precisamos de anima√ß√£o).  png8 √© √≥timo para qualidade (sem perdas no nosso caso) / local. <br><br>  <i>&gt; / dev / null 2&gt; / dev / null e</i> envia dados de sa√≠da e de trabalho para o abismo.  E '&amp;' permite que o php n√£o espere o console terminar de trabalhar, mas continue. <br><br>  Na sa√≠da, obtemos esta imagem: <br><br><img src="https://habrastorage.org/webt/4f/ee/s6/4fees6nkctphgo1oaxk6j9es7s0.png"><br>  Tamanho do arquivo final 2.4kb <br><br>  <i>O engra√ßado √© que h√° alguns anos atr√°s, em vez de branco, havia uma cor vermelha.</i>  <i>Os desenvolvedores, aparentemente, alteraram os valores padr√£o.</i> <br><br><h3>  Converter forma de onda em vetor </h3><br>  A imagem resultante √© a amplitude em Y e o tempo em X. √â fundamental convert√™-la em uma matriz JSON unidimensional.  Onde os valores atuar√£o como valores de amplitude, e o tempo √© simplesmente seu √≠ndice ordinal. <br><br>  Eu decidi fazer a tradu√ß√£o em tempo real, sem armazenar o resultado em cache, isso √© feito muito rapidamente. <br>  Medimos o n√∫mero de pixels ao longo de Y, de cima para o primeiro, e passamos para o pr√≥ximo pixel ao longo de X. <br><br><pre> <code class="php hljs">$a = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">"test.png"</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $h = <span class="hljs-string"><span class="hljs-string">'60'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// horizontal movener while ( $i &lt; 600 ) { // vertical movener $y = $h-1; $c = 0; while ( $c &lt; $h ) { //echo imagecolorat($aa, $i, $c ); // test color if(imagecolorat($a, $i, $c ) == "255") { $arr[$i] = $c; break; } else { $arr[$i] = $y; } $c++; } $i++; }; echo json_encode($arr);</span></span></code> </pre><br>  A matriz resultante consiste em 600 valores. <br><br> <code>[46,28,34,35,34,35,26,33,39,29,29,30,30,30,33,33,28...]</code> <br> <br><h3>  Renderiza√ß√£o de jogador por JSON </h3><br>  Para uma barra de progresso do trabalho conveniente, usei progressor.js da Elliot Bentley.  Ele fez isso para um servi√ßo de transcri√ß√£o de √°udio. <br><br>  <a href="">github.com/ejb/progressor.js</a> 2,76 KB <br><br>  Vamos dar uma olhada no nosso jogador novamente. <br><br><img src="https://habrastorage.org/webt/p9/dk/wf/p9dkwfisywv4-irpqxeyteuqpvw.jpeg"><br><br>  A barra de progresso consiste em duas camadas: um fundo com barras cinza e verde. <br><br>  Abaixo as imagens s√£o desenhadas com a fun√ß√£o getGraph. <br><br>  Seu significado √© desenhar colunas da espessura e cor desejadas com separadores de colunas. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); c.width = width; c.height = height; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = c.getContext(<span class="hljs-string"><span class="hljs-string">"2d"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGraph</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fillStyle1,fillStyle2,fillStyle3</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fillStyle3) { <span class="hljs-comment"><span class="hljs-comment">//console.log(fillStyle1); var grd = ctx.createLinearGradient(0,120,0,0); grd.addColorStop(0.5,fillStyle1); grd.addColorStop(1,fillStyle2); fillStyle1 = grd; fillStyle2 = fillStyle3; } json.forEach(function(item, i, arr) { ctx.fillStyle = fillStyle1; ctx.fillRect(i * 3, height, 2, item - height); ctx.fillStyle = fillStyle2; var next = json[i + 1]; if( item &lt;= next ) { h2 = next; } else { h2 = item; } ctx.fillRect(i * 3 + 2, height, 1, h2 - height); }); return c.toDataURL(); }</span></span></code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui est√° um exemplo de trabalho sem adaptabilidade</a> <br><br><h3>  4. Implementa√ß√£o da adaptabilidade </h3><br>  Agora precisamos reduzir a matriz JSON no cliente para o tamanho desejado e aqui voc√™ tem a adaptabilidade. <br><br><h3>  Planejar um </h3><br>  O primeiro m√©todo que vem √† mente √© remover cada segundo, terceiro, quarto ... em um ciclo, para que voc√™ n√£o possa reduzir a matriz em menos da metade e a precis√£o do pixel n√£o pode ser alcan√ßada aqui. <br><br>  Modificar a forma de onda excluindo valores de matriz √© um beco sem sa√≠da.  Ao fazer isso, voc√™ ver√° o quanto a forma de onda se torna impessoalmente rasgada, porque voc√™ joga extremos e n√£o mede a m√©dia dos vizinhos em altura. <br><br>  Precisamos de algoritmos de reamostragem.  Existe uma implementa√ß√£o do algoritmo em js: <br><br>  <a href=""><b>largestTriangleThreeBuckets</b></a> <br><br>  Funciona bem, apenas solicita uma entrada como essa matriz, cujos √≠ndices receber√£o as coordenadas XY. Temos uma matriz unidimensional, ent√£o tive que me divertir um pouco e refazer a fun√ß√£o.  Essa coisa funciona assim: <br><br><img src="https://habrastorage.org/webt/mf/xx/wt/mfxxwtrk4jf5nddwlkqpmzu3__e.gif"><br><br>  E <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> voc√™ pode tocar com adapt√°vel como KDPV. <br><br>  Defina o modo de exibi√ß√£o em que o quadro html estar√° √† direita.  Ent√£o voc√™ pode alterar a largura desta janela. <br><br><h3>  Plano B - Puff </h3><br>  No entanto, eu ainda n√£o gostaria de carregar o lado do cliente.  Por exemplo, eu quero 1000 pontos-5000, mas toda a largura da tela.  Se eu tiver mais pontos, como isso se comportar√° no celular?  Por um lado, isso n√£o √© absolutamente nenhum problema, n√£o √© t√£o aparentemente caro, a julgar pelas demos do algoritmo, ele mastiga 5000 pontos facilmente.  Mas, por outro lado, deve-se dar o que se pede.  Quest√£o de design. <br><br>  Elementar, se voc√™ tiver Node.Js, poder√° transferir esse c√≥digo para o servidor.  E se voc√™ tem php, pode encontrar uma implementa√ß√£o desse algoritmo em php, mas ... por que, pensei. <br><br>  Onde est√£o os algoritmos de reamostragem?  Na mesma lib nativa GD que usamos para gerar JSON.  Simplesmente passamos o par√¢metro do cliente em pixels da largura necess√°ria e redimensionamos nossa forma de onda antes de converter para JSON. <br><br>  Portanto, expandirei o c√≥digo escrito no in√≠cio. <br><br><pre> <code class="php hljs">$h = <span class="hljs-number"><span class="hljs-number">60</span></span>; $width_new = <span class="hljs-number"><span class="hljs-number">600</span></span>; $a = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">"$id.png"</span></span>); $width_old = imagesx($a); $aa = imagecreatetruecolor($width_new, $h); imagecopyresized($aa, $a, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $width_new, $h, $width_old, $h); imagetruecolortopalette($aa, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// horizontal movener while ( $i &lt; $width_new ) { // vertical movener $y = $h-1; $c = 0; while ( $c &lt; $h ){ //echo imagecolorat($aa, $i, $c ); // search what color is needed if(imagecolorat($aa, $i, $c ) == "1"){ $arr[$i] = $c; break; } else { $arr[$i] = $y; } $c++; } $i++; }; echo json_encode($arr);</span></span></code> </pre><br>  Depois disso, voc√™ n√£o pode se preocupar se precisar alterar o design, a largura do player, expandir para um aplicativo m√≥vel.  Tudo parece bastante flex√≠vel e muito inteligente. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O c√≥digo est√° aqui</a> <br><br><div class="spoiler">  <b class="spoiler_title">.</b> <div class="spoiler_text">  Ovo de pascoa <br><br>  Provavelmente foi um dia ensolarado.  A janela do nosso quarto dava para dois velhos andares de tijolos de 9 andares, dos quais me lembro quando adolescente, sei que um anel de bonde se abre atr√°s deles, um pouco mais adiante - o antigo hospital, logo atr√°s da escola, e o pr√©dio atual com o escrit√≥rio onde tento cavar em suas mem√≥rias, este √© um antigo hospital inacabado, agora um pr√©dio puramente comercial.  Lembro-me de que na minha inf√¢ncia as for√ßas especiais treinadas aqui eram exibidas na TV, atacando vigorosamente uma estrutura de concreto, coberta de tudo o que estava √† sua volta.  E agora, ao que parece, estou chocando energicamente o corrim√£o brilhante, descendo as escadas e admirando a forma de distor√ß√µes deste edif√≠cio no reflexo do complexo residencial mais pr√≥ximo.  (Nas proximidades, ao longo da linha do bonde, a parede do antigo cemit√©rio √© aberta. E nela est√° uma inscri√ß√£o em tinta verde ‚ÄúEnquanto Boris est√° no poder‚Äù e ‚ÄúLabor Russia‚Äù. Deus sabe quem e quando eles foram feitos, mas depois de algumas d√©cadas eles ainda leram mas permane√ßo completamente invis√≠vel. N√£o vejo mais, desde o legado dos anos 90, um monumento mais antigo da cidade.) <br><br>  No andar de cima, ele est√° vazio, como acontece vazio em um pacote com trigo sarraceno que foi iniciado: h√° muito tudo embaixo e apertado: alguns bandidos de geo-intelig√™ncia especial, escrit√≥rio 2gis, depois seoshniki regular e acima quase n√£o h√° gr√£os.  Voc√™ acha que algo deve crescer pelo ch√£o de algo aqui, mas ao longo dos 5 anos apenas o lavador de janelas olhou do transcendental e do contador imanente com olhos loucos, que batem em todas as portas do ch√£o em busca de algu√©m , que explicar√° como assinar um pagamento por meio de um plug-in maluco para servi√ßos banc√°rios na Internet devido a outra atualiza√ß√£o do navegador. <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt412629/">https://habr.com/ru/post/pt412629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt412619/index.html">Meetup myDribbble 2017 em Moscou</a></li>
<li><a href="../pt412621/index.html">Como se tornar um m√°gico (parte 3). Carta de Hogwarts</a></li>
<li><a href="../pt412623/index.html">O novo kit para o Star Citizen custar√° US $ 27 mil</a></li>
<li><a href="../pt412625/index.html">Como encontrar rapidamente e n√£o perder especialistas em IA e Ci√™ncia de Dados</a></li>
<li><a href="../pt412627/index.html">Exposi√ß√£o Internacional CMEF & ICMD 2018 Primavera em Xangai (Parte 2)</a></li>
<li><a href="../pt412633/index.html">Experi√™ncia em configurar e usar o WSL (subsistema Linux no Windows 10)</a></li>
<li><a href="../pt412637/index.html">Fazer ou n√£o redesenhar logotipos? Essa √© a quest√£o</a></li>
<li><a href="../pt412639/index.html">O que voc√™ precisa esperar para criar estrat√©gias de negocia√ß√£o na bolsa: qu√£o eficiente √© o aprendizado de m√°quina</a></li>
<li><a href="../pt412641/index.html">O que a minera√ß√£o, a Ge√≥rgia e o Irkutsk t√™m em comum?</a></li>
<li><a href="../pt412643/index.html">Como integramos o sistema de pagamentos ao projeto russo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>