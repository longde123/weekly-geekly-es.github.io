<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëï üë©üèø‚Äçüîß üìä Rhinoc√©ros √† l'int√©rieur du chat - ex√©cutez le firmware dans l'√©mulateur Kopycat üíå üí≥ ü§¥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lors de la r√©union 0x0A DC7831 DEF CON Nizhny Novgorod du 16 f√©vrier, nous avons pr√©sent√© un rapport sur les principes de base de l'√©mulation de code ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rhinoc√©ros √† l'int√©rieur du chat - ex√©cutez le firmware dans l'√©mulateur Kopycat</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inforion/blog/445798/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/pb/7e/gipb7e8ucwinvebjerxy1fk2d-8.jpeg" width="80%"></div><br><p>  Lors de la r√©union 0x0A DC7831 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DEF CON Nizhny Novgorod</a> du 16 f√©vrier, nous avons pr√©sent√© un rapport sur les principes de base de l'√©mulation de code binaire et notre propre d√©veloppement - un √©mulateur de plates-formes mat√©rielles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kopycat</a> . </p><br><p>  Dans l'article, nous d√©crirons le lancement du micrologiciel de l'appareil dans l'√©mulateur, d√©montrerons l'interaction avec le d√©bogueur et effectuerons une petite analyse dynamique du micrologiciel. </p><a name="habracut"></a><br><h2 id="predystoriya">  Contexte </h2><br><p><del>  Il y a longtemps dans une galaxie tr√®s lointaine </del></p><br><p>  Il y a quelques ann√©es, dans notre laboratoire, il √©tait n√©cessaire d'√©tudier le micrologiciel de l'appareil.  Le firmware a √©t√© compress√©, d√©compress√© par le chargeur de d√©marrage.  Il l'a fait d'une mani√®re tr√®s confuse, d√©pla√ßant plusieurs fois les donn√©es en m√©moire.  Oui, et le firmware lui-m√™me a alors activement interagi avec les p√©riph√©riques.  Et tout cela sur le noyau MIPS. </p><br><p>  Pour des raisons objectives, les √©mulateurs existants ne nous convenaient pas, mais je voulais quand m√™me ex√©cuter le code.  Ensuite, nous avons d√©cid√© de faire notre propre √©mulateur, qui fera un minimum et permettra de d√©baller le firmware principal.  Nous avons essay√© - il s'est av√©r√©.  Nous avons pens√©, que faire si nous ajoutons des p√©riph√©riques afin d'ex√©cuter √©galement le firmware principal.  Ce n'√©tait pas tr√®s douloureux - et √ßa a fonctionn√© aussi.  Nous avons r√©fl√©chi √† nouveau et avons d√©cid√© de cr√©er un √©mulateur √† part enti√®re. </p><br><p>  Le r√©sultat a √©t√© un √©mulateur de syst√®mes informatiques <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kopycat</a> . </p><br><img src="https://habrastorage.org/webt/eb/cx/b6/ebcxb6pxtiypy0s-usvu6i_hdwu.png" align="right"><br><div class="spoiler">  <b class="spoiler_title">Pourquoi Kopycat?</b> <div class="spoiler_text"><p>  Il y a un jeu de mots. </p><br><ol><li>  <em>copycat</em> (anglais, n. [Ààk…íp…™k√¶t]) - copycat, imitator </li><li>  <em>cat</em> (anglais, n. [Ààk√¶t]) - un chat, un chat - un animal pr√©f√©r√© de l'un des cr√©ateurs du projet </li><li>  Lettre "K" - du langage de programmation Kotlin </li></ol></div></div><br><h2 id="kopycat">  Kopycat </h2><br><p>  Lors de la cr√©ation de l'√©mulateur, des objectifs absolument sp√©cifiques ont √©t√© d√©finis: </p><br><ul><li>  la possibilit√© de cr√©er rapidement une nouvelle p√©riph√©rie, module, c≈ìur de processeur; </li><li>  la possibilit√© d'assembler un appareil virtuel √† partir de divers modules; </li><li>  la possibilit√© de charger toutes les donn√©es binaires (firmware) dans la m√©moire du p√©riph√©rique virtuel; </li><li>  la capacit√© de travailler avec des instantan√©s (instantan√©s de l'√©tat du syst√®me); </li><li>  la possibilit√© d'interagir avec l'√©mulateur via le d√©bogueur int√©gr√©; </li><li>  beau langage moderne √† d√©velopper. </li></ul><br><p>  En cons√©quence, Kotlin a √©t√© choisi pour l'impl√©mentation, l'architecture de bus (c'est lorsque les modules communiquent entre eux via des bus de donn√©es virtuels), JSON comme format de description de p√©riph√©rique et GDB RSP comme protocole d'interaction avec le d√©bogueur. </p><br><p>  Le d√©veloppement se poursuit depuis un peu plus de deux ans et se poursuit activement.  Pendant ce temps, les c≈ìurs de processeur MIPS, x86, V850ES, ARM et PowerPC ont √©t√© mis en ≈ìuvre. </p><br><p>  Le projet prend de l'ampleur et il est temps de le pr√©senter au grand public.  Nous ferons une description d√©taill√©e du projet plus tard, mais nous allons maintenant nous concentrer sur l'utilisation de Kopycat. </p><br><p>  Pour les plus impatients - la version promo de l'√©mulateur peut √™tre t√©l√©charg√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><h2 id="nosorog-v-emulyatore">  Rhino dans l'√©mulateur </h2><br><p>  Rappelons que plus t√¥t pour la conf√©rence SMARTRHINO-2018, un appareil de test "Rhinoc√©ros" a √©t√© cr√©√© pour la formation aux techniques de reverse engineering.  Le processus d'analyse statique du micrologiciel a √©t√© d√©crit dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . </p><br><p>  Essayons maintenant d'ajouter des ¬´haut-parleurs¬ª et d'ex√©cuter le firmware dans l'√©mulateur. </p><br><p>  Nous aurons besoin de: <br>  1) Java 1.8 <br>  2) Python et le module <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jep</a> pour utiliser Python √† l'int√©rieur de l'√©mulateur.  L'assemblage WHL du module Jep pour Windows peut √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t√©l√©charg√© ici</a> . </p><br><p>  <strong>Pour Windows:</strong> <br>  1) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">com0com</a> <br>  2) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PuTTY</a> </p><br><p>  <strong>Pour Linux:</strong> <br>  1) socat </p><br><p>  Vous pouvez utiliser Eclipse, IDA Pro ou radare2 en tant que client GDB. </p><br><h2 id="kak-eto-rabotaet">  Comment √ßa marche? </h2><br><p>  Afin d'ex√©cuter le firmware dans l'√©mulateur, vous devez "assembler" un p√©riph√©rique virtuel, qui est un analogue d'un p√©riph√©rique r√©el. </p><br><p>  Le v√©ritable appareil ("rhinoc√©ros") peut √™tre repr√©sent√© dans un sch√©ma fonctionnel: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nh/ph/ph/nhphph7rjwm3xiv52mvp_uefdq8.jpeg" alt="Circuit de l'appareil r√©el" width="60%"></div><br><p>  L'√©mulateur a une structure modulaire et le p√©riph√©rique virtuel final peut √™tre d√©crit dans un fichier JSON. </p><br><div class="spoiler">  <b class="spoiler_title">JSON sur 105 lignes</b> <div class="spoiler_text"><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"top"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, // Plugin name should be the same as file name (or full path from library start) <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"rhino"</span></span>, // Directory where plugin places <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, // Plugin parameters (constructor parameters if jar-plugin version) <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tty_dbg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tty_bt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"firmware"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: <span class="hljs-string"><span class="hljs-string">"NUL"</span></span>} ], // Plugin outer ports <span class="hljs-attr"><span class="hljs-attr">"ports"</span></span>: [ ], // Plugin internal buses <span class="hljs-attr"><span class="hljs-attr">"buses"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"mem"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUS30"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nand"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"4"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"gpio"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUS32"</span></span> } ], // Plugin internal components <span class="hljs-attr"><span class="hljs-attr">"modules"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"u1_stm32"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"STM32F042"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"firmware:String"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.firmware"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"usart_debug"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"UartSerialTerminal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"terminals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"tty"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.tty_dbg"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"term_bt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"UartSerialTerminal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"terminals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"tty"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.tty_bt"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"bluetooth"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"BT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_8"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_12"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_13"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_14"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_15"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> } ], // Plugin connection between components <span class="hljs-attr"><span class="hljs-attr">"connections"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart1_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"usart_debug.ports.term_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart1_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"usart_debug.ports.term_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart2_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.usart_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart2_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.usart_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.bt_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"term_bt.ports.term_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.bt_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"term_bt.ports.term_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_0.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x00"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_1.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x01"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_2.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x02"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_3.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x03"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_4.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x04"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_5.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x05"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_6.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x06"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_7.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x07"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_8.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x08"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_9.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x09"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_10.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0A"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_11.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0B"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_12.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0C"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_13.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0D"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_14.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0E"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_15.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0F"</span></span>] ] }</code> </pre> <br><p>  Faites attention au param√®tre du <em>firmware</em> dans la section <strong>params</strong> - c'est le nom du fichier qui peut √™tre t√©l√©charg√© sur le p√©riph√©rique virtuel en tant que firmware. </p></div></div><br><p>  Un p√©riph√©rique virtuel et son interaction avec le syst√®me d'exploitation principal peuvent √™tre repr√©sent√©s comme suit: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m9/i_/27/m9i_27btauj0onjugttzj3srmfg.jpeg" alt="Circuit √©mul√©" width="80%"></div><br><p>  L'instance de test actuelle de l'√©mulateur implique une interaction avec les ports COM du syst√®me d'exploitation principal (d√©bogage UART et UART pour le module Bluetooth).  Il peut s'agir de ports r√©els auxquels les p√©riph√©riques sont connect√©s ou de ports COM virtuels ( <em>com0com / socat est</em> juste pour cela <em>)</em> . </p><br><p>  Il existe actuellement deux fa√ßons principales d'interagir avec l'√©mulateur de l'ext√©rieur: </p><br><ul><li>  Protocole GDB RSP (respectivement, supportant ce protocole, outils - Eclipse / IDA / radare2); </li><li>  ligne de commande interne de l'√©mulateur (Argparse ou Python). </li></ul><br><h3 id="virtualnye-com-porty">  Ports COM virtuels </h3><br><p>  Afin d'interagir avec l'UART du p√©riph√©rique virtuel sur la machine locale via le terminal, vous devez cr√©er quelques ports COM virtuels connect√©s.  Dans notre cas, un port utilise un √©mulateur, et le second un programme terminal (PuTTY ou √©cran): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5d/jr/0w/5djr0wz88dgdaiw1xaasrof2wyk.png" alt="Ports COM virtuels" width="80%"></div><br><h4 id="ispolzovanie-com0com">  Utilisation de com0com </h4><br><p>  Les ports COM virtuels sont configur√©s avec l'utilitaire d'installation √† partir du kit com0com (la version de la console est <em>C: \ Program Files (x86) \ com0com \ setup.exe,</em> ou la version GUI est <em>C: \ Program Files (x86) \ com0com \ setupg.exe</em> ) : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v-/j9/pf/v-j9pfquunpiezqhkcr6cuyq-9k.png" alt="Configurer les ports COM virtuels"></div><br><p>  <strong><em>Cochez les cases Activer le d√©passement de tampon</em></strong> pour tous les ports virtuels cr√©√©s, sinon l'√©mulateur attendra une r√©ponse du port COM. </p><br><h4 id="ispolzovanie-socat">  Utiliser socat </h4><br><p>  Sur les syst√®mes UNIX, les ports COM virtuels sont automatiquement cr√©√©s par l'√©mulateur √† l'aide de l'utilitaire socat, pour cela il suffit de sp√©cifier le pr√©fixe <code>socat:</code> dans le nom du port lors du d√©marrage de l'√©mulateur. </p><br><h3 id="vnutrenniy-interfeys-komandnoy-stroki-argparse-ili-python">  Interface de ligne de commande interne (Argparse ou Python) </h3><br><p>  √âtant donn√© que Kopycat est une application console, l'√©mulateur fournit deux options permettant √† l'interface de ligne de commande d'interagir avec ses objets et variables: Argparse et Python. </p><br><p>  Argparse est l'interface CLI int√©gr√©e √† Kopycat, elle est toujours disponible pour tout le monde. </p><br><p>  Une CLI alternative est l'interpr√©teur Python.  Pour l'utiliser, vous devez installer le module Jep Python et configurer l'√©mulateur pour qu'il fonctionne avec Python (l'interpr√©teur Python install√© sur le syst√®me principal de l'utilisateur sera utilis√©). </p><br><h4 id="ustanovka-python-modulya-jep">  Installer le module Jep Python </h4><br><p>  Sous Linux, Jep peut √™tre install√© via pip: </p><br><pre> <code class="bash hljs">pip install jep</code> </pre> <br><p>  Pour installer Jep sous Windows, vous devez d'abord installer le SDK Windows et le Microsoft Visual Studio correspondant.  Nous avons simplifi√© un peu votre t√¢che et cr√©√© des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">assemblys WHL</a> JEP pour les versions actuelles de Python pour Windows, afin que le module puisse √™tre install√© √† partir d'un fichier: </p><br><pre> <code class="bash hljs">pip install jep-3.8.2-cp27-cp27m-win_amd64.whl</code> </pre> <br><p>  Pour v√©rifier l'installation de Jep, vous devez ex√©cuter la ligne de commande: </p><br><pre> <code class="bash hljs">python -c <span class="hljs-string"><span class="hljs-string">"import jep"</span></span></code> </pre> <br><p>  En r√©ponse, un message doit √™tre re√ßu: </p><br><pre> <code class="bash hljs">ImportError: Jep is not supported <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> standalone Python, it must be embedded <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Java.</code> </pre> <br><p>  Dans le fichier de commandes de l'√©mulateur pour votre syst√®me ( <em>kopycat.bat</em> pour Windows, <em>kopycat</em> pour Linux), ajoutez le param√®tre suppl√©mentaire <code>Djava.library.path</code> √† la liste des param√®tres <code>DEFAULT_JVM_OPTS</code> - il doit contenir le chemin d'acc√®s au module Jep install√©. </p><br><p>  Par cons√©quent, pour Windows, vous devriez obtenir une ligne comme celle-ci: </p><br><pre> <code class="plaintext hljs">set DEFAULT_JVM_OPTS="-XX:MaxMetaspaceSize=256m" "-XX:+UseParallelGC" "-XX:SurvivorRatio=6" "-XX:-UseGCOverheadLimit" "-Djava.library.path=C:/Python27/Lib/site-packages/jep"</code> </pre> <br><h2 id="zapusk-kopycat">  Lancement de Kopycat </h2><br><p>  L'√©mulateur est une application JVM de console.  Le lancement s'effectue via le script de ligne de commande du syst√®me d'exploitation (sh / cmd). </p><br><p>  Commande √† ex√©cuter sous Windows: </p><br><pre> <code class="plaintext hljs">bin\kopycat -g 23946 -n rhino -l user -y library -p firmware=firmware\rhino_pass.bin,tty_dbg=COM26,tty_bt=COM28</code> </pre> <br><p>  La commande √† ex√©cuter sous Linux √† l'aide de l'utilitaire socat: </p><br><pre> <code class="plaintext hljs">./bin/kopycat -g 23946 -n rhino -l user -y library -p firmware=./firmware/rhino_pass.bin,tty_dbg=socat:./COM26,tty_bt=socat:./COM28</code> </pre> <br><ul><li>  <code>-g 23646</code> - Port TCP qui sera ouvert pour l'acc√®s au serveur GDB; </li><li>  <code>-n rhino</code> - le nom du module principal du syst√®me (assemblage de p√©riph√©rique); </li><li>  <code>-l user</code> - le nom de la biblioth√®que pour rechercher le module principal; </li><li>  <code>-y library</code> - le chemin pour rechercher les modules inclus dans le p√©riph√©rique; </li><li>  <code>firmware\rhino_pass.bin</code> - chemin vers le fichier du firmware; </li><li>  COM26 et COM28 sont des ports COM virtuels. </li></ul><br><p>  Le r√©sultat sera l' <code>Argparse &gt;</code> <code>Python &gt;</code> (ou <code>Argparse &gt;</code> ): </p><br><pre> <code class="plaintext hljs">18:07:59 INFO [eFactoryBuilder.create ]: Module top successfully created as top 18:07:59 INFO [ Module.initializeAndRes]: Setup core to top.u1_stm32.cortexm0.arm for top 18:07:59 INFO [ Module.initializeAndRes]: Setup debugger to top.u1_stm32.dbg for top 18:07:59 WARN [ Module.initializeAndRes]: Tracer wasn't found in top... 18:07:59 INFO [ Module.initializeAndRes]: Initializing ports and buses... 18:07:59 WARN [ Module.initializePortsA]: ATTENTION: Some ports has warning use printModulesPortsWarnings to see it... 18:07:59 FINE [ ARMv6CPU.reset ]: Set entry point address to 08006A75 18:07:59 INFO [ Module.initializeAndRes]: Module top is successfully initialized and reset as a top cell! 18:07:59 INFO [ Kopycat.open ]: Starting virtualization of board top[rhino] with arm[ARMv6Core] 18:07:59 INFO [ GDBServer.debuggerModule ]: Set new debugger module top.u1_stm32.dbg for GDB_SERVER(port=23946,alive=true) Python &gt;</code> </pre> <br><h2 id="vzaimodeystvie-s-ida-pro">  Interaction avec IDA Pro </h2><br><p>  Pour simplifier les tests, nous utilisons le firmware Rhino comme <a href="">fichier ELF</a> (les m√©ta-informations y sont enregistr√©es) comme fichier source pour l'analyse dans IDA. </p><br><p>  Vous pouvez √©galement utiliser le micrologiciel principal sans m√©ta-informations. </p><br><p>  Apr√®s avoir d√©marr√© Kopycat dans IDA Pro, dans le menu Debugger, acc√©dez √† l'√©l√©ment " <em>Switch debugger ...</em> " et s√©lectionnez " <em>Remote GDB debugger</em> ".  Ensuite, configurez la connexion: menu <em>D√©bogueur - Options de processus ...</em> </p><br><p>  D√©finissez les valeurs: </p><br><ul><li>  Application - toute valeur </li><li>  Nom d'h√¥te: 127.0.0.1 (ou l'adresse IP de la machine distante sur laquelle Kopycat s'ex√©cute) </li><li>  Port: 23946 </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mx/kw/-l/mxkw-lbzq_igoewovazplw4moho.png" alt="Configuration de la connexion au serveur GDB"></div><br><p>  Maintenant, le bouton de d√©marrage du d√©bogage est disponible (touche F9): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/mu/-q/afmu-qpi0ymfpsga-orunargmas.png"></div><br><p>  Appuyez dessus - il se connecte au module de d√©bogage dans l'√©mulateur.  IDA passe en mode d√©bogage, des fen√™tres suppl√©mentaires deviennent disponibles: informations sur les registres, sur la pile. </p><br><p>  Nous pouvons maintenant utiliser toutes les fonctionnalit√©s standard du travail avec le d√©bogueur: </p><br><ul><li>  ex√©cution pas √† pas des instructions ( <em>Step into</em> et <em>Step over</em> - touches F7 et F8, respectivement); </li><li>  d√©marrer et suspendre l'ex√©cution; </li><li>  cr√©ation de points d'arr√™t sur le code et les donn√©es (touche F2). </li></ul><br><p>  Se connecter au d√©bogueur ne signifie pas d√©marrer le code du firmware.  La position actuelle pour l'ex√©cution doit √™tre l'adresse <code>0x08006A74</code> - le d√©but de la fonction <em>Reset_Handler</em> .  Si vous faites d√©filer la liste ci-dessous, vous pouvez voir l'appel √† la fonction <em>principale</em> .  Vous pouvez placer le curseur sur cette ligne (adresse <code>0x08006ABE</code> ) et effectuer l'op√©ration <em>Ex√©cuter jusqu'au curseur</em> (touche F4). </p><br><p><img src="https://habrastorage.org/webt/wx/k4/3r/wxk43r-316cpnsdabb9eydkzus4.png" alt="image"></p><br><p>  Ensuite, vous pouvez appuyer sur F7 pour acc√©der √† la fonction <em>principale</em> . </p><br><p>  Si vous ex√©cutez la commande <em>Continue process</em> (touche F9), la fen√™tre "Please wait" appara√Ætra avec un seul bouton <em>Suspend</em> : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9e/78/tg/9e78tgoterc50rqvmosunzp1u5i.png"></div><br><p>  Lorsque <em>Suspend est</em> enfonc√©, l'ex√©cution du code du firmware est suspendue et peut √™tre poursuivie √† partir de la m√™me adresse dans le code o√π il a √©t√© interrompu. </p><br><p>  Si vous continuez √† ex√©cuter le code, dans les terminaux connect√©s aux ports COM virtuels, vous pouvez voir les lignes suivantes: </p><br><p><img src="https://habrastorage.org/webt/fi/vi/j-/fivij-hshz3izcxoo0lnewnznc8.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/2m/cn/oq/2mcnoqd__te1i0sq5z28jd29mdg.png" alt="image"></p><br><p>  La pr√©sence de la cha√Æne "State bypass" indique que le module Bluetooth virtuel est pass√© en mode de r√©ception de donn√©es depuis le port COM de l'utilisateur. </p><br><p>  Maintenant, dans le terminal Bluetooth (sur la figure - COM29), vous pouvez entrer des commandes conform√©ment au protocole Rhino.  Par exemple, la cha√Æne "mur-mur" revient √† la commande "MEOW" dans le terminal Bluetooth: </p><br><img src="https://habrastorage.org/webt/yq/td/ab/yqtdabgfdd3jlzswsrk3rvbdzds.png"><br><br><h3 id="emuliruy-menya-ne-polnostyu">  Imite pas compl√®tement </h3><br><p>  Lors de la construction d'un √©mulateur, vous pouvez choisir le degr√© de d√©tail / √©mulation d'un appareil.  Ainsi, par exemple, le module Bluetooth peut √™tre √©mul√© de diff√©rentes mani√®res: </p><br><ul><li>  appareil enti√®rement √©mul√© avec un ensemble complet de commandes; </li><li>  Les commandes AT sont √©mul√©es et le flux de donn√©es est re√ßu du port COM du syst√®me principal; </li><li>  le p√©riph√©rique virtuel fournit une redirection compl√®te des donn√©es vers un p√©riph√©rique r√©el; </li><li>  comme un simple talon qui renvoie toujours ¬´OK¬ª. </li></ul><br><p>  Dans la version actuelle de l'√©mulateur, la deuxi√®me approche est utilis√©e - le module Bluetooth virtuel effectue la configuration, apr√®s quoi il passe en mode proxy de donn√©es du port COM du syst√®me principal vers le port UART de l'√©mulateur. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e6/5c/m_/e65cm_tl2bggpbg0-q0azjvdz64.jpeg"></div><br><p>  Consid√©rez la possibilit√© d'une instrumentation simple du code si une partie de la p√©riph√©rie n'est pas impl√©ment√©e.  Par exemple, si aucun temporisateur n'est cr√©√© pour contr√¥ler le transfert de donn√©es dans DMA (la v√©rification est effectu√©e dans la fonction <em>ws2812b_wait</em> situ√©e √† <code>0x08006840</code> ), le micrologiciel attendra toujours l'indicateur <em>occup√©</em> situ√© √† <code>0x200004C4</code> pour r√©initialiser la ligne de donn√©es DMA: </p><br><img src="https://habrastorage.org/webt/pt/jj/su/ptjjsutfya2dkoqdoshkeyeeqzw.png"><br><p>  Nous pouvons contourner cette situation en r√©initialisant manuellement le drapeau <em>occup√©</em> imm√©diatement apr√®s l'avoir d√©fini.  Dans IDA Pro, vous pouvez cr√©er une fonction Python et l'appeler en point d'arr√™t, et le point d'arr√™t doit √™tre d√©fini dans le code apr√®s avoir √©crit la valeur 1 dans l'indicateur <em>occup√©</em> . </p><br><h4 id="breakpoint-obrabotchik">  Gestionnaire de points d'arr√™t </h4><br><p>  Cr√©ez d'abord une fonction Python dans l'IDA.  Menu <em>Fichier - Commande de script ...</em> </p><br><p>  Ajoutez un nouvel extrait dans la liste de gauche, donnez-lui un nom (par exemple, <em>BPT</em> ), <br>  dans la zone de texte √† droite, nous entrons le code de fonction: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_dma</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Skipping wait ws2812..."</span></span> value = Byte(<span class="hljs-number"><span class="hljs-number">0x200004C4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value == <span class="hljs-number"><span class="hljs-number">1</span></span>: PatchDbgByte(<span class="hljs-number"><span class="hljs-number">0x200004C4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zi/za/-d/ziza-ddx3arqlqfbd-o6jvdmnjc.png"></div><br><p>  Apr√®s cela, cliquez sur <em>Ex√©cuter</em> et fermez la fen√™tre de script. </p><br><p>  Passons maintenant au code √† <code>0x0800688A</code> , d√©finissons le point d'arr√™t (touche F2), modifiez-le (menu contextuel <em>Modifier le point d'arr√™t ...</em> ), n'oubliez pas de d√©finir le type de script - Python: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fo/pn/1v/fopn1vb8fbxqrhn6xoia_rgnsau.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h6/yq/b2/h6yqb29r1m9sngr3csfimxcxsew.png"></div><br><p>  Si la valeur actuelle de l'indicateur <em>occup√©</em> est 1, la fonction <em>skip_dma</em> doit √™tre <em>ex√©cut√©e</em> dans la ligne de script: </p><br><img src="https://habrastorage.org/webt/m-/t8/in/m-t8in2th7ei6neigdzgzq17kxy.png"><br><p>  Si vous ex√©cutez le micrologiciel pour ex√©cution, le code du gestionnaire de points d'arr√™t peut √™tre vu dans l'IDA dans la fen√™tre <em>Sortie</em> sur la ligne <code>Skipping wait ws2812...</code>  Maintenant, le firmware n'attendra pas pour r√©initialiser le drapeau <em>occup√©</em> . </p><br><h4 id="vzaimodeystvie-s-emulyatorom">  Interaction √©mulateur </h4><br><p>  Il est peu probable que l'√©mulation √† des fins d'√©mulation suscite joie et plaisir.  C'est beaucoup plus int√©ressant si l'√©mulateur aide le chercheur √† voir les donn√©es en m√©moire ou √† √©tablir l'interaction des flux. </p><br><p>  Nous montrons comment √©tablir dynamiquement l'interaction des t√¢ches RTOS.  Tout d'abord, suspendez l'ex√©cution du code s'il est en cours d'ex√©cution.  Si vous passez √† la fonction <em>bluetooth_task_entry</em> dans la branche de traitement des commandes "LED" (adresse <code>0x080057B8</code> ), vous pouvez voir ce qui est cr√©√© en premier, puis un message est envoy√© √† la file d'attente syst√®me <em>ledControlQueueHandle</em> . </p><br><p><img src="https://habrastorage.org/webt/po/bk/zm/pobkzmapmust02eaafle7d_pxba.png" alt="image"></p><br><p>  Vous devez d√©finir un point d'arr√™t pour acc√©der √† la variable <em>ledControlQueueHandle</em> situ√©e √† <code>0x20000624</code> et continuer √† ex√©cuter le code: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ev/wo/g3/evwog3vrv7ozxlxjozd4itvve0a.png"></div><br><p>  Par cons√©quent, il s'arr√™tera d'abord √† l'adresse <code>0x080057CA</code> avant d'appeler la fonction <em>osMailAlloc</em> , puis √† <code>0x08005806</code> avant d'appeler la fonction <em>osMailPut</em> , puis apr√®s un certain temps √† l'adresse <code>0x08005BD4</code> (avant d'appeler la fonction <em>osMailGet</em> ), qui appartient √† la fonction <em>leds_task_entry</em> (t√¢che LED), c'est-√†-dire il y avait un interrupteur de t√¢che, et maintenant le contr√¥le a re√ßu la t√¢che LED. </p><br><p><img src="https://habrastorage.org/webt/th/ni/zh/thnizhzqykfn20l9-btkuqhawlc.png" alt="image"></p><br><p>  D'une mani√®re si simple, vous pouvez √©tablir comment les t√¢ches RTOS interagissent les unes avec les autres. </p><br><p>  Bien s√ªr, en r√©alit√©, l'interaction des t√¢ches peut √™tre plus compliqu√©e, mais l'utilisation d'un √©mulateur pour suivre cette interaction devient moins difficile. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici,</a> vous pouvez regarder une courte vid√©o du lancement de l'√©mulateur et de l'interaction avec IDA Pro. </p><br><h2 id="zapusk-s-radare2">  Lancement avec Radare2 </h2><br><p>  Vous ne pouvez pas ignorer un outil universel tel que Radare2. </p><br><p>  Pour vous connecter √† l'√©mulateur √† l'aide de r2, la commande ressemblera √† ceci: </p><br><pre> <code class="plaintext hljs">radare2 -A -a arm -b 16 -d gdb://localhost:23946 rhino_fw42k6.elf</code> </pre> <br><p>  Maintenant, d√©marrer ( <code>dc</code> ) et suspendre l'ex√©cution (Ctrl + C) sont disponibles. </p><br><p>  Malheureusement, pour le moment dans r2, il y a des probl√®mes lorsque vous travaillez avec un serveur gdb mat√©riel et un balisage de m√©moire, pour cette raison, les points d'arr√™t et les √©tapes (la commande <code>ds</code> ) ne fonctionnent pas.  Nous esp√©rons que cela sera corrig√© dans un proche avenir. </p><br><h2 id="zapusk-s-eclipse">  Lancement avec Eclipse </h2><br><p>  L'une des options d'utilisation de l'√©mulateur consiste √† d√©boguer le micrologiciel de l'appareil en cours de d√©veloppement.  Pour plus de clart√©, nous utiliserons √©galement le firmware Rhino.  Vous pouvez t√©l√©charger les sources <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">du</a> firmware √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partir d'ici</a> . </p><br><p>  Nous utiliserons Eclipse de la suite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">System Workbench pour STM32</a> comme IDE. </p><br><p>  Pour que le micrologiciel directement compil√© dans Eclipse soit charg√© dans l'√©mulateur, vous devez ajouter le param√®tre <code>firmware=null</code> √† la commande de d√©marrage de l'√©mulateur: </p><br><pre> <code class="plaintext hljs">bin\kopycat -g 23946 -n rhino -l user -y library -p firmware=null,tty_dbg=COM26,tty_bt=COM28</code> </pre> <br><h3 id="nastroyka-debug-konfiguracii">  Configuration de d√©bogage </h3><br><p>  Dans Eclipse, s√©lectionnez le menu <em>Ex√©cuter - Configurations de d√©bogage ....</em> Dans la fen√™tre qui s'ouvre, dans la section <em>D√©bogage mat√©riel GDB</em> , vous devez ajouter une nouvelle configuration, puis sp√©cifier le projet et l'application en cours de d√©bogage dans l'onglet "Principal": </p><br><img src="https://habrastorage.org/webt/f-/yk/eo/f-ykeob2i5vg25qbrz_egbqntou.png"><br><p>  Dans l'onglet D√©bogueur, vous devez sp√©cifier la commande GDB: <br> <code>${openstm32_compiler_path}\arm-none-eabi-gdb</code> </p> <br><p>  Et entrez √©galement les param√®tres de connexion au serveur GDB (h√¥te et port): </p><br><img src="https://habrastorage.org/webt/ef/ud/fo/efudfommb7a9gkr4kcvp0vtnqfm.png"><br><p>  Les param√®tres suivants doivent √™tre sp√©cifi√©s dans l'onglet "D√©marrage": </p><br><ul><li>  cochez la case <em>Charger l'image</em> (pour que l'image du micrologiciel assembl√© soit charg√©e dans l'√©mulateur); </li><li>  activez la coche <em>Charger les symboles</em> ; </li><li>  ajoutez une commande de d√©marrage: <code>set $pc = *0x08000004</code> (d√©finissez la valeur de la m√©moire √† l'adresse <code>0x08000004</code> dans le registre PC - l'adresse du <code>0x08000004</code> est stock√©e). </li></ul><br><p>  <strong>Veuillez noter</strong> que si vous ne souhaitez pas t√©l√©charger le fichier du micrologiciel √† partir d'Eclipse, vous n'avez pas besoin de sp√©cifier les param√®tres des <em>commandes</em> <em>Charger l'image</em> et <em>Ex√©cuter</em> . </p><br><img src="https://habrastorage.org/webt/w3/q8/2f/w3q82fvei4c91385rlcipmuiy_i.png"><br><p>  Apr√®s avoir cliqu√© sur D√©boguer, vous pouvez travailler en mode d√©bogage: </p><br><ul><li>  ex√©cution de code √©tape par √©tape <br><img src="https://habrastorage.org/webt/1h/6n/ax/1h6nax1gpgcdyrwakdmzzlu6_x8.png"></li><li>  interaction avec les points d'arr√™t <br><img src="https://habrastorage.org/webt/4d/n1/5e/4dn15e4hzaukbif58ggwhy_wg18.png"></li></ul><br><p>  <strong><em>Remarque</em></strong>  <em>Eclipse a, hmm ... quelques fonctionnalit√©s ... et vous devez vivre avec elles.</em>  <em>Par exemple, si le message ¬´Aucune source disponible pour¬´ 0x0 ¬ª¬ª appara√Æt lors du d√©marrage du d√©bogueur, ex√©cutez la commande Step (F5)</em> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ra/uz/ko/rauzko55hgnj1y_uapnqbz8ftrw.png"></div><br><h2 id="vmesto-zaklyucheniya">  Au lieu d'une conclusion </h2><br><p>  L'√©mulation de code natif est une chose tr√®s int√©ressante.  Pour un d√©veloppeur de p√©riph√©riques, il devient possible de d√©boguer le firmware sans v√©ritable p√©riph√©rique.  Pour le chercheur - la possibilit√© d'effectuer une analyse de code dynamique, ce qui n'est pas toujours possible m√™me avec un appareil. </p><br><p>  Nous voulons fournir aux sp√©cialistes un outil qui serait pratique, mod√©r√©ment simple et qui n'a pas pris beaucoup d'efforts et de temps √† configurer et √† lancer. </p><br><p>  √âcrivez dans les commentaires sur votre exp√©rience d'utilisation des √©mulateurs mat√©riels.  Nous vous invitons √† une discussion et serons heureux de r√©pondre √† vos questions. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445798/">https://habr.com/ru/post/fr445798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445786/index.html">Cryptographie en Java. Classe KeyStore</a></li>
<li><a href="../fr445788/index.html">Vid√©osurveillance en nuage √† faire soi-m√™me: nouvelles fonctionnalit√©s du SDK Web Ivideon</a></li>
<li><a href="../fr445792/index.html">Comment nous d√©veloppons la documentation dans un projet Embox ouvert</a></li>
<li><a href="../fr445794/index.html">Les g√©ants de l'informatique d√©voilent une solution de d√©ploiement de cloud hybride hybride</a></li>
<li><a href="../fr445796/index.html">Fintech Digest: Dorsey paie avec des bitcoins, la strat√©gie de la blockchain en Australie, l'introduction en bourse de Levi, le maire de Chicago et l'in√©vitabilit√© du bitcoin</a></li>
<li><a href="../fr445800/index.html">Monades en 15 minutes</a></li>
<li><a href="../fr445802/index.html">5 choses que tout le monde devrait savoir sur Internet</a></li>
<li><a href="../fr445804/index.html">Encapsulation pour de vrais samoura√Øs ou les nuances associ√©es au mot-cl√© interne en C #</a></li>
<li><a href="../fr445806/index.html">Comment l'intelligence artificielle change la science</a></li>
<li><a href="../fr445808/index.html">Nous d√©testons et chassons: la vie dangereuse d'un pirate de virus qui se fait de puissants ennemis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>