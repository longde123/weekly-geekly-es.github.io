<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚎 😠 🚡 تكوين صداقات CI ، اختبارات وحدة وقاعدة البيانات 👩🏻‍⚕️ 🧛🏾 🚆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="المقالة حول اختبار التفاعل مع قاعدة البيانات في CI. لقد رأيت العديد من الحلول التي تستخدم عامل النقل والحاملين للاختبار ، لكن لدي حلمي وأريد مشاركته. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>تكوين صداقات CI ، اختبارات وحدة وقاعدة البيانات</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452722/" style=";text-align:right;direction:rtl"><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/p9/2f/hw/p92fhwlfahzagt8w9wzxpfclgzw.png" alt="صورة"></div><br>  المقالة حول اختبار التفاعل مع قاعدة البيانات في CI.  لقد رأيت العديد من الحلول التي تستخدم عامل النقل والحاملين للاختبار ، لكن لدي حلمي وأريد مشاركته. <br><a name="habracut"></a><br>  تم ربط مشروع جافا الماضي الخاص بي ارتباطًا وثيقًا بقاعدة بيانات.  معالجة طويلة مع إعادة المحاولة ، multithreading ، وأقفال القفل.  بالنسبة للمهمة ، كان مطلوبًا تصحيح بضع استعلامات SQL صعبة.  كنت معتادًا على تغطية الكود الخاص بي مع الاختبارات ، لكن قبل ذلك تم تحويل كل SQL إلى استعلامات بدائية ويمكن تشغيلها على قاعدة H2 في الذاكرة.  وهنا على المتشددين. <br><br>  يمكنني اختبار لغة الاستعلامات البنيوية البسيطة بيدي ومطرقة الجبان في الاختبارات الذاتية ، مبررًا نفسي "لست نوعًا من الباغودل ، هناك أخطاء في الكود البسيط."  في الواقع ، تظهر الأخطاء في كثير من الأحيان أقل بسبب توافر الاختبارات.  كان من الممكن دفع المسؤولية إلى المختبرين - إذا ارتكبت خطأ في مكان ما ، فسوف يجدون ذلك. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/js/ro/nh/jsronhgbydvhziosboj6velwb5w.png" alt="صورة"></div><br>  وفقًا لإيديولوجية اختبار الوحدة ، لا يلزم إجراء اختبارات إلا لاختبار الوحدات الفردية ، وإذا كانت الوحدة تستخدم شيئًا من الخارج ، فيجب استبداله بكعب.  في الممارسة العملية ، عندما يصبح من الصعب للغاية تنفيذ روتين ، يتم تجاهل الوحدة ببساطة.  تعد السرعة والوحدات النمطية أمران مهمان ، لكن من المهم عدم ترك الكود بدون اختبار ، حتى لو لم يظهر في مقاييس التغطية.  لذلك ، لم تعد تعتبر الوحدة النمطية فئة منفصلة ، ولكن مجموعة متصلة ، جنبا إلى جنب مع التكوين.  الشيء الرئيسي في مثل هذه العبارات هو عدم الوصول إلى مفهوم الوحدة التي تمتد إلى مستوى الكتلة. <br><br>  للاختبار المحلي ، لدى كل مطور خطة خاصة به ، ولكن يتم تشغيل الاختبارات على Jenkins ولا يوجد اتصال بقاعدة البيانات هناك حتى الآن.  يحتاج CI إلى دائرة منفصلة ، ويبدو أنه واضح.  لكن على الرسم التخطيطي الفارغ ، ليس من الصحيح للغاية إجراء الاختبارات ؛ إن إنشاء بنية قاعدة بيانات في كل اختبار يستغرق وقتًا طويلاً وينطوي على تباين بين الهيكل في الاختبار وفي المعركة.  ركض على قاعدة معدة مسبقًا - أحصل على مجموعة من المشكلات في الفروع.  يمكنك إعداد قاعدة البيانات قبل تشغيل جميع الاختبارات باستخدام قاعدة بيانات تسييل ، ومسح كل شيء أولاً إلى الصفر ، ثم التحديث إلى أحدث إصدار. <br><br>  غالبًا ما يتم نسيان الاستعادة ويجب عليك تنظيف القواعد بيديك على بيئات الاختبار.  اختباره وله!  الخوارزمية هي كما يلي: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  إزالة كل شيء تحت الجذر (لنقاء التجربة) </li><li style=";text-align:right;direction:rtl">  التحديث إلى أحدث إصدار </li><li style=";text-align:right;direction:rtl">  أداء التراجع 1-2 الإصدارات مرة أخرى </li><li style=";text-align:right;direction:rtl">  التحديث إلى أحدث إصدار (يلزم إجراء الاختبارات على بنية قاعدة البيانات الجديدة ، بالإضافة إلى التحقق من أن الاستعادة لم تنس حذف أي شيء ، مما سيمنع التحديث من العودة مرة أخرى) </li></ol><br>  لا يريد المطورون الزميلون تشغيل اختبار الاستعادة عند بدء كل اختبار.  نحن جعل التبديل. <br><br><pre style=";text-align:right;direction:rtl"><code class="kotlin hljs">project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre> <br>  بينما هناك تدريب على القطط ، كل شيء على ما يرام.  لكن أحد المشروعات التي يتم تطويرها ديناميكيًا يجعل التعديلات الخاصة به - عمليتان للسحب ، تجميع متزامن.  مثال واحد هو اختبار شيء ما ، والثاني هو ضرب القاعدة من تحت قدميها.  يتم حلها عن طريق فرض حظر بسيط على الجمعيات الموازية. <br><br><img src="https://habrastorage.org/webt/my/64/hm/my64hmqfabt8qg0jcuz-xwiddvi.png" alt="صورة"><br><br>  ومرة أخرى السقوط - قررت إجراء اختبارات باستخدام حساب جينكينز ، لأنه  كل شيء على ما يرام على واحد الشخصية ، ومجموعة من الطلبات يقع لأسباب غير واضحة.  نحن نتذكر الحديث الحاد بأن DevOps هي ثقافة وأن استخدام الحسابات التقنية لأغراض شخصية أمر غير مقبول. <br><br><img src="https://habrastorage.org/webt/fr/lb/xf/frlbxfbj6ck-8pdbhff0v5kpeta.png" alt="صورة"><br><br>  تراكمت 10 مجموعة من الطلبات.  جميع جمعها ، وإعادة توزيعها ، يمكنك دمج.  أول واحد ذهب ، تغير الفرع الرئيسي - والباقي يقف في طابور لإعادة البناء.  يمكنك دمج كلما تقدمت ، لكن هناك أولويات.  عمليات سحب أكثر إلحاحًا ، أقل إلحاحًا ، يتم تعليقها أيضًا بسبب أخطاء في الكود.  بشكل عام ، موازاة الظهر. <br><br>  يجب أن يكون التجميع بسيطًا ، ويتألف من خطوات بسيطة ويكون مفهوما حتى بالنسبة لطالب الأمس.  في 99 ٪ لا توجد مشكلة في أن تجميع تجمع الطلب والإصدار متسلسل وليس متوازيًا.  إذا لم تتراكم المراجعة أكثر من 1-2 العلاقات العامة ، فإن حظر التجميعات المتزامنة يكون كافياً. <br><br>  ولأغراض الإطلاق المتوازي ، نحتاج إلى قواعد أو مخططات يكون لكل اختبار تم تشغيله وصولاً حصريًا إليها. <br><br>  الخيار الأول هو تخصيص ديناميكي.  إنشاء مخطط في قاعدة البيانات بسرعة.  وجود سحابة مع API ، يمكنك تخصيص قاعدة بيانات هناك. <br><br>  إذا لم تنجح في حذف حذف قواعد البيانات القديمة ، يمكنك إنهاء مساحة القرص بسرعة عندما تسقط الاختبارات و "تنس" لتحرير الموارد.  إنه "متى" وليس "إذا". <br><br>  الخيار الثاني - تجمع قاعدة بيانات / مخطط مع خدمة إدارة منفصلة.  في الخارج ، تتمسك واجهة برمجة التطبيقات (API) وتعطي القاعدة للوقت وتسترد القاعدة الحرة قبل المصطلح.  ما سيعود: خادم مخصص مع قاعدة بيانات أو مجرد مخطط قليلا ، لا يهم.  الشيء الرئيسي هو أن المورد لن تضيع إلى الأبد. <br><br>  الخيار الثالث - مجموعة من القواعد / المخططات للتنظيم الذاتي.  هناك حاجة إلى مورد لتبادل المعلومات حول الأقفال وتجمع قاعدة البيانات نفسها. <br><br>  لقد استقرت على الخيار الأخير ، لأنه من الأسهل بالنسبة لي أن أربطه وليس هناك حاجة إلى دعمه بشكل خاص.  المنطق على النحو التالي - يتم إنشاء عدة (10 دوائر على سبيل المثال) ويتم إضافة جميع المعلومات اللازمة حول الاتصال بها إلى المورد المشترك ، كل مثيل اختبار قبل البدء يجعل علامة البدء ، بعد النهاية - يحذفها.  إذا تعطل الاختبار قبل الانتهاء ، فسيتم اعتبار الدائرة مجانية في نهاية المهلة. <br><br>  إعدادات القراءة: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader())</code> </pre><br>  العمل مع sql من البرامج النصية يتطلب تحميل السائق: <br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> configurations { driver } dependencies { driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } }</code> </pre><br>  إتصال: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) }</code> </pre><br>  يمكن إجراء تبادل المعلومات من خلال جدول قاعدة البيانات.  تهيئة الجدول المرجعي (يجب أن يعمل مرة واحدة ، ثم يستمر الجدول حتى نهاية الوقت): <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } }</code> </pre><br>  للمطورين مخططات خاصة بهم للتصحيح والتجميع ، لذلك يجب إيقاف تشغيل استخدام التجمع: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre><br>  خذ وقاعدة مجانية: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } }</span></span></code> </pre><br>  إذا قمت بإكمال التجميع مرتين على التوالي ، يمكن تحديد أنظمة مختلفة وستظل قيم مختلفة عند تجميع ملفات الخصائص.  بالنسبة لعمليات الإطلاق المحلية ، تكون الإعدادات ثابتة. <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> configure([processResources, processTestResources]) { Task t -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (project.ext.isCiBuild()) { t.outputs.upToDateWhen { <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } t.filesMatching(<span class="hljs-string"><span class="hljs-string">'**/*.properties'</span></span>) { filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string"><span class="hljs-string">'${'</span></span>, endToken: <span class="hljs-string"><span class="hljs-string">'}'</span></span>) } }</code> </pre><br>  مهام اختبار الاستعادة: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> task restoreAfterRollbackTest(type: LiquibaseTask) { command = <span class="hljs-string"><span class="hljs-string">'update'</span></span> } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = <span class="hljs-string"><span class="hljs-string">'rollback'</span></span> requiresValue = <span class="hljs-literal"><span class="hljs-literal">true</span></span> doFirst { project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.tag'</span></span>] } doLast { project.ext.liquibaseCommandValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span> } }</code> </pre><br>  وقم بإعداد أمر التنفيذ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> configure([project]) { tasks.withType(LiquibaseTask.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>) { LiquibaseTask t -&gt; logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), configLiquibase.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn configLiquibase <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCiBuild()) { logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), lockDb.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn lockDb (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).finalizedBy unlockDb } } <span class="hljs-comment"><span class="hljs-comment">//   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br>  تخصيص قاعدة البيانات واختبار الاستعادة يمكن وضعها داخل الاختبارات.  طرق تشغيل التعليمات البرمجية قبل وبعد الانتهاء من جميع الاختبارات: في Junit5 ، هذا هو BeforeAllCallback ، في TestNG BeforeSuite. <br><br>  بالنسبة إلى السؤال "لماذا يجب اختبار sql بواسطة مبرمج java" ، فإن الإجابة هي أنه يجب اختبار أي كود.  هناك استثناءات وبعض الكود غير منطقي للاختبار في وقت معين. <br><br>  أود أن أعرف كيف يتم حل مشكلة اختبار التفاعل مع قاعدة البيانات بواسطة مبرمجين آخرين؟  هل وصلت الحاويات إلى كل منزل ، أم أن اختبار الاندماج ينتقل إلى أكتاف المختبرين؟ <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">قائمة كاملة</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonOutput <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonSlurper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.tools.ant.filters.ReplaceTokens <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.liquibase.gradle.LiquibaseTask plugins { id <span class="hljs-string"><span class="hljs-string">'java'</span></span> id <span class="hljs-string"><span class="hljs-string">'org.liquibase.gradle'</span></span> version <span class="hljs-string"><span class="hljs-string">'2.0.1'</span></span> } configurations { driver } repositories { jcenter() mavenCentral() maven { url = <span class="hljs-string"><span class="hljs-string">"http://www.datanucleus.org/downloads/maven2/"</span></span> } } dependencies { implementation <span class="hljs-string"><span class="hljs-string">'com.google.guava:guava:27.0.1-jre'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-core:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-context:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-jdbc:5.1.7.RELEASE'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'junit:junit:4.12'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-test:5.1.7.RELEASE'</span></span> testRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.liquibase:liquibase-core:3.6.1'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.yaml:snakeyaml:1.24'</span></span> driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader()) project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } task configLiquibase { doLast { liquibase { activities { testdb { changeLogFile <span class="hljs-string"><span class="hljs-string">'changelog.yaml'</span></span> url localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.url'</span></span>] driver localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.driverClass'</span></span>] username localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.username'</span></span>] password localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.password'</span></span>] logLevel <span class="hljs-string"><span class="hljs-string">'debug'</span></span> classpath <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${project.projectDir}</span></span></span><span class="hljs-string">/db"</span></span> contexts <span class="hljs-string"><span class="hljs-string">'main'</span></span> } runList = <span class="hljs-string"><span class="hljs-string">'testdb'</span></span> } } } } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } } project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) } task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } } task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } } configure([processResources, processTestResources]) { Task t -&gt; if (project.ext.isCiBuild()) { t.outputs.upToDateWhen { false } } t.filesMatching('**/*.properties') { filter(ReplaceTokens, tokens: localConfig, beginToken: '${', endToken: '}') } } task restoreAfterRollbackTest(type: LiquibaseTask) { command = 'update' } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = 'rollback' requiresValue = true doFirst { project.ext.liquibaseCommandValue = localConfig['test.rollback.tag'] } doLast { project.ext.liquibaseCommandValue = null } } configure([project]) { tasks.withType(LiquibaseTask.class) { LiquibaseTask t -&gt; logger.info("Liquibase task {} must run after {}", t.getName(), configLiquibase.getName()) (t as Task).dependsOn configLiquibase if (isCiBuild()) { logger.info("Liquibase task {} must run after {}", t.getName(), lockDb.getName()) (t as Task).dependsOn lockDb (t as Task).finalizedBy unlockDb } } //   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">pool.db.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> test.rollback.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> pool.db.driverClass=oracle.jdbc.driver.OracleDriver pool.db.url=jdbc:oracle:thin:@localhost:1527:ORCLCDB pool.db.username=SYSTEM pool.db.password=Oradoc_db1 pool.db.referenceTable=c<span class="hljs-comment"><span class="hljs-comment">##test_user1.REF_TABLE pool.db.baseName=C##CI_SCHEMA_{id} pool.db.basePass=CI_SCHEMA_{id}_PASS app.db.driverClass= app.db.url= app.db.username= app.db.password= test.rollback.tag=version_1</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar452722/">https://habr.com/ru/post/ar452722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar452706/index.html">في عام 1983 ، أصبح هذا الكمبيوتر من Bella Labs أول غراند ماستر.</a></li>
<li><a href="../ar452712/index.html">كيف حاولنا العمل في فريق ، وماذا جاء منه</a></li>
<li><a href="../ar452714/index.html">انتبه # 5: ملخص المقالات حول التفكير المنتج ، علم النفس السلوكي والإنتاجية</a></li>
<li><a href="../ar452716/index.html">في البحث عن نقطة الأمثل لتطبيق الموارد البشرية</a></li>
<li><a href="../ar452718/index.html">PsyGuide: نقص الانتباه. # 0001/1001</a></li>
<li><a href="../ar452724/index.html">Phoenix LiveView: عندما يكون كود جافا سكريبت ممتعًا *</a></li>
<li><a href="../ar452726/index.html">عظام جذابة ثلاثية الأبعاد: مادة عظمية مفرطة المرونة لعيوب الجمجمة البلاستيكية</a></li>
<li><a href="../ar452730/index.html">شهادة نظم المعلومات على مبدأ شرائح القياسية. الخرافات والواقع</a></li>
<li><a href="../ar452734/index.html">ترحيل تطبيقات iOS (ARM) تلقائيًا إلى macOS (x86) باستخدام Bitcode</a></li>
<li><a href="../ar452736/index.html">تشفير الرسائل في SecureDialogues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>