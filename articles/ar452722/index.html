<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ ๐ ๐ก ุชูููู ุตุฏุงูุงุช CI ุ ุงุฎุชุจุงุฑุงุช ูุญุฏุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช ๐ฉ๐ปโโ๏ธ ๐ง๐พ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุงูููุงูุฉ ุญูู ุงุฎุชุจุงุฑ ุงูุชูุงุนู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู CI. ููุฏ ุฑุฃูุช ุงูุนุฏูุฏ ูู ุงูุญููู ุงูุชู ุชุณุชุฎุฏู ุนุงูู ุงูููู ูุงูุญุงูููู ููุงุฎุชุจุงุฑ ุ ููู ูุฏู ุญููู ูุฃุฑูุฏ ูุดุงุฑูุชู. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุชูููู ุตุฏุงูุงุช CI ุ ุงุฎุชุจุงุฑุงุช ูุญุฏุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452722/" style=";text-align:right;direction:rtl"><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/p9/2f/hw/p92fhwlfahzagt8w9wzxpfclgzw.png" alt="ุตูุฑุฉ"></div><br>  ุงูููุงูุฉ ุญูู ุงุฎุชุจุงุฑ ุงูุชูุงุนู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู CI.  ููุฏ ุฑุฃูุช ุงูุนุฏูุฏ ูู ุงูุญููู ุงูุชู ุชุณุชุฎุฏู ุนุงูู ุงูููู ูุงูุญุงูููู ููุงุฎุชุจุงุฑ ุ ููู ูุฏู ุญููู ูุฃุฑูุฏ ูุดุงุฑูุชู. <br><a name="habracut"></a><br>  ุชู ุฑุจุท ูุดุฑูุน ุฌุงูุง ุงููุงุถู ุงูุฎุงุต ุจู ุงุฑุชุจุงุทูุง ูุซูููุง ุจูุงุนุฏุฉ ุจูุงูุงุช.  ูุนุงูุฌุฉ ุทูููุฉ ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุ multithreading ุ ูุฃููุงู ุงูููู.  ุจุงููุณุจุฉ ูููููุฉ ุ ูุงู ูุทููุจูุง ุชุตุญูุญ ุจุถุน ุงุณุชุนูุงูุงุช SQL ุตุนุจุฉ.  ููุช ูุนุชุงุฏูุง ุนูู ุชุบุทูุฉ ุงูููุฏ ุงูุฎุงุต ุจู ูุน ุงูุงุฎุชุจุงุฑุงุช ุ ููู ูุจู ุฐูู ุชู ุชุญููู ูู SQL ุฅูู ุงุณุชุนูุงูุงุช ุจุฏุงุฆูุฉ ููููู ุชุดุบูููุง ุนูู ูุงุนุฏุฉ H2 ูู ุงูุฐุงูุฑุฉ.  ูููุง ุนูู ุงููุชุดุฏุฏูู. <br><br>  ูููููู ุงุฎุชุจุงุฑ ูุบุฉ ุงูุงุณุชุนูุงูุงุช ุงูุจููููุฉ ุงูุจุณูุทุฉ ุจูุฏู ููุทุฑูุฉ ุงูุฌุจุงู ูู ุงูุงุฎุชุจุงุฑุงุช ุงูุฐุงุชูุฉ ุ ูุจุฑุฑูุง ููุณู "ูุณุช ููุนูุง ูู ุงูุจุงุบูุฏู ุ ููุงู ุฃุฎุทุงุก ูู ุงูููุฏ ุงูุจุณูุท."  ูู ุงููุงูุน ุ ุชุธูุฑ ุงูุฃุฎุทุงุก ูู ูุซูุฑ ูู ุงูุฃุญูุงู ุฃูู ุจุณุจุจ ุชูุงูุฑ ุงูุงุฎุชุจุงุฑุงุช.  ูุงู ูู ุงููููู ุฏูุน ุงููุณุคูููุฉ ุฅูู ุงููุฎุชุจุฑูู - ุฅุฐุง ุงุฑุชูุจุช ุฎุทุฃ ูู ููุงู ูุง ุ ูุณูู ูุฌุฏูู ุฐูู. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/js/ro/nh/jsronhgbydvhziosboj6velwb5w.png" alt="ุตูุฑุฉ"></div><br>  ููููุง ูุฅูุฏููููุฌูุฉ ุงุฎุชุจุงุฑ ุงููุญุฏุฉ ุ ูุง ููุฒู ุฅุฌุฑุงุก ุงุฎุชุจุงุฑุงุช ุฅูุง ูุงุฎุชุจุงุฑ ุงููุญุฏุงุช ุงููุฑุฏูุฉ ุ ูุฅุฐุง ูุงูุช ุงููุญุฏุฉ ุชุณุชุฎุฏู ุดูุฆูุง ูู ุงูุฎุงุฑุฌ ุ ููุฌุจ ุงุณุชุจุฏุงูู ุจูุนุจ.  ูู ุงูููุงุฑุณุฉ ุงูุนูููุฉ ุ ุนูุฏูุง ูุตุจุญ ูู ุงูุตุนุจ ููุบุงูุฉ ุชูููุฐ ุฑูุชูู ุ ูุชู ุชุฌุงูู ุงููุญุฏุฉ ุจุจุณุงุทุฉ.  ุชุนุฏ ุงูุณุฑุนุฉ ูุงููุญุฏุงุช ุงูููุทูุฉ ุฃูุฑุงู ูููุงู ุ ููู ูู ุงูููู ุนุฏู ุชุฑู ุงูููุฏ ุจุฏูู ุงุฎุชุจุงุฑ ุ ุญุชู ูู ูู ูุธูุฑ ูู ููุงููุณ ุงูุชุบุทูุฉ.  ูุฐูู ุ ูู ุชุนุฏ ุชุนุชุจุฑ ุงููุญุฏุฉ ุงูููุทูุฉ ูุฆุฉ ูููุตูุฉ ุ ูููู ูุฌููุนุฉ ูุชุตูุฉ ุ ุฌูุจุง ุฅูู ุฌูุจ ูุน ุงูุชูููู.  ุงูุดูุก ุงูุฑุฆูุณู ูู ูุซู ูุฐู ุงูุนุจุงุฑุงุช ูู ุนุฏู ุงููุตูู ุฅูู ููููู ุงููุญุฏุฉ ุงูุชู ุชูุชุฏ ุฅูู ูุณุชูู ุงููุชูุฉ. <br><br>  ููุงุฎุชุจุงุฑ ุงููุญูู ุ ูุฏู ูู ูุทูุฑ ุฎุทุฉ ุฎุงุตุฉ ุจู ุ ูููู ูุชู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุนูู Jenkins ููุง ููุฌุฏ ุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ููุงู ุญุชู ุงูุขู.  ูุญุชุงุฌ CI ุฅูู ุฏุงุฆุฑุฉ ูููุตูุฉ ุ ููุจุฏู ุฃูู ูุงุถุญ.  ููู ุนูู ุงูุฑุณู ุงูุชุฎุทูุทู ุงููุงุฑุบ ุ ููุณ ูู ุงูุตุญูุญ ููุบุงูุฉ ุฅุฌุฑุงุก ุงูุงุฎุชุจุงุฑุงุช ุ ุฅู ุฅูุดุงุก ุจููุฉ ูุงุนุฏุฉ ุจูุงูุงุช ูู ูู ุงุฎุชุจุงุฑ ูุณุชุบุฑู ููุชูุง ุทูููุงู ูููุทูู ุนูู ุชุจุงูู ุจูู ุงููููู ูู ุงูุงุฎุชุจุงุฑ ููู ุงููุนุฑูุฉ.  ุฑูุถ ุนูู ูุงุนุฏุฉ ูุนุฏุฉ ูุณุจููุง - ุฃุญุตู ุนูู ูุฌููุนุฉ ูู ุงููุดููุงุช ูู ุงููุฑูุน.  ููููู ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจู ุชุดุบูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุจุงุณุชุฎุฏุงู ูุงุนุฏุฉ ุจูุงูุงุช ุชุณููู ุ ููุณุญ ูู ุดูุก ุฃููุงู ุฅูู ุงูุตูุฑ ุ ุซู ุงูุชุญุฏูุซ ุฅูู ุฃุญุฏุซ ุฅุตุฏุงุฑ. <br><br>  ุบุงูุจูุง ูุง ูุชู ูุณูุงู ุงูุงุณุชุนุงุฏุฉ ููุฌุจ ุนููู ุชูุธูู ุงูููุงุนุฏ ุจูุฏูู ุนูู ุจูุฆุงุช ุงูุงุฎุชุจุงุฑ.  ุงุฎุชุจุงุฑู ููู!  ุงูุฎูุงุฑุฒููุฉ ูู ููุง ููู: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฅุฒุงูุฉ ูู ุดูุก ุชุญุช ุงูุฌุฐุฑ (ูููุงุก ุงูุชุฌุฑุจุฉ) </li><li style=";text-align:right;direction:rtl">  ุงูุชุญุฏูุซ ุฅูู ุฃุญุฏุซ ุฅุตุฏุงุฑ </li><li style=";text-align:right;direction:rtl">  ุฃุฏุงุก ุงูุชุฑุงุฌุน 1-2 ุงูุฅุตุฏุงุฑุงุช ูุฑุฉ ุฃุฎุฑู </li><li style=";text-align:right;direction:rtl">  ุงูุชุญุฏูุซ ุฅูู ุฃุญุฏุซ ุฅุตุฏุงุฑ (ููุฒู ุฅุฌุฑุงุก ุงูุงุฎุชุจุงุฑุงุช ุนูู ุจููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ุ ุจุงูุฅุถุงูุฉ ุฅูู ุงูุชุญูู ูู ุฃู ุงูุงุณุชุนุงุฏุฉ ูู ุชูุณ ุญุฐู ุฃู ุดูุก ุ ููุง ุณูููุน ุงูุชุญุฏูุซ ูู ุงูุนูุฏุฉ ูุฑุฉ ุฃุฎุฑู) </li></ol><br>  ูุง ูุฑูุฏ ุงููุทูุฑูู ุงูุฒููููู ุชุดุบูู ุงุฎุชุจุงุฑ ุงูุงุณุชุนุงุฏุฉ ุนูุฏ ุจุฏุก ูู ุงุฎุชุจุงุฑ.  ูุญู ุฌุนู ุงูุชุจุฏูู. <br><br><pre style=";text-align:right;direction:rtl"><code class="kotlin hljs">project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre> <br>  ุจูููุง ููุงู ุชุฏุฑูุจ ุนูู ุงููุทุท ุ ูู ุดูุก ุนูู ูุง ูุฑุงู.  ููู ุฃุญุฏ ุงููุดุฑูุนุงุช ุงูุชู ูุชู ุชุทููุฑูุง ุฏููุงูููููุง ูุฌุนู ุงูุชุนุฏููุงุช ุงูุฎุงุตุฉ ุจู - ุนูููุชุงู ููุณุญุจ ุ ุชุฌููุน ูุชุฒุงูู.  ูุซุงู ูุงุญุฏ ูู ุงุฎุชุจุงุฑ ุดูุก ูุง ุ ูุงูุซุงูู ูู ุถุฑุจ ุงููุงุนุฏุฉ ูู ุชุญุช ูุฏูููุง.  ูุชู ุญููุง ุนู ุทุฑูู ูุฑุถ ุญุธุฑ ุจุณูุท ุนูู ุงูุฌูุนูุงุช ุงูููุงุฒูุฉ. <br><br><img src="https://habrastorage.org/webt/my/64/hm/my64hmqfabt8qg0jcuz-xwiddvi.png" alt="ุตูุฑุฉ"><br><br>  ููุฑุฉ ุฃุฎุฑู ุงูุณููุท - ูุฑุฑุช ุฅุฌุฑุงุก ุงุฎุชุจุงุฑุงุช ุจุงุณุชุฎุฏุงู ุญุณุงุจ ุฌูููููุฒ ุ ูุฃูู  ูู ุดูุก ุนูู ูุง ูุฑุงู ุนูู ูุงุญุฏ ุงูุดุฎุตูุฉ ุ ููุฌููุนุฉ ูู ุงูุทูุจุงุช ููุน ูุฃุณุจุงุจ ุบูุฑ ูุงุถุญุฉ.  ูุญู ูุชุฐูุฑ ุงูุญุฏูุซ ุงูุญุงุฏ ุจุฃู DevOps ูู ุซูุงูุฉ ูุฃู ุงุณุชุฎุฏุงู ุงูุญุณุงุจุงุช ุงูุชูููุฉ ูุฃุบุฑุงุถ ุดุฎุตูุฉ ุฃูุฑ ุบูุฑ ููุจูู. <br><br><img src="https://habrastorage.org/webt/fr/lb/xf/frlbxfbj6ck-8pdbhff0v5kpeta.png" alt="ุตูุฑุฉ"><br><br>  ุชุฑุงููุช 10 ูุฌููุนุฉ ูู ุงูุทูุจุงุช.  ุฌููุน ุฌูุนูุง ุ ูุฅุนุงุฏุฉ ุชูุฒูุนูุง ุ ููููู ุฏูุฌ.  ุฃูู ูุงุญุฏ ุฐูุจ ุ ุชุบูุฑ ุงููุฑุน ุงูุฑุฆูุณู - ูุงูุจุงูู ููู ูู ุทุงุจูุฑ ูุฅุนุงุฏุฉ ุงูุจูุงุก.  ููููู ุฏูุฌ ูููุง ุชูุฏูุช ุ ููู ููุงู ุฃููููุงุช.  ุนูููุงุช ุณุญุจ ุฃูุซุฑ ุฅูุญุงุญูุง ุ ุฃูู ุฅูุญุงุญูุง ุ ูุชู ุชุนููููุง ุฃูุถูุง ุจุณุจุจ ุฃุฎุทุงุก ูู ุงูููุฏ.  ุจุดูู ุนุงู ุ ููุงุฒุงุฉ ุงูุธูุฑ. <br><br>  ูุฌุจ ุฃู ูููู ุงูุชุฌููุน ุจุณูุทูุง ุ ููุชุฃูู ูู ุฎุทูุงุช ุจุณูุทุฉ ููููู ูููููุง ุญุชู ุจุงููุณุจุฉ ูุทุงูุจ ุงูุฃูุณ.  ูู 99 ูช ูุง ุชูุฌุฏ ูุดููุฉ ูู ุฃู ุชุฌููุน ุชุฌูุน ุงูุทูุจ ูุงูุฅุตุฏุงุฑ ูุชุณูุณู ูููุณ ูุชูุงุฒููุง.  ุฅุฐุง ูู ุชุชุฑุงูู ุงููุฑุงุฌุนุฉ ุฃูุซุฑ ูู 1-2 ุงูุนูุงูุงุช ุงูุนุงูุฉ ุ ูุฅู ุญุธุฑ ุงูุชุฌููุนุงุช ุงููุชุฒุงููุฉ ูููู ูุงููุงู. <br><br>  ููุฃุบุฑุงุถ ุงูุฅุทูุงู ุงููุชูุงุฒู ุ ูุญุชุงุฌ ุฅูู ููุงุนุฏ ุฃู ูุฎุทุทุงุช ูููู ููู ุงุฎุชุจุงุฑ ุชู ุชุดุบููู ูุตููุงู ุญุตุฑููุง ุฅูููุง. <br><br>  ุงูุฎูุงุฑ ุงูุฃูู ูู ุชุฎุตูุต ุฏููุงูููู.  ุฅูุดุงุก ูุฎุทุท ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุณุฑุนุฉ.  ูุฌูุฏ ุณุญุงุจุฉ ูุน API ุ ููููู ุชุฎุตูุต ูุงุนุฏุฉ ุจูุงูุงุช ููุงู. <br><br>  ุฅุฐุง ูู ุชูุฌุญ ูู ุญุฐู ุญุฐู ููุงุนุฏ ุงูุจูุงูุงุช ุงููุฏููุฉ ุ ููููู ุฅููุงุก ูุณุงุญุฉ ุงููุฑุต ุจุณุฑุนุฉ ุนูุฏูุง ุชุณูุท ุงูุงุฎุชุจุงุฑุงุช ู "ุชูุณ" ูุชุญุฑูุฑ ุงูููุงุฑุฏ.  ุฅูู "ูุชู" ูููุณ "ุฅุฐุง". <br><br>  ุงูุฎูุงุฑ ุงูุซุงูู - ุชุฌูุน ูุงุนุฏุฉ ุจูุงูุงุช / ูุฎุทุท ูุน ุฎุฏูุฉ ุฅุฏุงุฑุฉ ูููุตูุฉ.  ูู ุงูุฎุงุฑุฌ ุ ุชุชูุณู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (API) ูุชุนุทู ุงููุงุนุฏุฉ ููููุช ูุชุณุชุฑุฏ ุงููุงุนุฏุฉ ุงูุญุฑุฉ ูุจู ุงููุตุทูุญ.  ูุง ุณูุนูุฏ: ุฎุงุฏู ูุฎุตุต ูุน ูุงุนุฏุฉ ุจูุงูุงุช ุฃู ูุฌุฑุฏ ูุฎุทุท ููููุง ุ ูุง ููู.  ุงูุดูุก ุงูุฑุฆูุณู ูู ุฃู ุงูููุฑุฏ ูู ุชุถูุน ุฅูู ุงูุฃุจุฏ. <br><br>  ุงูุฎูุงุฑ ุงูุซุงูุซ - ูุฌููุนุฉ ูู ุงูููุงุนุฏ / ุงููุฎุทุทุงุช ููุชูุธูู ุงูุฐุงุชู.  ููุงู ุญุงุฌุฉ ุฅูู ููุฑุฏ ูุชุจุงุฏู ุงููุนูููุงุช ุญูู ุงูุฃููุงู ูุชุฌูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุณูุง. <br><br>  ููุฏ ุงุณุชูุฑุช ุนูู ุงูุฎูุงุฑ ุงูุฃุฎูุฑ ุ ูุฃูู ูู ุงูุฃุณูู ุจุงููุณุจุฉ ูู ุฃู ุฃุฑุจุทู ูููุณ ููุงู ุญุงุฌุฉ ุฅูู ุฏุนูู ุจุดูู ุฎุงุต.  ุงูููุทู ุนูู ุงููุญู ุงูุชุงูู - ูุชู ุฅูุดุงุก ุนุฏุฉ (10 ุฏูุงุฆุฑ ุนูู ุณุจูู ุงููุซุงู) ููุชู ุฅุถุงูุฉ ุฌููุน ุงููุนูููุงุช ุงููุงุฒูุฉ ุญูู ุงูุงุชุตุงู ุจูุง ุฅูู ุงูููุฑุฏ ุงููุดุชุฑู ุ ูู ูุซูู ุงุฎุชุจุงุฑ ูุจู ุงูุจุฏุก ูุฌุนู ุนูุงูุฉ ุงูุจุฏุก ุ ุจุนุฏ ุงูููุงูุฉ - ูุญุฐููุง.  ุฅุฐุง ุชุนุทู ุงูุงุฎุชุจุงุฑ ูุจู ุงูุงูุชูุงุก ุ ูุณูุชู ุงุนุชุจุงุฑ ุงูุฏุงุฆุฑุฉ ูุฌุงููุฉ ูู ููุงูุฉ ุงููููุฉ. <br><br>  ุฅุนุฏุงุฏุงุช ุงููุฑุงุกุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader())</code> </pre><br>  ุงูุนูู ูุน sql ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ูุชุทูุจ ุชุญููู ุงูุณุงุฆู: <br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> configurations { driver } dependencies { driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } }</code> </pre><br>  ุฅุชุตุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) }</code> </pre><br>  ูููู ุฅุฌุฑุงุก ุชุจุงุฏู ุงููุนูููุงุช ูู ุฎูุงู ุฌุฏูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.  ุชููุฆุฉ ุงูุฌุฏูู ุงููุฑุฌุนู (ูุฌุจ ุฃู ูุนูู ูุฑุฉ ูุงุญุฏุฉ ุ ุซู ูุณุชูุฑ ุงูุฌุฏูู ุญุชู ููุงูุฉ ุงูููุช): <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } }</code> </pre><br>  ูููุทูุฑูู ูุฎุทุทุงุช ุฎุงุตุฉ ุจูู ููุชุตุญูุญ ูุงูุชุฌููุน ุ ูุฐูู ูุฌุจ ุฅููุงู ุชุดุบูู ุงุณุชุฎุฏุงู ุงูุชุฌูุน: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre><br>  ุฎุฐ ููุงุนุฏุฉ ูุฌุงููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } }</span></span></code> </pre><br>  ุฅุฐุง ููุช ุจุฅููุงู ุงูุชุฌููุน ูุฑุชูู ุนูู ุงูุชูุงูู ุ ูููู ุชุญุฏูุฏ ุฃูุธูุฉ ูุฎุชููุฉ ูุณุชุธู ููู ูุฎุชููุฉ ุนูุฏ ุชุฌููุน ูููุงุช ุงูุฎุตุงุฆุต.  ุจุงููุณุจุฉ ูุนูููุงุช ุงูุฅุทูุงู ุงููุญููุฉ ุ ุชููู ุงูุฅุนุฏุงุฏุงุช ุซุงุจุชุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> configure([processResources, processTestResources]) { Task t -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (project.ext.isCiBuild()) { t.outputs.upToDateWhen { <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } t.filesMatching(<span class="hljs-string"><span class="hljs-string">'**/*.properties'</span></span>) { filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string"><span class="hljs-string">'${'</span></span>, endToken: <span class="hljs-string"><span class="hljs-string">'}'</span></span>) } }</code> </pre><br>  ููุงู ุงุฎุชุจุงุฑ ุงูุงุณุชุนุงุฏุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> task restoreAfterRollbackTest(type: LiquibaseTask) { command = <span class="hljs-string"><span class="hljs-string">'update'</span></span> } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = <span class="hljs-string"><span class="hljs-string">'rollback'</span></span> requiresValue = <span class="hljs-literal"><span class="hljs-literal">true</span></span> doFirst { project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.tag'</span></span>] } doLast { project.ext.liquibaseCommandValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span> } }</code> </pre><br>  ููู ุจุฅุนุฏุงุฏ ุฃูุฑ ุงูุชูููุฐ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"> configure([project]) { tasks.withType(LiquibaseTask.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>) { LiquibaseTask t -&gt; logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), configLiquibase.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn configLiquibase <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCiBuild()) { logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), lockDb.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn lockDb (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).finalizedBy unlockDb } } <span class="hljs-comment"><span class="hljs-comment">//   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br>  ุชุฎุตูุต ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงุฎุชุจุงุฑ ุงูุงุณุชุนุงุฏุฉ ูููู ูุถุนูุง ุฏุงุฎู ุงูุงุฎุชุจุงุฑุงุช.  ุทุฑู ุชุดุบูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูุจู ูุจุนุฏ ุงูุงูุชูุงุก ูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช: ูู Junit5 ุ ูุฐุง ูู BeforeAllCallback ุ ูู TestNG BeforeSuite. <br><br>  ุจุงููุณุจุฉ ุฅูู ุงูุณุคุงู "ููุงุฐุง ูุฌุจ ุงุฎุชุจุงุฑ sql ุจูุงุณุทุฉ ูุจุฑูุฌ java" ุ ูุฅู ุงูุฅุฌุงุจุฉ ูู ุฃูู ูุฌุจ ุงุฎุชุจุงุฑ ุฃู ููุฏ.  ููุงู ุงุณุชุซูุงุกุงุช ูุจุนุถ ุงูููุฏ ุบูุฑ ููุทูู ููุงุฎุชุจุงุฑ ูู ููุช ูุนูู. <br><br>  ุฃูุฏ ุฃู ุฃุนุฑู ููู ูุชู ุญู ูุดููุฉ ุงุฎุชุจุงุฑ ุงูุชูุงุนู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุงุณุทุฉ ูุจุฑูุฌูู ุขุฎุฑููุ  ูู ูุตูุช ุงูุญุงููุงุช ุฅูู ูู ููุฒู ุ ุฃู ุฃู ุงุฎุชุจุงุฑ ุงูุงูุฏูุงุฌ ููุชูู ุฅูู ุฃูุชุงู ุงููุฎุชุจุฑููุ <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุงุฆูุฉ ูุงููุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonOutput <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonSlurper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.tools.ant.filters.ReplaceTokens <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.liquibase.gradle.LiquibaseTask plugins { id <span class="hljs-string"><span class="hljs-string">'java'</span></span> id <span class="hljs-string"><span class="hljs-string">'org.liquibase.gradle'</span></span> version <span class="hljs-string"><span class="hljs-string">'2.0.1'</span></span> } configurations { driver } repositories { jcenter() mavenCentral() maven { url = <span class="hljs-string"><span class="hljs-string">"http://www.datanucleus.org/downloads/maven2/"</span></span> } } dependencies { implementation <span class="hljs-string"><span class="hljs-string">'com.google.guava:guava:27.0.1-jre'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-core:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-context:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-jdbc:5.1.7.RELEASE'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'junit:junit:4.12'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-test:5.1.7.RELEASE'</span></span> testRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.liquibase:liquibase-core:3.6.1'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.yaml:snakeyaml:1.24'</span></span> driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader()) project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } task configLiquibase { doLast { liquibase { activities { testdb { changeLogFile <span class="hljs-string"><span class="hljs-string">'changelog.yaml'</span></span> url localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.url'</span></span>] driver localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.driverClass'</span></span>] username localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.username'</span></span>] password localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.password'</span></span>] logLevel <span class="hljs-string"><span class="hljs-string">'debug'</span></span> classpath <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${project.projectDir}</span></span></span><span class="hljs-string">/db"</span></span> contexts <span class="hljs-string"><span class="hljs-string">'main'</span></span> } runList = <span class="hljs-string"><span class="hljs-string">'testdb'</span></span> } } } } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } } project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) } task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } } task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } } configure([processResources, processTestResources]) { Task t -&gt; if (project.ext.isCiBuild()) { t.outputs.upToDateWhen { false } } t.filesMatching('**/*.properties') { filter(ReplaceTokens, tokens: localConfig, beginToken: '${', endToken: '}') } } task restoreAfterRollbackTest(type: LiquibaseTask) { command = 'update' } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = 'rollback' requiresValue = true doFirst { project.ext.liquibaseCommandValue = localConfig['test.rollback.tag'] } doLast { project.ext.liquibaseCommandValue = null } } configure([project]) { tasks.withType(LiquibaseTask.class) { LiquibaseTask t -&gt; logger.info("Liquibase task {} must run after {}", t.getName(), configLiquibase.getName()) (t as Task).dependsOn configLiquibase if (isCiBuild()) { logger.info("Liquibase task {} must run after {}", t.getName(), lockDb.getName()) (t as Task).dependsOn lockDb (t as Task).finalizedBy unlockDb } } //   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">pool.db.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> test.rollback.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> pool.db.driverClass=oracle.jdbc.driver.OracleDriver pool.db.url=jdbc:oracle:thin:@localhost:1527:ORCLCDB pool.db.username=SYSTEM pool.db.password=Oradoc_db1 pool.db.referenceTable=c<span class="hljs-comment"><span class="hljs-comment">##test_user1.REF_TABLE pool.db.baseName=C##CI_SCHEMA_{id} pool.db.basePass=CI_SCHEMA_{id}_PASS app.db.driverClass= app.db.url= app.db.username= app.db.password= test.rollback.tag=version_1</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar452722/">https://habr.com/ru/post/ar452722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar452706/index.html">ูู ุนุงู 1983 ุ ุฃุตุจุญ ูุฐุง ุงูููุจููุชุฑ ูู Bella Labs ุฃูู ุบุฑุงูุฏ ูุงุณุชุฑ.</a></li>
<li><a href="../ar452712/index.html">ููู ุญุงูููุง ุงูุนูู ูู ูุฑูู ุ ููุงุฐุง ุฌุงุก ููู</a></li>
<li><a href="../ar452714/index.html">ุงูุชุจู # 5: ููุฎุต ุงูููุงูุงุช ุญูู ุงูุชูููุฑ ุงูููุชุฌ ุ ุนูู ุงูููุณ ุงูุณูููู ูุงูุฅูุชุงุฌูุฉ</a></li>
<li><a href="../ar452716/index.html">ูู ุงูุจุญุซ ุนู ููุทุฉ ุงูุฃูุซู ูุชุทุจูู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</a></li>
<li><a href="../ar452718/index.html">PsyGuide: ููุต ุงูุงูุชุจุงู. # 0001/1001</a></li>
<li><a href="../ar452724/index.html">Phoenix LiveView: ุนูุฏูุง ูููู ููุฏ ุฌุงูุง ุณูุฑูุจุช ููุชุนูุง *</a></li>
<li><a href="../ar452726/index.html">ุนุธุงู ุฌุฐุงุจุฉ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ: ูุงุฏุฉ ุนุธููุฉ ููุฑุทุฉ ุงููุฑููุฉ ูุนููุจ ุงูุฌูุฌูุฉ ุงูุจูุงุณุชูููุฉ</a></li>
<li><a href="../ar452730/index.html">ุดูุงุฏุฉ ูุธู ุงููุนูููุงุช ุนูู ูุจุฏุฃ ุดุฑุงุฆุญ ุงูููุงุณูุฉ. ุงูุฎุฑุงูุงุช ูุงููุงูุน</a></li>
<li><a href="../ar452734/index.html">ุชุฑุญูู ุชุทุจููุงุช iOS (ARM) ุชููุงุฆููุง ุฅูู macOS (x86) ุจุงุณุชุฎุฏุงู Bitcode</a></li>
<li><a href="../ar452736/index.html">ุชุดููุฑ ุงูุฑุณุงุฆู ูู SecureDialogues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>