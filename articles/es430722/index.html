<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöß üê® üóÉÔ∏è Rendimiento de PHP: planificaci√≥n, creaci√≥n de perfiles, optimizaci√≥n üåÇ üë´ üêÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Hace dos a√±os escribimos sobre c√≥mo cambiamos a PHP 7.0 y ahorramos un mill√≥n de d√≥lares. En nuestro perfil de carga, la nueva versi√≥n resu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rendimiento de PHP: planificaci√≥n, creaci√≥n de perfiles, optimizaci√≥n</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/430722/"><img src="https://habrastorage.org/webt/k_/fe/vv/k_fevvrhhn2aruuz19gpne_jypy.jpeg"><br><br>  Hola Habr!  Hace dos a√±os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escribimos</a> sobre c√≥mo cambiamos a PHP 7.0 y ahorramos un mill√≥n de d√≥lares.  En nuestro perfil de carga, la nueva versi√≥n result√≥ ser dos veces m√°s eficiente en el uso de la CPU: la carga que sol√≠amos servir a ~ 600 servidores, despu√©s de que la transici√≥n comenz√≥ a servir a ~ 300.  Como resultado, durante dos a√±os tuvimos una reserva de capacidades. <br><br>  Pero Badoo est√° creciendo.  El n√∫mero de usuarios activos aumenta constantemente.  Estamos mejorando y desarrollando nuestra funcionalidad, gracias a la cual los usuarios pasan cada vez m√°s tiempo en la aplicaci√≥n.  Y esto, a su vez, se refleja en el n√∫mero de solicitudes, que en los √∫ltimos dos a√±os aument√≥ de 2 a 2.5 veces. <br><br>  Nos encontramos en una situaci√≥n en la que una ganancia doble en el rendimiento se estabiliz√≥ por un aumento de m√°s del doble en las solicitudes, y nuevamente comenzamos a acercarnos a los l√≠mites de nuestro grupo.  En el n√∫cleo de PHP, nuevamente se esperan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">optimizaciones</a> √∫tiles (JIT, precarga), pero solo est√°n planificadas para PHP 7.4, y esta versi√≥n se lanzar√° no antes de un a√±o.  Por lo tanto, el truco de transici√≥n no se puede repetir ahora: debe optimizar el c√≥digo de la aplicaci√≥n en s√≠. <br><br>  Debajo del corte, le dir√© c√≥mo abordamos tales tareas, qu√© herramientas usamos y dar√© ejemplos de optimizaciones, ideas y enfoques que aplicamos y que nos ayudaron en nuestro tiempo. <br><a name="habracut"></a><br><h1>  Por qu√© optimizar </h1><br>  La forma m√°s f√°cil y obvia de resolver el problema de rendimiento es agregar hierro.  Si su c√≥digo se ejecuta en el mismo servidor, agregar uno m√°s duplicar√° el rendimiento de su cl√∫ster.  Al transferir estos costos al tiempo de trabajo del desarrollador, nos preguntamos: ¬øpodr√° obtener un doble aumento en la productividad durante este tiempo debido a las optimizaciones?  Tal vez s√≠, pero tal vez no: depende de qu√© tan √≥ptimamente est√© funcionando el sistema y qu√© tan bueno sea el desarrollador.  Por otro lado, el servidor comprado seguir√° siendo propiedad de la empresa y no se devolver√° el tiempo empleado. <br><br>  Resulta que en peque√±os vol√∫menes la soluci√≥n correcta a menudo ser√° la adici√≥n de hierro. <br><br>  Pero toma nuestra situaci√≥n.  Ahora, despu√©s de que la ganancia de cambiar a PHP 7.0 fue compensada por el crecimiento de la actividad y el n√∫mero de usuarios, nuevamente tenemos 600 servidores que atienden solicitudes a la aplicaci√≥n PHP.  Para aumentar la capacidad una vez y media, necesitamos agregar 300 servidores. <br><br>  Tome como c√°lculo el costo promedio de un servidor: $ 4,000.  300 * 4000 = $ 1,200,000: el costo de aumentar la capacidad una vez y media. <br><br>  Es decir, en nuestras condiciones, podemos invertir una cantidad significativa de tiempo de trabajo en la optimizaci√≥n del sistema, y ‚Äã‚Äãseguir√° siendo m√°s rentable que comprar hierro. <br><br><h1>  Planificaci√≥n de la capacidad </h1><br>  Antes de emprender cualquier cosa, es importante entender si hay un problema.  Si ella no est√° all√≠, entonces vale la pena intentar predecir cu√°ndo puede aparecer.  Este proceso se llama planificaci√≥n de la capacidad. <br><br>  Un indicador concreto de la presencia de problemas de rendimiento es el tiempo de respuesta.  De hecho, no importa si la CPU (u otros recursos) se carga al 6% o 146%: si un cliente recibe un servicio de la calidad requerida en un tiempo satisfactorio, entonces todo funciona bien. <br><br>  La desventaja de centrarse en el tiempo de respuesta es que generalmente comienza a aumentar solo cuando el problema ya ha aparecido.  Si a√∫n no es as√≠, es dif√≠cil predecir su aparici√≥n.  Adem√°s, el tiempo de respuesta refleja los resultados de la influencia de todos los factores (servicios de frenado, red, unidades, etc.) y no proporciona una comprensi√≥n de las causas de los problemas. <br><br>  En nuestro caso, la CPU suele ser el cuello de botella, por lo que al planificar el tama√±o y el rendimiento de los cl√∫steres, principalmente prestamos atenci√≥n a las m√©tricas asociadas con su uso.  Recopilamos el uso de CPU de todas nuestras m√°quinas y construimos gr√°ficos con el valor promedio, mediana, percentil 75 y 95: <br><br><img src="https://habrastorage.org/webt/pt/xs/dr/ptxsdr6jybv45cznqjykeqd11_g.png"><br>  <i>Utilizaci√≥n de CPU de m√°quinas de cl√∫ster en porcentaje: promedio, mediana, percentiles</i> <br><br>  Hay cientos de m√°quinas en nuestros cl√∫steres que se han agregado all√≠ durante muchos a√±os.  Son diferentes en configuraci√≥n y rendimiento (el cl√∫ster no es homog√©neo).  Nuestro equilibrador tiene esto en cuenta ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video</a> ) y carga las m√°quinas de acuerdo con sus capacidades.  Para controlar este proceso, tambi√©n tenemos un programa de m√°quinas con carga m√°xima y m√≠nima. <br><br><img src="https://habrastorage.org/webt/nf/we/f7/nfwef7cixau-uxenwsglrnvfzho.png"><br>  <i>Las m√°quinas de cl√∫ster m√°s y menos cargadas</i> <br><br>  Si observa estos gr√°ficos (o solo la salida del comando superior) y ve la carga de la CPU del 50%, pensar√≠a que todav√≠a tenemos un margen para un aumento doble en la carga.  Pero en realidad este no suele ser el caso.  Y aqu√≠ est√° el por qu√©. <br><br><h1>  Hyper threading </h1><br>  Imagine un solo n√∫cleo sin hypertreading.  Lo cargamos con un hilo enlazado a la CPU.  Veremos un 100% de carga en la parte superior. <br><br>  Ahora active hyperreading en este kernel y c√°rguelo exactamente de la misma manera.  En la parte superior, ya veremos dos n√∫cleos l√≥gicos, y la carga total ser√° del 50% (generalmente en un 0% y en el otro 100%). <br><br><img src="https://habrastorage.org/webt/gr/zi/hw/grzihwfkj986zatrfrsrgg4-ykk.png"><br>  <i>Utilizaci√≥n de la CPU: datos principales y lo que realmente sucede</i> <br><br>  Como si el procesador solo estuviera cargado al 50%.  Pero f√≠sicamente no apareci√≥ ning√∫n n√∫cleo libre adicional.  Hypertreading permite <i>en algunos casos</i> ejecutar en un n√∫cleo f√≠sico m√°s de un proceso a la vez.  Pero esto est√° lejos de duplicar el rendimiento en situaciones t√≠picas, aunque en el gr√°fico de uso de la CPU parece la mitad de los recursos: del 50% al 100%. <br><br>  Esto significa que despu√©s del 50% del uso de la CPU cuando se habilita hypertreading, no crecer√° igual que antes. <br><br>  Escrib√≠ este c√≥digo para demostrar (este es un tipo de caso sint√©tico, en realidad los resultados ser√°n diferentes): <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de script</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $concurrency = $_SERVER[<span class="hljs-string"><span class="hljs-string">'argv'</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] ?? <span class="hljs-number"><span class="hljs-number">1</span></span>; $hashes = <span class="hljs-number"><span class="hljs-number">100000000</span></span>; $chunkSize = intval($hashes / $concurrency); $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $children = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $concurrency; $i++) {    $pid = pcntl_fork();    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> === $pid) {        $first = $i * $chunkSize;        $last = ($i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * $chunkSize - <span class="hljs-number"><span class="hljs-number">1</span></span>;        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($j = $first; $j &lt; $last; $j++) {            $dummy = md5($j);        }        printf(<span class="hljs-string"><span class="hljs-string">"[%d]: %d hashes in %0.4f sec\n"</span></span>, $i, $last - $first, microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) - $t1);        <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>;    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {        $children[$pid] = <span class="hljs-number"><span class="hljs-number">1</span></span>;    } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count($children) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {    $pid = pcntl_waitpid(<span class="hljs-number"><span class="hljs-number">-1</span></span>, $status);    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($pid &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {        <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($children[$pid]);    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {        <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-string"><span class="hljs-string">"Got a error pid=$pid"</span></span>);    } }</code> </pre> <br><br></div></div><br>  Tengo dos n√∫cleos f√≠sicos en mi computadora port√°til.  Ejecute este c√≥digo con diferentes datos de entrada para medir su rendimiento con un n√∫mero diferente de procesos paralelos en C. <br><br><div class="spoiler">  <b class="spoiler_title">Resultados de medici√≥n</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/n5/3z/ev/n53zevyyvda4w4u-2xkjryqlj9m.png"><br></div></div><br>  Trazamos los resultados de los lanzamientos: <br><img src="https://habrastorage.org/webt/xg/iv/rn/xgivrnyyynb418fnr5muqfn0qba.png"><br>  <i>Rendimiento del script seg√∫n la cantidad de procesos paralelos</i> <br><br>  A qu√© puedes prestar atenci√≥n: <br><br><ul><li>  C = 1 y C = 2 son predeciblemente iguales para HT = activado y HT = desactivado, el rendimiento se duplica cuando se agrega un n√∫cleo f√≠sico; <br></li></ul><br><ul><li>  en C = 3, las ventajas de HT se hacen evidentes: para HT = activado, pudimos obtener un rendimiento adicional, mientras que para HT = desactivado con C = 3 en adelante, comienza a disminuir previsiblemente lentamente; <br></li></ul><br><ul><li>  en C = 4 vemos todos los beneficios de HT;  pudimos exprimir un 30% adicional de productividad, pero en comparaci√≥n con C = 2 en este momento, el uso de la CPU aument√≥ del 50% al 100%. <br></li></ul><br>  Total, viendo en el 50% superior de la carga de la CPU, al ejecutar este script obtenemos 8.065 Mhash / seg, y al 100% - 10.511 Mhash / seg.  Esto significa que en alrededor del 50% de la parte superior, obtenemos 8.065 / 10.511 ~ 77% del rendimiento m√°ximo del sistema, y ‚Äã‚Äãde hecho nos queda aproximadamente el 100%: 77% = 23%, y no el 50%, como podr√≠a parecer. <br><br>  Este hecho debe ser considerado al planificar. <br><br><img src="https://habrastorage.org/webt/ru/6g/00/ru6g002t0ziv1pkppgqfjber80o.png"><br>  <i>Utilizaci√≥n de CPU para demoscript: datos principales y lo que realmente sucede</i> <br><br><h1>  Inconsistencia de tr√°fico </h1><br>  Adem√°s de hypertreading, la planificaci√≥n tambi√©n complica la irregularidad del tr√°fico dependiendo de la hora del d√≠a, d√≠a de la semana, temporada y otras frecuencias.  Para nosotros, por ejemplo, el pico es el domingo por la noche. <br><br><img src="https://habrastorage.org/webt/eh/ks/58/ehks58pfn7sjva3c869i7cwj7fy.png"><br>  <i>N√∫mero de solicitudes por segundo, pico domingo por la noche</i> <br><br>  No siempre el n√∫mero de solicitudes cambia de manera obvia.  Por ejemplo, los usuarios pueden interactuar de alguna manera con otros usuarios: la actividad de algunos puede generar push / email a otros y, por lo tanto, involucrarlos en el proceso.  A esto se agregan campa√±as promocionales que aumentan el tr√°fico y para las cuales tambi√©n debe estar preparado. <br><br>  Tambi√©n es importante tener en cuenta todo esto al planificar: por ejemplo, construir una tendencia por d√≠as pico y tener en cuenta la posible no linealidad del crecimiento m√°ximo. <br><br><h1>  Herramientas de perfilado y medici√≥n </h1><br>  Supongamos que descubrimos que hay problemas de rendimiento, comprendamos que esta no es la base de datos / servicios / cosas y, sin embargo, decidimos optimizar el c√≥digo.  Para hacer esto, en primer lugar, necesitamos un generador de perfiles o algunas herramientas para encontrar cuellos de botella y luego ver los resultados de nuestras optimizaciones. <br><br>  Desafortunadamente, para PHP hoy no existe una buena herramienta universal. <br><br><h2>  perf </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">perf</a> es una herramienta de creaci√≥n de perfiles integrada en el kernel de Linux.  Es un generador de perfiles de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">muestreo</a> que se inicia mediante un proceso separado, por lo tanto, no agrega directamente una sobrecarga al programa que se perfila.  La sobrecarga a√±adida indirectamente est√° uniformemente "manchada", por lo que no distorsiona las mediciones. <br><br>  Por todas sus ventajas, perf solo puede trabajar con c√≥digo compilado y con JIT y no puede trabajar con c√≥digo que se ejecuta "bajo una m√°quina virtual".  Por lo tanto, el c√≥digo PHP en s√≠ no se puede perfilar en √©l, pero puede ver claramente c√≥mo funciona PHP en su interior, incluidas varias extensiones de PHP, y cu√°ntos recursos se gastan en √©l. <br><br>  Por ejemplo, con perf, encontramos varios cuellos de botella, incluido un lugar de compresi√≥n, que analizar√© a continuaci√≥n. <br><br>  Un ejemplo: <br><br> <code>perf record --call-graph dwarf,65528 -F 99 -p $(pgrep php-cgi | paste -sd "," -) -- sleep 20 <br> perf report</code> <br> <br>  (si el proceso y perf se ejecutan bajo diferentes usuarios, entonces perf debe ejecutarse desde under sudo). <br><br><img src="https://habrastorage.org/webt/k9/vu/k6/k9vuk6sf37xhshipgvx2byw3xps.png"><br>  <i>Ejemplo de salida de informe de rendimiento para PHP-FPM</i> <br><br><h2>  Agregador XHProf y XHProf </h2><br>  XHProf es una extensi√≥n para PHP que coloca temporizadores alrededor de todas las llamadas a funciones / m√©todos, y tambi√©n contiene herramientas para visualizar los resultados as√≠ obtenidos.  A diferencia de perf, le permite operar con t√©rminos de c√≥digo PHP (al mismo tiempo, lo que sucede en las extensiones no es visible). <br><br>  Las desventajas incluyen dos cosas: <br><br><ul><li>  todas las mediciones se recopilan en el marco de una sola solicitud, por lo tanto, no proporcionan informaci√≥n sobre la imagen en su conjunto; <br></li><li>  la sobrecarga, aunque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">no tan grande</a> como, por ejemplo, cuando se usa Xdebug, pero es, y en algunos casos los resultados est√°n muy distorsionados (cuanto m√°s a menudo se llama una funci√≥n y cuanto m√°s simple es, mayor es la distorsi√≥n). <br></li></ul><br>  Aqu√≠ hay un ejemplo que ilustra el √∫ltimo punto: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">child1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">child2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parent1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ child1(); child2(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>; $i++) { parent1(); }</code> </pre> <br><img src="https://habrastorage.org/webt/iw/7m/y6/iw7my6irzq5xg7_soy7sfkqpj7m.png"><br>  <i>Salida XHProf para demos: parent1 es un orden de magnitud mayor que la suma de child1 y child2</i> <br><br>  Se puede ver que parent1 () se ejecut√≥ ~ 500 veces m√°s que child1 () + child2 (), aunque en realidad estos n√∫meros deber√≠an ser aproximadamente iguales, al igual que main () y parent1 (). <br><br>  Si el √∫ltimo inconveniente es dif√≠cil de combatir, entonces para combatir el primero creamos un complemento para XHProf, que agrega los perfiles de diferentes solicitudes y visualiza datos agregados. <br><br>  Adem√°s de XHProf, hay muchos otros perfiladores menos conocidos que trabajan en un principio similar.  Tienen ventajas y desventajas similares. <br><br><h2>  Pinba </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pinba le</a> permite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">monitorear el rendimiento por</a> secuencias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de</a> comandos (acciones) y por temporizadores preestablecidos.  Todas las mediciones en el contexto de los scripts se realizan de forma inmediata; para esto, no se requieren pasos adicionales.  Para cada secuencia de comandos y temporizador, se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">realiza getrusage</a> , por lo que sabemos exactamente cu√°nto tiempo se dedic√≥ al procesador en un fragmento de c√≥digo en particular (a diferencia de los perfiladores de muestreo, donde este tiempo puede resultar en la red, el disco, etc.).  Pinba es ideal para guardar datos hist√≥ricos y obtener una imagen tanto en general como dentro de tipos espec√≠ficos de consultas. <br><br><img src="https://habrastorage.org/webt/od/x5/qr/odx5qryl0ufhceiuyjkytjhtm0c.png"><br>  <i>El rusage general de todos los guiones obtenidos de Pinba</i> <br><br>  Las desventajas incluyen el hecho de que los temporizadores que perfilan secciones espec√≠ficas del c√≥digo, y no los scripts completos, deben organizarse por adelantado en el c√≥digo, as√≠ como la presencia de una sobrecarga que (como en XHProf) puede distorsionar los datos. <br><br><h2>  phpspy </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">phpspy</a> es un proyecto relativamente nuevo (el primer compromiso en GitHub fue hace medio a√±o), que parece prometedor, por lo que lo estamos monitoreando de cerca. <br><br>  Desde el punto de vista del usuario, phpspy es similar a perf: se inicia un proceso paralelo, que copia peri√≥dicamente las partes de la memoria del proceso PHP, las analiza y recibe trazas de la pila y otros datos desde all√≠.  Esto se hace de una manera bastante espec√≠fica.  Para minimizar la sobrecarga, phpspy no detiene el proceso de PHP y copia la memoria directamente mientras se est√° ejecutando.  Esto lleva al hecho de que el generador de perfiles puede tener un estado inconsistente, los rastros de la pila pueden romperse.  Pero phpspy puede detectar esto y descarta dichos datos. <br><br>  En el futuro, utilizando esta herramienta, ser√° posible recopilar tanto datos sobre la imagen como un conjunto y perfiles de tipos espec√≠ficos de consultas. <br><br><h2>  Tabla de comparaci√≥n </h2><br>  Para estructurar las diferencias entre las herramientas, hagamos una tabla din√°mica: <br><br><img src="https://habrastorage.org/webt/bg/1a/bt/bg1abtxk-f8i5q83qm5teok3lbs.png"><br>  <i>Comparaci√≥n de las principales caracter√≠sticas de los perfiladores.</i> <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gr√°ficos de llamas</a></i> <br><br><h1>  Optimizaci√≥n y enfoques </h1><br>  Con estas herramientas, supervisamos constantemente el rendimiento y el uso de nuestros recursos.  Cuando se usan injustificadamente o nos estamos acercando al umbral (para la CPU elegimos emp√≠ricamente un valor del 55% para tener un margen de tiempo en caso de crecimiento), como escrib√≠ anteriormente, una de las soluciones al problema es la optimizaci√≥n. <br><br>  Bueno, si la optimizaci√≥n ya ha sido realizada por otra persona, como fue el caso de PHP 7.0, cuando esta versi√≥n result√≥ ser mucho m√°s productiva que las anteriores.  En general, intentamos utilizar tecnolog√≠as y herramientas modernas, incluidas actualizaciones oportunas de las √∫ltimas versiones de PHP.  Seg√∫n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">los</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">puntos de referencia</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">p√∫blicos</a> , PHP 7.2 es 5-12% m√°s r√°pido que PHP 7.1.  Pero esta transici√≥n, por desgracia, nos dio mucho menos. <br><br>  Durante todo el tiempo hemos implementado una gran cantidad de optimizaciones.  Desafortunadamente, la mayor√≠a de ellos est√°n fuertemente relacionados con nuestra l√≥gica de negocios.  Hablar√© sobre aquellos que pueden ser relevantes no solo para nosotros, o ideas y enfoques que pueden usarse fuera de nuestro c√≥digo. <br><br><h2>  Compresi√≥n Zlib =&gt; zstd </h2><br>  Usamos compresi√≥n para teclas grandes de memkey.  Esto nos permite gastar tres o cuatro veces menos memoria para el almacenamiento debido a los costos adicionales de CPU para la compresi√≥n / descompresi√≥n.  Usamos zlib para esto (nuestra extensi√≥n para trabajar con memekes es diferente de las que vienen con PHP, pero las oficiales <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tambi√©n</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">usan</a> zlib). <br><br>  En perf, la producci√≥n era algo como esto: <br><br> <code>+    4.03%     0.22% php-cgi  libz.so.1.2.11      [.] inflate <br> +    3.38%     0.00% php-cgi  libz.so.1.2.11      [.] deflate</code> <br> <br>  El 7-8% del tiempo se dedic√≥ a la compresi√≥n / descompresi√≥n. <br><br>  Decidimos probar diferentes niveles y algoritmos de compresi√≥n.  Result√≥ que zstd se ejecuta en nuestros datos casi diez veces m√°s r√°pido, perdiendo en su lugar ~ 1.1 veces.  Un cambio bastante simple en el algoritmo nos ahorr√≥ ~ 7.5% de CPU (esto, recuerdo, en nuestros vol√∫menes es equivalente a ~ 45 servidores). <br><br>  Es importante comprender que la proporci√≥n del rendimiento de diferentes algoritmos de compresi√≥n puede variar mucho seg√∫n los datos de entrada.  Existen varias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comparaciones</a> , pero con mayor precisi√≥n, esto solo puede estimarse utilizando ejemplos del mundo real. <br><br><h2>  IS_ARRAY_IMMUTABLE como repositorio de datos raramente modificados </h2><br>  Al trabajar con tareas reales, debe lidiar con los datos que necesita con frecuencia y, al mismo tiempo, rara vez cambia y tiene un tama√±o limitado.  Tenemos muchos datos similares, un buen ejemplo es la configuraci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pruebas divididas</a> .  Verificamos si el usuario se encuentra bajo las condiciones de una prueba en particular y, dependiendo de esto, le mostramos la funcionalidad experimental o normal (esto sucede casi durante cada solicitud).  En otros proyectos, las configuraciones y varios directorios pueden ser un ejemplo: pa√≠ses, ciudades, idiomas, categor√≠as, marcas, etc. <br><br>  Dado que tales datos a menudo se solicitan, su recepci√≥n puede crear una carga adicional notable tanto en la propia aplicaci√≥n como en el servicio en el que se almacenan estos datos.  El √∫ltimo problema se puede resolver, por ejemplo, utilizando APCu, que utiliza la memoria de la misma m√°quina que ejecuta PHP-FPM como almacenamiento.  Pero incluso entonces: <br><br><ul><li>  habr√° costos de serializaci√≥n / deserializaci√≥n; <br></li><li>  necesita de alguna manera invalidar los datos al cambiar; <br></li><li>  Hay algunos gastos generales en comparaci√≥n con acceder solo a una variable en PHP. <br></li></ul><br>  PHP 7.0 presenta la optimizaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">IS_ARRAY_IMMUTABLE</a> .  Si declara una matriz, cuyos elementos se conocen en el momento de la compilaci√≥n, se procesar√° y se colocar√° en la memoria OPCache una vez, los trabajadores de PHP-FPM se referir√°n a esta memoria compartida sin perder el tiempo antes de intentar cambiar.  Tambi√©n se deduce que la inclusi√≥n de dicha matriz tomar√° un tiempo constante independientemente del tama√±o (generalmente ~ 1 microsegundo). <br><br>  A modo de comparaci√≥n: un ejemplo del tiempo para obtener una matriz de 10,000 elementos a trav√©s de include y apcu_fetch: <br><br><pre> <code class="php hljs">$t0 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $a = <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'test-incl-1.php'</span></span>; $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); printf(<span class="hljs-string"><span class="hljs-string">"include (%d): %d microsec\n"</span></span>, count($a), ($t1-$t0) * <span class="hljs-number"><span class="hljs-number">1e6</span></span>); $t0 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $a = apcu_fetch(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); printf(<span class="hljs-string"><span class="hljs-string">"apcu_fetch (%d): %d microsec\n"</span></span>, count($a), ($t1-$t0) * <span class="hljs-number"><span class="hljs-number">1e6</span></span>); <span class="hljs-comment"><span class="hljs-comment">//include (10000): 1 microsec //apcu_fetch (10000): 792 microsec</span></span></code> </pre><br>  Verificar si esta optimizaci√≥n se ha aplicado puede ser muy simple si observa los c√≥digos de operaci√≥n generados: <br><br><pre> <code class="php hljs">$ cat immutable.php <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'key1'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val1'</span></span>, <span class="hljs-string"><span class="hljs-string">'key2'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val2'</span></span>, <span class="hljs-string"><span class="hljs-string">'key3'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val3'</span></span>, ]; $ cat mutable.php <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'key1'</span></span> =&gt; \SomeClass::CONST_1, <span class="hljs-string"><span class="hljs-string">'key2'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val2'</span></span>, <span class="hljs-string"><span class="hljs-string">'key3'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val3'</span></span>, ]; $ php -d opcache.enable=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.enable_cli=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.opt_debug_level=<span class="hljs-number"><span class="hljs-number">0x20000</span></span> immutable.php $_main: ; (lines=<span class="hljs-number"><span class="hljs-number">1</span></span>, args=<span class="hljs-number"><span class="hljs-number">0</span></span>, vars=<span class="hljs-number"><span class="hljs-number">0</span></span>, tmps=<span class="hljs-number"><span class="hljs-number">0</span></span>) ; (after optimizer) ; /home/ubuntu/immutable.php:<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> L0 (<span class="hljs-number"><span class="hljs-number">4</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(...) $ php -d opcache.enable_cli=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.opt_debug_level=<span class="hljs-number"><span class="hljs-number">0x20000</span></span> mutable.php $_main: ; (lines=<span class="hljs-number"><span class="hljs-number">5</span></span>, args=<span class="hljs-number"><span class="hljs-number">0</span></span>, vars=<span class="hljs-number"><span class="hljs-number">0</span></span>, tmps=<span class="hljs-number"><span class="hljs-number">2</span></span>) ; (after optimizer) ; /home/ubuntu/mutable.php:<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> L0 (<span class="hljs-number"><span class="hljs-number">4</span></span>): T1 = FETCH_CLASS_CONSTANT string(<span class="hljs-string"><span class="hljs-string">"SomeClass"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"CONST_1"</span></span>) L1 (<span class="hljs-number"><span class="hljs-number">4</span></span>): T0 = INIT_ARRAY <span class="hljs-number"><span class="hljs-number">3</span></span> T1 string(<span class="hljs-string"><span class="hljs-string">"key1"</span></span>) L2 (<span class="hljs-number"><span class="hljs-number">5</span></span>): T0 = ADD_ARRAY_ELEMENT string(<span class="hljs-string"><span class="hljs-string">"val2"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"key2"</span></span>) L3 (<span class="hljs-number"><span class="hljs-number">6</span></span>): T0 = ADD_ARRAY_ELEMENT string(<span class="hljs-string"><span class="hljs-string">"val3"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"key3"</span></span>) L4 (<span class="hljs-number"><span class="hljs-number">6</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> T0</code> </pre><br>  En el primer caso, se puede ver que solo hay un c√≥digo de operaci√≥n en el archivo: el retorno de la matriz terminada.  En el segundo caso, su formaci√≥n elemento por elemento ocurre cada vez que se ejecuta este archivo. <br><br>  Por lo tanto, es posible generar estructuras en una forma que no requiera una mayor transformaci√≥n en tiempo de ejecuci√≥n.  Por ejemplo, en lugar de desarmar los nombres de las clases con los signos "_" y "\" cada vez para la carga autom√°tica, puede generar previamente el mapa de correspondencia "Clase =&gt; Ruta".  En este caso, la funci√≥n de conversi√≥n se reducir√° a una sola llamada de tabla hash.  Composer realiza este tipo de optimizaci√≥n si habilita la <a href="">opci√≥n de optimizaci√≥n del cargador autom√°tico</a> . <br><br>  Para la invalidaci√≥n de dichos datos, no necesita hacer nada espec√≠ficamente: PHP mismo recompilar√° el archivo al cambiar, tal como lo har√≠a con una implementaci√≥n de c√≥digo normal.  El √∫nico inconveniente que no debe olvidar: si el archivo es muy grande, la primera solicitud despu√©s de cambiarlo provocar√° una recompilaci√≥n, lo que puede llevar un tiempo tangible. <br><br><h2>  El rendimiento incluye / requiere </h2><br>  A diferencia del ejemplo de matriz est√°tica, adjuntar archivos con declaraciones de clase y funci√≥n no es tan r√°pido.  A pesar de la presencia de OPCache, el motor PHP debe copiarlos en la memoria del proceso, conectando las dependencias de forma recursiva, que al final puede tomar cientos de microsegundos o incluso milisegundos por archivo. <br><br>  Si crea un nuevo proyecto vac√≠o en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Symfony 4.1</a> y coloca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">get_included_files () como la</a> primera l√≠nea de la acci√≥n, puede ver que 310 archivos ya est√°n conectados.  En un proyecto real, este n√∫mero puede llegar a miles por solicitud.  Vale la pena prestar atenci√≥n a las siguientes cosas. <br><br>  <b>Falta de caracter√≠sticas de carga autom√°tica</b> <br><br>  Existe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RFC de carga autom√°tica de funciones</a> , pero no se ha visto ning√∫n desarrollo durante varios a√±os.  Por lo tanto, si una dependencia en Composer define funciones fuera de la clase y estas funciones deben ser accesibles para el usuario, esto se hace <a href="">conectando obligatoriamente un</a> archivo con estas funciones a cada inicializaci√≥n del cargador autom√°tico. <br><br>  Por ejemplo, eliminando una de las dependencias de composer.json, que declara muchas funciones y se reemplaza f√°cilmente por cien l√≠neas de c√≥digo, ganamos un par por ciento de la CPU. <br><br>  <b>El cargador autom√°tico se llama con m√°s frecuencia de lo que parece.</b> <br><br>  Para demostrar la idea, cree dicho archivo con una clase: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">C</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">D</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AC1 = \E::E1;   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AC2 = \F::F1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $as3 = \G::G1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $as4 = \H::H1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a5 = \I::I1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a6 = \J::J1;   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\K $k = null)</span></span></span><span class="hljs-function"> </span></span>{}   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asf1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\L $l = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asf2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\M $m = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">af3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\N $n = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">af4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\P $p = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br>  <b>Registrar cargador autom√°tico:</b> <br><br><pre> <code class="php hljs">spl_autoload_register(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Including $name...\n"</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">"$name.php"</span></span>; });</code> </pre> <br>  <b>Y haremos varios casos de uso para esta clase:</b> <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'A.php'</span></span> Including B... Including D... Including C... \A::AC1 Including A... Including B... Including D... Including C... Including E... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A() Including A... Including B... Including D... Including C... Including E... Including F... Including G... Including H... Including I... Including J...</code> </pre><br>  Puede notar que cuando de alguna manera conectamos la clase, pero no creamos su instancia, se conectar√°n los padres, las interfaces y los rasgos.  Esto se hace de forma recursiva para todos los archivos conectados como resuelve. <br><br>  Al crear una instancia, se agrega la resoluci√≥n de todas las constantes y campos, lo que conduce a la conexi√≥n de todos los archivos necesarios para esto, lo que, a su vez, tambi√©n causar√° una conexi√≥n recursiva de rasgos, padres e interfaces de las clases reci√©n conectadas. <br><br><img src="https://habrastorage.org/webt/8a/qq/2t/8aqq2tf_8j-mixi8p_ydoypo-yo.png"><br>  <i>Conexi√≥n de clases relacionadas para el proceso de creaci√≥n de instancias y otros casos</i> <br><br>  No existe una soluci√≥n universal para este problema, solo debe tenerlo en cuenta y controlar las conexiones entre clases: una l√≠nea puede extraer la conexi√≥n de cientos de archivos. <br><br>  <b>Configuraci√≥n de OPCache</b> <br><br>  Si utiliza el m√©todo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">implementaci√≥n at√≥mica cambiando el enlace simb√≥lico</a> propuesto por Rasmus Lerdorf, el creador de PHP, para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">resolver el</a> problema de "pegar" el enlace simb√≥lico en la versi√≥n anterior, debe incluir opcache.revalidate_path, como se recomienda, por ejemplo, en este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> sobre OPCache traducido por correo .Ru Grupo. <br><br>  El problema es que esta opci√≥n significativamente (en promedio, una vez y media o dos veces) aumenta el tiempo para incluir cada archivo.  En total, esto puede consumir una cantidad significativa de recursos (en nuestro caso, deshabilitar esta opci√≥n dio una ganancia de 7 a 9%). <br><br>  Para deshabilitarlo, debe hacer dos cosas: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hacer que el</a> servidor web resuelva enlaces simb√≥licos; <br></li><li>  deje de conectar archivos dentro del script PHP a lo largo de las rutas que contienen enlaces simb√≥licos, o forzarlos a trav√©s de readlink () o realpath (). <br></li></ul><br>  Si todos los archivos est√°n conectados con el cargador autom√°tico de Composer, el segundo elemento se ejecutar√° autom√°ticamente despu√©s de que se complete el primero: omposer utiliza la constante __DIR__, que se resolver√° correctamente. <br><br>  OPCache tiene algunas opciones m√°s que pueden aumentar el rendimiento a cambio de flexibilidad.  Puede leer m√°s sobre esto en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> que mencion√© anteriormente. <br><br>  A pesar de todas estas optimizaciones, incluir a√∫n no ser√° gratuito.  Para combatir esto, PHP 7.4 planea agregar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">precarga</a> . <br><br><h2>  APCu Lock </h2><br>  Aunque no estamos hablando de bases de datos y servicios aqu√≠, tambi√©n pueden ocurrir varios tipos de bloqueos en el c√≥digo, lo que aumenta el tiempo de ejecuci√≥n del script. <br><br>  A medida que crecieron las solicitudes, notamos una fuerte desaceleraci√≥n en respuesta en las horas pico.  Despu√©s de descubrir las razones, result√≥ que aunque APCu es la forma m√°s r√°pida de obtener datos (en comparaci√≥n con Memcache, Redis y otro almacenamiento externo), tambi√©n puede funcionar lentamente con la sobrescritura frecuente de las mismas claves. <br><br><img src="https://habrastorage.org/webt/hs/05/gc/hs05gcwvqozrqews1ewwtsskdyo.png"><br>  <i>N√∫mero de solicitudes por segundo y tiempo de ejecuci√≥n: picos el 16 y 17 de octubre</i> <br><br>  Cuando se usa APCu como cach√©, este problema no es tan relevante, ya que el almacenamiento en cach√© generalmente implica escritura rara y lectura frecuente.  Pero algunas tareas y algoritmos (por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Circuit Breaker</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">implementaci√≥n en PHP</a> )) tambi√©n implican grabaciones frecuentes, lo que provoca bloqueos. <br><br>  No existe una soluci√≥n universal para este problema, pero en el caso de Circuit Breaker se puede resolver, por ejemplo, poni√©ndolo en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servicio separado</a> instalado en m√°quinas con PHP. <br><br><h2>  Procesamiento por lotes </h2><br>  Incluso si no tiene en cuenta la inclusi√≥n, por lo general, una parte significativa del tiempo de ejecuci√≥n de la consulta todav√≠a se dedica a la inicializaci√≥n: un marco (por ejemplo, construir un contenedor DI e inicializar todas sus dependencias, enrutar, ejecutar a todos los oyentes), elevar la sesi√≥n, Usuario, etc. m√°s lejos <br><br>  Si su backend es una API interna para algo, entonces algunas solicitudes de clientes pueden agruparse y enviarse como una sola solicitud.  En este caso, la inicializaci√≥n se realizar√° una vez para varias solicitudes. <br><br>      ,   ,    .    -  ,          .       . <br><br><h2>    </h2><br>    Badoo   ,     .    PHP-FPM,      CPU,   ,            ,    :        IO, CPU  . <br><br>      PHP-FPM    ‚Äî  ,          PHP. <br><br>         (CPU, IO),    . , ,       ,  ,    -     ,        .        ,     .   ,  ,      . <br><br><h1>  Conclusi√≥n </h1><br>        .                    PHP     . <br><br>  : <br><br><ul><li>       ; <br></li><li>     ; <br></li><li>  -  ,  :  ,    ; <br></li><li>   :       (, ,  ); <br></li><li>    :     ; <br></li><li>   , OPCache    PHP,  , ,   ; <br></li><li>    :       (, ,   PHP 7.2   ,   ); <br></li><li>    : ,        . <br></li></ul><br>       ? <br><br>  Gracias por su atencion! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430722/">https://habr.com/ru/post/es430722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430710/index.html">Qu√© hacer si Black Friday es ma√±ana y sus servidores no est√°n listos</a></li>
<li><a href="../es430712/index.html">NeurIPS: C√≥mo conquistar la mejor conferencia de ML</a></li>
<li><a href="../es430714/index.html">VMware compra Heptio: ¬øqu√© significa para Kubernetes?</a></li>
<li><a href="../es430718/index.html">¬øPara qu√© objetos vale la pena usar la videovigilancia en la nube?</a></li>
<li><a href="../es430720/index.html">Intel RealSense D435i: peque√±a actualizaci√≥n y breve digresi√≥n hist√≥rica</a></li>
<li><a href="../es430724/index.html">DEFCON 21. La conferencia DNS puede ser peligrosa para su salud. Parte 1</a></li>
<li><a href="../es430728/index.html">Ens√©√±ame a dar retroalimentaci√≥n</a></li>
<li><a href="../es430730/index.html">Qu√© hace R&D ABBYY: Grupo de Investigaci√≥n Avanzada de PNL</a></li>
<li><a href="../es430732/index.html">A la cuesti√≥n de divisi√≥n y TI</a></li>
<li><a href="../es430734/index.html">Actualizaciones inteligentes vs contratos inteligentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>