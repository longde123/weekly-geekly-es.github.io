<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ฅ โ๐พ ๐๐ผ ูุชุงุจุฉ ููุงุฒู ุจุณูุท ุนูู ุงูุฐูุงุจ ๐๐พ ๐ค ๐๐ผ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุชูุนุจ ููุงุฒูุงุช ุงูุชุญููู ุฏูุฑูุง ุฑุฆูุณููุง ูู ููุฏุณุฉ ุงูููุจ. ุฅููุง ุชุณูุญ ูู ุจุชูุฒูุน ุงูุญูู ุนุจุฑ ุนุฏุฉ ูุงุฌูุงุช ุฎูููุฉ ุ ูุจุงูุชุงูู ุชุญุณูู ูุงุจููุฉ ุงูุชูุณุน. ููุธุฑูุง ูุชูููู ุงูุนุฏูุฏ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ูุชุงุจุฉ ููุงุฒู ุจุณูุท ุนูู ุงูุฐูุงุจ</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/476276/" style=";text-align:right;direction:rtl"><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/t8/nm/ze/t8nmzevaswfyxtitu7xpx3ml-ho.jpeg"></div><br>  ุชูุนุจ ููุงุฒูุงุช ุงูุชุญููู ุฏูุฑูุง ุฑุฆูุณููุง ูู ููุฏุณุฉ ุงูููุจ.  ุฅููุง ุชุณูุญ ูู ุจุชูุฒูุน ุงูุญูู ุนุจุฑ ุนุฏุฉ ูุงุฌูุงุช ุฎูููุฉ ุ ูุจุงูุชุงูู ุชุญุณูู ูุงุจููุฉ ุงูุชูุณุน.  ููุธุฑูุง ูุชูููู ุงูุนุฏูุฏ ูู ุงููุงุฌูุฉ ุงูุฎูููุฉ ุ ุชุตุจุญ ุงูุฎุฏูุฉ ูุชุงุญุฉ ููุบุงูุฉ ุ ูุฃูู ูู ุญุงูุฉ ุญุฏูุซ ุนุทู ูู ุฃุญุฏ ุงูุฎูุงุฏู ุ ูููู ููููุงุฒู ุงุฎุชูุงุฑ ุฎุงุฏู ุนูู ุขุฎุฑ. <br><br>  ุจุนุฏ ุฃู ูุนุจุช ูุน ููุงุฒูุงุช ุงุญุชุฑุงููุฉ ูุซู NGINX ุ ุญุงููุช ุฅูุดุงุก ููุงุฒู ุจุณูุท ูููุชุนุฉ.  ููุฏ ูุชุจุช ุนูู Go ุ ุฅููุง ูุบุฉ ุญุฏูุซุฉ ุชุฏุนู ุงูุชูุงุฒู ุงููุงูู.  ุชุญุชูู ุงูููุชุจุฉ ุงูููุงุณูุฉ ูู Go ุนูู ุงูุนุฏูุฏ ูู ุงูููุฒุงุช ูุชุชูุญ ูู ูุชุงุจุฉ ุชุทุจููุงุช ุนุงููุฉ ุงูุฃุฏุงุก ุจุฑูุฒ ุฃูู.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุณูููุฉ ุงูุชูุฒูุน ุ ูุฅูู ูููุฏ ุซูุงุฆูุฉ ูุงุญุฏุฉ ูุฑุชุจุทุฉ ุจุดูู ุซุงุจุช. <br><a name="habracut"></a><br><h2 style=";text-align:right;direction:rtl">  ููู ูุนูู ููุงุฒููุง </h2><br>  ูุชู ุงุณุชุฎุฏุงู ุฎูุงุฑุฒููุงุช ูุฎุชููุฉ ูุชูุฒูุน ุงูุญูู ุจูู ุงูุฃุณุทุญ ุงูุฎูููุฉ.  ุนูู ุณุจูู ุงููุซุงู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Round Robin - ูุชู ุชูุฒูุน ุงูุญูู ุจุงูุชุณุงูู ุ ูุน ูุฑุงุนุงุฉ ููุณ ุงูููุฉ ุงูุญุงุณูุจูุฉ ููุฎูุงุฏู. </li><li style=";text-align:right;direction:rtl">  ูุฑุฌุญ ุฌููุฉ ุฑูุจู - ุงุนุชูุงุฏุง ุนูู ููุฉ ุงููุนุงูุฌุฉ ุ ูููู ุชุนููู ุฎูุงุฏู ุฃูุฒุงู ูุฎุชููุฉ. </li><li style=";text-align:right;direction:rtl">  ุงูุงุชุตุงูุงุช ุงูุฃูู - ูุชู ุชูุฒูุน ุงูุญูู ุนุจุฑ ุงูุฎูุงุฏู ุงูุชู ุชุญุชูู ุนูู ุฃูู ุนุฏุฏ ูู ุงูุงุชุตุงูุงุช ุงููุดุทุฉ. </li></ul><br>  ูู ููุงุฒููุง ุ ูููุฐ ุฃุจุณุท ุงูุฎูุงุฑุฒููุงุช - Round Robin. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/b3e/35c/751/b3e35c7510dc44451088756d14739161.png"></div><br><br><h2 style=";text-align:right;direction:rtl">  ุงุฎุชูุงุฑ ูู ุฌููุฉ ุฑูุจู </h2><br>  ุฎูุงุฑุฒููุฉ Round Robin ุจุณูุทุฉ.  ุฅูู ูุนุทู ุฌููุน ููุงูู ุงูุฃุฏุงุก ููุณ ุงููุฑุตุฉ ูุฅููุงู ุงูููุงู. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/3b3/4a7/861/3b34a78610b7c1e2d22b85f0419700d2.png"></div><br>  <i>ุญุฏุฏ ุงูุฎูุงุฏู ูู Round Robin ููุนุงูุฌุฉ ุงูุทูุจุงุช ุงููุงุฑุฏุฉ.</i> <br><br>  ููุง ูู ููุถุญ ูู ุงูุฑุณู ุงูุชูุถูุญู ุ ุชุญุฏุฏ ุงูุฎูุงุฑุฒููุฉ ุงูุฎูุงุฏู ูู ุฏุงุฆุฑุฉ ุจุดูู ุฏูุฑู.  ููู ูุง ูููููุง ุงุฎุชูุงุฑูู <i>ูุจุงุดุฑุฉ</i> ุ ุฃููุณ ูุฐููุ <br><br>  ูุฅุฐุง ูุงู ุงูุฎุงุฏู ููุฐุจุ  ุฑุจูุง ูุง ูุญุชุงุฌ ุฅูู ุฅุฑุณุงู ุญุฑูุฉ ูุฑูุฑ ุฅููู.  ููุฐุง ูุนูู ุฃูู ูุง ูููู ุงุณุชุฎุฏุงู ุงูุฎุงุฏู ูุจุงุดุฑุฉ ุญุชู ูุตู ุฅูู ุงูุญุงูุฉ ุงููุทููุจุฉ.  ูู ุงูุถุฑูุฑู ุชูุฌูู ุญุฑูุฉ ุงููุฑูุฑ ููุท ุฅูู ุงูุฎูุงุฏู ุงูุชู ูุชู ุชุดุบูููุง ูุชุดุบูููุง. <br><br><h2 style=";text-align:right;direction:rtl">  ุชุญุฏูุฏ ุงููููู </h2><br>  ูุญู ุจุญุงุฌุฉ ุฅูู ุชุชุจุน ุฌููุน ุงูุชูุงุตูู ุงููุชุนููุฉ ุงูุฎูููุฉ.  ุชุญุชุงุฌ ุฅูู ูุนุฑูุฉ ูุง ุฅุฐุง ูุงู ุนูู ููุฏ ุงูุญูุงุฉ ุ ูุชุชุจุน ุนููุงู URL.  ููููุงู ุจุฐูู ุ ูููููุง ุชุญุฏูุฏ ุงููููู ุงูุชุงูู: <br><br><pre style=";text-align:right;direction:rtl"><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Backend <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { URL *url.URL Alive <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> mux sync.RWMutex ReverseProxy *httputil.ReverseProxy }</code> </pre> <br>  ูุง ุชููู ุ ุณุฃุดุฑุญ ูุนูู ุงูุญููู ูู ุงูุฎูููุฉ. <br><br>  ุงูุขู ูู ุงูููุงุฒู ุ ุชุญุชุงุฌ ุฅูู ุชุชุจุน ูู ุงููุคุซุฑุงุช ุงูุฎูููุฉ ุจุทุฑููุฉ ุฃู ุจุฃุฎุฑู.  ููููุงู ุจุฐูู ุ ููููู ุงุณุชุฎุฏุงู Slice ูุนุฏุงุฏ ูุชุบูุฑ.  ุญุฏุฏูุง ูู ServerPool: <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ServerPool <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { backends []*Backend current <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span> }</code> </pre> <br><h2 style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ReverseProxy </h2><br>  ููุง ุญุฏุฏูุง ุจุงููุนู ุ ูุฅู ุฌููุฑ ุงูููุงุฒู ูู ุชูุฒูุน ุญุฑูุฉ ุงููุฑูุฑ ุนูู ุฎูุงุฏู ูุฎุชููุฉ ูุฅุนุงุฏุฉ ุงููุชุงุฆุฌ ุฅูู ุงูุนููู.  ููุง ุชููู ูุซุงุฆู Go: <br><br>  <i>ReverseProxy ูู ูุนุงูุฌ HTTP ูุฃุฎุฐ ุงูุทูุจุงุช ุงููุงุฑุฏุฉ ููุฑุณููุง ุฅูู ุฎุงุฏู ุขุฎุฑ ุ ููุนูุฏ ุงูุฅุฌุงุจุงุช ุฅูู ุงูุนููู.</i> <br><br>  ุจุงูุถุจุท ูุง ูุญุชุงุฌู.  ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุงุฎุชุฑุงุน ุงูุนุฌูุฉ.  ููููู ุจุจุณุงุทุฉ ุฏูู ุทูุจุงุชูุง ูู ุฎูุงู <code>ReverseProxy</code> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs">u, _ := url.Parse(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080"</span></span>) rp := httputil.NewSingleHostReverseProxy(u) <span class="hljs-comment"><span class="hljs-comment">// initialize your server and add this as handler http.HandlerFunc(rp.ServeHTTP)</span></span></code> </pre> <br>  ุจุงุณุชุฎุฏุงู <code>httputil.NewSingleHostReverseProxy(url)</code> ููููู ุชููุฆุฉ <code>ReverseProxy</code> ุ ูุงูุฐู ุณูุจุซ ุงูุทูุจุงุช ุฅูู <code>url</code> ุชู ุชูุฑูุฑู.  ูู ุงููุซุงู ุฃุนูุงู ุ ุชู ุฅุฑุณุงู ุฌููุน ุงูุทูุจุงุช ุฅูู ุงููุถูู ุงููุญูู: 8080 ุ ูุชู ุฅุฑุณุงู ุงููุชุงุฆุฌ ุฅูู ุงูุนููู. <br><br>  ุฅุฐุง ูุธุฑุช ุฅูู ุชูููุน ุฃุณููุจ ServeHTTP ุ ูููููู ุงูุนุซูุฑ ุนูู ุชูููุน ูุนุงูุฌ HTTP ููู.  ูุฐูู ุ ููููู ุชูุฑูุฑู ุฅูู <code>HandlerFunc</code> ูู <code>http</code> . <br><br>  ุฃูุซูุฉ ุฃุฎุฑู ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://golang.org/pkg/net/http/">ุงููุซุงุฆู</a> . <br><br>  ุจุงููุณุจุฉ ุฅูู <code>ReverseProxy</code> ุ ููููู ุจุฏุก <code>ReverseProxy</code> <code>URL</code> ุงููุฑุชุจุท ูู <code>Backend</code> ุจุญูุซ ูููู ReverseProxy ุจุชูุฌูู ุงูุทูุจุงุช ุฅูู <code>URL</code> . <br><br><h2 style=";text-align:right;direction:rtl">  ุนูููุฉ ุงุฎุชูุงุฑ ุงูุฎุงุฏู </h2><br>  ุฃุซูุงุก ุงุฎุชูุงุฑ ุงูุฎุงุฏู ุงูุชุงูู ุ ูุญุชุงุฌ ุฅูู ุชุฎุทู ุงูุฎูุงุฏู ุงูุฃุณุงุณูุฉ.  ูููู ุชุญุชุงุฌ ุฅูู ุชูุธูู ุงูุนุฏ. <br><br>  ุณูุชุตู ุงูุนุฏูุฏ ูู ุงูุนููุงุก ุจุงูููุงุฒู ุ ูุนูุฏูุง ูุทูุจ ูู ูููู ุงูุนูุฏุฉ ุงูุชุงููุฉ ูููู ุญุฑูุฉ ุงููุฑูุฑ ุ ูุฏ ุชุญุฏุซ ุญุงูุฉ ุณุจุงู.  ูููุน ูุฐุง ุ ูููููุง ุญุธุฑ <code>ServerPool</code> ูุน <code>mutex</code> .  ูููู ุณูููู ูุฐุง <code>ServerPool</code> ุ ุฅูู ุฌุงูุจ ุฃููุง ูุง ูุฑูุฏ ุญุธุฑ <code>ServerPool</code> .  ูุญู ููุท ุจุญุงุฌุฉ ุฅูู ุฒูุงุฏุฉ ุงูุนุฏุงุฏ ูู ุฌุงูุจ ูุงุญุฏ. <br><br>  ุฃูุถู ุญู ูุชูุจูุฉ ูุฐู ุงููุชุทูุจุงุช ูู ุงูุฒูุงุฏุฉ ุงูุฐุฑูุฉ.  Go ูุฏุนููุง ูุน ุงูุญุฒูุฉ <code>atomic</code> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *ServerPool)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NextIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(atomic.AddUint64(&amp;s.current, <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) % <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(s.backends))) }</code> </pre> <br>  ูุญู ูุฒูุฏ ุงููููุฉ ุงูุญุงููุฉ ุจููุฏุงุฑ ูุงุญุฏ ููุนูุฏ ุงูููุฑุณ ุนู ุทุฑูู ุชุบููุฑ ุทูู ุงููุตูููุฉ.  ูุฐุง ูุนูู ุฃู ุงููููุฉ ูุฌุจ ุฃู ุชููู ุฏุงุฆููุง ูู ุงููุทุงู ูู 0 ุฅูู ุทูู ุงููุตูููุฉ.  ูู ุงูููุงูุฉ ุ ุณููุชู ุจูุคุดุฑ ูุญุฏุฏ ุ ูููุณ ุงูุนุฏุงุฏ ุจุฃูููู. <br><br><h2 style=";text-align:right;direction:rtl">  ุงุฎุชูุงุฑ ุฎุงุฏู ุงูุญูุฉ </h2><br>  ูุญู ูุนูู ุจุงููุนู ุฃู ุทูุจุงุชูุง ูุชู ุชุฏููุฑูุง ุฏูุฑููุง ุนุจุฑ ุฌููุน ุงูุฎูุงุฏู.  ููุญู ุจุญุงุฌุฉ ููุท ูุชุฎุทู ุงูุฎููู. <br><br>  ุฅุฑุฌุงุน <code>GetNext()</code> ุฏุงุฆููุง ูููุฉ ุชุชุฑุงูุญ ูู 0 ุฅูู ุทูู ุงูุตููู.  ูู ุฃู ููุช ุ ูููููุง ุงูุญุตูู ุนูู ุงูุนูุฏุฉ ุงูุชุงููุฉ ุ ูุฅุฐุง ูุงูุช ุบูุฑ ูุดุทุฉ ุ ููุญู ุจุญุงุฌุฉ ุฅูู ูุฒูุฏ ูู ุงูุจุญุซ ูู ุฎูุงู ุงููุตูููุฉ ูุฌุฒุก ูู ุงูุญููุฉ. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/9c1/7a7/fc5/9c17a7fc56f9bf6c9e4583c29127aa55.png"></div><br>  <i>ูุญู ุญููุฉ ูู ุฎูุงู ูุฌููุนุฉ.</i> <br><br>  ููุง ูู ููุถุญ ูู ุงูุฑุณู ุงูุชูุถูุญู ุ ูุฑูุฏ ุงูุงูุชูุงู ูู ุงูุนูุฏุฉ ุงูุชุงููุฉ ุฅูู ููุงูุฉ ุงููุงุฆูุฉ.  ูููู ุงูููุงู ุจุฐูู ุจุงุณุชุฎุฏุงู <code>next + length</code> .  ูููู ูุชุญุฏูุฏ ููุฑุณ ุ ุชุญุชุงุฌ ุฅูู ูุตุฑู ุนูู ุทูู ุงูุตููู.  ูููู ุงูููุงู ุจุฐูู ุจุณูููุฉ ุจุงุณุชุฎุฏุงู ุนูููุฉ ุงูุชุนุฏูู. <br><br>  ุจุนุฏ ุฃู ูุฌุฏูุง ุฎุงุฏููุง ุนุงููุงู ุฃุซูุงุก ุงูุจุญุซ ุ ูุฌุจ ูุถุน ุนูุงูุฉ ุนููู ูุฎุงุฏู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// GetNextPeer returns next active peer to take a connection func (s *ServerPool) GetNextPeer() *Backend { // loop entire backends to find out an Alive backend next := s.NextIndex() l := len(s.backends) + next // start from next and move a full cycle for i := next; i &lt; l; i++ { idx := i % len(s.backends) // take an index by modding with length // if we have an alive backend, use it and store if its not the original one if s.backends[idx].IsAlive() { if i != next { atomic.StoreUint64(&amp;s.current, uint64(idx)) // mark the current one } return s.backends[idx] } } return nil }</span></span></code> </pre><br><h2 style=";text-align:right;direction:rtl">  ุชุฌูุจ ุญุงูุฉ ุงูุณุจุงู ูู ุจููุฉ Backend </h2><br>  ููุง ุชุญุชุงุฌ ุฅูู ุชุฐูุฑ ูุถูุฉ ูููุฉ.  ุชุญุชูู ุจููุฉ <code>Backend</code> ุนูู ูุชุบูุฑ ูููู ููุนุฏูุฏ ูู goroutines ุชุนุฏููู ุฃู ุงูุงุณุชุนูุงู ุนูู ูู ููุณ ุงูููุช. <br><br>  ูุญู ูุนูู ุฃู goroutines ุณููุฑุฃ ุงููุชุบูุฑ ุฃูุซุฑ ูู ุงููุชุงุจุฉ ุฅููู.  ูุฐูู ุ ูุชุณูุณู ุงููุตูู ุฅูู <code>Alive</code> ุงุฎุชุฑูุง <code>RWMutex</code> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// SetAlive for this backend func (b *Backend) SetAlive(alive bool) { b.mux.Lock() b.Alive = alive b.mux.Unlock() } // IsAlive returns true when backend is alive func (b *Backend) IsAlive() (alive bool) { b.mux.RLock() alive = b.Alive b.mux.RUnlock() return }</span></span></code> </pre><br><h2 style=";text-align:right;direction:rtl">  ุชุญููู ุงูุชูุงุฒู ุจูู ุงูุทูุจุงุช </h2><br>  ุงูุขู ูููููุง ุตูุงุบุฉ ุทุฑููุฉ ุจุณูุทุฉ ูููุงุฒูุฉ ุทูุจุงุชูุง.  ุณูู ุชูุดู ููุท ุฅุฐุง ุณูุทุช ุฌููุน ุงูุฎูุงุฏู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// lb load balances the incoming request func lb(w http.ResponseWriter, r *http.Request) { peer := serverPool.GetNextPeer() if peer != nil { peer.ReverseProxy.ServeHTTP(w, r) return } http.Error(w, "Service not available", http.StatusServiceUnavailable) }</span></span></code> </pre> <br>  ูููู ุชูุฑูุฑ ูุฐู ุงูุทุฑููุฉ ุฅูู ุฎุงุฏู HTTP ุจุจุณุงุทุฉ ูุซู <code>HandlerFunc</code> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs">server := http.Server{ Addr: fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">":%d"</span></span>, port), Handler: http.HandlerFunc(lb), }</code> </pre><br><h2 style=";text-align:right;direction:rtl">  ูุญู ููุฌู ุญุฑูุฉ ุงููุฑูุฑ ููุท ุฅูู ุงูุฎูุงุฏู ุงูุชู ุชุนูู </h2><br>  ููุงุฒู ูุฏููุง ูุฏูู ูุดููุฉ ุฎุทูุฑุฉ.  ูุง ูุนุฑู ูุง ุฅุฐุง ูุงู ุงูุฎุงุฏู ูุนูู ุฃู ูุง.  ููุนุฑูุฉ ุฐูู ุ ุชุญุชุงุฌ ุฅูู ุงูุชุญูู ูู ุงูุฎุงุฏู.  ููุงู ุทุฑููุชุงู ููููุงู ุจุฐูู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุดุท: ุชูููุฐ ุงูุทูุจ ุงูุญุงูู ุ ูุฌุฏ ุฃู ุงูุฎุงุฏู ุงููุญุฏุฏ ูุง ูุณุชุฌูุจ ุ ููุถุน ุนูุงูุฉ ุนููู ูู ูุถุน ุงูุฎููู. </li><li style=";text-align:right;direction:rtl">  ุงููุจูู ูููุฌููู: ููููู ุงุฎุชุจุงุฑ ุงุชุตุงู ุฎูุงุฏู ูู ูุชุฑุฉ ุฒูููุฉ ูุนููุฉ ูุงูุชุญูู ูู ุงูุญุงูุฉ. </li></ul><br><h2 style=";text-align:right;direction:rtl">  ุงูุชุญูู ุจูุดุงุท ุงูุฎูุงุฏู ููุฏ ุงูุชุดุบูู </h2><br>  ูู ุญุงูุฉ <code>ReverseProxy</code> ุฃู ุฎุทุฃ <code>ReverseProxy</code> ูุจุฏุฃ <code>ReverseProxy</code> ูุธููุฉ ุฑุฏ ุงูุงุชุตุงู <code>ErrorHandler</code> .  ูุฐุง ูููู ุงุณุชุฎุฏุงูู ูููุดู ุนู ุงููุดู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs">proxy.ErrorHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(writer http.ResponseWriter, request *http.Request, e error)</span></span></span></span> { log.Printf(<span class="hljs-string"><span class="hljs-string">"[%s] %s\n"</span></span>, serverUrl.Host, e.Error()) retries := GetRetryFromContext(request) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> retries &lt; <span class="hljs-number"><span class="hljs-number">3</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> &lt;-time.After(<span class="hljs-number"><span class="hljs-number">10</span></span> * time.Millisecond): ctx := context.WithValue(request.Context(), Retry, retries+<span class="hljs-number"><span class="hljs-number">1</span></span>) proxy.ServeHTTP(writer, request.WithContext(ctx)) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-comment"><span class="hljs-comment">// after 3 retries, mark this backend as down serverPool.MarkBackendStatus(serverUrl, false) // if the same request routing for few attempts with different backends, increase the count attempts := GetAttemptsFromContext(request) log.Printf("%s(%s) Attempting retry %d\n", request.RemoteAddr, request.URL.Path, attempts) ctx := context.WithValue(request.Context(), Attempts, attempts+1) lb(writer, request.WithContext(ctx)) }</span></span></code> </pre> <br>  ูู ุชุทููุฑ ูุนุงูุฌ ุงูุฃุฎุทุงุก ูุฐุง ุ ุงุณุชุฎุฏููุง ุฅููุงููุงุช ุนูููุงุช ุงูุฅุบูุงู.  ูุฐุง ูุชูุญ ููุง ุงูุชูุงุท ูุชุบูุฑุงุช ุฎุงุฑุฌูุฉ ูุซู ุนูุงููู URL ููุฎูุงุฏู ูู ุทุฑููุชูุง.  ูุชุญูู ุงููุนุงูุฌ ูู ุนุฏุงุฏ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุ ูุฅุฐุง ูุงู ุฃูู ูู 3 ุ ูุฅููุง ูุฑุณู ุงูุทูุจ ููุณู ูุฑุฉ ุฃุฎุฑู ุฅูู ููุณ ุงูุฎุงุฏู.  ูุฐุง ูุฃูู ุจุณุจุจ ุงูุฃุฎุทุงุก ุงููุคูุชุฉ ุ ูุฏ ูุชุฎูู ุงูุฎุงุฏู ุนู ุทูุจุงุชูุง ุ ูููู ุณูุตุจุญ ูุชุงุญูุง ูุฑูุจูุง (ูุฏ ูุง ูููู ูุฏู ุงูุฎุงุฏู ูุขุฎุฐ ุชูุตูู ูุฌุงููุฉ ููุนููุงุก ุงูุฌุฏุฏ).  ูุฐูู ุชุญุชุงุฌ ุฅูู ุถุจุท ูุคูุช ุงูุชุฃุฎูุฑ ููุญุงููุฉ ุฌุฏูุฏุฉ ุจุนุฏ ุญูุงูู 10 ูููู ุซุงููุฉ.  ูุน ูู ุทูุจ ูููู ุจุฒูุงุฏุฉ ุนุฏุงุฏ ุงููุญุงููุงุช. <br><br>  ุจุนุฏ ูุดู ูู ูุญุงููุฉ ุ ูุญุชูู ุนูู ุงูุฎุงุฏู ุจุงุนุชุจุงุฑู ุฎุงููุงู. <br><br>  ุฃูุช ุงูุขู ุจุญุงุฌุฉ ุฅูู ุชุนููู ุฎุงุฏู ุฌุฏูุฏ ูููุณ ุงูุทูุจ.  ุณููุนู ุฐูู ุจุงุณุชุฎุฏุงู ุนุฏุงุฏ ุงูุนุฏุงุฏ ุจุงุณุชุฎุฏุงู ุญุฒูุฉ <code>context</code> .  ุจุนุฏ ุฒูุงุฏุฉ ุนุฏุงุฏ ุงููุญุงููุงุช ุ ูููู ุจุชูุฑูุฑูุง ุฅูู <code>lb</code> ูุชุญุฏูุฏ ุฎุงุฏู ุฌุฏูุฏ ููุนุงูุฌุฉ ุงูุทูุจ. <br><br>  ูุง ูููููุง ุงูููุงู ุจุฐูู ุฅูู ุฃุฌู ุบูุฑ ูุณูู ุ ูุฐูู ุณูููู ุจุงูุชุญูู ููุง ุฅุฐุง ูุงู ูุฏ ุชู ุงููุตูู ุฅูู ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงููุญุงููุงุช ูุจู ูุชุงุจุนุฉ ูุนุงูุฌุฉ ุงูุทูุจ. <br><br>  ููููู ุจุจุณุงุทุฉ ุงูุญุตูู ุนูู ุนุฏุงุฏ ุงููุญุงููุงุช ูู ุงูุทูุจ ุ ุฅุฐุง ูุตู ุฅูู ุงูุญุฏ ุงูุฃูุตู ุ ูุณููุทุน ุงูุทูุจ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// lb load balances the incoming request func lb(w http.ResponseWriter, r *http.Request) { attempts := GetAttemptsFromContext(r) if attempts &gt; 3 { log.Printf("%s(%s) Max attempts reached, terminating\n", r.RemoteAddr, r.URL.Path) http.Error(w, "Service not available", http.StatusServiceUnavailable) return } peer := serverPool.GetNextPeer() if peer != nil { peer.ReverseProxy.ServeHTTP(w, r) return } http.Error(w, "Service not available", http.StatusServiceUnavailable) }</span></span></code> </pre> <br>  ูุฐุง ูู ุชูููุฐ ุงูุนูุฏูุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ุญุฒูุฉ ุงูุณูุงู </h2><br>  ุชุณูุญ ูู ุญุฒูุฉ <code>context</code> ุจุชุฎุฒูู ุงูุจูุงูุงุช ุงููููุฏุฉ ูู ุทูุจุงุช HTTP.  ุณูู ูุณุชุฎุฏู ูุฐุง ุจูุดุงุท ูุชุชุจุน ุงูุจูุงูุงุช ุงููุชุนููุฉ ุจุงูุทูุจุงุช - ุนุฏุงุฏุงุช <code>Retry</code> ูุฅุนุงุฏุฉ <code>Retry</code> . <br><br>  ุฃููุงู ุ ุชุญุชุงุฌ ุฅูู ุชุนููู ููุงุชูุญ ุงูุณูุงู.  ูู ุงููุณุชุญุณู ุงุณุชุฎุฏุงู ูุง ุณูุณูุฉ ุ ูููู ุงูููู ุงูุนุฏุฏูุฉ ุงููุฑูุฏุฉ.  ุชุญุชูู Go ุนูู ูููุฉ ุฑุฆูุณูุฉ <code>iota</code> ููุชุทุจูู ุงูุชุฏุฑูุฌู ููุซูุงุจุช ุ ูุญุชูู ูู ูููุง ุนูู ูููุฉ ูุฑูุฏุฉ.  ูุฐุง ูู ุงูุญู ุงูุฃูุซู ูุชุนุฑูู ุงูููุงุชูุญ ุงูุฑูููุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ( Attempts <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">iota</span></span> Retry )</code> </pre> <br>  ููููู ุจุนุฏ ุฐูู ุงุณุชุฎุฑุงุฌ ุงููููุฉ ุ ููุง ููุนู ุนุงุฏุฉู ูุน <code>HashMap</code> .  ูุฏ ุชุนุชูุฏ ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ ุนูู ุงููููู ุงูุญุงูู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// GetAttemptsFromContext returns the attempts for request func GetRetryFromContext(r *http.Request) int { if retry, ok := r.Context().Value(Retry).(int); ok { return retry } return 0 }</span></span></code> </pre><br><h2 style=";text-align:right;direction:rtl">  ุฎุงุฏู ุงูุณูุจู ุงูุชุญูู ูู ุงูุตุญุฉ </h2><br>  ุงูุดููุงุช ุงูุณูุจูุฉ ุชุญุฏูุฏ ูุงุณุชุนุงุฏุฉ ุงูุฎูุงุฏู ุงูุณุงูุทุฉ.  ูุญู ูููู ุจุชุฌุฑุจุชูุง ูู ูุชุฑุฉ ุฒูููุฉ ูุนููุฉ ูุชุญุฏูุฏ ุญุงูุชูุง. <br><br>  ูุฅุฌุฑุงุก ุงุฎุชุจุงุฑ ping ุ ุญุงูู ุชุฃุณูุณ ุงุชุตุงู TCP.  ุฅุฐุง ูุงู ุงูุฎุงุฏู ูุณุชุฌูุจ ุ ูุฅููุง ูุญุชูู ุจู.  ูููู ุชูููู ูุฐู ุงูุทุฑููุฉ ูุงุณุชุฏุนุงุก ููุงุท ููุงูุฉ ูุนููุฉ ูุซู <code>/status</code> .  ุชุฃูุฏ ูู ุฅุบูุงู ุงูุงุชุตุงู ุจุนุฏ ุฅูุดุงุฆู ูุชูููู ุงูุญูู ุงูุฅุถุงูู ุนูู ุงูุฎุงุฏู.  ูุฅูุง ุ ูุณูุญุงูู ุงูุญูุงุธ ุนูู ูุฐุง ุงูุงุชุตุงู ูุณูุณุชููุฏ ููุงุฑุฏู ูู ุงูููุงูุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// isAlive checks whether a backend is Alive by establishing a TCP connection func isBackendAlive(u *url.URL) bool { timeout := 2 * time.Second conn, err := net.DialTimeout("tcp", u.Host, timeout) if err != nil { log.Println("Site unreachable, error: ", err) return false } _ = conn.Close() // close it, we dont need to maintain this connection return true }</span></span></code> </pre> <br>  ููููู ุงูุขู ุชูุฑุงุฑ ุงูุฎูุงุฏู ูุชุญุฏูุฏ ุญุงูุงุชูุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// HealthCheck pings the backends and update the status func (s *ServerPool) HealthCheck() { for _, b := range s.backends { status := "up" alive := isBackendAlive(b.URL) b.SetAlive(alive) if !alive { status = "down" } log.Printf("%s [%s]\n", b.URL, status) } }</span></span></code> </pre> <br>  ูุชุดุบูู ูุฐุง ุงูุฑูุฒ ุจุดูู ุฏูุฑู ุ ููููู ุชุดุบูู ุงููุคูุช ูู Go.  ุณูุชูุญ ูู ุงูุงุณุชูุงุน ุฅูู ุงูุฃุญุฏุงุซ ูู ุงูููุงุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// healthCheck runs a routine for check status of the backends every 2 mins func healthCheck() { t := time.NewTicker(time.Second * 20) for { select { case &lt;-tC: log.Println("Starting health check...") serverPool.HealthCheck() log.Println("Health check completed") } } }</span></span></code> </pre> <br>  ูู ูุฐุง ุงูุฑูุฒ ุ ุชููู ููุงุฉ <code>&lt;-tC</code> ุจุฅุฑุฌุงุน ูููุฉ ูู 20 ุซุงููุฉ.  <code>select</code> ูุณูุญ ูู ูุชุญุฏูุฏ ูุฐุง ุงูุญุฏุซ.  ูู ุญุงูุฉ ุนุฏู ูุฌูุฏ ูููู <code>default</code> ุ ููุชุธุฑ ุญุชู ูุชู ุชูููุฐ ุญุงูุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู. <br><br>  ุงูุขู ูู ุจุชุดุบูู ุงูููุฏ ูู ูุฌููุนุฉ ูููุตูุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> healthCheck()</code> </pre><br><h2 style=";text-align:right;direction:rtl">  ุงุณุชูุชุงุฌ </h2><br>  ูู ูุฐู ุงูููุงูุฉ ุ ุฏุฑุณูุง ุงูุนุฏูุฏ ูู ุงูุฃุณุฆูุฉ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฌููุฉ ุฑูุจู ุฎูุงุฑุฒููุฉ </li><li style=";text-align:right;direction:rtl">  ReverseProxy ูู ุงูููุชุจุฉ ุงูููุงุณูุฉ </li><li style=";text-align:right;direction:rtl">  ูุงุฆูุงุช ุงููุฒุงููุฉ </li><li style=";text-align:right;direction:rtl">  ุงูุนูููุงุช ุงูุฐุฑูุฉ </li><li style=";text-align:right;direction:rtl">  ุฏูุงุฆุฑ ูุตูุฑุฉ </li><li style=";text-align:right;direction:rtl">  ุงูุงุณุชุฑุฌุงุนุงุช </li><li style=";text-align:right;direction:rtl">  ุนูููุฉ ุงูุงุฎุชูุงุฑ </li></ul><br>  ููุงู ุงูุนุฏูุฏ ูู ุงูุทุฑู ูุชุญุณูู ุงูููุงุฒู ูุฏููุง.  ุนูู ุณุจูู ุงููุซุงู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงุณุชุฎุฏู ุงููููุฉ ููุฑุฒ ุงูุฎูุงุฏู ุงูุญูุฉ ูุชูููู ูุทุงู ุงูุจุญุซ. </li><li style=";text-align:right;direction:rtl">  ุฌูุน ุงูุฅุญุตุงุกุงุช. </li><li style=";text-align:right;direction:rtl">  ูู ุจุชุทุจูู ุฎูุงุฑุฒููุฉ ุงูุฏุงุฑุฉ ุงููุณุชุฏูุฑุฉ ุงูููุฒููุฉ ูุน ุฃูู ุนุฏุฏ ูู ุงูุงุชุตุงูุงุช. </li><li style=";text-align:right;direction:rtl">  ุฅุถุงูุฉ ุฏุนู ููููุงุช ุงูุชูููู. </li></ul><br>  ู ููุฐุง. <br><br>  ุดูุฑุฉ ุงููุตุฏุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar476276/">https://habr.com/ru/post/ar476276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar476264/index.html">Telegram ุจูุช ูุชุนูู ุงููุบุงุช ุงูุฃุฌูุจูุฉ: ูู ุงููููุงุช ุงูููุชุธุฉ ุฅูู ุงูุชุญุฏุซ</a></li>
<li><a href="../ar476266/index.html">ุชุฏุฑูุจ ูู ุดุฑูุฉ Mars Digital Technologies. ููู ุทุจููุง ุงูุชุนูู ุงูุนููู ูู ุนูููุงุช ุงูุงูุฏูุงุฌ ูุงูุดุฑุงุก</a></li>
<li><a href="../ar476268/index.html">ุญููู ูุชุญุฏูุงุช ุงูุชุดุงู ุงูุฃุฎุทุงุก ุงูุชู ููุฏููุง ูุฑูู PVS-Studio ูู ุงููุคุชูุฑุงุช ูู 2018-2019</a></li>
<li><a href="../ar476270/index.html">ุฑุจุญูุง: TopCoder Open 2019</a></li>
<li><a href="../ar476272/index.html">ุฅุฌุงุจุงุช ุนูู ุงูููุงู ูู ูุดู PVS-Studio ูู ุงููุคุชูุฑุงุช 2018-2019</a></li>
<li><a href="../ar476278/index.html">ูุคุชูุฑ ูุจุนุฉ ุณูุฏุงุก ุงูููุงูุงุช ุงููุชุญุฏุฉ ุงูุฃูุฑูููุฉ. ุงูุซุฑุงุก ุฃู ุงูููุช: ูุณุจ ุงููุงู ุนูู ุงูุฅูุชุฑูุช ุจุงุณุชุฎุฏุงู ุงููุจุนุฉ ุงูุณูุฏุงุก. ุงูุฌุฒุก 3</a></li>
<li><a href="../ar476280/index.html">ูู ุฎูุงู ุงูุดูู ุฅูู DOS: ุฃุฑุจุนุฉ ุฃูุฑุงุต ูุฑูุฉ ุบูุฑุช ุงูุนุงูู</a></li>
<li><a href="../ar476284/index.html">ูููู ุจุตูุงุบุฉ ุงุณุชุฑุงุชูุฌูุฉ ููุชุนุงูู ูุน ุงูุฃุฎุทุงุก ูู React</a></li>
<li><a href="../ar476286/index.html">ุฃูุถู 5 ุฃุทุฑ JS ูุชุทููุฑ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูู ุนุงู 2020. ุงูุฌุฒุก 1</a></li>
<li><a href="../ar476288/index.html">ุฃูุถู 5 ุฃุทุฑ JS ูุชุทููุฑ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูู ุนุงู 2020. ุงูุฌุฒุก 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>