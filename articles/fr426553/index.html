<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♥️ 🗽 🈶 Bannières publicitaires dans l'application iOS 🦏 👩‍🚀 🚽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, nous ouvrons une série d'articles sur ce dont on ne parle généralement pas lors des conférences et réunions techniques. Cet article et le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bannières publicitaires dans l'application iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/426553/"><img src="https://habrastorage.org/webt/ce/j2/t9/cej2t9yugiyn0bnzyhfnwtckqmq.jpeg"><br><br>  Aujourd'hui, nous ouvrons une série d'articles sur ce dont on ne parle généralement pas lors des conférences et réunions techniques.  Cet article et les suivants vous expliqueront comment fonctionne le mécanisme de monétisation dans l'application de divertissement iFunny iOS populaire aux États-Unis, que nous développons. <br><a name="habracut"></a><br>  La publicité est l'un des principaux moyens de monétiser les applications gratuites.  Mais maintenant, quelles options étaient en 2011 lorsque iFunny est apparu?  Le service a été initialement conçu comme une entreprise solide et durable, donc dès le premier jour, la société a décidé de ne pas flirter avec les utilisateurs et de ne pas s'engager dans des jeux à capitalisation conditionnelle. <br><br>  À cette époque, la principale option de monétisation était de créer une version gratuite du service, puis d'essayer de vendre la fonctionnalité principale.  Le consommateur était jeune, inexpérimenté et n'était pas prêt à se séparer de montants supérieurs à un dollar. <br><br>  Des mathématiques simples ont montré qu'avec une conversion de 10%, obtenir un ARPU de plus de 10 cents est une tâche presque impossible. <br><br>  Ensuite, j'ai dû réfléchir à la façon dont vous pouvez monétiser le produit.  Le modèle publicitaire a déjà très bien fonctionné sur le Web, et on peut supposer qu'il fleurira bientôt également sur les téléphones. <br>  En général, le début du modèle de monétisation de la publicité mobile peut être considéré comme l'apparition d'AdWhirl - un service qui vous a permis d'intégrer le SDK des réseaux publicitaires et de les faire pivoter.  Son apparence a permis d'élever FillRate à une moyenne de 50% sur le marché et de rendre les revenus du modèle publicitaire au moins comparables à des ventes d'un dollar.  Le principe même de la mise en œuvre de toutes les sources possibles de demande et de l'organisation de la concurrence entre elles est devenu le principal moteur de croissance de l'industrie publicitaire et continue d'être exploité à ce jour. <br><br>  Mais plus le système est complexe, moins il devient stable, ce qui est absolument inacceptable pour les grands services du niveau iFunny.  Commençant à s'orienter dans cette direction en 2011, la société a créé l'un des mécanismes les plus efficaces pour travailler avec la bannière mobile et la publicité native et a augmenté ses revenus par utilisateur de 40 fois, ce qui a permis de développer non seulement des projets internes, mais aussi d'investir dans d'autres entreprises. <br><br><h2>  MoPub et entreprise </h2><br>  Depuis 2012, nous sommes passés d'AdWhirl à MoPub. <br><br>  MoPub est une plateforme de publicité mobile avec la possibilité d'ajouter ses propres modules, qui comprend plusieurs excellents outils: <br><br><ul><li>  Marché MoPub - propre bourse de publicité; </li><li>  médiateur de réseaux publicitaires pour travailler avec des réseaux externes; </li><li>  un mécanisme de commande qui vous permet de placer indépendamment des bannières dans votre propre application et de personnaliser leurs affichages. </li></ul><br>  Les principaux avantages de MoPub: <br><br><ul><li>  capable de travailler avec la plupart des réseaux publicitaires; </li><li>  mécanisme clair de connexion de nouveaux réseaux tiers; </li><li>  open source </li><li>  un grand nombre de paramètres de base et de ciblage; </li><li>  une grande communauté autour du réseau, il y a même une conférence qui lui est propre. </li></ul><br>  MoPub présente également des inconvénients: <br><br><ul><li>  les demandes de pool sur GitHub ne sont pas acceptées et il n'y a aucune réaction à celles-ci; </li><li> le panneau de contrôle est très complexe, et pour le développeur, lors du débogage, il faut un certain temps pour se plonger dans sa structure. </li></ul><br><h2>  Le pouvoir de la vérité </h2><br>  Comme l'a dit le héros d'un film russe: "La force est en vérité".  Dans cette partie, je parlerai des difficultés auxquelles nous, en tant que développeurs d'applications, avons dû faire face après le premier million de téléchargements d'iFunny, la croissance de l'audience et du trafic publicitaire de plus de 100 partenaires. <br><br><h3>  Le contenu </h3><br>  Le marché publicitaire est une «caste» très fermée d'entreprises technologiques, mais en même temps, les agrégateurs disposent d'un large réseau de partenaires: des grandes entreprises qui travaillent avec des millions de budgets aux petites entreprises adaptées à des publics cibles spécifiques. <br><br>  Cette proximité et cette fragmentation des partenaires, malgré la pré-modération de la bannière et des règles plutôt strictes sur le contenu publicitaire, ne permettent pas aux vendeurs de publicité les plus honnêtes de publier des créations interdites ou de gâcher l'expérience utilisateur dans l'application. <br><br>  Il existe plusieurs catégories principales de contenu «obscène» dans les bannières publicitaires: <br><br><ul><li>  contenu porno.  Récemment, il apparaît de moins en moins, mais néanmoins il a lieu d'être.  Nous ne pouvons pas publier ce contenu dans l'article, donc l'image ne sera pas ici </li><li>  alertes système dans des bannières, un exemple peut être consulté sur l'un des utilisateurs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">twitter.com/IfunnyStates/status/1029393804749668352</a> </li><li>  contenu avec son.  Les sons ne sont pas interdits par les réseaux publicitaires, ainsi que les animations, mais si le son joue sans interagir avec l'interface, cela est perçu par les utilisateurs comme un bug d'application et affecte négativement l'expérience utilisateur </li><li>  attirer l'attention.  Une bonne bannière devrait attirer l'attention de l'utilisateur, mais cela ne se produit pas toujours de manière honnête: des vidéos vacillantes tombent parfois dans les bannières.  Une autre façon malhonnête d'amener l'utilisateur à appuyer sur la bannière consiste à simuler l'interface de l'application, par exemple comme ceci: <br><br><img src="https://habrastorage.org/webt/p5/3u/lk/p53ulkue4iz7ofr14t3i7xyrqpq.png"></li></ul><br>  Soit dit en passant, en Russie, une simple pression sur cette bannière peut émettre un abonnement payant pour certains opérateurs mobiles, et vous ne le saurez même pas avant d'avoir vu les détails.  C'est aussi une façon malhonnête de travailler avec la publicité, mais les opérateurs aux États-Unis n'ont pas une telle opportunité. <br><br><h3>  Clics automatiques </h3><br>  Comme mon expérience le montre, il s'agit d'un cas extrêmement négatif pour les utilisateurs.  En utilisant les capacités de JavaScript, WKWebView ou UIWebView, ainsi que des trous dans la mise en œuvre des bibliothèques de publicité, vous pouvez créer des annonces qui ouvriront le contenu de la bannière lui-même et conduiront l'utilisateur hors de l'application. <br><br>  Afin de répéter ce problème en utilisant l'exemple de MoPub, ajoutez simplement le code javascript du contenu suivant à la bannière: <br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ifunny.co"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"testbutton"</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'testbutton'</span></span></span><span class="javascript">).click(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Cela a fonctionné longtemps dans de nombreuses versions de MoPub, jusqu'à la version 4.13. <br><br>  En explorant la mise en œuvre de MoPub, il a été possible de générer des liens plus complexes qui permettraient non seulement d'ouvrir des publicités en plein écran, mais aussi d'envoyer l'utilisateur vers l'AppStore vers une application spécifique et même de ne pas prendre en compte l'affichage de la bannière. <br><br>  Soit dit en passant, dans les notes de publication de la version 4.13.0 du SDK MoPub pour iOS, il n'y a aucune information sur ce correctif, car il s'agissait d'un trou assez grave dans le SDK, et les partenaires malhonnêtes de MoPub l'ont exploité assez activement.  Comme le montrent les journaux, dont je parlerai plus tard, chaque jour, je devais bloquer jusqu'à 2 millions de tentatives d'ouverture de la bannière sans interaction de l'utilisateur avec elle. <br><br>  Dans le cas de MoPub, il s'est avéré facile de trouver et de répéter le problème, mais d'autres réseaux avec lesquels iFunny travaille ont un code fermé, et vous devez faire face aux nouveaux clics automatiques en bloquant les bannières ou même en déconnectant les réseaux pendant un certain temps. <br>  iFunny travaille en étroite collaboration avec tous les partenaires publicitaires et les informe de ces bannières.  Étant donné que le jeune public d'iFunny est intéressant pour les annonceurs, les partenaires sont prêts à les rencontrer et à retirer cette publicité de la rotation. <br><br><h3>  Crash </h3><br>  Le crash est toujours mauvais.  Pire encore, lorsqu'ils surviennent en raison d'une dépendance avec une source fermée, et que vous ne pouvez les influencer qu'indirectement.  Au fil des années de travail avec la publicité chez iFunnu, plusieurs types d'accidents ont été identifiés pour eux-mêmes, qui peuvent être divisés en plusieurs groupes. <br><br><ul><li>  Système </li></ul><br>  Il s'agit notamment des exceptions dans la bibliothèque réseau, WKWebView (UIWebView), OpenGL. <br>  Il est très difficile d'affecter directement ce type de plantages, mais il était encore possible d'affecter certains d'entre eux, après avoir étudié le fonctionnement du composant WebView avec WebGL. <br><br>  Voici à quoi ressemble la stackrace de ces plantages: <br><br> <code>1 libGPUSupportMercury.dylib gpus_ReturnNotPermittedKillClient + 12 <br> 2 AGXGLDriver gldUpdateDispatch + 7132 <br> 3 libGPUSupportMercury.dylib gpusSubmitDataBuffers + 172 <br> 4 AGXGLDriver gldUpdateDispatch + 12700 <br> 5 WebCore WebCore::GraphicsContext3D::reshape(int, int) + 524 <br> 6 WebCore WebCore::WebGLRenderingContextBase::initializeNewContext() + 712 <br> 7 WebCore WebCore::WebGLRenderingContextBase::WebGLRenderingContextBase(WebCore::HTMLCanvasElement*, WTF::RefPtr&lt;WebCore::GraphicsContext3D&gt;&amp;&amp;, WebCore::GraphicsContext3D::Attributes) + 512 <br> 8 WebCore WebCore::WebGLRenderingContext::WebGLRenderingContext(WebCore::HTMLCanvasElement*, WTF::PassRefPtr&lt;WebCore::GraphicsContext3D&gt;, WebCore::GraphicsContext3D::Attributes) + 36 <br> 9 WebCore WebCore::WebGLRenderingContextBase::create(WebCore::HTMLCanvasElement*, WebCore::WebGLContextAttributes*, WTF::String const&amp;) + 1272 <br> 10 WebCore WebCore::HTMLCanvasElement::getContext(WTF::String const&amp;, WebCore::CanvasContextAttributes*) + 520 <br> 11 WebCore WebCore::JSHTMLCanvasElement::getContext(JSC::ExecState&amp;) + 212 <br> 12 JavaScriptCore llint_entry + 27340 <br> 13 JavaScriptCore llint_entry + 24756 <br> 14 JavaScriptCore llint_entry + 24756 <br> 15 JavaScriptCore llint_entry + 24756 <br> 16 JavaScriptCore llint_entry + 25676 <br> 17 JavaScriptCore llint_entry + 24756 <br> 18 JavaScriptCore llint_entry + 24656 <br> 19 JavaScriptCore vmEntryToJavaScript + 260 <br> 20 JavaScriptCore JSC::JITCode::execute(JSC::VM*, JSC::ProtoCallFrame*) + 164 <br> 21 JavaScriptCore JSC::Interpreter::executeCall(JSC::ExecState*, JSC::JSObject*, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;) + 348 <br> 22 JavaScriptCore JSC::profiledCall(JSC::ExecState*, JSC::ProfilingReason, JSC::JSValue, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;, WTF::NakedPtr&lt;JSC::Exception&gt;&amp;) + 160 <br> 23 WebCore WebCore::JSEventListener::handleEvent(WebCore::ScriptExecutionContext*, WebCore::Event*) + 980 <br> 24 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;, WebCore::EventTargetData*, WTF::Vector&lt;WebCore::RegisteredEventListener, 1ul, WTF::CrashOnOverflow, 16ul&gt;&amp;) + 616 <br> 25 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;) + 324 <br> 26 WebCore WebCore::EventContext::handleLocalEvents(WebCore::Event&amp;) const + 108 <br> 27 WebCore WebCore::EventDispatcher::dispatchEvent(WebCore::Node*, WebCore::Event&amp;) + 876 <br> 28 WebCore non-virtual thunk to WebCore::HTMLScriptElement::dispatchLoadEvent() + 80 <br> 29 WebCore WebCore::ScriptElement::execute(WebCore::CachedScript*) + 360 <br> 30 WebCore WebCore::ScriptRunner::timerFired() + 456 <br> 31 WebCore WebCore::ThreadTimers::sharedTimerFiredInternal() + 144 <br> 32 WebCore WebCore::timerFired(__CFRunLoopTimer*, void*) + 24 <br> 33 CoreFoundation __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 24 <br> 34 CoreFoundation __CFRunLoopDoTimer + 868 <br> 35 CoreFoundation __CFRunLoopDoTimers + 240 <br> 36 CoreFoundation __CFRunLoopRun + 1568 <br> 37 CoreFoundation CFRunLoopRunSpecific + 440 <br> 38 WebCore RunWebThread(void*) + 452 <br> 39 libsystem_pthread.dylib _pthread_body + 236 <br> 40 libsystem_pthread.dylib _pthread_start + 280 <br> 41 libsystem_pthread.dylib thread_start + 0</code> <br> <br>  De plus, ils se produisent exclusivement en laissant en arrière-plan.  Cela est dû au fait que le moteur OpenGL ne devrait pas fonctionner lorsque l'application est en arrière-plan. <br><br>  Le correctif s'est avéré assez simple: <br><br>  Lorsque vous quittez en arrière-plan, vous devez prendre une capture d'écran de la bannière. <br><br>  Supprimez la vue publicitaire de l'écran afin que le composant WebView cesse d'utiliser OpenGL. <br>  Lorsque vous quittez l'arrière-plan, retournez tout comme il était. <br><br>  Dans le code Objective-C, cela ressemble à ceci: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onWillResignActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview) { <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsBeginImageContext</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.bounds.size); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.layer renderInContext:<span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetCurrentContext</span></span>()]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *adViewScreenShot = <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetImageFromCurrentImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsEndImageContext</span></span>(); adViewThumbView = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> alloc] initWithImage:adViewScreenShot]; adViewThumbView.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> clearColor]; adViewThumbView.frame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.frame; <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview.subviews indexOfObject:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview insertSubview:adViewThumbView atIndex:adIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView removeFromSuperview]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onDidBecomeActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView &amp;&amp; adViewThumbView) { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [adViewThumbView.superview.subviews indexOfObject:adViewThumbView]; [adViewThumbView.superview insertSubview:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView atIndex:adIndex]; [adViewThumbView removeFromSuperview]; adViewThumbView = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } }</code> </pre><br><ul><li>  Intégration </li></ul><br>  Ce sont des problèmes qui se produisent à la jonction d'iFunny, de Mopub et du fournisseur de publicité. <br>  En règle générale, ils surviennent après la mise à jour de la bibliothèque du fournisseur et en raison de nouvelles façons d'interagir avec eux. <br><br>  Le dernier cas de ce type remonte à juin de cette année, après la prochaine mise à jour de l'une des bibliothèques utilisées.  Une nouvelle façon d'initialiser la bibliothèque a suggéré d'utiliser singleton pour configurer les paramètres réseau. <br><br>  Y revenir deux fois, comme cela s'est produit dans la mise en œuvre, a périodiquement provoqué une frise du thread principal, j'ai donc dû encapsuler l'initialisation dans dispatch_once. <br><br>  Le département QA d'iFunny est capable de bien tester les bibliothèques de publicité, donc ce problème a été trouvé lors des tests de la mise à jour. <br><br><ul><li>  Inattendu </li></ul><br>  Ce type de plantages ne peut pas être contrôlé du tout, car il se produit sans aucune modification dans le client. <br><br>  Ils sont associés à la mise à jour du backend des partenaires et au manque de compatibilité ascendante.  De tels plantages se produisent souvent chez les grands fournisseurs de publicité, mais sont rapidement résolus, car ils affectent un grand nombre d'applications en même temps. <br><br>  Il y a eu des cas où l'iFunny sans crash par jour est passé de 99,8% à 80%, et le nombre de commentaires en colère dans l'histoire était de plusieurs dizaines. <br><br><h4>  Performances </h4><br>  La bannière publicitaire, en règle générale, utilise des composants WebView pour afficher la publicité, donc chaque bannière affichée est une initialisation d'une nouvelle WebView avec toutes ses dépendances. <br><br>  En outre, certains partenaires utilisent également WebView pour communiquer avec leur propre backend, car la bannière publicitaire sur les appareils mobiles est une descendante de la publicité sur le Web. <br><br>  Il arrive qu'après la mise à niveau, il y ait des fuites de mémoire à l'intérieur de la nouvelle bibliothèque.  Après l'apparition de l'outil Memory Graph dans Xcode, il est devenu beaucoup plus facile de trouver des fuites dans des bibliothèques tierces, de sorte que les partenaires peuvent désormais être rapidement informés à leur sujet. <br><br>  Voici le GIF de iFunny inactif lorsqu'il n'y a pas de publicité pour l'utilisateur: <br><br><img src="https://habrastorage.org/webt/oq/eg/ul/oqegulmbyh7j3zejhcmf4g_oage.gif"><br><br><h2>  Des solutions </h2><br>  Mais malgré tous les problèmes décrits ci-dessus, iFunny est stable et fait chaque jour sourire des millions de ses utilisateurs. <br><br>  Au fil des années de travail actif dans le domaine de la publicité, l'équipe de développement dispose de plusieurs outils qui permettent de surveiller avec succès les problèmes publicitaires et d'y répondre à temps. <br><br><h3>  Système d'enregistrement </h3><br>  Maintenant, le système de journalisation des exceptions dans iFunny s'est étendu à l'ensemble de l'application: pour cela, nous utilisons notre propre backend avec une base sur ClickHouse et nous affichons dans Grafana. <br><br>  Mais la première tâche pour travailler avec des journaux dans l'application était précisément l'enregistrement de situations exceptionnelles dans la publicité. <br><br>  Il existe plusieurs composants associés pour déterminer si un appel est transféré vers iFunny.  Je vais vous en dire plus sur chacun d'eux. <br><br><h4>  IFAdView </h4><br>  Il s'agit du descendant de la classe MPAdView (il est responsable de l'affichage des publicités sur MoPub). <br><br>  La méthode hitTest: withEvent est remplacée dans cette classe: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *)hitTest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)point withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *hitView = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> hitTest:point withEvent:event]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hitView) { [[IFAdsExceptionManager instance] triggerTouchView]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hitView; }</code> </pre> <br>  Ainsi, nous avons mis le déclencheur sur le fait que l'utilisateur a interagi avec la publicité. <br><br><h4>  IFURLProtocol </h4><br>  Nous héritons de NSURLProtocol et décrivons la méthode: <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)canInitWithRequest:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)request { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *wRequestURL = request.URL.absoluteString; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wRequestURL == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-appss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-apps://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itmss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"http://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"https://itunes.apple.com"</span></span>]) { [[IFAdsExceptionManager instance] adsTriggerItunesURL:wRequestURL]; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; }</code> </pre><br>  Il s'agit d'un déclencheur pour ouvrir l'AppStore à partir de l'application, nous listons toutes les URL disponibles pour cela. <br><br><h4>  IFAdsExceptionManager </h4><br>  Une classe qui collecte des déclencheurs et génère un enregistrement d'exception dans le journal. <br><br>  Pour clarifier ce que sont les déclencheurs, je décrirai chaque méthode de l'interface de cette classe. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerTouchView;       . &lt;source lang=<span class="hljs-string"><span class="hljs-string">"objectivec"</span></span>&gt;- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerItunesURL:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)itunesURL;</code> </pre> <br>  Un déclencheur qui détermine si une redirection se produit dans iTunes. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerResignActive;</code> </pre> <br>  Un déclencheur pour déterminer la perte d'activité d'une application.  Il compare les deux déclencheurs précédents. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)resetTriggers;</code> </pre> <br>  Réinitialiser les déclencheurs.  Nous l'appelons lorsque nous quittons l'arrière-plan ou lorsque nous ouvrons l'AppStore nous-mêmes, par exemple, lorsque nous envoyons l'utilisateur pour évaluer dans les anciennes versions d'iOS. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastRequestedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastLoadedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastFailedConfiguration;</code> </pre> <br>  Propriétés pour l'enregistrement des dernières annonces demandées et téléchargées avec succès ou sans succès.  Nécessaire pour former un message dans le journal. <br><br>  On peut voir que l'algorithme s'est avéré assez simple, mais efficace.  Il nous permet de suivre non seulement les découvertes automatiques de MoPub, mais aussi d'autres réseaux. <br><br>  Récemment, les annonces avec ouverture automatique ouvrent souvent SKStoreProductViewController, alors maintenant nous travaillons sur la définition de l'ouverture automatique de ce contrôleur.  L'algorithme pour définir cette exception sera un peu plus compliqué, mais Objective-C Runtime nous aidera ici. <br><br><h2>  Stand local </h2><br>  Basé sur le système de journalisation, iFunny a également commencé à développer un stand local afin de recevoir et déboguer les publicités que les utilisateurs voient en temps réel. <br><br>  Le stand se compose de: <br><br><ul><li>  agent de construction </li><li>  appareils </li><li>  suite de tests pour chaque fournisseur </li></ul><br>  L'une des solutions intéressantes utilisées sur le stand est l'IDFA à partir des plaintes des utilisateurs pour de la vraie publicité. <br><br>  Depuis environ 2016, nous avons cessé de recevoir de vraies annonces ciblant les États-Unis en utilisant uniquement des VPN, nous devons donc remplacer les appareils IDFA par des IDFA pour les vrais utilisateurs. <br><br>  Cela se fait assez facilement en utilisant le runtime Objective-C et le swizzling. <br>  Vous devez remplacer la méthode advertisingIdentifier de la classe ASIdentifierManager. <br><br>  Ici, nous le faisons à travers la catégorie: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AdsMonitorTests.customIDFA != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> swizzleIDFA]; } }); } + (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)swizzleIDFA { Class <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]; SEL originalSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(advertisingIdentifier); SEL swizzledSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(swizzled_advertisingIdentifier); Method originalMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector); Method swizzledMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector); <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> didAddMethod = class_addMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (didAddMethod) { class_replaceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method_exchangeImplementations(originalMethod, swizzledMethod); } } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - Method Swizzling - (NSUUID *)swizzled_advertisingIdentifier { NSUUID *result = AdsMonitorTests.customIDFA; return result; } @end</span></span></code> </pre><br>  La méthode décrite dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article est</a> utilisée pour transférer l'IDFA utilisateur vers la génération à partir de l'agent de génération. <br><br>  En conclusion, je tiens à dire que la bannière publicitaire fonctionne très bien aux États-Unis, et pendant sept ans de son utilisation active comme principale méthode de monétisation, iFunny a appris à bien travailler avec elle. <br><br>  Mais malgré le fait que les bannières génèrent 75% des revenus de l'entreprise, des travaux sont en cours sur les méthodes alternatives de monétisation et une certaine expérience a déjà été acquise dans la publicité native et l'utilisation d'enchères publicitaires sur le marché américain. <br><br>  En général, il y a quelque chose à dire. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426553/">https://habr.com/ru/post/fr426553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426543/index.html">Sauvegardes avec état dans Kubernetes</a></li>
<li><a href="../fr426545/index.html">Bonus Joker 2018: streaming en ligne gratuit, bofs, fête et table</a></li>
<li><a href="../fr426547/index.html">Alors que le créateur d'Android tente de sortir le premier "anti-smartphone"</a></li>
<li><a href="../fr426549/index.html">Un nouveau type de logiciel pour les chefs de produit</a></li>
<li><a href="../fr426551/index.html">Trekz Air - comment les écouteurs à conduction osseuse sonnent réellement</a></li>
<li><a href="../fr426555/index.html">PC, mais pas PC: Entretien avec le comité du programme Joker</a></li>
<li><a href="../fr426557/index.html">Les compétences les plus recherchées en science des données</a></li>
<li><a href="../fr426559/index.html">Réseaux de neurones pour le traitement d'images. Dit Alexander Savsunenko de Skylum Software</a></li>
<li><a href="../fr426561/index.html">The Great Five: doit avoir des outils pour accélérer le développement</a></li>
<li><a href="../fr426563/index.html">Carnet d'adresses hiérarchique, changement d'e-mail principal et autres innovations dans Zimbra 8.8.10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>