<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç∏ üö∞ ü§∞üèæ Comment √©conomiser de l'argent sur un th√©rapeute en utilisant le d√©veloppement pilot√© par les tests üì§ üë©üèø‚Äçüíº üí∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avez-vous d√©j√† eu cette condition? 


 Je veux vous montrer comment TDD peut am√©liorer la qualit√© du code en utilisant un exemple sp√©cifique. 
 Parce ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment √©conomiser de l'argent sur un th√©rapeute en utilisant le d√©veloppement pilot√© par les tests</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/leroy_merlin/blog/456662/">  Avez-vous d√©j√† eu cette condition? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bl/td/so/bltdsone5ewlnnqa_aamnii9rl8.jpeg" alt="image"></div><br>  Je veux vous montrer comment TDD peut am√©liorer la qualit√© du code en utilisant un exemple sp√©cifique. <br>  Parce que tout ce que j'ai rencontr√© en √©tudiant la question √©tait assez th√©orique. <br>  Il se trouve que j'ai √©crit deux applications presque identiques: l'une a √©t√© √©crite dans le style classique, car je ne connaissais pas TDD √† l'√©poque, et la seconde - en utilisant simplement TDD. <br><br>  Ci-dessous, je montrerai o√π √©taient les plus grandes diff√©rences. <br><br>  Personnellement, c'√©tait important pour moi, car chaque fois que quelqu'un trouvait un bogue dans mon code, j'attrapais un lourd inconv√©nient pour l'estime de soi.  Oui, j'ai compris que les bugs sont normaux, tout le monde les √©crit, mais le sentiment d'inf√©riorit√© n'a pas disparu.  Aussi, dans le processus d'√©volution du service, j'ai parfois r√©alis√© que j'en avais moi-m√™me √©crit un tel que √ßa me d√©mange de tout jeter et de le r√©√©crire.  Et comment cela s'est produit est incompr√©hensible.  D'une mani√®re ou d'une autre, tout allait bien au d√©but, mais apr√®s quelques fonctionnalit√©s et apr√®s un certain temps, vous ne pouvez pas regarder l'architecture sans larmes.  Bien qu'il semble que chaque √©tape du changement soit logique.  Le sentiment que je n'aimais pas le produit de mon propre travail coulait en douceur dans le sentiment que le programmeur √©tait de moi, excusez-moi, comme une balle de merde. <br><br>  Il s'est av√©r√© que je ne suis pas le seul et beaucoup de mes coll√®gues ont des sensations similaires.  Et puis j'ai d√©cid√© que soit j'apprendrais √† √©crire normalement, soit il √©tait temps de changer de m√©tier.  J'ai essay√© le d√©veloppement pilot√© par les tests dans le but de changer quelque chose dans mon approche de programmation. <br><br>  Pour l'avenir, sur la base des r√©sultats de plusieurs projets, je peux dire que TDD fournit une architecture plus propre, mais il ralentit le d√©veloppement.  Et ce n'est pas toujours adapt√© et pas pour tout le monde. <br><a name="habracut"></a><br><h1>  Qu'est-ce que TDD √† nouveau </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f39/01c/4ed/f3901c4ed2fee96d90b1a40fc30e9270.jpg" alt="image"></div><br><br>  TDD - d√©veloppement par test.  Article Wiki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br>  L'approche classique consiste √† √©crire d'abord une application, puis √† la couvrir de tests. <br><br>  Approche TDD - nous √©crivons d'abord des tests pour la classe, puis l'impl√©mentation.  Nous passons par les niveaux d'abstraction - du plus √©lev√© √† l'appliqu√©, en m√™me temps que nous divisons l'application en couches-classes √† partir desquelles nous <b>ordonnons</b> le comportement dont nous avons besoin, sans aucune impl√©mentation sp√©cifique. <br><br>  Et si je devais lire ceci pour la premi√®re fois, je ne comprendrais rien non plus. <br>  Trop de mots abstraits: regardons un exemple. <br>  Nous √©crirons une vraie application de printemps en Java, nous l'√©crirons en TDD, et j'essaierai de montrer mon processus de r√©flexion pendant le processus de d√©veloppement et finalement de tirer des conclusions sur le fait de savoir s'il est judicieux de passer du temps sur TDD ou non. <br><br><h1>  T√¢che pratique </h1><br>  Supposons que nous soyons si chanceux que nous ayons les TdR de ce que nous devons d√©velopper.  En r√®gle g√©n√©rale, les analystes ne s'en soucient pas, et cela ressemble √† ceci: <br><br>  <i>Il est n√©cessaire de d√©velopper un microservice qui calculera la possibilit√© de vendre des marchandises avec une livraison ult√©rieure au client √† domicile.</i>  <i>Les informations sur cette fonction doivent √™tre envoy√©es √† un syst√®me de donn√©es tiers.</i> <br><br>  La logique m√©tier est la suivante: un article est disponible √† la vente avec livraison si: <br><br><ul><li>  Le produit est en stock </li><li>  L'entrepreneur (par exemple, la soci√©t√© DostavchenKO) a la possibilit√© de le porter au client </li><li>  Couleur du produit - pas bleu (nous n'aimons pas le bleu) </li></ul><br>  Notre microservice sera inform√© d'un changement de la quantit√© de marchandises sur le plateau du magasin via une demande http. <br><br>  Cette notification est un d√©clencheur pour le calcul de la disponibilit√©. <br><br>  De plus, pour que la vie ne semble pas √™tre du miel: <br><br><ul><li>  L'utilisateur doit pouvoir d√©sactiver manuellement certains produits. </li><li>  Afin de ne pas spammer de DONN√âES, il vous suffit d'envoyer des donn√©es de disponibilit√© pour les produits qui ont chang√©. </li></ul><br>  Nous avons lu quelques fois TK - et c'est parti. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/10/xa/vc/10xavc46--r-thnqp--lbfzw4co.png"></div><br><br><h1>  Test d'int√©gration </h1><br>  Dans TDD, l'une des questions les plus importantes que vous devez poser √† tout ce que vous √©crivez est: "Qu'est-ce que je veux de ...?" <br><br>  Et la premi√®re question que nous posons concerne uniquement la demande dans son ensemble. <br>  La question est donc: <br><br>  <i>Que veux-je de mon microservice?</i> <br><br>  La r√©ponse est: <br><br>  En fait, beaucoup de choses.  M√™me une telle logique simple donne beaucoup d'options, une tentative d'√©criture qui, et plus encore de cr√©er des tests pour chacun d'entre eux, peut √™tre une t√¢che impossible.  Par cons√©quent, pour r√©pondre √† la question au niveau de l'application, nous ne choisirons que les principaux cas de test. <br><br>  Autrement dit, nous supposons que toutes les donn√©es d'entr√©e sont au format valide, les syst√®mes tiers r√©pondent normalement et auparavant, il n'y avait aucune information sur le produit. <br><br>  <i>Je veux donc:</i> <br><br><ul><li>  Un √©v√©nement est arriv√© o√π il n'y a aucun produit sur l'√©tag√®re.  Avertissez que la livraison n'est pas disponible. </li><li>  L'√©v√©nement est arriv√© que le produit jaune est en stock, DostavchenKO est pr√™t √† le prendre.  Avertissez de la disponibilit√© des marchandises. </li><li>  Deux messages sont venus d'affil√©e - tous deux avec une quantit√© positive de marchandises dans le magasin.  Envoy√© un seul message. </li><li>  Deux messages sont arriv√©s: dans le premier, il y a un produit dans le magasin, dans le second - il ne l'est plus.  Nous envoyons deux messages: d'abord - disponible, puis - non. </li><li>  Je peux d√©sactiver le produit manuellement et les notifications ne sont plus envoy√©es. </li><li>  ... </li></ul><br>  L'essentiel ici est de s'arr√™ter √† temps: comme je l'ai d√©j√† √©crit, il y a trop d'options, et cela n'a aucun sens de les d√©crire toutes ici - seulement les <b>plus</b> √©l√©mentaires.  √Ä l'avenir, lorsque nous r√©digerons des tests de logique m√©tier, leur combinaison couvrira probablement tout ce que nous proposons ici.  La principale motivation ici est de s'assurer que si ces tests r√©ussissent, l'application fonctionne comme nous en avons besoin. <br><br>  Toutes ces listes de souhaits, nous allons maintenant les distiller en tests.  De plus, comme il s'agit de Wishlist au niveau de l'application, nous aurons des tests pour √©lever le contexte du printemps, c'est-√†-dire assez lourd. <br>  Et cela, malheureusement, pour de nombreuses fins TDD, car pour √©crire un tel test d'int√©gration, vous avez besoin de beaucoup d'efforts que les gens ne sont pas toujours pr√™ts √† d√©penser.  Et oui, c'est l'√©tape la plus difficile, mais, croyez-moi, apr√®s l'avoir travers√©e, le code s'√©crira presque tout seul et vous serez s√ªr que votre application fonctionnera exactement comme vous le souhaitez. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/r2/hg/db/r2hgdbqezd8esoynflanwv-so8e.jpeg"></div><br>  Dans le processus de r√©ponse √† la question, vous pouvez d√©j√† commencer √† √©crire du code dans la classe initializr de spring g√©n√©r√©e.  Les noms des tests ne sont que notre liste de souhaits.  Pour l'instant, cr√©ez simplement des m√©thodes vides: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductQuantityIsZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyAvailableYellowProductIfPositiveQuantityAndDostavchenkoApproved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyOnceOnSeveralEqualProductMessages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyFirstAvailableThenNotIfProductQuantityMovedFromPositiveToZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noNotificationOnDisabledProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre> <br>  Concernant la d√©nomination des m√©thodes: je vous conseille fortement de les rendre informatives, pas test1 (), test2 (), car plus tard, lorsque vous oublierez la classe que vous avez √©crite et ce dont elle est responsable, vous aurez l'opportunit√© au lieu de essayez d'analyser directement le code, ouvrez simplement le test et lisez la m√©thode de contrat que la classe satisfait. <br><br><h2>  Commencez √† remplir les tests </h2><br>  L'id√©e principale est d'√©muler tout ce qui est externe afin de v√©rifier ce qui se passe √† l'int√©rieur. <br><br>  ¬´Externe¬ª par rapport √† notre service est tout ce qui n'est PAS le microservice lui-m√™me, mais qui communique directement avec lui. <br><br>  Dans ce cas, l'externe est: <br><br><ul><li>  Le syst√®me que notre service informera des changements dans la quantit√© de marchandises </li><li>  Client qui d√©connectera les marchandises manuellement </li><li>  Syst√®me DostavchenKO tiers </li></ul><br>  Pour √©muler les demandes des deux premiers, nous utilisons springing MockMvc. <br>  Pour √©muler DostavchenKO, nous utilisons wiremock ou MockRestServiceServer. <br><br>  En cons√©quence, notre test d'int√©gration ressemble √† ceci: <br><br><div class="spoiler">  <b class="spoiler_title">Test d'int√©gration</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureWireMock</span></span>(port = <span class="hljs-number"><span class="hljs-number">8090</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TddExampleApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MockMvc mockMvc; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ WireMock.reset(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductQuantityIsZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ stubNotification( <span class="hljs-comment"><span class="hljs-comment">// language=JSON "{\n" + " \"productId\": 111,\n" + " \"available\": false\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 111,\n" + " \"color\" : \"red\", \n" + " \"productQuantity\": 0\n" + "}"); verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyAvailableYellowProductIfPositiveQuantityAndDostavchenkoApproved() throws Exception { stubDostavchenko("112"); stubNotification( // language=JSON "{\n" + " \"productId\": 112,\n" + " \"available\": true\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 112,\n" + " \"color\" : \"Yellow\", \n" + " \"productQuantity\": 10\n" + "}"); verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyOnceOnSeveralEqualProductMessages() throws Exception { stubDostavchenko("113"); stubNotification( // language=JSON "{\n" + " \"productId\": 113,\n" + " \"available\": true\n" + "}"); for (int i = 0; i &lt; 5; i++) { performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 113,\n" + " \"color\" : \"Yellow\", \n" + " \"productQuantity\": 10\n" + "}"); } verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyFirstAvailableThenNotIfProductQuantityMovedFromPositiveToZero() throws Exception { stubDostavchenko("114"); stubNotification( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"available\": true\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": 10\n" + "}"); stubNotification( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"available\": false\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": 0\n" + "}"); verify(2, postRequestedFor(urlEqualTo("/notify"))); } @Test public void noNotificationOnDisabledProduct() throws Exception { stubNotification( // language=JSON "{\n" + " \"productId\": 115,\n" + " \"available\": false\n" + "}"); disableProduct(115); for (int i = 0; i &lt; 5; i++) { performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 115,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": " + i + "\n" + "}"); } verify(1, postRequestedFor(urlEqualTo("/notify"))); } private void disableProduct(int productId) throws Exception { mockMvc.perform( post("/disableProduct?productId=" + productId) ).andDo( print() ).andExpect( status().isOk() ); } private void performQuantityUpdateRequest(String content) throws Exception { mockMvc.perform( post("/product-quantity-update") .contentType(MediaType.APPLICATION_JSON) .content(content) ).andDo( print() ).andExpect( status().isOk() ); } private void stubNotification(String content) { stubFor(WireMock.post(urlEqualTo("/notify")) .withHeader("Content-Type", equalTo(MediaType.APPLICATION_JSON_UTF8_VALUE)) .withRequestBody(equalToJson(content)) .willReturn(aResponse().withStatus(HttpStatus.OK_200))); } private void stubDostavchenko(final String productId) { stubFor(get(urlEqualTo("/isDeliveryAvailable?productId=" + productId)) .willReturn(aResponse().withStatus(HttpStatus.OK_200).withBody("true"))); } }</span></span></code> </pre> </div></div><br><h1>  Qu'est-ce qui vient de se passer? </h1><br>  Nous avons r√©dig√© un test d'int√©gration, dont le passage nous garantit le fonctionnement du syst√®me selon les principales histoires d'utilisateurs.  Et nous l'avons fait AVANT de commencer √† mettre en ≈ìuvre le service. <br><br>  L'un des avantages de cette approche est que pendant le processus d'√©criture, je devais aller au <b>vrai</b> DostavchenKO et obtenir une <b>vraie</b> r√©ponse de l√† √† la <b>vraie</b> demande que nous avions faite dans notre talon.  C'est tr√®s bien que nous ayons pris soin de cela au tout d√©but du d√©veloppement, et pas apr√®s tout le code est √©crit.  Et ici, il s'av√®re que le format n'est pas celui sp√©cifi√© dans le mandat, ou que le service est g√©n√©ralement indisponible, ou autre chose. <br><br>  Je voudrais √©galement noter que non seulement nous n'avons pas √©crit <b>une seule</b> ligne de code qui ira plus tard au prod, mais nous n'avons m√™me pas fait <b>une seule</b> hypoth√®se sur la fa√ßon dont notre microservice sera organis√© √† l'int√©rieur: quelles couches il y aura, si nous utilisons la base, le cas √©ch√©ant, laquelle, etc. Au moment de la r√©daction du test, nous sommes abstraits de la mise en ≈ìuvre et, comme nous le verrons plus loin, cela peut donner un certain nombre d'avantages architecturaux. <br><br>  Contrairement au TDD canonique, o√π l'impl√©mentation est √©crite imm√©diatement apr√®s le test, le test d'int√©gration ne prendra pas tr√®s longtemps.  En fait, il ne deviendra vert qu'√† la toute fin du d√©veloppement, jusqu'√† ce que tout soit √©crit, y compris les fichiers. <br>  Nous allons plus loin. <br><br><h1>  Contr√¥leur </h1><br>  Apr√®s avoir √©crit le test d'int√©gration et sommes maintenant convaincus qu'apr√®s avoir r√©ussi la t√¢che, nous pouvons dormir paisiblement la nuit, il est temps de commencer √† programmer les couches.  Et la premi√®re couche que nous allons impl√©menter est le contr√¥leur.  Pourquoi exactement lui?  Parce que c'est le point d'entr√©e du programme.  Nous devons passer de haut en bas, de la toute premi√®re couche avec laquelle l'utilisateur va interagir, √† la derni√®re. <br>  C'est important. <br><br>  Et encore une fois, tout commence par la m√™me question: <br><br>  <i>Qu'est-ce que je veux du contr√¥leur?</i> <br><br>  La r√©ponse est: <br><br>  Nous savons que le contr√¥leur est engag√© dans la communication avec l'utilisateur, la validation et la conversion des donn√©es d'entr√©e et ne contient pas de logique m√©tier.  La r√©ponse √† cette question pourrait donc √™tre quelque chose comme ceci: <br><br>  <i>Je veux:</i> <br><br><ul><li>  BAD_REQUEST retourn√© √† l'utilisateur lors de la tentative de d√©connexion d'un produit avec un identifiant non valide </li><li>  BAD_REQUEST lors de la tentative de notification d'un changement de marchandise avec un identifiant non valide </li><li>  BAD_REQUEST lors de la tentative de notification d'une quantit√© n√©gative </li><li>  INTERNAL_SERVER_ERROR si DostavchenKO n'est pas disponible </li><li>  INTERNAL_SERVER_ERROR, si impossible d'envoyer √† DATA </li></ul><br>  √âtant donn√© que nous voulons √™tre conviviaux, pour tous les √©l√©ments ci-dessus, en plus du code http, vous devez afficher un message personnalis√© d√©crivant le probl√®me afin que l'utilisateur comprenne quel est le probl√®me. <br><br><ul><li>  200 si le traitement a r√©ussi </li><li>  INTERNAL_SERVER_ERROR avec un message par d√©faut dans tous les autres cas, afin de ne pas briller stackrace </li></ul><br>  Jusqu'√† ce que je commence √† √©crire sur TDD, la derni√®re chose √† laquelle je pensais √©tait ce que mon syst√®me apporterait √† l'utilisateur dans un cas sp√©cial et, √† premi√®re vue, peu probable.  Je ne pensais pas pour une raison simple - √©crire une impl√©mentation est si difficile, afin de prendre en compte absolument tous les cas marginaux, parfois il n'y a pas assez de RAM dans le cerveau.  Et apr√®s l'impl√©mentation √©crite, analyser le code pour quelque chose que vous n'auriez peut-√™tre pas envisag√© √† l'avance est toujours un plaisir: nous pensons tous que nous √©crivons le code parfait tout de suite).  Bien qu'il n'y ait pas de mise en ≈ìuvre, il n'est pas n√©cessaire d'y penser, et il n'y a aucune douleur √† le changer, si cela.  Apr√®s avoir √©crit le test en premier, vous n'avez pas √† attendre que les √©toiles convergent, et apr√®s le retrait du prod, un certain nombre de syst√®mes √©chouera et le client viendra vous voir avec une demande de r√©paration.  Et cela ne s'applique pas seulement au contr√¥leur. <br><br><h2>  Commencez √† √©crire des tests </h2><br>  Tout est clair avec les trois premiers: nous utilisons la validation de printemps, si une demande non valide arrive, l'application l√®vera une exception, que nous intercepterons dans un gestionnaire d'exceptions.  Ici, comme on dit, tout fonctionne par lui-m√™me, mais comment le contr√¥leur sait-il qu'un syst√®me tiers n'est pas disponible? <br><br>  Il est clair que le contr√¥leur lui-m√™me ne doit rien savoir des syst√®mes tiers, car  quel syst√®me demander et quelle est la logique m√©tier, c'est-√†-dire qu'il doit y avoir une sorte d'interm√©diaire.  Cet interm√©diaire est le service.  Et nous √©crirons des tests sur le contr√¥leur en utilisant la maquette de ce service, en √©mulant son comportement dans certains cas.  Ainsi, le service doit d'une mani√®re ou d'une autre informer le contr√¥leur que le syst√®me n'est pas disponible.  Vous pouvez le faire de diff√©rentes mani√®res, mais le moyen le plus simple de lancer une ex√©cution personnalis√©e.  Nous allons √©crire un test pour ce comportement de contr√¥leur. <br><br><div class="spoiler">  <b class="spoiler_title">Test d'erreur de communication avec un syst√®me de donn√©es tiers</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@WebMvcTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnServerErrorOnDataCommunicationError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataCommunicationException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( <span class="hljs-comment"><span class="hljs-comment">//language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Can't communicate with Data system\"\n" + " }\n" + " ]\n" + "}") ); } }</span></span></code> </pre><br></div></div><br>  √Ä ce stade, plusieurs choses sont apparues par elles-m√™mes: <br><br><ul><li>  Un service qui sera inject√© dans le contr√¥leur et auquel sera d√©l√©gu√© le traitement d'un message entrant pour une nouvelle quantit√© de marchandises. </li><li>  La m√©thode de ce service, et en cons√©quence sa signature, qui effectuera ce traitement. </li><li>  La r√©alisation que la m√©thode doit lancer une ex√©cution personnalis√©e lorsque le syst√®me n'est pas disponible. </li><li>  Cette ex√©cution personnalis√©e elle-m√™me. </li></ul><br>  Pourquoi par eux-m√™mes?  Parce que, comme vous vous en souvenez, nous n'avons pas encore √©crit d'impl√©mentation.  Et toutes ces entit√©s sont apparues dans le processus de programmation des tests.  Pour que le compilateur ne jure pas, en vrai code, nous devrons cr√©er tout ce qui est d√©crit ci-dessus.  Heureusement, presque n'importe quel IDE nous aidera √† g√©n√©rer les entit√©s n√©cessaires.  Ainsi, nous √©crivons en quelque sorte un test - et l'application est remplie de classes et de m√©thodes. <br><br>  Au total, les tests du contr√¥leur sont les suivants: <br><br><div class="spoiler">  <b class="spoiler_title">Les tests</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@WebMvcTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@InjectMocks</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Controller controller; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MockMvc mvc; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnBadRequestOnDisableWithInvalidProductId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mvc.perform( post(<span class="hljs-string"><span class="hljs-string">"/disableProduct?productId=-443"</span></span>) ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json(getInvalidProductIdJsonContent()) ); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnBadRequestOnNotifyWithInvalidProductId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ performUpdate( <span class="hljs-comment"><span class="hljs-comment">//language=JSON "{\n" + " \"productId\": -1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 0\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json(getInvalidProductIdJsonContent()) ); } @Test public void returnBadRequestOnNotifyWithNegativeProductQuantity() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": -10\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"productQuantity is invalid\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnServerErrorOnDostavchenkoCommunicationError() throws Exception { doThrow(new DostavchenkoException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"DostavchenKO communication exception\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnServerErrorOnDataCommunicationError() throws Exception { doThrow(new DataCommunicationException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Can't communicate with Data system\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void return200OnSuccess() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isOk() ); } @Test public void returnServerErrorOnUnexpectedException() throws Exception { doThrow(new RuntimeException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Internal Server Error\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnTwoErrorMessagesOnInvalidProductIdAndNegativeQuantity() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": -1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": -10\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " { \"message\": \"productQuantity is invalid\" },\n" + " { \"message\": \"productId is invalid\" }\n" + " ]\n" + "}") ); } private ResultActions performUpdate(String jsonContent) throws Exception { return mvc.perform( post("/product-quantity-update") .contentType(MediaType.APPLICATION_JSON_UTF8_VALUE) .content(jsonContent) ); } private String getInvalidProductIdJsonContent() { return //language=JSON "{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"productId is invalid\"\n" + " }\n" + " ]\n" + "}"; } }</span></span></code> </pre> </div></div><br>  Nous pouvons maintenant √©crire l'impl√©mentation et nous assurer que tous les tests r√©ussissent: <br><div class="spoiler">  <b class="spoiler_title">Impl√©mentation</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Validated</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/product-quantity-update"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateQuantity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestBody @Valid Update update)</span></span></span><span class="hljs-function"> </span></span>{ updateProcessorService.processUpdate(update); } <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/disableProduct"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"productId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Min</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long productId) </span></span>{ updateProcessorService.disableProduct(Long.valueOf(productId)); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Gestionnaire d'exceptions</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ControllerAdvice</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationExceptionHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(ConstraintViolationException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.BAD_REQUEST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onConstraintViolationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConstraintViolationException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"Constraint Violation"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(exception.getConstraintViolations().stream() .map(constraintViolation -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message( ((PathImpl) constraintViolation.getPropertyPath()).getLeafNode().toString() + <span class="hljs-string"><span class="hljs-string">" is invalid"</span></span>)) .collect(Collectors.toList())); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(value = MethodArgumentNotValidException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(value = HttpStatus.BAD_REQUEST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMethodArgumentNotValidException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodArgumentNotValidException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.info(exception.getMessage()); List&lt;ErrorResponse.Message&gt; fieldErrors = exception.getBindingResult().getFieldErrors().stream() .map(fieldError -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(fieldError.getField() + <span class="hljs-string"><span class="hljs-string">" is invalid"</span></span>)) .collect(Collectors.toList()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(fieldErrors); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(DostavchenkoException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDostavchenkoCommunicationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DostavchenkoException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(DataCommunicationException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDataCommunicationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataCommunicationException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(<span class="hljs-string"><span class="hljs-string">"Can't communicate with Data system"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(Exception.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"Error while processing"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(HttpStatus.INTERNAL_SERVER_ERROR.getReasonPhrase()))); } }</code> </pre> <br></div></div><br><h1>  Qu'est-ce qui vient de se passer? </h1><br>  <b>Dans TDD, vous n'avez pas besoin de garder tout le code dans votre t√™te.</b> <br><br>  Encore une fois: ne conservez pas toute l'architecture en RAM.  Regardez simplement une couche.  Il est simple. <br><br>  Dans le processus habituel, le cerveau ne suffit pas, car il existe de nombreuses impl√©mentations.  Si vous √™tes un super-h√©ros qui peut prendre en compte toutes les nuances d'un grand projet dans votre t√™te, alors TDD n'est pas n√©cessaire.  Je ne sais pas comment.  Plus le projet est grand, plus je me trompe. <br><br>  Apr√®s avoir r√©alis√© que vous ne devez comprendre que ce dont la couche suivante a besoin, l'illumination prend vie.  Le fait est que cette approche vous permet de ne pas faire de choses inutiles.  Ici tu parles avec une fille.  Elle parle d'un probl√®me au travail.  Et vous pensez comment le r√©soudre, vous vous faites des cerveaux.  Et elle n'a pas besoin de le r√©soudre, elle a juste besoin de le dire.  Et c'est tout.  Elle voulait juste partager quelque chose.  Apprendre cela √† la toute premi√®re √©tape de listen () est inestimable.  Pour tout le reste ... eh bien, vous savez. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/bk/fb/qxbkfb93hkn7folrvbn1pjd8hxm.png"></div><br><h1>  Le service </h1><br>  Ensuite, nous impl√©mentons le service. <br><br>  <i>Que voulons-nous du service?</i> <br><br>  Nous voulons qu'il traite de la logique m√©tier, c'est-√†-dire: <br><br><ol><li>  Il savait comment d√©connecter les marchandises <u>et a √©galement inform√©</u> : </li><li>  La disponibilit√©, si le produit n'est pas d√©connect√©, est en stock, la couleur du produit est jaune et DostavchenKO est pr√™t √† effectuer la livraison. </li><li>  Inaccessibilit√©, si les marchandises ne sont pas disponibles ind√©pendamment de quoi que ce soit. </li><li>  Inaccessibilit√©, si le produit est bleu. </li><li>  Inaccessibilit√© si DostavchenKO refuse de le porter. </li><li>  Inaccessibilit√© si les marchandises sont d√©connect√©es manuellement. </li><li>  Ensuite, nous voulons que le service lance l'ex√©cution si l'un des syst√®mes n'est pas disponible. </li><li>  Et aussi, afin de ne pas spammer de DONN√âES, vous devez organiser l'envoi de messages paresseux, √† savoir: </li><li>  Si nous avions l'habitude d'envoyer des marchandises disponibles pour des marchandises et que nous avons maintenant calcul√© ce qui est disponible, nous n'envoyons rien. </li><li>  Et s'il n'est pas disponible avant, mais maintenant il est disponible, nous l'envoyons. </li><li>  Et vous devez l'√©crire quelque part ... </li></ol><br>  <b>STOP!</b> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/if/ek/y1/ifeky128w2kgpc2gw2jcxwvzkia.jpeg"></div><br>  Ne pensez-vous pas que notre service commence √† faire trop? <br><br>  √Ä en juger par notre liste de souhaits, il sait comment d√©sactiver les marchandises, consid√®re l'accessibilit√© et s'assure qu'il n'envoie pas les messages pr√©c√©demment envoy√©s.  Ce n'est pas une coh√©sion √©lev√©e.  Il est n√©cessaire de d√©placer des fonctionnalit√©s h√©t√©rog√®nes dans diff√©rentes classes, et il devrait donc y avoir d√©j√† trois services: l'un traitera de la d√©connexion des marchandises, l'autre calculera la possibilit√© de livraison et la transmettra √† un service qui d√©cidera de l'envoyer ou non.  Soit dit en passant, de cette fa√ßon, le service de logique m√©tier ne saura rien du syst√®me DATA, ce qui est √©galement un avantage certain. <br><br>  D'apr√®s mon exp√©rience, assez souvent, apr√®s avoir √©t√© implant√© dans la mise en ≈ìuvre, il est facile d'oublier les moments architecturaux.  Si nous √©crivions le service tout de suite, sans penser √† ce qu'il devrait faire, et, plus important encore, qu'il ne devrait PAS, la probabilit√© de chevauchement des domaines de responsabilit√© augmenterait.  Je voudrais ajouter en mon nom que c'est cet exemple qui m'est arriv√© dans la pratique et la diff√©rence qualitative entre les r√©sultats de TDD et les approches de programmation s√©quentielle qui m'ont inspir√© pour √©crire ce billet. <br><br><h1>  Logique m√©tier </h1><br>  En pensant au service de logique m√©tier pour les m√™mes raisons qu'une forte coh√©sion, nous comprenons que nous avons besoin d'un niveau d'abstraction suppl√©mentaire entre celui-ci et le vrai DostavchenKO.  Et, puisque nous concevons le service en <b>premier</b> , nous pouvons exiger du client DostavchenKO un tel contrat interne que nous voulons.  Au cours de la r√©daction d'un test de logique m√©tier, nous comprendrons ce que nous attendons du client de la signature suivante: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAvailableForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{...}</code> </pre><br>  Au niveau du service, peu importe la r√©ponse du vrai DostavchenKO: √† l'avenir, la t√¢che du client lui permettra en quelque sorte d'obtenir ces informations.  Une fois que cela peut √™tre simple, mais il faudra parfois faire plusieurs demandes: pour le moment nous en sommes abstraits. <br><br>  Nous voulons une signature similaire d'un service qui traitera des marchandises d√©connect√©es: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProductEnabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{...}</code> </pre><br>  Ainsi, les questions ¬´Que veux-je du service de logique m√©tier?¬ª Enregistr√©es dans les tests se pr√©sentent comme suit: <br><br><div class="spoiler">  <b class="spoiler_title">Tests de service</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(MockitoJUnitRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpdateProcessorServiceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@InjectMocks</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionService manualExclusionService; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DostavchenkoClient dostavchenkoClient; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyAvailableIfYellowProductIsEnabledAndReadyForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsAbsent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(manualExclusionService); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsBlue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Blue"</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(manualExclusionService); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsDisabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsNotReadyForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span>(expected = DostavchenkoException.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwCustomExceptionIfDostavchenkoCommunicationFailed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())) .thenThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestClientException(<span class="hljs-string"><span class="hljs-string">"Something's wrong"</span></span>)); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); } }</code> </pre><br></div></div><br>      : <br><br><ul><li>  DostavchenKO  ,    </li><li> ,        ,         </li><li>       </li></ul><br> : <br><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpdateProcessorService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DostavchenkoClient dostavchenkoClient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ManualExclusionService manualExclusionService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (update.getProductQuantity() &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"Blue"</span></span>.equals(update.getColor())) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!manualExclusionService.isProductEnabled(update.getProductId())) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> availableForTransportation = dostavchenkoClient.isAvailableForTransportation(update.getProductId()); availabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(update.getProductId(), availableForTransportation)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exception) { log.warn(<span class="hljs-string"><span class="hljs-string">"Problems communicating with DostavchenKO"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DostavchenkoException(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ProductAvailability </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNotAvailableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(productId, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } }</code> </pre><br></div></div><br><h1>   </h1><br>        TDD  ‚Äî .   ,         : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId)</span></span></span></span></code> </pre> <br>          . <br><br>         : <br><br><ul><li>   . </li><li> ,   ,   ,     . </li><li> ,   ,   ,     . </li></ul><br>   ,        -  ,    : <br><br><ol><li> -,  ,      ,  -     , . .          .   , , ,      ,     .  ,              ,      ,           .      ,     ,      : ,         . </li><li> -,       .           ‚Äî   ,         .  ,  , ,       ,      ,      , . . ProductAvailability.    ,      . . .,  ,   god object,    ,        ,      ,     TDD,          ,     .   ,  , ¬´¬ª ‚Äî     : ¬´    ...¬ª     , ,  TDD,     . </li></ol><br>      : <br><br><div class="spoiler">  <b class="spoiler_title">Les tests</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManualExclusionServiceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionService service; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionRepository manualExclusionRepository; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ manualExclusionRepository.deleteAll(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Long productId = <span class="hljs-number"><span class="hljs-number">100L</span></span>; service.disableProduct(productId); assertThat(service.isProductEnabled(productId), is(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnEnabledIfProductWasNotDisabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertThat(service.isProductEnabled(<span class="hljs-number"><span class="hljs-number">100L</span></span>), is(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); assertThat(service.isProductEnabled(<span class="hljs-number"><span class="hljs-number">200L</span></span>), is(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); } }</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManualExclusionService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ManualExclusionRepository manualExclusionRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProductEnabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !manualExclusionRepository.exists(productId); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId)</span></span></span><span class="hljs-function"> </span></span>{ manualExclusionRepository.save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManualExclusion(productId)); } }</code> </pre><br></div></div><br><h1>    </h1><br> ,     ,     ,   DATA     . <br><br> ,         -, . .  ProductAvailability,     : productId  isAvailable. <br><br>        ,      : <br><br><ul><li>        . </li><li>  ,    . </li><li>   ,  . </li><li>       ,       ,  ,   . </li><li>      DATA     DataCommunicationException. </li></ul><br>    ,      : <br><br>     ,    ,  ,    ,          . <br><br>  ProductAvailability    , . .     ,  ,    .   ‚Äî          @Document (     MongoDb)     ProductAvailability. <br><br>  ,   ProductAvailability         ,      ,  ,    .            , . .      . <br><br>    . <br><br>  ,   ,         ProductAvailability,     ,       ,       ,     .   ,     ProductAvailability god object   ,      : , ,         ,     . <br><br><div class="spoiler">  <b class="spoiler_title">Les tests</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyAvailabilityNotifierTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LazyAvailabilityNotifier lazyAvailabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-meta"><span class="hljs-meta">@Qualifier</span></span>(<span class="hljs-string"><span class="hljs-string">"dataClient"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityRepository availabilityRepository; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ availabilityRepository.deleteAll(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyIfFirstTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sendNotificationAndVerifyDataBase(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyIfAvailabilityChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability oldProductAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); sendNotificationAndVerifyDataBase(oldProductAvailability); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability newProductAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); sendNotificationAndVerifyDataBase(newProductAvailability); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNotNotifyIfAvailabilityDoesNotChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability productAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); verify(availabilityNotifier, only()).notify(eq(productAvailability)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNotSaveIfSentWithException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException()).when(availabilityNotifier).notify(anyObject()); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> exceptionThrown = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { availabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RuntimeException exception) { exceptionThrown = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } assertTrue(<span class="hljs-string"><span class="hljs-string">"Exception was not thrown"</span></span>, exceptionThrown); assertThat(availabilityRepository.findAll(), hasSize(<span class="hljs-number"><span class="hljs-number">0</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span>(expected = DataCommunicationException.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapDataException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestClientException(<span class="hljs-string"><span class="hljs-string">"Something wrong"</span></span>)).when(availabilityNotifier).notify(anyObject()); lazyAvailabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendNotificationAndVerifyDataBase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ lazyAvailabilityNotifier.notify(productAvailability); verify(availabilityNotifier).notify(eq(productAvailability)); assertThat(availabilityRepository.findAll(), hasSize(<span class="hljs-number"><span class="hljs-number">1</span></span>)); assertThat(availabilityRepository.findAll().get(<span class="hljs-number"><span class="hljs-number">0</span></span>), hasProperty(<span class="hljs-string"><span class="hljs-string">"productId"</span></span>, is(productAvailability.getProductId()))); assertThat(availabilityRepository.findAll().get(<span class="hljs-number"><span class="hljs-number">0</span></span>), hasProperty(<span class="hljs-string"><span class="hljs-string">"availability"</span></span>, is(productAvailability.isAvailable()))); } }</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyAvailabilityNotifier</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AvailabilityNotifier</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityRepository availabilityRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityPersistenceObject persistedProductAvailability = availabilityRepository .findByProductId(productAvailability.getProductId()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persistedProductAvailability == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { notifyWith(productAvailability); availabilityRepository.save(createObjectFromProductAvailability(productAvailability)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persistedProductAvailability.isAvailability() != productAvailability.isAvailable()) { notifyWith(productAvailability); persistedProductAvailability.setAvailability(productAvailability.isAvailable()); availabilityRepository.save(persistedProductAvailability); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { availabilityNotifier.notify(productAvailability); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RestClientException exception) { log.error(<span class="hljs-string"><span class="hljs-string">"Couldn't notify"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataCommunicationException(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> AvailabilityPersistenceObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createObjectFromProductAvailability</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AvailabilityPersistenceObject(productAvailability.getProductId(), productAvailability.isAvailable()); } }</code> </pre> <br></div></div><br><h1>  Conclusion </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eq/cq/u-/eqcqu-xh6fu5mybs440rhhfob-g.png"></div><br>       .   ,       TDD,   ,    ,     ,         (  ,  -     ). <br><br>      ,   ,     .     ,  TDD   ,   ,  . <br><br>   ,          ,  , ,   ,     ,     . ,   ,    ¬´¬ª      ,   ,   ,   - -     ,      . <br><br>  ,     TDD      ,        ,  .      ,   ,   TDD, , -   ,    ,      TDD,          ,         . <br><br>     ,      . <br><br>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .  ,   ,      ,      ,   ,  ,      TDD   . <br><br>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ,       ,      TDD. <br><br>       ,  json.  ,  ,      json  POJO-.    IDEA,         ,    JSON. <br><br><h1>    ? </h1><br>    .    ,             ,    .    .  TDD   .     ,     .       ,      ,  .     , . .     .    . <br><br>   , TDD  ,     :      ,   ,   ,         .   ,      ,    . <br><br> TDD ‚Äî    .      ,      . ,   N ,        .   , ,    ,      .     N   .  ,  , , 1 god object   1 .     ,   TDD   :   ‚Äî    . <br><br> , ,       ‚Äî    - .    ‚Äî   .      1,5 . <br><br>   .    TDD    <i>   </i> ,  , ,   .   . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/je/ix/2n/jeix2nwpo0ui_ehjeisprshkrvk.jpeg"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr456662/">https://habr.com/ru/post/fr456662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr456650/index.html">Choisir un oscilloscope de poche √©conomique</a></li>
<li><a href="../fr456652/index.html">Le temps n'attend pas: que la chronologie de Windows 10 peut √™tre utile au criminel</a></li>
<li><a href="../fr456654/index.html">Projet ERP pas si effrayant que peint</a></li>
<li><a href="../fr456656/index.html">Le√ßons sur SDL 2: Le√ßon 4 - Etirement PNG</a></li>
<li><a href="../fr456658/index.html">Growth up: comment nous √©valuons les comp√©tences en √©quipe</a></li>
<li><a href="../fr456664/index.html">Qui poursuivre lorsqu'un robot perd votre argent</a></li>
<li><a href="../fr456666/index.html">WebTotem ou comment nous voulons rendre Internet plus s√ªr</a></li>
<li><a href="../fr456668/index.html">Microsoft ML Spark: une extension Spark qui rend SparkML plus humain et LightGBM en bonus</a></li>
<li><a href="../fr456670/index.html">√Ä propos de la m√©thode d'authentification tr√®s espion</a></li>
<li><a href="../fr456672/index.html">Recettes Nginx: notifications asynchrones de PostgreSQL vers websocket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>