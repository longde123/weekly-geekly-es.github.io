<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüè´ üë®‚Äçüëß‚Äçüë¶ üë®üèæ‚Äçüè´ HomeKit e ioBroker Vamos fazer amigos em casa üëßüèΩ ‚úãüèæ ü§º</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sem d√∫vida, o Apple iOS continua sendo um dos sistemas operacionais m√≥veis mais populares, o que significa que os sistemas de automa√ß√£o modernos devem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HomeKit e ioBroker Vamos fazer amigos em casa</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/433798/"><p><img src="https://habrastorage.org/webt/r6/5c/kp/r65ckpg2b-xatrgqefbyo7lflxa.png"></p><br><p>  Sem d√∫vida, o Apple iOS continua sendo um dos sistemas operacionais m√≥veis mais populares, o que significa que os sistemas de automa√ß√£o modernos devem poder se integrar nesse ecossistema e fornecer a capacidade de interagir.  √â exatamente para isso que a estrutura Homekit foi projetada, que permite trabalhar com dispositivos inteligentes na tela do iPhone / iPad / iWatch e, mais recentemente, no Mac (macOS Mojave). </p><br><p>  A maioria dos sistemas de automa√ß√£o (n√£o gosto do nome de marketing "casa inteligente") h√° muito tempo inclui m√≥dulos para integra√ß√£o com o Homekit, mas mesmo um usu√°rio treinado nem sempre consegue descobrir como disponibilizar seu dispositivo no aplicativo Casa (ou Eve). </p><br><p>  Hoje eu vou lhe dizer como fazer essas manipula√ß√µes no sistema ioBroker (este √© um sistema de automa√ß√£o aberto e gratuito).  Mas, para n√£o dar estupidamente todos os muitos exemplos de dispositivos, quero explicar alguns princ√≠pios e mostrar abordagens, sabendo quais voc√™ pode implementar facilmente outros exemplos. </p><br><p>  <em>"Conhecer alguns princ√≠pios compensa facilmente a ignor√¢ncia de alguns fatos."</em> <em><br></em>  <em>Claude Adrian Helvetius</em> </p><a name="habracut"></a><br><h3 id="iobroker-drayvery-ustroystva-i-sostoyaniya">  ioBroker.  Drivers, dispositivos e status </h3><br><p>  Antes de tudo, quero explicar o que √© um dispositivo no sistema ioBroker e como ele √© apresentado. </p><br><p>  Deixe-me lembr√°-lo de que o sistema ioBroker √© modular e que os m√≥dulos de extens√£o s√£o chamados de drivers (ou adaptadores).  Um driver √© um m√≥dulo de integra√ß√£o com algum dispositivo ou grupo de dispositivos, unido por uma funcionalidade, protocolo ou fabricante comum e, portanto, pode "arrastar" de um a v√°rios dispositivos para o sistema ioBroker.  Outro recurso √© a capacidade de criar v√°rias inst√¢ncias do mesmo driver, diferindo em qualquer configura√ß√£o. </p><br><p>  Mas cada dispositivo √© √∫nico e inimit√°vel, possui caracter√≠sticas e capacidades diferentes.  Com base nisso, o ioBroker se concentra principalmente n√£o no pr√≥prio dispositivo, mas em suas caracter√≠sticas, representadas por estados.  <strong>Um estado</strong> √© um objeto ioBroker interno que aceita e armazena um valor.  Os sin√¥nimos do estado podem ser considerados: sinais, atributos, caracter√≠sticas, propriedades, eventos.  Exemplos de condi√ß√µes: ‚Äútemperatura‚Äù, ‚Äún√≠vel de brilho‚Äù, ‚Äún√≠vel de bateria‚Äù, ‚Äúsinalizador de inicializa√ß√£o‚Äù, ‚Äúsinalizador de erro‚Äù, ‚Äúsinalizador de press√£o‚Äù, ‚Äúsinalizador de press√£o dupla‚Äù, etc.  Assim, cada dispositivo √© representado por muitos estados diferentes. </p><br><p><img src="https://habrastorage.org/webt/oc/mn/q_/ocmnq_d-zdyhjj7bflfxaa3dxb8.png" alt="Estrutura do Objeto" title="Estrutura do objeto"></p><br><p>  Os estados podem ser divididos em informativos - exibem informa√ß√µes do dispositivo e mut√°veis ‚Äã‚Äã- podem ser alterados pelo usu√°rio ou script e enviam essas altera√ß√µes ao dispositivo.  Assim, quando algo muda no dispositivo - esses dados s√£o exibidos nos estados e quando o estado muda do ioBroker (pelo usu√°rio ou pelo script) - o dispositivo recebe um sinal sobre a altera√ß√£o e deve responder de acordo (depende do pr√≥prio dispositivo e do driver com ele) obras). </p><br><p>  Todos os estados do dispositivo s√£o combinados em uma √∫nica √°rvore (registro) de estados.  Eles s√£o agrupados primeiro por dispositivo (em alguns casos, a canaliza√ß√£o ainda √© usada) e depois por inst√¢ncias de driver. </p><br><p>  O conceito de t√≥picos do protocolo MQTT se encaixa facilmente em uma √°rvore de estados.  Dessa forma, voc√™ pode conectar equipamentos adicionais ou sistemas de terceiros que suportam o protocolo MQTT.  √â suficiente instalar o driver MQTT - a ramifica√ß√£o correspondente aparecer√° na √°rvore de estados. </p><br><p>  E existem todos os tipos de servi√ßos on-line que podem fornecer informa√ß√µes √∫teis e / ou possibilitar o controle de outros equipamentos (alarmes de carros, por exemplo).  O resultado da intera√ß√£o com esses servi√ßos tamb√©m √© representado como um conjunto de estados. </p><br><p><img src="https://habrastorage.org/webt/xi/qk/ay/xiqkay8bgotkcb7qjhouj5-zln4.png" alt="√Årvore de estado" title="√Årvore de estado"></p><br><p>  No total, um dispositivo no ioBroker √© representado por um conjunto de estados que caracterizam o dispositivo e permitem interagir com ele. </p><br><h3 id="homekit-aksessuary-servisy-i-harakteristiki">  Homekit  Acess√≥rios, servi√ßos e especifica√ß√µes </h3><br><p>  Agora v√° para o Homekit.  Aqui √© aplicada a classifica√ß√£o dos dispositivos, sua funcionalidade e caracter√≠sticas. </p><br><p><img src="https://habrastorage.org/webt/xk/ch/8m/xkch8mdj6gv4zxw5g-kapazvuyy.png" alt="Categorias de dispositivos do kit dom√©stico" title="Categorias de dispositivos do kit dom√©stico"></p><br><p>  <strong>Acess√≥rios</strong> √© o equivalente a um dispositivo f√≠sico.  O acess√≥rio possui uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">categoria</a> para atribu√≠-lo a um grupo espec√≠fico. </p><br><p>  <strong>Servi√ßos</strong> √© o equivalente √† funcionalidade de um acess√≥rio.  Um acess√≥rio pode ter v√°rios servi√ßos. </p><br><p>  Os servi√ßos indicam os recursos do dispositivo: l√¢mpada, bateria, bot√£o, sensor de qualidade do ar, porta, filtro de ar, c√¢mera .. </p><br><p>  √â o servi√ßo que determina a exibi√ß√£o, o comportamento do dispositivo e o conjunto de caracter√≠sticas. </p><br><p>  <strong>Caracter√≠stica</strong> √© o equivalente dos atributos / propriedades que caracterizam um servi√ßo.  S√£o as caracter√≠sticas que determinam se o dispositivo est√° ligado, o n√≠vel de brilho da l√¢mpada ou quantas vezes o bot√£o √© pressionado.  Um √∫nico servi√ßo pode ter muitas caracter√≠sticas. </p><br><p><img src="https://habrastorage.org/webt/2f/rl/io/2frliotkqesh2zanlhpfiaskmaq.png" alt="Estrutura do Objeto" title="Estrutura do objeto"></p><br><p>  Os aplicativos que funcionam com o Homekit leem os servi√ßos e as caracter√≠sticas dos acess√≥rios e, em seguida, exibem e permitem alterar os valores nas caracter√≠sticas por meio da interface do usu√°rio.  Os valores alterados s√£o enviados aos dispositivos Homekit para aplic√°-los e, a partir dos dispositivos Homekit, respectivamente, tamb√©m os valores das caracter√≠sticas s√£o enviados com algumas altera√ß√µes do lado do dispositivo. </p><br><p>  No total, o dispositivo no HomeKit parece ser um acess√≥rio com um conjunto de servi√ßos e recursos. </p><br><h3 id="yahka-stykuem-koncepcii">  Yahka.  Juntamos o conceito </h3><br><p>  Para trabalhar com o Homekit, o ioBroker usa o driver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Yahka</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√≥dulos adicionais</a> devem ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instalados</a> antes da instala√ß√£o) - um complemento para uma biblioteca conhecida <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/KhaosT/HAP-NodeJS</a> , que tamb√©m cria o popular projeto HomeBridge.  Esta biblioteca foi projetada para criar um gateway / ponte virtual que fornece um conjunto de dispositivos virtuais no HomeKit.  Configurando os dispositivos e servi√ßos virtuais de acordo, definindo os valores das caracter√≠sticas, obtemos o dispositivo finalizado no Homekit e no aplicativo Home e tamb√©m podemos pedir √† Siri para gerenci√°-lo. </p><br><p>  O driver Yahka foi desenvolvido apenas para configurar acess√≥rios, adicionar servi√ßos a eles e indicar a correspond√™ncia de caracter√≠sticas (HomeKit) e estados (ioBroker). </p><br><p>  Mas primeiro, ap√≥s a instala√ß√£o, voc√™ precisa configurar o gateway e inseri-lo no aplicativo Home.  Ap√≥s a configura√ß√£o, todos os dispositivos adicionados ao gateway ser√£o automaticamente adicionados √† Casa.  Para fazer isso, especifique "Nome do dispositivo" (√© desej√°vel especificar apenas letras latinas) e lembre-se do c√≥digo PIN (ou defina seu pr√≥prio). </p><br><p><img src="https://habrastorage.org/webt/mj/b9/lf/mjb9lfsfvknvbjjmec9x0nexnns.png" alt="Configura√ß√£o do gateway" title="Configura√ß√£o do gateway"></p><br><div class="spoiler">  <b class="spoiler_title">Vamos ao aplicativo inicial e adicionamos um novo acess√≥rio.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/5k/m1/hr/5km1hrkrxh6whzmb8dn5zcvqtm4.png"><br><img src="https://habrastorage.org/webt/fo/p-/oz/fop-oz-o99nnegmciq7drkxjdyu.png"></p></div></div><br><p>  Agora vamos aos dispositivos.  Tudo ficaria bem se o conjunto de estados do dispositivo no ioBroker correspondesse claramente ao conjunto de servi√ßos e recursos do HomeKit.  E seria ainda melhor se os valores nos estados fossem adequados para os valores das caracter√≠sticas.  Mas, muitas vezes, n√£o √© assim, e voc√™ precisa criar maneiras incomuns de atracar.  Falarei sobre alguns deles abaixo, e voc√™ ter√° que implementar todas as outras op√ß√µes "√† imagem e semelhan√ßa". </p><br><p>  Por conveni√™ncia, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">criei um documento</a> com a tradu√ß√£o de servi√ßos e tipos, bem como os poss√≠veis valores das caracter√≠sticas.  Todos os tipos e servi√ßos utilizados correspondem √† <a href="">biblioteca HAP-NodeJS</a> . </p><br><h3 id="datchik-temperatury">  Sensor de temperatura </h3><br>  Este √© o exemplo mais simples - voc√™ s√≥ precisa ter um estado contendo o valor num√©rico da temperatura.  Pode ser obtido de qualquer lugar: a partir de sensores ou de servi√ßos de Internet (clima). <br><p>  Voc√™ precisa adicionar um dispositivo da categoria Sensor, adicionar o servi√ßo TemperatureSensor ao dispositivo e dar um nome a esse servi√ßo.  Existem 5 caracter√≠sticas neste servi√ßo, das quais a mais importante para n√≥s √© CurrentTemperature. </p><br><p><img src="https://habrastorage.org/webt/xn/yr/k7/xnyrk7hwwcmtwhiy_kcbub-nlms.png" alt="Term√¥metro acess√≥rio" title="Term√¥metro acess√≥rio"></p><br><p><img src="https://habrastorage.org/webt/j4/bj/bn/j4bjbnuijam7qadtoq9r9eh16ns.png" alt="Servi√ßo TemperatureSensor" title="Servi√ßo TemperatureSensor"></p><br><p>  Basta indicar o nome do estado correspondente √† temperatura na caracter√≠stica CurrentTemperature. </p><br><p>  Adicione o servi√ßo de umidade HumiditySensor aqui tamb√©m e um √≠cone de acess√≥rio separado ser√° criado no Homekit. </p><br><p><img src="https://habrastorage.org/webt/ag/na/90/agna90qhvaz84v3qutrvu4dltei.png" alt="Servi√ßo HumidadeSensor" title="Servi√ßo HumidadeSensor"></p><br><p>  Salve e pronto.  Agora voc√™ pode ligar para a Siri e perguntar sobre temperatura e umidade. </p><br><p><img src="https://habrastorage.org/webt/s4/cx/kg/s4cxkg72-7ycfuaentktjrhpdjy.png"></p><br><div class="spoiler">  <b class="spoiler_title">Conversa com Siri</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ff/p9/tt/ffp9ttfpcj3_wcbt4ztgisnwxzi.png"><br><img src="https://habrastorage.org/webt/ax/7z/1i/ax7z1ioiynurem96c3gof_2gnha.png"></p></div></div><br><h3 id="batareyka">  Bateria </h3><br><p>  Outro servi√ßo simples.  Seu truque √© que ele pode ser adicionado a praticamente qualquer acess√≥rio.  Adicione o servi√ßo BatteryService e indique na caracter√≠stica BatteryLevel um estado contendo a porcentagem de carga da bateria.  Depois disso, os dados de cobran√ßa aparecer√£o nos dados adicionais sobre o dispositivo. </p><br><p><img src="https://habrastorage.org/webt/pd/4p/ib/pd4pibwilwjymthk2g30ldqneey.png" alt="BatteryService" title="Servi√ßo de bateria"></p><br><p>  Voc√™ pode definir imediatamente o sinal de "carga baixa" (caracter√≠stica StatusLowBattery), se o valor do estado especificado for igual a 1, o √≠cone correspondente ser√° exibido na imagem do dispositivo. </p><br><p>  Mas e se voc√™ n√£o tiver esse estado, mas quiser ver o √≠cone de bateria fraca?  √â necess√°rio criar esse estado manualmente ou por um script e indicar o estado criado nas caracter√≠sticas. </p><br><p>  Agora resta apenas definir corretamente o valor verdadeiro neste estado.  Para fazer isso, usaremos o script - ele ser√° verdadeiro quando a bateria atingir 30%. </p><br><pre><code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">""</span></span>); on({<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"zigbee.0.00158d0001f41725.battery"</span></span>, <span class="hljs-attr"><span class="hljs-attr">change</span></span>: <span class="hljs-string"><span class="hljs-string">"ne"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = obj.state.val; setState(<span class="hljs-string"><span class="hljs-string">"javascript.0."</span></span>, (value &lt;= <span class="hljs-number"><span class="hljs-number">30</span></span>)); });</code> </pre> <br><p>  Ap√≥s a primeira execu√ß√£o, o script criar√° um estado e poder√° ser selecionado nas caracter√≠sticas. </p><br><p><img src="https://habrastorage.org/webt/tx/2z/6r/tx2z6r4deofbbram-k_muwaxut0.png"></p><br><p>  Este sinal ser√° exibido nas imagens de acess√≥rios </p><br><p><img src="https://habrastorage.org/webt/9o/nu/it/9onuitzmxs8exjofr7cfkwtwrqi.png"></p><br><div class="spoiler">  <b class="spoiler_title">e detalhes do dispositivo</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/fx/jg/av/fxjgavhu-spu27lskbzkmvb_dh8.png"></p></div></div><br><h3 id="lampy">  L√¢mpadas </h3><br><p>  As l√¢mpadas s√£o diferentes - brilhantes, quentes e vermelhas.  Existem 4 casos: </p><br><ul><li>  Simples - controlado por ligar e desligar </li><li>  Regul√°vel - tamb√©m controlado pelo n√≠vel de brilho </li><li>  Com a temperatura - √© poss√≠vel controlar a temperatura do brilho </li><li>  Cor - voc√™ pode controlar a cor do brilho </li></ul><br><p>  Para cada um desses casos, h√° uma caracter√≠stica correspondente no servi√ßo Lightbulb: </p><br><ul><li>  On - on / off </li><li>  Brilho - n√≠vel de brilho </li><li>  Matiz - sombra </li><li>  Satura√ß√£o - Satura√ß√£o </li><li>  ColorTemperature - temperatura da cor </li></ul><br><p>  No caso simples, na caracter√≠stica "On", indicamos o estado respons√°vel por ligar e desligar. </p><br><p><img src="https://habrastorage.org/webt/7p/2j/l2/7p2jl2cqi7q8rbw98d_ytedxwke.png"></p><br><p>  Se a l√¢mpada estiver regul√°vel, indicamos adicionalmente o status com o n√≠vel de brilho. </p><br><p><img src="https://habrastorage.org/webt/b6/da/n1/b6dan1fjltcn8sry8doex2hl6ck.png"></p><br><p>  Al√©m de atribuir estados corretos, √© importante observar o intervalo de valores aceit√°veis! </p><br><p>  Exemplo: em alguns casos, o estado respons√°vel pelo brilho da l√¢mpada pode assumir valores de 0 a 255, mas no Homekit esses valores s√£o limitados a um intervalo de 0 a 100. Nesse caso, voc√™ pode usar as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fun√ß√µes de convers√£o do</a> driver Yahka.  A fun√ß√£o "level255" apenas converte o intervalo dos valores 0..255 para o intervalo 0..100 (e vice-versa). </p><br><p>  As seguintes dificuldades podem surgir se a l√¢mpada for colorida, mas a cor usada for RGB.  Pode ser tr√™s estados diferentes ou um n√∫mero (ou sequ√™ncia).  Nesse caso, voc√™ precisar√° converter de um espa√ßo de cores RGB em outro espa√ßo XYB (esse espa√ßo √© usado pelo HomeKit) ou no plano XY. </p><br><p>  Para fazer isso, voc√™ precisa criar 2 novos estados (Matiz e Satura√ß√£o), nos quais converteremos os valores do estado RGB e vice-versa. </p><br><div class="spoiler">  <b class="spoiler_title">O script resultante para a cor √©</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//       createState("Hue"); createState("Sat"); //      RGB- on({id: "Hue", ack: false, change: 'any'}, function (obj) {  var hue = parseInt(obj.state.val);  var sat = parseInt(getState('Sat').val);  var res = hsvToRgb(hue, sat, 100);  setRGB(parseInt(res[0]), parseInt(res[1]), parseInt(res[2])); }); //    RGB- function setRGB(r, g, b){  var val = ('00'+r.toString(16)).slice(-2)+('00'+g.toString(16)).slice(-2)+('00'+b.toString(16)).slice(-2);  // RGB-   setState('zigbee.0.00124b0014d016ab.color', val, false); } //   HSV   RGB function hsvToRgb(h, s, v) {  var r, g, b;  var i;  var f, p, q, t;   h = Math.max(0, Math.min(360, h));  s = Math.max(0, Math.min(100, s));  v = Math.max(0, Math.min(100, v));  s /= 100;  v /= 100;   if(s == 0) {      r = g = b = v;      return [          Math.round(r * 255),          Math.round(g * 255),          Math.round(b * 255)      ];  }   h /= 60;  i = Math.floor(h);  f = h - i;  p = v * (1 - s);  q = v * (1 - s * f);  t = v * (1 - s * (1 - f));   switch(i) {      case 0:          r = v;          g = t;          b = p;          break;       case 1:          r = q;          g = v;          b = p;          break;       case 2:          r = p;          g = v;          b = t;          break;       case 3:          r = p;          g = q;          b = v;          break;       case 4:          r = t;          g = p;          b = v;          break;       default: // case 5:          r = v;          g = p;          b = q;  }   return [      Math.round(r * 255),      Math.round(g * 255),      Math.round(b * 255)  ]; }</span></span></code> </pre> </div></div><br><p>  A temperatura da cor pode ser mais f√°cil - se o intervalo de valores dispon√≠veis para a sua l√¢mpada for conhecido, ele poder√° ser convertido no intervalo dispon√≠vel para o HomeKit (atrav√©s da fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">scaleInt</a> ). </p><br><p><img src="https://habrastorage.org/webt/f0/vm/xh/f0vmxhpcndendf_efjf9xrmjxke.png" alt="Servi√ßo de l√¢mpadas" title="Servi√ßo de l√¢mpadas"></p><br><p><img src="https://habrastorage.org/webt/et/sp/fg/etspfg0idwn5v-cun2hh2y9xmm0.png"></p><br><div class="spoiler">  <b class="spoiler_title">Mais profundo na l√¢mpada</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/w_/q8/8p/w_q88pboeca8hl0fygtssrjegim.png"><br><img src="https://habrastorage.org/webt/bt/5c/bc/bt5cbc59jttu8ibjev1hfnnwkdm.png"></p></div></div><br><h3 id="termostat">  Termostato </h3><br><p>  Termostato - um dispositivo para manter a temperatura definida (servi√ßo Termostato).  Por conseguinte, a principal caracter√≠stica do termostato √© a temperatura desejada (TargetTemperature).  Al√©m da temperatura definida, pode ser indicada a temperatura atual (CurrentTemperature), que √© de natureza informativa (j√° que o dispositivo apenas l√™ a partir dos sensores). </p><br><p>  No aplicativo inicial, a temperatura alvo √© definida no termostato e a temperatura atual √© monitorada.  No meu termostato (Zont), havia apenas esses dois estados - eles estavam dispon√≠veis na API da nuvem de servi√ßo. </p><br><p>  Para a beleza de exibir o dispositivo no HomeKit, tive que adicionar algumas constantes: o estado atual do aquecimento est√° ativo (1), o estado-alvo do aquecimento √© autom√°tico (3). </p><br><p><img src="https://habrastorage.org/webt/vn/dd/ey/vnddeyypjlofn2jkxrqwe5ybwuw.png" alt="Servi√ßo de termostato" title="Servi√ßo de termostato"></p><br><p><img src="https://habrastorage.org/webt/pk/9u/k3/pk9uk3vfurepl1kfgow5lrp66dc.png"></p><br><div class="spoiler">  <b class="spoiler_title">Sele√ß√£o de temperatura</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/_4/g8/co/_4g8coln1rlsodscr8sah8p_h9o.png"></p></div></div><br><h3 id="vorota">  Port√µes </h3><br><p>  Com uma porta de garagem (servi√ßo GarageDoorOpener), tudo √© mais complicado do que com um termostato. </p><br><p>  Das caracter√≠sticas dispon√≠veis, o port√£o possui um estado de destino (TargetDoorState), que indica nosso desejo de que o port√£o seja "aberto" ou "fechado".  Mas voc√™ tamb√©m precisa exibir corretamente o estado atual do port√£o (CurrentDoorState): eles est√£o abertos ou fechados, ou talvez eles sejam abertos ou fechados? </p><br><p>  No meu caso, os port√µes foram abertos atrav√©s do mqtt no ioBroker com v√°rios estados de informa√ß√£o: </p><br><ul><li>  sinal de abertura do port√£o (OB) </li><li>  sinal de movimento do port√£o (LW) </li></ul><br><p><img src="https://habrastorage.org/webt/aw/b3/ip/awb3ipo5vz8qrn8jawhcfunuouc.png" alt="Estados de controle de porta de garagem" title="Estados de controle de porta de garagem"></p><br><p>  Gra√ßas a esses estados, voc√™ pode calcular o status atual do gate: </p><br><ul><li>  se n√£o houver OB nem DV, ent√£o os port√µes est√£o fechados </li><li>  se n√£o houver OB e houver um DV, os port√µes se abrir√£o </li><li>  se houver um OB e nenhum DV, os port√µes est√£o abertos </li><li>  se houver um OB e um DV, o port√£o ser√° fechado </li></ul><br><p>  Para enviar um sinal para abrir e fechar o port√£o, tenho dois estados separados (seria poss√≠vel gerenciar com um estado, mas tenho dois), que enviam uma mensagem via mqtt para o controlador de controle do port√£o: </p><br><ul><li>  sinal de abertura </li><li>  sinal de fechamento </li></ul><br><p>  Para enviar um sinal, voc√™ precisa simular um bot√£o "clique": defina o valor como true e, ap√≥s algum tempo, redefina-o como false.  Nesse sentido, para integrar com o HomeKit, foi necess√°rio criar outro estado - o "estado alvo do port√£o", quando alterado, o sinal correspondente ser√° enviado. </p><br><p>  O sinal de abertura do port√£o pode ser substitu√≠do pelo estado de destino (ou seja, qual √© o objetivo da meta): </p><br><ul><li>  se a CA estiver ‚Äúfechada‚Äù e n√£o houver DV, o port√£o estar√° fechado </li><li>  se a CA estiver "fechada" e houver um DV, os port√µes se abrir√£o </li><li>  se a autoridade de certifica√ß√£o estiver "aberta" e n√£o houver DV, o port√£o estar√° aberto </li><li>  se a autoridade de certifica√ß√£o estiver "aberta" e houver um DV, o port√£o ser√° fechado </li></ul><br><p>  Tamb√©m criaremos um estado separado "estado atual do port√£o" e o preencheremos no script, dependendo do valor dos sinais e do estado de destino. </p><br><div class="spoiler">  <b class="spoiler_title">Script de mudan√ßa de estado para portas de garagem</b> <div class="spoiler_text"><pre> <code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">"gate_0.current"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   createState("gate_0.target"); //   //    0,   300 on({id: "mqtt.0.gate.gpio.13", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.13", 0,  300); }); on({id: "mqtt.0.gate.gpio.12", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.12", 0,  300); }); //     on({id: "mqtt.0.gate.is_open", ack: false, val: 1}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 0, true); }); on({id: "mqtt.0.gate.is_open", ack: false, val: 0}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 1, true); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 0}, function (obj) {  setState("mqtt.0.gate.gpio.12", 1); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 1}, function (obj) {  setState("mqtt.0.gate.gpio.13", 1); }); on({id: "mqtt.0.gate.in_progress", ack: true, change: 'any'}, function (obj) {  //    " ",      if (obj.state.val === 1) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 2, true);      } else {          // ""          setState("javascript.0.gate_0.current", 3, true);      }  }  //    " ",      if (obj.state.val === 0) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 0, true);      } else {          // ""          setState("javascript.0.gate_0.current", 1, true);      }  } });</span></span></code> </pre> </div></div><br><p>  Depois de executar o script, voc√™ pode configurar as caracter√≠sticas do servi√ßo da porta da garagem: </p><br><p><img src="https://habrastorage.org/webt/lb/cm/t5/lbcmt51du7vnivrjbj2o_h_u28u.png" alt="Servi√ßo de abertura de garagem" title="Servi√ßo de abertura de garagem"></p><br><p><img src="https://habrastorage.org/webt/pg/rh/ey/pgrhey_qs-cxm8rg6yj_lufgmgs.png"></p><br><h3 id="kamera">  Camera </h3><br><p>  Para adicionar uma c√¢mera ao HomeKit, ser√° usado o m√©todo "cl√°ssico".  A transmiss√£o da imagem da c√¢mera atrav√©s do m√≥dulo ffmpeg √© organizada.  Por meio dele, o fluxo de entrada ser√° codificado, criptografado e entregue ao Homekit. </p><br><p>  Primeiro de tudo, voc√™ precisa instalar o ffmpeg no servidor em que o ioBroker est√° localizado. </p><br><p>  Para cada plataforma, ela √© instalada de maneiras diferentes, voc√™ pode mont√°-la a partir da fonte ou procurar uma montagem pronta, por exemplo, aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.johnvansickle.com/ffmpeg/</a> Deve ter um codificador libx264.  Voc√™ pode verificar o codificador ap√≥s instalar o ffmpeg com o comando: </p><br><pre> <code class="plaintext hljs">ffmpeg -codecs | grep 264</code> </pre> <br><p>  Os resultados devem conter uma linha do formul√°rio: </p><br><pre> <code class="plaintext hljs">DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_v4l2m2m h264_vdpau ) (encoders: libx264 libx264rgb h264_v4l2m2m )</code> </pre> <br><p>  Para o Raspberry Pi 3, voc√™ pode usar o conjunto <a href="">pronto</a> , que possui um codec com suporte para codifica√ß√£o de hardware da GPU (h264_omx, consome menos recursos).  Coloque assim: </p><br><pre> <code class="plaintext hljs">wget https://github.com/legotheboss/YouTube-files/raw/master/ffmpeg_3.1.4-1_armhf.deb sudo dpkg -i ffmpeg_3.1.4-1_armhf.deb</code> </pre> <br><p>  Os dois codecs est√£o presentes neste assembly: libx264 e h264_omx </p><br><p>  Em seguida, voc√™ precisa obter o endere√ßo do fluxo da c√¢mera que precisa ser transmitido (esta etapa est√° al√©m do escopo deste artigo).  Por exemplo, voc√™ pode usar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fluxo p√∫blico pronto</a> . </p><br><p>  Agora adicione a c√¢mera a Yahka, indique o endere√ßo do fluxo e, se necess√°rio, altere os par√¢metros do codec, tamanho da imagem e taxa de quadros. </p><br><p>  <strong>Importante: combina√ß√µes de par√¢metros s√£o muito importantes para a exibi√ß√£o correta da c√¢mera no Homekit e dependem da c√¢mera e do fluxo.</strong>  <strong>Tamb√©m afeta o desempenho do sistema, pois</strong>  <strong>O processo de execu√ß√£o do ffmpeg consome muitos recursos.</strong> </p><br><p><img src="https://habrastorage.org/webt/zh/uj/6g/zhuj6gv7alolh2nfvmpyxgmnoju.png" alt="Adicionando uma c√¢mera" title="Adicionando uma c√¢mera"></p><br><p><img src="https://habrastorage.org/webt/w7/_z/pl/w7_zplfretbtbw0v66nb9ip9ira.png" alt="Configura√ß√£o de transmiss√£o" title="Configura√ß√£o de transmiss√£o"></p><br><div class="spoiler">  <b class="spoiler_title">As c√¢meras s√£o adicionadas como dispositivos separados fora do gateway e devem ser adicionadas da mesma maneira que o gateway</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ib/8v/s9/ib8vs9ksuw5mk4ese_-gg6rnrv4.png"></p></div></div><br><p><img src="https://habrastorage.org/webt/0d/hp/qd/0dhpqdbfe_hgez4u7x2edcu92za.png" alt="Miniatura da c√¢mera" title="Miniatura da c√¢mera"></p><br><p><img src="https://habrastorage.org/webt/ue/tj/o4/uetjo4rqvi-fsae2rlkt56cmaji.png" alt="Transmiss√£o da c√¢mera" title="Transmiss√£o da c√¢mera"></p><br><h3 id="bonus">  B√¥nus </h3><br><p>  Como b√¥nus, falarei sobre o uso incomum da transmiss√£o de c√¢meras. </p><br><p>  Usando o mesmo ffmpeg, em vez da c√¢mera, voc√™ pode tentar transmitir a imagem, qualquer imagem.  Essas imagens tamb√©m podem ser combinadas com o fluxo de v√≠deo.  Voc√™ pode exibir texto, gr√°ficos e outras informa√ß√µes na imagem. </p><br><p><img src="https://habrastorage.org/webt/sg/cl/f7/sgclf7ssws1pkm_rlf3qy_avmhi.png" alt="Transposi√ß√£o de sobreposi√ß√£o de texto" title="Transposi√ß√£o de sobreposi√ß√£o de texto"></p><br><p>  Como resultado, voc√™ pode obter um painel interessante.  E se voc√™ atualizar a imagem periodicamente, obter√° dados din√¢micos. </p><br><p>  Como exemplo, eu trouxe um gr√°fico de altera√ß√µes em alguns indicadores na forma de uma imagem (arquivo em disco).  Este gr√°fico √© atualizado uma vez por minuto e substitui a imagem no arquivo. </p><br><div class="spoiler">  <b class="spoiler_title">(as fun√ß√µes createImage1, createImage2, a forma√ß√£o de um gr√°fico e a imposi√ß√£o de texto em uma imagem est√£o al√©m do escopo deste artigo, mas darei uma dica).</b> <div class="spoiler_text"><p>  Eu vou te dizer como voc√™ pode obter um gr√°fico na forma de uma imagem. </p><br><p>  O IoBroker possui uma maneira padr√£o de criar gr√°ficos - o driver Flot.  Este driver √© emparelhado com um driver da web e exibe o resultado em um navegador.  Mas, para obter o gr√°fico criado no servidor (no script) como uma imagem, √© necess√°rio um driver PhantomJS adicional, que captura uma "captura de tela" da p√°gina (na qual desenharemos um gr√°fico de Flot). </p><br><p>  Mas vou falar sobre uma maneira alternativa de criar gr√°ficos no servidor em um script. </p><br><p>  Existe uma biblioteca Chart.js <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.chartjs.org/</a> que permite desenhar gr√°ficos bonitos no navegador (exemplos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.chartjs.org/samples/latest/</a> ). </p><br><p>  Para desenhar, ele usa a ‚Äútela‚Äù (tela, tela) do navegador.  Portanto, para desenhar usando essa biblioteca no servidor, voc√™ precisa usar a vers√£o ‚Äúserver‚Äù dos objetos ‚Äúcanvas‚Äù e DOM.  √â isso que o pacote chartjs-node faz ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/vmpowerio/chartjs-node</a> ). </p><br><p>  A principal depend√™ncia desse pacote √© o pacote canvas ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/Automattic/node-canvas</a> ), que deve ser instalado globalmente (ou na pasta iobroker).  √â importante instalar todas as depend√™ncias da plataforma em que voc√™ coloca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/Automattic/node-canvas#compiling</a> . </p><br><p>  Depois disso, voc√™ pode adicionar os m√≥dulos chart.js, chartjs-node nas configura√ß√µes do driver javascript.  Eles devem instalar corretamente, sem erros.  Caso contr√°rio, lide com os erros e resolva-os. </p><br><p>  E ent√£o, voc√™ pode escrever um script. </p><br><p>  Abaixo est√° um script para um exemplo, como  inclui o uso do driver Hist√≥rico e usa nomes de estado espec√≠ficos. </p><br><p>  Aten√ß√£o!  O script tem constru√ß√µes complicadas para iniciantes - Promessa.  Essa √© uma maneira conveniente de n√£o escrever fun√ß√µes com retorno de chamada, mas criar cadeias de etapas.  Portanto, por exemplo, √© conveniente fazer isso para obter dados do hist√≥rico do estado. </p><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ChartjsNode = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'chartjs-node'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *  sendTo  Promise,      */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendToPromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter, cmd, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { sendTo(adapter, cmd, params, (result) =&gt; { resolve(result); }); }); } <span class="hljs-comment"><span class="hljs-comment">//    const chartColors = { black: 'rgb(0, 0, 0)', red: 'rgb(255, 99, 132)', orange: 'rgb(255, 159, 64)', yellow: 'rgb(255, 205, 86)', green: 'rgb(75, 192, 192)', blue: 'rgb(54, 162, 235)', purple: 'rgb(153, 102, 255)', grey: 'rgb(201, 203, 207)' }; /** *        * : * @param config -     * @param filename -     * : * @param Promise -    */ function doDraw(config, filename) { //     640x480  var chartNode = new ChartjsNode(640, 480); return chartNode.drawChart(config) .then(() =&gt; { //     return chartNode.writeImageToFile('image/png', filename); }); } /** *     ChartJS. * : * @param Promise -    */ function prepareDraw0(){ // ,    var ; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       ,      .then(()=&gt;{ //  ,   ,      = [ {"val":3,"ack":1,"ts":1539063874301}, {"val":5,"ack":1,"ts":1539063884299}, {"val":5.3,"ack":1,"ts":1539063894299}, {"val":3.39,"ack":1,"ts":1539063904301}, {"val":5.6,"ack":1,"ts":1539063914300}, {"val":-1.3,"ack":1,"ts":1539063924300}, {"val":-6.3,"ack":1,"ts":1539063934302}, {"val":1.23,"ack":1,"ts":1539063944301}, ]; }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //   label: '', //  backgroundColor: chartColors.black, borderColor: chartColors.black, //   pointRadius: 3, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, }] } } }; return chartJsOptions; }); } /** *     ChartJS. *         , *     . * * : * @param hours -  ,     * : * @param Promise -    */ function prepareDraw1(hours){ //   ,      const end = new Date().getTime(), start = end - 3600000*(hours || 1); // 1 =   //  ,       //   var , 2, 1, 2, 2; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       'mqtt.0.ESP_Easy..Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'mqtt.0.ESP_Easy..Temperature', options: { start: start, end: end, aggregate: 'onchange' } } ).then((result) =&gt; { //     ''  = result.result; }); }) //       'sonoff.0.chicken2.DS18B20_Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ //     '2' 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.sonoff_chicken_vent.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 1 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER1', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER2', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //           label: ' ('+[.length - 1].val+')', //  backgroundColor: chartColors.blue, borderColor: chartColors.blue, //  . 0 -   pointRadius: 0, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, //   Y yAxisID: 'y-axis-1', },{ label: ' 1 ('+1[1.length - 1].val+')', backgroundColor: chartColors.green, borderColor: chartColors.green, pointRadius: 0, borderWidth: 3, data: 1.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2 ('+2[2.length - 1].val+')', backgroundColor: chartColors.red, borderColor: chartColors.red, pointRadius: 0, borderWidth: 3, data: 2.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.yellow, borderColor: chartColors.yellow, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? 1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.grey, borderColor: chartColors.grey, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? -1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, //    () time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, //   -  position: 'left', //   id: 'y-axis-1', },{ type: 'linear', display: true, scaleLabel: { display: true, labelString: '  ' }, ticks: { min: -4, max: 2 }, //   -  position: 'right', id: 'y-axis-2', }] } } }; return chartJsOptions; }); } function createImage(filename, callback){ // filename -  ,       //    prepareDraw1(2) //     .then((result) =&gt; { //        return doDraw(result, filename); }) .then(()=&gt;{ if (callback) callback(); }) .catch((err)=&gt;{ console.error(err); }); }</span></span></code> </pre> </div></div><br><p><img src="https://habrastorage.org/webt/4c/d5/bs/4cd5bslfzniznrd16qfmqu0tuly.png" alt="Transmitir imagem em vez de transmitir" title="Transmitir imagem em vez de transmitir"></p><br><p>  A imagem em miniatura √© atualizada aproximadamente uma vez por minuto, portanto, definiremos a imagem para ser atualizada a cada 10 segundos: </p><br><pre> <code class="plaintext hljs">var fs = require('fs'); //  10    schedule("*/10 * * * * *", () =&gt; {  createImage1('/tmp/1_new.jpg', ()=&gt; {      fs.renameSync('/tmp/1_new.jpg', '/tmp/1.jpg');  });  createImage2('/tmp/2_new.jpg', ()=&gt; {      fs.renameSync('/tmp/2_new.jpg', '/tmp/2.jpg');  }); });</code> </pre> <br><p>  A peculiaridade √© que, no processo de transmiss√£o da imagem, √© necess√°rio substituir a imagem com rapidez suficiente para que o ffmpeg n√£o trate :) Portanto, a imagem √© formada primeiro em um arquivo e, em seguida, renomeada para a usada para tradu√ß√£o. </p><br><p>  Agora, nas configura√ß√µes da c√¢mera, especifique o nome do arquivo gerado em vez do endere√ßo do fluxo e adicione as configura√ß√µes para que a imagem seja ‚Äúatualizada‚Äù (par√¢metro ‚Äú-loop 1‚Äù).  Isso √© configurado nas propriedades avan√ßadas da c√¢mera.  Essas propriedades nada mais s√£o do que op√ß√µes de linha de comando para executar o ffmpeg.  Portanto, combina√ß√µes de par√¢metros devem ser encontradas na documenta√ß√£o e nos exemplos do ffmpeg. </p><br><p>  As propriedades s√£o divididas em 2 tipos: para receber uma "visualiza√ß√£o" (uma pequena imagem da c√¢mera) e para transmitir.  Portanto, voc√™ pode especificar arquivos de origem de imagem diferentes, por exemplo, com detalhes diferentes. </p><br><p><img src="https://habrastorage.org/webt/zy/30/b4/zy30b4wc2zud54wr-px_ezovdgu.png" alt="Op√ß√µes de inicializa√ß√£o do Ffmpeg" title="Op√ß√µes de inicializa√ß√£o do Ffmpeg"></p><br><p><img src="https://habrastorage.org/webt/mk/l5/qi/mkl5qizqb41if_youa62qrgm9hc.png" alt="Imagem de transmiss√£o ao vivo" title="Imagem de transmiss√£o ao vivo"></p><br><h3 id="zaklyuchenie">  Conclus√£o </h3><br><p>         ioBroker     .       ,       . ,   ,        . </p><br><p>  ,    Yahka       ,      Material.           ,            HomeKit. </p><br><p>       Yahka,    HomeKit     ‚Äî  Ham,     HomeBridge         .       . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433798/">https://habr.com/ru/post/pt433798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433786/index.html">Fintech Digest: criptomoeda √© propriedade, um n√∫mero recorde de cart√µes de cr√©dito foi emitido na Federa√ß√£o Russa</a></li>
<li><a href="../pt433788/index.html">Neg√≥cio Seguro e Novas Revis√µes Freelancers</a></li>
<li><a href="../pt433790/index.html">Modelos avan√ßados de constru√ß√£o em v√°rios est√°gios</a></li>
<li><a href="../pt433792/index.html">Scripts de shell no Ansible</a></li>
<li><a href="../pt433796/index.html">Como o Homo Sapiens conquistou o mundo. Habilidades de comunica√ß√£o e negocia√ß√£o</a></li>
<li><a href="../pt433800/index.html">Usando os controladores UDB PSoC da Cypress para reduzir as interrup√ß√µes em uma impressora 3D</a></li>
<li><a href="../pt433802/index.html">Como e por que vencemos a faixa de Big Data no Urban Tech Challenge Hackathon</a></li>
<li><a href="../pt433804/index.html">Redes de densidade de mistura</a></li>
<li><a href="../pt433806/index.html">Quando o arquivo online esquece</a></li>
<li><a href="../pt433808/index.html">5 erros mais comuns que os programadores cometem na entrevista</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>