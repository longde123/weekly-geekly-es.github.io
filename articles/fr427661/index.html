<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÇüèº ‚û∞ üö∑ Sportiduino - syst√®me de marquage √©lectronique pour les √©v√©nements sportifs, partie 3 üë®‚Äçüë¶ üë©üèº‚Äç‚öñÔ∏è üë®üèø‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üí Partie 1 , partie 2 

 Un an s'est √©coul√© depuis la derni√®re publication, et on me pose souvent la question de ce qui a chang√© depuis. En bref, la t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sportiduino - syst√®me de marquage √©lectronique pour les √©v√©nements sportifs, partie 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427661/">  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 2</a> <br><br>  Un an s'est √©coul√© depuis la derni√®re publication, et on me pose souvent la question de ce qui a chang√© depuis.  En bref, la transition vers les puces Ntag a √©t√© effectu√©e, de petits changements ont √©t√© apport√©s au circuit pour offrir une meilleure sensibilit√©, un volume de signal et un mouvement d'horloge corrects, et un logiciel a √©t√© cr√©√© pour fonctionner avec le syst√®me.  En g√©n√©ral, le syst√®me s'est stabilis√© et est pr√™t pour la lecture et l'utilisation.  Plus de d√©tails ci-dessous. <br><a name="habracut"></a><br>  Tout d'abord, je vais vous parler des puces RFID, pourquoi la transition a √©t√© faite vers Ntag.  Permettez-moi de vous rappeler que la m√©moire Mifare Classic 1K contient 1024 octets, dont 752 octets sont disponibles pour stocker des informations.  La structure de la m√©moire est divis√©e en 16 blocs, qui contiennent 4 pages de 16 octets, dont l'un est r√©serv√© au cryptage.  Si vous utilisez une page en tant que service, il restait 46 pages pour l'enregistrement des marques. <br><br>  Au d√©but du d√©veloppement, j'ai utilis√© la m√©moire librement - une page de 16 octets par marque, ce qui limite l'utilisation des d√©marrages de taille moyenne.  Et pour rogaining, course d'orientation touristique ou course aventure, 46 stations sont peu nombreuses.  Par cons√©quent, l'id√©e de compactage a √©t√© r√©alis√©e: deux marques ont √©t√© √©crites sur chaque page.  Dans le m√™me temps, il y avait un risque de perte de donn√©es, car l'unit√© d'enregistrement est d'une page, et lors du r√©enregistrement, vous devez lire la moiti√© d√©j√† enregistr√©e afin de la r√©√©crire.  En fait, je suis mont√© sur ce r√¢teau lors de Rogaining en novembre dernier, une petite partie des donn√©es a √©t√© perdue, j'ai d√ª beaucoup √©diter manuellement.  Et, bien qu'une erreur dans le code ait √©t√© d√©tect√©e, j'ai d√©cid√© de passer √† des puces plus volumineuses sans risque de perte de donn√©es lors de la r√©√©criture. <br><br>  L'une des options possibles consiste √† utiliser des puces Mifare 4K, dont la structure diff√®re de 1K en seulement quatre fois la grande quantit√© de m√©moire.  Mais de telles puces sont plus ch√®res et la dur√©e de nettoyage, les marques √† leur utilisation augmenteraient.  Une autre option consiste √† utiliser les puces de la s√©rie Ntag (213/215/216).  La structure de la m√©moire des puces Ntag est assez simple - la m√©moire est divis√©e en pages de 4 octets, les 4 premi√®res et 5 derni√®res pages sont r√©serv√©es au stockage des informations de service, le reste peut √™tre utilis√©.  Les puces de la s√©rie Ntag diff√®rent par la taille de la m√©moire, Ntag213 a 36 pages (144 octets) gratuitement, Ntag215 a 126 pages (504 octets) et Ntag216 a 222 pages (888 octets).  En cons√©quence, j'ai impl√©ment√© la prise en charge de toutes les puces de cette s√©rie, bien que Ntag215 puisse √™tre consid√©r√© comme optimal, dont la m√©moire est suffisante pour 120 marques, et le prix est assez bas (environ 0,2 $ par puce sous forme d'autocollant ou 0,4 $ sous forme de porte-cl√©s).  Aussi, sur les conseils de SFR, il a d√©cid√© d'abandonner le stockage des informations critiques - le num√©ro de la derni√®re page gratuite au profit de sa recherche binaire.  Cela a augment√© l'horodatage, mais a augment√© la fiabilit√©. <br><br>  La page de m√©moire Ntag contient 4 octets, dans lesquels vous devez ajuster le num√©ro de station - 1 octet et l'horodatage - 4 octets.  Le probl√®me a √©t√© r√©solu par le fait que le temps complet d'initialisation (nettoyage) de la puce est √©crit sur une page s√©par√©e, et lorsqu'il est marqu√©, seuls les 3 octets inf√©rieurs du temps.  Ensuite, lors de la lecture, le temps des rep√®res est compl√®tement restaur√© en fonction du temps d'initialisation.  Une autre page de la puce est occup√©e par le num√©ro de puce et deux sont laiss√©es en r√©serve.  La structure r√©sultante est pr√©sent√©e ci-dessous: <br><br><img src="https://habrastorage.org/webt/x4/zv/yv/x4zvyv3m8q5tmcznc__em4jcaqy.jpeg"><br><br>  L'utilisation de Ntag a permis de r√©soudre le probl√®me de l'enregistrement s√©curis√© d'un grand nombre de marques sur la puce, mais un autre probl√®me s'est pos√©.  Les puces Ntag n√©cessitent plus de puissance d'√©mission que Mifare avec la m√™me zone d'antenne, et les puces de porte-cl√©s dans lesquelles l'antenne est de l'ordre de 2 cm ^ 2 peuvent ne pas fonctionner correctement sur le module RC522 en standard.  La solution au probl√®me consistait √† souder les inductances du module √† des inductances plus puissantes.  Dans le m√™me temps, la plage de r√©ponse a augment√© de mani√®re significative, pour les puces Ntag jusqu'√† 2 cm et pour Mifare jusqu'√† 3 cm. Mais certains modules ont commenc√© √† mal fonctionner en raison de cette soudure: les puces ont √©t√© enregistr√©es uniquement avec une plage de distances certaine et plut√¥t impr√©visible de l'antenne d'√©mission.  J'ai d√ª entrer dans la biblioth√®que Arduino RC522 et y trouver le param√®tre de gain, qui est responsable de la puissance de l'antenne; le modifier pour des stations individuelles a r√©solu le probl√®me.  Il a √©galement ma√Ætris√© la fabrication manuelle de puces sur un bracelet √† partir d'autocollants.  Alibaba est d√©j√† en vente pr√™te √† l'emploi et belle, mais leur zone d'antenne est presque la moiti√© de celle, la marque passe moins stable.  Je note √©galement que j'ai quitt√© le support des puces Mifare 1K, vous pouvez travailler avec elles, mais pour cela, vous devez utiliser un firmware s√©par√©, et la capacit√© de la puce est limit√©e √† 42 marques, mais elles sont livr√©es avec des modules RC522. <br><br><img src="https://habrastorage.org/webt/d3/gm/oc/d3gmocpv7hk81ahbkk2fbddxhea.jpeg"><br><br>  Un autre probl√®me qui a d√ª √™tre r√©solu pendant le d√©veloppement √©tait le mauvais d√©roulement de l'horloge.  Dans certaines stations, l'horloge a commenc√© √† ralentir ou √† se pr√©cipiter jusqu'√† 5 minutes par jour.  Pendant longtemps, je ne pouvais pas comprendre la raison, puis j'ai d√©couvert que seules les stations avec une carte de circuit imprim√© fabriqu√©e en usine √©taient bugg√©es, alors que tout fonctionnait bien sur celles grav√©es manuellement.  J'ai pens√© √† quoi cela pouvait √™tre li√©.  Sur des pistes assez √©paisses grav√©es √† la main en raison de leur √©tamage abondant, moins de r√©sistance.  Il s'est av√©r√© que le condensateur √† la sortie du stabilisateur n'√©tait pas suffisant pour d√©coupler la puissance de l'horloge sur des pistes minces d'usine.  J'ai mis un autre condensateur pr√®s de l'horloge, et le probl√®me, pour la plupart, a √©t√© r√©solu.  Une petite partie de la montre √©choue toujours, mais j'associe d√©j√† cela au mariage de montres bon march√© avec ali, vous devez rechercher des fournisseurs fiables. <br><br>  Eh bien, le dernier changement dans le circuit est l'amplification du signal sonore.  Auparavant, le contr√¥le et la puissance du tweeter dans le circuit √©taient effectu√©s √† partir du pied du microcontr√¥leur, il √©tait donc assez limit√© en puissance.  Maintenant, la puissance passe directement des batteries, et le contr√¥le se fait par un transistor, ce qui a consid√©rablement augment√© le volume du signal.  Tous ces changements sont maintenant pris en compte et introduits dans les fichiers Gerber, mais j'ai retravaill√© manuellement une quarantaine de stations, j'ai d√ª choisir le compos√©, couper les pistes, accrocher le transistor aux fils, il y avait des stations cass√©es. <br><br><img src="https://habrastorage.org/webt/tm/n4/y9/tmn4y9n0ild0bvrr1bzh_jvoweq.jpeg"><br><br>  En raison de la transition vers d'autres puces, le micrologiciel des stations de base a d√ª √™tre consid√©rablement modifi√©, mais le principe et la logique de travail, pour la plupart, sont rest√©s les m√™mes.  Les m√™mes modes d'√©conomie d'√©nergie, sommeil, travail, r√©glage √† l'aide de puces principales.  Mais le firmware de la passerelle a √©t√© compl√®tement repens√©.  Le protocole de communication pr√©c√©dent, lorsque les donn√©es √©taient diffus√©es en continu sur un port COM dans un flux continu, semblait vuln√©rable: un octet √©tait manquant et toutes les donn√©es transform√©es en citrouille.  L'adaptation aux protocoles de transfert de donn√©es existants semblait ennuyeuse, alors il a invent√© son v√©lo. <br><br>  Les informations sont transmises et re√ßues s√©quentiellement en transmettant des paquets de 32 octets maximum.  Si les donn√©es transmises ne rentrent pas dans le paquet, la transmission est effectu√©e en retransmettant s√©quentiellement les paquets.  Le paquet commence par l'octet de d√©marrage 0xFE, suivi du num√©ro de commande, de la longueur du paquet, des donn√©es et √† la fin de la somme de contr√¥le.  Les commandes passent uniquement avec la valeur correcte de la somme de contr√¥le et des octets de d√©marrage.  Assez simple et assez fiable. <br><br><img src="https://habrastorage.org/webt/oo/cr/ma/oocrma2ibcdulbqoncpeyqqkdlm.jpeg"><br><br>  La connexion a √©t√© √©tablie, mais il a fallu √©crire un logiciel normal pour l'ordinateur, mes travaux sur le traitement n'√©taient pas adapt√©s √† cela.  Semyon Yakimov, qui a cr√©√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un module</a> Python pour travailler avec le syst√®me, l'a repris, ce dont il est tr√®s reconnaissant.  Le module vous permet de communiquer avec la passerelle, de transmettre et de recevoir des donn√©es dans un format pratique.  Apr√®s cela, j'ai ma√Ætris√© Python en premi√®re approximation et √©crit une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">application GUI</a> simple bas√©e sur ce module et PyQt, qui peut √™tre utilis√©e pour configurer le syst√®me, ainsi que pour collecter des donn√©es √† partir de puces sous la forme d'un fichier JSON.  Eh bien, les donn√©es peuvent √™tre trait√©es √† l'aide de petits scripts pour des comp√©titions avec une vari√©t√© de conditions et de r√®gles, publi√©es sous une forme pratique ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">orientation touristique</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rogaining</a> ).  Mais, de toute fa√ßon, cela implique certaines comp√©tences, et le bonheur serait incomplet sans les d√©veloppeurs du programme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SportOrg</a> , qui ont ajout√© le soutien √† Sportiduino (en plus de Sportident et SFR).  Le programme se d√©veloppe activement et beaucoup de choses sont capables de juger les d√©buts de la course d'orientation. <br><br><h3>  Conclusion </h3><br>  Ainsi, √† l'heure actuelle, il existe un mat√©riel et des logiciels stables.  Je crois que l'objectif de l'entreprise a √©t√© atteint: un syst√®me de marquage √©lectronique bon march√© est apparu.  Je ne vais rien changer dans le cadre de ce sch√©ma, sauf s'il y a une sorte de bogue.  Le syst√®me de marquage a d√©j√† √©t√© d√©velopp√© et test√© sur un grand nombre de comp√©titions diff√©rentes: course d'orientation, rogaining, lancer de marche, trail, √©tapes touristiques.  Outre moi, il est utilis√© par plusieurs personnes dans des endroits diff√©rents.  Quelqu'un a jou√© au syst√®me, quelqu'un y a fait des ajouts, par exemple, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">module radio</a> ou l'utilisation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">piles au lithium et de</a> puces <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mifare</a> comme principales. <br><br>  Le d√©veloppement est ouvert et non commercial, sous licence GNU GPLv3.  N'importe qui peut librement le copier, le reproduire, le modifier et l'utiliser.  Au cours de la derni√®re ann√©e, j'ai pos√© beaucoup de questions si je fais une vente de station.  Non, je ne veux pas faire √ßa.  D'un autre c√¥t√©, cela ne me d√©range pas si quelqu'un remplit ce cr√©neau.  Je suis seulement pr√™t √† donner des conseils de montage et d'utilisation, car tout y est assez simple. <br><br>  Le projet est disponible sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> , il y a des diagrammes localis√©s, des instructions et d'autres documents utiles.  Merci de votre attention. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427661/">https://habr.com/ru/post/fr427661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427647/index.html">Tesla (TSLA) Rapport Q3 2018</a></li>
<li><a href="../fr427649/index.html">Matrice de cuisson √† la maison</a></li>
<li><a href="../fr427653/index.html">Distribuer et conqu√©rir: mettre en page maintenant et maintenant</a></li>
<li><a href="../fr427655/index.html">Traefik en tant que contr√¥leur d'entr√©e pour K8S</a></li>
<li><a href="../fr427657/index.html">Utilisation de l'inspecteur d'animation dans les outils de d√©veloppement Chrome</a></li>
<li><a href="../fr427663/index.html">Ours Habro et crabe</a></li>
<li><a href="../fr427665/index.html">Les meilleures balances intelligentes (selon Wareable)</a></li>
<li><a href="../fr427669/index.html">KNX Home Control: √âclairage</a></li>
<li><a href="../fr427671/index.html">Sberbank et Yandex ont officiellement lanc√© la plateforme de trading Beru, la version russe d'Amazon</a></li>
<li><a href="../fr427673/index.html">Apprentissage automatique @ booking.com</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>