<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗒️ 🔷 🤣 Opsi kloning DB untuk pengembangan / pengujian 👨🏻‍🎓 🤬 🎴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya akan menjelaskan secara singkat bagaimana kloning database diatur (pembuatan beberapa contoh database dari satu cadangan) pada proyek saat ini. M...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Opsi kloning DB untuk pengembangan / pengujian</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440804/"> Saya akan menjelaskan secara singkat bagaimana kloning database diatur (pembuatan beberapa contoh database dari satu cadangan) pada proyek saat ini.  Metode ini memungkinkan menghemat waktu dan ruang hard disk. <br><br>  Situasi: ada database tebal (katakanlah, seratus GB).  Saya ingin memiliki database ini dengan semua data secara terpisah untuk setiap pengembang dan tidak menghabiskan disk terabyte di atasnya.  Berikut ini adalah solusi untuk MSSQL untuk windows menggunakan PowerShell. <br><br>  Saya menemukan utilitas Redgate SQL Clone.  Situs ini memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">deskripsi cara kerjanya</a> .  Intinya adalah menggunakan hal seperti itu: membedakan hard disk virtual.  Ini diterjemahkan ke dalam bahasa Rusia sebagai "disk virtual diferensial" - disk yang hanya menyimpan perbedaannya dengan disk "induk". <br><br>  Detail di bawah potongan <br><a name="habracut"></a><br>  Skema kerjanya adalah sebagai berikut: <br><br><ol><li>  Kami membuat dan mencolokkan disk virtual biasa (nantinya akan menjadi induknya). </li><li>  Kami membuat satu contoh basis data dari mana klon akan dibuat.  Kami membersihkan pro-data, menyiapkan basis data sepenuhnya untuk bekerja di lingkungan pengujian.  Kami menempatkan file database pada disk virtual. </li><li>  Putuskan koneksi database dari server.  Kami memutuskan koneksi disk virtual. </li><li>  Buat disk pembeda.  Kami terhubung ke sistem.  Kami menghubungkan database dari disk ini ke server sql. </li><li>  Ulangi langkah 4 hingga jumlah database yang harmonis tercapai. </li></ol><br>  Membuat disk induk tidak akan dijelaskan, karena  ini dapat dilakukan secara manual melalui antarmuka grafis manajemen disk.  Nah, atau perintah google dan melengkapi skrip yang diberikan dalam artikel. <br><br>  Catat waktu: <br><br>  Di windows 10 dan windows server 2016 ada powershell commandlet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">New-VHD</a> .  Bagi mereka yang menggunakan versi server sebelumnya ada utilitas diskpart.  Mengotomatiskan bekerja dengannya sangat tidak nyaman, karena  pada input, ia menerima file dengan perintah untuk dieksekusi. <br><br>  Catatan dua: <br><br>  Karena  Karena file database ditempatkan pada disk yang berbeda, kinerja solusi semacam itu masih jauh dari sempurna.  Ternyata beberapa tingkat tipuan: catatan masuk ke database, yang terletak pada disk virtual yang menyimpan perbedaan di rumah yang dibangun Jack.  Saya tidak punya nomor kinerja tertentu (karena di sirkuit pengujian kami ini bukan pertanyaan pertama).  Saya akan berterima kasih jika seseorang mengukur seberapa banyak kecepatan menulis / membaca terkuras. <br><br>  Perhatikan tiga: <br><br>  Karena  skrip tidak dimaksudkan untuk digunakan secara luas dan disediakan hanya sebagai contoh, ada peningkatan kelengkungan dan pengikatan yang ketat pada MSSQL. <br><br><div class="spoiler">  <b class="spoiler_title">Kami akan menginisialisasi beberapa variabel:</b> <div class="spoiler_text"><pre><code class="plaintext hljs">$server = "server"; $db_file_name = "db_file_name"; $root_path = "path to folder with disks"; $cred = try { Get-StoredCredential -Target "$server\Administrator"; } catch { Get-Credential -Message "server windows user" -UserName "$server\Administrator" } $db_cred = $(try { Get-StoredCredential -Target "$server\sa"; } catch { Get-Credential -Message "sql server user" -UserName "sa" }).GetNetworkCredential(); $session = New-PSSession -ComputerName $server -Credential $cred;</code> </pre> <br></div></div><br>  Karena  skrip dijalankan pada mesin pengembang, dan semua tindakan dilakukan pada mesin dengan server sql, diasumsikan bahwa PowerShell Remoting dikonfigurasi.  Semua perintah dieksekusi dalam sesi terbuka. <br><br>  Get-StoredCredential adalah commandlet untuk menyimpan kredensial pada mesin lokal (diinstal secara terpisah).  Pada prinsipnya, Anda dapat melakukannya tanpanya, itulah sebabnya ia dibungkus dengan try / catch. <br><br><div class="spoiler">  <b class="spoiler_title">Berikut ini adalah kode eksekusi skrip diskpart:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">function run_script([string]$script, [bool]$suppress_output = $false) { $result = Invoke-Command -Session $session -ArgumentList $script -ScriptBlock { param($script) $script.Split("`r`n") | % { Write-Host $_.Trim() }; Out-File -FilePath "tmp" -InputObject $script -Encoding ascii return diskpart /s "tmp" } if($suppress_output) { return $result; } else { $result | ? { !$_.Contains("Microsoft") -and $_ -ne "" } | Write-Host } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Perintah Sql yang saya jalankan melalui SQLCMD:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">function run_sql([string]$sql) { Write-Host $sql SQLCMD -S $server -d master -U $($db_cred.UserName) -P $($db_cred.Password) -Q $sql }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Membuat disk pembeda:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> run_script "create vdisk file=`"$root_path\$name.vhdx`" parent=`"$root_path\parent_disk.vhdx`""</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Selanjutnya, hubungkan disk dan basis data:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> $disk_letter = Invoke-Command -Session $session -ScriptBlock { ls function:[dz]: -n | ?{ !(test-path $_) } | select -Last 1; } $volumes = run_script "list volume" $true $disks = run_script "list disk" $true $script = " sel vdisk file=`"$current_path\$db_name.vhdx`" attach vdisk"; run_script $script; $disks_after = run_script "list disk" $true $new_disk = $($disks_after | ? { $_ -notin $disks } ) Write-Host $new_disk $new_disk -match "\d+" $diskId = $Matches[0] $script = " select disk $diskId online disk"; run_script $script $volumes_after = run_script "list volume" $true # get added disk $new_volume = $($volumes_after | ? { $_ -notin $volumes } ) Write-Host $new_volume $new_volume -match "\d+" $volumeId = $Matches[0] $script = " select volume $volumeId assign letter=$disk_letter"; run_script $script run_script "list volume"; run_script "list vdisk"; $atach_script = "CREATE DATABASE $db_name ON (FILENAME = '$disk_letter\$db_file_name.mdf'),(FILENAME = '$disk_letter\$db_file_name.ldf') FOR ATTACH"; run_sql "$atach_script"</code> </pre><br></div></div><br>  Sepotong "fungsi ls: [dz]: -n" hanyalah semacam sihir untuk mendapatkan daftar huruf drive.  Cara kerjanya - tidak tahu, disalin dari stackoverflow. <br><br>  Dalam kode di atas, kesulitan terbesar adalah untuk mendapatkan disk virtual yang dihasilkan dan menaruhnya di surat tertentu.  Dia juga perlu melakukan online sebelumnya. <br><br><div class="spoiler">  <b class="spoiler_title">Melepaskan drive sedikit lebih mudah:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> run_sql " ALTER DATABASE $name SET OFFLINE WITH ROLLBACK IMMEDIATE GO sp_detach_db $name"; $script = "select vdisk file=`"$root_path\$name.vhdx`" detach vdisk "; run_script $script</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Menyatukan semuanya:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">param( [ValidateSet("detach_all", "attach_all_available", "create_new", "attach_db", "detach_db", "remove_file")][Parameter(mandatory=$true)][string] $mode, [string] $name ) function run_sql([string]$sql) { Write-Host $sql SQLCMD -S $server -d master -U $($db_cred.UserName) -P $($db_cred.Password) -Q $sql } function run_script([string]$script, [bool]$suppress_output = $false) { $result = Invoke-Command -Session $session -ArgumentList $script -ScriptBlock { param($script) $script.Split("`r`n") | % { Write-Host $_.Trim() }; Out-File -FilePath "tmp" -InputObject $script -Encoding ascii return diskpart /s "tmp" } if($suppress_output) { return $result; } else { $result | ? { !$_.Contains("Microsoft") -and $_ -ne "" } | Write-Host } } function attach_disk([string]$db_name, [string]$current_path) { $disk_letter = Invoke-Command -Session $session -ScriptBlock { ls function:[dz]: -n | ?{ !(test-path $_) } | select -Last 1; } $volumes = run_script "list volume" $true $disks = run_script "list disk" $true $script = " sel vdisk file=`"$current_path\$db_name.vhdx`" attach vdisk"; run_script $script; $disks_after = run_script "list disk" $true $new_disk = $($disks_after | ? { $_ -notin $disks } ) Write-Host $new_disk $new_disk -match "\d+" $diskId = $Matches[0] $script = " select disk $diskId online disk"; run_script $script $volumes_after = run_script "list volume" $true # get added disk $new_volume = $($volumes_after | ? { $_ -notin $volumes } ) Write-Host $new_volume $new_volume -match "\d+" $volumeId = $Matches[0] $script = " select volume $volumeId assign letter=$disk_letter"; run_script $script run_script "list volume"; run_script "list vdisk"; $atach_script = "CREATE DATABASE $db_name ON (FILENAME = '$disk_letter\$db_file_name.mdf'),(FILENAME = '$disk_letter\$db_file_name.ldf') FOR ATTACH"; run_sql "$atach_script" } $server = "server"; $db_file_name = "db_file_name"; $cred = try { Get-StoredCredential -Target "$server\Administrator"; } catch { Get-Credential -Message "server windows user" -UserName "$server\Administrator" } $db_cred = $(try { Get-StoredCredential -Target "$server\sa"; } catch { Get-Credential -Message "sql server user" -UserName "sa" }).GetNetworkCredential(); $session = New-PSSession -ComputerName $server -Credential $cred; $root_path = "path to folder with disks"; $files = Invoke-Command -Session $session -ArgumentList $root_path -ScriptBlock { param($root_path) Get-ChildItem -Filter "*.vhdx" -Path $root_path } switch ($mode) { "detach_all" { $files ` | % { Write-Host $("*"*40) `r`n $_.FullName `r`n; $_ } ` | % { " ALTER DATABASE $($_.Name.Replace('.vhdx', '')) SET OFFLINE WITH ROLLBACK IMMEDIATE GO sp_detach_db $($_.Name.Replace('.vhdx', ''))" } ` | % { run_sql "$_" } $files ` | % { Write-Host $("*"*40) `r`n $_.FullName `r`n; $_ } ` | % { run_script "select vdisk file=`"$($_.FullName)`" detach vdisk " } break; } "attach_all_available" { $files | % { $_.Name.Replace('.vhdx', '') } | ? { $_ -ne "parent_disk" } | % { attach_disk $_ $root_path } break; } "attach_db" { attach_disk $name $root_path break; } "detach_db" { run_sql " ALTER DATABASE $name SET OFFLINE WITH ROLLBACK IMMEDIATE GO sp_detach_db $name"; $script = "select vdisk file=`"$root_path\$name.vhdx`" detach vdisk "; run_script $script break; } "create_new" { $script = "create vdisk file=`"$root_path\$name.vhdx`" parent=`"$root_path\parent_disk.vhdx`"" run_script $script attach_disk $name $root_path; break; } "remove_file" { Invoke-Command -Session $session -ArgumentList $name,$root_path -ScriptBlock { param($name, $root_path) Remove-Item -Path "$root_path\$name.vhdx" } } } Remove-PSSession $session</code> </pre><br></div></div><br>  Kali Achtung: <br><br>  Jika Anda me-reboot server, maka Anda tersiksa untuk menjelaskan kepada server sql bahwa database ini tidak ada, dan Anda harus menyambungkan kembali. <br><br>  Achtung dua: <br><br>  Penulis, tentu saja, memeriksa perintah di sirkuit pengujiannya, tetapi tidak bermaksud untuk menjamin apa pun (terutama kinerjanya).  Dengan risiko Anda sendiri. <br><br>  Total: <br><br>  Meluncurkan basis data pengujian tambahan membutuhkan beberapa menit dan 40MB pada disk.  Dengan demikian, jauh lebih nyaman bagi setiap pengembang untuk mengatur instance database mereka sendiri. <br><br>  Opsional: <br><br>  Script yang sama dapat digunakan untuk meningkatkan database untuk tes integrasi. <br><br>  Semoga bermanfaat bagi seseorang. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id440804/">https://habr.com/ru/post/id440804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id440792/index.html">Efek penyaringan SVG. Bagian 5. Mencocokkan teks dengan tekstur permukaan dengan feDisplacementMap</a></li>
<li><a href="../id440794/index.html">Konferensi DEFCON 19. Tiga generasi serangan DoS (melibatkan penonton sebagai korban). Bagian 1</a></li>
<li><a href="../id440796/index.html">Konferensi DEFCON 19. Tiga generasi serangan DoS (melibatkan penonton sebagai korban). Bagian 2</a></li>
<li><a href="../id440800/index.html">Kali Linux 2019.1 dirilis</a></li>
<li><a href="../id440802/index.html">WearMouse, mouse udara untuk jam tangan Wear OS</a></li>
<li><a href="../id440806/index.html">Dark Mobile on CodeFest: fungsional Swift, kesalahpahaman, Clean Architecture, dan #Of courseZheKotlin</a></li>
<li><a href="../id440808/index.html">TDE di Apache Ignite: Kisah Fitur Utama dalam Proyek Open Source Besar</a></li>
<li><a href="../id440810/index.html">Talos - “Distribusi Linux Modern untuk Kubernetes” Diperkenalkan</a></li>
<li><a href="../id440814/index.html">Sovereign LPWAN, Bagian 1: Perizinan dan Operasi Jaringan LPWAN di Rusia - Persyaratan Negara Baru Lama</a></li>
<li><a href="../id440816/index.html">Git dan pengembangan tim (untuk boneka)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>