<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÄ üë®üèª‚Äçüíª üçØ RxJava para Coroutines: migra√ß√£o de recursos de ponta a ponta üí¥ üëåüèª üñ®Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(publicado originalmente no Medium ) 

 As corotinas Kotlin s√£o muito mais do que apenas threads leves - s√£o um novo paradigma que ajuda os desenvolve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RxJava para Coroutines: migra√ß√£o de recursos de ponta a ponta</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483832/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/jb/id/pq/jbidpqpivwqpagw9azop_fswram.png" alt="imagem"></div><br>  (publicado originalmente no <a href="https://link.medium.com/OJ7ed2RCd3" rel="nofollow">Medium</a> ) <br><br>  As corotinas Kotlin s√£o muito mais do que apenas threads leves - s√£o um novo paradigma que ajuda os desenvolvedores a lidar com a simultaneidade de maneira <a href="https://medium.com/%40elizarov/structured-concurrency-722d765aa952" rel="nofollow">estruturada</a> e idiom√°tica. <br><br>  Ao desenvolver um aplicativo Android, deve-se considerar muitas coisas diferentes: remover opera√ß√µes de longa execu√ß√£o do thread da interface do usu√°rio, manipular eventos do ciclo de vida, cancelar assinaturas, retornar ao thread da interface do usu√°rio para atualizar a interface do usu√°rio.  Nos √∫ltimos dois anos, o RxJava se tornou uma das estruturas mais usadas para resolver esse conjunto de problemas.  Neste artigo, vou orient√°-lo na migra√ß√£o de recursos de ponta a ponta do RxJava para as corotinas. <br><a name="habracut"></a><br><h4>  Recurso </h4><br>  O recurso que vamos converter em corotinas √© bastante simples: quando o usu√°rio envia um pa√≠s, fazemos uma chamada de API para verificar se o pa√≠s est√° qualificado para uma pesquisa de detalhes de neg√≥cios por meio de um provedor como o <a href="https://www.gov.uk/government/organisations/companies-house" rel="nofollow">Companies House</a> .  Se a chamada foi bem-sucedida, mostramos a resposta, se n√£o - a mensagem de erro. <br><br><h4>  Migra√ß√£o </h4><br><img src="https://habrastorage.org/webt/j0/0h/kg/j00hkgwjgnuwnzz4lsgdf5ry_fa.png" align="left"><br>  Vamos migrar nosso c√≥digo em uma abordagem de baixo para cima, come√ßando com o servi√ßo Retrofit, passando para uma camada Repository, depois para uma camada Interactor e, finalmente, para um ViewModel. <br><br>  As fun√ß√µes que retornam atualmente Single devem se tornar fun√ß√µes de suspens√£o e as fun√ß√µes que retornam Observable devem retornar Flow.  Neste exemplo em particular, n√£o faremos nada com o Flows. <br><br><h4>  Servi√ßo de moderniza√ß√£o </h4><br>  Vamos pular direto para o c√≥digo e refatorar o m√©todo businessLookupEligibility no BusinessLookupService para as rotinas.  √â assim que parece agora. <br><br><pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"v1/eligibility"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"countryCode"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: Single&lt;NetworkResponse&lt;BusinessLookupEligibilityResponse, ErrorResponse&gt;&gt; }</code> </pre> <br>  Etapas de refatora√ß√£o: <br><br><ol><li>  A partir da <a href="" rel="nofollow">vers√£o 2.6.0, o</a> Retrofit suporta o modificador de suspens√£o.  Vamos transformar o m√©todo businessLookupEligibility em uma fun√ß√£o de suspens√£o. </li><li>  Remova o inv√≥lucro √∫nico do tipo de retorno. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"v1/eligibility"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"countryCode"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: NetworkResponse&lt;BusinessLookupEligibilityResponse, ErrorResponse&gt; }</code> </pre><br>  NetworkResponse √© uma classe selada que representa BusinessLookupEligibilityResponse ou ErrorResponse.  O NetworkResponse √© constru√≠do em um adaptador de chamada Retrofit personalizado.  Dessa maneira, restringimos o fluxo de dados a apenas dois casos poss√≠veis - sucesso ou erro, para que os clientes do BusinessLookupService n√£o precisem se preocupar com o tratamento de exce√ß√µes. <br><br><h4>  Reposit√≥rio </h4><br>  Vamos seguir em frente e ver o que temos no BusinessLookupRepository.  No corpo do m√©todo businessLookupEligibility, chamamos businessLookupService.businessLookupEligibility (aquele que acabamos de refatorar) e usamos o operador de mapa de RxJava para transformar NetworkResponse em um modelo de resposta Result e mapear para modelo de dom√≠nio.  Resultado √© outra classe selada que representa Result.Success e cont√©m o objeto BusinessLookupEligibility, caso a chamada de rede tenha sido bem-sucedida.  Se houve um erro na chamada de rede, uma exce√ß√£o de desserializa√ß√£o ou outra coisa deu errado, criamos Result.Failure com uma mensagem de erro significativa (ErrorMessage √© <a href="https://kotlinlang.org/docs/reference/type-aliases.html" rel="nofollow">tipealias</a> para String). <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupService: BusinessLookupService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupApiToDomainMapper: BusinessLookupApiToDomainMapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> responseToString: Mapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> schedulerProvider: SchedulerProvider ) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Result&lt;BusinessLookupEligibility, ErrorMessage&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> businessLookupService.businessLookupEligibility(countryCode) .map { response -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-symbol"><span class="hljs-symbol">@map</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (response) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Success -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibility = businessLookupApiToDomainMapper.map(response.body) Result.Success&lt;BusinessLookupEligibility, ErrorMessage&gt;(businessLookupEligibility) } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Error -&gt; Result.Failure&lt;BusinessLookupEligibility, ErrorMessage&gt;( responseToString.transform(response) ) } }.subscribeOn(schedulerProvider.io()) } }</code> </pre><br>  Etapas de refatora√ß√£o: <br><br><ol><li>  businessLookupEligibility se torna uma fun√ß√£o de suspens√£o. </li><li>  Remova o inv√≥lucro √∫nico do tipo de retorno. </li><li>  Os m√©todos no reposit√≥rio geralmente executam tarefas de longa execu√ß√£o, como chamadas de rede ou consultas de banco de dados.  √â de responsabilidade do reposit√≥rio especificar em qual thread esse trabalho deve ser realizado.  Por subscribeOn (schedulerProvider.io ()), estamos dizendo ao RxJava que o trabalho deve ser feito no encadeamento io.  Como o mesmo pode ser alcan√ßado com as corotinas?  Vamos usar o withContext com um expedidor espec√≠fico para mudar a execu√ß√£o do bloco para o encadeamento diferente e retornar ao expedidor original quando a execu√ß√£o for conclu√≠da.  √â uma boa pr√°tica garantir que uma fun√ß√£o seja principalmente segura usando withContext.  Os consumidores do BusinessLookupRepository n√£o devem pensar em qual thread eles devem usar para executar o m√©todo businessLookupEligibility; deve ser seguro cham√°-lo no thread principal. </li><li>  N√£o precisamos mais do operador de mapa, pois podemos usar o resultado de businessLookupService.businessLookupEligibility no corpo de uma fun√ß√£o de suspens√£o. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupService: BusinessLookupService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupApiToDomainMapper: BusinessLookupApiToDomainMapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> responseToString: Mapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dispatcherProvider: DispatcherProvider ) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Result&lt;BusinessLookupEligibility, ErrorMessage&gt; = withContext(dispatcherProvider.io) { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response = businessLookupService.businessLookupEligibility(countryCode)) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Success -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibility = businessLookupApiToDomainMapper.map(response.body) Result.Success&lt;BusinessLookupEligibility, ErrorMessage&gt;(businessLookupEligibility) } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Error -&gt; Result.Failure&lt;BusinessLookupEligibility, ErrorMessage&gt;( responseToString.transform(response) ) } } }</code> </pre><br><h4>  Interactractor </h4><br>  Neste exemplo espec√≠fico, BusinessLookupEligibilityInteractor n√£o cont√©m nenhuma l√≥gica adicional e serve como um proxy para BusinessLookupRepository.  Usamos a <a href="https://kotlinlang.org/docs/reference/operator-overloading.html" rel="nofollow">sobrecarga do operador de</a> chamada para que o interator possa ser chamado como uma fun√ß√£o. <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupEligibilityInteractor</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupRepository: BusinessLookupRepository ) { <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Result&lt;BusinessLookupEligibility, ErrorMessage&gt;&gt; = businessLookupRepository.businessLookupEligibility(countryCode) }</code> </pre><br>  Etapas de refatora√ß√£o: <br><br><ol><li>  operador divertido chamar torna-se suspender operador divertido chamar. </li><li>  Remova o inv√≥lucro √∫nico do tipo de retorno. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupEligibilityInteractor</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupRepository: BusinessLookupRepository ) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Result&lt;BusinessLookupEligibility, ErrorMessage&gt; = businessLookupRepository.businessLookupEligibility(countryCode) }</code> </pre><br><h4>  ViewModel </h4><br>  Em BusinessProfileViewModel, chamamos BusinessLookupEligibilityInteractor que retorna Single.  Assinamos o fluxo e o observamos no thread da interface do usu√°rio, especificando o agendador da interface do usu√°rio.  No caso de Success, atribu√≠mos o valor de um modelo de dom√≠nio a um businessViewState LiveData.  Em caso de falha, atribu√≠mos uma mensagem de erro. <br><br>  Adicionamos todas as assinaturas a um CompositeDisposable e as descartamos no m√©todo onCleared () do ciclo de vida de um ViewModel. <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessProfileViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibilityInteractor: BusinessLookupEligibilityInteractor, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> schedulerProvider: SchedulerProvider ) : ViewModel() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> disposables = CompositeDisposable() <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessViewState: MutableLiveData&lt;ViewState&gt; = LiveDataFactory.createDefault(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCountrySubmit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(country: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Country</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { disposables.add(businessLookupEligibilityInteractor(country.countryCode) .observeOn(schedulerProvider.ui()) .subscribe { state -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-symbol"><span class="hljs-symbol">@subscribe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Success -&gt; businessViewState.value = state.entity.provider <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Failure -&gt; businessViewState.value = state.failure } }) } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void onCleared() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCleared(); disposables.clear(); } }</code> </pre><br>  Etapas de refatora√ß√£o: <br><br><ol><li>  No come√ßo do artigo, mencionei uma das principais vantagens das corotinas - concorr√™ncia estruturada.  E √© aqui que entra em jogo.  Toda corotina tem um escopo.  O escopo tem controle sobre uma rotina por meio de seu trabalho.  Se um trabalho for cancelado, todas as corotinas no escopo correspondente tamb√©m ser√£o canceladas.  Voc√™ pode criar seus pr√≥prios escopos, mas, neste caso, vamos alavancar o viewModel com reconhecimento do ciclo de vida do ViewModel.  Iniciaremos uma nova rotina em um viewModelScope usando viewModelScope.launch.  A corotina ser√° iniciada no encadeamento principal, pois o viewModelScope possui um expedidor padr√£o - Dispatchers.Main.  Uma corrotina iniciada em Dispatchers.O Main n√£o bloquear√° o encadeamento principal enquanto estiver suspenso.  Como acabamos de lan√ßar uma rotina, podemos chamar o operador de suspens√£o businessLookupEligibilityInteractor e obter o resultado.  businessLookupEligibilityInteractor chama BusinessLookupRepository.businessLookupEligibility o que muda a execu√ß√£o para Dispatchers.IO e volta para Dispatchers.Main.  Como estamos no encadeamento da interface do usu√°rio, podemos atualizar o businessViewState LiveData atribuindo um valor. </li><li>  Podemos nos livrar dos descart√°veis, pois o viewModelScope est√° vinculado a um ciclo de vida do ViewModel.  Qualquer corrotina iniciada neste escopo √© automaticamente cancelada se o ViewModel for limpo. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessProfileViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibilityInteractor: BusinessLookupEligibilityInteractor ) : ViewModel() { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessViewState: MutableLiveData&lt;ViewState&gt; = LiveDataFactory.createDefault(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCountrySubmit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(country: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Country</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { viewModelScope.launch { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> state = businessLookupEligibilityInteractor(country.countryCode)) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Success -&gt; businessViewState.value = state.entity.provider <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Failure -&gt; businessViewState.value = state.failure } } } }</code> </pre><br><h4>  Principais t√≥picos </h4><br>  Ler e entender c√≥digos escritos com corotinas √© bastante f√°cil, no entanto, √© uma mudan√ßa de paradigma que exige algum esfor√ßo para aprender a abordar a escrita de c√≥digos com corotinas. <br><br>  Neste artigo, n√£o cobri teste.  Eu usei a biblioteca <a href="https://mockk.io/" rel="nofollow">mockk</a> porque tinha problemas ao testar corotinas usando o Mockito. <br><br>  Tudo o que escrevi com o Rx Java achei bastante f√°cil de implementar com corotinas, <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html" rel="nofollow">fluxos</a> e <a href="https://kotlinlang.org/docs/reference/coroutines/channels.html" rel="nofollow">canais</a> .  Uma das vantagens das corotinas √© que elas s√£o um recurso da linguagem Kotlin e est√£o evoluindo junto com a linguagem. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt483832/">https://habr.com/ru/post/pt483832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt483818/index.html">Mecanismo, linguagem de script e romance visual - em 45 horas</a></li>
<li><a href="../pt483820/index.html">O que afeta a emiss√£o de cr√©dito. Vis√£o geral da competi√ß√£o de risco padr√£o de cr√©dito residencial</a></li>
<li><a href="../pt483822/index.html">5 recursos de JavaScript sem os quais n√£o consegui escrever c√≥digo</a></li>
<li><a href="../pt483824/index.html">Como conseguir o trabalho dos seus sonhos, pensando positivamente e avan√ßando, tendo estudado minhas cinco regras ...</a></li>
<li><a href="../pt483830/index.html">Roteamento para iOS: navega√ß√£o universal sem reescrever o aplicativo</a></li>
<li><a href="../pt483834/index.html">Debian: simplesmente transformando i386 em amd64</a></li>
<li><a href="../pt483842/index.html">A hist√≥ria da cria√ß√£o de uma nuvem dom√©stica. Parte 5. Atualizando 2019 - PHP 7.2, MariaDB 10.4 e Nextcloud 17</a></li>
<li><a href="../pt483844/index.html">An√°lise de documentos regulat√≥rios sobre prote√ß√£o de informa√ß√µes no setor financeiro e de cr√©dito da R√∫ssia</a></li>
<li><a href="../pt483846/index.html">Gerenciamento alternativo de janelas no Linux</a></li>
<li><a href="../pt483850/index.html">Deuses n√£o queimam panelas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>