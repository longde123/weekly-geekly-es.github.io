<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßöüèæ ‚ùáÔ∏è üí® Outils de sauvegarde PostgreSQL. Andrey Salnikov (Data Egret) üëâ üôÑ üëé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je vous sugg√®re de lire le d√©chiffrement du rapport par Andrey Salnikov de Data Egret "Outils de cr√©ation de sauvegarde PostgreSQL" . √Ä la fin, un tab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Outils de sauvegarde PostgreSQL. Andrey Salnikov (Data Egret)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485622/"><p>  <strong>Je vous sugg√®re de lire le d√©chiffrement du rapport par Andrey Salnikov de Data Egret "Outils de cr√©ation de sauvegarde PostgreSQL"</strong> <strong>.</strong>  <strong>√Ä la fin, un tableau r√©capitulatif des outils mis √† jour</strong> </p><br><p>  Cette pr√©sentation concerne les outils de sauvegarde PostgreSQL disponibles.  Sauvegardes logiques, sauvegardes binaires, outils de sauvegarde int√©gr√©s et outils tiers.  Les sauvegardes incr√©mentielles sont-elles n√©cessaires lorsqu'elles peuvent vraiment aider.  Voyons quand et quel outil est le plus appropri√© √† utiliser.  Quelle est la meilleure fa√ßon d'automatiser le processus de sauvegarde et de v√©rifier l'int√©grit√© d'une sauvegarde?  Examinez de <a href="https://www.postgresql.org/docs/10/app-pgbasebackup.html" rel="nofollow">plus</a> pr√®s des outils tels que <a href="https://www.postgresql.org/docs/10/app-pgdump.html" rel="nofollow">pg_dump</a> , <a href="https://www.postgresql.org/docs/10/app-pgbasebackup.html" rel="nofollow">pg_basebackup</a> , <a href="https://www.2ndquadrant.com/en/resources/barman/" rel="nofollow">barman</a> , <a href="https://github.com/wal-e/wal-e" rel="nofollow">wal-e</a> , <a href="https://github.com/wal-g/wal-g" rel="nofollow">wal-g</a> , <a href="https://pgbackrest.org/" rel="nofollow">pgbackrest</a> , <a href="https://www.enterprisedb.com/enterprise-postgres/edb-postgres-backup-and-recovery-tool" rel="nofollow">BART</a> et <a href="https://postgrespro.ru/products/extensions/pg_probackup" rel="nofollow">pg_probackup</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Us6cHVNA4vk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Je m'appelle Andrey Salnikov, je suis un employ√© de Data Egret et ce rapport sera consacr√© aux outils de cr√©ation de sauvegardes dans PostgreSQL. </p><br><p><img src="https://habrastorage.org/webt/qr/pa/mu/qrpamu1psbed1aonvt1shrrpedk.png"></p><br><p>  D'abord qui nous sommes, mon entreprise.  Notre activit√© principale: nous travaillons en tant qu'administrateurs √† distance et nous avons un nombre assez important de clients.  Il y a d'√©normes bases, il y a un tas de petites bases, il y a toutes sortes de m√©langes quand une grande base ou un tas de petites.  Nous fournissons √©galement des services de conseil et d'audit - c'est le cas si les gens n'ont pas besoin d'un soutien constant, mais qu'une sorte d'expertise est n√©cessaire. <br>  PostgreSQL √©tant un produit open source, nous participerons naturellement √† toutes sortes de conf√©rences en termes de partage de notre exp√©rience et d'aide de PostgreSQL de toutes les mani√®res possibles.  Parce que la base de donn√©es PostgreSQL est vraiment bonne.  Et il s'av√®re que nous avons vu beaucoup de profils de charge: charges DWH, charges WEB et m√©langes de charges.  Et les bases tombaient de diff√©rentes mani√®res.  Beaucoup d'exp√©rience. </p><br><p><img src="https://habrastorage.org/webt/a0/vc/b_/a0vcb_l47qx4vvzh1hxnjcqesz4.png"></p><br><p>  Il s'agit de la partie la plus int√©ressante du rapport.  Pourquoi des sauvegardes sont-elles n√©cessaires?  En fait, ils sont n√©cessaires pour que nous puissions nous reposer paisiblement, pour que nous puissions dormir paisiblement, pour que nous puissions nous d√©tendre tranquillement lors de concerts.  Maintenant, c'est l'objectif principal du point de vue de la base pourquoi les sauvegardes sont n√©cessaires.  Pour que tout soit calme dans nos vies.  Parce que s'il y a des sauvegardes v√©rifi√©es, nous pouvons faire tout cela.  Mais ce qui se passe avec la base est la dixi√®me chose. </p><br><p><img src="https://habrastorage.org/webt/dj/_9/aj/dj_9ajbympb3eslx0bl1phlp6te.png"></p><br><p>  Quelle est la gamme d'outils pour cr√©er des sauvegardes dans le monde PostgreSQL?  Il s'agit de l'outil de r√©cup√©ration int√©gr√© pg_dump, pg_dumpall ou pg_restore.  C'est le seul outil qui vous permet de faire des sauvegardes logiques.  Autrement dit, il peut vous pg_dump, √† la fois dans SQL pour vider, et dans un petit format binaire pour vider les donn√©es.  Et cela sort de la bo√Æte avec PostgreSQL. <br>  L'outil suivant (pg_basebackup) pour cr√©er des sauvegardes, qui sort √©galement de la bo√Æte et d√©marre √† partir de cet outil, et en outre, ils seront tous des outils pour cr√©er des sauvegardes de bases de donn√©es binaires.  Pg_basebackup est √©galement un outil qui sort de la bo√Æte, qui nous permet de t√©l√©charger des r√©pliques postgreSQL et de prendre une copie binaire de la base de donn√©es, de tirer une base de donn√©es persistante et, si nous voulons √™tre en mesure d'archiver √† temps, nous pouvons configurer PostgreSQL pour le vider √† une sorte de disque.  Ce sont les outils de base.  Ils sont bons, ils le font, ils ex√©cutent leur fonctionnalit√© √† 5, mais ils sont g√™nants en termes de gestion et de masse.  Lorsque vous avez 20 bases de donn√©es, vous devrez le faire vous-m√™me par script. <br>  Les deux outils suivants sont des outils cloud sp√©cifiques et purs - wal-e et wal-g.  Les m√™mes gars les d√©veloppent, mais le d√©veloppement de wal-e √©tait termin√©, et ils sont pass√©s √† wal-g.  Ces outils sont principalement destin√©s √† AWS et au stockage dans S3.  Wal-e est toujours en mesure de travailler avec Google Cloud, avec Azure et avec le syst√®me de disque, vous pouvez simplement sp√©cifier une sorte de lecteur distant.  Wal-g ne fonctionne qu'avec AWS, uniquement avec S3.  Eh bien, ou toute autre interface similaire avec S3.  Nous les utilisons, de bonnes choses.  Je vais encore d√©monter chaque outil en d√©tail. </p><br><p><img src="https://habrastorage.org/webt/h_/cs/my/h_csmywtln65xfdmoryutenb6-g.png"></p><br><p>  Et sur le prochain ensemble d'outils, ce sont des outils qui s'appuient sur pg_basebackup ou l'utilisent directement ou impl√©mentent d'une mani√®re ou d'une autre ses fonctionnalit√©s.  Ils sont tous √©crits par des d√©veloppeurs qui s'engagent sur PostgreSQL et ont leur propre fork commercial, qui les promeut dans leur cercle d'influence. <br>  L'outil barman le plus populaire, que nous utilisons assez largement dans le pays.  Il s'agit essentiellement d'un wrapper Python autour de pg_basebackup.  Il peut √©galement fonctionner sur les protocoles ssh.  Un outil pgbackrest tr√®s int√©ressant et tr√®s prometteur.  PostgreSQL est impliqu√© dans le d√©veloppement et s'y engage activement.  Il a √©t√© √©crit √† l'origine en Python.  Maintenant, la version qui est utilis√©e - elle est √©crite en C pour acc√©l√©rer et la possibilit√© de suppression parall√®le des sauvegardes. <br>  Pg_probackup est un utilitaire de nos coll√®gues russes de PostgreSQL Professional qui vous permet de faire des sauvegardes incr√©mentielles, qui sont assez petites. <br>  Et le dernier utilitaire est l'outil de sauvegarde et de r√©cup√©ration (BART) d'EnterpriseDB.  Elle n'est pas tr√®s populaire chez nous.  C'est principalement pour CentOS et Red Hat.  Pour Ubuntu, avec elle, √† mon avis, difficile.  Et en raison de la faible popularit√© de BART chez nous, il (BART) ne se trouve presque nulle part dans les installations. </p><br><p><img src="https://habrastorage.org/webt/ow/si/t8/owsit8h0n3welzlugm95_glqdds.png"></p><br><p>  J'essaierais de d√©composer ces outils en certaines choses qui sont importantes. </p><br><ul><li><p>  Tout d'abord, il est important pour nous de savoir comment nous allons le stocker, sur quels disques et sur quels services.  Et il y a une liste de caract√©ristiques que nous allons parcourir. </p><br></li><li><p>  La s√©paration de donn√©es suivante, ici je subdivise que, lors de la suppression de la sauvegarde ou de la restauration de la sauvegarde, nous pouvons couper une partie de l'ensemble du serveur de base de donn√©es (serveur) et travailler avec lui comme une base de donn√©es int√©grale int√©grale. </p><br></li><li><p>  Dans quelle mesure ils prennent en charge diff√©rentes versions de la base de donn√©es. </p><br></li><li><p>  De quels modes de fonctionnement disposent-ils en termes de parall√©lisme, en termes d'automatisation, etc. </p><br></li><li><p>  Et la facilit√© de maintenance correspond √† la quantit√© que nous pouvons s√©parer en un service distinct, qui lui-m√™me passera par des bases de donn√©es et supprimera les sauvegardes selon un calendrier. </p><br></li><li><p>  Validation - Je voulais que la sauvegarde soit v√©rifi√©e afin de garantir que nous pourrons ensuite en r√©cup√©rer et que nous aurons une base normale et ininterrompue. </p><br><p>  Et maintenant, passons en revue ces six grands points plus en d√©tail.  Et j'y marquerai quel instrument cela nous donnera. </p><br></li></ul><br><p><img src="https://habrastorage.org/webt/s5/v0/h0/s5v0h0p62rsqz1r86v2upwibj5c.png"></p><br><p>  Par stockage, ils peuvent tout stocker dans le syst√®me de fichiers, c'est-√†-dire que nous pouvons remonter notre disque sur le syst√®me d'exploitation et y copier des sauvegardes.  Tous les outils vous permettent de le faire.  Un lecteur r√©seau mont√© est fondamentalement le m√™me, car il est obtenu dans notre syst√®me de fichiers local. <br>  Dans AWS (S3), trois outils peuvent fonctionner pour nous - wal-g, wal-e, pgbackrest.  Parce que parmi ces utilitaires: barman et ainsi de suite, c'est le seul qui peut fonctionner avec AWS (S3). <br>  Avec Azure, seulement wal-e.  Google Cloud n'est que wal-e. </p><br><p><img src="https://habrastorage.org/webt/gw/sc/qd/gwscqdmvmqlbe1r1e545ipkemzs.png"></p><br><ul><li>  Une copie logique des donn√©es ne nous est fournie que par pg_dump, pg_dumpall.  La diff√©rence entre eux est que pg_dumpall traite l'int√©gralit√© de l'instance de base de donn√©es (serveur), dans pg_dump vous pouvez sp√©cifier une base de donn√©es sp√©cifique sur l'instance et travailler avec elle. </li><li>  Les copies binaires sont tout le reste. </li><li>  Un facteur important pendant le stockage est que si nous sommes limit√©s d'une mani√®re ou d'une autre par les ressources du disque, alors des situations surviennent souvent lorsque nous divisons la base de donn√©es en diff√©rents espaces table.  Cela est √©galement vrai pour les serveurs de fer, car vous ne voulez pas souffrir de RAID.  Cela est vrai pour les nuages, car il existe une certaine limitation, en particulier lorsque vous prenez une voiture avec des disques NVME et combien sont connect√©s, donc beaucoup sont connect√©s.  Les instances AWS se d√©veloppent, mais avec des disques EBS.  Et lors de la restauration des donn√©es, il sera important pour nous que nous puissions redistribuer ces espaces table, les affecter le long de nouveaux chemins et vers de nouveaux disques.  Et maintenant cette bonne propri√©t√© est pr√©sente chez wal-e.  En wal-g, ils ne savent toujours pas comment travailler avec.  Pg_probackup peut fonctionner avec.  Barman, basebackup, pgbackrest.  Cette chose est assez souvent importante, surtout lorsque vous avez une base de donn√©es de 8 √† 10 To.  Parmi nos clients de production, presque toutes ces bases de donn√©es sont regroup√©es en espaces table. </li></ul><br><p><img src="https://habrastorage.org/webt/qd/-v/sk/qd-vskcocq-r2tv0duopeyxtvke.png"></p><br><p>  Maintenant, quelle taille peut-on avoir de sauvegarde.  Tout cela se passera dans le contexte des sauvegardes binaires.  Il est clair que la sauvegarde binaire repr√©sente le poids de la base de donn√©es, tant nous l'avons copi√©.  P√®se 8 To, nous avons copi√© 8 To.  1 Mo p√®se 1 Mo, copi√©.  Comment √©conomiser de l'espace quand on veut une longue cha√Æne de sauvegardes?  Pour ce faire, est venu avec quelques outils.  Autrement dit, la base de donn√©es stocke des donn√©es dans ses fichiers.  Si nous avons une longue base de donn√©es d'archives, nous y modifions g√©n√©ralement un petit% de ces fichiers.  Et pour cela, ils ont propos√© une sauvegarde diff√©rentielle. </p><br><p>  La sauvegarde diff√©rentielle c'est quoi?  Nous regardons quels fichiers ont chang√© et copions uniquement vers le stockage, o√π stocker la sauvegarde.  Et nous lierons tous les autres fichiers avec un lien physique √† cette base de donn√©es.  Il s'av√®re que nous √©conomisons ainsi de l'espace.  Et en m√™me temps, nous pouvons supprimer en toute s√©curit√© les anciennes sauvegardes de bases de donn√©es sans g√¢cher les plus r√©centes. </p><br><p>  Cette chose est bonne, mais nous avons d√©cid√© d'aller de l'avant et de proposer une sauvegarde incr√©mentielle.  Les sauvegardes incr√©mentielles sont de deux types. </p><br><p>  Le premier est au niveau du fichier.  Elle ne diff√®re de la sauvegarde diff√©rentielle que dans la mesure o√π la sauvegarde diff√©rentielle se concentre sur une sauvegarde compl√®te de votre base de donn√©es, et par rapport √† une sauvegarde compl√®te, elle copie les fichiers diff et les copies.  La sauvegarde incr√©mentielle peut se concentrer sur les sauvegardes diff√©rentielles, copie uniquement les fichiers modifi√©s qui ont chang√© par rapport √† la sauvegarde diff√©rentielle.  Pour l'incr√©mentiel, vous aurez besoin de toute la cha√Æne de sauvegardes.  Autrement dit, la sauvegarde principale -&gt; 1√®re sauvegarde incr√©mentielle (elle sera toujours diff√©rentielle) -&gt; puis toutes les sauvegardes incr√©mentielles.  La sauvegarde diff√©rentielle se concentre toujours sur une base de donn√©es de sauvegarde compl√®te.  Incr√©mentielle peut se concentrer sur d'autres types de sauvegarde. <br>  Pg_probackup et BART ont opt√© pour la cr√©ation de sauvegardes incr√©mentielles par bloc.  Parce que nous pouvons changer non pas le fichier entier, mais le bloc de donn√©es.  Et ces utilitaires parcourent les fichiers wal et s√©lectionnent exactement les blocs que vous avez modifi√©s.  Ces blocs de sauvegarde sont copi√©s dans la sauvegarde.  Afin de r√©cup√©rer avec une telle sauvegarde incr√©mentielle, vous aurez √©galement besoin d'une copie compl√®te de la base de donn√©es et de plus, vous devez toujours enregistrer ces √©l√©ments incr√©mentiels qui sont tap√©s √† partir de wal.  Cela impose certaines limitations de l'utilitaire, car ils doivent parcourir les fichiers wal.  PostgreSQL Professional poss√®de √©galement une couche sur la structure des fichiers de la base de donn√©es.  Par cons√©quent, ils recherchent assez rapidement ces blocs.  Ces sauvegardes incr√©mentielles sont tr√®s petites.  Si vous avez une petite modification de la base de donn√©es% et du fait que beaucoup d'informations techniques sont √©crites dans le fichier wal, ces utilitaires sauvegardent des dizaines de kilo-octets de donn√©es pour 1 wal. </p><br><p><img src="https://habrastorage.org/webt/s3/d9/ca/s3d9ca1otjtkwql3_qakv67am7c.png"></p><br><p>  Plus de partage de donn√©es.  Cela implique que si nous devons sauvegarder tout pas.  Ou ne restaurez pas tout.  Ceci n'est possible qu'avec des sauvegardes logiques, et cela nous permet de ne faire que pg_dump.  Les utilitaires offrent des fonctionnalit√©s assez √©tendues.  Pg_dump peut vous permettre de vider la structure de la base de donn√©es si vous en avez besoin.  Vous pouvez sp√©cifiquement vider une table ou vous pouvez exclure une table de la sauvegarde ou vider la liste des tables, exclure la liste.  La fonctionnalit√© est assez large √† cet √©gard.  L'inconv√©nient est que lors de la r√©cup√©ration √† partir d'un tel vidage, si vous avez une grande base de donn√©es, vous devrez consacrer beaucoup de temps √† la r√©cup√©rer, car tout cela doit √™tre jou√© sur une pure instance de PostgreSQL. <br>  Ces utilitaires sont tr√®s pratiques pour utiliser le cas lorsque nous avons surestim√© nos forces et que nous n'avons pas cr√©√© un tas de petites bases de donn√©es.  Nous pouvons les fusionner en une seule instance.  Nous pouvons le voir de cette fa√ßon si nous √©valuons √† nouveau maintenant notre force, si notre base de donn√©es est gonfl√©e ou si nous y changeons l'architecture d'un monolithe en un service et en sciant les donn√©es.  Pg_dump dans ce cas est la seule chose qui vous permet de le faire sans douleur. </p><br><p>  Vous pouvez √©galement restaurer une base de donn√©es et pgbackrest est r√©pertori√© ici.  Il a une telle puce, que nous pouvons indiquer que nous n'avons besoin que d'une seule base de donn√©es de sauvegarde binaire.  Que fait-il?  Il restaure la base de donn√©es par d√©faut √† partir de la sauvegarde, il s'agit du mod√®le et des postgres et de la base de donn√©es que nous avons sp√©cifi√©e.  Toutes les autres bases de donn√©es, il r√©initialise les fichiers et les rend de longueur nulle.  Autrement dit, PostgreSQL a une structure transparente pour stocker des bases de donn√©es dans des fichiers, vous pouvez √† ce niveau, pour ainsi dire, r√©duire la base de donn√©es restaur√©e.  Supposons que nous ayons besoin de trouver les donn√©es urgentes √† partir d'un binaire, nous ne voulons pas augmenter la base de 10 To, nous avons deux bases l√†-bas et nous en √©levons une, ce qui permet un total de 5 To.  Dans ce cas, bien s√ªr, la coh√©rence est viol√©e, mais pour certaines solutions rapides, lorsque vous avez un besoin urgent de pr√©lever du sang de votre nez √† partir d'une grande base de donn√©es, dont il existe plusieurs, ce sont de tr√®s bonnes fonctionnalit√©s qui le sont.  Mais comme une base de donn√©es de sauvegarde compl√®te ne doit pas √™tre consid√©r√©e lors de la r√©cup√©ration.  Autrement dit, c'est pour les travaux d'urgence. </p><br><p><img src="https://habrastorage.org/webt/bq/pf/aj/bqpfaj0wvrtn1atsq0yj1j4x7de.png"></p><br><p>  Comment fonctionne le travail avec de nombreuses versions de la base de donn√©es?  Ici aussi, tout est assez int√©ressant.  Pg_dump est tr√®s bon dans la mesure o√π nous ne sommes pas li√©s √† la version de la base de donn√©es √† restaurer.  Il y a le mode texte brut, et c'est juste du SQL pur, qui d√©crit la structure enti√®re de la base de donn√©es, toutes les donn√©es.  En principe, vous pouvez r√©cup√©rer o√π vous voulez, dans MySQL, dans MSSQL, dans Oracle avec quelques modifications dans ce vidage.  Entre les principales versions de PostgreSQL, ces vidages sont √©galement assez faciles √† utiliser. <br>  Multi-versioning, qu'est-ce que je veux dire par l√†?  C'est dans quelle mesure l'utilitaire peut traiter diff√©rentes versions de bases de donn√©es et fonctionner simultan√©ment avec PostgreSQL 9.6, 10, 11. Tout sauf les versions int√©gr√©es de pg_dump et pg_basebackup, car elles sont li√©es √† la version sp√©cifique avec laquelle elles sont fournies.  Le reste se concentre sur ces utilitaires.  Ils peuvent √™tre indiqu√©s o√π se trouvent pg_basebackup, pg_dump de diff√©rentes versions.  Ils respectivement avec la version de PostgreSQL choisissent le dernier utilitaire pour supprimer la sauvegarde. <br>  Tous les utilitaires, √† l'exception de pg_dump, conviennent √† la cr√©ation de r√©pliques et de serveurs de secours, car il s'agit de sauvegardes logiques.  √Ä l'aide de l'un de ces utilitaires, vous pouvez restaurer les serveurs et vous connecter √† l'assistant pour fonctionner comme une r√©plique de ce serveur. </p><br><p><img src="https://habrastorage.org/webt/rk/mr/jp/rkmrjpvyme8ifuybv7jvpkqd0r4.png"></p><br><p>  Comment les sauvegardes peuvent √™tre supprim√©es en g√©n√©ral, quels modes existent pour supprimer les sauvegardes.  Vous pouvez simplement copier des fichiers √† l'aide d'outils OS standard: via le protocole ssh (rsync, scp) et √©ventuellement d'autres utilitaires qui le sont.  Pourquoi il existe une telle opportunit√©, car ils vous permettent de parall√©liser la copie.  Pgbackrest ne fonctionne que de cette fa√ßon, barman, il peut fonctionner de cette fa√ßon, et il peut fonctionner en utilisant le protocole PostgreSQL. <br>  Protocole PostgreSQL - lorsque l'utilitaire de sauvegarde se connecte √† PostgreSQL et extrait tous les fichiers ainsi que les journaux d'archivage qui surviennent pendant le processus de sauvegarde √† l'aide du protocole de r√©plication.  Tout le monde et le barman peuvent le faire. <br>  Fondamentalement, tout peut faire une sauvegarde √† partir d'une r√©plique, cela d√©pend de la version de PostgreSQL.  Avec PostgreSQL 10 et 11, nous pouvons supprimer des sauvegardes d'une r√©plique.  Mais je ne le recommande pas, en g√©n√©ral, aucune de nos soci√©t√©s ne le recommandera.  Parce qu'il y a des situations o√π ils ont manqu√© la surveillance, ils ont pris une sauvegarde de la r√©plique pendant un mois, qui est tomb√©e du serveur ma√Ætre et n'est pas pertinente.  En d'autres termes, les sauvegardes doivent toujours √™tre supprim√©es du serveur ma√Ætre.  Dans ce cas seulement, vous serez s√ªr d'avoir une base de donn√©es de sauvegarde vraiment √† jour. <br>  Sauvegardes multithreads - tout le monde peut le faire, car tout est pour des raisons diff√©rentes, quelqu'un via le protocole ssh, quelqu'un impl√©ment√© au niveau de la copie de la base de donn√©es.  Sauf pg_basebackup et BART, car l'op√©ration BART ne se produit que sur pg_basebackup lorsque la sauvegarde est supprim√©e et, malheureusement, elle est monothread et ne sera pas multithread. </p><br><p><img src="https://habrastorage.org/webt/72/4x/j0/724xj0dcehoennfciyo2uzucisq.png"></p><br><p>  Un exemple de multithreading.  Je restaurais une base de donn√©es de 8 To.  Lorsque vous vous concentrez sur le choix d'un syst√®me pour supprimer les sauvegardes, sachez que wal-e est √©crit en Python, wal-g est √©crit en Golang.  J'ai d√ª restaurer la base de 8 To.  Wal-e a rencontr√© une limitation Python et m'a attir√© avec AWS √† une vitesse de 600 Mbps.  Lorsque je suis pass√© √† wal-g, il √©tait dans une situation o√π il ne pouvait pas travailler avec les sauvegardes wal-e, mais il pouvait extraire des fichiers wal.  Par cons√©quent, cette image du milieu ici est la restauration de la base de donn√©es.  Puis roul√© wal, qui se trouvait l√† en S3 et a √©t√© restaur√© √† un certain moment.  Wal-e a rencontr√© une limitation et une concurrence Python en Python, c'est tellement conditionnel.  Un wal-g a couru dans l'interface S3, c'est-√†-dire la vitesse √† laquelle S3 pouvait donner √† chaque instant, si rapidement que cela prenait.  En moyenne, il √©tait de 2 Go / s, ce qui est suffisant.  Autrement dit, avec wal-e, une heure de modifications de la base de donn√©es a √©t√© re√ßue en 45 minutes de sauvegarde continue.  Avec wal-g, il s'est av√©r√© qu'ils ont roul√© une heure quelque part dans la base de donn√©es pendant environ 5 minutes. </p><br><p><img src="https://habrastorage.org/webt/rj/nk/fa/rjnkfaa9ld-am4dazwrasjqwfbk.png"></p><br><p>  Modes de fonctionnement, ce qui est int√©ressant ici dans le syst√®me de sauvegarde. </p><br><ul><li>  R√©cup√©ration dans le temps jusqu'√† un point pr√©cis.  Si nous avons des journaux archiv√©s et que nous les copions, nous pouvons les restaurer.  Il vous permet de faire un syst√®me de sauvegarde, c'est comme un facteur standard.  L'essentiel est que nous stockions des fichiers wal quelque part.  Les d√©charges, bien s√ªr, ne savent pas comment, car elles parlent un peu d‚Äôautre chose. </li><li>  Ajuster la charge sur le r√©seau est une chose assez importante, car comme je l'ai dit, il est souhaitable de supprimer le vidage du serveur ma√Ætre, alors vous vous garantissez que vous obtenez vraiment la sauvegarde r√©elle.  Eh bien, il arrive parfois que les serveurs soient tellement charg√©s qu'il est assez difficile d'y entrer.  Certains clients collent une interface r√©seau distincte.  Parfois, un temps de chargement minimal est effectu√©.  C'est √©galement bon lorsque nous pouvons sp√©cifier la charge sur le r√©seau lors de la cr√©ation de la sauvegarde.  Cela vous permet de faire pg_basebackup, barman et BART, wal-e, wal-g. </li><li>  Compression √† la vol√©e.  Il s'agit de savoir combien nous transmettrons sur le r√©seau.  Si nous pouvons compresser le fichier avant de l'envoyer au r√©f√©rentiel, alors c'est bien √† la vol√©e.  Et presque tout le monde peut le faire, ici.  L'essentiel est d'indiquer le niveau de compression l√†-bas. </li></ul><br><p><img src="https://habrastorage.org/webt/lv/pe/vd/lvpevdlrpqrg-9hypasdcs9-dse.png"></p><br><p>  Facilit√© d'entretien, qu'est-ce qui est int√©ressant ici pour les syst√®mes de sauvegarde? </p><br><ul><li>   CLI ‚Äî    ,               ,     ,        ,      .    ,       CLI,     ,     ,     .       ,       ,      . </li><li>         barman, pgbackrest  BART,        .   ,        20-30  ,    ,    ,          ,           backup-           . ,  ,     . </li><li>    ‚Äì          ,     ,       backup-,   ,    backup-.           ,     -   .         .       . </li><li>   ‚Äì                 backup-,   ,  -   .     ,    ,     .  ,   , ,      ,       wal ,   ,        .   wal-e, wal-g,      ,    backup      - .  7 backup    . </li></ul><br><p><img src="https://habrastorage.org/webt/zj/r0/es/zjr0esauswimuw1itkqosshmyla.png"></p><br><p>   backup.  ,       backup,    backup  ,    ,        .  ,       .     ,   .   .    stage   .   ,       ,    backup .   CLI  ,           backup    . </p><br><p>     ,      ,  .         ,    backup .   ,     .  ,    .  ,    .   .   checksum  PostgreSQL.      ,      checksum  PostgreSQL.       checksum,   . </p><br><p>  pgbackrest  pg_probackup    backup  ,     checksum.          checksum. </p><br><p>  ,    backup,      checksum , ,   checksum   .     . </p><br><p><img src="https://habrastorage.org/webt/mj/_e/di/mj_edibaxks4v2_4-t5kanbxghe.png"></p><br><p>  : </p><br><ul><li> <a href="https://www.postgresql.org/docs/10/static/app-pgdump.html" rel="nofollow">https://www.postgresql.org/docs/10/static/app-pgdump.html</a> </li><li> <a href="https://www.postgresql.org/docs/10/static/app-pgbasebackup.html" rel="nofollow">https://www.postgresql.org/docs/10/static/app-pgbasebackup.html</a> </li><li> <a href="https://www.2ndquadrant.com/en/resources/barman/" rel="nofollow">https://www.2ndquadrant.com/en/resources/barman/</a> </li><li> <a href="https://github.com/wal-e/wal-e" rel="nofollow">https://github.com/wal-e/wal-e</a> </li><li> <a href="https://github.com/wal-g/wal-g" rel="nofollow">https://github.com/wal-g/wal-g</a> </li><li> <a href="https://pgbackrest.org/" rel="nofollow">https://pgbackrest.org/</a> </li><li> <a href="https://www.enterprisedb.com/products/edb-postgres-platform/edb-backup-and-recovery-tool" rel="nofollow">https://www.enterprisedb.com/products/edb-postgres-platform/edb-backup-and-recovery-tool</a> </li><li> <a href="https://postgrespro.ru/products/extensions/pg_probackup" rel="nofollow">https://postgrespro.ru/products/extensions/pg_probackup</a> </li></ul><br><p>      .   ,     .       ,     . </p><br><p><img src="https://habrastorage.org/webt/tt/qn/i7/ttqni7mc49sw-n6bww9bpi1gese.png"></p><br><p> :  ,  backup      ,     ,   ,   .       ,      ,       backup.    ,  ,  -    , ,   ,  ,    ,     ,   .    -    ? </p><br><p> :       ,        ,       .     .   .  -   , , backup   ,   ,       ,      .          ,         .    ,  , , ,  ,   ,     /     .  ,       ,       .      ,     .   ,      .       ,        . </p><br><p> :    , ,    ?       . </p><br><p> :        .         4 .       .     .      backup.       .    ,     . </p><br><p> :         ? </p><br><p> :    .       .   wal-e, wal-g, pgbackrest.    borman, pg_dump,   basebackup.    ,      ,       .   . </p><br><p> :  ,    -     PostgreSQL,   , , postgis  - -? </p><br><p> :    ,      backup   ,      .  checksum  ,  PostgreSQL   checksum,   ,       .   postgis,     -      . Pg_dump      ,    ,   , SQL .        SQL .     . , ,         .    dump,       . </p><br><p> :  ,     .   ,          -  ? </p><br><p> :     .    dump  ,         .    ,    ‚Äì    ,  ,  - ,  ,     .      ,    . ,   -  ,      . </p><br><p> :   ,     ,   ,  bloat   ? </p><br><p> : . </p><br><p> :    ‚Äî  ,     -    . , Symantec, Veritas Backup Exec  .      PostgreSQL? </p><br><p> : ,      ,      . PostgreSQL     ,    pg_start_backup.  ,  .     . </p><br><p> :  ,  -  Symantec, Veritas Backup Exec      . </p><br><p> :   . </p><br><p> : , ,      .   checksum    - ,   , - ? </p><br><p> :    ‚Äî            .        stage ,    .    stage    .       .             .    ,      -,        .     .      . </p><br><p> :   ,      WAL ,   S3.        wal-e, wal-g    - awscli  .      ? </p><br><p>  (  ):   wal-g.     wal-g.      40     wal-g .      .  ,   .   , prefetch,   wal  ,    . ,      ‚Äî  ,       wal.    wal   ,   page cache   ,  ,      wal,       ,        .     ,   . </p><br><p>  :     .   ,     PostgreSQL ‚Äî   -&gt; /dev/null,  ,      .        ,          .       smoke .   <a href="https://postgrespro.ru/docs/postgresql/10/amcheck" rel="nofollow">amcheck</a> ,      .        ,        ,     ,       . </p><br><p> :       10  .       .            .    .       wal  ‚Äî      .      ? </p><br><p> :        .      .      .         ,        . </p><br><p> :          ,       pg_dump,        . ? </p><br><p> : -     . ,   . </p><br><p> :   ,      ,    - ? </p><br><p> : pg_dump   ,    . </p><br><p> :     pg_dump,    ,   ,   ,         ,    . </p><br><p> :         ,       -,    . </p><br><p> :   ,   . </p><br><p> :        ,       -  . </p><br><p> :    .     .      .      . ,     ,    .   . Pg_dump  ,  - ,  exit_code  .   ,       , .   ,      . </p><br><p> PS ‚Ññ1        pg_dump, pg_basebackup. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th> barman </th><th> wal-e </th><th> wal-g </th><th> pg_probackup </th><th> pgbackrest </th><th> BART </th></tr></thead><tbody><tr><td> ssh (rsync, scp) </td><td>  + </td><td></td><td></td><td></td><td>  + </td><td></td></tr><tr><td>     </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td> S3 </td><td></td><td>  + </td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td> Azure </td><td></td><td>  + </td><td>  + </td><td></td><td></td><td></td></tr><tr><td> Google Cloud </td><td></td><td>  + </td><td>  + </td><td></td><td></td><td></td></tr><tr><td>    </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td>   </td><td></td><td></td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td>   </td><td></td><td></td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td></td><td> barman </td><td> wal-e </td><td> wal-g </td><td> pg_probackup </td><td> pgbackrest </td><td> BART </td></tr><tr><td>    </td><td></td><td></td><td>  + </td><td>  + </td><td></td><td></td></tr><tr><td>    </td><td></td><td></td><td></td><td></td><td>  + </td><td></td></tr><tr><td> - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>   </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td> R√©cup√©ration ponctuelle </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Ajustement de la charge r√©seau </td><td>  + </td><td></td><td>  + </td><td></td><td></td><td>  + </td></tr><tr><td>  Compression √† la vol√©e </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td>  CLI </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Serveur d√©di√© </td><td>  + </td><td></td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td></td><td>  barman </td><td>  wal-e </td><td>  wal-g </td><td>  pg_probackup </td><td>  pgbackrest </td><td>  Bart </td></tr><tr><td>  Stockage de sauvegarde structur√© </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Politiques de r√©tention </td><td>  + </td><td>  cron </td><td>  cron </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  CLI pour la surveillance </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Validit√© de l'ach√®vement de la sauvegarde </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Checksum postgresql </td><td></td><td></td><td></td><td>  + </td><td>  + </td><td></td></tr></tbody></table></div><br><p>  PS n ¬∞ 2 Erreurs, corrections sous l'article, ajouts au tableau crois√© dynamique peuvent √™tre effectu√©s par <a href="" rel="nofollow">demande Pull</a> </p><br><p>  PS # 3 Wal-g accueille des volontaires pour aider avec la documentation. </p><br><p>  PS n ¬∞ 4 Pour installer wal-g en utilisant rpm, vous pouvez utiliser mon d√©p√¥t: <a href="https://github.com/patsevanton/wal-g-rpm" rel="nofollow">Github</a> , <a href="https://copr.fedorainfracloud.org/coprs/antonpatsev/wal-g/" rel="nofollow">Fedora COPR</a> . </p><br><p>  PS n ¬∞ 5 Comment faire une sauvegarde compl√®te et une sauvegarde incr√©mentielle lors de la cr√©ation et du stockage dans S3, et enregistrer uniquement la sauvegarde compl√®te sur bande?  Si vous avez des id√©es, dites-le moi dans les commentaires ou en PM. </p><br><p><img src="https://habrastorage.org/webt/r8/hh/ks/r8hhkssl2kpkvvqvat1xgwe8eie.png"></p><br><p>  Enqu√™te: Quels outils de sauvegarde utilisez-vous? </p><br><p>  PS Telegram Channel Telegram PostgreSQL: <a href="https://t.me/pgsql" rel="nofollow">https://t.me/pgsql</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485622/">https://habr.com/ru/post/fr485622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485610/index.html">Cr√©er une application Qt dans WebAssembly sous Windows</a></li>
<li><a href="../fr485612/index.html">Qu'est-ce qu'un accident spatial m'a appris en tant que d√©veloppeur</a></li>
<li><a href="../fr485614/index.html">La culture d'entreprise rouge est le principal probl√®me des entreprises russes (partie 3)</a></li>
<li><a href="../fr485618/index.html">Automatisation pour les plus petits. Remarques. API RESTful</a></li>
<li><a href="../fr485620/index.html">Yoshkar-Ola, en g√©n√©ral, une ville informatique?</a></li>
<li><a href="../fr485624/index.html">Serveur Minecraft: Windows vs Linux</a></li>
<li><a href="../fr485630/index.html">La cosmonautique africaine: des d√©chets √† la r√©alit√©</a></li>
<li><a href="../fr485632/index.html">Surveillance du score de cr√©dit dans Power BI</a></li>
<li><a href="../fr485636/index.html">Les virus r√©sistants aux CRISPR construisent des abris pour prot√©ger les g√©nomes des enzymes p√©n√©trant l'ADN</a></li>
<li><a href="../fr485640/index.html">M√©thodes de masquage des pages Web</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>