<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùé ü•Å üß¢ SObjectizer-5.6.0: couper en direct pour continuer √† grandir üí™üèø üö¢ üêî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le troisi√®me jour, une nouvelle version de SObjectizer est devenue disponible : 5.6.0 . Sa principale caract√©ristique est le rejet de la compatibilit√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SObjectizer-5.6.0: couper en direct pour continuer √† grandir</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453256/"><p><img src="https://habrastorage.org/webt/vp/ah/jx/vpahjx-dkpsauwtfzyeiktnsfp4.jpeg"></p><br><p>  Le troisi√®me jour, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">nouvelle version de SObjectizer</a> est devenue disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">: 5.6.0</a> .  Sa principale caract√©ristique est le rejet de la compatibilit√© avec la branche stable pr√©c√©dente 5.5, qui n'a cess√© de se d√©velopper au cours des quatre ans et demi. </p><br><p>  Les principes de base du fonctionnement de SObjectizer-5 sont rest√©s les m√™mes.  Les communications, les agents, les coop√©rations et les r√©partiteurs sont toujours avec nous.  Mais quelque chose a s√©rieusement chang√©, quelque chose a √©t√© g√©n√©ralement jet√©.  Par cons√©quent, le simple fait de prendre SO-5.6.0 et de recompiler votre code √©chouera.  Quelque chose doit √™tre r√©√©crit.  Quelque chose devra peut-√™tre √™tre repens√©. </p><br><p>  Pourquoi avons-nous pris soin de la compatibilit√© pendant plusieurs ann√©es, puis avons d√©cid√© de tout prendre et tout casser?  Et qu'est-ce qui s'est cass√© le plus profond√©ment? </p><br><p>  J'essaierai d'en parler dans cet article. </p><br><h1 id="zachem-voobsche-potrebovalos-chto-to-lomat">  Pourquoi aviez-vous besoin de casser quelque chose? </h1><br><p>  C'est aussi simple que cela. </p><a name="habracut"></a><br><p>  SObjectizer-5.5 au cours de son d√©veloppement a absorb√© tant de choses diff√©rentes et diverses qui n'√©taient pas initialement pr√©vues, en cons√©quence, il a form√© trop de b√©quilles et d'accessoires √† l'int√©rieur.  Avec chaque nouvelle version, ajouter quelque chose de nouveau √† SO-5.5 devenait de plus en plus difficile.  Et enfin, √† la question "Pourquoi avons-nous besoin de tout cela?"  aucune r√©ponse appropri√©e n'a √©t√© trouv√©e. </p><br><p>  La premi√®re raison est donc la re-complication des abats de SObjectizer. </p><br><p>  La deuxi√®me raison est que nous sommes stupidement fatigu√©s de nous concentrer sur les anciens compilateurs C ++.  La branche 5.5 a commenc√© en 2014, lorsque nous avions, si je ne me trompe pas, gcc-4.8 et MSVS2013.  Et √† ce niveau, nous avons continu√© √† maintenir la barre des exigences pour le niveau de support pour la norme C ++. </p><br><p>  Au d√©part, nous avions un ¬´int√©r√™t √©go√Øste¬ª √† cet √©gard.  De plus, pendant un certain temps, nous avons consid√©r√© les faibles exigences de qualit√© de support pour la norme C ++ comme notre "avantage concurrentiel". </p><br><p>  Mais le temps passe, "l'int√©r√™t √©go√Øste" est r√©volu.  Certains avantages d'un tel "avantage concurrentiel" ne sont pas visibles.  Peut-√™tre qu'ils le seraient, si nous travaillions avec C ++ 98, alors nous serions int√©ress√©s par l'entreprise sanglante.  Mais l'entreprise sanglante de ceux comme nous, en principe, n'est pas int√©ress√©e.  Il a donc √©t√© d√©cid√© d'arr√™ter de nous limiter et de prendre quelque chose de plus frais.  Nous avons donc pris le plus frais de l'√©curie en ce moment: C ++ 17. </p><br><p>  √âvidemment, tout le monde n'aimera pas cette solution, apr√®s tout, pour beaucoup de C ++ 17, c'est maintenant un bord d'attaque inaccessible, qui est encore tr√®s, tr√®s loin. </p><br><p>  N√©anmoins, nous avons d√©cid√© d'un tel risque.  Tout de m√™me, le processus de vulgarisation de SObjectizer ne va pas vite, donc quand SObjectizer devient plus ou moins largement sollicit√©, C ++ 17 ne sera plus un ¬´bord d'attaque¬ª.  Au lieu de cela, il sera trait√© de la m√™me mani√®re que maintenant en C ++ 11. </p><br><p>  En g√©n√©ral, au lieu de continuer √† construire des b√©quilles en utilisant un sous-ensemble de C ++ 11, nous avons d√©cid√© de refaire s√©rieusement les internes de SObjectizer en utilisant C ++ 17.  Construire une base sur laquelle SObjectizer pourra progressivement se d√©velopper au cours des quatre ou cinq prochaines ann√©es. </p><br><h1 id="chto-serezno-pomenyalos-v-sobjectizer-56">  Qu'est-ce qui a s√©rieusement chang√© dans SObjectizer-5.6? </h1><br><p>  Passons maintenant bri√®vement en revue certains des changements les plus frappants. </p><br><h2 id="u-kooperaciy-agentov-bolshe-net-strokovyh-imen">  Les coop√©rations d'agent n'ont plus de nom de cha√Æne </h2><br><h3 id="problema">  Le probl√®me </h3><br><p>  D√®s le d√©but, SObjectizer-5 a exig√© que chaque coop√©ration ait son propre nom de cha√Æne unique.  Cette fonctionnalit√© a √©t√© h√©rit√©e du cinqui√®me SObjectizer du pr√©c√©dent, quatri√®me SObjectizer. </p><br><p>  Par cons√©quent, SObjectizer devait stocker les noms des coop√©rations enregistr√©es.  V√©rifiez leur caract√®re unique lors de l'inscription.  Recherche de coop√©ration par nom lors de la d√©sinscription, etc., etc. </p><br><p>  Depuis les toutes premi√®res versions, un sch√©ma simple a √©t√© utilis√© dans SObjectzer-5: un dictionnaire unique de coop√©rations enregistr√©es prot√©g√©es par mutex.  Lors de l'enregistrement d'une coop√©ration, mutex est captur√©, l'unicit√© du nom de la coop√©ration, la pr√©sence d'un parent, etc. sont v√©rifi√©es.  Apr√®s v√©rification, le dictionnaire est modifi√©, apr√®s quoi le mutex est lib√©r√©.  Cela signifie que si en m√™me temps l'enregistrement / le d√©senregistrement de plusieurs coop√©rations commence √† la fois, alors √† certains moments, ils s'arr√™teront et attendront que l'une des op√©rations se termine avec le dictionnaire coop√©ratif.  Pour cette raison, les op√©rations coop√©ratives n'ont pas bien √©volu√©. </p><br><p>  C'est ce dont je voulais me d√©barrasser pour am√©liorer la situation avec la rapidit√© d'enregistrement des coop√©rations. </p><br><h3 id="reshenie">  Solution </h3><br><p>  Deux fa√ßons principales de r√©soudre ce probl√®me ont √©t√© envisag√©es. </p><br><p>  Premi√®rement, le stockage des noms de cha√Æne, mais la modification de la fa√ßon dont le dictionnaire est stock√© afin que l'op√©ration d'enregistrement de coop√©ration puisse √©voluer.  Par exemple, le partage de dictionnaire, c.-√†-d.  le briser en plusieurs morceaux, dont chacun serait prot√©g√© par son mutex. </p><br><p>  Deuxi√®mement, un rejet complet des noms de cha√Æne et l'utilisation de certains identifiants attribu√©s par SObjectizer. </p><br><p> En cons√©quence, nous avons choisi la deuxi√®me m√©thode et abandonn√© compl√®tement la d√©nomination des coop√©ratives.  Maintenant, dans SObjectizer, il existe une chose telle que <code>coop_handle</code> , c'est-√†-dire  un handle dont le contenu est cach√© √† l'utilisateur, mais qui peut √™tre compar√© √† <code>std::weak_ptr</code> . </p><br><p>  SObjectizer renvoie <code>coop_handle</code> lors de l'enregistrement d'une collaboration: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> coop = env.make_coop(); ... <span class="hljs-comment"><span class="hljs-comment">//    . auto coop_id = env.register_coop(std::move(coop)); // . //   coop_id    .</span></span></code> </pre> <br><p>  Cette poign√©e doit √™tre utilis√©e pour le retrait de la coop√©ration: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> coop = env.make_coop(); ... <span class="hljs-comment"><span class="hljs-comment">//    . auto coop_id = env.register_coop(std::move(coop)); // . //   coop_id    . ... // - . // ,     . //       . env.deregister_coop(coop_id, ...);</span></span></code> </pre> <br><p>  En outre, cette poign√©e doit √™tre utilis√©e lors de l'√©tablissement d'une relation parent-enfant: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   . auto parent = env.make_coop(); ... //  parent . auto parent_id = env.register_coop(std::move(parent)); //  . ... //      ,    . auto child = env.make_coop(parent_id); ...</span></span></code> </pre> <br><p>  La structure du r√©f√©rentiel de coop√©ration au sein de l'environnement SObjectizer a √©galement radicalement chang√©.  Si, avant la version 5.5 incluse, il s'agissait d'un dictionnaire commun, chaque coop√©ration est d√©sormais un r√©f√©rentiel de liens vers les coop√©rations enfants.  C'est-√†-dire  les coop√©ratives forment un arbre avec une racine dans une coop√©rative racine sp√©ciale cach√©e √† l'utilisateur. </p><br><p>  Une telle structure permet de mieux redimensionner <code>register_coop</code> op√©rations <code>register_coop</code> et <code>deregister_coop</code> : le blocage mutuel des op√©rations parall√®les ne se produit que si elles appartiennent toutes deux √† la m√™me coop√©ration parentale.  Pour plus de clart√©, voici le r√©sultat du lancement d'un <a href="" rel="nofollow">benchmark sp√©cial</a> qui mesure les performances des op√©rations avec les coop√©rations sur mon ancien portable avec Ubuntu 16.04 et GCC-7.3: </p><br><pre> <code class="plaintext hljs">_test.bench.so_5.parallel_parent_child -r 4 -l 7 -s 5 Configuration: roots: 4, levels: 7, level-size: 5 parallel_parent_child: 15.69s 488280 488280 488280 488280 Total: 1953120</code> </pre> <br><p>  C'est-√†-dire  la version 5.6.0 a g√©r√© pr√®s de 2 millions de coop√©rations en ~ 15,5 secondes. </p><br><p>  Et voici la version 5.5.24.4, la derni√®re de la branche 5.5 pour le moment: </p><br><pre> <code class="plaintext hljs">_test.bench.so_5.parallel_parent_child -r 4 -l 7 -s 5 Configuration: roots: 4, levels: 7, level-size: 5 parallel_parent_child: 46.856s 488280 488280 488280 488280 Total: 1953120</code> </pre> <br><p>  Le m√™me sc√©nario, mais le r√©sultat est trois fois pire. </p><br><h2 id="ostalsya-vsego-odin-vid-dispetcherov">  Il ne reste qu'un seul type de r√©partiteurs </h2><br><p>  Les r√©partiteurs sont l'une des pierres angulaires de SObjectizer.  Ce sont les r√©partiteurs qui d√©terminent o√π et comment les agents traiteront leurs messages.  Donc, sans l'id√©e de r√©partiteurs, il n'y aurait probablement pas eu de SObjectizer. </p><br><p>  Cependant, les r√©partiteurs eux-m√™mes ont √©volu√©, √©volu√© et √©volu√© au point qu'il n'√©tait m√™me pas difficile pour nous de cr√©er un nouveau r√©partiteur pour SObjectizer-5.5.  Mais tr√®s g√™nant.  Cependant, prenons-le dans l'ordre. </p><br><p>  Initialement, tous les r√©partiteurs dont l'application avait besoin ne pouvaient √™tre cr√©√©s qu'au d√©marrage de SObjectizer: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { <span class="hljs-comment"><span class="hljs-comment">/* -   */</span></span> }, <span class="hljs-comment"><span class="hljs-comment">//    SObjectizer-. []( so_5::environment_params_t &amp; params ) { p.add_named_dispatcher("active_obj", so_5::disp::active_obj::create_disp()); p.add_named_dispatcher("shutdowner", so_5::disp::active_obj::create_disp()); p.add_named_dispatcher("groups", so_5::disp::active_group::create_disp()); ... } );</span></span></code> </pre> <br><p>  Je n'ai pas cr√©√© le manager n√©cessaire avant le d√©part - tout, c'est ma faute, vous ne pouvez rien changer. </p><br><p>  Il est clair que cela n'est pas pratique et √† mesure que les sc√©narios d'utilisation de SObjectizer se d√©veloppaient, il √©tait n√©cessaire de r√©soudre ce probl√®me.  Par cons√©quent, la m√©thode <code>add_dispatcher_if_not_exists</code> , qui a v√©rifi√© la pr√©sence du r√©partiteur et, s'il n'y en avait pas, a permis de cr√©er une nouvelle instance: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . env.add_dispatcher_if_not_exists( "extra_dispatcher", []{ return so_5::disp::active_obj::create_disp(); } ); }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Ces r√©partiteurs √©taient appel√©s publics.  Les r√©partiteurs publics avaient des noms uniques.  Et en utilisant ces noms, les agents √©taient li√©s aux r√©partiteurs: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . env.add_dispatcher_if_not_exists( "extra_dispatcher", []{ return so_5::disp::active_obj::create_disp(); } ); //         //    . auto coop = env.create_coop( "ping_pong", //     extra_dispatcher. so_5::disp::active_obj::create_disp_binder( "extra_dispatcher" ) ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Mais les r√©partiteurs publics avaient une caract√©ristique d√©sagr√©able.  Ils ont commenc√© √† travailler imm√©diatement apr√®s avoir √©t√© ajout√©s √† l'environnement SObjectizer et ont continu√© √† travailler jusqu'√† ce que l'environnement SObjectizer termine son travail. </p><br><p>  Encore une fois, au fil du temps, il a commenc√© √† interf√©rer.  Il fallait veiller √† ce que des r√©partiteurs puissent √™tre ajout√©s selon les besoins et que les r√©partiteurs devenus inutiles soient automatiquement supprim√©s. </p><br><p>  Il y avait donc des r√©partiteurs ¬´priv√©s¬ª.  Ces r√©partiteurs n'avaient pas de nom et vivaient tant qu'il y avait des r√©f√©rences √† eux.  Des r√©partiteurs priv√©s pouvaient √™tre cr√©√©s √† tout moment apr√®s le d√©marrage de l'environnement SObjectizer, ils √©taient d√©truits automatiquement. </p><br><p>  En g√©n√©ral, les r√©partiteurs priv√©s se sont av√©r√©s √™tre un maillon tr√®s r√©ussi dans l'√©volution des r√©partiteurs, mais travailler avec eux √©tait tr√®s diff√©rent de travailler avec des r√©partiteurs publics: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . auto disp = so_5::disp::active_obj::create_private_disp(env); //         //    . auto coop = env.create_coop( "ping_pong", //      . disp-&gt;binder() ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Encore plus de r√©partiteurs priv√©s et publics diff√©raient dans la mise en ≈ìuvre.  Par cons√©quent, afin de ne pas dupliquer le code et d'√©crire s√©par√©ment le r√©partiteur public et priv√© du m√™me type, j'ai d√ª utiliser des constructions plut√¥t complexes avec des mod√®les et l'h√©ritage. </p><br><p>  En cons√©quence, j'√©tais fatigu√© d'accompagner toute cette vari√©t√©, et dans SObjectizer-5.6, il ne restait qu'un seul type de r√©partiteurs.  En fait, c'est un analogue des r√©partiteurs priv√©s.  Mais seulement sans mention explicite du mot "priv√©".  Alors maintenant, le fragment montr√© ci-dessus sera √©crit comme suit: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . auto disp = so_5::disp::active_obj::make_dispatcher(env); //         //    . auto coop = env.create_coop( "ping_pong", //      . disp.binder() ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><h2 id="ostalis-tolko-svobodnye-funkcii-send-send_delayed-i-send_periodic">  Il n'y a que des fonctions libres send, send_delayed et send_periodic left </h2><br><p>  Le d√©veloppement de l'API pour l'envoi de messages √† SObjectizer est probablement l'exemple le plus frappant de la fa√ßon dont SObjectizer a chang√© car la prise en charge de C ++ 11 s'est am√©lior√©e dans les compilateurs √† notre disposition. </p><br><p>  Tout d'abord, les messages ont √©t√© envoy√©s comme ceci: </p><br><pre> <code class="cpp hljs">mbox-&gt;deliver_message(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> my_message(...));</code> </pre> <br><p>  Ou, si vous suivez les "recommandations des meilleurs √©leveurs de chiens" (c): </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;my_message&gt; msg(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> my_message(...)); mbox-&gt;deliver_message(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(msg));</code> </pre> <br><p>  Cependant, nous avons mis √† notre disposition des compilateurs avec prise en charge des mod√®les variadiques et des fonctions d'envoi.  Il est devenu possible d'√©crire comme ceci: </p><br><pre> <code class="cpp hljs">send&lt;my_message&gt;(target, ...);</code> </pre> <br><p>  Certes, il a fallu plus de temps √† toute une famille pour se <code>send_to_agent</code> partir d'un simple <code>send</code> , y compris <code>send_to_agent</code> , <code>send_delayed_to_agent</code> , etc.  Et puis, pour rendre cette famille plus √©troite √† l'ensemble familier de <code>send</code> , <code>send_delayed</code> et <code>send_periodic</code> . </p><br><p>  Mais, malgr√© le fait que la famille des fonctions d'envoi a √©t√© form√©e il y a assez longtemps et est le moyen recommand√© pour envoyer des messages depuis plusieurs ann√©es, les anciennes m√©thodes telles que <code>deliver_message</code> , <code>schedule_timer</code> et <code>single_timer</code> √©taient toujours disponibles pour l'utilisateur. </p><br><p>  Mais dans la version 5.6.0, seules les fonctions free <code>send</code> , <code>send_delayed</code> et <code>send_periodic</code> √©taient enregistr√©es dans l'API publique SObjectizer.  Tout le reste a √©t√© soit compl√®tement supprim√©, soit transf√©r√© dans les espaces de noms SObjectizer internes. </p><br><p>  Donc, dans SObjectizer-5.6, l'interface d'envoi de messages est finalement devenue ce qu'elle aurait √©t√© si nous avions des compilateurs avec un support C ++ 11 normal d√®s le d√©but.  Eh bien, en plus de cela, si nous avions l'exp√©rience de l'utilisation de ce C ++ 11 tr√®s normal. </p><br><h2 id="edinyy-format-send_delayed-i-send_periodic">  Format unique send_delayed et send_periodic </h2><br><p>  Avec les fonctions <code>send_delayed</code> et <code>send_periodic</code> dans les versions pr√©c√©dentes de SObjectizer, il y a eu un autre incident. </p><br><p>  Pour utiliser le minuteur, vous devez avoir acc√®s √† l'environnement SObjectizer.  √Ä l'int√©rieur de l'agent, il existe un lien vers l'environnement SObjectizer.  Et √† l'int√©rieur de mchain, il y a un tel lien.  Mais √† l'int√©rieur de la mbox, elle n'√©tait pas l√†.  Par cons√©quent, si un message en attente a √©t√© envoy√© √† un agent ou √† mchain, l'appel <code>send_delayed</code> √†: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(target_agent, pause, ...); send_delayed&lt;my_message&gt;(target_mchain, pause, ...);</code> </pre> <br><p>  Pour le cas de mbox, nous avons d√ª prendre un lien vers l'environnement SObjectizer ailleurs: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;so_environment(), target_mbox, pause, ...);</code> </pre> <br><p>  Cette fonctionnalit√© de <code>send_delayed</code> et <code>send_periodic</code> √©tait un √©clat mineur.  Ce qui n'est pas tellement g√™nant, mais assez ennuyeux.  Et tout cela parce qu'au d√©part, nous n'avions pas commenc√© √† stocker le lien vers l'environnement SObjectizer dans mbox-ahs. </p><br><p>  La violation de la compatibilit√© avec les versions pr√©c√©dentes √©tait une bonne raison de se d√©barrasser de cet √©clat. </p><br><p>  Vous pouvez maintenant d√©couvrir √† partir de mbox pour quel environnement SObjectizer il a √©t√© cr√©√©.  Et cela a permis d'utiliser les <code>send_delayed</code> simples <code>send_delayed</code> et <code>send_periodic</code> pour tout type de destinataire de message de temporisation: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(target_agent, pause, ...); send_delayed&lt;my_message&gt;(target_mchain, pause, ...); send_delayed&lt;my_message&gt;(target_mbox, pause, ...);</code> </pre> <br><p>  Dans le sens litt√©ral, "une bagatelle, mais agr√©able." </p><br><h2 id="net-bolshe-ad-hoc-agentov">  Plus d'agents ad hoc </h2><br><p>  Comme le dit le proverbe, "Chaque accident a un pr√©nom, un deuxi√®me pr√©nom et un nom de famille."  Dans le cas des agents ad hoc, voici mon pr√©nom, mon deuxi√®me pr√©nom et mon nom de famille :( </p><br><p>  Le point est le suivant.  Lorsque nous avons commenc√© √† parler de SObjectizer-5 en public, nous avons entendu beaucoup de reproches concernant la verbosit√© du code des exemples de SObjectizer.  Et personnellement, cette verbosit√© m'a sembl√© un probl√®me s√©rieux que je dois s√©rieusement affronter. </p><br><p>  Une source de verbosit√© est la n√©cessit√© pour les agents d'h√©riter du type de base sp√©cial <code>agent_t</code> .  Et de cela, semble-t-il, il n'y a pas d'√©chappatoire.  Ou pas? </p><br><p>  Il y avait donc des agents ad hoc, c'est-√†-dire  agents, pour la d√©termination desquels il n'√©tait pas n√©cessaire d'√©crire une classe distincte, il suffisait seulement de r√©gler la r√©action aux messages sous la forme de fonctions lambda.  Par exemple, l'exemple classique de ping-pong sur les agents ad-hoc pourrait √™tre √©crit comme ceci: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pinger = coop-&gt;define_agent(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ponger = coop-&gt;define_agent(); pinger .on_start( [ponger]{ so_5::send&lt; msg_ping &gt;( ponger ); } ) .event&lt; msg_pong &gt;( pinger, [ponger]{ so_5::send&lt; msg_ping &gt;( ponger ); } ); ponger .event&lt; msg_ping &gt;( ponger, [pinger]{ so_5::send&lt; msg_pong &gt;( pinger ); } );</code> </pre> <br><p>  C'est-√†-dire  pas de cours √† part.  Nous appelons juste <code>define_agent()</code> sur la coop√©ration et obtenons une sorte d'objet agent, auquel vous pouvez vous abonner aux messages entrants. </p><br><p>  Donc, dans SObjectizer-5, il y avait une s√©paration en agents r√©guliers et ad hoc. </p><br><p>  Ce qui n'a pas apport√© de bonus visibles, seulement les co√ªts de main-d'≈ìuvre suppl√©mentaires pour accompagner une telle s√©paration.  Et au fil du temps, il est devenu clair que les agents ad hoc sont comme une valise sans poign√©e: c'est difficile √† transporter et c'est dommage de partir.  Mais en travaillant sur SObjectizer-5.6, il a √©t√© d√©cid√© de quitter. </p><br><p>  Dans le m√™me temps, une autre le√ßon a √©galement √©t√© apprise, peut-√™tre encore plus importante: dans toute discussion publique sur l'outil sur Internet, un grand nombre de personnes participeront qui sont indiff√©rents √† ce qu'est l'outil, pourquoi il est n√©cessaire, pourquoi il est tel qu'il est cens√© √™tre utilis√©, etc.  Il est simplement important pour eux d'exprimer leur forte opinion.  Dans le segment Internet de langue russe, en plus de cela, il est toujours tr√®s important de dire aux d√©veloppeurs de l'outil comment ils sont stupides et sans instruction, et combien le r√©sultat de leur travail n'est pas n√©cessaire. </p><br><p>  Par cons√©quent, vous devez √™tre tr√®s prudent dans ce que l'on vous dit.  Et vous pouvez √©couter (puis attentivement) uniquement ce qui est dit ici dans cette veine: "J'ai essay√© de le faire sur votre instrument et je n'aime pas la quantit√© de code qu'il contient ici."  M√™me ces souhaits doivent √™tre trait√©s avec beaucoup de soin: "Je prendrais votre d√©veloppement si cela √©tait plus facile ici et ici." </p><br><p>  Malheureusement, la comp√©tence de ¬´filtrage¬ª d√©clar√©e par les ¬´sympathisants¬ª sur Internet il y a environ cinq ans √©tait bien moindre qu'aujourd'hui.  Par cons√©quent, une telle exp√©rience sp√©cifique en tant qu'agents ad-hoc dans SObjectizer. </p><br><h2 id="sobjectizer-56-bolshe-ne-podderzhivaet-sinhronnogo-vzaimodeystviya-agentov">  SObjectizer-5.6 ne prend plus en charge l'interaction d'agent synchronis√© </h2><br><p>  Le sujet de l'interaction synchronis√©e entre les agents est tr√®s ancien et douloureux. </p><br><p>  Cela a commenc√© √† l'√©poque de SObjectizer-4.  Et dans SObjectizer-5 a continu√©.  Jusqu'√† pr√©sent, enfin, le soi-disant  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">demandes de service</a> .  Ce qui au d√©part, certes, √©tait effrayant comme la mort.  Mais j'ai r√©ussi √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">leur donner un look plus ou moins d√©cent</a> . </p><br><p>  Mais cela s'est av√©r√© √™tre le cas m√™me lorsque la premi√®re cr√™pe est sortie grumeleuse :( </p><br><p>  Dans SObjectizer, j'ai d√ª impl√©menter la livraison et le traitement des messages r√©guliers d'une mani√®re, et la livraison et le traitement des demandes synchrones d'une autre.  Il est particuli√®rement triste que ces fonctionnalit√©s aient d√ª √™tre prises en compte, y compris lors de l'impl√©mentation de vos propres mbox. </p><br><p>  Et apr√®s que la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctionnalit√© des messages d'enveloppe a</a> √©t√© ajout√©e √† SObjectizer, il est devenu n√©cessaire de regarder encore plus souvent et encore plus attentivement les diff√©rences entre les messages r√©guliers et les demandes synchrones. </p><br><p>  En g√©n√©ral, avec les demandes synchrones pendant la maintenance / le d√©veloppement de SObjectizer, il y avait trop de maux de t√™te.  √Ä tel point qu'au d√©but, il y avait une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">volont√© concr√®te de se d√©barrasser de ces demandes tr√®s synchrones</a> .  Et puis ce d√©sir s'est r√©alis√©. </p><br><p>  Ainsi, dans SObjectizer-5.6, les agents peuvent √† nouveau interagir uniquement via des messages asynchrones. </p><br><p>  Et comme parfois une interaction synchrone est toujours n√©cessaire, la prise en charge de ce type d'interaction a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">√©t√© soumise au projet so5extra qui l'accompagne</a> : </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    "-". using my_request_reply = so_5::extra::sync::request_reply_t&lt;my_request, my_reply&gt;; ... //  ,    . class request_handler final : public so_5::agent_t { ... //  .      . void on_request(typename my_request_reply::request_mhood_t cmd) { ... //  . //      cmd-&gt;request(). //   . cmd-&gt;make_reply(...); //      my_reply. } ... void so_define_agent() override { //       . so_subscribe_self().event(&amp;request_handler::on_request); } }; ... //     . so_5::mbox_t handler_mbox = ...; //        15s. //    ,    . my_reply reply = my_request_reply::ask_value(handler_mbox, 15s, ...); //       my_request.</span></span></code> </pre> <br><p>  C'est-√†-dire  Maintenant, travailler avec des requ√™tes synchrones est fondamentalement diff√©rent en ce sens que le gestionnaire de requ√™tes ne renvoie pas de valeur de la m√©thode du gestionnaire, comme c'√©tait le cas auparavant.  Au lieu de cela, la m√©thode <code>make_reply</code> est <code>make_reply</code> . </p><br><p>  La nouvelle impl√©mentation est bonne dans la mesure o√π la demande et la r√©ponse sont envoy√©es √† l'int√©rieur du SObjectizer comme des messages asynchrones r√©guliers.  En fait, <code>make_reply</code> est une impl√©mentation l√©g√®rement plus sp√©cifique de <code>send</code> . </p><br><p>  Et, plus important encore, la nouvelle impl√©mentation nous a permis d'obtenir des fonctionnalit√©s qui √©taient auparavant inaccessibles: </p><br><ul><li>  les requ√™tes synchrones (c'est-√†-dire les objets <code>request_reply_t&lt;Request, Reply&gt;</code> ) peuvent maintenant √™tre enregistr√©es et / ou transmises √† d'autres gestionnaires.  Qu'est-ce qui permet de mettre en ≈ìuvre diff√©rents sch√©mas d'√©quilibrage de charge; </li><li>  Vous pouvez faire en sorte que la r√©ponse √† la demande apparaisse dans une mbox r√©guli√®re de l'agent initiant la demande.  Et l'agent initiateur traitera la r√©ponse de la mani√®re habituelle, comme tout autre message; </li><li>  Vous pouvez envoyer plusieurs demandes √† diff√©rents destinataires √† la fois, puis analyser leurs r√©ponses dans l'ordre dans lequel elles ont √©t√© re√ßues: </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> first_dialog = so_5::extra::sync::<span class="hljs-keyword"><span class="hljs-keyword">request_reply_t</span></span>&lt;first_request, first_reply&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> second_dialog = so_5::extra::sync::<span class="hljs-keyword"><span class="hljs-keyword">request_reply_t</span></span>&lt;second_request, second_reply&gt;; <span class="hljs-comment"><span class="hljs-comment">//         . auto reply_ch = create_mchain(env); //     . first_dialog::initiate_with_custom_reply_to( one_service, reply_ch, so_5::extra::sync::do_not_close_reply_chain, ...); second_dialog::initiate_with_custom_reply_to( another_service, reply_ch, so_5::extra::sync::do_not_close_reply_chain, ...); //    . receive(from(reply_ch).handle_n(2).empty_timeout(15s), [](typename first_dialog::reply_mhood_t cmd) {...}, [](typename second_dialog::reply_mhood_t cmd) {...});</span></span></code> </pre> <br><p>  Donc, nous pouvons dire qu'avec l'interaction synchrone dans SObjectizer, les √©v√©nements suivants se sont produits: </p><br><ul><li>  il a longtemps disparu pour des raisons id√©ologiques; </li><li>  ensuite il a √©t√© ajout√© et il s'est av√©r√© que cette interaction est parfois utile; </li><li>  mais l'exp√©rience a montr√© que la premi√®re mise en ≈ìuvre n'est pas tr√®s r√©ussie; </li><li>  l'ancienne impl√©mentation a √©t√© compl√®tement abandonn√©e et une nouvelle impl√©mentation a √©t√© propos√©e en retour. </li></ul><br><p>  Ils ont travaill√© sur leurs propres erreurs, en g√©n√©ral. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Cet article, assez bri√®vement, a parl√© de plusieurs changements dans SObjectizer-5.6.0 et les raisons de ces changements. </p><br><p>  Une liste plus compl√®te des changements peut √™tre trouv√©e <a href="" rel="nofollow">ici</a> . </p><br><p>  En conclusion, je voudrais offrir √† ceux qui n'ont pas encore essay√© SObjectizer, prenez-le et essayez-le.  Et partagez avec nous vos sentiments: ce que vous avez aim√©, ce que vous n'avez pas aim√©, ce qui manquait. </p><br><p>  Nous √©coutons attentivement tous les commentaires / suggestions constructifs.  De plus, ces derni√®res ann√©es, seul ce dont quelqu'un a besoin est inclus dans SObjectizer.  Donc, si vous ne nous dites pas ce que vous aimeriez avoir dans SObjectizer, cela n'appara√Ætra pas.  Et si vous me le dites, alors qui sait ...;) </p><br><p>  Le projet vit et se d√©veloppe maintenant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ici</a> .  Et pour ceux qui ont l'habitude d'utiliser uniquement GitHub, il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">miroir GitHub</a> .  Ce miroir est compl√®tement nouveau, vous pouvez donc ignorer le manque d'√©toiles. </p><br><p>  PS.  Vous pouvez suivre les actualit√©s li√©es √† SObjectizer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">dans ce groupe Google</a> .  L√†, vous pouvez soulever des probl√®mes li√©s √† SObjectizer. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453256/">https://habr.com/ru/post/fr453256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453242/index.html">Aire de jeux pour les √©v√©nements d'√©t√©</a></li>
<li><a href="../fr453246/index.html">ERP - Syst√®me de d√©gradation continue</a></li>
<li><a href="../fr453248/index.html">Artemis Lunar Mission - lancement de la production de l'√©l√©ment principal de la station orbitale lunaire Lunar Gateway</a></li>
<li><a href="../fr453252/index.html">Comment nous avons fait le programme du club Sportmaster</a></li>
<li><a href="../fr453254/index.html">√Ä propos du code de GOST, Grasshopper, son SBox et les graines perdues</a></li>
<li><a href="../fr453258/index.html">Cr√©ation d'une p√©dale de r√©verb√©ration √† l'aide de puces PT2399 (partie 1)</a></li>
<li><a href="../fr453260/index.html">Fonctions de param√©trage DPI</a></li>
<li><a href="../fr453262/index.html">O√π sont stock√©es vos constantes sur le microcontr√¥leur CortexM (en utilisant le compilateur IAR C ++ comme exemple)</a></li>
<li><a href="../fr453264/index.html">Virtuali-tee: un ¬´T-shirt m√©dical¬ª qui ne couvre pas mais expose</a></li>
<li><a href="../fr453272/index.html">Sponsors GitHub: une nouvelle fa√ßon de contribuer √† l'open source</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>