<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèª üöÆ üë©‚Äçüëß‚Äçüë¶ Mon impl√©mentation de tampon en anneau dans NOR flash üëÑ üç™ üëéüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Contexte 


 Il existe des distributeurs automatiques de notre propre conception. √Ä l'int√©rieur du Raspberry Pi et un peu de cerclage sur une carte s√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mon impl√©mentation de tampon en anneau dans NOR flash</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479044/"><h1 id="predystoriya">  Contexte </h1><br><p>  Il existe des distributeurs automatiques de notre propre conception.  √Ä l'int√©rieur du Raspberry Pi et un peu de cerclage sur une carte s√©par√©e.  Un accepteur de pi√®ces, un accepteur de billets, un terminal bancaire sont connect√©s ... Un programme auto-√©crit g√®re tout.  L'historique complet de l'≈ìuvre est √©crit dans le magazine sur une cl√© USB (MicroSD), qui est ensuite transmis via Internet (√† l'aide d'un modem USB) au serveur, o√π il est ajout√© √† la base de donn√©es.  Les informations de vente sont charg√©es en 1s, il y a aussi une interface web simple pour le suivi, etc. </p><br><p>  C'est-√†-dire que le magazine est vital - pour la comptabilit√© (les revenus, les ventes, etc.), le suivi (toutes sortes de d√©faillances et autres circonstances de force majeure);  ceci, vous pouvez dire, toutes les informations que nous avons sur cette machine. </p><br><h1 id="problema">  Le probl√®me </h1><br><p>  Les lecteurs flash se pr√©sentent comme des appareils tr√®s peu fiables.  Ils √©chouent avec une r√©gularit√© enviable.  Cela entra√Æne √† la fois un arr√™t de la machine et (si pour une raison quelconque le journal n'a pas pu √™tre transmis en ligne) une perte de donn√©es. </p><br><p>  <em>Ce n'est pas la premi√®re exp√©rience d'utilisation de lecteurs flash, avant qu'il y ait un autre projet avec plus d'une centaine d'appareils o√π le magazine √©tait stock√© sur des lecteurs flash USB, il y avait aussi des probl√®mes de fiabilit√©, parfois le nombre de pannes par mois √©tait de l'ordre de la dizaine.</em>  <em>Nous avons essay√© diff√©rents lecteurs flash, y compris ceux de marque sur la m√©moire SLC, et certains mod√®les sont plus fiables que d'autres, mais le remplacement des lecteurs flash n'a pas r√©solu radicalement le probl√®me.</em> </p><a name="habracut"></a><br><p>  <strong>Attention!</strong>  Longrid!  Si vous n'√™tes pas int√©ress√© par le ¬´pourquoi¬ª, mais uniquement par le ¬´comment¬ª, vous pouvez imm√©diatement aller <a href="https://habr.com/ru/post/479044/">√† la fin de l'</a> article. </p><br><h1 id="reshenie">  Solution </h1><br><p>  La premi√®re chose qui vient √† l'esprit: abandonner MicroSD, mettre, par exemple, SSD et d√©marrer √† partir de celui-ci.  C'est th√©oriquement possible, probablement, mais relativement cher et pas si fiable (un adaptateur USB-SATA est ajout√©; sur les SSD √† petit budget, les statistiques de d√©faillance ne sont pas satisfaisantes non plus). </p><br><p>  Le disque dur USB ne semble pas non plus une solution particuli√®rement attrayante. </p><br><p>  Par cons√©quent, nous sommes arriv√©s √† cette option: laisser le t√©l√©chargement depuis MicroSD, mais les utiliser en mode lecture seule, et stocker le journal des op√©rations (et d'autres informations uniques √† un mat√©riel sp√©cifique - num√©ro de s√©rie, √©talonnages des capteurs, etc.) ailleurs. </p><br><p>  Le sujet de la FS en lecture seule pour les framboises a d√©j√† √©t√© √©tudi√© √† plusieurs reprises, je ne m'attarderai pas sur les d√©tails de la mise en ≈ìuvre dans cet article <em>(mais s'il y a un int√©r√™t, j'√©crirai peut-√™tre un mini-article sur ce sujet)</em> .  Le seul point que je veux noter: √† la fois par exp√©rience personnelle et par des critiques qui ont d√©j√† mis en place un gain de fiabilit√©, c'est.  Oui, il est impossible de se d√©barrasser compl√®tement des pannes, mais il est tout √† fait possible de r√©duire consid√©rablement leur fr√©quence.  Oui, et les cartes deviennent unifi√©es, ce qui simplifie consid√©rablement le remplacement du personnel de maintenance. </p><br><h2 id="apparatnaya-chast">  Mat√©riel informatique </h2><br><p>  Il n'y avait aucun doute sur le choix du type de m√©moire - NOR Flash. <br>  Arguments: </p><br><ul><li>  connexion simple (le plus souvent le bus SPI, l'exp√©rience d'utilisation qui est d√©j√† l√†, donc pas de probl√®mes "de fer" √† pr√©voir); </li><li>  prix ridicule; </li><li>  protocole d'exploitation standard (l'impl√©mentation est d√©j√† dans le noyau Linux, si vous le souhaitez, vous pouvez prendre un tiers, qui est √©galement pr√©sent, ou m√™me √©crire le v√¥tre, l'avantage est simple); </li><li>  fiabilit√© et ressource: <br>  √† partir d'une fiche technique typique: les donn√©es sont stock√©es pendant 20 ans, 100 000 cycles d'effacement pour chaque bloc; <br>  √† partir de sources tierces: BER extr√™mement bas, il est postul√© qu'il n'y a pas besoin de codes de correction d'erreur <em>(dans certains articles, ECC pour NOR est pris en compte, mais g√©n√©ralement MLC NOR est l√†, cela arrive)</em> . </li></ul><br><p>  Estimons les besoins en volume et en ressources. </p><br><p>  Je veux avoir la garantie de sauvegarder les donn√©es pendant plusieurs jours.  Cela est n√©cessaire pour qu'en cas de probl√®me de connexion, l'historique des ventes ne soit pas perdu.  Nous allons nous concentrer sur 5 jours, pendant cette p√©riode <em>(m√™me en tenant compte des week-ends et jours f√©ri√©s),</em> nous pouvons r√©soudre le probl√®me. </p><br><p>  Nous tapons maintenant environ 100 Ko de magazine par jour (3 √† 4 000 enregistrements), mais progressivement ce chiffre augmente - les d√©tails augmentent, de nouveaux √©v√©nements sont ajout√©s.  De plus, il y a parfois des salves (certains capteurs commencent √† envoyer du spam avec des faux positifs, par exemple).  Nous calculerons 10 mille enregistrements de 100 octets - m√©gaoctets par jour. </p><br><p>  Un total de 5 Mo de donn√©es propres (bien compressibles) sort.  Ils ont √©galement <em>(estimation approximative)</em> 1 Mo de donn√©es de service. </p><br><p>  Autrement dit, nous avons besoin d'une puce de 8 Mo si vous n'utilisez pas la compression, ou de 4 Mo si vous l'utilisez.  Des nombres bien r√©els pour ce type de m√©moire. </p><br><p>  En ce qui concerne la ressource: si nous pr√©voyons que la m√©moire enti√®re ne sera r√©√©crite pas plus d'une fois tous les 5 jours, alors en 10 ans de service, nous obtenons moins de mille cycles de r√©√©criture. <br>  Je me souviens, le constructeur promet cent mille. </p><br><div class="spoiler">  <b class="spoiler_title">Un peu sur NOR vs NAND</b> <div class="spoiler_text"><p>  Aujourd'hui, bien s√ªr, la m√©moire NAND est beaucoup plus populaire, mais pour ce projet, je ne l'utiliserais pas: NAND, contrairement √† NOR, n√©cessite n√©cessairement l'utilisation de codes de correction d'erreur, une table de mauvais blocs, etc., et les jambes de puces NAND g√©n√©ralement beaucoup plus. </p><br><p>  Les inconv√©nients de NOR incluent: </p><br><ul><li>  petit volume (et, par cons√©quent, prix √©lev√© par m√©gaoctet); </li><li>  faible taux de change (en grande partie d√ª au fait qu'une interface s√©rie est utilis√©e, g√©n√©ralement SPI ou I2C); </li><li>  effacement lent (selon la taille du bloc, il faut compter des fractions de seconde √† plusieurs secondes). </li></ul><br><p>  Cela ne semble rien de critique pour nous, alors continuez. </p></div></div><br><p>  Si les d√©tails sont int√©ressants, c'est la puce <a href="https://www.adestotech.com/wp-content/uploads/doc3686.pdf" rel="nofollow">at25df321a qui a</a> √©t√© choisie <em>(cependant, c'est insignifiant, il y a beaucoup d'analogues sur le march√© qui sont compatibles avec le brochage et le syst√®me de commande; m√™me si nous voulons mettre la puce d'un autre fabricant et / ou d'un autre volume, tout fonctionnera sans changer le code)</em> . </p><br><p>  J'utilise le pilote int√©gr√© au noyau Linux, sur Raspberry, gr√¢ce √† la prise en charge de la superposition de l'arborescence des p√©riph√©riques, tout est tr√®s simple - vous devez mettre la superposition compil√©e dans / boot / overlays et modifier un peu /boot/config.txt. </p><br><div class="spoiler">  <b class="spoiler_title">Exemple de fichier dts</b> <div class="spoiler_text"><p>  Honn√™tement, je ne sais pas ce qui est √©crit sans erreurs, mais √ßa marche. </p><br><pre><code class="plaintext hljs">/* * Device tree overlay for at25 at spi0.1 */ /dts-v1/; /plugin/; / { compatible = "brcm,bcm2835", "brcm,bcm2836", "brcm,bcm2708", "brcm,bcm2709"; /* disable spi-dev for spi0.1 */ fragment@0 { target = &lt;&amp;spi0&gt;; __overlay__ { status = "okay"; spidev@1{ status = "disabled"; }; }; }; /* the spi config of the at25 */ fragment@1 { target = &lt;&amp;spi0&gt;; __overlay__ { #address-cells = &lt;1&gt;; #size-cells = &lt;0&gt;; flash: m25p80@1 { compatible = "atmel,at25df321a"; reg = &lt;1&gt;; spi-max-frequency = &lt;50000000&gt;; /* default to false: m25p,fast-read ; */ }; }; }; __overrides__ { spimaxfrequency = &lt;&amp;flash&gt;,"spi-max-frequency:0"; fastread = &lt;&amp;flash&gt;,"m25p,fast-read?"; }; };</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Et une autre ligne dans config.txt</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">dtoverlay=at25:spimaxfrequency=50000000</code> </pre> </div></div><br><p>  Je vais omettre la description de la connexion de la puce au Raspberry Pi.  D'une part, je ne suis pas un expert en √©lectronique, d'autre part, tout est trivial m√™me pour moi: le microcircuit n'a que 8 jambes, dont nous avons besoin de masse, d'alimentation, SPI (CS, SI, SO, SCK);  les niveaux co√Øncident avec ceux du Raspberry Pi, aucune liaison suppl√©mentaire n'est requise - il suffit de connecter les 6 contacts sp√©cifi√©s. </p><br><h2 id="postanovka-zadachi">  √ânonc√© du probl√®me </h2><br><p>  Comme d'habitude, la formulation du probl√®me passe par plusieurs it√©rations, il me semble que le moment est venu pour la suivante.  Arr√™tons-nous donc, rassemblons ce qui a d√©j√† √©t√© √©crit et clarifions les d√©tails qui restent dans l'ombre. </p><br><p>  Nous avons donc d√©cid√© que le journal serait stock√© dans SPI NOR Flash. </p><br><div class="spoiler">  <b class="spoiler_title">Qu'est-ce que NOR Flash pour ceux qui ne connaissent pas</b> <div class="spoiler_text"><p>  Il s'agit d'une m√©moire non volatile avec laquelle vous pouvez effectuer trois op√©rations: </p><br><ol><li>  Lecture: <br>  La lecture la plus courante: nous transmettons l'adresse et lisons autant d'octets que n√©cessaire; </li><li>  Record: <br>  L'√©criture dans un flash NOR ressemble √† un flash ordinaire, mais elle a une particularit√©: vous ne pouvez changer que 1 en 0, mais pas l'inverse.  Par exemple, si nous avions 0x55 dans la cellule m√©moire, alors apr√®s y avoir √©crit 0x0f, 0x05 y sera d√©j√† stock√© <em>(voir le tableau ci-dessous)</em> ; </li><li>  Effacer: <br>  Bien s√ªr, nous devons √©galement pouvoir effectuer l'op√©ration inverse - changer 0 en 1, c'est pourquoi l'op√©ration d'effacement existe.  Contrairement aux deux premiers, il ne fonctionne pas en octets, mais en blocs (le bloc d'effacement minimum dans le microcircuit s√©lectionn√© est de 4 Ko).  L'effacement d√©truit le bloc entier et c'est la seule fa√ßon de changer 0 √† 1. Par cons√©quent, lorsque vous travaillez avec la m√©moire flash, vous devez souvent aligner les structures de donn√©es sur la bordure du bloc d'effacement. <br>  Enregistrer en NOR Flash: </li></ol><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Donn√©es binaires </th></tr></thead><tbody><tr><td>  <strong>√âtait</strong> </td><td> <code>01010101</code> </td> </tr><tr><td>  <strong>Enregistr√©</strong> </td><td> <code>00001111</code> </td> </tr><tr><td>  <strong>Est devenu</strong> </td><td> <code>00000101</code> </td> </tr></tbody></table></div></div></div><br><p>  Le journal lui-m√™me repr√©sente une s√©quence d'enregistrements de longueur variable.  Une longueur d'enregistrement typique est d'environ 30 octets (bien que des enregistrements de plusieurs kilo-octets se produisent parfois).  <em>Dans ce cas, nous travaillons avec eux comme un ensemble d'octets, mais, si vous √™tes int√©ress√©, CBOR est utilis√© dans les enregistrements.</em> </p><br><p>  En plus du journal, nous devons stocker certaines informations de "r√©glage", qu'elles soient mises √† jour ou non: un certain ID d'appareil, l'√©talonnage du capteur, l'indicateur "l'appareil est temporairement d√©sactiv√©", etc. <br>  Ces informations sont un ensemble d'enregistrements de valeurs-cl√©s, √©galement stock√©s dans CBOR. Nous n'avons pas beaucoup de ces informations (quelques kilo-octets maximum), elles sont rarement mises √† jour. <br>  √Ä l'avenir, nous l'appellerons contexte. </p><br><p>  Si vous vous souvenez o√π cet article a commenc√©, il est tr√®s important de garantir la fiabilit√© du stockage des donn√©es et, si possible, un fonctionnement continu m√™me en cas de panne mat√©rielle / corruption de donn√©es. </p><br><p>  Quelles sources de probl√®mes peuvent √™tre envisag√©es? </p><br><ul><li>  Mettez hors tension pendant les op√©rations d'√©criture / effacement.  Il s'agit de la cat√©gorie ¬´contre la ferraille sans r√©ception¬ª. <br>  Informations issues de la <a href="https://electronics.stackexchange.com/questions/225956/what-would-happen-in-case-of-power-outage-during-nor-flash-erase-or-programming" rel="nofollow">discussion</a> sur stackexchange: lorsque l'alimentation est coup√©e lorsque vous travaillez avec le flash, cet effacement (mise √† 1), cette √©criture (mise √† 0) conduisent √† un comportement ind√©fini: les donn√©es peuvent √™tre √©crites, partiellement √©crites (disons, nous avons transf√©r√© 10 octets / 80 bits , et seulement 45 bits ont r√©ussi √† √™tre enregistr√©s), il est √©galement possible que certains des bits soient √† l'√©tat "interm√©diaire" (la lecture peut produire soit 0 soit 1); </li><li>  Erreurs de la m√©moire flash elle-m√™me. <br>  Le BER, bien que tr√®s faible, ne peut pas √™tre √©gal √† z√©ro; </li><li>  Erreurs de bus <br>  Les donn√©es transmises via SPI ne sont en aucun cas prot√©g√©es, cela peut tr√®s bien se produire sous la forme d'erreurs sur un seul bit ou d'erreurs de synchronisation - perte ou insertion de bits (ce qui entra√Æne une distorsion massive des donn√©es); </li><li>  Autres erreurs / √©checs <br>  Erreurs dans le code, "p√©pins" de framboise, intervention extraterrestre ... </li></ul><br><p>  J'ai formul√© des exigences, dont la satisfaction, √† mon avis, est n√©cessaire pour assurer la fiabilit√©: </p><br><ul><li>  Les enregistrements doivent √™tre √©crits dans la m√©moire flash imm√©diatement, l'enregistrement en attente n'est pas pris en compte; - si une erreur se produit, elle doit √™tre d√©tect√©e et trait√©e d√®s que possible; - le syst√®me doit, si possible, se remettre des erreurs. <br>  <em>(un exemple tir√© de la vie "comme il ne devrait pas √™tre", que tout le monde a rencontr√©, je pense: apr√®s un red√©marrage d'urgence, le syst√®me de fichiers "s'est cass√©" et le syst√®me d'exploitation ne d√©marre pas)</em> </li></ul><br><h2 id="idei-podhody-razmyshleniya">  Id√©es, approches, r√©flexions </h2><br><p>  Quand j'ai commenc√© √† penser √† cette t√¢che, un tas d'id√©es m'a travers√© la t√™te, par exemple: </p><br><ul><li>  Utiliser la compression des donn√©es </li><li>  Utilisez des structures de donn√©es d√©licates, par exemple, stockez les en-t√™tes d'enregistrement s√©par√©ment des enregistrements eux-m√™mes, de sorte que si une erreur se produit dans un enregistrement, vous pouvez lire le reste sans probl√®me </li><li>  utiliser des champs de bits pour contr√¥ler l'int√©gralit√© de l'enregistrement lorsque l'alimentation est coup√©e; </li><li>  stocker des sommes de contr√¥le pour tout et tout; </li><li>  utiliser une sorte de codage correcteur d'erreurs. </li></ul><br><p>  Certaines de ces id√©es ont √©t√© utilis√©es, d'autres ont √©t√© d√©cid√©es √† refuser.  Allons dans l'ordre. </p><br><h3 id="szhatie-dannyh">  Compression des donn√©es </h3><br><p>  Les √©v√©nements que nous enregistrons dans le journal eux-m√™mes sont tout √† fait les m√™mes et r√©p√©tables ("jet√© une pi√®ce de 5 roubles", "cliqu√© sur le bouton de livraison de changement", ...).  Par cons√©quent, la compression devrait √™tre assez efficace. </p><br><p>  La surcharge pour la compression est insignifiante (le processeur que nous avons est assez puissant, m√™me sur le premier Pi il y avait un c≈ìur avec une fr√©quence de 700 MHz, sur les mod√®les actuels il y avait plusieurs c≈ìurs avec une fr√©quence de plus d'un gigahertz), la vitesse d'√©change avec le stockage est faible (plusieurs m√©gaoctets par seconde), la taille d'enregistrement est petite.  En g√©n√©ral, si la compression affectera les performances, alors seulement positive <em>(absolument non critique, simplement d√©clar√©e)</em> .  De plus, nous n'avons pas de v√©ritable Linux embarqu√©, mais ordinaire - donc l'impl√©mentation ne devrait pas n√©cessiter beaucoup d'efforts (il suffit de lier la biblioth√®que et d'utiliser plusieurs fonctions). </p><br><p>  Une partie du journal a √©t√© extraite du p√©riph√©rique de travail (1,7 Mo, 70000 enregistrements) et pour commencer, sa compressibilit√© a √©t√© v√©rifi√©e √† l'aide des gzip, lz4, lzop, bzip2, xz, zstd disponibles sur l'ordinateur. </p><br><ul><li>  gzip, xz, zstd ont montr√© des r√©sultats similaires (40 Ko). <br>  J'ai √©t√© surpris que le xz √† la mode se soit montr√© ici au niveau gzip ou zstd; </li><li>  lzip avec les param√®tres par d√©faut a donn√© un r√©sultat l√©g√®rement pire; </li><li>  lz4 et lzop n'ont pas donn√© de tr√®s bons r√©sultats (150 Ko); </li><li>  bzip2 a montr√© des r√©sultats √©tonnamment bons (18 Ko). </li></ul><br><p>  Les donn√©es sont donc tr√®s bien compress√©es. <br>  Donc (si nous ne trouvons pas de d√©fauts fatals) il devrait y avoir une compression!  Tout simplement parce que plus de donn√©es tiendront sur le m√™me lecteur flash. </p><br><p>  R√©fl√©chissons aux d√©fauts. </p><br><p>  Premier probl√®me: nous avons d√©j√† convenu que chaque disque devrait imm√©diatement se mettre √† clignoter.  Habituellement, l'archiveur collecte les donn√©es du flux d'entr√©e jusqu'√† ce qu'il d√©cide qu'il est temps d'√©crire sur la sortie.  Nous devons imm√©diatement obtenir un bloc de donn√©es compress√© et l'enregistrer dans une m√©moire non volatile. </p><br><p>  Je vois trois fa√ßons: </p><br><ol><li>  Compressez chaque entr√©e en utilisant la compression du dictionnaire au lieu des algorithmes d√©crits ci-dessus. <br>  C'est une option qui fonctionne, mais je ne l'aime pas.  Pour garantir un niveau de compression plus ou moins d√©cent, le dictionnaire doit √™tre ¬´affin√©¬ª pour des donn√©es sp√©cifiques, tout changement entra√Ænera une baisse catastrophique du niveau de compression.  Oui, le probl√®me est r√©solu en cr√©ant une nouvelle version du dictionnaire, mais c'est un casse-t√™te - nous devrons stocker toutes les versions du dictionnaire;  dans chaque entr√©e, nous devrons indiquer avec quelle version du dictionnaire il a √©t√© compress√© ... </li><li>  Compressez chaque entr√©e avec des algorithmes "classiques", mais ind√©pendamment des autres. <br>  Les algorithmes de compression consid√©r√©s ne sont pas con√ßus pour fonctionner avec des enregistrements de cette taille (dizaines d'octets), le coefficient de compression sera clairement inf√©rieur √† 1 (c'est-√†-dire une augmentation de la quantit√© de donn√©es au lieu de la compression); </li><li>  Faites FLUSH apr√®s chaque enregistrement. <br>  De nombreuses biblioth√®ques de compression prennent en charge FLUSH.  Il s'agit d'une commande (ou param√®tre de la proc√©dure de compression), √† la r√©ception de laquelle l'archiveur g√©n√®re un flux compress√© afin que <strong>toutes les</strong> donn√©es non compress√©es qui ont d√©j√† √©t√© re√ßues puissent √™tre restaur√©es.  Un tel analogue de <code>sync</code> dans les syst√®mes de fichiers ou de <code>commit</code> dans SQL. <br>  Ce qui est important, les op√©rations de compression suivantes pourront utiliser le dictionnaire accumul√© et le taux de compression ne souffrira pas autant que dans la version pr√©c√©dente. </li></ol><br><p>  Je pense qu'il est √©vident que j'ai choisi la troisi√®me option, approfondissons-la. </p><br><p>  Il y avait un <a href="https://www.bolet.org/~pornin/deflate-flush.html" rel="nofollow">excellent article</a> sur FLUSH dans zlib. </p><br><p>  J'ai fait un test motiv√© bas√© sur l'article, pris 70 000 entr√©es de journal √† partir d'un appareil r√©el, avec une taille de page de 60 Ko <em>(nous reviendrons √† la taille de la page)</em> : </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Donn√©es source </th><th>  Compression Gzip -9 (sans FLUSH) </th><th>  zlib avec Z_PARTIAL_FLUSH </th><th>  zlib avec Z_SYNC_FLUSH </th></tr></thead><tbody><tr><td>  <strong>Volume, Kb</strong> </td><td>  1692 </td><td>  40 </td><td>  352 </td><td>  604 </td></tr></tbody></table></div><br><p>  √Ä premi√®re vue, le prix introduit par FLUSH est excessivement √©lev√©, mais en r√©alit√© nous avons un mauvais choix - soit ne pas compresser du tout, soit compresser (et tr√®s efficacement) avec FLUSH.  N'oubliez pas que nous avons 70 000 enregistrements, la redondance introduite par Z_PARTIAL_FLUSH n'est que de 4 √† 5 octets par enregistrement.  Et le taux de compression s'est av√©r√© √™tre presque 5: 1, ce qui est plus qu'un excellent r√©sultat. </p><br><div class="spoiler">  <b class="spoiler_title">Cela peut sembler inattendu, mais en fait Z_SYNC_FLUSH est un moyen plus efficace de faire FLUSH</b> <div class="spoiler_text"><p>  Dans le cas de l'utilisation de Z_SYNC_FLUSH, les 4 derniers octets de chaque enregistrement seront toujours 0x00, 0x00, 0xff, 0xff.  Et si nous les connaissons, nous ne pouvons pas les stocker, donc la taille totale n'est que de 324 Ko. </p><br><p>  L'article auquel je fais r√©f√©rence a une explication: </p><br><blockquote>  Un nouveau bloc de type 0 avec un contenu vide est ajout√©. <br><br>  Un bloc de type 0 avec un contenu vide se compose de: <br><ul><li>  l'en-t√™te de bloc √† trois bits; </li><li>  0 √† 7 bits √©gaux √† z√©ro, pour r√©aliser l'alignement des octets; </li><li>  la s√©quence de quatre octets 00 00 FF FF. </li></ul><br></blockquote><p>  Comme vous pouvez le voir, dans le dernier bloc avant ces 4 octets vient de 3 √† 10 bits z√©ro.  Cependant, la pratique a montr√© que z√©ro bit est en fait au moins 10. </p><br><p>  Il s'av√®re que ces blocs de donn√©es courts sont g√©n√©ralement (toujours?) Encod√©s √† l'aide d'un bloc de type 1 (bloc fixe), qui se termine n√©cessairement par 7 bits z√©ro, nous obtenons donc 10-17 bits garantis z√©ro (et le reste sera nul avec une probabilit√© d'environ 50%). </p><br><p>  Ainsi, sur les donn√©es de test, dans 100% des cas, avant 0x00, 0x00, 0xff, 0xff, il y a un octet z√©ro, et plus que dans le troisi√®me cas, il y a deux octets z√©ro <em>(peut-√™tre que j'utilise du CBOR binaire, et lorsque j'utilise du texte CBOR JSON serait plus susceptible de rencontrer des blocs de type 2 - bloc dynamique, respectivement, les blocs se produiraient sans z√©ro octet suppl√©mentaire avant 0x00, 0x00, 0xff, 0xff)</em> . </p><br><p>  Le total des donn√©es de test disponibles peut contenir moins de 250 Ko de donn√©es compress√©es. </p><br><p>  Vous pouvez √©conomiser un peu plus en jonglant avec les bits: maintenant nous ignorons la pr√©sence de plusieurs bits z√©ro √† la fin du bloc, plusieurs bits au d√©but du bloc ne changent pas non plus ... <br>  Mais j'ai alors pris la ferme d√©cision d'arr√™ter, sinon, √† un tel rythme, vous pouvez atteindre le d√©veloppement de votre archiveur. </p></div></div><br><p>  Au total, j'ai obtenu 3-4 octets par enregistrement de mes donn√©es de test, le taux de compression √©tait sup√©rieur √† 6: 1.  Honn√™tement, je ne comptais pas sur un tel r√©sultat, √† mon avis tout ce qui est meilleur que 2: 1 est d√©j√† un r√©sultat qui justifie l'utilisation de la compression. </p><br><p>  Tout va bien, mais zlib (d√©gonfler) est toujours <del>  archa√Øque </del>  algorithme de compression bien m√©rit√© et l√©g√®rement d√©mod√©.  Le simple fait que les 32 derniers Ko du flux de donn√©es non compress√©s soient utilis√©s comme dictionnaire semble √©trange aujourd'hui (c'est-√†-dire que si un bloc de donn√©es est tr√®s similaire √† ce qui √©tait dans le flux d'entr√©e de 40 Ko en arri√®re, il recommencera √† √™tre archiv√©, mais ne sera pas voir l'entr√©e pr√©c√©dente).  Dans <del>  √† la mode </del>  Le dictionnaire de taille des archiveurs modernes est souvent mesur√© en m√©gaoctets plut√¥t qu'en kilo-octets. </p><br><p>  Nous continuons donc notre mini-√©tude des archiveurs. </p><br><p>  Le prochain bzip2 a √©t√© test√© (rappel, sans FLUSH, il a montr√© un taux de compression fantastique, presque 100: 1).  H√©las, avec FLUSH cela se montrait tr√®s mal, la taille des donn√©es compress√©es √©tait sup√©rieure √† celle des donn√©es non compress√©es. </p><br><div class="spoiler">  <b class="spoiler_title">Mes hypoth√®ses sur les raisons de l'√©chec</b> <div class="spoiler_text"><p>  Libbz2 ne propose qu'une seule option de vidage, ce qui semble effacer le dictionnaire (similaire √† Z_FULL_FLUSH dans zlib), il n'y a aucune raison de parler d'une sorte de compression efficace. </p></div></div><br><p>  Et zstd a √©t√© le dernier √† √™tre test√©.  Selon les param√®tres, il se comprime soit au niveau gzip, mais beaucoup plus rapidement, ou gzip est meilleur. </p><br><p>  H√©las, avec FLUSH, il s'est av√©r√© ¬´pas tr√®s¬ª: la taille des donn√©es compress√©es √©tait d'environ 700 Ko. </p><br><p>  J'ai <a href="https://github.com/facebook/zstd/issues/900" rel="nofollow">pos√© une question</a> sur la page du projet dans github, j'ai obtenu une r√©ponse selon laquelle il vaut la peine de compter jusqu'√† 10 octets de donn√©es de service pour chaque bloc de donn√©es compress√©es, ce qui est proche des r√©sultats, la capture du d√©gonflage ne fonctionne pas. </p><br><p>  J'ai d√©cid√© de m'arr√™ter l√†-dessus dans des exp√©riences avec des archiveurs (je vous rappelle que xz, lzip, lzo, lz4 ne se sont pas montr√©s m√™me au stade des tests sans FLUSH, mais je n'ai pas consid√©r√© d'algorithmes de compression plus exotiques). </p><br><p>  Nous revenons aux probl√®mes d'archivage. </p><br><p>  Le deuxi√®me probl√®me (comme on dit dans l'ordre, mais pas en valeur) - les donn√©es compress√©es sont un flux unique dans lequel il est constamment envoy√© vers les sections pr√©c√©dentes.  Ainsi, lorsqu'une section de donn√©es compress√©es est endommag√©e, nous perdons non seulement le bloc de donn√©es non compress√©es qui lui est associ√©, mais aussi toutes les suivantes. </p><br><p>  Il existe une approche pour r√©soudre ce probl√®me: </p><br><ol><li>  Emp√™chez l'apparition d'un probl√®me - ajoutez une redondance aux donn√©es compress√©es, ce qui permettra d'identifier et de corriger les erreurs;  nous en parlerons plus tard; </li><li>  Minimisez les cons√©quences en cas de probl√®me <br>  Nous avons d√©j√† dit pr√©c√©demment qu'il est possible de compresser chaque bloc de donn√©es ind√©pendamment, et le probl√®me dispara√Ætra de lui-m√™me (la corruption des donn√©es d'un bloc entra√Ænera la perte de donn√©es de ce bloc uniquement).  Cependant, il s'agit d'un cas extr√™me dans lequel la compression des donn√©es sera inefficace.  L'extr√™me oppos√©: utilisez les 4 Mo de notre microcircuit comme une seule archive, ce qui nous donnera une excellente compression, mais des cons√©quences catastrophiques en cas de corruption de donn√©es. <br>  <em>Oui, un compromis est n√©cessaire en termes de fiabilit√©.</em>  <em>Mais nous devons nous rappeler que nous d√©veloppons un format de stockage de donn√©es pour la m√©moire non volatile avec un BER extr√™mement bas et une p√©riode de stockage de donn√©es d√©clar√©e de 20 ans.</em> </li></ol><br><p>  Au cours des exp√©riences, j'ai constat√© que des pertes plus ou moins notables dans le niveau de compression commencent sur des blocs de donn√©es compress√©s d'une taille inf√©rieure √† 10 Ko. <br>  Il a √©t√© mentionn√© plus t√¥t que la m√©moire utilis√©e a une organisation de page, je ne vois aucune raison pour laquelle vous ne devriez pas utiliser la correspondance ¬´une page - un bloc de donn√©es compress√©es¬ª. </p><br><p>  Autrement dit, la taille de page minimale raisonnable est de 16 Ko (avec une marge pour les informations de service).  Cependant, une taille de page aussi petite impose des restrictions importantes sur la taille d'enregistrement maximale. </p><br><p>  Bien que je ne m'attende toujours pas √† des enregistrements de plus d'unit√©s de kilo-octets sous forme compress√©e, j'ai d√©cid√© d'utiliser des pages de 32 Ko (un total de 128 pages par puce). </p><br><p>  <strong>R√©sum√©:</strong> </p><br><ul><li>  Nous stockons les donn√©es compress√©es √† l'aide de zlib (d√©gonfler); </li><li>  Pour chaque enregistrement, d√©finissez Z_SYNC_FLUSH; </li><li>  Pour chaque enregistrement compress√©, nous supprimons les octets finaux <em>(par exemple, 0x00, 0x00, 0xff, 0xff)</em> ;  dans l'en-t√™te indique le nombre d'octets que nous coupons; </li><li>  Nous stockons les donn√©es dans des pages de 32 Ko;  √† l'int√©rieur de la page, il y a un seul flux de donn√©es compress√©es;  sur chaque page, nous recommen√ßons la compression. </li></ul><br><p>  Et, avant de terminer la compression, je voudrais attirer l'attention sur le fait que nous n'obtenons que quelques octets de donn√©es d'√©criture, il est donc extr√™mement important de ne pas gonfler les informations de service, chaque octet est compt√©. </p><br><h3 id="hranenie-zagolovkov-dannyh">  Stockage des en-t√™tes de donn√©es </h3><br><p>  √âtant donn√© que nous avons des enregistrements de longueur variable, nous devons en quelque sorte d√©terminer l'emplacement / les limites des enregistrements. </p><br><p>  Je connais trois approches: </p><br><ol><li>  Tous les enregistrements sont stock√©s dans un flux continu, vient d'abord l'en-t√™te d'enregistrement contenant la longueur, puis l'enregistrement lui-m√™me. <br>  Dans ce mode de r√©alisation, les en-t√™tes et les donn√©es peuvent avoir une longueur variable. <br>  En fait, nous obtenons une liste √† lien unique qui est utilis√©e tout le temps; </li><li>  Les en-t√™tes et les enregistrements eux-m√™mes sont stock√©s dans des flux s√©par√©s. <br>  En utilisant des en-t√™tes de longueur constante, nous nous assurons que les dommages √† un en-t√™te n'affectent pas le reste. <br>  Une approche similaire est utilis√©e, par exemple, dans de nombreux syst√®mes de fichiers; </li><li>  Les enregistrements sont stock√©s dans un flux continu, la limite de l'enregistrement est d√©termin√©e par un marqueur (symbole / s√©quence de caract√®res, ce qui est / qui est interdit √† l'int√©rieur des blocs de donn√©es).  Si un marqueur est trouv√© √† l'int√©rieur de l'enregistrement, nous le rempla√ßons par une certaine s√©quence (√©chappons-le). <br>  Une approche similaire est utilis√©e, par exemple, dans le protocole PPP. </li></ol><br><p>  Je vais illustrer. </p><br><p>  Option 1: <br><img src="https://habrastorage.org/webt/b3/yu/q8/b3yuq8z6elbufkrice2g_vjtuhe.png" alt="Option 1"><br>  Tout est tr√®s simple ici: connaissant la longueur de l'enregistrement, on peut calculer l'adresse de l'en-t√™te suivant.  Nous passons donc √† travers les en-t√™tes jusqu'√† ce que nous rencontrions une r√©gion remplie de 0xff (r√©gion libre) ou la fin de la page. </p><br><p>  Option 2: <br><img src="https://habrastorage.org/webt/kf/qy/_7/kfqy_7qzi7pzmk-g5cqa4r6s75q.png" alt="Option 2"><br>  En raison de la longueur variable de l'enregistrement, nous ne pouvons pas dire √† l'avance le nombre d'enregistrements (et donc les en-t√™tes) par page dont nous avons besoin.  Vous pouvez r√©partir les en-t√™tes et les donn√©es elles-m√™mes sur diff√©rentes pages, mais je pr√©f√®re une approche diff√©rente: nous pla√ßons les en-t√™tes et les donn√©es sur la m√™me page, cependant, les en-t√™tes (de taille constante) viennent du d√©but de la page et les donn√©es (de longueur variable) de la fin.  D√®s qu'ils se "rencontrent" (il n'y a pas assez d'espace libre pour un nouveau record) - nous consid√©rons que cette page est pleine. </p><br><p>  Option 3: <br><img src="https://habrastorage.org/webt/-q/u1/qj/-qu1qjmqlcvfi570ovsdy_nzzny.png" alt="Option 3"><br>  Il n'est pas n√©cessaire de stocker dans l'en-t√™te la longueur ou d'autres informations sur l'emplacement des donn√©es, il y a suffisamment de marqueurs qui indiquent les limites des enregistrements.  Cependant, les donn√©es doivent √™tre trait√©es lors de l'√©criture / lecture. <br>  En tant que marqueur, j'utiliserais 0xff (dont la page est remplie apr√®s l'effacement), donc la zone libre ne sera certainement pas trait√©e comme des donn√©es. </p><br><p>  Tableau de comparaison: </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Option 1 </th><th>  Option 2 </th><th>  Option 3 </th></tr></thead><tbody><tr><td>  <strong>Tol√©rance aux erreurs</strong> </td><td>  - </td><td>  + </td><td>  + </td></tr><tr><td>  <strong>Compacit√©</strong> </td><td>  + </td><td>  - </td><td>  + </td></tr><tr><td>  <strong>Complexit√© de la mise en ≈ìuvre</strong> </td><td>  * </td><td>  ** </td><td>  ** </td></tr></tbody></table></div><br><p>  L'option 1 a un d√©faut fatal: si l'un des en-t√™tes est endommag√©, toute notre cha√Æne suivante est d√©truite.  D'autres options vous permettent de r√©cup√©rer une partie des donn√©es m√™me en cas de dommages massifs. <br>  Mais ici, il convient de rappeler que nous avons d√©cid√© de stocker les donn√©es sous forme compress√©e, et donc nous perdons toutes les donn√©es sur la page apr√®s l'enregistrement "cass√©", donc m√™me s'il y a un moins dans le tableau, nous n'en tenons pas compte. </p><br><p>  Compacit√©: </p><br><ul><li>  dans la premi√®re version, nous devons stocker uniquement la longueur dans l'en-t√™te, si des entiers de longueur variable sont utilis√©s, alors dans la plupart des cas, nous pouvons le faire avec un octet; </li><li>  dans la deuxi√®me option, nous devons stocker l'adresse et la longueur de d√©part;  l'enregistrement doit √™tre de taille constante, j'estime 4 octets par enregistrement (deux octets par d√©calage et deux octets par longueur); </li><li>          ,    -    1-2%.       . </li></ul><br><p>        (   ).      ,     . </p><br><p> <em>, -  -    . ,        ,      ‚Äî     ,  , ...</em> </p><br><p>     :          ,      ,      .. , , ,      ‚Äî     ,   . </p><br><p> <strong>:</strong>       "   ‚Äî   " -    . </p><br><h3 id="ispolzovanie-bitovyh-poley-dlya-kontrolya-uspeshnosti-operaciy-zapisi">         </h3><br><p>    ,    ,     : <br>         . <br> <em>   ,  erase    1,     1  0,   .</em>    "  "  1,  " " ‚Äî 0. </p><br><p>          flash: </p><br><ol><li>   ‚Äú  ‚Äù; </li><li>  ; </li><li>   ‚Äú  ‚Äù; </li><li>  ; </li><li>   ‚Äú ‚Äù. </li></ol><br><p>  ,     ‚Äú ‚Äù,  4  . </p><br><p>          ‚Äú1111‚Äù ‚Äî     ‚Äú1000‚Äù ‚Äî   ;         ,        . </p><br><p>  ,           , , , ,      (   )   . </p><br><p> <strong>:</strong>      . </p><br><h3 id="kontrolnye-summy">   </h3><br><p>       (  )     ,     . ,       ,   . </p><br><p>      ,     ,           <em>( , ,   ‚Äî       )</em> . </p><br><p>  ,    ,   ,   ‚Äî  . </p><br><p>         ‚Äî CRC.   ,     100%    ,   ‚Äî               <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-1"><span class="MJXp-msubsup" id="MJXp-Span-2"><span class="MJXp-mn" id="MJXp-Span-3" style="margin-right: 0.05em;">2</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-4" style="vertical-align: 0.5em;"><span class="MJXp-mo" id="MJXp-Span-5">‚àí</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-6">n</span></span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.659ex" height="2.298ex" viewBox="0 -883.9 1575.6 989.6" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-2212" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-6E" x="778" y="0"></use></g></g></svg></span><script type="math/tex" id="MathJax-Element-1">2^{-n}</script>  .      ,      ,       :       ,      .  ‚Äî      . </p><br><p>   : <a href="http://amsoftware.narod.ru/algo.html" rel="nofollow"> 1</a> , <a href="http://amsoftware.narod.ru/algo2.html" rel="nofollow"> 2</a> <em>(  narod.ru, )</em> . </p><br><p>       , CRC ‚Äî     .    ,    . </p><br><p>        ,     . </p><br><p> : <br>         <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-7"><span class="MJXp-msubsup" id="MJXp-Span-8"><span class="MJXp-mn" id="MJXp-Span-9" style="margin-right: 0.05em;">10</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-10" style="vertical-align: 0.5em;"><span class="MJXp-mo" id="MJXp-Span-11">‚àí</span><span class="MJXp-mn" id="MJXp-Span-12">3</span></span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.658ex" height="2.419ex" viewBox="0 -935.7 2005.4 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-30" x="500" y="0"></use><g transform="translate(1001,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-2212" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-33" x="778" y="0"></use></g></g></svg></span><script type="math/tex" id="MathJax-Element-2">10^{-3}</script>    ,       : </p><br><div class="scrollable-table"><table><thead><tr><th> ,  </th><th>  ,  </th><th>   </th><th>    </th><th>    </th></tr></thead><tbody><tr><td>  1 </td><td>  0 </td><td>  1000 </td><td>  0 </td><td>  1000 </td></tr><tr><td>  1 </td><td>  1 </td><td>  4 </td><td> 999 </td><td> 1003 </td></tr><tr><td>  1 </td><td>  2 </td><td> ‚âà0 </td><td> 1997 </td><td> 1997 </td></tr><tr><td>  1 </td><td>  4 </td><td> ‚âà0 </td><td> 3990 </td><td> 3990 </td></tr><tr><td>  10 </td><td>  0 </td><td> 9955 </td><td>  0 </td><td> 9955 </td></tr><tr><td>  10 </td><td>  1 </td><td> 39 </td><td> 990 </td><td> 1029 </td></tr><tr><td>  10 </td><td>  2 </td><td> ‚âà0 </td><td>  1979 </td><td>  1979 </td></tr><tr><td>  10 </td><td>  4 </td><td> ‚âà0 </td><td> 3954 </td><td> 3954 </td></tr><tr><td>  1000 </td><td>  0 </td><td> 632305 </td><td>  0 </td><td> 632305 </td></tr><tr><td>  1000 </td><td>  1 </td><td> 2470 </td><td> 368 </td><td> 2838 </td></tr><tr><td>  1000 </td><td>  2 </td><td>  10 </td><td> 735 </td><td> 745 </td></tr><tr><td>  1000 </td><td>  4 </td><td> ‚âà0 </td><td> 1469 </td><td> 1469 </td></tr></tbody></table></div><br><p>  ,   ‚Äî               ‚Äî    . </p><br><p> ,      : ,       ,           .     ,  <a href="https://habr.com/ru/post/428746/">   </a> . </p><br><p> ,        ,      32    <em>(   64     -)</em> . </p><br><p>   ,    ,      , -   32-   (16  ,    0.01%;  24 ,  ,     ). </p><br><p>    :          ,    4  ?           ?  ,   <em> </em> ,      . </p><br><p>       ,     CRC-32C. <br>    6      22  (,     c), 4      655  (    ), 2           . </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><p> <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" rel="nofollow"> </a>  CRC. </p><br><p> <a href="https://users.ece.cmu.edu/~koopman/crc/c32/0x8f6e37a0_len.txt" rel="nofollow">  crc-32c</a>  <a href="http://users.ece.cmu.edu/~koopman/crc/notes.html" rel="nofollow"> </a> ‚Äî ,    CRC  . </p><br><p>  <a href="http://users.ece.cmu.edu/~koopman/networks/dsn02/dsn02_koopman.pdf" rel="nofollow"> </a>  <a href="https://users.ece.cmu.edu/~koopman/crc/c32/0xfa567d89_len.txt" rel="nofollow">   </a> ,          ,      ,    ,         . </p></div></div><br><p> ,      ,  :       ? </p><br><p>  ""     : </p><br><ul><li>          ‚Äî       (         /, ,     ..); </li><li>  deflate  zlib      <em> </em>   ""  ,  ,         ,      (        , zlib      ). </li></ul><br><p>  ""     : </p><br><ul><li> CRC ""     ,    - (          ,  ,  ,   "" ); </li><li>          , <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-72/product_id-1820/GNU-Zlib.html" rel="nofollow">  </a> ,   . </li></ul><br><p>              . </p><br><p> <strong>:</strong>  CRC-32C,        ,      flash ( ). </p><br><h3 id="izbytochnost">  </h3><br><p>     , ,   , ,    (   )     . </p><br><p>        ,   . <br>       ,  - ,           RAID-6         . <br>         ,   ,           ,     . </p><br><p>   ,       .        ? </p><br><ol><li>   ( -      ,  Raspberry, ...) <br> ,             ; </li><li>   ( -   flash-   ,  ) <br>      ,         ; </li><li>       ; </li><li>   <br>            . </li></ol><br><p>       (    )       . ,   -  . </p><br><p> <strong>:</strong>      , ,      ,      (     ,      ). </p><br><h3 id="prochee">  </h3><br><p> ,          <em>(      )</em> ,      ,   . </p><br><ul><li>     "" <br>     -    ,    ..,    ,      . <br>     ,    ,    ; </li><li>     . <br>       ‚Äî ! <br>         Magic Number (),        <em>( ,       )</em> ; </li><li>    (  )   ,         1 ; </li><li>               . </li></ul><br><p>   <a href="https://planetcalc.com/2481/" rel="nofollow">-</a>  .          . </p><br><h1 id="anchorformatanchoropisanie-formata-hraneniya-dannyh"><a name="format"></a>     </h1><br><h2 id="byte-order"> Byte order </h2><br><p> ,    ,   big-endian  (network byte order),   0x1234   0x12, 0x34. </p><br><h2 id="delenie-na-stranicy">    </h2><br><p>  -     . </p><br><p>     32,   ,  1/4      (   4  128 ). </p><br><p>        (          ). </p><br><p>       (   ),    0 (     0,  ‚Äî  32,  ‚Äî  64  ..) </p><br><p>       (ring buffer),          0,    1, ...,     ,          . </p><br><h2 id="vnutri-stranicy">   </h2><br><p><img src="https://habrastorage.org/webt/7r/sr/fa/7rsrfafqrc263dsu8zd5ptceqga.png" alt=""><br>     4-  ,     (CRC-32C),      ", ,  ". </p><br><p>   (  -)  : </p><br><ul><li>   Magic Number (  ‚Äî   ) <br>        <code>0xed00 ‚äï  </code> ; </li><li>   " " (   ). </li></ul><br><p>        (  deflate).          (  ),       .              (   ). </p><br><p>      Z_SYNC_FLUSH,        4  0x00, 0x00, 0xff, 0xff, , ,      . <br>   ( 4, 5  6 )      -. </p><br><p>      1, 2  3 , : </p><br><ul><li>   (T),   : 0 ‚Äî , 1 ‚Äî ; </li><li>    (S)  1  7 ,     "",       ; </li><li>   (L). </li></ul><br><p>   S: </p><br><div class="scrollable-table"><table><thead><tr><th> S </th><th>  ,  </th><th>   ,  </th></tr></thead><tbody><tr><td> <code>0</code> </td> <td>  1 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>10</code> </td> <td>  1 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr><tr><td> <code>110</code> </td> <td>  2 </td><td> 4 ( <code>00 00 ff ff</code> ) </td></tr><tr><td> <code>1110</code> </td> <td>  2 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>11110</code> </td> <td>  2 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr><tr><td> <code>1111100</code> </td> <td>  3 </td><td> 4 ( <code>00 00 ff ff</code> ) </td></tr><tr><td> <code>1111101</code> </td> <td>  3 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>1111110</code> </td> <td>  3 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr></tbody></table></div><br><p>  ,  ,   : <br><img src="https://habrastorage.org/webt/iu/fu/bp/iufubpdgxnpv9czd45tomt-0vtc.png" alt="  "><br>     T,  ‚Äî  S,  L (    ),  ‚Äî  ,  ‚Äî    ,     -. </p><br><p>  ,      ( 63+5    )     . </p><br><p>       CRC-32C,       (init)      . </p><br><p> <em>CRC   "",  (-    )  :</em> <math> </math><em><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-13"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-14">C</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-15">R</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-16">C</span><span class="MJXp-mo" id="MJXp-Span-17" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-18">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-19">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-20">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-21">t</span><span class="MJXp-mo" id="MJXp-Span-22" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-23">A</span><span class="MJXp-mrow" id="MJXp-Span-24"><span class="MJXp-mo" id="MJXp-Span-25" style="margin-left: 0.167em; margin-right: 0.167em;">|</span></span><span class="MJXp-mrow" id="MJXp-Span-26"><span class="MJXp-mo" id="MJXp-Span-27" style="margin-left: 0.167em; margin-right: 0.167em;">|</span></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-28">B</span><span class="MJXp-mo" id="MJXp-Span-29" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-30" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-31">C</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-32">R</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-33">C</span><span class="MJXp-mo" id="MJXp-Span-34" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-35">C</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-36">R</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-37">C</span><span class="MJXp-mo" id="MJXp-Span-38" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-39">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-40">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-41">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-42">t</span><span class="MJXp-mo" id="MJXp-Span-43" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-44">A</span><span class="MJXp-mo" id="MJXp-Span-45" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-46" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-47">B</span><span class="MJXp-mo" id="MJXp-Span-48" style="margin-left: 0em; margin-right: 0em;">)</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="43.505ex" height="2.66ex" viewBox="0 -832 18731.1 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-52" x="760" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-43" x="1520" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-28" x="2280" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-69" x="2670" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-6E" x="3015" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-69" x="3616" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-74" x="3961" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-2C" x="4323" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-41" x="4768" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-7C" x="5518" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-7C" x="5797" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-42" x="6075" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-29" x="6835" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-3D" x="7502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-43" x="8558" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-52" x="9319" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-43" x="10078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-28" x="10839" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-43" x="11228" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-52" x="11989" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-43" x="12748" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-28" x="13509" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-69" x="13898" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-6E" x="14244" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-69" x="14844" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-74" x="15190" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-2C" x="15551" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-41" x="15996" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-29" x="16747" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-2C" x="17136" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMATHI-42" x="17582" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700019,15700186,15700190,15700259,15700271&amp;usg=ALkJrhjSa2EKrVDnVgFad7Tf_e7zd4OvlQ#MJMAIN-29" x="18341" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-3">CRC(init, A || B) = CRC(CRC(init, A), B)</script></em>   <em>.</em> <em><br>      CRC         .</em> </p><br><p>        . </p><br><p>    ,         0x00  0xff (       0xff,      ; 0x00    ). </p><br><h2 id="primernye-algoritmy">   </h2><br><h3 id="chtenie-iz-flesh-pamyati">   - </h3><br><p>       . <br>      ‚Äî       -  . </p><br><p> <em>(  , Linux     NOR Flash, )</em> </p><br><h3 id="zapis-v-flesh-pamyat">   - </h3><br><p>  . <br>  . </p><br><p>        ‚Äî       . </p><br><h3 id="podgotovka-novoy-mikroshemy-k-rabote">      </h3><br><p>     ( )      1. <br>         ( UUID    ). </p><br><p> , -   . </p><br><h3 id="zagruzka-avtomata">   </h3><br><p>     8    ( + CRC),    Magic Number   CRC . <br>  ""      ,    ,   . <br>   ,   CRC,   "".    ‚Äî    .   ‚Äî   ,    "" . <br>      , ,    "" . <br>   zlib (      ). </p><br><p> ,  ,  ,  . </p><br><h3 id="dobavlenie-zapisi-v-zhurnal">     </h3><br><p>     ,  Z_SYNC_FLUSH.,       . <br>    (     CRC) ‚Äî    (. ). <br>    CRC.    ‚Äî   . </p><br><h3 id="novaya-stranica">   </h3><br><p>       (              ).     ‚Äî       ,     . <br>    erase.    0xff.  -   ‚Äî    ,  .. <br>     ,     ,  ‚Äî    (  ). </p><br><h1 id="primenimost-formata">   </h1><br><p>   ,       -    ( , JSON, MessagePack, CBOR, , protobuf)  NOR Flash. </p><br><p> ,  ""  SLC NOR Flash. </p><br><p>         BER,  NAND  MLC NOR <em>(      ?        )</em> . </p><br><p>  ,      ,   FTL: USB flash, SD, MicroSD, etc <em>(          512 ,          ‚Äî   ""        )</em> . </p><br><p>             128 (16)  1 (128).         , , ,     <em>(      ,   NOR Flash    )</em> . </p><br><p>  -   ,         ‚Äî ,   ,      github. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  ,      <em>  </em> . </p><br><p>        ,  :     - , ,         . ,  () -         . </p><br><p>    ,   ?  Oui bien s√ªr.   , ,      .   -        . </p><br><p>        ?  ,       ,   .    . </p><br><p>    ,       ,   " ". </p><br><p>        ,       <em>()</em>   , ,    ""  (, ,     ;      ).        <em>(    ‚Äî   )</em> . </p><br><p>          ,      . </p><br><h1 id="literatura">  Litt√©rature </h1><br><p>        ,       . </p><br><p>      ,     ,        ,      : </p><br><ol><li>  <a href="https://github.com/madler/infgen/" rel="nofollow">infgen</a>   zlib.        deflate/zlib/gzip.         deflate ( gzip) ‚Äî  . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479044/">https://habr.com/ru/post/fr479044/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479034/index.html">Comment se connecter √† un VPN d'entreprise sous Linux en utilisant openconnect et vpn-slice</a></li>
<li><a href="../fr479036/index.html">Intel ne peut pas faire face √† la demande de processeurs. HP et Dell en souffrent</a></li>
<li><a href="../fr479038/index.html">Transformation num√©rique Leroy Merlin: Conception d'une interface pour travailler avec les appels clients</a></li>
<li><a href="../fr479040/index.html">Tests de r√©gression visuelle. Red√©marrer</a></li>
<li><a href="../fr479042/index.html">La m√©thode Y est un moyen tr√®s simple de cr√©er un Rubik's Cube</a></li>
<li><a href="../fr479048/index.html">Node.js Streams pour les nuls ou comment travailler avec les streams</a></li>
<li><a href="../fr479050/index.html">Recherche de brevets en informatique. Le parcours du jeune combattant. Partie II Sources d'information pour la recherche sur les brevets</a></li>
<li><a href="../fr479052/index.html">[Supercalcul 2019]. Stockage multicloud en tant qu'application pour les nouveaux disques Kingston DC1000M</a></li>
<li><a href="../fr479054/index.html">Vendredi sondage mobile</a></li>
<li><a href="../fr479056/index.html">Tu parles de la vie? L'√©quipe DREAM sur Alexa Prize Socialbot Challenge 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>