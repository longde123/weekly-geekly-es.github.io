<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöû üóΩ ‚ôèÔ∏è Usando o c√≥digo mbed em seu pr√≥prio projeto STM32 - experimente fazer overclock no LCD chin√™s üò∏ üî∏ üé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√Äs vezes, o c√≥digo de outra pessoa realmente ajuda a conectar o ferro perif√©rico ao microcontrolador. Infelizmente, adaptar o c√≥digo de outra pessoa a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando o c√≥digo mbed em seu pr√≥prio projeto STM32 - experimente fazer overclock no LCD chin√™s</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/390909/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Äs vezes, o c√≥digo de outra pessoa realmente ajuda a conectar o ferro perif√©rico ao microcontrolador. </font><font style="vertical-align: inherit;">Infelizmente, adaptar o c√≥digo de outra pessoa ao seu projeto pode ser mais dif√≠cil do que reescrev√™-lo, especialmente quando se trata de megaestruturas como arduino ou mbed. </font><font style="vertical-align: inherit;">Querendo conectar um LCD chin√™s baseado em ILI9341 √† placa STM32L476G DISCOVERY, o autor decidiu usar o driver escrito para mbed no projeto de demonstra√ß√£o da ST sem alterar uma √∫nica linha em seu c√≥digo. </font><font style="vertical-align: inherit;">Como resultado, foi poss√≠vel ao mesmo tempo fazer overclock da tela para velocidades de atualiza√ß√£o sem precedentes de 27 fps.</font></font><br>
<br>
<img src="https://habrastorage.org/files/e3a/44f/7c3/e3a44f7c39d643e29471ee044ea6ea38.jpg"><br>
<br>
<a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o ao problema</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ST Microelectronics produz microcontroladores muito interessantes, tanto em termos de capacidade e pre√ßo, como tamb√©m lan√ßa placas para desenvolvimento r√°pido. Um deles ser√° discutido - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32L476G DESCOBERTA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Os recursos de computa√ß√£o desta placa s√£o muito encorajadores - um ARM de 32 bits com uma freq√º√™ncia de clock m√°xima de 80 MHz pode executar opera√ß√µes de ponto flutuante. Ao mesmo tempo, √© capaz de reduzir ao m√≠nimo o consumo de energia e trabalhar com bateria, aguardando a oportunidade de fazer algo √∫til. Decidi conectar um LCD colorido chin√™s barato com uma resolu√ß√£o de 320 por 240 trabalhando na interface SPI para este dispositivo. Como us√°-lo com o mbed √© descrito em detalhes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mbed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- este √© um ambiente de programa√ß√£o on-line onde voc√™ pode compilar seu firmware sem ter um compilador no seu computador, ap√≥s o qual voc√™ pode baix√°-lo e atualiz√°-lo simplesmente copiando-o na placa compat√≠vel com mbed, que parece um disco remov√≠vel quando conectado ao USB. Tudo isso √© √≥timo, mas existem alguns problemas. Em primeiro lugar, nem todas as placas s√£o compat√≠veis com mbed. Em segundo lugar, existem muitos projetos existentes que n√£o s√£o compat√≠veis com o mbed, incluindo o software fornecido pela ST. E, finalmente, nem todos os desenvolvedores s√£o compat√≠veis com o mbed, alguns (por exemplo, o autor dessas linhas) encontram mais desvantagens do que vantagens nesta ferramenta maravilhosa. Quais s√£o essas desvantagens, discutiremos abaixo, por enquanto √© suficiente mencionar que, depois de conectar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o driver de v√≠deo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o projeto de demonstra√ß√£o da ST e algumas otimiza√ß√µes simples, ele come√ßou a funcionar cerca de 10 vezes mais r√°pido.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aprendendo o c√≥digo do driver</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est√° na hora de baixar e estudar o c√≥digo fonte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do driver de v√≠deo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O trabalho com portas no mbed √© organizado por meio de chamadas para m√©todos de classe que representam portas de E / S. Por exemplo, a classe DigitalOut implementa o acesso √† porta de sa√≠da. Atribuir uma inst√¢ncia desse objeto zero ou um inicia a grava√ß√£o do bit correspondente na porta de sa√≠da. A classe DigitalOut √© inicializada pelo tipo enumerado PinName, cujo √∫nico objetivo √© identificar a perna do processador. Uma das principais desvantagens da implementa√ß√£o do DigitalOut e de outras classes que implementam a E / S √© que a porta √© inicializada no construtor da inst√¢ncia da classe. Isso √© √≥timo para piscar um LED se uma inst√¢ncia da classe DigitalOut for criada na pilha na fun√ß√£o principal. Mas imagine que temos muito ferro diferente, cuja inicializa√ß√£o est√° espalhada por v√°rios m√≥dulos.Se tornarmos inst√¢ncias de nossas classes de E / S est√°ticas, perderemos todo o controle sobre a inicializa√ß√£o, pois ocorrer√° antes da fun√ß√£o principal e em uma ordem arbitr√°ria. As bibliotecas ST (chamadas HAL - n√≠vel de abstra√ß√£o de hardware) usam um paradigma diferente e mais flex√≠vel. Cada porta de entrada / sa√≠da possui seu pr√≥prio contexto e um conjunto de fun√ß√µes que funcionam com ela, mas elas podem ser chamadas exatamente quando necess√°rio. Os contextos de porta geralmente s√£o criados como vari√°veis ‚Äã‚Äãest√°ticas, mas nenhuma inicializa√ß√£o autom√°tica descontrolada ocorre (as bibliotecas ST s√£o escritas em C). Um utilit√°rio extremamente conveniente tamb√©m merece ser mencionado.As bibliotecas ST (chamadas HAL - n√≠vel de abstra√ß√£o de hardware) usam um paradigma diferente e mais flex√≠vel. Cada porta de entrada / sa√≠da possui seu pr√≥prio contexto e um conjunto de fun√ß√µes que funcionam com ela, mas elas podem ser chamadas exatamente quando necess√°rio. Os contextos de porta geralmente s√£o criados como vari√°veis ‚Äã‚Äãest√°ticas, mas nenhuma inicializa√ß√£o autom√°tica descontrolada ocorre (as bibliotecas ST s√£o escritas em C). Um utilit√°rio extremamente conveniente tamb√©m merece ser mencionado.As bibliotecas ST (chamadas HAL - n√≠vel de abstra√ß√£o de hardware) usam um paradigma diferente e mais flex√≠vel. Cada porta de entrada / sa√≠da possui seu pr√≥prio contexto e um conjunto de fun√ß√µes que funcionam com ela, mas elas podem ser chamadas exatamente quando necess√°rio. Os contextos de porta geralmente s√£o criados como vari√°veis ‚Äã‚Äãest√°ticas, mas nenhuma inicializa√ß√£o autom√°tica descontrolada ocorre (as bibliotecas ST s√£o escritas em C). Um utilit√°rio extremamente conveniente tamb√©m merece ser mencionado.mas nenhuma inicializa√ß√£o autom√°tica descontrolada ocorre neste caso (as bibliotecas ST s√£o escritas em C). Um utilit√°rio extremamente conveniente tamb√©m merece ser mencionado.mas nenhuma inicializa√ß√£o autom√°tica descontrolada ocorre neste caso (as bibliotecas ST s√£o escritas em C). Um utilit√°rio extremamente conveniente tamb√©m merece ser mencionado.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CubeMX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que pode gerar todo o c√≥digo de inicializa√ß√£o necess√°rio para o conjunto de portas que voc√™ precisa e at√© permite que voc√™ fa√ßa altera√ß√µes subseq√ºentes nesse conjunto de portas sem afetar seu pr√≥prio c√≥digo. Sua √∫nica desvantagem √© a incapacidade de usar com projetos existentes; voc√™ deve iniciar o projeto com o uso deste utilit√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A biblioteca mbed usa as mesmas fun√ß√µes HAL da biblioteca ST para inicializar os recursos do microcontrolador, mas isso a torna incrivelmente impensada em alguns lugares. Para garantir isso, basta olhar para o c√≥digo de inicializa√ß√£o da porta SPI (que precisamos trabalhar com a exibi√ß√£o) no arquivo </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_api.c</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A fun√ß√£o spi_init procura primeiro uma porta SPI adequada pelas pernas que ela usar√° e depois chama a fun√ß√£o init_spi, que realmente inicializa a porta. </font><font style="vertical-align: inherit;">Nesse caso, todas as tr√™s portas SPI poss√≠veis usam uma estrutura de contexto est√°tica</font></font><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> SPI_HandleTypeDef SpiHandle;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© essencialmente um exemplo cl√°ssico de uso de vari√°veis ‚Äã‚Äãglobais em vez de vari√°veis ‚Äã‚Äãlocais. </font><font style="vertical-align: inherit;">Mesmo levando em conta o fato de termos um n√∫cleo de computa√ß√£o, o contexto global n√£o est√° protegido contra o uso simult√¢neo em diferentes locais do c√≥digo, ainda h√° interrup√ß√µes e o multitarefa.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conecte a biblioteca ao seu projeto</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, eu n√£o quero escrever todo o c√≥digo no mbed. Gosto muito dos exemplos de ST que acompanham o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CubeMX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . N√£o encontrei o driver pronto para o meu LCD para as bibliotecas ST, n√£o queria escrever sozinho. Permaneceu uma maneira alternativa de se divertir de alguma forma - para conectar o driver escrito para o mbed, e para que ele n√£o exija que nada seja alterado. Tudo o que voc√™ precisa fazer √© implementar as bibliotecas mbed de uma maneira alternativa. De fato, a tarefa √© mais simples do que parece, devido a todas as bibliotecas mbed, o driver do LCD usa apenas a porta de sa√≠da e o SPI. Al√©m disso, ele precisa das fun√ß√µes de forma√ß√£o de atrasos e classes de arquivos e fluxos. Com o √∫ltimo, tudo √© simples - n√£o precisamos deles e somos substitu√≠dos por plugues que n√£o fazem nada. As fun√ß√µes de gera√ß√£o de atraso s√£o f√°ceis de escrever - elas est√£o no arquivo</font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait_api.h</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A implementa√ß√£o de classes de E / S requer uma abordagem um pouco mais criativa. Vamos corrigir a falta de bibliotecas mbed e n√£o fazer a inicializa√ß√£o do hardware no construtor. O construtor receber√° um link para o contexto da porta localizado em outro local, seu c√≥digo de inicializa√ß√£o ser√° completamente independente de nossas classes de interface. Existe a √∫nica maneira de transferir essas informa√ß√µes para o construtor sem alterar o c√≥digo do driver - atrav√©s do PinName, que em vez de simplesmente listar as pernas agora armazenar√° um ponteiro para a porta, o n√∫mero da perna e, opcionalmente, um ponteiro para o recurso (como SPI) ao qual essa perna est√° conectada.</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PinName</span></span></span><span class="hljs-class"> {</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>:<font></font>
	PinName() : m_port(<span class="hljs-number"><span class="hljs-number">0</span></span>), m_pin(<span class="hljs-number"><span class="hljs-number">0</span></span>), m_obj(<span class="hljs-number"><span class="hljs-number">0</span></span>) {}<font></font>
	PinName(GPIO_TypeDef* port, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> pin, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* obj = <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		: m_port(port), m_pin(pin), m_obj(obj)<font></font>
		{<font></font>
			assert_param(m_port != <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
		}<font></font>
<font></font>
	GPIO_TypeDef* m_port;<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span>      m_pin;
	<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*         m_obj;<font></font>
<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PinName not_connected;<font></font>
};<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A implementa√ß√£o da porta de sa√≠da √© bastante trivial. Para melhorar o desempenho, tentaremos usar menos as fun√ß√µes HAL e trabalhar diretamente com os registradores de portas o m√°ximo poss√≠vel, al√©m de escrever c√≥digo embutido, o que permitir√° ao compilador evitar chamadas de fun√ß√£o.</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DigitalOut</span></span></span><span class="hljs-class"> {</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>:<font></font>
	DigitalOut(GPIO_TypeDef* port, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> pin)<font></font>
		: m_port(port), m_pin(pin)<font></font>
		{<font></font>
			assert_param(m_port != <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
		}<font></font>
	DigitalOut(PinName <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp; N)<font></font>
		: m_port(N.m_port), m_pin(N.m_pin)<font></font>
		{<font></font>
			assert_param(m_port != <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> =(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit) {
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bit) m_port-&gt;BSRR = m_pin;
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>     m_port-&gt;BRR  = m_pin;<font></font>
	}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">private</span></span>:<font></font>
	GPIO_TypeDef* m_port;<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span>      m_pin;<font></font>
};<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo de implementa√ß√£o da porta SPI n√£o √© muito mais complicado, voc√™ pode v√™-lo </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Como separamos a inicializa√ß√£o da porta do c√≥digo da interface, ignoramos os pedidos de altera√ß√µes na configura√ß√£o. </font><font style="vertical-align: inherit;">A profundidade dos bits da palavra √© simplesmente lembrada. </font><font style="vertical-align: inherit;">Se o usu√°rio deseja transmitir uma palavra de 16 bits e a porta estiver configurada como 8 bits, basta reorganizar os bytes e transferi-los um a um - at√© 4 bytes ainda s√£o colocados no buffer da porta. </font><font style="vertical-align: inherit;">Todos os arquivos necess√°rios para compilar o driver s√£o coletados no diret√≥rio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Agora voc√™ pode conectar os </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> originais do </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">driver</font></a><font style="vertical-align: inherit;"> ao projeto e compil√°-los. </font><font style="vertical-align: inherit;">Tamb√©m precisaremos de um </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que inicialize as portas, crie uma inst√¢ncia do driver e desenhe algo significativo na tela.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overclock</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o LCD for usado para produzir algo din√¢mico, existe um desejo natural de tornar a comunica√ß√£o com ele mais r√°pida. A primeira coisa que vem √† mente √© aumentar a freq√º√™ncia do rel√≥gio SPI, que o motorista define em 10MHz, mas ignoramos seus desejos e podemos definir qualquer coisa. Aconteceu que a tela funciona bem e com uma frequ√™ncia de 40MHz - esta √© a frequ√™ncia m√°xima que nosso processador com uma frequ√™ncia de clock de 80MHz √© capaz. Para avaliar o desempenho, foi escrito um c√≥digo simples que exibe um bitmap de 100x100 pixels em um loop. O resultado foi extrapolado para a tela inteira (um bitmap que ocupa a tela inteira simplesmente n√£o cabe na mem√≥ria). O resultado - 11fps est√° muito longe do limite te√≥rico de 32fps, obtido se voc√™ transferir 16 bits para cada pixel sem parar. O motivo fica claro se voc√™ olhar para</font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo fonte do driver</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se ele precisa transmitir uma sequ√™ncia de bytes, ele simplesmente os transfere um a um, na melhor das hip√≥teses, com palavras de 16 bits. </font><font style="vertical-align: inherit;">A raz√£o para esse design ineficiente est√° na API mbed. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A classe SPI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> possui um m√©todo para transmitir uma matriz de dados, mas s√≥ pode ser usada de forma ass√≠ncrona, chamando a fun√ß√£o de notifica√ß√£o ap√≥s a conclus√£o e no contexto de um manipulador de interrup√ß√£o. </font><font style="vertical-align: inherit;">N√£o √© de surpreender que poucas pessoas usem esse m√©todo. </font><font style="vertical-align: inherit;">Eu completei minha implementa√ß√£o da classe SPI com uma fun√ß√£o que envia um buffer e aguarda o final da transfer√™ncia. </font><font style="vertical-align: inherit;">Depois de adicionar uma chamada a essa fun√ß√£o no c√≥digo de transfer√™ncia de bitmap, o desempenho aumentou para 27 fps, o que j√° est√° muito pr√≥ximo do limite te√≥rico.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo fonte</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para compila√ß√£o, foi utilizado o IAR Embedded Workbench for ARM 7.50.2. </font><font style="vertical-align: inherit;">Com base no firmware de demonstra√ß√£o de c√≥digo da ST. </font><font style="vertical-align: inherit;">Descri√ß√£o do pino, que est√° ligado ao LCD pode ser encontrada no arquivo </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lcd.h</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt390909/">https://habr.com/ru/post/pt390909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt390899/index.html">Professor Gotche: "O comportamento da Big Farm atende ao crit√©rio de" crime organizado ""</a></li>
<li><a href="../pt390901/index.html">Militares alem√£es testaram um laser HEL de 10 quilowatts</a></li>
<li><a href="../pt390903/index.html">O Google mostrou uma rede neural capaz de reconhecer um pa√≠s a partir de uma fotografia (al√©m de cidade e rua), mesmo que a fotografia tenha sido tirada em uma casa</a></li>
<li><a href="../pt390905/index.html">Vendas de phablet aumentam na R√∫ssia</a></li>
<li><a href="../pt390907/index.html">A Apple respondeu aos requisitos do FBI. Em tribunal, a empresa apoiar√° Google, Facebook e Microsoft</a></li>
<li><a href="../pt390911/index.html">Geektimes + MWC2016 e tudo-tudo-tudo</a></li>
<li><a href="../pt390913/index.html">Problemas de RH e a busca por especialistas em TI</a></li>
<li><a href="../pt390915/index.html">Em Mumbai, foram identificadas 16 zonas onde voc√™ n√£o pode tirar selfies: para que os turistas n√£o morram</a></li>
<li><a href="../pt390917/index.html">CHIP - Assassino de Raspberry Pi de US $ 9</a></li>
<li><a href="../pt390919/index.html">Raspberry Pi 3 ter√° Wi-Fi, Bluetooth LE - as primeiras fotos de um mini-PC j√° est√£o na Web</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>