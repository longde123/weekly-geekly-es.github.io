<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>◽️ 👐🏻 👇🏾 Otomatis Menghasilkan dan Mengisi Elemen Konfigurasi Perangkat Jaringan dengan Nornir 🐤 💅🏻 👨🏽‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! 


 Baru-baru ini, sebuah artikel oleh Mikrotik dan Linux tergelincir di sini . Rutin dan otomatisasi di mana masalah serupa diselesaikan ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Otomatis Menghasilkan dan Mengisi Elemen Konfigurasi Perangkat Jaringan dengan Nornir</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482194/"><p><img src="https://habrastorage.org/webt/7z/bp/zt/7zbpztvjkn5yfvxwcxudhj7hrja.png"></p><br><p>  Halo, Habr! </p><br><p>  Baru-baru ini, sebuah artikel oleh <a href="https//habr.com/en/post/480404/" rel="nofollow">Mikrotik dan Linux</a> tergelincir di sini <a href="https//habr.com/en/post/480404/" rel="nofollow">.</a>  <a href="https//habr.com/en/post/480404/" rel="nofollow">Rutin dan otomatisasi di</a> mana masalah serupa diselesaikan dengan cara fosil.  Dan meskipun tugasnya sangat khas, tidak ada yang serupa ditemukan di Habré tentang hal itu.  Saya berani menawarkan sepeda saya ke komunitas IT terkemuka. </p><a name="habracut"></a><br><p>  Ini bukan motor pertama untuk tugas ini.  Opsi pertama diimplementasikan beberapa tahun yang lalu pada versi yang dimungkinkan 1.x.x.  Sepeda itu jarang digunakan dan karena itu terus berkarat.  Dalam arti bahwa tugas itu sendiri tidak terjadi sesering versi yang diperbarui <em>mungkin</em> .  Dan setiap kali Anda harus pergi, rantai akan jatuh, roda akan jatuh.  Namun, bagian pertama, generasi konfigurasi - selalu berhasil dengan sangat jelas, karena mesin telah lama didirikan untuk <em>jinja2</em> .  Tetapi bagian kedua - meluncurkan konfigurasi, sebagai aturan membawa kejutan.  Dan karena saya harus meluncurkan konfigurasi jarak jauh ke lantai ratusan perangkat, beberapa di antaranya ribuan kilometer jauhnya, itu agak menjengkelkan untuk menggunakan alat ini. </p><br><p>  Di sini saya harus mengakui bahwa rasa tidak aman saya, lebih tepatnya, terletak pada kurangnya keakraban dengan <em>memungkinkan</em> saya daripada kekurangannya.  Dan ini, omong-omong, adalah poin penting.  <em>ansible</em> adalah domain pengetahuan yang benar-benar terpisah, dengan DSL (Domain Specific Language) sendiri, yang harus dipertahankan pada tingkat yang dapat diandalkan.  Nah, momen yang <em>memungkinkan</em> berkembang cukup cepat, dan tanpa memperhatikan kompatibilitas ke belakang, tidak menambah kepercayaan diri. </p><br><p>  Oleh karena itu, belum lama ini, versi kedua sepeda diimplementasikan.  Kali ini dalam <em>python</em> , atau lebih tepatnya, dalam kerangka kerja yang ditulis dalam <em>python</em> dan untuk <em>python</em> disebut <a href="https://nornir.readthedocs.io/" rel="nofollow">Nornir</a> </p><br><p>  Jadi - <em>Nornir</em> adalah mikroframework yang ditulis dengan <em>python</em> dan untuk <em>python</em> dan dimaksudkan untuk otomatisasi.  Seperti dalam kasus yang <em>memungkinkan</em> , untuk menyelesaikan masalah, persiapan data yang kompeten diperlukan di sini yaitu.  inventarisasi host dan parameternya, tetapi skrip tidak ditulis pada DSL yang terpisah, tetapi semuanya pada nada yang tidak terlalu lama, tetapi sangat bagus [dan | ah]. </p><br><p>  Mari kita lihat apa itu dalam contoh hidup berikut ini. </p><br><p>  Saya memiliki jaringan cabang dengan beberapa lusin kantor di seluruh negeri.  Di setiap kantor, ada router WAN yang mengakhiri beberapa saluran komunikasi dari operator yang berbeda.  Protokol perutean adalah BGP.  Ada dua jenis router WAN: Cisco ISG atau Juniper SRX. </p><br><p>  Sekarang tugas: perlu mengkonfigurasi subnet khusus untuk pengawasan video di port terpisah pada semua router WAN dari jaringan cabang - umumkan subnet ini di BGP - konfigurasikan batas kecepatan untuk port khusus. </p><br><p>  Pertama, kita perlu menyiapkan beberapa templat, berdasarkan konfigurasi mana yang akan dibuat secara terpisah untuk Cisco dan Juniper.  Dan juga perlu menyiapkan data untuk setiap titik dan parameter koneksi yaitu  untuk mengumpulkan inventaris itu </p><br><p>  Template siap untuk Cisco: </p><br><pre><code class="bash hljs">$ cat templates/ios/base.j2 class-map match-all VIDEO_SURV match access-group 111 policy-map VIDEO_SURV class VIDEO_SURV police 1500000 conform-action transmit exceed-action drop interface {{ host.task_data.ifname }} description VIDEOSURV ip address 10.10.{{ host.task_data.ipsuffix }}.254 255.255.255.0 service-policy input VIDEO_SURV router bgp {{ host.task_data.asn }} network 10.40.{{ host.task_data.ipsuffix }}.0 mask 255.255.255.0 access-list 11 permit 10.10.{{ host.task_data.ipsuffix }}.0 0.0.0.255 access-list 111 permit ip 10.10.{{ host.task_data.ipsuffix }}.0 0.0.0.255 any</code> </pre> <br><p>  Templat untuk Juniper: </p><br><pre> <code class="bash hljs">$ cat templates/junos/base.j2 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 description <span class="hljs-string"><span class="hljs-string">"Video surveillance"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 family inet filter input <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces {{ host.task_data.ifname }} unit 0 family inet address 10.10.{{ host.task_data.ipsuffix }}.254/24 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> policy-options policy-statement export2bgp term 1 from route-filter 10.10.{{ host.task_data.ipsuffix }}.0/24 exact <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> security zones security-zone WAN interfaces {{ host.task_data.ifname }} <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding bandwidth-limit 1m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding burst-size-limit 187k <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1m <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> discard <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding bandwidth-limit 1500000 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-exceeding burst-size-limit 280k <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall policer policer-1.5m <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> discard <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall filter <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in term 1 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> policer policer-1.5m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> firewall filter <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>-in term 1 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> count limiter</code> </pre> <br><p>  Template, tentu saja, tidak diambil dari langit-langit.  Ini pada dasarnya adalah perbedaan antara konfigurasi kerja-itu menjadi setelah menyelesaikan tugas pada dua router spesifik dari model yang berbeda. </p><br><p>  Dari template kami, kami melihat bahwa bagi kami untuk menyelesaikan masalah, dua parameter untuk Juniper dan 3 parameter untuk Cisco sudah cukup.  ini mereka: </p><br><ul><li>  ifname </li><li>  ipsuffix </li><li>  asn </li></ul><br><p>  Sekarang kita perlu mengatur parameter ini untuk setiap perangkat, mis.  lakukan <em>inventaris yang</em> sama. </p><br><p>  Untuk <em>inventaris,</em> kami akan dengan jelas mengikuti dokumentasi <a href="https://nornir.readthedocs.io/en/latest/tutorials/intro/initializing_nornir.html" rel="nofollow">Inisialisasi Nornir</a> </p><br><p>  yaitu membuat kerangka file yang sama: </p><br><pre> <code class="bash hljs">. ├── config.yaml ├── inventory │ ├── defaults.yaml │ ├── groups.yaml │ └── hosts.yaml</code> </pre> <br><p>  File config.yaml - file konfigurasi standar nornir </p><br><pre> <code class="plaintext hljs">$ cat config.yaml --- core: num_workers: 10 inventory: plugin: nornir.plugins.inventory.simple.SimpleInventory options: host_file: "inventory/hosts.yaml" group_file: "inventory/groups.yaml" defaults_file: "inventory/defaults.yaml"</code> </pre> <br><p>  Kami akan menentukan parameter utama di file <em>hosts.yaml</em> , grup (dalam kasus saya, nama pengguna / kata sandi) di <em>groups.yaml</em> , dan kami tidak akan menentukan apa pun di <em>defaults.yaml</em> , tetapi harus ada tiga minus untuk menunjukkan bahwa ini adalah file <em>yaml</em> walaupun kosong. </p><br><p>  Inilah yang tampak seperti hosts.yaml: </p><br><pre> <code class="plaintext hljs">--- srx-test: hostname: srx-test groups: - juniper data: task_data: ifname: fe-0/0/2 ipsuffix: 111 cisco-test: hostname: cisco-test groups: - cisco data: task_data: ifname: GigabitEthernet0/1/1 ipsuffix: 222 asn: 65111</code> </pre> <br><p>  Dan ini adalah groups.yaml: </p><br><pre> <code class="plaintext hljs">--- cisco: platform: ios username: admin1 password: cisco1 juniper: platform: junos username: admin2 password: juniper2</code> </pre> <br><p>  Ini adalah <em>inventaris</em> untuk tugas kita.  Selama inisialisasi, parameter dari file inventaris dipetakan ke model objek <strong>InventoryElement</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Di bawah spoiler, diagram model InventoryElement</b> <div class="spoiler_text"><pre> <code class="json hljs">print(json.dumps(InventoryElement.schema(), indent=<span class="hljs-number"><span class="hljs-number">4</span></span>)) { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"InventoryElement"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hostname"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Hostname"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Username"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"platform"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Platform"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"groups"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Groups"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Data"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"connection_options"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Connection_Options"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"additionalProperties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"$ref"</span></span>: <span class="hljs-string"><span class="hljs-string">"#/definitions/ConnectionOptions"</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"definitions"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"ConnectionOptions"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"ConnectionOptions"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hostname"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Hostname"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Username"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"platform"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Platform"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"extras"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Extras"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span> } } } } }</code> </pre> </div></div><br><p>  Model ini mungkin terlihat sedikit membingungkan, terutama pada awalnya.  Mode interaktif di <strong>ipython</strong> banyak membantu mengetahuinya. </p><br><pre> <code class="bash hljs"> $ ipython3 Python 3.6.9 (default, Nov 7 2019, 10:44:02) Type <span class="hljs-string"><span class="hljs-string">'copyright'</span></span>, <span class="hljs-string"><span class="hljs-string">'credits'</span></span> or <span class="hljs-string"><span class="hljs-string">'license'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more information IPython 7.1.1 -- An enhanced Interactive Python. Type <span class="hljs-string"><span class="hljs-string">'?'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>. In [1]: from nornir import InitNornir In [2]: nr = InitNornir(config_file=<span class="hljs-string"><span class="hljs-string">"config.yaml"</span></span>, dry_run=True) In [3]: nr.inventory.hosts Out[3]: {<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>: Host: srx-test, <span class="hljs-string"><span class="hljs-string">'cisco-test'</span></span>: Host: cisco-test} In [4]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>].data Out[4]: {<span class="hljs-string"><span class="hljs-string">'task_data'</span></span>: {<span class="hljs-string"><span class="hljs-string">'ifname'</span></span>: <span class="hljs-string"><span class="hljs-string">'fe-0/0/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'ipsuffix'</span></span>: 111}} In [5]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>][<span class="hljs-string"><span class="hljs-string">'task_data'</span></span>] Out[5]: {<span class="hljs-string"><span class="hljs-string">'ifname'</span></span>: <span class="hljs-string"><span class="hljs-string">'fe-0/0/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'ipsuffix'</span></span>: 111} In [6]: nr.inventory.hosts[<span class="hljs-string"><span class="hljs-string">'srx-test'</span></span>].platform Out[6]: <span class="hljs-string"><span class="hljs-string">'junos'</span></span></code> </pre><br><p>  Akhirnya, mari kita beralih ke skrip itu sendiri.  Tidak ada yang istimewa yang bisa saya banggakan.  Saya baru saja mengambil contoh yang sudah selesai dari <a href="https://nornir.readthedocs.io/en/latest/tutorials/intro/grouping_tasks.html" rel="nofollow">tutorial</a> dan menggunakannya hampir tanpa perubahan.  Seperti inilah tampilan skrip yang berfungsi: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InitNornir <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir.plugins.tasks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> networking, text <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nornir.plugins.functions.text <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_title, print_result <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config_and_deploy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(task)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Transform inventory data to configuration via a template file r = task.run(task=text.template_file, name="Base Configuration", template="base.j2", path=f"templates/{task.host.platform}") # Save the compiled configuration into a host variable task.host["config"] = r.result # Save the compiled configuration into a file with open(f"configs/{task.host.hostname}", "w") as f: f.write(r.result) # Deploy that configuration to the device using NAPALM task.run(task=networking.napalm_configure, name="Loading Configuration on the device", replace=False, configuration=task.host["config"]) nr = InitNornir(config_file="config.yaml", dry_run=True) # set dry_run=False, cross your fingers and run again # run tasks result = nr.run(task=config_and_deploy) print_result(result)</span></span></code> </pre> <br><p>  Perhatikan <em>dry_run = True</em> parameter pada baris inisialisasi objek <strong>nr</strong> . <br>  Di sini, seperti halnya dalam suatu <em>kemungkinan</em> , suatu uji coba dilaksanakan di mana koneksi ke router dibuat, konfigurasi baru yang berubah disiapkan, yang kemudian divalidasi oleh perangkat (tetapi ini tidak tepat; itu tergantung pada dukungan perangkat dan implementasi driver di NAPALM), tetapi konfigurasi baru tidak secara langsung diterapkan .  Untuk penggunaan tempur, Anda harus menghapus parameter <em>dry_run</em> atau mengubah nilainya menjadi <em>Salah</em> . </p><br><p>  Saat skrip berjalan, Nornir menampilkan log detail ke konsol. </p><br><div class="spoiler">  <b class="spoiler_title">Di bawah spoiler, kesimpulan pertempuran berjalan pada dua router uji:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">config_and_deploy*************************************************************** * cisco-test ** changed : True ******************************************* vvvv config_and_deploy ** changed : True vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv INFO ---- Base Configuration ** changed : True ------------------------------------- INFO class-map match-all VIDEO_SURV match access-group 111 policy-map VIDEO_SURV class VIDEO_SURV police 1500000 conform-action transmit exceed-action drop interface GigabitEthernet0/1/1 description VIDEOSURV ip address 10.10.222.254 255.255.255.0 service-policy input VIDEO_SURV router bgp 65001 network 10.10.222.0 mask 255.255.255.0 access-list 11 permit 10.10.222.0 0.0.0.255 access-list 111 permit ip 10.10.222.0 0.0.0.255 any ---- Loading Configuration on the device ** changed : True --------------------- INFO +class-map match-all VIDEO_SURV + match access-group 111 +policy-map VIDEO_SURV + class VIDEO_SURV +interface GigabitEthernet0/1/1 + description VIDEOSURV + ip address 10.10.222.254 255.255.255.0 + service-policy input VIDEO_SURV +router bgp 65001 + network 10.10.222.0 mask 255.255.255.0 +access-list 11 permit 10.10.222.0 0.0.0.255 +access-list 111 permit ip 10.10.222.0 0.0.0.255 any ^^^^ END config_and_deploy ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ * srx-test ** changed : True ******************************************* vvvv config_and_deploy ** changed : True vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv INFO ---- Base Configuration ** changed : True ------------------------------------- INFO set interfaces fe-0/0/2 unit 0 description "Video surveillance" set interfaces fe-0/0/2 unit 0 family inet filter input limit-in set interfaces fe-0/0/2 unit 0 family inet address 10.10.111.254/24 set policy-options policy-statement export2bgp term 1 from route-filter 10.10.111.0/24 exact set security zones security-zone WAN interfaces fe-0/0/2 set firewall policer policer-1m if-exceeding bandwidth-limit 1m set firewall policer policer-1m if-exceeding burst-size-limit 187k set firewall policer policer-1m then discard set firewall policer policer-1.5m if-exceeding bandwidth-limit 1500000 set firewall policer policer-1.5m if-exceeding burst-size-limit 280k set firewall policer policer-1.5m then discard set firewall filter limit-in term 1 then policer policer-1.5m set firewall filter limit-in term 1 then count limiter ---- Loading Configuration on the device ** changed : True --------------------- INFO [edit interfaces] + fe-0/0/2 { + unit 0 { + description "Video surveillance"; + family inet { + filter { + input limit-in; + } + address 10.10.111.254/24; + } + } + } [edit] + policy-options { + policy-statement export2bgp { + term 1 { + from { + route-filter 10.10.111.0/24 exact; + } + } + } + } [edit security zones] security-zone test-vpn { ... } + security-zone WAN { + interfaces { + fe-0/0/2.0; + } + } [edit] + firewall { + policer policer-1m { + if-exceeding { + bandwidth-limit 1m; + burst-size-limit 187k; + } + then discard; + } + policer policer-1.5m { + if-exceeding { + bandwidth-limit 1500000; + burst-size-limit 280k; + } + then discard; + } + filter limit-in { + term 1 { + then { + policer policer-1.5m; + count limiter; + } + } + } + } ^^^^ END config_and_deploy ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</code> </pre> </div></div><br><h3 id="pryachem-paroli-v-ansible_vault">  Menyembunyikan kata sandi di ansible_vault </h3><br><p>  Pada awal artikel, saya <em>menemukan beberapa kemungkinan</em> , tetapi tidak semuanya buruk di sana.  Saya sangat suka <strong>brankas</strong> mereka, yang dirancang untuk menyembunyikan informasi sensitif dari pandangan.  Dan mungkin banyak yang memperhatikan bahwa kita memiliki semua nama pengguna / kata sandi untuk semua router perang yang bersinar dalam bentuk terbuka di file <em>groups.yaml</em> .  Itu jelek, tentu saja.  Mari lindungi data ini dengan <strong>brankas</strong> . </p><br><p>  Kami mentransfer parameter dari groups.yaml ke creds.yaml, dan mengenkripsinya dengan AES256 dengan kata sandi 20 digit: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> inventory $ cat creds.yaml --- cisco: username: admin1 password: cisco1 juniper: username: admin2 password: juniper2 $ pwgen 20 -N 1 &gt; vault.passwd ansible-vault encrypt creds.yaml --vault-password-file vault.passwd Encryption successful $ cat creds.yaml <span class="hljs-variable"><span class="hljs-variable">$ANSIBLE_VAULT</span></span>;1.1;AES256 39656463353437333337356361633737383464383231366233386636333965306662323534626131 3964396534396333363939373539393662623164373539620a346565373439646436356438653965 39643266333639356564663961303535353364383163633232366138643132313530346661316533 6236306435613132610a656163653065633866626639613537326233653765353661613337393839 62376662303061353963383330323164633162386336643832376263343634356230613562643533 30363436343465306638653932366166306562393061323636636163373164613630643965636361 34343936323066393763323633336366366566393236613737326530346234393735306261363239 35663430623934323632616161636330353134393435396632663530373932383532316161353963 31393434653165613432326636616636383665316465623036376631313162646435</code> </pre> <br><p>  Sangat sederhana.  Tetap mengajarkan skrip <em>Nornir</em> kami untuk mendapatkan dan menggunakan data ini. <br>  Untuk melakukan ini, dalam skrip kami, setelah baris inisialisasi <em>nr = InitNornir (config_file = ...</em> tambahkan kode berikut: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span>nr = InitNornir(config_file=<span class="hljs-string"><span class="hljs-string">"config.yaml"</span></span>, dry_run=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-comment"><span class="hljs-comment"># set dry_run=False, cross your fingers and run again # enrich Inventory with the encrypted vault data from ansible_vault import Vault vault_password_file="inventory/vault.passwd" vault_file="inventory/creds.yaml" with open(vault_password_file, "r") as fp: password = fp.readline().strip() vault = Vault(password) vaultdata = vault.load(open(vault_file).read()) for a in nr.inventory.hosts.keys(): item = nr.inventory.hosts[a] item.username = vaultdata[item.groups[0]]['username'] item.password = vaultdata[item.groups[0]]['password'] #print("hostname={}, username={}, password={}\n".format(item.hostname, item.username, item.password)) # run tasks ...</span></span></code> </pre> <br><p>  Tentu saja, vault.passwd tidak boleh terletak di sebelah creds.yaml seperti dalam contoh saya.  Tetapi untuk bermain itu akan dilakukan. </p><br><p>  Itu saja untuk saat ini.  Beberapa artikel tentang Cisco + Zabbix akan datang, tetapi ini tidak sedikit tentang otomatisasi.  Dan dalam waktu dekat saya berencana untuk menulis tentang RESTCONF di Cisco. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id482194/">https://habr.com/ru/post/id482194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id482178/index.html">Kisah seorang siswa Korea yang menerima hadiah dari kementerian untuk sistem pemantauan antrian</a></li>
<li><a href="../id482182/index.html">Masalah apa yang akan saya miliki jika saya berjuang untuk keseimbangan gender di bidang TI?</a></li>
<li><a href="../id482186/index.html">Hidup dan TI atau tahun ketika saya berhenti dari pekerjaan terakhir saya</a></li>
<li><a href="../id482188/index.html">Jajak pendapat Jumat tentang pembaruan</a></li>
<li><a href="../id482190/index.html">Seperti apa konten Durex di jejaring sosial di China</a></li>
<li><a href="../id482196/index.html">Apa pemodelan produksi dan mengapa itu diperlukan?</a></li>
<li><a href="../id482198/index.html">Cara membuat autoscaler Anda untuk sebuah cluster</a></li>
<li><a href="../id482200/index.html">Blockchain untuk keamanan siber: harapan dan kenyataan</a></li>
<li><a href="../id482202/index.html">Metode untuk memperbarui kriptografi pada peralatan Titik Periksa ke GOST 2012</a></li>
<li><a href="../id482206/index.html">Cara membuat produksi suku cadang 3D untuk pesawat lebih ekonomis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>