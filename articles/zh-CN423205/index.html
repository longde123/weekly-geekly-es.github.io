<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏫 👨‍👧 🤜🏼 MS SQL Server上的存储项目，与1C 7.7集成以及SSDT中的开发自动化 🐬 🤫 🔃</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="时间不多了，很快这种发展几乎一无所有，但我仍然没有时间描述它。 



 这将是关于联邦一级拥有大量分支机构和分支机构的公司。 但是，像往常一样，这一切都是从很久以前的一家小商店开始的。 多年来，发生了相当迅速和自发的发展，分支机构，部门和其他办公室出现了，并且在那时，IT基础架构没有得到应有的重视...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MS SQL Server上的存储项目，与1C 7.7集成以及SSDT中的开发自动化</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423205/"> 时间不多了，很快这种发展几乎一无所有，但我仍然没有时间描述它。 <br><br><img src="https://habrastorage.org/webt/fi/5s/if/fi5siftwc5fvceqqsjgxfnqubum.png"><br><br> 这将是关于联邦一级拥有大量分支机构和分支机构的公司。 但是，像往常一样，这一切都是从很久以前的一家小商店开始的。 多年来，发生了相当迅速和自发的发展，分支机构，部门和其他办公室出现了，并且在那时，IT基础架构没有得到应有的重视，这也是经常发生的情况。 当然，1C77随处可见，没有任何复制和缩放的储备，因此，您知道，最终我们得出的结论是，Sprut-Frankenstein的触角用胶带绑住了-在每个分支中都有一个与中心碱基交换的自主突变体在“膝盖高”模式下，只有几本参考书，没有这些书，那是根本不可能的，其余的是自主的。 一段时间以来，他们对中心办公室的分支机构的副本（数十个！）感到满意，但其中的数据滞后了几天。 <br><br> 但是，现实需要更快，更灵活地获取信息，并且还需要做其他事情。 从这样一个规模的会计系统转移到另一个会计系统仍然是一片沼泽。 因此，决定创建一个数据仓库（DX），在该仓库中信息将从不同的数据库中流出，以便以后的其他服务和多维数据集，SSRS报告和泄漏形式的分析系统可以从此CD接收数据。 <br><br> 展望未来，我要说的是，向新会计系统的过渡几乎已经完成，这里描述的大多数项目都将在不久的将来被削减，因为这是不必要的。 对不起，当然，但是什么也做不了。 <br><br> 以下是一篇很长的文章，但是在您开始阅读之前，请允许我说，我决不会将此决定作为标准来通过，但是也许有人会从中找到有用的东西。 <br><a name="habracut"></a><br> 我将从对该项目的一般方法开始，为此选择了SSDT作为开发环境，随后在Git中发布了该项目。 我认为，今天有足够多的文章和教程来描述此工具的优势。 但是有一些问题是在这种环境之外的。 <br><br><h4> 枚举和数据库版本的存储 </h4><br> 关于版本和枚举，该项目的要求是： <br><br><ul><li> 方便地编辑和跟踪项目中数据库版本的更改 </li><li> 方便管理员通过SSMS查看数据库版本 </li><li> 将版本更改的历史记录保存在数据库本身中（部署的对象和时间） </li><li> 在项目中存储枚举 </li><li> 轻松编辑和跟踪转账更改 </li><li> 如果没有增量版本，则将数据库部署锁锁定在现有锁上 </li><li> 安装新版本，记录历史记录，传输和重组应在一个事务中执行，并在任何阶段出现故障时完全回滚 </li></ul><br> 因为 传输通常包含逻辑并且是基本值，没有这些值，就不可能将记录添加到其他表中（由于FK外键），实质上，它们与元数据一起是数据库结构的一部分。 因此，任何枚举元素的更改都会导致数据库版本的增加，并且必须确保与该版本一起增加记录的部署期间。 <br><br> 我认为在不增加版本的情况下阻止部署的所有优点都是显而易见的，其中之一是如果已经早先成功执行了发布脚本，则无法重新运行发布脚本。 <br><br> 尽管通常建议数据库网络仅使用主要版本（不带分数），但我们决定使用XY格式的版本，其中Y是在表，列，列表元素的名称或其他较小内容的描述中纠正拼写错误时的补丁程序，例如在存储过程中添加注释等。 在所有其他情况下，都会建立主要版本。 <br><br> 也许对于某人而言，没有什么比<i>这</i>更明显了。 但是在适当的时候，我就如何在数据库项目中存储转移的内部争议花了很多神经和精力，因此是风水（ <i>按照我的想法</i> ），与他们合作很方便，同时最大程度地减少错误的可能性。 <br><br> 通常，使用传输，一切都很简单-我们在项目中创建一个PostDeploy文件，并在其中编写代码以填充表。 使用合并或拖曳-这就是您喜欢的方式。 我们希望闪烁一下，以预先检查目标表中的记录数是否超过源（项目）中的记录数。 如果超过，则抛出异常以引起注意，因为它很奇怪。 为什么源中的记录更少？ 因为一个人多余吗？ 为什么突然呢？ 如果数据库已经有链接？ 尽管我们使用外键（FK）（不允许您删除记录），但是如果有链接，我们仍然希望保留此选项。 结果，PostDeploy变成了一个不可读的工作表，因为对于每个要填充的表，除了值本身之外，还存在验证码，合并等。 <br><br> 但是，如果在SQLCMD模式下使用PostDeploy，则有可能将代码块提取到单独的文件中，因此，仅保留结构化的文件名列表来填充PostDeploy中的枚举。 <br><br> 数据库版本有些细微差别。 互联网一直在争论数据库版本的存储位置，外观以及通常是否需要将其存储在某个地方？ 假设我们决定需要它，将它存储在项目的哪个位置？ 在PostDeploy脚本的某个地方，还是将其放在脚本第一行中声明的变量中？ <br><br> 我认为，两者都不是。 当将其存储在单独的文件中时，此功能更加方便。 <br><br> 有人会说-项目属性中有dacpac，您可以在其中设置版本。 当然，您甚至可以按照<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处的</a>描述将此版本拖入脚本中，但这很不方便-要更改数据库版本，您需要走很远的地方，单击一堆按钮。 我不了解Microsoft的逻辑-他们将它与排序，兼容性级别等数据库参数一起藏在一个遥远的角落，因为数据库版本作为排序参数的变化通常是“经常”，对吧？ 如果进行持续的开发，那么每次部署新版本时都会建立该版本，因此，跟踪更改的便利性也起着重要作用，因为当点亮一个带有友好名称的已更改文件时，这是一回事，而当点亮.sqlproj项目文件时，其中XML格式的行很多，并且在该行中间的某个位置突出显示了一个更改的数字，但不是很明显。 <br><br><img src="https://habrastorage.org/webt/bg/i3/48/bgi3485rgezdefuaami2weappqy.png"><br><br> 这样更好 <br><br><img src="https://habrastorage.org/webt/ro/9y/ld/ro9yldaaeoqcmubpi42adq-so50.png"><br><br> 但是，也许这些只是我的蟑螂，您不应该注意它们。 <br><br> 现在的问题是：已经在部署的数据库中存储此版本的位置。 再次，dacpac似乎做得很漂亮-它将所有内容都写到系统板上，但是要查看版本，您需要执行请求（或者可以执行该请求，但是我只是不知道如何烹调它们？似乎在旧版SSMS中有一个接口可以用于此操作，现在不） <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> msdb.dbo.sysdac_instances_internal</code> </pre> <br> 对于管理员（不仅是），这不是很方便。 将版本直接显示在数据库本身的属性中更加合乎逻辑。 <br><br><img src="https://habrastorage.org/webt/ed/ax/le/edaxle3ic1lfwvaeuhhhphmrulo.png"><br><br> 还是不行 <br><br> 为此，您需要向项目中添加文件，该文件包含在内部版本中，以描述高级属性。 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>;</code> </pre> <br> 是的，它们是空的，在发布脚本中看起来很难看，但是没有它们就不能做。 如果项目中未对它们进行描述，并且它们将存在于数据库中，那么Studio将在每次部署时尝试删除它们。  （已经进行了许多尝试来简洁地解决此问题，并且没有不必要的部署选项，但无济于事） <br><br> 我们将在PostDeploy脚本中为其设置值。 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @username <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) = suser_sname() ,@curdatetime <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>(),<span class="hljs-string"><span class="hljs-string">'dd.MM.yyyy HH:mm:ss'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = @username; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DBVersion)]; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = @curdatetime;</code> </pre> <br>  <code>sp_updateextendedproperty</code>无需任何检查，因为从PostDeploy启动该块时，如果不存在所有属性，则已经创建了所有属性。 <br><br> 好吧，最好保留有关谁在何时部署数据库的历史记录。 <br><br> 通过选中“ <b>高级发布选项”</b>窗口中的“ <b>启用事务脚本”</b>框，可以使用标准工具在事务中执行元数据更改的部署。 但是此标志不会影响脚本（Pre / Post）的部署，并且它们可以继续运行而无需事务。 当然，没有什么可以阻止事务从PostDeploy脚本的开头开始，但是它将是与元数据分开的事务，并且我们的任务是在PostDeploy中发生异常时回滚元数据更改。 <br><br> 解决方案很简单-在PreDeploy中启动事务，然后在PostDeploy中提交，并且出于这些目的，请勿在发布设置中使用任何选中标记。 <br><br> 为了方便地将数据库版本存储在项目中并在部署过程中将其注册在所需的位置，可以使用SQLCMD变量。 但是，我不想将版本存储在代码的繁杂部分中，而是希望将其存储在表面上。 <br><br><img src="https://habrastorage.org/webt/yg/qm/o9/ygqmo9wf5pnwnyx7kfnumsflps8.png"><br><br> 为了将数据库版本放在一个单独的文件中，并在项目级别从那里管理版本，我们在.sqlproj中添加以下块： <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BeforeBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\Properties\DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lines"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtDBVersion"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WriteLinesToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\\SetPreDepVarsTmp.sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Lines</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":setvar DBVersion $(ExtDBVersion)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Overwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br> 这是MSBuild在构建文件并基于读取的数据创建临时文件之前从文件中读取一行的指令。  MSBuild将创建一个临时的<code>SetPreDepVarsTmp.sql</code>文件，该文件将<code>:setvar DBVersion $(ExtDBVersion)</code>行<code>:setvar DBVersion $(ExtDBVersion)</code> ，其中<code>$(ExtDBVersion)</code>是从存储数据库版本的文件中读取的值。 <br><br> 经过此类操作后，您可以从PreDeploy脚本中引用此临时文件并在其中启动全局事务： <br><br><pre> <code class="sql hljs">:r .\SetPreDepVarsTmp.sql go :r ".\BeginTransaction.sql"</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">中级版本</b> <div class="spoiler_text"> 最初，为ExtendedProperties.sql文件分配的不是空值，而是变量中的值 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DeployerName)]; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DeploymentDate)]; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DBVersion)];</code> </pre> <br> 依次由MSBuild将变量自动注册到SetPreDepVarsTmp.sql文件中，如下所示： <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentDateTime</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.DateTime]::Now.ToString(dd.MM.yyyy HH:mm:ss))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentDateTime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NewLine</span></span></span><span class="hljs-tag">&gt;</span></span> -- <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NewLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BeforeBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lines"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtDBVersion"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WriteLinesToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\SetPreDepVarsTmp.sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Lines</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":setvar DBVersion $(ExtDBVersion)$(NewLine):setvar DeploymentDate "</span></span></span><span class="hljs-tag">$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CurrentDateTime</span></span></span><span class="hljs-tag">)"$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NewLine</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:setvar</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DeploymentUser</span></span></span><span class="hljs-tag"> $(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UserDomain</span></span></span><span class="hljs-tag">)\$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UserName</span></span></span><span class="hljs-tag">)" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Overwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br> 使用这种方法，您不需要在PostDeploy中重新安装这些属性，但是麻烦的是SetPreDepVarsTmp.sql包含静态值，并且如果发布脚本是现在生成的，但是在一小时或更晚的第二天（开发人员检查了很长时间）之后就部署了例如，在视觉上），属性中指定的发布日期将不同于实际的发布日期，并且与历史记录中的日期不一致。 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">BeginTransaction.sql文件的内容</b> <div class="spoiler_text"> 本质上，这只是从Studio选中“ <b>启用事务脚本”</b>复选框时生成的标准事务开始块进行复制粘贴，但是我们以自己的方式使用它。 在脚本中，只有临时表名称已从<code>#tmpErrors</code>更改为<code>#tmpErrors</code> ，因此，如果有人打开该复选框，则不会发生名称冲突。 <br><br><pre> <code class="sql hljs">IF (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'tempdb..#tmpErrors'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual GO CREATE TABLE #tmpErrorsManual (Error int) GO SET XACT_ABORT ON GO SET TRANSACTION ISOLATION LEVEL READ COMMITTED GO BEGIN TRANSACTION GO</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">PostDeploy脚本</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @TableName <span class="hljs-built_in"><span class="hljs-built_in">VarChar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-comment"><span class="hljs-comment">--        if $(SkipEnumDeploy) = 0 begin PRINT N' ...' :r ..\\EnumTable1.sql end --   PRINT N'  ...'; declare @username varchar(256) = suser_sname() , @curdatetime varchar(20) = format(getdate(),'dd.MM.yyyy HH:mm:ss') if $(DBVersion) &gt; (select isnull( MAX( DBVersion),0) from zDBVersionHistory) begin insert into zDBVersionHistory( DBVersion, DeploymentDate, DeployerName) values ($(DBVersion),@curdatetime,@username) EXECUTE sp_updateextendedproperty @name = N'DeployerName', @value = @username; EXECUTE sp_updateextendedproperty @name = N'DBVersion', @value = [$(DBVersion)]; EXECUTE sp_updateextendedproperty @name = N'DeploymentDate', @value = @curdatetime; end else begin RaisError ( N':          ,  .      ,        DBVersion          .' , 16 , 1 ) WITH SETERROR; end GO :r ".\CaptureTransactionError.sql" :r ".\CommitTransaction.sql"</span></span></code> </pre> <br>  SkipEnumDeploy变量已经很清楚了，它允许您跳过更新清单的阶段；这对于较小的外观更改很有用。 尽管从宗教的角度来看，这可能不是正确的，但是在开发阶段肯定是有用的。 <br></div></div><br> 文件<code>CaptureTransactionError.sql</code>和<code>CommitTransaction.sql</code>也是从Studio设置上述标志时生成的标准交易算法中复制粘贴（经过较小的更正）的，现在我们可以自己播放。 <br><br><div class="spoiler">  <b class="spoiler_title">内容CaptureTransactionError.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF @@ERROR &lt;&gt; 0 AND @@TRANCOUNT &gt; 0 <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@TRANCOUNT = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual (Error) VALUES (1); BEGIN TRANSACTION; END</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">CommitTransaction.sql内容</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF EXISTS (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual) ROLLBACK TRANSACTION GO DROP TABLE #tmpErrorsManual GO IF @@TRANCOUNT&gt;0 BEGIN PRINT N'     .' COMMIT TRANSACTION END ELSE RaisError ( N'    .' , 16 , 1 );</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">内容EnumTable1.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TableName = N<span class="hljs-string"><span class="hljs-string">'Table1'</span></span> PRINT N<span class="hljs-string"><span class="hljs-string">'  '</span></span>+@TableName+<span class="hljs-string"><span class="hljs-string">'...'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> try <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpEnums; select * into #tmpEnums from (values ( 0, ' 1') , ( 1, ' 2') , ( 2, ' 3') ) as tmp ( Id , Title ) set nocount off --         If ((select count(*) from Table1) &gt; (select count(*) from #tmpEnums)) begin RaisError ( N':      ,   .' , 0 , 1 ) WITH SETERROR; end set Identity_insert Table1 on Merge Table1 as target Using ( select * from #tmpEnums except select * from dbo.Table1 ) as source on target.Id = source.Id when matched then update set target.Title = source.Title when not matched by target then insert ( Id , Title ) values ( source.Id , source.Title ); set Identity_insert Table1 off drop table if exists #tmpEnums; END TRY begin catch IF @@trancount &gt; 0 ROLLBACK TRANSACTION set @Error_Message = Error_Message(); RaisError ( N': %s.' , 0 , 1 , @Error_Message ) WITH SETERROR; end catch :r "..\\CaptureTransactionError.sql"</span></span></code> </pre> <br></div></div><br> 部署<code>Publish</code>脚本将具有以下结构 <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- PreDeploy ----:setvar DBVersion "10.6" --   ,     DBVersion ----   --    ,           -- PostDeploy ----  ----   ----  </span></span></code> </pre> <br><br> 当然，理想情况下，我希望该版本在发布时显示 <br><img src="https://habrastorage.org/webt/8a/9w/o2/8a9wo2o5lemfglm1ru1kt5yntdm.png"><br><br> 但是，您无法将文件中的值拉到该窗口中，尽管MSBuild会读取该值并将其通过.sqlproj文件中的其他指令（如上例所示）放入ExtDBVersion属性中，但该构造 <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCmdVariable</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span>$(ExtDBVersion)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCmdVariable</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br> 不滚动。 <br><br> 续集开发人员在其<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">网络日记中</a>写下了如何完成此工作。 根据它们的版本，魔术在于<code>SqlCommandVariableOverride</code>指令，该指令很简单-向.sqlproj项目文件中添加几行 <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCommandVariableOverride</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DBVersion=$(ExtDBVersion)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br> 完成。 不错的尝试，但是没有。 也许当这篇博客文章发表时，一切都奏效了，但是从那时起，在这些美国，您已经举行了三届总统大选，没人知道明天会有什么指示停止。 <br><br><img src="https://habrastorage.org/webt/xv/d9/li/xvd9liiwyjicnv5icr9d1utjnxs.jpeg"><br><br> 一个同志<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a>尝试了所有选择，但没有一个选择。 <br><br> 因此，从dacpac获取版本，或将其存储在PostDeploy中，或存储在单独的文件中，或_________（输入您的版本）。 <br><br><h4> 与1C集成 </h4><br> 第一个问题是1C77没有应用程序服务器或其他守护程序，允许它在不启动平台的情况下与其进行交互。 那些使用1C77的人知道她没有完整的控制台模式。 您可以使用参数运行平台，甚至可以基于参数进行操作，但是控制台参数很少，其用途有所不同。 但是即使有他们的帮助，您也可以将它们组合在一起。 但是，它可能会意外地飞出，它可能会弹出一个模式窗口，并等待某人单击“确定”和其他超级按钮。 也许，最大的问题-平台的速度有很多不足之处...因此，只有一种解决方案-直接查询1C数据库。 有了这样的结构，您不仅可以接受并编写这些查询，而且好处是整个社区一次都开发了一个很棒的工具-1C ++（1cpp.dll），这对他们来说是不可思议的！ 该库允许您以1C的形式编写查询，然后将其转换为表和字段的真实名称。 如果任何人都不知道，则可以使用伪名称编写请求，看起来像这样 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $.</code> </pre> <br> 这样的请求是人类可以理解的，但是服务器上没有这样的表和字段，还有其他名称，因此1C ++会将其转换为 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SP5278 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> SC2235</code> </pre> <br> 服务器已经理解了这样的请求。 每个人都很高兴，没有人发誓-一个人也不是服务器。 在这里，问题似乎已经解决。 <br><br> 第二个问题在于配置平面：在分支机构中使用一种配置，在中心局中使用另一种配置，在分支机构中使用第三种配置！ 课？!! 1我也这么认为。 而且，它们不是典型的，甚至不是典型的遗产，而是在维京人时期完全从头开始编写的，不幸的是，并不是最好的架构师为这些配置奠定了基础。例如，《实现》文档在每种配置中都有一组不同的详细信息。 但是，不仅某些字段的名称不同，当详细信息的名称相同时，这更有趣，而且存储在其中的数据的含义也不同。 <br><br><img src="https://habrastorage.org/webt/hs/jx/sv/hsjxsv_f7qy4xlgpwjiw7uir0ko.jpeg"><br><br> 在配置中，几乎不使用任何寄存器，所有内容都建立在复杂的文档上。 因此，有时我不得不在一个干净的事务上写一整张纸，包括大量的案例和联接，以重复配置中某些过程的逻辑，该过程在表单的文本字段中显示一些信息。 <br><br> 我们必须向开发团队致敬，这些年来，开发团队一直支持他们从“执行者”那里继承的东西，这是一项艰巨的工作-支持它甚至优化某些东西。 直到您看到-您不了解，我自己最初都不相信所有事情都可能如此复杂。 问-为什么不从头开始重写？ 普遍缺乏资源。 公司发展如此之快，以至于尽管有一大批程序员，但他们根本无法满足业务需求，更不用说重写整个概念了。 <br><br> 我们继续讲述请求的故事。 显然，所有用于数据提取的块都变成了存储，以便以后可以绕过1C平台在服务器端启动它们。 规则是这样的：一个存储负责检索一个实体。 因为 愿望清单在开始阶段已经积累了很多，因为多年来变得很痛苦，然后出现了数十个存储文件。 <br><br> 第三个问题是如何提高开发速度和质量，然后如何支持所有这些怪物？ 编写1C ++的请求，然后将其转换结果复制粘贴到存储中？ 此外，这非常不方便且乏味，而且出错的可能性很高-复制错误的一个或错误的一个或不选择查询的最后一行，然后在没有查询的情况下进行复制。 在直接进行1C查询时尤其如此，因为没有诸如<i>Directory。Nomenclature。Article的</i>伪名称，只有真实名称<i>SC2235.SP5278</i> ，因此将请求从商品目录下复制到检索顾客的商店非常简单。 当然，由于目标表中字段的类型和数量不匹配，请求很可能会下降，但是存在相同的图板，例如枚举，其中只有两列是ID和Name。 通常，仅保留某种自动化即可。 好吧，足够的歌词，让我们开始吧！ <br><br> 我希望存储开发过程可以归结为以下内容： <br><br><ol><li> 我们使用伪名称修复SQL查询并保存它 </li><li> 我们按下<b>魔术按钮，</b>然后在出口处收到转换后的SQL上已更正的存储过程，并已清除至服务器 </li></ol><br><h4> 一些细节 </h4><br> 为了解决第三个问题，编写了外部处理（.ert）。 处理中有许多过程，每个过程都包含用于使用伪名提取一个实体的查询文本，例如 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $.</code> </pre> <br> 在处理表格上，有一个用于显示特定过程结果的字段，即 请求转换为服务器可以理解的形式，以便您可以快速尝试。 另外， <b>调试块</b>总是添加到该请求中，其中包含变量的声明，测试数据库的名称，服务器等。 它仅保留在SSMS中复制粘贴并按F5键。 当然，您可以从处理本身执行此请求，但是您可以理解请求计划以及所有这些……通常，这就是调试的方式。 因为 有几种配置；在处理中，可以将带有对象伪名的相同查询文本转换为针对不同配置的最终查询。 实际上，在一个会议术语中引用的名称是SC123，在另一个会议中引用的名称是SC321。 但是1C ++允许您在运行时加载不同的配置，并根据字典为每个配置生成单独的输出。 <br><br> 接下来，将批处理运行模式添加到处理中，当它自动启动每个配置的每个过程时，每个过程的输出都将写入.sql文件（以下称为基本文件）。 因此，我们得到了一堆基本文件的组合，这些组合随后将使用VS自动转换为存储过程。 值得注意的是，基本文件包含<b>调试块</b> 。 <br><br> 似乎为什么不立即对存储过程的最终文件做出结论，并在此过程中保留所有内容？ 事实是，对于某些测试，有必要在声明所有变量的批处理中运行查询的调试版本，再加上我希望绕过1C从VS管理存储过程名称，因为这是合逻辑的，不是吗？ <br><br> 顺便说一句，基本文件也存储在项目中，当然，现成的存储过程的文件也存储在项目中。 任何时候都可以在不启动1C的情况下在SSMS中打开基础文件并执行该文件，而不必担心变量声明。 <br><br> 在处理中，所有带有请求的过程也是模板，具有相同的参数集，但是在该过程中，仅使用必要的参数。 在某些情况下，涉及到所有事情，而在某些情况下，两个就足够了。 因此，添加新过程归结为复制模板并使用查询本身填充参数。 <br><br> 其中一个处理过程的代码，之后将变成存储过程 <br><img src="https://habrastorage.org/webt/ci/ev/sb/cievsb9urq5miainrvoqu9mkig0.png"><br><br> 最终查询是这样的： <br><pre> <code class="1c hljs">++<span class="hljs-string"><span class="hljs-string">"("</span></span>+OPENQUERY()+<span class="hljs-string"><span class="hljs-string">")"</span></span>+ </code> </pre> <br> 加工外观 <br><img src="https://habrastorage.org/webt/yv/n4/in/yvn4injz09-m8ljnqhbediqvmqy.png"><br><br> 切换配置时，“数据”列表中用于卸载项目的可用（必要）项目列表会更改。 如果可能，将1C中的过程代码尽可能地统一。 如果提取了交易对手，并且这些目录在不同的配置中不一致，则生成过程中会有不同的情况，例如：此块对每个人都是固定的，仅针对这种confon将此块添加到最终请求中，而另一个对另一个confon。 事实证明，在一个实体的存储过程中，但是在不同的配置中，它们不仅可以因表名而异，而且可以因一个实体中存在而另一实体中不存在的整个连接块而不同。 当然，输出字段的集合是相同的，并且对应于接收器表或SSIS包的容器，对于一些配置，其中的字段原则上不是这些细节，因此某些字段会被存根阻塞。 <br><br>  <b>魔术按钮</b> <br><br>  Visual Studio具有MSbuild和出色的T4模板等工具。 因此，作为魔术按钮，用C＃编写了T4脚本，它是： <br><br><ol><li> 在注册表中注册一个空配置（否则1C将显示一个模式窗口，其中包含建议注册conf并等待用户操作的建议） </li><li> 在SQL Server上为此konf创建一个空数据库，因为没有它，1C会报错 </li><li> 启动1C，并通过OLE告诉它执行处理（相同的.ert），还将唯一的GUID传输到1C </li><li> 输出是一系列具有现成（已转换）请求的文件和一个标记文件，在启动时收到的GUID被写入其中 </li><li> 从注册表中删除conf的注册，并从服务器中删除一个临时的空数据库 </li><li> 检查令牌文件的内容。 如果标记文件包含我们在启动时传递给1C的GUID，则表示它工作到最后，没有崩溃等，然后转到下一步，否则我们显示错误 </li><li> 我们创建存储。 </li><li> 我们使用gcomp对.ert文件进行反编译，以获取模块文本和处理形式，然后我们将其转换为Unicode，以便随后发送至Git并在其中正确显示。 对于那些不使用1C的用户：.ert文件是二进制文件，而Studio和git一起吹嘘.ert文件已更改，但是不清楚其中到底有什么更改，也许只是有人将按钮向左移动了一个像素（没有理由就无法接受） </li></ol><br><br>     T4       ,     (   ,    )        .      ,          .         ,     ,       ,      ,         - —   1. <br><br>  ,  ,    ,        ,        ,          .      —   1,     1,  -   . <br><br>      :       ? <br><br><ol><li>     / ; </li><li>    VS     ,     ; </li><li>   4; </li><li> <s>.</s> 做完了 </li></ol><br><div class="spoiler"> <b class="spoiler_title">?</b> <div class="spoiler_text"> 因为               ,       ,    .sqlproj,  <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \1.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \2.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \3.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \*.sql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>       «     ».   ,  ,   ,     :) <br><br>     , ,    (, )     .           ( ),         , -   - -       ,             . <br></div></div><br>         ,      .      . , ,      ,      ,       ,       (    ),      . ,    (   ,      )  ,        ,  ,          .           ,   . ,     ,      ,     ,   ,     (   ,          1, ,    MD ). <br><br>      ,         <i>OPENQUERY</i> ,     1   ,     ,       ,       ,         <i>EXEC</i> . <i>OPENQUERY</i>    ,      ,   ,   . <br><br>  177 (  )   SQL2000,   varchar(max)  ,  varchar(8000),     9, … ,          EXEC(@SQL1+@SQL2).    ,       SQL2016,     SQL2000.     ,     ,    . <br><br><div class="spoiler"> <b class="spoiler_title">      </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName.dbo.$. <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName.dbo.$. <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> xxx = <span class="hljs-string"><span class="hljs-string">'hello!'</span></span> ^<span class="hljs-comment"><span class="hljs-comment">--       8 , ,        ,       ,   .          ,             .. ... join ... ) join ...</span></span></code> </pre> </div></div><br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[SP1] @LinkedServerName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) ,@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @TSQL0 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>), @TSQL1 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>), @TSQL2 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL0=<span class="hljs-string"><span class="hljs-string">' select ... from OPENQUERY('</span></span>+@LinkedName+<span class="hljs-string"><span class="hljs-string">','' select ... from '</span></span>+@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName+<span class="hljs-string"><span class="hljs-string">'.dbo.DH123. join '</span></span>+@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName+<span class="hljs-string"><span class="hljs-string">'.SC123. ... where '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL1=<span class="hljs-string"><span class="hljs-string">' xxx = ''''hello!'''' join ... join ... )'' join ... '''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL2=<span class="hljs-string"><span class="hljs-string">' ... EXEC(@TSQL0+@TSQL1+@TSQL2) END</span></span></code> </pre> <br></div></div><br>     —     .       (, )   ,       , ,     ,      ,      ,   OPENQUERY  8 . <br><br> .ert             ,        ..  ,     . <br><br>          ,    . <br><br><h4> ETL </h4><br> ,       (  ).      (Stage).   ,  ETL    SSIS , ,   ,     ,      .      .                    (  ),            . <br><br>                 ,     (   ) ,   ,        (..   ),            ,        . <br><br>          ,     ,      . ,     .     zabbix. <br><br>             . <br><br> 因为    1     ,        ,            .      ,   ,   <code>truncate</code>  . <br><br> ,       (  )       -,  « 1-»     . <br><br>     SSIS  <br><br><img src="https://habrastorage.org/webt/al/nl/u_/alnlu_3yriilaxfcwlhq_mcf_ce.png"><br><br>      <br><br><img src="https://habrastorage.org/webt/rh/eh/c8/rhehc8b9jtn6qf6polrfqjiduuk.png"><br><br><h4>  ,   </h4><br>         SSIS     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> SQL Server</a> (SQL Server Destination),     ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> OLE DB</a> (OLE DB Destination). <br><br>      ,       ,     ,             .    ,        ,   . (,     ) <br><br>       .           ,    ,      ,        (/  ). <br>                      . <br><br>          ,         (  ). 即       ,        .      ,        ,         .    -        —          .            . <br><br>                  ,         (.. )   . <br><br>       ,     ,          . <br><br><h4> 聚苯乙烯 </h4><br>     ,     ,      ,    ,   .   —   ,    .           -  ,       ,   . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN423205/">https://habr.com/ru/post/zh-CN423205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN423191/index.html">推出海上平台的元素。 第一部分</a></li>
<li><a href="../zh-CN423193/index.html">逐步使用pywebpush配置Web推送通知</a></li>
<li><a href="../zh-CN423195/index.html">JPA 2.2的新增功能</a></li>
<li><a href="../zh-CN423197/index.html">LOLWUT：数据库团队中的艺术品</a></li>
<li><a href="../zh-CN423203/index.html">酷团队负责人将负责服务</a></li>
<li><a href="../zh-CN423207/index.html">如何自动更新在线游戏客户端</a></li>
<li><a href="../zh-CN423209/index.html">杀手表格2？ MoonRay S100牙科3D打印机概述</a></li>
<li><a href="../zh-CN423211/index.html">国家杜马委员会：点赞和转发仍将承担刑事责任</a></li>
<li><a href="../zh-CN423213/index.html">就像古俄语一样，“这是一个考验”</a></li>
<li><a href="../zh-CN423215/index.html">我的钱在哪里，老兄：Steam沉默不语</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>