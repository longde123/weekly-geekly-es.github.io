<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëáüèΩ ‚õÖÔ∏è üôá Cari kesalahan FDCAN yang tidak üë©üèæ‚Äçüè´ üÖøÔ∏è üë®üèø‚Äçü§ù‚Äçüë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selalu bekerja dengan CAN itu sederhana, tetapi ada yang salah (di perangkat pada KDPV) ... 



 Baru-baru ini, saya sering berhasil menggunakan mikro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cari kesalahan FDCAN yang tidak</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483590/">  Selalu bekerja dengan CAN itu sederhana, tetapi ada yang salah (di perangkat pada KDPV) ... <br><br><img src="https://habrastorage.org/webt/ky/xj/cf/kyxjcfi0o7ycyw6h-9n4_iucezk.png" alt="gambar"><br><br>  Baru-baru ini, saya sering berhasil menggunakan mikrokontroler STM32H750VB, dan dalam satu perangkat saya perlu menggunakan bus CAN, tetapi upaya pertama yang saya lakukan <s>menunjukkan semua kepercayaan diri saya</s> memberikan hasil yang aneh.  Kisahnya dijelaskan di bawah ini. <br><a name="habracut"></a><br>  Jadi, pertama tentang sirkuit.  Pada KDPV dilingkari dengan warna hijau, tentu saja, pelakunya adalah mikrokontroler, tidak ada yang rumit dengan CAN - terhubung sesuai dengan <br><br><img src="https://habrastorage.org/webt/wa/fu/-v/wafu-vni4ogihvcyx6yljc3w18m.png" alt="gambar"><br><br>  MAX3051 digunakan sebagai lapisan fisik (well, saya suka ..), seperti ini: <br><br><img src="https://habrastorage.org/webt/h-/tr/q3/h-trq3qw6uj20y0wsvcbe24vxhi.png" alt="gambar"><br><br>  Sebelumnya, bukannya STM32H750VB, STM32F107 berada di sistem yang sama, tetapi orang tua itu tidak bisa mengatasi tugas dan diputuskan untuk menggantinya dengan yang lebih modern <s>dan muda</s> . <br><br>  Tapi ini nasib buruk - mikrokontroler lama memiliki bxCAN, dan yang baru sudah memiliki FDCAN.  Meskipun ada perbedaan, tetapi dari sudut pandang kode (dan bekerja - perangkat di bus sudah tua): penggantian sangat sederhana.  Bagi yang ingin, Anda dapat membandingkan: <br><div class="scrollable-table"><table><tbody><tr><th>  Apakah </th><th>  Telah menjadi </th></tr><tr><td><pre>  MX_CAN1_Init (); </pre></td><td><pre>  MX_FDCAN1_Init (); </pre></td></tr><tr><td><pre>     hcan1.Instance = CAN1;
     hcan1.Init.Prescaler = 4;
     hcan1.Init.Mode = CAN_MODE_NORMAL;
     hcan1.Init.SyncJumpWidth = CAN_SJW_4TQ;
     hcan1.Init.TimeSeg1 = CAN_BS1_15TQ;
     hcan1.Init.TimeSeg2 = CAN_BS2_2TQ;
     hcan1.Init.TimeTriggeredMode = DISABLE;
     hcan1.Init.AutoBusOff = ENABLE;
     hcan1.Init.AutoWakeUp = DISABLE;
     hcan1.Init.AutoRetransmission = DISABLE;
     hcan1.Init.ReceiveFifoLocked = DISABLE;
     hcan1.Init.TransmitFifoPriority = DISABLE; </pre></td><td><pre>   hfdcan1.Instance = FDCAN1;
   hfdcan1.Init.FrameFormat = FDCAN_FRAME_FD_NO_BRS;
   hfdcan1.Init.Mode = FDCAN_MODE_NORMAL;
   hfdcan1.Init.AutoRetransmission = ENABLE;
   hfdcan1.Init.TransmitPause = DISABLE;
   hfdcan1.Init.ProtocolException = ENABLE;
   hfdcan1.Init.NominalPrescaler = 1;
   hfdcan1.Init.NominalSyncJumpWidth = 3;
   hfdcan1.Init.NominalTimeSeg1 = 11;
   hfdcan1.Init.NominalTimeSeg2 = 4;
   hfdcan1.Init.DataPrescaler = 1;
   hfdcan1.Init.DataSyncJumpWidth = 3;
   hfdcan1.Init.DataTimeSeg1 = 11;
   hfdcan1.Init.DataTimeSeg2 = 4;
   hfdcan1.Init.MessageRAMOffset = 64;
   hfdcan1.Init.StdFiltersNbr = 0;
   hfdcan1.Init.ExtFiltersNbr = 0;
   hfdcan1.Init.RxFifo0ElmtsNbr = 4;
   hfdcan1.Init.RxFifo0ElmtSize = FDCAN_DATA_BYTES_8;
   hfdcan1.Init.RxFifo1ElmtsNbr = 4;
   hfdcan1.Init.RxFifo1ElmtSize = FDCAN_DATA_BYTES_8;
   hfdcan1.Init.RxBuffersNbr = 4;
   hfdcan1.Init.RxBufferSize = FDCAN_DATA_BYTES_8;
   hfdcan1.Init.TxEventsNbr = 4;
</pre></td></tr><tr><td><pre>  if (HAL_CAN_Init (&amp; hcan1)! = HAL_OK) { </pre></td><td><pre>  if (HAL_FDCAN_Start (&amp; hfdcan1)! = HAL_OK) { </pre></td></tr></tbody></table></div><br>  Secara umum, perbedaan kosmetik.  Dan bagi saya sepertinya itu akan bekerja sekaligus dan benar. <br><br>  Namun, itu tidak langsung berfungsi ... <br><br>  Kontroler CAN tidak dapat menetapkan level dominan dan masuk ke kondisi Bus-Off, dan tidak ada data yang diterima dari bus (terlepas dari kenyataan bahwa perangkat lain di bus secara stabil mengirim paket dua kali per detik). <br><br>  Yah, saya pikir, garis debugging datang, dan menyolder kabel pada jalur CAN-RX dan CAN-TX (sebenarnya, melihat bus itu sendiri tampak logis - perangkat itu diam, dan perangkat lain yang terhubung mengirim paket <s>, sesuai kesepakatan</s> ). <br><br>  Setelah itu, mode FDCAN_MODE_BUS_MONITORING pertama kali dihidupkan.  Dan, lihatlah, saya segera melihat paket dari bus!  (Dalam mode ini, pengontrol CAN hanya dapat mendengarkan data, tetapi tidak mengirimkan apa pun).  Sangat bagus ... <br><br>  Kemudian mode FDCAN_MODE_EXTERNAL_LOOPBACK dihidupkan (dalam mode ini, sebaliknya, kita hanya mendengarkan diri kita sendiri, tetapi kemudian kita mentransfer semuanya ke bus).  Dan pada garis CAN_RX dan CAN_TX semua paket data muncul - keduanya dikirim oleh perangkat itu sendiri dan diterima dari bus, di sini di <br>  Pada gambar di bawah (data abu-abu TX dari mikrokontroler, garis data oranye RX) mereka terlihat sebagai puncak: <br><br><img src="https://habrastorage.org/webt/qb/m3/f_/qbm3f_fo_u8j8aan5_aduaido4a.png" alt="gambar"><br><br>  Jadi, setelah percobaan ini, menjadi jelas bahwa rangkaian bekerja dengan benar, pengontrol CAN dalam mikroprosesor dapat menerima dan mengirimkan data. <br><br>  Namun, ketika mencoba untuk secara bersamaan menerima dan mengirimkan data, sistem masih menjadi Bus-Off dengan kesalahan dalam register kontrol kesalahan (register status protokol FDCAN (FDCAN_PSR)) LEC [2: 0] = 5 - yang berarti dari lembar data Bit0Error: Selama transmisi pesan (atau bit mengakui, atau kesalahan aktif <br>  flag, atau flag overload), perangkat ingin mengirim level yang dominan (data atau bit pengidentifikasi <br>  nilai logis 0), tetapi nilai bus yang dipantau adalah resesif ... <br><br>  Setelah dua hari siksaan (jelas apa kesalahannya, tetapi tidak jelas bagaimana cara memperbaikinya) dan studi yang cermat tentang lembar data, errata, dan sekelompok kode dan manual pihak ketiga, <s>pencerahan</s> sampai pada pemahaman saya - saya melakukan semuanya dengan benar, tetapi saya tidak berhasil! <br><br>  Yah, saya pikir, mungkin masalahnya ada di teknologi, dan ... mengganti mikrokontroler itu sendiri (dengan yang lain dari batch yang sama).  Dan ... itu berhasil!  Ya, di sini, tanpa <s>menari dengan rebana</s> masalah, dengan kode sumber dan sebagaimana mestinya menjadi yang pertama kalinya. <br><br><h4>  Ringkasan Singkat </h4><br>  Rupanya, spesimen licik seperti itu muncul.  Tetapi di sisi lain, saya berhasil menggali lebih dalam pekerjaan FDCAN secara umum, yang dapat dikaitkan dengan nilai tambahnya.  Dan untuk minus ... Dan untuk mereka dapat dikaitkan dengan waktu yang hilang (controller dapat dilampirkan ke proyek lain) dan pemahaman bahwa pengontrol modern buggy <s>dengan kekuatan yang mengerikan,</s> juga, dengan cara modern (atau apakah ini juga merupakan nilai tambah?). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id483590/">https://habr.com/ru/post/id483590/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id483578/index.html">Berita dari dunia OpenStreetMap No. 493 (12.24.2019 - 12.30.2019)</a></li>
<li><a href="../id483580/index.html">VIM - Ini bukan hanya editor, ini adalah integrasi dengan semua lingkungan kerja Anda</a></li>
<li><a href="../id483584/index.html">Mentransfer backend PHP ke Redis stream bus dan memilih perpustakaan yang tidak bergantung pada framework</a></li>
<li><a href="../id483586/index.html">Dasar-dasar bekerja dengan zmq dalam python, membuat penyimpanan kunci / nilai sederhana</a></li>
<li><a href="../id483588/index.html">Cara mencoba memblokir situs apa pun menggunakan ILV</a></li>
<li><a href="../id483594/index.html">Ekonomi masa depan untuk fisikawan</a></li>
<li><a href="../id483598/index.html">Bahkan lebih banyak telur Paskah yang musikal: kami terus berbicara tentang hadiah untuk pendengar yang penuh perhatian</a></li>
<li><a href="../id483602/index.html">Konferensi DefCon 27: Di Balik Layar Membuat Lencana Elektronik Bagian 2</a></li>
<li><a href="../id483604/index.html">Iridium: menerima dan mendekode sinyal konstelasi satelit di rumah</a></li>
<li><a href="../id483608/index.html">Visualisasi batas-batas solusi classifier berbasis gambar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>