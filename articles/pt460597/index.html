<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§öüèΩ üì© üëåüèº Como diagnosticar problemas de integra√ß√£o do SDK. A experi√™ncia da equipe de desenvolvimento do Yandex Mobile Ads SDK üë©üèΩ‚Äç‚úàÔ∏è üë≤üèø üõ¢Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Meu nome √© Dmitry Fisko, estou desenvolvendo o SDK do Yandex Mobile Ads. Nossa biblioteca foi projetada para gerar receita com aplicativo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como diagnosticar problemas de integra√ß√£o do SDK. A experi√™ncia da equipe de desenvolvimento do Yandex Mobile Ads SDK</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/460597/"> Ol√° pessoal!  Meu nome √© Dmitry Fisko, estou desenvolvendo o SDK do Yandex Mobile Ads.  Nossa biblioteca foi projetada para gerar receita com aplicativos m√≥veis nas plataformas Android e iOS.  Hoje, quero falar sobre como simplificamos a an√°lise de erros complexos de integra√ß√£o do SDK em aplicativos Android.  Talvez nossa experi√™ncia seja √∫til para voc√™. <br><br>  Nossos usu√°rios - desenvolvedores de aplicativos m√≥veis - nem sempre leem a documenta√ß√£o; portanto, √†s vezes, eles apresentam maneiras complexas de usar o SDK.  A integra√ß√£o incorreta pode reduzir a efic√°cia da publicidade e, portanto, reduzir a receita do desenvolvedor.  Para ajudar os desenvolvedores a monetizar melhor os aplicativos, criamos um sistema de monitoramento proativo que analisa o desempenho de um aplicativo m√≥vel.  Se aprendermos sobre o problema por meio do monitoramento, entraremos em contato com os desenvolvedores e ajud√°-los a encontrar a fonte do problema e resolv√™-lo. <br><br>  Infelizmente, nem todos os erros de integra√ß√£o do SDK podem ser identificados pelo monitoramento.  Se tal situa√ß√£o surgir, recorremos ao parceiro para esclarecer os detalhes da integra√ß√£o.  Em seguida, tentamos determinar a causa dos problemas e ajudar a resolv√™-los.  Se mesmo essas informa√ß√µes n√£o forem suficientes para determinar a causa dos erros, solicitamos ao parceiro permiss√£o para fazer a engenharia reversa do aplicativo.  Ap√≥s a permiss√£o, come√ßamos a ver o trabalho do SDK de publicidade no aplicativo como uma caixa preta.  Visualizamos a atividade da rede por meio de um proxy, verificamos a exibi√ß√£o de exibi√ß√µes de publicidade por meio do Inspetor de layout etc. <br><a name="habracut"></a><br>  A visualiza√ß√£o da atividade de rede de um aplicativo a partir do Android 7.0 √© problem√°tica, pois o sistema, por padr√£o, n√£o confia nos certificados definidos pelo usu√°rio.  A instala√ß√£o do certificado √© necess√°ria para visualizar o tr√°fego SSL do aplicativo atrav√©s de um proxy.  Isso resolver√° o problema iniciando o aplicativo nas vers√µes do Android anteriores √† 7.0 ou adicionando network_security_config ao aplicativo, por exemplo, atrav√©s do Apktool.  Voc√™ pode exibir a exibi√ß√£o de exibi√ß√µes de publicidade por meio do utilit√°rio Layout Inspector executando o aplicativo em um emulador ou em um dispositivo.  Nesse caso, voc√™ precisa modificar o arquivo AndroidManifest.xml adicionando o atributo <i>debuggable = true</i> por meio do Apktool. <br><br>  Se o m√©todo da caixa preta n√£o for suficiente e o problema n√£o puder ser reproduzido, voc√™ poder√° examinar a l√≥gica do aplicativo.  Para fazer isso, voc√™ pode usar os utilit√°rios de descompila√ß√£o do APK, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JADX</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bytecode Viewer</a> .  Mas muitas vezes essa abordagem leva muito tempo e nem sempre leva a um resultado.  Portanto, para entender rapidamente como o aplicativo usa o SDK de dentro para fora, criamos um script para substituir uma nova implementa√ß√£o do SDK em um aplicativo j√° criado. <br><br><h3>  <b>Instalando uma nova implementa√ß√£o do SDK em um aplicativo</b> </h3><br>  A altera√ß√£o do c√≥digo do SDK permite incorporar o c√≥digo arbitr√°rio no aplicativo por meio das classes da vers√£o modificada do SDK e, por exemplo, ativar o modo de log adicional.  O algoritmo de opera√ß√£o √© o seguinte.  Script: <br><br><ol><li>  desmonta arquivos DEX de aplicativos em pequenas empresas; </li><li>  converte o arquivo JAR da nova vers√£o do SDK em smali; </li><li>  substitui a implementa√ß√£o de arquivos smali SDK nos arquivos de aplicativos smali; </li><li>  Remonta o aplicativo com a nova vers√£o do SDK. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gw/rk/ku/gwrkku0cnnnauln9jie1wiim09s.png" width="700"></div><br><h3>  <b>Desmontar arquivos DEX de aplicativos em pequenas empresas</b> </h3><br>  Voc√™ precisa decompor o aplicativo, dividi-lo em unidades menores, para poder alterar o c√≥digo das classes do SDK sem alterar o c√≥digo do aplicativo.  Como abordar o aplicativo montado?  Desmonte o DEX em arquivos smali. <br><br>  No Android, o aplicativo armazena o c√≥digo nos arquivos DEX.  Voc√™ pode extra√≠-los do aplicativo por meio do utilit√°rio descompactar, pois o APK √© um arquivo comum com conte√∫do estruturado.  Os arquivos DEX t√™m um formato bin√°rio para empacotamento de c√≥digo mais denso em compara√ß√£o aos JARs.  Devido √† natureza bin√°ria do DEX, ele √© desumano, portanto, alterar o pr√≥prio DEX √© irracional.  A primeira coisa que vem √† mente √© descompilar o DEX em Java.  Essa convers√£o √© poss√≠vel, mas n√£o √© trivial e ocorre com a perda de funcionalidade do c√≥digo.  Portanto, usaremos a tradu√ß√£o para o c√≥digo smali.  A convers√£o para smali permite transferir com precis√£o as instru√ß√µes do DEX de forma leg√≠vel por humanos, com a possibilidade de convers√£o subsequente em c√≥digo vi√°vel. <br><br>  Chamar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utilit√°rio smali</a> converte o DEX em um conjunto de classes no c√≥digo smali.  Nesse caso, o arranjo inicial de classes por subpacotes √© preservado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ur/_q/rx/ur_qrxcls0qgsqkc9uv39q_vohy.png" width="600"></div><br><h3>  <b>Convertendo o novo SDK em smali</b> </h3><br>  Vamos preparar uma vers√£o de substitui√ß√£o do SDK.  Para garantir a reprodutibilidade do problema, criaremos uma vers√£o do SDK com o log ativado com base na mesma vers√£o que j√° est√° integrada ao aplicativo.  Uma das maneiras mais f√°ceis de descobrir a vers√£o conectada do SDK de an√∫ncios para celular do Yandex no aplicativo √© exibir o conte√∫do do m√©todo na classe MobileAds.getLibraryVersion () por meio do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apk Analizer</a> no Android Studio.  Depois de descobrir a vers√£o usada do SDK de publicidade, passamos para o ramo desta vers√£o e coletamos a vers√£o da biblioteca com log adicional.  Como resultado, obtemos um arquivo AAR.  Ele cont√©m recursos e c√≥digo da biblioteca.  No arquivo AAR, estamos interessados ‚Äã‚Äãapenas no c√≥digo no arquivo JAR, pois n√£o h√° recursos externos em nosso SDK: todos os recursos s√£o incorporados diretamente ao c√≥digo ou s√£o provenientes do back-end.  A falta de arquivos de recursos simplifica a integra√ß√£o do SDK no IDE sem o suporte de sistemas de compila√ß√£o modernos. <br><br>  Para alterar a vers√£o do SDK no aplicativo para um novo, trazemos o AAR para o mesmo estado que o aplicativo desmontado, ou seja, a partir do AAR, obtemos um conjunto de arquivos smali.  A convers√£o ocorre ao longo da cadeia: AAR ‚Üí JAR ‚Üí DEX ‚Üí SMALI: <br><br><ol><li>  do AAR usando o utilit√°rio descompactar, extra√≠mos o JAR com o c√≥digo; </li><li>  Convertemos JAR em DEX por meio do utilit√°rio dxdump do Android SDK Tools; </li><li>  obtemos os arquivos no c√≥digo smali usando o utilit√°rio smali com o arquivo DEX como par√¢metro. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x-/ma/il/x-mailcf2mefqvmdacff6dcha7m.png" width="630"></div><br><h3>  <b>Implementa√ß√£o do SDK</b> </h3><br>  Depois de recebermos os pequenos arquivos do aplicativo e do SDK com os logs, substitu√≠mos a implementa√ß√£o do SDK por uma nova.  Em seguida, reconstru√≠mos o aplicativo.  Ao transmitir para smali, as classes resultantes mant√™m sua localiza√ß√£o por subpacotes.  Portanto, se o pacote em que as classes do SDK est√£o localizadas for conhecido, ser√° f√°cil distinguir a classe da biblioteca das classes do aplicativo.  As classes SDK podem ser distribu√≠das por v√°rios DEXs.  Portanto, o algoritmo pelo qual a implementa√ß√£o do SDK √© substitu√≠da difere de um aplicativo com um ou v√°rios arquivos DEX. <br><br><h3>  <b><font color="#fd181d">E o</font> algoritmo para substituir a implementa√ß√£o do SDK em um aplicativo por um DEX</b> </h3><br>  Em um √∫nico aplicativo DEX, simplesmente copiamos as novas classes smali do SDK sobre todas as classes de aplicativos e geramos um DEX modificado.  Voc√™ pode gerar um arquivo DEX usando o utilit√°rio baksmali.  O diret√≥rio com os arquivos de pacote de classes no c√≥digo smali √© alimentado na entrada do utilit√°rio.  Depois de passar por baksmali os arquivos smali combinados do aplicativo e o novo SDK, obtemos um arquivo DEX modificado com a l√≥gica do SDK alterada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qy/5m/jk/qy5mjkuhcnfyec681wkio0w4fda.png" width="370"></div><br><h3>  <b><font color="#fd181d">E o</font> algoritmo para substituir a implementa√ß√£o do SDK em um aplicativo pelo MultiDex</b> </h3><br>  Para um aplicativo com MultiDex, adicione um SDK separado ao novo DEX e remova a vers√£o anterior do SDK do restante dos arquivos DEX do aplicativo.  Adicionar uma nova vers√£o do SDK a DEXs individuais contornar√° a limita√ß√£o no n√∫mero de m√©todos no formato DEX.  O MultiDex carregar√° automaticamente o arquivo DEX adicionado com o c√≥digo SDK, se for nomeado corretamente.  O MultiDex procura por arquivos DEX por sua vez, usando o √≠ndice no final do arquivo: primeiro dex1, depois dex2 - e assim por diante.Se voc√™ nomear o arquivo com um √≠ndice incremental, o MultiDex o carregar√° automaticamente na m√°quina virtual.  Assim, por meio do baksmali, geraremos arquivos DEX com base nos arquivos smali de aplicativos recebidos anteriormente, mas com classes exclu√≠das da vers√£o antiga do SDK.  E tamb√©m colete um arquivo DEX adicional com uma vers√£o modificada do SDK, incrementando o √≠ndice no nome do arquivo DEX. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7w/if/qj/7wifqjuneamhnw7wae86arkwu7w.png" width="530"></div><br><h3>  <b>Recrie o aplicativo com a nova vers√£o do SDK</b> </h3><br>  Temos arquivos DEX de aplicativos com uma vers√£o modificada do SDK.  O problema √© pequeno: substituiremos os arquivos DEX no arquivo APK originalmente descompactado do aplicativo pelos arquivos DEX modificados.  E, chamando o comando zip, obtemos a vers√£o final do APK, que ainda precisa ser assinada.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Assinaremos</a> com a tecla debug via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">apksigner</a> para que o aplicativo possa ser instalado no dispositivo.  O aplicativo com a l√≥gica SDK modificada est√° pronto. <br><br><h3>  <b><font color="#fd181d">N</font> Saving</b> </h3><br>  O algoritmo funciona na maioria dos casos, mas √†s vezes n√£o funciona para substituir a implementa√ß√£o do SDK no aplicativo.  As raz√µes para isso: <br><br><ol><li>  Ofusca√ß√£o ProGuard.  As regras no arquivo de consumidor da biblioteca impedem o ProGuard de mover as classes do SDK.  Mas se o desenvolvedor cancelar essas instru√ß√µes, parte das classes da biblioteca poder√° alterar seu pacote.  Nesse caso, o algoritmo n√£o funcionar√°, pois o script n√£o encontrar√° o local das classes do antigo SDK. </li><li>  Limita√ß√£o do formato DEX.  Se todo o c√≥digo do aplicativo estiver armazenado em um arquivo DEX, que esgotou quase completamente o limite dos m√©todos usados.  Ao substituir uma vers√£o do SDK em um aplicativo por uma vers√£o com log adicional, o n√∫mero de m√©todos aumentar√°.  O limite ser√° excedido.  No formato DEX, o limite √© 2 ^ 16. </li><li>  Proteja seu aplicativo contra altera√ß√µes.  O aplicativo possui mecanismos internos para combater a modifica√ß√£o.  Por exemplo, atrav√©s da valida√ß√£o da assinatura do aplicativo.  Ao alterar o APK, alteramos sua assinatura.  Quando o aplicativo √© iniciado, ele verifica a assinatura na refer√™ncia e lan√ßa uma exce√ß√£o.  √â especialmente dif√≠cil remover essa verifica√ß√£o se ela for colocada na parte nativa. </li></ol><br><h3>  <b><font color="#fd181d">E</font> togas</b> </h3><br>  Automatizamos as etapas descritas no artigo com um script bash simples.  O script possui falhas, mas acelera bastante a an√°lise de problemas complexos ao integrar o SDK nos aplicativos parceiros.  Por√©m, raramente usamos essa abordagem, pois geralmente encontramos uma solu√ß√£o em est√°gios anteriores. <br><br>  Desde a convers√£o para smali, voc√™ pode obter benef√≠cios adicionais: os arquivos smali permitem depurar o aplicativo sem fonte.  Para iniciar a depura√ß√£o, voc√™ precisa gerar um projeto no Android Studio com base nos pequenos arquivos do aplicativo e anexar o depurador ao processo de seu interesse.  Mais detalhes est√£o escritos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste artigo</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460597/">https://habr.com/ru/post/pt460597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460577/index.html">Viva o rei: mundo cruel da hierarquia em uma matilha de c√£es vadios</a></li>
<li><a href="../pt460587/index.html">M√≥dulo sem fio para sensor capacitivo de umidade do solo no nRF52832</a></li>
<li><a href="../pt460589/index.html">Escrevendo uma rede neural simples usando matem√°tica e numpy</a></li>
<li><a href="../pt460591/index.html">Obten√ß√£o de raiz em um roteador Tenda Nova MW6</a></li>
<li><a href="../pt460593/index.html">"Universal" na equipe de desenvolvimento: benef√≠cio ou dano?</a></li>
<li><a href="../pt460599/index.html">Not√≠cias do mundo do OpenStreetMap no 468 (02/07/2019 - 08.07.2019)</a></li>
<li><a href="../pt460603/index.html">V2G. Carros el√©tricos ajudar√£o a equilibrar a produ√ß√£o e o consumo de eletricidade</a></li>
<li><a href="../pt460605/index.html">Est√∫dio Fotogr√°fico Autom√°tico, Parte 1</a></li>
<li><a href="../pt460607/index.html">Loja de aplicativos de seguran√ßa ofensiva com ferramentas de hackers do Android</a></li>
<li><a href="../pt460611/index.html">Failover: o perfeccionismo nos destr√≥i e ... pregui√ßa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>