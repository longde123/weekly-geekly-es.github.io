<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😶 🙅🏾 🤷🏼 Nous protégeons le serveur distant sous Windows comme nous le pouvons 📒 🌳 🏇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le sujet de la sécurité des serveurs Windows a été soulevé plusieurs fois, y compris sur ce blog. Néanmoins, je voudrais à nouveau rafraîchir la mémoi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous protégeons le serveur distant sous Windows comme nous le pouvons</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pc-administrator/blog/474088/"><p><img src="https://habrastorage.org/getpro/habr/post_images/ee6/d54/289/ee6d54289f854ab18b4c86c99ce5243e.jpg"></p><br><p>  Le sujet de la sécurité des serveurs Windows a été soulevé plusieurs fois, y compris sur ce blog.  Néanmoins, je voudrais à nouveau rafraîchir la mémoire des anciennes méthodes de défense et en parler de nouvelles peu connues.  Bien sûr, nous utiliserons au maximum les outils intégrés. </p><br><p>  Supposons donc que nous ayons une petite entreprise qui loue un serveur de terminaux dans un centre de données distant. </p><a name="habracut"></a><br><p>  Lorsque vous concevez une protection, vous devez commencer par un modèle de menace - contre qui ou quoi, en fait, nous défendrons.  Dans notre configuration typique, je construirai une défense contre les pirates externes malveillants, des utilisateurs incompétents (et peut-être un peu malveillants).  Commençons par le périmètre extérieur de la défense - le pare-feu. </p><br><h1 id="za-toboy-kak-za-ognennoy-stenoy">  Derrière toi comme un mur de feu </h1><br><p>  À l'époque de Windows 2003, le pare-feu intégré était une vision misérable, et s'il était impossible d'utiliser des outils tiers, vous deviez utiliser IPSec.  Un exemple d'une telle configuration est discuté, par exemple, dans le document <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Secure Windows Servers using IPSec Firewall</a> . </p><br><p> Maintenant, avec l'avènement de WFP ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Windows Filtering Platform</a> ), les choses se sont améliorées.  En principe, chaque administrateur système Windows est probablement tombé sur ce pare-feu d'une manière ou d'une autre, donc configurer l'accès à distance au serveur uniquement à partir de certaines adresses IP ne devrait pas être difficile.  Je ferai attention à certains "chips", qui sont rarement utilisés. </p><br><p>  Par défaut, le pare-feu bloque toutes les connexions entrantes, à l'exception de celles explicitement autorisées, mais les sorties permettent toutes les connexions sauf celles explicitement interdites.  Cette politique peut être modifiée en ouvrant la gestion du pare-feu via wf.msc et en sélectionnant "Propriétés". </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/843/247/278/84324727844f52b04c72436b3b0190ae.jpg"></p><br><p>  <em>Paramètres du pare-feu.</em> </p><br><p>  Maintenant, si nous voulons empêcher les utilisateurs du serveur Terminal Server d'accéder à Internet à partir de ce serveur, nous réussirons. </p><br><blockquote>  Il convient de noter que lors de la configuration des règles d'accès au serveur (connexions entrantes), la création explicite de règles pour le trafic sortant n'est pas nécessaire.  En termes d'iptables, établis et liés sont toujours autorisés. </blockquote><p>  Pour les connaisseurs de la ligne de commande, vous pouvez configurer le pare-feu dans le contexte de netsh advfirewall.  Vous pouvez lire les commandes dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pare-feu Windows 7 avec sécurité avancée</a> ". J'ajouterai que le blocage des connexions entrantes et sortantes est activé par la commande: </p><br><pre><code class="bash hljs">netsh advfirewall <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> currentprofile firewallpolicy blockinbound,blockoutbound</code> </pre> <br><p>  Une autre caractéristique du pare-feu Windows est que tout programme ou paramètre modifie ses règles sans notification.  Par exemple, vous avez désactivé toutes les règles de notre grand-père, une seconde est apparue à proximité, vous avez créé un réseau local entre elles, mis en place un accès partagé et ... soudain, vous avez activé smb pour tout le monde et tout avec toutes les conséquences. </p><br><p>  Il y a essentiellement deux sorties et demie (permettez-moi de vous rappeler que nous ne parlons que d'outils intégrés): vérifiez régulièrement si les règles ont changé et utilisez le bon vieux IPSec ou, pour moi, l'option la plus raisonnable est de configurer le pare-feu avec la stratégie de groupe.  Les paramètres sont définis dans Configuration ordinateur - Configuration Windows - Paramètres de sécurité - Moniteur de pare-feu Windows Defender dans Advanced Security. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c09/9b2/f7c/c099b2f7c2be0024c3c5783d865308d4.jpg"></p><br><p>  <em>Configuration d'une stratégie de groupe de pare-feu.</em> </p><br><p>  De plus, en utilisant le pare-feu Windows, vous pouvez implémenter un fail2ban simple.  Il suffit d'activer l'audit des tentatives de connexion infructueuses et, en cas de plusieurs échecs consécutifs, de bloquer l'adresse IP source.  Vous pouvez utiliser des scripts auto-écrits, ou vous pouvez utiliser des outils prêts à l'emploi, dont j'ai parlé dans l'article « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment donner des chiffreurs pour couler une entreprise</a> ». </p><br><p>  Si le pare-feu intégré ne suffit pas et que vous souhaitez utiliser quelque chose de plus sérieux, vous pouvez installer un logiciel tiers.  Il est dommage que la plupart des solutions bien connues pour Windows Server soient payantes.  Une autre option serait de placer un routeur devant le serveur.  Il est clair qu'une telle installation convient si nous utilisons la colocation et que nous ne louons pas un serveur quelque part loin, très loin à l'étranger.  Si le centre de données étranger est notre choix, vous pouvez utiliser la virtualisation - par exemple, Hyper-V intégré - et installer GNU \ Linux ou FreeBSD familier dans la machine virtuelle. </p><br><p>  La question se pose: comment faire en sorte que la machine virtuelle ait un accès direct à Internet, mais pas le serveur?  De plus, que l'adresse MAC du serveur ne brille pas sur l'hébergeur et ne nécessite donc pas l'achat d'une autre adresse IP. </p><br><blockquote>  Attention  Il est préférable d'effectuer d'autres actions via IP-KVM! </blockquote><p>  Pour cela, la machine virtuelle doit être équipée de deux adaptateurs réseau.  L'une est pour la connexion directe à Internet, pour cela nous allons faire un switch virtuel de type «externe» et décochez la case permettant au système d'exploitation d'interagir avec ce switch.  Avec cette coche, nous privons le serveur d'un accès direct à Internet (il est préférable de configurer le pare-feu virtuel à l'avance), et son MAC ne s'allumera pas sur l'hôte. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/183/150/bd1/183150bd155c8e704802546314738394.jpg"></p><br><p>  <em>Configurez un commutateur virtuel externe.</em> </p><br><p>  Un autre commutateur virtuel doit être de type «interne» pour l'interaction entre la machine virtuelle et le serveur.  Il doit déjà configurer l'adressage local.  Cela va créer un routeur virtuel qui se tient devant le serveur et le protège. </p><br><p>  Dans le même temps, vous pouvez configurer votre VPN préféré pour le bureau ou les employés distants sur cette machine virtuelle sans se soucier du rôle de «Routage et accès distant» ou avec IPSec intégré, comme je l'ai décrit dans l'article « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment j'ai caché la base 1C en Allemagne</a> ».  L'essentiel est de ne pas oublier de vérifier le démarrage de cette machine virtuelle au démarrage du système. </p><br><p>  Vous pouvez vous connecter à un tel serveur à l'aide de RDP standard ou utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des clients HTML5</a> avec une authentification à deux facteurs.  En cas de force brute, il vaut la peine de s'occuper des deux solutions fail2ban et de bloquer le compte pendant un certain temps avec plusieurs tentatives infructueuses d'autorisation consécutive. </p><br><p>  Dehors, nous avons plus ou moins protégé le serveur, passons à la protection interne. </p><br><h1 id="zaschita-vnutrennyaya-ostanovit-i-ne-puschat">  Protection interne: arrêtez et ne lâchez pas </h1><br><p>  Bien sûr, pour protéger le serveur de l'intérieur, je veux vraiment installer une sorte d'antivirus - on ne sait jamais ce que les utilisateurs du serveur accumulent ou pompent depuis Internet.  Mais en pratique, l'antivirus sur le serveur peut faire plus de mal que de bien.  Par conséquent, j'utilise généralement des mécanismes de blocage de lancement de logiciels non mis en liste blanche - en particulier, le mécanisme SRP (stratégies de restriction logicielle), que j'ai également mentionné dans l'article « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment permettre aux chiffreurs d'inonder une entreprise</a> ». </p><br><p>  Je m'attarderai plus en détail sur un écueil, que nous oublions souvent lorsque vous activez SRP avec des paramètres standard, lorsque tout est bloqué, à l'exception des dossiers Windows et Program Files.  En effet, cela filtre presque tous les logiciels malveillants.  Mais cela ne fonctionne pas vraiment avec la malveillance des employés, car dans les dossiers système, il existe des sous-dossiers avec le droit de créer des objets par les utilisateurs.  Par exemple, vous pouvez consulter le dossier C: \ Windows \ Temp. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/792/8a3/a92/7928a3a92823ab9ee919cdb456ed94da.jpg"></p><br><p>  <em>Autorisations pour le dossier qui est sur liste blanche.</em> </p><br><p>  Et un tel dossier n'est pas le seul.  Vous pouvez, bien sûr, auditer vous-même les dossiers système, ou vous pouvez faire confiance à des personnes qui l'ont déjà fait.  Par exemple, un spécialiste de <em>Stefan Kanthak</em> sur son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">blog</a> (il y a un virus de test EICAR par référence, un antivirus peut fonctionner) parcourt de manière plutôt agressive les méthodes de protection antivirus et Windows et propose en même temps un package de paramètres SRP déjà assemblé qui bloquera également ces dossiers suspects.  Sur demande, l'auteur fournit un programme pour convertir ces paramètres de registre en fichiers de stratégie locale. </p><br><p>  Si vous préférez utiliser le mécanisme AppLocker avec des paramètres plus flexibles, la solution <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AaronLocker</a> peut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous</a> aider. </p><br><blockquote>  Les éditeurs ne recommandent pas d'utiliser et d'installer des scripts et d'autres programmes à partir d'Internet sans les avoir d'abord étudiés. </blockquote><p>  Si AppLocker est apparu pendant longtemps et que l'âge de SRP a dépassé 15 ans, alors une alternative relativement récente est WDAC (Windows Defender Application Control).  En effet, depuis Security Essentials, l '«antivirus» intégré a acquis de nombreuses fonctionnalités intéressantes.  Par exemple, WDAC est le module responsable des politiques d'accès aux applications et aux bibliothèques.  Auparavant, il faisait partie de Device Guard (protection d'un ordinateur, y compris en utilisant des technologies de virtualisation), et un peu de sa configuration était décrite dans l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le principe du mode S dans Windows 10 et la configuration de Device Guard de vos propres mains</a> ."  Plus de détails sur toutes les subtilités peuvent être trouvés dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> officielle, mais je peux ajouter quelques inconvénients qui le distinguent des solutions classiques comme SRP et AppLocker: </p><br><ul><li>  Il n'y a pas de configuration graphique, tout au long des applets de commande PowerShell. </li><li>  Il n'y a pas de paramètres dans la tranche utilisateur, uniquement pour l'ordinateur. </li><li>  La configuration est assez inhabituelle - un fichier xml est préparé, qui est ensuite converti en binaire et distribué aux ordinateurs. </li></ul><br><p>  Mais il est possible de configurer l'application dans une tranche: par exemple, si vous souhaitez donner à cmd.exe l'accès à votre script, et non à un virus tiers, cela peut être implémenté.  De plus, la politique peut être appliquée avant de démarrer le système à l'aide d'UEFI. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/eef/b63/bfe/eefb63bfe3fd2313517544106174af73.jpg"></p><br><p>  <em>Verrou Chrome via WDAC.</em> </p><br><p>  En général, en raison de la configuration douloureuse, l'impression était que WDAC n'était plus positionné seul pour gérer les ordinateurs, mais comme un outil qui vous permet de vous intégrer à des systèmes MDM centralisés comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Microsoft Intune</a> .  Mais en même temps, le développement du bon vieux SRP a été <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interrompu</a> dans Windows 10 1803. </p><br><p>  Si nous parlons de Windows Defender, vous ne pouvez pas vous empêcher de mentionner Credential Guard et Remote Credential Guard. </p><br><p>  Le premier outil utilise à nouveau la virtualisation, démarrant le composant LSA (Local Security Authority) dans un processus isolé du système d'exploitation, ce qui complique grandement le processus de vol de hachages de mots de passe et de tickets Kerberos.  En savoir plus sur la technologie dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> officielle.  Pour que le processeur fonctionne, il doit prendre en charge la virtualisation et le système doit avoir le démarrage sécurisé activé et le module TPM pour lier les informations d'identification à l'équipement.  Vous pouvez activer Credential Guard via la stratégie de groupe Configuration ordinateur - Modèles d'administration - Système - Device Guard - Activer la sécurité basée sur la virtualisation. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e4d/88e/ade/e4d88eade072b25149d4a9a00c5d7e32.jpg"></p><br><p>  <em>Activation de Credential Guard.</em> </p><br><p>  Le deuxième outil sert à protéger les informations d'identification transmises (en particulier l'administrateur!) Pour la connexion à distance, par exemple, via le même RDP.  Auparavant, le mécanisme du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mode administrateur restreint</a> était proposé à ces fins, mais il limitait la connexion à un seul serveur.  Une fois connecté au serveur, il était impossible d'utiliser uniquement les ressources réseau, les droits d'administrateur étaient appliqués à un seul serveur à la fois sur le compte Système local. </p><br><p>  Remote Credential Guard vous permet de transférer des informations d'identification de la machine locale vers un serveur distant sans entrer de mot de passe explicite, ce qui, en plus d'une sécurité avancée, offrira également la commodité de la connexion aux serveurs (SSO).  Vous pouvez en lire plus dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> , mais j'ajouterai que pour que le mécanisme fonctionne, il suffit d'activer sa prise en charge sur le serveur - par exemple, via le registre avec la commande: </p><br><pre> <code class="bash hljs">reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /d 0</code> </pre><br><p>  Et puis connectez-vous au serveur avec la commande: </p><br><pre> <code class="bash hljs">mstsc.exe /remoteGuard</code> </pre><br><p>  Maintenant, les informations d'identification sont sécurisées et le serveur est assez sécurisé.  Certes, dans le matériel, je n'ai pas consciemment abordé les questions de protection contre un hébergeur malveillant, mais ici, cela se résume à une chose en général - au chiffrement du disque. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr474088/">https://habr.com/ru/post/fr474088/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr474070/index.html">Dispositifs de salle de réunion BYOD</a></li>
<li><a href="../fr474076/index.html">Comment devenir le meilleur au monde dans une niche</a></li>
<li><a href="../fr474080/index.html">Bot télégramme montrant les premières pages des 10 périodiques mondiaux les plus populaires</a></li>
<li><a href="../fr474082/index.html">Phonocut - un enregistreur de vinyle domestique: réflexions sur la probabilité de décollage</a></li>
<li><a href="../fr474084/index.html">Julia et les réseaux de neurones: Flux</a></li>
<li><a href="../fr474090/index.html">Salaires de Developer à Arménie</a></li>
<li><a href="../fr474092/index.html">Section backend de DUMP Kazan: architecture d'application cloud, microservices sortants, DDD et plus</a></li>
<li><a href="../fr474094/index.html">Éditeur de diagramme - sur l'amitié entre Vue.js et MxGraph</a></li>
<li><a href="../fr474096/index.html">Langages de programmation populaires 2019 des utilisateurs de hh.ru</a></li>
<li><a href="../fr474104/index.html">Un moyen universel de personnaliser l'apparence d'une application WinForms (en utilisant l'exemple de FAQ.Net)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>