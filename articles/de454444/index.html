<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✍️ 🐅 🧑🏾‍🤝‍🧑🏻 Wir profilieren das Laden von Habr oder wie 189 Anfragen auf der Seite Einfluss nehmen 🌚 🕢 🤽🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einiger Zeit interessierte ich mich für die Leistung von Websites, Download-Optimierungen und dergleichen. Und jetzt, als ich wieder ins Habr ging...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir profilieren das Laden von Habr oder wie 189 Anfragen auf der Seite Einfluss nehmen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454444/"><p><img src="https://habrastorage.org/webt/dg/5m/ab/dg5mabkefi6xhfiovvydhay2fkw.jpeg" alt="Nimm dicken Kirschsaft"></p><br><p>  Vor einiger Zeit interessierte ich mich für die Leistung von Websites, Download-Optimierungen und dergleichen.  Und jetzt, als ich wieder ins Habr ging, dachte ich, ich wäre es gewohnt, eine ziemlich schnelle Ressourcenbelastung als gegeben zu betrachten, ohne darüber nachzudenken, wie dies erreicht wurde.  Aus diesem Grund habe ich mich entschlossen, Geschäft mit Vergnügen zu verbinden - um zu sehen, wie sich die Leistung von Habr entwickelt und welche technischen Lösungen zur Optimierung entwickelt wurden. </p><br><p>  Für diejenigen, die wissen möchten, was getan wurde, damit wir den Inhalt so schnell wie möglich erhalten und wie der Download des Habr aus Argentinien aussieht - bitte unter Katze. </p><a name="habracut"></a><br><h2 id="podgotovka">  Vorbereitung </h2><br><p>  Wir benötigen eine neue Version von Chrome / Canary, die im anonymen Modus arbeitet (stellen Sie sicher, dass alle Erweiterungen deaktiviert sind).  Außerdem müssen Sie in der Entwicklerkonsole (Developer Tools - F12) auf der Registerkarte "Netzwerk" das Flag "Cache deaktivieren" setzen, da  <strong>Wir werden nur den ersten Start profilieren, solange sich noch keine Ressourcen im Cache befinden.</strong> </p><br><h2 id="etap-pervyy---po-verham">  Stufe Eins - "Oben" </h2><br><p>  Das Hauptziel dieses Teils ist es, die Site als Ganzes kennenzulernen, ihre Struktur zu verstehen und herauszufinden, welche spezifischen Ressourcen sie benötigt. </p><br><p>  Wir öffnen Entwicklertools, gehen zur Registerkarte "Netzwerk", öffnen die Site und sehen uns ganz unten auf der Registerkarte Statistiken zur Netzwerknutzung an: </p><br><p><img src="https://habrastorage.org/webt/ni/fs/yb/nifsybxewz18qswerh5jubfsn1a.png" alt="Und der Umhang einer weißen Mutter."></p><br><p>  Die gesamte Site wurde in 2,02 Sekunden geladen, was einfach großartig aussieht (angesichts der Last von Habr).  Das Ereignis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DomContentLoaded</a> (im Folgenden einfach DCL) wurde im Allgemeinen in 1,01 Sekunden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">angezeigt,</a> was sogar noch besser aussieht.  Mit all dem stellt die Site 189 Anfragen und lädt 9,6 MB Ressourcen.  Dies sagt uns, dass entweder das Habra-Team ein Genie ist (es kann durchaus sein) und der Artikel hier fertiggestellt werden sollte (und sie das Team um Kaffee und Kekse bitten), oder dass ich einen 100-Mbit / s-Kanal und Core I7 habe .  Das heißt,  Sie müssen der Realität ein wenig näher kommen und zumindest die Kanalbreite begrenzen. </p><br><p>  Wir schalten den Fast 3G-Modus ein und schauen noch einmal: </p><br><p><img src="https://habrastorage.org/webt/bp/ov/lk/bpovlkvte1ojvmuamwcoki4uniq.png" alt="Gießen Sie den Saft trinken auf den Umhang -"></p><br><p>  Der DCL verschlechterte sich auf 3,48 Sekunden, was immer noch einigermaßen akzeptabel ist.  Aber schließlich wurde die Seite in atheistischen 54,76 Sekunden geladen.  Jetzt ist alles logisch - Sie können nicht einfach fast 10 Megabyte herunterladen und herunterladen, wenn Sie eine schwache Verbindung haben.  Höchstwahrscheinlich haben die Jungs gute Arbeit geleistet, um uns den Inhalt so schnell wie möglich zu zeigen (dies wird durch die Tatsache belegt, dass DCL auch im Fast3G-Modus schnell genug auftritt), und sie haben alles, was für das Laden nicht kritisch war, im Hintergrund gelassen.  Wir werden das etwas später überprüfen und jetzt wollen wir sehen, warum wir so lange geladen haben.  Sortieren Sie alle Anfragen nach Ladezeit: </p><br><p><img src="https://habrastorage.org/webt/el/jv/uc/eljvucnzbn0d83cd2konxv8ff-8.png" alt="Ein Punkt wird zu Einstellungen."><br>  <a href="">Klickbar</a> </p><br><p>  Bilder (Top-7) werden am längsten geladen und eine JavaScript-Datei ist prebid.js.  Wenn wir ihre Größe betrachten, können wir annehmen, dass dies genau der Grund für das langsame Laden ist. </p><br><div class="spoiler">  <b class="spoiler_title">Über Annahmen</b> <div class="spoiler_text"><p>  Mit Annahmen müssen Sie äußerst vorsichtig sein.  Beispielsweise kann ein langes Laden einer Ressource nicht nur durch die Dateigröße verursacht werden, sondern auch beispielsweise durch Probleme mit DNS, maximale Speicherlast oder einen Cold-Server-Cache.  Daher kann eine nicht überprüfte Annahme dazu führen, dass Sie Zeit damit verschwenden, ein Problem zu lösen, das noch nicht einmal existiert. </p></div></div><br><p>  Wenn wir uns die Statistiken <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ansehen</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">TTFB</a> : 0,610 ms, Last: 40 000 ms), können wir schließen, dass unsere Annahme sehr wahrscheinlich ist.  Bewundern wir unsere TOP 1 (png, 1560X780, 24bit): </p><br><p><img src="https://habrastorage.org/webt/61/ts/aj/61tsajb8gnvzqjaw0cg-mqdj32e.png" alt="Jetzt, wo es keinen Platz mehr gibt"></p><br><p>  In der Tat sind Probleme mit Bildern hauptsächlich Probleme unseres Verkehrs mit Ihnen.  Bilder (im Gegensatz zu Stilen und Skripten) blockieren das Rendern der Webseite nicht. Trotz des Vorhandenseins solcher Schwergewichte (es kann schlimmer sein, sie haben es gesehen) hat dies fast keinen Einfluss auf die Leistung.  Obwohl natürlich eine Optimierung in dieser Richtung (z. B. Transcodierung in jpeg2000 oder webp oder progressives Laden wäre nicht überflüssig). </p><br><div class="spoiler">  <b class="spoiler_title">Über Bilder</b> <div class="spoiler_text"><p>  Wie ich oben geschrieben habe, blockieren Bilder nicht das Rendern der Seite.  Aber sie nutzen unseren Verbindungspool und in http 1.x ist ihre Anzahl begrenzt, und auch bei http 2.x und Chrome ist nicht alles so reibungslos, wie ich gehört habe.  Daher besteht auch hier die Möglichkeit, dass ein Bild das Laden eines synchronen Skripts verlangsamt und das Rendern der Seite bereits beendet wird.  Darüber hinaus kann das Laden des Bildes auch zu einer Nachzählung des Layouts führen, wodurch das Rendern verlangsamt wird.  Wenn wir uns das Habr-Markup ansehen, haben fast alle img-Tags Breite und Höhe.  Dadurch entfällt der Reflow, um die Download-Leistung positiv zu beeinflussen.  Mehr dazu lesen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </p></div></div><br><p>  Mal sehen, welche anderen Ressourcen der Habr nutzt - wir werden die Typen durchgehen und sie nach Ladezeit sortieren.  Beginnen wir mit JavaScript </p><br><h3 id="javascript">  Javascript </h3><br><div class="spoiler">  <b class="spoiler_title">Über Javascript</b> <div class="spoiler_text"><p>  JavaScript hat verschiedene Probleme mit der Leistung der Website.  Erstens (jeder weiß das schon lange) blockiert synchrones js das weitere Rendern von Seiten.  Das heißt,  Bis wir unser JavaScript erhalten und ausführen, wartet der Browser (eigentlich nicht ganz, der Browser, insbesondere Chrome, kann optimieren, aber dies ist eine andere Geschichte) und rendert keinen weiteren Inhalt.  Mit synchronen Skripten im Kopf verschieben wir den Moment, in dem der Benutzer mindestens etwas sieht (sogar Text).  Daher versucht jeder, Js am Ende der Seite zu werfen oder sie sogar asynchron zu machen.  Dies funktioniert, löst aber nicht das zweite Problem, das uns die Tatsache bringt, dass JavaScript immer noch eine Skriptsprache ist.  Daher reicht der Browser nicht aus, um ihn nur herunterzuladen - er muss auch "verstanden" werden.  Und hier stellt sich heraus, dass dies ein Problem ist, da schwache Prozessoren (z. B. in billigen Telefonen oder Netbooks oder sogar guten Laptops im eingeschränkten Leistungsmodus) dies langsam tun und den Haupt-Thread blockieren!  Im Folgenden finden Sie ein Beispiel dafür, wie ein asynchrones Werbeskript in den kritischen Bereich des Habr-Renderings eingedrungen ist und zwar ein wenig, aber dennoch die Leistung beeinträchtigt hat.  Wenn jemand interessiert ist, gibt es einen sehr (sehr, sehr) guten Artikel zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Thema.</a> </p></div></div><br><p>  Habr-Skripte laden viel - 1,1 MB (und dies ist bereits in komprimierter Form) für 40 Anfragen.  Dies ist ehrlich gesagt wichtig, es kommt immer noch auf uns zurück und wir müssen etwas dagegen tun.  Sortieren Sie unsere Skripte "nach dem Wasserfall".  Unsere Aufgabe ist es, Skripte zu finden, die VOR der blauen Linie geladen wurden, da sie (höchstwahrscheinlich) verhindern, dass wir die Site so schnell wie möglich rendern. </p><br><p><img src="https://habrastorage.org/webt/0m/8g/u4/0m8gu4f9s-odx2kf7xg8jiweuke.png" alt="Auf dem Umhang meiner Mutter"><br>  <a href="">Klickbar</a> </p><br><p>  Wir öffnen das HTML, das Habr uns gegeben hat (es ist wichtig, die Antwort zu lesen, da das endgültige HTML anders aussehen wird) und gehen die Liste durch.  Wie Sie sehen können, werden jQuery, raven.js, Advertise.js und adriver.js synchron direkt vom Head-Tag geladen (d. H. Sie blockieren überhaupt alles).  Gpt und Publisher werden vom Kopf geladen, aber bereits asynchron (d. H. Sie blockieren nichts, der Browser rendert die Seite weiter, während sie geladen werden).  Vendors, Main und Math, Checklogin werden am Ende geladen, aber synchron (d. H. Der Text ist bereits vorhanden, wir können ihn lesen, aber die DCL wird erst angezeigt, wenn sie geladen werden).  Der Rest erscheint nicht in der ersten Antwort - sie werden dynamisch hinzugefügt, aber dies ist ein anderes Thema. </p><br><p>  Wir haben also Skripte gefunden, die sich irgendwie darauf auswirken, wie schnell wir den Text auf der Seite sehen.  Dies sind die ersten Kandidaten für eine Optimierung.  Idealerweise sollten sie asynchron oder so niedrig wie möglich platziert werden, damit der Browser Inhalte für uns rendern kann.  Das Ideal ist jedoch nicht erreichbar, da es höchstwahrscheinlich andere Skripte auf der Site gibt, die von derselben jQuery abhängen.  Der Wunsch, Raven so schnell wie möglich herunterzuladen - eine Bibliothek zum Verfolgen verschiedener Fehler, die auf dem Client auftreten - kann ebenfalls verstanden werden.  Advertise.js und adriver.js sind jedoch bereits echte Kandidaten, um zumindest die Seite nach unten zu bewegen, und maximal auch im asynchronen Modus.  Eine ähnliche Geschichte mit gpt und Publisher.  Ja, sie werden asynchron geladen, aber sie können (und werden) uns beim Laden stören.  Daher können auch sie ganz unten auf der Seite gesendet werden.  Darüber hinaus können Sie versuchen, die Attribute " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ressourcenhinweise"</a> - "Preload / Prefetch / DNS-Prefetch" zu verwenden, um dem Browser mitzuteilen, was im Voraus geladen werden soll.  Übrigens rate ich Ihnen, über Ressourcenhinweise zu lesen - ein sehr interessantes Tool, wenn auch mit begrenzter (bisheriger) Unterstützung. </p><br><p>  Sortieren Sie nun die Liste nach Dateigröße: </p><br><p><img src="https://habrastorage.org/webt/r-/om/kq/r-omkqj5qrslwffj42o5eogv_3s.png" alt="Der Umhang muss ganz verstaut sein"><br>  https://github.com/Drag13/articles/blob/habrformance/habrformance/scripts.PNG </p><br><p>  Wir sehen ein Skript, das zweimal geladen wird (Pubads).  Wir stellen außerdem fest, dass prebid.js aus dem Not-for-Prod-Ordner geladen wird </p><br><p><img src="https://habrastorage.org/webt/4e/su/7w/4esu7wsvwdpgmbw8nscc_sqcgmo.png" alt="In dickem Kirschsaft."></p><br><p>  Um unser Gewissen zu klären, überprüfen wir, ob alle Skripte minimiert sind.  Plötzlich wurden die Skripte check-login.js und adriver.js nicht minimiert.  Besonders zufrieden mit dem Inhalt des letzteren: </p><br><p><img src="https://habrastorage.org/webt/6q/nv/q8/6qnvq8dimcd_5m3w77mr3mkjlea.png" alt="Nimm den Umhang einer Kirschmutter"></p><br><p>  Und mit Skripten können Sie vorübergehend beenden. </p><br><h3 id="stili">  Stile </h3><br><div class="spoiler">  <b class="spoiler_title">Über Stile</b> <div class="spoiler_text"><p>  Bei Stilen ist auch nicht alles so einfach.  Erstens blockiert das synchrone Laden von Stilen auch den Hauptthread (obwohl sie schnell und schneller als JavaScript analysiert werden).  Und zweitens ist alles etwas komplizierter.  Warum benötigt der Browser CSS?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CSSOM erstellen</a> .  Was kann JavaScript mit CSS tun?  Das ist richtig - ändern.  Und was passiert, wenn CSSOM noch nicht erstellt wurde und js dort bereits versucht, etwas zu ändern?  Die Antwort ist wer weiß.  Daher verzögert der Browser die Ausführung von JavaScript, bis die CSSOM berechnet ist.  Wie in einem anderen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sehr nützlichen Artikel</a> richtig geschrieben - kein CSS = kein JavaScript.  Daher blockiert das Laden von CSS die JS-Ausführung. </p></div></div><br><p>  Hier sind die Stile, die Habr lädt: </p><br><p><img src="https://habrastorage.org/webt/nm/6y/a7/nm6ya7qcp1bdqcp5sl2fiingrp8.png" alt="Und eine Tasse Milch."><br>  <a href="">Klickbar</a> </p><br><p>  Wie Sie sehen können, gibt es nur drei davon, wobei der zweite und der dritte in einem separaten Frame geladen sind. Daher ignorieren wir sie.  Der erste Satz von Stilen ist jedoch für die gesamte Site von entscheidender Bedeutung.  Und wir haben es sehr lange heruntergeladen.  Warum?  Erstens haben sie lange auf eine Antwort vom Server gewartet (TTFB 570 ms, wir werden im dritten Abschnitt darauf zurückkommen), und zweitens wurden 713 ms für eine lange Zeit geladen.  Was kann man hier machen?  Die erste und einfachste Möglichkeit besteht darin, das Preload-Attribut hinzuzufügen.  Dadurch wird der Browser aufgefordert, CSS so früh wie möglich zu laden.  Die zweite Möglichkeit besteht darin, kritisches CSS hervorzuheben und direkt in die Webseite einzubetten und den Rest synchron (oder sogar asynchron) zu laden.  Dies führt zu einer Vergrößerung der Seite (aber sie ist bereits nicht klein und + 5 KB verderben nichts) und einer möglichen Neugestaltung des Layouts (Zeitverlust), aber Sie können es versuchen. </p><br><p>  Ich werde nicht einmal Schriftarten anzeigen.  Es ist alleine da, obwohl es aus irgendeinem Grund direkt vom Habr-Server anstelle des CDN geladen wird (und höchstwahrscheinlich aus einem Grund).  Aber ich werde mich dafür bedanken, dass es nur eine Schriftart gibt. </p><br><p>  Hierbei kann der Übersichtsteil der Site-Analyse als abgeschlossen betrachtet werden.  Zeit, tiefer zu gehen. </p><br><h2 id="etap-vtoroy---ruchnoy-rezhim">  Stufe zwei - "Manueller Modus" </h2><br><p>  In der letzten Phase haben wir gesehen, <em>dass</em> Habr lädt.  Jetzt werden wir sehen, <em>wie</em> dies gerendert wird. </p><br><p>  Wechseln Sie zur Registerkarte Profilerstellung.  Wir überprüfen, was Slow3g verlangsamt (dann ohne Einschränkungen erneut ausführen) und führen es aus.  Zunächst interessieren wir uns für alles, was vor dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">First Contentful Paint (FCP) -Ereignis</a> passiert, und für alle Fälle für DCL.  Wir wählen den Bereich vom Beginn des Ladens in FCP aus und sehen uns das endgültige Diagramm an. </p><br><p><img src="https://habrastorage.org/webt/1s/nb/qi/1snbqidqssgm4mxoulzysms7swu.png" alt="Gießen Sie die Milch ordentlich -"></p><br><p>  Alles geht ziemlich schnell - 2,161 Sekunden vor FCP (es war schneller, aber anscheinend hatte sich etwas geändert), aber wie Sie sehen können, war der Browser die meiste Zeit im Leerlauf.  Die Nutzlast dauerte nur 14% der Zeit (ca. 310 ms).  Im Idealfall wird der Hauptbrowser-Thread kontinuierlich ausgeführt. Beim Parsen von HTML, CSS und JS wird JS ausgeführt.  Und hier - nichts.  Warum?  Weil der Browser einfach nichts zu tun hatte.  Erinnerst du dich, dass wir den Verkehr reduziert haben?  Der Browser hat Anfragen gesendet und wartet nun nur darauf, dass diese abgeschlossen werden.  Wenn wir das Diagramm der Netzwerkprozesse (das oberste) öffnen, wird alles sofort klar. </p><br><p><img src="https://habrastorage.org/webt/uf/1-/gt/uf1-gt0kx7rkdpd9tzeod3hv99o.png" alt="Ein Punkt wird zu Einstellungen."><br>  <a href="">Klickbar</a> </p><br><p>  Im Jahr 2029 sah der Browser main.bundle.css, schickte eine Anfrage, um sie zu erhalten, und begann zu warten.  Zu diesem Zeitpunkt stellte der Prescanner (Smart Chrome, es kann vorauslaufen) fest, dass sich unten synchrone Skripte befinden, und ohne auf das Eintreffen von CSS zu warten, schickte er eine Anfrage nach Skripten.  Dann werben und adriver laden (aber wir erinnern uns, dass CSSOM nicht erstellt wird, Sie JS jedoch nicht berühren können), sodass der Browser sie ignorierte.  Danach wurden gpt und raven geladen, aber das CSS wurde noch geladen, sodass sie ebenfalls ignoriert wurden.  Schließlich wurde CSS geladen, das der Browser in 12 ms analysierte und sofort das in die Seite eingebettete JS analysierte.  Dann schlief der Browser nach fast 150 ms wieder ein und wartete auf jQuery.min.js.  Und danach habe ich bereits ernsthaft angefangen zu arbeiten - ich habe die geladene jQuery (20 ms) herausgefunden, raven.js (4 ms) analysiert, fast die gesamte Seite (36 ms) analysiert, die Stile (28 ms) nachgezählt, das Layout berechnet (78 ms + 8 ms) und Schließlich haben wir für ~ 6 ms die Seite gemalt.  Hier haben wir FCP.  Als nächstes analysieren wir die Seite, analysieren die Skripte - Hallo an niemanden (publishertag.js, gpt.js, der vor DCL in den Hauptthread gelangt ist), spielten ein wenig mit Stilen herum (was aufgrund der Neuberechnung des Layouts einen leichten Zeitverlust verursachte) und warteten auf Anbieter. bundle.js.  Um auf die Anbieter zu warten, haben wir fast 1100 ms im Leerlauf verbracht.  Parallel dazu haben wir auch main.bundle.js geladen (die übrigens schneller gebootet haben), also ist nicht alles so schlecht.  Dann ging alles wieder gut.  Wir haben die Anbieter analysiert, das Hauptpaket analysiert, Math.Jax analysiert und schließlich die Seite analysiert und DCL erhalten.  Zwar funktionierte genau dort eine Art Handler, der auf meinem I7 den Hauptthread bei 80 ms stoppte (d. H. Die Site schien bei 80 ms einzufrieren).  Jetzt haben wir das fast nicht bemerkt, aber auf einem schwachen Prozessor kann es theoretisch auffallen. Wenn Sie dies nach dem Rendern des Inhalts sehen, ist dies eine Gelegenheit, JS zu überprüfen. </p><br><p>  Was soll ich sagen  Wieder trotz der Tatsache, dass es ziemlich gut aussieht.  Die Hauptprobleme wurden uns geliefert: </p><br><ul><li>  Ein großer einfacher Browser (auch aufgrund des künstlichen Ungleichgewichts zwischen der Rechenleistung des Computers und der Kanalbreite, aber dies ist auch ein durchaus gültiges Szenario) </li><li>  Langes CSS-Laden, das die Arbeit mit kritischen js verzögerte </li><li>  Synchrones Laden von jQuery, Anbietern und Hauptpaketen, wodurch das Auftreten von Inhalten gestoppt wurde. </li></ul><br><p>  Was wir damit machen können, haben wir bereits besprochen: </p><br><ul><li>  Versuchen Sie, das Preload-Attribut für CSS und möglicherweise JS hinzuzufügen </li><li>  CSS reduzieren oder inline </li><li>  Versuchen Sie im Allgemeinen, Skripte aus dem synchronen Laden herauszuwerfen (zumindest einige). </li></ul><br><p>  Wiederholen wir nun dasselbe ohne Einschränkungen der Kanalbreite.  Das Bild ist schon viel besser: 0,452 Sekunden zu FMP, dem einfachsten von allen!  13 ms.  DCL - 953 ms, einfach 15 ms.  So sieht mein Traum-Download aus.  Genau das ist passiert, weil ich einen neuen Tab geöffnet und das Caching nicht entfernt habe.  Versuchen wir dasselbe, aber ohne Cache: </p><br><p><img src="https://habrastorage.org/webt/g5/ji/5q/g5ji5qscsjud50jdqkoazqoxsga.png" alt="Jetzt, wo es keinen Platz mehr gibt"></p><br><p>  Alles ist auch ganz gut, FCP / FMP - 1689, Nutzlast 45%.  Übrigens ist es auch schlecht, die Last auf 100% einzustellen, da schwächere Maschinen überlastet werden.  Es ist also besser, eine Reserve für Ausfallzeiten zu haben.  Aber hier wurde unerwartet viel Zeit für das Rendern aufgewendet - 400 ms für FMP.  Davon entfielen 200 ms auf die Neuberechnung von Stilen und die Neuberechnung des Layouts. </p><br><p>  Übrigens ein weiterer interessanter Punkt.  Erinnern Sie sich an die Anzeigenskripte - gpt.js und publishertag.js, die im ersten Teil erwähnt wurden?  Jetzt können Sie sehen, dass sie trotz ihrer Asynchronität (wenn auch ein wenig) unsere Statistiken ruinieren konnten.  Dies geschah, weil die Ausführung von asynchronen Skripten entsprechend der Bereitschaft der Skripte selbst erfolgt.  Das heißt,  Dies kann jederzeit geschehen, auch vor FCP / DCL, was 3309 geschah. </p><br><p>  Also haben wir die manuelle Demontage durchgeführt.  Es ist Zeit, die Automatisierung aufzudecken. </p><br><h2 id="etap-tretiy---s-etogo-nado-bylo-nachinat">  Stufe drei - „Wir mussten damit anfangen“ </h2><br><div class="spoiler">  <b class="spoiler_title">Über die Kollektivfarm</b> <div class="spoiler_text"><p>  Ich denke, jeder versteht, dass diese Studie sehr willkürlich ist.  Zumindest, weil die ganze Zeit, während ich neue Artikel testete, die Last auf dem Server und die Last auf den Netzwerk-Backbones geändert wurden.  Auf eine gute Weise müssen Sie einen dedizierten Server bereitstellen, auf dem niemand etwas schreibt, die relevante Last mit relevanten Verzögerungen emuliert und erst dann ein Profil erstellt.  Andernfalls können Sie einige Annahmen treffen (z. B. über die Notwendigkeit, ein Preload-Attribut in CSS hinzuzufügen), es hinzufügen, für die Produktion bereitstellen, und dann stellt sich heraus, dass die Last während des Tests stark gestiegen ist und der Server uns 500 ms später den gleichen Stil gegeben hat.  Und es stellt sich heraus, dass die Vorspannung schlecht ist - es hat alles nur noch schlimmer gemacht.  Und der Autor ist der letzte Rettich überhaupt.  Darüber hinaus macht die manuelle Profilerstellung (wie im zweiten Teil) wenig Sinn, bis Sie alle automatischen Werkzeuge entfernt und die dort gefundenen Probleme gelöst haben, da sich das Bild nach Ihren ersten Änderungen ändert. </p><br><p>  Daher benötigen wir vor allen Experimenten die stabilste Umgebung.  Diesmal.  Das zweite - Sie sollten niemals von Anfang an tief gehen (zum Beispiel in die Profilerstellung).  Starten Sie zuerst die automatischen Werkzeuge und lassen Sie sie für Sie arbeiten.  Sammeln Sie Berichte und sehen Sie, was in kürzester Zeit so gut wie möglich getan werden kann.  Versuche es zu tun.  Wenn möglich, haben Sie möglicherweise bereits genug.  Zum Beispiel wiegt Ihr css.bundle 100 KB, aber in Wirklichkeit benötigen Sie 45 KB (übrigens die reale Situation: Sie haben den gesamten Bootstrap genommen, aber nur das Raster wurde benötigt).  Sie reduzierten die Größe der Stile und gewannen praktisch umsonst eine halbe Sekunde.  Das sind zwei.  Immer überprüfen.  Es scheint, dass Stile inline sind, alles sollte besser werden, aber es wird schlechter.  Und warum?  Und weil in den Stilen von 50 KB Base64-Bildern und unserer Seite gerade 200 KB Ressourcen geladen wurden.  Denken Sie daran, dass es keine Silberkugel und universelle Skripte gibt.  Das sind drei.  Und das letzte, auch wenn es dem vorherigen Satz widerspricht.  Wenn Sie keine komplizierte Site haben, überwachen Sie einfach TTFB (Serverprobleme), die Größe der heruntergeladenen Ressourcen (Hallo zu den Logos für 2 MB) und gewähren Sie niemandem Zugriff auf Google Tag Manager.  Höchstwahrscheinlich wird dies völlig ausreichen. </p></div></div><br><p>  Wir werden nicht weit gehen. Öffnen Sie in denselben Entwicklertools die Registerkarte "Überwachung" und starten Sie LightHouse (LH) mit den folgenden Einstellungen: Desktop, nur Leistung, keine Drosselung, Speicherplatz löschen.  Nachdem wir ein wenig gewartet haben (verlassen Sie nicht die Seite, auf der das Audit durchgeführt wird, und machen Sie nichts besseres), erhalten wir fantastische Zahlen (auch wenn der Cache deaktiviert ist). </p><br><p><img src="https://habrastorage.org/webt/cg/cu/rc/cgcurczrbd7r4xhjqrtqgw-pj5s.png" alt="Auf dem Umhang meiner Mutter"></p><br><p>  Es scheint mir sogar, dass sie speziell auf diese Figuren zugeschnitten waren. </p><br><p>  LH beschwert sich jedoch immer noch über: </p><br><ul><li>  Veraltetes Bildformat (empfiehlt die Verwendung von webp, jpeg2000 usw.) </li><li>  DOM node –    : 2533,   1500. </li><li>    </li><li>     —     23  </li><li>  document.write </li></ul><br><p>   .     (), DOM —      node (-),      (  ),   document.write-  writer ( -    ) </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><p>    (       )   .    ,  ,  , .  ,   ,      .       CSS, —      ,   ,      JavaScript. ,        ,     .                       . </p></div></div><br><p>     ,       fast3g , ,      ( I7,  celeron): </p><br><p><img src="https://habrastorage.org/webt/td/ei/3j/tdei3jxtwbcvda5csqvvmgz2tua.png" alt="Der Umhang muss ganz verstaut sein"></p><br><p>      ( FCP   3500 ms, FMP 5.7): </p><br><ul><li>   ,   . LH    next-gen  ,  ,   ,     11   </li><li>      .       adriver.js  advertise.js  50 ,     . </li><li>    CSS    ,    5kb  45kb. </li><li>      main thread.           JavaScript — (8.5   script evaluation   2186 ms   raven.js).   ? </li></ul><br><p>     ?         .    -    .  : </p><br><ul><li>   </li><li>   DOM </li><li>   JavaScript   </li></ul><br><p>    ,        ,         (,  raven.js). </p><br><p>  ,      ,       — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">webpagetest.org</a> </p><br><p>    —   ,  ,  .        —     ,      .   ,    .   ,    ,   . ,       ,      ,   —  -. </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://habr.com</a> ( ru/en ). </p><br><p><img src="https://habrastorage.org/webt/qz/hb/gn/qzhbgnvpgll4xbdlvejmvfzpndm.png" alt="In einer Pfanne mit Milch."></p><br><p> ( ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> ) </p><br><p>    .     ( )    DNS (500 ms   ),     , ssl   .   ,    1150 ms    c      (    ). ,     (    habrastorage). </p><br><p>      main.bundle.css. ,     dr.habracdn.net ,     dns lookup — 36 ms (     400 ms).  SSL negotiation 606 ms,  TTFB 601 ms,   .    .       DCL — 4100 ms   ,   . </p><br><p>     image analysis , ,        .  -      PNG  1.4,   webp + downscaling ( ,   ) — 17.7 KB.  ,       ,     png  154.          . ,  : </p><br><ul><li>         (   ,        , ..    ). </li><li>   .   ,    . </li><li>  TTFB (webpagetest    F  ) —     </li><li>       ,       (         ) </li></ul><br><h2 id="vyvody">  Schlussfolgerungen </h2><br><p>      .     : </p><br><p>  : </p><br><ul><li>  TTFB   500 ms      ( <strong></strong> dns, ssl  initial connection) </li><li>  habrastorage </li></ul><br><p>  : </p><br><ul><li>    </li><li>   DOM-a </li><li>       </li></ul><br><p>  , ,      .      ,     ,    . ,   SPA,       ,    JS   —    .     .       //,           </p><br><h2 id="poleznye-ssylki">  Nützliche Links </h2><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">   </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Webpagetest</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  webpagetest</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">   1</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">   2</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> FCP</a> </li></ul><br><p>  PS.       (  )   .      ,    .1, .2, .3    . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de454444/">https://habr.com/ru/post/de454444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de454432/index.html">Unterhaltsame Archäologie: Der Style Guide R unter der Lupe</a></li>
<li><a href="../de454434/index.html">PDA (Pocket Travel Computer): Schaltkreis-GPS-Logger</a></li>
<li><a href="../de454436/index.html">Petty Petty Joy # 1: Loguru</a></li>
<li><a href="../de454440/index.html">Petty Little Fun # 2: Starlette</a></li>
<li><a href="../de454442/index.html">So wählen Sie ein Proxy-Netzwerk für Ihr Unternehmen aus: 3 praktische Tipps</a></li>
<li><a href="../de454446/index.html">Was ist neu in C # 8?</a></li>
<li><a href="../de454450/index.html">Wie Edison Wireless erfand und nichts verstand</a></li>
<li><a href="../de454452/index.html">Wir zeigen Inhalte auf dem erkannten Bild nach bestimmten Regeln an</a></li>
<li><a href="../de454456/index.html">Schulung Cisco 200-125 CCNA v3.0. Tag 7. FAQ</a></li>
<li><a href="../de454458/index.html">Metamorphe Tests: Warum weiß fast niemand etwas über diese vielversprechende Technik?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>