<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔍 💏 👩🏼‍💼 Und welchen Unterschied wählt Collation? 🔠 🤛🏽 💏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Artikel wurde für Studenten des Kurses "MS SQL Server Developer" erstellt. 
 Ich möchte eine Geschichte aus einem der vorherigen Projekte teile...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Und welchen Unterschied wählt Collation?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/461231/"><p>  Dieser Artikel wurde für Studenten des Kurses <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"MS SQL Server Developer" erstellt.</a> <br>  Ich möchte eine Geschichte aus einem der vorherigen Projekte teilen, die zeigt, dass Collation sehr sorgfältig ausgewählt werden muss.  Und was passiert, wenn dieser Parameter trotzdem falsch gewählt wird und welche Möglichkeiten zur Lösung des Problems bestehen. </p><br><p>  Zunächst eine kleine Einführung zu Collation.  In SQL Server teilt der Parameter Collation dem Server mit, wie Zeilen sortiert und verglichen werden sollen.  Zum Beispiel die Zeilen "Apple" und "Apple".  Sind sie anders oder nicht?  Dies hängt von der angegebenen Sortierung ab.  Wenn das Register immer weniger klar wird, was tun mit dem Beispiel „Weihnachtsbaum“ und „Weihnachtsbaum“?  Zählen Sie sie als gleich oder als verschieden?  Dies ist auch alles in Collation. </p><br><p>  Die Geschichte ereignete sich in einem Projekt, dessen Funktionalität DropBox oder Google Drive sehr ähnlich ist.  Es bietet die Möglichkeit, ihre synchronisierten Ordner und Dateien auf verschiedenen Computern zu verwalten sowie anderen Benutzern den Zugriff auf diesen synchronisierten Ordner zu ermöglichen. </p><br><p><img src="https://habrastorage.org/webt/zb/r_/ix/zbr_ixoq-dgwur4uwz_izd9myta.png" alt="Bild"></p><a name="habracut"></a><br><p>  Die Geschichte begann also mit der Tatsache, dass auf Prod-Servern 75-90% der Fehler in den Protokollen vorhanden waren (siehe Abbildung unten), und es ist nicht klar, woher sie kamen und was ihr Grund war.  Der Fehler war: "ReadWrtLst ist nicht vollständig".  Als nächstes kamen die Benutzerdetails und ihre Ordner. </p><br><p><img src="https://habrastorage.org/webt/i5/jz/lt/i5jzltkaco2jt9du8opn4ywi1du.png" alt="Bild"></p><br><p>  Der Code fand schnell einen Ort, der einen Fehler verursachte, aber wir konnten nicht verstehen, warum er auftrat und wie er reproduziert werden konnte. Es war nur klar, dass der Fehler irgendwie mit der Tatsache zusammenhängt, dass der Benutzer es irgendwie geschafft hat Erstellen Sie einen anderen Ordner mit demselben Namen in Ihrem Betriebssystem. </p><br><p>  Wir haben Informationen zu Benutzern gesammelt, für die dieser Fehler ausgegeben wird.  Und hier standen wir vor der ersten Überraschung: Von Millionen Benutzern des Systems hatten nur 50 diesen Fehler. Und diese 50 Benutzer generieren 90% der Fehlerprotokolle.  Da die Situation nicht reproduziert werden konnte, haben wir uns entschlossen, einen der Benutzer zu kontaktieren und herauszufinden, warum einer der Ordner nicht mit ihm synchronisiert wurde.  Der Ordner sah für uns genauso aus wie für die anderen. Der einzige Unterschied bestand darin, dass er in der Sprache des Benutzers mithilfe von Hieroglyphen aufgerufen wurde.  Und der Benutzer war Japaner.  Unter diesen 50 Nutzern waren übrigens die Japaner die Mehrheit. </p><br><p>  Dank eines Entwicklers des Teams konnten wir den Fehler reproduzieren.  Der Fehler bestand darin, dass das Betriebssystem die Ordnernamen als unterschiedlich betrachtete und SQL Server sie aufgrund der ausgewählten Sortierung als gleich betrachtete. </p><br><p>  Im Projekt verwendete Sortierung: <br>  SQL_Latin1_General_CP1_CI_AS </p><br><p>  Ein kleiner Exkurs zum Lesen von Collation.  (Wenn Sie damit vertraut sind, können Sie es gerne überspringen.) </p><br><p>  Die Sortierung besteht also aus mehreren Teilen: </p><br><ul><li>  SQL - Sortieroptionen nach SQL Server (SQL zu Beginn der Sortierung) oder Windows (dann wäre es nur Latin1_ ...); </li><li>  Latin1_General - Gebietsschema oder verwendete Sprache; </li><li>  CP1 - Codepage - Codepage; </li><li>  CI - Groß- und Kleinschreibung nicht berücksichtigen - Groß- und Kleinschreibung nicht berücksichtigen; </li><li>  AS - Accent Sensitive - unter Berücksichtigung von Axonen oder Diakritika, mit anderen Worten, wird 'a' nicht als gleich 'ấ' angesehen. </li></ul><br><p>  Diese Sortierung war einst die Standardkollatierung bei der Installation von SQL Server. </p><br><p>  Welche Möglichkeiten gibt es? </p><br><ul><li>  _KS - Unter Berücksichtigung der japanischen Zeichen von Hiragana und Katakana interpretiert SQL Server die Hieroglyphen von Hiragana und Katakana als gleich, wenn die Option nicht ausgewählt ist. </li><li> _WS - Wenn der Parameter unter Berücksichtigung der Zeichenbreite nicht ausgewählt ist, werden "Text" und "T ext" als dieselben Zeilen betrachtet. </li><li>  _VSS - unter Berücksichtigung der Anzeichen für die Wahl der Rechtschreiboption auf Japanisch, erschien ab Version 2017. </li><li>  _UTF8 - Ermöglicht das Speichern von Daten in UTF8. </li></ul><br><p>  Alle verwendeten Textfelder in der Datenbank geben NVARCHAR ein. <br>  Es stellt sich heraus, dass SQL Server Zeichenfolgen nicht auf die gleiche Weise wie das Betriebssystem verglich, da das aktuelle Sortieren den Unterschied in der Schreibweise japanischer Zeichen und den Unterschied in der Zeichenbreite ignorierte, was das Problem verursachte, d. H.  Der Benutzer konnte Ordner erstellen und diese nicht zur Synchronisierung zum System hinzufügen.  Das gleiche passiert später beim Vergleichen von Dateinamen. </p><br><p>  Wir begannen darüber nachzudenken, wie wir dieses Problem lösen und die Sortierung ändern können. </p><br><p>  Die Sortierung kann auf mehreren Ebenen eingestellt werden: </p><br><ul><li>  SQL Server-Instanz </li><li>  Datenbank </li><li>  Tabelle </li><li>  Das Feld </li></ul><br><p>  Gleichzeitig wird nicht empfohlen, unterschiedliche Sortierungen in der Datenbank zu haben, da Sie jedes Mal, wenn Sie Zeilen mit unterschiedlichen Sortierungen vergleichen, die Konvertierung mit COLLATE durchführen müssen, um dem Server anzugeben, welche Vergleichsreihenfolge verwendet werden soll. </p><br><p>  Welche Optionen gibt es in einer Situation, in der klar ist, dass die Sortierung nicht richtig ausgewählt ist? </p><br><ol><li>  Sortierung auf DB-Ebene ändern; </li><li>  Sortierung auf Feldebene ändern (in unserem Fall war es sinnlos, die gesamte Tabelle zu ändern); </li><li>  Fügen Sie das Varbinary-Feld hinzu, in das ein Duplikat aus dem Feld mit dem Namen des Ordners geschrieben werden soll, und verwenden Sie es zum Vergleich. </li><li>  Teilen Sie den Benutzern mit, dass die Unterstützung von Zeichen in Verzeichnisnamen eingeschränkt ist. </li></ol><br><p>  Die erste Option - Ändern der Sortierung auf Datenbankebene - ist die schwierigste.  Im Fall der Datenbank müsste die Datenbank neu erstellt und die Daten dort neu geladen werden.  Da das System rund um die Uhr funktionierte, wurde diese Option sofort abgelehnt. </p><br><p>  Die zweite Option zum Ändern des Felds: Die einfachste Option zum Implementieren besteht darin, ein Feld mit der gewünschten Sortierung hinzuzufügen und die Daten dorthin zu übertragen.  Dann muss jedoch der Code in der Datenbank geändert werden, der mit diesem Feld funktioniert, und die Datenbank enthält viel Code. </p><br><p>  Die dritte Option hat uns am besten gefallen, da sie theoretisch die geringsten Änderungen vorgenommen hat, da das Hauptfeld mit der aktuellen Sortierung weiterhin bestehen würde und wir keine Probleme mit ihrer Konvertierung hätten, während alle erforderlichen Funktionen in Form der Berücksichtigung des japanischen Alphabets oder der Breite vorhanden sind Zeichen würden funktionieren.  Der Nachteil war, dass Änderungen am Software-Teil vorgenommen werden mussten, aber da dieser Server-Teil möglich war, konnte dies durchgeführt werden. </p><br><p>  Die vierte Option war in diesem Fall die einfachste, da die Gesamtzahl der Benutzer mehrere Millionen betrug und nur 50 ein Problem hatten. Wenn die Anwendung jedoch in Japan aktiv verwendet würde, wäre diese Lösung von geringem Nutzen. </p><br><p>  Nachdem die Daten der Verwaltung vorgelegt wurden, wurde beschlossen, die Benutzer darüber zu informieren, dass die Software keine Anzahl von Zeichen unterstützt. Wenn sie im Namen synchronisierter Dateien und Ordner verwendet wird, funktioniert die Software möglicherweise nicht ordnungsgemäß.  Dies ist eine vorübergehende Lösung, da mit der weiteren Verteilung die Anzahl der Benutzer, die mit einem ähnlichen Problem konfrontiert sind, zunimmt und es erforderlich sein wird, mithilfe der ersten drei Optionen etwas zu ändern. </p><br><p>  Die beste Option für die Auswahl der Sortierung basiert auf Ihren Anwendungsanforderungen.  Wenn SQL Server Zeichenfolgen auf dieselbe Weise wie das Betriebssystem vergleichen soll, ist die Sortierung standardmäßig definitiv falsch.  Leider sind solche Nuancen zu Beginn eines Projekts beim Entwerfen eines Systems selten sichtbar, aber hoffentlich erinnern Sie sich nach dem Lesen des Artikels an die beschriebene Situation und treten nicht selbst auf einen solchen Rechen. </p><br><p>  Nützliche Sortierressourcen: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://docs.microsoft.com/en-us/sql/relational-databases/collations/collation-and-unicode-support?view=sql-server-2017</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://www.red-gate.com/simple-talk/sql/sql-development/questions-sql-server-collations-shy-ask/</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://www.virtual-dba.com/sql-server-collation/</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461231/">https://habr.com/ru/post/de461231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461219/index.html">Dell Latitude 7400 2-in-1: Ein schönes und leichtes Cabrio-Notebook für Unternehmen mit Metallgehäuse</a></li>
<li><a href="../de461223/index.html">IaaS Digest: Hochleistung, Datenspeicherung und neue Technologien für Rechenzentren</a></li>
<li><a href="../de461225/index.html">Wie man von der treibenden Basis von Barneo zum Nordpol kommt</a></li>
<li><a href="../de461227/index.html">Embarcadero RAD Studio 10.3.2 ist herausgekommen oder was tot ist ... gestorben</a></li>
<li><a href="../de461229/index.html">Helsinki Wie man einen Job in der finnischen Spielebranche findet, ohne Erlaubnis anfängt zu arbeiten und nicht gegen russische Gesetze verstößt</a></li>
<li><a href="../de461239/index.html">Flattern in den Beispielen. Deep Links in Flatteranwendungen</a></li>
<li><a href="../de461241/index.html">Wolfram Mathematica in Geophysik</a></li>
<li><a href="../de461243/index.html">Gehen Sie nicht nach Afrika spazieren: Wie ist die Situation mit der Internet-Zensur auf dem schwarzen Kontinent?</a></li>
<li><a href="../de461247/index.html">50 beste Quellen zum Produktmanagement zum Lesen, Hören und Anschauen</a></li>
<li><a href="../de461249/index.html">Schreiben einer Android App für Filmfans - Teil 2 (Design)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>