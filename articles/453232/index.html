<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∞üèº üêõ ü§üüèª Escribir mil millones de canciones con C # y Deep Learning üë®üèø‚Äçüî¨ ‚úåüèæ ü§ΩüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, explicar√© c√≥mo crear un sitio web ASP.NET Core , que use IA para generar letras de canciones √∫nicas con solo hacer clic en un bot√≥n,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escribir mil millones de canciones con C # y Deep Learning</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453232/">  En este art√≠culo, explicar√© c√≥mo crear un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">sitio web ASP.NET Core</a> , que use IA para generar letras de canciones √∫nicas con solo hacer clic en un bot√≥n, y permitir a los usuarios votar por las mejores canciones. <br><a name="habracut"></a><br><h1>  La red neuronal </h1><br>  Hace aproximadamente 2.5 meses, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">OpenAI</a> public√≥ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">una</a> publicaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">blog</a> , donde demostraron casi imposible: un modelo de aprendizaje profundo, que puede escribir art√≠culos, indistinguibles de los escritos por humanos.  El texto que gener√≥ fue tan impresionante que tuve que revisar el calendario para asegurarme de que no fuera una broma de los Inocentes (f√≠jate que era febrero y que Seattle estaba cubierta de nieve). <br><br><p><img src="https://habrastorage.org/webt/df/ok/nc/dfoknc5wbfxrkyvigyygtz9kctw.png" alt="Muestra de texto GPT-2"></p><br><p> No lanzaron la red neuronal m√°s grande con m√°s de mil millones de par√°metros que construyeron hasta el d√≠a de hoy (una decisi√≥n muy controvertida), pero obtuvieron una versi√≥n m√°s peque√±a de 117M de par√°metros <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">en GitHub</a> bajo licencia MIT.  El modelo tiene un nombre muy inmemorable: <b>GPT-2</b> . </p><br><p>  Entonces, hace aproximadamente un mes, cuando estaba tratando de pensar qu√© proyecto genial podr√≠a hacer con TensorFlow, esa red se convirti√≥ en el punto de partida.  Si ya pod√≠a generar texto en ingl√©s, no deber√≠a haber sido demasiado dif√≠cil <i>ajustarlo</i> para generar letras de canciones, si hay un conjunto de datos lo suficientemente grande. </p><br><h2>  ¬øC√≥mo funciona GPT-2? </h2><br><p>  Hay varios logros importantes en la investigaci√≥n de aprendizaje profundo, que hicieron posible GPT-2: </p><br><h3>  Aprendizaje auto supervisado </h3><br><p>  Yan LeCunn finaliz√≥ su nombre con esta t√©cnica solo unos d√≠as despu√©s de que escrib√≠ la primera versi√≥n de este art√≠culo.  Es una t√©cnica muy poderosa, que se puede aplicar b√°sicamente a cualquier tipo de datos del mundo real.  Para entrenar a GPT-2, OpenAI recolect√≥ <i>decenas de gigabytes de art√≠culos</i> de varias fuentes, que fueron votados en Reddit. </p><br><p>  Convencionalmente, uno tendr√≠a que tener un ser humano para revisar todos estos art√≠culos y, por ejemplo, marcarlos como "positivos" o "negativos".  Luego ense√±ar√≠an una red neuronal de manera supervisada para clasificar estos art√≠culos de la misma manera que lo hizo un humano. </p><br><p><img src="https://habrastorage.org/webt/cn/sl/_2/cnsl_21o1f-vio39rn5auufl_lw.jpeg" alt="RECAPTCHA: encuentra carteles callejeros"></p><br><p>  La nueva idea aqu√≠ es que para crear un modelo de aprendizaje profundo, que tenga una comprensi√≥n de alto nivel de sus datos, simplemente corrompe los datos y le encarga al modelo que restaure el original.  Esto hace que el modelo entienda las conexiones entre datos y sus contextos circundantes. </p><br><p>  Tomemos el texto como ejemplo.  GPT-2 toma una muestra del texto original, recoge el 15% de las fichas que se corromper√°n, luego enmascara el 80% de ellas (por ejemplo, las reemplaza con una ficha de m√°scara especial, generalmente ___), reemplaza el 10% con alguna otra ficha aleatoria del diccionario, y mantiene el 10% restante intacto.  Tome <i>, tir√© una pelota y cay√≥ al pasto</i> .  Despu√©s de la corrupci√≥n, podr√≠a verse as√≠: <i>tir√© la pelota del auto y ___ al c√©sped</i> .  En t√©rminos simples, para que la red restaure el original, debe aprender que es probable que algo arrojado caiga, y que la pelota del auto es algo muy poco com√∫n en el contexto. </p><br><p>  Un modelo entrenado as√≠ es bueno para generar / completar datos parciales, pero las caracter√≠sticas de alto nivel que aprendi√≥ (como salidas de capas internas) se pueden usar para otros fines agregando una capa o dos encima de ellas y ajustando <b>solo esa nueva √∫ltima capa</b> en un conjunto de datos real, <b>m√°s peque√±o</b> y marcado por humanos de una manera convencional. </p><br><h3>  Escasa autoatenci√≥n </h3><br><p>  GPT-2 usa algo llamado escasa auto-atenci√≥n.  En esencia, es una t√©cnica que permite que el procesamiento de la red neuronal de gran entrada se centre en algunas partes de ella m√°s que en otras.  Y la red aprende d√≥nde debe "mirar" durante el entrenamiento.  El mecanismo de atenci√≥n se explica mejor en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">esta publicaci√≥n de blog</a> . </p><br><p>  La parte <i>escasa</i> en el t√≠tulo de esta secci√≥n se refiere a una restricci√≥n sobre qu√© segmentos de entrada puede elegir el mecanismo de atenci√≥n.  La atenci√≥n inicial podr√≠a elegir entre toda la entrada.  Eso caus√≥ que su matriz de peso fuera O (input_size ^ 2), que crece muy r√°pidamente con el tama√±o de la entrada.  La escasa atenci√≥n generalmente restringe eso de alguna manera.  Para obtener m√°s informaci√≥n al respecto, eche un vistazo a otra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">publicaci√≥n de blog de OpenAI</a> . </p><br><p>  La atenci√≥n en GPT-2 es de <i>m√∫ltiples cabezas</i> .  Imagine que podr√≠a tener un ojo adicional o dos que podr√≠a usar para verificar lo que estaba en el √∫ltimo p√°rrafo sin dejar de leer el actual. </p><br><h3>  Muchos mas </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">Conexiones residuales</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">codificaci√≥n de pares de bytes</a> , predicci√≥n de la siguiente oraci√≥n y mucho m√°s. </p><br><h2>  Portar GPT-2 (y convertir Python en general) </h2><br><p>  El c√≥digo del modelo original est√° en Python, pero soy un chico de C #.  Afortunadamente, el c√≥digo fuente es bastante legible, y su <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">quid</a> est√° en solo 5 archivos, tal vez 500 l√≠neas en total.  As√≠ que cre√© un nuevo proyecto .NET Standard, instal√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">Gradient</a> (un enlace TensorFlow para .NET) y convert√≠ esos archivos l√≠nea por l√≠nea en C #.  Eso me llev√≥ unas 2 horas.  La √∫nica cosa pit√≥nica que quedaba en el c√≥digo era el uso del m√≥dulo Python regex de pip (el administrador de paquetes m√°s utilizado para Python), ya que no quer√≠a perder el tiempo aprendiendo las complejidades de las expresiones regulares de Python ( <i>como si no fuera suficiente para tratar con .NET ya</i> ). </p><br><p>  En su mayor√≠a, la conversi√≥n consisti√≥ en definir clases similares, agregar tipos y reescribir las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">comprensiones de la lista de</a> Python en las construcciones LINQ correspondientes.  Adem√°s de LINQ de la biblioteca est√°ndar, utilic√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">MoreLinq</a> , que ampl√≠a ligeramente lo que LINQ puede hacer. Por ejemplo: </p><br><p></p><pre><code class="python hljs">bs = list(range(ord(<span class="hljs-string"><span class="hljs-string">"!"</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"~"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)) + list(range(ord(<span class="hljs-string"><span class="hljs-string">"¬°"</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"¬¨"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)) + list(range(ord(<span class="hljs-string"><span class="hljs-string">""</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"√ø"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br><p>  convertido en: </p><br><p></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bs = Range(<span class="hljs-string"><span class="hljs-string">'!'</span></span>, <span class="hljs-string"><span class="hljs-string">'~'</span></span> - <span class="hljs-string"><span class="hljs-string">'!'</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>) .Concat(Range(<span class="hljs-string"><span class="hljs-string">'¬°'</span></span>, <span class="hljs-string"><span class="hljs-string">'¬¨'</span></span> -<span class="hljs-string"><span class="hljs-string">'¬°'</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>)) .Concat(Range(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'√ø'</span></span> - <span class="hljs-string"><span class="hljs-string">''</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>)) .ToList();</code> </pre> <br><p>  Otra cosa con la que tuve que luchar fue la discrepancia entre la forma en que Python maneja los rangos, y los nuevos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">rangos e √≠ndices aparecen</a> en el pr√≥ximo C # 8, que descubr√≠ al depurar mis ejecuciones iniciales: en C # 8 el final del rango es <b>inclusivo</b> , mientras que en Python es <b>exclusivo</b> (para incluir el √∫ltimo elemento en Python, debe omitir el lado derecho de <i>...</i> expresi√≥n). </p><br><blockquote>  Hay dos cosas dif√≠ciles en inform√°tica: invalidaci√≥n de cach√©, nombrar cosas y errores fuera de uno. </blockquote><br><p>  Desafortunadamente, la ca√≠da de la fuente original no conten√≠a ning√∫n entrenamiento o incluso c√≥digo de ajuste, pero <b>Neil Shepperd</b> proporcion√≥ un sintonizador simple en su <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">GitHub</a> , que tambi√©n tuve que portar.  De todos modos, el resultado de ese esfuerzo es un <b>c√≥digo C #</b> , que se puede usar <b>para jugar con GPT-2</b> , ahora forma parte del repositorio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">muestras de</a> degradado. </p><br><p>  El objetivo del ejercicio de transferencia es doble: despu√©s de la transferencia, uno puede <b>jugar con el c√≥digo del modelo en su ID de C # favorito</b> y mostrar que <b>ahora es posible lograr que los modelos de aprendizaje profundo de √∫ltima generaci√≥n funcionen de manera personalizada .NET proyecta</b> poco despu√©s del lanzamiento (entre la ca√≠da del c√≥digo de GPT-2 y el primer lanzamiento de Billion Songs, solo un poco m√°s de un mes). </p><br><h2>  Afinando la letra de la canci√≥n </h2><br><p>  Hay varias formas de obtener un gran corpus de letras de canciones.  Puede raspar uno de los sitios web de Internet que lo alojan con un analizador HTML, extraerlo de su colecci√≥n de karaoke o archivos mp3.  Afortunadamente, alguien lo hizo por nosotros.  Encontr√© bastantes conjuntos de datos de letras preparados en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">Kaggle</a> .  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">Cada canci√≥n que has escuchado</a> " parec√≠a ser la m√°s grande.  Intentando ajustar GPT-2 a √©l, me enfrent√© a dos problemas. </p><br><h3>  Lectura CSV </h3><br><p>  S√≠, lo ley√≥ correctamente, el <i>an√°lisis CSV fue un problema</i> .  Inicialmente, quer√≠a usar ML.NET, la nueva biblioteca de Microsoft para aprendizaje autom√°tico, para leer el archivo.  Sin embargo, despu√©s de hojear la documentaci√≥n y configurarla, me di cuenta de que no pudo procesar los saltos de l√≠nea en las canciones correctamente.  No importa lo que hice, luch√≥ despu√©s de unos cientos de ejemplos, y comenz√≥ a mezclar piezas de letras con t√≠tulos y artistas. </p><br><p>  As√≠ que tuve que recurrir a una biblioteca de nivel inferior, que anteriormente ten√≠a una mejor experiencia con: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">CsvHelper</a> .  Proporciona una interfaz tipo <i>DataReader</i> .  Puedes ver el c√≥digo us√°ndolo <a href="" rel="nofollow">aqu√≠</a> .  Esencialmente, abre un archivo, configura un <i>CsvReader</i> y luego intercala la llamada a <i>.Read ()</i> con la (s) llamada (s) a <i>.GetField (fieldName)</i> . </p><br><h3>  Canciones cortas </h3><br><p>  La mayor√≠a de las canciones son cortas en comparaci√≥n con un art√≠culo promedio en el conjunto de datos original utilizado por OpenAI.  El entrenamiento GPT-2 es m√°s eficiente en grandes fragmentos de texto, por lo que tuve que agrupar varias canciones en fragmentos de texto continuo para alimentarlas al entrenador.  OpenAI tambi√©n parec√≠a usar esta t√©cnica, por lo que ten√≠an un token especial <i>&lt;| endoftext |&gt;</i> , que act√∫a como un separador entre los textos completos dentro de un fragmento, y se dobla como el token de inicio.  Agrupe las canciones hasta que se alcanzara un cierto n√∫mero de tokens, luego devolv√≠ todo el fragmento para incluirlo en los datos de entrenamiento.  El c√≥digo relevante est√° <a href="" rel="nofollow">aqu√≠</a> . </p><br><h3>  Requisitos de hardware para el ajuste </h3><br><p>  Incluso la versi√≥n m√°s peque√±a de GPT-2 es grande.  Con <b>12 GB de RAM de GPU</b> <b>solo</b> pude <b>establecer el tama√±o del lote en 2</b> (por ejemplo, entrenar en dos trozos a la vez, los tama√±os de lote m√°s grandes mejoran el rendimiento de la GPU y los resultados del entrenamiento).  3 se perder√≠an <i>de memoria</i> en CUDA.  Y me llev√≥ medio d√≠a ajustarlo al rendimiento deseado en mi V100.  La ventaja es que puede ver el progreso, ya que de vez en cuando el c√≥digo de entrenamiento genera algunas muestras generadas, que comienzan como texto simple y simple, y se parecen cada vez m√°s a las letras de las canciones a medida que avanza el entrenamiento. </p><br><p>  No lo he probado, pero el <b>entrenamiento en CPU probablemente ser√° muy lento</b> . </p><br><h3>  Modelo preajustado </h3><br><p>  Mientras preparaba esta publicaci√≥n de blog, me di cuenta de que ser√≠a mejor no obligar a todos a pasar horas ajustando el <b>modelo de</b> <b>letra</b> , as√≠ que <b>publiqu√©</b> una <b>sintonizada previamente</b> en el <a href="" rel="nofollow">repositorio de Billion Songs</a> .  Si solo est√° intentando ejecutar Billion Songs, ni siquiera tiene que descargarlo manualmente.  El proyecto lo har√° por usted por defecto. </p><br><div class="spoiler">  <b class="spoiler_title">modelo medio entrenado jugando HAL9000 en m√≠</b> <div class="spoiler_text">  Te lo juro, se supone que debo escribirte <br>  Y te lo juro, lo juro <br>  Lo arruinaste ahora, espero que lo hagas <br>  Y espero tu sue√±o, espero que sue√±es, espero que sue√±es, espero que sue√±es, espero que sue√±es <br>  Acerca de <br>  a lo que voy  Me voy  Me voy  Me voy, me voy, me voy, me voy, me voy, me voy, me voy, <br>  Me voy, me voy, me voy ... </div></div><br><h1>  Hacer un sitio web </h1><br><p>  OK!  Parece una canci√≥n (m√°s o menos), ¬°ahora hagamos un sitio web! </p><br><p>  Como no planeo proporcionar ninguna API, elijo la plantilla de Razor Pages en lugar de MVC.  Tambi√©n activ√© la autorizaci√≥n, ya que permitiremos a los usuarios votar por las mejores letras y tener una lista de los 10 mejores. </p><br><p>  Apresurando el MVP, segu√≠ adelante y cre√© una p√°gina web Song.cshtml, cuyo objetivo por ahora ser√° simplemente llamar a GPT-2 y obtener una canci√≥n aleatoria.  El dise√±o de la p√°gina es trivial, y b√°sicamente consiste en la canci√≥n y su t√≠tulo: </p><br><pre> <code class="xml hljs">@page "/song/{id}" @model BillionSongs.Pages.SongModel<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @{ ViewData["Title"] = @Model.Song.Title ?? "Untitled"; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">article</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align: center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>@(Model.Song.Title ?? "Untitled")<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span>@Model.Song.Lyrics<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">article</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><p>  Ahora, porque me gusta que mi c√≥digo sea reutilizable, cre√© una interfaz que me permitir√° conectar diferentes generadores de letras m√°s adelante, que ASP.NET inyectar√° en SongModel. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ILyricsGenerator</span></span> { <span class="hljs-function"><span class="hljs-function">Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateLyrics</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> song, CancellationToken cancellation</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><p>  Omitiendo el t√≠tulo de la canci√≥n por ahora, todo lo que tenemos que hacer es registrar <i>Gpt2LyricsGenerator</i> en <i>Inicio. Configure los Servicios</i> y llame desde <i>SongModel</i> .  Entonces, comencemos con el generador.  Y lo primero que debemos asegurar es que tenemos </p><br><h2>  Generaci√≥n de letras repetibles </h2><br><p>  Debido a que hice una declaraci√≥n audaz en el t√≠tulo, que va a ser m√°s de mil millones de canciones, ni siquiera piense en generarlas y almacenarlas.  Primero, sin metadatos, eso tomar√≠a solo m√°s de 1TB de espacio en disco.  En segundo lugar, se tarda ~ 3 minutos en mi nettop para generar una nueva canci√≥n, por lo que tardar√° una eternidad en generarlas todas.  ¬°Y quiero poder convertir esos mil millones en un quintill√≥n cambiando a <i>Int64</i> si es necesario!  ¬øImagina que podr√≠amos hacer 1 centavo por canci√≥n, en un quintill√≥n de canciones?  ¬°Eso ser√≠a m√°s que el PIB anual actual mundial! </p><br><p>  En cambio, lo que debemos hacer es asegurarnos de que GPT-2 genere la misma canci√≥n una y otra vez, dada su <i>identificaci√≥n</i> , que especifico en la ruta.  Para ese prop√≥sito, TensorFlow brinda la capacidad de establecer la semilla de su generador de n√∫meros interno en cualquier momento a trav√©s de la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">tf.set_random_seed de</a> esta manera: <i>tf.set_random_seed (songNumber)</i> .  Entonces solo quer√≠a llamar a <i>Gpt2Sampler.SampleSequence</i> , para obtener el texto de la canci√≥n codificada, decodificarlo y devolver el resultado, completando as√≠ <i>Gpt2LyricsGenerator</i> . </p><br><p>  Desafortunadamente, en el primer intento eso no funcion√≥ como se esperaba.  Cada vez que presiono el bot√≥n Actualizar, se devuelve un nuevo texto √∫nico en la p√°gina.  Despu√©s de un poco de depuraci√≥n, finalmente descubr√≠ que TensorFlow 1.X tiene problemas importantes con la reproducibilidad: muchas operaciones tienen estados internos, que no se ven afectados por <i>set_random_seed</i> y son dif√≠ciles de alcanzar para restablecer. </p><br><p>  La reinicializaci√≥n de las variables del modelo ayud√≥ a compensar ese problema, pero tambi√©n signific√≥ que la sesi√≥n debe recrearse, y los pesos del modelo tuvieron que recargarse en cada llamada.  Volver a cargar una sesi√≥n de ese tama√±o provoc√≥ una p√©rdida de memoria gigante.  Para evitar buscar su causa en el c√≥digo fuente de TensorFlow C ++, en lugar de generar texto en el proceso, decid√≠ generar un nuevo proceso con <i>Process.Start</i> , generar texto all√≠ y leerlo desde la salida est√°ndar.  Hasta que se estabilice una forma de restablecer el estado del modelo en TensorFlow, este ser√≠a el camino a seguir. </p><br><p>  As√≠ que termin√© con dos clases: <a href="" rel="nofollow">Gpt2LyricsGenerator</a> , que implementa <i>ILyricsGenerator</i> desde arriba, generando una nueva instancia de BillionSongs.exe con par√°metros de l√≠nea de comando, que incluyen la identificaci√≥n de la canci√≥n, y eventualmente instancia <a href="" rel="nofollow">Gpt2TextGenerator</a> , que en realidad llama a GPT-2 para generar letras, y simplemente lo imprime. </p><br><p>  Ahora actualizar la p√°gina siempre me dio el mismo texto. </p><br><h2>  Tratar con 3 minutos de tiempo para generar una canci√≥n </h2><br><p>  ¬°Qu√© experiencia de usuario horrible ser√≠a!  Vaya a un sitio web, haga clic en "Crear nueva canci√≥n", y <b>no pasa absolutamente nada durante 3 (!) Minutos</b> mientras mi nettop se toma su tiempo para generar la letra de la canci√≥n que solicit√≥. </p><br><p>  Resolv√≠ este problema en m√∫ltiples niveles: </p><br><h3>  Canciones pregenerativas </h3><br><p>  Como se mencion√≥ anteriormente, no puede pregenerar todas las canciones y servirlas desde una base de datos.  Y no puede simplemente generar a pedido, porque eso es disminuir.  Entonces que puedes hacer? </p><br><p>  Simple!  Dado que la forma principal para que los usuarios vean una nueva canci√≥n es hacer clic en el bot√≥n "Hacer aleatorio", pregeneremos muchas canciones de antemano, col√≥quelas en una <i>ConcurrentQueue</i> y dejemos que "Hacer canciones aleatorias" aparezcan.  Si bien el n√∫mero de visitantes es bajo, el servidor tomar√° tiempo entre ellos para generar algunas canciones, que luego ser√°n f√°cilmente accesibles. </p><br><p>  Otro truco que utilic√© es hacer un bucle en esa cola varias veces, para que muchos usuarios pudieran ver la misma canci√≥n pregenerada.  Solo hay que mantener un equilibrio entre el uso de RAM y cu√°ntas veces un usuario tiene que hacer clic en "Hacer aleatorio" para ver algo que ha visto antes.  Simplemente eleg√≠ 50,000 canciones como un n√∫mero razonable, lo que tomar√≠a solo 50MB de RAM, mientras proporcionaba una gran cantidad de clics. </p><br><p>  Implement√© esa funcionalidad en la clase <a href="" rel="nofollow">PregeneratedSongProvider</a> : <i>IRandomSongProvider</i> (la interfaz se inyecta en el c√≥digo, responsable de manejar el bot√≥n "Hacer aleatorio"). </p><br><h3>  Almacenamiento en cach√© </h3><br><p>  Las canciones pregeneradas se almacenan en cach√© en la memoria, pero tambi√©n configuro el encabezado de <i>cach√©</i> HTTP en <i>p√∫blico</i> para permitir que el navegador, y CDN (uso CloudFlare) lo almacene en cach√© para evitar ser golpeado por la afluencia de usuarios. </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ResponseCache(VaryByHeader = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"User-Agent"</span></span></span><span class="hljs-meta">, Duration = 3*60*60)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SongModel</span></span>: <span class="hljs-title"><span class="hljs-title">PageModel</span></span> { ‚Ä¶ }</code> </pre><br><h3>  Volviendo canciones populares </h3><br><p>  La mayor√≠a de las canciones generadas por GPT-2 afinado de esa manera son bastante aburridas, si no rudimentarias.  Para hacer que los clics en "Hacer aleatorio" sean m√°s atractivos, agregu√© un 25% de probabilidad de que, en lugar de una canci√≥n completamente aleatoria, obtengas alguna canci√≥n que otros usuarios hayan votado previamente.  Adem√°s de aumentar el compromiso, aumenta la posibilidad de que solicite una canci√≥n, almacenada en cach√© en el CDN o en la memoria. </p><br><p>  Todos los trucos anteriores est√°n conectados entre s√≠ mediante la inyecci√≥n de dependencia ASP.NET en la clase de <a href="" rel="nofollow">inicio</a> . </p><br><h2>  Votar </h2><br><p>  No hay mucho especial sobre la implementaci√≥n de la votaci√≥n.  Hay <a href="" rel="nofollow">SongVoteCache</a> , que mantiene los recuentos actualizados.  Y un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">iframe que aloja los botones de voto</a> en la p√°gina de la canci√≥n, que permite almacenar en cach√© la parte esencial de la p√°gina: t√≠tulo y letra, mientras que el conteo de votos y el estado de inicio de sesi√≥n se cargan m√°s tarde. </p><br><h1>  Los resultados finales </h1><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/aw/c7/wf/awc7wfzablt9gotcrrv8nsihrvu.png" alt="Muestra de canci√≥n generada"></a> <br></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">Una versi√≥n de demostraci√≥n que se</a> ejecuta en <s>mi nettop, liderada por CloudFlare (darle un poco de holgura, su Core i3)</s> ahora congelada y movida al nivel gratuito de Azure App Service. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">El repositorio de GitHub</a> , que contiene el c√≥digo fuente, y las instrucciones para ejecutar el sitio web y ajustar el modelo. </p><br><h1>  Planes para el futuro / ejercicios </h1><br><h2>  Generar t√≠tulos </h2><br><p>  GPT-2 es muy f√°cil de ajustar.  Se podr√≠a hacer que genere t√≠tulos de canciones al anteponer o sufijar cada muestra de letra del conjunto de datos con un token artificial como <i>&lt;| startoftitle |&gt;</i> , seguido del t√≠tulo del mismo conjunto de datos. </p><br><p>  Alternativamente, los usuarios podr√≠an sugerir y / o votar por t√≠tulos. </p><br><h2>  Generar m√∫sica </h2><br><p>  A la mitad del desarrollo de Billion Songs, pens√© que ser√≠a genial descargar un mont√≥n de archivos MIDI (que es un formato de m√∫sica de la vieja escuela, que est√° mucho m√°s cerca del texto que los mp3), y entrenar GPT-2 en ellos para generar m√°s .  Algunos de esos archivos incluso ten√≠an texto incrustado, por lo <b>que podr√≠a obtener la generaci√≥n de karaoke</b> . </p><br><p>  S√© que la generaci√≥n de m√∫sica de esta manera es muy posible, porque ayer <b>OpenAI en realidad public√≥ una implementaci√≥n de esa idea</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">en su blog</a> .  Pero, ¬°hurra, <b>no hicieron el karaoke!</b>  Descubr√≠ que es posible raspar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">http://www.midi-karaoke.info</a> para ese prop√≥sito. </p><br><h2>  Gradiente, tambi√©n conocido como TensorFlow para .NET </h2><br>  Por favor, vea nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">blog</a> para cualquier actualizaci√≥n. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453232/">https://habr.com/ru/post/453232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453216/index.html">Sistemas de monitoreo de tr√°fico en redes VoIP. Segunda parte - Principios de organizaci√≥n</a></li>
<li><a href="../453218/index.html">Lo principal con YaC 2019: cien drones en las carreteras, Yandex.M√≥dulo, comida, casa inteligente</a></li>
<li><a href="../453220/index.html">13 errores de marketing por correo electr√≥nico a evitar para una mejor participaci√≥n</a></li>
<li><a href="../453222/index.html">SphinxSearch-meetup SuperJob</a></li>
<li><a href="../453228/index.html">Reloj Nixie en indicadores IN-18</a></li>
<li><a href="../453234/index.html">Ingenier√≠a inversa del protocolo de intercambio en equipos EOS</a></li>
<li><a href="../453236/index.html">Creaci√≥n de prototipos de un juego m√≥vil, d√≥nde comenzar y c√≥mo hacerlo. Parte 2</a></li>
<li><a href="../453238/index.html">Luces de marcha en rel√©</a></li>
<li><a href="../453242/index.html">Zona de juegos para eventos de verano.</a></li>
<li><a href="../453246/index.html">ERP - Sistema de degradaci√≥n continua</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>