<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛌🏽 🆗 ⚗️ 两年来，我们开发了监控系统。 点击以... ⚔️ 🧜 🤴🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好！ 


 我已经在此博客中谈到了微服务体系结构的模块化监视系统的组织以及从Graphite + Whisper到Graphite + ClickHouse的过渡，以在高负载下存储指标 。 之后，我的同事Sergey Noskov 写了关于我们的监控系统的第一个链接-由我们开发的Bioyino...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>两年来，我们开发了监控系统。 点击以...</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/467995/"><p> 大家好！ </p><br><p> 我已经在此博客中谈到了微服务体系结构<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的模块化监视系统</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">组织</a>以及<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">从Graphite + Whisper到Graphite + ClickHouse</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">过渡，以</a>在高负载下<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">存储指标</a> 。 之后，我的同事<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Sergey Noskov</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">写了</a>关于我们的监控系统的第一个链接-由我们开发的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Bioyino</a> ，这是一个分布式可扩展的指标聚合器。 </p><br><p> 现在该刷新有关我们如何在Avito中准备监视的信息了-我们的上一篇文章早在2018年，在此期间，监视体系结构，触发器和通知管理，ClickHouse中的各种数据优化以及其他创新都有一些有趣的变化，关于我只想告诉你的。 </p><br><p><img src="https://habrastorage.org/webt/wy/zd/u6/wyzdu6fyb-3ehjdbzwi8jgxhvec.png"></p><a name="habracut"></a><br><p> 但是，让我们从顺序开始。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">早在2017年，</a>我就展示了当时相关的组件交互图，我想再次进行演示，这样您就不必再次切换选项卡了。 </p><br><p> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/4e9/d52/d3e/4e9d52d3e19df15d928d29d2394095fa.jpg"></a> </p><br><p> 从那一刻起，发生了以下事情。 </p><br><ul><li><p> Graphite群集中的服务器数量已从3增加到6。 <br>  （ <code>56 CPU 2.60GHz, 384GB RAM, 10 SSD SAS 745GB, Raid 6, 10GBit/s Net</code> ）。 </p><br></li><li><p> 我们用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">bioyino</a>代替了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">brubeck-</a>我们自己的Rust实现<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">StatsD</a> ，甚至<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">撰写了</a>整篇<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文章</a> 。 但是，在文章发布之后，我们提出了对标记（Graphite）和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Raft的</a>支持以选择领导者。 </p><br></li><li><p> 我们确定了使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">生物抑制剂</a>作为StatsD代理的可能性，并将此类代理放置在整块实例附近以及k8中需要的位置。 </p><br></li><li><p> 我们终于摆脱了旧的Munin监视系统（以前我们仍然拥有它，但是不再使用其数据）。 </p><br></li><li><p> 由于新版本的Kubernetes不支持Heapster，因此通过Prometheus / Federations组织了来自Kubernetes集群的数据收集。 </p><br></li></ul><br><h1 id="monitoring"> 监控方式 </h1><br><p> 在过去的两年中，接受和处理的指标数量增长了约9倍。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/r2/yu/zm/r2yuzm1rt5ok64zh2utwrpdtzbk.png"></a> </p><br><p> 占用的服务器空间百分比也在无情地攀升，我们正在采取各种措施来降低它。 这在图表上清晰可见。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/s2/uj/ml/s2ujmlqnrsoo0yb0kgtxkdcf4ek.png"></a> </p><br><p> 我们到底在做什么？ </p><br><ul><li> 我们开始将复杂的压缩方法应用于数据列。 <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> graphite.data <span class="hljs-keyword"><span class="hljs-keyword">MODIFY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> UInt32 CODEC(Delta, ZSTD)</code> </pre> </li><li> 我们会继续将超过5周的数据从30秒间隔压缩到5分钟间隔。 为此，我们有一个cron任务，该任务每月（大约）启动一次以下过程： </li></ul><br><pre> <code class="bash hljs">10 10 10 * * clickhouse-client -q <span class="hljs-string"><span class="hljs-string">"select distinct partition from system.parts where active=1 and database='graphite' and table='data' and max_date between today()-55 AND today()-35;"</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> PART; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> clickhouse-client -u systemXXX --password XXXXXXX -q <span class="hljs-string"><span class="hljs-string">"OPTIMIZE TABLE graphite.data PARTITION ('"</span></span><span class="hljs-variable"><span class="hljs-variable">$PART</span></span><span class="hljs-string"><span class="hljs-string">"') FINAL"</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><ul><li> 我们共享了数据表。 现在，我们有了三个带有两个副本的碎片，每个副本都有一个代表度量的哈希碎片键。 这种方法为我们提供了执行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">汇总过程</a>的机会，因为特定指标的所有值都在同一个分片内，并且所有分片上的磁盘空间都被统一用完。 </li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">分布式表</a>架构如下。 </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> graphite.data_all ( <span class="hljs-string"><span class="hljs-string">`Path`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, <span class="hljs-string"><span class="hljs-string">`Value`</span></span> Float64, <span class="hljs-string"><span class="hljs-string">`Time`</span></span> UInt32, <span class="hljs-string"><span class="hljs-string">`Date`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, <span class="hljs-string"><span class="hljs-string">`Timestamp`</span></span> UInt32 ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Distributed</span></span> ( <span class="hljs-string"><span class="hljs-string">'graphite_cluster'</span></span>, <span class="hljs-string"><span class="hljs-string">'graphite'</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span>, jumpConsistentHash(cityHash64(<span class="hljs-keyword"><span class="hljs-keyword">Path</span></span>), <span class="hljs-number"><span class="hljs-number">3</span></span>) )</code> </pre> <br><p> 我们还为用户分配了“默认”只读权限，并将对表的写入过程的执行权交给了单独的用户<code>systemXXX</code> 。 </p><br><p>  ClickHouse中的Graphite群集的配置如下。 </p><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote_servers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">graphite_cluster</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">internal_replication</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">internal_replication</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>graphite-clickhouse01<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>9000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>systemXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span>XXXXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>graphite-clickhouse04<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>9000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>systemXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span>XXXXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">internal_replication</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">internal_replication</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>graphite-clickhouse02<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>9000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>systemXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span>XXXXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>graphite-clickhouse05<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>9000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>systemXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span>XXXXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">internal_replication</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">internal_replication</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>graphite-clickhouse03<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>9000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>systemXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span>XXXXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>graphite-clickhouse06<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>9000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>systemXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span>XXXXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">replica</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">shard</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">graphite_cluster</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remote_servers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> 除了写入负载之外，从Graphite读取数据的请求数量也增加了。 该数据用于： </p><br><ul><li> 触发处理并生成警报； </li><li> 在越来越多的公司员工的办公室，笔记本电脑和PC屏幕上的显示器上显示图形。 </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/ch/rb/wh/chrbwhdiyl3x3cxjqmwgtohph6y.png"></a> </p><br><p> 为了防止监视程序在此负载下淹没，我们使用了另一种方法：将最近两天的数据存储在单独的“小”盘中，然后将过去两天的所有读取请求发送到那里，以减少主分片表的负载。 同样对于这种“小型”平板电脑，我们使用了反向度量存储方案，该方案极大地加快了对其中包含的数据的搜索，并为它组织了每日分区。 该板的方案如下。 </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> graphite.data_reverse ( <span class="hljs-string"><span class="hljs-string">`Path`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, <span class="hljs-string"><span class="hljs-string">`Value`</span></span> Float64, <span class="hljs-string"><span class="hljs-string">`Time`</span></span> UInt32 CODEC(Delta(<span class="hljs-number"><span class="hljs-number">4</span></span>), ZSTD(<span class="hljs-number"><span class="hljs-number">1</span></span>)), <span class="hljs-string"><span class="hljs-string">`Date`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, <span class="hljs-string"><span class="hljs-string">`Timestamp`</span></span> UInt32 ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = ReplicatedGraphiteMergeTree ( <span class="hljs-string"><span class="hljs-string">'/clickhouse/tables/{cluster}/data_reverse'</span></span>, <span class="hljs-string"><span class="hljs-string">'{replica}'</span></span>, <span class="hljs-string"><span class="hljs-string">'graphite_rollup'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Path</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SETTINGS</span></span> index_granularity = <span class="hljs-number"><span class="hljs-number">4096</span></span></code> </pre> <br><p> 为了向其中定向数据，我们在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">carbon-clickhouse</a>应用程序配置文件中添加了一个新部分。 </p><br><pre> <code class="plaintext hljs">[upload.graphite_reverse] type = "points-reverse" table = "graphite.data_reverse" threads = 2 url = "http://systemXXX:XXXXXXX@localhost:8123/" timeout = "60s" cache-ttl = "6h0m0s" zero-timestamp = true</code> </pre> <br><p> 为了删除超过两天的分区，我们编写了一个cron任务。 看起来像这样。 </p><br><pre> <code class="bash hljs">1 12 * * * clickhouse-client -q <span class="hljs-string"><span class="hljs-string">"select distinct partition from system.parts where active=1 and database='graphite' and table='data_reverse' and max_date&lt;today()-2;"</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> PART; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> clickhouse-client -u systemXXX --password XXXXXXX -q <span class="hljs-string"><span class="hljs-string">"ALTER TABLE graphite.data_reverse DROP PARTITION ('"</span></span><span class="hljs-variable"><span class="hljs-variable">$PART</span></span><span class="hljs-string"><span class="hljs-string">"')"</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p> 为了从表中读取数据，在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">graphite-clickhouse</a>配置文件中添加了一个部分： </p><br><pre> <code class="plaintext hljs">[[data-table]] table = "graphite.data_reverse" max-age = "48h" reverse = true</code> </pre> <br><p> 结果，我们有了一个表，其中100％的数据已复制到所有六台服务器，这些服务器在不到两天的时间内处理了来自请求的全部读取负载（其中有95％）。 另外，我们还有一个分片表，其中每个分片上的数据为1/3，可读取所有历史数据。 即使这样的请求很小，来自它们的负载也要高得多。 </p><br><p>  CPU发生了什么？ 由于Graphite群集中已记录和读取的数据量增加，服务器上的总CPU负载也增加了。 看起来像这样。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_u/mg/m3/_umgm3dd9lgetkopu45jjrqqodw.png"></a> </p><br><p> 我想提请注意以下细微差别：一半的CPU用于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Carbon-c-relay</a> （2018-09-05版本v3.2，负责传输度量标准）中的度量标准的解析和主处理，它位于六台服务器中的三台中。 从图中可以看出，这三个服务器位于TOP中。 </p><br><h1 id="alerting"> 警报 </h1><br><p> 作为警报系统，我们仍然有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Moira</a>和为其编写的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">moira-client</a> 。 为了灵活地管理触发器，通知和升级，我们使用了一个称为alert.yaml的声明性描述。 它是通过PaaS创建服务时自动生成的（有关更多信息，请参见Vadim Madison的文章<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“我们对微服务的了解”</a> ），并将其放置在其存储库中。 为了使用alert.yaml，我们在moira-client上进行了绑定，并将其命名为alert-autoconf（我们计划开放）。 在TeamCity中组装服务有一个步骤，即通过alert-autoconf将触发器和通知导出到Moira。 将更改提交到alert.yaml时，将运行自动测试，以检查yaml文件的有效性，并针对每个度量标准模板向Graphite发出请求，以验证其正确性。 </p><br><p> 对于不使用PaaS的基础架构团队，我们组织了一个单独的存储库，称为“警报”。 它的格式如下：Team / Project / alert.yaml。 对于每个alert.yaml，我们在TeamCity中生成一个单独的程序集，该程序集运行测试并在Moira中推送alert.yaml的内容。 </p><br><p> 因此，我们所有的员工都可以使用一种方法来管理触发器，通知和升级。 </p><br><p> 由于在通过GUI触发触发器之前，我们实现了以yaml格式上传触发器的功能。 可以将接收到的yaml文档的内容插入到alert.yaml中，而无需进行任何其他转换，然后将更改推送到向导中。 在构建期间，alert-autoconf将了解这样的触发器已经存在，并将其注册到我们在Redis中的注册表中。 </p><br><p> 不久前，我们全天候24x7轮班工作。 为了将触发器转移给他们以进行维修，请在alert.yaml中足够正确地填写“看到后该怎么办”的说明，将标签[24x7]放置到向导中。 滚动alert.yaml后，其中描述的所有触发器将自动置于24x7的24小时轮班监控之下。  U-简化！ 美女！ </p><br><h1 id="sbor-biznes-metrik"> 业务指标收集 </h1><br><p> 自上<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一篇</a>有关收集和处理业务指标的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文章</a>以来，我们的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">bioyino</a>变得更好。 </p><br><ol><li> 而不是通过<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">领事</a>来选择领导者，而是使用内置的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Raft</a> 。 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">标签以Graphite格式</a>正确处理。 </li><li> 现在您可以将<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">bioyino</a> （StatsD服务器）用作代理。 </li><li> 为了计算唯一值，支持“设置”格式。 </li><li> 指标的最终汇总可以在多个线程中完成。 </li><li> 数据可以通过多个并行连接发送到Graphite块。 </li><li> 修复了发现的所有错误。 </li></ol><br><p> 现在它像这样工作。 </p><br><p> 我们开始在所有大型度量生成器旁边积极引入StatsD代理：在具有整体实例的容器中，在服务旁边的k8s pod中，在具有基础结构组件的主机上等。 <br>  Statsd代理位于应用程序旁边。 它通过UDP使用此应用程序中的度量标准，但不再使用网络子系统（由于Linux内核中的优化）。 所有事件都是预先汇总的，并且每秒收集的数据（可以配置时间间隔）以Cap'n Proto格式发送到StatsD服务器的主要群集（bioyino0 [1-3]）。 </p><br><p> 度量标准的进一步处理和聚合，StatsD群集中领导者的选择以及领导者向Graphite发送度量标准都没有改变。 您可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在上一篇文章</a>中详细了解此<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">内容</a> 。 </p><br><p> 至于数字，它们如下。 </p><br><p>  <em>收到的StatsD事件图</em> <br> <a href=""><img src="https://habrastorage.org/webt/m2/td/56/m2td56sycgexhmsupyp7nfmp2hw.png"></a> <br><img src="https://habrastorage.org/webt/np/5m/hi/np5mhi_4z6pfwpdpbvzfamn7fws.png"></p><br><p>  <em>从StatsD发送到Graphite的指标图</em> <br> <a href=""><img src="https://habrastorage.org/webt/m2/td/56/m2td56sycgexhmsupyp7nfmp2hw.png"></a> </p><br><h1 id="itogo"> 合计 </h1><br><p> 目前，监视组件之间交互的一般方案如下所示。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/n6/ym/-b/n6ym-bcuyt3a3ctoda93lassduo.png"></a> </p><br><p> 指标总数：2 189 484 898 474。 <br> 指标的总存储深度：3年。 <br> 唯一度量标准名称的数目：6 585 413 171。 <br> 触发器数量：1053，它们的作用范围是1到15,000。 </p><br><p>  <strong>近期计划：</strong> </p><br><ul><li> 开始将产品服务移至标记的度量标准存储方案； </li><li> 向Graphite集群添加三台服务器； </li><li> 用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">持久的组织</a>结交Moira朋友; </li><li> 在监视团队中<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">查找</a>其他开发人员。 </li></ul><br><p> 我将很乐意在这里发表评论和提出问题-写。 我还将<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在11月7</a>日<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用Highload ++</a>进行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">表演</a> ，如果您在那里，我们可以谈谈。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN467995/">https://habr.com/ru/post/zh-CN467995/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN467979/index.html">广告整合：如何运作？</a></li>
<li><a href="../zh-CN467981/index.html">思科UCS C240 M5机架服务器装箱</a></li>
<li><a href="../zh-CN467987/index.html">生动活泼的果冻：无需CPU即可进行材料级决策</a></li>
<li><a href="../zh-CN467989/index.html">如何设计汽车悬架控制单元</a></li>
<li><a href="../zh-CN467991/index.html">鉴于生活成本，开发商与莫斯科的地区工资有多少不同</a></li>
<li><a href="../zh-CN467997/index.html">软件架构被高估，简单设计被低估</a></li>
<li><a href="../zh-CN467999/index.html">对于VNA或日文中文设备的问题</a></li>
<li><a href="../zh-CN468001/index.html">您不认为：程序确实变得更加昂贵了</a></li>
<li><a href="../zh-CN468003/index.html">5 GHz铁：关于如何构建超快VDS的故事</a></li>
<li><a href="../zh-CN468005/index.html">谈一谈光荣的支持（9月24日，莫斯科）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>