<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèí üêØ üìÖ Consist√™ncia de dados em sistemas muito carregados ü¶Ñ ‚õé üë≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Edi√ß√£o 
 Quase qualquer sistema de informa√ß√£o requer armazenamento de dados continuamente. Na maioria dos sistemas com carga pequena e m√©dia, essa fun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Consist√™ncia de dados em sistemas muito carregados</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431854/"><h2>  Edi√ß√£o </h2><br>  Quase qualquer sistema de informa√ß√£o requer armazenamento de dados continuamente.  Na maioria dos sistemas com carga pequena e m√©dia, essa fun√ß√£o √© executada por DBMSs relacionais, cuja vantagem indiscut√≠vel √© a garantia da consist√™ncia dos dados. <br><br>  Um exemplo cl√°ssico que explica o que √© a consist√™ncia dos dados - a opera√ß√£o de transfer√™ncia de fundos de uma conta para outra.  No momento em que a opera√ß√£o de altera√ß√£o do saldo de uma conta j√° foi conclu√≠da e a outra ainda n√£o teve tempo, pode ocorrer uma falha.  Os fundos ser√£o debitados de uma conta, mas n√£o ser√£o creditados em outra.  Esse estado dos dados do sistema √© chamado de inconsistente e, talvez, n√£o seja necess√°rio explicar a quais consequ√™ncias isso pode levar.  Os DBMSs relacionais fornecem um mecanismo de transa√ß√£o que garante a consist√™ncia dos dados a qualquer momento.  Uma transa√ß√£o √© um conjunto finito de opera√ß√µes que transfere um estado consistente para outro estado consistente. <a name="habracut"></a>  No caso de um erro em qualquer etapa, o DBMS cancela todas as opera√ß√µes executadas anteriormente e retorna os dados ao seu estado original acordado.  Em outras palavras, todas as opera√ß√µes ser√£o executadas ou nenhuma. <br><br>  Quanto aos sistemas de grande escala, nem sempre √© poss√≠vel usar um √∫nico banco de dados, devido a uma carga muito pesada.  Nesses casos, cada m√≥dulo do sistema (servi√ßo) √© fornecido com seu pr√≥prio banco de dados separado.  Nesse caso, surge a quest√£o de como garantir a consist√™ncia dos dados para essa arquitetura de cluster. <br><br><h2>  Solu√ß√£o de consist√™ncia de dados </h2><br>  Uma solu√ß√£o s√£o transa√ß√µes distribu√≠das.  Primeiro, todos os n√≥s do cluster devem concordar que a opera√ß√£o √© poss√≠vel; as altera√ß√µes s√£o confirmadas em todos os n√≥s.  Como os n√≥s n√£o t√™m dispositivo de armazenamento comum, a √∫nica maneira de obter uma opini√£o comum √© concordar em usar algum protocolo de consenso distribu√≠do. <br><br>  Um protocolo simples para capturar transa√ß√µes globais √© o commit de duas fases (2PC).  O n√≥ que executa a transa√ß√£o √© considerado o coordenador.  Na fase de prepara√ß√£o (prepara√ß√£o), o coordenador informa os outros n√≥s sobre a confirma√ß√£o da transa√ß√£o e aguarda a confirma√ß√£o deles de que eles est√£o prontos para confirmar.  Se pelo menos um n√≥ n√£o estiver pronto, a transa√ß√£o ser√° interrompida.  Na fase de confirma√ß√£o, o coordenador informa todos os n√≥s da decis√£o de confirmar a transa√ß√£o.  Ap√≥s o recebimento da confirma√ß√£o de todos de que tudo est√° correto, o coordenador tamb√©m captura a transa√ß√£o. <br><br><img src="https://access.redhat.com/webassets/avalon/d/JBoss_Enterprise_Application_Platform-5-Transactions_Development_Guide-en-US/images/721547b5fb5ee9da94ec3200cb1231fe/fig-two-phase-commit-overview.png" alt="imagem"><br><br><h4>  Figura 1 - Esquema geral de um commit de duas fases </h4><br>  Este protocolo evita um m√≠nimo de mensagens, mas n√£o √© robusto.  Por exemplo, se o coordenador falhar ap√≥s a fase de prepara√ß√£o, os n√≥s restantes n√£o ter√£o informa√ß√µes sobre se a transa√ß√£o deve ser confirmada ou cancelada (eles ter√£o que aguardar a corre√ß√£o da falha).  Outra desvantagem s√©ria do 2PC (e de outros protocolos de transa√ß√£o distribu√≠da, por exemplo 3PC) √© que, √† medida que o n√∫mero de n√≥s do cluster aumenta, o desempenho das confirma√ß√µes de duas fases diminui. <br><br><img src="http://www.techort.com/wp-content/uploads/2018/10/1539271021_859_data-integrity-in-microservice-architecture-how-to-ensure-it-without-distributed-transactions-and-tight-connectivity-avito-habr-blog.png" alt="imagem"><br><br><h4>  Figura 2 - Depend√™ncia da velocidade de uma confirma√ß√£o de duas bases no n√∫mero de servidores em um cluster DBMS </h4><br>  Al√©m disso, a abordagem de transa√ß√£o distribu√≠da imp√µe uma limita√ß√£o: todos os m√≥dulos do sistema devem usar o mesmo DBMS, o que nem sempre √© conveniente. <br><br>  Outra op√ß√£o √© fornecer um mecanismo que permita trabalhar com diferentes bancos de dados (para servi√ßos) como um √∫nico banco de dados (para resolver o problema com a integridade dos dados em um banco de dados distribu√≠do).  Ao mesmo tempo, √© necess√°rio um certo an√°logo de uma transa√ß√£o para um sistema distribu√≠do ("transa√ß√£o comercial"). <br><br>  Em transa√ß√µes comuns, bem como em confirma√ß√µes de duas fases, todas as opera√ß√µes s√£o controladas pelo mecanismo de transa√ß√£o (usando bloqueios), e isso √© feito para fornecer a capacidade de reverter qualquer opera√ß√£o (abordagem pessimista - consideramos que qualquer opera√ß√£o pode estar causando uma falha).  Esse √© o gargalo do sistema.  Uma alternativa √© a chamada abordagem otimista: acreditamos que a maioria das opera√ß√µes √© conclu√≠da com sucesso.  Tamb√©m realizamos a√ß√µes adicionais devido ao fato de uma falha.  I.e.  reduzindo custos para a maioria das opera√ß√µes, o que leva ao aumento da produtividade. <br><br><h2>  O que √© uma Saga e como funciona </h2><br>  Uma alternativa para transa√ß√µes para arquitetura de microsservi√ßo √© o Saga.  Saga (saga) √© um conjunto de etapas executadas por v√°rios m√≥dulos do sistema (servi√ßos);  o servi√ßo saga tamb√©m √© necess√°rio, respons√°vel pela opera√ß√£o (transa√ß√£o comercial) como um todo.  As etapas s√£o vinculadas por meio de um gr√°fico de eventos.  Ap√≥s a conclus√£o da saga, o sistema deve passar de um estado acordado para outro (em caso de execu√ß√£o bem-sucedida) ou retornar ao estado acordado anterior (em caso de cancelamento). <br><br>  Como implementar tal retorno ou revers√£o de uma transa√ß√£o comercial?  Para isso, a saga utiliza o mecanismo de cancelamento de etapas (a√ß√µes compensat√≥rias).  Por exemplo, uma das etapas foi bem-sucedida (por exemplo, uma entrada foi adicionada √† tabela do banco de dados do usu√°rio), mas uma das etapas a seguir falhou e a saga inteira deve ser cancelada.  Em seguida, o mesmo servi√ßo recebe um comando - cancele a a√ß√£o.  Mas no DBMS de servi√ßo, a transa√ß√£o local j√° foi conclu√≠da, o registro do usu√°rio foi adicionado.  Em seguida, para retornar ao estado anterior, o servi√ßo deve executar uma a√ß√£o de compensa√ß√£o (em nosso exemplo, exclua o registro).  O cancelamento de etapas permite que a atomicidade (‚Äútudo ou nada‚Äù) seja implementada no √¢mbito da saga - todas as etapas s√£o executadas ou compensadas. <br><br><img src="https://cdn-images-1.medium.com/max/1200/1*IUfYVaCXhQHWqM13_6sLhQ.png" alt="imagem"><br><br><h4>  Figura 3 - O mecanismo de trabalho de Saga e a natureza do efeito compensat√≥rio </h4><br>  Na Figura 3, as etapas da saga s√£o designadas como T1 ... T4, a√ß√µes compensat√≥rias: C1 ... C4. <br>  As sagas suportam a idempot√™ncia de etapas (uma a√ß√£o cuja repeti√ß√£o repetida √© equivalente a uma √∫nica).  A abordagem sag fornece a oportunidade de repetir qualquer etapa (por exemplo, se voc√™ n√£o recebeu uma resposta ap√≥s a conclus√£o bem-sucedida).  A idempot√™ncia tamb√©m permite restaurar o estado quando os dados s√£o perdidos em qualquer n√≥ (falha e recupera√ß√£o).  Ao executar uma etapa, cada servi√ßo deve determinar (pela chave de idempot√™ncia) se j√° executou essa etapa ou n√£o (se n√£o, executar, caso contr√°rio, pule).  Para a√ß√µes de compensa√ß√£o, tamb√©m √© poss√≠vel adicionar chaves de idempot√™ncia e repeti√ß√µes de opera√ß√µes (garantindo persist√™ncia / estabilidade). <br><br><h2>  Sum√°rio </h2><br>  Dos quatro requisitos para o sistema de transa√ß√µes ACID (atomicidade, consist√™ncia, isolamento, estabilidade), o mecanismo sag permite que tr√™s sejam implementados - todos, exceto o isolamento.  A falta de isolamento pode levar a anomalias (‚Äúleituras sujas‚Äù, ‚Äúleituras n√£o repet√≠veis‚Äù, reescrita de altera√ß√µes entre diferentes transa√ß√µes comerciais, etc.).  Para superar essas situa√ß√µes, √© necess√°rio o uso de mecanismos adicionais, por exemplo, controle de vers√£o de objetos mut√°veis. <br><br>  Sagas permitem resolver as seguintes tarefas: <br><br><ul><li>  Fornecer altera√ß√µes de dados dependentes para dados cr√≠ticos de neg√≥cios; </li><li>  Ser capaz de definir uma ordem estrita de etapas; </li><li>  Cumprir 100% de consist√™ncia (coordenar dados mesmo em caso de acidente); </li><li>  Forne√ßa verifica√ß√µes de desempenho em todos os n√≠veis. </li></ul><br><h2>  Exemplos de escopo e aplica√ß√£o </h2><br>  Sagas s√£o freq√ºentemente usados ‚Äã‚Äãem sistemas com um grande n√∫mero de solicita√ß√µes.  Por exemplo, servi√ßos de email populares, redes sociais.  No entanto, a abordagem pode ser aplicada em projetos de menor escala. <br><br>  Nossa empresa tem experi√™ncia no desenvolvimento de um sistema de contabilidade para uma grande empresa que foi projetada para v√°rias dezenas de usu√°rios e todos os dados foram armazenados em um DBMS relacional.  O problema surgiu ao implementar o c√°lculo autom√°tico do trabalho planejado: em alguns casos, os c√°lculos eram muito grandes e exigiam a inser√ß√£o de milh√µes de registros nas tabelas do DBMS, que carregavam significativamente o DBMS e retardavam a opera√ß√£o de todo o sistema. <br><br>  Foi encontrada uma solu√ß√£o - colocar a l√≥gica de c√°lculo do trabalho em um servi√ßo separado com seu pr√≥prio DBMS para armazenar o trabalho em si e objetos relacionados.  A consist√™ncia dos dados foi assegurada pela saga.  Se o c√°lculo falhar, o m√≥dulo principal do aplicativo receber√° um comando para cancelar a opera√ß√£o de c√°lculo l√≥gico. <br><br><h2>  Bibliotecas ativadas pelo Saga </h2><br>  O aplicativo foi desenvolvido em .Net e, para essa tecnologia, existem v√°rias bibliotecas do gerenciador de servi√ßos com suporte para sagas.  Analisamos as bibliotecas NServiceBus, MassTransit e Rebus.  Como resultado, decidimos pelo Rebus - essa biblioteca √© mais f√°cil de aprender, ao mesmo tempo em que realiza o princ√≠pio das sagas e √© livre para usar.  NServiceBus e MassTransit s√£o ferramentas mais sofisticadas com toneladas de recursos adicionais.  Eles n√£o foram necess√°rios como parte de nossa tarefa, mas pode ser aconselh√°vel us√°-los em projetos futuros com l√≥gica mais complexa. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt431854/">https://habr.com/ru/post/pt431854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt431844/index.html">Swift Heroes 2018. Como foi</a></li>
<li><a href="../pt431846/index.html">GeekBrains come√ßa a preparar desenvolvedores de Python full-stack</a></li>
<li><a href="../pt431848/index.html">Como eu escrevi o maior roteiro para o Altium Designer</a></li>
<li><a href="../pt431850/index.html">Heisenbug 2018 Moscou: transmiss√£o online gratuita, festa e muito mais</a></li>
<li><a href="../pt431852/index.html">Hackear 50.000 impressoras de rede e imprimir texto arbitr√°rio? Nada √© mais f√°cil«É</a></li>
<li><a href="../pt431856/index.html">Estendendo o Unity Editor com a Janela do Editor, Objeto Script√°vel e Editor Personalizado</a></li>
<li><a href="../pt431858/index.html">Mitap Sbertekh em Rostov do Don</a></li>
<li><a href="../pt431860/index.html">Nas op√ß√µes de driver do Linux, ou como passei o fim de semana</a></li>
<li><a href="../pt431862/index.html">Mitap Sbertekh em Ecaterimburgo</a></li>
<li><a href="../pt431864/index.html">PVS-Studio ROI: como n√£o perder milh√µes (vers√£o preliminar do artigo)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>