<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè† üë©üèæ‚Äç‚öñÔ∏è üëá Blackjack et protection contre les fuites ‚è∞ ‚úãüèª ‚ö´Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salutations. Il y a une telle chose - hydrolock \ neptune \ avkvastorozh - des syst√®mes d'arr√™t d'eau en cas de fuite incontr√¥l√©e. Le principe est sim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Blackjack et protection contre les fuites</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/399459/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salutations. Il y a une telle chose - hydrolock \ neptune \ avkvastorozh - des syst√®mes d'arr√™t d'eau en cas de fuite incontr√¥l√©e. Le principe est simple - un capteur d'eau + automatisation + une paire de robinets √©lectriques. Mais le diable, comme d'habitude, est dans les d√©tails: comment les robinets sont dispos√©s, comment les capteurs de fuite sont dispos√©s, et pourquoi l'un co√ªte 50 roubles et l'autre co√ªte 500 roubles. Un kilogramme d'un bulletin de mise en page sera enroul√© autour de tout cela, l'emballage vous enl√®vera les yeux, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'histoire, je vais parcourir les briques du syst√®me, qui m'ont guid√© dans le choix. L'ensemble du syst√®me est construit sur des capteurs d'usine et un contr√¥leur fait maison bas√© sur des particules (ex.Spark) Photon (tel qu'un esp8266 qui a un IDE cloud sur le c√¢blage hors de la bo√Æte), la base de l'appareil est un contr√¥leur stm + module wifi de Broadcom. Tout cela est li√© √† un serveur openhab sur Orange Pi One.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/715/6ee/aa2/7156eeaa28b44479a5d5aff2e63ff89c.png" width="600"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi pas un syst√®me fini? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Parce que je peux le faire moi-m√™me et c'est √©lev√© </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - L'int√©gration avec des syst√®mes externes est boiteuse dans des syst√®mes pr√™ts √† l'emploi. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Les syst√®mes pr√™ts √† l'emploi n'ont pas de fonctions auxiliaires - prenant en compte les relev√©s de compteurs, les capteurs de temp√©rature de l'eau, la notification des pannes d'eau et autres fantasmes √©rotiques de marche.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commen√ßons par les grues</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A choisi b√™tement au front en termes de couple. Pendant quelque temps, il a v√©cu en banlieue, o√π la qualit√© de l'eau (comme probablement partout √† Zamkadye) laisse beaucoup √† d√©sirer. Donc, les vannes √† bille 1/2 pouce si vous ne touchez pas l'ann√©e - il est tr√®s difficile de tourner. Et sur le porte-serviettes chauffant de 1 pouce, je n'essaie m√™me pas de le d√©placer - seulement si je renforce l'√©paule avec une cl√©, mais ici vous pouvez arracher quelque chose. Le probl√®me r√©side dans les d√©p√¥ts de bois dur calcique, "envahis" par un seul mot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, le choix s'est port√© sur la s√©rie professionnelle de l'hydrolock - 21N * m de couple ne ressemble pas √† un bavardage publicitaire, la grue est tout simplement √©norme - √©valuez le lieu de son installation avant l'achat. </font></font><br>
<br>
<img src="https://habrastorage.org/files/758/e07/18c/758e0718cc9a46e09306bac214db8cf1.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le robinet est scell√©, un joint en caoutchouc autour du p√©rim√®tre, l'entr√©e sous le presse-√©toupe. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retirez le couvercle.</font></font><br>
<br>
<img src="https://habrastorage.org/files/f9d/aa4/a25/f9daa4a251e140c3bbe4b049a5af7f46.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devant nous se trouve le haut de la planche et le moteur pas √† pas. Tout cela est aliment√© par 12 volts. La mise en court-circuit du c√¢ble de commande √† la terre met la vanne en position ferm√©e. Sur la carte, nous voyons un simple contr√¥leur PIC 12f629. Surv√©cu, le contr√¥leur dans le lecteur de grue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le dos de la planche est le plus int√©ressant. </font></font><br>
<br>
<img src="https://habrastorage.org/files/c14/e08/f2e/c14e08f2e4224088a534e1811fa3729a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pilote shagovik L293 et ‚Äã‚Äãphotocoupleur (√©metteur + photod√©tecteur). Elle regarde l'engrenage principal de l'entra√Ænement, qui est peint en plusieurs parties - blanc et noir, ferm√© / ouvert. </font></font><br>
<br>
<img src="https://habrastorage.org/files/a14/cec/177/a14cec1771ef4d52bc15c83e9183124e.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La grue tourne tout le temps dans une direction, la logique du contr√¥leur est simple - nous tournons l'arbre jusqu'√† ce que nous passions √† la couleur souhait√©e. La rotation de la grue dans une direction est moins d'usure et la mani√®re sans contact de d√©terminer la position est moins susceptible de provoquer un dysfonctionnement / une d√©faillance d'une r√©sistance variable ou d'un interrupteur de fin de course.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'installation, vous pouvez d√©visser la grue de l'entra√Ænement - elle est maintenue sur 2 √©crous. Il y a un joint calorifuge entre l'entra√Ænement et la grue. </font></font><br>
<br>
<img src="https://habrastorage.org/files/bf7/37c/1f7/bf737c1f7a144c72baba7a17fdc94615.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai eu la r√©paration il y a un an et demi. La grue achet√©e il y a trois ans - pour d√©monter, regarder √† l'int√©rieur, acheter plus et l'enrouler pendant la r√©paration. Ouais, maintenant ... le maximum dont j'ai r√©ussi dans ce cirque infernal √©tait de poser un collecteur de salet√©s dans l'assemblage de l'alimentation en eau avec la perspective de le remplacer par une grue. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et seulement apr√®s un an et demi - j'ai achet√© une deuxi√®me grue et je les ai viss√©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous observons un ph√©nom√®ne √©trange et rare (lu dans la voix de Drozdov) - toutes les informations du site Web du fabricant ont √©t√© confirm√©es. De plus, la description est particuli√®re, comme si les techniciens l'avaient √©crit, puis le marketing √©tait arros√© pour les gens, mais encore peu de gens comprennent toutes les puces. Il n'y a pas assez de section sur le site - pour les int√©grateurs avec des d√©tails techniques √† l'int√©rieur. M√™me au d√©triment de l'augmentation du couple, ils ne se sont pas allong√©s au d√©but - la grue au d√©marrage frappe avec un moteur de 1,5 A et apr√®s 2-3 secondes, elle commence √† monter en mode normal (courant 0,7 A). La fermeture prend environ 25 √† 30 secondes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autre exp√©rience: au d√©triment du couple - c'est excessif pour l'√©poque de Moscou, ici l'eau est tout √† fait OK, pendant un an et demi dans un filtre de 100 Œºm il y a une paire de crasses et pas de prolif√©ration. </font><font style="vertical-align: inherit;">Il faut payer le gros couple avec le prix, l'heure d'ouverture et la place dans le placard. </font><font style="vertical-align: inherit;">Je pense qu'il y aura suffisamment de disques conventionnels Hydrolock Ultimate, Neptune ou Aquastorozh. </font><font style="vertical-align: inherit;">Je ne peux pas garantir les deux derniers - je ne l'ai pas compris, il y a environ 5 ans, ils avaient des engrenages partiellement en plastique, maintenant ils semblent l'avoir r√©par√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a aussi un hydrolock Winner avec connexion directe de capteurs au variateur - c'est si vous n'avez pas besoin de tout ce que j'ai fait. </font><font style="vertical-align: inherit;">L√†, la puissance est autonome √† partir de 4 batteries, et la base est similaire √† un lecteur ultime. </font><font style="vertical-align: inherit;">En g√©n√©ral, il est √©galement potentiellement int√©ressant pour un contr√¥leur self-made - c'est 5 volts, vous n'avez pas besoin de mettre deux bus sur 5 et 12 volts et vous pouvez jeter l'isolement optique.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capteurs de fuite</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai achet√© les capteurs du m√™me compteur WSU - universel. </font><font style="vertical-align: inherit;">Ils ont deux sorties ¬´collecteur ouvert¬ª, l'une tire au sol uniquement s'il y a de l'eau, la seconde - si de l'eau p√©n√®tre, elle tire au sol tout le temps jusqu'√† ce que l'alimentation soit coup√©e. </font><font style="vertical-align: inherit;">J'utilise uniquement la premi√®re sortie, le reste de la logique est dans le contr√¥leur, mais il semble que cette sortie puisse √™tre utile pour d'autres syst√®mes de r√©partition de condos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fils du kit sont √† trois m√®tres quelque part. </font><font style="vertical-align: inherit;">La couleur des fils est Ad_i_Israel. </font><font style="vertical-align: inherit;">D√©couvrez le devis:</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fil rouge (marron) (Vcc) aliment√© de +5 √† +30 volts. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fil noir (blanc) (OUT2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fil vert (OUT1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fil jaune (GND)</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici ce qui a emp√™ch√© de faire de la terre blanche / noire? </font><font style="vertical-align: inherit;">Soit dit en passant, sur la grue, les fils de couleur avec logique ne sont pas ale. </font><font style="vertical-align: inherit;">Le premier capteur se trouve dans la cuisine, sous l'√©vier √† c√¥t√© du lave-vaisselle. </font></font><br>
<br>
<img src="https://habrastorage.org/files/2ea/407/a25/2ea407a255b8420e9b1d6c26772e2709.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxi√®me dans la salle de bain dans un foss√© de drainage sp√©cial. </font><font style="vertical-align: inherit;">Quand il a fait la chape, il ne l'a pas coll√©e au mur. </font><font style="vertical-align: inherit;">Le r√©sultat fut une sorte de puisard pour recueillir l'eau de la salle de bain et des toilettes. </font></font><br>
<br>
<img src="https://habrastorage.org/files/51d/715/898/51d71589848d4a77a59f8caf0dbf2041.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De l'exp√©rience de fonctionnement - il y avait d√©j√† une fausse alarme du capteur dans le lave-vaisselle. </font><font style="vertical-align: inherit;">A en juger par le journal pour un cycle d'interrogation (500 ms), il y avait un circuit, a modifi√© le code - le changement d'√©tat se produit maintenant √† 10 valeurs identiques cons√©cutives du capteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les contacts du capteur sont plaqu√©s or. </font><font style="vertical-align: inherit;">Un ami poss√®de des capteurs similaires depuis plusieurs ann√©es, aucune oxydation n'a √©t√© constat√©e.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capteurs de pression</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pratiquement - showom√®tres. </font><font style="vertical-align: inherit;">La pr√©cision + - 0,5 atm me convenait parfaitement. </font><font style="vertical-align: inherit;">Sur la base des capteurs, une alerte d'arr√™t d'eau survient. </font><font style="vertical-align: inherit;">J'ai achet√© Ali </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capteurs de temp√©rature</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pourquoi ne pas ajouter? </font><font style="vertical-align: inherit;">D'utile - il pourra une fois par an vous informer de l'arr√™t de l'eau chaude. </font><font style="vertical-align: inherit;">Banal DS18B20 d'occasion.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compteurs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itelma le plus courant, une fois tous les 10 litres, prenez contact. </font><font style="vertical-align: inherit;">C√¥t√© contr√¥leur, la sortie est tir√©e jusqu'√† + 3,3v, le compteur la tire au sol.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contr√¥leur</font></font></h3><br>
<img src="https://habrastorage.org/files/318/4e6/d7a/3184e6d7ad9c4eab99d9962410c7918c.jpg"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä l'int√©rieur</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/a83/72d/117/a8372d1170ca43f8b92925fa76a240f8.jpg"><br>
<img src="https://habrastorage.org/files/f7b/e62/ee8/f7be62ee80a54ff2a0ed60ad17467a8b.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bas√© sur Particle Photon, plus de d√©tails </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ils ont une version avec un module 2G ou 3G (Electron). Le premier micrologiciel √©tait un laitier complet, clignotant avec des diodes OK, mais d√®s que vous commencez une saucisse compliqu√©e √† m√¢cher, jouer avec i2c et les interruptions peut perdre le wifi. Maintenant tu peux vivre. En principe, vous pouvez jeter les capteurs de pression hors du circuit et remuer tout sur l'ESP8266 - allez-y. Tout d'abord, photon doit √™tre li√© au compte de particules (fait via l'application sur le mobile ou via la console CLI Particle - j'utilise uniquement la deuxi√®me m√©thode) et enregistrer un r√©seau wifi. Apr√®s la liaison, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la section appareil appara√Æt le contr√¥leur et son √©tat de connexion au cloud.</font></font><br>
<br>
<img src="https://habrastorage.org/files/71d/c17/687/71dc17687ccb4a289d0a0dd2296fdfca.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai tous les n≈ìuds connect√©s au cloud uniquement pour mettre √† jour le firmware. </font><font style="vertical-align: inherit;">Non pas que je serais parano√Øaque - travailler avec le cloud ne consomme pas de riches ressources de contr√¥leur. </font><font style="vertical-align: inherit;">L'IDE prend en charge le travail avec les biblioth√®ques, litt√©ralement une douzaine sont prises en charge par le compteur lui-m√™me, le reste par la communaut√©. </font><font style="vertical-align: inherit;">√Ä mon avis, tout ce qui est commun a √©t√© port√© depuis longtemps, et une autre caract√©ristique est que l'EDI sait imm√©diatement combien de projets utilisent la biblioth√®que.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code source du firmware</font></font></b><div class="spoiler_text"><pre><code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Adafruit_SSD1306/Adafruit_SSD1306.h"</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MQTT/MQTT.h"</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"OneWire/OneWire.h"</span></span></span></span><font></font>
<font></font>
SYSTEM_THREAD(ENABLED);<font></font>
SYSTEM_MODE(MANUAL);<font></font>
STARTUP(WiFi.selectAntenna(ANT_EXTERNAL));<font></font>
STARTUP(System.enableFeature(FEATURE_RETAINED_MEMORY));<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value;<font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">valve_struct</span></span></span><span class="hljs-class"> {</span></span><font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout;<font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> currentMillis = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_conected = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_wifi_uptime = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_counter_read = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> wifi_uptime;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> read_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
byte display_timeout = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//temp onewire </span></span><font></font>
OneWire ds0 = OneWire(D2);<font></font>
OneWire ds1 = OneWire(D3);<font></font>
byte addr0[<span class="hljs-number"><span class="hljs-number">8</span></span>];<font></font>
byte addr1[<span class="hljs-number"><span class="hljs-number">8</span></span>];
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense0 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense1 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
byte data[<span class="hljs-number"><span class="hljs-number">12</span></span>];<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OLED_RESET A7</span></span>
<span class="hljs-function"><span class="hljs-function">Adafruit_SSD1306 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">display</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OLED_RESET)</span></span></span></span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//valve control</span></span>
retained valve_struct valve[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, D4}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, D5} };<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//counter control</span></span>
retained counter_struct counter[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A0}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A1} };
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pressure[<span class="hljs-number"><span class="hljs-number">2</span></span>] = {A2, A3};
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SENSOR_TIMEOUT 10</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> sensor_struct sensor[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D6}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D7} };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span></span>;<font></font>
<font></font>
byte server[] = { <span class="hljs-number"><span class="hljs-number">192</span></span>,<span class="hljs-number"><span class="hljs-number">168</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">101</span></span>};
<span class="hljs-function"><span class="hljs-function">MQTT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(server, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1883</span></span></span></span><span class="hljs-function"><span class="hljs-params">, callback)</span></span></span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)p, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(p), retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf_d[<span class="hljs-number"><span class="hljs-number">12</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf_d,<span class="hljs-string"><span class="hljs-string">"%d"</span></span>,p);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)buf_d, n, retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-comment"><span class="hljs-comment">//char buf_f[18];</span></span>
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;
<span class="hljs-comment"><span class="hljs-comment">//    dtostrf(p, 9, 4, buf_f);</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//int n = sprintf(buf_f,"%f",p);</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)s.c_str(), s.length(), retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// recieve message</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> p[length + <span class="hljs-number"><span class="hljs-number">1</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, payload, length);<font></font>
    p[length] = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p)</span></span></span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(topic)</span></span></span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.equals(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"1"</span></span>))<font></font>
        {<font></font>
            Particle.connect();<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(Particle.connected, <span class="hljs-number"><span class="hljs-number">10000</span></span>)) <font></font>
                {publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
                {Particle.disconnect(); publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
            Particle.disconnect();<font></font>
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m = message.toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) <font></font>
        {<font></font>
            set_valve(x, m);<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>),  valve[x].state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> m = message.toFloat();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt;= <span class="hljs-number"><span class="hljs-number">999999</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) <font></font>
        {<font></font>
            counter[x].value = m;<font></font>
        }<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>),  counter[x].value , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
<span class="hljs-comment"><span class="hljs-comment">//Serial.begin(9600);</span></span><font></font>
    WiFi.on();<font></font>
    WiFi.connect();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(WiFi.ready, <span class="hljs-number"><span class="hljs-number">5000</span></span>)) {mqtt_connect();}
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) <font></font>
    {<font></font>
        pinMode(valve[i].pin, OUTPUT);<font></font>
        digitalWrite(valve[i].pin, valve[i].state);<font></font>
        pinMode(counter[i].pin, INPUT);<font></font>
        pinMode(sensor[i].pin, INPUT);<font></font>
        counter[i].state = digitalRead(counter[i].pin);<font></font>
        pinMode(pressure[i], AN_INPUT);<font></font>
    }<font></font>
    pinMode(A4, INPUT_PULLUP);<font></font>
<font></font>
    display.begin(SSD1306_SWITCHCAPVCC, <span class="hljs-number"><span class="hljs-number">0x3C</span></span>);  <span class="hljs-comment"><span class="hljs-comment">// initialize with the I2C addr 0x3C (for the 128x64)</span></span>
    display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//Particle.connect();</span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> 
</span></span>{<font></font>
    currentMillis = millis();<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//       MQTT </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_conected &gt;= <span class="hljs-number"><span class="hljs-number">30000</span></span> || previous_conected &gt; currentMillis)<font></font>
    {<font></font>
        previous_conected = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.isConnected() &amp; wifi_uptime &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>)<font></font>
        {<font></font>
            mqtt_connect();<font></font>
        }<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/rssi"</span></span>, WiFi.RSSI(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_wifi_uptime &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> || previous_wifi_uptime &gt; currentMillis)<font></font>
    {<font></font>
        previous_wifi_uptime = currentMillis;<font></font>
        WiFi.ready() ? wifi_uptime++ : wifi_uptime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        <span class="hljs-comment"><span class="hljs-comment">//work with button and display</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fg = digitalRead(A4);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
        {<font></font>
            display_timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) <font></font>
            { <font></font>
                display.clearDisplay();<font></font>
                display.display();<font></font>
            } <font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fg == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
        {<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
            {<font></font>
                display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span>
                display.setTextSize(<span class="hljs-number"><span class="hljs-number">2</span></span>);<font></font>
                display.setTextColor(WHITE);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"C="</span></span>);<font></font>
                display.println(counter[<span class="hljs-number"><span class="hljs-number">0</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"H="</span></span>);<font></font>
                display.println(counter[<span class="hljs-number"><span class="hljs-number">1</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"Valve="</span></span>);<font></font>
                display.print(valve[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);<font></font>
                display.println(valve[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">48</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"Sensor="</span></span>);<font></font>
                display.print(sensor[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);<font></font>
                display.println(sensor[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);<font></font>
                display.display();<font></font>
            }<font></font>
            display_timeout = <span class="hljs-number"><span class="hljs-number">10</span></span>;<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//counter check</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_counter_read &gt;= <span class="hljs-number"><span class="hljs-number">500</span></span> || previous_counter_read &gt; currentMillis)<font></font>
    {<font></font>
        previous_counter_read = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) <font></font>
        {<font></font>
            byte count_state = digitalRead(counter[i].pin);<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state != counter[i].state)<font></font>
            {<font></font>
                counter[i].state = count_state;<font></font>
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                {<font></font>
                    counter[i].value += <span class="hljs-number"><span class="hljs-number">0.01</span></span>;
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/%d"</span></span>, i);<font></font>
                    publish_message(buf18 , counter[i].value, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-comment"><span class="hljs-comment">//    </span></span><font></font>
            byte sensor_state = digitalRead(sensor[i].pin);<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor_state != sensor[i].state) <span class="hljs-comment"><span class="hljs-comment">//</span></span><font></font>
            {<font></font>
                sensor[i].state = sensor_state;<font></font>
                sensor[i].timeout = SENSOR_TIMEOUT; <font></font>
            }<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <font></font>
            {<font></font>
                sensor[i].timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                {<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/sensor/%d"</span></span>, i);<font></font>
                    publish_message(buf18 , sensor[i].state, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].state  == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                    {<font></font>
                        set_valve(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span>
                        set_valve(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span><font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// temp onewire</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - start_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">299000</span></span> || start_temp_timer &gt; currentMillis)<font></font>
    { <span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
        start_temp_timer = currentMillis;<font></font>
        presense0 = start_temp0();<font></font>
        presense1 = start_temp1();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - read_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">300000</span></span> || read_temp_timer &gt; currentMillis)<font></font>
    {<span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
        read_temp_timer = currentMillis;<font></font>
        start_temp_timer = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense0) read_temp0();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense1) read_temp1();
        <span class="hljs-comment"><span class="hljs-comment">//preasure calc and send</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>]; 
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++)<font></font>
        {<font></font>
            <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/pressure/%d"</span></span>, i);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> read_val = analogRead(pressure[i]);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value = (read_val - <span class="hljs-number"><span class="hljs-number">600.0</span></span>) / <span class="hljs-number"><span class="hljs-number">300.0</span></span> ;<font></font>
            publish_message(buf18 , value, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//Particle.process();</span></span><font></font>
    client.loop();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(<span class="hljs-string"><span class="hljs-string">"water_count"</span></span>))<font></font>
    { <span class="hljs-comment"><span class="hljs-comment">//  spark    </span></span>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>);<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, Particle.connected() ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);<font></font>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);<font></font>
        <font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    <font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds0.search(addr0)) { ds0.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    ds0.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr0, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr0[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    <font></font>
    ds0.reset();<font></font>
    ds0.select(addr0);<font></font>
    ds0.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    <font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds1.search(addr1)) { ds1.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    ds1.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr1, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr1[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    <font></font>
    ds1.reset();<font></font>
    ds1.select(addr1);<font></font>
    ds1.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span><font></font>
    ds0.reset();<font></font>
    ds0.select(addr0);<font></font>
    ds0.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) <font></font>
    {<font></font>
        data[i] = ds0.read();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/0"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span><font></font>
    ds0.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span><font></font>
    ds1.reset();<font></font>
    ds1.select(addr1);<font></font>
    ds1.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) <font></font>
    {<font></font>
        data[i] = ds1.read();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/1"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span><font></font>
    ds1.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_valve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vlv, byte state)</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    valve[vlv].state = state;<font></font>
    digitalWrite(valve[vlv].pin, state);<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf26[<span class="hljs-number"><span class="hljs-number">26</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf26,<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/%d"</span></span>, vlv);<font></font>
    publish_message(buf26 , state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gr√¢ce √† MQTT, nous nous connectons au courtier. </font><font style="vertical-align: inherit;">Surveillez les capteurs et le casque dans les branches correspondantes des √©v√©nements et des valeurs mqtt. </font><font style="vertical-align: inherit;">Par exemple home / water_count / valve / 0 - un lecteur d'eau. </font><font style="vertical-align: inherit;">home / water_count / counter / 0 - lectures du compteur d'une eau froide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous souscrivons aux commandes pour changer l'√©tat du variateur et r√©gler la valeur actuelle du compteur (eau froide et eau chaude):</font></font><br>
<br>
<pre><code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);
<span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un bouton sur l'appareil - en appuyant sur nous allumons l'√©cran, dessinons les lectures actuelles des compteurs, des capteurs et des robinets. √âcran OLED, s'estompe rapidement s'il est allum√© tout le temps.</font></font><br>
<br>
<pre><code class="hljs lisp">STARTUP(<span class="hljs-name"><span class="hljs-name">System</span></span>.enableFeature(<span class="hljs-name"><span class="hljs-name">FEATURE_RETAINED_MEMORY</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'une fonctionnalit√© mat√©rielle et logicielle int√©ressante du contr√¥leur stm, dans la particule de r√©f√©rence qu'ils appellent BackupSRAM. Photon a une sortie vbat - ce n'est pas la puissance de la batterie ou la charge. Tant qu'il y a de la tension sur cette branche, le contenu de 4 000 octets de SRAM est maintenu avec le contr√¥leur compl√®tement hors tension. Cela √©limine le probl√®me d'usure sur l'EEPROM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le code, les variables qui doivent √™tre introduites dans cette m√©moire sont d√©clar√©es avec l'indication: conserv√©es. J'ai impl√©ment√© le mat√©riel du supercondensateur √† 1.5F. Selon la fiche technique, la m√©moire mourra √† 1.6v, selon mes exp√©riences de banc sur le proto-board, elle viendra dans 2 semaines avec environ mon condensateur. La logique de fermeture des grues lorsque les capteurs sont d√©clench√©s est "autonome" et ne d√©pend pas de la connexion √† openhab. Il y a un interrupteur √† 3 voies pour le contr√¥le direct de l'entra√Ænement - automatique, OFF (robinets ouverts), Close (ferm√©).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le sch√©ma ci-dessous: </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a8/f4c/63d/1a8f4c63dba34f4e9905b703fabad0fd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le projet Eagle, ainsi que des biblioth√®ques personnalis√©es, peuvent √™tre t√©l√©charg√©s </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La redevance a √©t√© faite LUT, dans les pistes n'a pas diminu√©.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bain d'eau meilleur ami de LUT</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/351/e37/1c3/351e371c3caf487d9f14f839f89402be.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloc d'alimentation. </font><font style="vertical-align: inherit;">Nous avons besoin de 12 et 5 volts. </font><font style="vertical-align: inherit;">Le donateur est recherch√© sur ebay pour la ligne: "adaptateur de disque dur 5v 12v", comme celui- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ci</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a √©t√© imprim√© avec du plastique PLA sur une imprimante 3D (Tarantula Tevo). </font><font style="vertical-align: inherit;">Buse 0,4 mm, couche 0,25 mm. </font><font style="vertical-align: inherit;">Le couvercle est en m√™me temps et la base pour le montage de la carte contr√¥leur. </font><font style="vertical-align: inherit;">La base avec l'alimentation est fix√©e au mur. </font><font style="vertical-align: inherit;">La base avec le couvercle n'est pas fix√©e avec des vis, la tension du couvercle est suffisante (comme le couvercle de la grand-m√®re sur les pots de confiture) et la structure en couches des murs fonctionne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mod√®le 3D dans l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/945/110/37d/94511037d3734ad1a573e84e5fc426ef.png"><br>
<br>
<img src="https://habrastorage.org/files/5aa/546/c0b/5aa546c0b6dd41d58fd6b33bde08df74.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi tout cela ressemble mont√© sur une conduite d'eau.</font></font><br>
<br>
<img src="https://habrastorage.org/files/cfb/293/f66/cfb293f66c3f4bb9ad2f46e812418918.jpg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openhab</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©ploy√© sur Orange Pi One sous Armbian.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de l'article</font></font></b><div class="spoiler_text"><pre><code class="hljs julia">  -    ,  .
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp1	<span class="hljs-string"><span class="hljs-string">"T cool [%.1f ¬∞C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp2	<span class="hljs-string"><span class="hljs-string">"T hot [%.1f ¬∞C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp2:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count0	<span class="hljs-string"><span class="hljs-string">"Count cool [%.2f ¬≥]"</span></span>					(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count1	<span class="hljs-string"><span class="hljs-string">"Count hot [%.2f ¬≥]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure0	<span class="hljs-string"><span class="hljs-string">"P cool [%.2f .]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure1	<span class="hljs-string"><span class="hljs-string">"P hot [%.2f .]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor0	<span class="hljs-string"><span class="hljs-string">"Sensor0 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor1	<span class="hljs-string"><span class="hljs-string">"Sensor1 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve0	<span class="hljs-string"><span class="hljs-string">"Valve cool"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/0:state:default], &gt;[mqtt_bro:home/water_count/valve/0/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve1	<span class="hljs-string"><span class="hljs-string">"Valve hot"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/1:state:default], &gt;[mqtt_bro:home/water_count/valve/1/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>	watercount_sendStr <span class="hljs-string"><span class="hljs-string">"LastVol:[%s]"</span></span>						(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendCool <span class="hljs-string"><span class="hljs-string">"Send cool [%.2f ¬≥]"</span></span>		(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendHot <span class="hljs-string"><span class="hljs-string">"Send hot [%.2f ¬≥]"</span></span>			(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendSwitch <span class="hljs-string"><span class="hljs-string">"Autosend"</span></span> 	(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_rssi	<span class="hljs-string"><span class="hljs-string">"WaterCount [%d dB]"</span></span>	(gSpark_RSSI)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/rssi:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_spark_state	<span class="hljs-string"><span class="hljs-string">"WaterCount Spark"</span></span>		(gSpark)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/spark:state:default], &gt;[mqtt_bro:home/water_count/spark/set:command:*:default]"</span></span> }</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une petite r√®gle de transformation est n√©cessaire pour le capteur de fuite.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les configurations se transforment</font></font></b><div class="spoiler_text"><b>transform\water_sensor.map </b><br>
1=dry<br>
0=wet<br>
undefined=undefined<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous formons la page de gestion:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plan du site de configuration</font></font></b><div class="spoiler_text"><b>Sitemap</b><br>
Text label=¬´¬ª icon=¬´water¬ª <br>
 {<br>
 Frame <br>
 {<br>
 Text item=watercount_temp1<br>
 Text item=watercount_count0<br>
 Text item=watercount_pressure0<br>
 Switch item=watercount_valve0 mappings=[1=¬´Close¬ª, 0=¬´Open¬ª]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_temp2<br>
 Text item=watercount_count1<br>
 Text item=watercount_pressure1<br>
 Switch item=watercount_valve1 mappings=[1=¬´Close¬ª, 0=¬´Open¬ª]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_sensor0<br>
 Text item=watercount_sensor1 <br>
 }<br>
 Frame <br>
 {<br>
 Switch item=watercount_sendSwitch mappings=[0=¬´OFF¬ª, 1=¬´ON¬ª]<br>
 Text item=watercount_sendStr<br>
 Text item=watercount_sendCool<br>
 Text item=watercount_sendHot<br>
 }<br>
 } <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et les r√®gles de traitement:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√®gles de configuration</font></font></b><div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 was wet less than 5 seconds")<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 become dry")<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 was dry less than 5 seconds");			<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 become wet! Valves will be closed!")<font></font>
			}<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 was wet less than 5 seconds")<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 become dry")<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 was dry less than 5 seconds");			<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 become wet! Valves will be closed!")<font></font>
			}<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
	<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_temp2"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_temp2 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_temp2.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">37</span></span> )<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot water temp drop to %s", watercount_temp2.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Cool pressure drop to %s", watercount_pressure0.state.toString));<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Cool pressure rise to %s", watercount_pressure0.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot pressure drop to %s", watercount_pressure1.state.toString));<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot pressure rise to %s", watercount_pressure1.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Generate send string counters" //every <span class="hljs-number"><span class="hljs-number">24</span></span> day <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> mounth  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">00.01</span></span> minutes
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 1 24 1/1 ?" 
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span><font></font>
		<font></font>
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaCool = (watercount_count0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()<font></font>
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaHot = (watercount_count1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()<font></font>
		<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deltaCool &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; deltaHot &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		{<font></font>
			watercount_sendStr.postUpdate(String::format(" %.2f / %.2f 3", deltaCool, deltaHot))<font></font>
			watercount_sendCool.state = watercount_count0.state<font></font>
			watercount_sendHot.state = watercount_count1.state<font></font>
			sendTelegram("****_bot", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3. %s", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), watercount_sendStr.state.toString()))<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			watercount_sendSwitch.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			sendTelegram("****_bot", "Current counters value less than sended last time. Turn off autosend.")<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Send string counters" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 23 24 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_sendSwitch.state == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendMail("uk@uk.ru", " 23,  5, . 23", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()));<font></font>
			sendTelegram("****_bot", "Send email with watercount values");<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			sendTelegram("****_bot", "Can't send email with watercount values - autosend is OFF.");<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Rotate valves" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 05 25 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_valve0.state == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; watercount_valve1.state == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		{	<font></font>
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			sendTelegram("****_bot", "Valves was rotated.");<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			sendTelegram("****_bot", "Can't rotate valves, it's closed.");<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour envoyer des messages, je n'utilise pas la fonctionnalit√© int√©gr√©e de l'application Android openhab, ni ne m'int√®gre √† leur cloud. </font><font style="vertical-align: inherit;">J'aime le bot Telegram. </font><font style="vertical-align: inherit;">Comment configurer et connecter le bot peut √™tre vu sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pour envoyer des lettres √† partir de la bo√Æte aux lettres gmail, si vous disposez d'une authentification √† deux facteurs, vous devez activer un mot de passe √† usage unique pour l'application de messagerie et d√©finir ce mot de passe dans la configuration openhab. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suivez les r√®gles. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√©rifiez watercount_sensor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le contr√¥leur envoie de nouvelles valeurs de capteur de fuite uniquement lorsque la valeur est modifi√©e ou en cas de fausse alarme (moins de 10 cycles). Nous analysons la signification historique et historique, nous formons des messages d'information. Il y a une nuance - une tentative pour obtenir prevoiusItem donne constamment la valeur actuelle, je n'ai pas trouv√© de solution - je prends la valeur "-3 sec", si quelqu'un l'a surmont√©e, √©crivez-la dans des commentaires ou dans PM. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√©rifiez watercount_temp2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - v√©rifiez si moins de 37, ce qui signifie que l'eau chaude est devenue froide, vous devez allumer le chauffe-eau √† l'arriv√©e. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√©rifiez watercount_pressure</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - nous analysons la valeur actuelle et pr√©c√©dente, nous r√©pondons par un message √† une baisse en dessous de 1 atm et √† une croissance au-dessus. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rer des compteurs de cha√Ænes d'envoi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- commence le cron le 24 de chaque mois √† 1 heure du matin. Nous v√©rifions que les valeurs sont d√©sormais sup√©rieures √† celles envoy√©es la derni√®re fois. Si moins, d√©sactivez l'envoi automatique et g√©n√©rez une alerte. Si tout va bien - nous nous souvenons des valeurs des compteurs √† envoyer au Code p√©nal, nous envoyons le futur corps du message au t√©l√©gramme. Dans le m√™me temps, nous √©conomisons dans watercount_sendStr combien nous avons consomm√© au cours du mois dernier. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rer des compteurs de cha√Ænes d'envoi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - commence sur cron le 24e jour √† 23h00. V√©rifie si l'envoi automatique est activ√©, s'il est activ√© - le casque envoie des compteurs au courrier de la compagnie maritime. Il s'av√®re que j'ai le 24√®me jour toute la journ√©e, quelque chose √† r√©parer ou simplement √† couper l'envoi automatique, si une erreur s'est produite dans les t√©l√©grammes. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise √† jour par commentaire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vannes rotatives</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- La r√®gle de fermeture / ouverture du robinet une fois par mois contre l'√©bullition. </font><font style="vertical-align: inherit;">Le 25 √† 5h du matin - pour ne pas entrer dans le travail du lave-vaisselle ou du lave-linge, mais m√™me s'il y arrive - ce n'est pas critique, le chevauchement de l'eau sera d'environ 3-4 secondes. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et ce n'est qu'ici que la maison intelligente commence ... La</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
combinaison de syst√®mes en un seul point (openhab) vous permet de cr√©er une logique qui n'est pas disponible pour un ensemble de syst√®mes autonomes. </font><font style="vertical-align: inherit;">Par exemple: un √©v√©nement d'augmentation du compteur d'eau est arriv√© - le syst√®me de s√©curit√© est actif, les serrures de la porte d'entr√©e sont ferm√©es, la consommation d'√©nergie du lave-vaisselle et du lave-linge est inf√©rieure √† 5 watts - ce qui signifie qu'une fuite par les capteurs est d√©tect√©e. </font><font style="vertical-align: inherit;">Nous formons une commande pour fermer les grues, envoyons un message au bot dans le t√©l√©gramme. </font><font style="vertical-align: inherit;">Mais c'est comme un fil plus tard.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr399459/">https://habr.com/ru/post/fr399459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr399449/index.html">L'ADN ne fait que la moiti√© de la taille des chromosomes. Tout le reste est une coquille de fonctionnalit√©s inconnues</a></li>
<li><a href="../fr399451/index.html">Pourquoi nous n'avons pas de souvenirs infantiles</a></li>
<li><a href="../fr399453/index.html">Cinq formes d'argent blockchain disponibles d√®s maintenant</a></li>
<li><a href="../fr399455/index.html">Non seulement les appareils √©lectrom√©nagers: qu'y a-t-il d'autre dans Audiomania pour les m√©lomanes, les amateurs et les musiciens</a></li>
<li><a href="../fr399457/index.html">Russian FinTech Meetup # 2: Commerce √† l'√®re num√©rique</a></li>
<li><a href="../fr399461/index.html">L'intelligence artificielle aidera les gens √† se d√©barrasser des phobies et des peurs</a></li>
<li><a href="../fr399463/index.html">Multicopter a appris √† s'asseoir sur les toits des voitures en mouvement</a></li>
<li><a href="../fr399469/index.html">Le r√©seau neuronal Pix2pix colore de mani√®re r√©aliste les croquis au crayon et les photos en noir et blanc</a></li>
<li><a href="../fr399471/index.html">Habitations spatiales, partie 5: comment nous vivrons sur Mercure (ou nous ne le ferons pas)</a></li>
<li><a href="../fr399473/index.html">La puce Intel 4004 a 45 ans. Un peu d'histoire informatique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>