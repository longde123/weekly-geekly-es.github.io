<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ»â€ğŸ’¼ ğŸš… ğŸ‘¨ğŸ½â€âš•ï¸ HighLoad ++, Andrey Gushchin (Zabbix): hautes performances et partitionnement natif ğŸ”’ ğŸ˜’ â˜ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous verrons comment Zabbix fonctionne avec la base de donnÃ©es TimescaleDB en tant que backend. Nous montrons comment repartir de zÃ©ro et comment migr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Andrey Gushchin (Zabbix): hautes performances et partitionnement natif</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/485470/">  Nous verrons comment Zabbix fonctionne avec la base de donnÃ©es TimescaleDB en tant que backend.  Nous montrons comment repartir de zÃ©ro et comment migrer avec PostgreSQL.  Nous donnons Ã©galement des tests de performance comparatifs des deux configurations. <br><br><img src="https://habrastorage.org/webt/h4/jl/nw/h4jlnwupm_dewx7jasafurn-ibm.jpeg"><br><br>  HighLoad ++ Siberia 2019. Salle Tomsk.  24 juin, 16h00.  RÃ©sumÃ©s et <a href="https://www.highload.ru/siberia/2019/abstracts/5390">prÃ©sentation</a> .  La prochaine confÃ©rence HighLoad ++ se tiendra les 6 et 7 avril 2020 Ã  Saint-PÃ©tersbourg.  DÃ©tails et billets <a href="http://bit.ly/2sSxgBx">ici</a> . <br><br>  <b>Andrey Gushchin (ci</b> - <b>aprÃ¨s</b> dÃ©nommÃ© <b>AG):</b> - Je suis ingÃ©nieur du support technique ZABBIX (ci-aprÃ¨s dÃ©nommÃ© Zabbix), un formateur.  Je travaille dans le support technique depuis plus de 6 ans et j'ai Ã©tÃ© directement confrontÃ© Ã  la performance.  Aujourd'hui, je vais parler des performances que TimescaleDB peut donner par rapport Ã  PostgreSQL 10. Par ailleurs, une partie introductive - sur la faÃ§on dont cela fonctionne. <a name="habracut"></a><br><br><h3>  Principaux dÃ©fis de performance: de la collecte au nettoyage des donnÃ©es </h3><br>  Pour commencer, il existe certains dÃ©fis de performances que chaque systÃ¨me de surveillance rencontre.  Le premier dÃ©fi de performance est la collecte et le traitement rapides des donnÃ©es. <br><br><img src="https://habrastorage.org/webt/jl/xr/hv/jlxrhv3huan1s0w4otmxoknifzy.jpeg"><br><br>  Un bon systÃ¨me de surveillance doit recevoir rapidement et en temps opportun toutes les donnÃ©es, les traiter selon des expressions de dÃ©clenchement, c'est-Ã -dire les traiter selon certains critÃ¨res (dans diffÃ©rents systÃ¨mes, c'est diffÃ©rent) et les enregistrer dans la base de donnÃ©es afin d'utiliser ces donnÃ©es Ã  l'avenir. <br><br><img src="https://habrastorage.org/webt/d5/vq/-l/d5vq-lgcwljaq50nc-zxfeugi3k.jpeg"><br><br>  Le deuxiÃ¨me dÃ©fi de performance est de garder l'histoire.  Stockez souvent dans la base de donnÃ©es et accÃ©dez rapidement et facilement Ã  ces mesures qui ont Ã©tÃ© collectÃ©es sur une pÃ©riode de temps.  La chose la plus importante est qu'il est pratique d'obtenir ces donnÃ©es, de les utiliser dans des rapports, des graphiques, des dÃ©clencheurs, dans certaines valeurs de seuil, pour des alertes, etc. <br><br><img src="https://habrastorage.org/webt/k2/1l/3g/k21l3gg3vmeayv-d8oqpatgssv8.jpeg"><br><br>  Le troisiÃ¨me dÃ©fi en termes de performances consiste Ã  effacer l'histoire, c'est-Ã -dire lorsque votre journÃ©e est telle que vous n'avez pas besoin de stocker des statistiques dÃ©taillÃ©es qui ont Ã©tÃ© collectÃ©es sur 5 ans (voire des mois ou deux mois).  Certains nÅ“uds de rÃ©seau ont Ã©tÃ© supprimÃ©s ou certains hÃ´tes, les mesures ne sont plus nÃ©cessaires car elles sont dÃ©jÃ  obsolÃ¨tes et ne sont plus collectÃ©es.  Tout cela doit Ãªtre nettoyÃ© pour que votre base de donnÃ©es ne s'agrandisse pas.  En gÃ©nÃ©ral, l'effacement de l'historique est le plus souvent un test sÃ©rieux pour le stockage - trÃ¨s souvent, il affecte les performances. <br><br><h3>  Comment rÃ©soudre les problÃ¨mes de mise en cache? </h3><br>  Je vais maintenant parler spÃ©cifiquement du Zabbix.  Dans Zabbix, les premier et deuxiÃ¨me appels sont rÃ©solus Ã  l'aide de la mise en cache. <br><br><img src="https://habrastorage.org/webt/mg/2b/tb/mg2btblcs3cxvlnddc0yg6lwxrw.jpeg"><br><br>  Collecte et traitement des donnÃ©es - nous utilisons la RAM pour stocker toutes ces donnÃ©es.  Maintenant, ces donnÃ©es seront discutÃ©es plus en dÃ©tail. <br><br>  Du cÃ´tÃ© de la base de donnÃ©es, il existe Ã©galement une certaine mise en cache pour les principaux Ã©chantillons - pour les graphiques, etc. <br><br>  Mise en cache du cÃ´tÃ© du serveur Zabbix lui-mÃªme: nous avons ConfigurationCache, ValueCache, HistoryCache, TrendsCache.  Qu'est ce que c'est <br><br><img src="https://habrastorage.org/webt/6j/4e/_a/6j4e_acyhx8ldzgjfziqhuzvwz0.jpeg"><br><br>  ConfigurationCache est le cache principal dans lequel nous stockons les mÃ©triques, les hÃ´tes, les Ã©lÃ©ments de donnÃ©es, les dÃ©clencheurs;  tout ce dont vous avez besoin pour traiter le prÃ©traitement, collecter les donnÃ©es, auprÃ¨s de quels hÃ´tes collecter, avec quelle frÃ©quence.  Tout cela est stockÃ© dans ConfigurationCache, afin de ne pas aller dans la base de donnÃ©es, de ne pas crÃ©er de requÃªtes inutiles.  AprÃ¨s le dÃ©marrage du serveur, nous mettons Ã  jour ce cache (crÃ©er) et le mettons Ã  jour pÃ©riodiquement (en fonction des paramÃ¨tres de configuration). <br><br><img src="https://habrastorage.org/webt/q1/zc/dg/q1zcdgan2c5rcep47ebef24xrn0.jpeg"><br><br><h3>  Mise en cache dans Zabbix.  Collecte de donnÃ©es </h3><br>  Ici, le schÃ©ma est assez grand: <br><br><img src="https://habrastorage.org/webt/88/mh/gd/88mhgd974zcj8eou8kghhodhwf0.jpeg"><br><br>  Les principaux dans le schÃ©ma sont ces collecteurs: <br><br><img src="https://habrastorage.org/webt/2y/co/f7/2ycof750qb71iooc2qiahs-5i9y.jpeg"><br><br>  Ce sont les processus d'assemblage eux-mÃªmes, divers Â«scrutateursÂ» qui sont responsables de diffÃ©rents types d'assemblages.  Ils collectent des donnÃ©es via icmp, ipmi, selon diffÃ©rents protocoles et transfÃ¨rent le tout au prÃ©traitement. <br><br><h3>  Historique de prÃ©traitement </h3><br>  De plus, si nous avons des Ã©lÃ©ments de donnÃ©es calculÃ©s (qui sait Zabbix - sait), c'est-Ã -dire des Ã©lÃ©ments de donnÃ©es calculÃ©s et agrÃ©gÃ©s, nous les prenons directement de ValueCache.  Je dirai plus tard comment il est rempli.  Tous ces collecteurs utilisent ConfigurationCache pour obtenir leurs travaux, puis les passent au prÃ©traitement. <br><br><img src="https://habrastorage.org/webt/b4/qb/mh/b4qbmhsqtxvrfli40n-espjba6c.jpeg"><br><br>  Le prÃ©traitement utilise Ã©galement ConfigurationCache pour obtenir les Ã©tapes de prÃ©traitement; il traite ces donnÃ©es de diffÃ©rentes maniÃ¨res.  Ã€ partir de la version 4.2, nous l'avons soumis au proxy.  C'est trÃ¨s pratique, car le prÃ©traitement lui-mÃªme est une opÃ©ration assez difficile.  Et si vous avez un trÃ¨s gros "Zabbix", avec un grand nombre d'Ã©lÃ©ments de donnÃ©es et une frÃ©quence de collecte Ã©levÃ©e, cela facilite grandement le travail. <br><br>  En consÃ©quence, aprÃ¨s avoir traitÃ© ces donnÃ©es d'une maniÃ¨re ou d'une autre en utilisant le prÃ©traitement, nous les enregistrons dans HistoryCache afin de les traiter plus en dÃ©tail.  Cela met fin Ã  la collecte de donnÃ©es.  Nous passons au processus principal. <br><br><h3>  Fonctionnement du synchroniseur d'historique </h3><br><img src="https://habrastorage.org/webt/40/yj/9-/40yj9-h-hgm5wcd2hu2ygt5uyp4.jpeg"><br><br>  Le principal processus de Zabbix (car il s'agit d'une architecture monolithique) est le synchroniseur d'histoire.  Il s'agit du processus principal qui traite spÃ©cifiquement du traitement atomique de chaque Ã©lÃ©ment de donnÃ©es, c'est-Ã -dire de chaque valeur: <br><br><ul><li>  la valeur vient (elle le prend de HistoryCache); </li><li>  vÃ©rifie dans le synchroniseur de configuration: existe-t-il des dÃ©clencheurs de calcul? les calcule; <br>  s'il y en a, il crÃ©e des Ã©vÃ©nements, crÃ©e une escalade afin de crÃ©er une alerte, si nÃ©cessaire par configuration; </li><li>  enregistre les dÃ©clencheurs pour le traitement ultÃ©rieur, l'agrÃ©gation;  si vous agrÃ©gez au cours de la derniÃ¨re heure et ainsi de suite, cette valeur se souvient de ValueCache, afin de ne pas accÃ©der Ã  la table d'historique;  Ainsi, ValueCache est rempli avec les donnÃ©es nÃ©cessaires qui sont nÃ©cessaires pour calculer les dÃ©clencheurs, les Ã©lÃ©ments calculÃ©s, etc. </li><li>  puis le synchroniseur d'historique Ã©crit toutes les donnÃ©es dans la base de donnÃ©es; </li><li>  la base de donnÃ©es les Ã©crit sur le disque - c'est lÃ  que le processus de traitement se termine. </li></ul><br><h3>  Bases de donnÃ©es  Mise en cache </h3><br>  Du cÃ´tÃ© de la base de donnÃ©es, lorsque vous souhaitez consulter des graphiques ou des rapports d'Ã©vÃ©nements, il existe plusieurs caches.  Mais dans le cadre de ce rapport, je n'en parlerai pas. <br><br>  Pour MySQL, il y a Innodb_buffer_pool, un tas de caches diffÃ©rents qui peuvent Ã©galement Ãªtre configurÃ©s. <br>  Mais ce sont les principaux: <br><br><ul><li>  shared_buffers; </li><li>  effective_cache_size; </li><li>  shared_pool. </li></ul><br><img src="https://habrastorage.org/webt/fw/7n/0z/fw7n0ziowm_jbvs--peokkswjdw.jpeg"><br><br>  J'ai citÃ© pour toutes les bases de donnÃ©es qu'il existe certains caches qui vous permettent de garder en mÃ©moire les donnÃ©es qui sont souvent nÃ©cessaires pour les requÃªtes.  LÃ , ils ont leurs propres technologies pour cela. <br><br><h3>  Ã€ propos des performances de la base de donnÃ©es </h3><br>  En consÃ©quence, il existe un environnement concurrentiel, c'est-Ã -dire que le serveur Zabbix collecte des donnÃ©es et les enregistre.  Lors du redÃ©marrage, il lit Ã©galement Ã  partir de l'historique pour remplir ValueCache et ainsi de suite.  Ici, vous pouvez avoir des scripts et des rapports qui utilisent l'API Zabbix, qui est construite sur la base de l'interface Web.  "Zabbiks" -API est inclus dans la base de donnÃ©es et reÃ§oit les donnÃ©es nÃ©cessaires pour obtenir des graphiques, des rapports ou une liste d'Ã©vÃ©nements, des problÃ¨mes rÃ©cents. <br><br><img src="https://habrastorage.org/webt/gr/to/vp/grtovpkr0x6kkytkg5bw2zllpqw.jpeg"><br><br>  Grafana est Ã©galement une solution de visualisation trÃ¨s populaire, utilisÃ©e par nos utilisateurs.  Capable d'entrer directement Ã  la fois via "Zabbiks" -API et via la base de donnÃ©es.  Cela crÃ©e Ã©galement une certaine concurrence pour obtenir des donnÃ©es: un rÃ©glage plus fin et meilleur de la base de donnÃ©es est nÃ©cessaire pour correspondre Ã  la livraison rapide des rÃ©sultats et des tests. <br><br><img src="https://habrastorage.org/webt/aj/ak/l-/ajakl-q1nyal8mce-xw4snwrgye.jpeg"><br><br><h3>  Effacer l'histoire.  Zabbix a femme de mÃ©nage </h3><br>  Le troisiÃ¨me dÃ©fi utilisÃ© par Zabbix est de clarifier l'histoire avec Housekeeper.  Hauskiper respecte tous les paramÃ¨tres, c'est-Ã -dire que dans nos Ã©lÃ©ments de donnÃ©es, il est indiquÃ© combien stocker (en jours), combien stocker les tendances, la dynamique des changements. <br><br>  Je n'ai pas parlÃ© de TrendCache, que nous calculons Ã  la volÃ©e: les donnÃ©es arrivent, nous les agrÃ©gons en une heure (en gros ce sont des chiffres dans la derniÃ¨re heure), le montant est moyen / minimum et l'Ã©crivons une fois par heure dans le tableau des changements de dynamique (Tendances) .  Hauskiper dÃ©marre et supprime les donnÃ©es de la base de donnÃ©es Ã  l'aide de sÃ©lections rÃ©guliÃ¨res, ce qui n'est pas toujours efficace. <br><br>  Comment comprendre qu'elle est inefficace?  Vous pouvez voir l'image suivante sur les graphiques de performances des processus internes: <br><br><img src="https://habrastorage.org/webt/cw/au/u3/cwauu3n4dk0-u_nonnfzbf0og6g.jpeg"><br><br>  Votre synchroniseur d'historique est constamment occupÃ© (graphique rouge).  Et le tableau "rouge" qui va en haut.  Il s'agit du Hauskiper, qui dÃ©marre et attend la base de donnÃ©es lorsqu'il supprime toutes les lignes qu'il a spÃ©cifiÃ©es. <br><br>  Prenez un ID d'article: vous devez supprimer les 5 000 derniers;  Bien sÃ»r, par indices.  Mais gÃ©nÃ©ralement, l'ensemble de donnÃ©es est suffisamment volumineux - la base de donnÃ©es lit toujours cela Ã  partir du disque et le place dans le cache, et c'est une opÃ©ration trÃ¨s coÃ»teuse pour la base de donnÃ©es.  Selon sa taille, cela peut entraÃ®ner certains problÃ¨mes de performances. <br><br>  Vous pouvez dÃ©sactiver Hauskiper de maniÃ¨re simple - nous avons une interface Web familiÃ¨re pour tout le monde.  En paramÃ©trant l'administration gÃ©nÃ©rale (paramÃ¨tres de Â«GouvernanteÂ»), nous dÃ©sactivons la gestion interne pour l'historique et les tendances internes.  En consÃ©quence, Hauskiper ne contrÃ´le plus cela: <br><br><img src="https://habrastorage.org/webt/cp/si/jo/cpsijomx2kl2p1trw0it8ujvpga.jpeg"><br><br>  Que puis-je faire ensuite?  Vous vous Ãªtes dÃ©connectÃ©, vos plannings se sont nivelÃ©s ... Quels problÃ¨mes peuvent Ãªtre plus poussÃ©s dans ce cas?  Qu'est-ce qui peut aider? <br><br><h3>  Partitionnement (partitionnement) </h3><br>  Ceci est gÃ©nÃ©ralement configurÃ© sur chaque base de donnÃ©es relationnelle que j'ai rÃ©pertoriÃ©e d'une maniÃ¨re diffÃ©rente.  MySQL possÃ¨de sa propre technologie.  Mais dans l'ensemble, ils sont trÃ¨s similaires en ce qui concerne PostgreSQL 10 et MySQL.  Bien sÃ»r, il existe de nombreuses diffÃ©rences internes dans la faÃ§on dont tout est mis en Å“uvre et comment tout cela affecte les performances.  Mais en gÃ©nÃ©ral, la crÃ©ation d'une nouvelle partition entraÃ®ne souvent aussi certains problÃ¨mes. <br><br><img src="https://habrastorage.org/webt/g3/ru/gs/g3rugs9kazu4fcyk70inqtrnrd4.jpeg"><br><br>  Selon votre configuration (la quantitÃ© de donnÃ©es que vous crÃ©ez en une journÃ©e), ils dÃ©finissent gÃ©nÃ©ralement le minimum un - 1 jour / partition, et pour les tendances, la dynamique des changements - 1 mois / nouvelle partition.  Cela peut changer si vous avez une trÃ¨s grande configuration. <br><br>  Disons tout de suite la taille de la configuration: jusqu'Ã  5 000 nouvelles valeurs par seconde (appelÃ©es nvps) - cela sera considÃ©rÃ© comme une petite Â«configurationÂ».  Moyenne - de 5 Ã  25 000 valeurs par seconde.  Tout ce qui est au-dessus est dÃ©jÃ  des installations grandes et trÃ¨s grandes qui nÃ©cessitent une configuration trÃ¨s soignÃ©e de la base de donnÃ©es elle-mÃªme. <br><br>  Sur les trÃ¨s grandes installations, 1 jour - cela peut ne pas Ãªtre optimal.  Personnellement, j'ai vu sur des partitions MySQL de 40 gigaoctets par jour (et il peut y en avoir plus).  Il s'agit d'une trÃ¨s grande quantitÃ© de donnÃ©es, ce qui peut entraÃ®ner certains problÃ¨mes.  Elle doit Ãªtre rÃ©duite. <br><br><h3>  Pourquoi partitionner? </h3><br>  Ce que le partitionnement donne, je pense que tout le monde le sait, c'est le partitionnement de table.  Il s'agit souvent de fichiers distincts sur les demandes de disque et d'Ã©tendue.  Il sÃ©lectionne de maniÃ¨re plus optimale une partition, si elle fait partie de la partition habituelle. <br><br><img src="https://habrastorage.org/webt/nd/u2/6a/ndu26acwf_st_axq0rfws4t0yhu.jpeg"><br><br>  Pour Zabbix, en particulier, il est utilisÃ© par plage, par plage, c'est-Ã -dire que nous utilisons un horodatage (le nombre est ordinaire, le temps depuis le dÃ©but de l'Ã¨re).  Vous spÃ©cifiez le dÃ©but du jour / la fin de la journÃ©e, et ceci est une partition.  Par consÃ©quent, si vous faites une demande de donnÃ©es il y a deux jours, tout cela est sÃ©lectionnÃ© plus rapidement dans la base de donnÃ©es, car vous n'avez besoin de tÃ©lÃ©charger qu'un fichier dans le cache et le problÃ¨me (plutÃ´t qu'une grande table). <br><br><img src="https://habrastorage.org/webt/n8/-5/h0/n8-5h0inf3gdrt6fv2jaqeguoxm.jpeg"><br><br>  De nombreuses bases de donnÃ©es accÃ©lÃ¨rent Ã©galement l'insertion (insertion dans une seule table enfant).  Bien que je parle de faÃ§on abstraite, mais c'est aussi possible.  Le partage est souvent utile. <br><br><h3>  Elasticsearch pour NoSQL </h3><br>  RÃ©cemment, en 3.4, nous avons implÃ©mentÃ© une solution pour NoSQL.  Ajout de la possibilitÃ© d'Ã©crire dans Elasticsearch.  Vous pouvez Ã©crire quelques types distincts: choisissez - soit Ã©crire des nombres ou des signes;  nous avons un texte de chaÃ®ne, vous pouvez Ã©crire des journaux dans Elasticsearch ... En consÃ©quence, l'interface Web accÃ©dera Ã©galement Ã  Elasticsearch.  Cela fonctionne bien dans certains cas, mais pour le moment, il peut Ãªtre utilisÃ©. <br><br><img src="https://habrastorage.org/webt/xq/f_/kc/xqf_kcj7pttjfkqtvykodkhf1ne.jpeg"><br><br><h3>  TimescaleDB.  Hypertables </h3><br>  Pour 4.4.2, nous avons remarquÃ© une chose comme TimescaleDB.  Qu'est ce que c'est  Il s'agit d'une extension pour Postgres, c'est-Ã -dire qu'elle a une interface PostgreSQL native.  De plus, cette extension vous permet de travailler avec des donnÃ©es de sÃ©rie temporelle beaucoup plus efficacement et d'avoir un partitionnement automatique.  Ã€ quoi Ã§a ressemble: <br><br><img src="https://habrastorage.org/webt/_q/nk/mz/_qnkmz4mbfzhveegk3d2hjzgafg.jpeg"><br><br>  C'est hypertable - il y a un tel concept dans Timescale.  Il s'agit de l'hypertable que vous crÃ©ez et il contient des morceaux.  Les morceaux sont des partitions, ce sont des tables enfants, si je ne me trompe pas.  C'est vraiment efficace. <br><br><img src="https://habrastorage.org/webt/un/gu/pk/ungupk6uffgezcunuoaa4tjkk0g.jpeg"><br><br><h3>  TimescaleDB et PostgreSQL </h3><br>  Comme les fabricants de TimescaleDB le garantissent, ils utilisent un algorithme de traitement des demandes plus correct, en particulier insert'ov, qui vous permet d'avoir des performances Ã  peu prÃ¨s constantes avec une taille croissante de l'insertion de l'ensemble de donnÃ©es.  Autrement dit, aprÃ¨s 200 millions de lignes de Â«PostgresÂ», l'habituel commence Ã  s'affaisser et perd littÃ©ralement les performances Ã  zÃ©ro, tandis que Â«TimescaleÂ» vous permet d'insÃ©rer des insertions aussi efficacement que possible avec n'importe quelle quantitÃ© de donnÃ©es. <br><br><img src="https://habrastorage.org/webt/xo/zb/-o/xozb-o86ammklruo6wbmreoddga.jpeg"><br><br><h3>  Comment installer TimescaleDB?  Tout est simple! </h3><br>  Il l'a dans la documentation, il est dÃ©crit - il peut Ãªtre livrÃ© Ã  partir de colis pour tout ... Cela dÃ©pend des colis officiels de Postgres.  Il peut Ãªtre compilÃ© manuellement.  Il se trouve que j'ai dÃ» compiler pour la base de donnÃ©es. <br><br><img src="https://habrastorage.org/webt/vm/t8/ab/vmt8ab42ehsl-ne-cxb70skn9ik.jpeg"><br><br>  Chez Zabbix, nous venons d'activer Extention.  Je pense que ceux qui ont utilisÃ© Extention dans Postgres ... Vous venez d'activer Extention, crÃ©ez-le pour la base de donnÃ©es Zabbix que vous utilisez. <br><br>  Et la derniÃ¨re Ã©tape ... <br><br><h3>  TimescaleDB.  Tableaux d'historique de migration </h3><br>  Vous devez crÃ©er un hypertable.  Il existe une fonction spÃ©ciale pour cela - CrÃ©er une hypertable.  Dans ce document, le premier paramÃ¨tre indique la table qui est nÃ©cessaire dans cette base de donnÃ©es (pour laquelle vous devez crÃ©er une hypertable). <br><br><img src="https://habrastorage.org/webt/rs/p0/ja/rsp0ja0xplwviw9abiqvsody8zw.jpeg"><br><br>  Le champ par lequel vous souhaitez crÃ©er, et chunk_time_interval (c'est l'intervalle des morceaux (partitions Ã  utiliser). 86 400 est un jour. <br><br>  ParamÃ¨tre migrate_data: si vous insÃ©rez dans true, cela transfÃ¨re toutes les donnÃ©es actuelles aux blocs crÃ©Ã©s prÃ©cÃ©demment. <br><br>  J'ai moi-mÃªme utilisÃ© migrate_data - cela prend un temps dÃ©cent, selon la taille de votre base de donnÃ©es.  J'avais plus d'un tÃ©raoctet - la crÃ©ation a pris plus d'une heure.  Dans certains cas, lors des tests, j'ai supprimÃ© les donnÃ©es historiques du texte (history_text) et de la chaÃ®ne (history_str), afin de ne pas les transfÃ©rer - elles n'Ã©taient pas vraiment intÃ©ressantes pour moi. <br><br>  Et nous faisons la derniÃ¨re mise Ã  jour dans notre db_extention: nous dÃ©finissons timescaledb pour que la base de donnÃ©es et, en particulier, notre Zabbix comprennent ce qu'est db_extention.  Il l'active et utilise la syntaxe et les requÃªtes de base de donnÃ©es correctes, en utilisant les Â«fonctionnalitÃ©sÂ» nÃ©cessaires Ã  TimescaleDB. <br><br><h3>  Configuration du serveur </h3><br>  J'ai utilisÃ© deux serveurs.  Le premier serveur est une machine virtuelle assez petite, 20 processeurs, 16 gigaoctets de RAM.  Configurez Postgres 10.8 dessus: <br><br><img src="https://habrastorage.org/webt/q_/h-/fe/q_h-fey52vutiin_dcat3zezb1g.jpeg"><br><br>  Le systÃ¨me d'exploitation Ã©tait Debian, le systÃ¨me de fichiers Ã©tait xfs.  J'ai fait des rÃ©glages minimaux pour utiliser cette base de donnÃ©es particuliÃ¨re, moins ce que Zabbix utilisera.  Sur la mÃªme machine se trouvait un serveur Zabbix, PostgreSQL et des agents de chargement. <br><br><img src="https://habrastorage.org/webt/vl/jv/bu/vljvbuggjlj1vz5tvptvzsicauo.jpeg"><br><br>  J'ai utilisÃ© 50 agents actifs qui utilisent le LoadableModule pour gÃ©nÃ©rer rapidement divers rÃ©sultats.  Ils ont gÃ©nÃ©rÃ© des lignes, des nombres, etc.  J'ai obstruÃ© la base de donnÃ©es avec beaucoup de donnÃ©es.  Initialement, la configuration contenait 5 000 Ã©lÃ©ments de donnÃ©es par hÃ´te, et approximativement chaque Ã©lÃ©ment de donnÃ©es contenait un dÃ©clencheur - de sorte qu'il s'agissait d'une vÃ©ritable configuration.  Parfois, il faut mÃªme plus d'un dÃ©clencheur pour l'utiliser. <br><br><img src="https://habrastorage.org/webt/9e/z0/os/9ez0os1zg6wv3k3d176svhoauqe.jpeg"><br><br>  J'ai rÃ©gulÃ© l'intervalle de mise Ã  jour, la charge elle-mÃªme de sorte que j'ai non seulement utilisÃ© 50 agents (ajoutÃ©s plus), mais aussi Ã  l'aide d'Ã©lÃ©ments de donnÃ©es dynamiques et rÃ©duit l'intervalle de mise Ã  jour Ã  4 secondes. <br><br><h3>  Test de performance.  PostgreSQL: 36 000 NVP </h3><br>  Le premier lancement, la premiÃ¨re configuration que j'ai eue sur PostreSQL 10 pur sur ce matÃ©riel (35 000 valeurs par seconde).  En gÃ©nÃ©ral, comme vous pouvez le voir Ã  l'Ã©cran, l'insertion de donnÃ©es prend des fractions de seconde - tout va bien et rapidement, les SSD (200 gigaoctets).  La seule chose est que 20 Go se remplissent rapidement. <br><br><img src="https://habrastorage.org/webt/st/er/oh/sterohufqkrwjzwicbau9fxyeg8.jpeg"><br><br>  Il y aura beaucoup plus de tels graphiques.  Il s'agit du tableau de bord de performances standard du serveur Zabbix. <br><br><img src="https://habrastorage.org/webt/2m/31/jy/2m31jys-j4bm3ocrwo7bqtp5ftu.jpeg"><br><br>  Le premier graphique est le nombre de valeurs par seconde (bleu, en haut Ã  gauche), 35 000 valeurs dans ce cas.  Ce (centre de chargement) est le chargement des processus d'assemblage, et celui (en haut Ã  droite) charge les processus internes: les synchroniseurs d'historique et la femme de mÃ©nage, qui fonctionnent ici depuis un temps suffisant. <br><br>  Ce graphique (en bas au centre) montre l'utilisation de ValueCache - combien de hits ValueCache pour les dÃ©clencheurs (plusieurs milliers de valeurs par seconde).  Un autre graphique important est le quatriÃ¨me (en bas Ã  gauche), qui montre l'utilisation de HistoryCache, dont j'ai parlÃ©, qui est un tampon avant l'insertion dans la base de donnÃ©es. <br><br><h3>  Test de performance.  PostgreSQL: 50 000 NVP </h3><br>  Ensuite, j'ai augmentÃ© la charge Ã  50 000 valeurs par seconde sur le mÃªme matÃ©riel.  Lors du chargement avec Hauskiper, 10 000 valeurs ont dÃ©jÃ  Ã©tÃ© enregistrÃ©es en 2-3 secondes avec le calcul.  Ce qui, en fait, est illustrÃ© dans la capture d'Ã©cran suivante: <br><br><img src="https://habrastorage.org/webt/z7/ml/st/z7mlstfkfw8weobkfvj83zxy4w4.jpeg"><br><br>  Hauskiper commence dÃ©jÃ  Ã  interfÃ©rer avec le travail, mais en gÃ©nÃ©ral, le chargement des trappeurs d'histoire est toujours Ã  60% (troisiÃ¨me graphique, en haut Ã  droite).  HistoryCache dÃ©jÃ  pendant le travail de "Hauskiper" commence Ã  se remplir activement (en bas Ã  gauche).  C'Ã©tait environ un demi-gigaoctet, rempli Ã  20%. <br><br><img src="https://habrastorage.org/webt/mk/-k/q4/mk-kq4jre2iwk-6fdt9xlejoaje.jpeg"><br><br><h3>  Test de performance.  PostgreSQL: 80 000 NVP </h3><br>  A augmentÃ© Ã  80 000 valeurs par seconde: <br><br><img src="https://habrastorage.org/webt/7g/zj/jq/7gzjjqaa68jpj_9yltg7mhfvz0a.jpeg"><br><br>  Il s'agissait d'environ 400 000 Ã©lÃ©ments de donnÃ©es, 280 000 dÃ©clencheurs.  L'insert, comme vous pouvez le voir, pour le chargement des plombs historiques (il y en avait 30) Ã©tait dÃ©jÃ  assez Ã©levÃ©.  De plus, j'ai augmentÃ© divers paramÃ¨tres: lesteurs d'historique, cache ... Sur ce matÃ©riel, le chargement des lesteurs d'histoire a commencÃ© Ã  augmenter au maximum, presque Â«sur l'Ã©tagÃ¨reÂ» - en consÃ©quence, HistoryCache est passÃ© Ã  une charge trÃ¨s Ã©levÃ©e: <br><br><img src="https://habrastorage.org/webt/xd/3z/ky/xd3zkydh5zu-vkewwstgk12qc-s.jpeg"><br><br>          (  ,  )  ,      â€“         ,    . Â«Â»        ,       , â€¦ <br><br><img src="https://habrastorage.org/webt/d7/3l/2z/d73l2zoa7tqmhkjoji9z4hx1poy.jpeg"><br><br>    ,    48  128   : <br><br><img src="https://habrastorage.org/webt/-x/-b/9d/-x-b9dzzor5kwaba8sloo01yhk0.jpeg"><br><br>    Â«Â» â€“  History syncer (60 )    .    Â« Â»,   , ,  ,    -   . <br><br><h3>  . TimescaleDB: 80  NVPs </h3><br>      â€“  TimescaleDB.     : <br><br><img src="https://habrastorage.org/webt/zr/2l/hb/zr2lhbdocfwqknn3sgd_4agzsus.jpeg"><br><br>   â€“    .    Â«Â»-   -,   ,   .    3         HistoryCache â€“ ,      .  , 80     â€“    rate (,   Â«Â»).      setup,   . <br><br><h3>   PostgreSQL: 120  NVPs </h3><br>              125   : <br><br><img src="https://habrastorage.org/webt/cd/ay/e6/cdaye6egnxctvuobxadw6hf7bhw.jpeg"><br><br>    : <br><br><img src="https://habrastorage.org/webt/ts/di/fg/tsdifgr_chfu20nox8il6o2dtha.jpeg"><br><br>     setup,      .          1,5 ,       .  ,         TimescaleDB,       ,     MySQL. <br><br>    ,          ,     .     !    â€“   TimescaleDB.   : 120    . <br><br>    Â«Â» : <br><br><img src="https://habrastorage.org/webt/rz/rn/m-/rzrnm-wfnbq8unwrcvozg8neccy.jpeg"><br><br>    TimescaleDB     io.weight   ;          TimescaleDB.     ,        ( SSD)! <br><br>  -  setup',     , TimescaleDB,   ,   .       ,         . <br><br>      : Conference â€“  , Summit â€“  .    â€“ Â«Â», , IRC.     -  â€“     ,    . <br><br><h3>   </h3><br>    ( â€“ ): â€“  TimescaleDB    ,      , , ,        Â«Â»  Â«Â»?    -      ,  -,      Â«Â»,     Â«Â»,   Â«Â» ,        ? <br><br><img src="https://habrastorage.org/webt/5j/k8/og/5jk8ogejgbixfe_a0tfxzh8vbmw.jpeg"><br><br> <b>:</b> â€“ ,   ,    :  Â«Â»    TimescaleDB.    ,   ,   ,   Â«Â» .      ,     ( TimescaleDB),   ,    !    ,        ,  . <br><br>           Â«Â»:       - .        ,         .         setup'.    MySQLâ€¦   setup'    . <br><br> <b>:</b> â€“   ,   community,    Â«Â»: <br><br><img src="https://habrastorage.org/webt/xh/pg/0j/xhpg0jw0a7davjqyru9gqg7xnx8.jpeg"><br><br>   .  Â«Â»     TimescaleDB? <br><br> <b>:</b> â€“      â€“      .     TimescaleDB    ,  - .         .      . <br><br> <b>:</b> â€“     â€“      Â«Â». <br>  (  ): â€“      ,      delete,       â€“ , ,     .  Â«Â»,     ,   .  ,    ,    big data: Â«!Â» <br><br> Â«Â»  ,     .        ,        select'       ,      â€“ Â«    !Â» ( ).   !         ,   . <br><br> <b>:</b> â€“     SQL.   , Â«Â»     ,    â€“ -  .     ,      ,      , ,  â€“ Clickhouse, , - -?.. Kafka â€“    !    - ? <br><br> <b>:</b> â€“   .     Â«Â»   3.4:        , ,  ;   -      .           .   -     ,      ,       Â«Â».     , , ,   NoSQL- (,  Â«Â»)  . <br><br> <b>:</b> â€“ , ,     ? <br><br> <b>:</b> â€“ ,     Â«Â» â€“   ,     ,  .   ,               -   ,     , ,  . <br><br> <b>:</b> â€“  ,     ,    Â«Â», ? <br><br> <b>:</b> â€“   . ,           , ,  Â«Â»   ,     .  .    :       .  â€“  ,       â€“ Grafana   -. <br><br> <b>:</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Autrement dit, nous parlons d'une lutte Ã©gale, et non du grand avantage de ces bases de donnÃ©es rapides? </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AG:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Je pense que lorsque nous nous intÃ©grerons, il y aura des tests plus prÃ©cis. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - OÃ¹ est passÃ© le bon vieux RRD? </font><font style="vertical-align: inherit;">Qu'est-ce qui vous a fait passer aux bases de donnÃ©es SQL? </font><font style="vertical-align: inherit;">Initialement, sur RRD, toutes les mesures ont Ã©tÃ© collectÃ©es. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AG:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Dans le RRD Â«ZabbixÂ», c'Ã©tait peut-Ãªtre dans une version trÃ¨s ancienne. </font><font style="vertical-align: inherit;">Il y a toujours eu des bases de donnÃ©es SQL - une approche classique. </font><font style="vertical-align: inherit;">L'approche classique est MySQL, PostgreSQL (ils existent dÃ©jÃ  depuis longtemps). </font><font style="vertical-align: inherit;">Nous avons une interface commune pour les bases de donnÃ©es SQL et RRD, que nous n'avons presque jamais utilisÃ©es.</font></font><br><br><img src="https://habrastorage.org/webt/a4/oi/25/a4oi25ls8s9shibkxhx1ckuxfqk.jpeg"><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/umRk94j5M8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Un peu de publicitÃ© :) </h3><br>  Merci de rester avec nous.  Aimez-vous nos articles?  Vous voulez voir des matÃ©riaux plus intÃ©ressants?  Soutenez-nous en passant une commande ou en recommandant Ã  vos amis <a href="https://ua-hosting.company/cloudvps/nl">des VPS basÃ©s sur le cloud pour les dÃ©veloppeurs Ã  partir de 4,99 $</a> , un <b>analogue unique de serveurs d'entrÃ©e de gamme que nous avons inventÃ©s pour vous:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">Toute la vÃ©ritÃ© sur les VPS (KVM) E5-2697 v3 (6 cÅ“urs) 10 Go DDR4 480 Go SSD 1 Gbit / s Ã  partir de 19 $ ou comment diviser le serveur?</a>  (les options sont disponibles avec RAID1 et RAID10, jusqu'Ã  24 cÅ“urs et jusqu'Ã  40 Go de DDR4). <br><br>  <b>Dell R730xd 2 fois moins cher au centre de donnÃ©es Equinix Tier IV Ã  Amsterdam?</b>  Nous avons seulement <b><a href="https://ua-hosting.company/serversnl">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV Ã  partir de 199 $</a> aux Pays-Bas!</b>  <b><b>Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - Ã  partir de 99 $!</b></b>  Pour en savoir plus sur la <a href="https://habr.com/company/ua-hosting/blog/329618/">crÃ©ation d'un bÃ¢timent d'infrastructure.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">classe utilisant des serveurs Dell R730xd E5-2650 v4 coÃ»tant 9 000 euros pour un sou?</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485470/">https://habr.com/ru/post/fr485470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485458/index.html">Silencieux d'obusier</a></li>
<li><a href="../fr485460/index.html">20 bibliothÃ¨ques pour une application iOS spectaculaire</a></li>
<li><a href="../fr485462/index.html">Nous traitons avec eSIM (+ entretien avec un expert)</a></li>
<li><a href="../fr485464/index.html">Mon premier jeu html5, d'Alice Yandex et de rÃ©compenses aux applications mobiles</a></li>
<li><a href="../fr485468/index.html">Variante de travail avec les sockets web dans iOS dans Swift / A Ã©crit un gestionnaire pour travailler avec websocket</a></li>
<li><a href="../fr485472/index.html">Quoi de neuf Ã  attendre d'AMD?</a></li>
<li><a href="../fr485476/index.html">Tendances et trading sur la bourse: 4 indicateurs populaires d'analyse technique</a></li>
<li><a href="../fr485480/index.html">Colonne portable Z-poject Doublebeef - double mono en russe. Test, dÃ©montage et mise Ã  niveau</a></li>
<li><a href="../fr485482/index.html">3 problÃ¨mes de transfert de donnÃ©es vers Google Analytics via le protocole de mesure</a></li>
<li><a href="../fr485484/index.html">[Case Locomizer] Quelles connaissances peuvent rÃ©ellement Ãªtre extraites d'un ensemble de donnÃ©es anonyme avec les coordonnÃ©es de l'utilisateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>