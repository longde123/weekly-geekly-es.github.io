<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüíº üöÖ üë®üèΩ‚Äç‚öïÔ∏è HighLoad ++, Andrey Gushchin (Zabbix): hautes performances et partitionnement natif üîí üòí ‚òÅÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous verrons comment Zabbix fonctionne avec la base de donn√©es TimescaleDB en tant que backend. Nous montrons comment repartir de z√©ro et comment migr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Andrey Gushchin (Zabbix): hautes performances et partitionnement natif</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/485470/">  Nous verrons comment Zabbix fonctionne avec la base de donn√©es TimescaleDB en tant que backend.  Nous montrons comment repartir de z√©ro et comment migrer avec PostgreSQL.  Nous donnons √©galement des tests de performance comparatifs des deux configurations. <br><br><img src="https://habrastorage.org/webt/h4/jl/nw/h4jlnwupm_dewx7jasafurn-ibm.jpeg"><br><br>  HighLoad ++ Siberia 2019. Salle Tomsk.  24 juin, 16h00.  R√©sum√©s et <a href="https://www.highload.ru/siberia/2019/abstracts/5390">pr√©sentation</a> .  La prochaine conf√©rence HighLoad ++ se tiendra les 6 et 7 avril 2020 √† Saint-P√©tersbourg.  D√©tails et billets <a href="http://bit.ly/2sSxgBx">ici</a> . <br><br>  <b>Andrey Gushchin (ci</b> - <b>apr√®s</b> d√©nomm√© <b>AG):</b> - Je suis ing√©nieur du support technique ZABBIX (ci-apr√®s d√©nomm√© Zabbix), un formateur.  Je travaille dans le support technique depuis plus de 6 ans et j'ai √©t√© directement confront√© √† la performance.  Aujourd'hui, je vais parler des performances que TimescaleDB peut donner par rapport √† PostgreSQL 10. Par ailleurs, une partie introductive - sur la fa√ßon dont cela fonctionne. <a name="habracut"></a><br><br><h3>  Principaux d√©fis de performance: de la collecte au nettoyage des donn√©es </h3><br>  Pour commencer, il existe certains d√©fis de performances que chaque syst√®me de surveillance rencontre.  Le premier d√©fi de performance est la collecte et le traitement rapides des donn√©es. <br><br><img src="https://habrastorage.org/webt/jl/xr/hv/jlxrhv3huan1s0w4otmxoknifzy.jpeg"><br><br>  Un bon syst√®me de surveillance doit recevoir rapidement et en temps opportun toutes les donn√©es, les traiter selon des expressions de d√©clenchement, c'est-√†-dire les traiter selon certains crit√®res (dans diff√©rents syst√®mes, c'est diff√©rent) et les enregistrer dans la base de donn√©es afin d'utiliser ces donn√©es √† l'avenir. <br><br><img src="https://habrastorage.org/webt/d5/vq/-l/d5vq-lgcwljaq50nc-zxfeugi3k.jpeg"><br><br>  Le deuxi√®me d√©fi de performance est de garder l'histoire.  Stockez souvent dans la base de donn√©es et acc√©dez rapidement et facilement √† ces mesures qui ont √©t√© collect√©es sur une p√©riode de temps.  La chose la plus importante est qu'il est pratique d'obtenir ces donn√©es, de les utiliser dans des rapports, des graphiques, des d√©clencheurs, dans certaines valeurs de seuil, pour des alertes, etc. <br><br><img src="https://habrastorage.org/webt/k2/1l/3g/k21l3gg3vmeayv-d8oqpatgssv8.jpeg"><br><br>  Le troisi√®me d√©fi en termes de performances consiste √† effacer l'histoire, c'est-√†-dire lorsque votre journ√©e est telle que vous n'avez pas besoin de stocker des statistiques d√©taill√©es qui ont √©t√© collect√©es sur 5 ans (voire des mois ou deux mois).  Certains n≈ìuds de r√©seau ont √©t√© supprim√©s ou certains h√¥tes, les mesures ne sont plus n√©cessaires car elles sont d√©j√† obsol√®tes et ne sont plus collect√©es.  Tout cela doit √™tre nettoy√© pour que votre base de donn√©es ne s'agrandisse pas.  En g√©n√©ral, l'effacement de l'historique est le plus souvent un test s√©rieux pour le stockage - tr√®s souvent, il affecte les performances. <br><br><h3>  Comment r√©soudre les probl√®mes de mise en cache? </h3><br>  Je vais maintenant parler sp√©cifiquement du Zabbix.  Dans Zabbix, les premier et deuxi√®me appels sont r√©solus √† l'aide de la mise en cache. <br><br><img src="https://habrastorage.org/webt/mg/2b/tb/mg2btblcs3cxvlnddc0yg6lwxrw.jpeg"><br><br>  Collecte et traitement des donn√©es - nous utilisons la RAM pour stocker toutes ces donn√©es.  Maintenant, ces donn√©es seront discut√©es plus en d√©tail. <br><br>  Du c√¥t√© de la base de donn√©es, il existe √©galement une certaine mise en cache pour les principaux √©chantillons - pour les graphiques, etc. <br><br>  Mise en cache du c√¥t√© du serveur Zabbix lui-m√™me: nous avons ConfigurationCache, ValueCache, HistoryCache, TrendsCache.  Qu'est ce que c'est <br><br><img src="https://habrastorage.org/webt/6j/4e/_a/6j4e_acyhx8ldzgjfziqhuzvwz0.jpeg"><br><br>  ConfigurationCache est le cache principal dans lequel nous stockons les m√©triques, les h√¥tes, les √©l√©ments de donn√©es, les d√©clencheurs;  tout ce dont vous avez besoin pour traiter le pr√©traitement, collecter les donn√©es, aupr√®s de quels h√¥tes collecter, avec quelle fr√©quence.  Tout cela est stock√© dans ConfigurationCache, afin de ne pas aller dans la base de donn√©es, de ne pas cr√©er de requ√™tes inutiles.  Apr√®s le d√©marrage du serveur, nous mettons √† jour ce cache (cr√©er) et le mettons √† jour p√©riodiquement (en fonction des param√®tres de configuration). <br><br><img src="https://habrastorage.org/webt/q1/zc/dg/q1zcdgan2c5rcep47ebef24xrn0.jpeg"><br><br><h3>  Mise en cache dans Zabbix.  Collecte de donn√©es </h3><br>  Ici, le sch√©ma est assez grand: <br><br><img src="https://habrastorage.org/webt/88/mh/gd/88mhgd974zcj8eou8kghhodhwf0.jpeg"><br><br>  Les principaux dans le sch√©ma sont ces collecteurs: <br><br><img src="https://habrastorage.org/webt/2y/co/f7/2ycof750qb71iooc2qiahs-5i9y.jpeg"><br><br>  Ce sont les processus d'assemblage eux-m√™mes, divers ¬´scrutateurs¬ª qui sont responsables de diff√©rents types d'assemblages.  Ils collectent des donn√©es via icmp, ipmi, selon diff√©rents protocoles et transf√®rent le tout au pr√©traitement. <br><br><h3>  Historique de pr√©traitement </h3><br>  De plus, si nous avons des √©l√©ments de donn√©es calcul√©s (qui sait Zabbix - sait), c'est-√†-dire des √©l√©ments de donn√©es calcul√©s et agr√©g√©s, nous les prenons directement de ValueCache.  Je dirai plus tard comment il est rempli.  Tous ces collecteurs utilisent ConfigurationCache pour obtenir leurs travaux, puis les passent au pr√©traitement. <br><br><img src="https://habrastorage.org/webt/b4/qb/mh/b4qbmhsqtxvrfli40n-espjba6c.jpeg"><br><br>  Le pr√©traitement utilise √©galement ConfigurationCache pour obtenir les √©tapes de pr√©traitement; il traite ces donn√©es de diff√©rentes mani√®res.  √Ä partir de la version 4.2, nous l'avons soumis au proxy.  C'est tr√®s pratique, car le pr√©traitement lui-m√™me est une op√©ration assez difficile.  Et si vous avez un tr√®s gros "Zabbix", avec un grand nombre d'√©l√©ments de donn√©es et une fr√©quence de collecte √©lev√©e, cela facilite grandement le travail. <br><br>  En cons√©quence, apr√®s avoir trait√© ces donn√©es d'une mani√®re ou d'une autre en utilisant le pr√©traitement, nous les enregistrons dans HistoryCache afin de les traiter plus en d√©tail.  Cela met fin √† la collecte de donn√©es.  Nous passons au processus principal. <br><br><h3>  Fonctionnement du synchroniseur d'historique </h3><br><img src="https://habrastorage.org/webt/40/yj/9-/40yj9-h-hgm5wcd2hu2ygt5uyp4.jpeg"><br><br>  Le principal processus de Zabbix (car il s'agit d'une architecture monolithique) est le synchroniseur d'histoire.  Il s'agit du processus principal qui traite sp√©cifiquement du traitement atomique de chaque √©l√©ment de donn√©es, c'est-√†-dire de chaque valeur: <br><br><ul><li>  la valeur vient (elle le prend de HistoryCache); </li><li>  v√©rifie dans le synchroniseur de configuration: existe-t-il des d√©clencheurs de calcul? les calcule; <br>  s'il y en a, il cr√©e des √©v√©nements, cr√©e une escalade afin de cr√©er une alerte, si n√©cessaire par configuration; </li><li>  enregistre les d√©clencheurs pour le traitement ult√©rieur, l'agr√©gation;  si vous agr√©gez au cours de la derni√®re heure et ainsi de suite, cette valeur se souvient de ValueCache, afin de ne pas acc√©der √† la table d'historique;  Ainsi, ValueCache est rempli avec les donn√©es n√©cessaires qui sont n√©cessaires pour calculer les d√©clencheurs, les √©l√©ments calcul√©s, etc. </li><li>  puis le synchroniseur d'historique √©crit toutes les donn√©es dans la base de donn√©es; </li><li>  la base de donn√©es les √©crit sur le disque - c'est l√† que le processus de traitement se termine. </li></ul><br><h3>  Bases de donn√©es  Mise en cache </h3><br>  Du c√¥t√© de la base de donn√©es, lorsque vous souhaitez consulter des graphiques ou des rapports d'√©v√©nements, il existe plusieurs caches.  Mais dans le cadre de ce rapport, je n'en parlerai pas. <br><br>  Pour MySQL, il y a Innodb_buffer_pool, un tas de caches diff√©rents qui peuvent √©galement √™tre configur√©s. <br>  Mais ce sont les principaux: <br><br><ul><li>  shared_buffers; </li><li>  effective_cache_size; </li><li>  shared_pool. </li></ul><br><img src="https://habrastorage.org/webt/fw/7n/0z/fw7n0ziowm_jbvs--peokkswjdw.jpeg"><br><br>  J'ai cit√© pour toutes les bases de donn√©es qu'il existe certains caches qui vous permettent de garder en m√©moire les donn√©es qui sont souvent n√©cessaires pour les requ√™tes.  L√†, ils ont leurs propres technologies pour cela. <br><br><h3>  √Ä propos des performances de la base de donn√©es </h3><br>  En cons√©quence, il existe un environnement concurrentiel, c'est-√†-dire que le serveur Zabbix collecte des donn√©es et les enregistre.  Lors du red√©marrage, il lit √©galement √† partir de l'historique pour remplir ValueCache et ainsi de suite.  Ici, vous pouvez avoir des scripts et des rapports qui utilisent l'API Zabbix, qui est construite sur la base de l'interface Web.  "Zabbiks" -API est inclus dans la base de donn√©es et re√ßoit les donn√©es n√©cessaires pour obtenir des graphiques, des rapports ou une liste d'√©v√©nements, des probl√®mes r√©cents. <br><br><img src="https://habrastorage.org/webt/gr/to/vp/grtovpkr0x6kkytkg5bw2zllpqw.jpeg"><br><br>  Grafana est √©galement une solution de visualisation tr√®s populaire, utilis√©e par nos utilisateurs.  Capable d'entrer directement √† la fois via "Zabbiks" -API et via la base de donn√©es.  Cela cr√©e √©galement une certaine concurrence pour obtenir des donn√©es: un r√©glage plus fin et meilleur de la base de donn√©es est n√©cessaire pour correspondre √† la livraison rapide des r√©sultats et des tests. <br><br><img src="https://habrastorage.org/webt/aj/ak/l-/ajakl-q1nyal8mce-xw4snwrgye.jpeg"><br><br><h3>  Effacer l'histoire.  Zabbix a femme de m√©nage </h3><br>  Le troisi√®me d√©fi utilis√© par Zabbix est de clarifier l'histoire avec Housekeeper.  Hauskiper respecte tous les param√®tres, c'est-√†-dire que dans nos √©l√©ments de donn√©es, il est indiqu√© combien stocker (en jours), combien stocker les tendances, la dynamique des changements. <br><br>  Je n'ai pas parl√© de TrendCache, que nous calculons √† la vol√©e: les donn√©es arrivent, nous les agr√©gons en une heure (en gros ce sont des chiffres dans la derni√®re heure), le montant est moyen / minimum et l'√©crivons une fois par heure dans le tableau des changements de dynamique (Tendances) .  Hauskiper d√©marre et supprime les donn√©es de la base de donn√©es √† l'aide de s√©lections r√©guli√®res, ce qui n'est pas toujours efficace. <br><br>  Comment comprendre qu'elle est inefficace?  Vous pouvez voir l'image suivante sur les graphiques de performances des processus internes: <br><br><img src="https://habrastorage.org/webt/cw/au/u3/cwauu3n4dk0-u_nonnfzbf0og6g.jpeg"><br><br>  Votre synchroniseur d'historique est constamment occup√© (graphique rouge).  Et le tableau "rouge" qui va en haut.  Il s'agit du Hauskiper, qui d√©marre et attend la base de donn√©es lorsqu'il supprime toutes les lignes qu'il a sp√©cifi√©es. <br><br>  Prenez un ID d'article: vous devez supprimer les 5 000 derniers;  Bien s√ªr, par indices.  Mais g√©n√©ralement, l'ensemble de donn√©es est suffisamment volumineux - la base de donn√©es lit toujours cela √† partir du disque et le place dans le cache, et c'est une op√©ration tr√®s co√ªteuse pour la base de donn√©es.  Selon sa taille, cela peut entra√Æner certains probl√®mes de performances. <br><br>  Vous pouvez d√©sactiver Hauskiper de mani√®re simple - nous avons une interface Web famili√®re pour tout le monde.  En param√©trant l'administration g√©n√©rale (param√®tres de ¬´Gouvernante¬ª), nous d√©sactivons la gestion interne pour l'historique et les tendances internes.  En cons√©quence, Hauskiper ne contr√¥le plus cela: <br><br><img src="https://habrastorage.org/webt/cp/si/jo/cpsijomx2kl2p1trw0it8ujvpga.jpeg"><br><br>  Que puis-je faire ensuite?  Vous vous √™tes d√©connect√©, vos plannings se sont nivel√©s ... Quels probl√®mes peuvent √™tre plus pouss√©s dans ce cas?  Qu'est-ce qui peut aider? <br><br><h3>  Partitionnement (partitionnement) </h3><br>  Ceci est g√©n√©ralement configur√© sur chaque base de donn√©es relationnelle que j'ai r√©pertori√©e d'une mani√®re diff√©rente.  MySQL poss√®de sa propre technologie.  Mais dans l'ensemble, ils sont tr√®s similaires en ce qui concerne PostgreSQL 10 et MySQL.  Bien s√ªr, il existe de nombreuses diff√©rences internes dans la fa√ßon dont tout est mis en ≈ìuvre et comment tout cela affecte les performances.  Mais en g√©n√©ral, la cr√©ation d'une nouvelle partition entra√Æne souvent aussi certains probl√®mes. <br><br><img src="https://habrastorage.org/webt/g3/ru/gs/g3rugs9kazu4fcyk70inqtrnrd4.jpeg"><br><br>  Selon votre configuration (la quantit√© de donn√©es que vous cr√©ez en une journ√©e), ils d√©finissent g√©n√©ralement le minimum un - 1 jour / partition, et pour les tendances, la dynamique des changements - 1 mois / nouvelle partition.  Cela peut changer si vous avez une tr√®s grande configuration. <br><br>  Disons tout de suite la taille de la configuration: jusqu'√† 5 000 nouvelles valeurs par seconde (appel√©es nvps) - cela sera consid√©r√© comme une petite ¬´configuration¬ª.  Moyenne - de 5 √† 25 000 valeurs par seconde.  Tout ce qui est au-dessus est d√©j√† des installations grandes et tr√®s grandes qui n√©cessitent une configuration tr√®s soign√©e de la base de donn√©es elle-m√™me. <br><br>  Sur les tr√®s grandes installations, 1 jour - cela peut ne pas √™tre optimal.  Personnellement, j'ai vu sur des partitions MySQL de 40 gigaoctets par jour (et il peut y en avoir plus).  Il s'agit d'une tr√®s grande quantit√© de donn√©es, ce qui peut entra√Æner certains probl√®mes.  Elle doit √™tre r√©duite. <br><br><h3>  Pourquoi partitionner? </h3><br>  Ce que le partitionnement donne, je pense que tout le monde le sait, c'est le partitionnement de table.  Il s'agit souvent de fichiers distincts sur les demandes de disque et d'√©tendue.  Il s√©lectionne de mani√®re plus optimale une partition, si elle fait partie de la partition habituelle. <br><br><img src="https://habrastorage.org/webt/nd/u2/6a/ndu26acwf_st_axq0rfws4t0yhu.jpeg"><br><br>  Pour Zabbix, en particulier, il est utilis√© par plage, par plage, c'est-√†-dire que nous utilisons un horodatage (le nombre est ordinaire, le temps depuis le d√©but de l'√®re).  Vous sp√©cifiez le d√©but du jour / la fin de la journ√©e, et ceci est une partition.  Par cons√©quent, si vous faites une demande de donn√©es il y a deux jours, tout cela est s√©lectionn√© plus rapidement dans la base de donn√©es, car vous n'avez besoin de t√©l√©charger qu'un fichier dans le cache et le probl√®me (plut√¥t qu'une grande table). <br><br><img src="https://habrastorage.org/webt/n8/-5/h0/n8-5h0inf3gdrt6fv2jaqeguoxm.jpeg"><br><br>  De nombreuses bases de donn√©es acc√©l√®rent √©galement l'insertion (insertion dans une seule table enfant).  Bien que je parle de fa√ßon abstraite, mais c'est aussi possible.  Le partage est souvent utile. <br><br><h3>  Elasticsearch pour NoSQL </h3><br>  R√©cemment, en 3.4, nous avons impl√©ment√© une solution pour NoSQL.  Ajout de la possibilit√© d'√©crire dans Elasticsearch.  Vous pouvez √©crire quelques types distincts: choisissez - soit √©crire des nombres ou des signes;  nous avons un texte de cha√Æne, vous pouvez √©crire des journaux dans Elasticsearch ... En cons√©quence, l'interface Web acc√©dera √©galement √† Elasticsearch.  Cela fonctionne bien dans certains cas, mais pour le moment, il peut √™tre utilis√©. <br><br><img src="https://habrastorage.org/webt/xq/f_/kc/xqf_kcj7pttjfkqtvykodkhf1ne.jpeg"><br><br><h3>  TimescaleDB.  Hypertables </h3><br>  Pour 4.4.2, nous avons remarqu√© une chose comme TimescaleDB.  Qu'est ce que c'est  Il s'agit d'une extension pour Postgres, c'est-√†-dire qu'elle a une interface PostgreSQL native.  De plus, cette extension vous permet de travailler avec des donn√©es de s√©rie temporelle beaucoup plus efficacement et d'avoir un partitionnement automatique.  √Ä quoi √ßa ressemble: <br><br><img src="https://habrastorage.org/webt/_q/nk/mz/_qnkmz4mbfzhveegk3d2hjzgafg.jpeg"><br><br>  C'est hypertable - il y a un tel concept dans Timescale.  Il s'agit de l'hypertable que vous cr√©ez et il contient des morceaux.  Les morceaux sont des partitions, ce sont des tables enfants, si je ne me trompe pas.  C'est vraiment efficace. <br><br><img src="https://habrastorage.org/webt/un/gu/pk/ungupk6uffgezcunuoaa4tjkk0g.jpeg"><br><br><h3>  TimescaleDB et PostgreSQL </h3><br>  Comme les fabricants de TimescaleDB le garantissent, ils utilisent un algorithme de traitement des demandes plus correct, en particulier insert'ov, qui vous permet d'avoir des performances √† peu pr√®s constantes avec une taille croissante de l'insertion de l'ensemble de donn√©es.  Autrement dit, apr√®s 200 millions de lignes de ¬´Postgres¬ª, l'habituel commence √† s'affaisser et perd litt√©ralement les performances √† z√©ro, tandis que ¬´Timescale¬ª vous permet d'ins√©rer des insertions aussi efficacement que possible avec n'importe quelle quantit√© de donn√©es. <br><br><img src="https://habrastorage.org/webt/xo/zb/-o/xozb-o86ammklruo6wbmreoddga.jpeg"><br><br><h3>  Comment installer TimescaleDB?  Tout est simple! </h3><br>  Il l'a dans la documentation, il est d√©crit - il peut √™tre livr√© √† partir de colis pour tout ... Cela d√©pend des colis officiels de Postgres.  Il peut √™tre compil√© manuellement.  Il se trouve que j'ai d√ª compiler pour la base de donn√©es. <br><br><img src="https://habrastorage.org/webt/vm/t8/ab/vmt8ab42ehsl-ne-cxb70skn9ik.jpeg"><br><br>  Chez Zabbix, nous venons d'activer Extention.  Je pense que ceux qui ont utilis√© Extention dans Postgres ... Vous venez d'activer Extention, cr√©ez-le pour la base de donn√©es Zabbix que vous utilisez. <br><br>  Et la derni√®re √©tape ... <br><br><h3>  TimescaleDB.  Tableaux d'historique de migration </h3><br>  Vous devez cr√©er un hypertable.  Il existe une fonction sp√©ciale pour cela - Cr√©er une hypertable.  Dans ce document, le premier param√®tre indique la table qui est n√©cessaire dans cette base de donn√©es (pour laquelle vous devez cr√©er une hypertable). <br><br><img src="https://habrastorage.org/webt/rs/p0/ja/rsp0ja0xplwviw9abiqvsody8zw.jpeg"><br><br>  Le champ par lequel vous souhaitez cr√©er, et chunk_time_interval (c'est l'intervalle des morceaux (partitions √† utiliser). 86 400 est un jour. <br><br>  Param√®tre migrate_data: si vous ins√©rez dans true, cela transf√®re toutes les donn√©es actuelles aux blocs cr√©√©s pr√©c√©demment. <br><br>  J'ai moi-m√™me utilis√© migrate_data - cela prend un temps d√©cent, selon la taille de votre base de donn√©es.  J'avais plus d'un t√©raoctet - la cr√©ation a pris plus d'une heure.  Dans certains cas, lors des tests, j'ai supprim√© les donn√©es historiques du texte (history_text) et de la cha√Æne (history_str), afin de ne pas les transf√©rer - elles n'√©taient pas vraiment int√©ressantes pour moi. <br><br>  Et nous faisons la derni√®re mise √† jour dans notre db_extention: nous d√©finissons timescaledb pour que la base de donn√©es et, en particulier, notre Zabbix comprennent ce qu'est db_extention.  Il l'active et utilise la syntaxe et les requ√™tes de base de donn√©es correctes, en utilisant les ¬´fonctionnalit√©s¬ª n√©cessaires √† TimescaleDB. <br><br><h3>  Configuration du serveur </h3><br>  J'ai utilis√© deux serveurs.  Le premier serveur est une machine virtuelle assez petite, 20 processeurs, 16 gigaoctets de RAM.  Configurez Postgres 10.8 dessus: <br><br><img src="https://habrastorage.org/webt/q_/h-/fe/q_h-fey52vutiin_dcat3zezb1g.jpeg"><br><br>  Le syst√®me d'exploitation √©tait Debian, le syst√®me de fichiers √©tait xfs.  J'ai fait des r√©glages minimaux pour utiliser cette base de donn√©es particuli√®re, moins ce que Zabbix utilisera.  Sur la m√™me machine se trouvait un serveur Zabbix, PostgreSQL et des agents de chargement. <br><br><img src="https://habrastorage.org/webt/vl/jv/bu/vljvbuggjlj1vz5tvptvzsicauo.jpeg"><br><br>  J'ai utilis√© 50 agents actifs qui utilisent le LoadableModule pour g√©n√©rer rapidement divers r√©sultats.  Ils ont g√©n√©r√© des lignes, des nombres, etc.  J'ai obstru√© la base de donn√©es avec beaucoup de donn√©es.  Initialement, la configuration contenait 5 000 √©l√©ments de donn√©es par h√¥te, et approximativement chaque √©l√©ment de donn√©es contenait un d√©clencheur - de sorte qu'il s'agissait d'une v√©ritable configuration.  Parfois, il faut m√™me plus d'un d√©clencheur pour l'utiliser. <br><br><img src="https://habrastorage.org/webt/9e/z0/os/9ez0os1zg6wv3k3d176svhoauqe.jpeg"><br><br>  J'ai r√©gul√© l'intervalle de mise √† jour, la charge elle-m√™me de sorte que j'ai non seulement utilis√© 50 agents (ajout√©s plus), mais aussi √† l'aide d'√©l√©ments de donn√©es dynamiques et r√©duit l'intervalle de mise √† jour √† 4 secondes. <br><br><h3>  Test de performance.  PostgreSQL: 36 000 NVP </h3><br>  Le premier lancement, la premi√®re configuration que j'ai eue sur PostreSQL 10 pur sur ce mat√©riel (35 000 valeurs par seconde).  En g√©n√©ral, comme vous pouvez le voir √† l'√©cran, l'insertion de donn√©es prend des fractions de seconde - tout va bien et rapidement, les SSD (200 gigaoctets).  La seule chose est que 20 Go se remplissent rapidement. <br><br><img src="https://habrastorage.org/webt/st/er/oh/sterohufqkrwjzwicbau9fxyeg8.jpeg"><br><br>  Il y aura beaucoup plus de tels graphiques.  Il s'agit du tableau de bord de performances standard du serveur Zabbix. <br><br><img src="https://habrastorage.org/webt/2m/31/jy/2m31jys-j4bm3ocrwo7bqtp5ftu.jpeg"><br><br>  Le premier graphique est le nombre de valeurs par seconde (bleu, en haut √† gauche), 35 000 valeurs dans ce cas.  Ce (centre de chargement) est le chargement des processus d'assemblage, et celui (en haut √† droite) charge les processus internes: les synchroniseurs d'historique et la femme de m√©nage, qui fonctionnent ici depuis un temps suffisant. <br><br>  Ce graphique (en bas au centre) montre l'utilisation de ValueCache - combien de hits ValueCache pour les d√©clencheurs (plusieurs milliers de valeurs par seconde).  Un autre graphique important est le quatri√®me (en bas √† gauche), qui montre l'utilisation de HistoryCache, dont j'ai parl√©, qui est un tampon avant l'insertion dans la base de donn√©es. <br><br><h3>  Test de performance.  PostgreSQL: 50 000 NVP </h3><br>  Ensuite, j'ai augment√© la charge √† 50 000 valeurs par seconde sur le m√™me mat√©riel.  Lors du chargement avec Hauskiper, 10 000 valeurs ont d√©j√† √©t√© enregistr√©es en 2-3 secondes avec le calcul.  Ce qui, en fait, est illustr√© dans la capture d'√©cran suivante: <br><br><img src="https://habrastorage.org/webt/z7/ml/st/z7mlstfkfw8weobkfvj83zxy4w4.jpeg"><br><br>  Hauskiper commence d√©j√† √† interf√©rer avec le travail, mais en g√©n√©ral, le chargement des trappeurs d'histoire est toujours √† 60% (troisi√®me graphique, en haut √† droite).  HistoryCache d√©j√† pendant le travail de "Hauskiper" commence √† se remplir activement (en bas √† gauche).  C'√©tait environ un demi-gigaoctet, rempli √† 20%. <br><br><img src="https://habrastorage.org/webt/mk/-k/q4/mk-kq4jre2iwk-6fdt9xlejoaje.jpeg"><br><br><h3>  Test de performance.  PostgreSQL: 80 000 NVP </h3><br>  A augment√© √† 80 000 valeurs par seconde: <br><br><img src="https://habrastorage.org/webt/7g/zj/jq/7gzjjqaa68jpj_9yltg7mhfvz0a.jpeg"><br><br>  Il s'agissait d'environ 400 000 √©l√©ments de donn√©es, 280 000 d√©clencheurs.  L'insert, comme vous pouvez le voir, pour le chargement des plombs historiques (il y en avait 30) √©tait d√©j√† assez √©lev√©.  De plus, j'ai augment√© divers param√®tres: lesteurs d'historique, cache ... Sur ce mat√©riel, le chargement des lesteurs d'histoire a commenc√© √† augmenter au maximum, presque ¬´sur l'√©tag√®re¬ª - en cons√©quence, HistoryCache est pass√© √† une charge tr√®s √©lev√©e: <br><br><img src="https://habrastorage.org/webt/xd/3z/ky/xd3zkydh5zu-vkewwstgk12qc-s.jpeg"><br><br>          (  ,  )  ,      ‚Äì         ,    . ¬´¬ª        ,       , ‚Ä¶ <br><br><img src="https://habrastorage.org/webt/d7/3l/2z/d73l2zoa7tqmhkjoji9z4hx1poy.jpeg"><br><br>    ,    48  128   : <br><br><img src="https://habrastorage.org/webt/-x/-b/9d/-x-b9dzzor5kwaba8sloo01yhk0.jpeg"><br><br>    ¬´¬ª ‚Äì  History syncer (60 )    .    ¬´ ¬ª,   , ,  ,    -   . <br><br><h3>  . TimescaleDB: 80  NVPs </h3><br>      ‚Äì  TimescaleDB.     : <br><br><img src="https://habrastorage.org/webt/zr/2l/hb/zr2lhbdocfwqknn3sgd_4agzsus.jpeg"><br><br>   ‚Äì    .    ¬´¬ª-   -,   ,   .    3         HistoryCache ‚Äì ,      .  , 80     ‚Äì    rate (,   ¬´¬ª).      setup,   . <br><br><h3>   PostgreSQL: 120  NVPs </h3><br>              125   : <br><br><img src="https://habrastorage.org/webt/cd/ay/e6/cdaye6egnxctvuobxadw6hf7bhw.jpeg"><br><br>    : <br><br><img src="https://habrastorage.org/webt/ts/di/fg/tsdifgr_chfu20nox8il6o2dtha.jpeg"><br><br>     setup,      .          1,5 ,       .  ,         TimescaleDB,       ,     MySQL. <br><br>    ,          ,     .     !    ‚Äì   TimescaleDB.   : 120    . <br><br>    ¬´¬ª : <br><br><img src="https://habrastorage.org/webt/rz/rn/m-/rzrnm-wfnbq8unwrcvozg8neccy.jpeg"><br><br>    TimescaleDB     io.weight   ;          TimescaleDB.     ,        ( SSD)! <br><br>  -  setup',     , TimescaleDB,   ,   .       ,         . <br><br>      : Conference ‚Äì  , Summit ‚Äì  .    ‚Äì ¬´¬ª, , IRC.     -  ‚Äì     ,    . <br><br><h3>   </h3><br>    ( ‚Äì ): ‚Äì  TimescaleDB    ,      , , ,        ¬´¬ª  ¬´¬ª?    -      ,  -,      ¬´¬ª,     ¬´¬ª,   ¬´¬ª ,        ? <br><br><img src="https://habrastorage.org/webt/5j/k8/og/5jk8ogejgbixfe_a0tfxzh8vbmw.jpeg"><br><br> <b>:</b> ‚Äì ,   ,    :  ¬´¬ª    TimescaleDB.    ,   ,   ,   ¬´¬ª .      ,     ( TimescaleDB),   ,    !    ,        ,  . <br><br>           ¬´¬ª:       - .        ,         .         setup'.    MySQL‚Ä¶   setup'    . <br><br> <b>:</b> ‚Äì   ,   community,    ¬´¬ª: <br><br><img src="https://habrastorage.org/webt/xh/pg/0j/xhpg0jw0a7davjqyru9gqg7xnx8.jpeg"><br><br>   .  ¬´¬ª     TimescaleDB? <br><br> <b>:</b> ‚Äì      ‚Äì      .     TimescaleDB    ,  - .         .      . <br><br> <b>:</b> ‚Äì     ‚Äì      ¬´¬ª. <br>  (  ): ‚Äì      ,      delete,       ‚Äì , ,     .  ¬´¬ª,     ,   .  ,    ,    big data: ¬´!¬ª <br><br> ¬´¬ª  ,     .        ,        select'       ,      ‚Äì ¬´    !¬ª ( ).   !         ,   . <br><br> <b>:</b> ‚Äì     SQL.   , ¬´¬ª     ,    ‚Äì -  .     ,      ,      , ,  ‚Äì Clickhouse, , - -?.. Kafka ‚Äì    !    - ? <br><br> <b>:</b> ‚Äì   .     ¬´¬ª   3.4:        , ,  ;   -      .           .   -     ,      ,       ¬´¬ª.     , , ,   NoSQL- (,  ¬´¬ª)  . <br><br> <b>:</b> ‚Äì , ,     ? <br><br> <b>:</b> ‚Äì ,     ¬´¬ª ‚Äì   ,     ,  .   ,               -   ,     , ,  . <br><br> <b>:</b> ‚Äì  ,     ,    ¬´¬ª, ? <br><br> <b>:</b> ‚Äì   . ,           , ,  ¬´¬ª   ,     .  .    :       .  ‚Äì  ,       ‚Äì Grafana   -. <br><br> <b>:</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Autrement dit, nous parlons d'une lutte √©gale, et non du grand avantage de ces bases de donn√©es rapides? </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AG:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Je pense que lorsque nous nous int√©grerons, il y aura des tests plus pr√©cis. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - O√π est pass√© le bon vieux RRD? </font><font style="vertical-align: inherit;">Qu'est-ce qui vous a fait passer aux bases de donn√©es SQL? </font><font style="vertical-align: inherit;">Initialement, sur RRD, toutes les mesures ont √©t√© collect√©es. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AG:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Dans le RRD ¬´Zabbix¬ª, c'√©tait peut-√™tre dans une version tr√®s ancienne. </font><font style="vertical-align: inherit;">Il y a toujours eu des bases de donn√©es SQL - une approche classique. </font><font style="vertical-align: inherit;">L'approche classique est MySQL, PostgreSQL (ils existent d√©j√† depuis longtemps). </font><font style="vertical-align: inherit;">Nous avons une interface commune pour les bases de donn√©es SQL et RRD, que nous n'avons presque jamais utilis√©es.</font></font><br><br><img src="https://habrastorage.org/webt/a4/oi/25/a4oi25ls8s9shibkxhx1ckuxfqk.jpeg"><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/umRk94j5M8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Un peu de publicit√© :) </h3><br>  Merci de rester avec nous.  Aimez-vous nos articles?  Vous voulez voir des mat√©riaux plus int√©ressants?  Soutenez-nous en passant une commande ou en recommandant √† vos amis <a href="https://ua-hosting.company/cloudvps/nl">des VPS bas√©s sur le cloud pour les d√©veloppeurs √† partir de 4,99 $</a> , un <b>analogue unique de serveurs d'entr√©e de gamme que nous avons invent√©s pour vous:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">Toute la v√©rit√© sur les VPS (KVM) E5-2697 v3 (6 c≈ìurs) 10 Go DDR4 480 Go SSD 1 Gbit / s √† partir de 19 $ ou comment diviser le serveur?</a>  (les options sont disponibles avec RAID1 et RAID10, jusqu'√† 24 c≈ìurs et jusqu'√† 40 Go de DDR4). <br><br>  <b>Dell R730xd 2 fois moins cher au centre de donn√©es Equinix Tier IV √† Amsterdam?</b>  Nous avons seulement <b><a href="https://ua-hosting.company/serversnl">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV √† partir de 199 $</a> aux Pays-Bas!</b>  <b><b>Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - √† partir de 99 $!</b></b>  Pour en savoir plus sur la <a href="https://habr.com/company/ua-hosting/blog/329618/">cr√©ation d'un b√¢timent d'infrastructure.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">classe utilisant des serveurs Dell R730xd E5-2650 v4 co√ªtant 9 000 euros pour un sou?</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485470/">https://habr.com/ru/post/fr485470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485458/index.html">Silencieux d'obusier</a></li>
<li><a href="../fr485460/index.html">20 biblioth√®ques pour une application iOS spectaculaire</a></li>
<li><a href="../fr485462/index.html">Nous traitons avec eSIM (+ entretien avec un expert)</a></li>
<li><a href="../fr485464/index.html">Mon premier jeu html5, d'Alice Yandex et de r√©compenses aux applications mobiles</a></li>
<li><a href="../fr485468/index.html">Variante de travail avec les sockets web dans iOS dans Swift / A √©crit un gestionnaire pour travailler avec websocket</a></li>
<li><a href="../fr485472/index.html">Quoi de neuf √† attendre d'AMD?</a></li>
<li><a href="../fr485476/index.html">Tendances et trading sur la bourse: 4 indicateurs populaires d'analyse technique</a></li>
<li><a href="../fr485480/index.html">Colonne portable Z-poject Doublebeef - double mono en russe. Test, d√©montage et mise √† niveau</a></li>
<li><a href="../fr485482/index.html">3 probl√®mes de transfert de donn√©es vers Google Analytics via le protocole de mesure</a></li>
<li><a href="../fr485484/index.html">[Case Locomizer] Quelles connaissances peuvent r√©ellement √™tre extraites d'un ensemble de donn√©es anonyme avec les coordonn√©es de l'utilisateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>