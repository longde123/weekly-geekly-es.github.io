<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚èÆÔ∏è üöî üéÖüèª Autorisation utilisateur dans Django via GSSAPI et d√©l√©gation de droits utilisateur au serveur üë® üë© üëè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="R√©cemment, mes coll√®gues et moi avons d√ª impl√©menter une autorisation transparente (SSO) dans notre projet. Maintenant, il y a pas mal d'informations ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Autorisation utilisateur dans Django via GSSAPI et d√©l√©gation de droits utilisateur au serveur</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427839/">  R√©cemment, mes coll√®gues et moi avons d√ª impl√©menter une autorisation transparente (SSO) dans notre projet.  Maintenant, il y a pas mal d'informations sur le sujet, surtout en russe.  Pour cette raison, il a √©t√© d√©cid√© de partager avec les descendants la mise en ≈ìuvre d'une telle fonctionnalit√©. <br><br>  La t√¢che √©tait donc la suivante: il fallait configurer une autorisation transparente via GSSAPI de l'utilisateur vers le serveur, puis pouvoir acc√©der √† la base de donn√©es au nom de cet utilisateur. <br><a name="habracut"></a><br>  Nous avions: <br><br><ul><li>  serveur Kerberos + LDAP configur√© </li><li>  Serveur PostgreSQL configur√© pour l'autorisation exclusivement par GSSAPI </li><li>  Serveur d'applications Django + UWSGI + nginx avec Kerberos configur√© </li></ul><br>  Initialement, l'id√©e √©tait de d√©l√©guer l'autorisation utilisateur dans l'application au serveur Web, en configurant l'autorisation GSSAPI dessus, et Django pour indiquer que nous travaillerions avec RemoteUser.  Dans le cadre de cette description, je ne parlerai pas de la fa√ßon de configurer nginx pour qu'il fonctionne sur GSSAPI et Django pour d√©l√©guer l'autorisation √† un serveur Web, ceci est une partie bien document√©e et il y a beaucoup d'articles √† ce sujet.  Apr√®s r√©glage et tests, nous avons r√©alis√© que ce n'√©tait absolument pas ce dont nous avions besoin.  Oui, nous pouvons autoriser et obtenir le nom d'utilisateur principal, mais nous n'avons pas le droit de faire quoi que ce soit au nom de cet utilisateur. <br><br>  Ensuite, nous avons tent√© de trouver quelque chose d'int√©ressant sur Internet.  Ils ont relativement bien r√©ussi et les packages suivants pour Django ont √©t√© trouv√©s: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">django-kerberos</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">django-auth-spnego</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">django-auth-kerbero</a> .  En fait, tous ces packages ont fait la m√™me chose, certains n'ont pas √©t√© mis √† jour depuis longtemps et ont d√ª "danser avec un tambourin" pendant longtemps, de sorte qu'au moins quelque chose a fonctionn√©.  Ils ont fourni les m√™mes fonctionnalit√©s que le bundle nginx (GSSAPI) + Django (RemouteUser).  Tous ont aid√© √† r√©soudre le probl√®me avec leur code source. <br><br>  Ensuite, les packages suivants ont √©t√© trouv√©s pour travailler avec GSSAPI en Python: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ccs-pykerberos</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">python-gssapi</a> , en fait ils importent l'impl√©mentation des standards RFC2744 et RFC4559 en Python.  En utilisant le paquet ccs-pykerberos, nous avons juste r√©ussi √† impl√©menter la fonctionnalit√© pr√©vue, puis je vais montrer un petit code o√π la communication avec LDAP et l'utilisateur est impl√©ment√©e, ainsi qu'une requ√™te vers la base de donn√©es en son nom. <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.shortcuts <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>.response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TemplateResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kerberos <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 def <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(request): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'HTTP_AUTHORIZATION'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.META: kind, initial_client_token = request.META[<span class="hljs-string"><span class="hljs-string">'HTTP_AUTHORIZATION'</span></span>].split(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> kind == <span class="hljs-string"><span class="hljs-string">'Negotiate'</span></span>: service = <span class="hljs-string"><span class="hljs-string">'HTTP@django-server-pricipal.che.ru'</span></span> _ignore_result, krb_context = kerberos.authGSSServerInit(service) kerberos.authGSSServerStep(krb_context, initial_client_token) principal = kerberos.authGSSServerUserName(krb_context) _ignore_result = kerberos.authGSSServerStoreDelegate(krb_context) conn = psycopg2.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>( host=<span class="hljs-string"><span class="hljs-string">'postgresql-server-host'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=principal, dbname=<span class="hljs-string"><span class="hljs-string">'request-db'</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> = conn.<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>("SELECT version()") records = <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: unauthorized_template_name = <span class="hljs-string"><span class="hljs-string">'gssapi_test/unauthorized.html'</span></span> response = TemplateResponse(request, <span class="hljs-string"><span class="hljs-string">'gssapi_test/index.html'</span></span>, status=<span class="hljs-number"><span class="hljs-number">401</span></span>) response[<span class="hljs-string"><span class="hljs-string">'WWW-Authenticate'</span></span>] = <span class="hljs-string"><span class="hljs-string">'Negotiate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response content = {<span class="hljs-string"><span class="hljs-string">'records'</span></span>: records} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render(request, <span class="hljs-string"><span class="hljs-string">'gssapi_test/index.html'</span></span>, content)</code> </pre> <br>  Tout d'abord, nous devons v√©rifier si l'en-t√™te d'autorisation nous a √©t√© donn√©, sinon, nous devons envoyer l'en-t√™te avec Negotiate en r√©ponse, et attendre √† nouveau le jeton de l'utilisateur Negotiate.  Ce jeton ressemble √† un grand footcloth encod√© en base64.  Apr√®s avoir re√ßu le jeton, nous initialisons (autorisons) le serveur de notre application dans le service LDAP √† l'aide de la fonction authGSSServerInit ().  Ensuite, nous autoriserons dans le service LDAP au nom de l'utilisateur, en utilisant la fonction authGSSServerStep () uniquement pour le jeton re√ßu de l'en-t√™te.  Ensuite, nous obtenons le principal de l'utilisateur, que nous utiliserons en tant qu'utilisateur, lors de l'ex√©cution de la requ√™te dans la base de donn√©es.  Et aussi, nous devons cr√©er un cache de bitels Kerberos, qui sera utilis√© automatiquement afin de nous autoriser dans PostgreSQL, la fonction authGSSServerStoreDelegate ().  Cette fonction n'est disponible que dans la derni√®re version de ce paquet, vous devez donc cloner vos sources avec git et build. <br><br>  Le navigateur doit √™tre configur√© pour renvoyer N√©gocier, par d√©faut cette option est d√©sactiv√©e.  Tous les tests ont √©t√© effectu√©s sur Firefox dans CentOS7, et CentOS7 a √©t√© install√© sur tous les serveurs. <br><br>  De plus, nous pouvons avoir un probl√®me dans lequel le cache de tickets g√©n√©r√© par notre fonction ne sera pas visible pour notre processus et, par cons√©quent, nous obtiendrons que l'utilisateur n'√©tait pas autoris√© dans GSSAPI.  Il est r√©solu en d√©finissant la mise en cache des tickets dans krb5.conf.  Juste au cas o√π, je vais donner un exemple de notre configuration: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/krb5.conf</b> <div class="spoiler_text"><pre> <code class="python hljs">includedir /etc/krb5.conf.d/ includedir /var/lib/sss/pubconf/krb5.include.d/ [libdefaults] default_realm = DOMAIN.RU dns_lookup_realm = false dns_lookup_kdc = false rdns = false ticket_lifetime = <span class="hljs-number"><span class="hljs-number">24</span></span>h forwardable = true udp_preference_limit = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">#    -    #default_ccache_name = KEYRING:persistent:%{uid} #    KRB5_KTNAME     default_keytab_name = FILE:/etc/httpd/http.keytab [realms] DOMAIN.RU = { kdc = ldap-server-host.domain.ru:88 master_kdc = ldap-server-host.domain.ru:88 admin_server = ldap-server-host.domain.ru:749 kpasswd_server = ldap-server-host.domain.ru:464 default_domain = domain.ru pkinit_anchors = FILE:/etc/domain/ca.crt } [domain_realm] .domain.ru = DOMAIN.RU domain.ru = DOMAIN.RU .domain.ru = DOMAIN.RU</span></span></code> </pre><br></div></div><br>  Ce morceau de code a √©t√© cr√©√© afin de comprendre comment se d√©roulent l'autorisation et la d√©l√©gation des droits, puis avec cette connaissance, vous pouvez cr√©er des d√©corateurs d'autorisation et des liens de communication avec la base de donn√©es.  Le paquet ccs-pykerberos a √©t√© d√©velopp√© par Apple pour ses besoins internes, respectivement, je fournirai un lien vers leur code, o√π ils l'utiliseront.  Il nous a beaucoup aid√©s √† comprendre qu'ils ont d√©velopp√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ccs-calendarserver / twistedcaldav / authkerb.py</a> <br><br><h4>  Liens utiles </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Configurer Kerberos + LDAP</a> </li><li>  <a href="">Impl√©mentation d'une t√¢che similaire en Java</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Configuration de nginx pour fonctionner sur SPNEGO</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sp√©cification RFC2744</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RFC4559 Sp√©cifications pour SPNEGO</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427839/">https://habr.com/ru/post/fr427839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427821/index.html">Dell Inspiron 5570: ordinateur portable √©conomique pour la maison et le bureau</a></li>
<li><a href="../fr427825/index.html">Slurm-2: le d√©but. Plan de travail. Docker: appareil, Dockerfile, docker-compose</a></li>
<li><a href="../fr427829/index.html">Supervision ou externalisation? Telle est la question</a></li>
<li><a href="../fr427833/index.html">Rapport de la conf√©rence Joker 2018</a></li>
<li><a href="../fr427837/index.html">Les premiers jours dans l'√©quipe de d√©veloppement - comme cela arrive avec nous</a></li>
<li><a href="../fr427841/index.html">Escroquerie Magic Leap</a></li>
<li><a href="../fr427843/index.html">Comment bien dormir et bien dormir</a></li>
<li><a href="../fr427845/index.html">Comment installer un million d'√©toiles dans un iPhone</a></li>
<li><a href="../fr427847/index.html">Curiosit√© et procrastination dans l'apprentissage automatique</a></li>
<li><a href="../fr427849/index.html">Ligne droite avec TM. v3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>