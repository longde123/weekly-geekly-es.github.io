<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ»â€ğŸ¤â€ğŸ‘¨ğŸ¼ ğŸ‘µ ğŸ›• RÃ©duisez le nombre de couches d'architecture de 5 Ã  2 âœ³ï¸ ğŸ’†ğŸ» ğŸ‘¨ğŸ¿â€ğŸ¤â€ğŸ‘¨ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En travaillant sur plusieurs projets open-source, j'ai dÃ©cidÃ© un jour de simplifier ma vie et j'ai dÃ©veloppÃ© le module Upstream pour nginx, ce qui m'a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RÃ©duisez le nombre de couches d'architecture de 5 Ã  2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/417829/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/kw/j7/fd/kwj7fdn4wlfdatsf5joghqb3we8.jpeg" width="400"></div><br>  En travaillant sur plusieurs projets open-source, j'ai dÃ©cidÃ© un jour de simplifier ma vie et j'ai dÃ©veloppÃ© le module Upstream pour nginx, ce qui m'a aidÃ© Ã  supprimer les couches volumineuses de l'architecture multicouche.  Ce fut une expÃ©rience amusante que je veux partager dans cet article.  Mon code est accessible au public ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/tarantool/nginx_upstream_module</a> .  Vous pouvez le rÃ©cupÃ©rer Ã  partir de zÃ©ro ou tÃ©lÃ©charger l'image Docker Ã  partir de ce lien: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">hub.docker.com/r/tarantool/tarantool-nginx</a> . <br><br>  Au programme: <br><br><ul><li>  Introduction et thÃ©orie. </li><li>  Comment utiliser ces technologies. </li><li>  Ã‰valuation des performances. </li><li>  Liens utiles. </li></ul><a name="habracut"></a><br><h2>  Introduction et thÃ©orie </h2><br><img src="https://habrastorage.org/webt/10/rj/x5/10rjx5ayayibzqllg9-u3hdw-ei.png"><br><br>  Voici Ã  quoi ressemble l'architecture de microservice standard.  Les demandes des utilisateurs parviennent via nginx au serveur d'applications.  Il existe une logique mÃ©tier sur le serveur avec laquelle les utilisateurs interagissent. <br><br>  Le serveur d'applications ne stocke pas l'Ã©tat des objets, ils doivent donc Ãªtre stockÃ©s ailleurs.  Vous pouvez utiliser des bases de donnÃ©es pour cela.  Et n'oubliez pas le cache, qui rÃ©duira la latence et accÃ©lÃ©rera la livraison du contenu. <br><br>  Divisez-le en couches: <br><br>  <b>1Ã¨re couche</b> - nginx. <br>  <b>2e couche</b> - serveur d'applications. <br>  <b>3Ã¨me couche</b> - cache. <br>  <b>4Ã¨me couche</b> - proxy de base de donnÃ©es.  Ce proxy est nÃ©cessaire pour garantir la tolÃ©rance aux pannes et maintenir une connexion constante Ã  la base de donnÃ©es. <br>  <b>La 5Ã¨me couche</b> est le serveur de base de donnÃ©es. <br><br>  En pensant Ã  ces couches, j'ai compris comment en exclure certaines.  Pourquoi?  Il y a plusieurs raisons.  J'aime les choses simples et comprÃ©hensibles;  Je n'aime pas supporter un grand nombre de systÃ¨mes diffÃ©rents en production;  et enfin et surtout, moins il y a de couches, moins il y a de points de dÃ©faillance.  En consÃ©quence, j'ai crÃ©Ã© le module Tarantool Upstream sous nginx, ce qui a permis de rÃ©duire le nombre de couches Ã  deux. <br><br><img src="https://habrastorage.org/webt/_j/3g/4a/_j3g4akjywetwlgaayru26ot0vi.png" width="622"><br><br>  Comment Tarantool aide-t-il Ã  rÃ©duire le nombre de couches?  La premiÃ¨re couche est nginx, les deuxiÃ¨me, troisiÃ¨me et cinquiÃ¨me couches remplacent Tarantool.  La quatriÃ¨me couche, le proxy de base de donnÃ©es, est maintenant dans nginx.  L'astuce est que Tarantool est une base de donnÃ©es, un cache et un serveur d'applications, trois en un.  Mon module en amont connecte nginx et Tarantool l'un Ã  l'autre et leur permet de fonctionner de maniÃ¨re transparente sans les trois autres couches. <br><br><img src="https://habrastorage.org/webt/aj/fn/tx/ajfntx13aw0r1hsbopzn9soky50.png"><br><br>  Voici Ã  quoi ressemble le nouveau microservice.  L'utilisateur envoie une demande Ã  REST ou JSON RPC dans nginx avec le module Tarantool Upstream.  Le module peut Ãªtre connectÃ© directement Ã  Tarantool, ou la charge peut Ãªtre Ã©quilibrÃ©e sur plusieurs serveurs Tarantool.  Entre nginx et Tarantool, nous utilisons un protocole efficace basÃ© sur MSGPack.  Vous trouverez plus d'informations dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . <br><br>  Vous pouvez Ã©galement suivre ces liens pour tÃ©lÃ©charger Tarantool et le module nginx.  Mais je vous conseille de les installer via le gestionnaire de paquets de votre distribution ou d'utiliser l'image Docker ( <code>docker pull tarantool/tarantool-nginx</code> ). <br><br>  Images Docker: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">hub.docker.com/r/tarantool/tarantool</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Module amont Tarantool NginX</a> <br><br>  Packages binaires: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tarantool - TÃ©lÃ©charger</a> <br><br>  Code source: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tarantool</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tarantool / nginx_upstream_module</a> <br><br><h2>  Comment utiliser ces technologies </h2><br>  Voici un exemple de fichier nginx.conf.  Comme vous pouvez le voir, il s'agit d'un nginx rÃ©gulier en amont.  Ici, nous avons <code>tnt_pass</code> , qui <code>tnt_pass</code> directement <code>tnt_pass</code> nginx dans quel chemin mettre tarantool en amont. <br><br>  <i>nginx-tnt.conf</i> <br><pre> <code class="hljs pgsql">http { # upstream upstream tnt { <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3301</span></span>; keepalive <span class="hljs-number"><span class="hljs-number">1000</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">8081</span></span>; # gateway <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> /api/<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { tnt_pass_http_request parse_args; tnt_pass tnt; } } }</code> </pre> <br>  Voici les liens vers la documentation: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://nginx.org/en/docs/http/ngx_">nginx.org/en/docs/http/ngx_http_upstream_module.html</a> <br>  <a href="">github.com/tarantool/nginx_upstream_module/blob/master/README.md</a> <br><br>  ConfigurÃ© un tas de nginx et Tarantool, alors quoi?  Nous devons maintenant enregistrer une fonction de gestionnaire pour notre service et la placer dans un fichier.  Je l'ai mis dans le fichier Â«app.luaÂ». <br><br>  Voici un lien vers la documentation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tarantool</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tarantool.io/en/doc/1.9/book/box/data_model/#index</a> <br><br><pre> <code class="hljs powershell">-- Bootstrap Tarantool box.cfg { listen=<span class="hljs-string"><span class="hljs-string">'*:3301'</span></span> } -- Grants box.once(<span class="hljs-string"><span class="hljs-string">'grants'</span></span>, function() box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'read,write,execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'universe'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) -- Global variable hello_str = <span class="hljs-string"><span class="hljs-string">'Hello'</span></span> -- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(http_request)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">local</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello_str</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http_request</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method</span></span></span><span class="hljs-function"> == '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GET</span></span></span><span class="hljs-function">' </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str</span></span></span><span class="hljs-function"> = '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Goodbye</span></span></span><span class="hljs-function">' </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">first</span></span></span><span class="hljs-function">', </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">2</span></span></span><span class="hljs-function">,</span></span> { str .. <span class="hljs-string"><span class="hljs-string">'world!'</span></span> }, http_request.args <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  ConsidÃ©rez maintenant le code Lua. <br><br>  Notre <code>Box.cfg {}</code> indique Ã  Tarantool de commencer Ã  Ã©couter sur le port 3301, mais il peut accepter d'autres paramÃ¨tres. <br><br>  <code>Box.once</code> dit Ã  Tarantool d'appeler une fonction une fois. <br><br>  <code>function api ()</code> est une fonction que j'appellerai bientÃ´t.  Il prend une requÃªte HTTP comme premier argument et renvoie un tableau de valeurs. <br><br>  J'ai enregistrÃ© ce code dans un fichier et l'ai nommÃ© Â«app.luaÂ».  Vous pouvez l'exÃ©cuter en lanÃ§ant simplement l'application Tarantool. <br><br> <code>$&gt; tarantool app.lua</code> <br> <br>  Nous appelons notre fonction Ã  l'aide d'une requÃªte GET.  J'utilise Â«wgetÂ» pour cela.  Par dÃ©faut, Â«wgetÂ» enregistre la rÃ©ponse dans un fichier.  Et pour lire les donnÃ©es du fichier, j'utilise Â«chatÂ». <br><br><pre> <code class="lua hljs">$ wget <span class="hljs-string"><span class="hljs-string">'0.0.0.0:8081/api/do?arg_1=1&amp;arg_2=2'</span></span> $ cat <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>* { â€œidâ€:<span class="hljs-number"><span class="hljs-number">0</span></span>, # â€” unique identifier of the request â€œresultâ€: [ # â€” is what our Tarantool <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> [â€œ</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">first</span></span></span><span class="hljs-function">â€], [2], [{ â€œ</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">â€:{â€œ</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arg_2</span></span></span><span class="hljs-function">â€:â€2",â€</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arg_1</span></span></span><span class="hljs-function">":â€1"} â€œ1â€:â€</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Goodbye</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">world</span></span></span><span class="hljs-function">!â€ }] ]}</span></span></code> </pre> <br><h2>  Ã‰valuation des performances </h2><br>  L'Ã©valuation a Ã©tÃ© rÃ©alisÃ©e sur des donnÃ©es de production.  L'entrÃ©e est un grand objet JSON.  La taille moyenne d'un tel objet est de 2 Ko.  Serveur unique, processeur 4 cÅ“urs, 90 Go de RAM, OS Ubuntu 14.04.1 LTS. <br><br>  Pour ce test, nous utilisons un seul travailleur nginx.  Ce travailleur est un Ã©quilibreur avec un algorithme ROUND-ROBIN simple.  Il Ã©quilibre la charge entre les deux nÅ“uds Tarantool.  La charge est mise Ã  l'Ã©chelle Ã  l'aide du partage. <br><br>  Ces graphiques montrent le nombre de lectures par seconde.  Le graphique supÃ©rieur montre les retards (en millisecondes). <br><br><img src="https://habrastorage.org/webt/ji/ob/ef/jiobefhg74ac5e6u298d755qpak.png"><br><br>  Et ces graphiques montrent le nombre d'opÃ©rations d'Ã©criture par seconde.  Le graphique supÃ©rieur montre les retards (en millisecondes) <br><br><img src="https://habrastorage.org/webt/m0/k1/_i/m0k1_i2pcdkqjsrbwckwpv6g4_e.png"><br><br>  Impressionnant! <br><br>  Dans le prochain article, je parlerai en dÃ©tail de REST et JSON RPC. <br><br>  <i>Version anglaise de l'article: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">hackernoon.com/shrink-the-number-of-tiers-in-a-multitier-architecture-from-5-to-2-c59b7bf46c86</a></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417829/">https://habr.com/ru/post/fr417829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417813/index.html">Zabbix - surveillance des voisins OSPF Ã  l'aide de piÃ¨ges SNMPv3, douleur et dÃ©sespoir</a></li>
<li><a href="../fr417821/index.html">Network Digest: 20 documents d'experts sur les protocoles, les normes et la sÃ©curitÃ© de l'information</a></li>
<li><a href="../fr417823/index.html">Nouvelle gÃ©nÃ©ration: lancement du premier rÃ©seau commercial 5G au monde</a></li>
<li><a href="../fr417825/index.html">"Repousser les limites": la gamme 6 GHz sera donnÃ©e aux besoins du Wi-Fi</a></li>
<li><a href="../fr417827/index.html">Wi-Fi gratuit: un tribunal allemand abolit les peines imposÃ©es aux cafÃ©s pour violation des droits d'auteur des clients</a></li>
<li><a href="../fr417831/index.html">La vie avec Java SE 8 et Java SE 11 Ã  25 $ par processeur par mois</a></li>
<li><a href="../fr417835/index.html">Â«Empire en profondeurÂ»: pourquoi les grandes entreprises informatiques posent leurs cÃ¢bles sous-marins</a></li>
<li><a href="../fr417837/index.html">Mise Ã  niveau de Django de la version 1.9 vers la version 2.0</a></li>
<li><a href="../fr417839/index.html">Les attaquants utilisent le jeu "Clash of Clans" pour blanchir de l'argent des cartes de crÃ©dit volÃ©es</a></li>
<li><a href="../fr417841/index.html">Nous interdisons govnokod, ou plug-ins utiles pour ESLint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>