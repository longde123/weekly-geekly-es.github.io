<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÜ ü§∑ ‚ú°Ô∏è Ad Exchange Server - Diferente de outros üèâ üè¶ üìä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Ad Exchange como parte do lance em tempo real (RTB) √© uma das solu√ß√µes da AdTech que est√° transformando o mercado de publicidade on-line. Sua princi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ad Exchange Server - Diferente de outros</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/maxilect/blog/421471/">  O Ad Exchange como parte do lance em tempo real (RTB) √© uma das solu√ß√µes da AdTech que est√° transformando o mercado de publicidade on-line.  Sua principal fun√ß√£o √© ancorar um grande n√∫mero de SSPs e DSPs que n√£o possuem integra√ß√£o direta entre si, al√©m de revender uma variedade de tr√°fego de publicidade entre eles. <br><br>  Gra√ßas a um pedido para o mercado dos EUA, mergulhamos de cabe√ßa nas especificidades da cria√ß√£o da plataforma Ad Exchange.  E neste artigo, apresentamos algumas id√©ias e resultados. <br><br><img src="https://habrastorage.org/webt/ua/tj/gw/uatjgwrn-musoqo-_gchjt2fptc.jpeg" alt="imagem"><br><a name="habracut"></a><br><h2>  Declara√ß√£o do problema </h2><br>  Lances em tempo real (RTB) fornecem a venda de espa√ßo publicit√°rio em sites em tempo real para exibir an√∫ncios relevantes ao p√∫blico-alvo. <br><br>  Em resumo, o diagrama do processo √© o seguinte: <br><br><img src="https://habrastorage.org/webt/u4/e9/3w/u4e93wxmuauj4qskiyt0wt4gz-q.png" alt="imagem"><br><br><ul><li>  o usu√°rio final solicita uma p√°gina da web ou aplicativo m√≥vel onde √© reservado um local para um banner (o c√≥digo da plataforma para a venda de invent√°rio de publicidade est√° incorporado - SSP, Supply Side Platform); </li><li>  Para garantir o pre√ßo m√°ximo de venda do invent√°rio, o SSP organiza propostas entre os v√°rios DSPs (Demand Side Platform) por meio do Ad Exchange, cujo objetivo √© comprar o invent√°rio o mais barato poss√≠vel; </li><li>  ap√≥s o an√∫ncio do vencedor do leil√£o, o DSP vencedor envia um c√≥digo de faixa SSP, que √© exibido ao usu√°rio; </li><li>  outro lado do processo √© o DMP, um sistema de terceiros que fornece ao DSP informa√ß√µes detalhadas sobre o usu√°rio final (al√©m do que pode transmitir SSPs na forma de cookies etc.) para justificar a conveni√™ncia da compra e o custo proposto. </li></ul><br>  Hoje existem algumas trocas do Ad Exchange.  Al√©m disso, muitos SSPs implementam seus pr√≥prios lances (realmente fechando a funcionalidade do Ad Exchange).  Mas nosso cliente tinha certeza de que, devido a algumas novas id√©ias, ele poderia entrar rapidamente no mercado e resistir √† concorr√™ncia. <br><br>  As trocas trabalham com princ√≠pios diferentes: algu√©m oferece uma margem maior, algu√©m menos, algu√©m vende equipamentos exclusivos, outros se concentram em bens de consumo condicionais.  O mercado √© bastante jovem e se desenvolve ativamente; portanto, n√£o h√° modelos de neg√≥cios testados ao longo dos anos aqui: tudo se baseia em hip√≥teses e experimentos ousados.  A maioria dos jogadores trabalha de acordo com um esquema simples: recebe uma solicita√ß√£o de um dos v√°rios SSPs com os quais conseguiu concordar e a envia a todos os DSPs integrados, antecipando uma aposta melhor.  Receita do Ad Exchange - a diferen√ßa entre o pre√ßo de compra e venda de invent√°rio de publicidade no SSP e no DSP menos os custos operacionais. <br><br>  Nosso cliente sugeriu otimizar esse esquema distribuindo corretamente solicita√ß√µes de SSP ao DSP - n√£o enviando deliberadamente "perdendo" solicita√ß√µes, reduzindo assim os custos operacionais.  Devido a isso, voc√™ pode reduzir a comiss√£o da troca sem perder receita e tornar sua oferta mais atraente no contexto do Ad Exchange concorrente na luta pelo SSP e DSP.  E conectar mais parceiros proporcionar√° renda e estabilidade no mercado. <br><br>  Para implementar essa estrat√©gia no mercado dos EUA, fomos encarregados de tornar o Ad Exchange com uma distribui√ß√£o inteligente de solicita√ß√µes, que forneceria uma boa porcentagem de recompra.  Em teoria, para essa distribui√ß√£o, voc√™ pode usar muitas informa√ß√µes que acompanham a solicita√ß√£o, at√© mesmo os dados dos sistemas de terceiros (DMP) mencionados acima.  No entanto, an√°lises complexas requerem recursos; portanto, a tarefa √© encontrar um equil√≠brio entre os custos da distribui√ß√£o inteligente e o ganho (em compara√ß√£o com outros participantes do mercado) de sua implementa√ß√£o.  Em um mercado imaturo relativamente novo, construir solu√ß√µes muito complexas, apertar d√©cimos de otimiza√ß√£o, simplesmente n√£o faz sentido. <br><br>  Uma caracter√≠stica importante do projeto, al√©m das altas cargas esperadas, foi o cumprimento dos requisitos n√£o funcionais para a velocidade do leil√£o realizado pelo SSP.  Adequado neste segmento de mercado, √© o tempo limite para aguardar uma resposta do SSP a 300 ms, que deve ser atendida juntamente com as chamadas para sistemas externos (DSP). <br><br>  O projeto come√ßou no outono de 2016.  Gra√ßas √† experi√™ncia da equipe nessa √°rea, ap√≥s tr√™s meses fizemos o primeiro prot√≥tipo e depois de mais tr√™s MVP (Produto m√≠nimo vi√°vel) prontos, o que nos permitiu coletar as primeiras an√°lises para iniciar a distribui√ß√£o inteligente de solicita√ß√µes no Ad Exchange. <br><br>  O lan√ßamento do MVP mostrou que a hip√≥tese sobre o sucesso comercial do projeto est√° correta - o Ad Exchange come√ßou a ganhar dinheiro para o cliente.  Os planos de desenvolvimento inicial do Ad Exchange inclu√≠ram um estudo mais aprofundado dos dados - conectando informa√ß√µes do usu√°rio final de sistemas externos √† an√°lise.  Mas, no est√°gio MVP, foi decidido usar apenas os dados que o SSP possui.  Isso foi suficiente para obter o lucro esperado. <br><br><h2>  Arquitetura da solu√ß√£o </h2><br>  A solu√ß√£o √© constru√≠da com base no modelo da Cadeia de responsabilidade, que permite n√£o corrigir a rota de solicita√ß√µes no sistema, adicionando facilmente processadores e v√°rios servi√ßos, do pr√≥prio leil√£o √†s ferramentas de filtragem. <br><br><img src="https://habrastorage.org/webt/oo/kd/gk/ookdgk5zkuz2ryzrq7xahistsno.jpeg" alt="imagem"><br><br>  O cliente n√£o nos limitou na pilha de tecnologias usadas.  Portanto, cuidando do futuro desenvolvimento e suporte do projeto, criamos uma solu√ß√£o escal√°vel horizontalmente usando o Postgres e o Hadoop. <br><br>  O pr√≥prio Ad Exchange √© escrito em Java - ao mesmo tempo, n√£o usamos nenhuma estrutura para n√£o cair na carga (trabalhamos em um n√≠vel baixo). <br>  Para manter o tempo limite do SSP mencionado, selecionamos os par√¢metros do coletor de lixo (G1 foi usado) e realizamos um trabalho s√≠ncrono com um grande n√∫mero de solicita√ß√µes - usamos um cliente HTTP que n√£o bloqueia o fluxo, bem como uma extens√£o do protocolo HTTP keep-alive que permite o envio de v√°rias solicita√ß√µes dentro uma conex√£o TCP. <br><br>  Os componentes de software s√£o implantados no hardware alugado do host, conforme  as condi√ß√µes da tarefa n√£o permitiram o uso da nuvem devido √† sobreposi√ß√£o de recursos das m√°quinas virtuais na nuvem (a aloca√ß√£o dos recursos necess√°rios pode levar tempo, mas n√£o temos).  No momento, o Ad Exchange usa quatro servidores f√≠sicos, um dos quais √© redundante (para atualiza√ß√µes cont√≠nuas etc.). <br><br>  O c√≥digo-fonte aberto Apache Kafka √© usado como um intermedi√°rio de mensagens - √© idealmente integrado ao nosso modelo de "um assinante - muitos editores", embora tivesse que ser ligeiramente distorcido para que as mensagens repetidas n√£o chegassem. <br><br>  Cada um dos servidores fornece no modo normal o processamento de cerca de 10 mil solicita√ß√µes por segundo (esses par√¢metros foram estabelecidos durante o desenvolvimento da solu√ß√£o).  Agora, a carga m√©dia √© de 15 a 20 mil solicita√ß√µes por segundo e, no pico, o fluxo de solicita√ß√µes atingiu 40 mil por segundo por v√°rias horas, e o Ad Exchange fez um √≥timo trabalho nisso. <br><br>  A distribui√ß√£o de solicita√ß√µes entre servidores √© realizada pelo balanceador de carga do software nginx, configurado para nossa tarefa.  Em nossa experi√™ncia, no nginx, voc√™ pode manter de 60 a 70 mil solicita√ß√µes por segundo, sem alocar um balanceador de hardware separado.  Se, no futuro, a carga no Ad Exchange estiver acima desse limite, planejamos comprar um balanceador de hardware que distribua solicita√ß√µes entre v√°rios do mesmo tipo nginx. <br><br>  Ele monitora o que est√° acontecendo, sujeito a um aumento constante na carga, um sistema de monitoramento que faz parte do Ad Exchange criado. <br><br><h2>  Armazenamento </h2><br>  Dada a depend√™ncia das an√°lises durante a distribui√ß√£o de consultas, o banco de dados √© parte integrante do nosso Ad Exchange.  O sistema armazena informa√ß√µes sobre lances, participantes de leil√£o e transa√ß√µes. <br><br>  N√£o faz sentido coletar esse volume de dados para todo o per√≠odo do Ad Exchange, para que o armazenamento tenha uma arquitetura multin√≠vel.  Todos os dados do leil√£o s√£o armazenados por semana.  Com base nelas, s√£o constru√≠das unidades intermedi√°rias de n√≠vel superior, que s√£o armazenadas por v√°rios meses.  E com base nos intermedi√°rios, os agregados finais s√£o usados, que s√£o usados ‚Äã‚Äãem an√°lises de longo prazo e para reconcilia√ß√µes com SSP e DSP.  Entre outras informa√ß√µes nessas unidades, h√° dados sobre quantas apostas foram feitas e quanto dinheiro a bolsa pagar√° ao SSP ou esperar√° receber do DSP. <br>  Os pontos de extremidade s√£o armazenados por toda a dura√ß√£o do Ad Exchange. <br><br>  A coleta de an√°lises e a forma√ß√£o de agregados fornecem servi√ßos separados. <br><br>  Para que o armazenamento correspondesse √† velocidade do pr√≥prio sistema, eu tamb√©m tive que trabalhar com ele.  Em particular, por algum tempo brigamos com o hoster, porque  os dados da transa√ß√£o simplesmente n√£o tiveram tempo de gravar no banco de dados.  Verificou-se que a falha era um problema de hardware com a matriz RAID.  Ap√≥s substitu√≠-lo, conseguimos extrair 90.000 solicita√ß√µes por segundo no Postgres (inserindo dados no banco de dados). <br><br>  O restante do Ad Exchange √© sem estado, o que proporciona uma escala horizontal f√°cil no futuro.  Ele n√£o armazena dados sobre solicita√ß√µes - a informa√ß√£o m√°xima recebida sobre qual DSP deve ser selecionado.  Para que possamos adicionar novos servidores para processar solicita√ß√µes, conforme necess√°rio. <br><br><h2>  Filtragem de tr√°fego </h2><br>  Um elemento chave do sistema que permite reduzir a carga e manter os tempos limite indicados pelo cliente √© a filtragem de tr√°fego. <br><br>  De acordo com a tarefa em m√£os, qualquer Ad Exchange: <br><ul><li>  aceita solicita√ß√µes do SSP; </li><li>  realiza um leil√£o (envia solicita√ß√µes para v√°rios DSPs, compara os pre√ßos oferecidos, identifica o vencedor); </li><li>  concorda com a vit√≥ria do SSP (informa o pre√ßo do vencedor menos sua comiss√£o, aguarda uma resposta com o pre√ßo final do show); </li><li>  conclui a transa√ß√£o (informa o DSP necess√°rio sobre sua vit√≥ria, conduz o tr√°fego do usu√°rio). </li></ul><br>  A distribui√ß√£o inteligente de solicita√ß√µes em nosso Ad Exchange est√° inclu√≠da no est√°gio inicial do leil√£o. <br><br>  Quando recebemos uma solicita√ß√£o do SSP com determinadas informa√ß√µes (IP, agente do usu√°rio), as detalhamos usando as informa√ß√µes acumuladas nas informa√ß√µes de usu√°rio conhecidas do sistema, uma lista de DSPs para os quais solicita√ß√µes semelhantes foram enviadas, suas respostas etc.  Isso √© necess√°rio para selecionar a combina√ß√£o mais vantajosa de DSP para cada solicita√ß√£o.  Gra√ßas √† sele√ß√£o dessa combina√ß√£o, o sistema permite que voc√™ n√£o envie solicita√ß√µes para os DSPs que n√£o oferecem ou fazem, mas s√£o muito baixos.  Para fazer isso, um servi√ßo separado em tempo real compila um mapa de como o DSP responde √†s solicita√ß√µes (esses cart√µes s√£o armazenados no Redis). <br><br>  Paralelamente, verificamos o status do DSP - se a propor√ß√£o de respostas dentro do tempo limite cair, o sistema reduzir√° automaticamente o n√∫mero de solicita√ß√µes para esse DSP.  Assim que a carga no DSP √© reduzida (e a propor√ß√£o de respostas corretas em um tempo aceit√°vel aumenta), o n√∫mero de solicita√ß√µes retorna gradualmente ao n√≠vel anterior. <br><br>  Entre os DSPs que responderam a tempo, realizamos um leil√£o interno - selecione a melhor oferta e envie-a para o SSP.  Desde a solicita√ß√£o do SSP at√© nossa resposta, n√£o passam mais de 300 ms, de acordo com os requisitos do setor. <br><br>  Como enviamos os dados para o SSP, onde nosso leil√£o √© realizado, precisamos considerar os lances vencidos l√°.  O servidor de leil√µes j√° est√° envolvido no registro deles no pr√≥ximo est√°gio, ao processar o tr√°fego do usu√°rio.  Gra√ßas a ele, o mapa de resposta do DSP √© enriquecido com novos dados (juntamente com as informa√ß√µes coletadas sobre o usu√°rio final). <br><br>  Uma compara√ß√£o dos dados obtidos no est√°gio do leil√£o e dos par√¢metros conhecidos do tr√°fego do usu√°rio nos permite filtrar os bots (clickers de publicidade, bots de pesquisa etc.).  Esse tr√°fego n√£o √© resgatado pelo DSP e, na aus√™ncia de seu pr√≥prio sistema de filtragem, ele se transforma em perdas de clientes, que dever√£o ser cobertas pela margem. <br><br>  Note-se que a filtragem de tr√°fego de bot n√£o foi iniciada imediatamente.  Por√©m, ap√≥s a inclus√£o de bloqueios simples, o ganho de margem foi de cerca de 50%. <br><br>  A prop√≥sito, al√©m das ferramentas autom√°ticas de filtragem de tr√°fego em nosso sistema, √© poss√≠vel que o cliente altere manualmente os valores limite de v√°rios par√¢metros, ajustando a margem. <br><br>  O tr√°fego do usu√°rio em si √© cr√≠tico para n√≥s, mas quando √© processado, n√£o √© mais necess√°rio caber em 300 ms.  Ele usa um sistema de processamento separado, que pode reter um pouco o usu√°rio, mas n√£o permitir√° perder essa solicita√ß√£o. <br><br>  Para garantir a estabilidade da solu√ß√£o, foi introduzido um subsistema que, entendendo a carga atual do Ad Exchange, "corta" as solicita√ß√µes de leil√µes, que n√£o podem ser processadas fisicamente.  Assim, o sistema √© protegido contra o crescimento descontrolado de carga do SSP. <br><br><h2>  Perspectivas </h2><br>  At√© o momento, o Ad Exchange que criamos funciona e gera bons lucros.  E fornecemos suporte e integra√ß√£o de novos parceiros (DSP / SSP), conforme necess√°rio.  No total, v√°rias dezenas de sistemas j√° foram integrados.  Cada integra√ß√£o implica n√£o apenas a conex√£o de software, mas tamb√©m testes abrangentes do servi√ßo, porque, sob cargas pesadas, os problemas do servi√ßo conectado podem afetar outros parceiros. <br><br>  Em geral, o mercado est√° caminhando para o fato de que o SSP e o DSP se conectar√£o diretamente, o que tornar√° as trocas desnecess√°rias.  Mas a integra√ß√£o baseia-se nos recursos do SSP e DSP.  Apesar da exist√™ncia da API aberta (protocolo OpenRTB), ela ainda n√£o √© universalmente reconhecida no mercado.  Por exemplo, um participante importante como o Appnexus integrou recentemente o suporte ao OpenRTB. <br><br>  Essencialmente, o Ad Exchange √© um provedor de liquidez.  Portanto, √© improv√°vel que a decis√£o no futuro perca sua relev√¢ncia.  Al√©m disso, o modelo de troca s√≥ est√° ganhando popularidade no restante do mercado publicit√°rio. <br><br><hr><br>  Autor do artigo: Nikolay Eremin <br><br>  PS Publicamos nossos artigos em v√°rios sites do Runet.  Assine nossas p√°ginas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">canal</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">VK</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FB</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Telegram</a> para descobrir todas as nossas publica√ß√µes e outras not√≠cias do Maxilect. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt421471/">https://habr.com/ru/post/pt421471/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt421461/index.html">Time Tracker para scripts, documentos e planilhas do Google</a></li>
<li><a href="../pt421463/index.html">A vida noturna do c√©u ou em busca de Perseid - processamento</a></li>
<li><a href="../pt421465/index.html">DevOps para celular na pr√°tica</a></li>
<li><a href="../pt421467/index.html">Desenvolvimento de um rob√¥ para coletar bolas de golfe</a></li>
<li><a href="../pt421469/index.html">O Telegram concordou em transferir para os servi√ßos IP [mas n√£o para o russo] endere√ßos IP e n√∫meros de alguns usu√°rios</a></li>
<li><a href="../pt421473/index.html">O que s√£o corotinas em Kotlin?</a></li>
<li><a href="../pt421475/index.html">OutOfLine - padr√£o na mem√≥ria para aplicativos C ++ de alto desempenho</a></li>
<li><a href="../pt421477/index.html">O que est√° escrito no arquivo .ssh / known_hosts</a></li>
<li><a href="../pt421481/index.html">Microfones, capturas de tela e v√≠deo local: como o SDK da Web Voximplant controla a m√≠dia em um navegador</a></li>
<li><a href="../pt421485/index.html">Aviso importante para usu√°rios do Gitlab Pages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>