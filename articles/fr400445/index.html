<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏿 🤦🏼 🔏 Connecter une mini console de jeu Nintendo Classic au Raspberry pi 😦 👼🏽 🤶🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les vacances se terminent, ce qui signifie qu'il est temps de regretter le foie et de tourner la tête. Une autre idée m'est donc venue à l'esprit. Apr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Connecter une mini console de jeu Nintendo Classic au Raspberry pi</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/400445/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les vacances se terminent, ce qui signifie qu'il est temps de regretter le foie et de tourner la tête. Une autre idée m'est donc venue à l'esprit. Après avoir connecté la manette de jeu de Dendy (c'est un joystick, c'est un contrôleur, c'est un joystick, c'est une console de jeu, etc.) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geektimes.ru/post/281520</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , j'ai pensé à connecter une seconde à Raspberry pi. Je ne voulais pas acheter la deuxième camelote avec des boutons de blocage, et ici, au fait, j'ai été jetée sur les étagères de la Nintendo Classic Mini, eh bien, comme ils l'ont jetée - vous achèterez du raifort. Le but n'était pas d'acheter un émulateur pour 4K, mais j'ai décidé d'acheter une manette de jeu. Heureusement, j'ai réussi à l'acheter, c'était la dernière du magasin. Ceux qui sont intéressés par ce qui en est arrivé peuvent cliquer sur le bouton ci-dessous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> direct </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">vers la preuve</font></a><font style="vertical-align: inherit;"> , si la régulière n'est pas activée.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/c3a/89c/5a4/c3a89c5a4ceae503f25e700e9cd79a45.jpg" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas de secret pour personne que cette manette de jeu peut être connectée à la fois à la Wii et à la Wii U, ce qui signifie qu'elle peut être interrogée via l'interface i2c. Ce qui est encourageant, c'est que la manette de jeu est alimentée par 3,3 V, ce qui signifie que vous n'avez pas à vous soucier des niveaux de tension correspondants. Pour connecter la manette de jeu au Raspberry pi, j'ai décidé d'acheter des connecteurs pour wiimote sur aliexpress, qui sont soudés sur la carte de lui. Bien qu'il y ait 2 connecteurs dans l'emballage et qu'ils se trouvaient dans une bulle commune, l'un des connecteurs est tombé en ruine. Aucun bidon ne peut faire ici. Après que tout a été soudé, il a fallu vérifier si cela fonctionne. Pour cela, j'ai décidé d'utiliser les utilitaires du package i2c-tools. L'idée était de déterminer l'appareil à l'adresse - 52. Après avoir lancé i2cdetect, j'ai vu le précieux:</font></font><br>
<br>
<pre><code class="cpp hljs">i2cdetect -y <span class="hljs-number"><span class="hljs-number">1</span></span>
     <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2</span></span>  <span class="hljs-number"><span class="hljs-number">3</span></span>  <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  <span class="hljs-number"><span class="hljs-number">7</span></span>  <span class="hljs-number"><span class="hljs-number">8</span></span>  <span class="hljs-number"><span class="hljs-number">9</span></span>  a  b  c  d  e  f
<span class="hljs-number"><span class="hljs-number">00</span></span>:          <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> -- -- -- -- -- -- -- --
<span class="hljs-number"><span class="hljs-number">10</span></span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
<span class="hljs-number"><span class="hljs-number">20</span></span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
<span class="hljs-number"><span class="hljs-number">30</span></span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
<span class="hljs-number"><span class="hljs-number">40</span></span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
<span class="hljs-number"><span class="hljs-number">50</span></span>: -- -- <span class="hljs-number"><span class="hljs-number">52</span></span> -- -- -- -- -- -- -- -- -- -- -- -- --
<span class="hljs-number"><span class="hljs-number">60</span></span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
<span class="hljs-number"><span class="hljs-number">70</span></span>: -- -- -- -- -- -- -- --</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon cœur s'est immédiatement réchauffé (comme si une fille inconnue vous souriait dans une rue au printemps), alors ça marche. Ensuite, vous deviez google pour connecter des périphériques à la Wii. J'ai trouvé un exemple de la façon dont un nunchak Wii se connecte à un Raspberry pi. À partir de cet exemple, j'ai découvert que la manette de jeu doit être initialisée en écrivant zéro dans le registre 0x40, puis juste avant de lire chaque fois que vous avez juste besoin d'écrire un zéro et de lire les 6 premiers octets.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, j'ai également été confronté au choix d'une bibliothèque pour i2c. Comme je n'ai pas réussi avec la bibliothèque bcm2835, j'ai décidé d'utiliser la bibliothèque utilisée dans l'exemple - il s'agit de la bibliothèque WirinPi. Tout a fonctionné avec elle. Empiriquement, j'ai découvert que les informations du bouton sont contenues dans 4 et 5 octets (si vous comptez des octets à partir de zéro). Les informations sur les boutons de sélection, de démarrage, de descente et de droite se trouvent dans le quatrième octet, et les informations sur les boutons A, B, haut et gauche se trouvent dans le cinquième octet. De plus, les informations sur les boutons de sélection, bas et droit sont dans les 4 bits supérieurs de l'octet, et les informations sur le bouton de démarrage sont dans le bas. Il en va de même pour le 5ème octet, les informations sur les boutons A, B sont dans les 4 bits supérieurs de l'octet, et les informations sur les boutons haut, gauche sont dans les bas. Voici les codes des boutons: A - 0xcf, B - 0xbf, haut - 0xf0, gauche - 0xf1, sélectionnez - 0xcf, démarrez - 0xf3, bas - 0xbf, droite - 0x7f.Le résultat de la pression conjointe sur des boutons, dont les informations sont dans un octet et dans les mêmes bits, est un «ET» logique de leurs codes. Ainsi, par exemple, appuyer simultanément sur les boutons A et B donne la valeur 0x8f.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vers le tableau: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/77c/166/6b1/77c1666b13f7f2b7e71554e5e9f2d690.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai écrit un petit programme de test pour la lecture des boutons, ci-dessous je vais le lister en entier et expliquer ce qui se passe avec:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;unistd.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;wiringPi.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;wiringPiI2C.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;errno.h&gt;</span></span></span></span>
<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> i, a, b, c, d, state;
<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> bytes[<span class="hljs-number"><span class="hljs-number">6</span></span>];
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{<font></font>
wiringPiSetup();<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd = wiringPiI2CSetup(<span class="hljs-number"><span class="hljs-number">0x52</span></span>);<font></font>
wiringPiI2CWriteReg8(fd, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>);<font></font>
delayMicroseconds(<span class="hljs-number"><span class="hljs-number">20</span></span>);
<span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <font></font>
{<font></font>
	state = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
	wiringPiI2CWrite(fd, <span class="hljs-number"><span class="hljs-number">0x00</span></span>);<font></font>
        delayMicroseconds(<span class="hljs-number"><span class="hljs-number">100</span></span>);
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">6</span></span>; i++)<font></font>
	{<font></font>
           bytes[i] = wiringPiI2CRead(fd);<font></font>
        }<font></font>
	a = bytes[<span class="hljs-number"><span class="hljs-number">5</span></span>] &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>;<font></font>
	b = bytes[<span class="hljs-number"><span class="hljs-number">5</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>;<font></font>
	c = bytes[<span class="hljs-number"><span class="hljs-number">4</span></span>] &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>;<font></font>
	d = bytes[<span class="hljs-number"><span class="hljs-number">4</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a == <span class="hljs-number"><span class="hljs-number">0xc</span></span>)<font></font>
	state ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">0</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a == <span class="hljs-number"><span class="hljs-number">0xb</span></span>)<font></font>
	state ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">0xc</span></span>)<font></font>
	state ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (d == <span class="hljs-number"><span class="hljs-number">0x30</span></span>)<font></font>
	state ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b == <span class="hljs-number"><span class="hljs-number">0x00</span></span>)<font></font>
	state ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">0xb</span></span>)<font></font>
	state ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b == <span class="hljs-number"><span class="hljs-number">0x10</span></span>)<font></font>
	state ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">0x7</span></span>)<font></font>
	state ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>);
	<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%x \n"</span></span>, state);<font></font>
	}<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au tout début, des variables sont déclarées, à l'aide desquelles l'état d'un bouton particulier sera déterminé. </font><font style="vertical-align: inherit;">Il est important que les variables soient de type char, sinon avec un décalage au niveau du bit vers la gauche, seulement 4 zéros sont ajoutés, et c'est tout. </font><font style="vertical-align: inherit;">L'interprétation sera fausse. </font><font style="vertical-align: inherit;">Peu importe à quel point cela semble drôle, vous devez utiliser le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sort</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, dans le corps principal du programme, la bibliothèque WiringPi est initialisée - câblagePiSetup ();, puis l'adresse i2c du périphérique est définie sur 0x52. </font><font style="vertical-align: inherit;">Ensuite, le contrôleur est initialisé:</font></font><br>
<br>
<pre><code class="cpp hljs">
wiringPiI2CWriteReg8(fd, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>);<font></font>
delayMicroseconds(<span class="hljs-number"><span class="hljs-number">20</span></span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, déjà, dans le corps de la boucle, 6 octets sont lus, et avant la lecture, zéro est écrit à chaque fois. </font><font style="vertical-align: inherit;">Et après cela, le bouton enfoncé est déterminé. </font><font style="vertical-align: inherit;">En général, tout ce code a migré vers les fichiers de l'émulateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme la dernière fois, l'initialisation de la bibliothèque est enregistrée dans le fichier fceu.c:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FCEUI_Initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!FCEU_InitVirtualVideo())
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
    <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;FSettings,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(FSettings));<font></font>
    FSettings.UsrFirstSLine[<span class="hljs-number"><span class="hljs-number">0</span></span>]=<span class="hljs-number"><span class="hljs-number">8</span></span>;<font></font>
    FSettings.UsrFirstSLine[<span class="hljs-number"><span class="hljs-number">1</span></span>]=<span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    FSettings.UsrLastSLine[<span class="hljs-number"><span class="hljs-number">0</span></span>]=<span class="hljs-number"><span class="hljs-number">231</span></span>;<font></font>
    FSettings.UsrLastSLine[<span class="hljs-number"><span class="hljs-number">1</span></span>]=<span class="hljs-number"><span class="hljs-number">239</span></span>;<font></font>
    FSettings.SoundVolume=<span class="hljs-number"><span class="hljs-number">100</span></span>;<font></font>
    FCEUPPU_Init();<font></font>
    X6502_Init();<font></font>
    wiringPiSetup();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bien toutes les modifications ne concernent que le fichier input.c. </font><font style="vertical-align: inherit;">Initialement, dans la fonction FCEUI_Initialize (void) int, les modes de fonctionnement du port gpio pour travailler avec l'ancienne manette de jeu (de Simba) sont définis et la manette de jeu est initialisée.</font></font><br>
<br>
<pre><code class="cpp hljs">
pinMode (<span class="hljs-number"><span class="hljs-number">0</span></span>, OUTPUT);<font></font>
pinMode (<span class="hljs-number"><span class="hljs-number">2</span></span>, OUTPUT);<font></font>
pinMode (<span class="hljs-number"><span class="hljs-number">3</span></span>, INPUT);<font></font>
digitalWrite (<span class="hljs-number"><span class="hljs-number">0</span></span>, HIGH);<font></font>
digitalWrite (<span class="hljs-number"><span class="hljs-number">2</span></span>, LOW);<font></font>
fd = wiringPiI2CSetup(<span class="hljs-number"><span class="hljs-number">0x52</span></span>);<font></font>
wiringPiI2CWriteReg8(fd, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>);<font></font>
usleep(<span class="hljs-number"><span class="hljs-number">20</span></span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au début, vous devez également déclarer des variables qui détermineront les pressions sur les boutons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fonction statique DECLFW (B4016), un stroboscope est fourni pour l'ancien gamepad, le nouveau stroboscope n'est pas nécessaire:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LastStrobe==<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
{<font></font>
	digitalWrite (<span class="hljs-number"><span class="hljs-number">0</span></span>, LOW);<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la création d'un programme de test, je n'ai pas pu résoudre le problème d'identification des boutons enfoncés ensemble, dont les informations sont sur un octet et sur un bit. À la fin, j'ai appliqué la construction de cas de commutation au lieu de if else. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, la fonction elle-même est une fonction de lecture de l'état des boutons:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FCEU_UpdateInput</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{<font></font>
joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
joy[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0xff</span></span>;<font></font>
wiringPiI2CWrite(fd, <span class="hljs-number"><span class="hljs-number">0x00</span></span>);<font></font>
usleep(<span class="hljs-number"><span class="hljs-number">100</span></span>);
<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;= <span class="hljs-number"><span class="hljs-number">7</span></span>; i++)<font></font>
	{<font></font>
	bytes[i] = wiringPiI2CRead(fd);<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^= digitalRead(<span class="hljs-number"><span class="hljs-number">3</span></span>) &lt;&lt; i;<font></font>
	digitalWrite (<span class="hljs-number"><span class="hljs-number">2</span></span>, HIGH);<font></font>
	delayMicroseconds (<span class="hljs-number"><span class="hljs-number">20</span></span>);<font></font>
	digitalWrite (<span class="hljs-number"><span class="hljs-number">2</span></span>, LOW);<font></font>
	delayMicroseconds (<span class="hljs-number"><span class="hljs-number">20</span></span>);<font></font>
	}<font></font>
	a = bytes[<span class="hljs-number"><span class="hljs-number">5</span></span>] &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>;<font></font>
	b = bytes[<span class="hljs-number"><span class="hljs-number">5</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>;<font></font>
	c = bytes[<span class="hljs-number"><span class="hljs-number">4</span></span>] &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>;<font></font>
	d = bytes[<span class="hljs-number"><span class="hljs-number">4</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (a){
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">0</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xb</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x8</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
	}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (b){
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x10</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x20</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
	}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (c){
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xb</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x7</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x8</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>);<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x4</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>);<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x3</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>);<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
	}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (d){
	<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x30</span></span>:<font></font>
	joy[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>);
	<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
	}<font></font>
	digitalWrite (<span class="hljs-number"><span class="hljs-number">0</span></span>, HIGH);<font></font>
	}<font></font>
	</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En un cycle, j'ai combiné la lecture des boutons des deux manettes, eh bien, pensez que 2 octets supplémentaires sont lus, cela n'a pas d'importance, mais tout se passe en même temps. </font><font style="vertical-align: inherit;">Et il n'y a aucun retard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, tout va bien. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si je me souviens bien, demain au travail, déjà déformé. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS J'ai</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oublié d'ajouter que pour une compilation réussie, dans le Makefile (formé après l'exécution de la commande Configure), qui se trouve dans le répertoire src, vous devez ajouter -lwiringPi -lm -lrt à l'endroit où les dépendances de la bibliothèque sont écrites. </font><font style="vertical-align: inherit;">Ligne:</font></font><br>
<br>
<pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">LIBS</span></span> =</code></pre></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr400445/">https://habr.com/ru/post/fr400445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr400433/index.html">SpaceX en 2017: des plans énormes</a></li>
<li><a href="../fr400435/index.html">En 2017, être un génie isolé échouera</a></li>
<li><a href="../fr400439/index.html">Son de cinéma maison sans fil: la farine du choix - Une abondance de formats, d'opportunités et de défis</a></li>
<li><a href="../fr400441/index.html">Les artisans ont piraté NES Classic, maintenant les jeux peuvent être téléchargés via USB</a></li>
<li><a href="../fr400443/index.html">Des avions stratosphériques à énergie solaire présentés au monde</a></li>
<li><a href="../fr400447/index.html">Acer C710: installation de Windows 10</a></li>
<li><a href="../fr400449/index.html">2016 Geek Hits</a></li>
<li><a href="../fr400451/index.html">IBM 5 en 5: cinq innovations qui changeront nos vies au cours des cinq prochaines années</a></li>
<li><a href="../fr400453/index.html">Pourquoi les restes d'étoiles sont verts</a></li>
<li><a href="../fr400455/index.html">Il y a 10 ans, le monde a vu l'iPhone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>