<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÄÔ∏è üïµüèª üóÉÔ∏è Bauen Sie einen gusseisernen Walker auf Spring Boot und AppCDS ‚ùï üñïüèø üí´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="AppCDS (Application Class Data Sharing) - JVM-Funktion zur Beschleunigung des Starts und zum Speichern von Speicher. Nachdem es in JDK 1.5 (2004) in d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bauen Sie einen gusseisernen Walker auf Spring Boot und AppCDS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472638/"><p><img src="https://habrastorage.org/webt/se/py/8z/sepy8zdhkojsr-xiqs-lwdtyegy.jpeg"></p><br><p> <strong>AppCDS (Application Class Data Sharing)</strong> - JVM-Funktion zur Beschleunigung des Starts und zum Speichern von Speicher.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nachdem es</a> in JDK 1.5 (2004) in den Kinderschuhen von HotSpot <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">aufgetaucht</a> war, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">blieb</a> es lange Zeit sehr begrenzt und sogar teilweise kommerziell.  Erst mit OpenJDK 10 (2018) wurde es blo√üen Sterblichen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zur</a> Verf√ºgung gestellt und gleichzeitig der Anwendungsbereich erweitert.  Und k√ºrzlich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ver√∂ffentlichtes</a> Java 13 hat versucht, diese Anwendung zu vereinfachen. </p><br><p>  Die Idee von AppCDS besteht darin, einmal geladene Klassen zwischen Instanzen derselben JVM auf demselben Host zu ‚Äûteilen‚Äú.  Es scheint, dass dies f√ºr Microservices gro√üartig sein sollte, insbesondere f√ºr die "Broiler" auf Spring Boot mit ihren Tausenden von Bibliotheksklassen, da diese Klassen jetzt nicht bei jedem Start jeder JVM-Instanz geladen (analysiert und √ºberpr√ºft) werden m√ºssen und nicht im Speicher dupliziert werden.  Dies bedeutet, dass der Start schneller und der Speicherverbrauch geringer sein sollte.  Wunderbar, nicht wahr? </p><br><p>  Alles ist so, alles ist so.  Aber wenn Sie, der Odnokhabryanin, fr√ºher nicht an die Boulevardschilder, sondern an bestimmte Zahlen und Beispiele glaubten, dann willkommen bei kat - versuchen wir herauszufinden, wie es wirklich ist ... </p><a name="habracut"></a><br><h2 id="vmesto-disclaimera">  Anstelle eines Haftungsausschlusses </h2><br><p>  Vorher ist kein Leitfaden zur Verwendung von AppCDS, sondern eine Zusammenfassung der Ergebnisse einer kleinen Studie.  Ich war daran interessiert zu verstehen, wie diese JVM-Funktion in meinem Arbeitsprojekt anwendbar ist, und habe versucht, sie aus der Sicht eines Unternehmensentwicklers zu bewerten, indem ich das Ergebnis in diesem Artikel darlegte.  Dies beinhaltete keine Themen wie die Verwendung von AppCDS im Modulpfad, die Implementierung von AppCDS auf anderen virtuellen Maschinen (nicht HotSpot) und die Komplikationen bei der Verwendung von Containern.  Es gibt jedoch einen theoretischen Teil zum Erkunden des Themas sowie einen experimentellen Teil, der geschrieben wurde, damit Sie die Erfahrung selbst wiederholen k√∂nnen.  Keines der Ergebnisse wurde bisher in der Produktion angewendet, aber wer wei√ü, wie es morgen sein wird ... </p><br><h2 id="teoriya">  Theorie </h2><br><h3 id="kratkoe-vvedenie-v-appcds">  Eine kurze Einf√ºhrung in AppCDS </h3><br><p>  Die Bekanntschaft mit diesem Thema ist Ihnen m√∂glicherweise aus verschiedenen Quellen gekommen, zum Beispiel: </p><br><ul><li>  in einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel</a> von Nikolai Parlog (einschlie√ülich Java 13 Br√∂tchen, aber ohne Spring Boot) </li><li>  in einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bericht</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel</a> von Volker Simonis (ohne Java 13, aber mit Details) </li><li>  in einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bericht des</a> Autors dieser Zeilen (ohne Java 13, jedoch mit Schwerpunkt auf Spring Boot) </li></ul><br><p>  Um mich nicht auf Nacherz√§hlungen einzulassen, werde ich nur einige Punkte hervorheben, die f√ºr diesen Artikel wichtig sind. </p><br><p>  Erstens ist AppCDS eine Erweiterung der CDS-Funktion, die seit langem in HotSpot verf√ºgbar ist. Die Essenz lautet wie folgt: </p><br><p><img src="https://habrastorage.org/webt/gi/kg/ro/gikgrobp0s_hbnr5ox8z6d1ziqc.png"></p><br><p>  Um beide Ideen zum Leben zu erwecken, m√ºssen Sie (allgemein) Folgendes tun: </p><br><ol><li>  Rufen Sie eine Liste der Klassen ab, die Sie f√ºr Anwendungsinstanzen freigeben m√∂chten </li><li>  F√ºhren Sie diese Klassen in einem Archiv zusammen, das f√ºr die Speicherzuordnung geeignet ist </li><li>  Verbinden Sie das Archiv beim Start mit jeder Instanz der Anwendung </li></ol><br><p>  Es scheint, dass der Algorithmus nur 3 Schritte umfasst - nehmen Sie es und machen Sie es.  Aber hier beginnen die Nachrichten, alle m√∂glichen Dinge. </p><br><p>  Das Schlimme ist, dass im schlimmsten Fall jedes dieser Elemente zu mindestens einem JVM-Start mit eigenen spezifischen Optionen wird, was bedeutet, dass der gesamte Algorithmus ein subtiles Jonglieren derselben Art von Optionen und Dateien ist.  Das klingt nicht sehr vielversprechend, oder? </p><br><p>  Es gibt jedoch gute Nachrichten: Die Arbeiten zur Verbesserung dieses Algorithmus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dauern an</a> , und mit jeder Version von Java wird die Anwendung einfacher.  Also zum Beispiel: </p><br><ul><li> In OpenJDK <strong>10 und 11 k√∂nnen</strong> Sie Schritt <strong>1</strong> √ºberspringen, wenn Sie nur die wichtigsten JDK-Klassen freigeben m√∂chten, da diese bereits f√ºr uns kompiliert und in <code>$JAVA_HOME\lib\classlist</code> (~ 1200 Stk.) Eingef√ºgt wurden. </li><li>  In OpenJDK <strong>12 k√∂nnen</strong> Sie <strong>Schritt 2</strong> √ºberspringen, da das Verteilungsarchiv neben der Liste der Klassen auch ein vorgefertigtes Archiv enth√§lt, das sofort verwendet wird und keine explizite Verbindung erfordert. </li><li>  F√ºr den Fall, dass Sie alles andere teilen m√∂chten (und normalerweise nur m√∂chten) <br>  OpenJDK <strong>13</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">bietet</a> dynamische CDS-Archive - Archive, die w√§hrend des Betriebs der Anwendung gesammelt und gespeichert werden, wenn sie besetzt ist.  Auf diese Weise k√∂nnen Sie die <strong>Punkte 1 und 2</strong> zu einem nicht zu verwirrenden Punkt zusammenfassen (obwohl nicht alles so einfach ist, aber dazu sp√§ter mehr). </li></ul><br><p>  Unabh√§ngig davon, wie der Prozess der Vorbereitung von AppCDS abl√§uft, stehen die drei oben aufgef√ºhrten Schritte immer dahinter, nur in einigen F√§llen sind sie verschleiert. </p><br><p>  Wie Sie wahrscheinlich bemerkt haben, beginnen viele Anwendungsklassen mit dem Aufkommen von AppCDS ein Doppelleben: Sie leben gleichzeitig an ihren fr√ºheren Orten (meistens JAR-Dateien) und in einem neuen gemeinsam genutzten Archiv.  Gleichzeitig √§ndert / entfernt / erg√§nzt der Entwickler sie weiterhin an derselben Stelle, und die JVM √ºbernimmt sie bei der Arbeit von der neuen.  Man muss kein Wahrsager sein, um die Gefahr einer solchen Situation zu erkennen: Wenn nichts unternommen wird, werden fr√ºher oder sp√§ter Kopien der Klassen korrodieren und wir werden viele Reize der typischen ‚ÄûJAR-H√∂lle‚Äú bekommen.  Es ist klar, dass die JVM Klassen√§nderungen nicht verhindern kann, aber in der Lage sein sollte, eine zeitliche Diskrepanz zu erkennen.  Es ist jedoch eine Idee, dies durch paarweisen Vergleich von Klassen zu tun, selbst durch Pr√ºfsummen.  Dies kann den Rest der Produktivit√§tsgewinne zunichte machen.  Dies ist wahrscheinlich der Grund, warum die JVM-Ingenieure nicht die einzelnen Klassen als Vergleichsobjekt, sondern den gesamten Klassenpfad ausgew√§hlt haben. In der AppCDS-Dokumentation hei√üt es: ‚ÄûDer Klassenpfad beim Erstellen eines gemeinsam genutzten Archivs sollte derselbe (oder zumindest ein Pr√§fix) sein wie bei nachfolgenden Starts der Anwendung.‚Äú </p><br><blockquote>  Beachten Sie, dass der zur Erstellungszeit des Archivs verwendete Klassenpfad mit dem zur Laufzeit verwendeten Klassenpfad (oder einem Pr√§fix davon) identisch sein muss. </blockquote><p>  Dies ist jedoch keine eindeutige Aussage, da, wie Sie sich erinnern, ein Klassenpfad auf verschiedene Arten gebildet werden kann, z. </p><br><ul><li>  Lesen von <code>.class</code> Dateien aus kompilierten Paketverzeichnissen, <br>  B. <code>java com.example.Main</code> </li><li>  Scannen von Verzeichnissen mit JAR-Dateien bei Verwendung von Platzhaltern, <br>  B. <code>java -cp mydir/* com.example.Main</code> </li><li>  explizite Auflistung von JAR- und / oder ZIP-Dateien, <br>  B. <code>java -cp lib1.jar;lib2.jar com.example.Main</code> </li></ul><br><p>  (Dies schlie√üt nicht die Tatsache ein, dass der Klassenpfad auch anders festgelegt werden kann, z. B. √ºber die JVM-Optionen <code>-cp/-classpath/--class-path</code> , die Umgebungsvariable <code>CLASSPATH</code> oder das Attribut der zu startenden JAR-Datei f√ºr den <code>Class-Path</code> ) </p><br><p>  Von diesen Methoden wird in AppCDS nur eine unterst√ºtzt - die explizite Aufz√§hlung von JAR-Dateien.  Anscheinend waren die HotSpot JVM-Ingenieure der Ansicht, dass der Vergleich von Klassenpfaden im AppCDS-Archiv und in der gestarteten Anwendung nur dann schnell genug und zuverl√§ssig w√§re, wenn sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">so</a> klar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wie m√∂glich angegeben w√ºrden</a> - mit einer √ºblichen vollst√§ndigen Liste. </p><br><blockquote>  CDS / AppCDS unterst√ºtzt die Archivierung von Klassen nur aus JAR-Dateien. </blockquote><p>  Es ist wichtig anzumerken, dass diese Aussage nicht rekursiv ist, d.h.  gilt nicht f√ºr JAR-Dateien in JAR-Dateien (es sei denn, es handelt sich um Dynamic CDS, siehe unten).  Dies bedeutet, dass die √ºblichen JAR-Puppen von Spring Boot mit regul√§ren AppCDS nicht so funktionieren. Sie m√ºssen sich setzen. </p><br><p>  Ein weiterer Haken in der Arbeit von CDS ist, dass gemeinsam genutzte Archive mit festen Adressen (normalerweise ab <code>0x800000000</code> ) auf den Speicher projiziert werden.  Dies ist an sich nicht schlecht, aber da die Adressraum-Layout-Randomisierung (ASLR) auf den meisten Betriebssystemen standardm√§√üig aktiviert ist, kann der erforderliche Speicherbereich teilweise belegt sein.  Was die HotSpot JVM in diesem Fall tut, ist die spezielle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Option</a> <code>-Xshare</code> , die drei Werte unterst√ºtzt: </p><br><ul><li>  <code>-Xshare:on</code> - CDS / AppCDS erzwingen;  Wenn der Bereich belegt ist, wird die JVM mit einem Fehler beendet.  Dieser Modus wird <strong>f√ºr die Verwendung in der Produktion nicht empfohlen</strong> , da dies zu sporadischen Abst√ºrzen beim Starten von Anwendungen f√ºhren kann. </li><li>  <code>-Xshare:off</code> - (Sie) schalten CDS / AppCDS;  deaktiviert die Verwendung gemeinsam genutzter Daten vollst√§ndig (einschlie√ülich eingebetteter Archive) </li><li>  <code>-Xshare:auto</code> - das Standardverhalten der JVM, wenn sie im Falle der Unm√∂glichkeit, den erforderlichen Speicherbereich zuzuweisen, leise aufgibt und die Klassen wie gewohnt l√§dt </li></ul><br><p>  Zum Zeitpunkt des Schreibens dieses Artikels arbeitet Oracle nur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">daran</a> , solche Probleme zu beheben, aber eine Versionsnummer wurde noch nicht zugewiesen. </p><br><p>  Diese Optionen sind f√ºr uns sp√§ter teilweise n√ºtzlich, aber jetzt schauen wir uns ... </p><br><h3 id="varianty-primeneniya-appcds">  AppCDS-Anwendungen </h3><br><p>  Es gibt verschiedene M√∂glichkeiten mit AppCDS. <del>  ruiniere dein Leben </del>  Optimieren Sie die Arbeit von Microservices.  Sie unterscheiden sich stark in ihrer Komplexit√§t und ihrem potenziellen Gewinn. Daher ist es wichtig, sofort zu entscheiden, welche sp√§ter besprochen wird. </p><br><p>  Am einfachsten ist es, nicht einmal AppCDS, sondern nur CDS zu verwenden. In diesem Fall gelangen nur Plattformklassen in das gemeinsam genutzte Archiv (siehe "Eine kurze Einf√ºhrung in AppCDS").  Wir werden diese Option sofort l√∂schen, da sie bei Anwendung auf Microservices in Spring Boot zu wenig Gewinn bringt.  Dies l√§sst sich am Anteil eines gemeinsamen Mikrodienstes an der Anzahl der gemeinsam genutzten Klassen in ihrer allgemeinen Verteilung ablesen (siehe gr√ºnes Segment): </p><br><p><img src="https://habrastorage.org/webt/lz/7x/9l/lz7x9lodfzwv4ihwjjifjyxsf_a.png"></p><br><p>  Komplexer, aber vielversprechender ist die Verwendung von vollwertigem AppCDS, dh die Aufnahme von Bibliotheks- und Anwendungsklassen in dasselbe Archiv.  Dies ist eine ganze Familie von Optionen, die aus Kombinationen der Anzahl der teilnehmenden Anwendungen und der Anzahl der Instanzen abgeleitet werden.  Das Folgende sind subjektive Einsch√§tzungen des Autors zu den Vorteilen und Schwierigkeiten verschiedener Anwendungen von AppCDS. </p><br><div class="scrollable-table"><table><thead><tr><th>  Nr </th><th>  Anwendungen </th><th>  Instanzen </th><th>  CPU-Gewinn </th><th>  RAM Gewinn </th><th>  Schwierigkeit </th></tr></thead><tbody><tr><td>  1 </td><td>  Eins </td><td>  Eins </td><td>  + </td><td>  ¬± </td><td>  Niedrig </td></tr><tr><td>  <strong>2</strong> </td><td>  <strong>Eins</strong> </td><td>  <strong>Ein paar</strong> </td><td>  <strong>++</strong> </td><td>  <strong>++</strong> </td><td>  <strong>Niedrig</strong> </td></tr><tr><td>  3 </td><td>  Ein paar </td><td>  Einzeln </td><td>  ++ </td><td>  ++ </td><td>  Hoch </td></tr><tr><td>  4 </td><td>  Ein paar </td><td>  Ein paar </td><td>  +++ </td><td>  +++ </td><td>  Hoch </td></tr></tbody></table></div><br><p>  Achten Sie darauf: </p><br><ul><li>  In der Anwendung auf eine Anwendung in einer Instanz (Nr. 1) kann sich der Speichergewinn als Null oder sogar negativ herausstellen (insbesondere bei Messungen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unter Windows</a> ). </li><li>  Das Erstellen des richtigen freigegebenen Archivs erfordert Aktionen, deren Komplexit√§t nicht davon abh√§ngt, wie viele Kopien die Anwendung dann gestartet wird (vergleichen Sie die Optionspaare Nr. 1-2 und Nr. 3-4). </li><li>  Gleichzeitig f√ºhrt der √úbergang von einer Instanz zu mehreren offensichtlich zu einer Gewinnsteigerung f√ºr beide Indikatoren, hat jedoch keinen Einfluss auf die Komplexit√§t der Vorbereitung. </li></ul><br><p>  In diesem Artikel werden wir <strong>nur die Option Nr. 2</strong> (bis Nr. 1) erreichen, da sie f√ºr eine enge Bekanntschaft mit AppCDS einfach genug ist und wir nur ohne zus√§tzliche Tricks das k√ºrzlich ver√∂ffentlichte dynamische CDS-Archiv <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JEP-350 verwenden k√∂nnen</a> , das ich in Aktion f√ºhlen m√∂chte. </p><br><h3 id="dynamic-cds-archives">  Dynamische CDS-Archive </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das</a> dynamische CDS-Archiv <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JEP-350</a> , eine der wichtigsten Innovationen von Java 13, soll die Verwendung von AppCDS vereinfachen.  Um die Vereinfachung zu sp√ºren, m√ºssen Sie zuerst die Komplexit√§t verstehen.  Ich m√∂chte Sie daran erinnern, dass der klassische ‚Äûsaubere‚Äú Algorithmus zum Anwenden von AppCDS aus drei Schritten besteht: (1) Abrufen einer Liste gemeinsam genutzter Klassen, (2) Erstellen eines Archivs daraus und (3) Ausf√ºhren der Anwendung mit verbundenem Archiv.  Von diesen Schritten ist nur der dritte tats√§chlich n√ºtzlich, der Rest ist nur die Vorbereitung daf√ºr.  Und obwohl das Abrufen einer Liste von Klassen (Schritt 1) ‚Äã‚Äãsehr einfach erscheint (in einigen F√§llen ist dies nicht einmal erforderlich), erweist es sich bei der Arbeit mit nicht trivialen Anwendungen als am schwierigsten, insbesondere im Hinblick auf Spring Boot.  JEP-350 wird also nur ben√∂tigt, um diesen Schritt zu eliminieren oder vielmehr zu automatisieren.  Die Idee ist, dass die JVM selbst eine Liste der Klassen erstellt, die die Anwendung ben√∂tigt, und dann selbst das sogenannte ‚Äûdynamische‚Äú Archiv daraus bildet.  Stimmen Sie zu, es klingt gut.  Der Haken ist jedoch, dass jetzt unklar wird, wann die Ansammlung von Klassen beendet und diese im Archiv abgelegt werden sollen.  Zuvor haben wir im klassischen AppCDS einen solchen Moment selbst ausgew√§hlt und konnten sogar zwischen diesen Aktionen wechseln, um etwas in der Liste der Klassen zu √§ndern, bevor wir es in ein Archiv verwandeln.  Jetzt geschieht dies automatisch und nur zu einem Zeitpunkt, f√ºr den die JVM-Ingenieure m√∂glicherweise die einzige Kompromissoption gew√§hlt haben - das regelm√§√üige Herunterfahren der JVM.  Dies bedeutet, dass das Archiv erst erstellt wird, wenn die Anwendung gestoppt wird.  Diese L√∂sung hat einige wichtige Konsequenzen: </p><br><ul><li>  Im Falle eines JVM-Absturzes wird das Archiv nicht erstellt, egal wie wunderbar die Liste der bis dahin angesammelten Klassen w√§re (Sie k√∂nnen sie sp√§ter nicht mit regul√§ren Mitteln extrahieren). </li><li>  Das Archiv wird nur aus den Klassen erstellt, die w√§hrend der Anwendungssitzung geladen werden konnten.  F√ºr Webanwendungen bedeutet dies, dass das Erstellen eines Archivs durch Starten und Stoppen direkt dort nicht korrekt ist, da dann viele wichtige Klassen nicht in das Archiv gelangen.  Es ist erforderlich, mindestens eine HTTP-Anforderung an die Anwendung auszuf√ºhren (und es ist besser, sie in allen Szenarien ordnungsgem√§√ü auszuf√ºhren), damit alle Klassen, die sie tats√§chlich verwendet, geladen werden. </li></ul><br><p>  Ein wichtiger Unterschied zwischen dynamischen und statischen Archiven besteht darin, dass sie immer ein ‚ÄûAdd-On‚Äú gegen√ºber statischen Basisarchiven darstellen. Diese Archive k√∂nnen entweder in das Java Distribution Kit integriert oder auf klassische 3-Schritt-Weise separat erstellt werden. </p><br><p>  Syntaktisch gesehen bedeutet die Verwendung von Dynamic CDS Archives zwei JVM-Starts mit zwei Optionen: </p><br><ol><li>  Testlauf mit der Option <code>-XX:ArchiveClassesAtExit=archive.jsa</code> , an dessen Ende ein dynamisches Archiv erstellt wird (Sie k√∂nnen einen beliebigen Pfad und Namen angeben). </li><li>  N√ºtzlicher Start mit der Option <code>-XX:SharedArchiveFile=archive.jsa</code> , die das zuvor erstellte Archiv verwendet </li></ol><br><p>  Die zweite Option unterscheidet sich nicht vom Verbinden eines regul√§ren statischen Archivs.  Befindet sich das statische Basisarchiv pl√∂tzlich nicht mehr am Standardspeicherort (innerhalb des JDK), enth√§lt diese Option m√∂glicherweise auch eine Angabe des Pfads dazu, z. B.: </p><br><pre> <code class="bash hljs">-XX:SharedArchiveFile=base.jsa:dynamic.jsa</code> </pre> <br><p>  <em>(Unter Windows muss das Pfadtrennzeichen das Zeichen ";" sein.)</em> </p><br><p>  Jetzt wissen Sie genug √ºber AppCDS, damit Sie es in Aktion betrachten k√∂nnen. </p><br><h2 id="praktika">  √úbe </h2><br><h3 id="podopytnyy-krolik">  Experimentelles Kaninchen </h3><br><p>  Damit unsere Anwendung von AppCDS in der Praxis nicht auf eine typische HelloWorld beschr√§nkt ist, werden wir die eigentliche Anwendung auf Spring Boot als Grundlage nehmen.  Meine Kollegen und ich m√ºssen h√§ufig Anwendungsprotokolle auf Remote-Testservern und "live" ansehen, so wie sie geschrieben wurden.  Um dies zu verwenden, ist ein vollwertiger Protokollaggregator (wie ELK) oft nicht geeignet.  Das endlose Herunterladen von Protokolldateien - f√ºr eine lange Zeit und das Betrachten der grauen Konsolenausgabe von <code>tail</code> ist deprimierend.  Aus diesem Grund habe ich eine Webanwendung erstellt, mit der alle Protokolle in Echtzeit direkt an den Browser ausgegeben, Linien nach Wichtigkeitsgrad koloriert (gleichzeitig XML formatiert), mehrere Protokolle zu einem zusammengefasst und andere Tricks ausgef√ºhrt werden k√∂nnen.  Es hei√üt <strong>ANALOG</strong> (z. B. ein ‚ÄûLog Analyzer‚Äú, obwohl dies nicht der Fall ist) und liegt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auf GitHub</a> .  Klicken Sie auf den Screenshot, um ihn zu vergr√∂√üern: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/q3/lo/m_/q3lom_x6c9wghlerm1g9oa9-yfw.png"></a> </p><br><p>  Technisch gesehen ist dies eine Anwendung f√ºr Spring Boot + Spring Integration, unter deren Haube <code>tail</code> , <code>docker</code> und <code>kubectl</code> (um Protokolle von Dateien, Docker-Containern bzw. Kubernetes-Ressourcen zu unterst√ºtzen).  Es kommt in Form der klassischen "dicken" Spring Boot JAR-Datei.  Zur Laufzeit <strong>h√§ngen 10K-Klassen</strong> im Anwendungsspeicher, von denen die √ºberwiegende Mehrheit Spring- und JDK-Klassen sind.  Offensichtlich √§ndern sich diese Klassen ziemlich selten, was bedeutet, dass sie in ein gemeinsam genutztes Archiv gestellt und in allen Instanzen der Anwendung wiederverwendet werden k√∂nnen, wodurch Speicher und CPU gespart werden. </p><br><h3 id="odinochnyy-eksperiment">  Einzelversuch </h3><br><p>  Wenden wir nun das vorhandene Wissen √ºber Dynamic AppCDS auf das experimentelle Kaninchen an.  Da im Vergleich alles bekannt ist, ben√∂tigen wir einen Bezugspunkt - den Stand des Programms, mit dem wir die w√§hrend des Experiments erzielten Ergebnisse vergleichen. </p><br><h4 id="vvodnye-zamechaniya">  Einleitende Bemerkungen </h4><br><ul><li>  Alle weiteren Befehle gelten f√ºr Linux.  Unterschiede f√ºr Windows und MacOS sind nicht grundlegend. </li><li>  Die JIT-Kompilierung kann die Ergebnisse sp√ºrbar beeinflussen und theoretisch aus <code>-Xint</code> der Reinheit des Experiments <code>-Xint</code> werden (mit der Option <code>-Xint</code> , wie im genannten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel beschrieben</a> ). Aus Gr√ºnden der maximalen Glaubw√ºrdigkeit wurde jedoch beschlossen, dies nicht zu tun. </li><li>  Die folgenden Zahlen zur Startzeit wurden auf einem schnellen Testserver erhalten.  Auf Arbeitsmaschinen sind √§hnliche Zahlen in der Regel bescheidener, aber da wir nicht an absoluten Werten, sondern an prozentualen Inkrementen interessiert sind, halten wir diesen Unterschied f√ºr unbedeutend. </li><li>  Um nicht vorzeitig auf die Komplexit√§t der Messung des gemeinsam genutzten Speichers einzugehen, werden wir vorerst darauf verzichten, genaue Messwerte in Bytes zu erhalten.  Stattdessen f√ºhren wir das Konzept des ‚Äû <strong>CDS-Potenzials</strong> ‚Äú ein, ausgedr√ºckt als Prozentsatz der Anzahl gemeinsam genutzter Klassen zur Gesamtzahl der geladenen Klassen.  Dies ist nat√ºrlich eine abstrakte Gr√∂√üe, wirkt sich jedoch direkt auf den tats√§chlichen Speicherverbrauch aus.  Dar√ºber hinaus h√§ngt seine Definition √ºberhaupt nicht vom Betriebssystem ab, und f√ºr die Berechnung sind nur Protokolle ausreichend. </li></ul><br><h4 id="referentnaya-tochka">  Bezugspunkt </h4><br><p>  Dieser Punkt sei der Zustand einer frisch heruntergeladenen Anwendung, d.h.  ohne ausdr√ºckliche Verwendung von AppCDS'ov und anderen.  Um es zu bewerten, brauchen wir: </p><br><ol><li><p>  Installieren Sie OpenJDK 13 (z. B. die inl√§ndische <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Liberica-</a> Distribution, jedoch nicht die Lite-Version). <br>  Es muss beispielsweise auch der Umgebungsvariablen PATH oder <code>JAVA_HOME</code> hinzugef√ºgt werden: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_HOME=~/tools/jdk-13</code> </pre> <br></li><li><p>  <a href="">Laden Sie</a> ANALOG <a href="">herunter</a> (zum Zeitpunkt des Schreibens war die neueste Version v0.12.1). </p><br><p>  Bei Bedarf k√∂nnen Sie in der Datei <code>config/application.yaml</code> im Parameter <code>server.address</code> den externen Hostnamen f√ºr den Zugriff auf die Anwendung angeben (standardm√§√üig wird dort <code>localhost</code> angegeben). </p><br></li><li><p>  Aktivieren Sie die Ladeprotokollierung f√ºr JVM-Klassen. <br>  Dazu k√∂nnen Sie die Umgebungsvariable <code>JAVA_OPTS</code> mit folgendem Wert <code>JAVA_OPTS</code> : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=-Xlog:class+load=info:file=<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/class-load.log</code> </pre> <br><p>  Diese Option wird an die JVM √ºbergeben und weist sie an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">, die</a> Quelle jeder Klasse zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verpf√§nden</a> . </p><br></li><li><p>  F√ºhren Sie einen Testlauf durch: </p><br><ol><li>  F√ºhren Sie die Anwendung mit dem Skript <code>bin/analog</code> </li><li>  √ñffnen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">http: // localhost: 8083</a> im Browser, stecken Sie Schaltfl√§chen und Morgengrauen </li><li>  Beenden Sie die Anwendung, indem Sie in der Konsole <code>bin/analog</code> script <code>Ctrl+C</code> dr√ºcken </li></ol><br></li><li><p>  Nehmen Sie das Ergebnis (aus Dateien im <code>log/</code> Verzeichnis) </p><br><ul><li><p>  Gesamtzahl der geladenen Klassen (nach <code>class-load.log</code> ): </p><br><pre> <code class="bash hljs">cat class-load.log | wc -l 10463</code> </pre> <br></li><li><p>  Wie viele von ihnen werden aus einem freigegebenen Archiv heruntergeladen (entsprechend): </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'source: shared'</span></span> - class-load.log 1146</code> </pre> <br></li><li><p>  Durchschnittliche Startzeit (nach einer Reihe von Starts; per <code>analog.log</code> ): </p><br><pre> <code class="bash hljs">grep -oE <span class="hljs-string"><span class="hljs-string">'\(JVM running for .+\)'</span></span> analog.log | grep -oE <span class="hljs-string"><span class="hljs-string">'[0-9]\.[0-9]+'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{ total += $1; count++ } END { print total/count }'</span></span> 4.5225</code> </pre> <br></li></ul><br></li></ol><br><p>  In diesem Schritt betrug das Potential von CDS also <code>1146/10463=0,1095</code> <strong>~ 11%</strong> .  Wenn Sie √ºberrascht sind, woher die gemeinsam genutzten Klassen stammen (schlie√ülich haben wir noch kein AppCDS aufgenommen), erinnere ich Sie daran, dass das JDK ab der 12. Version <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">das</a> fertige CDS-Archiv <code>$JAVA_HOME/lib/server/classes.jsa</code> von nicht weniger als fertig Liste der Klassen: </p><br><pre> <code class="bash hljs">cat <span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/lib/classlist | wc -l 1170</code> </pre> <br><p>  Nachdem wir nun den Anfangszustand der Anwendung bewertet haben, k√∂nnen wir AppCDS darauf anwenden und im Vergleich verstehen, was dies ergibt. </p><br><h4 id="osnovnoy-opyt">  Kernerfahrung </h4><br><p>  Wie die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> uns hinterlassen hat, m√ºssen Sie zum Erstellen eines dynamischen AppCDS-Archivs nur einen Testlauf der Anwendung mit der Option <code>-XX:ArchiveClassesAtExit</code> .  Ab dem n√§chsten Start kann das Archiv genutzt werden und Gewinn erzielen.  Um dies an demselben experimentellen Kaninchen (AnaLog) zu √ºberpr√ºfen, ben√∂tigen Sie: </p><br><ol><li><p>  F√ºgen Sie dem Befehl run die angegebene Option hinzu: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -XX:ArchiveClassesAtExit=work/classes.jsa"</span></span></code> </pre> <br></li><li><p>  Protokollierung erweitern: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -Xlog:cds=debug:file=log/cds.log"</span></span></code> </pre><br><p>  Diese Option erzwingt die Protokollierung des Prozesses zum Erstellen eines CDS-Archivs, wenn die Anwendung gestoppt wird. </p><br></li><li><p>  F√ºhren Sie den gleichen Testlauf wie mit dem Referenzpunkt durch: </p><br><ol><li>  F√ºhren Sie die Anwendung mit dem Skript <code>bin/analog</code> </li><li>  √ñffnen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">http: // localhost: 8083</a> im Browser, stecken Sie Schaltfl√§chen und Morgengrauen </li><li>  Beenden Sie die Anwendung, indem Sie in der Konsole <code>bin/analog</code> script <code>Ctrl+C</code> dr√ºcken <br>  Danach sollte ein riesiger Fu√ütuch mit allen m√∂glichen Warnungen in die Konsole fallen und die <code>log/cds.log</code> sollte mit Details gef√ºllt sein.  Sie interessieren uns noch nicht. </li></ol><br></li><li><p>  Schalten Sie den Startmodus von "Test" auf "N√ºtzlich" um: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"-XX:SharedArchiveFile=work/classes.jsa -Xlog:class+load=info:file=log/class-load.log -Xlog:class+path=debug:file=log/class-path.log"</span></span></code> </pre><br><p>  Hier erg√§nzen wir die Variable <code>JAVA_OPTS</code> , sondern √ºberschreiben sie mit neuen Werten, die (1) die Verwendung eines gemeinsam genutzten Archivs, (2) das Protokollieren von <code>JAVA_OPTS</code> und (3) das Protokollieren von Klassenpfadpr√ºfungen umfassen. </p><br></li><li><p>  F√ºhren Sie einen n√ºtzlichen Start der Anwendung gem√§√ü dem Schema aus Absatz 3 durch. </p><br></li><li><p>  Nehmen Sie das Ergebnis (aus Dateien im <code>log/</code> Verzeichnis) </p><br><ul><li><p>  √úberpr√ºfen, ob AppCDS wirklich angewendet wurde ( <code>class-path.log</code> ): </p><br><pre> <code class="plaintext hljs">[0.011s][info][class,path] type=BOOT [0.011s][info][class,path] Expecting BOOT path=/home/upc/tools/jdk-13/lib/modules [0.011s][info][class,path] ok [0.011s][info][class,path] type=APP [0.011s][info][class,path] Expecting -Djava.class.path=/home/upc/tmp/analog/lib/analog.jar [0.011s][info][class,path] ok</code> </pre><br><p>  Die <code>ok</code> Markierungen nach den Zeilen <code>type=BOOT</code> und <code>type=APP</code> zeigen das erfolgreiche √ñffnen, √úberpr√ºfen und Laden der integrierten bzw. angewendeten CDS-Archive an. </p><br></li><li><p>  Gesamtzahl der geladenen Klassen (nach <code>class-load.log</code> ): </p><br><pre> <code class="bash hljs">cat class-load.log | wc -l 10403</code> </pre><br></li><li><p>  Wie viele von ihnen werden aus einem freigegebenen Archiv heruntergeladen (entsprechend): </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'source: shared'</span></span> -c class-load.log 6910</code> </pre><br></li><li><p>  Durchschnittliche Startzeit (nach einer Reihe von Starts; per <code>analog.log</code> Datei): </p><br><pre> <code class="bash hljs">grep -oE <span class="hljs-string"><span class="hljs-string">'\(JVM running for .+\)'</span></span> analog.log | grep -oE <span class="hljs-string"><span class="hljs-string">'[0-9]\.[0-9]+'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{ total += $1; count++ } END { print total/count }'</span></span> 4.04167</code> </pre><br></li></ul><br></li></ol><br><p>  In diesem Schritt betrug das Potenzial von CDS jedoch bereits <code>6910/10403‚âà0,66</code> <strong>= 66%</strong> , <code>6910/10403‚âà0,66</code> es stieg <strong>um 55%</strong> gegen√ºber dem Referenzpunkt.  Gleichzeitig wurde die durchschnittliche Startzeit um <code>(4,5225-4,04167)=0,48</code> Sekunden verringert, d.h.  Der Start ist um <strong>~ 10,6%</strong> des Anfangswertes schneller. </p><br><h4 id="analiz-rezultatov">  Ergebnisanalyse </h4><br><p>  <em>Der Arbeitstitel des Artikels lautet: "Warum so wenig?"</em> </p><br><p>  Wir haben alles nach den Anweisungen gemacht, aber nicht alle Klassen waren im Archiv.  Ihre Anzahl beeinflusst die Startzeit nicht weniger als die Rechenleistung der Maschine des Experimentators, daher werden wir uns auf diese Zahl konzentrieren. </p><br><p>  Wenn Sie sich erinnern, haben wir die Datei <code>log/cds.log</code> ignoriert, die beim Stoppen der experimentellen Anwendung nach dem Testlauf erstellt wurde.  In dieser HotSpot-Datei hat die JVM freundlicherweise Warnklassen f√ºr jede Klasse notiert, die nicht im CDS-Archiv enthalten waren.  Hier ist die Gesamtzahl solcher Marken: </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'[warning]'</span></span> cds.log -c 3591</code> </pre><br><p>  Angesichts der Tatsache, dass im Protokoll <code>class-load.log</code> nur mehr als <code>class-load.log</code> Klassen erw√§hnt werden und 66% davon aus dem Archiv heruntergeladen werden, ist es nicht schwer zu verstehen, dass die in <code>cds.log</code> aufgef√ºhrten 3600 Klassen die ‚Äûfehlenden‚Äú 44% des CDS-Potenzials sind.  Jetzt m√ºssen Sie herausfinden, warum sie √ºbersprungen wurden. </p><br><p>  Wenn Sie sich das Protokoll cds.log ansehen, stellt sich heraus, dass es nur vier eindeutige Gr√ºnde f√ºr das √úberspringen von Klassen gibt.  Hier sind Beispiele f√ºr jeden von ihnen: </p><br><pre> <code class="plaintext hljs">Skipping org/springframework/web/client/HttpClientErrorException: Not linked Pre JDK 6 class not supported by CDS: 49.0 org/jrobin/core/RrdUpdater Skipping java/util/stream/Collectors$$Lambda$554: Unsafe anonymous class Skipping ch/qos/logback/classic/LoggerContext: interface org/slf4j/ILoggerFactory is excluded</code> </pre><br><p>  Unter allen 3591 verpassten Klassen finden sich hier folgende Gr√ºnde: </p><br><p><img src="https://habrastorage.org/webt/sp/f6/6k/spf66kzmkajvdxki1xdiwjyx9lg.png"></p><br><p>  Schauen Sie sie sich genauer an: </p><br><ul><li><p> <code>Unsafe anonymous class</code> <br>   JVM   ‚Äú‚Äù   ,       -,         . </p><br></li><li><p> <code>Not linked</code> <br>      , ‚Äú‚Äù     ,  ,   .      ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">StackOverflow </a>    . , ,       ‚Äú‚Äù () JAR-  ,   AppCDS.       ,     (  ). </p><br></li><li><p> <code>Pre JDK 6 class</code> <br>  ,   CDS    Java 5.        class-   ,   CDS    .    ,    ,  6,  Java,       .       -   ,      runtime- (, slf4j). </p><br></li><li><p> <code>Skipping ... : super class/interface ... is excluded</code> <br>   ,  ‚Äú‚Äù     .          CDS',    .  Zum Beispiel: </p><br><pre> <code class="plaintext hljs">[warning][cds] Pre JDK 6 class not supported by CDS: 49.0 org/slf4j/spi/MDCAdapter [warning][cds] Skipping ch/qos/logback/classic/util/LogbackMDCAdapter: interface org/slf4j/spi/MDCAdapter is excluded</code> </pre><br></li></ul><br><p>  <strong>Fazit</strong> </p><br><blockquote>  CDS       100%. </blockquote><p> ,     ,  ,         ,  ,     .      . </p><br><h3 id="mnozhestvennyy-eksperiment">   </h3><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JEP-310</a> , AppCDS                         JDK.   .       ,     .    CDS (, ,     )       . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um das experimentelle Kaninchen zu klonen (AnaLog in mehreren F√§llen ausf√ºhren), m√ºssen wir etwas an den Einstellungen √§ndern. </font><font style="vertical-align: inherit;">Dadurch k√∂nnen die angehobenen Prozesse nicht ‚Äûgebeugt‚Äú werden. </font><font style="vertical-align: inherit;">Dank Spring Boot k√∂nnen Sie dies tun, ohne Dateien zu bearbeiten oder zu kopieren. </font><font style="vertical-align: inherit;">Alle Einstellungen k√∂nnen durch JVM-Optionen √ºberschrieben werden. </font><font style="vertical-align: inherit;">Das Weiterleiten dieser Optionen von einer Umgebungsvariablen </font></font><code>ANALOG_OPTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stellt ein Startskript bereit, das freundlicherweise von Gradle generiert wird.</font></font></p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"-Djavamelody.enabled=false -Dlogging.config=classpath:logging/logback-console.xml"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ANALOG_OPTS</span></span></span><span class="hljs-string"> -Dnodes.this.agentPort=7801 -Dserver.port=8091"</span></span></code> </pre><br><p>      JavaMelody,             ,        ,       .     TCP-    ;       . </p><br><p>  ,    ,   JVM      AppCDS    .         <code>JAVA_OPTS</code>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JVM Unified Logging Framework</a> : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"-Xlog:class+load=info:file=log/class-load-%p.log -Xlog:class+path=debug:file=log/class-path-%p.log"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -XX:SharedArchiveFile=work/classes.jsa"</span></span></code> </pre><br><p>        <code>%p</code> ,    JVM      (PID).   AppCDS  ,     (         ). </p></div></div><br><h4 id="osnovnoy-opyt-1">   </h4><br><p>  ,          .                  .     : </p><br><ol><li><p>      <code>server.port</code>  <code>nodes.this.agentPort</code> ,      : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ANALOG_OPTS</span></span></span><span class="hljs-string"> -Dnodes.this.agentPort=7801 -Dserver.port=8091"</span></span></code> </pre><br><p> ,       (    ). </p><br></li><li><p>    <code>bin/analog</code> </p><br><p> <em>()</em>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">http://localhost:8091</a>  ,     </p><br></li><li><p>  PID  (  ), : </p><br><pre> <code class="bash hljs">pgrep -f analog 13792</code> </pre><br></li><li><p>      <code>pmap</code> (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> ): </p><br><pre> <code class="bash hljs">pmap -XX 13792 | sed -n -e <span class="hljs-string"><span class="hljs-string">'2p;$p'</span></span> Address Perm Offset Device Inode Size KernelPageSize MMUPageSize Rss Pss Shared_Clean Shared_Dirty Private_Clean Private_Dirty Referenced Anonymous LazyFree AnonHugePages ShmemPmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked ProtectionKey VmFlagsMapping 3186952 1548 1548 328132 325183 3256 0 10848 314028 212620 314024 0 0 0 0 0 0 0 325183 0 KB</code> </pre><br><p>           ;   . </p><br></li><li><p>   1-4     (,  ). </p><br></li></ol><br><h4 id="analiz-rezultatov-1">   </h4><br><p>    <code>pmap</code>             .        CDS'    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">   </a> .    ,  ,        PSS: </p><br><blockquote> The "proportional set size" (PSS) of a process is the count of pages it has in memory, where each page is divided by the number of processes sharing it. So if a process has 1000 pages all to itself, and 1000 shared with one other process, its PSS will be 1500. </blockquote><p>  ,   ,  ‚Äú ‚Äù .        ,      . </p><br><p>    PSS       ,    : </p><br><div class="scrollable-table"><table><thead><tr><th> Iteration: </th><th>  1 </th><th>  2 </th><th>  3 </th><th>  4 </th><th>  5 </th></tr></thead><tbody><tr><td> PSS of inst#1: </td><td> 339 088 </td><td> 313 778 </td><td> 305 517 </td><td> 301 153 </td><td> 298 604 </td></tr><tr><td> PSS of inst#2: </td><td></td><td> 314 904 </td><td> 306 567 </td><td> 302 555 </td><td> 299 919 </td></tr><tr><td> PSS of inst#3: </td><td></td><td></td><td> 314 914 </td><td> 311 008 </td><td> 308 691 </td></tr><tr><td> PSS of inst#4: </td><td></td><td></td><td></td><td> 306 563 </td><td> 304 495 </td></tr><tr><td> PSS of inst#5: </td><td></td><td></td><td></td><td></td><td> 294 686 </td></tr><tr><td> <em>Average:</em> </td><td> 339 088 </td><td> 314 341 </td><td> 308 999 </td><td> 305 320 </td><td> 301 279 </td></tr></tbody></table></div><br><p>         ,      - : </p><br><ul><li>        ‚Äú‚Äù  </li><li>     , PSS   </li><li>  ‚Äú‚Äù ,     PSS      </li></ul><br><p>    ,      .         AppCDS.        ,       <code>-XX:SharedArchiveFile=work/classes.jsa</code>   <code>-Xshare:off</code> ,    CDS .              ,    . </p><br><p><img src="https://habrastorage.org/webt/vq/4s/n6/vq4sn66zppmcyl5aovqj6xpkwyq.png"></p><br><p>       : </p><br><ul><li><p>  PSS  AppCDS      CDS. <br>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> .  ,  ,    HelloWorld- JVM   CDS   2   ,   CDS.      PSS            CDS,     .        : </p><br></li><li><p>    PSS   AppCDS    2-  ; 3-      . <br>        ,      ,    ,     .  ,        AppCDS,   ,   ,      3-    . <br>  :    ,    CDS?      : </p><br></li><li><p>    CDS/AppCDS  JVM      ,  PSS       .  ,    ,      <code>pmap</code> ,   ‚Äú‚Äù   <code>sed</code> '.              : </p><br><pre> <code class="bash hljs">pmap -X `pgrep -f analog` 14981: <span class="hljs-comment"><span class="hljs-comment"># ... Address Perm Offset Device Inode Size Rss Pss ... Mapping # ... ... 7faf5e31a000 r-xp 00000000 08:03 269427 17944 14200 14200 ... libjvm.so # ... ... 7faf5f7f9000 r-xp 00000000 08:03 1447189 1948 1756 25 ... libc-2.27.so</span></span></code> </pre><br><p>       ( <code>Mapping</code> )  , ‚Äú‚Äù      .       JVM  ( <code>libjvm.so</code>   ),     ( <code>libc-2.27.so</code>  ).    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>        : </p><br><blockquote> For the Java VM, the read-only parts of the loaded shared libraries (ie <code>libjvm.so</code> ) can be shared between all the VM instances running at the same time. This explains why, taking together, the two VM's consume less memory (ie have a smaller memory footprint) than the simple sum of their single resident set sizes when running alone. </blockquote><br></li></ul><br><p>           .     ,  , .  ,          ,         JVM     ,    Java-    .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  </a>  GeekOut: </p><br><p><img src="https://habrastorage.org/webt/wp/ia/qo/wpiaqom-2teiw_iegjacskkt3sm.png"></p><br><p> , , ,      AppCDS    , ..     Java-.   ,             JVM,  , -      . </p><br><p>       VisualVM      Metaspace    AppCDS  ,      : </p><br><p> <strong> AppCDS</strong> </p><br><p><img src="https://habrastorage.org/webt/pt/wv/6r/ptwv6rmyk8j7f7yzgxrjkqrsvww.png"></p><br><p> <strong> AppCDS</strong> </p><br><p><img src="https://habrastorage.org/webt/dt/jn/0m/dtjn0mdpcgykbfynjbwdma2vmqm.png"></p><br><p>   ,         128     Metaspace   AppCDS    <code>64.2 MiB / 8.96 MiB</code> <strong>‚âà7,2  </strong> ,   CDS .            (.  )       <code>66.4 MiB / 13.9 MiB</code> <strong>‚âà4,8 </strong> .      ,    AppCDS      ,       Metaspace.            Metaspace,    ,    CDS . </p><br><h2 id="vmesto-zaklyucheniya">  Anstelle einer Schlussfolgerung </h2><br><p>            Spring Boot  AppCDS ‚Äì  JVM,        . </p><br><ul><li>            JEP-350 Dynamic CDS Archives ‚Äì    JDK 13. </li><li>    Spring Boot  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√≥</a>          CDS (  ). ,           100%   -   <strong>66%</strong> .      ,      <strong>‚âà11%</strong> (    15%,      ). </li><li>     ,       5-     PSS (      ).  ,  AppCDS     ,   <strong>  </strong>           , <strong> 8%</strong> (PSS).       ,    CDS,     ,     .        AppCDS  <strong> </strong> . </li><li>          Metaspace,  ,         AppCDS  <strong> 5  </strong> ,   CDS. </li></ul><br><p> ,    , AppCDS,  ,    ‚Äúkiller feature‚Äù.           Spring Boot.   ,   ,    AppCDS      .  , ,        AppCDS   <em></em>   Spring Boot.              ,      ‚Ä¶ </p><br><p> <em>  by <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nick Fewings</a> on <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Unsplash</a></em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de472638/">https://habr.com/ru/post/de472638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de472620/index.html">Museum DataArt. Inspektion des Mera CM 7209 Videoterminals</a></li>
<li><a href="../de472622/index.html">Nivellierungsplan f√ºr den Beruf Data Engineer</a></li>
<li><a href="../de472626/index.html">ASRock Z390 Phantom Gaming 7 Motherboard Test: Vorbereitung f√ºr 9900KS</a></li>
<li><a href="../de472628/index.html">Codierungen, Shift-Chiffre, Brute-Hashes und Bilderstellung mit PIL-Python. Probleml√∂sung mit r0ot-mi Cryto. Teil 1</a></li>
<li><a href="../de472636/index.html">DotNext 2019 Moskauer Programm√ºbersicht: Wer sagt Ihnen was?</a></li>
<li><a href="../de472640/index.html">Was ich in 6 Jahren gelernt habe, um Startups beim Wachstum zu unterst√ºtzen</a></li>
<li><a href="../de472642/index.html">Freelance webdev - wie und mit wem Sie NICHT arbeiten sollten</a></li>
<li><a href="../de472644/index.html">Praktika in internationalen Unternehmen: Wie man das Interview nicht ausf√ºllt und das begehrte Angebot erh√§lt</a></li>
<li><a href="../de472650/index.html">Angst, Schmerz und Hass auf technische Unterst√ºtzung</a></li>
<li><a href="../de472658/index.html">Fast alles √ºber die Zukunft HolyJS 2019 Moskau</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>