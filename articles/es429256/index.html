<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüîß üí™ üö£üèª C√≥mo hacer crecer un bosque en Actionscript3 / Flash en unas pocas * l√≠neas de c√≥digo üî∑ üõÄüèº üõ∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este comentario, me jact√© de haber escrito un programa que cre√≥ un bosque "decente" en doscientas l√≠neas de c√≥digo. Desafortunadamente, la realidad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo hacer crecer un bosque en Actionscript3 / Flash en unas pocas * l√≠neas de c√≥digo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429256/">  En este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comentario,</a> me jact√© de haber escrito un programa que cre√≥ un bosque "decente" en doscientas l√≠neas de c√≥digo.  Desafortunadamente, la realidad result√≥ ser un poco m√°s grande: las fuentes excavadas contienen alrededor de 2100 l√≠neas de c√≥digo, de las cuales alrededor de 700 son comentarios, pensamientos en voz alta, c√≥digo viejo descartado e intentos de documentar m√©todos.  Sin embargo, el tama√±o del ejecutable SWF result√≥ ser 13112 bytes. <br><br>  Todo comenz√≥ con el hecho de que en el foro Kongregate.com, donde estaba pasando el rato activamente en ese momento, uno de los participantes sugiri√≥ competir en la generaci√≥n procesal de algo, el primer tema fue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Bosque"</a> . <br><br><img src="https://habrastorage.org/webt/hm/qt/av/hmqtavjkbvff-lrzqdg37j6oge8.png"><br><a name="habracut"></a><br>  Naturalmente, todos ten√≠an su propia idea de lo que deber√≠a ser el bosque que cultivar√≠an.  En ese momento le√≠ libros sobre todo tipo de magia, como resultado, quer√≠a cultivar un bosque.  El bosque est√° formado por √°rboles: escribimos la clase √Årbol {...}.  Un √°rbol consta de ramas y hojas: escribimos la clase Rama {...} y pensamos, ¬ørealmente necesitamos tener en cuenta cada hoja del √°rbol?  Como resultado, la "rama" adquiri√≥ el par√°metro "con hojas", y el √°rbol adquiri√≥ un par de texturas, una para las ramas y un tronco, una para las hojas.  La textura "debajo del √°rbol" era relativamente simple de hacer: hay un ruido de perlin, puedes estirarlo, envolverlo, pintarlo, considerarlo listo, pero ten√≠as que jugar con las hojas. <br><br>  Sin embargo, no estaba contento con solo el ruido de la guinda de la textura de un √°rbol; en su lugar, se me ocurri√≥ un mapa de relieve, es decir  Cre√≥ un mapa de altura, lo ajust√≥ debajo del semic√≠rculo de la rama visible desde el lado, luego rellen√≥ la textura principal con marr√≥n y superpuso un mapa de altura con la iluminaci√≥n ajustada al chirrido lateral.  El c√≥digo resultante es el siguiente: <br><br><pre><code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateBranch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:void </span></span>{ branchBitmap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapData(<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">0xff8080ff</span></span>); <span class="hljs-comment"><span class="hljs-comment">//branchBitmap.perlinNoise(32, 256, 2, 100 + Math.round(Math.random() * 900), true, true, 7, true); var hm:BitmapData = new BitmapData(512, 512, false, 0); var seed:int = 1000 + Math.random() * 2000; hm.perlinNoise(24,192, 2, seed, true, true, BitmapDataChannel.BLUE, false); // blue only. Is a heightmap var i:int; var j:int; for (i = 0; i &lt; 512; i++) { if (Math.abs(i - 256) &gt; 100) r = 0; else r = 200 * Math.sqrt(1 - (i - 256) * (i - 256) / 10000);// square curve //r = 200 * Math.sin(Math.PI * (i - 128) / 256); // sine curve for (j = 0; j &lt; 512; j++) hm.setPixel(i, j, Math.round(r*(500.0 + (hm.getPixel(i, j)-128))*0.002)); // now, r means position on the "log", and initial perlin noise is log's texture. // perlinNoise median 128, highest offset taking as 100, the result offset needs to be ~0.2 in multiplier } var v:Vector.&lt;int&gt; = new Vector.&lt;int&gt;(); var vv:Vector.&lt;Number&gt; = new Vector.&lt;Number&gt;(3); for (i = 1; i &lt; 511; i++) { v.length = 0; v.push(hm.getPixel(0, i-1), hm.getPixel(1, i-1), hm.getPixel(2, i-1), hm.getPixel(0, i), hm.getPixel(1, i), hm.getPixel(2, i), hm.getPixel(0, i+i), hm.getPixel(1, i+1), hm.getPixel(2, i+1)); for (j = 1; j &lt; 510; j++) { var g:int = -1 * v[0] - 2 * v[1] - 1 * v[2] + 1 * v[8] + 2 * v[7] + 1 * v[6]; // gradient by Y var r:int = -1 * v[0] - 2 * v[3] - 1 * v[6] + 1 * v[2] + 2 * v[5] + 1 * v[8]; // gradient by X //if ((i &gt; 50) &amp;&amp; (i &lt; 55) &amp;&amp; (j &gt; 50) &amp;&amp; (j &lt; 55)) trace(g, r); var b:int = v[5]; r += 128; g += 128; var p:uint = r *0x10000 + g*0x100 + b; branchBitmap.setPixel(j, i, p); v.shift(); v.push(hm.getPixel(j + 2, i + 1)); v[2] = hm.getPixel(j + 2, i - 1); v[5] = hm.getPixel(j + 2, i); } } var bf:BlurFilter = new BlurFilter(2,8); // ___ // bevelFilter is not what I need, it bevels a rectangle and just that [___] // dropShadowFilter requires empty alpha I believe // convolution filter works best on self, while it can do what I need branchBitmap.applyFilter(branchBitmap, branchBitmap.rect, P0, bf); hm.copyPixels(branchBitmap, branchBitmap.rect, P0); //branchBitmap.perlinNoise(32, 256, 0, seed, true, true, 7, true); // naked grayscale // 0 octaves means 50% gray filling branchBitmap.fillRect(branchBitmap.rect, 0xff808080); // it looks like I'll have enough details just by perlin-noising the heightmap var inc:Number = Math.PI / 3; var azi:Number = -Math.PI * 1 / 4; var cx:Number = Math.cos(inc) * Math.cos(azi); var cy:Number = Math.cos(inc) * Math.sin(azi); var cz:Number = Math.sin(inc); azi = 1 - 2 * cz; inc = 1 / cz; // cos(lighting) to be normalized into (0..1) via cz for (i = 0; i &lt; 512; i++) for (j = 0; j &lt; 512; j++) { p = branchBitmap.getPixel(j, i); var h:uint = hm.getPixel(j, i); // give a vector here somewhere vv[0]= (h &gt;&gt; 16)-128; vv[1] = ((h &gt;&gt; 8) &amp; 255)-128; vv[2] = 26; // balance constant, a normal is always pointing upwards, Basis.Normalize(vv); var m:Number = inc*(cx * vv[0] + cy * vv[1] + cz * vv[2]); // cos(lightangle) r = (p &gt;&gt; 16) &amp; 255; g = (p &gt;&gt; 8) &amp; 255; b = p &amp; 255; r = Math.max(0,Math.min(255, r * m)); g = Math.max(0,Math.min(255, g * m)); b = Math.max(0,Math.min(255, b * m)); branchBitmap.setPixel(j, i, 0x10000 * r + 0x100 * g + b); } branchBitmap.applyFilter(branchBitmap, branchBitmap.rect, P0,bf); // should be here, without blurring it's liney hm = new BitmapData(192, 512, false); hm.copyPixels(branchBitmap, new Rectangle(160, 0, 192, 512), P0); branchBitmap = hm; }</span></span></code> </pre> <br>  "Basis" es una clase auxiliar para vectores a la Vector3D, pero como el c√≥digo fue escrito en Flash 10.1, todav√≠a no exist√≠an tales vectores, o prefer√≠ hacer mi propia bicicleta.  La textura debajo de la rama con hojas se dibuj√≥ de la siguiente manera: al principio se hizo una hoja, luego se determin√≥ si las ramas ten√≠an una hoja central, esto determin√≥ la longitud de la pieza de la rama a la que se unieron las hojas, luego se unieron (calculado sobre la textura) en un √°ngulo a la rama por el ancho calculado de la hoja .  La forma de la hoja se estableci√≥ como un c√≠rculo distorsionado con varios puntos de referencia desplazados del c√≠rculo por un radio de media hoja, y la longitud de los esquejes se estableci√≥ por separado, todo esto se dibuj√≥ en la textura de la hoja en blanco y negro y se guard√≥ para el futuro.  (M√°s precisamente, hab√≠a dos texturas de "rama con hojas", una para los extremos, es decir, ramas para las que nada crece desde el "extremo", pero con hojas, se dibuj√≥ una hoja al final de la rama, la segunda para "medio "Sin hoja final.) <br><br>  Entonces la parte m√°s dif√≠cil es ¬øc√≥mo se ver√° el √°rbol?  Aqu√≠ pens√© y experiment√© durante mucho tiempo.  Decid√≠ hacer que el √°rbol realmente creciera: las ramas se extienden en longitud (en realidad crecen desde el extremo), a veces generan ramas a un lado, las ramas se extienden hacia el sol (hacia arriba) y un par de condiciones m√°s.  Result√≥ un hash terrible, la mejor opci√≥n que pudimos compartir se ve√≠a as√≠: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/427/f05/aa5/427f05aa580feb5a231dd5e23c63baa8.jpg" alt="imagen"><br>  <i>(Curiosamente, diary.ru es un excelente servicio de alojamiento de fotos, ¬°hasta ahora nada ha salido mal!)</i> <br><br>  Llegu√© a la conclusi√≥n de que necesitamos reducir de alguna manera la densidad de las ramas.  Inicialmente, la idea era limitarlos gravitacionalmente, es decir,  ramas demasiado "pesadas" simplemente se rompen y caen.  Comenc√© a contar el momento de fuerza en la flexi√≥n, compar√°ndolo con la fuerza del √°rbol (arrastr√© los valores desde alg√∫n lugar, lo califiqu√© como constantes y comenc√© a probar): result√≥ mal, a veces el tronco se rompi√≥, aunque no deber√≠a haber sucedido, y el √°rbol se dobl√≥ con seguridad , a veces una rama grande se rompi√≥ al principio, el resultado condujo a un tronco desequilibrado y se rompi√≥ nuevamente, esta vez debido a una p√©rdida de equilibrio vertical, y a veces una rama que era bastante normal en estructura, creciendo en grosor, inicialmente doblada bajo su peso, luego quiebra, ventas  si no hay nada en ella ya no se creci√≥.  Marc√≥ porque el desaf√≠o era una fecha l√≠mite. <br><br>  El segundo intento fue limitar tanto el crecimiento de nuevas ramas como la supervivencia de las antiguas / anteriores utilizando iluminaci√≥n.  Desde el tercer intento de implementaci√≥n (los dos primeros permanecieron en forma de funciones comentadas) result√≥ as√≠: constru√≠ una red de v√≥xeles tridimensional con un lado de 0.5 metros (s√≠, todos los valores que hab√≠a en metros y kilogramos; realmente quer√≠a f√≠sica real para un bosque real en ese momento), que estaba lleno al principio ceros, luego, al rodear el √°rbol, cada rama contribu√≠a al relleno de la red en forma de volumen dividido por uno o dos v√≥xeles.  El hecho es que todas las ramas (en cualquier caso, casi todas) como piezas separadas del marco calculado eran m√°s cortas que 0.5m, lo que nos permiti√≥ usar una aproximaci√≥n aproximada.  Adem√°s del relleno, cada rama "proyecta una sombra" en los v√≥xeles subyacentes en forma de relleno adicional de los v√≥xeles debajo y ligeramente alrededor del v√≥xel con una rama (la forma final es una pir√°mide cuadrada, pero jugar con un c√≠rculo se romp√≠a y, por lo tanto, no se iluminaba de todos modos).  Este enrejado se us√≥ como un limitador, si una de las ramas comienza a crecer en el medio del √°rbol: tendr√° menos luz all√≠, ser√° m√°s corta y es posible que no crezca en absoluto o muera por falta de iluminaci√≥n.  Las ramas muertas se cayeron. <br><br>  Esta opci√≥n hizo posible obtener √°rboles que eran relativamente transparentes cuando se ve√≠an y relativamente compactos en t√©rminos de alcance, la primera versi√≥n de trabajo se ve√≠a as√≠: <br><br><img src="https://habrastorage.org/webt/of/9e/kl/of9eklhz1sf9try2zuwtkr_3kds.jpeg"><br><br>  En esta versi√≥n, todav√≠a depur√© el mecanismo de crecimiento del √°rbol, y el √°rbol se pod√≠a ver desde todos los lados.  Se dibuj√≥ un √°rbol una rama a la vez, la matriz de ramas se orden√≥ primero por distancia del observador, ya que en el viejo curso VMX sobre gr√°ficos tridimensionales de 1996, seleccion√© colores con fines cosm√©ticos del rango HSB para cada llamada "dibujame un √°rbol" para que el bosque no sea mon√≥tono, el esqueleto del √°rbol tambi√©n se gira al azar para dibujar.  En total, hab√≠a de seis a ocho modelos de √°rboles para dibujar, cada uno creciendo bajo su propia influencia de RNG, el paisaje de la tierra produjo otro ruido de guinda, y el lugar donde cultivar el √°rbol se seleccion√≥ al azar usando un conjunto de rangos de puntos permitidos para el crecimiento al moverse hacia un lado observador a distancia.  Si el √°rbol se plant√≥ en el punto A, y el radio del √°rbol R seleccionado para "crecer", entonces los valores (AR, A + R) quedaron prohibidos para el crecimiento a la distancia actual, al pasar al siguiente (-0.05) este intervalo disminuy√≥ en 0.1, y se elimin√≥ cuando se redujo a cero. <br><br>  El √∫ltimo (y de hecho el primer e inmediatamente considerado) matiz de todo el algoritmo es que es MUY LARGO.  Para recorrer el √°rbol "adulto", se necesitan unos segundos para dibujar, unos pocos m√°s para dibujar las texturas de un √°rbol, se tarda de medio segundo a dos, y Adobe Flash no est√° dise√±ado para intervalos de c√°lculo tan largos sin actualizar la pantalla (m√°s precisamente, sin devolver el control al motor) .  Por lo tanto, necesit√°bamos un algoritmo que supiera c√≥mo mantener el estado entre llamadas, continuar trabajando desde el lugar donde fue interrumpido y controlar su tiempo de ejecuci√≥n, y al mismo tiempo no entrar en p√°nico y no asustar al motor flash.  Guardar el estado se implement√≥ como un par de propiedades de la clase Principal, dividi√©ndose en etapas: seleccionando las funciones "cultivar un √°rbol una vez", "dibujar un √°rbol terminado" y "dibujar un pedazo de tierra" y medir el tiempo dedicado, respectivamente, tan pronto como la pr√≥xima "una vez" Le tom√≥ m√°s de unos segundos para un √°rbol, el √°rbol fue considerado "listo" y puesto a un lado.  Result√≥ tres grandes fases: crear texturas, "cultivar" √°rboles, colocar √°rboles terminados en la pantalla. <br><br>  El resultado se ve as√≠: <br><br><img src="https://habrastorage.org/webt/gq/ng/5l/gqng5lalvmyilnobmf1dvhhsbqw.png"><br><br>  Puedes jugar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Optimizado (m√°s precisamente, escrito) para Flash 10.1, tener en cuenta un mont√≥n de actualizaciones flash en t√©rminos de seguridad puede ser terriblemente lento; en este caso, le aconsejo que descargue la versi√≥n de depuraci√≥n de Adobe Flash Player 11.5 y la abra sin conexi√≥n.  Todo el dibujo toma de 5 a 6 minutos, despu√©s de los dos primeros en la pantalla comienza a producirse alg√∫n movimiento, lo que puede ser interesante de observar.  Despu√©s de dibujar, puede presionar Ctrl + clic para guardar el resultado como un archivo PNG cu√°druple en comparaci√≥n con el tama√±o de la ventana. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es429256/">https://habr.com/ru/post/es429256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es429246/index.html">Pr√°cticas de verano en Mars IS: una mirada al interior</a></li>
<li><a href="../es429248/index.html">Consejos pol√≠glotas: c√≥mo aprender cualquier idioma sin l√°grimas y maldiciones</a></li>
<li><a href="../es429250/index.html">Cien recetas de contabilidad digital</a></li>
<li><a href="../es429252/index.html">An√°lisis est√°tico de aplicaciones m√≥viles.</a></li>
<li><a href="../es429254/index.html">Sobre las curvas de Bezier y la velocidad de Arduino, segunda parte</a></li>
<li><a href="../es429258/index.html">C√≥mo crear mec√°nicas de juego confiables usando solo Excel: modelado y optimizaci√≥n de soluciones</a></li>
<li><a href="../es429260/index.html">Nuestro camino hacia el almacenamiento centralizado de registros</a></li>
<li><a href="../es429262/index.html">Bienvenido a la reuni√≥n de oto√±o DIYorDIE 17 de noviembre</a></li>
<li><a href="../es429264/index.html">Tiempo de UPS de iones de litio: ¬øun peligro de incendio o un paso seguro hacia el futuro?</a></li>
<li><a href="../es429266/index.html">Qu√© salarios para especialistas en TI ofrecen los empleadores de My Circle, datos de mayo a octubre de 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>