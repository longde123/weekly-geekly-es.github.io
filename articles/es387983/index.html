<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî† üë©üèΩ‚Äçüé® üî∂ Control de cortina a trav√©s de la interfaz RS-485. Parte 2: agregar WiFi üíÉüèª üèáüèº üò®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Completamos la tarea m√≠nima: probamos c√≥mo funciona el motor AKKO AM72E a trav√©s de la interfaz RS485 . Ahora podemos controlar la luz solar enviando ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Control de cortina a trav√©s de la interfaz RS-485. Parte 2: agregar WiFi</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/387983/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Completamos la tarea m√≠nima: probamos c√≥mo funciona el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">motor AKKO AM72E a trav√©s de la interfaz RS485</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ahora podemos controlar la luz solar enviando electrones a trav√©s de cables. El siguiente paso obvio es la transici√≥n del control con la ayuda de part√≠culas elementales al control con la ayuda de vibraciones, es decir. ondas de radio Los hechizos que usaremos en este caso dependen de la magia que elijamos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Cualquier tecnolog√≠a inal√°mbrica ser√≠a adecuada para nuestros prop√≥sitos, pero quer√≠a controlar las cortinas desde mi tel√©fono inteligente. En este caso, es aconsejable no instalar ning√∫n programa adicional. Me conectar√© a la red WiFi de mi hogar y gestionar√© la cortina el√©ctrica con un navegador. Conduzca, a trav√©s del adaptador RS485-UART me conectar√© al ESP8266. Puede seguir su propio camino y usar, por ejemplo, un enrutador WiFi.</font></font><br>
<img src="https://habrastorage.org/files/26c/46e/51b/26c46e51b071497ca28860904e0b4030.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ESP-01 por hoy, es el m√≥dulo m√°s econ√≥mico con WiFi. Cuesta tan poco que si necesita controlar varios motores, no podemos tirar de los cables de un motor a otro, sino simplemente conectar cada uno a su propio m√≥dulo. En este caso, no necesitaremos dar a cada AM72E su propia direcci√≥n; puede comunicarse con la direcci√≥n ESP-01. Estamos interesados ‚Äã‚Äãen el ESP8266 no solo por su bajo precio y peque√±o tama√±o, sino tambi√©n por el hecho de que tiene muy pocos recursos y requerir√° mucho esfuerzo para lograr algo que funcione.</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 No describir√© c√≥mo conectar y actualizar el firmware ESP8266. C√≥mo hacer esto correctamente se puede encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Windows, para programar el ESP8266, puede usar el IDE de Arduino, y luego escribimos en C (bueno, casi) o NodeMcu, y puede escribir en Lua. Tambi√©n hay otras opciones, pero no nos convienen.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 No, no tenemos prisa por subir NodeMcu. El firmware debe estar preparado. Los recursos en ESP-01 no son suficientes para que podamos olvidarnos de ellos si queremos crear un servidor web. Hay una ROM flash en el tablero, un lugar donde se almacenar√°n todos nuestros archivos, 512 KB. Esto ya es extremadamente peque√±o, pero no descansaremos en la falta de recursos en flash, sino en RAM. El SoC ESP8266 tiene un √°rea de RAM de 64 KB para el c√≥digo del programa y 96 KB para los datos. Al inicio, los datos del flash se cargan en la RAM. Si llenamos el firmware de stock de NodeMcu y observamos la cantidad de memoria disponible, veremos esto:</font></font><br>
<img src="https://habrastorage.org/files/c54/7f9/999/c547f99991104dba8b65a641d86d227d.jpg" alt="imagen"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 21 kb! Con tales vol√∫menes, ¬°tiene que guardar cada byte! Tambi√©n vemos algo de basura despu√©s de la l√≠nea "No se puede detectar autom√°ticamente el firmware, porque no se recibi√≥ la respuesta correcta". Esta es informaci√≥n de depuraci√≥n, emitida a una velocidad de 74,880, luego la velocidad cambia. As√≠ es como se ve a la velocidad correcta: </font></font><br>
<img src="https://habrastorage.org/files/0f9/0e3/884/0f90e388462847c0afbd2220e3a7f18d.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 nada interesante. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Primero, aumente la cantidad de RAM disponible. Para hacer esto significativamente, puede reconstruir el firmware usted mismo. Los c√≥digos fuente est√°n disponibles, pero no tiene ganas de palear todo el proyecto solo por probarlo. Adem√°s, esto tendr√° que hacerse bajo Linux. No es que sea muy dif√≠cil, pero si estamos distra√≠dos, nunca terminaremos. Puede </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajustar el</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> firmware aqu√≠: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">frightanic.com/nodemcu-custom-build</font></a><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Cambi√© la casilla de verificaci√≥n a dev096 y puse una marca de verificaci√≥n adicional al lado de 1-ware en la ventana de selecci√≥n de complementos. Encend√≠ este m√≥dulo debido a una funci√≥n: el c√°lculo CRC16. Aqu√≠ est√°: </font></font><br>
<img src="https://habrastorage.org/files/31a/eb5/e41/31aeb5e41a2046c481526e59a4e90d7a.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 usted, por supuesto, puede habilitar o deshabilitar los m√≥dulos que necesita. Ahora ingrese el correo electr√≥nico en el formulario y haga clic en el bot√≥n "Verificar el estado de compilaci√≥n". Un correo electr√≥nico de una sola vez tambi√©n est√° bien. Esperamos unos minutos y en una carta recibimos un enlace a los archivos con el firmware. El firmware en el que solo puede trabajar con enteros le ahorrar√° un destello con una docena de kilobytes. Yo serv√≠ este. Pero puedes hacer otra elecci√≥n. Veamos por qu√© nos esforzamos tanto: </font></font><br>
<img src="https://habrastorage.org/files/093/2f2/553/0932f25535044d40a3fc252c3a9f5c49.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ahora tenemos 35 KB de RAM disponibles.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Antes de pasar a la programaci√≥n, regresemos brevemente al adaptador UART-RS485. A la parte del mismo responsable del cambio de transmisi√≥n-recepci√≥n. A la resistencia R1. Al cargar, el ESP8266 establece todos los pines GPIO en el modo de entrada, y luego el programa determina en qu√© modo funcionar√° cada GPIO. Result√≥ que en el momento de la carga, el contacto TX_UART (U0TXD) debe estar en un nivel alto, de lo contrario, el programa grabado en flash no se iniciar√°. Sin R1, cuando se sondea un contacto TX, se leer√° un nivel bajo y el ESP8266 se "colgar√°" hasta que se vuelva a conectar el adaptador.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Puede rechazar todo el esquema de conmutaci√≥n de recepci√≥n-transmisi√≥n utilizando uno de los pines GPIO. </font><font style="vertical-align: inherit;">Pero hay pocos GPIO disponibles en el ESP-01, y quiz√°s encuentren otra aplicaci√≥n en su proyecto. </font><font style="vertical-align: inherit;">Adem√°s, con el esquema de conmutaci√≥n, el adaptador que hicimos se puede usar, por ejemplo, con un enrutador que no tiene un GPIO.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 El proyecto consta de tres archivos: data, index.html e init.lua. </font><font style="vertical-align: inherit;">Es m√°s correcto considerar esto no como un proyecto, sino como un prototipo. </font><font style="vertical-align: inherit;">Por ejemplo, no hay autorizaci√≥n, excepto cuando est√° conectado a un enrutador. </font><font style="vertical-align: inherit;">Y no estoy del todo seguro de que el servidor del ESP8266 sea capaz de resistir ataques. </font><font style="vertical-align: inherit;">El c√≥digo no se verifica de ninguna manera, excepto cuando est√° conectado, hay una conexi√≥n de red o ha desaparecido. </font><font style="vertical-align: inherit;">No hay c√≥digo que reinicie autom√°ticamente el ESP8266 si el programa se congela. </font><font style="vertical-align: inherit;">Las dos √∫ltimas tareas se resuelven f√°cilmente, pero el proyecto se habr√≠a vuelto m√°s complicado.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debe editar el archivo de datos: ingrese el nombre y la contrase√±a de su red WiFi all√≠. Al conectar el ESP8266 a la red, podremos controlar las cortinas a trav√©s de Internet. Despu√©s de finalizar la depuraci√≥n init.lua, configure la variable de depuraci√≥n en falso o elim√≠nela por completo. Por lo tanto, se arrojar√° menos basura en UART. Si esto no se hace, es posible que la unidad no funcione. Adem√°s, AKKO AM72E a√∫n no podr√° entender lo que le est√° escribiendo. En este caso, la funci√≥n de registro y todas las l√≠neas en las que se menciona en init.lua tambi√©n se pueden eliminar.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Volvamos al tema del ahorro de recursos. El archivo de datos, con mi nombre de red y contrase√±a, ocupa 1643 bytes en la memoria. Si a√∫n no lo ha adivinado, entonces este archivo es un archivo lua normal. Se puede compilar. Despu√©s de la compilaci√≥n, el mismo archivo ya ocupa 1040 bytes. Puedes hacer lo mismo con init.lua. El tama√±o del archivo puede reducirse a√∫n m√°s. Es necesario descartar todo lo superfluo, en primer lugar, comentarios y espacios. El archivo se vuelve poco legible, pero si necesitamos m√°s espacio, tenemos que buscarlo. Esta es una pr√°ctica com√∫n. Al final, nadie apreciar√° el dise√±o hermoso y correcto de su c√≥digo. Bueno, tal vez competidores cuando tu c√≥digo llegue a ellos. Pero la funcionalidad truncada se notar√° de inmediato. Especialmente si hay algo para comparar. Cuando se programan dispositivos con pocos recursos, las prioridades cambian. Esto es a menudo por qu√© los programasescrito en C para sistemas embebidos son poco legibles. Todo se complica cambiando todo lo posible al preprocesador. Si comienza un proyecto en C y lo pospone durante un par de meses, es posible que necesite un tiempo decente para descubrir su propio c√≥digo. Se presta menos atenci√≥n al mantenimiento del c√≥digo, ya que En tres o cinco a√±os, aparece un nuevo hierro y todo tiene que ser reescrito nuevamente debido a la nueva arquitectura.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eliminar manualmente todo lo innecesario del archivo de datos, comenz√≥ a ocupar 705 bytes. Al mismo tiempo, el tama√±o a√∫n puede reducirse en varias decenas de bytes, si las variables reciben nombres no significativos, sino nombres de una letra (s√≠, s√≠, esto no es lo que se nos ense√±a en la escuela). Despu√©s de compilarlo, el archivo data.lc ocupa 728 bytes en flash. ¬°Vaya! ¬°Incluso sucede! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No hay mucho que decir sobre index.htm. Tambi√©n le agregu√© una imagen en formato svg. T√∫ tambi√©n puedes hacerlo. Simplemente llene curtain.svg en el flash con otro archivo.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Init.lua: el archivo principal del proyecto. </font><font style="vertical-align: inherit;">Hay comentarios en el archivo mismo y si algo no est√° claro, puede comenzar la ejecuci√≥n l√≠nea por l√≠nea y, en general, experimentar hasta que se aclare por completo. </font><font style="vertical-align: inherit;">Adem√°s de UARTA, todav√≠a hay LED de conmutaci√≥n conectados a GPIO2. </font><font style="vertical-align: inherit;">Los archivos cuando los carga el servidor se leen desde la memoria flash y se transfieren en bloques de 512 bytes. </font><font style="vertical-align: inherit;">Esto reduce los requisitos de tama√±o de la RAM disponible. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto no est√° en el c√≥digo, pero si se hace necesario calcular CRC16, entonces se hace con el comando ow.crc16 (buf, crc). </font><font style="vertical-align: inherit;">Por ejemplo, si escribe: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
= ow.crc16 ('\ 85 \ 00 \ 00 \ 03 \ 01', 0xFFFF) </font><font style="vertical-align: inherit;">en la l√≠nea de comando, obtenemos </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
15593 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo necesita recordar, env√≠e primero el byte bajo y luego el alto. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Esto es lo que sucedi√≥ al final: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
deber√≠a haber un video)</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es387983/">https://habr.com/ru/post/es387983/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es387971/index.html">Los ingenieros de la NASA saben c√≥mo construir adecuadamente una Estrella de la Muerte a partir de Star Wars</a></li>
<li><a href="../es387973/index.html">¬øPor qu√© la inteligencia artificial es m√°s frecuente que la mujer?</a></li>
<li><a href="../es387975/index.html">¬øQu√© obtenemos m√°s de los juegos de computadora: da√±o o beneficio?</a></li>
<li><a href="../es387977/index.html">Que la fuerza te acompa√±e</a></li>
<li><a href="../es387979/index.html">Microsoft Neural Network derrota a Google e Intel en la competencia de reconocimiento de im√°genes</a></li>
<li><a href="../es387985/index.html">–°–µ—Ä–¥–∏—Ç—ã–π –∫–æ—Ç–∏–∫ —Å—É–¥–∏—Ç—Å—è —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–º –∫–æ—Ñ–µ –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –∫–æ–ø–∏—Ä–∞–π—Ç–∞</a></li>
<li><a href="../es387987/index.html">Elon Musk teme que la Tercera Guerra Mundial pueda interrumpir la exploraci√≥n de Marte</a></li>
<li><a href="../es387989/index.html">Las bombillas Philips Hue comienzan a bloquear a los competidores</a></li>
<li><a href="../es387993/index.html">Varios trucos de vida que pueden ser √∫tiles para escribir tesis o documentos grandes en MS Word</a></li>
<li><a href="../es387999/index.html">Discusi√≥n: c√≥mo la llegada de un sistema de grabaci√≥n de m√∫sica cambi√≥ la m√∫sica en s√≠</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>