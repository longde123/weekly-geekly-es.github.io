<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîè üìá ü§™ Schwierige IPSec unter Linux üë®üèª‚Äç‚öïÔ∏è ‚õ¥Ô∏è üë©üèø‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fr√ºher oder sp√§ter beim Aufbau einer IT-Infrastruktur besteht die Aufgabe darin, sich in alle Dienste eines gro√üen Unternehmens zu integrieren. Dies k...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Schwierige IPSec unter Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425079/"><img src="https://habrastorage.org/webt/9i/ar/ia/9iariac5i8g79f_qasyzcuf5tnc.png"><br><br>  Fr√ºher oder sp√§ter beim Aufbau einer IT-Infrastruktur besteht die Aufgabe darin, sich in alle Dienste eines gro√üen Unternehmens zu integrieren.  Dies kann beispielsweise eine Bank oder ein Telekommunikationsbetreiber sein.  In der Regel verf√ºgen gro√üe Unternehmen √ºber gut etablierte Richtlinien zur Informationssicherheit, die insbesondere die Implementierung eines Dienstes mit einer externen Infrastruktur √ºber verschl√ºsselte Kan√§le - IPSec - erfordern.  Gleichzeitig gibt es in kleinen <s>Startup-</s> Organisationen keine Erfahrung mit der Organisation solcher Programme, und von der Ausr√ºstung ist nur VDS mit Linux an Bord.  Dar√ºber hinaus gibt es zu meiner √úberraschung in Runet praktisch keine Materialien, die Linux-Tools zur Fehlerbehebung beschreiben.  Versuchen wir, diese L√ºcke zu schlie√üen und den praktischen Teil der Einstellungen zu beschreiben. <br><a name="habracut"></a><br>  Das allgemeine Schema des Dienstes ist unten dargestellt.  In gro√üen Organisationen ist in der Regel alles bereits standardisiert, in Betrieb genommen, alle m√∂glichen Verschl√ºsselungs- und anderen Netzwerkelemente werden auf separaten Ger√§ten (Tsiska-Wacholder und √§hnliche) und, was noch wichtiger ist, von <b>Einzelpersonen</b> (m√∂glicherweise jede blaue Box in der folgenden Abbildung) ausgef√ºhrt von verschiedenen Personen serviert).  Sie haben eine virtuelle Maschine, mit der der Dienst gestartet und IPSec organisiert wird. <br><br><img src="https://habrastorage.org/webt/cw/1p/g0/cw1pg0gmvnixufv4anjqa2vgxrq.png"><br><br>  Bitte beachten Sie, dass IPSec selbst zwischen einer IP-Adresse (in meinem Beispiel <code>10.0.255.1 &lt;-&gt; 10.0.1.1</code> ) und der Dienst selbst zwischen anderen ( <code>192.168.255.1&lt;-&gt; 192.168.1.1</code> ) organisiert ist.  Solche Schemata werden auch als <i>IPSec Network-Network bezeichnet</i> . <br><br>  Ein einfaches Beispiel ist, dass Sie in einem jungen, aber sehr ehrgeizigen Unternehmen <i>SuperService arbeiten</i> und die Interaktion mit der geschlossenen API von <i>MegaTelecom</i> organisieren <i>m√ºssen</i> .  Ihre Infrastruktur ist ein VDS-Server, Ihre Partnerinfrastruktur besteht aus einer Reihe von Netzwerk- und Serverger√§ten.  Die Aufgabe ist in zwei Phasen unterteilt: <br><br><ol><li>  Transport organisieren (wie die Zusammenarbeit stattfinden wird). </li><li>  Konfigurieren Sie den Dienst (f√ºhren Sie Anwendungen direkt auf den Servern aus). </li></ol><br>  Daher hat der <i>SuperService-</i> Manager beschlossen, eine Verbindung zu einer gro√üen Organisation herzustellen, um ein Gesch√§ftsproblem zu l√∂sen.  Er wandte sich an <i>MegaTelecom</i> , an das sie ihm <b>technische Spezifikationen</b> f√ºr die Verbindung schickten.  Eine dieser Bedingungen ist <b>IPSec</b> .  Dieser Zustand trat in Form einer <i>Excel-</i> Platte auf, von der ich im Folgenden ein Beispiel vorstellte.  Auf dem Bild habe ich technisch wichtige Parameter gelb hervorgehoben.  Das Format kann variieren, aber das Wesentliche bleibt gleich. <br><br><img src="https://habrastorage.org/webt/wi/jk/7t/wijk7treuikfegnmkk9sof2pnze.png"><br><br>  Zun√§chst wird es von Ihrer Seite nicht ausgef√ºllt, es muss ausgef√ºllt und zur Genehmigung an den Partner gesendet werden.  Nachdem Sie zugestimmt haben, k√∂nnen Sie sich hinsetzen und versuchen, Ihren Linux-Computer zu optimieren. <br><br><h3>  IPSec-Konzept </h3><br>  Als n√§chstes werde ich eine kleine Theorie f√ºr Leute geben, die mit Technologie √ºberhaupt nicht vertraut sind.  Alles, was ich weiter beschreiben werde, bezieht sich auf reines Ethernet und IPv4.  Ich werde nicht auf Verschl√ºsselung und Schl√ºsselaustauschalgorithmen eingehen, sondern mich auf den Netzwerkteil konzentrieren. <br><br>  <b>IPSec</b> - eine Reihe von Techniken und Protokollen zum Organisieren einer sicheren Verbindung. <br><br>  Im Gegensatz zu anderen Tunneling-Technologien (GRE, PPP, L2TP, sogar MPLS-TE) werden f√ºr IPSec explizite Tunnelschnittstellen erstellt, √ºber die der Datenverkehr geleitet werden kann.  Stattdessen bietet IPSec das Konzept der sogenannten <b>Security Assotiations (SA) an</b> .  <i>SA</i> ist der Tunnel von einem Netzwerkger√§t zum anderen.  Vergessen Sie jedoch nicht, dass <i>SA</i> keine Netzwerkschnittstelle im normalen Sinne des Wortes ist. Klassisches Routing funktioniert hier nicht.  Anstelle der Routing-Tabelle funktioniert hier das <b>SP-</b> Konzept <b>(Security Policy)</b> .  Wir schreiben explizit eine Zugriffsliste (Access List, ACL) vor, um Datenverkehr durch eine bestimmte SA zu leiten.  All diese Dinge sind im sogenannten <b>ISAKMP-</b> Framework definiert. <br><blockquote>  <b>ISAKMP</b> - eine Beschreibung der IPSec-Verfahren, in der Literatur wird es als Framework bezeichnet.  Es beschreibt die Begriffe SA, SP, SAD (Security Assotiations Database), SPD (Security Policy Database), die Notwendigkeit, Hilfstunnel zu installieren ... ISAKMP ist so konzipiert, dass es nicht von Tunneltechnologien, Authentifizierungsalgorithmen und Verschl√ºsselung abh√§ngt.  Er f√ºhrt einfach die notwendigen Definitionen ein. <br><br>  <b>IKE (v1 / 2)</b> - direktes Authentifizierungsprotokoll.  Er implementiert bereits Schl√ºsselaustauschalgorithmen und deren Anwendung. <br><br>  Dank des Cisco-Konzepts gelten ISAKMP und IKE jetzt auch als synonym. </blockquote>  Vor dem Verschl√ºsseln des Datenverkehrs m√ºssen sich die Parteien auf die Parameter (und Schl√ºssel) dieser Verschl√ºsselung einigen.  Zu diesem Zweck erhebt sich zwischen beiden Seiten ein Hilfstunnel (auch ISAKMP-Tunnel genannt), der st√§ndig in Betrieb ist.  Dieser bidirektionale Tunnel ist eine UDP-Verbindung (standardm√§√üig an Port 500).  Um diesen Hilfstunnel zu organisieren, m√ºssen sich die Parteien gegenseitig authentifizieren (das Passwort muss √ºbereinstimmen).  Dies erfolgt √ºber das <b>IKEv1 / 2-</b> Protokoll <b>(Internet Key Exchange)</b> .  Und bereits im von <i>ISAKMP</i> organisierten Tunnel vereinbaren die Parteien, den Benutzerverkehr direkt zu verschl√ºsseln. <br><br>  Die IPSec-Organisation selbst ist in zwei Phasen unterteilt: <br><br><ol><li>  Erstellen eines ISAKMP-Hilfstunnels </li><li>  Erstellen eines Benutzerdatentunnels </li></ol><br>  Wie ich schrieb, werden Tunnel im IPSec-Konzept (oder besser gesagt im <i>ISAKMP-</i> Konzept) als <i>SA bezeichnet</i> . <br><br>  Die erste Phase (Organisation ISAKMP SA) kann in zwei Modi durchgef√ºhrt werden: <br><br><ol><li>  <b>Hauptparteien</b> tauschen abwechselnd Verhandlungsparameter aus.  Es gilt als sicherer und wird f√ºr permanente Kan√§le verwendet (unser Fall). </li><li>  <b>aggressiv</b> - In einer Nachricht sendet der Initiator alle erforderlichen Koordinierungsparameter. Er wird verwendet, wenn ein Remote-Benutzer f√ºr eine tempor√§re Sitzung verbunden wird (um die Sitzung zu beschleunigen). </li></ol><br>  Sie m√ºssen verstehen, dass die <b>Haupt-</b> SA-Tunnel <b>unidirektional sind</b> .  F√ºr die bidirektionale Daten√ºbertragung √ºber den IPSec-Kanal m√ºssen zwei Tunnel vorhanden sein: Quelle (src) ‚Üí Empf√§nger (dst) und umgekehrt. <br><br>  Bei allen Verschl√ºsselungsmethoden werden dem urspr√ºnglichen IP-Paket zus√§tzliche Header hinzugef√ºgt. Die Kapselung erfolgt.  F√ºr diese Kapselung gibt es zwei Methoden: <b>AH (Authentication Header)</b> und <b>ESP (Encapsulation Security Payload)</b> .  AH authentifiziert nur das Paket (vom Absender digital signiert), ESP und authentifiziert (Zeichen) und verschl√ºsselt.  Heute wird AH fast nie verwendet, alles ist in ESP verpackt. <br><br>  Sie k√∂nnen das Quell-IP-Paket verschl√ºsseln und authentifizieren, ohne den IP-Header (Transportmodus) oder damit (Tunnelmodus) zu ber√ºcksichtigen.  <b>Transport wird</b> verwendet, wenn geplant ist, seine Tunnel mithilfe anderer Technologien (nicht IPSec / ESP) zu organisieren.  Zum Beispiel GRE, l2tp, ppp.  Um einen Dienst mit der internen Infrastruktur einer gro√üen Organisation zu verbinden, wird er praktisch nicht verwendet.  Ich habe dieses Szenario verwendet, um mehrere B√ºros √ºber IPSec zu einem VPN zu kombinieren.  Wir sind mehr am <b>Tunnelmodus</b> interessiert.  Wie Sie auf dem Bild sehen k√∂nnen, wird hier ein zus√§tzlicher IP-Header hinzugef√ºgt. <br><br><img src="https://habrastorage.org/webt/kc/pl/qe/kcplqeh1wmwmwlsidaj7ckvsnh0.png"><br><blockquote>  √úbrigens gibt es ein echtes Beispiel f√ºr die Verwendung der AH-Kapselung.  Angenommen, wir haben zwei Netzwerke, die mit verschiedenen Routern verbunden sind.  Hosts sollten Informationen mit einer MTU von 1500 Bytes ohne Fragmentierung √ºbertragen, aber wir haben einen Zwischenabschnitt, der nur 1380 Bytes unterst√ºtzt.  Der gesamte Track ist vertrauensw√ºrdig.  Wir k√∂nnen die Tatsache nutzen, dass IPSec keine Tunnelschnittstellen im klassischen Sinne erstellt, durch die der Verkehr nicht geleitet wird.  Wir werden eine Tunnel- <i>SA vom</i> Typ <i>AH</i> erstellen (wir m√ºssen nicht verschl√ºsseln), dann wird der Datenverkehr dorthin geleitet.  Nur externe IP-Pakete (gem√§√ü externen IP-Headern) werden im Datenverkehr fragmentiert, interne werden ohne √Ñnderungen wieder zusammengesetzt. <br><br><img src="https://habrastorage.org/webt/o9/ni/p6/o9nip6nargofgqz9_77nfrbcily.png"><br></blockquote><img width="60%" align="right" src="https://habrastorage.org/webt/ar/v1/w1/arv1w1hdlpdoosmczuno9o1prue.png"><br>  Beachten Sie, dass der <i>ESP-</i> Header <b>vor dem TCP / UDP-Transport</b> ansteigt.  Denken Sie daran, dass das IP-Feld ein Protokollfeld enth√§lt?  Basierend auf diesem Feld verarbeiten Netzwerkger√§te (und Endhosts) IP-Pakete korrekt.  F√ºr ESP ist die Nummer 50. Eine vollst√§ndige Liste der Protokolle f√ºr dieses Feld kann im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wiki</a> angezeigt werden. Dies kann sehr n√ºtzlich sein. <br><br><img align="right" src="https://habrastorage.org/webt/aa/ha/cs/aahacsstzsqw1ljf1x1j7omrm4c.png">  Das Fehlen eines Transportschicht-Headers (TCP / UDP / ICMP ist bereits verschl√ºsselt!) Beschr√§nkt Technologien wie NAT.  Denken Sie daran, dass NAT mit Port-√úbersetzung (√úberladung, PAT, MASQARADE, es hat viele Namen) auf der Basis von Transportprotokoll-Ports funktioniert.  Und im verschl√ºsselten IPSec-Tunnel sind sie es nicht!  Um dieses Problem zu l√∂sen, gibt es eine Technologie wie <b>IPSec NAT-Traversal (NAT-T)</b> .  In der ersten Phase vereinbaren die Parteien die Verwendung von NAT-T.  Wenn beide Seiten NAT-T unterst√ºtzen (und sogar auf denselben UDP-Ports), wird der UDP-Header zu den resultierenden Tunneln f√ºr den Datenverkehr hinzugef√ºgt, mit denen Pakete bereits Router mit Netzwerkadress√ºbersetzung durchlaufen. <br><br>  Der Tunnel selbst steigt nicht an, Sie m√ºssen den Verkehr dorthin lenken.  Wie ich oben geschrieben habe, funktionieren Routing-Regeln hier nicht. Sie m√ºssen <b>Sicherheitsrichtlinien (SP)</b> schreiben. <br><br>  Richtlinien bestehen aus der Quelladresse, der Zieladresse, der Richtung (in, out, fwd) und den Benutzertunnelparametern (hier wird ESP beschrieben, ob es sich entweder um AH, Tunnelversion oder Transport handelt).  Dies √§hnelt eher dem Organisieren von Regeln f√ºr NAT.  NAT hat auch nicht gen√ºgend Routing-Tabelleneintr√§ge.  Und auch dort werden die Regeln angegeben, <i>wo, wo und wie</i> und nicht <i>wo und durch was</i> .  Und auch mit der falschen Handbewegung k√∂nnen Sie die gesamte Kommunikation auf dem Remote-Server blockieren. <br><blockquote>  Alle IPSec-Manipulationen f√ºgen Overhead-Header hinzu.  Zumindest essen sie weitere 40 Bytes aus dem Originalpaket.  So ist beispielsweise bei einer Standard-MTU f√ºr PPPoE mit 1380 Byte Verbindungen die tats√§chliche MTU &lt;1340. </blockquote><h3>  IPSec unter Linux </h3><br>  Lassen Sie uns am Beispiel von DEB-Verteilungen √ºben.  Ich werde nur den Fall einer Autorisierung betrachten, die auf einem <i>Pre-Shared-Key (PSK)</i> basiert. Wir werden das Schema ab dem Anfang des Artikels konfigurieren. <br><br>  IPSec selbst wird vom Kernel unterst√ºtzt, diese Unterst√ºtzung ist jedoch sehr begrenzt.  Tats√§chlich befassen sich die kr√§ftigen Module nur mit der Verschl√ºsselung und den Schl√ºsseln (Paketverarbeitung), die bereits empfangen (an den Kernel √ºbertragen) wurden.  Und um dort die Parameter und Regeln zu √ºbergeben, mit denen Sie den Datenverkehr verarbeiten m√ºssen, ben√∂tigen Sie eine separate Software.  Als solche Software gibt es mehrere L√∂sungen: <br><br><ol><li>  KAME wurde von BSD migriert </li><li>  xSWAN (strongswan, freeswan, libreswan usw.) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">K√ºstenmauer</a> </li></ol><br>  Es schien mir die einfachste (vorhersehbarste) Version von KAME zu sein, und wir werden es weiter drehen. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># deb-       root@localhost: ~# apt-get install racoon ipsec-tools</span></span></code> </pre><br>  Traditionell bestand KAME aus zwei Komponenten <br><br><ol><li>  Der <b>Racoon-Daemon</b> zur Steuerung des <i>ISAKMP-</i> Tunnels. </li><li>  <b>Setkey-</b> Dienstprogramme zum Verwalten von SA-Tunneln mit Daten. </li></ol><br>  Beginnen wir mit dem ersten.  <i>Racoon</i> ist f√ºr die Tunnelautorisierungseinstellungen unter IKE verantwortlich.  Dies ist ein Daemon, der mit einer Konfigurationsdatei ( <code>/etc/racoon.conf</code> ) konfiguriert ist und von einem regul√§ren Init-Skript ( <code>/etc/init.d/racoon &lt;start|stop|restart&gt;</code> ) gestartet wird. <br><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # cat /etc/racoon.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      remote  sainfo     # #      PSK  path pre_shared_key "/etc/racoon/psk.txt"; log debug; listen { #  ,      ISAKMP  isakmp 10.0.1.1 [500]; strict_address; } #   remote      IPSec. #      tunnel-group  ASA. #   IP-   anonymous #          . #     user-network # remote anonymous remote 10.0.255.1 { nat_traversal off; exchange_mode main; my_identifier address 10.0.1.1; proposal { encryption_algorithm 3des; hash_algorithm sha1; authentication_method pre_shared_key; dh_group modp1024; lifetime time 86400 sec; } } #   IPSec.  transform-set  ASA. # # ,      #       . #         # sainfo address &lt;src&gt; address &lt;dst&gt; #      ,       # sainfo anonymous sainfo address 192.168.1.1 any address 192.168.255.1 any { pfs_group modp1024; lifetime time 28800 sec; encryption_algorithm 3des; authentication_algorithm hmac_sha1; compression_algorithm deflate; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # cat /etc/racoon/psk.txt</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   PSK- #  &lt;REMOTE IP ADDR&gt; &lt;PASSWORD&gt; #  -      ,     racoon 10.0.255.1 SUPERPASSWORD</span></span></code> </pre><br></div></div><br>  Wie immer Details in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>man 5 racoon.conf</code></a> <br><br>  Als n√§chstes werden wir <i>das Setkey-</i> Dienstprogramm aufnehmen.  Es startet auch als Daemon ( <code>/etc/init.d/setkey &lt;start|stop|restart&gt;</code> ), f√ºhrt jedoch das Skript <code>/etc/ipsec-tools.conf</code> .  Wie gesagt, es werden bereits Tunnel f√ºr den Benutzerverkehr erstellt.  Setzt n√§mlich <b>SA und SP</b> f√ºr sie.  Dies ist so etwas wie eine <i>Kryptokarte</i> auf der ASA.  Die einfachste M√∂glichkeit f√ºr uns ist, nur SP hinzuzuf√ºgen.  Dann wird die SA automatisch basierend auf den Parametern der zweiten Phase erstellt, die in den <i>Waschb√§reneinstellungen</i> angegeben sind. <br><br>  Es ist jedoch m√∂glich, die Parameter der zweiten Phase von <i>racoon √ºberhaupt</i> nicht zu verwenden, sondern SA √ºber dieses Dienstprogramm einzustellen.  Details und Syntax finden Sie in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>man 8 setkey</code></a> .  Aber ich werde ein Beispiel f√ºr die einfachste Konfiguration geben. <br><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # cat /etc/ipsec-tools.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">flush; spdflush; spdadd 192.168.1.1/32 192.168.255.1/32 any -P out ipsec esp/tunnel/10.0.1.1-10.0.255.1/require; spdadd 192.168.255.1/32 192.168.1.1/32 any -P <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ipsec esp/tunnel/10.0.255.1-10.0.1.1/require;</code> </pre><br></div></div><br>  Derzeit wird das Dienstprogramm <i>setkey</i> vom <i>iproute2-</i> Modul dupliziert. <br>  Als Teil davon gibt es zwei Records Management Teams SA und SP. <br><br><ol><li>  ip xfrm <b>state</b> </li><li>  IP-Xfrm- <b>Richtlinie</b> </li></ol><br>  Zus√§tzlich zur Verwaltung dieses Dienstprogramms k√∂nnen Sie den Status der organisierten SAs und <i>SPs anzeigen,</i> die auf den Datenverkehr angewendet werden.  Weitere Details in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>man 8 ip-xfrm</code></a> . <br><blockquote>  Schauen Sie sich das Originaltablett noch einmal an.  Es gibt verschiedene IP-Adressen f√ºr IPSec und Service.  Die interne IP-Adresse wird innerhalb der <i>Megatelecom-</i> Infrastruktur gefiltert.  Wir haben aber nur eine virtuelle Maschine.  Darauf sollte irgendwie eine interne IP-Adresse erscheinen, und Pakete in den Tunnel sollten von dort ausgehen.  Es gibt verschiedene M√∂glichkeiten, um dieses Szenario zu erreichen: <br><br><ol><li>  Eine statische Route ohne Erkennung eines Stopps, jedoch mit expliziter Angabe der ausgehenden Schnittstelle und der IP-Adresse. </li><li>  Definieren von Routen basierend auf richtlinienbasiertem Routing (PBR unter Linux, auch bekannt als <i>IP-Regel</i> ). </li><li>  Adress√ºbersetzung ( <i>NAT / MASQARADE</i> ). </li></ol><br>  Aus meiner Sicht ist hier die erste Option geeignet. <br><br>  Wir k√∂nnen unserer Schnittstelle eine zus√§tzliche (sekund√§re) IP-Adresse hinzuf√ºgen, w√§hrend es besser ist, einen <b>Alias</b> f√ºr diese Schnittstelle zu erstellen <br> <code>root@localhost: ~# ip addr add 192.168.1.1/32 dev eth1 label eth1:1</code> <br>  und konfigurieren Sie die Route zum <i>Megatelecom-</i> Server von dieser IP-Adresse. <br> <code>root@localhost: ~# ip route add 192.168.255.1/32 dev eth1:1 src 192.168.1.1</code> <br>  Aber wenn Sie dies tun, wird nichts beginnen.  Tatsache ist, dass die Linux-Station beim Hinzuf√ºgen einer Route in diesem Formular versucht, die MAC-Adresse des Empf√§ngers zu ermitteln. Dies geschieht √ºber ARP ... Der Computer sendet ARP-Anforderungen mit <code>Who has IP 192.168.255.1</code> .  Da sich 192.168.255.1 nicht im selben Netzwerk wie 192.168.1.1 (mask / 32!) Befindet, erfolgt keine Antwort auf ARP.  Wenn Sie jedoch versuchen, eine Verbindung <code>No route to host</code> wird von der lokalen IP-Adresse <code>No route to host</code> zur√ºckgegeben.  Um dies zu verhindern, m√ºssen wir einen statischen ARP-Datensatz festlegen: <br> <code>root@localhost: ~# arp -s 192.168.255.1 00:00:00:00:00:01 -i eth1:1</code> <br>  So ein Life Hack.  √úbrigens f√ºhren solche Manipulationen m√∂glicherweise nicht zum korrekten Betrieb des Linux-IP-Stacks.  In einem der F√§lle f√ºhrten <code>ip route</code> nicht zum gew√ºnschten Ergebnis. Der Netzwerkstapel musste neu gestartet werden. <br></blockquote><h3>  Gesundheitscheck </h3><br><br>  Vergessen Sie nicht, der Tunnel wird nur steigen, wenn der Verkehr hinein geht!  Es ist erforderlich, vor dem Ziel von einer bestimmten Schnittstelle (IP-Adresse) aus zu pingen. <br> <code>root@localhost: ~# ping -I 192.168.1.1 192.168.255.1</code> <br>  Mit einer leichten Verz√∂gerung sollten Antworten von der R√ºckseite kommen (es sei denn, ICMP ist nat√ºrlich irgendwo auf der Site geschlossen). <br><br>  Wir k√∂nnen sehen, ob der ISAKMP-Tunnel gestiegen ist. <br><br><div class="spoiler">  <b class="spoiler_title">racoonctl show-sa isakmp</b> <div class="spoiler_text"><pre> <code class="bash hljs">root@localhost: ~<span class="hljs-comment"><span class="hljs-comment"># racoonctl show-sa isakmp Destination Cookies Created 10.0.1.1.500 356a7e11111a93f:367111530375c065 2018-10-02 09:18:28</span></span></code> </pre><br></div></div><br>  Wir k√∂nnen auch Tunnel mit Benutzerdaten sehen. <br><br><div class="spoiler">  <b class="spoiler_title">racoonctl show-sa esp</b> <div class="spoiler_text"><pre> <code class="bash hljs">10.0.1.1 10.0.255.1 esp mode=tunnel spi=2148175815(0x800a8fc7) reqid=0(0x00000000) E: 3des-cbc 799e587f 6a2b4b78 5590cc2a 3d3ee331 f7e7f472 01abcdef A: hmac-sha1 01c5161f 46679a36 5d07ee9d f159fc9a 01abcdef seq=0x00000000 replay=4 flags=0x00000000 state=mature created: Oct 2 09:22:44 2018 current: Oct 2 10:39:21 2018 diff: 4597(s) hard: 28800(s) soft: 23040(s) last: Oct 2 09:22:45 2018 hard: 0(s) soft: 0(s) current: 84(bytes) hard: 0(bytes) soft: 0(bytes) allocated: 1 hard: 0 soft: 0 sadb_seq=1 pid=3764 refcnt=0 10.0.255.1 10.0.1.1 esp mode=tunnel spi=45614328(0x02b804f8) reqid=0(0x00000000) E: 3des-cbc 97cedcf1 644e8bbb c22b4e2c fa08a874 01abcdef 211ad19e A: hmac-sha1 1ab3e79d 3fd924a0 01abcdef 6c9ac89a 01abcdef seq=0x00000000 replay=4 flags=0x00000000 state=mature created: Oct 2 09:22:44 2018 current: Oct 2 10:39:21 2018 diff: 4597(s) hard: 28800(s) soft: 23040(s) last: Oct 2 09:22:45 2018 hard: 0(s) soft: 0(s) current: 84(bytes) hard: 0(bytes) soft: 0(bytes) allocated: 1 hard: 0 soft: 0 sadb_seq=0 pid=3764 refcnt=0</code> </pre><br></div></div><br>  In <i>tcpdump</i> kann es hilfreich sein <i>,</i> sich die Logik zum Herstellen einer Verbindung anzusehen.  Hier sehen Sie auch die Phasen des Verbindungsaufbaus und des bereits an ESP <b>verschl√ºsselten</b> Datenverkehrs.  Nat√ºrlich gibt es Techniken, um es zu entschl√ºsseln, aber normalerweise reicht diese Schlussfolgerung bereits aus. <br><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # tcpdump -i eth1 host 10.0.255.1</b> <div class="spoiler_text"><pre> <code class="bash hljs">18:01:06.409631 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 1 I ident 18:01:06.439276 IP 10.0.255.1.500 &gt; 10.0.1.1.500: isakmp: phase 1 R ident 18:01:06.440840 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 1 I ident 18:01:06.475244 IP 10.0.255.1.1.500 &gt; 10.0.1.1.500: isakmp: phase 1 R ident 18:01:06.477032 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 1 I ident[E] 18:01:06.487785 IP 10.0.255.1.500 &gt; 10.0.1.1.500: isakmp: phase 1 R ident[E] 18:01:06.488048 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 2/others I inf[E] 18:01:07.412451 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 2/others I oakley-quick[E] 18:01:07.465363 IP 10.0.255.1.500 &gt; 10.0.1.1.500: isakmp: phase 2/others R oakley-quick[E] 18:01:07.465940 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 2/others I oakley-quick[E] 18:01:08.467373 IP 10.0.1.1 &gt; 10.0.255.1: ESP(spi=0x7aabfa82,seq=0x1), length 116 18:01:08.480141 IP 10.0.255.1 &gt; 10.0.1.1: ESP(spi=0x0386f867,seq=0x1), length 116</code> </pre><br></div></div><br><blockquote>  Wenn Sie eine Remoteverbindung √ºber SSH herstellen, ist es praktisch, tcpdump im Hintergrund auszuf√ºhren, um nicht viele Fenster zu erstellen: <br><br> <code>root@localhost: ~# tcpdump -i eth1 -w ipsec.pcap esp &amp; <br></code> <br><br>  Wir fangen an zu pingen, telnet, netcat ... <br><br> <code>root@localhost: ~# killall tcpdump <br> root@localhost: ~# tcpdump -vr ipsec.pcap <br></code> <br></blockquote>  Auch in den Protokollen k√∂nnen Sie den erfolgreichen Status der Verbindung sehen.  Es zeigt den erfolgreichen Aufbau beider Phasen von IPSec. <br><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # cat /var/log/daemon.log</b> <div class="spoiler_text"><pre> <code class="bash hljs">Oct 3 17:53:26 vm22433 racoon: INFO: IPsec-SA request <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 10.0.255.1 queued due to no phase1 found. Oct 3 17:53:26 vm22433 racoon: INFO: initiate new phase 1 negotiation: 10.0.1.1[500]&lt;=&gt;10.0.255.1[500] Oct 3 17:53:26 vm22433 racoon: INFO: begin Identity Protection mode. Oct 3 17:53:26 vm22433 racoon: INFO: received Vendor ID: CISCO-UNITY Oct 3 17:53:26 vm22433 racoon: INFO: received Vendor ID: DPD Oct 3 17:53:26 vm22433 racoon: INFO: received Vendor ID: draft-ietf-ipsra-isakmp-xauth-06.txt Oct 3 17:53:26 vm22433 racoon: INFO: ISAKMP-SA established 10.0.1.1[500]-10.0.255.1[500] spi:ebddc300af62ae42:abcdef0123 Oct 3 17:53:27 vm22433 racoon: INFO: initiate new phase 2 negotiation: 10.0.1.1[500]&lt;=&gt;10.0.255.1[500] Oct 3 17:53:27 vm22433 racoon: INFO: received RESPONDER-LIFETIME: 4608000 kbytes Oct 3 17:53:27 vm22433 racoon: WARNING: attribute has been modified. Oct 3 17:53:27 vm22433 racoon: INFO: IPsec-SA established: ESP/Tunnel 10.0.1.1[500]-&gt;10.0.255.1[500] spi=238677(0xe39eabc) Oct 3 17:53:27 vm22433 racoon: INFO: IPsec-SA established: ESP/Tunnel 10.0.1.1[500]-&gt;10.0.255.1500] spi=7204011111(0x44b4aaa)</code> </pre></div></div><br>  Das ist alles.  Es m√ºssen noch alle erforderlichen Manipulationen zum Start hinzugef√ºgt werden, und Sie k√∂nnen mit der Integration von Anwendungen beginnen. <br><br>  PS: Eine Aufforderung, alle Fehler oder Ungenauigkeiten im Artikel per pers√∂nlicher Nachricht zu melden.  Wenn ich den Artikel optimiere, sehen die Kommentare albern aus. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de425079/">https://habr.com/ru/post/de425079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de425069/index.html">Testen eines Pr√§sentators mit PromiseKit</a></li>
<li><a href="../de425071/index.html">Wie sch√ºtzt man sich vor Stapel√ºberlauf (bei Cortex M)?</a></li>
<li><a href="../de425073/index.html">Einfache Erstellung eines Git-Repositorys auf OneDrive</a></li>
<li><a href="../de425075/index.html">Bildverarbeitung: Installieren, Konfigurieren und Verwenden von Google Cloud Vision in PHP</a></li>
<li><a href="../de425077/index.html">Kotlin unter der Haube - siehe dekompilierten Bytecode</a></li>
<li><a href="../de425081/index.html">Der Staat wei√ü nicht, wie viel er f√ºr IT ausgibt. Wir beweisen die Zahlen</a></li>
<li><a href="../de425083/index.html">Postgres stat ohne Nerven und Belastungen</a></li>
<li><a href="../de425085/index.html">7 Best Container Practices von Google</a></li>
<li><a href="../de425087/index.html">Openspace Agility: Einf√ºhrung von Agile im gesamten Unternehmen (jetzt mit F√ºhrung!)</a></li>
<li><a href="../de425089/index.html">IT in der Tierwelt: Ant Food Search und TCP / IP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>