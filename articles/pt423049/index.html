<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öõÔ∏è ü§æüèø üêÖ Processos de aprendizado no Linux ‚úäüèø üî± üßõüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, gostaria de falar sobre o caminho da vida dos processos na fam√≠lia Linux OS. Na teoria e nos exemplos, examinarei como os processos nasc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Processos de aprendizado no Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423049/"><img src="https://habrastorage.org/webt/w9/tj/yz/w9tjyz5nyynb4zwy2kiikc0ckec.png"><br>  Neste artigo, gostaria de falar sobre o caminho da vida dos processos na fam√≠lia Linux OS.  Na teoria e nos exemplos, examinarei como os processos nascem e morrem, uma pequena conversa sobre a mec√¢nica das chamadas e sinais do sistema. <br><br>  Este artigo √© mais voltado para iniciantes em programa√ß√£o de sistemas e para aqueles que querem apenas aprender um pouco mais sobre como os processos funcionam no Linux. <br><a name="habracut"></a><br>  Tudo escrito abaixo se aplica ao Debian Linux com o kernel 4.15.0. <br><br><h2>  Conte√∫do </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1. Introdu√ß√£o</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Atributos do processo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ciclo de vida do processo</a> <br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Processar nascimento</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Estado pronto</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O status est√° "em execu√ß√£o"</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Reencarna√ß√£o em outro programa</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Estado pendente</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Status de parada</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√£o do processo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O estado dos "zumbis"</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Esquecimento</a> </li></ol></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Agradecimentos</a> </li></ol><br><a name="intro"></a><h2>  1. Introdu√ß√£o </h2><br>  O software do sistema interage com o n√∫cleo do sistema atrav√©s de fun√ß√µes especiais - chamadas do sistema.  Em casos raros, existe uma API alternativa, por exemplo, procfs ou sysfs, criada na forma de sistemas de arquivos virtuais. <br><br><a name="definition"></a><h2>  Atributos do processo </h2><br>  O processo no kernel √© apresentado simplesmente como uma estrutura com muitos campos (a defini√ß√£o da estrutura pode ser lida <a href="" rel="nofollow">aqui</a> ). <br>  Mas como o artigo √© dedicado √† programa√ß√£o do sistema, e n√£o ao desenvolvimento do kernel, somos um pouco abstratos e simplesmente focamos nos campos importantes do processo para n√≥s: <br><br><ul><li>  ID do processo (pid) </li><li>  Descritores de arquivo aberto (fd) </li><li>  Manipuladores de sinal </li><li>  Diret√≥rio de trabalho atual (cwd) </li><li>  Vari√°veis ‚Äã‚Äãde ambiente (ambiente) </li><li>  C√≥digo de retorno </li></ul><br><a name="lifecycle"></a><h2>  Ciclo de vida do processo </h2><br><img src="https://habrastorage.org/webt/dw/ru/5n/dwru5nbeoag7imroc_ki1qa9gba.png"><br><br><a name="fork"></a><h3>  Processar nascimento </h3><br>  Somente um processo no sistema nasce de uma maneira especial - <code>init</code> - √© gerado diretamente pelo kernel.  Todos os outros processos aparecem duplicando o processo atual usando a chamada do sistema <code>fork(2)</code> .  Ap√≥s a execu√ß√£o do <code>fork(2)</code> , obtemos dois processos quase id√™nticos, com exce√ß√£o dos seguintes pontos: <br><br><ol><li>  <code>fork(2)</code> retorna o PID do filho ao pai, 0 √© retornado ao filho; </li><li>  O filho altera o PPID (ID do processo pai) para o PID do pai. </li></ol><br>  Ap√≥s a execu√ß√£o da <code>fork(2)</code> , todos os recursos do processo filho s√£o uma c√≥pia dos recursos do pai.  Copiar um processo com todas as p√°ginas alocadas de mem√≥ria √© caro, portanto o kernel Linux usa a tecnologia Copy-On-Write. <br>  Todas as p√°ginas na mem√≥ria do pai s√£o marcadas como somente leitura e ficam dispon√≠veis para o pai e o filho.  Assim que um dos processos altera os dados em uma p√°gina espec√≠fica, essa p√°gina n√£o muda, mas a c√≥pia j√° est√° copiada e alterada.  Nesse caso, o original √© "desatado" desse processo.  Assim que o original somente leitura permanecer "vinculado" a um √∫nico processo, a p√°gina ser√° reatribu√≠da ao status de leitura e grava√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Um exemplo de um programa in√∫til simples com fork (2)</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;errno.h&gt; #include &lt;sys/wait.h&gt; #include &lt;sys/types.h&gt; int main() { int pid = fork(); switch(pid) { case -1: perror("fork"); return -1; case 0: // Child printf("my pid = %i, returned pid = %i\n", getpid(), pid); break; default: // Parent printf("my pid = %i, returned pid = %i\n", getpid(), pid); break; } return 0; }</span></span></span></span></code> </pre><br><br><pre> <code class="bash hljs">$ gcc test.c &amp;&amp; ./a.out my pid = 15594, returned pid = 15595 my pid = 15595, returned pid = 0</code> </pre><br></div></div><br><a name="ready"></a><h3>  Estado pronto </h3><br>  Imediatamente ap√≥s a execu√ß√£o, o <code>fork(2)</code> entra no estado pronto. <br>  De fato, o processo enfileira e aguarda o agendador no kernel para permitir que o processo seja executado no processador. <br><br><a name="running"></a><h3>  O status est√° "em execu√ß√£o" </h3><br>  Assim que o agendador colocou o processo em execu√ß√£o, o estado "running" come√ßou.  O processo pode executar todo o per√≠odo proposto (quantum), ou pode dar lugar a outros processos usando a exporta√ß√£o do sistema <code>sched_yield</code> . <br><br><a name="exec"></a><h3>  Reencarna√ß√£o em outro programa </h3><br>  Alguns programas implementam l√≥gica na qual o processo pai cria um filho para resolver um problema.  A crian√ßa, neste caso, resolve um problema espec√≠fico, e os pais delegam apenas tarefas aos filhos.  Por exemplo, um servidor Web com uma conex√£o de entrada cria um filho e passa o processamento da conex√£o para ele. <br>  No entanto, se voc√™ precisar executar outro programa, dever√° recorrer √† chamada de sistema <code>execve(2)</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *filename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argv[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> envp[])</span></span></span></span>;</code> </pre><br>  ou chamadas de biblioteca <code>execl(3), execlp(3), execle(3), execv(3), execvp(3), execvpe(3)</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, ... </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* (char *) NULL */</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execlp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, ... </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* (char *) NULL */</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, ... </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*, (char *) NULL, char * const envp[] */</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argv[])</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execvp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argv[])</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execvpe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argv[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> envp[])</span></span></span></span>;</code> </pre><br>  Todas as chamadas acima executam o programa, cujo caminho √© indicado no primeiro argumento.  Se for bem-sucedido, o controle √© transferido para o programa carregado e n√£o √© retornado ao programa original.  Nesse caso, o programa carregado possui todos os campos da estrutura do processo, exceto os descritores de arquivo marcados como <code>O_CLOEXEC</code> , que ser√£o fechados. <br><br>  Como n√£o se confundir em todos esses desafios e escolher o certo?  √â o suficiente para entender a l√≥gica de nomenclatura: <br><br><ul><li>  Todas as chamadas come√ßam com <code>exec</code> </li><li>  A quinta letra define o tipo de passagem de argumento: <br><ul><li>  <b>l</b> significa <b>lista</b> , todos os par√¢metros s√£o passados ‚Äã‚Äãcomo <code>arg1, arg2, ..., NULL</code> </li><li>  <b>v</b> significa <b>vetor</b> , todos os par√¢metros s√£o passados ‚Äã‚Äãem uma matriz terminada em nulo; </li></ul></li><li>  A letra <b>p</b> , que significa <b>caminho</b> , pode ser seguida.  Se o argumento do <code>file</code> come√ßar com um caractere diferente de "/", o <code>file</code> especificado ser√° procurado nos diret√≥rios listados na vari√°vel de ambiente PATH </li><li>  A √∫ltima pode ser a letra <b>e</b> , indicando o <b>ambiente</b> .  Nessas chamadas, o √∫ltimo argumento √© uma matriz terminada em nulo de cadeias terminadas em nulo do formul√°rio <code>key=value</code> - vari√°veis ‚Äã‚Äãde ambiente que ser√£o passadas para o novo programa. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Exemplo de chamada para / bin / cat --help via execve</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;unistd.h&gt; int main() { char* args[] = { "/bin/cat", "--help", NULL }; execve("/bin/cat", args, environ); // Unreachable return 1; }</span></span></span></span></code> </pre><br><br><pre> <code class="bash hljs">$ gcc test.c &amp;&amp; ./a.out Usage: /bin/cat [OPTION]... [FILE]... Concatenate FILE(s) to standard output. * *</code> </pre><br></div></div><br>  A fam√≠lia de chamadas <code>exec*</code> permite executar scripts com direitos de execu√ß√£o e come√ßar com uma sequ√™ncia de shebangs (#!). <br><br><div class="spoiler">  <b class="spoiler_title">Um exemplo de execu√ß√£o de um script com um PATH falsificado usando execle</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;unistd.h&gt; int main() { char* e[] = {"PATH=/habr:/rulez", NULL}; execle("/tmp/test.sh", "test.sh", NULL, e); // Unreachable return 1; }</span></span></span></span></code> </pre><br><br><pre> <code class="bash hljs">$ cat test.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo $0 echo $PATH $ gcc test.c &amp;&amp; ./a.out /tmp/test.sh /habr:/rulez</span></span></code> </pre><br></div></div><br>  Existe uma conven√ß√£o que implica que argv [0] corresponde aos argumentos nulos para fun√ß√µes na fam√≠lia exec *.  No entanto, isso pode ser violado. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo quando gato se torna cachorro usando execlp</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;unistd.h&gt; int main() { execlp("cat", "dog", "--help", NULL); // Unreachable return 1; }</span></span></span></span></code> </pre><br><br><pre> <code class="bash hljs">$ gcc test.c &amp;&amp; ./a.out Usage: dog [OPTION]... [FILE]... * *</code> </pre><br></div></div><br>  Um leitor curioso pode perceber que h√° um n√∫mero na assinatura da fun√ß√£o <code>int main(int argc, char* argv[])</code> - o n√∫mero de argumentos, mas nada desse tipo √© passado para a fam√≠lia de fun√ß√µes <code>exec*</code> .  Porque  Porque quando o programa inicia, o controle n√£o √© imediatamente transferido para o main.  Antes disso, algumas a√ß√µes definidas pelo glibc s√£o executadas, incluindo argc de contagem. <br><br><a name="waiting"></a><h3>  Estado pendente </h3><br>  Algumas chamadas do sistema podem demorar, como E / S.  Nesses casos, o processo entra em um estado "pendente".  Assim que a chamada do sistema for conclu√≠da, o kernel colocar√° o processo no estado "pronto". <br>  No Linux, h√° tamb√©m um estado de "espera" no qual o processo n√£o responde a sinais de interrup√ß√£o.  Nesse estado, o processo se torna "indestrut√≠vel", e todos os sinais recebidos permanecem alinhados at√© o processo deixar esse estado. <br>  O pr√≥prio kernel escolhe para qual estado transferir o processo.  Na maioria das vezes, os processos que solicitam E / S est√£o no estado "em espera (sem interrup√ß√µes)".  Isso √© especialmente percept√≠vel ao usar um disco remoto (NFS) com uma Internet n√£o muito r√°pida. <br><br><a name="stopped"></a><h3>  Status de parada </h3><br>  Voc√™ pode pausar um processo a qualquer momento enviando um sinal SIGSTOP.  O processo entrar√° em um estado "parado" e permanecer√° l√° at√© receber um sinal para continuar trabalhando (SIGCONT) ou morrer (SIGKILL).  Os sinais restantes ser√£o colocados na fila. <br><br><a name="exit"></a><h3>  Conclus√£o do processo </h3><br>  Nenhum programa pode se desligar.  Eles s√≥ podem solicitar isso ao sistema com a chamada do sistema <code>_exit</code> ou serem encerrados pelo sistema devido a um erro.  Mesmo quando voc√™ retorna um n√∫mero de <code>main()</code> , <code>_exit</code> ainda √© chamado implicitamente. <br>  Embora o argumento para a chamada do sistema seja int, apenas o byte baixo do n√∫mero √© considerado o c√≥digo de retorno. <br><br><a name="zombie"></a><h3>  O estado dos "zumbis" </h3><br>  Imediatamente ap√≥s a conclus√£o do processo (n√£o importa se est√° correto ou n√£o), o kernel grava informa√ß√µes sobre como o processo terminou e o coloca no estado "zumbi".  Em outras palavras, um zumbi √© um processo conclu√≠do, mas a mem√≥ria dele ainda √© armazenada no kernel. <br>  Al√©m disso, este √© o segundo estado em que o processo pode ignorar com seguran√ßa o sinal SIGKILL, porque n√£o pode morrer morto novamente. <br><br><a name="wait"></a><h3>  Esquecimento </h3><br>  O c√≥digo de retorno e o motivo da conclus√£o do processo ainda est√£o armazenados no kernel e devem ser retirados de l√°.  Para fazer isso, voc√™ pode usar as chamadas de sistema apropriadas: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">pid_t</span></span> wait(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *wstatus); <span class="hljs-comment"><span class="hljs-comment">/*  waitpid(-1, wstatus, 0) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pid_t</span></span> waitpid(<span class="hljs-keyword"><span class="hljs-keyword">pid_t</span></span> pid, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *wstatus, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> options);</code> </pre><br>  Todas as informa√ß√µes sobre a finaliza√ß√£o do processo se encaixam no tipo de dados int.  As macros descritas na p√°gina do <code>waitpid(2)</code> s√£o usadas para obter o c√≥digo de retorno e o motivo da finaliza√ß√£o do programa. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de conclus√£o e recebimento corretos de um c√≥digo de retorno</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;errno.h&gt; #include &lt;sys/wait.h&gt; #include &lt;sys/types.h&gt; int main() { int pid = fork(); switch(pid) { case -1: perror("fork"); return -1; case 0: // Child return 13; default: { // Parent int status; waitpid(pid, &amp;status, 0); printf("exit normally? %s\n", (WIFEXITED(status) ? "true" : "false")); printf("child exitcode = %i\n", WEXITSTATUS(status)); break; } } return 0; }</span></span></span></span></code> </pre><br><br><pre> <code class="bash hljs">$ gcc test.c &amp;&amp; ./a.out <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> normally? <span class="hljs-literal"><span class="hljs-literal">true</span></span> child exitcode = 13</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Exemplo de conclus√£o incorreta</b> <div class="spoiler_text"><br>  Passar argv [0] como NULL resulta em uma falha. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;errno.h&gt; #include &lt;sys/wait.h&gt; #include &lt;sys/types.h&gt; int main() { int pid = fork(); switch(pid) { case -1: perror("fork"); return -1; case 0: // Child execl("/bin/cat", NULL); return 13; default: { // Parent int status; waitpid(pid, &amp;status, 0); if(WIFEXITED(status)) { printf("Exit normally with code %i\n", WEXITSTATUS(status)); } if(WIFSIGNALED(status)) { printf("killed with signal %i\n", WTERMSIG(status)); } break; } } return 0; }</span></span></span></span></code> </pre><br><br><pre> <code class="bash hljs">$ gcc test.c &amp;&amp; ./a.out killed with signal 6</code> </pre><br></div></div><br>  H√° momentos em que um pai termina mais cedo que o filho.  Nesses casos, o <code>init</code> se tornar√° o pai da crian√ßa e ele usar√° a chamada de <code>wait(2)</code> quando chegar a hora. <br><br>  Depois que os pais obt√™m informa√ß√µes sobre a morte da crian√ßa, o n√∫cleo apaga todas as informa√ß√µes sobre a crian√ßa, para que outro processo em breve ocorra. <br><br><a name="thanks"></a><h2>  Agradecimentos </h2><br>  Agradecimentos a Sasha "Al" pela edi√ß√£o e assist√™ncia no design; <br><br>  Obrigado a Sasha "Reisse" pelas respostas claras a perguntas dif√≠ceis. <br><br>  Eles suportaram a inspira√ß√£o que me atacou e a enxurrada de minhas perguntas que me atacaram. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423049/">https://habr.com/ru/post/pt423049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423039/index.html">Fazemos autentica√ß√£o na web atrav√©s de blockchain</a></li>
<li><a href="../pt423041/index.html">Bizarre Story Super NES CD-ROM</a></li>
<li><a href="../pt423043/index.html">Devido a uma vulnerabilidade no sistema de prote√ß√£o de ve√≠culo el√©trico Tesla, um carro pode ser roubado em alguns segundos</a></li>
<li><a href="../pt423045/index.html">Qual impressora 3D escolher? Revis√£o de v√≠deo 3Dtool</a></li>
<li><a href="../pt423047/index.html">Reservamos sistemas de TI por dinheiro razo√°vel</a></li>
<li><a href="../pt423051/index.html">A luta por recursos, parte 1: No√ß√µes b√°sicas de Cgroups</a></li>
<li><a href="../pt423053/index.html">Struct e readonly: como evitar a degrada√ß√£o do desempenho</a></li>
<li><a href="../pt423055/index.html">Analistas de Wall Street: ‚ÄúA Apple nos fez comer nossos chap√©us‚Äù</a></li>
<li><a href="../pt423057/index.html">Python tamb√©m recusa parcialmente os termos mestre / escravo</a></li>
<li><a href="../pt423059/index.html">Melhor do que dizem: Tr√™s itens essenciais para o pr√≥ximo MacBook ser um dos melhores laptops da Apple</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>