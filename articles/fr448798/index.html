<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôåüèº üì® ‚öíÔ∏è Test Python avec pytest. Utilisation de pytest avec d'autres outils, CHAPITRE 7 ü§Ø ü§¶üèΩ üêó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Retour 


 En r√®gle g√©n√©rale, pytest n'est pas utilis√© ind√©pendamment, mais dans un environnement de test avec d'autres outils. Ce chapitre traite d'a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Test Python avec pytest. Utilisation de pytest avec d'autres outils, CHAPITRE 7</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448798/"><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Retour</a> </p><br><p>  <em>En r√®gle g√©n√©rale, pytest n'est pas utilis√© ind√©pendamment, mais dans un environnement de test avec d'autres outils.</em>  <em>Ce chapitre traite d'autres outils qui sont souvent utilis√©s en conjonction avec pytest pour des tests efficaces et efficients.</em>  <em>Bien qu'il ne s'agisse nullement d'une liste exhaustive, les outils abord√©s ici vous donneront une id√©e du go√ªt du pouvoir de m√©langer pytest avec d'autres outils.</em> </p><br><p><img src="https://habrastorage.org/webt/hd/--/9w/hd--9w134j0rxhmxftrflbbdopy.png"></p><a name="habracut"></a><br><p>  Les exemples de ce livre sont √©crits en utilisant Python 3.6 et pytest 3.2.  pytest 3.2 prend en charge Python 2.6, 2.7 et Python 3.3+. </p><br><blockquote> Le code source du projet T√¢ches, ainsi que pour tous les tests pr√©sent√©s dans ce livre, est disponible sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="https://pragprog.com/titles/bopytest/source_code">lien</a> sur la page Web du livre √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="https://pragprog.com/titles/bopytest">pragprog.com</a> .  Vous n'avez pas besoin de t√©l√©charger le code source pour comprendre le code de test;  le code de test est pr√©sent√© sous une forme pratique dans les exemples.  Mais pour suivre les t√¢ches du projet ou adapter des exemples de test pour tester votre propre projet (vos mains ne sont pas li√©es!), Vous devez vous rendre sur la page Web du livre et t√©l√©charger le travail.  L√†, sur la page Web du livre, il y a un lien pour les messages d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="https://pragprog.com/titles/bopytest/errata">erreur</a> et un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="https://forums.pragprog.com/forums/438">forum de discussion</a> . </blockquote><p>  Sous le spoiler se trouve une liste d'articles de cette s√©rie. </p><br><div class="spoiler">  <b class="spoiler_title">Table des mati√®res</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Pr√©sentation</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 1: Premiers pas avec Pytest</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 2: √âcriture des fonctions de test</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 3: Appareils Pytest</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 4: Luminaires int√©gr√©s</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 5: Plugins</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 6: Configuration</strong></a> </li><li>  [ <strong>Chapitre 7: Utilisation de pytest avec d'autres outils</strong> ] (cet article) ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://habr.com/en/post/448798/</a> ) </li></ul></div></div><br><h2 id="pdb-debugging-test-failures">  pdb: d√©bogage des √©checs de test </h2><br><p> Le module <code>pdb</code> est un d√©bogueur Python dans la biblioth√®que standard.  Vous utilisez <code>--pdb</code> pour que pytest d√©marre une session de d√©bogage au point d'√©chec.  Regardons <code>pdb</code> en action dans le cadre du projet T√¢ches. </p><br><p>  Dans ¬´Param√©trage du luminaire¬ª √† la page 64, nous avons laiss√© le projet T√¢ches avec quelques erreurs: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3/c/tasks_proj $ pytest --tb=no -q .........................................FF.FFFF FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF.FFF........... 42 failed, 54 passed in 4.74 seconds</code> </pre> <br><p>  Avant de voir comment <code>pdb</code> peut nous aider √† d√©boguer ce test, examinons les options de pytest disponibles pour acc√©l√©rer le d√©bogage des erreurs de test, que nous avons abord√©es dans la section ¬´Utilisation des options¬ª √† la page 9: </p><br><ul><li>  <code>--tb=[auto/long/short/line/native/no]</code> : contr√¥le le style de trace. </li><li>  <code>-v / --verbose</code> : affiche tous les noms de test qui ont r√©ussi ou √©chou√©. </li><li>  <code>-l / --showlocals</code> : affiche les variables locales √† c√¥t√© de la trace de pile. </li><li>  <code>-lf / --last-failed</code> : ex√©cute uniquement les tests qui √©chouent. </li><li>  <code>-x / --exitfirst</code> : <code>-x / --exitfirst</code> la session de test lors du premier √©chec. </li><li>  <code>--pdb</code> : d√©marre une session de d√©bogage interactive au point d'√©chec. </li></ul><br><hr><br><p>  <em>Installation de MongoDB</em> </p><br><hr><br><p>  Comme mentionn√© au chapitre 3, ¬´Appareils Pytest¬ª, page 49, l'installation de <code>MongoDB</code> et <code>pymongo</code> est requise pour ex√©cuter les tests MongoDB. </p><br><p>  J'ai test√© la version de Community Server trouv√©e sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.mongodb.com/download-center</a> .  pymongo s'installe avec <code>pip</code> : <code>pip install pymongo</code> .  Cependant, c'est le dernier exemple dans un livre qui utilise MongoDB.  Pour essayer le d√©bogueur sans utiliser MongoDB, vous pouvez ex√©cuter les commandes pytest √† partir du <code>code/ch2/</code> , car ce r√©pertoire contient √©galement plusieurs tests ayant √©chou√©. </p><br><hr><br><p>  Nous venons d' <code>code/ch3/c</code> les tests √† partir du <code>code/ch3/c</code> pour nous assurer que certains d'entre eux ne fonctionnent pas.  Nous n'avons pas vu de tracebacks ou de noms de test car <code>--tb=no</code> d√©sactive le tra√ßage et nous n'avions pas <code>--verbose</code> activ√©.  R√©p√©tons les erreurs (pas plus de trois) avec le texte d√©taill√©: </p><br><pre> <code class="plaintext hljs">$ pytest --tb=no --verbose --lf --maxfail=3 ============================= test session starts ============================= collected 96 items / 52 deselected run-last-failure: rerun previous 44 failures tests/func/test_add.py::test_add_returns_valid_id[mongo] ERROR [ 2%] tests/func/test_add.py::test_added_task_has_id_set[mongo] ERROR [ 4%] tests/func/test_add.py::test_add_increases_count[mongo] ERROR [ 6%] =================== 52 deselected, 3 error in 0.72 seconds ====================</code> </pre> <br><p>  Nous savons maintenant quels tests ont √©chou√©.  Examinons un seul d'entre eux, en utilisant <code>-x</code> , en <code>--tb=no</code> le tra√ßage, en n'utilisant pas <code>--tb=no</code> et en montrant les variables locales avec <code>-l</code> : </p><br><pre> <code class="plaintext hljs">$ pytest -v --lf -l -x ===================== test session starts ====================== run-last-failure: rerun last 42 failures collected 96 items tests/func/test_add.py::test_add_returns_valid_id[mongo] FAILED =========================== FAILURES =========================== _______________ test_add_returns_valid_id[mongo] _______________ tasks_db = None def test_add_returns_valid_id(tasks_db): """tasks.add(&lt;valid task&gt;) should return an integer.""" # GIVEN an initialized tasks db # WHEN a new task is added # THEN returned task_id is of type int new_task = Task('do something') task_id = tasks.add(new_task) &gt; assert isinstance(task_id, int) E AssertionError: assert False E + where False = isinstance(ObjectId('59783baf8204177f24cb1b68'), int) new_task = Task(summary='do something', owner=None, done=False, id=None) task_id = ObjectId('59783baf8204177f24cb1b68') tasks_db = None tests/func/test_add.py:16: AssertionError !!!!!!!!!!!! Interrupted: stopping after 1 failures !!!!!!!!!!!! ===================== 54 tests deselected ====================== =========== 1 failed, 54 deselected in 2.47 seconds ============</code> </pre><br><p>  Tr√®s souvent, cela suffit pour comprendre pourquoi le test a √©chou√©.  Dans ce cas particulier, il est assez clair que <code>task_id</code> pas un entier - c'est une instance d'ObjectId.  ObjectId est le type utilis√© par MongoDB pour les identificateurs d'objet dans la base de donn√©es.  Mon intention avec la couche <code>tasksdb_pymongo.py</code> √©tait de cacher certains d√©tails de l'impl√©mentation de MongoDB du reste du syst√®me.  Il est clair que dans ce cas cela n'a pas fonctionn√©. </p><br><p>  Cependant, nous voulons voir comment utiliser pdb avec pytest, alors imaginons pourquoi on ne sait pas pourquoi ce test a √©chou√©.  Nous pouvons faire en sorte que pytest d√©marre une session de d√©bogage et nous d√©marre directement au point d'√©chec en utilisant <code>--pdb</code> : </p><br><pre> <code class="plaintext hljs">$ pytest -v --lf -x --pdb ===================== test session starts ====================== run-last-failure: rerun last 42 failures collected 96 items tests/func/test_add.py::test_add_returns_valid_id[mongo] FAILED &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; traceback &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; tasks_db = None def test_add_returns_valid_id(tasks_db): """tasks.add(&lt;valid task&gt;) should return an integer.""" # GIVEN an initialized tasks db # WHEN a new task is added # THEN returned task_id is of type int new_task = Task('do something') task_id = tasks.add(new_task) &gt; assert isinstance(task_id, int) E AssertionError: assert False E + where False = isinstance(ObjectId('59783bf48204177f2a786893'), int) tests/func/test_add.py:16: AssertionError &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; entering PDB &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &gt; /path/to/code/ch3/c/tasks_proj/tests/func/test_add.py(16) &gt; test_add_returns_valid_id() -&gt; assert isinstance(task_id, int) (Pdb)</code> </pre> <br><p>  Maintenant que nous sommes √† l'invite (Pdb), nous avons acc√®s √† toutes les fonctionnalit√©s de d√©bogage interactif de pdb.  Lors de la visualisation des plantages, j'utilise r√©guli√®rement ces commandes: </p><br><ul><li>  <code>p/print expr</code> : imprime la valeur de exp. </li><li>  <code>pp expr</code> : Pretty affiche la valeur de expr. </li><li>  <code>l/list</code> : <code>l/list</code> le point de d√©faillance et cinq lignes de code au-dessus et en dessous. </li><li>  <code>l/list begin,end</code> : √©num√®re les num√©ros de ligne sp√©cifiques. </li><li>  <code>a/args</code> : imprime les arguments de la fonction actuelle avec leurs valeurs. </li><li>  <code>u/up</code> : d√©place un niveau vers le haut du chemin de la pile. </li><li>  <code>d/down</code> : descend d'un niveau dans la trace de la pile. </li><li>  <code>q/quit</code> : termine une session de d√©bogage. </li></ul><br><p>  D'autres commandes de navigation, telles que step et next, ne sont pas tr√®s utiles, car nous sommes assis juste dans l'instruction assert.  Vous pouvez √©galement simplement entrer des noms de variables et obtenir des valeurs. </p><br><p>  Vous pouvez utiliser <code>p/print expr</code> m√™me mani√®re que l' <code>-l/--showlocals</code> pour afficher les valeurs dans une fonction: </p><br><pre> <code class="plaintext hljs">(Pdb) p new_task Task(summary='do something', owner=None, done=False, id=None) (Pdb) p task_id ObjectId('59783bf48204177f2a786893') (Pdb)</code> </pre> <br><p>  Vous pouvez maintenant quitter le d√©bogueur et poursuivre les tests. </p><br><pre> <code class="plaintext hljs">(Pdb) q !!!!!!!!!!!! Interrupted: stopping after 1 failures !!!!!!!!!!!! ===================== 54 tests deselected ====================== ========== 1 failed, 54 deselected in 123.40 seconds ===========</code> </pre> <br><p>  Si nous n'utilisions pas <code>-</code> , pytest ouvrirait √† nouveau Pdb lors du prochain test.  Plus d'informations sur l'utilisation du module pdb sont disponibles dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation Python</a> . </p><br><h2 id="coveragepy-opredelenie-obema-testiruemogo-koda">  Coverage.py: D√©terminer la quantit√© de code de test </h2><br><p>  La couverture du code est un indicateur du pourcentage de code test√© test√© par un ensemble de tests.  Lorsque vous ex√©cutez des tests pour le projet T√¢ches, certaines fonctions T√¢ches sont ex√©cut√©es avec chaque test, mais pas avec tous. </p><br><p>  Les outils de couverture de code sont parfaits pour vous permettre de savoir quelles parties du syst√®me sont compl√®tement ignor√©es par les tests. </p><br><p>  <code>Coverage.py</code> est l'outil de couverture Python pr√©f√©r√© qui mesure la couverture de code. </p><br><p>  Vous l'utiliserez pour v√©rifier le code du projet T√¢ches avec pytest. </p><br><p>  Pour utiliser <code>coverage.py</code> vous devez l'installer.  Cela <code>pytest-cov</code> pas de mal d'installer un plugin appel√© <code>pytest-cov</code> , qui vous permet d'appeler <code>coverage.py</code> depuis pytest avec quelques options pytest suppl√©mentaires.  Puisque la <code>coverage</code> est l'une des d√©pendances de <code>pytest-cov</code> , installez simplement <code>pytest-cov</code> et cela prendra la <code>coverage.py</code> : </p><br><pre> <code class="plaintext hljs">$ pip install pytest-cov Collecting pytest-cov Using cached pytest_cov-2.5.1-py2.py3-none-any.whl Collecting coverage&gt;=3.7.1 (from pytest-cov) Using cached coverage-4.4.1-cp36-cp36m-macosx_10_10_x86 ... Installing collected packages: coverage, pytest-cov Successfully installed coverage-4.4.1 pytest-cov-2.5.1</code> </pre> <br><p>  Ex√©cutons le rapport de couverture pour la deuxi√®me version de t√¢che.  Si la premi√®re version du projet T√¢ches est toujours install√©e, d√©sinstallez-la et installez la version 2: </p><br><pre> <code class="plaintext hljs">$ pip uninstall tasks Uninstalling tasks-0.1.0: /path/to/venv/bin/tasks /path/to/venv/lib/python3.6/site-packages/tasks.egg-link Proceed (y/n)? y Successfully uninstalled tasks-0.1.0 $ cd /path/to/code/ch7/tasks_proj_v2 $ pip install -e . Obtaining file:///path/to/code/ch7/tasks_proj_v2 ... Installing collected packages: tasks Running setup.py develop for tasks Successfully installed tasks $ pip list ... tasks (0.1.1, /path/to/code/ch7/tasks_proj_v2/src) ...</code> </pre> <br><p>  Maintenant que la prochaine version des t√¢ches est install√©e, vous pouvez ex√©cuter le rapport de couverture de base: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch7/tasks_proj_v2 $ pytest --cov=src ===================== test session starts ====================== plugins: mock-1.6.2, cov-2.5.1 collected 62 items tests/func/test_add.py ... tests/func/test_add_variety.py ............................ tests/func/test_add_variety2.py ............ tests/func/test_api_exceptions.py ......... tests/func/test_unique_id.py . tests/unit/test_cli.py ..... tests/unit/test_task.py .... ---------- coverage: platform darwin, python 3.6.2-final-0 ----------- Name Stmts Miss Cover -------------------------------------------------- src\tasks\__init__.py 2 0 100% src\tasks\api.py 79 22 72% src\tasks\cli.py 45 14 69% src\tasks\config.py 18 12 33% src\tasks\tasksdb_pymongo.py 74 74 0% src\tasks\tasksdb_tinydb.py 32 4 88% -------------------------------------------------- TOTAL 250 126 50% ================== 62 passed in 0.47 seconds ===================</code> </pre> <br><p>  √âtant donn√© que le r√©pertoire actuel est <code>tasks_proj_v2</code> et que le code source sous test est dans src, l'ajout de l'option <code>--cov=src</code> g√©n√®re un rapport de couverture pour ce r√©pertoire uniquement. </p><br><p>  Comme vous pouvez le voir, certains fichiers ont une couverture assez faible et m√™me 0%.  Ce sont des rappels utiles: <code>tasksdb_pymongo.py</code> 0% car nous avons d√©sactiv√© le test de MongoDB dans cette version.  Certains d'entre eux sont assez faibles.  Le projet devra certainement fournir des tests pour tous ces domaines avant d'√™tre pr√™t pour les heures de grande √©coute. </p><br><p>  Je pense que plusieurs fichiers ont un pourcentage de couverture plus √©lev√©: <code>api.py</code> et <code>tasksdb_tinydb.py</code> .  Jetons un coup d'≈ìil √† <code>tasksdb_tinydb.py</code> et voyons ce qui manque.  Je pense que la meilleure fa√ßon de le faire est d'utiliser des rapports HTML. </p><br><p>  Si vous ex√©cutez √† nouveau <code>coverage.py</code> avec l' <code>--cov-report=html</code> , un <code>--cov-report=html</code> sera g√©n√©r√©: </p><br><pre> <code class="plaintext hljs">$ pytest --cov=src --cov-report=html ===================== test session starts ====================== plugins: mock-1.6.2, cov-2.5.1 collected 62 items tests/func/test_add.py ... tests/func/test_add_variety.py ............................ tests/func/test_add_variety2.py ............ tests/func/test_api_exceptions.py ......... tests/func/test_unique_id.py . tests/unit/test_cli.py ..... tests/unit/test_task.py .... ---------- coverage: platform darwin, python 3.6.2-final-0 ----------- Coverage HTML written to dir htmlcov ================== 62 passed in 0.45 seconds ===================</code> </pre> <br><p>  Vous pouvez ensuite ouvrir <code>htmlcov/index.html</code> dans un navigateur qui affiche la sortie sur l'√©cran suivant: </p><br><p><img src="https://habrastorage.org/webt/vs/sc/84/vssc84hovxefvf2g65740gu3ll0.png"></p><br><p>  Cliquer sur <code>tasksdb_tinydb.py</code> affichera un rapport pour un fichier.  Le pourcentage de lignes couvertes est affich√© en haut du rapport, plus le nombre de lignes couvertes et combien ne le sont pas, comme indiqu√© sur l'√©cran suivant: </p><br><p><img src="https://habrastorage.org/webt/os/pc/-o/ospc-o_yzzdfh1lzllw_1qtilrc.png"></p><br><p>  En faisant d√©filer vers le bas, vous pouvez voir les lignes manquantes, comme indiqu√© dans l'√©cran suivant: </p><br><p><img src="https://habrastorage.org/webt/85/rg/lt/85rgltocwrunycedzbeweix4zyc.png"></p><br><p>  M√™me si cet √©cran n'est pas une page compl√®te pour ce fichier, cela suffit pour nous dire que: </p><br><ol><li>  Nous ne testons pas <code>list_tasks()</code> avec l'ensemble propri√©taire. </li><li>  Nous ne testons pas <code>update()</code> ou <code>delete()</code> . </li><li>  Peut-√™tre que nous ne testons pas √† fond <code>unique_id()</code> . </li></ol><br><p>  Super.  Nous pouvons les inclure dans notre liste de tests TO-DO avec les tests du syst√®me de configuration. </p><br><p>  Bien que les outils de couverture de code soient extr√™mement utiles, la recherche d'une couverture √† 100% peut √™tre dangereuse.  Lorsque vous voyez du code qui n'est pas test√©, cela peut signifier qu'un test est n√©cessaire.  Mais cela peut √©galement signifier que certaines fonctions du syst√®me ne sont pas n√©cessaires et peuvent √™tre supprim√©es.  Comme tous les outils de d√©veloppement logiciel, l'analyse de la couverture du code ne remplace pas la r√©flexion. </p><br><p>  Voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code> coverage.py</code></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>pytest-cov</code></a> plus de d√©tails. </p><br><h2 id="mock-podmena-chastey-sistemy">  maquette: substitution de pi√®ces du syst√®me </h2><br><p>  Le package simul√© est utilis√© pour remplacer des parties du syst√®me afin d'isoler des parties du code de test du reste du syst√®me.  Mock - les objets sont parfois appel√©s tests doubles, espions, contrefa√ßons ou talons. </p><br><p>  Entre votre propre appareil pytest monkeypatch (d√©crit dans Utilisation de monkeypatch √† la page 85) et la simulation, vous devriez avoir toutes les fonctionnalit√©s de test double n√©cessaires. </p><br><blockquote>  Attention!  Moqueur et tr√®s bizarre <br>  Si c'est la premi√®re fois que vous rencontrez des jumeaux d'essai comme des simulacres, des talons et des espions, pr√©parez-vous!  Ce sera tr√®s √©trange, tr√®s rapide, dr√¥le, bien que tr√®s impressionnant. </blockquote><p>  Le package <code>mock</code> est livr√© avec la biblioth√®que Python standard, comme <code>unittest.mock</code> depuis Python 3.3.  Dans les versions ant√©rieures, il est disponible sous la forme d'un package distinct install√© via PyPI.  Cela signifie que vous pouvez utiliser la version fictive PyPI de Python 2.6 vers la derni√®re version Python et obtenir les m√™mes fonctionnalit√©s que la derni√®re version <code>mock</code> Python.  Cependant, pour une utilisation avec pytest, un plugin appel√© <code>pytest-mock</code> a certaines fonctionnalit√©s qui en font mon interface pr√©f√©r√©e pour le syst√®me de simulation. </p><br><p>  Pour le projet T√¢ches, nous utiliserons <code>mock</code> pour nous aider √† tester l'interface de ligne de commande.  Dans Coverage.py: en d√©terminant la quantit√© de code test√©e, √† la page 129, vous avez vu que notre fichier <code>cli.py</code> n'a pas √©t√© test√© du tout.  Nous allons commencer √† le r√©parer maintenant.  Mais parlons d'abord de strat√©gie. </p><br><p>  La premi√®re solution du projet T√¢ches a <code>api.py</code> √† effectuer la plupart des tests de fonctionnalit√© via <code>api.py</code>  Par cons√©quent, une solution raisonnable est que les tests de ligne de commande ne doivent pas √™tre des tests fonctionnels complets.  Nous pouvons √™tre s√ªrs que le syst√®me fonctionnera via la CLI si nous obtenons un niveau API mouill√© lors des tests CLI.  C'est aussi une solution pratique qui nous permet de regarder moki dans cette section. </p><br><p>  L'impl√©mentation des t√¢ches CLI utilise un package d'interface de ligne de commande <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Click</a> tiers.  Il existe de nombreuses alternatives pour impl√©menter l'interface de ligne de commande, y compris un module int√©gr√© √† Python <code>argparse</code> .  L'une des raisons pour lesquelles j'ai choisi Click est qu'il comprend un moteur de test qui nous aide √† tester les applications Click.  Cependant, le code dans <code>cli.py</code> , bien que nous esp√©rons qu'il est typique des applications Click, n'est pas √©vident. </p><br><p>  Ralentissons et installons la 3e version des t√¢ches: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ $ pip install -e ch7/tasks_proj_v2 ... Successfully installed tasks</code> </pre> <br><p>  Dans la suite de cette section, vous d√©velopperez plusieurs tests pour tester la fonctionnalit√© de ¬´list¬ª. <br>  Voyons cela en action pour comprendre ce que nous allons v√©rifier: </p><br><blockquote>  <strong><em>Remarque du traducteur:</em></strong> lors de l'utilisation de la plate-forme Windows, j'ai rencontr√© plusieurs probl√®mes lors du test de la session ci-dessous. <br><ol><li>  Un dossier doit √™tre cr√©√© pour la base de donn√©es nomm√©e <strong><code>tasks_db</code></strong> dans le dossier de votre utilisateur.  Par exemple, <code>c:\Users\User_1\tasks_db\</code> <br>  Sinon, nous obtenons - &gt;&gt; FileNotFoundError: [Errno 2] Aucun fichier ou r√©pertoire de ce type: 'c: \ Users \ User_1 // tasks_db // tasks_db.json' </li><li>  Utilisez des guillemets doubles au lieu d'une apostrophe.  Sinon, obtenez une erreur <br>  'fais quelque chose de grand' <br>  Utilisation: les t√¢ches ajoutent [OPTIONS] R√âSUM√â <br>  Essayez "t√¢ches ajouter -h" pour obtenir de l'aide. <br><br>  Erreur: vous avez obtenu des arguments suppl√©mentaires inattendus (quelque chose de g√©nial ') <br></li></ol><br></blockquote><br><pre> <code class="plaintext hljs">$ tasks list ID owner done summary -- ----- ---- ------- $ tasks add 'do something great' $ tasks add "repeat" -o Brian $ tasks add "again and again" --owner Okken $ tasks list ID owner done summary -- ----- ---- ------- 1 False do something great 2 Brian False repeat 3 Okken False again and again $ tasks list -o Brian ID owner done summary -- ----- ---- ------- 2 Brian False repeat $ tasks list --owner Brian ID owner done summary -- ----- ---- ------- 2 Brian False repeat</code> </pre> <br><p>  Cela semble assez simple.  La commande <code>tasks list</code> affiche une liste de toutes les t√¢ches sous l'en-t√™te. <br>  Le titre est imprim√© m√™me si la liste est vide.  La commande affiche uniquement les donn√©es d'un propri√©taire, si <code>-o</code> ou <code>--owner</code> .  Et comment v√©rifions-nous cela?  Il y a plusieurs fa√ßons, mais nous allons utiliser moki. </p><br><p>  Les tests qui utilisent des MOK sont n√©cessairement <em>des tests en bo√Æte blanche</em> , et nous devons examiner le code pour d√©cider quoi et o√π nous battrons.  Le principal point d'entr√©e est ici: </p><br><blockquote>  ch7 / tasks_proj_v2 / src / tasks / cli.py </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: tasks_cli()</code> </pre> <br><p>  Ceci est juste un appel √† <code>tasks_cli()</code> : </p><br><blockquote>  ch7 / tasks_proj_v2 / src / tasks / cli.py </blockquote><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@click.group(context_settings={'help_option_names': ['-h', '--help']}) @click.version_option(version='0.1.1') def tasks_cli(): """Run the tasks application.""" pass</span></span></code> </pre> <br><p>  De toute √©vidence?  Non.  Mais attendez, cela devient bon (ou mauvais, selon votre point de vue).  Voici l'une des commandes de <code>list</code> : </p><br><blockquote>  ch7 / tasks_proj_v2 / src / tasks / cli.py </blockquote><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@tasks_cli.command(name="list", help="list tasks") @click.option('-o', '--owner', default=None, help='list tasks with this owner') def list_tasks(owner): """    .   ,      . """ formatstr = "{: &gt;4} {: &gt;10} {: &gt;5} {}" print(formatstr.format('ID', 'owner', 'done', 'summary')) print(formatstr.format('--', '-----', '----', '-------')) with _tasks_db(): for t in tasks.list_tasks(owner): done = 'True' if t.done else 'False' owner = '' if t.owner is None else t.owner print(formatstr.format( t.id, owner, done, t.summary))</span></span></code> </pre> <br><p>  Lorsque vous vous habituez √† √©crire du code Click, assurez-vous que ce code n'est pas si mauvais.  Je ne vais pas expliquer ici quoi et comment cela fonctionne dans cette fonction, car le d√©veloppement du code de ligne de commande n'est pas au centre du livre;  cependant, bien que je sois presque absolument s√ªr d'avoir ce code correct, de toute fa√ßon, il y a toujours beaucoup de place pour l'erreur humaine.  C'est pourquoi un bon ensemble de tests automatis√©s est important pour s'assurer que cette fonctionnalit√© fonctionne correctement. <br>  Cette fonction <code>list_tasks(owner)</code> d√©pend de plusieurs autres fonctions: <code>tasks_db()</code> , qui est le gestionnaire de contexte, et <code>tasks.list_tasks(owner)</code> , qui est la fonction API. </p><br><p>  Nous allons utiliser la <code>mock</code> pour mettre en place de fausses fonctions pour <code>tasks_db()</code> et <code>tasks.list_tasks()</code> .  Ensuite, nous pouvons appeler la m√©thode <code>list_tasks</code> via l'interface de ligne de commande et nous assurer qu'elle appelle la fonction <code>tasks.list_tasks()</code> , qui fonctionne correctement et traite correctement la valeur de retour. <br>  Pour noyer <code>tasks_db()</code> , regardons une vraie impl√©mentation: </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Retour</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr448798/">https://habr.com/ru/post/fr448798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr448786/index.html">Test Python avec pytest. CHAPITRE 3 Appareils pytest</a></li>
<li><a href="../fr448790/index.html">SpaceVIL - Framework GUI multiplateforme pour le d√©veloppement sur .Net Core, .Net Standard et JVM</a></li>
<li><a href="../fr448792/index.html">Test Python avec pytest. Luminaires int√©gr√©s, Chapitre 4</a></li>
<li><a href="../fr448794/index.html">Test Python avec pytest. Plugins CHAPITRE 5</a></li>
<li><a href="../fr448796/index.html">Test Python avec pytest. Configuration, CHAPITRE 6</a></li>
<li><a href="../fr448800/index.html">Configurer Visual Studio dans votre organisation avec .vsconfig</a></li>
<li><a href="../fr448802/index.html">Penser avec des portails: cr√©er des portails dans Unreal Engine 4</a></li>
<li><a href="../fr448804/index.html">Se pr√©parer pour le runtime et le notaire renforc√©s de macOS</a></li>
<li><a href="../fr448806/index.html">Cr√©ation d'un syst√®me d'extension sur la biblioth√®que Qt</a></li>
<li><a href="../fr448808/index.html">√Ä propos de choses simples, compliqu√©es. "Acier dormant." Comment graisser les boulons rouill√©s ou non WD-40 avec un seul ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>