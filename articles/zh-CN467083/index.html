<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏬 ✨ 👠 现代处理器如何使用奇怪的popcount指令 👵🏽 🧕🏼 👩‍👩‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="这是我在!! Con 2019上的演讲的伪解码。 

 当今使用的大多数处理器体系结构都有称为popcount指令， popcount是“人口数”的缩写。 她执行以下操作：计算机器字中设置的位数。 例如（为简单起见，我们采用8位字）， popcount(00100110)为3， popcount(0...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>现代处理器如何使用奇怪的popcount指令</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467083/"> <i>这是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我在!! Con 2019上的演讲</a>的伪解码。</i> <br><br> 当今使用的大多数处理器体系结构都有称为<code>popcount</code>指令， <code>popcount</code>是“人口数”的缩写。 她执行以下操作：计算机器字中设置的位数。 例如（为简单起见，我们采用8位字）， <code>popcount(00100110)</code>为3， <code>popcount(01100000)</code>为2。 <br><br> 就像我一样，这可能会让您大吃一惊，但这就是她所做的！ 似乎不是很有帮助，对不对？ <br><a name="habracut"></a><br> 我认为这是对某些超专业用例的最新补充，但实际上至少从1961年开始，它就已出现在处理器体系结构中： <br><br><ul><li>  1961年： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IBM Stretch</a> <br></li><li>  1964年： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CDC 6000</a> <br></li><li>  1975年： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Cray-1</a> <br></li><li>  2005年： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SPARC</a> <br></li><li>  2005年： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ARM NEON</a> <br></li><li>  2007年： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AMD K10</a> <br></li><li>  2008年： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">英特尔Nehalem</a> </li></ul><br> 那到底是怎么回事？ <br><h4>  NSA指令 </h4><br>  <code>popcount</code>也被称为“ NSA指令”， <code>popcount</code>一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">非常有趣的线程</a>讨论了它在密码学中的用法。 有传言说，它最初是应NSA的要求添加到CPU指令集中的。 如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">该归档邮件线程中所述</a> ： <br><br><blockquote> 将每批速度更快的CDC汽车中的一辆发送给“好客户”几乎是一种传统-一辆未知的卡车到了，再也没有听到过。 </blockquote><br> 一个伟大的传说，但是为什么他们要使用它呢？ <br><br> 内容的一种度量是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Hamming的weight</a> ，它是字符串中非零字符的数量。 对于二进制字符串，这是<code>popcount</code> ！ <br><br> 如此处<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">所述</a> ，NSA需要对截获的消息进行加密分析，并且由于CDC 6000使用60位单词，因此一个单词足以存储感兴趣的大多数字母。 他们能够： <br><br><ol><li> 将消息分成几行 <br></li><li> 为字符串中的每个唯一字符设置一个位 <br></li><li> 使用<code>popcount</code>计算不同字符的数量 <br></li><li> 将计数器用作哈希以进行进一步的密码分析 </li></ol><br> 奇怪的是， <code>popcount</code>似乎在1970年代中期至2000年代中期的指令集中消失了，因此返回值应该用加密应用程序以外的方式解释。 它还有什么用？ <br><br><h4> 错误修复 </h4><br> 汉明权重的概念与汉<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">明距离</a>有关， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">汉明距离</a>是相同长度的两条线之间不同位置的数量。 对于两个二进制字符串<code>x</code>和<code>y</code> ，这只是<code>popcount</code>之后的<code>popcount</code> 。 例如： <br><br><pre>  00100110
 01100000 ^
 --------
 01000110<font></font>
<font></font>
 popcount（01000110）= 3 </pre><br> 在电信应用中，这有助于计算信号距离，在已知距离处沿导线传输一个已知字，并对改变的位数进行计数以估算传输错误。 <br><br> 然后我们可以设计合适的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">纠错码</a> 。 例如，如果传输必须承受两个修改位，则代码字的汉明距离应相差至少5个。 <br><br><h4> 二元卷积神经网络 </h4><br> 现在完全不同了：二进制卷积神经网络！ 但是首先，这是什么？ <br><br><ul><li> 二进制表示与32位浮点值不同，我们仅使用值+1（编码为1）和-1（编码为0）的矩阵。 <br></li><li> 卷积是否意味着矩阵相乘？ <br></li><li> 神经网络是受动物大脑启发的系统（我在这里游泳了一点）。 </li></ul><br> 因此，我们必须执行二进制矩阵的乘法。 但是二进制矩阵有什么特别之处？ <br><br> 常规矩阵乘以32位值非常适合具有强大CPU和GPU的台式计算机，但是我们越来越经常希望在小型和简单的设备（例如智能手机，路由器，智能手表等）上做有用的工作。我们可以对它们进行分解二进制矩阵的层可以使用更复杂的矩阵，并且使用它们和存储它们更加容易，即使层数增加，我们也可以从中受益。 <br><br> 这就是<code>popcount</code>发挥作用的地方。 它用于计算两个二进制矩阵的标量积： <br><br><pre>  a = xnor（x，y）
 b =弹出数（a）
 c = len（a）
点（x，y）= 2×b-c </pre><br> 有关更多详细信息，请参见<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a> 。 <br><br><h4> 国际象棋编程 </h4><br> 许多国际象棋程序都以位<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">板</a>表示形式存储数据，可以方便地将其放入64位字中。  <code>Population Count</code>操作用于此视图下的有意义的操作，例如计算图形的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">移动性</a> 。 <br><br><h4> 分子指纹 </h4><br> 这也与汉明距离有关：以某种方式对分子进行散列和比较（使用<code>popcount</code> ）以确定它们之间的相似程度。 有关更多详细信息，请参见<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a> 。 <br><br><h4> 哈希数组映射尝试（HAMT） </h4><br> 这是我第一次了解<code>popcount</code> ！  HAMT是一种数据结构（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">最初由Phil Bagwell创建</a> ），可以在每个trie节点上的数组中存储非常多的值（通常为32或64）。 但是，每次为32或64个元素的数组分配内存可能非常浪费，尤其是在该数组实际上仅包含几个元素的情况下。 解决方案是添加一个位掩码，其中设置的位数与数组中元素的数量相对应，这允许数组根据需要增长和收缩。 可以使用<code>popcount</code>有效地完成给定元素的索引计算。 在有关实现HAMT结构的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">博客文章中</a> ，您可以了解有关它们如何工作的更多信息。 <br><br><h4> 压缩数据结构 </h4><br> 这是一个令人兴奋的新研究领域，其重点是如何在最小的空间内存储数据而又不拆包以完成有用的工作。 一种方法是根据可以在两个操作中请求的位的数组（位向量）进行思考： <br><br><ul><li>  <code>rank(i)</code>计算直到位向量中第i个索引为止的位数 <br></li><li>  <code>select(i)</code>查找设置第i位的索引 </li></ul><br> 为了使这些操作在大位向量上高效，在两种情况下都需要建立索引并有效使用它，这两种情况都涉及<code>popcount</code> 。 这是RRR指数的良好概述。 而且，据我所知，最先进的现代方法<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在未压缩位序列上的空间高效，高性能等级和选择结构一文中进行了介绍</a></i> 。 <br><br><h4> 编译器优化 </h4><br>  <code>popcount</code>变得如此广泛，以至于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GCC</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Clang</a>都能够检测到它并用内置指令替换它。 想象一下这个Clippy：“哦，我看到您正在尝试实现<code>popcount</code> ，让我出去为您修复它！” 相应的LLVM代码在<a href="">此处</a> 。  Daniel Lemyr引用它作为现代编译器令人惊叹的头脑的一个例子。 <br><br><h4> 结论 </h4><br> 尽管它仍然有点不寻常的CPU指令，但<code>popcount</code>指令在其历史的<code>popcount</code>在神秘之中，开始在<code>popcount</code>使用。 我喜欢它连接计算机科学这些不同领域的方式，并且我想知道还有多少其他这种奇怪的指令。 如果您有自己的最爱，我想听听她的消息！ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN467083/">https://habr.com/ru/post/zh-CN467083/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN467063/index.html">数据中心柴油发电机的燃料监控-如何做到这一点，为什么如此重要？</a></li>
<li><a href="../zh-CN467065/index.html">面向学生的物理奥林匹克竞赛问题档案</a></li>
<li><a href="../zh-CN467073/index.html">“在西方，没有40岁以下的艺术指导。 对于我们来说，最多可以达到30个。” 成为IT设计师感觉如何</a></li>
<li><a href="../zh-CN467079/index.html">CSS和Javascript蚂蚁轮播</a></li>
<li><a href="../zh-CN467081/index.html">分析《 Kinopoisk》评论的情感色彩</a></li>
<li><a href="../zh-CN467085/index.html">C，C ++和DotNet反编译是反向的基础。 用r0ot-mi解决换向问题。 第一部分</a></li>
<li><a href="../zh-CN467087/index.html">我如何准备并通过Oracle数据库SQL认证（1Z0-071）</a></li>
<li><a href="../zh-CN467089/index.html">已修补的Exim-再次修补。 在一个请求中，Exim 4.92中的全新远程命令执行</a></li>
<li><a href="../zh-CN467091/index.html">从Angular开发人员的角度快速介绍Svelte</a></li>
<li><a href="../zh-CN467093/index.html">使用Strace监视程序</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>