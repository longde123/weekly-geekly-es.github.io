<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöú ü§≥üèΩ üë®üèø‚Äç‚úàÔ∏è MassTransit, Saga, dan RabbitMQ untuk menerapkan manajer proses üïê üë©üèº‚Äçüíª üö£üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suatu kali, kami menghadapi tugas mengotomatisasi berbagai alur kerja di sebuah perusahaan besar. Bagi kami, ini berarti mengumpulkan sekitar 10 siste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MassTransit, Saga, dan RabbitMQ untuk menerapkan manajer proses</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/412793/"><p>  Suatu kali, kami menghadapi tugas mengotomatisasi berbagai alur kerja di sebuah perusahaan besar.  Bagi kami, ini berarti mengumpulkan sekitar 10 sistem pada saat peluncuran.  Selain itu, semuanya harus terhubung secara tidak sinkron, terukur, andal. </p><br><p>  Proses yang disederhanakan dapat digambarkan sebagai urutan tindakan dalam sistem yang berbeda, yang tidak dapat sepenuhnya otomatis, karena membutuhkan partisipasi manusia.  Misalnya, untuk memilih tindakan tertentu atau koordinasi elementer, yang diperlukan untuk pindah ke tahap proses selanjutnya. </p><br><p>  Untuk mengatasi masalah ini, kami memutuskan untuk menggunakan arsitektur perpesanan melalui bus data, dan MassTransit dengan Saga-nya bersamaan dengan RabbitMQ sangat cocok untuk kami. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8f9/896/b2a/8f9896b2aade49a732cf10b63b8276ec.jpg" alt="gambar"><a name="habracut"></a></p><h2>  Seperti apa Saga? </h2><br>  Saga adalah implementasi templat Manajer Proses dari buku <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Templat Integrasi Aplikasi Perusahaan</a> , yang memungkinkan Anda untuk menggambarkan proses sebagai mesin keadaan.  Suatu peristiwa tiba di pintu masuk, Saga melakukan serangkaian tindakan.  Pada saat yang sama, pada setiap tahap Saga, keputusan seseorang mungkin diperlukan.  Kemudian dia membuat tugas di pelacak dan "tertidur" untuk waktu yang tidak terbatas, menunggu acara baru. <br><p>  Saga didasarkan pada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Automatonymous</a> .  Ini secara deklaratif dijelaskan dalam kelas yang diwarisi dari MassTransitStateMachine &lt;&gt;.  Untuk Saga, Anda perlu menjelaskan semua status, peristiwa yang diambil, dan tindakan yang diambil saat peristiwa tertentu terjadi.  Keadaan saat ini disimpan dalam database. </p><br><p>  Pertama, kami menggambarkan semua negara bagian dan acara Saga dan memberi mereka nama yang bisa dimengerti.  Ini terlihat seperti ini: </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateMachine</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingTaskCreated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingTaskTakedToWork { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingDecisionAboutTask { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State Rejected { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;IStartWorkflowCommand&gt; StartWorkflowCommandReceived { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskCreatedNotification&gt; TaskCreated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskTakedToWorkNotification&gt; TaskTakedToWork { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskDeclinedNotification&gt; TaskDeclined { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskApprovedNotification&gt; TaskApproved { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildStateMachine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InstanceState(x =&gt; x.CurrentState); Event(() =&gt; StartWorkflowCommandReceived, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId) .SelectId(context =&gt; context.Message.CorrelationId)); Event(() =&gt; TaskCreated, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskTakedToWork, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskDeclined, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskApproved, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); } }</code> </pre> <br><p>  Kami telah meluncurkan kelas parsial, tempat kami mendeklarasikan daftar semua negara bagian dan acara, dan metode BuildStateMachine, yang menggambarkan korelasi peristiwa dengan Saga.  Untuk melakukan ini, parameter khusus CorrelationId dilewatkan di setiap peristiwa - ini adalah Guid, yang berjalan antara semua sistem yang terhubung dan dalam sistem pemantauan. </p><br><p>  Jadi, jika ada masalah yang muncul, kita dapat mengembalikan seluruh gambaran tentang apa yang terjadi dengan log dari semua sistem yang terhubung.  Kami mengirim CorrelationId dalam pesan dari Saga, sistem mengirimkannya kembali dalam pemberitahuan sehingga kami dapat menghubungkan pesan tersebut dengan Saga tertentu. </p><br><p>  Berikut adalah contoh dari kelas mesin negara itu sendiri: </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed partial <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> StateMachine : MassTransitStateMachine&lt;WorkflowSaga&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> StateMachine() { BuildStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">Initially</span></span>(WhenStartWorkflowCommandReceived()); During(AwaitingTaskCreatedInPlanner, WhenTaskCreated()); During(AwaitingTaskTakedToWork, WhenTaskTakedToWork()); During(AwaitingDecisionAboutTask, WhenTaskApproved(), WhenTaskDeclined()); } private EventActivityBinder&lt;WorkflowSaga, IStartWorkflowCommand&gt; WhenStartWorkflowCommandReceived() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(StartWorkflowCommandReceived) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.SaveConfigurationRequestInfo(ctx.Data)) .Send(TaskManagerQueue, ctx =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CreateTaskCommand(ctx.Instance)) .TransitionTo(AwaitingTaskCreated); } private EventActivityBinder&lt;WorkflowSaga, TaskCreatedNotification&gt; WhenTaskCreated() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(DPORPApproveTaskCreatedInPlanner) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.SaveCreatedTaskInfo(ctx.Data)) .Send(MailServiceQueue, ctx =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NotifyRequestAuthorThatWorkflowStarted(ctx.Instance)) .TransitionTo(AwaitingTaskTakedToWork); } private EventActivityBinder&lt;WorkflowSaga, TaskTakedToWorkNotification&gt; WhenTaskTakedToWork() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskTakedToWork) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsTakedToWork(ctx.Data)) .TransitionTo(AwaitingDecisionAboutTask); } private EventActivityBinder&lt;WorkflowSaga, TaskApprovedNotification&gt; WhenTaskApproved() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskApproved) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsApproved(ctx.Data)) .Finalize(); } private EventActivityBinder&lt;WorkflowSaga, TaskDeclinedNotification&gt; WhenTaskDeclined() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskDeclined) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsDeclined(ctx.Data)) .TransitionTo(Rejected); } }</code> </pre><br><p>  Konstruktor menjelaskan negara.  Penerimaan setiap acara dilakukan dengan metode terpisah untuk menjaga keterbacaan.  Seluruh logika membangun pesan dilakukan dalam pesan itu sendiri, jika tidak, dengan meningkatnya kompleksitas sistem, Saga membengkak cukup cepat. </p><br><p>  Perhatian harus diberikan dalam mengembangkan konvensi dan menjaga keterbacaan.  Karena imperatifitas C #, sangat sulit untuk mendeklarasikan deskripsi negara dan tindakan di dalamnya.  Bahkan untuk mesin keadaan sederhana, neraka sungguhan dimulai. </p><br><p>  Sekarang beberapa kata tentang SagaInstance.  SagaInstance adalah kelas yang diwarisi dari SagaStateMachineInstance.  Ini terdiri dari objek dan bidang yang menjadi ciri mesin negara.  Secara kasar, ini adalah memori Saga.  Kami menyimpan semua data Saga yang dia butuhkan sepanjang hidupnya.  Juga di kelas ini dijelaskan logika perubahan dalam data ini dalam perjalanan kerja. </p><br><p>  Berikut ini sebuah contoh: </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WorkflowSaga : SagaStateMachineInstance , ISagaWithState , ICreatedOnOffset , IModifiedOnOffset , ICreatedBy&lt;string&gt; , IModifiedBy&lt;string&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Guid CorrelationId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string CurrentState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string InitialRequestViewUrl { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestAuthor { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestText { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> byte[] RowVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string CreatedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string ModifiedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset CreatedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset ModifiedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset CompletedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> virtual ICollection&lt;RelatedTask&gt; RelatedTasks { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveGabrielConfigurationRequestInfo( ICreateGabrielConfigurationRequestCommand command) { CorrelationId = command.CorrelationId; RequestNumber = command.RequestNumber; RequestAuthor = command.Author; RequestText = command.RequestText; InitialRequestViewUrl = command.InitialRequestViewUrl; CreatedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveCreatedTaskInfo(ITaskCreationInfo taskCreationInfo) { RelatedPlannerTasks.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RelatedPlannerTask(taskCreationInfo)); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsTakedToWork(ITaskUpdatedInfo taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.TakedToWork); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsApproved(TaskApprovedNotification taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.Completed, taskInfo.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); CompletedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsDeclined(TaskDeclinedNotification taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.Declined, taskInfo.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); CompletedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } private <span class="hljs-type"><span class="hljs-type">void</span></span> UpdateTaskInfo(ITaskUpdatedInfo taskInfo, TaskStatus taskStatus, string <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { var task = RelatedTasks.Single(t =&gt; t.Number == taskInfo.Number); task.ModifiedBy = taskInfo.TaskModifiedBy; task.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>; task.Status = taskStatus; } }</code> </pre><br><p>  Contoh menunjukkan bahwa dalam SagaInstance CorrelationId disimpan untuk korelasi peristiwa dengan Saga dan CurrentState untuk menyimpan keadaan Saga saat ini. </p><br><h2>  Menangani kesalahan </h2><br><p>  Apa yang terjadi pada Saga jika terjadi kesalahan selama pemrosesan pesan?  Ini adalah masalah penting, karena semua orang ingin mesin negara untuk selalu tetap konsisten, bahkan jika ada yang salah.  Dan dengan MassTransit, Saga baik-baik saja. </p><br><p>  Seperti yang sudah Anda perhatikan, pada contoh di atas tidak ada satu pun blok coba tangkap untuk menangani pengecualian.  Alasannya sederhana: mereka tidak diperlukan di sana.  Jika pengecualian terjadi selama pemrosesan pesan, pesan dikembalikan ke antrian dan semua perubahan dibatalkan.  Karena kami melakukan semua manipulasi data dalam transaksi yang sama dengan Saga, transaksi tidak akan ditutup. </p><br><p>  Secara umum, manipulasi sesuatu selain Saga dalam Saga itu sendiri adalah praktik yang buruk.  Menurut buku "Template Integrasi untuk Aplikasi Perusahaan", manajer proses harus tetap setipis dan sebodoh mungkin: berikan saja perintah ke sistem dan pantau statusnya, tetapi dia sendiri tidak boleh melakukan apa pun. </p><br><p>  Tentu saja, ada skenario yang lebih kompleks ketika Anda perlu melakukan beberapa tindakan kompensasi untuk menangani pengecualian.  Kemudian pengendali mesin status ".Catch" digunakan untuk menangkap pengecualian dari tipe tertentu dan kemudian menjalankan logika kompensasi. </p><br><p>  Dan jika Anda hanya perlu berjanji pengecualian, maka lebih baik menggunakan pengamat (Observer). </p><br><p>  Sekarang bayangkan situasi bahwa kita telah menjalankan perintah Kirim selama pemrosesan pesan, setelah pengecualian terjadi.  Apa yang akan terjadi pada perintah yang dikirim pada langkah ini?  Lagi pula, semua yang telah terbang tidak dapat dikembalikan?  Tapi di sini semuanya dipikirkan. </p><br><p>  Saat mengkonfigurasi bus, Anda dapat mengaktifkan opsi UseInMemoryOutbox.  Opsi ini memungkinkan Anda untuk tidak mengirim pesan sampai langkah saat ini selesai.  Jika pengecualian terjadi, pesan tidak akan dikirim sama sekali.  Berikut adalah kutipan dari dokumentasi: </p><br><pre> <code class="hljs pgsql">/// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Includes an outbox <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the consume <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span>, which delays outgoing messages <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span> /// <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the pipeline <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the outbox <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>. At this <span class="hljs-type"><span class="hljs-type">point</span></span>, the message execution pipeline should be /// nearly complete <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> the ack remaining. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> an <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> thrown, the messages are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> sent/published. /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="configurator"&gt;The pipe configurator&lt;/param&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> UseInMemoryOutbox(this IConsumePipeConfigurator configurator)</code> </pre> <br><h2>  Tes </h2><br><p>  Sepintas, pengujian mesin keadaan asinkron masih menyenangkan.  Tapi di sini semuanya baik-baik saja.  MassTransit menyediakan kerangka kerja penulisan tes yang baik yang sepenuhnya memenuhi semua kebutuhan kita untuk menguji mesin negara. </p><br><p>  Kerangka kerja ini menyediakan InMemory dengan implementasi bus data (InMemoryTestHarness), yang memungkinkan Anda untuk mengirim dan menerima pesan yang melewati RabbitMQ atau antrian lainnya. </p><br><p>  Nah, sebagai contoh: </p><br><pre> <code class="hljs pgsql">[TestFixture] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SagaTests : TestFixtureBase { protected const string HostName = "HostName"; protected InMemoryTestHarness Harness; protected StateMachine StateMachine; protected StateMachineSagaTestHarness&lt;GabrielConfigurationRequestSaga, StateMachine&gt; Saga; [SetUp] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SetUp() { StateMachine = (StateMachine)Kernel. <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>&lt;MassTransitStateMachine&lt;WorkflowSaga&gt;&gt;(); Harness = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> InMemoryTestHarness(HostName); Saga = Harness .StateMachineSaga&lt;WorkflowSaga, StateMachine&gt;(StateMachine); } [TearDown] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TearDown() { await Harness.Stop(); } protected async Task&lt;WorkflowSaga&gt; InitializeSaga() { await Harness.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); var command = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TestStartWorkflowCommand { CorrelationId = SagaId, Author = RequestAuthor, InitialRequestViewUrl = InitialRequestViewUrl, RequestText = RequestText, RequestNumber = RequestNumber, }; await Harness.InputQueueSendEndpoint .Send&lt;IStartWorkflowCommand&gt;(command); //    ,  consume    , // ,  Saga  ,    <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(Harness.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;IStartWorkflowCommand&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); var currentSaga = Saga.Created.Contains(SagaId); currentSaga.RelatedPlannerTasks = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;RelatedPlannerTask&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSaga; } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task CheckCurrntStateWhenStartWorkflowCommand() { var saga = await InitializeSaga(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsNotNull(saga); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(StateMachine .AwaitingORDTApproveTaskCreatedInPlanner.Name, saga.CurrentState); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WhenTaskCreated : SagaTestsBase { private async Task&lt;WorkflowSaga&gt; InitializeState() { var saga = await InitializeSaga(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); saga.CurrentState = StateMachine.AwaitingTaskCreated.Name; InitializeRelatedTask(saga); await SendTaskCreatedNotification(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(Harness.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;TaskCreatedNotification&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> saga; } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task SaveWorkflowDataWhenTaskCreated() { var saga = await InitializeState(); var taskInfo = saga.RelatedPlannerTasks .First(task =&gt; task.PlannerTaskType == PlannerTaskType.DPORPApprove); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskNumber, taskInfo.Number); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskUrl, taskInfo.TaskUrl); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(SagaId, taskInfo.SagaCorrelationId); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskStatus.Created, taskInfo.Status); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, taskInfo.ModifiedBy); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(saga.CurrentState, StateMachine.AwaitingTaskTakedToWork.Name); } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task SendsMailWhenTaskCreated() { var mailConsumer = Harness .Consumer&lt;MockConsumer&lt;ISendEmailMessageWithTemplateCommand&gt;&gt; (RabbitMqRouting.QueueNames .SendEmailsQueueName); await InitializeState(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(mailConsumer.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;ISendEmailMessageWithTemplateCommand&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); } private async Task SendTaskCreatedNotification() { await Harness.InputQueueSendEndpoint .Send(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TaskCreatedNotification { TaskUrl = TaskUrl, Number = TaskNumber, TaskModifiedBy = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, CorrelationId = SagaId }); } }</code> </pre><br><p>  Tes berjalan cukup cepat.  Misalnya, pada komputer pengembang tunggal, 850 tes berjalan dalam waktu sekitar 21 detik. </p><br><h2>  Tips Berguna </h2><br><p>  Sebagai kesimpulan, kami memberikan daftar tips yang berguna berdasarkan pengalaman kami. </p><br><ol><li><p>  Kontrak dan skema komunikasi bus paling baik ditempatkan di nuget pribadi.  Jadi Anda tidak akan memiliki perbedaan dalam nama di sisi pengirim dan penerima.  Anda juga dapat meletakkan konstanta dengan penamaan antrian dan host di nuget.  Nuget dapat disesuaikan setiap hari.  Dan juga beberapa kontrol sumber mendukung nuget, ada feed pribadi berbayar. </p><br></li><li><p>  Memahami perbedaan antara Kirim dan Publikasikan.  Gunakan Kirim jika Anda memiliki satu pelanggan dan Anda tahu persis nama antrian yang Anda kirimi perintah.  Terbit dirancang untuk mengirim peringatan siaran.  Detail pada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> . </p><br></li><li><p>  Jika Anda perlu membuat pesan Permintaan / Respons, lebih baik menambahkan nama antrian untuk respons ke kontrak daripada menggunakan skema Permintaan / Respons dari MassTransit, yang disarankan oleh MassTransit sendiri untuk dihindari.  Karena ini sangat mengurangi keandalan.  Anda kehilangan semua manfaat asinkron.  Tetapi jika Anda masih perlu mendapatkan jawaban dalam waktu terbatas, lebih baik menggunakan panggilan langsung.  Ini paling baik ditulis dalam buku yang sama, "Templat Integrasi Aplikasi Perusahaan". </p><br></li><li><p>  Saga harus tipis.  Cobalah untuk membawa semua logika berat ke sistem lain.  Dan Saga harus melompati negara dan menyebarkan pesan ke kiri dan kanan. </p><br></li><li><p>  Tambahkan ke semua pesan CorrelationId, yang akan berjalan di antara sistem.  Jadi jauh lebih mudah untuk menganalisis log dan menautkan semua pesan menjadi satu gambar.  Masstransit juga melakukan hal yang sama.  CorrelationId ditambahkan ke pesan saat mewarisi dari antarmuka CorrelatedBy. <br></p><br>  Mengatur log dan memonitor di sistem Anda, tidak akan ada salahnya.  Pengalaman kami dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel ini</a> . <br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id412793/">https://habr.com/ru/post/id412793/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id412783/index.html">Menginstal proksi MTProto Telegram dari sumber pada Centos 7</a></li>
<li><a href="../id412785/index.html">Magister Manajemen dan Freelancer. Kisahnya dalam tiga bagian</a></li>
<li><a href="../id412787/index.html">Menanamkan Git dalam Sistem Pengembangan Perusahaan</a></li>
<li><a href="../id412789/index.html">"Bantuan dalam pekerjaan": cara membuat bot obrolan lebih pintar</a></li>
<li><a href="../id412791/index.html">Meningkatkan kinerja sistem pengawasan video dan mencegah crash</a></li>
<li><a href="../id412795/index.html">Dan mari kita menarik kesimpulan dari diskusi artikel "Apa yang salah dengan kembalinya Geektimes ke Habr"</a></li>
<li><a href="../id412797/index.html">Tentang bahaya CDN, layanan, dan font dari Google</a></li>
<li><a href="../id412799/index.html">Selalu berkomunikasi: Mango Talker - messenger dan softphone</a></li>
<li><a href="../id412801/index.html">Studi: peretas mencuri jutaan dolar karena keamanan pertukaran mata uang kripto yang rendah</a></li>
<li><a href="../id412803/index.html">Pandangan yang lebih dalam pada berbagai platform kontrak pintar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>