<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôæ üôçüèª üöá Conflu√™ncia Atlassian: extens√≠vel em python üßò üèä ‚ô¶Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em Alfastrakhovanie, usamos ativamente o "Wiki", cujo mecanismo √© o Atlassian Confluence. A primeira vez que me deparei com isso (na tentativa de cria...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conflu√™ncia Atlassian: extens√≠vel em python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/alfastrah/blog/460929/"><p>  Em Alfastrakhovanie, usamos ativamente o "Wiki", cujo mecanismo √© o Atlassian Confluence.  A primeira vez que me deparei com isso (na tentativa de criar conte√∫do nele), eu n√£o tinha "dinamismo" - eu queria poder formar partes de p√°ginas de forma program√°tica, interagir com outros sistemas etc. </p><br><p>  Por algum tempo, ele bateu a cabe√ßa contra paredes diferentes, mas depois viu que "n√£o havia uma parede na casa".  Quero compartilhar minha experi√™ncia - como posso adicionar palestrantes ao Confluence.  Espero que isso seja √∫til para quem usa.  E, como sempre, para todos curiosos. </p><a name="habracut"></a><br><h2 id="dinamichnyy-viki">  Wiki din√¢mico </h2><br><p>  Inicialmente, o Confluence sugere uma maneira universal de expandir sua funcionalidade - plugins.  Provavelmente, ele √© bom, existe apenas uma desvantagem - um alto limite de entrada (voc√™ precisa aprender muito). </p><br><p>  Ap√≥s uma breve reflex√£o (pelos padr√µes de espa√ßo), havia duas maneiras mais simples de expandir sua funcionalidade: a macro padr√£o "HTML" e "HTML Include". Neste artigo, focaremos mais detalhadamente no √∫ltimo. </p><br><p>  H√° um princ√≠pio de opera√ß√£o para esses m√©todos - o c√≥digo HTML √© incorporado na p√°gina do Confluence, pode ser est√°tico (que tamb√©m pode ser interessante, por exemplo, para formata√ß√£o de p√°gina n√£o padr√£o), pode ser din√¢mico (incluindo componentes do servidor). </p><br><h2 id="primer-zapros-na-soglasovanie">  Exemplo: solicita√ß√£o de reconcilia√ß√£o </h2><br><p>  Vejamos a maneira proposta de expandir os recursos do Confluence com um exemplo simples - uma lista de aprova√ß√£o de documentos. </p><br><p>  O que queremos fazer: adicione uma lista de aprova√ß√£o √† p√°gina para que todos possam ver quem deve coordenar o documento, se foi acordado e, se sim, quando. </p><br><p>  Por conveni√™ncia, transformaremos o item da lista em um bot√£o e escreveremos nele o nome do coordenador.  O bot√£o estar√° ativo se a p√°gina for visualizada pelo coordenador e n√£o estar√° ativo em todos os outros casos. </p><br><p> Ap√≥s a aprova√ß√£o, o bot√£o "deixar√° de ser um bot√£o" - em vez do bot√£o ap√≥s a aprova√ß√£o, desenharemos na p√°gina o fato da aprova√ß√£o na forma de um texto (o nome do aprovador e a data da aprova√ß√£o).  Na vers√£o mais rascunho (sem design), pode ser algo como isto: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3cf/285/175/3cf2851757c85ff0c8994dde698ec5d7.png" alt="imagem"></p><br><h3 id="shema-vzaimodeystviya">  Esquema de intera√ß√£o </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/600/48b/a4c/60048ba4cdef1ccdd55a355cb8bf3c19.png" alt="imagem"></p><br><p>  Coment√°rios - como funciona: </p><br><ul><li>  a p√°gina do Confluence cont√©m v√°rias macro "html include" - na verdade, solicita√ß√µes HTTP GET com par√¢metros (consideraremos mais detalhadamente abaixo) </li><li>  ao renderizar uma p√°gina, essas solicita√ß√µes (scripts python) s√£o executadas no servidor de aplicativos, o resultado (HTML gerado) √© desenhado na p√°gina </li><li>  no processo de seu trabalho, o script, por exemplo, entra em contato com o banco de dados com o hist√≥rico de assinatura da p√°gina, se a p√°gina ainda n√£o tiver sido "assinada" pelo assinante - o HTML conter√° um bot√£o (tudo como descrito acima) </li><li>  quando voc√™ clica no bot√£o, o envio ocorre - outro script python √© chamado (um script para processar o fato da coordena√ß√£o) </li><li>  este script salva informa√ß√µes sobre o fato de entrar no banco de dados e redireciona o usu√°rio de volta √† p√°gina original (ao renderizar o fato de que o fato de assinar ser√° levado em considera√ß√£o - clicando no bot√£o "assinar") </li></ul><br><p>  Um pouco complicado em palavras, vamos tentar esclarecer o c√≥digo. </p><br><p>  Ent√£o, precisamos criar dois scripts </p><br><ul><li>  o script para a forma√ß√£o do bot√£o "sign" (vou cham√°-lo de script "button") </li><li>  um script para descobrir o fato de assinar (rea√ß√£o a um clique no bot√£o - chamarei seu script de "manipulador") </li></ul><br><p>  Vamos cri√°-los, comece com o bot√£o. </p><br><h4 id="skript-knopka">  Bot√£o Script </h4><br><p>  Esquematicamente, como o script do bot√£o funciona: </p><br><pre><code class="python hljs">date = getSignDate() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> date: <span class="hljs-comment"><span class="hljs-comment">#       . else: if user==signee: #    else: #  inactive </span></span></code> </pre> <br><p>  O script deve ser um documento HTML v√°lido, cujo corpo, no formato m√≠nimo, √© um formul√°rio </p><br><ul><li>  A a√ß√£o do formul√°rio cont√©m a URL do script "manipulador" </li><li>  o bot√£o ativo √© enviar </li><li>  campos de formul√°rio ocultos cont√™m par√¢metros adicionais para o manipulador (no nosso caso, o nome da p√°gina e o login do signat√°rio) </li></ul><br><p>  Uma vis√£o aproximada do script (por quest√µes de brevidade, joguei fora tudo o que era desnecess√°rio - veja o c√≥digo completo do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a> ) </p><br><pre> <code class="python hljs">form = cgi.FieldStorage() signee = form[<span class="hljs-string"><span class="hljs-string">"signee"</span></span>].value <span class="hljs-comment"><span class="hljs-comment">#   (  ) actual = form["actual"].value #    id = form["id"].value #  ,    resHtml = """ &lt;!DOCTYPE HTML&gt; &lt;html&gt; &lt;head&gt;&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;&lt;/head&gt; &lt;body&gt; &lt;form name="input" action="http://172.16.108.216/misc/sign_proc.py" method="get"&gt; """ server, token = wikiLogin() #   Confluence userName = getUserName(token, signee) #        res = getSignDate(id, signee) #     if res: #    resHtml += "&lt;p&gt; ({0}, {1})&lt;/p&gt;".format(userName, res) #   else: #    if signee.lower() == actual.lower(): #      -   resHtml += '&lt;input type="hidden" name="id" value="{0}"&gt;'.format(id) resHtml += '&lt;input type="hidden" name="signee" value="{0}"&gt;'.format(signee) resHtml += "   &lt;input type=\"submit\" value=\"{0}\"&gt;".format(userName) else: #      -    resHtml += "   &lt;input disabled type=\"submit\" value=\"{0}\"&gt;".format(userName) resHtml += "&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;" #   HTML sys.stdout.buffer.write(b'Content-Type: text/html;charset=utf-8\n\n') sys.stdout.buffer.write(resHtml.encode("utf-8"))</span></span></code> </pre> <br><h4 id="skript-obrabotchik">  Script "manipulador" </h4><br><p>  A tarefa do manipulador √© muito simples - para corrigir o fato de pressionar o bot√£o "concordo".  Em seguida, redirecione de volta para a p√°gina de onde a solicita√ß√£o veio - ao renderizar a p√°gina, o fato de coordena√ß√£o j√° ser√° levado em considera√ß√£o (veja a descri√ß√£o acima). </p><br><p>  Um exemplo (abreviado) de script "manipulador" (a vers√£o completa - veja o github) </p><br><pre> <code class="python hljs">form = cgi.FieldStorage() signee = form[<span class="hljs-string"><span class="hljs-string">"signee"</span></span>].value <span class="hljs-comment"><span class="hljs-comment">#   id = form["id"].value #  ,    addSignDate(id, signee) #    resHtml = """ &lt;html&gt; &lt;head&gt; &lt;meta http-equiv="refresh" content="5;url=http://wiki.alfastrah.ru/display/DIT/{0}"&gt; &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt; &lt;title&gt; &lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt;    &lt;b&gt;{0}&lt;/b&gt;  &lt;b&gt;{1}&lt;/b&gt; . &lt;br&gt;      ...&lt;/p&gt; &lt;/body&gt; &lt;/html&gt; """.format(id, signee) sys.stdout.buffer.write(b'Content-Type: text/html;charset=utf-8\n\n') sys.stdout.buffer.write(resHtml.encode("utf-8"))</span></span></code> </pre> <br><h4 id="stranica-v-confluence">  P√°gina em Confluence </h4><br><p>  A p√°gina do Confluence cont√©m tr√™s macro HTML inclu√≠dos com par√¢metros diferentes (veja o c√≥digo abaixo) e, na vers√£o mais simples, fica assim: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7ba/788/498/7ba788498511262c7e13618503eae77e.png" alt="imagem"></p><br><p>  C√≥digo da p√°gina no formato de marca√ß√£o wiki - aqui voc√™ pode ver os par√¢metros </p><br><pre> <code class="plaintext hljs">&lt;h1&gt; &lt;/h1&gt; &lt;p&gt; ,  &lt;/p&gt; &lt;h1&gt; &lt;/h1&gt; &lt;ul&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=boss&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=korolevmv&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=maxvar&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;/ul&gt;</code> </pre> <br><h3 id="nemnogo-o-nastroyke">  Um pouco sobre como configurar </h3><br><p>  Para que o esquema descrito funcione, √© necess√°rio levar em considera√ß√£o os seguintes </p><br><h4 id="nalichie-makrosa-html-include">  Disponibilidade da macro de inclus√£o HTML </h4><br><p>  √Äs vezes, os administradores o ocultam - existem muitos problemas adicionais para ele (o outro lado das possibilidades). </p><br><p>  Essa macro √© gratuita e faz parte do Confluence - se voc√™ n√£o tiver uma, entre em contato com os administradores, deixe-os procurar ... </p><br><h4 id="belye-spiski-confluence">  Confluence White Lists </h4><br><p>  O Confluence n√£o executar√° scripts hospedados em fontes desconhecidas; o host no qual o script est√° hospedado deve estar nas chamadas "listas brancas" (entre em contato com os administradores).  Isso se aplica apenas ao script "button" - o script do manipulador j√° √© chamado pelo bot√£o, as restri√ß√µes do Confluence n√£o se aplicam a ele. </p><br><h4 id="vypolnimost-skriptov">  Execu√ß√£o de script </h4><br><p>  Os scripts (bot√µes e manipulador) devem ser execut√°veis ‚Äã‚Äã- copie o URL para o navegador, ele deve funcionar e gerar HTML; se isso n√£o acontecer, depure-o. </p><br><h4 id="oshibki-v-skriptah">  Erros de script </h4><br><p>  Se algum dos scripts travar com um erro - voc√™ n√£o ver√° nada de bom, depure corretamente antes de publicar no Confluence. </p><br><h2 id="parametry-skriptov">  Op√ß√µes de script </h2><br><p>  Uma mente indagadora pode prestar aten√ß√£o aos par√¢metros do script - por um lado, s√£o redundantes (por exemplo, o nome da p√°gina na qual o bot√£o de aprova√ß√£o est√° colocado - √© conhecido, por que preench√™-lo?).  Por outro lado, eles s√£o inseguros (o "invasor" em nosso exemplo pode alterar o nome do aprovador por conta pr√≥pria ou excluir o bot√£o de reconcilia√ß√£o). </p><br><p>  A redund√¢ncia pode ser "superada" pelas macros de usu√°rio (eu me pergunto h√° muito tempo - como elas podem ser praticamente √∫teis? Escreverei brevemente em um artigo separado).  A seguran√ßa no Confluence √© garantida pelo hist√≥rico da p√°gina - todos os "movimentos" s√£o registrados, voc√™ pode alterar qualquer coisa; no Confluence permanece uma maravilhosa "trilha de auditoria" que permite entender em detalhes quem mudou o que e quando. </p><br><h2 id="vzaimodeystvie-so-stranicey">  Intera√ß√£o da p√°gina </h2><br><p>  Em nossa pr√°tica, houve casos em que tivemos que analisar o c√≥digo da p√°gina para coletar dados (por exemplo, √© assim que gerenciamos o portf√≥lio de projetos).  √â poss√≠vel e nem muito dif√≠cil.  Evolutivamente, chegamos √† conclus√£o de que, se algumas informa√ß√µes em uma p√°gina s√£o necess√°rias apenas para o c√≥digo que interpreta essas informa√ß√µes, √© mais f√°cil formular essas informa√ß√µes imediatamente no pr√≥prio c√≥digo (na forma de JSON, por exemplo): edit√°-lo no modo de edi√ß√£o de p√°gina √© bastante simples , √© atra√≠do pelo programa, mas as economias em an√°lise e maior confiabilidade s√£o significativas. </p><br><h2 id="esche-primery">  Mais exemplos </h2><br><p>  Por que mais usamos essas macros (como id√©ias - de repente, algo se mostra √∫til), muito brevemente </p><br><p>  Design da <strong>p√°gina</strong> : se voc√™ deseja projetar a p√°gina de maneira n√£o padr√£o - marca√ß√£o usando CSS, que est√° contido no bloco HTML </p><br><p>  <strong>Calend√°rio de f√©rias</strong> : usamos um calend√°rio JS simples, preenche-o com dados do JSON, que editamos diretamente no c√≥digo da p√°gina, obtemos um belo prato com as f√©rias divididas (ano, m√™s, semana). </p><br><p>  <strong>Impress√£o de cart√µes de tarefas para um quadro de scrum</strong> : definimos os par√¢metros (n√∫meros de tarefas no Jira e atributos adicionais) no formul√°rio na p√°gina wiki (no bloco HTML), o lado do servidor forma os cart√µes de forma adequada para o envio a uma impressora. </p><br><p>  <strong>Gerenciamento de portf√≥lio de projetos</strong> : t√≠nhamos essa ideia.  Os mapas foram pontuados diretamente no wiki (o mapa de pontua√ß√£o √© uma p√°gina especialmente marcada), um plano de blocos grandes foi compilado a partir desses mapas de pontua√ß√£o, que foram lindamente desenhados na forma de um gr√°fico de Gantt. </p><br><p>  <strong>Gloss√°rio</strong> : a capacidade de visualizar termos - explica√ß√µes para palavras individuais de uma p√°gina - de um dicion√°rio comum e emitir entradas de dicion√°rio na forma de "pop-ups".  O pr√≥prio dicion√°rio √© coletado automaticamente na parte inferior da p√°gina. </p><br><p>  <strong>Gr√°ficos</strong> : se voc√™ precisar desenhar algum tipo de gr√°fico simples, √© muito simples fazer isso incorporando o bloco HTML a qualquer um dos pacotes padr√£o (Google Charts, HighCharts, etc.) </p><br><p>  <strong>Tabelas</strong> : em cima de qualquer mesa do Confluence voc√™ pode "pendurar" o Datatable - obtemos uma tabela filtrada com "pagina√ß√£o", muito agrad√°vel e conveniente. </p><br><p>  A lista pode ser continuada por tempo suficiente; durante a opera√ß√£o, foi observado um inconveniente significativo: os erros no c√≥digo do servidor s√£o mal detectados - 500 erros s√£o mal visualizados e praticamente n√£o cont√™m informa√ß√µes.  Caso contr√°rio, experimente - √© seguro o suficiente. </p><br><h2 id="chut-podytozhim">  Resumir </h2><br><p>  A maneira simples descrita acima para aumentar o dinamismo do Confluence permite resolver muitos problemas diferentes.  Para us√°-lo, n√£o s√£o necess√°rias ferramentas e habilidades especiais.  O uso √© seguro o suficiente.  Eu recomendo. </p><br><p>  No pr√≥ximo artigo, falarei sobre a experi√™ncia de usar macros personalizadas no Confluence - que, na minha opini√£o, pode realmente ser aprimorado com a ajuda delas. </p><br><p>  Tudo √© poss√≠vel na programa√ß√£o - apenas uma quest√£o de tempo e motiva√ß√£o. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460929/">https://habr.com/ru/post/pt460929/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460911/index.html">Fazendo o bem, fazendo o mal: escrevendo c√≥digo mal com Go, parte 2</a></li>
<li><a href="../pt460913/index.html">Visita fotogr√°fica ao museu do Instituto de F√≠sica e Energia de Obninsk</a></li>
<li><a href="../pt460915/index.html">Sistema de gerenciamento de banco de dados conveniente</a></li>
<li><a href="../pt460923/index.html">Tarefa de teste Yandex</a></li>
<li><a href="../pt460925/index.html">Jogo online com rob√¥s reais de RC em Chernobyl. Parte 2</a></li>
<li><a href="../pt460931/index.html">Sobre decoradores em Python</a></li>
<li><a href="../pt460933/index.html">Semana 30 de seguran√ßa: privacidade, tecnologia e sociedade</a></li>
<li><a href="../pt460935/index.html">Introdu√ß√£o ao analisador est√°tico PVS-Studio para Visual C #</a></li>
<li><a href="../pt460939/index.html">Longrid sobre a hist√≥ria da minera√ß√£o russa e a atitude dos reguladores em rela√ß√£o a ela</a></li>
<li><a href="../pt460941/index.html">Compromisso de e-mail comercial: sem defesa contra ataques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>