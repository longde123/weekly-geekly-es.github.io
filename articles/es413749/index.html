<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî™ üçæ üôÑ B + √°rbol en un proyecto real üë® üìã üòÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, veremos en detalle c√≥mo se hace el √°rbol B + en una base de datos distribuida Apache Ignite . 




 Ya hay un par de art√≠culos sobre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>B + √°rbol en un proyecto real</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/413749/"><p>  En este art√≠culo, veremos en detalle c√≥mo se hace el √°rbol B + en una base de datos distribuida <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Apache Ignite</a> . <br></p><br><img src="https://habrastorage.org/webt/mv/_t/zg/mv_tzg1o-c96a2ib19cf9umv67u.jpeg"><a name="habracut"></a><br><p>  Ya hay un par de art√≠culos sobre √°rboles H en √°rboles B ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dos</a> ), pero es m√°s probable que sean te√≥ricos e incluso si contienen una implementaci√≥n, entonces no est√°n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">listos para la producci√≥n</a> .  A partir de esto, hay un inter√©s en observar la implementaci√≥n que se utiliza en la vida. </p><br><p>  Antes de seguir leyendo el art√≠culo, le aconsejo que vea una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">conferencia de Maxim Babenko</a> , si a√∫n no sabe qu√© es el √°rbol B en teor√≠a.  Pero no necesito conocer Java en profundidad ni el proyecto Apache Ignite: escribir√© los detalles expl√≠citamente u los ocultar√© bajo spoilers. </p><br><p>  Al leer las fuentes de Ignite, le aconsejo que omita los argumentos de los m√©todos en su mente, cuyo significado no es muy claro y que lea los nombres de las funciones; es mucho m√°s f√°cil leer el cuerpo de la funci√≥n si sabe de antemano lo que hace. </p><br><p>  Tenga en cuenta que no soy el desarrollador principal de Apache Ignite y podr√≠a haber entendido mal algo del c√≥digo.  Entonces, saqu√© la frase "hasta donde yo entiendo", que debe agregarse mentalmente antes de cada oraci√≥n afirmativa. </p><br><h1 id="zachem-b-derevo-v-apache-ignite">  ¬øPor qu√© B + tree en Apache Ignite? </h1><br><p> Apache Ignite es una base de datos en memoria, pero desde la versi√≥n 2.1 tiene un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">almac√©n de datos persistente</a> , una funci√≥n para guardar datos en el disco <em>(no tiene nada que ver con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la estructura de datos persistente</a> )</em> .  Por lo tanto, est√° claro por qu√© se necesita una estructura para la memoria externa, queda por entender por qu√© no eligieron otra. </p><br><p>  Para empezar, el √°rbol B + es una optimizaci√≥n del √°rbol B, donde los valores se almacenan solo en hojas.  En esta optimizaci√≥n, caben m√°s claves en un nodo, lo que aumenta el grado de ramificaci√≥n.  Por lo tanto, no hay muchas razones para usar el √°rbol B cl√°sico. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">B *</a> y B + *: son m√°s densos en el disco, pero tienen peor rendimiento, porque  almacenamos datos de RAM, el rendimiento es m√°s importante para nosotros. </p><br><p>  A juzgar por los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">puntos</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">referencia, un</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√°rbol LSM es</a> m√°s r√°pido en la escritura, pero m√°s lento en la lectura.  Adem√°s, la p√©rdida en la lectura es mayor que la ganancia en la escritura, por lo que para un caso general hipot√©tico, tambi√©n tomar√≠a el √°rbol B +. </p><br><p>  Tambi√©n hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√°rboles fractales</a> extra√±os, sin embargo, aparentemente, est√°n patentados e implementados solo en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TokuDB</a> . </p><br><p>  Personalmente, estoy m√°s interesado en por qu√© era imposible tomar un backend de disco ya preparado, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LevelDB</a> .  Una respuesta parcial es que PDS admite almacenamiento de terceros. </p><br><h1 id="realizaciya-v-krupnuyu-kletku">  Implementaci√≥n de c√©lulas grandes </h1><br><p> Inicialmente, GridGain desarroll√≥ Apache Ignite, pero antes de partir a c√≥digo abierto llevaba el nombre de la compa√±√≠a, por lo que algunos nombres de componentes comienzan con <code>Grid</code> y otros con <code>Ignite</code> .  Por <code>GridCursor</code> tanto, <code>GridCursor</code> , pero <code>IgniteTree</code> .  No hay otra l√≥gica aqu√≠. </p><br><p>  El c√≥digo Apache Ignite est√° escrito en los patrones de mejores pr√°cticas de Java, y cada clase hereda una interfaz, si no una.  Desde la interfaz <code>IgniteTree</code> y comienza el baile.  Doy el c√≥digo sin javadoc, para abreviar. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T val)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key, Object x, InvokeClosure&lt;T&gt; c)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper, Object x)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findFirst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findLast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvokeClosure</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable T row)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">OperationType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operationType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> OperationType { NOOP, REMOVE, PUT } }</code> </pre> <br><p>  La interfaz <code>IgniteTree</code> describe un conjunto est√°ndar de operaciones.  Tenga en cuenta que para realizar una b√∫squeda por rango, debe tejer hojas en una lista.  El bono admite una operaci√≥n de registro arbitrario: <code>invoke</code> . </p><br><p>  La operaci√≥n <code>put</code> toma solo un argumento de tipo <code>T</code> sin una clave.  No encontrar√° una explicaci√≥n para esto en <code>IgniteTree</code> , sin embargo, la respuesta est√° oculta en el encabezado <code>BPlusTree</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BPlusTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataStructure</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br><p>  Como puede ver, el valor hereda la clave, por lo tanto, en la operaci√≥n de venta, la clave se calcula a partir del valor.  Esto no limita la funcionalidad del √°rbol.  Supongo que es m√°s compacto almacenar juegos. </p><br><p>  Por lo general, se establecen fuera del mapa al adjuntar una constante de basura al valor.  Sin embargo, en el √°rbol B +, <em>solo las claves se</em> almacenan en nodos; si el valor tambi√©n almacena la clave, entonces en las hojas es suficiente almacenar <em>solo los valores</em> .  Y si el √°rbol es un conjunto, autom√°ticamente resulta que en las hojas solo habr√° claves sin valores basura. </p><br><p><img src="https://habrastorage.org/webt/gk/5a/mj/gk5amjeohtkej5assnsgyy791p4.png"></p><br><p>  Ahora veamos el c√≥digo de b√∫squeda del elemento. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> g Get. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> IgniteCheckedException If failed. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doFind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Get g)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. g.init(); switch (findDown(g, g.rootId, 0L, g.rootLvl)) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; default: return; } } } /** * @param g Get. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result findDown(final Get g, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { long page = acquirePage(pageId); try { for (;;) { // Init args. g.pageId = pageId; g.fwdId = fwdId; Result res = read(pageId, page, search, g, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert g.pageId != pageId; assert g.fwdId != fwdId || fwdId == 0; // Go down recursively. res = findDown(g, g.pageId, g.fwdId, lvl - 1); switch (res) { case RETRY: checkInterrupted(); continue; // The child page got split, need to reread our page. default: return res; } case NOT_FOUND: assert lvl == 0 : lvl; g.row = null; // Mark not found result. return res; default: return res; } } } finally { if (g.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  La base del algoritmo transversal del √°rbol B se ha mantenido sin cambios: descienden el √°rbol recursivamente a la hoja deseada: si el valor est√° presente, entonces devuelven el resultado, y si no, entonces <code>null</code> .  La recursi√≥n aparentemente se dej√≥ por conveniencia, de todos modos, los √°rboles B no son profundos. </p><br><p><img src="https://habrastorage.org/webt/tc/g3/0t/tcg30to_z-6fcrfegjfulubh0gq.jpeg"></p><br><p>  Me sorprendi√≥ porque hab√≠a una instalaci√≥n clara en mi cabeza: la recursi√≥n siempre se elimina en un proyecto real ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">no hay una optimizaci√≥n de recursi√≥n de cola en Java</a> , la recursi√≥n es aceptable en proyectos en otros idiomas).  Pero realmente, la altura del √°rbol B se mide en unidades, porque el tama√±o del bloque de orden <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></mn><mrow class="MJX-TeXAtom-ORD"><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10</font></font></mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> 2 ^ {10} </script>  y la cantidad de datos del pedido <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></mn><mrow class="MJX-TeXAtom-ORD"><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40</font></font></mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-2"> 2 ^ {40} </script>  y la altura ser√° <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mn>4</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.975ex" height="2.901ex" viewBox="0 -935.7 10753.2 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-29" x="2962" y="0"></use></g><g transform="translate(5566,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-29" x="2962" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-3D" x="9196" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhjt6-tHopBsrZgL360tWhIwtLy51Q#MJMAIN-34" x="10252" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c</font></font></mi><mrow class="MJX-TeXAtom-ORD"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(</font></font></mo><msup><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></mn><mrow class="MJX-TeXAtom-ORD"><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40</font></font></mn></mrow></msup><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(</font></font></mo><msup><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></mn><mrow class="MJX-TeXAtom-ORD"><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10</font></font></mn></mrow></msup><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></mo></mrow><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></mo><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 4</font></font></mn></math></span></span><script type="math/tex" id="MathJax-Element-3"> \ frac {log (2 ^ {40})} {log (2 ^ {10})} = 4 </script>  . </p><br><p>  Apache Ignite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ama la concurrencia</a> .  Por lo tanto, el √°rbol admite modificaciones competitivas.  En el momento de la operaci√≥n, una p√°gina est√° bloqueada, pero otro hilo puede modificar el resto del √°rbol para que se requiera una segunda lectura.  Y as√≠ el procedimiento puede llegar a la ra√≠z. </p><br><p>  Al principio, no entend√≠ el significado de dicha funcionalidad, porque el disco es lento y un hilo procesar√° con calma todas las operaciones de E / S.  Est√° claro que la b√∫squeda en el nodo cargado desde el disco cuesta un poco y durante este tiempo puede cargar el disco con otra operaci√≥n, pero los intentos repetidos consumir√°n la ganancia.  Sin embargo, me di cuenta de que en esta implementaci√≥n los nodos no se enjuagaron inmediatamente en el disco despu√©s de la modificaci√≥n, sino que se quedaron en la memoria por un tiempo, para luego aplicar muchas modificaciones a la vez.  No se pierden datos gracias a Write Ahead Log.  Encontrar√° m√°s informaci√≥n al final del art√≠culo. </p><br><p>  Ahora veamos el c√≥digo para agregar un elemento. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> needOld)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ checkDestroyed(); Put p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Put(row, needOld); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. p.init(); Result res = putDown(p, p.rootId, 0L, p.rootLvl); switch (res) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; case FOUND: // We may need to insert split key into upper level here. if (!p.isFinished()) { // It must be impossible to have an insert higher than the current root, // because we are making decision about creating new root while keeping // write lock on current root, so it can't concurrently change. assert p.btmLvl &lt;= getRootLevel(); checkInterrupted(); continue; } return p.oldRow; default: throw new IllegalStateException("Result: " + res); } } } catch (IgniteCheckedException e) { throw new IgniteCheckedException("Runtime failure on row: " + row, e); } catch (RuntimeException e) { throw new IgniteException("Runtime failure on row: " + row, e); } catch (AssertionError e) { throw new AssertionError("Assertion error on row: " + row, e); } finally { checkDestroyed(); } } /** * @param p Put. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result putDown(final Put p, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { assert lvl &gt;= 0 : lvl; final long page = acquirePage(pageId); try { for (;;) { // Init args. p.pageId = pageId; p.fwdId = fwdId; Result res = read(pageId, page, search, p, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert lvl &gt; 0 : lvl; assert p.pageId != pageId; assert p.fwdId != fwdId || fwdId == 0; res = p.tryReplaceInner(pageId, page, fwdId, lvl); if (res != RETRY) // Go down recursively. res = putDown(p, p.pageId, p.fwdId, lvl - 1); if (res == RETRY_ROOT || p.isFinished()) return res; if (res == RETRY) checkInterrupted(); continue; // We have to insert split row to this level or it is a retry. case FOUND: // Do replace. assert lvl == 0 : "This replace can happen only at the bottom level."; return p.tryReplace(pageId, page, fwdId, lvl); case NOT_FOUND: // Do insert. assert lvl == p.btmLvl : "must insert at the bottom level"; assert p.needReplaceInner == FALSE : p.needReplaceInner + " " + lvl; return p.tryInsert(pageId, page, fwdId, lvl); default: return res; } } } finally { if (p.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  La √∫nica diferencia es que despu√©s de detectar la posici√≥n, el c√≥digo se <code>replace</code> e <code>insert</code> .  Ya no puedes ver el c√≥digo de <code>remove</code> .  El mecanismo b√°sico es que con intentos repetidos de caminar recursivamente a trav√©s del √°rbol junto con un objeto especial dependiendo de la operaci√≥n: <code>Get</code> , <code>Put</code> o <code>Remove</code> . </p><br><p>  <code>Invoke</code> funciona de la misma manera, solo la operaci√≥n se realiza con una copia del registro, luego se determina su tipo: <code>NOOP</code> para leer, <code>REMOVE</code> para eliminar y <code>PUT</code> para actualizar o agregar, y luego se genera el objeto <code>Put</code> o <code>Remove</code> correspondiente, que se aplica al registro en el √°rbol. </p><br><h1 id="ispolzovanie">  Uso </h1><br><p>  A continuaci√≥n, <code>BPlusTree</code> un vistazo m√°s de cerca a dos <code>BPlusTree</code> <code>CacheDataTree</code> : <code>CacheDataTree</code> y <code>PendingEntriesTree</code> .  Overboard es la implementaci√≥n de √≠ndices: este es un tema para una discusi√≥n por separado, para la cual a√∫n no estoy listo. </p><br><p>  Antes de continuar, <code>IgniteCache</code> que el mapa distribuido local tiene una funcionalidad <code>IgniteCache</code> y se llama <code>IgniteCache</code> , en adelante simplemente un cach√©. </p><br><h2 id="cachedatatree"> <code>CacheDataTree</code> </h2> <br><p>  <code>CacheDataTree</code> es una asignaci√≥n de m√∫ltiples <code>IgniteCache</code> al disco.  La ordenaci√≥n es multinivel: primero ordena por ID de cach√© para agrupar las claves en un cach√©, y luego por hash. </p><br><p>  <code>CacheDataTree</code> no itera sobre el rango, ya que los √≠ndices se implementan en los herederos de <code>H2Tree extends BPlusTree</code> , por lo que el tipo espec√≠fico de clasificaci√≥n no es importante: cualquiera es suficiente para las operaciones de <code>put</code> y <code>get</code> .  Comparar hashes es m√°s r√°pido que los objetos.  Pero lo m√°s importante, un hash uniforme llenar√° el √°rbol m√°s densamente. </p><br><p>  Los √°rboles se equilibran para que no se degeneren en una lista.  Pero si agrega claves distribuidas uniformemente al √°rbol de b√∫squeda, se equilibrar√° autom√°ticamente.  Dado que los √°rboles B comienzan a equilibrarse a medida que surgen problemas, y los hashes mezclan claves de manera uniforme, la clasificaci√≥n por hash reduce la frecuencia del equilibrio. </p><br><p>  Usar hashes en el √°rbol de b√∫squeda no es una idea tan extra√±a como parece, su desarrollo l√≥gico conducir√° a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">trie mapeado de matriz Hash</a> . </p><br><h2 id="pendingentriestree"> <code>PendingEntriesTree</code> </h2> <br><p>  <code>PendingEntriesTree</code> almacena claves para datos a lo largo del tiempo y se utiliza como conjunto.  La ordenaci√≥n es multinivel: primero ordenada por ID de cach√© para agrupar claves en una cach√©, y luego por tiempo de vida.  La siguiente es otra ronda de comparaci√≥n, aparentemente, puramente t√©cnica, para distinguir entre elementos.  De la clasificaci√≥n es f√°cil adivinar que esta clase se usa para buscar rangos.  Este √°rbol duplica las claves de entrada de cach√© para la preferencia. </p><br><p>  Comprende c√≥mo funciona esta aventura separada. </p><br><div class="spoiler">  <b class="spoiler_title">Aventura</b> <div class="spoiler_text"><p>  En <code>IgniteCacheOffheapManagerImpl.expire()</code> tome el cursor y elimine las entradas de <code>PendingEntriesTree</code> .  Las entradas en el <code>CacheDataTree</code> se eliminan en el cierre <code>c</code> , que se pasa en los par√°metros. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( GridCacheContext cctx, IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount )</span></span></span></span></code> </pre> <br><p>  Apache Ignite recientemente dej√≥ de admitir Java 7, por lo que el cierre se crea a trav√©s de una clase an√≥nima. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; expireC = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GridCacheEntryEx entry, GridCacheVersion obsoleteVer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> touch = !entry.isNear(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.isTraceEnabled()) log.trace(<span class="hljs-string"><span class="hljs-string">"Trying to remove expired entry from cache: "</span></span> + entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entry.onTtlExpired(obsoleteVer)) touch = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (GridCacheEntryRemovedException ignore) { entry = entry.context().cache().entryEx(entry.key()); touch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (touch) entry.context().evicts().touch(entry, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } };</code> </pre><br><p>  Lo que estamos buscando es en el m√©todo <code>GridCacheMapEntry.onTtlExpired()</code> , donde la l√≠nea atesorada est√° en el bloque <code>finally</code> . </p><br><pre> <code class="java hljs">cctx.cache().removeEntry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre> </div></div><br><h1 id="detali-realizacii">  Detalles de implementaci√≥n </h1><br><h2 id="rabota-so-stranicami-v-offheap">  Trabajar con p√°ginas en Offheap </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Offheap</a> es una t√©cnica para optimizar la gesti√≥n manual de la memoria en un idioma con un recolector de basura. </p><br><p>  Es un mito que, debido al recolector de basura, todo se ralentiza, por lo general, los recolectores cuestan un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">porcentaje miserable de rendimiento</a> .  Incluso los montones grandes en s√≠ mismos no son un problema, porque  los recopiladores trabajan de manera competitiva (por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CMS y G1</a> en Java), y los servidores tienen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">docenas de n√∫cleos</a> .  Por supuesto, el recopilador agrega pausas impredecibles a la aplicaci√≥n, lo cual es importante para los juegos, pero tolerable para la base de datos. </p><br><p>  Pero lo que realmente ser√° el problema es una violaci√≥n de la hip√≥tesis generacional en un gran mont√≥n. </p><br><div class="spoiler">  <b class="spoiler_title">Hip√≥tesis de generaci√≥n</b> <div class="spoiler_text"><p>  Las optimizaciones de GC utilizan la hip√≥tesis generacional.  Esta hip√≥tesis existe en dos versiones: fuerte y d√©bil. </p><br><p>  <strong>Hip√≥tesis generacional d√©bil: la</strong> mayor√≠a de los objetos mueren j√≥venes. </p><br><p>  <strong>Una hip√≥tesis fuerte sobre las generaciones: cuanto</strong> m√°s viejo es el objeto, m√°s tiempo vivir√°. </p><br><p>  Una hip√≥tesis fuerte implica una d√©bil, pero no al rev√©s.  Idealmente, el GC deber√≠a contentarse con cumplir la hip√≥tesis d√©bil, pero en la pr√°ctica esto no es as√≠. </p><br><p>  Eche un vistazo a la charla de Alexey Shipilev sobre el nuevo GC en Java, si desea comprender mejor el tema: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dos</a> . </p></div></div><br><p>  Y aqu√≠ es tal cosa que antes del advenimiento de PDS, Apache Ignite se posicion√≥ principalmente como un cach√© entre servicios y una base de datos de disco (por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hadoop</a> ).  Por lo tanto, los mapas en Ignite se llaman <code>IgniteCache</code> y tienen la funcionalidad de extrusi√≥n correspondiente.  Y los cach√©s simplemente violan la hip√≥tesis generacional: en ellos, la probabilidad de que un objeto se elimine aumenta con el tiempo.  Por lo tanto, en este caso, Offheap para almacenar datos de usuario mejora el rendimiento. </p><br><p>  M√°s bonificaciones: </p><br><ul><li>  Offheap facilita la implementaci√≥n de estructuras que contienen m√°s de elementos <code>Integer.MAX_VALUE</code> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Si mantiene un mont√≥n de menos de 32 GB, los enlaces pesar√°n 4 bytes</a> , lo que ahorra unos pocos gigabytes. </li><li>  Como el recopilador crea un gr√°fico de objetos, consume memoria en proporci√≥n a su n√∫mero.  Y el n√∫mero de objetos es proporcional al mont√≥n.  El recopilador tambi√©n consume una CPU, que se gasta mejor para la compresi√≥n de datos, por ejemplo. </li><li>  En montones muy grandes, incluso si la hip√≥tesis generacional no se viola en su conjunto, todav√≠a habr√° muchos objetos antiguos en valor absoluto que la violar√°n. </li></ul><br><p>  Como los datos se env√≠an al disco, los objetos se serializan en la memoria directamente a trav√©s de <code>unsafe</code> , y luego esta √°rea de memoria se utiliza para el b√∫fer de E / S. </p><br><h2 id="write-ahead-log">  Escribir registro a continuaci√≥n </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Write Ahead Log</a> es un registro de operaciones con una estructura lineal, que agrega costos constantes, a diferencia de un √°rbol.  El √°rbol se actualiza con menos frecuencia, y si los datos se pierden debido a una ca√≠da, se restauran del registro mediante la aplicaci√≥n de operaciones que comienzan desde el √∫ltimo estado guardado.  El resultado es un rendimiento mejorado sin comprometer la fiabilidad.  Le aconsejo que eche un vistazo a la interfaz <code>IgniteWriteAheadLogManager</code> : hay documentaci√≥n detallada. </p><br><h2 id="obhod-uzla">  Bypass de nodo </h2><br><p>  Como los nodos en los √°rboles B no son peque√±os, se omiten mediante la b√∫squeda binaria.  Para esto, se <code>BPlusTree.GetPageHandler</code> descendientes de la clase <code>BPlusTree.GetPageHandler</code> , y para diferentes operaciones son diferentes. </p><br><div class="spoiler">  <b class="spoiler_title">Implementaci√≥n de b√∫squeda binaria</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findInsertionPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lvl, BPlusIO&lt;L&gt; io, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> low, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cnt, L row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shift)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> row != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> high = cnt - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (low &lt;= high) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cmp = compare(lvl, io, buf, mid, row); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift; <span class="hljs-comment"><span class="hljs-comment">// We need to fix the case when search row matches multiple data rows. //noinspection Duplicates if (cmp &lt; 0) low = mid + 1; else if (cmp &gt; 0) high = mid - 1; else return mid; // Found. } return -(low + 1); // Not found. }</span></span></code> </pre> <br><p>  El m√©todo de <code>compare</code> es diferente para diferentes descendientes de <code>BPlusTree</code> .  Un √≠ndice negativo codifica la ausencia de un elemento con la posici√≥n donde podr√≠a estar.  <code>Collections.binarySearch</code> de la biblioteca est√°ndar hace lo mismo. </p><br><p>  Presta atenci√≥n a las siguientes l√≠neas. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift;</code> </pre> <br><p>  Para la operaci√≥n <code>findOne</code> , este c√≥digo no hace nada, porque  <code>shift</code> se establece en cero, es decir  si las mismas claves est√°n en el √°rbol, encontrar√°n una arbitraria de ellas. </p><br><p>  Sin embargo, si busca el rango de esta manera, los elementos se perder√°n, por lo que el <code>shift</code> se establece en <code>1</code> .  Como resultado, la b√∫squeda <em>no encuentra el elemento incluso si est√° all√≠</em> , pero no es importante buscar el rango. </p></div></div><br><h2 id="spisok-listov">  Lista de hojas </h2><br><p>  Para sortear el rango de manera eficiente, las hojas est√°n vinculadas a una lista.  <code>BPlusTree.ForwardCursor</code> , que va de hoja en hoja, se devuelve como un resultado de b√∫squeda.  Aparentemente, el paso del cursor no est√° aislado de otras operaciones en el √°rbol, porque  Al pasar, el bloqueo se toma solo en una p√°gina.  No encontr√© un mecanismo de sincronizaci√≥n que proteja el acceso a los m√©todos del cursor. </p><br><h1 id="zaklyuchenie">  Conclusi√≥n </h1><br><p>  Dado que el √°rbol B + en Apache Ignite es joven en comparaci√≥n con otras bases de datos relacionales, obtenemos el conjunto necesario para el √°rbol B + listo para producci√≥n: </p><br><ul><li>  <strong>WAL</strong> ofrece seguridad barata, como resultado, el √°rbol rara vez se actualiza en el disco. </li><li>  <strong>Offheap</strong> con datos en forma serializada. </li><li>  <strong>Concurrencia</strong> : para partes del √°rbol cargadas en la memoria. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413749/">https://habr.com/ru/post/es413749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413739/index.html">C√≥mo escaneamos todo Internet y lo que aprendimos</a></li>
<li><a href="../es413741/index.html">Qu√© era y c√≥mo: impresiones del equipo WWDC Redmadrobot</a></li>
<li><a href="../es413743/index.html">Inicie LAMP y cientos de otras aplicaciones web con unos pocos clics.</a></li>
<li><a href="../es413745/index.html">Se desarroll√≥ un sistema de alimentaci√≥n inal√°mbrico para todos los componentes electr√≥nicos del cuerpo humano a la vez.</a></li>
<li><a href="../es413747/index.html">Pasando por NULL</a></li>
<li><a href="../es413751/index.html">Ruslan Cheremin y Maxim Gramin: trabajen con el medio ambiente en jug.msk.ru</a></li>
<li><a href="../es413753/index.html">Eye in the Sky: patrulla drone con reconocimiento de violencia en multitudes y lugares p√∫blicos</a></li>
<li><a href="../es413757/index.html">Base de datos en un proyecto comercial: ¬øqu√© hacer?</a></li>
<li><a href="../es413759/index.html">Curiosity descubri√≥ org√°nicos en Marte, que tiene miles de millones de a√±os</a></li>
<li><a href="../es413761/index.html">C√≥mo evitar que Windows 10 se reinicie despu√©s de las actualizaciones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>