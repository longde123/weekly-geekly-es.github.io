<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ง๐ป ๐ช๐ฟ ๐ฉ๐ปโโ๏ธ ุงูุชุบููุฑุงุช ูู BattlEye antichita ุงูุดุนุจูุฉ ูุทุฑู ุงูุชุญุงูู ุนูููุง โฃ๏ธ ๐ โ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุงูุฑุฆูุณูุฉ ุงูุชุญุฏูุซุงุช BattlEye shellcode 
 ุจูุฑูุฑ ุงูููุช ุ ุชุชุบูุฑ ููุงูุญุฉ ุงูุบุด ุ ููุฒูุงุฏุฉ ูุนุงููุฉ ุงูููุชุฌ ุ ุชุธูุฑ ุงููุธุงุฆู ูุชุฎุชูู ูููุง. ูุจู ุนุงู ุ ุฃุนุฏุฏุช ูุตููุง ุชูุตู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุงูุชุบููุฑุงุช ูู BattlEye antichita ุงูุดุนุจูุฉ ูุทุฑู ุงูุชุญุงูู ุนูููุง</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484420/" style=";text-align:right;direction:rtl"><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/zd/c7/fe/zdc7ferp6hnuf19n_aid_mh4tca.png"></div><br><h2 style=";text-align:right;direction:rtl">  ุงูุฑุฆูุณูุฉ ุงูุชุญุฏูุซุงุช BattlEye shellcode </h2><br>  ุจูุฑูุฑ ุงูููุช ุ ุชุชุบูุฑ ููุงูุญุฉ ุงูุบุด ุ ููุฒูุงุฏุฉ ูุนุงููุฉ ุงูููุชุฌ ุ ุชุธูุฑ ุงููุธุงุฆู ูุชุฎุชูู ูููุง.  ูุจู ุนุงู ุ ุฃุนุฏุฏุช ูุตููุง ุชูุตููููุง ูุฑูุฒ BattlEye shellcode ูู <a href="https://vmcall.blog/battleye-anticheat-analysis-and-mitigation/">ูุฏููุชู</a> [ <a href="https://habr.com/ru/post/483068/">ุงูุชุฑุฌูุฉ</a> ุนูู Habrรฉ] ุ ูุณูููู ูุฐุง ุงูุฌุฒุก ูู ุงูููุงูุฉ ุงูุนูุงุณูุง ุจุณูุทูุง ููุชุบููุฑุงุช ุงูุชู ุฃุฌุฑูุช ุนูู ููุฏ ุงููุดุฑุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  ุงูุทูุงุจุน ุงูุฒูููุฉ ุนูู ุงููุงุฆูุฉ ุงูุณูุฏุงุก </h2><br>  ูู ุชุญููู ุญุฏูุซ ูู BattlEye ุ ูู ููู ููุงู ุณูู ุทูุงุจุน ุฒูููุฉ ููุชุฌููุน ูู ูุงุฆูุฉ ุญุธุฑ ุงูุธู ุ ููุจุฏู ุฃู ุงููุทูุฑูู ูุฑุฑูุง ุฅุถุงูุฉ ุงููุฒูุฏ: <br><br> <code>0x5B12C900 (action_x64.dll) <br> 0x5A180C35 (TerSafe.dll, Epic Games) <br> 0xFC9B9325 (?) <br> 0x456CED13 (d3dx9_32.dll) <br> 0x46495AD9 (d3dx9_34.dll) <br> 0x47CDEE2B (d3dx9_32.dll) <br> 0x469FF22E (d3dx9_35.dll) <br> 0x48EC3AD7 (D3DCompiler_40.dll) <br> 0x5A8E6020 (?) <br> 0x55C85371 (d3dx9_32.dll) <br> 0x456CED13 (?) <br> 0x46495AD9 (D3DCompiler_40.dll) <br> 0x47CDEE2B (D3DX9_37.dll) <br> 0x469FF22E (?) <br> 0x48EC3AD7 (?) <br> 0xFC9B9325 (?) <br> 0x5A8E6020 (?) <br> 0x55C85371 (?)</code> <br> <br>  ูู ุฃุชููู ูู ุชุญุฏูุฏ ุงูุทูุงุจุน ุงูุฒูููุฉ ุงููุชุจููุฉ ุ ูุงุซููู ูู <b>0xF *******</b> ููุง ุงูุชุฌุฒุฆุฉ ุงูุชู ุฃูุดุฃุชูุง ุงูุชุฌููุนุงุช ุงูุญุชููุฉ ูู Visual Studio.  ุจูุถูmottikraus ู T0B1 ูุชุญุฏูุฏ ุจุนุถ ุงูุทูุงุจุน ุงูุฒูููุฉ. <br><a name="habracut"></a><br><h2 style=";text-align:right;direction:rtl">  ุงูุดููุงุช ูุญุฏุฉ </h2><br>  ููุง ุฃุธูุฑ ุงูุชุญููู ุงูุฑุฆูุณู ุ ูุฅู ุงูููุฒุฉ ุงูุฑุฆูุณูุฉ ูู BattlEye ูู ุชุนุฏุงุฏ ุงููุญุฏุงุช ุ ูููุฐ ูุญุธุฉ ุงูุชุญููู ุงูุฃุฎูุฑ ุ ุชูุช ุฅุถุงูุฉ ูุญุฏุฉ ุฃุฎุฑู ุฅูู ุงููุงุฆูุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> battleye::misc::module_unknown1() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetProcAddress(current_module, <span class="hljs-string"><span class="hljs-string">"NSPStartup"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (optional_header.data_directory[<span class="hljs-number"><span class="hljs-number">4</span></span>].size == <span class="hljs-number"><span class="hljs-number">0x1B20</span></span> || optional_header.data_directory[<span class="hljs-number"><span class="hljs-number">4</span></span>].size == <span class="hljs-number"><span class="hljs-number">0xE70</span></span> || optional_header.data_directory[<span class="hljs-number"><span class="hljs-number">4</span></span>].size == <span class="hljs-number"><span class="hljs-number">0x1A38</span></span> || timestamp &gt;= <span class="hljs-number"><span class="hljs-number">0x5C600000</span></span> &amp;&amp; timestamp &lt; <span class="hljs-number"><span class="hljs-number">0x5C700000</span></span>) { report_module_unknown report = {}; report.unknown = <span class="hljs-number"><span class="hljs-number">0</span></span>; report.report_id = <span class="hljs-number"><span class="hljs-number">0x35</span></span>; report.val1 = <span class="hljs-number"><span class="hljs-number">0x5C0</span></span>; report.timestamp = timestamp; report.image_size = optional_header.size_of_image; report.entrypoint = optional_header.address_of_entry_point; report.directory_size = optional_header.data_directory[<span class="hljs-number"><span class="hljs-number">4</span></span>].size; battleye::report(&amp;report, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(report), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } }</code> </pre> <br>  ุฑุจูุง ูุฐุง ูู ุงููุดู ุนู ุจุนุถ dlls ุงููููู ุ ุญูุซ ูุชู ุงูุชุญูู ูู ุญุฌู ุฌุฏูู ุฅุนุงุฏุฉ ุงูุชูุฌูู ููุง. <br><br><h2 style=";text-align:right;direction:rtl">  ุนูุงููู ุงูููุงูุฐ </h2><br>  ูู ุงูุชุญููู ุงูุณุงุจู ุ ุชู ูุถุน ุนูุงูุฉ ุนูู ูุฎุชูู ูุฒูุฏู ุงูุบุด ุจุฃุณูุงุก ุงูููุงูุฐ ุ ูููู ููุฐ ุฐูู ุงูุญูู ุชููู ููุฏ ุงููุดุฑุฉ ุนู ุงูุชุญูู ูู ุฑุคูุณ ุงูููุงูุฐ ูุฐู.  ุชู ุงุณุชุจุฏุงู ูุงุฆูุฉ ุนูุงููู ุงูููุงูุฐ ุจุงููุงูู ุจู: <br><br> <code>Chod's <br> Satan5</code> <br> <br><h2 style=";text-align:right;direction:rtl">  ุฃุณูุงุก ุงูุตูุฑ </h2><br>  ุชุดุชูุฑ BattlEye ุจุงุณุชุฎุฏุงู ุทุฑู ุงููุดู ุงูุจุฏุงุฆูุฉ ููุบุงูุฉ ุ ูุฃุญุฏูุง ูู ูุงุฆูุฉ ุณูุฏุงุก ุจุฃุณูุงุก ุงูุตูุฑ.  ูู ูู ุนุงู ุ ุชุตุจุญ ูุงุฆูุฉ ุฃุณูุงุก ุงูุตูุฑ ุงููุญุธูุฑุฉ ุฃุทูู ุ ูุนูู ูุฏุงุฑ ุงูุฃุญุฏ ุนุดุฑ ุดูุฑูุง ุงููุงุถูุฉ ุชูุช ุฅุถุงูุฉ ุฎูุณุฉ ุฃุณูุงุก ุฌุฏูุฏุฉ: <br><br> <code>frAQBc8W.dll <br> C:\\Windows\\mscorlib.ni.dll <br> DxtoryMM_x64.dll <br> Project1.dll <br> OWClient.dll <br></code> <br>  ุชุฌุฏุฑ ุงูุฅุดุงุฑุฉ ุฅูู ุฃู ูุฌูุฏ ูุญุฏุฉ ููุทูุฉ ููุง ุงุณู ูุทุงุจู ูุฃู ุนูุตุฑ ูู ุนูุงุตุฑ ุงููุงุฆูุฉ ูู ูุนูู ุฃูู ุณูุชู ุญุธุฑู ุนูู ุงูููุฑ.  ูููู ูุญุฑู ุงูุชูุงุฑูุฑ ุฃูุถูุง ูุนูููุงุช ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ุ ูุงูุชู ูุชู ุงุณุชุฎุฏุงููุง ุนูู ุงูุฃุฑุฌุญ ูุชูููุฒ ุนูููุงุช ุงูุงุญุชูุงู ุนู ุงูุชุตุงุฏูุงุช ุนูู ุฎุงุฏู BattlEye. <br><br><h2 style=";text-align:right;direction:rtl">  7 ุฒูุจ </h2><br>  ุชู ุงุณุชุฎุฏุงู 7-Zip ุนูู ูุทุงู ูุงุณุน ููุณุชูุฑ ุงุณุชุฎุฏุงูู ูู ูุจู ุงููุดุงุฑููู ูู ูุดูุฏ ุงูุบุด ูููุก ููุฐุงูุฑุฉ ููุฑุงุบุงุช ุงูููุฏ (ุฃููุงุฏ ุงูููุฏ).  ุชุญุงูู BattlEye ุงูุชุนุงูู ูุน ูุฐุง ูู ุฎูุงู ุฅุฌุฑุงุก ูุญุต ูุฒุงูุฉ ุฑุฏูุก <b>ููุบุงูุฉ</b> ุ ูุงูุฐู ุชุบูุฑ ููุฐ ููุงูุชู ุงูุณุงุจูุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>::check_7zip() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> module_handle = GetModuleHandleA(<span class="hljs-string"><span class="hljs-string">"..\\..\\Plugins\\ZipUtility\\ThirdParty\\7zpp\\dll\\Win64\\7z.dll"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// --- REMOVED --- // if (module_handle &amp;&amp; *(int*)(module_handle + 0x1000) != 0xFF1441C7) // --- ADDED --- if (module_handle &amp;&amp; *(int*)(module_handle + 0x1008) != 0x83485348) { sevenzip_report.unknown_1 = 0; sevenzip_report.report_id = 0x46; sevenzip_report.unknown_2 = 0; sevenzip_report.data1 = *(__int64*)(module_handle + 0x1000; sevenzip_report.data2 = *(__int64*)(module_handle + 0x1008; battleye::report(&amp;sevenzip_report, sizeof(sevenzip_report), false); } }</span></span></code> </pre> <br>  ูุจุฏู ุฃู ูุทูุฑู BattlEye ุฎูููุง ุฃู ููุงูุชู ุงูุณุงุจูุฉ ุฏูุนุช ุงูุนุฏูุฏ ูู ุงููุณุชุฎุฏููู ูุชุฌุงูุฒ ูุฐุง ุงูุงุฎุชูุงุฑ ุจุจุณุงุทุฉ ุนู ุทุฑูู ูุณุฎ ุงูุจุงูุชุงุช ุงููุฑุบูุจุฉ ุฅูู ุงููููุน ุงูุฐู ุชู ุงูุชุญูู ููู ุจูุงุณุทุฉ BattlEye.  ููู ุฃุตูุญูุง ุงูููููุ  ููุฏ ุบูุฑูุง ุนูููุฉ ุงูุชุญูู ุจููุฏุงุฑ ุซูุงููุฉ ุจุงูุช ูุงุณุชูุฑูุง ูู ุงุณุชุฎุฏุงู ููุณ ุงูุทุฑููุฉ ุงูุณูุฆุฉ ููุชุญูู ูู ุงููุฒุงูุฉ.  ุงููุณู ุงููุงุจู ููุชูููุฐ ูููุฑุงุกุฉ ููุท ุ ููู ูุง ุนููู ุงูููุงู ุจู ูู ุชูุฒูู 7-Zip ูู ุงููุฑุต ูููุงุฑูุฉ ุงูุฃูุณุงู ุงูุชู ุชู ููููุง ูุน ุจุนุถูุง ุงูุจุนุถ ุ  ุฅุฐุง ูุงู ููุงู ุฃู ุชุจุงููุงุช ุ ูููุงู ุฎุทุฃ ูุง.  ุนูู ูุญูู ุงูุฌุฏ ุ ูุง ุดุจุงุจ ุ ุฃุฏุงุก ุงุฎุชุจุงุฑุงุช ุงููุฒุงูุฉ ููุณ ุจุงูุฃูุฑ ุงูุตุนุจ. <br><br><h2 style=";text-align:right;direction:rtl">  ูุญุต ุงูุดุจูุฉ </h2><br>  ูุง ูุฒุงู ุชุนุฏุงุฏ ุฌุฏูู TCP ูุนูู ุ ูููู ุจุนุฏ ุฃู ุฃุตุฏุฑุช ุชุญููููุง ุณุงุจููุง ููุชูุฏ ุงููุทูุฑูู ุจุณุจุจ ุงูุฅุจูุงุบ ุนู ุนูุงููู IP ุงูุฎุงุตุฉ ุจู Cloudflare ุ ูุง ุฒุงููุง ูุฒูููู ูุฐุง ุงูุงุฎุชุจุงุฑ.  ูุง ูุฒุงู ูุธุงู ููุงูุญุฉ ุงูุบุด ูุจูุบ ุนู ุงููููุฐ ุงูุฐู ูุณุชุฎุฏูู xera.ph ููุงุชุตุงู ุ ููู ุงููุทูุฑูู ุฃุถุงููุง ูุญุตูุง ุฌุฏูุฏูุง ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงูุช ุงูุนูููุฉ ูุน ุงูุงุชุตุงู ููุง ุญูุงูุฉ ูุดุทุฉ (ูู ุงูููุชุฑุถ ุฃู ูุชู ุฐูู ุจุงุณุชุฎุฏุงู ุงููุนุงูุฌ). <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> network::scan_tcp_table { <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(local_port_buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(local_port_buffer); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (iteration_index = <span class="hljs-number"><span class="hljs-number">0</span></span>; iteration_index; &lt; <span class="hljs-number"><span class="hljs-number">500</span></span> ++iteration_index) { <span class="hljs-comment"><span class="hljs-comment">// GET NECESSARY SIZE OF TCP TABLE auto table_size = 0; GetExtendedTcpTable(0, &amp;table_size, false, AF_INET, TCP_TABLE_OWNER_MODULE_ALL, 0); // ALLOCATE BUFFER OF PROPER SIZE FOR TCP TABLE auto allocated_ip_table = (MIB_TCPTABLE_OWNER_MODULE*)malloc(table_size); if (GetExtendedTcpTable(allocated_ip_table, &amp;table_size, false, AF_INET, TCP_TABLE_OWNER_MODULE_ALL, 0) != NO_ERROR) goto cleanup; for (entry_index = 0; entry_index &lt; allocated_ip_table-&gt;dwNumEntries; ++entry_index) { // --- REMOVED --- // const auto ip_address_match_1 = // allocated_ip_table-&gt;table[entry_index].dwRemoteAddr == 0x656B1468; // 104.20.107.101 // // const auto ip_address_match_2 = // allocated_ip_table-&gt;table[entry_index].dwRemoteAddr == 0x656C1468; // 104.20.108.101 // +++ ADDED +++ const auto target_process = OpenProcess(QueryLimitedInformation, 0, ip_table-&gt;table[entry_index].dwOwningPid); const auto protected = target_process == INVALID_HANDLE &amp;&amp; GetLastError() == 0x57; if (!protected) { CloseHandle(target_process); return; } const auto port_match = allocated_ip_table-&gt;table[entry_index].dwRemotePort == 20480; for (port_index = 0; port_index &lt; 10 &amp;&amp; allocated_ip_table-&gt;table[entry_index].dwLocalPort != local_port_buffer[port_index]; ++port_index) { if (local_port_buffer[port_index]) continue tcp_table_report.unknown = 0; tcp_table_report.report_id = 0x48; tcp_table_report.module_id = 0x5B9; tcp_table_report.data = BYTE1(allocated_ip_table-&gt;table[entry_index].dwLocalPort) | (LOBYTE(allocated_ip_table-&gt;table[entry_index.dwLocalPort) &lt;&lt; 8; battleye::report(&amp;tcp_table_report, sizeof(tcp_table_report), false); local_port_buffer[port_index] = allocated_ip_table-&gt;table[entry_index].dwLocalPort; break } } cleanup: // FREE TABLE AND SLEEP free(allocated_ip_table); Sleep(10 } }</span></span></code> </pre> <br>  ุดูุฑุง IChooseYou ููุฌุฑุฏุฉ <br><br><h2 style=";text-align:right;direction:rtl">  BattlEye ูููุฉ ุงูุงูุชูุงููุฉ </h2><br>  ุฃูุนุงุจ ุงููุฑุตูุฉ ูู ูุนุจุฉ ูุทุฉ ููุฃุฑ ูุณุชูุฑุฉ ุ ูุฐูู ุชูุชุดุฑ ุดุงุฆุนุงุช ุนู ุญูู ุฌุฏูุฏุฉ ูุซู ุงููุงุฑ.  ูู ูุฐุง ุงูุฌุฒุก ุ ุณูู ูููู ูุธุฑุฉ ุนูู ุงูุชูููุงุช ุงูุงุณุชูุดุงููุฉ ุงูุฌุฏูุฏุฉ ุงูุชู ุชูุช ุฅุถุงูุชูุง ูุคุฎุฑูุง ุฅูู ุชุฑุณุงูุชูุง ูู ููุจู ูููุฑ ูุจูุฑ ูู ููุงูุญุฉ ุงูุบุด BattlEye.  ูู ูุนุธู ุงูุฃุญูุงู ุ ูุชุณูู ูุฐู ุงูุชูููุงุช ุงููุดู ุงูููุฏุณ.  ุนุงุฏุฉู ูุง ูุชู ุชูููุฐูุง ูู ุฎูุงู ูุนุงูุฌุฉ ุฏุงูุฉ ูุงูุงูุชูุงู ูู ุฎูุงู ุงูููุฏุณ ููุนุฑูุฉ ูู ุงูุฐู ูุทูู ุนูู ูุฐู ุงููุธููุฉ ุชุญุฏูุฏูุง.  ููุงุฐุง ุชุญุชุงุฌ ุฅูู ุงูููุงู ุจุฐููุ  ูุซู ุฃู ุจุฑูุงูุฌ ุขุฎุฑ ุ ูุฏู ุงููุชุณูููู ูุฃูุนุงุจ ุงูููุฏูู ูุฌููุนุฉ ูู ุงููุธุงุฆู ุงููุนุฑููุฉ ุงูุชู ูุณุชุฎุฏููููุง ููุญุตูู ุนูู ูุนูููุงุช ูู ููุญุฉ ุงูููุงุชูุญ ุฃู ุงูุฅุฎุฑุงุฌ ุฅูู ูุญุฏุฉ ุงูุชุญูู ุฃู ุญุณุงุจ ุชุนุจูุฑุงุช ุฑูุงุถูุฉ ูุนููุฉ.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุญุจ ุงููุชุณูููู ุฅูู ุฃูุนุงุจ ุงูููุฏูู ุฅุฎูุงุก ูุฌูุฏูู ุ ุณูุงุก ูู ุงูุฐุงูุฑุฉ ุฃู ุนูู ุงููุฑุต ุ ุญุชู ูุง ูุนุซุฑ ุนูููู ุจุฑูุงูุฌ ููุงูุญุฉ ุงูุบุด.  ูููู ูุง ุชูุณุงู ุจุฑุงูุฌ ุงูุบุด ูู ุฃููุง ุชุณุชุฏุนู ุงููุธุงุฆู ุจุงูุชุธุงู ูู ููุชุจุงุช ุฃุฎุฑู ุ ููููู ุงุณุชุฎุฏุงู ูุฐุง ูุงูุชุดุงู ุงูุบุด ูุฌูููุฉ.  ูู ุฎูุงู ุชุทุจูู ูุญุฑู traversal ุงูููุฏุณ ููุธุงุฆู ูุซู <code>std::print</code> ุ ูููููุง ุงูุนุซูุฑ ุนูู ูุฐู ุงูุฎุฏุงุน ุญุชู ูู ูุงูุช ููุซููู. <br><br>  <strong>ููุฐุช</strong> BattlEye "ุชุฌุงูุฒ ูููุฉ" ุ ุนูู ุงูุฑุบู ูู ุญูููุฉ ุฃูู ูู ูุชู ุงูุฅุนูุงู ุนู ุฐูู ุจุดูู ุนููู ููู ููุช ูุดุฑ ุงูููุงู ูู ุชูู ููุงู ุณูู ุดุงุฆุนุงุช.  ุงูุชุจู ุฅูู ุนูุงูุงุช ุงูุงูุชุจุงุณ - ูุง ุณุชุฑุงู ููุง ููุณ ุญููุง ุฌููุฉ ููุฏุณ ุญููููุฉ ุ ูููู ูุฌุฑุฏ ูุฒูุฌ ูู ุงูุชุญูู ูู ุนููุงู ุงููุฑุณู ูุชูุฑูุบ ุจุฑูุงูุฌ ุงูุงุชุตุงู.  ูุฏ ููุฑ ุชุทุจูู traversal ููุฏุณ ุญูููู ุฎูุงู ููุฏุณ ูุฅูุดุงุก ููุฏุณ ุงุณุชุฏุนุงุก ุญูููู. <br><br>  ููุง ุฃูุถุญุช ูู ููุงู ุณุงุจู ุญูู BattlEye ุ ูุฅู ูุธุงู ููุงูุญุฉ ุงูุบุด ูุนูู ุจุดูู ุญููู ุนูู ุชุฏููู ููุฏ ุงููุดุฑุฉ ุฅูู ุงููุนุจุฉ ุนูุฏ ุชุดุบูููุง.  ูุฐู ุงูุฑููุฒ ูุฐููุฉ ููุง ุฃุญุฌุงู ูููุงู ูุฎุชููุฉ ุ ููุง ุชูุชูู ูู ููุช ูุงุญุฏ.  ูู ุงูุฎุตุงุฆุต ุงููููุฒุฉ ููุฐุง ุงููุธุงู ุฃู ุงูุจุงุญุซูู ุจุญุงุฌุฉ ุฅูู ุชุญููู ุญููู ูููุงูุญุฉ ุงูุบุด ุฃุซูุงุก ุงููุจุงุฑุงุฉ ูุชุนุฏุฏุฉ ุงููุงุนุจูู ุ ููุง ูุนูุฏ ุชุญุฏูุฏ ุฎุตุงุฆุต ูุฐุง ุงูุบุด ุงููุถุงุฏ.  ููุง ูุณูุญ ูููุงูุญุฉ ุงูุบุด ุจุชุทุจูู ุชุฏุงุจูุฑ ูุฎุชููุฉ ุนูู ูุณุชุฎุฏููู ูุฎุชูููู ุ ุนูู ุณุจูู ุงููุซุงู ุ ูููู ูุญุฏุฉ ููุทูุฉ ุฃูุซุฑ ุนูููุง ููุท ุฅูู ุดุฎุต ูุฏูู ูุณุจุฉ ุนุงููุฉ ุจุดูู ุบูุฑ ุนุงุฏู ูู ุฌุฑุงุฆู ุงููุชู ูุงููููุงุช ุ ููุง ุดุงุจู ุฐูู. <br><br>  ุฃุญุฏ ุฑููุฒ shell ูุฐู ุ BattlEye ุ ูุณุคูู ุนู ุฅุฌุฑุงุก ุชุญููู ุงูููุฏุณ ูุฐุง ุ  ุณูู ูุณูููุง <em>shellcode8kb</em> ูุฃููุง ุฃุตุบุฑ ููููุงู ููุงุฑูุฉ ุจู <em>shellcodemain</em> ุ ุงูุฐู <em>ูุซูุชู</em> <a href="https://vmcall.blog/battleye-anticheat-analysis-and-mitigation/">ููุง</a> .  ูุฐุง ุฑูุฒ shell ุตุบูุฑ ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ <strong>AddVectoredExceptionHandler</strong> ุจุฅุนุฏุงุฏ ูุนุงูุฌ ุงุณุชุซูุงุก vectorized ููู ุซู ุชุนููู ุงุนุชุฑุงุถ ุงูููุงุทุนุฉ ุนูู ุงููุธุงุฆู ุงูุชุงููุฉ: <br><br> <code>GetAsyncKeyState <br> GetCursorPos <br> IsBadReadPtr <br> NtUserGetAsyncKeyState <br> GetForegroundWindow <br> CallWindowProcW <br> NtUserPeekMessage <br> NtSetEvent <br> sqrtf <br> __stdio_common_vsprintf_s <br> CDXGIFactory::TakeLock <br> TppTimerpExecuteCallback</code> <br> <br>  ููููุงู ุจุฐูู ุ ูุฅูู ูุชูุฑุฑ ุจุจุณุงุทุฉ ุญูู ูุงุฆูุฉ ุงููุธุงุฆู ุงููุณุชุฎุฏูุฉ ุจุดูู ููุงุณู ุ ูุน ุชุนููู ุงูุชุนูููุฉ ุงูุฃููู ูู ุงููุธููุฉ ุงูููุงุจูุฉ ุฅูู <strong>int3</strong> ุ ูุงูุชู ูุชู ุงุณุชุฎุฏุงููุง ูููุทุฉ ุชููู.  ุจุนุฏ ุชุนููู ููุทุฉ ุชููู ุ ุชูุฑ ุฌููุน ุงูููุงููุงุช ุฅูู ุงููุธููุฉ ุงูููุงุจูุฉ ูู ุฎูุงู ูุนุงูุฌ ุงูุงุณุชุซูุงุก ุ ูุงูุฐู ูุฏูู ุญู ุงููุตูู ุงููุงูู ุฅูู ุงูุณุฌูุงุช ูุงูููุฏุณ.  ุจุนุฏ ูุฐุง ุงููุตูู ุ ูููู ุงููุนุงูุฌ ุงูุงุณุชุซูุงุฆู ุจุชูุฑูุบ ุนููุงู ุจุฑูุงูุฌ ุงูุงุณุชุฏุนุงุก ูู ุฃุนูู ุงูููุฏุณ ุ ูุฅุฐุง ุชู ุงุณุชููุงุก ุฃุญุฏ ุงูุดุฑูุท ุงูุงุณุชุฏูุงููุฉ ุ ูุชู ุชูุฑูุบ 32 ุจุงูุช ูู ูุธููุฉ ุงูุงุณุชุฏุนุงุก ูุฅุฑุณุงููุง ุฅูู ุฎุงุฏู BattlEye ุจูุนุฑู ุงูุชูุฑูุฑ <strong>0x31</strong> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">__int64 battleye::exception_handler(_EXCEPTION_POINTERS *exception) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exception-&gt;ExceptionRecord-&gt;ExceptionCode != STATUS_BREAKPOINT) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> caller_function = *(__int64 **)exception-&gt;ContextRecord-&gt;Rsp; MEMORY_BASIC_INFORMATION caller_memory_information = {}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> desired_size = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// QUERY THE MEMORY PAGE OF THE CALLER const auto call_failed = NtQueryVirtualMemory( GetCurrentProcess(), caller_function, MemoryBasicInformation, &amp;caller_memory_information, sizeof(caller_memory_information), &amp;desired_size) &lt; 0; // IS THE MEMORY SOMEHOW NOT COMMITTED? (WOULD SUGGEST VAD MANIPULATIUON) const auto non_commit = caller_memory_information.State != MEM_COMMIT; // IS THE PAGE EXECUTABLE BUT DOES NOT BELONG TO A PROPERLY LOADED MODULE? const auto foreign_image = caller_memory_information.Type != MEM_IMAGE &amp;&amp; caller_memory_information.RegionSize &gt; 0x2000; // IS THE CALL BEING SPOOFED BY NAMAZSO? const auto spoof = *(_WORD *)caller_function == 0x23FF; // jmp qword ptr [rbx] // FLAG ALL ANBORMALITIES if (call_failed || non_commit || foreign_image || spoof) { report_stack.unknown = 0; report_stack.report_id = 0x31; report_stack.hook_id = hook_id; report_stack.caller = (__int64)caller_function; report_stack.function_dump[0] = *caller_function; report_stack.function_dump[1] = caller_function[1]; report_stack.function_dump[2] = caller_function[2]; report_stack.function_dump[3] = caller_function[3]; if (!call_failed) { report_stack.allocation_base = caller_memory_information.AllocationBase; report_stack.base_address = caller_memory_information.BaseAddress; report_stack.region_size = caller_memory_information.RegionSize; report_stack.type_protect_state = caller_memory_information.Type | caller_memory_information.Protect | caller_memory_information.State; } battleye::report(&amp;report_stack, sizeof(report_stack), false); return -1; } }</span></span></code> </pre> <br>  ููุง ูุฑู ุ ูููู ุงููุนุงูุฌ ุงูุงุณุชุซูุงุฆู ุจุชูุฑูุบ ุฌููุน ูุธุงุฆู ุงูุงุณุชุฏุนุงุก ูู ุญุงูุฉ ุญุฏูุซ ุชุบููุฑ ุบูุฑ ููุชุธู ูู ุตูุญุฉ ุงูุฐุงูุฑุฉ ุฃู ุนูุฏูุง ูุง ุชูุชูู ุงููุธููุฉ ุฅูู ูุญุฏุฉ ููุทูุฉ ุนูููุฉ ูุนุฑููุฉ (ูู ูุชู ุชุนููู ููุน ุตูุญุฉ ุงูุฐุงูุฑุฉ MEM_IMAGE ุจูุงุณุทุฉ ูุตููู ุงูุฎุฑุงุฆุท ุงููุฏููุฉ).  ููุง ูููู ุจุชูุฑูุบ ูุธุงุฆู ุงูุงุชุตุงู ุนูุฏูุง ููุดู ูู ุงุณุชุฏุนุงุก <strong>NtQueryVirtualMemory</strong> ุจุญูุซ ูุง ูุฑุชุจุท ุงูุบุด ุจููุงููุฉ ุงููุธุงู ูุฐู ููุฎูู ุงููุญุฏุฉ ุงูููุทูุฉ ุงูุฎุงุตุฉ ุจูู ูู ุชูุฑูุบ ุงูููุฏุณ.  ุงูุดุฑุท ุงูุฃุฎูุฑ ูุซูุฑ ููุงูุชูุงู ููุบุงูุฉ ุ ููู ููุซู ุฌููุน ูุธุงุฆู ุงูุงุชุตุงู ุงูุชู ุชุณุชุฎุฏู ุฃุฏุงุฉ <strong>jmp qword ptr [rbx]</strong> - ุงูุทุฑููุฉ ุงููุณุชุฎุฏูุฉ ูู "ูุญุงูุงุฉ ุณุงุฎุฑุฉ ูุนููุงู ุงููุฑุณู".  ุชู <a href="https://www.unknowncheats.me/forum/anti-cheat-bypass/268039-x64-return-address-spoofing-source-explanation.html">ุฅุตุฏุงุฑู ูู ููุจู</a> ุนุถู ุงูุณูุฑุชูุฑ ุงููุดุงุฑู ุงูุฎุงุต ุจู namazso.  ูุจุฏู ุฃู ูุทูุฑู BattlEye ุฑุฃูุง ุฃู ุงููุงุณ ูุณุชุฎุฏููู ุทุฑููุฉ ุงูุฎุฏุงุน ูุฐู ูู ุฃูุนุงุจูู ููุฑุฑูุง ุชูุฌูููุง ูุจุงุดุฑุฉ.  ุชุฌุฏุฑ ุงูุฅุดุงุฑุฉ ููุง ุฅูู ุฃู ุงูุทุฑููุฉ ุงูุชู ูุตููุง namazsos ุชุนูู ุจุดูู ุฌูุฏ ุ ูุง ุนููู ุณูู ุงุณุชุฎุฏุงู ุฃุฏุงุฉ ูุฎุชููุฉ ุฃู ูุฎุชููุฉ ุชูุงููุง ุฃู ูุฌุฑุฏ ุณุฌู ูุฎุชูู - ูุง ููู. <br><br>  ุชูููุญ ูุทูุฑ BattlEye: ุฅู <code>CDXGIFactory::TakeLock</code> ูู ุฐุงูุฑุชู ุบูุฑ ุตุญูุญ ูุฃูู ููุช (ุจุทุฑูู ุงูุฎุทุฃ ุฃู ุนู ูุตุฏ) ุจุชูููู ุญุดูุฉ CC ุ ูุงูุชู ุชููู ูุฎุชููุฉ ุชูุงููุง ูู ูู ูุฑุฉ ุชููู ูููุง ุจุงูุชุฌููุน.  ูุชุญููู ุฃูุตู ูุฏุฑ ูู ุงูุชูุงูู ุ ุชุญุชุงุฌ ุฅูู ุฅุฒุงูุฉ ุงูุญุดู (ุงูุจุงูุช ุงูุฃูู ูู ุงูุชูููุน) ุ ูุจุงูุชุงูู ุณุชุญุตู ุนูู ุงูุฃุฑุฌุญ ุนูู ุงููุฒูุฏ ูู ุงูุบุดุงุดูู :) <br><br>  ุชุจุฏู ุงูุจููุฉ ุงููุงููุฉ ุงููุฑุณูุฉ ุฅูู ุฎุงุฏู BattlEye ููุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unaligned</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">battleye_stack_report</span></span></span><span class="hljs-class"> {</span></span> __int8 unknown; __int8 report_id; __int8 val0; __int64 caller; __int64 function_dump[<span class="hljs-number"><span class="hljs-number">4</span></span>]; __int64 allocation_base; __int64 base_address; __int32 region_size; __int32 type_protect_state; };</code> </pre> <br><h2 style=";text-align:right;direction:rtl">  ุงูุชุนุฑู ุนูู ุจุฑูุงูุฌ Hypervisor ูู BattlEye </h2><br>  ูุง ุชุฒุงู ูุนุจุฉ ุงููุท ูุงููุฃุฑ ูู ูุฌุงู ุงุฎุชุฑุงู ุงูุฃูุนุงุจ ูุตุฏุฑูุง ููุงุจุชูุงุฑ ูู ุนูููุงุช ุงูุงุณุชุบูุงู ูููุงูุญุฉ ุงูุบุด.  ุจุฏุฃ ุงุณุชุฎุฏุงู ุชูููุฉ ุงููุญุงูุงุฉ ุงูุงูุชุฑุงุถูุฉ ูู ุฃูุนุงุจ ุงููุฑุตูุฉ ูู ุงูุชุทูุฑ ุจูุดุงุท ุจุนุฏ ุธููุฑ ุจุฑุงูุฌ Hypervisor ุณููุฉ ุงูุงุณุชุฎุฏุงู ูุซู <a href="https://github.com/tandasat/DdiMon">DdiMon</a> Satoshi Tanda ู <a href="https://github.com/wbenny/hvpp">hvpp</a> Peter Benes.  ูุชู ุงุณุชุฎุฏุงู ูุฐูู ุงููุดุฑูุนูู ูู ูุจู ูุนุธู ุงูุบุด ุงููุฏููุน ููุดูุฏ ุงููุฑุงุตูุฉ ุชุญุช ุงูุฃุฑุถ ุจุณุจุจ ุนุชุจุฉ ุงูุฏุฎูู ุงูููุฎูุถุฉ ูุงููุซุงุฆู ุงูุชูุตูููุฉ.  ูู ุงููุญุชูู ุฃู ุชุคุฏู ูุฐู ุงูุฅุตุฏุงุฑุงุช ุฅูู ุชุณุฑูุน ุณุจุงู ุงูุชุณูุญ ูู ูุฌุงู ุจุฑุงูุฌ Hypervisor ุ ุงูุชู ุจุฏุฃุช ุงูุขู ุชุธูุฑ ูู ูุฌุชูุน ุงููุชุณูููู.  ุฅููู ูุง ููููู ุงููุณุคูู ุนู ูุงุญุฏุฉ ูู ุฃูุจุฑ ูุฌุชูุนุงุช ุงุฎุชุฑุงู ุงูุฃูุนุงุจ ุจุงุณุชุฎุฏุงู <a href="https://www.unknowncheats.me/">WLN</a> ููุงุณู ุงููุณุชุนุงุฑ ุญูู ูุฐุง ุงููููู: <br><br><blockquote style=";text-align:right;direction:rtl">  ูุน ุธููุฑ ุฃูุธูุฉ Hypervisor ุงูุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู ูู ุงุฎุชุฑุงู ุงูุฃูุนุงุจ ุ ุฃุตุจุญ ูู ุงููุญุชู ุฃู ุชุฑูุฒ ุจุฑุงูุฌ ููุงูุญุฉ ุงูุฎุฏุงุน ูุซู BattlEye ุนูู ุงูุชุนุฑู ุงูุนุงู ุนูู ุงููุญุงูุงุฉ ุงูุงูุชุฑุงุถูุฉ. </blockquote><br>  ูุฑุฌุน ุงูุงุณุชุฎุฏุงู ุงููุงุณุน ุงููุทุงู ูุจุฑุงูุฌ Hypervisor ุฅูู ุงูุชุญุณููุงุช ุงูุญุฏูุซุฉ ูู ููุงูุญุฉ ุงูุบุด ุ ูุงูุชู ุชุฑูุช ูููุชุณูููู ูุฑุตูุง ููููุฉ ุฌุฏูุง ูุชุนุฏูู ุงูุฃูุนุงุจ ุจุทุฑู ุชูููุฏูุฉ.  ูููู ุชูุณูุฑ ุดุนุจูุฉ ุจุฑุงูุฌ Hypervisor ุจุจุณุงุทุฉ ุชุฌูุจ ููุงูุญุฉ ุงูุบุด ุ ูุฃู ุงูุธุงูุฑูุฉ ุชุนูู ุนูู ุชุจุณูุท ุฅุฎูุงุก ุงููุนูููุงุช ุจุงุณุชุฎุฏุงู ุขููุงุช ูุซู <a href="https://revers.engineering/syscall-hooking-via-extended-feature-enable-register-efer/">ุฑุจุทุงุช syscall</a> ู <a href="https://www.anandtech.com/show/2480/10">MMU ุงูุงูุชุฑุงุถูุฉ</a> . <br><br>  ูู ุงูุขููุฉ ุงูุฃุฎูุฑุฉ ุ ููุฐุช BattlEye ุงูุชุนุฑู ุนูู ุจุฑุงูุฌ Hypervisor ุงูุดุงุฆุนุฉ ูุซู ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ ุงููุฐููุฑุฉ ุฃุนูุงู (DdiMonุ hvpp) ุจุงุณุชุฎุฏุงู ุงูุงูุชุดุงู ุงููุณุชูุฏ ุฅูู ุงูููุช.  ูุญุงูู ูุฐุง ุงูุงุนุชุฑุงู ุงูุชุดุงู ููู ููุช ุชุนูููุงุช CPUID ุบูุฑ ุงูููุงุณูุฉ.  CPUID ูู ุชุนูููุฉ ููุฎูุถุฉ ุงูุชูููุฉ ูุณุจููุง ุนูู ูุนุฏุงุช ุญููููุฉ ุ ูุนุงุฏุฉ ูุง ุชุชุทูุจ ูุงุฆุชู ุฏูุฑุฉ ููุท ุ ููู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ ุ ูููู ุฃู ูุณุชุบุฑู ุชูููุฐู ุนุดุฑ ูุฑุงุช ุฃุทูู ุจุณุจุจ ุงูุนูููุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ ุงูุชู ูุณุจุจูุง ูุญุฑู ุงูุงุณุชุจุทุงู.  ูุญุฑู ุงูุงุณุชุจุทุงู ูุง ูุดุจู ุงููุนุฏุงุช ุงูุญููููุฉ ุ ุงูุชู ุชููู ุจุจุณุงุทุฉ ุจุชูููุฐ ุงูุนูููุฉ ุจุงูุทุฑููุฉ ุงููุชููุนุฉ ุ ูุฃูู ุนูู ุฃุณุงุณ ูุนูุงุฑ ุชุนุณูู ูุชุชุจุน ููุบูุฑ ุงูุจูุงูุงุช ุงูุชู ูุชู ุฅุฑุฌุงุนูุง ุฅูู ุงูุถูู ุจุดูู ูุดุฑูุท. <br><br>  <strong>ุญูููุฉ ููุชุนุฉ:</strong> ูุชู ุงุณุชุฎุฏุงู CPUID ุจูุดุงุท ูู ุฅุฌุฑุงุกุงุช ุงูุชุนุฑู ุงููุคูุชุฉ ูุฐู ูุฃููุง ุชุนูููุฉ ุฐุงุช ูุงุชุฌ ุบูุฑ ูุดุฑูุท ุ ุจุงูุฅุถุงูุฉ ุฅูู ุชุนูููุฉ ุบูุฑ ูุชุณูุณูุฉ.  ูุฐุง ูุนูู ุฃู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPUID) ุชุณุชุฎุฏู <a href="https://en.wikipedia.org/wiki/Memory_barrier">ูุญุงุฌุฒ</a> ูุชุถูู ุงุชุจุงุน ุงูุชุนูููุงุช ูุจู ูุจุนุฏ ุฐูู ุ  ูู ุงูููุช ููุณู ุ ุชุตุจุญ ุชูููุชุงุช ูุณุชููุฉ ุนู ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงูุชุนูููุงุช ุงููุนุชุงุฏุฉ.  ููููู ุฃูุถูุง ุงุณุชุฎุฏุงู ุฅุฑุดุงุฏุงุช ูุซู <a href="https://www.felixcloutier.com/x86/xsetbv">XSETBV</a> ุ ูุงูุชู ุชุคุฏู ุฃูุถูุง ุฅูู ุฎุฑูุฌ ุบูุฑ ูุดุฑูุท ุ ูููู ูุถูุงู ุชูููุช ูุณุชูู ุ ุณูุชุทูุจ ุฐูู ููุนูุง ูู ุชุนูููุงุช ุงูุญุงุฌุฒ ุจุญูุซ ูุง ูุญุฏุซ ุฃู ุฅุนุงุฏุฉ ุชุฑุชูุจ ูุจูู ุฃู ุจุนุฏู ุ ููุง ูุคุซุฑ ุนูู ููุซูููุฉ ุงูุชูููุช. <br><br><h4 style=";text-align:right;direction:rtl">  ุงุนุชุฑุงู </h4><br>  ูููุง ููู ุฅุฌุฑุงุก ุงูุงุนุชุฑุงู ูู ูุญุฏุฉ BattlEye "BEClient2" ุ  ููุฏ ุฃุฌุฑูุช ุงูููุฏุณุฉ ุงูุนูุณูุฉ ูุฃุนุฏุช ุฅูุดุงุก ุงูุดูุฑุฉ ูู pseudo-C ุ ุซู ูุดุฑุชูุง ุนูู <a href="https://twitter.com/vm_call">twitter</a> .  ูู ุงูููู ุงูุชุงูู ูุชุบุฑูุฏุชู ุ ุบูุฑ ูุทูุฑู BattlEye ุจุดูู ุบูุฑ ูุชููุน ุชุดููุด BEClient2 ุ ุนูู ุฃูู ุฃู ูููุนูู ูุฐุง ูู ุชุญููู ุงููุญุฏุฉ.  ูู ูุชุบูุฑ ุงูุชุนุชูู ุงูุณุงุจู ูุฃูุซุฑ ูู ุนุงู ุ ูููู ุชุบูุฑ ูู ุงูููู ุงูุชุงูู ูุชุบุฑูุฏุชู ุญููู - ุณุฑุนุฉ ูุซูุฑุฉ ููุฅุนุฌุงุจ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> battleye::take_time() { <span class="hljs-comment"><span class="hljs-comment">// SET THREAD PRIORITY TO THE HIGHEST const auto old_priority = SetThreadPriority(GetCurrentThread(), THREAD_PRIORITY_TIME_CRITICAL); // CALCULATE CYCLES FOR 1000MS const auto timestamp_calibrator = __rdtsc(); Sleep(1000); const auto timestamp_calibration = __rdtsc() - timestamp_calibrator; // TIME CPUID auto total_time = 0; for (std::size_t count = 0; count &lt; 0x6694; count++) { // SAVE PRE CPUID TIME const auto timestamp_pre = __rdtsc(); std::uint32_t cpuid_data[4] = {}; __cpuid(cpuid_data, 0); // SAVE THE DELTA total_time += __rdtsc() - timestamp_pre; } // SAVE THE RESULT IN THE GLOBAL REPORT TABLE battleye::report_table[0x1A8] = 10000000 * total_time / timestamp_calibration / 0x65; // RESTORE THREAD PRIORITY SetThreadPriority(GetCurrentThread(), old_priority); }</span></span></code> </pre> <br>  ููุง ููุช ุฃุนูุงู ุ ูุฐู ูู ุชูููุฉ ุงูุชุนุฑู ุงูุฃูุซุฑ ุดููุนูุง ุจุงุณุชุฎุฏุงู ุชุนูููุงุช ุชู ุงุนุชุฑุงุถูุง ุฏูู ููุฏ ุฃู ุดุฑุท.  ููุน ุฐูู ุ ููู ุนุฑุถุฉ ูููุช ูุฒูู ุ ูุณูุชุญุฏุซ ุนู ุฐูู ุจุงูุชูุตูู ูู ุงููุณู ุงูุชุงูู. <br><br><h4 style=";text-align:right;direction:rtl">  ุชุฌุงูุฒ ุงูุงุนุชุฑุงู </h4><br>  ูุฐู ุงูุทุฑููุฉ ุงูุงุนุชุฑุงู ูุฏูู ูุดุงูู.  ุฃููุงู ุ ูู ุงููุญุชูู ุญุฏูุซ ููุช ูุฒูู ุ ููุชู ุฐูู ุนุงุฏุฉ ุจุทุฑููุชูู: ุนู ุทุฑูู ุชุญููู TSC ูู VMCS ุฃู ุชูููู TSC ูู ูู ูุฑุฉ ูุชู ูููุง ุชูููุฐ CPUID.  ููุงู ุงูุนุฏูุฏ ูู ุงูุทุฑู ุงูุฃุฎุฑู ููุชุนุงูู ูุน ุงููุฌูุงุช ุงููุฑุชูุฒุฉ ุนูู ุงูููุช ุ ูููู ูุฐุง ุงูุฃุฎูุฑ ุฃุณูู ูู ุงูุชูููุฐ ุ ูุฃูู ููููู ุถูุงู ุฃู ูููู ููุช ุชูููุฐ ุงูุชุนูููุงุช ุฎูุงู ุฏูุฑุฉ ูุงุญุฏุฉ ุฃู ุณุงุนุชูู ูู ุชุฒุงูู ุงูุชูููุฐ ุนูู ูุนุฏุงุช ุญููููุฉ.  ุชุนุชูุฏ ุตุนูุจุฉ ุงูุชุดุงู ุชูููุฉ ุงูุชุฒููู ูุฐู ุงููุฑุฉ ุนูู ุฎุจุฑุฉ ุงููุทูุฑ.  ูู ุงููุณู ุงูุชุงูู ุ ุณููุธุฑ ูู ุชุฒููู ุงูููุช ูุชุญุณูู ุงูุชูููุฐ ุงูุฐู ุชู ุฅูุดุงุคู ูู BattlEye.  ุงูุณุจุจ ุงูุซุงูู ููุฐุง ุงูุฎูู ูู ุทุฑููุฉ ุงูุชุนุฑู ูู ุฃู ุชุฃุฎูุฑ CPUID (ููุช ุงูุชุดุบูู) ูู ูุนุงูุฌุงุช ูุฎุชููุฉ ูุฎุชูู ุงุฎุชูุงููุง ูุจูุฑูุง ุงุนุชูุงุฏูุง ุนูู ูููุฉ ุงููุฑูุฉ.  ูุฏ ูุณุชุบุฑู ุงูุฃูุฑ ูุง ูุตู ุฅูู 70-300 ุฏูุฑุฉ ุนูู ูุฏุงุฑ ุงูุณุงุนุฉ ูุฅููุงูู.  ุงููุดููุฉ ุงูุซุงูุซุฉ ูู ุฅุฌุฑุงุก ุงูุชุนุฑู ูุฐุง ูู ุงุณุชุฎุฏุงู SetThreadPriority.  ุชูุณุชุฎุฏู ูุธููุฉ Windows ูุฐู ูุชุนููู ูููุฉ ุฃููููุฉ ูุงุตู ุงูุฏูู ุงููุญุฏุฏ ุ ููู ูุธุงู ุงูุชุดุบูู ูุง ูุณุชูุน ุฏุงุฆููุง ุฅูู ุงูุทูุจ.  ูุฐู ุงููุธููุฉ ูู ุจุจุณุงุทุฉ ุงูุชุฑุงุญ ูุฒูุงุฏุฉ ุฃููููุฉ ุงูุฎูุท ุ ูููุณ ููุงู ูุง ูุถูู ุญุฏูุซ ุฐูู.  ูุจุงูุชุงูู ุ ูู ุงููููู ุฃู ุชุชุฃุซุฑ ูุฐู ุงูุทุฑููุฉ ุจุงูุงููุทุงุนุงุช ุฃู ุงูุนูููุงุช ุงูุฃุฎุฑู. <br><br>  ูู ูุฐู ุงูุญุงูุฉ ุ ูู ุงูุณูู ุชุฌุงูุฒ ุงูุชุนุฑู ุ ูุงูุชูููุฉ ุงูููุถุญุฉ ูููุช ุงูุชุฒููู ุชุคุฏู ุฅูู ูุฒููุฉ ุทุฑููุฉ ุงูุชุนุฑู ูุฐู ุจุดูู ูุนุงู.  ุฅุฐุง ุฃุฑุงุฏ ูุทูุฑู BattlEye ุชุญุณูู ูุฐู ุงูุทุฑููุฉ ุ ูุฅู ุงููุณู ุงูุชุงูู ููุฏู ุจุนุถ ุงูุชูุตูุงุช. <br><br><h4 style=";text-align:right;direction:rtl">  ุชุญุณู </h4><br>  ูููู ุชุญุณูู ูุฐู ุงูููุฒุฉ ุจุนุฏุฉ ุทุฑู.  ุฃููุงู ุ ููููู ุชุนุทูู ุงูููุงุทุนุงุช ุนู ุนูุฏ ููุฑุถ ุฃููููุฉ ุณูุณูุฉ ุงูุฑุณุงุฆู ุนู ุทุฑูู ุชุบููุฑ CR8 ุฅูู ุฃุนูู IRQL.  ุณูููู ุฃูุถูุง ูุซุงูููุง ูุนุฒู ูุฐุง ุงูุงุฎุชูุงุฑ ูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ูุงุญุฏุฉ.  ุชุญุณูู ุขุฎุฑ: ูุฌุจ ุนููู ุงุณุชุฎุฏุงู ุฃุฌูุฒุฉ ุถุจุท ููุช ูุฎุชููุฉ ุ ูููู ุงูุนุฏูุฏ ูููุง ููุณ ุฏููููุง ูุซู TSC ุ ูููู ููุฌุฏ ุฌูุงุฒ ุถุจุท ููุช ูุซู APERF timer ุ ุฃู Actual Performance Clock.  ุฃูุตู ุจูุฐุง ุงููุคูุช ูุฃูู ูู ุงูุตุนุจ ุงูุบุด ุจู ููุชุฑุงูู ูู ุนุฏุงุฏ ููุท ุนูุฏูุง ูููู ุงููุนุงูุฌ ุงูููุทูู ูู ุญุงูุฉ ุงูุทุงูุฉ C0.  ูุฐุง ุจุฏูู ุฑุงุฆุน ูุงุณุชุฎุฏุงู TSC.  ููููู ุฃูุถูุง ุงุณุชุฎุฏุงู ACPI ุฃู HPET ุฃู PIT timer ุฃู GPU timer ุฃู NTP timer ุฃู PPERF timer ุ ูุงูุฐู ูุดุจู APERF ุ ูููู ุชุญุณุจ ุงูุชุฏุงุจูุฑ ุงูุชู ูููุธุฑ ุฅูููุง ุนูู ุฃููุง ุชุนูููุงุช ุชูููุฐูุฉ.  ุนูุจ ูุฐุง ูู ุฃูู ุชุญุชุงุฌ ุฅูู ุชูููู HWP ุ ูุงูุชู ูููู ุชุนุทูููุง ูู ูุจู ุงููุดุบู ุงููุณูุท ุ ูุจุงูุชุงูู ููู ุบูุฑ ูุฌุฏูุฉ. <br><br>  ููุฌุฏ ุฃุฏูุงู ูุณุฎุฉ ูุญุณูุฉ ูู ุฅุฌุฑุงุก ุงูุชุนุฑู ุงูุฐู ูุฌุจ ุฅุฌุฑุงุคู ูู kernel: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> battleye::take_time() { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> cpuid_regs[<span class="hljs-number"><span class="hljs-number">4</span></span>] = {}; _disable(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> aperf_pre = __readmsr(IA32_APERF_MSR) &lt;&lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; __cpuid(&amp;cpuid_regs, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> aperf_post = __readmsr(IA32_APERF_MSR) &lt;&lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> aperf_diff = aperf_post - aperf_pre; <span class="hljs-comment"><span class="hljs-comment">// CPUID IET ARRAY STORE // BATTLEYE REPORT TABLE STORE _enable(); }</span></span></code> </pre> <br>  <strong>ููุงุญุธุฉ:</strong> IET ุชุนูู "ููุช ุชูููุฐ ุงูุชุนูููุงุช". <br><br>  ููุน ุฐูู ุ ูุง ูุฒุงู ุงูุฅุฌุฑุงุก ุบูุฑ ููุซูู ุจู ููุบุงูุฉ ูู ุงููุดู ุนู ุจุฑุงูุฌ Hypervisor ุงูุดุงุฆุนุฉ ุ ูุธุฑูุง ูุฃู ุฃููุงุช ุชุดุบูู CPUID ูููู ุฃู ุชุฎุชูู ุงุฎุชูุงููุง ูุจูุฑูุง.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณูููู ูู ุงูุฃูุถู ููุงุฑูุฉ IET ูู ุงูุฅุฑุดุงุฏุงุช ุงุซููู. ูุงุญุฏ ูููู ูุฌุจ ุฃู ูููู ุชุฃุฎูุฑ ุชูููุฐ ุฃุทูู ูู CPUID. ุนูู ุณุจูู ุงููุซุงู ุ ูุฏ ูููู FYL2XP1 - ุชุนูููุฉ ุญุณุงุจูุฉ ุชุณุชุบุฑู ููุชูุง ุฃุทูู ููููุงู ูุฅููุงููุง ูู ูุชูุณุท โโIET ูุชุนููู CPUID. ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุง ูุณุจุจ ุฃู ูุตุงุฆุฏ ูู ุจุฑูุงูุฌ Hypervisor ููููู ููุงุณ ููุชูุง ุจุดูู ููุซูู. ุจุงุณุชุฎุฏุงู ูุงุชูู ุงููุธููุชูู ุ ูููู ุฃู ุชูุดุฆ ูุธููุฉ ุงูุชูุตูู ุตููููุง ูุชุฎุฒูู ุชุนูููุงุช IET CPUID ู FYL2XP1. ุจุงุณุชุฎุฏุงู ูุคูุช APERF ุ ุณูููู ูู ุงููููู ุงูุญุตูู ุนูู ุงูุณุงุนุฉ ุงูุฃูููุฉ ูุชุนููู ุญุณุงุจู ุ ูุชูููุฐ ุงูุชุนูููุงุช ูุญุณุงุจ ุฏูุชุง ุงูุณุงุนุฉ ูุฐูู. ูููู ุชุฎุฒูู ุงููุชุงุฆุฌ ูู ุตููู IET ูุฏูุฑุงุช ุงูุชูููุท N ุ ูุงูุญุตูู ุนูู ูุชูุณุท โโุงููููุฉ ุ ูุชูุฑุงุฑ ุงูุนูููุฉ ูู CPUID. ุฅุฐุง ูุงู ููุช ุชูููุฐ ุชุนูููุฉ CPUID ุฃุทูู ูู ุงูุชุนูููุงุช ุงูุญุณุงุจูุฉ ุูุฐู ุนูุงูุฉ ููุซููุฉ ุนูู ุฃู ุงููุธุงู ุธุงูุฑู ุ ูุฃู ุงูุชุนูููุงุช ุงูุญุณุงุจูุฉ ุชุญุช ุฃู ุธุฑู ูู ุงูุธุฑูู ูุฏ ุชูุถู ููุชูุง ุฃุทูู ูู ุชูููุฐ CPUID ููุญุตูู ุนูู ูุนูููุงุช ุญูู ุงูุดุฑูุฉ ุงููุตูุนุฉ ุฃู ุงูุฅุตุฏุงุฑ. ุณูููู ูุฐุง ุงูุฅุฌุฑุงุก ููุชุนุฑู ุฃูุถูุง ุนูู ูู ูุณุชุฎุฏููู TSC offset / scaling.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุฃูุฑุฑ ุ ูุชุนูู ุนูู ุงููุทูุฑูู ูุฑุถ ุชูููู ุงูุฑุจุท ูููุฑู ุงูุญุณุงุจู ูุฅุฌุฑุงุก ูุฐุง ุงููุญุต ุนูู ูุจ ูุงุญุฏ ุ ูุชุนุทูู ุงูููุงุทุนุงุช ูุฅุฌุจุงุฑ IRQL ุนูู ุชุนููู ุงูุญุฏ ุงูุฃูุตู ูููููุฉ ูุถูุงู ุจูุงูุงุช ูุชุณูุฉ ูููุซููุฉ. </font><font style="vertical-align: inherit;">ุณูููู ูู ุงููุฏูุด ุฅุฐุง ูุฑุฑ ูุทูุฑู BattlEye ุชูููุฐ ุฐูู ุ ูุฃูู ูุชุทูุจ ุจุฐู ุงููุฒูุฏ ูู ุงูุฌูุฏ. </font><font style="vertical-align: inherit;">ูู ุจุฑูุงูุฌ ุชุดุบูู kernel ุ ูุฃูู BattlEye ุฑูุชูููู ุขุฎุฑูู ููุชุนุฑู ุนูู ุงูุฌูุงุฒ ุงูุธุงูุฑู ุ ูููู ูุฐุง ููุถูุน ูููุงู ุขุฎุฑ.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar484420/">https://habr.com/ru/post/ar484420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar484408/index.html">ุนุตุฑ RUTM</a></li>
<li><a href="../ar484410/index.html">ุนุงุฏุงุช ุงููุทูุฑ ูููุฏุฉ</a></li>
<li><a href="../ar484412/index.html">ูุนุงูุฌ NXP S32G ูููุฏุณุฉ ุงูุงููุชุฑูููุงุช ุงูุญุฏูุซุฉ</a></li>
<li><a href="../ar484414/index.html">ุงุฎุชูุงุฑ ุฃุฑุดููู ูุณุฌูุงุช ุงููุณุฎ ุงูุงุญุชูุงุทู</a></li>
<li><a href="../ar484418/index.html">ุงูุฑุฆูุณ ุงูุชูููุฐู ูุดุฑูุฉ Motoriki Ilya Chekh: ูู ุจุนุถ ุงูุฃุญูุงู ูุชููุนูู ุนููุงู ูุซุงููุงู ูู ุงูุฃุทุฑุงู ุงูุตูุงุนูุฉ ุงูุชุฌุฑูุจูุฉ ุ ุซู ูุดุนุฑูู ุจุฎูุจุฉ ุฃูู</a></li>
<li><a href="../ar484424/index.html">ูููุฏูุง ุฃูุฑูู - ุฑูุงูุฉ ูููุฑูุจุงุช ุงูุขููุฉ</a></li>
<li><a href="../ar484426/index.html">ุฃูุง ูุจูุฏู ุงูุฏุฑุงุฌุฉ. ุงูุชุญุฌูู ุนุฏู ุงูููุงุกุฉ</a></li>
<li><a href="../ar484428/index.html">ุงุฎุชูุงุฑ ููุฑุฉ ูุจุฏุก ุงูุชุดุบูู ุฏูู ูุณุชุซูุฑ: ูู ุงูุนูุณ</a></li>
<li><a href="../ar484430/index.html">ุฃูู ูุธุงุฑุฉ VR ูุฒูุฏุฉ ุจุชูููุฉ HDR ูู ุงูุนุงูู: ูุง ูู ูุนุฑูู ุนู ุงููููุฐุฌ ุงูุฃููู ูู Panasonic</a></li>
<li><a href="../ar484436/index.html">ูุตุฏุฑ ููุชูุญ ุบูุฑ ููุชู: ูุงู ูุทูุฑ ุฃุณุฑุน ุฎุงุฏู ููุจ ุจุญุฐู ูุณุชูุฏุนู - ุชุญุฏูุซ ููู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>