<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯд░ЁЯП╜ ЁЯЩПЁЯП╗ ЁЯЙР рднрд╛рдЧ 5/2 Bldgред 1: RocketChip рдПрд╡реЗрдиреНрдпреВ рдФрд░ рдлрд┐рд╕рд▓рди рдЗрдВрд╕реНрдЯреНрд░реВрдореЗрдВрдЯреЗрд╢рди рдЯреНрд░реИрдХ рдХрд╛ рдЪреМрд░рд╛рд╣рд╛ ЁЯСиЁЯП╗тАНЁЯЪТ ЁЯЫвя╕П ЁЯС╕ЁЯП╛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдкрд┐рдЫрд▓реЗ рдЪрд╛рд░ рднрд╛рдЧреЛрдВ рдореЗрдВ, рдЖрд░рдЖрдИрдПрд╕рд╕реА-рд╡реА рд░реЙрдХреЗрдЯ рдХреЛрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░реА рдХреА рдЧрдИ рдереА, рдЕрд░реНрдерд╛рддреН, рдЗрд╕ рдХреЛрд░ рдХреЛ рдЕрд▓реНрдЯрд░рдЯрд╛ рдПрдлрдкреАрдЬреАрдПрдПрд╕ (рдЕрдм рдЗрдВрдЯреЗрд▓) рдХреЗ рд╕рд╛рде рдПрдХ "рдЧреИрд░-рдорд╛рдирдХ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рднрд╛рдЧ 5/2 Bldgред 1: RocketChip рдПрд╡реЗрдиреНрдпреВ рдФрд░ рдлрд┐рд╕рд▓рди рдЗрдВрд╕реНрдЯреНрд░реВрдореЗрдВрдЯреЗрд╢рди рдЯреНрд░реИрдХ рдХрд╛ рдЪреМрд░рд╛рд╣рд╛</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461577/"><p>  рдкрд┐рдЫрд▓реЗ рдЪрд╛рд░ рднрд╛рдЧреЛрдВ рдореЗрдВ, рдЖрд░рдЖрдИрдПрд╕рд╕реА-рд╡реА рд░реЙрдХреЗрдЯ рдХреЛрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░реА рдХреА рдЧрдИ рдереА, рдЕрд░реНрдерд╛рддреН, рдЗрд╕ рдХреЛрд░ рдХреЛ рдЕрд▓реНрдЯрд░рдЯрд╛ рдПрдлрдкреАрдЬреАрдПрдПрд╕ (рдЕрдм рдЗрдВрдЯреЗрд▓) рдХреЗ рд╕рд╛рде рдПрдХ "рдЧреИрд░-рдорд╛рдирдХ" рдмреЛрд░реНрдб рдореЗрдВ рдкреЛрд░реНрдЯ рдХрд░ рд░рд╣рд╛ рд╣реИред  рдЕрдВрдд рдореЗрдВ, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкрд┐рдЫрд▓реЗ рднрд╛рдЧ рдореЗрдВ</a> , рдпрд╣ рдЗрд╕ рдмреЛрд░реНрдб рдкрд░ рд▓рд┐рдирдХреНрд╕ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдХрд▓рд╛ред  рдХреНрдпрд╛ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдЗрд╕ рд╕рдм рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореБрдЭреЗ рдХреНрдпрд╛ рд╕реВрдЭрд╛?  рдпрд╣ рддрдереНрдп рдХрд┐ рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рдореБрдЭреЗ рдХреЛрдбрд╛рдВрддрд░рдХ RISC-V, C рдФрд░ рд╕реНрдХрд╛рд▓рд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рдерд╛, рдФрд░ рдЙрди рд╕рднреА рдореЗрдВ, рд╕реНрдХрд╛рд▓рд╛ рд╕рдмрд╕реЗ рдирд┐рдЪрд▓реЗ рд╕реНрддрд░ рдХреА рднрд╛рд╖рд╛ рдереА (рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░реЛрд╕реЗрд╕рд░ рдЙрд╕ рдкрд░ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ)ред </p><br><p>  рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ, рдЖрдЗрдП C рдХреЛ рдЖрдкрддреНрддрд┐рдЬрдирдХ рди рдмрдирд╛рдПрдВред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рд╕реНрдХреЗрд▓рд╛ + рдЫреЗрдиреА рдмрдВрдбрд▓ рдХреЗрд╡рд▓ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдХреЗ рд╕реНрдкрд╖реНрдЯ рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП рдПрдХ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдбреЛрдореЗрди-рд╡рд┐рд╢рд┐рд╖реНрдЯ рднрд╛рд╖рд╛ рдХреЗ</a> рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ рдЖрдЬ рд╣рдо рд╕реАрдЦреЗрдВрдЧреЗ рдХрд┐ рдирд┐рд░реНрджреЗрд╢ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░реЛрд╕реЗрд╕рд░ рдореЗрдВ рд╕рд░рд▓ рд╕реА рдлрд╝рдВрдХреНрд╢рди рдХреЛ "рдХреИрд╕реЗ" рдЦреАрдВрдЪреЗрдВред </p><br><p> рдЕрдВрддрд┐рдо рд▓рдХреНрд╖реНрдп <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">QInst рдХреЗ</a> рд╕рд╛рде рд╕рд╛рджреГрд╢реНрдп рджреНрд╡рд╛рд░рд╛ рддреБрдЪреНрдЫ AFL рдЬреИрд╕реЗ рдЗрдВрд╕реНрдЯреНрд░реВрдореЗрдВрдЯреНрд╕ рдХрд╛ рддреБрдЪреНрдЫ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╣реИ, рдФрд░ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗрд╡рд▓ рдПрдХ рдЙрдк-рдЙрддреНрдкрд╛рдж рд╣реИред </p><a name="habracut"></a><br><p>  рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ RTL рдХрдирд╡рд░реНрдЯрд░ рдХреЗ рд▓рд┐рдП рдУрдкрдирд╕реАрдПрд▓ (рдФрд░ рдПрдХ рдирд╣реАрдВ) рд╡рд╛рдгрд┐рдЬреНрдпрд┐рдХ рд╣реИред  рдореБрдЭреЗ RISC-V рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдорд╛рди COPILOT рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рднреА рдЬрд╛рдирдХрд╛рд░реА рдорд┐рд▓реА, рдЬрд┐рд╕рдореЗрдВ рд╕рдорд╛рди рд▓рдХреНрд╖реНрдп (рдмрд╣реБрдд рдЕрдзрд┐рдХ рдЙрдиреНрдирдд) рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХреБрдЫ рдмреБрд░реА рддрд░рд╣ рд╕реЗ рдЧреБрдЧрд▓реА рдХрд░ рд░рд╣рд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛ рдПрдХ рд╡рд╛рдгрд┐рдЬреНрдпрд┐рдХ рдЙрддреНрдкрд╛рдж рднреА рд╣реИред  рдореИрдВ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ OpenSource рд╕рдорд╛рдзрд╛рдиреЛрдВ рдореЗрдВ рджрд┐рд▓рдЪрд╕реНрдкреА рд░рдЦрддрд╛ рд╣реВрдВ, рд▓реЗрдХрд┐рди рдпрджрд┐ рд╡реЗ рд╣реИрдВ, рддреЛ рднреА рдЗрд╕реЗ рд╕реНрд╡рдпрдВ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рдордЬрд╝рд╛ рд╣реИ - рдХрдо рд╕реЗ рдХрдо рдПрдХ рд╕рд░рд▓реАрдХреГрдд рдорд╛рдорд▓реЗ рдХреЗ рдЕрдзреНрдпрдпрди рдХреЗ рд░реВрдк рдореЗрдВ, рдФрд░ рдлрд┐рд░ рдпрд╣ рдХреИрд╕реЗ рдЬрд╛рддрд╛ рд╣реИ ... </p><br><p>  <strong>рдЕрд╕реНрд╡реАрдХрд░рдг</strong> ("рдЖрдЧ рдмреБрдЭрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреЗ рд╕рд╛рде рдиреГрддреНрдп" рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕рд╛рдорд╛рдиреНрдп рдЪреЗрддрд╛рд╡рдиреА рдХреЗ рдЕрд▓рд╛рд╡рд╛): рдореИрдВ рджреГрдврд╝рддрд╛ рд╕реЗ рдкрд░рд┐рдгрд╛рдореА рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдХреЛрд░ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рджреГрдврд╝рддрд╛ рд╕реЗ рдЕрдиреБрд╢рдВрд╕рд╛ рдирд╣реАрдВ рдХрд░рддрд╛, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде - рдЕрдм рддрдХ рдореБрдЭреЗ рдЗрддрдирд╛ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рднреА рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖ рд░рд╣рд╛ рд╣реИ рдХрд┐ рдбреЗрдЯрд╛ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХреНрдпреЛрдВ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдФрд░ / рдпрд╛ рдХреЛрд░ рдХреЗ рдмреАрдЪ рдХреБрдЫ рд╕реАрдорд╛ рдорд╛рдорд▓реЗ рдореЗрдВ "рдкреНрд░рд╡рд╛рд╣"ред  рдЗрд╕ рддрдереНрдп рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХрд┐ рдбреЗрдЯрд╛ "рдмреАрдЯ" рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдЕрднреА рднреА рдорд╛рдиреНрдпрддрд╛ рдФрд░ рдорд╛рдиреНрдпрддрд╛ рд╣реИ ... </p><br><p>  рд╢реБрд░реБрдЖрдд рдХреЗ рд▓рд┐рдП, рдореБрдЭреЗ "рд╕рд╛рдзрд╛рд░рдг рдлрд╝рдВрдХреНрд╢рди" рдХреНрдпрд╛ рдХрд╣рддреЗ рд╣реИрдВ?  рдЗрд╕ рд▓реЗрдЦ рдХреЗ рдкреНрд░рдпреЛрдЬрдиреЛрдВ рдХреЗ рд▓рд┐рдП, рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдЬрд┐рд╕рдореЗрдВ рд╕рднреА рд╕рдВрдХреНрд░рдордг (рд╕рд╢рд░реНрдд рдФрд░ рдмрд┐рдирд╛ рд╢рд░реНрдд) рдХреЗрд╡рд▓ рдирд┐рд░рдВрддрд░ рдорд╛рди рджреНрд╡рд╛рд░рд╛ рдЕрдиреБрджреЗрд╢ рдХрд╛рдЙрдВрдЯрд░ рдмрдврд╝рд╛рддреЗ рд╣реИрдВред  рдпрд╣реА рд╣реИ, "рдЧрддрд┐рд╢реАрд▓" рдХрд┐рдирд╛рд░реЛрдВ рдХреЗ рдмрд┐рдирд╛, рд╕рднреА рд╕рдВрднрд╡ рд╕рдВрдХреНрд░рдордгреЛрдВ рдХрд╛ рдЧреНрд░рд╛рдл (рдирд┐рд░реНрджреЗрд╢рд┐рдд) рдПрд╕рд╛рдЗрдХреНрд▓рд┐рдХ рд╣реИред  рдЗрд╕ рд▓реЗрдЦ рдХреЗ рдврд╛рдВрдЪреЗ рдореЗрдВ рдЕрдВрддрд┐рдо рд▓рдХреНрд╖реНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рд╕реЗ рдПрдХ рд╕рд░рд▓ рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рд╣реИ рдФрд░, рдЗрд╕реЗ рдПрдХ рдЕрд╕реЗрдВрдмрд▓рд░ рдкреНрд▓рдЧ-рдЗрди рдХреЗ рд╕рд╛рде рдмрджрд▓рдХрд░, рд╕рдВрд╢реНрд▓реЗрд╖рдг рдЪрд░рдг рдкрд░ рдкреНрд░реЛрд╕реЗрд╕рд░ рдореЗрдВ рдЗрд╕реЗ "рд╕реАрд╡реЗ" рдХрд░реЗрдВ, рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ рдЗрд╕реЗ рджреВрд╕рд░реЗ рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рдПрдХ рд╕рд╛рдЗрдб рдЗрдлреЗрдХреНрдЯ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИред  <em>рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рд╢рд╛рдЦрд╛ рдХреЛ рдирд╣реАрдВ рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рд╕рдмрд╕реЗ рд╕рд░рд▓ рдорд╛рдорд▓реЗ рдореЗрдВ рдЙрдиреНрд╣реЗрдВ рдмрдирд╛рдирд╛ рдореБрд╢реНрдХрд┐рд▓ рдирд╣реАрдВ рд╣реЛрдЧрд╛ред</em> </p><br><h2 id="uchimsya-ponimat-c-na-samom-dele-net">  C рдХреЛ рд╕рдордЭрдирд╛ рд╕реАрдЦрдирд╛ (рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдирд╣реАрдВ) </h2><br><p> рдкрд╣рд▓реЗ рдЖрдкрдХреЛ рдпрд╣ рд╕рдордЭрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рд╣рдо C рдХреЛ рдХреИрд╕реЗ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВрдЧреЗ?  рдпрд╣ рд╕рд╣реА рд╣реИ, рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ - рдпрд╣ рд╡реНрдпрд░реНрде рдирд╣реАрдВ рдерд╛ рдХрд┐ рдореИрдВрдиреЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдИрдПрд▓рдПрдл рдлрд╝рд╛рдЗрд▓реЛрдВ</a> рдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкрд╛рд░реНрд╕</a> рдХрд░рдирд╛ рд╕реАрдЦрд╛: рдЖрдкрдХреЛ рдмрд╕ рд╣рдорд╛рд░реЗ рдХреЛрдб рдХреЛ рд╕реА / рд░рд╕реНрдЯ / рдХреБрдЫ рдФрд░ рдХреЛ рдПрдХ рдИрдкреАрдкреАрдПрдл рдмрд╛рдЗрдЯрдХреЛрдб рдореЗрдВ рд╕рдВрдХрд▓рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдФрд░ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЗрд╕реЗ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВред  рдХреБрдЫ рдХрдард┐рдирд╛рдЗрдпрд╛рдБ рдЗрд╕ рддрдереНрдп рдХреЗ рдХрд╛рд░рдг рд╣реЛрддреА рд╣реИрдВ рдХрд┐ рд╕реНрдХрд╛рд▓рд╛ рдореЗрдВ рдЖрдк рдХреЗрд╡рд▓ <code>elf.h</code> рдХреЛ рдирд╣реАрдВ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рдВрд░рдЪрдирд╛ рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреЛ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред  рдЖрдк рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬреЗрдПрдирдПрд░реЗрдЯрд░</a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рдХрддреЗ рд╣реИрдВ</a> - рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ, рддреЛ рд╡реЗ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдмрд╛рдЗрдВрдб</a> рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ - рди рдХреЗрд╡рд▓ рд╕рдВрд░рдЪрдирд╛рдПрдВ, рдмрд▓реНрдХрд┐ рдЬреЗрдПрдирдП рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдб рднреА рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╣реИрдВ (рдЬреЗрдПрдирдЖрдИ рдХреЗ рд╕рд╛рде рднреНрд░рдорд┐рдд рдирд╣реАрдВ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП)ред  рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рдХреЗ рд░реВрдк рдореЗрдВ, рдореИрдВ рдЕрдкрдиреА рдмрд╛рдЗрдХ рд▓рд┐рдЦреВрдВрдЧрд╛ рдФрд░ рд╣реЗрдбрд░ рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдЧрдгрдирд╛ рдФрд░ рдСрдлрд╕реЗрдЯ рд╕реНрдерд┐рд░рд╛рдВрдХ рдХреЛ рд╕рд╛рд╡рдзрд╛рдиреАрдкреВрд░реНрд╡рдХ рд▓рд┐рдЦреВрдВрдЧрд╛ред  рдкрд░рд┐рдгрд╛рдо рдФрд░ рдордзреНрдпрд╡рд░реНрддреА рд╕рдВрд░рдЪрдирд╛рдПрдВ рдХреЗрд╕ рдХрдХреНрд╖рд╛рдУрдВ рдХреА рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдВрд░рдЪрдирд╛ рджреНрд╡рд╛рд░рд╛ рд╡рд░реНрдгрд┐рдд рд╣реИрдВ: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegularSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SymtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StrtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RelSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Header</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> sectionHeaders: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">], sectionStringTableIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Section</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> data: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">, linkIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, infoIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, kind: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">SectionKind</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Symbol</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, size: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, shndx: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, isInstrumenter: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Relocation</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> relocatedSection: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, symbol: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfInsn</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> opcode: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, dst: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, src: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, imm: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Either</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-class"><span class="hljs-params">, </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfProg</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, insns: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">BpfInsn</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  рдореИрдВ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╡рд░реНрдгрди рдирд╣реАрдВ рдХрд░реВрдВрдЧрд╛ - рдпрд╣ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>java.nio.ByteBuffer</code></a> рд╕реЗ рд╕рд┐рд░реНрдл рдПрдХ рд╕реБрд╕реНрдд рдмрд╛рдЗрдЯ рдЯреНрд░рд╛рдВрд╕рдлрд░ рд╣реИ - рд╕рднреА рджрд┐рд▓рдЪрд╕реНрдк рдЪреАрдЬреЗрдВ рдкрд╣рд▓реЗ рд╣реА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдИрдПрд▓рдПрдл рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ рдкрд░ рд▓реЗрдЦ</a> рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХреА рдЧрдИ рд╣реИрдВред  рдореИрдВ рдХреЗрд╡рд▓ рдпрд╣ рдХрд╣ рд╕рдХрддрд╛ рд╣реВрдВ рдХрд┐ рдЖрдкрдХреЛ <code>opcode == 0x18</code> (рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ 64-рдмрд┐рдЯ рддрд╛рддреНрдХрд╛рд▓рд┐рдХ рдорд╛рди рд▓реЛрдб рдХрд░рдирд╛) рдХреЛ рд╕рд╛рд╡рдзрд╛рдиреАрдкреВрд░реНрд╡рдХ рд╕рдВрднрд╛рд▓рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ рд╣реА рдмрд╛рд░ рдореЗрдВ рджреЛ 8-рдмрд╛рдЗрдЯ рд╢рдмреНрдж рд▓реЗрддрд╛ рд╣реИ (рд╢рд╛рдпрдж рдЗрд╕ рддрд░рд╣ рдХреЗ рдЕрдиреНрдп opcodes рд╣реИрдВ, рд▓реЗрдХрд┐рди рдореИрдВ рдЙрдирдХреЗ рд╕рд╛рде рдЕрднреА рддрдХ рдирд╣реАрдВ рдЖрдпрд╛ рд╣реВрдВ) , рдФрд░ рдпрд╣ рд╣рдореЗрд╢рд╛ рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рд╕реЗ рдЬреБрдбрд╝реЗ рдореЗрдореЛрд░реА рдкрддреЗ рдХреЛ рд▓реЛрдб рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВрдиреЗ рд╢реБрд░реВ рдореЗрдВ рд╕реЛрдЪрд╛ рдерд╛ред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <code>__builtin_popcountl</code> рдИрдорд╛рдирджрд╛рд░реА рд╕реЗ 64-рдмрд┐рдЯ <strong>рд╕реНрдерд┐рд░</strong> <code>0x0101010101010101</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред  рдореИрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХреА рдЧрдИ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдкреИрдЪ рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде "рдИрдорд╛рдирджрд╛рд░" рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рдХреНрдпреЛрдВ рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реВрдВ - рдХреНрдпреЛрдВрдХрд┐ рдореИрдВ рд╡рд░реНрдгреЛрдВ рдХреЛ рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд░реВрдк рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ (рд╕рдЬрд╛ рдХреЗ рд▓рд┐рдП рдЦреЗрдж рд╣реИ), рддрд╛рдХрд┐ рдмрд╛рдж рдореЗрдВ <code>COMMON</code> рдЕрдиреБрднрд╛рдЧ рдХреЗ рдкрд╛рддреНрд░реЛрдВ рдХреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдкреНрд░рдХрд╛рд░ рдХреЗ рдкрддреЗ рдХреЗ рд╡рд┐рд╢реЗрд╖ рд╣реИрдВрдбрд▓рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдмреИрд╕рд╛рдЦреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдмрд┐рдирд╛ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рд╕реЗ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХреЗ (рдФрд░ рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ, рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдирд┐рд░рдВрддрд░ / рдЧреИрд░-рд╕реНрдерд┐рд░ <code>UInt</code> рд╕рд╛рде рдиреГрддреНрдп рдХреЗ рд╕рд╛рде)ред </p><br><h2 id="stroim-hardware-po-naboru-instrukciy">  рд╣рдо рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рдПрдХ рд╕реЗрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд░рддреЗ рд╣реИрдВ </h2><br><p>  рдЗрд╕рд▓рд┐рдП, рдЕрдиреБрдорд╛рди рдХреЗ рдЕрдиреБрд╕рд╛рд░, рд╕рднреА рд╕рдВрднрд╛рд╡рд┐рдд рдирд┐рд╖реНрдкрд╛рджрди рдорд╛рд░реНрдЧ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреА рд╕реВрдЪреА рд╕реЗ рдиреАрдЪреЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдбреЗрдЯрд╛ рдПрдХ рдЙрдиреНрдореБрдЦ рдЪрдХреНрд░реАрдп рдЧреНрд░рд╛рдл рдХреЗ рд╕рд╛рде рдмрд╣рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХреЗ рд╕рднреА рдХрд┐рдирд╛рд░реЛрдВ рдХреЛ рд╕рд╛рдВрдЦреНрдпрд┐рдХреАрдп рд░реВрдк рд╕реЗ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдЗрд╕реА рд╕рдордп, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╡рд┐рд╢реБрджреНрдз рд░реВрдк рд╕реЗ рджрд╣рдирд╢реАрд▓ рддрд░реНрдХ рд╣реИрдВ (рдЬреЛ рдХрд┐ рд░рд╛рд╕реНрддреЗ рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЗ рдмрд┐рдирд╛ рд╣реИрдВ), рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдкрд░ рд╕рдВрдЪрд╛рд▓рди рд╕реЗ рдкреНрд░рд╛рдкреНрдд, рд╕рд╛рде рд╣реА рдореЗрдореЛрд░реА рдХреЗ рд╕рд╛рде рд▓реЛрдб / рд╕реНрдЯреЛрд░ рд╕рдВрдЪрд╛рд▓рди рдХреЗ рджреМрд░рд╛рди рджреЗрд░реАред  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╕рд╛рдорд╛рдиреНрдп рд╕реНрдерд┐рддрд┐ рдореЗрдВ, рдСрдкрд░реЗрд╢рди рдПрдХ рдШрдбрд╝реА рдЪрдХреНрд░ рдореЗрдВ рдкреВрд░рд╛ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред  рд╣рдо рд╕рд░рд▓ рдХрд░реЗрдВрдЧреЗ: рд╣рдо <code>UInt</code> рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рди рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди <code>(UInt, Bool)</code> : рдЬреЛрдбрд╝реА рдХрд╛ рдкрд╣рд▓рд╛ рддрддреНрд╡ рдореВрд▓реНрдп рд╣реИ, рдФрд░ рджреВрд╕рд░рд╛ рдЗрд╕рдХреА рд╢реБрджреНрдзрддрд╛ рдХрд╛ рд╕рдВрдХреЗрдд рд╣реИред  рдпрд╣реА рд╣реИ, рдпрд╣ рдореЗрдореЛрд░реА рд╕реЗ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдЕрдзрд┐рдХ рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖрддрд╛ рд╣реИ, рдЬрдм рддрдХ рдХрд┐ рдкрддрд╛ рдЧрд▓рдд рд╣реИ, рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рд▓рд┐рдЦрдирд╛ рдЕрд╕рдВрднрд╡ рд╣реИред </p><br><p>  EBPF рдмрд╛рдЗрдЯрдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдореЙрдбрд▓ 64-рдмрд┐рдЯ рдПрдбреНрд░реЗрд╕рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдХреБрдЫ рдкреНрд░рдХрд╛рд░ рдХреА рд░реИрдо рдХреЛ рдорд╛рдирддрд╛ рд╣реИ, рд╕рд╛рде рд╣реА 16 (рдпрд╛ рджрд╕) 64-рдмрд┐рдЯ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХрд╛ рдПрдХ рд╕реЗрдЯ рд╣реИред  рдПрдХ рдЖрджрд┐рдо рдкреБрдирд░рд╛рд╡рд░реНрддреА рдПрд▓реНрдЧреЛрд░рд┐рджрдо рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рд╣реИ: </p><br><ul><li>  рд╣рдо рдЙрд╕ рд╕рдВрджрд░реНрдн рд╕реЗ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдирд┐рд░реНрджреЗрд╢ рдХреЗ <code>r1</code> рдФрд░ <code>r2</code> рдореЗрдВ <code>r2</code> , рдмрд╛рдХреА рдореЗрдВ - рд╢реВрдиреНрдп, рд╕рднреА рд╡реИрдз (рдЕрдзрд┐рдХ рд╕рдЯреАрдХ рд░реВрдк рд╕реЗ, рд╡реИрдзрддрд╛ рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдирд┐рд░реНрджреЗрд╢ рдХреА "рддрддреНрдкрд░рддрд╛" рдХреЗ рдмрд░рд╛рдмрд░ рд╣реИ) </li><li>  рдпрджрд┐ рд╣рдо рдПрдХ рдЕрдВрдХрдЧрдгрд┐рддреАрдп-рддрд╛рд░реНрдХрд┐рдХ рдирд┐рд░реНрджреЗрд╢ рджреЗрдЦрддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдЙрд╕рдХреЗ рдСрдкрд░реЗрдВрдб рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЛ рд╕рдВрджрд░реНрдн рд╕реЗ рдирд┐рдХрд╛рд▓рддреЗ рд╣реИрдВ, рд╕реВрдЪреА рдХреА рдкреВрдВрдЫ рдХреЗ рд▓рд┐рдП рдЦреБрдж рдХреЛ рдмреБрд▓рд╛рддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕ рд╕рдВрджрд░реНрдн рдХреЛ рдЬрд┐рд╕рдореЗрдВ рдЖрдЙрдЯрдкреБрдЯ рдСрдкрд░реЗрдВрдб рдХреЛ рдПрдХ рдЬреЛрдбрд╝реА рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ <code>(data1 op data2, valid1 &amp;&amp; valid2)</code> </li><li>  рдпрджрд┐ рд╣рдо рдПрдХ рд╢рд╛рдЦрд╛ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдмрд╕ рджреЛрдиреЛрдВ рд╢рд╛рдЦрд╛рдУрдВ рдХрд╛ рдкреБрдирд░рд╛рд╡рд░реНрддреА рдирд┐рд░реНрдорд╛рдг рдХрд░рддреЗ рд╣реИрдВ: рдпрджрд┐ рд╢рд╛рдЦрд╛ рд╣реЛрддреА рд╣реИ, рдФрд░ рдпрджрд┐ рдирд╣реАрдВ </li><li>  рдЕрдЧрд░ рд╣рдо рдореЗрдореЛрд░реА рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдпрд╛ рд╕рд╣реЗрдЬрдиреЗ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдХрд┐рд╕реА рддрд░рд╣ рд╣рдо рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддреЗ рд╣реИрдВ: рд╣рдо рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХреЙрд▓рдмреИрдХ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдпрд╣ рдорд╛рдирддреЗ рд╣реБрдП рдХрд┐ рдЗрд╕ рдирд┐рд░реНрджреЗрд╢ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рджреМрд░рд╛рди рдПрдХ рдмрд╛рд░ <code>valid</code> рдмрдпрд╛рди рдХреЛ рд╡рд╛рдкрд╕ рдирд╣реАрдВ рд▓рд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рд╕реЗрд╡ рдСрдкрд░реЗрд╢рди рдХреА рд╡реИрдзрддрд╛ рдФрд░ рд╣рдорд╛рд░реЗ рджреНрд╡рд╛рд░рд╛ <code>globalValid</code> рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рд╣реИ, рдЬрд┐рд╕реЗ рдирд┐рдпрдВрддреНрд░рдг рд╡рд╛рдкрд╕ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  рдЙрд╕реА рд╕рдордп, рд╣рдореЗрдВ рд╡реЗрддрди рд╡реГрджреНрдзрд┐ рдФрд░ рдЕрдиреНрдп рд╕рдВрд╢реЛрдзрдиреЛрдВ рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╛рдордиреЗ рдХреА рдУрд░ рдкрдврд╝рдирд╛ рдФрд░ рд▓рд┐рдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред </li></ul><br><p>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╕рдВрдЪрд╛рд▓рди рдпрдерд╛рд╕рдВрднрд╡ рд╕рдорд╛рдирд╛рдВрддрд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рдЪрд░рдгреЛрдВ рдореЗрдВ рдирд╣реАрдВред  рдЙрд╕реА рд╕рдордп, рдореИрдВ рдЖрдкрдХреЛ рдзреНрдпрд╛рди рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддрд╛ рд╣реВрдВ рдХрд┐ рдореЗрдореЛрд░реА рдХреЗ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдмрд╛рдЗрдЯ рдкрд░ рд╕рднреА рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЖрджреЗрд╢ рджрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЕрдиреНрдпрдерд╛ рдкрд░рд┐рдгрд╛рдо рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╣реИ, рдпреВрдмреАред  рдпрд╛рдиреА  <code>*addr += 1</code> - рдпрд╣ рд╕рд╛рдорд╛рдиреНрдп рд╣реИ, рдЬрдм рддрдХ рдкрдврд╝рдирд╛ рдкреВрд░рд╛ рдирд╣реАрдВ рд╣реЛ рдЬрд╛рддрд╛ рддрдм рддрдХ рд▓рд┐рдЦрдирд╛ рдмрд┐рд▓реНрдХреБрд▓ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛрдЧрд╛ (рдХреНрдпреЛрдВрдХрд┐ рд╣рдо рдЕрднреА рднреА рдирд╣реАрдВ рдЬрд╛рдирддреЗ рдХрд┐ рдХреНрдпрд╛ рд▓рд┐рдЦрдирд╛ рд╣реИ), рд▓реЗрдХрд┐рди <code>*addr += 1; return *addr;</code> <code>*addr += 1; return *addr;</code>  рдореИрдВрдиреЗ рдЖрдо рддреМрд░ рдкрд░ <strong>рд╢реВрдиреНрдп</strong> рдпрд╛ рдРрд╕рд╛ рдХреБрдЫ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рджрд┐рдпрд╛ред  рд╢рд╛рдпрдж рдпрд╣ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреЗ рд▓рд╛рдпрдХ рд╣реЛрдЧрд╛ (рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдХреБрдЫ рдЕрдзрд┐рдХ рдореБрд╢реНрдХрд┐рд▓ рд╕рдорд╕реНрдпрд╛ рдХреЛ рдЫреБрдкрд╛рддрд╛ рд╣реИ), рд▓реЗрдХрд┐рди рдЕрдкрдиреЗ рдЖрдк рдореЗрдВ рдЗрд╕ рддрд░рд╣ рдХреА рдЕрдкреАрд▓ рдХрд┐рд╕реА рднреА рдорд╛рдорд▓реЗ рдореЗрдВ рдПрдХ рддрдерд╛рдХрдерд┐рдд рд╡рд┐рдЪрд╛рд░ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЖрдкрдХреЛ рдпрд╣ рдзреНрдпрд╛рди рд░рдЦрдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдХрд┐рд╕ рдкрддреЗ рдкрд░ рдХрд╛рдо рдкрд╣рд▓реЗ рд╣реА рд╣реЛ рдЪреБрдХрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдореЗрд░реА рдЗрдЪреНрдЫрд╛ рд╣реИ <code>valid</code> рд╕рдВрднрд╡ рд╣реЛ <code>valid</code> рд╡реИрдзрд╛рдирд┐рдХ рдореВрд▓реНрдпреЛрдВ рдХреЛ рдорд╛рдиреНрдп рдХрд░реЗрдВред  рдпрд╣ рдареАрдХ рд╡реИрд╕рд╛ рд╣реА рд╣реИ рдЬреИрд╕рд╛ рдХрд┐ рдирд┐рд╢реНрдЪрд┐рдд рдЖрдХрд╛рд░ рдХреЗ рд╡реИрд╢реНрд╡рд┐рдХ рдЪрд░реЛрдВ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </p><br><p>  рдирддреАрдЬрд╛ рдПрдХ рдЕрдореВрд░реНрдд рд╡рд░реНрдЧ <code>BpfCircuitConstructor</code> , рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдХреЛрдИ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдирд╣реАрдВ рд╣реИрдВ <code>doMemLoad</code> , <code>doMemStore</code> рдФрд░ <code>resolveSymbol</code> : </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... sealed abstract class LdStType(val lgsize: Int) { val byteSize = 1 &lt;&lt; lgsize val bitSize = byteSize * 8 val mask: UInt = if (bitSize == 64) mask64 else ((1l &lt;&lt; bitSize) - 1).U } case object u8 extends LdStType(0) case object u16 extends LdStType(1) case object u32 extends LdStType(2) case object u64 extends LdStType(3) def doMemLoad(addr: UInt, tpe: LdStType, valid: Bool): (UInt, Bool) def doMemStore(addr: UInt, tpe: LdStType, data: UInt, valid: Bool): Bool sealed trait Resolved { def asPlainValue: UInt def load(ctx: Context, offset: Int, tpe: LdStType, valid: Bool): LazyData def store(offset: Int, tpe: LdStType, data: UInt, valid: Bool): Bool } def resolveSymbol(sym: BpfLoader.Symbol): Resolved // ... }</span></span></code> </pre> <br><h2 id="integraciya-s-processornym-yadrom">  рд╕реАрдкреАрдпреВ рдХреЛрд░ рдПрдХреАрдХрд░рдг </h2><br><p>  рд╢реБрд░реБрдЖрдд рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рд╕рд░рд▓ рддрд░реАрдХреЗ рд╕реЗ рдЬрд╛рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛: рдорд╛рдирдХ RoCC (рд░реЙрдХреЗрдЯ рдХрд╕реНрдЯрдо рдХреЙрдкреНрд░реЗрд╕рд░) рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛрд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВред  рдЬрд╣рд╛рдВ рддрдХ тАЛтАЛрдореИрдВ рд╕рдордЭрддрд╛ рд╣реВрдВ, рдпрд╣ рд╕рднреА рдЖрд░рдЖрдИрдПрд╕рд╕реА-рд╡реА-рд╕рдВрдЧрдд рдХрд░реНрдиреЗрд▓ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ, рдмрд▓реНрдХрд┐ рдХреЗрд╡рд▓ рд░реЙрдХреЗрдЯ рдФрд░ рдмреЙрдо (рдмрд░реНрдХрд▓реЗ рдЖрдЙрдЯ-рдСрдл-рдСрд░реНрдбрд░ рдорд╢реАрди) рдХреЗ рд▓рд┐рдП рдПрдХ рдирд┐рдпрдорд┐рдд рд╡рд┐рд╕реНрддрд╛рд░ рд╣реИ, рдЗрд╕рд▓рд┐рдП, рдЬрдм <code>custom0</code> рдкрд░ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдХрд╛рд░реНрдп рдХреЛ рдЦреАрдВрдЪрддреЗ рд╣реИрдВ, рддреЛ рдХреЛрдбрд╛рдВрддрд░рдХ <code>custom0</code> mnemonics рдЙрдирдореЗрдВ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ - <code>custom3</code> рддреНрд╡рд░рдХ рдХрдорд╛рдВрдб рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИред </p><br><p>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдкреНрд░рддреНрдпреЗрдХ рд░реЙрдХреЗрдЯ / BOOM рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛрд░ рдореЗрдВ рдЪрд╛рд░ RoCC рддреНрд╡рд░рдХ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдХрд┐ рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬреЛрдбрд╝реЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЙрджрд╛рд╣рд░рдг рднреА рд╣реИрдВ: </p><br><p>  <strong>Configs.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WithRoccExample</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(site, here, up</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BuildRoCC</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>( (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> accumulator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AccumulatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom0, n = <span class="hljs-number"><span class="hljs-number">4</span></span>)(p)) accumulator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> translator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">TranslatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom1)(p)) translator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> counter = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">CharacterCountExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom2)(p)) counter }) })</code> </pre> <br><p>  рдЗрд╕реА рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди <code>LazyRoCC.scala</code> рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╣реИред </p><br><p>  рддреНрд╡рд░рдХ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдореЛрд░реА рдирд┐рдпрдВрддреНрд░рдХ рд╕реЗ рдкрд╣рд▓реЗ рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рджреЛ рд╡рд░реНрдЧреЛрдВ рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддрд╛ рд╣реИ: рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ <code>LazyRoCC</code> , <code>LazyRoCCModuleImp</code> рд╕реЗ рджреВрд╕рд░реЗ рд╕реЗ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓рд╛ рд╣реИред  рджреВрд╕рд░реЗ рд╡рд░реНрдЧ рдореЗрдВ рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ <code>io</code> рдкреЛрд░реНрдЯ рд╣реИ <code>RoCCIO</code> , рдЬрд┐рд╕рдореЗрдВ <code>cmd</code> рдЕрдиреБрд░реЛрдз рдкреЛрд░реНрдЯ, рд░рд┐рд╕реНрдкрд╛рдВрд╕ рдкреЛрд░реНрдЯ, рдореЗрдо рдПрдХреНрд╕реЗрд╕ L1D рдХреИрд╢ рдкреЛрд░реНрдЯ, <code>busy</code> рдФрд░ <code>interrupt</code> рдЖрдЙрдЯрдкреБрдЯ рдФрд░ <code>exception</code> рдЗрдирдкреБрдЯ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред  рдПрдХ рдкреЗрдЬ рдЯреЗрдмрд▓ рд╡реЙрдХрд░ рдкреЛрд░реНрдЯ рдФрд░ FPUs рднреА рд╣реИрдВ рдЬрд┐рдирдХреА рд╣рдореЗрдВ рдЕрднреА рддрдХ рдЬрд░реВрд░рдд рдирд╣реАрдВ рд╣реИ (рд╡реИрд╕реЗ рднреА, eBPF рдореЗрдВ рдХреЛрдИ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЕрдВрдХрдЧрдгрд┐рдд рдирд╣реАрдВ рд╣реИ)ред  рдЕрдм рддрдХ рдореИрдВ рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЗ рд╕рд╛рде рдХреБрдЫ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ, рдЗрд╕рд▓рд┐рдП рдореИрдВрдиреЗ рдЯрдЪ <code>interrupt</code> рдирд╣реАрдВ рдХрд┐рдпрд╛ред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВ рдЗрд╕реЗ рд╕рдордЭрддрд╛ рд╣реВрдВ, рдЧреИрд░-рдХреИрд╢реНрдб рдореЗрдореЛрд░реА рдПрдХреНрд╕реЗрд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯрд╛рдЗрд▓рд▓рд┐рдВрдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрднреА рдХреЗ рд▓рд┐рдП рдореИрдВ рдЗрд╕реЗ рд╕реНрдкрд░реНрд╢ рдирд╣реАрдВ рдХрд░реВрдВрдЧрд╛ред </p><br><h2 id="uporyadochivatel-zaprosov">  рдХреНрд╡реЗрд░реА рдЖрдпреЛрдЬрдХ </h2><br><p>  рдЗрд╕рд▓рд┐рдП, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдХреИрд╢ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЛрд░реНрдЯ рд╣реИ, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ рдПрдХред  рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ, рдПрдХ рдлрд╝рдВрдХреНрд╢рди, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдЪрд░ рдмрдврд╝рд╛ рд╕рдХрддрд╛ рд╣реИ (рдЬреЛ, рдмрд╣реБрдд рдХрдо рд╕реЗ рдХрдо, рдПрдХ рдПрдХрд▓ рдкрд░рдорд╛рдгреБ рдСрдкрд░реЗрд╢рди рдореЗрдВ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ) рдпрд╛ рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдХрд┐рд╕реА рднреА рддрд░рд╣ рдЗрд╕реЗ рд▓реЛрдб рдХрд░рдиреЗ, рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдФрд░ рд╕рд╣реЗрдЬрдиреЗ рд╕реЗ рдЗрд╕реЗ nontrivially рд░реВрдкрд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВред  рдЕрдВрдд рдореЗрдВ, рдПрдХ рдПрдХрд▓ рдирд┐рд░реНрджреЗрд╢ рдХрдИ рдЕрд╕рдВрдмрдВрдзрд┐рдд рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИред  рдкреНрд░рджрд░реНрд╢рди рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╢рд╛рдпрдж рдпрд╣ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рд╡рд┐рдЪрд╛рд░ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди, рджреВрд╕рд░реА рдУрд░, рдХреНрдпреЛрдВ рдирд╣реАрдВ, рдХрд╣рддреЗ рд╣реИрдВ, рддреАрди рд╢рдмреНрджреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░реЗрдВ (рдЬреЛ рдХрд┐, рд╕рдВрднрд╡рддрдГ, рдХреИрд╢ рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╣реИрдВ), рдХрд┐рд╕реА рддрд░рд╣ рдЙрдиреНрд╣реЗрдВ рд╕рдВрдпреЛрдЬрди рддрд░реНрдХ рдХреЗ рд╕рд╛рде <strong>рд╕рдорд╛рдирд╛рдВрддрд░ рдореЗрдВ</strong> рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░реЗрдВ (рддрдм рдПрдХ рд╣рд░рд╛) рдФрд░ рдкрд░рд┐рдгрд╛рдо рдмрдЪрд╛рдУред  рдЗрд╕рд▓рд┐рдП, рд╣рдореЗрдВ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХреА рд╕реНрдХреАрдо рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ рдХрд┐ рдПрдХрд▓ рдХреИрд╢ рдкреЛрд░реНрдЯ рдХреЗ рд╕рдорд╛рдирд╛рдВрддрд░ рдкрд╣реБрдВрдЪ рдкрд░ рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ "рд╣рд▓" рдкреНрд░рдпрд╛рд╕ рдХрд░реЗред </p><br><p>  рддрд░реНрдХ рд▓рдЧрднрдЧ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реЛрдВрдЧреЗ: рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрдк-рдЗрдВрдЬреЗрдХреНрд╢рди (RoCC рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдПрдХ 7-рдмрд┐рдЯ рдлрд╝рдВрдХреНрд╢рдирд▓ рдлрд╝реАрд▓реНрдб) рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ, рдХреНрд╡реЗрд░реА рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬрд╝рд░ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдПрдХ рд╡реИрд╢реНрд╡рд┐рдХ рдореБрдЭреЗ рдмрд╣реБрдд рд╣рд╛рдирд┐рдХрд╛рд░рдХ рд▓рдЧрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЙрди рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рдмреАрдЪ рдЕрддрд┐рд░рд┐рдХреНрдд рдирд┐рд░реНрднрд░рддрд╛ рдХрд╛ рдПрдХ рдЧреБрдЪреНрдЫрд╛ рдмрдирд╛рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдХрднреА рднреА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдФрд░) рд╕реНрдХреНрд╡реИрдВрдбрд░ Fmax рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ)ред  рдЕрдЧрд▓рд╛, рдкреНрд░рддреНрдпреЗрдХ "рд╕реЗрд╡рд░" / "рд▓реЛрдбрд░" рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдЬреЛ рдХрд┐ рдзрд╛рд░рд╛рд╡рд╛рд╣рд┐рдХ рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рд╣реИред  рдПрдХ рдЬреАрд╡рд┐рдд рдХрддрд╛рд░ рдореЗрдВ, рдЗрд╕рд▓рд┐рдП рдмреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдПред  рдкреНрд░рддреНрдпреЗрдХ рдЙрдкрд╛рдп рдкрд░, рдкрдВрдЬреАрдХрд░рдг рдЖрджреЗрд╢ рдореЗрдВ рдкрд╣рд▓рд╛ рдЕрдиреБрд░реЛрдз рдЪреБрдирд╛ рдЬрд╛рддрд╛ рд╣реИ - рдЙрд╕реЗ <strong>рдЕрдЧрд▓реЗ рдЙрдкрд╛рдп рдкрд░</strong> рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛рддреА рд╣реИред  рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ, рдЗрд╕ рддрд░рд╣ рдХреЗ рддрд░реНрдХ рдХреЛ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХреЗ рд╕рд╛рде рдХрд╡рд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдореИрдВ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЕрднреА рддрдХ рдЙрдирдореЗрдВ рд╕реЗ рдмрд╣реБрдд рдХреБрдЫ рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рд┐рд░реНрдл рд╕рддреНрдпрд╛рдкрди рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдХрдо рд╕реЗ рдХрдо рдХреБрдЫ рд╕рдордЭрджрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдиреНрдпреВрдирддрдо рд╕реЗрдЯ)ред  рдореИрдВрдиреЗ <code>PeekPokeTester</code> рдбрд┐рдЬрд╛рдЗрдиреЛрдВ рдХреЗ рдкрд░реАрдХреНрд╖рдг рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рдпрд╛ рдХрдо рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдШрдЯрдХ рд╕реЗ рдорд╛рдирдХ <code>PeekPokeTester</code> рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ред  рдореИрдВрдиреЗ рдкрд╣рд▓реЗ рд╣реА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдПрдХ рдмрд╛рд░ рдЗрд╕рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛ рдерд╛</a> ред </p><br><p>  рдкрд░рд┐рдгрд╛рдо рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрдХ рдЧрд░реНрднрдирд┐рд░реЛрдзрдХ рдерд╛: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializer</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">isComputing: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span><span class="hljs-class"><span class="hljs-params">, next: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">monotonic</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = <span class="hljs-type"><span class="hljs-type">WireInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> prevRes = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) prevRes := res &amp;&amp; isComputing res := (x || prevRes) &amp;&amp; isComputing res } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noone</span></span></span></span>(bs: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = !bs.foldLeft(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>)(_ || _) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> previousReqs = <span class="hljs-type"><span class="hljs-type">ArrayBuffer</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextReq</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">Bool</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> enable = monotonic(x) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> retired = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doRetire = result &amp;&amp; next <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> thisReq = enable &amp;&amp; !retired &amp;&amp; !doRetire <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> reqWon = thisReq &amp;&amp; noone(previousReqs) when (isComputing) { when(reqWon) { result := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } when(doRetire) { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } } otherwise { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } previousReqs += thisReq (result, previousReqs.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) } }</code> </pre> <br><p>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣рд╛рдВ рдбрд┐рдЬрд┐рдЯрд▓ рд╕рд░реНрдХрд┐рдЯ рдмрдирд╛рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ, рд╕реНрдХрд╛рд▓рд╛ рдХреЛрдб рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдпрджрд┐ рдЖрдк рдПрдХ рдХрд░реАрдм рд╕реЗ рджреЗрдЦрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдПрдХ <code>ArrayBuffer</code> рднреА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рд╕рд░реНрдХрд┐рдЯ рдХреЗ рдЯреБрдХрдбрд╝реЗ рдвреЗрд░ рд╣реЛ рдЧрдП рд╣реИрдВ ( <code>Boolean</code> <code>ArrayBuffer</code> рд╕реЗ рдПрдХ рдкреНрд░рдХрд╛рд░ рд╣реИ, <code>Bool</code> рдПрдХ рдЫреЗрдиреА рдкреНрд░рдХрд╛рд░ рд╣реИ рдЬреЛ рд▓рд╛рдЗрд╡ рдЙрдкрдХрд░рдг рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддрд╛ рд╣реИ, рди рдХрд┐ рдХреБрдЫ рдмреВрд▓рд┐рдпрди рд░рдирдЯрд╛рдЗрдо рдХреЗ рд▓рд┐рдП рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ)ред </p><br><h2 id="rabota-s-l1d-keshom">  L1D рдХреИрд╢ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ </h2><br><p>  рдХреИрд╢ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдЬреНрдпрд╛рджрд╛рддрд░ <code>io.mem.req</code> рдЕрдиреБрд░реЛрдз <code>io.mem.req</code> рдФрд░ <code>io.mem.resp</code> рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ <code>io.mem.resp</code> рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛрддрд╛ рд╣реИред  рдЙрд╕реА рд╕рдордп, рдЕрдиреБрд░реЛрдз рдкреЛрд░реНрдЯ рдкрд╛рд░рдВрдкрд░рд┐рдХ <code>ready</code> рдФрд░ <code>valid</code> рд╕рдВрдХреЗрддреЛрдВ рд╕реЗ рд╕реБрд╕рдЬреНрдЬрд┐рдд рд╣реИ: рдкрд╣рд▓рд╛ рдЖрдкрдХреЛ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдЕрдиреБрд░реЛрдз рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИ, рджреВрд╕рд░рд╛ рд╣рдо рдХрд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЕрдиреБрд░реЛрдз рддреИрдпрд╛рд░ рд╣реИ рдФрд░ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕рд╣реА рд╕рдВрд░рдЪрдирд╛ рд╣реИ, рд╕рд╛рдордиреЗ, <code>valid &amp;&amp; resp</code> рдЕрдиреБрд░реЛрдз рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдРрд╕реЗ рдХреБрдЫ рдЗрдВрдЯрд░рдлреЗрд╕ рдореЗрдВ, рд╕реЗрдЯрд┐рдВрдЧ рдХреЗ рдХреНрд╖рдг рд╕реЗ рд▓реЗрдХрд░ <code>true</code> рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рдХреЗ <code>valid &amp;&amp; resp</code> рдмрдврд╝рдд рдХреЗ рд╕рдХрд╛рд░рд╛рддреНрдордХ рдмрд┐рдВрджреБ рддрдХ рд╕рдВрдХреЗрддреЛрдВ рдХреА "рдЧреИрд░-рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛" рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ (рдпрд╣ рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП <code>fire()</code> рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ <code>valid &amp;&amp; resp</code> рдЬрд╛ рд╕рдХрддреА рд╣реИ)ред </p><br><p>  рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреЛрд░реНрдЯ, рдмрджрд▓реЗ рдореЗрдВ, рдХреЗрд╡рд▓ рдПрдХ <code>valid</code> рд╕рдВрдХреЗрдд рд╣реИ, рдФрд░ рдпрд╣ рдПрдХ рдШрдбрд╝реА рдЪрдХреНрд░ рдореЗрдВ рдЬрд╡рд╛рдмреЛрдВ рдХреЛ рд░реЗрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреА рд╕рдорд╕реНрдпрд╛ рд╣реИ: рдпрд╣ "рд╣рдореЗрд╢рд╛ рддреИрдпрд╛рд░" рд╣реЛрддрд╛ рд╣реИ, рдзрд╛рд░рдгрд╛ рджреНрд╡рд╛рд░рд╛, рдФрд░ <code>fire()</code> рд╕рд┐рд░реНрдл <code>valid</code> ред </p><br><p>  рд╕рд╛рде рд╣реА, рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдХрд╣рд╛ рдерд╛, рдЬрдм рдЖрдк рднрдпрд╛рдирдХ рд╣реЛрдВ рддреЛ рдЖрдк рдЕрдиреБрд░реЛрдз рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: рдЖрдк рдХреБрдЫ рдирд╣реАрдВ рд▓рд┐рдЦ рд╕рдХрддреЗ, рдореБрдЭреЗ рдирд╣реАрдВ рдкрддрд╛ рдХрд┐ рдХреНрдпрд╛ рдкрдврд╝рд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рд╕реЗ рдкрдврд╝рд╛ рдЧрдпрд╛ рдЬреЛ рдШрдЯрд╛рдП рдЧрдП рдореВрд▓реНрдп рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдмрд╛рдж рдореЗрдВ рд▓рд┐рдЦрд╛ рдЬрд╛рдПрдЧрд╛ рд╡рд╣ рднреА рдХрд┐рд╕реА рддрд░рд╣ рдЕрдЬреАрдм рд╣реИред  рд▓реЗрдХрд┐рди <code>Serializer</code> рд╡рд░реНрдЧ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЗрд╕реЗ рд╕рдордЭрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдо рдХреЗрд╡рд▓ рдпрд╣ рд╕рдВрдХреЗрдд рджреЗрддреЗ рд╣реИрдВ рдХрд┐ рд╡рд░реНрддрдорд╛рди рдЕрдиреБрд░реЛрдз рдкрд╣рд▓реЗ рд╣реА рдХреИрд╢ рдореЗрдВ рдЪрд▓рд╛ рдЧрдпрд╛ рд╣реИ: <code>next = io.mem.req.fire()</code> ред  рдпрд╣ рд╕рдм рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ "рд░реАрдбрд░" рдореЗрдВ рдЙрддреНрддрд░ рдХреЗрд╡рд▓ рддрднреА рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рд╡рд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЖрдпрд╛ рдерд╛ - рдкрд╣рд▓реЗ рдирд╣реАрдВ рдФрд░ рдмрд╛рдж рдореЗрдВ рдирд╣реАрдВред  рдЗрд╕рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ <code>holdUnless</code> рд╡рд┐рдзрд┐ рд╣реИред  рдкрд░рд┐рдгрд╛рдо рд▓рдЧрднрдЧ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╣реИ: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constructor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serializer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Serializer</span></span>(isComputing, io.mem.req.fire()) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemLoad</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">UInt</span></span>, <span class="hljs-type"><span class="hljs-type">Bool</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doResp = isComputing &amp;&amp; serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) &amp;&amp; io.mem.resp.valid &amp;&amp; io.mem.resp.bits.tag === thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> &amp;&amp; io.mem.resp.bits.cmd === <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> (io.mem.resp.bits.data holdUnless doResp, serializer.monotonic(doResp)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemStore</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, data: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XWR</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := data io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolveSymbol</span></span></span></span>(sym: <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>): <span class="hljs-type"><span class="hljs-type">Resolved</span></span> = sym <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>(symName, _, size, <span class="hljs-type"><span class="hljs-type">ElfConstants</span></span>.<span class="hljs-type"><span class="hljs-type">Elf64_Shdr</span></span>.<span class="hljs-type"><span class="hljs-type">SHN_COMMON</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> size &lt;= <span class="hljs-number"><span class="hljs-number">8</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">RegisterReference</span></span>(regs.getOrElseUpdate(symName, <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>(<span class="hljs-number"><span class="hljs-number">64.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)))) } }</code> </pre> <br><p>  рдЗрд╕ рд╡рд░реНрдЧ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдкреНрд░рддреНрдпреЗрдХ рдЙрддреНрдкрдиреНрди рдЙрдк-рдирд┐рд░реНрдорд╛рдг рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред </p><br><h2 id="ne-vsyo-to-v-kuche-chto-globalnaya-peremennaya">  рдвреЗрд░ рдкрд░ рд╕рднреА рдПрдХ рд╡реИрд╢реНрд╡рд┐рдХ рдЪрд░ рдирд╣реАрдВ рд╣реИ </h2><br><p>  рд╣рдореНрдо, рдПрдХ рдореЙрдбрд▓ рдЙрджрд╛рд╣рд░рдг рдХреНрдпрд╛ рд╣реИ?  рдореИрдВ рдХрд┐рд╕ рдкреНрд░рджрд░реНрд╢рди рдХреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛?  рдмреЗрд╢рдХ, рдПрдПрдлрдПрд▓ рдЗрдВрд╕реНрдЯреНрд░реВрдореЗрдВрдЯреЗрд╢рди!  рдпрд╣ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдХреНрд▓рд╛рд╕рд┐рдХ рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; extern uint8_t *__afl_area_ptr; extern uint64_t prev; void inst_branch(uint64_t tag) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; }</span></span></span></span></code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рдореЗрдВ <code>__afl_area_ptr</code> рд╕реЗ рдПрдХ рдмрд╛рдЗрдЯ рдХрд╛ рдХрдореЛрдмреЗрд╢ рд▓реЙрдЬрд┐рдХрд▓ рд▓реЛрдбрд┐рдВрдЧ рдФрд░ рд╕реЗрд╡рд┐рдВрдЧ (рдФрд░ рдЙрдирдХреЗ рдмреАрдЪ рдПрдХ рдЗрдиреНрдХреНрд░реАрдореЗрдВрдЯ) рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣рд╛рдБ рд░рдЬрд┐рд╕реНрдЯрд░ <code>__afl_area_ptr</code> рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рдХрд╣ рд░рд╣рд╛ рд╣реИ! </p><br><p>  рдпрд╣реА рдХрд╛рд░рдг рд╣реИ рдХрд┐ <code>Resolved</code> рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: рдпрд╣ рдпрд╛ рддреЛ рдПрдХ рдирд┐рдпрдорд┐рдд рдореЗрдореЛрд░реА рдПрдбреНрд░реЗрд╕ рдХреЛ рд▓рдкреЗрдЯ рд╕рдХрддрд╛ рд╣реИ рдпрд╛ рдПрдХ рд░рдЬрд┐рд╕реНрдЯрд░ рд╕рдВрджрд░реНрдн рд╣реЛ рд╕рдХрддрд╛ рд╣реИред  рдЙрд╕реА рд╕рдордп, рдЕрдм рддрдХ рдореИрдВ рдХреЗрд╡рд▓ рдЖрдХрд╛рд░ рдореЗрдВ 1, 2, 4 рдпрд╛ 8 рдмрд╛рдЗрдЯреНрд╕ рдХреЗ рд╕реНрдХреЗрд▓рд░ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рддрд╛ рд╣реВрдВ, рдЬреЛ рд╣рдореЗрд╢рд╛ рд╢реВрдиреНрдп рдСрдлрд╕реЗрдЯ рдкрд░ рдкрдврд╝реЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЗ рд▓рд┐рдП, рдЖрдк рдХреЙрд▓ рдХреЗ рдЖрджреЗрд╢ рдХреЛ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рд╢рд╛рдВрддрд┐ рд╕реЗ рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ рдЬрд╛рдирдирд╛ рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рд╣реИ рдХрд┐ <code>prev</code> рдХреЛ рдкрд╣рд▓реЗ рдШрдЯрд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рд╕реВрдЪрдХрд╛рдВрдХ рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рд╣реА рдлрд┐рд░ рд╕реЗ рд▓рд┐рдЦрд╛ рдЬрд╛рдПрдЧрд╛ред </p><br><h2 id="a-teper-instrumentaciya">  рдФрд░ рдЕрдм рдЗрдВрд╕реНрдЯреНрд░реВрдореЗрдВрдЯреЗрд╢рди </h2><br><p>  рдХреБрдЫ рдмрд┐рдВрджреБ рдкрд░, рд╣рдореЗрдВ RoCC рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЗ рд╕рд╛рде рдПрдХ рдЕрд▓рдЧ рдФрд░ рдХрдо рдпрд╛ рдЕрдзрд┐рдХ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рддреНрд╡рд░рдХ рдорд┐рд▓рд╛ред  рдЕрдм рдХреНрдпрд╛?  рдкреНрд░реЛрд╕реЗрд╕рд░ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдзрдХреЗрд▓рддреЗ рд╣реБрдП рд╕рднреА рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓рд╛рдЧреВ рдХрд░реЗрдВ?  рдореБрдЭреЗ рдРрд╕рд╛ рдкреНрд░рддреАрдд рд╣реБрдЖ рдХрд┐ рдХрдо рдмреИрд╕рд╛рдЦреА рдХреА рдЬрд░реВрд░рдд рд╣реЛрдЧреА, рдпрджрд┐ рдирд┐рд░реНрджреЗрд╢ рдХреЗ рдирд┐рд░реНрджреЗрд╢ рдХреЗ рд╕рдорд╛рдирд╛рдВрддрд░, рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЬрд╛рд░реА рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдорд╛рди рдХреЗ рд╕рд╛рде <code>funct</code> рдмрд╕ рд╕рдХреНрд░рд┐рдп рд╣реЛ рдЬрд╛рдПрдЧрд╛ред  рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ, рдореБрдЭреЗ рдЗрд╕рдХреЗ рд▓рд┐рдП рдЦреБрдж рдХреЛ рддрдбрд╝рдкрд╛рдирд╛ рдкрдбрд╝рд╛: рдореИрдВрдиреЗ рд╕рд┐рдЧреНрдирд▓рдЯреИрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рднреА рд╕реАрдЦ рд▓рд┐рдпрд╛, рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рдмрдЧрд┐рдВрдЧ рд▓рдЧрднрдЧ рдЕрдВрдзрд╛ рд╣реИ, рдФрд░ рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдорд╛рдореВрд▓реА рдмрджрд▓рд╛рд╡ рдХреЗ рдмрд╛рдж рдкрд╛рдВрдЪ рдорд┐рдирдЯ рдХреЗ рдкреБрдирд░реНрд╕рдВрдпреЛрдЬрди рдХреЗ рд╕рд╛рде (рдмреВрдЯреНрд░реЛрдо рдмрджрд▓рдиреЗ рдХреЗ рдЕрдкрд╡рд╛рдж рдХреЗ рд╕рд╛рде - рд╡рд╣рд╛рдВ рд╕рдм рдХреБрдЫ рддреЗрдЬ рд╣реИ - рдпрд╣ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдмрд╣реБрдд рдЕрдзрд┐рдХ рд╣реИред </p><br><p>  рдирддреАрдЬрддрди, рдХрдорд╛рдВрдб рдбрд┐рдХреЛрдбрд░ рдХреЛ рдШреБрдорд╛рдпрд╛ рдЧрдпрд╛ рдФрд░ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХреЛ рдереЛрдбрд╝рд╛ "рд╕реАрдзрд╛" рдХрд┐рдпрд╛ рдЧрдпрд╛, рдЗрд╕ рддрдереНрдп рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдореВрд▓ рдирд┐рд░реНрджреЗрд╢ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдбрд┐рдХреЛрдбрд░ рдиреЗ рдЬреЛ рднреА рдХрд╣рд╛, рд╡рд╣ рдЦреБрдж рдХреЛ рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рд╕рдХреНрд░рд┐рдп рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдЖрдЙрдЯрдкреБрдЯ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЗ рд▓рд┐рдП рдПрдХ рд▓рдВрдмрд╛ рд╡рд┐рд▓рдВрдмрд┐рдд рд▓реЗрдЦрди рд╣реЛрдЧрд╛, рдЬреИрд╕рд╛ рдХрд┐ рдбрд┐рд╡реАрдЬрди рдСрдкрд░реЗрд╢рди рдХреЗ рджреМрд░рд╛рди рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдбреЗрдЯрд╛ рдХреИрд╢ рдпрд╛рдж рдЖрддреА рд╣реИред </p><br><p>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдПрдХ рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рд╡рд┐рд╡рд░рдг рдПрдХ рдЬреЛрдбрд╝реА рд╣реИ ([рдПрдХ рдирд┐рд░реНрджреЗрд╢ рдХреЛ рдкрд╣рдЪрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдкреИрдЯрд░реНрди], [рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛрд░ рдХреЗ рдбреЗрдЯрд╛ рдкрде рдмреНрд▓реЙрдХреЛрдВ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдореВрд▓реНрдпреЛрдВ рдХрд╛ рд╕реЗрдЯ])ред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <code>default</code> (рдЕрдкрд░рд┐рдЪрд┐рдд рдирд┐рд░реНрджреЗрд╢) рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ (рдЬреИрд╕рд╛ рдХрд┐ рдпрд╣ <code>IDecode.scala</code> рд╕реЗ рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдбреЗрд╕реНрдХрдЯреЙрдк рд╣реЗрдмрд░ рдореЗрдВ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ, рдмрджрд╕реВрд░рдд рджрд┐рдЦрддрд╛ рд╣реИ): </p><br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">default</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// jal renf1 fence.i // val | jalr | renf2 | // | fp_val| | renx2 | | renf3 | // | | rocc| | | renx1 s_alu1 mem_val | | | wfd | // | | | br| | | | s_alu2 | imm dw alu | mem_cmd mem_type| | | | mul | // | | | | | | | | | | | | | | | | | | | | | div | fence // | | | | | | | | | | | | | | | | | | | | | | wxd | | amo // | | | | | | | | scie | | | | | | | | | | | | | | | | | dp List(N,X,X,X,X,X,X,X,X,A2_X, A1_X, IMM_X, DW_X, FN_X, N,M_X, MT_X, X,X,X,X,X,X,X,CSR.X,X,X,X,X)</span></span></code> </pre> <br><p>  ... рдФрд░ рд░реЙрдХреЗрдЯ рдХреЛрд░ рдореЗрдВ <em>рдПрдХ рдПрдХреНрд╕рдЯреЗрдВрд╢рди</em> рдХрд╛ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╡рд┐рд╡рд░рдг рдЗрд╕ рддрд░рд╣ рд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDecode</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecodeConstants</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> table: <span class="hljs-type"><span class="hljs-type">Array</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = <span class="hljs-type"><span class="hljs-type">Array</span></span>( <span class="hljs-type"><span class="hljs-type">BNE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SNE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BEQ</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SEQ</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLT</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLT</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLTU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLTU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGEU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGEU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p>  рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ RISC-V рдореЗрдВ (рди рдХреЗрд╡рд▓ RocketChip рдореЗрдВ, рдмрд▓реНрдХрд┐ рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ рдХрдорд╛рдВрдб рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдореЗрдВ) ISA рд╡рд┐рднрд╛рдЬрди рдХреЛ рдЕрдирд┐рд╡рд╛рд░реНрдп рд╕рдмреНрдорд┐рдЯ I (рдкреВрд░реНрдгрд╛рдВрдХ рд╕рдВрдЪрд╛рд▓рди), рд╕рд╛рде рд╣реА рд╡реИрдХрд▓реНрдкрд┐рдХ M (рдкреВрд░реНрдгрд╛рдВрдХ рдЧреБрдгрди рдФрд░ рд╡рд┐рднрд╛рдЬрди), A (рдПрдЯреЙрдорд┐рдХреНрд╕) рдкрд░ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рд╕рдорд░реНрдерд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЖрджрд┐ </p><br><p>  рдирддреАрдЬрддрди, рдореВрд▓ рд╡рд┐рдзрд┐ </p><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs = <span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> <br><p>  рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ </p><br><div class="spoiler">  <b class="spoiler_title">рд╡рд╣реА, рд▓реЗрдХрд┐рди рдЗрдВрд╕реНрдЯреНрд░реВрдореЗрдВрдЯреЗрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рдбрд┐рдХреЛрдбрд░ рдФрд░ рдЖрд░рдУрд╕реА рдХреЗ рд╕рдХреНрд░рд┐рдпрдг рдХрд╛ рдХрд╛рд░рдг рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])], handlers: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs=<span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc_explicit, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handlers.isEmpty) { handler_rocc := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> handler_rocc_funct := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = handlers.map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>(pattern, funct) =&gt; pattern -&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(funct.<span class="hljs-type"><span class="hljs-type">U</span></span>)) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerDecoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">N</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>)), handlerTable) <span class="hljs-type"><span class="hljs-type">Seq</span></span>(handler_rocc, handler_rocc_funct) zip handlerDecoder map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (s,d) =&gt; s:=d } } rocc := rocc_explicit || handler_rocc <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> </div></div><br><p>  рдкреНрд░реЛрд╕реЗрд╕рд░ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдореЗрдВ рдмрджрд▓рд╛рд╡реЛрдВ рдореЗрдВ рд╕реЗ, рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╕реНрдкрд╖реНрдЯ, рд╢рд╛рдпрдж, рдпрд╣ рдерд╛: </p><br><pre> <code class="diff hljs"> io.rocc.exception := wb_xcpt &amp;&amp; csr.io.status.xs.orR io.rocc.cmd.bits.status := csr.io.status io.rocc.cmd.bits.inst := new RoCCInstruction().fromBits(wb_reg_inst) + when (wb_ctrl.handler_rocc) { + io.rocc.cmd.bits.inst.opcode := 0x0b.U // custom0 + io.rocc.cmd.bits.inst.funct := wb_ctrl.handler_rocc_funct + io.rocc.cmd.bits.inst.xd := false.B + io.rocc.cmd.bits.inst.rd := 0.U + } io.rocc.cmd.bits.rs1 := wb_reg_wdata io.rocc.cmd.bits.rs2 := wb_reg_rs2</code> </pre> <br><p>  рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдПрдХреНрд╕реЗрд▓реЗрд░реЗрдЯрд░ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХреЗ рдХреБрдЫ рдорд╛рдкрджрдВрдбреЛрдВ рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: рдХреЛрдИ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рдирд╣реАрдВ рд▓рд┐рдЦреА рдЧрдИ рд╣реИ, рдФрд░ <code>funct</code> рдХреНрдпрд╛ рдбрд┐рдХреЛрдбрд░ рд╡рд╛рдкрд╕ рдЖрдпрд╛ рдХреЗ рдмрд░рд╛рдмрд░ рд╣реИред  рд▓реЗрдХрд┐рди рдереЛрдбрд╝рд╛ рдХрдо рд╕реНрдкрд╖реНрдЯ рдкрд░рд┐рд╡рд░реНрддрди рд╣реИ: рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рдпрд╣ рдХрдорд╛рдВрдб рд╕реАрдзреЗ рддреНрд╡рд░рдХ (рдЙрдирдореЗрдВ рд╕реЗ рдЪрд╛рд░ - рдЬреЛ рдПрдХ рд╣реИ?) рдкрд░ рдирд╣реАрдВ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд░рд╛рдЙрдЯрд░ рдХреЗ рд▓рд┐рдП, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдпрд╣ рдвреЛрдВрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рдХрдорд╛рдВрдб рдореЗрдВ <code>opcode == custom0</code> (рд╣рд╛рдБ) рдкреНрд░рдХреНрд░рд┐рдпрд╛, рдФрд░ рдпрд╣ рдареАрдХ рд╢реВрдиреНрдп рддреНрд╡рд░рдХ рд╣реИ!)ред </p><br><h2 id="proverka">  рдирд┐рд░реАрдХреНрд╖рдг </h2><br><p>  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдпрд╣ рд▓реЗрдЦ рдПрдХ рдирд┐рд░рдВрддрд░рддрд╛ рдорд╛рдирддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЛ рдЕрдзрд┐рдХ рдпрд╛ рдХрдо рдЙрддреНрдкрд╛рджрди рд╕реНрддрд░ рдкрд░ рд▓рд╛рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рдХрдо рд╕реЗ рдХрдо, рдЖрдкрдХреЛ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд╕реНрд╡рд┐рдЪ рдХрд░рддреЗ рд╕рдордп рд╕рдВрджрд░реНрдн (рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреА рд╕реНрдерд┐рддрд┐) рдХреЛ рдмрдЪрд╛рдиреЗ рдФрд░ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╕реАрдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред  рдЗрд╕ рдмреАрдЪ, рдореИрдВ рдЬрд╛рдВрдЪ рдХрд░реВрдВрдЧрд╛ рдХрд┐ рдпрд╣ рдХрд┐рд╕реА рддрд░рд╣ рдЧреНрд░реАрдирд╣рд╛рдЙрд╕ рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; uint64_t counter; uint64_t funct1(uint64_t x, uint64_t y) { return __builtin_popcountl(x); } uint64_t funct2(uint64_t x, uint64_t y) { return (x + y) * (x - y); } uint64_t instMUL() { counter += 1; *((uint64_t *)0x81005000) = counter; return 0; }</span></span></span></span></code> </pre> <br><p>  рдЕрдм <code>main</code> рд▓рд╛рдЗрди рдореЗрдВ <code>bootrom/sdboot/sd.c</code> рдХреЛ рдЬреЛрдбрд╝реЗрдВ </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/path/to/freedom-u-sdk/riscv-pk/machine/encoding.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// ... ////    -   RoCC #define STR1(x) #x #define STR(x) STR1(x) #define EXTRACT(a, size, offset) (((~(~0 &lt;&lt; size) &lt;&lt; offset) &amp; a) &gt;&gt; offset) #define CUSTOMX_OPCODE(x) CUSTOM_##x #define CUSTOM_0 0b0001011 #define CUSTOM_1 0b0101011 #define CUSTOM_2 0b1011011 #define CUSTOM_3 0b1111011 #define CUSTOMX(X, rd, rs1, rs2, funct) \ CUSTOMX_OPCODE(X) | \ (rd &lt;&lt; (7)) | \ (0x7 &lt;&lt; (7+5)) | \ (rs1 &lt;&lt; (7+5+3)) | \ (rs2 &lt;&lt; (7+5+3+5)) | \ (EXTRACT(funct, 7, 0) &lt;&lt; (7+5+3+5+5)) #define CUSTOMX_R_R_R(X, rd, rs1, rs2, funct) \ asm ("mv a4, %[_rs1]\n\t" \ "mv a5, %[_rs2]\n\t" \ ".word "STR(CUSTOMX(X, 15, 14, 15, funct))"\n\t" \ "mv %[_rd], a5" \ : [_rd] "=r" (rd) \ : [_rs1] "r" (rs1), [_rs2] "r" (rs2) \ : "a4", "a5"); int main(void) { // ... //  RoCC extension write_csr(mstatus, MSTATUS_XS &amp; (MSTATUS_XS &gt;&gt; 1)); //   bootrom       uint64_t res; CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 2); // ...     uint64_t x = 1; for (int i = 0; i &lt; 123; ++i) x *= *(volatile uint8_t *)0x80000000; kputc('0' + x % 10); //   !!! // ... }</span></span></span></span></code> </pre> <br><p>  <code>write_csr</code> ,     <code>custom0</code> - <code>custom3</code> .      ,   illegal instruction,  ,  , ,   .   <code>define</code> -     - ,   ┬л┬╗ binutils  <code>customX</code>      RocketChip,  ,   ,   . </p><br><p>     sdboot  ,       ,      . </p><br><p>  : </p><br><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000000000 in ?? () (gdb) x/d 0x81005000 0x81005000: 123 (gdb) set variable $pc=0x10000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x0000000000010488 in crc16_round (data=&lt;optimized out&gt;, crc=&lt;optimized out&gt;) at sd.c:151 151 crc ^= data; (gdb) x/d 0x81005000 0x81005000: 246</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"> funct1</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000010194 in main () at sd.c:247 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); (gdb) set variable $a5=0 (gdb) set variable $pc=0x10194 (gdb) set variable $a4=0xaa (gdb) display/10i $pc-10 1: x/10i $pc-10 0x1018a &lt;main+46&gt;: sw a3,124(a3) 0x1018c &lt;main+48&gt;: addiw a0,a0,1110 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 =&gt; 0x10194 &lt;main+56&gt;: 0x2f7778b 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; (gdb) display/x $a5 2: /x $a5 = 0x0 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x4 (gdb) set variable $a4=0xaabc (gdb) set variable $pc=0x10194 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x9</code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕реНрд░реЛрдд рдХреЛрдб</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi461577/">https://habr.com/ru/post/hi461577/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi461565/index.html">рдЯрд╛рдЗрдкрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдбреЗрд╡рд▓рдкрд░ рдХреА 5 рдЖрдЬреНрдЮрд╛рдПрдБ</a></li>
<li><a href="../hi461567/index.html">рдПрд╕рдХреНрдпреВрдПрд▓ред рдордиреЛрд░рдВрдЬрдХ рдкрд╣реЗрд▓рд┐рдпрд╛рдБ</a></li>
<li><a href="../hi461569/index.html">рдлреНрд░рдВрдЯ-рдПрдВрдб рдХреЗ рд▓рд┐рдП рдзреНрдпрд╛рди рджреЗрдВ: рдкрд░реАрдХреНрд╖рдг рд╕реЗ рдкрд╣рд▓реЗ рдХреНрдпрд╛ рдЬрд╛рдВрдЪрдирд╛ рд╣реИ</a></li>
<li><a href="../hi461571/index.html">рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЬреАрд╡рди рдореЗрдВ рдПрд╕рд╡реАрдЬреАред рдпреИрдВрдбреЗрдХреНрд╕ рд░рд┐рдкреЛрд░реНрдЯ</a></li>
<li><a href="../hi461575/index.html">рдХрд┐рд╕реА рднреА рдУрдкрдирд╕реНрдЯреИрдХ-рд╕рдВрдЧрдд рд╣реЛрд╕реНрдЯрд┐рдВрдЧ рдкрд░ 3CX рдХреНрд▓рд╛рдЙрдб-рдЖрдзрд╛рд░рд┐рдд PBX рдмрдирд╛рдирд╛</a></li>
<li><a href="../hi461579/index.html">WebMoney рдирдП WMP рд╡реЙрд▓реЗрдЯ рдкреЗрд╢ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЦреЗрд▓ рдХреЗ рдирд┐рдпрдореЛрдВ рдХреЛ рдмрджрд▓рддрд╛ рд╣реИ</a></li>
<li><a href="../hi461583/index.html">рдЕрдЬрдЧрд░ рд╕рдВрд░рдЪрдирд╛рддреНрдордХ рдЙрддреНрдкрд╛рджреЛрдВ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ</a></li>
<li><a href="../hi461587/index.html">10 рдЪрд░рдгреЛрдВ рдореЗрдВ рдЖрд╡реЗрджрди рдХрд╛ рд╕реНрдерд╛рдиреАрдпрдХрд░рдг</a></li>
<li><a href="../hi461589/index.html">рдЯрд┐рдХ рдЯреАрдПрд╕реА рдХреЛ рдкреИрд░ рдХреА рдЕрдВрдЧреБрд▓реА: рд╕рд╛рдордЧреНрд░реА рдЪрдХреНрд░</a></li>
<li><a href="../hi461593/index.html">рдПрдл # рдкрд░ рдПрдкреАрдЖрдИред рдкреНрд░рд╡реЗрд╢ рднреВрдорд┐рдХрд╛ рдЖрдзрд╛рд░рд┐рдд рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдореЙрдбреНрдпреВрд▓</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>