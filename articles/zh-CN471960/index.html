<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏡 ⭐️ 🌷 操作TA505，第二部分：使用NetSupport RAT学习ServHelper后门 🎂 💇🏼 👐🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在2019年7月底，我们发现了一个有趣的TA505恶意软件样本。 在2019年7月22日，它被上传到ANY.RUN进行动态分析。 我们注意到以下事实：除了TA505 Servhelper常用的标签外，在暴露的标签中还出现了netsupport标签，并且在网络签名触发中，还标识了相同的名称NetSup...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>操作TA505，第二部分：使用NetSupport RAT学习ServHelper后门</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/471960/"><img src="https://habrastorage.org/webt/tq/ic/md/tqicmdfgz5vzah4oqw6_i6mwan0.png"><br><br> 在2019年7月底，我们发现了一个有趣<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的TA505恶意软件</a>样本。 在2019年7月22日，它被上传到ANY.RUN进行动态分析。 我们注意到以下事实：除了TA505 Servhelper常用的标签外，在暴露的标签中还出现了netsupport标签，并且在网络签名触发中，还标识了相同的名称NetSupport RAT。 <a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/cs/sq/uk/cssqukxglw4w6ygse7dzg-kw2jw.png"><br><br>  <i>图</i>  <i>1. ANY.RUN在线分析仪中设置的恶意软件和标签的下载日期</i> <br><br><img src="https://habrastorage.org/webt/h9/hd/g8/h9hdg8qo0sxrox1jnippd8ka_zo.png"><br><br>  <i>图</i>  <i>2. ANY.RUN沙箱中的NetSupport RAT上的网络签名触发</i> <br><br> 乍一看，这似乎很奇怪：毕竟，ServHelper组的后门本身具有令人印象深刻的功能，可以控制受害人的PC。 现在是时候详细考虑恶意软件的工作了。 <br><br><h2>  NSIS和PowerShell滴管 </h2><br> 我们的分析从其开始的可执行PE文件是基于Nullsoft可脚本安装系统（NSIS）平台的安装程序。 执行安装过程的NSIS脚本提取并运行嵌入式PowerShell脚本： <br><br><img src="https://habrastorage.org/webt/xt/aj/nu/xtajnurxwbyfsilz4yamr5cckmq.png"><br><br>  <i>图</i>  <i>3. NSIS脚本说明</i> <br><br> 启动的PowerShell脚本包含一个Base64编码的缓冲区（为清楚起见，在下图中将其截断），在解码之后，该缓冲区由CDES模式下的Triple DES（3DES）解密： <br><br><img src="https://habrastorage.org/webt/uo/ow/r0/uoowr0t6nf0s2khnk2blkkgdk8c.png"><br><br>  <i>图</i>  <i>4.在PowerShell脚本中解密数据</i> <br><br> 该脚本的第一部分是一个具有语音名称heller的函数，负责增加系统中的特权并绕过UAC保护。 为此使用了两种技术： <br><br> 方法1：在任务计划程序中使用SilentCleanup任务： <br><br><ul><li>该任务可以由用户启动，但可以使用更高的特权。 任务属性使用％windir％环境变量包含可执行文件的路径。 您可以更改环境变量的值（例如，指定启动PowerShell脚本），然后启动任务将导致以管理员权限执行PowerShell脚本，而不会警告UAC。 </li><li> 攻击者在Windows 8和Windows 10系统上使用此技术。 </li><li> 执行此技术的代码与Metasploit框架<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的</a>模块<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">实现</a>相同。 </li></ul><br><img src="https://habrastorage.org/webt/4n/jo/_s/4njo_svmmajgn-z2xmf5iuddj78.png"><br><br>  <i>图</i>  <i>5.部分脚本具有绕过SilentCleanup任务的技术</i> <br><br> 方法2：使用sysprep.exe系统实用程序和侧面加载DLL技术 <br><br><ul><li> 首先，创建一个帮助程序<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">脚本</a>以重新启动C：\ Windows \ Temp目录中的PowerShell脚本。 然后<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">形成</a>一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CAB归档文件</a> ，其中包含辅助DLL库CRYPTBASE.dll（PowerShell脚本同时包含该库的x86版本和x64版本）。 使用wusa.exe系统实用程序，将此存档解压缩到C：\ Windows \ System32 \ Sysprep目录中。 然后，启动系统实用程序sysprep.exe，它将加载先前解压缩的DLL库，然后依次执行辅助脚本。 因此，PowerShell脚本将以管理员权限重新启动，而不会警告UAC。 </li><li> 攻击者在Windows 7系统上使用此技术。 </li><li> 可以在本文中找到详细说明，并在例如Github上的项目中找到实现示例。 </li></ul><br><img src="https://habrastorage.org/webt/9j/lv/cd/9jlvcdqsqskqepj5qxegbsxapky.png"><br><br>  <i>图</i>  <i>6.部分脚本具有绕过sysprep.exe实用程序的技术</i> <br><br> 脚本中有很多注释，未使用的Test-Administrator函数，一些变量未经初始化就使用：所有这些都是借入代码的标志，而没有仔细检查其简洁性。 <br><br> 使用必需的特权运行脚本后，将执行脚本的第二部分。 在这一阶段，目标有效载荷被解码： <br><br><ul><li> 该字符串由Base64解码， </li><li> 使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Deflate</a>扩展缓冲区 </li><li> 该字符串由Base64重新解码。 </li></ul><br><img src="https://habrastorage.org/webt/er/an/bg/eranbgnpwn2psafs1n0o0i5uv7s.png"><br><br>  <i>图</i>  <i>7.有效载荷解码算法</i> <br><br><ul><li> 结果，将在系统中创建以下文件： </li><li>  ％systemroot％\ help \ hlp11.dat- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RDP包装程序库的</a> x86 / x64版本。 它用于扩展RDP服务的功能，包括几个同时连接的可能性。 重要的是要注意，库已被修改：在执行开始时，行<b>c：\ windows \ help \ hlp12.dat</b>被线性XOR解码，然后将DLL库加载到接收的路径上： </li></ul><br><img src="https://habrastorage.org/webt/vl/ji/xm/vljixm5vye-ncz-p5hkkl-mfpjw.png"><br><br>  <i>图</i>  <i>8.解密DLL库的路径及其加载</i> <br><br><ul><li>  ％systemroot％\ help \ hlp12.dat是ServHelper后门的x86 / x64版本，将在下一节中讨论； </li><li>  ％systemroot％\ help \ hlp13.dat-RDP包装器库的配置文件， </li><li>  ％systemroot％\ system32 \ rdpclip.exe-RDP服务的组件，用于交换剪贴板数据； </li><li>  ％systemroot％\ system32 \ rfxvmt.dll是用于使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RemoteFX</a>技术传输数据的RDP服务组件。 </li></ul><br> 在提取并记录了有效负载之后，脚本将设置其组件的正确操作： <br><br><ul><li> 将rfxvmt.dll组件的所有者更改为NT SERVICE \ TrustedInstaller并授予必要的权限； </li><li> 将RDP连接的端口值从标准3389更改为7201。 </li><li> 将网络服务帐户添加到本地管理员组 </li><li> 将hlp11.dat注册为RDP服务并重新启动该服务； </li><li> 删除创建的临时文件。 </li></ul><br><h2>  ServHelper RAT→滴管 </h2><br> 删除程序的结果之一是hlp12.dat DLL，它是ServHelper恶意软件。 可以根据操作系统的位大小来创建库的x86版本和x64版本（它们之间没有根本区别）。 这两个版本都是用Delphi编写的，与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">UPX 3.95</a> （x64）和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PeCompact 2.20</a> （x86）打包在一起。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Proofpoint</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">趋势科技的</a>同事之前<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">曾对</a>这个后门的分布和操作进行了分析。 我们的示例的功能库在许多方面都与已知的方法趋同：特别是，用于解密使用的字符串的算法（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Vigenere cipher</a> ）没有改变： <br><br><img src="https://habrastorage.org/webt/ul/ms/cy/ulmscymkg-0u1nk02c9kqxz8brs.png"><br><br>  <i>图</i>  <i>9.使用Vigenere密码解密字符串的伪代码</i> <br><br> 有趣的是，并未对所有字符串实施加密：例如，控制域的地址和带有其他组件的Web链接保持打开状态： <br><br><img src="https://habrastorage.org/webt/a-/bd/uu/a-bduux2q7geptwtgyeijtiqpzw.png"><br><br>  <i>图</i>  <i>10.未加密的域和Web链接</i> <br><br> 访问这些链接之一（hxxp：//letitbe.icu/2.txt）时，将下载一个加密文件（MD5：0528104f496dd13438dd764e747d0778）。 在十六进制编辑器中分析文件末尾时，您会注意到字节0x09的值经常重复： <br><br><img src="https://habrastorage.org/webt/gm/1o/9f/gm1o9ff_vl6w12nr0dfxgxu78zu.png"><br><br>  <i>图</i>  <i>11.在下载的文件中重复字节0x09</i> <br><br> 字节值重复是使用单字节XOR进行加密的常见标志。 在这种情况下，该理论可以通过以下代码得到证实： <br><br><img src="https://habrastorage.org/webt/aw/7k/lq/aw7klqin_brodmhtoy7wccnhw9c.png"><br><br>  <i>图</i>  <i>12.单字节异或加密功能</i> <br><br><img src="https://habrastorage.org/webt/bv/pt/vd/bvptvd-axazrevfus5vxogr5kuy.png"><br><br>  <i>图</i>  <i>13.将单字节值作为参数传递给XOR函数</i> <br><br> 解密的结果是，我们将收到包含以下内容的ZIP归档文件： <br><br><img src="https://habrastorage.org/webt/it/oi/w2/itoiw2a-gl6palkqplytqjv4ae4.png"><br><br>  <i>图</i>  <i>14.解密的ZIP存档的内容</i> <br><br> 所有文件都是用于NetSupport Manager PC远程控制的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">合法</a>软件，各个组的攻击者都反复使用过这些文件。 <br><br><img src="https://habrastorage.org/webt/qs/1f/1b/qs1f1b0xwk9zrfddvzixc4mizhy.png"><br><br>  <i>图</i>  <i>15. NetSupport Manager软件说明</i> <br><br> 其中一个文件（client32.ini）是配置文件，其中包含受害人的PC通过其连接到攻击者的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">中间网关</a>的地址： <br><br><img src="https://habrastorage.org/webt/up/ch/fe/upchfeck-veyfpct418q8h1akre.png"><br><br>  <i>图</i>  <i>16.攻击者充当NetSupport Manager网关</i> <br><br> 如果受害者位于防火墙后面，并且Internet访问受端口限制，则此选项才有意义。 要在Internet上正常工作，必须打开对至少两个端口的访问权限：80（HTTP）和443（HTTPS），以便增加成功连接的可能性。 <br><br> 在2019年9月，我们发现了几个类似的ServHelper示例，但选项范围非常有限。 以其中之一为例（MD5：5b79a0c06aec6126364ce1d5cbfedf66）：在可执行PE文件的资源中，具有重复字节形式的具有相似特征的加密数据： <br><br><img src="https://habrastorage.org/webt/ue/iy/tt/ueiytt_k_swonc2vfbnvcrnylos.png"><br><br>  <i>图</i>  <i>17. ServHelper资源中的加密数据</i> <br> 这是一个用一个字节再次“阻塞”的ZIP归档文件，其中包含NetSupport Manager的相同组件，尽管这次具有不同的中间网关：179 [。] 43.146.90：443。 <br><br><h2> 结论 </h2><br> 在本文中，我们研究了TA505后门的交付和使用选项之一-ServHelper。 除了主要组件操作之前的奇怪功能（例如，绕过UAC和提升权限）之外，我们还注意到了主要后门的有趣变形：基本功能（数据盗窃，间谍和命令执行）通过嵌入另一种PC远程控制工具NetSupport RAT进行了补充。 此外，新版本的ServHelper不再具有使其成为完整后门的关键功能：现在，它仅用作安装NetSupport RAT的中间工具。 攻击者可能发现此方法在开发和检测能力方面均更为有效。 但是，我们感兴趣的分组工具列表并不止于此。 <br><br>  <b>由</b>正向技术公司的Alexey Vishnyakov <b>发表</b> <br><div class="spoiler">  <b class="spoiler_title">国际奥委会</b> <div class="spoiler_text">  hxxp：//185.225.17.175/wrkn157.exe-从中加载NSIS滴管的Web链接 <br>  d2a062ca772fa3ace7c7edadbd95eaf7-原始的NSIS滴管 <br>  0cacea3329f35e88a4f9619190e3746f-PowerShell删除程序shipkat.ps1 <br>  fb609b00e29689db74c853ca7d69f440-CRYPTBASE.dll（x86） <br>  843288a35906aa90b2d1cc6179588a26-CRYPTBASE.dll（x64） <br>  445cd6df302610bb640baf2d06438704-hlp11.dat（x86） <br>  083f66cc0e0f626bbcc36c7f143561bd-hlp11.dat（x64） <br>  40bae264ea08b0fa115829c5d74bf3c1-hlp12.dat（x86） <br>  ac72ab230608f2dca1da1140e70c92ad-hlp12.dat（x64） <br>  07f1dc2a9af208e88cb8d5140b54e35e-hlp13.dat <br>  1690e3004f712c75a2c9ff6bcde49461-rdpclip.exe <br>  dc39d23e4c0e681fad7a3e1342a2843c-rfxvmt.dll <br>  ServHelper C2： <br>  179 [。] 43.156.32 <br>  185 [。] 163.45.124 <br>  185 [。] 163.45.175 <br>  185 [。] 225.17.150 <br>  185 [。] 225.17.169 <br>  185 [。] 225.17.175 <br>  185 [。] 225.17.98 <br>  195 [。] 123.221.66 <br>  195 [。] 123.246.192 <br>  37 [。] 252.8.63 <br>  94 [。] 158.245.123 <br>  94 [。] 158.245.154 <br>  94 [。] 158.245.232 <br>  fdguyt5ggs [。] pw <br>  foxlnklnk [。] xyz <br>  gidjshrvz [。] xyz <br>  letitbe [。] icu <br>  pofasfafha [。] xyz <br>  0528104f496dd13438dd764e747d0778-使用NetSupport RAT的加密ZIP存档 <br>  NetSupport Manager组件： <br>  953896600dfb86750506706f1599d415-cksini.exe <br>  8d9709ff7d9c83bd376e01912c734f0a-client32.exe <br>  2d3b207c8a48148296156e5725426c7f-HTCTL32.DLL <br>  0e37fbfa79d349d672456923ec5fbbe3-msvcr100.dll <br>  26e28c01461f7e65c402bdf09923d435-nskbfltr.inf <br>  88b1dab8f4fd1ae879685995c90bd902-NSM.ini <br>  7067af414215ee4c50bfcd3ea43c84f0-NSM.LIC <br>  dcde2248d19c778a41aa165866dd52d0-pcicapi.dll <br>  a0b9388c5f18e27266a31f8c5765b263-PCICHEK.DLL <br>  00587238d16012152c2e951a087f2cc9-PCICL32.DLL <br>  2a77875b08d4d2bb7b654db33a88f16c-remcmdstub.exe <br>  eab603d12705752e3d268d86dff74ed4-TCCTL32.DLL <br>  185 [。] 225.17.66：443-NetSupport RAT网关地址 <br>  5b79a0c06aec6126364ce1d5cbfedf66-带有NetSupport RAT存档的ServHelper <br>  179 [。] 43.146.90：443-NetSupport RAT网关地址 </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN471960/">https://habr.com/ru/post/zh-CN471960/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN471948/index.html">在盒子里玩</a></li>
<li><a href="../zh-CN471950/index.html">我对未来的愿景D</a></li>
<li><a href="../zh-CN471954/index.html">自己的网络收音机</a></li>
<li><a href="../zh-CN471956/index.html">动画状态图</a></li>
<li><a href="../zh-CN471958/index.html">GA中的Amazon EX Windows带有错误，但比任何人都快</a></li>
<li><a href="../zh-CN471962/index.html">甲骨文的崛起</a></li>
<li><a href="../zh-CN471964/index.html">神谕者解救</a></li>
<li><a href="../zh-CN471968/index.html">在一个伪造的PayPal网站上遇到勒索软件Nemty</a></li>
<li><a href="../zh-CN471974/index.html">两位船长如何成为将军：白色和红色</a></li>
<li><a href="../zh-CN471976/index.html">IT专家如何在国外找到工作？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>