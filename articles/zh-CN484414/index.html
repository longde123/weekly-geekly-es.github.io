<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔆 🧑🏽‍🤝‍🧑🏼 🐜 选择备份日志的存档器 💖 🤵🏾 😦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好！ 


 在本文中，我想谈一谈我如何选择存档器来压缩前台系统的日志。 


 我工作的部门负责开发和维护银行的统一前台系统。 我负责其维护，监视和DevOps。 


 我们的系统是一个高负载的应用程序，每天为5,000多个唯一用户提供服务。 如今，它已成为具有其优点和缺点的“整体”。 但是...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>选择备份日志的存档器</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/homecredit/blog/484414/"><p> 大家好！ </p><br><p> 在本文中，我想谈一谈我如何选择存档器来压缩前台系统的日志。 </p><br><p> 我工作的部门负责开发和维护银行的统一前台系统。 我负责其维护，监视和DevOps。 </p><br><p> 我们的系统是一个高负载的应用程序，每天为5,000多个唯一用户提供服务。 如今，它已成为具有其优点和缺点的“整体”。 但是现在，将功能转移到微服务的过程正在积极进行。 </p><br><p> 每天，我们的系统都会生成130 GB以上的原始日志，尽管事实上我们使用ENG堆栈（Elasticsearch Nxlog Graylog），但文件日志包含更多信息（例如，堆栈跟踪错误），因此需要归档和存储。 </p><br><p> 由于存储位置有限，因此出现了一个问题：“以及哪个归档程序将最好地完成此任务。” </p><br><p> 为了解决此问题，我编写了一个PowerShell脚本来为我执行分析。 </p><a name="habracut"></a><br><p> 该脚本的任务是调用具有不同压缩参数的rar，7z和zip存档器，以计算存档形成的速度以及所使用的磁盘空间。 </p><br><div class="spoiler">  <b class="spoiler_title">ArchSearch.ps1</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#Requires -Version 4.0 #  ,      Clear-Host #   ,     Set-Location $PSScriptRoot #  ,      $Archive = "Archive" $ArchFileName = "ArchFileName" [array]$path = (Get-ChildItem '.\logs').DirectoryName|Select-Object -Unique #      -.  ,     . if ((Test-Path -Path ".\$Archive") -ne $true){ New-Item -Path .\ -Name $Archive -ItemType Directory -Force } else { #    -    Get-ChildItem .\$Archive|Remove-Item -Recurse -Force } #      [array]$table=@() #   Rar #rar # m&lt;0..5&gt; Set compression level (0-store...3-default...5-maximal) 1..5|foreach{ $CompressionLevel = $("-m" + $_) $mc = Measure-Command {cmd /c .\rar.exe a -ep1 -ed $CompressionLevel -o+ -tsc .\$Archive\$($ArchFileName + $_) "$path"} [math]::Round(($mc.TotalMilliseconds), 0) $ArchFileNamePath = ".\$Archive\$($ArchFileName + $_ + ".rar")" $table += ""|Select-Object -Property @{name="ArchFileName"; expression={$ArchFileNamePath -split "\\"|Select-Object -Last 1}},` @{name="CompressionLevel"; expression={$CompressionLevel}},@{name="Extension"; expression={"rar"}},@{name="Size"; expression={(Get-ChildItem $ArchFileNamePath).Length}},` @{name="Time"; expression={[math]::Round(($mc.TotalMilliseconds), 0)}},` @{name="Size %"; expression={0}},@{name="Time %"; expression={0}},@{name="Result %"; expression={0}} } #   7z #7z # -mx[N] : set compression level: -mx1 (fastest) ... -mx9 (ultra) #cmd /c "$env:ProgramFiles\7-Zip\7z.exe" a -mx="$MX" -mmt="$MMT" -t7z -ssw -spf $($ArchFileName + "Fastest") "$path" 1..9|foreach{ $CompressionLevel = $("-mx=" + $_) $mc = Measure-Command {cmd /c "$env:ProgramFiles\7-Zip\7z.exe" a $CompressionLevel -t7z -ssw -spf .\$Archive\$($ArchFileName + $_) $path} #-mmt="$MMT" [math]::Round(($mc.TotalMilliseconds), 0) $ArchFileNamePath = ".\$Archive\$($ArchFileName + $_ + ".7z")" $table += ""|Select-Object -Property @{name="ArchFileName"; expression={$ArchFileNamePath -split "\\"|Select-Object -Last 1}},` @{name="CompressionLevel"; expression={$CompressionLevel}},@{name="Extension"; expression={"7z"}},@{name="Size"; expression={(Get-ChildItem $ArchFileNamePath).Length}},` @{name="Time"; expression={[math]::Round(($mc.TotalMilliseconds), 0)}},` @{name="Size %"; expression={0}},@{name="Time %"; expression={0}},@{name="Result %"; expression={0}} } #   zip (  PS "Compress-Archive") #zip 1..2|foreach{ Switch ($_){ 1{$CompressionLevel = "Fastest"} 2{$CompressionLevel = "Optimal"} } $mc = Measure-Command {Compress-Archive -Path $path -DestinationPath .\$Archive\$($ArchFileName + $_) -CompressionLevel $CompressionLevel -Force} [math]::Round(($mc.TotalMilliseconds), 0) $ArchFileNamePath = ".\$Archive\$($ArchFileName + $_ + ".zip")" $table += ""|Select-Object -Property @{name="ArchFileName"; expression={$ArchFileNamePath -split "\\"|Select-Object -Last 1}},` @{name="CompressionLevel"; expression={$CompressionLevel}},@{name="Extension"; expression={"zip"}},@{name="Size"; expression={(Get-ChildItem $ArchFileNamePath).Length}},` @{name="Time"; expression={[math]::Round(($mc.TotalMilliseconds), 0)}},` @{name="Size %"; expression={0}},@{name="Time %"; expression={0}},@{name="Result %"; expression={0}} } #     Size     [0] -     $Size = ($table|Sort-Object -Property Size)[0].Size / 100 #     Time     [0] -      $Time = ($table|Sort-Object -Property Time)[0].Time / 100 #    $table|foreach { $_.time $_."Size %" = [math]::Round(($_.Size / $Size), 0) $_."Time %" = [math]::Round(($_.Time / $Time), 0) if ($_."Size %" -ge $_."Time %"){ $_."Result %" = $_."Size %" - $_."Time %" } else { $_."Result %" = $_."Time %" - $_."Size %" } } #        "Size %" -     $table|Sort-Object -Property "Size %","Result %"|Select-Object -First 1|Format-Table -AutoSize #        "Result %" -          $table|Sort-Object -Property "Result %","Size %","Time %"|Select-Object -First 1|Format-Table -AutoSize $table|Sort-Object -Property "Size %","Result %"|Select-Object -First 1|Format-Table -AutoSize $table|Sort-Object -Property "Result %","Size %","Time %"|Select-Object -First 1|Format-Table -AutoSize #  !   ,     Get-ChildItem .\$Archive|Remove-Item -Force</span></span></code> </pre> </div></div><br><h1 id="podgotovitelnye-raboty"> 准备工作： </h1><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,   PowerShell  4.0 ($PSVersionTable): #Requires -Version 4.0 #  ,      Clear-Host #   ,     (   .\) Set-Location $PSScriptRoot</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,      $Archive = "Archive" $ArchFileName = "ArchFileName" [array]$path = (Get-ChildItem '.\logs').DirectoryName|Select-Object -Unique #      -.  ,      if ((Test-Path -Path ".\$Archive") -ne $true){ New-Item -Path .\ -Name $Archive -ItemType Directory -Force } else { #   ,     Get-ChildItem .\$Archive|Remove-Item -Recurse -Force } #      [array]$table=@()</span></span></code> </pre> <br><h1 id="razbiraem-podrobnee"> 我们会更详细地分析 </h1><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#     1  5       foreach 1..5|foreach{</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#    $CompressionLevel   1  5($_),       $CompressionLevel = $("-m" + $_)</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#  Measure-Command     ,   {} $mc = Measure-Command {cmd /c .\rar.exe a -ep1 -ed $CompressionLevel -o+ -tsc .\$Archive\$($ArchFileName + $_) "$path"}</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#       [math]::Round(($mc.TotalMilliseconds), 0) #    $ArchFileName + $_ + ".rar": Archive1.rar $ArchFileNamePath = ".\$Archive\$($ArchFileName + $_ + ".rar")" #   $table (+=)   $table += ""|Select-Object -Property @{name="ArchFileName"; expression={$ArchFileNamePath -split "\\"|Select-Object -Last 1}},` @{name="CompressionLevel"; expression={$CompressionLevel}},@{name="Extension"; expression={"rar"}},@{name="Size"; expression={(Get-ChildItem $ArchFileNamePath).Length}},` @{name="SizeAVD"; expression={0}},@{name="Time"; expression={[math]::Round(($mc.TotalMilliseconds), 0)}},` @{name="Size %"; expression={0}},@{name="Time %"; expression={0}},@{name="Result %"; expression={0}} }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#     Size     [0] -     $Size = ($table|Sort-Object -Property Size)[0].Size / 100 #     Time     [0] -      $Time = ($table|Sort-Object -Property Time)[0].Time / 100 #    $table|foreach { $_.time $_."Size %" = [math]::Round(($_.Size / $Size), 0) $_."Time %" = [math]::Round(($_.Time / $Time), 0) if ($_."Size %" -ge $_."Time %"){ $_."Result %" = $_."Size %" - $_."Time %" } else { $_."Result %" = $_."Time %" - $_."Size %" } } #        "Size %" -     $table|Sort-Object -Property "Size %","Result %"|Select-Object -First 1|Format-Table -AutoSize #        "Result %" -          $table|Sort-Object -Property "Result %","Size %","Time %"|Select-Object -First 1|Format-Table -AutoSize #  !   ,    . Get-ChildItem .\$Archive|Remove-Item -Force</span></span></code> </pre> <br><pre> <code class="php hljs">$table|Sort-Object -Property <span class="hljs-string"><span class="hljs-string">"Size %"</span></span>,<span class="hljs-string"><span class="hljs-string">"Result %"</span></span>|Format-Table -AutoSize</code> </pre> <br><div class="scrollable-table"><table><thead><tr><th> 档案名称 </th><th> 压缩等级 </th><th> 扩展名 </th><th> 尺码 </th><th> 时间 </th><th> 尺寸％ </th><th> 时间％ </th><th> 结果％ </th></tr></thead><tbody><tr><td>  ArchFileName8.7z </td><td>  -mx = 8 </td><td>  7z </td><td>  26511520 </td><td>  62404 </td><td>  100 </td><td>  1674 </td><td>  1574 </td></tr><tr><td>  ArchFileName9.7z </td><td>  -mx = 9 </td><td>  7z </td><td>  26511520 </td><td>  64614 </td><td>  100 </td><td>  1733 </td><td>  1633 </td></tr><tr><td>  ArchFileName7.7z </td><td>  -mx = 7 </td><td>  7z </td><td>  28948176 </td><td>  52832 </td><td>  109 </td><td>  1417 </td><td>  1308 </td></tr><tr><td>  ArchFileName6.7z </td><td>  -mx = 6 </td><td>  7z </td><td>  30051742 </td><td>  37339 </td><td>  113 </td><td>  1002 </td><td>  889 </td></tr><tr><td>  ArchFileName5.7z </td><td>  -mx = 5 </td><td>  7z </td><td>  31239355 </td><td>  35169 </td><td>  118 </td><td>  943 </td><td>  825 </td></tr><tr><td>  ArchFileName4.rar </td><td>  -m4 </td><td>  rar </td><td>  33514693 </td><td>  11426 </td><td>  126 </td><td>  306 </td><td>  180 </td></tr><tr><td>  ArchFileName5.rar </td><td>  -m5 </td><td>  rar </td><td>  33465152 </td><td>  12894 </td><td>  126 </td><td>  346 </td><td>  220 </td></tr><tr><td>  ArchFileName3.rar </td><td>  -立方米 </td><td>  rar </td><td>  33698079 </td><td>  9835 </td><td>  127 </td><td>  264 </td><td>  137 </td></tr><tr><td>  ArchFileName2.rar </td><td>  -平方米 </td><td>  rar </td><td>  34399885 </td><td>  8352 </td><td>  130 </td><td>  224 </td><td>  94 </td></tr><tr><td>  ArchFileName4.7z </td><td>  -mx = 4 </td><td>  7z </td><td>  38926348 </td><td>  6470 </td><td>  147 </td><td>  174 </td><td>  27 </td></tr><tr><td>  ArchFileName3.7z </td><td>  -mx = 3 </td><td>  7z </td><td>  44545819 </td><td>  5889 </td><td>  168 </td><td>  158 </td><td>  10 </td></tr><tr><td>  ArchFileName2.7z </td><td>  -mx = 2 </td><td>  7z </td><td>  51690114 </td><td>  4754 </td><td>  195 </td><td>  128 </td><td>  67 </td></tr><tr><td>  ArchFileName1.rar </td><td>  -m1 </td><td>  rar </td><td>  53605833 </td><td>  4600 </td><td>  202 </td><td>  123 </td><td>  79 </td></tr><tr><td>  ArchFileName1.7z </td><td>  -mx = 1 </td><td>  7z </td><td>  57472172 </td><td>  3728 </td><td>  217 </td><td>  100 </td><td>  117 </td></tr><tr><td>  ArchFileName2.zip </td><td> 最佳的 </td><td> 拉链 </td><td>  65733242 </td><td>  14025 </td><td>  248 </td><td>  376 </td><td>  128 </td></tr><tr><td>  ArchFileName1.zip </td><td> 最快的 </td><td> 拉链 </td><td>  81556824 </td><td>  9031 </td><td>  308 </td><td>  242 </td><td>  66 </td></tr></tbody></table></div><br><pre> <code class="php hljs">$table|Sort-Object -Property <span class="hljs-string"><span class="hljs-string">"Result %"</span></span>,<span class="hljs-string"><span class="hljs-string">"Size %"</span></span>,<span class="hljs-string"><span class="hljs-string">"Time %"</span></span>|Format-Table -AutoSize</code> </pre> <br><div class="scrollable-table"><table><thead><tr><th> 档案名称 </th><th> 压缩等级 </th><th> 扩展名 </th><th> 尺码 </th><th> 时间 </th><th> 尺寸％ </th><th> 时间％ </th><th> 结果％ </th></tr></thead><tbody><tr><td>  ArchFileName3.7z </td><td>  -mx = 3 </td><td>  7z </td><td>  44545819 </td><td>  5889 </td><td>  168 </td><td>  158 </td><td>  10 </td></tr><tr><td>  ArchFileName4.7z </td><td>  -mx = 4 </td><td>  7z </td><td>  38926348 </td><td>  6470 </td><td>  147 </td><td>  174 </td><td>  27 </td></tr><tr><td>  ArchFileName1.zip </td><td> 最快的 </td><td> 拉链 </td><td>  81556824 </td><td>  9031 </td><td>  308 </td><td>  242 </td><td>  66 </td></tr><tr><td>  ArchFileName2.7z </td><td>  -mx = 2 </td><td>  7z </td><td>  51690114 </td><td>  4754 </td><td>  195 </td><td>  128 </td><td>  67 </td></tr><tr><td>  ArchFileName1.rar </td><td>  -m1 </td><td>  rar </td><td>  53605833 </td><td>  4600 </td><td>  202 </td><td>  123 </td><td>  79 </td></tr><tr><td>  ArchFileName2.rar </td><td>  -平方米 </td><td>  rar </td><td>  34399885 </td><td>  8352 </td><td>  130 </td><td>  224 </td><td>  94 </td></tr><tr><td>  ArchFileName1.7z </td><td>  -mx = 1 </td><td>  7z </td><td>  57472172 </td><td>  3728 </td><td>  217 </td><td>  100 </td><td>  117 </td></tr><tr><td>  ArchFileName2.zip </td><td> 最佳的 </td><td> 拉链 </td><td>  65733242 </td><td>  14025 </td><td>  248 </td><td>  376 </td><td>  128 </td></tr><tr><td>  ArchFileName3.rar </td><td>  -立方米 </td><td>  rar </td><td>  33698079 </td><td>  9835 </td><td>  127 </td><td>  264 </td><td>  137 </td></tr><tr><td>  ArchFileName4.rar </td><td>  -m4 </td><td>  rar </td><td>  33514693 </td><td>  11426 </td><td>  126 </td><td>  306 </td><td>  180 </td></tr><tr><td>  ArchFileName5.rar </td><td>  -m5 </td><td>  rar </td><td>  33465152 </td><td>  12894 </td><td>  126 </td><td>  346 </td><td>  220 </td></tr><tr><td>  ArchFileName5.7z </td><td>  -mx = 5 </td><td>  7z </td><td>  31239355 </td><td>  35169 </td><td>  118 </td><td>  943 </td><td>  825 </td></tr><tr><td>  ArchFileName6.7z </td><td>  -mx = 6 </td><td>  7z </td><td>  30051742 </td><td>  37339 </td><td>  113 </td><td>  1002 </td><td>  889 </td></tr><tr><td>  ArchFileName7.7z </td><td>  -mx = 7 </td><td>  7z </td><td>  28948176 </td><td>  52832 </td><td>  109 </td><td>  1417 </td><td>  1308 </td></tr><tr><td>  ArchFileName8.7z </td><td>  -mx = 8 </td><td>  7z </td><td>  26511520 </td><td>  62404 </td><td>  100 </td><td>  1674 </td><td>  1574 </td></tr><tr><td>  ArchFileName9.7z </td><td>  -mx = 9 </td><td>  7z </td><td>  26511520 </td><td>  64614 </td><td>  100 </td><td>  1733 </td><td>  1633 </td></tr></tbody></table></div><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#  !   ,    . Get-ChildItem .\$Archive|Remove-Item -Force</span></span></code> </pre> <br><p> 结果： <br> 就磁盘空间而言，最经济的是7z，压缩比为-mx = 8和-mx = 9 </p><br><p><img src="https://habrastorage.org/webt/cd/mq/f5/cdmqf5xjxwupeq8m3y7erk75tfm.png"></p><br><p> 最快的归档文件创建时间为7z，压缩比为-mx = 1 </p><br><p><img src="https://habrastorage.org/webt/8e/_b/jj/8e_bjj2e0rkquzmbe9sm-dvmzdw.png"></p><br><p> 最佳速度和占用空间为7z，压缩比为-mx = 3 </p><br><p><img src="https://habrastorage.org/webt/mz/fb/ss/mzfbssm17xhzc_ixnxeuqgdbg5w.png"></p><br><p> 我们选择压缩率为-mx = 8的7z，因为归档文件的大小为-mx 9，但是它的工作速度更快。 </p><br><p> 太好了，选择了存档器和压缩率，现在让我们存档日志！ </p><br><h1 id="nam-nuzhno-reshit-sleduyuschie-zadachi"> 我们需要解决以下问题： </h1><br><ol><li> 避免在操作过程中增加服务器负载。 </li><li> 使用子文件夹日志处理所有文件夹。 </li><li> 删除超过30天的归档文件（以免磁盘空间用完）。 </li><li> 每天创建档案，具体取决于修改文件的时间。 </li></ol><br><div class="spoiler">  <b class="spoiler_title">ArchLogs.ps1</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#Requires -Version 4.0 #          #SCHTASKS /Create /SC DAILY /ST 22:00 /TN ArchLogs /TR "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe C:\Scripts\ArchLogs.ps1" /RU "NT AUTHORITY\NETWORKSERVICE" /F /RL HIGHEST #  ,      Clear-Host #   ,     Set-Location $PSScriptRoot #           . #  1 Function Set-MMTCore { $Core = (Get-WmiObject –class Win32_processor|Measure-Object NumberOfLogicalProcessors -sum).Sum / 2 $CoreTMP = $Core / 4 IF ($Core -lt 4) { $Core = $Core -1 } Else { $Core = $Core - $CoreTMP } [math]::Round($Core) } #    $MX = 8 #     $MMT = Set-MMTCore #  ,      $SearchFolder = "C:\inetpub" #     $SearchFolder $InetpubFolder = Get-ChildItem $SearchFolder #     Logs #  2 $LogsFolder = $InetpubFolder|foreach {Get-ChildItem $_.Fullname|Where-Object{$_.PSIsContainer -eq $true}|Where-Object{$_.name -eq "logs"}} #  ,      $Archive = "Archive" $ArchiveFile = "ArchFiles.txt" #      $LogsFolder   $LogsFolderName   foreach($LogsFolderName in $LogsFolder.Fullname){ $LogsFolderName #   $Archive,       IF ((Test-Path -Path "$LogsFolderName\$Archive") -ne $true){New-Item -Path $LogsFolderName -Name $Archive -ItemType Directory -Force} #    30  #  3 Get-ChildItem "$LogsFolderName\$Archive"|Where-Object {$_.LastWriteTime -le (Get-Date).AddDays(-30)}| Remove-Item -Force #     [Array]$ArchiveItems = Get-ChildItem -Path $LogsFolderName -Exclude $Archive #   , .    -  IF ($ArchiveItems.Count -ne ^_^quot&amp;#0;quot^_^){ #       $AllLogsFiles = Get-ChildItem $ArchiveItems -Recurse &lt;#-Filter *.log#&gt;|Where-Object {$_.LastWriteTime -lt (Get-Date).Date} #     #  4 $AllData = ($AllLogsFiles|Sort-Object -Property LastWriteTime).LastWriteTime.Date|Select-Object -Unique $AllData foreach ($Data in $AllData){ IF ($ArchiveItems.Count -ne ^_^quot&amp;#0;quot^_^){ #         ($AllLogsFiles|Where-Object {$_.LastWriteTime -lt (Get-Date).Date}|Where-Object {$_.LastWriteTime -ge (Get-Date $Data) -and $_.LastWriteTime -lt (Get-Date $Data).AddDays(1)}).FullName|Out-File .\$ArchiveFile -Force -Encoding default Write-Host "===" $Data Write-Host "===" #      IF ($(Get-Content .\ArchFiles.txt -Encoding default) -ne $null){ $ArchiveFileName =$(($LogsFolderName.Remove($LogsFolderName.LastIndexOf("\"))) -split "\\"|Select-Object -Last 1) + "_" + $(Get-Date $Data -Format dd-MM-yyyy) cmd /c "$env:ProgramFiles\7-Zip\7z.exe" a -mx="$MX" -mmt="$MMT" -t7z -ssw -sdel "$LogsFolderName\$Archive\$ArchiveFileName" "@$ArchiveFile" #        IF(Test-Path ".\$ArchiveFile"){Remove-Item ".\$ArchiveFile" -Force} #      Logs $LogsFolderName|foreach {Get-ChildItem $_|Where-Object {(Get-ChildItem -Path $_.FullName) -eq $null}|Remove-Item -Force} } } } } }</span></span></code> </pre> </div></div><br><p> 在这里，我不会绘制脚本的每一行（在注释中进行描述），而是仅停留在Set-MMTCore函数上，该函数使我们能够计算7z的线程数，以便不将处理器加载到服务器上： </p><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MMTCore</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">#        2 $Core = (Get-WmiObject –class Win32_processor|Measure-Object NumberOfLogicalProcessors -sum).Sum / 2 #      4 $CoreTMP = $Core / 4 IF ($Core -lt 4) { $Core = $Core -1 } Else { $Core = $Core - $CoreTMP } #    [math]::Round($Core) }</span></span></code> </pre> <br><h6 id="bez-ispolzovaniya-funkcii-set-mmtcore"> 不使用Set-MMTCore函数 </h6><br><p> 可以看出，CPU处于100％静止状态。 这意味着我们将不可避免地在服务器上引起问题，并从监视系统收到警报。 </p><br><p><img src="https://habrastorage.org/webt/lx/zs/35/lxzs35gatvlgkeq3nqg1lqlosum.png"></p><br><h6 id="pri-ispolzovanii-funkcii-set-mmtcore"> 使用Set-MMTCore函数时 </h6><br><p> 可以看出，CPU为30-35％。 这意味着使用Set-MMTCore函数可以在不影响服务器操作的情况下存档文件。 </p><br><p><img src="https://habrastorage.org/webt/1i/0e/lu/1i0elui1ntjzib8hlb6i1lgdbea.png"></p><br><p> 备份脚本的结果： </p><br><h6 id="papka-do-arhivacii"> 归档前的文件夹： </h6><br><p><img src="https://habrastorage.org/webt/jp/4l/zm/jp4lzmtwot2wr8pry4xmxks7uxo.png"></p><br><h6 id="papka-posle-arhivacii"> 归档后的文件夹： </h6><br><p><img src="https://habrastorage.org/webt/5d/ei/ls/5deils-brkw-qwkq6mdedtw2kxm.png"></p><br><h6 id="fayly-sozdannye--v-processe-arhivacii"> 在归档过程中创建的文件： </h6><br><p><img src="https://habrastorage.org/webt/hi/pv/q-/hipvq-nga8eyesk50mfzb4qs8cw.png"></p><br><h6 id="fayly-v-arhive"> 档案中的文件： </h6><br><p><img src="https://habrastorage.org/webt/a4/3_/s9/a43_s9t2hg2cfjl3ytu559jjxo8.png"></p><br><p><img src="https://habrastorage.org/webt/rl/yf/u2/rlyfu2qtcs3jcq0rdu9__wuok6m.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN484414/">https://habr.com/ru/post/zh-CN484414/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN484404/index.html">我们推动开发人员并以科学的方式提供反馈-Yandex.Money metap的视频</a></li>
<li><a href="../zh-CN484406/index.html">pn结上的精灵</a></li>
<li><a href="../zh-CN484408/index.html">RUTM时代</a></li>
<li><a href="../zh-CN484410/index.html">有用的开发人员习惯</a></li>
<li><a href="../zh-CN484412/index.html">恩智浦S32G处理器，用于现代汽车电子架构</a></li>
<li><a href="../zh-CN484418/index.html">首席执行官Motoriki Ilya Chekh：有时候，他们希望实验用假肢能完成理想的工作，但他们对此感到失望</a></li>
<li><a href="../zh-CN484420/index.html">流行的BattlEye Antichita的变化以及规避它们的方法</a></li>
<li><a href="../zh-CN484424/index.html">Nvidia Orin-机器人车辆的芯片</a></li>
<li><a href="../zh-CN484426/index.html">我和我的助力车。 效率低下</a></li>
<li><a href="../zh-CN484428/index.html">选择一个没有投资者的创业公司的想法：相反</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>