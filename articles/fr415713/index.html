<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵🏼 🤟🏾 👧🏻 Programmation PHP orientée aspect 🧑🏿‍🤝‍🧑🏿 🌦️ 🕺🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous! 

 Ce mois-ci, nous avons terminé le premier ensemble du cours Backend PHP Developer et nous les embauchons avec puissance et main (au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Programmation PHP orientée aspect</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/415713/">  Bonjour à tous! <br><br>  Ce mois-ci, nous avons terminé le premier ensemble du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cours Backend PHP Developer</a> et nous les embauchons avec puissance et main (autant que possible pendant les vacances).  Le cours a été réapprovisionné par un autre enseignant - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Evgeny Volosatov</a> , que beaucoup connaissent probablement.  Eh bien, nous partageons traditionnellement des choses intéressantes. <br><br>  Allons-y. <br><br>  Dans toute application, certaines parties du code «croisent» plusieurs parties de l'architecture en même temps. <br><br>  Ce problème n'est pas si évident lorsque vous travaillez avec un cadre entièrement fonctionnel.  Votre problème sera très probablement répandu, et il y aura une chance que le cadre l'ait déjà résolu en sacrifiant une division des responsabilités ou en fournissant une abstraction au-dessus du cadre.  De nombreux frameworks utilisent une architecture orientée événement pour résoudre les problèmes de fonctionnalité de bout en bout.  Mais il arrive toujours un moment où le cadre n'est pas en mesure de fournir le niveau de contrôle souhaité sur un morceau de logique particulier.  Cela est particulièrement vrai lors de l'utilisation de microframes ou du développement avec des bibliothèques spécialisées.  Plus votre application prend en compte les principes de séparation des responsabilités, plus le rôle de la fonctionnalité de bout en bout dans votre architecture sera important. <br><br><img src="https://habrastorage.org/webt/hg/2m/2n/hg2m2nmlz9m4ztlew8ezhfaz30o.png"><a name="habracut"></a><br><br><h2>  Programmation PHP orientée aspect </h2><br>  La programmation orientée aspect (AOP) est un paradigme de programmation axé sur l'organisation et la modularisation des fonctionnalités de bout en bout.  Cas d'application - ACL, journalisation, gestion des erreurs, mise en cache. <br><br>  Les hypothèses intégrées (internes) de PHP (lorsque vous définissez une fonction / constante / classe, elle reste définie pour toujours) rendent le paradigme AOP difficile à implémenter. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Li3 a</a> été le premier à résoudre le problème de la fonctionnalité de bout en bout en utilisant un mécanisme de filtrage qui permet de filtrer la logique d'une méthode par le biais de fermetures.  Pour rendre la méthode filtrable, l'implémentation de Li3 nécessite l'ajout manuel de code de modèle.  Avec de telles limitations, les techniques AOP sont limitées aux techniques de filtrage. <br><br>  Autres implémentations AOP bien connues en PHP: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AOP</a> (extension PECL) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Allez!</a> </li></ul><br>  L'extension PECL AOP est une approche intéressante mais en même temps risquée, car la prise en charge des extensions PECL n'est pas courante.  Une autre option est Go! Libraries, qui est une implémentation AOP qui corrige le code PHP à la volée, ce qui permet d'utiliser des méthodes AOP. <br><br>  Il existe d'autres implémentations, mais la plupart d'entre elles sont construites sur la base de procurations (pour autant que je sache), et cette approche a de nombreuses limites. <br><br><h2>  Nouveau mec dans la région </h2><br>  La génération automatique de code existe depuis longtemps en PHP et est utilisée dans de nombreuses bibliothèques, par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ProxyManager.</a>  Et grâce à l'adoption de Composer, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Go!</a>  montre que l'édition de code à la volée est possible. <br><br>  Si la génération de code peut toujours être considérée comme simple, la correction du code est un peu plus compliquée.  Premièrement, en PHP, il n'y a pas d'analyseur de code intégré, et deuxièmement, il y a très peu de bibliothèques qui résolvent les problèmes d'analyse du code PHP.  La plus connue est la bibliothèque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP-Parser</a> .  PHP-Parser est un excellent outil, mais même il ignore la mise en forme des espaces dans les arbres de syntaxe abstraite générés.  Ce qui rend difficile la correction du code.  En effet, le code à corriger est du vrai code exécutable.  Par conséquent, si vous souhaitez que le retour arrière soit précis avec des erreurs, vous devez prendre en compte les numéros de ligne dans le fichier corrigé. <br><br>  Pour cette tâche, nous utilisons le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">correcteur de</a> code Kahlan JIT.  Kahlan est le nouveau framework de test Unit &amp; BDD, grâce aux techniques d'édition JIT, permettant le code de patch stub et singe directement dans Ruby ou JavaScript.  Sous le capot, nous constatons que cette bibliothèque est basée sur l'analyseur PHP rudimentaire.  Mais, néanmoins, il est suffisamment rapide et stable pour nous convenir. <br><br>  La bibliothèque de filtres est disponible sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/crysalead/filter</a> et peut être utilisée comme suit. <br><br>  Tout d'abord, le correcteur de code JIT doit être initialisé dès que possible (par exemple, immédiatement après avoir activé le composeur de chargement automatique): <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/../vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lead</span></span>\<span class="hljs-title"><span class="hljs-title">Filter</span></span>\<span class="hljs-title"><span class="hljs-title">Filters</span></span>; Filters::patch(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre> <br>  Notez que l'édition de code n'est possible que pour les classes chargées par le composeur autoload'er.  Si une classe est ajoutée à l'aide des expressions require ou include, elle est déjà chargée avant d'appeler Filters :: patch (true) et ne sera donc pas corrigée. <br><br>  Par défaut, tout le code corrigé sera stocké dans / tmp / jit, mais vous pouvez toujours le changer en votre propre: <br><br><pre> <code class="php hljs">Filters::patch(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, [<span class="hljs-string"><span class="hljs-string">'cachePath'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'my/cache/path/jit'</span></span>]);</code> </pre> <br>  Les fichiers mis en cache seront restaurés automatiquement chaque fois que vous modifiez un fichier PHP. <br><br>  Attention!  <code>Filters::patch(true)</code> est le moyen le plus simple de configurer le patcher, gardez à l'esprit que tout votre code sera corrigé.  Cela peut prendre du temps pour encapsuler toutes les méthodes de votre base de code dans une fermeture de filtre. <br><br>  Heureusement, si la fonctionnalité de bout en bout joue un rôle crucial dans un code bien conçu, seules quelques méthodes sont nécessaires dans le projet.  Par conséquent, l'approche préférée consiste à corriger uniquement les méthodes qui seront filtrées: <br><br><pre> <code class="php hljs">Filters::patch([ <span class="hljs-string"><span class="hljs-string">'A\ClassName'</span></span>, <span class="hljs-string"><span class="hljs-string">'An\Example\ClassName::foo'</span></span>, <span class="hljs-string"><span class="hljs-string">'A\Second\Example\ClassName'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'foo'</span></span>, <span class="hljs-string"><span class="hljs-string">'bar'</span></span>], ], [ <span class="hljs-string"><span class="hljs-string">'cachePath'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'my/cache/path/jit'</span></span>, ]);</code> </pre> <br>  Ainsi, vous pouvez choisir de corriger toutes les méthodes d'une certaine classe, une seule méthode ou plusieurs d'entre elles. <br><br><h2>  Filtre API </h2><br>  Maintenant que le patcher JIT est activé, créez un filtre de journal: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Chaos</span></span>\<span class="hljs-title"><span class="hljs-title">Filter</span></span>\<span class="hljs-title"><span class="hljs-title">Filters</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Chaos</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Monolog</span></span>\<span class="hljs-title"><span class="hljs-title">Logger</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Monolog</span></span>\<span class="hljs-title"><span class="hljs-title">Handler</span></span>\<span class="hljs-title"><span class="hljs-title">StreamHandler</span></span>; $logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logger(<span class="hljs-string"><span class="hljs-string">'database'</span></span>); $logger-&gt;pushHandler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamHandler(<span class="hljs-string"><span class="hljs-string">'my/log/path/db.log'</span></span>, Logger::WARNING)); Filters::apply(Database::class, <span class="hljs-string"><span class="hljs-string">'query'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($next, $sql, $data, $options)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($logger)</span></span></span><span class="hljs-function"> </span></span>{ $logger-&gt;info(<span class="hljs-string"><span class="hljs-string">'Ran SQL query: '</span></span> . $sql); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $next($sql, $data, $options); });</code> </pre><br>  L'exemple ci-dessus crée un filtre de journal de requête SQL pour la bibliothèque de bases de données Chaos.  Plus d'informations sur le filtre API peuvent être trouvées sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/crysalead/filter</a> . <br><br><h2>  Conclusion </h2><br>  AOP, à mon avis, est la vraie réponse pour la fonctionnalité de bout en bout.  Toutes les autres abstractions sont également redondantes et dans la plupart des cas limitées à un certain cadre.  Je ne perds pas espoir qu'un jour PHP fournira une API intégrée pour une programmation orientée aspect.  Mais maintenant, je pense que la correction de code JIT est la meilleure option, où les avantages l'emportent largement sur la surcharge du processeur, qui peut être pratiquement négligée lorsque la correction de code JIT n'est pas appliquée à l'échelle mondiale. <br><br>  LA FIN <br><br>  Comme toujours, nous attendons, le cas échéant, des questions, un souhait et vous invitons à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une leçon ouverte</a> où vous pourrez écouter une conférence intéressante et mieux connaître le nouveau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">professeur</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415713/">https://habr.com/ru/post/fr415713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415699/index.html">Trois courtes histoires de registre Windows</a></li>
<li><a href="../fr415701/index.html">Top 10: les meilleurs articles du Joker 2017</a></li>
<li><a href="../fr415705/index.html">Les pirates ont compromis les référentiels Gentoo Linux sur GitHub</a></li>
<li><a href="../fr415707/index.html">Richard Hamming: Chapitre 18. Modélisation - I</a></li>
<li><a href="../fr415709/index.html">7 péchés du propriétaire du produit</a></li>
<li><a href="../fr415715/index.html">L'histoire de l'effondrement et du sauvetage miraculeux du moule dans KOMPAS-3D</a></li>
<li><a href="../fr415717/index.html">Puis-je fabriquer un pistolet léger pour l'écran LCD? Kickstarter récolte déjà des fonds</a></li>
<li><a href="../fr415721/index.html">Pourquoi le processeur phare a-t-il besoin d'une mémoire supérieure? Test du kit HyperX Fury DDR4-3466</a></li>
<li><a href="../fr415723/index.html">Des concepteurs au département d'assurance qualité, ou y a-t-il une vie après l'usine</a></li>
<li><a href="../fr415725/index.html">Une architecture propre et rapide comme alternative à VIPER</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>