<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèΩ üë©‚Äç‚ù§Ô∏è‚Äçüë® ü•ä Dynamische DAG-Erzeugung im Luftstrom üîù üôáüèø üà¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo allerseits! Mein Name ist Anton, in Rostelecom entwickle ich ein zentrales Data Warehouse. Unser Repository besteht aus Modulen, deren Orchestra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dynamische DAG-Erzeugung im Luftstrom</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rostelecom/blog/435746/"><p>  Hallo allerseits!  Mein Name ist Anton, in Rostelecom entwickle ich ein zentrales Data Warehouse.  Unser Repository besteht aus Modulen, deren Orchestrator mehrere Informatica-Instanzen verwendet, von denen einige im Rahmen des √úbergangs zu Open-Source-L√∂sungen auf Airflow √ºbertragen werden sollen.  Da Informatica und Airflow grunds√§tzlich unterschiedliche Tools sind, ist es nicht so einfach, eine vorhandene Implementierung zu √ºbernehmen und zu wiederholen.  Wir wollten einerseits einen Workflow erhalten, der der aktuellen Implementierung so nahe wie m√∂glich kommt, und andererseits das interessanteste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erste Airflow-Prinzip verwenden</a> - Dynamik, die Flexibilit√§t bietet. </p><br><p>  In diesem kurzen Artikel m√∂chte ich √ºber die wirklich dynamische Erzeugung von DAGs in Airflow sprechen.  Zu diesem Thema enth√§lt das Internet haupts√§chlich viele Artikel von Entwicklern aus Indien, die Materialien der Form <em>"Sie k√∂nnen Dags in Airflow dynamisch generieren, hier ein Beispiel: &lt;Beispiel zum Generieren von 10 HelloWorld-Aufgaben / Dags&gt;" sind</em> .  Wir waren jedoch an der Erzeugung von Dags interessiert, die sich mit der Zeit mit einer variablen Anzahl und Namen von Aufgaben √§ndern werden. </p><br><p><img src="https://habrastorage.org/webt/zl/yr/sk/zlyrskhcw1q8wswrizaqcep2-pa.png" title="Apache Airflow"></p><a name="habracut"></a><br><p>  Derzeit wird Airflow implementiert, um ein Modul zu starten, das Datenpakete auf Remote-Quellservern f√ºr den weiteren Upload in das Repository generiert.  Es l√§uft nach einem einfachen Zeitplan, es ist nicht sehr interessant, es im Detail zu untersuchen.  Au√üerdem wird in K√ºrze eine Orchestrierung √ºber das Airflow-Modul eingef√ºhrt, das Datenpakete zum weiteren Laden durch Schichten in Zwischenstufen bereitstellt.  Hier warten wir auf eine Reihe von Rechen, deren Beschreibungen ich nirgendwo gefunden habe und die ich teilen m√∂chte. </p><br><p>  Auf Airflow on Habr√© gibt es einige Artikel von Entwicklern von Mail.ru, in denen grundlegende Dinge gut beschrieben werden: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Allgemeine Beschreibung des Luftstroms</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verzweigung, Parametrisierung √ºber Jinja und Kommunikation innerhalb der DAG √ºber Xcom</a> </p><br><h2 id="nebolshoy-glossariy">  Kleines Glossar: </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DAG / DAG</a> ist ein gerichteter azyklischer Graph.  In diesem Fall meinen wir eine Folge von Aktionen, die voneinander abh√§ngen und keine Zyklen bilden. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SubDAG / Sabdag</a> - das gleiche wie DAG, jedoch innerhalb einer anderen DAG, die als Teil der √ºbergeordneten DAG gestartet wurde (d. H. Aufgabe ist) und keinen separaten Zeitplan hat. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Operator / Operator</a> - ein bestimmter Schritt im Tag, der eine bestimmte Aktion ausf√ºhrt.  Zum Beispiel PythonOperator. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgabe / Aufgabe</a> - Eine bestimmte Instanz des Bedieners beim Starten der DAG wird als kleines Quadrat in der Weboberfl√§che angezeigt.  Zum Beispiel PythonOperator, der <em>run_task</em> hei√üt und in der DAG <em>check_dag ausgef√ºhrt wird</em> . </p><br><h2 id="ideya-dinamicheskoy-generacii-taskov-v-dage-problemy-i-nedostatki">  Die Idee der dynamischen Aufgabengenerierung in dag, Probleme und Nachteile </h2><br><p>  Eingabedaten: </p><br><p>  Es gibt eine Tabelle im Orchester-Repository, nennen wir sie PKG_TABLE. <br>  Es gibt einen Mechanismus, der der Tabelle PKG_TABLE Eintr√§ge hinzuf√ºgt, f√ºr die das Datenpaket zum Herunterladen bereit ist. </p><br><p>  Was wir wollten: </p><br><p>  DAG, die f√ºr herunterladbare Pakete generiert wird und mit dem Herunterladen beginnt (Spoiler: Am Ende hat sich alles herausgestellt). </p><br><p> Mit dem folgenden Code generieren wir einen Tag, der aus der LatestOnlyOperator-Task und ihrer abh√§ngigen Task besteht. Diese wird erstellt, wenn die Funktion pkg_subdag_factory ausgef√ºhrt wird, die eine Liste von Paketen aus der Tabelle PKG_TABLE empf√§ngt und mehrere PythonOperators generiert.  Wenn keine Pakete zum Herunterladen vorhanden sind, wird ein DummyOperator generiert. </p><br><p>  Sie beschlossen, die erste Version mit einem PythonOperator zu erstellen und sie mithilfe von Airflow in einen detaillierten Workflow umzuverteilen. </p><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- """  DAG    """ from airflow.models import DAG from airflow.operators.python_operator import PythonOperator from airflow.operators.subdag_operator import SubDagOperator from airflow.operators.dummy_operator import DummyOperator from airflow.operators.latest_only_operator import LatestOnlyOperator from airflow.hooks.oracle_hook import OracleHook from datetime import datetime, timedelta import logging from scripts.lib import run_load, select_pkg_data def pkg_subdag_factory( oracle_hook, parent_dag_name, child_dag_name, start_date, schedule_interval, param_dict): """ ,  DAG    PythonOperator\` (1  - 1 PythonOperator)  : oracle_hook - airflow.hooks.oracle_hook.OracleHook parent_dag_name -  ""  child_dag_name -    start_date -       schedule_interval -      param_dict -     """ dag = DAG( '%s.%s' % (parent_dag_name, child_dag_name), schedule_interval=schedule_interval, start_date=start_date, catchup=False ) logging.info('selecting pkg data...') pkg_set = select_pkg_data(oracle_hook) if len(pkg_set): logging.info('pkg_set:') logging.info(pkg_set) for pkg in pkg_set: pkg_id = pkg[1] pkg_dict = {'pkg_data_' + str(pkg_id): pkg} param_dict.update(pkg_dict) task_name = 'pkg_' + str(pkg_id) PythonOperator( task_id=task_name, python_callable=run_load, op_kwargs={ 'oracle_hook': oracle_hook, 'param_dict': param_dict, 'pkg_id': pkg_id }, retries=0, dag=dag ) else: logging.info('Undelivered packages not found') DummyOperator(task_id='no_packages_dummy', retries=0, dag=dag) return dag interval = '*/10 * * * *' args = { 'owner': 'airflow', 'start_date': datetime(2018, 11, 12) } oracle_hook = OracleHook('ora_meta') main_dag_name = 'load' load_dag_name = 'load_packages' param_dict = { #       } main_dag = DAG( dag_id=main_dag_name, default_args=args, schedule_interval=interval, catchup=False ) subdag = SubDagOperator( subdag=pkg_subdag_factory( oracle_hook, main_dag_name, load_dag_name, args['start_date'], interval, param_dict ), task_id=load_dag_name, dag=main_dag ) #  ,       latest_only = LatestOnlyOperator(task_id='latest_only', dag=main_dag) subdag.set_upstream(latest_only)</span></span></code> </pre> <br><p>  Die folgenden Screenshots zeigen, wie dies als Ergebnis aussieht. <br>  Aussehen der DAG: </p><br><p><img src="https://habrastorage.org/webt/_x/tl/sd/_xtlsduwcwvecmuwk2qfd2rlpyq.png" title="Aussehen der DAG"></p><br><p>  Aussehen des Subtags bei Fehlen von Paketen zur Lieferung: </p><br><p><img src="https://habrastorage.org/webt/z7/vn/gy/z7vngyipby78gaksu29i0km1y04.png" title="In Ermangelung von Paketen zur Lieferung"></p><br><p>  Aussehen des Subtags bei Vorhandensein von Paketen zur Lieferung: </p><br><p><img src="https://habrastorage.org/webt/-3/ig/9f/-3ig9fawopeyqupws_ya7pp3ve0.png" title="Wenn es Pakete zur Lieferung gibt"></p><br><h2 id="problemy-i-nyuansy">  Probleme und Nuancen </h2><br><ul><li>  Catchup funktionierte nicht wie erwartet: Nach dem Einschalten des ausgeschalteten Dags kam es zu mehreren Starts (nicht f√ºr den gesamten Zeitraum des Zeitplans, sondern 2-3 gleichzeitig).  Aus diesem Grund musste ich LatestOnlyOperator hinzuf√ºgen, damit alle Starts mit Ausnahme des letzten im Leerlauf erfolgen. </li><li>  Wenn Sie ein Subdag erstellen, m√ºssen Sie es explizit √ºber die Befehlszeile mit dem Befehl "airflow unpause &lt;subdag_name&gt;" aktivieren. Andernfalls wird es nicht gestartet, und Sie m√ºssen dies beim Erstellen jedes neuen Subdags (eines Subdags mit einem neuen Namen) tun, was die dynamische Generierung sehr unpraktisch macht .  Wenn Sie in der Luftstromkonfiguration ($ airflow_home / airflow.cfg) den Parameter "dags_are_paused_at_creation" = false setzen, ist dies nicht erforderlich, kann jedoch zu unangenehmen Konsequenzen beim automatischen automatischen Starten eines neuen Tages f√ºhren - es scheint mir, dass Sie neue Tage manuell starten m√ºssen. </li></ul><br><p>  In der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> hei√üt es: "Eine wichtige Funktion von Airflow besteht darin, dass diese DAG-L√§ufe atomare, idempotente Elemente sind, &lt;...&gt;" was bedeutet: "Es versteht sich, dass der Tag unver√§ndert generiert wird."  Aufgrund der Tatsache, dass wir diese "Schl√ºsself√§higkeit" verletzt haben, haben wir einige Dinge gelernt: </p><br><ul><li>  Ein leerer Tag (ohne Aufgaben) beginnt und kann nicht enden und verstopft alle m√∂glichen Parallelen.  Dies geschah, wenn zum Zeitpunkt des Starts des Dags keine Download-Pakete vorhanden waren.  Um dies zu umgehen, wird ein DummyOperator erstellt. </li><li>  Wenn w√§hrend der Arbeit der Task-Tag neu generiert wird und diese Aufgabe nicht mehr im aktualisierten Tag enthalten ist, wird sie mit einer Unterbrechung des laufenden Prozesses beendet.  Dies geschieht bei jedem Schritt des Shedulers, jedoch nicht h√§ufiger als im Parameter min_file_process_interval in der Luftstromkonfiguration ($ airflow_home / airflow.cfg) angegeben.  Um dies zu umgehen, haben wir die Erstellung von Task Packs nicht nur anhand des Status "Bereit zum Herunterladen", sondern auch anhand des Status "Laden in Bearbeitung" durchgef√ºhrt, damit diese w√§hrend des Downloads weiterhin generiert werden. </li><li>  Wenn die aktuelle Version des Dags keine Aufgabe enth√§lt, die zuvor ausgef√ºhrt wurde, z. B. eine Aufgabe mit dem Namen "pkg_123", die zuvor geladen wurde und in der aktuellen Version des Dags nicht erstellt wurde, k√∂nnen Sie keine Statistiken zu dieser Aufgabe in der Weboberfl√§che anzeigen.  Obwohl alle Informationen in der Luftstromdatenbank gespeichert sind und auf deren Grundlage ein externes Dashboard f√ºr alte Starts erstellt werden kann.  Wenn sich die Frage nach der H√§ufigkeit der Aktualisierung von DAGs und der M√∂glichkeit zum Deaktivieren dieser DAGs stellt, k√∂nnen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> dar√ºber lesen. </li><li>  Aufgrund der dynamischen Generierung von task_id ist es erforderlich, ein W√∂rterbuch mit Daten f√ºr alle aktuellen Pakete sowie die ID des aktuellen Pakets in jede dieser Aufgaben zu werfen, damit Sie, wenn die Funktion selbst funktioniert, die erforderlichen Daten aus demselben W√∂rterbuch nach Paket-ID ausw√§hlen.  Andernfalls wurden alle Aufgaben f√ºr dasselbe Paket gestartet. </li></ul><br><h2 id="execution_date-v-logah-i-fakticheskoe-vremya-zapuska">  Ausf√ºhrungsdatum in Protokollen und tats√§chliche Startzeit </h2><br><p>  Ich werde mit einer weiteren Nuance von Airflow enden, die zun√§chst verwirrt und in anderen Artikeln nicht mit einfachen Worten beschrieben wird - Ausf√ºhrungsdatum (das in allen Protokollen, in der Benutzeroberfl√§che usw. angezeigt wird) und die tats√§chliche Startzeit.  Im Prinzip befindet sich die Beschreibung in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation des Luftstroms</a> und in den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FAQ</a> , aber das Ergebnis ist nicht offensichtlich, so dass meines Erachtens eine Kl√§rung erforderlich ist. </p><br><p>  <em>Dokumentation</em> : "Scheduler startet Ihren Job am Ende des Zeitraums" <br>  <em>Ergebnis</em> : Wenn Sie einen Tag mit einem Zeitplan erstellen, z. B. @daily, wird bei einem Lauf mit dem Ausf√ºhrungsdatum "2018-01-01 00:00:00" tats√§chlich "2018-02-01 00:00:00" ausgef√ºhrt. </p><br><h2 id="poleznye-ssylki">  N√ºtzliche Links: </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nachholdokumentation</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NeuesteOnlyOperator-Dokumentation</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Weitere Dokumentation zu LatestOnlyOperator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beispiel f√ºr die Verwendung von LatestOnlyOperator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einige Nuancen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Frage zu Abh√§ngigkeiten vom vorherigen Start</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ein kleines Beispiel zur dynamischen Erzeugung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Eine Frage zur dynamischen Erzeugung mit einer kleinen Beschreibung</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de435746/">https://habr.com/ru/post/de435746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de435734/index.html">Wie man sich nicht von Physik t√§uschen l√§sst</a></li>
<li><a href="../de435738/index.html">DIY Projekttechnik. Teil eins</a></li>
<li><a href="../de435740/index.html">Die Registrierung ist beim GraphQL Meetup in St. Petersburg m√∂glich</a></li>
<li><a href="../de435742/index.html">Ressourcenmanagement in der Zimbra Collaboration Suite</a></li>
<li><a href="../de435744/index.html">Fintech Digest: Die Bank of Russia wird in der Lage sein, Standorte zu blockieren, das P2P-Kreditvolumen sinkt, Krypto in Europa</a></li>
<li><a href="../de435748/index.html">Metasploit Framework 5.0 ver√∂ffentlicht</a></li>
<li><a href="../de435750/index.html">Januar IT Events Digest</a></li>
<li><a href="../de435752/index.html">Moscow Python Conf ++ 2019 - die erste Konferenz, auf der wir einige Redner von Grund auf selbst vorbereiten</a></li>
<li><a href="../de435756/index.html">Old New Year Sale</a></li>
<li><a href="../de435760/index.html">Inside Quake: Sichtbare Oberfl√§chen definieren</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>