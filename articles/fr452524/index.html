<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Ü üö∞ üî° Compresser l'APK, essayer de le faire fonctionner üíè üóùÔ∏è üåã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="/ PxHere / PD 


 L'optimisation du poids de l'APK est une t√¢che non triviale, mais tr√®s pertinente √† l'√©poque de l'application instantan√©e. L'activat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compresser l'APK, essayer de le faire fonctionner</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452524/"><p><img src="https://habrastorage.org/webt/mt/4c/5p/mt4c5phurcqjoygefzy7edmhsxa.jpeg"><br>  <em>/ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PxHere</a> / PD</em> </p><br><p>  L'optimisation du poids de l'APK est une t√¢che non triviale, mais tr√®s pertinente √† l'√©poque de l'application instantan√©e.  L'activation de proguard vous √©pargnera du code inutile si vos d√©pendances peuvent √™tre d√©termin√©es au stade de la compilation, mais il existe plusieurs autres types de fichiers dans l'APK qui peuvent √™tre exclus de l'assembly. </p><br><p>  Sous le chat sur la fa√ßon de cr√©er des d√©pendances - d√©fini au stade de la compilation, quels fichiers peuvent √™tre exclus de l'assembly et comment le faire, ainsi que, nous analyserons comment exclure les composants inutilis√©s de l'assembly si vous avez plusieurs applications avec une base de code commune. </p><a name="habracut"></a><br><h1 id="pered-prochteniem">  Avant de lire </h1><br><ul><li>  Avant d'appliquer les conseils de l'article, optimisez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guide</a> APK pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google</a> .  Cet article est destin√© √† ceux qui n'ont pas suffisamment d'optimisations standard. </li><li>  Par "proguard", je veux dire un compilateur d'optimisation avec minification. </li><li>  Par composant, j'entends une certaine caract√©ristique du produit d'un point de vue commercial.  Dans notre cas, il s'agit simplement d'une collection de fichiers dans un certain package.  Nous avons un module gradle pour toute l'application. </li></ul><br><p> Le poids de notre APK optimis√© par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google</a> √©tait de <code>4.4 </code> </p><br><h1 id="lishnie-fayly">  Fichiers suppl√©mentaires </h1><br><p>  Commen√ßons par un simple.  Si vous n'utilisez pas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kotlin-reflect</a> , vous pouvez exclure les m√©ta-informations sur les classes kotlin de l'assembly.  Vous pouvez le faire comme suit: <br>  Dans <code>build.gradle (Module: app)</code> </p><br><pre> <code class="plaintext hljs">android { packagingOptions { exclude("META-INF/*.kotlin_module") exclude("**.kotlin_builtins") exclude("**.kotlin_metadata") } }</code> </pre> <br><p>  La r√©flexion Java n'a pas besoin des <code>*.kotlin_module</code> , <code>*.kotlin_builtins</code> et <code>*.kotlin_metadata</code> .  D√©terminer quelle r√©flexion vous utilisez est tr√®s simple.  Si vous √©crivez <code>obj::class.&lt;method&gt;</code> , alors vous utilisez la r√©flexion kotlin, si <code>obj::class.java.&lt;method&gt;</code> , puis la r√©flexion java. </p><br><p>  <em>Le r√©sultat de l'optimisation pour nous: -602,1 ko</em> </p><br><h1 id="zavisimosti">  D√©pendances </h1><br><p>  Les biblioth√®ques ajoutent parfois des d√©pendances pour les cas qui ne se produisent jamais dans votre application.  Par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ktor-client</a> tire avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kotlin-reflect</a> (0,5 Mo!). <br>  J'ai lutt√© avec de tels cas comme suit: j'ai collect√© l'APK avec <code>minifyEnabled = true</code> , je l' <code>minifyEnabled = true</code> jet√© dans l'analyseur Android Studio, t√©l√©charg√© <code>mapping.txt</code> et recherch√© des packages qui, en th√©orie, ne devraient pas √™tre pr√©sents dans l'assemblage.  Par exemple, <code>kotlin.reflect</code> .  Apr√®s avoir <code>./gradlew app:dependencies</code> dans le dossier du projet pour rechercher les d√©pendances (n'oubliez pas d'augmenter la longueur de l'historique dans le terminal. L'arbre des d√©pendances peut √™tre volumineux!).  √Ä partir de cet arbre, il est facile de comprendre ce qui fait r√©f√©rence aux d√©pendances inutiles et de les exclure.  Dans <code>build.gradle</code> votre module: </p><br><pre> <code class="plaintext hljs">dependencies { implementation("io.ktor:ktor-client-core:$ktorVersion") { exclude(group: "org.jetbrains.kotlin", module: "kotlin-reflect") } implementation("io.ktor:ktor-client-okhttp:$ktorVersion") { exclude(group: "org.jetbrains.kotlin", module: "kotlin-reflect") } }</code> </pre> <br><p>  Ce code supprime la d√©pendance de la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ktor-client</a> sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kotlin-reflect</a> .  Si vous souhaitez exclure autre chose, remplacez vos valeurs. </p><br><p>  <strong>!!!</strong>  <strong>Utilisez ces conseils tr√®s attentivement!</strong>  <strong>Avant d'√©liminer les d√©pendances, assurez-vous que vous n'en avez pas besoin.</strong>  <strong>Si vous ne le faites pas, alors l'application peut commencer √† tomber en production !!!</strong> </p><br><p>  <em>Le r√©sultat de l'optimisation pour nous: -500,3 ko</em> </p><br><h1 id="proverte-vashi-xml">  Validez votre XML </h1><br><p>  Malheureusement, proguard ne supprime pas les fichiers de balisage XML suppl√©mentaires du dossier de pr√©sentation.  Le XML non utilis√© peut utiliser des widgets "lourds" et proguard ne pourra pas non plus les exclure de l'assemblage!  Pour √©viter cela, supprimez les ressources inutilis√©es avec <code>Refactor -&gt; Remove unused resources...</code> </p><br><h1 id="proverte-vash-di">  V√©rifiez votre di </h1><br><p>  Si vous, comme nous, utilisez DI d'ex√©cution, v√©rifiez si vous avez des fournisseurs pour les d√©pendances que vous n'utilisez pas.  Proguard ne peut pas les exclure de l'assembly car ils ne sont pas inutilis√©s du point de vue du compilateur.  Vous les utilisez lors de la cr√©ation d'un graphe de d√©pendances. </p><br><h1 id="isklyuchite-otladochnye-zavisimosti-iz-reliznoy-sborki">  Exclure les d√©pendances de d√©bogage des versions de version </h1><br><p>  Les outils de d√©bogage peuvent prendre beaucoup de place de fa√ßon inattendue.  Par exemple, le <code>stetho</code> p√®se environ <code>0.2 </code> apr√®s compression!  Dans tous les cas, il est pr√©f√©rable d'exclure l'int√©gralit√© de l'infrastructure de d√©bogage de la version afin que personne ne puisse en savoir trop sur votre application en la t√©l√©chargeant simplement sur Google Play. </p><br><p>  Vous pouvez cr√©er diff√©rentes versions des m√™mes fichiers pour le d√©bogage et la publication.  Pour ce faire, dans le dossier <code>src</code> , √† c√¥t√© de <code>main</code> , cr√©ez les dossiers de <code>debug</code> et de <code>release</code> .  Vous pouvez maintenant √©crire la fonction <code>initStetho</code> qui initialise Stetho dans le fichier <code>src/debug/java/your/pkg/Stetho.kt</code> et la fonction <code>initStetho</code> qui ne fait rien dans le <code>src/debug/java/your/pkg/Stetho.kt</code> <code>src/release/java/your/pkg/Stetho.kt</code> . </p><br><p>  Au cas o√π, assurez-vous que cette d√©pendance est incluse uniquement dans les versions de d√©bogage.  Vous pouvez le faire en rempla√ßant l' <code>implementation</code> par <code>debugImplementation</code> dans <code>build.gradle</code> .  Plus souvent qu'autrement, proguard √©limine les fichiers inutiles m√™me sans cette √©tape, mais pas toujours.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La r√©ponse √† la question "pourquoi?"</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ci-dessous dans le texte de l'article</a> . </p><br><h1 id="platformy">  Plateformes </h1><br><p>  Parfois, sur la m√™me base de code, plusieurs versions diff√©rentes d'une application sont √©mises.  Il peut s'agir de versions diff√©rentes pour diff√©rents pays ou r√©gions, ou, comme dans notre cas, pour diff√©rents clients.  Vous trouverez ci-dessous des conseils sur la fa√ßon de d√©charger la plate-forme. </p><br><p><img src="https://habrastorage.org/webt/5d/oy/ze/5doyzeespts24cj8hqkey7lsros.jpeg"><br>  <em>/ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PxHere</a> / PD</em> </p><br><h1 id="nash-opyt">  Notre exp√©rience </h1><br><p>  Nous d√©veloppons un concepteur d'applications mobiles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">E-SHOP</a> .  Nous avons plusieurs dizaines de clients et chacun a son propre ensemble de composants.  Certains composants sont utilis√©s par tous les clients, certains ne sont qu'une partie.  Notre t√¢che consiste √† inclure dans l'assemblage client uniquement les composants dont il a besoin. </p><br><h1 id="isklyuchenie-komponenta-po-flagu">  Exception de drapeau </h1><br><p>  Pour chaque client, nous cr√©ons une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">saveur de produit</a> distincte.  C'est pratique car il est facile de cr√©er diff√©rentes ressources pour diff√©rents clients, l'IDE fournit une interface graphique pour basculer entre les saveurs et les caches fonctionnent bien.  Et vous pouvez √©galement g√©n√©rer votre propre <code>BuildConfig.java</code> pour chaque client.  Les valeurs de champ de cette classe sont connues au stade de la compilation.  Voil√† ce dont nous avons besoin!  Cr√©ez un champ de type <code>boolean</code> pour chaque composant. </p><br><pre> <code class="plaintext hljs">android { productFlavors { client1 { buildConfigField("boolean", "IS_CATALOG_ENABLED", "true") } client2 { buildConfigField("boolean", "IS_CATALOG_ENABLED", "false") } } }</code> </pre> <br><p>  <em>Il s'agit d'une version simplifi√©e de la configuration.</em>  <em>Le pr√©sent est complexe en raison de l'int√©gration avec notre CI.</em> </p><br><p>  On sait maintenant si le composant est actif au stade de la compilation, et proguard peut l'exclure de l'assemblage! </p><br><h1 id="snova-xml">  XML √† nouveau </h1><br><p>  Maintenant, le probl√®me avec les dispositions XML inutilis√©es prend une nouvelle dimension!  Vous ne pouvez pas simplement prendre et supprimer le balisage d'un composant simplement parce que certains clients n'en ont pas besoin. </p><br><p>  Dans notre application XML de l'un des composants rarement utilis√©s, nous avons utilis√© un widget qui faisait r√©f√©rence √† la biblioth√®que de reconnaissance d'images <code>firebase.ml.vision</code> .  Il p√®se environ 0,2 Mo, ce qui est beaucoup.  Il a √©t√© d√©cid√© d'ajouter ce widget avec du code au lieu de le d√©clarer dans le balisage.  Apr√®s cela, proguard a pu exclure la <code>vision</code> de l'assemblage pour les clients qui n'en avaient pas besoin. </p><br><p>  <em>Le r√©sultat de l'optimisation pour nous: -222,3 ko pour l'APK moyen</em> </p><br><h1 id="annotaciya-keep">  <code>@Keep</code> </h1><br><p>  Il y a 2 fa√ßons de dire √† proguard que votre classe ne peut pas √™tre minifi√©e: √©crivez une r√®gle dans le fichier <code>proguard-rules.pro</code> ou mettez l'annotation <code>@Keep</code> .  Dans la biblioth√®que <code>play-services-vision</code> , cette annotation se trouve sur la classe racine.  Par cons√©quent, 0,2 mb se bloque, m√™me dans les applications clientes qui n'ont pas besoin de reconnaissance d'image. </p><br><p>  Je n'ai pas trouv√© de moyen simple et s√ªr de supprimer cette annotation.  Si vous savez comment - veuillez √©crire dans les commentaires. </p><br><p>  Heureusement, la biblioth√®que <code>firebase.ml.vision</code> , qui est une version plus r√©cente de <code>play-services-vision</code> , n'utilise pas cette annotation, et nous avons r√©solu le probl√®me en y acc√©dant. </p><br><h1 id="i-vnov-di">  Et encore DI </h1><br><p>  Dernier point mais non le moindre.  DI pour les composants d√©connect√©s.  Tout est simple ici: pour chaque composant, nous utilisons notre propre conteneur, et nous connectons les d√©pendances g√©n√©rales via un module s√©par√©. </p><br><p>  <em>Le r√©sultat d'optimisation pour nous: -20,1 ko pour l'APK moyen</em> </p><br><h1 id="vyvody">  Conclusions </h1><br><ul><li>  Le poids de l'APK moyen est pass√© de <code>4.4 </code> √† <code>3.1 </code> , et le minimum - √† <code>2.5 </code> ! </li><li>  Le code d'application n'a pas √©t√© endommag√©, mais am√©lior√©.  DI est d√©sormais plus facile √† utiliser </li></ul><br><p>  Toutes les optimisations pr√©sent√©es dans l'article sont des ¬´fruits √† faible pendaison¬ª.  Ils sont assez faciles √† mettre en ≈ìuvre et obtiennent rapidement le r√©sultat.  Jusqu'√† <em>-43%</em> pour un APK d√©j√† optimis√© dans notre cas.  J'esp√®re avoir √©conomis√© votre temps en r√©pertoriant tout au m√™me endroit. </p><br><h3 id="vsem-spasibo">  Merci √† tous! </h3></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452524/">https://habr.com/ru/post/fr452524/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452514/index.html">La conception du jeu √† la vie. L'√©conomie du jeu (Partie II)</a></li>
<li><a href="../fr452516/index.html">Conteneur Docker pour la gestion des serveurs HP avec ILO</a></li>
<li><a href="../fr452518/index.html">VMware EMPOWER 2019 - les principaux sujets de la conf√©rence, qui se tiendra du 20 au 23 mai √† Lisbonne</a></li>
<li><a href="../fr452520/index.html">Les ¬´√©l√©ments¬ª d'Euclid fantaisie dans TeX</a></li>
<li><a href="../fr452522/index.html">Huit options Bash peu connues</a></li>
<li><a href="../fr452526/index.html">Classe moyenne: pourquoi les musiciens modernes gagnent</a></li>
<li><a href="../fr452528/index.html">Elon Musk: si vous ne r√©duisez pas consid√©rablement les co√ªts, Tesla sera √† court d'argent dans 10 mois</a></li>
<li><a href="../fr452530/index.html">Auto-geeks, fintech et marketing de contenu, ou pourquoi l'assureur devrait externaliser les √©ditions informatiques</a></li>
<li><a href="../fr452532/index.html">Thermom√®tre et hygrom√®tre Arduino avec E-PAPER sur nRF52832 - ou ce que les fabricants ont oubli√© de publier</a></li>
<li><a href="../fr452534/index.html">Nouvelle approche de multiplication Conseils pour am√©liorer les ordinateurs quantiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>