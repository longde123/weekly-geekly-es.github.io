<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôáüèº ü§ûüèø üöâ [√úbersetzung] Funktionsweise von Graal - Java JVM JVM Compiler üëäüèø üë®üèø‚Äçüîß üîï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Ich pr√§sentiere Ihnen die √úbersetzung des Artikels " Verstehen, wie Graal funktioniert - ein in Java geschriebener Java JIT-Compiler ". 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[√úbersetzung] Funktionsweise von Graal - Java JVM JVM Compiler</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419637/"><p> Hallo Habr!  Ich pr√§sentiere Ihnen die √úbersetzung des Artikels " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verstehen, wie Graal funktioniert - ein in Java geschriebener Java JIT-Compiler</a> ". </p><br><h2 id="vvedenie">  Einf√ºhrung </h2><br><p>  Einer der Gr√ºnde, warum ich Forscher in Programmiersprachen wurde, ist, dass in einer gro√üen Gemeinschaft von Menschen, die mit Computertechnologie zu tun haben, fast jeder Programmiersprachen verwendet und viele daran interessiert sind, wie sie funktionieren.  Als ich als Kind zum ersten Mal auf das Programmieren stie√ü und eine Programmiersprache kennenlernte, wollte ich zun√§chst wissen, wie es funktioniert, und als erstes wollte ich meine eigene Sprache erstellen. </p><br><p>  In dieser Pr√§sentation zeige ich Ihnen einige der Arbeitsmechanismen der Sprache, die Sie alle verwenden - Java.  Die Besonderheit ist, dass ich ein Projekt namens <em>Graal verwenden werde</em> , das das Konzept von <em>Java in Java</em> implementiert. </p><a name="habracut"></a><br><p>  Graal ist nur eine der Komponenten in der Arbeit von Java - es ist ein <em>Just-in-Time-</em> Compiler.  Dies ist der Teil der JVM, der Java-Bytecode w√§hrend der Programmausf√ºhrung in Maschinencode konvertiert, und einer der Faktoren, die eine hohe Plattformleistung gew√§hrleisten.  Es scheint mir auch, dass die meisten Leute dies als einen der komplexesten und vagesten Teile der JVM betrachten, was au√üerhalb ihres Verst√§ndnisses liegt.  Diese Meinung zu √§ndern ist der Zweck dieser Rede. </p><br><p>  Wenn Sie wissen, was eine JVM ist;  im Allgemeinen verstehen, was die Begriffe <em>Bytecode</em> und <em>Maschinencode</em> bedeuten;  und in der Lage, in Java geschriebenen Code zu lesen, dann hoffe ich, dass dies ausreicht, um das pr√§sentierte Material zu verstehen. </p><br><p>  Ich werde zun√§chst diskutieren, warum wir m√∂glicherweise einen neuen JIT-Compiler f√ºr die in Java geschriebene JVM wollen, und danach werde ich zeigen, dass dies nichts Besonderes ist, wie Sie vielleicht denken, indem ich die Aufgabe in die Zusammenstellung, Verwendung und Demonstration des Compilers aufteile dass sein Code der gleiche ist wie in jeder anderen Anwendung. </p><br><p>  Ich werde die Theorie ein wenig ansprechen und dann zeigen, wie sie w√§hrend des gesamten Kompilierungsprozesses vom Bytecode bis zum Maschinencode angewendet wird.  Ich werde auch einige Details zeigen, und am Ende werden wir √ºber die Vorteile dieser Funktion sprechen, zus√§tzlich zur Implementierung von <em>Java in Java</em> f√ºr sich. </p><br><p>  Ich werde die Screenshots des Codes in Eclipse verwenden, anstatt sie w√§hrend der Pr√§sentation zu starten, um die unvermeidlichen Probleme der Live-Codierung zu vermeiden. </p><br><h2 id="chto-takoe-jit-kompilyator">  Was ist ein JIT-Compiler? </h2><br><p>  Ich bin sicher, dass viele von Ihnen wissen, was ein JIT-Compiler ist, aber ich werde trotzdem auf die Grundlagen eingehen, damit hier niemand Angst hat, diese Hauptfrage zu stellen. </p><br><p> Wenn Sie den Befehl <code>javac</code> oder <em>compile-on-save</em> in der IDE ausf√ºhren, kompiliert Ihr Java-Programm vom Java-Code zum JVM-Bytecode, der die bin√§re Darstellung des Programms darstellt.  Es ist kompakter und einfacher als der Java-Quellcode.  Der normale Prozessor Ihres Laptops oder Servers kann jedoch nicht nur den JVM-Bytecode ausf√ºhren. </p><br><p>  F√ºr den Betrieb Ihres Programms interpretiert die JVM diesen Bytecode.  Dolmetscher sind normalerweise viel langsamer als Maschinencode, der auf dem Prozessor ausgef√ºhrt wird.  Aus diesem Grund kann die JVM w√§hrend der Ausf√ºhrung des Programms einen anderen Compiler starten, der Ihren Bytecode in Maschinencode konvertiert, den der Prozessor bereits ausf√ºhren kann. </p><br><p>  Dieser Compiler, der normalerweise viel ausgefeilter als <code>javac</code> , f√ºhrt komplexe Optimierungen durch, um als Ergebnis hochwertigen Maschinencode zu erzeugen. </p><br><h2 id="zachem-pisat-jit-kompilyator-na-java">  Warum einen JIT-Compiler in Java schreiben? </h2><br><p>  Bisher enth√§lt eine JVM-Implementierung namens <em>OpenJDK</em> zwei Haupt-JIT-Compiler.  Der als <em>C1</em> bekannte Client-Compiler ist f√ºr einen schnelleren Betrieb ausgelegt, erzeugt jedoch gleichzeitig weniger optimierten Code.  Der als <em>opto</em> oder <em>C2</em> bekannte Server-Compiler ben√∂tigt etwas mehr Zeit zum Arbeiten, erzeugt jedoch optimierten Code. </p><br><p>  Die Idee war, dass der Client-Compiler besser f√ºr Desktop-Anwendungen geeignet war, bei denen lange Pausen im JIT-Compiler unerw√ºnscht waren, und der Server-Compiler f√ºr lang laufende Server-Anwendungen, die mehr Zeit f√ºr das Kompilieren aufwenden konnten. </p><br><p>  Heute k√∂nnen sie so kombiniert werden, dass der Code zuerst von C1 kompiliert wird. Wenn er dann weiterhin intensiv ausgef√ºhrt wird und es sinnvoll ist, zus√§tzliche Zeit zu verbringen, - C2.  Dies wird als <em>gestufte Kompilierung bezeichnet</em> . </p><br><p>  Lassen Sie uns auf C2 eingehen, den Server-Compiler, der weitere Optimierungen durchf√ºhrt. </p><br><p>  Wir k√∂nnen OpenJDK aus dem Spiegel auf <em>GitHub</em> klonen oder einfach den Projektbaum auf der Site √∂ffnen. </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/dmlloyd</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openjdk.git</span></span></code> </pre> <br><p>  Der C2-Code befindet sich in <em>openjdk / hotspot / src / share / vm / opto</em> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/c2.png" alt="Quellcode c2"></p><br><p>  Zun√§chst ist anzumerken, dass C2 in <em>C ++ geschrieben ist</em> .  Das ist nat√ºrlich nichts Schlimmes, aber es gibt bestimmte Nachteile.  C ++ ist eine unsichere Sprache.  Dies bedeutet, dass Fehler in C ++ die VM zum Absturz bringen k√∂nnen.  Der Grund daf√ºr ist wahrscheinlich das Alter des Codes, aber C2 C ++ - Code ist sehr schwierig zu warten und zu entwickeln. </p><br><p>  Cliff Click, eine der Schl√ºsselfiguren hinter dem C2-Compiler, sagte, dass er VM nie wieder in C ++ schreiben w√ºrde, und wir h√∂rten das <em>Twitter-</em> JVM-Team sagen, dass C2 stagniert und aus einem bestimmten Grund ersetzt werden muss Schwierigkeiten bei der Weiterentwicklung. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-1.jpeg" alt="Cliff klicken auf Darstellungation"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-2.png" alt="Was Cliff Click nicht noch einmal machen macht"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://www.youtube.com/watch?v=Hqw57GJSrac</a> </p><br><p>  Zur√ºck zur Frage: Was kann Java in Java zur L√∂sung dieser Probleme beitragen?  Das gleiche, was das Schreiben eines Programms in Java anstelle von C ++ erm√∂glicht.  Dies ist wahrscheinlich Sicherheit (Ausnahmen anstelle von Abst√ºrzen, kein wirklicher Speicherverlust oder baumelnde Zeiger), gute <em>Helfer</em> (Debugger, Profiler und Tools wie <em>VisualVM</em> ), gute IDE-Unterst√ºtzung usw. </p><br><p>  Sie k√∂nnten denken: <em>Wie kann ich so etwas wie einen Java JIT-Compiler schreiben?</em>  und dass dies nur in einer einfachen Systemprogrammiersprache wie C ++ m√∂glich ist.  Ich hoffe, Sie in dieser Pr√§sentation davon zu √ºberzeugen, dass dies √ºberhaupt nicht der Fall ist!  Im Wesentlichen sollte der JIT-Compiler nur den JVM-Bytecode akzeptieren und den Maschinencode ausgeben - Sie geben ihm <code>byte[]</code> am Eingang und Sie m√∂chten auch <code>byte[]</code> .  Dies erfordert viel komplexe Arbeit, wirkt sich jedoch nicht auf die Systemebene aus und erfordert daher keine <em>Systemsprache</em> wie C oder C ++. </p><br><h2 id="nastroyka-graal">  Graal Setup </h2><br><p>  Das erste, was wir brauchen, ist Java 9. Die verwendete Graal-Schnittstelle namens <em>JVMCI</em> wurde Java als Teil der <em>JEP 243 Java-Level-JVM-Compiler-Schnittstelle</em> hinzugef√ºgt. Die erste Version, die sie enth√§lt, ist Java 9. Ich verwende <em>9 + 181</em> .  Bei besonderen Anforderungen gibt es Ports (Backports) f√ºr Java 8. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> export JAVA_HOME=`pwd`/jdk9 <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=<span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> java <span class="hljs-literal"><span class="hljs-literal">-version</span></span> java version <span class="hljs-string"><span class="hljs-string">"9"</span></span> Java(TM) SE Runtime Environment (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>) Java HotSpot(TM) <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-Bit</span></span> Server VM (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>, mixed mode)</code> </pre> <br><p>  Das n√§chste, was wir brauchen, ist ein Build-System namens <code>mx</code> .  Es ist ein bisschen wie <em>Maven</em> oder <em>Gradle</em> , aber h√∂chstwahrscheinlich w√ºrden Sie es nicht f√ºr Ihre Anwendung ausw√§hlen.  Es implementiert bestimmte Funktionen, um einige komplexe Anwendungsf√§lle zu unterst√ºtzen. Wir werden sie jedoch nur f√ºr einfache Assemblys verwenden. </p><br><p>  Sie k√∂nnen <code>mx</code> mit GitHub klonen.  Ich verwende Commit <code>#7353064</code> .  F√ºgen Sie nun einfach die ausf√ºhrbare Datei zum Pfad hinzu. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/mx.git <span class="hljs-variable"><span class="hljs-variable">$</span></span> cd mx; git checkout <span class="hljs-number"><span class="hljs-number">7353064</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=`pwd`/mx:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br><p>  Jetzt m√ºssen wir Graal selbst klonen.  Ich verwende eine Distribution namens <em>GraalVM</em> Version <em>0.28.2</em> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/graal.git -<span class="hljs-literal"><span class="hljs-literal">-branch</span></span> vm<span class="hljs-literal"><span class="hljs-literal">-enterprise</span></span><span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span></code> </pre> <br><p>  Dieses Repository enth√§lt andere Projekte, an denen wir nicht interessiert sind. Gehen Sie also einfach zum <em>Compiler-</em> Unterprojekt, dem Graal JIT-Compiler, und kompilieren Sie es mit <code>mx</code> . </p><br><pre> <code class="hljs ruby">$ cd graal/compiler $ mx build</code> </pre> <br><p>  Um mit Graal-Code zu arbeiten, verwende ich die <em>Eclipse-IDE</em> .  Ich benutze Eclipse 4.7.1.  <code>mx</code> kann Eclipse-Projektdateien f√ºr uns generieren. </p><br><pre> <code class="hljs ruby">$ mx eclipseinit</code> </pre> <br><p>  Um das <em>Graal-</em> Verzeichnis als <em>Arbeitsbereich</em> zu √∂ffnen <em>, m√ºssen</em> Sie <em>Datei, Importieren ..., Allgemein, Bestehende Projekte</em> ausf√ºhren und das <em>Graal-</em> Verzeichnis <em>erneut</em> ausw√§hlen.  Wenn Sie Eclipse nicht unter Java 9 ausgef√ºhrt haben, m√ºssen Sie m√∂glicherweise auch die JDK-Quellen anh√§ngen. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/eclipse.png" alt="Graal in der Finsternis"></p><br><p>  Gut.  Jetzt, da alles fertig ist, wollen wir sehen, wie es funktioniert.  Wir werden diesen sehr einfachen Code verwenden. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { workload(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre> <br><p>  Zuerst kompilieren wir diesen <code>javac</code> Code und f√ºhren dann die JVM aus.  Zun√§chst zeige ich Ihnen, wie der Standard-C2-JIT-Compiler funktioniert.  Dazu geben wir mehrere Flags an: <code>-XX:+PrintCompilation</code> , die erforderlich sind, damit die JVM beim Kompilieren einer Methode ein Protokoll schreibt, und <code>-XX:CompileOnly=Demo::workload</code> , damit nur diese Methode kompiliert wird.  Wenn dies nicht der Fall ist, werden zu viele Informationen angezeigt, und die JVM ist intelligenter als erforderlich und optimiert den gew√ºnschten Code. </p><br><pre> <code class="hljs ruby">$ javac Demo.java $ java \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>+PrintCompilation \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">113</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><p>  Ich werde dies nicht im Detail erkl√§ren, aber ich werde nur sagen, dass dies eine Protokollausgabe ist, die zeigt, dass die <code>workload</code> Methode kompiliert wurde. </p><br><p>  Als JIT-Compiler unserer Java 9-JVM verwenden wir jetzt das frisch kompilierte Graal.  F√ºgen Sie dazu einige weitere Flags hinzu. </p><br><p>  <code>--module-path=...</code> und <code>--upgrade-module-path=...</code> f√ºgen Graal zum <code>--upgrade-module-path=...</code> hinzu.  Ich m√∂chte Sie daran erinnern, dass der <em>Modulpfad</em> in Java 9 als Teil des <em>Jigsaw-</em> Modulsystems <em>angezeigt wurde</em> . F√ºr unsere Zwecke k√∂nnen wir ihn analog zum <em>Klassenpfad betrachten</em> . </p><br><p>  Wir ben√∂tigen das <code>-XX:+UnlockExperimentalVMOptions</code> , da JVMCI (die von Graal verwendete Schnittstelle) in dieser Version eine experimentelle Funktion ist. </p><br><p>  Das Flag <code>-XX:+EnableJVMCI</code> ben√∂tigt, um zu sagen, dass wir JVMCI verwenden m√∂chten, und <code>-XX:+UseJVMCICompiler</code> - um einen neuen JIT-Compiler zu aktivieren und zu installieren. </p><br><p>  Um das Beispiel nicht zu komplizieren und anstatt C1 in Verbindung mit der JVMCI zu verwenden, nur den JVMCI-Compiler zu verwenden, geben Sie das Flag <code>-XX:-TieredCompilation</code> , wodurch die schrittweise Kompilierung deaktiviert wird. </p><br><p>  Wie zuvor geben wir die Flags <code>-XX:+PrintCompilation</code> und <code>-XX:CompileOnly=Demo::workload</code> . </p><br><p>  Wie im vorherigen Beispiel sehen wir, dass eine Methode kompiliert wurde.  Aber dieses Mal haben wir f√ºr die Kompilierung nur zusammengesetztes Graal verwendet.  F√ºrs Erste, nimm einfach mein Wort daf√ºr. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">583</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><h2 id="interfeys-kompilyatora-jvm">  JVM-Compiler-Schnittstelle </h2><br><p>  Denken Sie nicht, dass wir etwas ziemlich Ungew√∂hnliches gemacht haben?  Wir haben eine JVM installiert und den JIT-Compiler durch den gerade kompilierten neuen ersetzt, ohne etwas an der JVM selbst zu √§ndern.  Diese Funktion wird von einer neuen JVM-Schnittstelle namens JVMCI bereitgestellt, der <em>JVM-Compiler-Schnittstelle</em> , die, wie oben erw√§hnt, <em>JEP 243 war</em> und in Java 9 geliefert wurde. </p><br><p>  Die Idee √§hnelt einigen anderen vorhandenen JVM-Technologien. </p><br><p>  Vielleicht sind Sie jemals auf zus√§tzliche Quellcodeverarbeitung in <code>javac</code> mit der <em>Java-API</em> zur <em>Annotationsverarbeitung gesto√üen</em> .  Dieser Mechanismus erm√∂glicht es, Anmerkungen und das Quellcodemodell, in dem sie verwendet werden, zu identifizieren und basierend darauf neue Dateien zu erstellen. </p><br><p>  M√∂glicherweise haben Sie auch zus√§tzliche Bytecode-Verarbeitung in der JVM mithilfe von <em>Java-Agenten verwendet</em> .  Mit diesem Mechanismus k√∂nnen Sie den Java-Bytecode √§ndern, indem Sie ihn beim Booten abfangen. </p><br><p>  Die Idee von JVMCI ist √§hnlich.  Sie k√∂nnen damit Ihren eigenen in Java geschriebenen Java JIT-Compiler verbinden. </p><br><p>  Jetzt m√∂chte ich ein paar Worte dar√ºber sagen, wie ich den Code w√§hrend dieser Pr√§sentation zeigen werde.  Um die Idee zu verstehen, werde ich zun√§chst einige vereinfachte Bezeichner und Logik in Form von Text auf Folien zeigen. Danach werde ich zu Eclipse-Screenshots wechseln und den realen Code zeigen, der etwas komplizierter sein kann, aber die Hauptidee bleibt dieselbe.  Der Hauptteil dieser Pr√§sentation soll zeigen, dass es wirklich m√∂glich ist, mit dem realen Projektcode zu arbeiten, und deshalb m√∂chte ich ihn nicht ausblenden, obwohl er etwas kompliziert sein kann. </p><br><p>  Von nun an zerstreue ich die Meinung, dass der JIT-Compiler m√∂glicherweise sehr kompliziert ist. </p><br><p>  Was akzeptiert der JIT-Compiler f√ºr die Eingabe?  Es akzeptiert den Bytecode der zu kompilierenden Methode.  Und der Bytecode ist, wie der Name schon sagt, nur ein Array von Bytes. </p><br><p>  Was produziert der JIT-Compiler als Ergebnis?  Es gibt den Maschinencode der Methode aus.  Maschinencode ist auch nur ein Array von Bytes. </p><br><p>  Infolgedessen sieht die Schnittstelle, die beim Schreiben eines neuen JIT-Compilers zum Einbetten in die JVM implementiert werden muss, ungef√§hr so ‚Äã‚Äãaus. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] compileMethod(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytecode); }</code> </pre> <br><p>  Wenn Sie sich also nicht vorstellen k√∂nnen, wie Java etwas so Niedriges wie die JIT-Kompilierung in Maschinencode ausf√ºhren kann, k√∂nnen Sie jetzt sehen, dass dies keine so niedrige Arbeit ist.  Richtig?  Dies ist nur eine Funktion von <code>byte[]</code> zu <code>byte[]</code> . </p><br><p>  In Wirklichkeit ist alles etwas komplizierter.  Nur Bytecode reicht nicht aus - wir ben√∂tigen au√üerdem weitere Informationen wie die Anzahl der lokalen Variablen, die erforderliche Stapelgr√∂√üe und die vom Interpreter-Profiler gesammelten Informationen, um zu verstehen, wie der Code tats√§chlich ausgef√ºhrt wird.  Stellen Sie sich daher die Eingabe in Form von <code>CompilationRequest</code> , die uns √ºber die zu kompilierende <code>JavaMethod</code> und alle erforderlichen Informationen bereitstellt. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilationRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">JavaMethod </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaMethod</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getCode(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxLocals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxStackSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ProfilingInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfilingInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... }</code> </pre> <br><p>  Au√üerdem erfordert die Schnittstelle keine R√ºckgabe von kompiliertem Code.  Stattdessen wird eine andere API verwendet, um den Maschinencode in der JVM zu installieren. </p><br><pre> <code class="java hljs">HotSpot.installCode(targetCode);</code> </pre> <br><p>  Um einen neuen JIT-Compiler f√ºr die JVM zu schreiben, m√ºssen Sie nur diese Schnittstelle implementieren.  Wir erhalten Informationen √ºber die Methode, die kompiliert werden muss, und wir m√ºssen sie in Maschinencode kompilieren und <code>installCode</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ HotSpot.installCode(...); } }</code> </pre> <br><p>  Wechseln wir mit Graal zur Eclipse-IDE und sehen uns einige echte Schnittstellen und Klassen an.  Wie bereits erw√§hnt, werden sie etwas komplizierter sein, aber nicht viel. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/jvmci-compiler-interface.png" alt="JVMCICompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-1.png" alt="HotSpotGraalCompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-2.png" alt="compileMethod"></p><br><p>  Jetzt m√∂chte ich zeigen, dass wir √Ñnderungen an Graal vornehmen und diese sofort in Java 9 verwenden k√∂nnen. Ich werde eine neue Protokollmeldung hinzuf√ºgen, die beim Kompilieren der Methode mit Graal angezeigt wird.  F√ºgen Sie es der implementierten Schnittstellenmethode hinzu, die von der JVMCI aufgerufen wird. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(<span class="hljs-string"><span class="hljs-string">"Going to compile "</span></span> + request.getMethod().getName()); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-3.png" alt="Zusammenstellung"></p><br><p>  Deaktivieren Sie vorerst die Kompilierungsprotokollierung in HotSpot.  Jetzt k√∂nnen wir unsere Nachricht von der ge√§nderten Version des Compilers sehen. </p><br><pre> <code class="java hljs">$ java \ --<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ --upgrade-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ -XX:+UnlockExperimentalVMOptions \ -XX:+EnableJVMCI \ -XX:+UseJVMCICompiler \ -XX:-TieredCompilation \ -XX:CompileOnly=Demo::workload \ Demo Going to compile workload</code> </pre> <br><p>  Wenn Sie versuchen, dies selbst zu wiederholen, werden Sie feststellen, dass Sie nicht einmal unser Build-System - <code>mx build</code> - ausf√ºhren m√ºssen.  Genug, normal f√ºr Eclipse, <em>beim Speichern kompilieren</em> .  Und nat√ºrlich m√ºssen wir die JVM selbst nicht neu erstellen.  Wir binden den ge√§nderten Compiler einfach in die vorhandene JVM ein. </p><br><h2 id="graf-graal">  Graf Graal </h2><br><p>  Nun, wir wissen, dass Graal ein <code>byte[]</code> in ein anderes <code>byte[]</code> konvertiert.  Lassen Sie uns nun √ºber die Theorie und Datenstrukturen sprechen, die er verwendet, weil  Sie sind selbst f√ºr den Compiler etwas ungew√∂hnlich. </p><br><p>  Im Wesentlichen verwaltet der Compiler Ihr Programm.  Dazu muss das Programm in Form einer Datenstruktur dargestellt werden.  Eine Option ist Bytecode und √§hnliche Anweisungslisten, die jedoch nicht sehr aussagekr√§ftig sind. </p><br><p>  Stattdessen verwendet Graal ein Diagramm, um Ihr Programm darzustellen.  Wenn wir einen einfachen Additionsoperator verwenden, der zwei lokale Variablen zusammenfasst, enth√§lt das Diagramm einen Knoten zum Laden jeder Variablen, einen Knoten f√ºr die Summe und zwei Kanten, die zeigen, dass das Ergebnis des Ladens der lokalen Variablen in den Additionsoperator eingegeben wird. </p><br><p>  Dies wird manchmal als <em>Programmabh√§ngigkeitsgraph bezeichnet</em> . </p><br><p>  Mit einem Ausdruck der Form <code>x + y</code> erhalten wir Knoten f√ºr die lokalen Variablen <code>x</code> und <code>y</code> und einen Knoten ihrer Summe. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/data-graph.png" alt="Datenflussdiagramm"></p><br><p>  Die blauen R√§nder in diesem Diagramm zeigen die Richtung des Datenflusses vom Lesen lokaler Variablen bis zur Summierung. </p><br><p>  Wir k√∂nnen auch Kanten verwenden, um die Ausf√ºhrungsreihenfolge des Programms widerzuspiegeln.  Wenn wir anstelle des Lesens lokaler Variablen Methoden aufrufen, m√ºssen wir uns die Reihenfolge des Aufrufs merken und k√∂nnen sie nicht neu anordnen (ohne den darin enthaltenen Code zu kennen).  Dazu gibt es zus√§tzliche Kanten, die diese Reihenfolge definieren.  Sie sind rot dargestellt. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/control-graph.png" alt="Kontrollflussdiagramm"></p><br><p>  Das Graal-Diagramm besteht also aus zwei Diagrammen, die in einem zusammengefasst sind.  Die Knoten sind gleich, aber einige Kanten geben die Richtung des Datenstroms an, w√§hrend andere die √úbertragung der Kontrolle zwischen ihnen anzeigen. </p><br><p>  Um das Graal-Diagramm <em>anzuzeigen</em> , k√∂nnen Sie ein Tool namens <em>IdealGraphVisualiser</em> oder <em>IGV verwenden</em> .  Der Start erfolgt mit dem <code>mx igv</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/igv.png" alt="IdealGraphVisualiser"></p><br><p>  F√ºhren Sie danach die JVM mit dem Flag <code>-Dgraal.Dump</code> . </p><br><p>  Ein einfacher Datenstrom kann durch Schreiben eines einfachen Ausdrucks angezeigt werden. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average.png" alt="Arithmetisches mittel igv"></p><br><p>  Sie k√∂nnen sehen, wie die Parameter <code>0</code> ( <code>P(0</code> ) und <code>1</code> ( <code>P(1)</code> ) zum Eingang der Additionsoperation gehen, die zusammen mit der Konstanten <code>2</code> ( <code>C(2)</code> ) zum Eingang der Divisionsoperation gehen, wonach dieser Wert zur√ºckgegeben wird. </p><br><p>  Um einen komplexeren Daten- und Kontrollfluss zu betrachten, f√ºhren wir einen Zyklus ein. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; values.length; n++) { sum += values[n]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum / values.length; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop.png" alt="Arithmetisches Mittel igv mit Zyklus"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop-detail.png" alt="Arithmetisches Medium Detailliertes IGV mit Schleife"></p><br><p>  In diesem Fall haben wir Knoten am Anfang und Ende der Schleife, die die Elemente des Arrays lesen und die L√§nge des Arrays lesen.  Nach wie vor geben die blauen Linien die Richtung des Datenstroms und die roten Linien den Kontrollfluss an. </p><br><p>  Jetzt k√∂nnen Sie sehen, warum diese Datenstruktur manchmal als <em>Knotenmeer</em> oder <em>Knotensuppe bezeichnet wird</em> . </p><br><p>  Ich m√∂chte sagen, dass C2 eine sehr √§hnliche Datenstruktur verwendet, und tats√§chlich war es C2, das die Idee eines Compilers aus einem <em>Meer von Knoten</em> popul√§r machte, sodass dies keine Innovation von Graal ist. </p><br><p>  Ich werde den Prozess der Erstellung dieses Diagramms erst im n√§chsten Teil der Pr√§sentation zeigen, aber wenn Graal das Programm in diesem Format erh√§lt, wird die Optimierung und Kompilierung durch √Ñndern dieser Datenstruktur durchgef√ºhrt.  Dies ist einer der Gr√ºnde, warum das Schreiben eines JIT-Compilers in Java sinnvoll ist.  Java ist eine objektorientierte Sprache, und ein Diagramm ist eine Sammlung von Objekten, die durch Kanten in Form von Links verbunden sind. </p><br><h2 id="ot-baytkoda-k-mashinnomu-kodu">  Vom Bytecode zum Maschinencode </h2><br><p>  Lassen Sie uns sehen, wie diese Ideen in der Praxis aussehen, und einige Schritte des Kompilierungsprozesses befolgen. </p><br><h3 id="poluchenie-baytkoda">  Bytecode erhalten </h3><br><p>  Die Kompilierung beginnt mit dem Bytecode.  Kehren wir zu unserem kleinen Summationsbeispiel zur√ºck. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><p>  Wir geben den am Eingang empfangenen Bytecode kurz vor Beginn der Kompilierung aus. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(request.getMethod().getName() + <span class="hljs-string"><span class="hljs-string">" bytecode: "</span></span> + Arrays.toString(request.getMethod().getCode())); ... } }</code> </pre> <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">workload</span></span> bytecode: [<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>]</code> </pre> <br><p>  Wie Sie sehen k√∂nnen, ist die Eingabe in den Compiler Bytecode. </p><br><h3 id="parser-baytkoda-i-postroitel-grafa">  Bytecode-Parser und Graph Builder </h3><br><p>  <em>Der Builder</em> , der dieses Byte-Array als JVM-Bytecode wahrnimmt, konvertiert es in ein Graal-Diagramm.  Dies ist eine Art <em>abstrakte Interpretation</em> - der Builder interpretiert den Java-Bytecode, manipuliert jedoch anstelle der √úbergabe von Werten die freien Enden der Kanten und verbindet sie schrittweise miteinander. </p><br><p>  Nutzen wir die Tatsache, dass Graal in Java geschrieben ist, und sehen wir, wie es mit den Eclipse-Navigationswerkzeugen funktioniert.  Wir wissen, dass es in unserem Beispiel einen Additionsknoten gibt. Lassen Sie uns also herausfinden, wo er erstellt wurde. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-1.png" alt="Addnode"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-2.png" alt="Suchaufrufe AddNode.create"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-3.png" alt="Parser"></p><br><p>  Es ist ersichtlich, dass sie vom Bytecode-Parser erstellt werden, und dies f√ºhrte uns zum <code>IADD</code> Verarbeitungscode ( <code>96</code> , den wir im gedruckten Eingabearray gesehen haben). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">genArithmeticOp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaKind kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode)</span></span></span><span class="hljs-function"> </span></span>{ ValueNode y = frameState.pop(kind); ValueNode x = frameState.pop(kind); ValueNode v; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (opcode) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LADD: v = genIntegerAdd(x, y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; ... } frameState.push(kind, append(v)); }</code> </pre> <br><p>  Ich habe oben gesagt, dass dies eine abstrakte Interpretation ist, weil  All dies ist einem Bytecode-Interpreter sehr √§hnlich.  Wenn es sich um einen echten JVM-Interpreter handeln w√ºrde, w√ºrde er zwei Werte vom Stapel nehmen, eine Addition durchf√ºhren und das Ergebnis zur√ºcksetzen.  In diesem Fall entfernen wir zwei Knoten aus dem Stapel, die beim Start des Programms Berechnungen sind, f√ºgen, was das Ergebnis der Summierung ist, einen neuen Knoten zum Hinzuf√ºgen hinzu und platzieren ihn auf dem Stapel. </p><br><p>  Somit ist der Graph Graal aufgebaut. </p><br><h3 id="poluchenie-mashinnogo-koda">  Maschinencode abrufen </h3><br><p>  Um ein Graal-Diagramm in Maschinencode zu konvertieren, m√ºssen Sie Bytes f√ºr alle seine Knoten generieren.  Dies erfolgt f√ºr jeden Knoten separat, indem seine <code>generate</code> aufgerufen wird. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Generator gen)</span></span></span><span class="hljs-function"> </span></span>{ gen.emitAdd(a, b); }</code> </pre> <br><p>  Ich wiederhole, hier arbeiten wir auf einem sehr hohen Abstraktionsniveau.  Wir haben eine Klasse, mit der wir Maschinencode-Anweisungen erteilen, ohne auf Einzelheiten der Funktionsweise einzugehen. </p><br><p>  <code>emitAdd</code>       ,          , ,  ,       .      . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>       ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Register dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> encode = prefixAndEncode(dst.encoding); emitByte(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); emitByte(<span class="hljs-number"><span class="hljs-number">0xC0</span></span> | encode); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emitByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ data.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/incl.png" alt="Montageanleitung im Assembler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-byte.png" alt="Byte-Ausgabe"></p><br><p>  ,    ,     <code>ByteBuffer</code> ‚Äî    . </p><br><h3 id="vyhodnoy-mashinnyy-kod">    </h3><br><p>               ‚Äî       . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... System.err.println(method.getName() + <span class="hljs-string"><span class="hljs-string">" machine code: "</span></span> + Arrays.toString(result.getTargetCode())); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/machine-code.png" alt="Druckmaschinencode"></p><br><p>           .    HotSpot.     .     OpenJDK, , -,     JVM,      . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cd openjdk/hotspot/src/share/tools/hsdis <span class="hljs-variable"><span class="hljs-variable">$</span></span> curl <span class="hljs-literal"><span class="hljs-literal">-O</span></span> http://ftp.heanet.ie/mirrors/gnu/binutils/binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> tar <span class="hljs-literal"><span class="hljs-literal">-xzf</span></span> binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> make BINUTILS=binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span> ARCH=amd64 CFLAGS=<span class="hljs-literal"><span class="hljs-literal">-Wno</span></span><span class="hljs-literal"><span class="hljs-literal">-error</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> cp build/macosx<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>/hsdis<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>.dylib ../../../../../..</code> </pre> <br><p>      : <code>-XX:+UnlockDiagnosticVMOptions</code>  <code>-XX:+PrintAssembly</code> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockDiagnosticVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintAssembly \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo</code> </pre> <br><p>             . </p><br><pre> <code class="hljs perl">workload machine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] ... <span class="hljs-number"><span class="hljs-number">0x000000010f71cda0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda5</span></span>: add %edx,%esi ;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0xcba8da9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x0000000102b74006 ; {poll_return} 0x000000010f71cdaf: vzeroupper 0x000000010f71cdb2: retq</span></span></code> </pre> <br><p> .  ,           .    <code>generate</code>   ,         . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddNode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... gen.emitSub(op1, op2, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) ... <span class="hljs-comment"><span class="hljs-comment">// changed from emitAdd } }</span></span></code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-add.png" alt="Ausgabe der AddNode-Anweisung"></p><br><p>    ,  ,      ,      . </p><br><pre> <code class="hljs perl">workload mechine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] <span class="hljs-number"><span class="hljs-number">0x0000000107f451a0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a5</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edx</span></span></span><span class="hljs-function">,%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esi</span></span></span><span class="hljs-function"> </span></span>;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0x1db81a9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x000000010618d006 ; {poll_return} 0x0000000107f451af: vzeroupper 0x0000000107f451b2: retq</span></span></code> </pre> <br><p> ,   ? Graal     ;         ;       ;    .  ,       Graal. </p><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>] ‚Üí [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">...</span></span>]</code> </pre> <br><h2 id="optimizaciya">  </h2><br><p>  ,     ,        .       Graal  ,    . </p><br><p> <em> </em> ‚Äî          .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Graph graph)</span></span></span></span>; }</code> </pre> <br><h3 id="kanonikalizaciya-canonicalisation">  (canonicalisation) </h3><br><p> <em></em>      .       ,       ,      <em> </em> ( <em>constant folding</em> )   . </p><br><p>       ‚Äî       <code>canonical</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> ,  ,    ,      .                  ‚Äî    .    <code>-(-x)</code>  <code>x</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NegateNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> NegateNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((NegateNode) value).getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/negate-node.png" alt="findSynonym in NegateNode"></p><br><p>       Graal   . ,       . </p><br><p>           Java,       <code>canonical</code> . </p><br><h3 id="global-value-numbering"> Global value numbering </h3><br><p> <em>Global value numbering (GVN)</em> ‚Äî       .    <code>a + b</code>    ,   ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) * (a + b); }</code> </pre> <br><p> Graal     .   ‚Äî        .   GVN         .        <em>hash map</em>  ,  ,  . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn.png" alt="Globale Wertnummerierung"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-1.png" alt="Diagramm zur Nummerierung globaler Werte"></p><br><p>    ,   <em></em> ‚Äî  ,      ,     -  .  ,  ,  ,       ,      ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (getA() + getB()) * (getA() + getB()); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-2.png" alt="Ein Diagramm, dessen globaler Wert nicht nummeriert werden kann"></p><br><h3 id="ukrupnenie-blokirovok-lock-coarsening">   (lock coarsening) </h3><br><p>     .               <em></em> . ,     ,      ,   <em></em> ( <em>inlining</em> ). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } }</code> </pre> <br><p>   ,   , , , . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; monitor.exit(); monitor.enter(); counter++; monitor.exit(); }</code> </pre> <br><p>                    .    <em> </em> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; counter++; monitor.exit(); }</code> </pre> <br><p>  Graal       <code>LockEliminationPhase</code> .   <code>run</code>      ,         .  ,        ,           . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StructuredGraph graph)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (monitorExitNode monitorExitNode : graph.getNodes(MonitorExitNode.class)) { FixedNode next = monitorExitNode.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> monitorEnterNode) { AccessmonitorNode monitorEnterNode = (AccessmonitorNode) next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (monitorEnterNode.object() ## monitorExitNode.object()) { monitorExitNode.remove(); monitorEnterNode.remove(); } } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination.png" alt="Vereinfachung der Sperre"></p><br><p>            , , ,      ,          <code>2</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter += <span class="hljs-number"><span class="hljs-number">2</span></span>; monitor.exit(); }</code> </pre> <br><p>    IGV   .  ,   ,       \   ,  , ,        <code>2</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-before.png" alt="Vereinfachen Sie Sperren auf"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-after.png" alt="Vereinfachen Sie Sperren nach"></p><br><h2 id="ne-zatronutye-prakticheskie-aspekty">     </h2><br><p>   Graal   ,  ,      ,          . , , ,          . </p><br><p>       Graal   ,  , ,         ,    ,  ,    . </p><br><h3 id="naznachenie-registrov">   </h3><br><p>    Graal      ,   ,  .        ?          ,      ? </p><br><p> ,  ,    .      .       ,      , ,   ,    .        ,  ,  ,             , ,  . </p><br><p>        <em> </em> ( <em>register allocation</em> ). Graal ,    JIT-,    ‚Äî <em>  </em> ( <em>linear scan algorithm</em> ). </p><br><h3 id="dispetcherizaciya">  </h3><br><p>    ,     ,   ,        -    ,         . </p><br><p> ,       ,   , ,         (..     ),        . ,    ,     . </p><br><p>    <em> </em> ( <em>graph scheduling</em> ).       .       ,          .       ,      , ,        . </p><br><p>                ,     . </p><br><h2 id="v-kakih-sluchayah-ispolzovat-graal">     Graal? </h2><br><p>        , ,   , Graal ‚Äî   ,       <em>Oracle</em> .      ,    Graal? </p><br><h3 id="kompilyator-nizhnego-urovnya-final-tier-compiler">    (final-tier compiler) </h3><br><p> C  JVMCI Graal    <em>  </em>  HotSpot ‚Äî ,     .     (   HotSpot)   Graal    ,    . </p><br><p> <em>Twitter</em>       Graal   ,    Java 9           .       : <code>-XX:+UseJVMCICompiler</code>  . </p><br><p>    JVMCI   ,      Graal   JVM.    (deploy) -  JVM,      Graal.      Java-,   Graal,       JVM. </p><br><p>  OpenJDK   <em>Metropolis</em>       JVM   Java. Graal        . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/metropolis.png" alt="Metropolis-Projekt"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">http://cr.openjdk.java.net/\~jrose/metropolis/Metropolis-Proposal.html</a> </p><br><h3 id="polzovatelskie-optimizacii">   </h3><br><p> Graal    .    Graal   JVM,     Graal   .           ,  Graal       . ,     -     ,    ,                 JNI. </p><br><p> Charles Nutter      <em>JRuby</em>         Graal       Ruby. ,        - . </p><br><h3 id="aot-ahead-of-time-kompilyaciya"> AOT (ahead-of-time)  </h3><br><p> Graal ‚Äî    Java. JVMCI  ,  Graal,    ,     ,    Graal     .  ,     Graal    ,     JIT-. </p><br><p>     JIT-  AOT-      ,  Graal     .       AOT   Graal. </p><br><p> Java 9              JIT-,     .        JVM,          . </p><br><p> AOT Java 9     Graal,       Linux.            ,  ,            . </p><br><p>    . <em>SubstrateVM</em> ‚Äî  AOT-,   Java-    JVM  . ,     - (statically linked)  .    JVM  ,         .     SubstrateVM  Graal.          ( <em>just-in-time</em> ) SubstrateVM, ,   Graal  .   Graal AOT-  . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> javac Hello.java <span class="hljs-variable"><span class="hljs-variable">$</span></span> graalvm<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span>/bin/native<span class="hljs-literal"><span class="hljs-literal">-image</span></span> Hello classlist: <span class="hljs-number"><span class="hljs-number">966.44</span></span> ms (cap): <span class="hljs-number"><span class="hljs-number">804.46</span></span> ms setup: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">514.31</span></span> ms (typeflow): <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">580.70</span></span> ms (objects): <span class="hljs-number"><span class="hljs-number">719.04</span></span> ms (features): <span class="hljs-number"><span class="hljs-number">16.27</span></span> ms analysis: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">422.58</span></span> ms universe: <span class="hljs-number"><span class="hljs-number">262.09</span></span> ms (parse): <span class="hljs-number"><span class="hljs-number">528.44</span></span> ms (inline): <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">259.94</span></span> ms (compile): <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">716.20</span></span> ms compile: <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">817.97</span></span> ms image: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">070.29</span></span> ms debuginfo: <span class="hljs-number"><span class="hljs-number">672.64</span></span> ms write: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">797.45</span></span> ms [<span class="hljs-type"><span class="hljs-type">total</span></span>]: <span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">907.56</span></span> ms <span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-literal"><span class="hljs-literal">-lh</span></span> hello <span class="hljs-literal"><span class="hljs-literal">-rwxr</span></span><span class="hljs-literal"><span class="hljs-literal">-xr</span></span><span class="hljs-literal"><span class="hljs-literal">-x</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> chrisseaton staff <span class="hljs-number"><span class="hljs-number">6.6</span></span>M <span class="hljs-number"><span class="hljs-number">4</span></span> Oct <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> hello <span class="hljs-variable"><span class="hljs-variable">$</span></span> file ./hello ./hellojava: Mach<span class="hljs-literal"><span class="hljs-literal">-O</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-bit</span></span> executable x86_64 <span class="hljs-variable"><span class="hljs-variable">$</span></span> time ./hello Hello! real <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">010</span></span>s user <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s</code> </pre> <br><h3 id="truffle"> Truffle </h3><br><p>     Graal      <em>Truffle</em> . Truffle ‚Äî         JVM. </p><br><p>  ,   JVM,  ,   JIT-   (,    ,   ,  JIT- JVM    ,        ). Truffle    ‚Äî       ,   ,  Truffle, ,              <em> </em> ( <em>partial evaluation</em> ). </p><br><p>         ,             <em> </em> ( <em>inlining</em> )  <em> </em> ( <em>constant folding</em> )      . Graal       ,  Truffle       . </p><br><p>       Graal ‚Äî  Truffle.       Ruby,   <em>TruffleRuby</em>    Truffle , , Graal. TruffleRuby ‚Äî     Ruby,   10   , ,  ,        . </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/graalvm/truffleruby</a> </p><br><h2 id="vyvody">  Schlussfolgerungen </h2><br><p>  ,      ,   ,   JIT- Java         . JIT-   ,          , , -           . ,  ,   .   JIT-    ,   <code>byte[]</code>  JVM  <code>byte[]</code>  . </p><br><p>  ,       Java.           ,   C++. </p><br><p> Java- Graal   - .   ,    ,            . </p><br><p>          .        ,        Eclipse     .           (definitions),     ..    . </p><br><p>          JIT      JIT- JVM,   <em>JITWatch</em> ,   ,        Graal     ,   . ,   ,  -       ,     Graal     JVM.         IDE,       <em>hello-world</em> . </p><br><p>         SubstrateVM  Truffle,   Graal,     ,     Java  .     ,   Graal    Java.  ,    ,   -  <em>LLVM</em> ,    , ,   ,     . </p><br><p> , ,       Graal      JVM.  Weil JVMCI   Java 9, Graal      ,  ,    Java-. </p><br><p> Graal ‚Äî        .    ,      Graal.    ,      ! </p><br><hr><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">More information about TruffleRuby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Low Overhead Polling For Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Top 10 Things To Do With GraalVM</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ruby Objects as C Structs and Vice Versa</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Understanding How Graal Works ‚Äî a Java JIT Compiler Written in Java</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Flip-Flops ‚Äî the 1-in-10-million operator</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Deoptimizing Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Very High Performance C Extensions For JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Optimising Small Data Structures in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pushing Pixels with JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tracing With Zero Overhead in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">How Method Dispatch Works in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">A Truffle/Graal High Performance Backend for JRuby</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de419637/">https://habr.com/ru/post/de419637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de419623/index.html">"SIE": wie wir auf Bilder k√ºnstlicher Intelligenz gekommen sind</a></li>
<li><a href="../de419625/index.html">√úbersicht meiner Lieblingsfunktionen von PHP7</a></li>
<li><a href="../de419627/index.html">Wir suchen Referenten bei Moscow Data Science Major</a></li>
<li><a href="../de419633/index.html">Jetzt werden alle wichtigen Stammzertifikatlisten von Let's Encrypt als vertrauensw√ºrdig eingestuft</a></li>
<li><a href="../de419635/index.html">Ver√∂ffentlichung der stabilen Version von Dart 2.0 und Dart Web Platform</a></li>
<li><a href="../de419641/index.html">Erstellen einer einfachen C # AI in Unity</a></li>
<li><a href="../de419643/index.html">Minsk EPAM Software Engineering Konferenz: Machen Sie es real</a></li>
<li><a href="../de419647/index.html">Seminar ‚ÄûSchwarzer Freitag im E-Commerce. Geheimnisse des √úberlebens, 16. August, Moskau</a></li>
<li><a href="../de419649/index.html">Ein bisschen √ºber Katzen oder welchen CAT wir f√ºr die Synchronisierung von Podcasts ausgew√§hlt haben</a></li>
<li><a href="../de419651/index.html">Weder GA noch YM. Wie wir unseren eigenen Clickstream gemacht haben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>