<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¦ğŸ¿ ğŸ‘°ğŸ» ğŸ’µ Bagaimana Clickhouse dipilih di Galaksi Matahari ğŸ•´ï¸ ğŸˆ·ï¸ ğŸ‘©ğŸ»â€âœˆï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dahulu kala, di galaksi Solar yang sangat jauh, bahkan sebelum menjadi bagian dari alam semesta Rostelecom, sebuah produk webProxy yang kecil muncul t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana Clickhouse dipilih di Galaksi Matahari</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/485850/"><p>  Dahulu kala, di galaksi Solar yang sangat jauh, bahkan sebelum menjadi bagian dari alam semesta Rostelecom, sebuah produk webProxy yang kecil muncul tidak hanya perlu untuk menyaring lalu lintas jaringan, tetapi juga untuk membangun statistik di atasnya dengan penyimpanan berikutnya.  Pada saat itu, basis data kolom tidak sepopuler sekarang.  Satu-satunya analog yang cocok adalah basis data HP Vertica berbayar.  Bagaimana di Galaxy Surya mereka memecahkan masalah ini dan apa yang akhirnya mereka datangi, kami akan katakan di bawah luka. </p><br><p><img src="https://habrastorage.org/webt/ss/in/pp/ssinpppaaj81-bh__txjpuaj3ri.png" alt="gambar"><a name="habracut"></a></p><br><p>  Pertama, kami memutuskan untuk membuat database kami sendiri.  Sebagai hasilnya, ia ditulis dalam OCaml dengan penyimpanan biner kolom (representasi teks dikompresi melalui lz4) dan bahasa querynya sendiri, cukup fleksibel, pada ekspresi S.  Partisi dilakukan per hari. </p><br><p>  Contoh permintaan: </p><br><p><img src="https://habrastorage.org/webt/gh/dr/ij/ghdrijsawxn1qsnod7q3cw-swn0.jpeg" alt="gambar"></p><br><p>  Itu bukan pilihan yang paling nyaman dan cepat, tetapi diperluas dan disesuaikan. <br>  Waktu berlalu, begitu pula kebutuhan untuk mempercepat pembangunan statistik dan laporan lalu lintas.  Karena itu, kami mulai mempertimbangkan opsi lain: </p><br><ul><li>  postgres murni; <br><ul><li>  Postgres + cstore_fdw; </li><li>  Clickhouse; </li><li>  Elastis </li></ul></li></ul><br><h2 id="sravnenie-postgres-vs-elastic">  Perbandingan Postgres vs Elastis </h2><br><p>  Pada tahap pertama, kami membandingkan Elastic dan Postgres + cstore.  Postgres dianggap paling dekat, karena sudah digunakan dalam sistem, dan keahlian tersedia untuk bekerja dengannya. </p><br><p>  Elastis juga aktif digunakan di perusahaan.  Terlepas dari "daya tarik" pencarian teks lengkap dan kecepatannya, Elastic harus ditinggalkan karena terlalu banyak volume yang ditempati oleh data pada disk.  Dalam hal kecepatan, Elastic menang pada kueri sederhana sekitar 3 kali, misalnya, pada kueri "TOP 20 situs dalam seminggu".  Dan pada situs yang lebih kompleks - hingga 9 kali: "TOP 20 situs untuk lalu lintas per bulan." </p><br><p>  Namun, itu lebih baik daripada markasnya sendiri, yang membutuhkan waktu beberapa menit untuk melakukan ini versus 5-6 detik di Elastis dan 15-55 detik di Postgres. </p><br><h2 id="sravnenie-postgres-vs-clickhouse">  Perbandingan Postgres vs Clickhouse </h2><br><h4 id="ishodnye-dannye">  Sumber data </h4><br><p>  Dengan <a href="https://github.com/wizardjedi/clickhouse-test">https://github.com/wizardjedi/clickhouse-test</a> kami mengambil wadah dengan Postgres dan Clickhouse.  Wadah ini dirancang untuk membuat tabel. </p><br><p>  Tampilan tabel untuk Postgres: </p><br><p><img src="https://habrastorage.org/webt/mb/nf/4a/mbnf4aalz2o6fkr4yc1qhsdbaz0.jpeg" alt="gambar"></p><br><p>  Kunci primer harus dihapus, karena tabel asing di Postgres tidak mengizinkan ini. </p><br><p>  Untuk Clickhouse, membuat tabel seperti itu adalah sebagai berikut: </p><br><p><img src="https://habrastorage.org/webt/ur/q3/v6/urq3v6yhc_zdfj6qqs15n79qrwy.jpeg" alt="gambar"></p><br><p>  Untuk membiasakan diri dengan proses menginstal cstore untuk Postgres, buka <a href="https://github.com/citusdata/cstore_fdw">https://github.com/citusdata/cstore_fdw</a> . </p><br><p>  Juga, ketika menginstal cstore, Anda perlu menginstal paket postgresql-server-dev-XY </p><br><p>  Saat membandingkan kinerja, ukuran data berikut (dalam megabita) digunakan: </p><br><p><img src="https://habrastorage.org/webt/mf/8p/4b/mf8p4byqh65atvuboqctq-pywfc.jpeg" alt="gambar"></p><br><p>  Data sumber hanyalah kueri sql yang mencantumkan semua tuple, yaitu.  data mentah. <br>  Selama eksekusi query, terutama yang berat, selain data, dimensi database diukur. </p><br><p>  Terungkap bahwa untuk Clickhouse mereka pasti tidak bertambah. </p><br><p><img src="https://habrastorage.org/webt/ev/py/un/evpyunzfq1hda5c5vsaux2oha1q.jpeg" alt="gambar"></p><br><h4 id="parametry-vychislitelnoy-sistemy">  Parameter Sistem Komputer </h4><br><p> Pabrikan: Intel <br>  Baris: core i5 <br>  Model: 8250U <br>  Frekuensi jam: 1.60GHz per inti <br>  Core: 4 <br>  RAM: 16 GB <br>  SSD: 256 GB </p><br><h4 id="zagruzka-dannyh-v-bd">  Memuat data ke dalam basis data </h4><br><p>  Untuk volume data yang sedemikian besar di Clickhouse, mereka dimuat dengan sangat cepat: 1 jam 40 menit (ini untuk 600 juta tupel). </p><br><p>  Pada awalnya, kami berencana untuk mengunduh semuanya dalam satu file, tetapi kesalahan "bad_alloc" ditampilkan.  Rupanya, karena ketidakmampuan Clickhouse untuk mengalokasikan memori.  Tidak ada solusi yang ditemukan.  Oleh karena itu, 600 juta tuple dibagi menjadi 30 file, masing-masing 20 juta, dalam hal ini, setiap file diunduh sedikit lebih dari 3 menit. </p><br><p>  Dengan Postgres, segalanya menjadi lebih rumit, tetapi hanya pada awalnya.  Mengunduh file sql mentah yang berisi perintah INSERT INTO &lt;table_name&gt; (atribut) VALUES tuples memakan waktu.  Oleh karena itu, semuanya dikonversi ke format csv dan perintah COPY &lt;table_name&gt; FROM WITH CSV dieksekusi. <br></p><p>  Perlu dicatat bahwa pertama-tama kita memuat data ke dalam tabel Postgres biasa, dari tempat kita menyalinnya ke tabel asing, yang dikendalikan oleh cstore.  Akibatnya, memuat Postgres dari file csv juga memakan waktu kurang dari dua jam. </p><br><h4 id="sravnenie-proizvoditelnosti">  Perbandingan kinerja </h4><br><p>  Perbandingan kinerja Postgres dan Clickhouse ditunjukkan pada tabel di bawah ini.  Tetapi tanpa membangun indeks dan mengubah parameter basis data.  Pada titik tertentu, memori pada disk hampir habis, dan karena itu menjadi perlu untuk menghapus tabel reguler yang tidak terkompresi dari Postgres.  Saat ini, hanya tabel yang tersedia di Clickhouse dan Postgres cstore. </p><br><img src="https://habrastorage.org/webt/vg/fz/mb/vgfzmbyouvqkwzand_58ihhetrg.jpeg"><br><p>  Rupanya, cstore berfokus pada atribut pertama yang ditentukan saat membuatnya.  Dengan kata lain, dia mengurutkan semua data dengan itu.  Ini dapat dengan mudah diperhatikan, karena pertanyaan yang berhubungan dengan EventDate lebih cepat dieksekusi di cstore daripada di Postgres. </p><br><p>  Saat menjalankan query, Postgres kadang-kadang memakan waktu hingga 27 GB pada drive eksternal untuk file-file sementara. </p><br><p>  Clickhouse membutuhkan banyak RAM. </p><br><p>  Dalam file konfigurasi /etc/clickhouse/users.xml, &lt;max_memory_usage&gt; 12000000000 &lt;/max_memory_usage&gt; dan &lt;max_bytes_before_external_sort&gt; 1000000000 &lt;/max_btes_before_external_sort&gt; ditentukan. </p><br><p>  Untuk beberapa pertanyaan, RAM tidak cukup, itulah sebabnya kami harus meningkatkannya.  Setelah itu, pemrosesan permintaan berlanjut, tetapi pada permintaan terakhir itu masih terganggu.  Ada beberapa parameter lain yang tersedia untuk membatasi konsumsi memori <a href="https://clickhouse.yandex/docs/ru/query_language/queries/">https://clickhouse.yandex/docs/ru/query_language/queries/</a> . </p><br><p>  Kebetulan kami menambahkan sedikit lebih banyak data ke Clickhouse: 695_640_2000 tuple bukan 600_000_000, tetapi itu tidak menghentikannya untuk menang. </p><br><p>  Di cstore_fdw, Anda dapat mengonfigurasi berbagai parameter <a href="https://github.com/citusdata/cstore_fdw/issues/174">https://github.com/citusdata/cstore_fdw/issues/174</a> , <a href="https://github.com/citusdata/cstore_fdw">https://github.com/citusdata/cstore_fdw</a> , yang memengaruhi kinerja. </p><br><h4 id="particionirovanie">  Partisi </h4><br><p>  Adapun untuk mempartisi, itu juga di Clickhouse <a href="">https://github.com/yandex/ClickHouse/blob/master/docs/ru/table_engines/custom_partitioning_key.md</a> , <a href="https://clickhouse.yandex/docs/ru/table_engines/custom_partitioning_key/">https://clickhouse.yandex/docs/ru/table_engines/custom_partitioning_key /</a> , dan di Postgres (versi 10 dan 11).  Contoh partisi di clickhouse dapat ditemukan di <a href="">https://github.com/yandex/ClickHouse/blob/master/dbms/tests/queries/0_stateless/00502_custom_partitioning_local.sql</a> dan <a href="https://github.com/yandex/ClickHouse/issues/1513">https://github.com/yick/ClickHouse/issues/1513</a> . </p><br><p>  Penggunaan partisi di Postgres dimungkinkan asalkan cstore hanya berfungsi dengan tabel asing, karena Anda perlu membuat server untuk itu, dan Anda tidak dapat menentukan server untuk tabel biasa.  Tabel asing tidak dapat dibagi menjadi partisi, itu sendiri dapat bertindak sebagai partisi.  Oleh karena itu, hanya ada satu cara yang memungkinkan untuk menggunakan partisi: buat tabel induk biasa, Anda bisa melampirkan tabel asing di dalamnya dalam bentuk partisi, yang sudah bekerja pada cstore_fdw. </p><br><p>  Di Clickhouse, mempartisi berfungsi di luar kotak. </p><br><h4 id="vyvod">  Kesimpulan </h4><br><p>  Akibatnya, kami memutuskan untuk menggunakan Clickhouse, karena cerdas: selalu setidaknya 10 kali lebih cepat daripada analog.  Pada server memori, biasanya ada lebih dari 32 Gb, 64, dan 128, jadi pertanyaan di atas meja sekitar 50 Gb akan berjalan dengan baik.  Jika tabelnya sangat besar, yaitu mempartisi, atau memperbaiki parameter server clickhouse akan membantu. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id485850/">https://habr.com/ru/post/id485850/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id485836/index.html">Hubungkan iRig Pro tanpa kabel yang dibundel</a></li>
<li><a href="../id485838/index.html">Perburuan bug Kubernetes resmi dibuka</a></li>
<li><a href="../id485842/index.html">T & J Teknologi PoE</a></li>
<li><a href="../id485844/index.html">Rambut abu-abu atipikal: depigmentasi rambut karena stres</a></li>
<li><a href="../id485846/index.html">Fujitsu dan SUSE Joint Webinar: "Solusi Terbuka dan Andal untuk Era Digital"</a></li>
<li><a href="../id485852/index.html">10 alasan untuk TIDAK memesan audit usability audit online</a></li>
<li><a href="../id485854/index.html">Bantu kompiler C ++ dalam mengatasi kelebihan fungsi</a></li>
<li><a href="../id485856/index.html">Bagaimana kami mencetak hexapod dan apa yang terjadi</a></li>
<li><a href="../id485858/index.html">Bagaimana cara mengajar telepon untuk melihat keindahan</a></li>
<li><a href="../id485862/index.html">DDoS dari pembuat kopi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>