<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏤 🎷 📹 Apa hasil migrasi dari ClickHouse tanpa otorisasi ke ClickHouse dengan otorisasi 🤩 👩🏿‍💻 🍷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mari kita mulai dengan sedikit latar belakang. Di perusahaan kami, sebuah proyek sedang dalam pemeliharaan, yang sampai saat ini masih dalam tahap pen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apa hasil migrasi dari ClickHouse tanpa otorisasi ke ClickHouse dengan otorisasi</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/468779/"><img src="https://habrastorage.org/webt/nt/i1/bm/nti1bmodzcztxtnclfwsh3z5vfs.png"><br><p>  Mari kita mulai dengan sedikit latar belakang.  Di perusahaan kami, sebuah proyek sedang dalam pemeliharaan, yang sampai saat ini masih dalam tahap pengujian / pengembangan.  Pada saat itu, digunakan ClickHouse dengan 3 pecahan, masing-masing 2 replika.  Mempertimbangkan bahwa infrastruktur proyek ini adalah uji dan tidak memerlukan otorisasi tambahan (ClickHouse berada di segmen tertutup), tidak ada yang mengajukan pertanyaan ini. </p><br><p>  Seiring berjalannya waktu, proyek ini berkembang, ClickHouse menjadi basis produksi dan kami memigrasikan data dari infrastruktur lama ke infrastruktur baru dengan 1 shard, 3 replika di 3 server yang berbeda (ClickHouse di-host di Kubernetes berdasarkan StatefulSets) dan, tentu saja, dengan otorisasi. </p><br><p>  Inilah yang terjadi selanjutnya. </p><a name="habracut"></a><br><p>  Hampir segera setelah memulai proyek dalam produksi, kami menemukan bahwa dalam datadir ClickHouse dari database pengguna, dalam tabel non-shard (dalam kasus kami, yang terletak secara lokal pada setiap node, tanpa postfix yang diiris, dari tipe Terdistribusi), ada sejumlah besar tidak hilang bin-log.  Tanggal log mendahului tanggal instalasi pada otorisasi ClickHouse. </p><br><p>  Berikut ini adalah output konsol untuk salah satu replika table table_1 dari database pengujian ClickHouse: </p><br><pre><code class="plaintext hljs">ls -l /var/lib/clickhouse/data/test/table_1/test_usr@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000 | tail -n 10 -rw-r----- 1 clickhouse clickhouse 1472 Jul 8 08:26 9983.bin -rw-r----- 1 clickhouse clickhouse 1453 Jul 8 08:26 9985.bin -rw-r----- 1 clickhouse clickhouse 1383 Jul 8 08:26 9987.bin -rw-r----- 1 clickhouse clickhouse 1461 Jul 8 08:27 9989.bin -rw-r----- 1 clickhouse clickhouse 1458 Jul 8 08:28 9991.bin -rw-r----- 1 clickhouse clickhouse 1468 Jul 8 08:29 9993.bin -rw-r----- 1 clickhouse clickhouse 1413 Jul 8 08:29 9995.bin -rw-r----- 1 clickhouse clickhouse 1509 Jul 8 08:32 9997.bin -rw-r----- 1 clickhouse clickhouse 1504 Jul 8 08:32 9999.bin drwxr-x--- 2 clickhouse clickhouse 4096 Sep 16 12:59 tmp</code> </pre> <br><p>  Yaitu  data itu sendiri ditempatkan di tabel Terdistribusi lokal dari replika tertentu, tetapi untuk alasan yang tidak diketahui pada saat itu, itu tidak dipindahkan ke tabel dengan postfix yang di-shard (seperti ReplicatedMergeTree), yang dapat diakses dari semua replika klaster dengan mengaksesnya melalui tabel lokal (tanpa postfix) beling). </p><br><p>  Ternyata setelah analisis, data yang dicatat dalam database ClickHouse pada infrastruktur lama, yaitu  sebelum memungkinkan otorisasi, mereka tidak dapat lagi didistribusikan di antara replika pada infrastruktur baru, karena  Di server ClickHouse baru, otorisasi telah diaktifkan. </p><br><p>  Kenapa begitu.  Ketika data ditulis ke ClickHouse tanpa otorisasi, tautan dari formulir berikut ini dihasilkan di direktori datadir clickHouse di direktori basis data dan tabel yang sesuai (tautan dihasilkan berdasarkan permintaan yang dibuat ke database): </p><br><pre> <code class="plaintext hljs">test_usr@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000</code> </pre> <br><p>  Mari kita lihat lebih detail.  Tautan di atas diakses oleh pengguna test_usr, tetapi kata sandi untuk otorisasi tidak ditentukan.  Dan apa yang terjadi, jika sebelum mengaktifkan otorisasi dalam database, sejumlah besar data dicatat di ClickHouse, yang membentuk log bin, dan ClickHouse di server lama tidak punya waktu untuk kehilangan mereka, maka setelah mengaktifkan otorisasi pada server ClickHouse baru dan migrasi lama tidak hilang bin-log ke server baru, bin-log ini tidak bisa lagi dimainkan, karena  tautan telah dibuat tanpa otorisasi untuk pengguna test_usr. </p><br><p>  Semua data masuk baru di ClickHouse juga akan menghasilkan bin-log di direktori dan tabel basis data yang sesuai, yang kemudian akan diputar, tetapi dengan tautan yang berbeda, di mana otorisasi ditunjukkan (karena aplikasi sudah mengakses ClickHouse pada infrastruktur baru) dibuat dengan kata sandi untuk pengguna test_usr, jika tidak permintaan tidak akan mencapai basis data): </p><br><pre> <code class="plaintext hljs">test_usr:password@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000</code> </pre> <br><p>  Karena  data ditulis ke basis data secara tidak sinkron, yaitu, mereka pertama kali ditempatkan pada satu replika ClickHouse lokal yang diakses, dan hanya kemudian mereka dikirim ke replika lain dari gugus. </p><br><p>  Akibatnya, data lama yang direkam pada salah satu replika ClickHouse lokal, tetapi tidak didistribusikan di antara sisa replika cluster (karena tautan yang dihasilkan tidak berisi kata sandi untuk pengguna, tetapi sudah ditetapkan), mereka bahkan tidak dapat diakses untuk membaca replika tempat log-bin yang tidak teraplikasi ditempatkan secara langsung. </p><br><p>  Bagaimana kami memecahkan masalah dan tidak kehilangan data yang tidak terisi? </p><br><p>  Semuanya ternyata sangat sederhana.  Cukup untuk melakukan manipulasi berikut dengan data yang tidak terisi dalam database: </p><br><ol><li>  Tautan yang dihasilkan untuk masing-masing tabel dari database masalah harus diganti namanya (diganti namanya) ke formulir yang diperlukan: <br><pre> <code class="plaintext hljs">mv /var/lib/clickhouse/data/test/table_1/test_usr@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000 /var/lib/clickhouse/data/test/table_1/test_usr:password@clickhouse%2D0%2Eclickhouse%2Eclickhouse%2Dprod%2Esvc%2Ecluster%2Elocal\:9000</code> </pre> </li><li>  Mulai ulang replika ClickHouse, yang memulai proses pemutaran log tempat sampah dan menempatkannya di tabel sharded kami (ReplicatedMergeTree). </li></ol><br><p>  <strong>PS</strong> : Saya menyarankan semua orang untuk memeriksa operasi server ClickHouse mereka untuk masalah yang dijelaskan.  Jika ini ditemukan, maka catatan ini akan membantu Anda menghemat waktu mencari solusi dan lebih berhati-hati saat mengatur / mengubah kata sandi di ClickHouse di masa depan. </p><br><h3 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Baca juga artikel lain di blog kami: </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Penerapan Aplikasi Musim Semi Biru-Hijau dengan Nginx Web Server</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Cara menjalankan beberapa saluran pipa menggunakan GitLab CI / CD</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">/etc/resolv.conf untuk opsi Kubernetes, ndots: 5, karena ini dapat mempengaruhi kinerja aplikasi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Memahami paket Konteks di Golang</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Tiga trik sederhana untuk mengurangi gambar buruh pelabuhan</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id468779/">https://habr.com/ru/post/id468779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id468765/index.html">Pentingnya mengkonfirmasi perintah kontrol menggunakan Delimobile sebagai contoh</a></li>
<li><a href="../id468767/index.html">Mainan kayu, bagian dua - 1986-1988</a></li>
<li><a href="../id468769/index.html">Xavier Noria on Rails 6, konsultasi dan banyak lagi</a></li>
<li><a href="../id468773/index.html">Perusahaan energi India NTPC akan membangun taman tenaga surya 5.000 megawatt</a></li>
<li><a href="../id468775/index.html">Supremasi AI: Catur Leela. Atau tentang bagaimana jaringan saraf terbuka sepenuhnya menang</a></li>
<li><a href="../id468781/index.html">Bermain dengan bilangan kompleks</a></li>
<li><a href="../id468785/index.html">Intel Stratix 10 DX melengkapi garis Stratix 10 FPGA</a></li>
<li><a href="../id468793/index.html">Kami berurusan dengan Libra cryptocurrency. Detail</a></li>
<li><a href="../id468799/index.html">Antipatterns dalam React atau Bad Tips for Beginners</a></li>
<li><a href="../id468803/index.html">Bagaimana Kami Membuat Mesin Workflow Kami</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>