<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÉ üë©üèΩ‚Äçüç≥ üò≥ Samba como ADDC no Solaris 11.4 üßëüèΩ üè≥Ô∏è‚Äçüåà ‚ú®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Introdu√ß√£o 
 Quando instalei o pacote Samba pela primeira vez no Solaris, verificou-se que n√£o havia fun√ß√£o ADDC neste pacote. Pesquisas longas na ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Samba como ADDC no Solaris 11.4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438910/"><h2>  1. Introdu√ß√£o </h2><br>  Quando instalei o pacote Samba pela primeira vez no Solaris, verificou-se que n√£o havia fun√ß√£o ADDC neste pacote.  Pesquisas longas na Internet me levaram a respostas desse tipo - o pacote Samba no Solaris n√£o suporta essa fun√ß√£o, e alguns escreveram que essa fun√ß√£o geralmente √© imposs√≠vel de implementar no Solaris.  Mais pesquisas me levaram ao fato de que tudo depende da falta de uma ACL Posix no zfs, bem como no python, usado no Solaris.  Para resolver esses problemas, voc√™ deve usar um disco r√≠gido com o sistema de arquivos ufs, al√©m de criar python (assim como Samba) a partir do c√≥digo-fonte. <br><a name="habracut"></a><br><h2>  Prepara√ß√£o </h2><br>  Todas as a√ß√µes que realizo no VMware ESXI, antes de instalar o sistema, adicionam outro disco r√≠gido √† m√°quina virtual.  Em seguida, voc√™ precisa fazer o download do c√≥digo fonte do Python e do Samba (para a raiz do sistema de arquivos). <br><br><pre><code class="plaintext hljs">wget https://download.samba.org/pub/samba/stable/samba-4.8.8.tar.gz wget https://www.python.org/ftp/python/2.7.15/Python-2.7.15.tgz</code> </pre> <br>  Descompacte arquivos e renomeie pastas para mais conveni√™ncia <br><br><pre> <code class="plaintext hljs">gzip -d samba-4.8.8.tar.gz gzip -d Python-2.7.15.tgz tar -xvf Python-2.7.15.tar tar -xvf samba-4.8.8.tar mv Python-2.7.15 python mv samba-4.8.8 samba</code> </pre><br>  Em seguida, voc√™ precisa instalar o gcc e algumas depend√™ncias <br><br><pre> <code class="plaintext hljs">pkg install gcc pkg install pkgconfig pkg install automake pkg install autoconf</code> </pre><br>  Definir vari√°veis ‚Äã‚Äãpara criar vers√µes x64 <br><br><pre> <code class="plaintext hljs">export CPP="/usr/gcc/7/bin/gcc -E" export CC="/usr/gcc/7/bin/gcc" export CFLAGS="-m64 -std=gnu99 -fPIC -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64" export LDFLAGS="-m64 -L/usr/lib -R/usr/lib" export CXXFLAGS="-m64"</code> </pre><br>  Crie o sistema de arquivos ufs em um disco r√≠gido adicional (especifique o nome usado por voc√™) <br><br><pre> <code class="plaintext hljs">newfs /dev/dsk/c1t1d0s2</code> </pre><br>  Em seguida, voc√™ precisa registrar esse disco r√≠gido no arquivo vfstab (n√£o um erro de digita√ß√£o, no Solaris esse arquivo √© chamado dessa maneira).  Adicione esta linha a este arquivo. <br><br><pre> <code class="plaintext hljs">/dev/dsk/c1t1d0s2 /dev/dsk/c1t1d0s2 /ADDC ufs fsck yes -</code> </pre><br>  Crie um diret√≥rio de montagem e monte o disco r√≠gido nele <br><br><pre> <code class="plaintext hljs">mkdir /ADDC mount /dev/dsk/c1t1d0s2 /ADDC</code> </pre><br><h2>  Montagem e instala√ß√£o </h2><br>  Voc√™ pode come√ßar a construir o Samba e o Python.  V√° para o diret√≥rio com o c√≥digo-fonte Solaris descompactado e construa.  A montagem do samba leva muito tempo. <br><br><pre> <code class="plaintext hljs">cd /samba ./configure --prefix=/ADDC gmake gmake install</code> </pre><br>  Voc√™ n√£o precisa especificar par√¢metros adicionais para criar python, a instala√ß√£o ser√° realizada no diret√≥rio / usr / local <br><br><pre> <code class="plaintext hljs">cd /python ./configure gmake gmake install</code> </pre><br>  Ap√≥s criar o python, voc√™ precisa adicionar o caminho ao python rec√©m-criado na vari√°vel path <br><br><pre> <code class="plaintext hljs">export PATH="/usr/local/bin:/usr/sbin:/usr/bin"</code> </pre><br>  <b>IMPORTANTE:</b> Para que tudo funcione corretamente, voc√™ deve especificar a vari√°vel PATH conforme indicado neste exemplo, o caminho / usr / local / bin deve estar em primeiro lugar. <br>  Ap√≥s estas etapas, usar o Samba como um ADDC n√£o ser√° um problema; para isso, voc√™ precisa executar o script samba-tool <br><br><pre> <code class="plaintext hljs">/ADDC/bin/samba-tool domain provision --use-rfc2307 --dns-backend=SAMBA_INTERNAL --realm=office.virusslayer.su --domain=virusslayer --host-name=ad --host-ip=192.168.1.105 --function-level=2008_R2 --adminpass=Password123456</code> </pre><br>  Indique a regi√£o, dom√≠nio, nome do host que voc√™ precisa, no host-ip usado para este host. <br><br>  O pr√≥ximo passo √© configurar o kerberos. Para isso, √© necess√°rio alterar os seguintes arquivos <br><br><pre> <code class="plaintext hljs">/etc/krb5/krb5.conf /etc/krb5/kdc.conf</code> </pre><br>  O arquivo krb5.conf precisa ser convertido para <br><br><pre> <code class="plaintext hljs">[libdefaults] default_realm = OFFICE.VIRUSSLAYER.SU dns_lookup_realm = false dns_lookup_kdc = true default_tgs_enctypes = aes256-cts-hmac-sha1-96 default_tkt_enctypes = aes256-cts-hmac-sha1-96 permitted_enctypes = aes256-cts-hmac-sha1-96 [realms] OFFICE.VIRUSSLAYER.SU = { kdc = kdc.office.virusslayer.su admin_server = kdc.office.virusslayer.su }</code> </pre><br>  kdc.conf <br><br><pre> <code class="plaintext hljs">[realms] OFFICE.VIRUSSLAYER.SU = { profile = /etc/krb5/krb5.conf acl_file = /etc/krb5/kadm5.acl kadmind_port = 749 max_life = 8h 0m 0s max_renewable_life = 7d 0h 0m 0s default_principal_flags = +preauth }</code> </pre><br>  Para iniciar automaticamente e parar, tive que escrever um script simples no bash <br><br><pre> <code class="plaintext hljs">#!/usr/bin/bash case $1 in start|-start) /ADDC/sbin/samba /ADDC/sbin/smbd /ADDC/sbin/nmbd ;; stop|-stop) rm /ADDC/var/run/*.pid pkill -15 samba pkill -15 smbd pkill -15 nmbd ;; v|-v) /ADDC/sbin/samba -V ;; config|-config) cat /ADDC/etc/smb.conf ;; restart|-restart) rm /ADDC/var/run/*.pid pkill -15 samba pkill -15 smbd pkill -15 nmbd /ADDC/sbin/samba /ADDC/sbin/smbd /ADDC/sbin/nmbd ;; esac</code> </pre><br>  Coloque esse script no arquivo (que o criou anteriormente) / usr / bin / sambactl, torne-o execut√°vel e copie-o para os diret√≥rios rc3.d, rc0.d para iniciar automaticamente e parar o Samba <br><br><pre> <code class="plaintext hljs">touche /usr/bin/sambactl chmod +x /usr/bin/sambactl cp /usr/bin/sambactl /etc/rc3.d/Ssambactl cp /usr/bin/sambactl /etc/rc0.d/Ksambactl</code> </pre><br>  Para uma opera√ß√£o correta, √© necess√°rio alterar o servidor DNS do sistema (o arquivo resolve.conf n√£o precisa ser alterado, as altera√ß√µes s√£o salvas apenas at√© a reinicializa√ß√£o). Para isso, editamos o servi√ßo e atualizamos o status (especifique o endere√ßo IP do sistema atual como servidor) <br><br><pre> <code class="plaintext hljs">svccfg -s dns/client setprop config/nameserver="192.168.1.105" svcadm refresh dns/client</code> </pre><br>  Ap√≥s essas manipula√ß√µes, voc√™ pode iniciar o Samba e tamb√©m adicionar uma entrada dns <br><br><pre> <code class="plaintext hljs">/usr/bin/sambactl /ADDC/bin/samba-tool dns add office.virusslayer.su -U administrator office.virusslayer.su kdc.office.virusslayer.su A 192.168.1.105</code> </pre><br>  Confira o trabalho dos kerberos <br><br><pre> <code class="plaintext hljs">kinit administrator</code> </pre><br>  Se tudo estiver correto e a senha for digitada corretamente, o ticket ser√° criado no diret√≥rio / tmp / volatile-user / 0 <br>  A instala√ß√£o do Kerberos n√£o foi conclu√≠da, voc√™ tamb√©m precisa configurar o servidor de sincroniza√ß√£o de hor√°rio, para isso, criar o arquivo /etc/inet/ntp.conf, iniciar o servi√ßo de hor√°rio e fazer as altera√ß√µes necess√°rias nesse arquivo <br><br><pre> <code class="plaintext hljs">server 127.127.1.0 prefer server 0.europe.pool.ntp.org server 1.europe.pool.ntp.org server 2.europe.pool.ntp.org server 3.europe.pool.ntp.org driftfile /var/ntp/ntp.drift restrict 192.168.1.0 255.255.255.0 nomodify notrap</code> </pre><br>  Na linha restrita, especifique a sub-rede cujo acesso ao servidor de hor√°rio ser√° permitido <br><br>  Iniciar e atualizar o servi√ßo <br><br><pre> <code class="plaintext hljs">svcadm enable ntp svcadm refresh ntp</code> </pre><br>  Para editar pol√≠ticas de grupo, voc√™ pode usar o Remote Administration Tools (RSAT), essas ferramentas podem ser baixadas aqui <br><br><pre> <code class="plaintext hljs">Windows 8.1 https://www.microsoft.com/ru-ru/download/details.aspx?id=39296 Windows 10 https://www.microsoft.com/ru-RU/download/details.aspx?id=45520 Windows 7 https://www.microsoft.com/ru-ru/download/details.aspx?id=7887</code> </pre><br>  Ap√≥s a instala√ß√£o do RSAT no Windows 7, essas ferramentas devem ser ativadas no painel de controle (ativar ou desativar os recursos do Windows).  Depois que o computador for inserido no dom√≠nio, inicie o editor de pol√≠tica de grupo. Na Pol√≠tica de Dom√≠nio Padr√£o, edite a pol√≠tica respons√°vel pelo servidor de hor√°rio. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f85/073/3cd/f850733cda36ad5cc4e0137ad879c883.png" alt="imagem"><br><br>  Nesta se√ß√£o, voc√™ deve habilitar a op√ß√£o "Ativar cliente NTP do Windows", "Configurar cliente NTP do Windows", definir o tipo de NTP, especificar NtpServer office.virusslayer.su <br><br>  Al√©m disso, voc√™ pode configurar o firewall, editar o arquivo /etc/firewall/pf.conf (trazendo-o para o seguinte formul√°rio). <br><br><pre> <code class="plaintext hljs">set skip on lo0 pass quick on lo0 from any to any no state pass in quick on net0 proto {tcp,udp} from any to any port {22,53,123,135,137,464,389,515,636,631,445,139,88,3268,3269,49152:65535} flags S/SA modulate state pass out quick on net0 proto tcp from any to any port {80,443,21,20,53} flags S/SA modulate state pass out quick on net0 proto udp from any to any port=53 keep state pass out quick on net0 proto icmp from any to any block from any to any fragment block from any to any block all</code> </pre><br>  Inicie o servi√ßo e especifique o arquivo com as regras <br><br><pre> <code class="plaintext hljs">svcadm enable firewall pfctl -f /etc/firewall/pf.conf</code> </pre><br><h2>  Conclus√£o </h2><br>  Como voc√™ pode ver nesta publica√ß√£o no Solaris, √© poss√≠vel usar o Samba como um ADDC, embora seja muito mais complicado do que qualquer outro sistema operacional. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438910/">https://habr.com/ru/post/pt438910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438898/index.html">Instala√ß√£o reversa e extens√£o do Chrome</a></li>
<li><a href="../pt438900/index.html">No caminho para os princ√≠pios f√≠sicos da evolu√ß√£o biol√≥gica. Fim + texto completo da tradu√ß√£o</a></li>
<li><a href="../pt438902/index.html">Usando DBREPLICATION ao recolher bancos de dados no Microsoft SQL Server</a></li>
<li><a href="../pt438906/index.html">Compreendendo o protocolo de pagina√ß√£o POCSAG</a></li>
<li><a href="../pt438908/index.html">Treinamento Cisco 200-125 CCNA v3.0. Cisco Certified Network Specialist (CCNA). Dia 1. No√ß√µes b√°sicas de rede</a></li>
<li><a href="../pt438916/index.html">Notas de um fitoqu√≠mico. A batata. Parte tr√™s. "Bullet Fugu" ou SOLANIN</a></li>
<li><a href="../pt438920/index.html">Avalonia: primeiro encontro</a></li>
<li><a href="../pt438922/index.html">Criptografia de tr√°fego no Direct Connect, Parte 2</a></li>
<li><a href="../pt438924/index.html">Notas do provedor de IoT: nove edi√ß√µes da Internet das Coisas ou por que n√£o √© bom na R√∫ssia</a></li>
<li><a href="../pt438928/index.html">Festa da IA ‚Äã‚Äãno Vale do Sil√≠cio: prefeito, bilion√°rio, presidentes, g√™nios, desenvolvedores de processadores e uma garota com cabelos brilhantes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>