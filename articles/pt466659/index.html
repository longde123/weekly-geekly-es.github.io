<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∂üèª üõåüèΩ üòù Revis√£o do Kubecost para economizar dinheiro no Kubernetes nas nuvens üí° üó£Ô∏è üßöüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Atualmente, mais e mais empresas est√£o migrando sua infraestrutura de servidores de ferro e suas pr√≥prias m√°quinas virtuais para as nuvens. Essa solu√ß...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Revis√£o do Kubecost para economizar dinheiro no Kubernetes nas nuvens</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/466659/"><img src="https://habrastorage.org/webt/fu/3l/w8/fu3lw8ytqwbk6znjtlhawezl1qa.png"><br><br>  Atualmente, mais e mais empresas est√£o migrando sua infraestrutura de servidores de ferro e suas pr√≥prias m√°quinas virtuais para as nuvens.  Essa solu√ß√£o √© f√°cil de explicar: n√£o h√° necessidade de cuidar do hardware, o cluster √© facilmente configurado de v√°rias maneiras diferentes ... e o mais importante, as tecnologias dispon√≠veis (como o Kubernetes) facilitam o dimensionamento do poder de computa√ß√£o, dependendo da carga. <br><br>  O aspecto financeiro √© sempre importante.  A ferramenta, que ser√° discutida neste artigo, foi projetada para ajudar a reduzir os or√ßamentos ao usar a infraestrutura de nuvem com o Kubernetes. <a name="habracut"></a><br><br><h2>  1. Introdu√ß√£o </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Kubecost</a> √© uma startup californiana de imigrantes do Google, criando uma solu√ß√£o para calcular custos de infraestrutura em servi√ßos em nuvem (dentro do cluster Kubernetes + recursos compartilhados), encontrando gargalos nas configura√ß√µes do cluster e enviando notifica√ß√µes apropriadas para o Slack. <br><br>  Temos clientes com o Kubernetes nas nuvens conhecidas da AWS e GCP, al√©m de mais raras para a comunidade Linux do Azure - em geral, em todas as plataformas suportadas pelo Kubecost.  Para alguns deles, consideramos os custos dos servi√ßos intra-cluster por conta pr√≥pria (usando uma t√©cnica semelhante √† usada pelo Kubecost), al√©m de monitorar os custos de infraestrutura e tentar otimiz√°-los.  Portanto, √© l√≥gico que est√°vamos interessados ‚Äã‚Äãna capacidade de automatizar essas tarefas. <br><br>  O c√≥digo fonte do m√≥dulo principal do Kubecost √© aberto sob os termos da licen√ßa Open Source (Apache License 2.0).  Pode ser usado livremente, e as fun√ß√µes dispon√≠veis devem ser suficientes para pequenos projetos.  No entanto, neg√≥cios s√£o neg√≥cios: o restante do produto est√° fechado, pode ser usado para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">assinaturas pagas</a> , o que tamb√©m implica suporte comercial.  Al√©m disso, os autores oferecem uma licen√ßa gratuita para pequenos clusters (1 cluster com <s>10 n√≥s</s> - durante a reda√ß√£o deste artigo, esse limite foi expandido para 20 n√≥s) ou um per√≠odo de avalia√ß√£o com recursos completos por 1 m√™s. <br><br><h2>  Como funciona </h2><br>  Portanto, a maior parte do Kubecost √© um aplicativo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b>modelo de custo</b></a> escrito em Go.  O gr√°fico de leme, que descreve todo o sistema, √© chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b>de analisador de custos</b></a> e √© essencialmente um conjunto de modelo de custo com Prometheus, Grafana e v√°rios pain√©is. <br><br>  De um modo geral, o modelo de custo tem sua pr√≥pria interface da web, que exibe gr√°ficos e estat√≠sticas detalhadas sobre custos de forma tabular, bem como, √© claro, dicas sobre como otimizar custos.  Os pain√©is apresentados no Grafana s√£o um est√°gio anterior no desenvolvimento do Kubecost e cont√™m os mesmos dados do modelo de custo, complementando-os com as estat√≠sticas usuais sobre o consumo de CPU / mem√≥ria / rede / espa√ßo em disco no cluster e seus componentes. <br><br>  Como o Kubecost funciona? <br><br><ul><li>  O modelo de custo por meio da API de provedores de nuvem recebe pre√ßos de servi√ßo. </li><li>  Al√©m disso, dependendo do tipo de ferro do site e da regi√£o, o custo por site √© considerado. </li><li>  Com base no custo do trabalho dos n√≥s, cada pod final recebe o custo por hora de uso do processador, gastando um gigabyte de mem√≥ria e o custo de uma hora de armazenamento de um gigabyte de dados - dependendo do n√≥ no qual ele trabalhou ou da classe de armazenamento. </li><li>  Com base no custo do trabalho de pods individuais, o pagamento √© considerado para namespaces, servi√ßos, implanta√ß√µes, StatefulSets. </li><li>  Para calcular estat√≠sticas, s√£o usadas as m√©tricas fornecidas por kube-state-metrics e node-exportator. </li></ul><br>  √â importante observar que o Kubecost, <b>por padr√£o, conta apenas os recursos dispon√≠veis no Kubernetes</b> .  Bancos de dados externos, servidores GitLab, reposit√≥rios S3 e outros servi√ßos que n√£o est√£o no cluster (embora localizados na mesma nuvem) n√£o s√£o vis√≠veis para ele.  Embora para GCP e AWS, voc√™ possa adicionar as chaves das suas contas de servi√ßo e calcular tudo juntas. <br><br><h2>  Instala√ß√£o </h2><br>  Para o Kubecost funcionar, voc√™ precisa: <br><br><ul><li>  Kubernetes vers√£o 1.8 e superior; </li><li>  m√©tricas de estado de cubo; </li><li>  Prometeu; </li><li>  exportador de n√≥s. </li></ul><br>  Aconteceu que em nossos clusters todas essas condi√ß√µes foram atendidas com anteced√™ncia; portanto, foi suficiente apenas para especificar o ponto de extremidade correto para o acesso ao Prometheus.  No entanto, o Helm-chart oficial do kubecost cont√©m tudo o que voc√™ precisa para iniciar em um cluster simples. <br><br>  Existem v√°rias maneiras de instalar o Kubecost: <br><br><ol><li>  O m√©todo de instala√ß√£o padr√£o descrito nas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√µes</a> no site do desenvolvedor.Voc√™ precisa <b>adicionar o reposit√≥rio do analisador de custos ao Helm e, em seguida, instalar o gr√°fico</b> .  Resta apenas encaminhar a porta e concluir as configura√ß√µes para o estado desejado manualmente (via kubectl) e / ou usando a interface da web de modelo de custo. <br><br>  Nem tentamos esse m√©todo, porque n√£o usamos configura√ß√µes prontas de terceiros, no entanto, parece uma boa op√ß√£o "tente voc√™ mesmo".  Se voc√™ j√° possui alguns dos componentes do sistema instalados ou deseja um ajuste mais fino, √© melhor considerar a segunda maneira. <br></li><li>  Use essencialmente <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o mesmo gr√°fico</a> , mas configure e instale independentemente de</b> qualquer maneira conveniente. <br><br>  Como j√° mencionado, al√©m do pr√≥prio kubecost, este gr√°fico cont√©m os gr√°ficos Grafana e Prometheus, que tamb√©m podem ser personalizados conforme desejado. <br><br>  O gr√°fico <code>values.yaml</code> para o analisador de custos dispon√≠vel no gr√°fico permite configurar: <br><br><ul><li>  lista de componentes do analisador de custos a serem implantados; </li><li>  seu ponto final para Prometheus (se voc√™ j√° tiver um); </li><li>  Dom√≠nios e outras configura√ß√µes de entrada para modelo de custo e Grafana; </li><li>  anota√ß√µes para pods; </li><li>  a necessidade de armazenamento permanente e seu tamanho. </li></ul><br>  Uma lista completa de op√ß√µes de configura√ß√£o dispon√≠veis com uma descri√ß√£o est√° na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> . <br><br>  Como o kubecost na vers√£o b√°sica n√£o sabe como restringir o acesso, voc√™ precisar√° configurar imediatamente a autentica√ß√£o b√°sica para o painel da web. <br></li><li>  Instale <b>apenas o n√∫cleo do sistema</b> - modelo de custo.  Para fazer isso, voc√™ deve ter o Prometheus instalado no cluster e especificar o valor correspondente do seu endere√ßo na vari√°vel <code>prometheusEndpoint</code> do Helm.  Depois disso, aplique o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conjunto de configura√ß√µes YAML</a> no cluster. <br><br>  Novamente, voc√™ precisa adicionar manualmente o Ingress com a autentica√ß√£o b√°sica.  E, finalmente, voc√™ precisa adicionar uma se√ß√£o para coletar m√©tricas de modelo de custo em <code>extraScrapeConfigs</code> na configura√ß√£o do Prometheus: <br><br><pre> <code class="plaintext hljs">- job_name: kubecost honor_labels: true scrape_interval: 1m scrape_timeout: 10s metrics_path: /metrics scheme: http dns_sd_configs: - names: - &lt;   kubecost&gt; type: 'A' port: 9003</code> </pre> </li></ol><br><h2>  O que n√≥s ganhamos? </h2><br>  Com uma instala√ß√£o completa, temos √† disposi√ß√£o o painel da web kubecost e o Grafana com um conjunto de pain√©is. <br><br>  <b>O custo total</b> exibido na tela principal mostra realmente o custo estimado dos recursos para o m√™s.  Esse √© o pre√ßo <i>previsto</i> que exibe o custo do uso do cluster (por m√™s) no n√≠vel atual de consumo de recursos. <br><br>  Essa m√©trica √© mais para an√°lise e otimiza√ß√£o de custos.  N√£o √© muito conveniente observar os custos totais do resumo de julho no kubecost: voc√™ precisar√° <b>cobrar</b> por isso.  Mas voc√™ pode ver os custos detalhados por namespaces, r√≥tulos e pods por 1/2/7/30/90 dias, que o faturamento nunca mostrar√°. <br><br><img src="https://habrastorage.org/webt/e7/wy/ue/e7wyueplh3ndwjmv5agldrofhkg.png"><br><br>  Falando de <b>etiquetas</b> .  Voc√™ deve entrar imediatamente nas configura√ß√µes e definir os nomes dos r√≥tulos que ser√£o usados ‚Äã‚Äãcomo categorias adicionais para agrupar os custos: <br><br><img src="https://habrastorage.org/webt/0x/xr/h8/0xxrh8q1doxatdxzdgihdb0yjog.png"><br><br>  Voc√™ pode pendurar qualquer etiqueta nelas - √© conveniente se voc√™ j√° possui seu pr√≥prio sistema de etiquetas. <br><br>  L√°, voc√™ tamb√©m pode alterar o endere√ßo da API do terminal ao qual o modelo de custo se conecta, configurar o tamanho do desconto no GCP e definir seus pr√≥prios pre√ßos de recursos e moeda para mensur√°-los (por algum motivo, o recurso n√£o afeta o Custo total). <br><br>  O Kubecost pode mostrar v√°rios <b>problemas no cluster</b> (e at√© alertar em caso de perigo).  Infelizmente, a op√ß√£o n√£o √© configur√°vel e, portanto, se voc√™ tiver ambientes de desenvolvedor e eles forem usados, poder√° observar constantemente algo como isto: <br><br><img src="https://habrastorage.org/webt/of/gu/we/ofguweanrykbvv5xt7s8_mb-j8o.png"><br><br>  Uma ferramenta importante √© a <b>economia de cluster</b> .  Ele mede a atividade dos pods (consumo de recursos, incluindo a rede) e tamb√©m considera quanto dinheiro e quanto pode ser economizado. <br><br>  Pode parecer que as dicas de otimiza√ß√£o s√£o bastante √≥bvias, mas a experi√™ncia sugere que ainda h√° algo para se olhar.  Em particular, a atividade de rede dos pods √© monitorada (o Kubecost oferece aten√ß√£o aos inativos), s√£o comparados o consumo de mem√≥ria e CPU solicitados e reais, bem como a CPU usada pelos n√≥s do cluster (oferece o recolhimento de v√°rios n√≥s em um), carga do disco e algumas d√∫zias par√¢metros. <br><br>  Como em qualquer problema de otimiza√ß√£o, a otimiza√ß√£o de recursos com base nos dados do Kubecost deve ser <b>tratada com cautela</b> .  Por exemplo, a Economia de cluster sugere a exclus√£o de n√≥s, alegando que √© seguro, mas n√£o leva em conta a presen√ßa de seletores de n√≥ e contamina√ß√£o nos pods implantados neles que n√£o est√£o presentes em outros n√≥s.  De qualquer forma, mesmo os autores do produto em seu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo recente</a> (a prop√≥sito, pode ser muito √∫til para aqueles que est√£o interessados ‚Äã‚Äãno t√≥pico do projeto) recomendam n√£o se apressar de cabe√ßa na otimiza√ß√£o de custos, mas abordar a quest√£o com aten√ß√£o. <br><br><h2>  Sum√°rio </h2><br>  Depois de usar o kubecost por um m√™s em alguns projetos, podemos concluir que esta √© uma ferramenta interessante (e at√© f√°cil de aprender e instalar) para analisar e otimizar os custos dos provedores de nuvem usados ‚Äã‚Äãnos clusters Kubernetes.  Os c√°lculos s√£o muito precisos: em nossos experimentos, eles coincidiram com o que os fornecedores realmente exigiram. <br><br>  N√£o sem desvantagens: existem bugs n√£o cr√≠ticos, a funcionalidade em alguns locais n√£o cobre os requisitos espec√≠ficos de alguns projetos.  No entanto, se voc√™ precisar entender rapidamente para onde vai o dinheiro e o que pode "cortar" para reduzir constantemente a fatura de servi√ßos em nuvem de 5 a 30% (isso aconteceu no nosso caso), essa √© uma √≥tima op√ß√£o. <br><br><h2>  PS </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Escalonamento autom√°tico e gerenciamento de recursos no Kubernetes (revis√£o e relat√≥rio de v√≠deo)</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dailymotion da Kubernetes-adventure: construindo infraestrutura nas nuvens + no local</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dicas e truques do Kubernetes: aloca√ß√£o no local e carregamento de aplicativos da web</a> .‚Äù </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt466659/">https://habr.com/ru/post/pt466659/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt466647/index.html">Telefone para um cavalo e orquestra sem pianista. Como elaborar tarefas esportivas no front-end</a></li>
<li><a href="../pt466649/index.html">Fim de semana em carro el√©trico</a></li>
<li><a href="../pt466651/index.html">Escolhendo entre XML e SQL para rolar scripts LiquiBase usando Java / Spring / H2 como exemplo</a></li>
<li><a href="../pt466653/index.html">Depurando jogos para NES: como isso acontece hoje</a></li>
<li><a href="../pt466657/index.html">Detalhes din√¢micos: jogos secretos do compilador, vazamento de mem√≥ria, nuances de desempenho</a></li>
<li><a href="../pt466661/index.html">Mestrado a Dist√¢ncia no Exterior: Notas Antes da Tese</a></li>
<li><a href="../pt466663/index.html">Experimentos simples com o microcontrolador STM32F103 (Blue Tablet)</a></li>
<li><a href="../pt466665/index.html">Estouro de CSS e perda de dados</a></li>
<li><a href="../pt466667/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n ¬∞ 379 (2 a 8 de setembro de 2019)</a></li>
<li><a href="../pt466669/index.html">Tesla desenvolve baterias capazes de rodar 1,6 milh√£o de km sem reposi√ß√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>