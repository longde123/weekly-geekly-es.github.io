<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ù üßòüèø üßñüèø RBKmoney Payments under the hood - microsservi√ßos, protocolos e configura√ß√£o de plataforma üëéüèº üë©üèΩ‚Äçü§ù‚Äçüë®üèª ‚óºÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Habr! O RBKmoney entra em contato novamente e continua uma s√©rie de artigos sobre como escrever o processamento de pagamento fa√ßa voc√™ mesmo. 




...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RBKmoney Payments under the hood - microsservi√ßos, protocolos e configura√ß√£o de plataforma</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rbkmoney/blog/443518/"><p>  Oi Habr!  O RBKmoney entra em contato novamente e continua uma s√©rie de artigos sobre como escrever o processamento de pagamento fa√ßa voc√™ mesmo. </p><br><p><img src="https://habrastorage.org/webt/nc/w-/dh/ncw-dhwzrbb-b84-afrgy1syhri.jpeg"></p><br><p>  Eu queria mergulhar imediatamente nos detalhes da descri√ß√£o da implementa√ß√£o de um processo de neg√≥cios de pagamento como uma m√°quina de estado, mostrar exemplos dessa m√°quina com um conjunto de eventos, recursos de implementa√ß√£o ... Mas parece que voc√™ n√£o pode prescindir de mais alguns artigos de revis√£o.  A √°rea de assunto acabou sendo muito grande.  Este post ir√° revelar as nuances do trabalho e a intera√ß√£o entre os microsservi√ßos de nossa plataforma, a intera√ß√£o com sistemas externos e como gerenciamos a configura√ß√£o de neg√≥cios. <a name="habracut"></a></p><br><h3 id="makroservis">  Servi√ßo de macro </h3><br><p>  Nosso sistema consiste em muitos microsservi√ßos, que, implementando cada parte final da l√≥gica de neg√≥cios, interagem entre si e juntos formam um servi√ßo de macro.  Na verdade, o servi√ßo de macro implantado no data center, conectado a bancos e outros sistemas de pagamento, √© o nosso processamento de pagamentos. </p><br><h4 id="shablon-mikroservisa">  Modelo de microsservi√ßo </h4><br><p>  Utilizamos uma abordagem unificada para o desenvolvimento de qualquer microsservi√ßo, em qualquer idioma que ele seja escrito.  Cada microsservi√ßo √© um cont√™iner do Docker que cont√©m: </p><br><ul><li>  o pr√≥prio aplicativo que implementa a l√≥gica de neg√≥cios escrita em Erlang ou Java; </li><li>  RPClib - uma biblioteca que implementa a comunica√ß√£o entre microsservi√ßos; <br><ul><li>  usamos o Apache Thrift, suas principais vantagens s√£o bibliotecas cliente-servidor prontas e a capacidade de tipificar estritamente a descri√ß√£o de todos os m√©todos p√∫blicos que cada microsservi√ßo fornece; </li><li> o segundo recurso da biblioteca √© a implementa√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Google Dapper</a> , que permite rastrear solicita√ß√µes rapidamente com uma simples pesquisa no Elasticsearch.  O primeiro microsservi√ßo que recebeu uma solicita√ß√£o de um sistema externo gera um <code>trace_id</code> exclusivo, que √© salvo por cada cadeia de solicita√ß√µes subsequente.  Al√©m disso, geramos e salvamos <code>parent_id</code> e <code>span_id</code> , o que permite criar uma √°rvore de consultas, monitorando visualmente toda a cadeia de microsservi√ßos envolvidos no processamento da solicita√ß√£o; </li><li>  o terceiro recurso - usamos ativamente a transfer√™ncia no n√≠vel de transporte de informa√ß√µes diferentes sobre o contexto da solicita√ß√£o.  Por exemplo, prazos (a vida √∫til esperada da solicita√ß√£o definida no cliente) ou em nome de quem fazemos uma chamada para um m√©todo; </li></ul></li><li>  O modelo Consul √© um agente de descoberta de servi√ßo que mant√©m informa√ß√µes sobre a localiza√ß√£o, disponibilidade e status de um microsservi√ßo.  Os microsservi√ßos se encontram pelos nomes DNS, a zona TTL √© zero, o servi√ßo que morreu ou n√£o passou na verifica√ß√£o de integridade p√°ra de resolver e, portanto, recebe tr√°fego; </li><li>  os logs que o aplicativo grava em um formato compreens√≠vel para o Elasticsearch no arquivo e na <code>filebeat</code> arquivos do cont√™iner local, que est√° sendo executado na m√°quina host em rela√ß√£o ao cont√™iner, coleta esses logs e os envia ao cluster Elasticsearch; <br><ul><li>  como implementamos a plataforma de acordo com o modelo de Event Sourcing, as cadeias de logs resultantes tamb√©m s√£o usadas para visualiza√ß√£o na forma de diferentes pain√©is Grafana, o que nos permite reduzir o tempo para implementar m√©tricas diferentes (tamb√©m usamos m√©tricas separadas). </li></ul></li></ul><br><p><img src="https://habrastorage.org/webt/2v/ac/a2/2vaca2u7qtih8_1iqtl0h_2ywoq.jpeg"></p><br><p>  Ao desenvolver microsservi√ßos, usamos as limita√ß√µes que inventamos especialmente, projetadas para resolver o problema de alta disponibilidade da plataforma e sua toler√¢ncia a falhas: </p><br><ul><li>  limites estritos de mem√≥ria para cada cont√™iner, quando voc√™ ultrapassa os limites - OOM, a maioria dos microsservi√ßos vive dentro de 256-512M.  Isso torna a implementa√ß√£o da l√≥gica de neg√≥cios mais fragmentada, protege contra desvios para o mon√≥lito, reduz o custo do ponto de falha, oferece uma vantagem adicional ao trabalhar com hardware barato (a plataforma √© implantada e √© executada em servidores de processador √∫nico baratos); </li><li>  o menor n√∫mero poss√≠vel de microsservi√ßos com estado e o maior n√∫mero poss√≠vel de implementa√ß√µes sem estado.  Isso nos permite resolver os problemas de toler√¢ncia a falhas, velocidade de recupera√ß√£o e, em geral, minimizar locais com comportamento potencialmente incompreens√≠vel.  Isso se torna especialmente importante com o aumento da vida √∫til do sistema quando um grande legado √© acumulado; </li><li>  deixe travar e "definitivamente quebrar√°" abordagens.  Sabemos que qualquer parte do nosso sistema falhar√° necessariamente; portanto, o projetamos para que isso n√£o afete a corre√ß√£o geral das informa√ß√µes acumuladas na plataforma.  Ajuda a minimizar o n√∫mero de estados indefinidos no sistema. </li></ul><br><p>  <em>Certamente familiar para muitos que se integram com terceiros, a situa√ß√£o.</em>  <em>Esper√°vamos uma resposta de terceiros √† solicita√ß√£o para amortizar o dinheiro de acordo com o protocolo, e uma resposta completamente diferente veio, n√£o descrita em nenhuma especifica√ß√£o, que n√£o se sabe como interpret√°-lo.</em> </p><br><p>  Nessa situa√ß√£o, matamos a m√°quina de estado que atende a esse pagamento, qualquer a√ß√£o externa recebe um erro de 500. E por dentro descobrimos o estado atual do pagamento, alinhamos o estado da m√°quina com a realidade e revivemos a m√°quina de estado. </p><br><h2 id="protocol-oriented-development">  Desenvolvimento Orientado a Protocolo </h2><br><p><img src="https://habrastorage.org/webt/my/8p/o1/my8po16kkxanpoanxnzrea_i7gg.jpeg"></p><br><p>  No momento da reda√ß√£o deste artigo, 636 verifica√ß√µes diferentes foram registradas em nosso Service Discovery para servi√ßos que garantem o funcionamento da plataforma.  Mesmo considerando que v√°rias verifica√ß√µes est√£o sendo executadas em um servi√ßo e tamb√©m que a maioria dos servi√ßos sem estado funciona em pelo menos uma inst√¢ncia tripla, ainda √© poss√≠vel obter cinquenta aplicativos que precisam ser capazes de se conectar de alguma forma e n√£o falhar no inferno da RPC. </p><br><p>  A situa√ß√£o √© complicada pelo fato de termos tr√™s linguagens de desenvolvimento na pilha - Erlang, Java, JS e todas elas precisam ser capazes de se comunicar de forma transparente. </p><br><p>  A primeira tarefa que precisou ser resolvida foi projetar a arquitetura correta para a troca de dados entre microsservi√ßos.  Como base, adotamos o Apache Thrift.  Todos os microsservi√ßos trocam bin√°rios de trift; usamos o HTTP como transporte. </p><br><p>  Colocamos as especifica√ß√µes de fonte na forma de reposit√≥rios separados no nosso github, para que estejam dispon√≠veis para qualquer desenvolvedor que tenha acesso a elas.  Inicialmente, eles usaram um reposit√≥rio comum para todos os protocolos, mas com o tempo chegaram √† conclus√£o de que isso √© inconveniente - o trabalho paralelo conjunto de protocolos se transformou em uma dor de cabe√ßa constante.  Equipes diferentes e at√© desenvolvedores diferentes foram for√ßados a concordar com o nome das vari√°veis, uma tentativa de dividir em espa√ßo para nome tamb√©m n√£o ajudou. </p><br><p>  Em geral, podemos dizer que temos um desenvolvimento orientado a protocolos.  Antes de iniciar qualquer implementa√ß√£o, desenvolvemos o futuro protocolo de microsservi√ßo na forma de uma especifica√ß√£o de eleva√ß√£o, passamos por 7 c√≠rculos de revis√£o, atraindo futuros clientes desse microsservi√ßo e temos a oportunidade de come√ßar a desenvolver simultaneamente v√°rios microsservi√ßos em paralelo, porque conhecemos todos os seus m√©todos futuros e j√° podemos escrever seus manipuladores, opcionalmente usando moki. </p><br><p>  Uma etapa separada no processo de desenvolvimento de protocolo √© uma revis√£o de seguran√ßa, na qual os caras examinam, do ponto de vista de seus detetives, as nuances da especifica√ß√£o que est√° sendo desenvolvida. </p><br><p>  Tamb√©m consideramos apropriado destacar uma fun√ß√£o separada do propriet√°rio do protocolo na equipe.  A tarefa √© dif√≠cil, uma pessoa precisa ter em mente as especificidades de todos os microsservi√ßos, mas compensa em grande escala e a presen√ßa de um √∫nico ponto de escala√ß√£o. </p><br><p>  Sem a aprova√ß√£o final da solicita√ß√£o de recebimento por esses funcion√°rios, o protocolo n√£o pode ser mesclado em uma filial principal.  Existe uma funcionalidade muito conveniente no github para isso - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">propriet√°rios de c√≥digo</a> , n√≥s a usamos com prazer. </p><br><p>  Assim, resolvemos o problema de comunica√ß√£o entre microsservi√ßos, poss√≠veis problemas de mal-entendido que tipo de microsservi√ßo apareceu na plataforma e por que √© necess√°rio.  Esse conjunto de protocolos √© talvez a √∫nica parte da plataforma em que escolhemos incondicionalmente a qualidade em rela√ß√£o ao custo e √† velocidade do desenvolvimento, porque a implementa√ß√£o de um microsservi√ßo pode ser reescrita de maneira relativamente indolor e o protocolo no qual v√°rias dezenas j√° s√£o caras e dolorosas. </p><br><p>  Ao longo do caminho, o registro preciso ajuda a resolver o problema da documenta√ß√£o.  Nomes razoavelmente escolhidos de m√©todos e par√¢metros, alguns coment√°rios e uma especifica√ß√£o auto-documentada economizam muito tempo! </p><br><p>  Por exemplo, √© assim que a especifica√ß√£o do m√©todo de um de nossos microsservi√ßos √© exibida, permitindo que voc√™ obtenha uma lista de eventos que ocorreram na plataforma: </p><br><pre> <code class="plaintext hljs">/**    */ typedef i64 EventID /* Event sink service definitions */ service EventSink { /** *       ,   *    ,  ,  `range`.  *      `0`  `range.limit` . * *   `range.after`    ,   * ,        , *   `EventNotFound`. */ Events GetEvents (1: EventRange range) throws (1: EventNotFound ex1, 2: base.InvalidRequest ex2) /** *         *  . */ base.EventID GetLastEventID () throws (1: NoLastEvent ex1) } /* Events */ typedef list&lt;Event&gt; Events /** * ,    -,  . */ struct Event { /** *  . *    ,     *      (total order). */ 1: required base.EventID id /** *   . */ 2: required base.Timestamp created_at /** *  -,  . */ 3: required EventSource source /** *  ,    ( ) *   -,  . */ 4: required EventPayload payload /** *      . *    . */ 5: optional base.SequenceID sequence } // Exceptions exception EventNotFound {} exception NoLastEvent {} /** * ,       -   */ exception InvalidRequest { /**          */ 1: required list&lt;string&gt; errors }</code> </pre> <br><h3 id="thrift-console-client">  Cliente do console Thrift </h3><br><p>  √Äs vezes, somos confrontados com a tarefa de chamar certos m√©todos do microsservi√ßo necess√°rio diretamente, por exemplo, com as m√£os do terminal.  Isso pode ser √∫til para depura√ß√£o, obten√ß√£o de um conjunto de dados brutos ou quando a tarefa √© t√£o rara que o desenvolvimento de uma interface de usu√°rio separada √© impratic√°vel. </p><br><p>  Portanto, desenvolvemos uma ferramenta para n√≥s mesmos que combina as fun√ß√µes de <code>curl</code> , mas permite que voc√™ fa√ßa solicita√ß√µes de trift na forma de estruturas JSON.  N√≥s o chamamos de acordo - <code>woorl</code> .  O utilit√°rio √© universal, basta transferir a localiza√ß√£o de qualquer especifica√ß√£o de eleva√ß√£o para ele usando o par√¢metro de linha de comando; ele far√° o resto sozinho.  Um utilit√°rio muito conveniente, voc√™ pode iniciar um pagamento diretamente no terminal, por exemplo. </p><br><p>  √â assim que o apelo √© direcionado diretamente ao microsservi√ßo da plataforma, respons√°vel pelo gerenciamento de aplicativos (por exemplo, para criar uma loja).  Solicitei dados na minha conta de teste: </p><br><p><img src="https://habrastorage.org/webt/zk/9f/zy/zk9fzypaopdlugw06vwkso2qt0q.jpeg"></p><br><p>  <em>Os leitores observadores provavelmente notaram um recurso na captura de tela.</em>  <em>Tamb√©m n√£o gostamos disso.</em>  <em>√â necess√°rio fixar a autoriza√ß√£o de trift calls entre microsservi√ßos, √© necess√°rio colar o TLS de maneira adequada.</em>  <em>Mas enquanto os recursos, como sempre, n√£o s√£o suficientes.</em>  <em>N√≥s nos limitamos √† cobertura total do per√≠metro em que vivem os microsservi√ßos de processamento.</em> </p><br><h2 id="protokoly-obscheniya-s-vneshnimi-sistemami">  Protocolos para comunica√ß√£o com sistemas externos </h2><br><p>  Para publicar especifica√ß√µes externas de eleva√ß√£o e for√ßar nossos comerciantes a se comunicar usando o protocolo bin√°rio, consideramos isso muito cruel para eles.  Era necess√°rio escolher um protocolo leg√≠vel por humanos que nos permitisse integrar convenientemente conosco, depurar e poder documentar convenientemente.  Escolhemos o padr√£o Open API, tamb√©m conhecido como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Swagger</a> . </p><br><p>  Voltando ao problema de documentar protocolos, o Swagger permite que voc√™ resolva esse problema de maneira r√°pida e barata.  A rede possui muitas implementa√ß√µes do belo design da especifica√ß√£o Swagger na forma de documenta√ß√£o do desenvolvedor.  Examinamos tudo o que pudemos encontrar e, finalmente, escolhemos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ReDoc</a> , uma biblioteca JS que aceita o swagger.json como entrada e gera essa documenta√ß√£o de tr√™s colunas na sa√≠da: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://developer.rbk.money/api/</a> . </p><br><p>  As abordagens para o desenvolvimento de ambos os protocolos, Thrift interno e Swagger externo, s√£o absolutamente id√™nticas para n√≥s.  Isso adiciona tempo ao desenvolvimento, mas compensa a longo prazo. </p><br><p>  Tamb√©m precis√°vamos resolver outro problema importante - n√£o apenas aceitamos solicita√ß√µes de baixa de dinheiro, mas tamb√©m as enviamos ainda mais - para bancos e sistemas de pagamento. </p><br><p>  For√ß√°-los a implementar nosso elevador seria uma tarefa ainda mais impratic√°vel do que envi√°-lo para APIs p√∫blicas. </p><br><p>  Portanto, criamos e implementamos o conceito de adaptadores de protocolo.  Esse √© apenas outro microsservi√ßo que implementa nossa especifica√ß√£o de eleva√ß√£o interna de um lado, que √© a mesma para toda a plataforma, e o segundo √© um protocolo externo espec√≠fico para um banco ou subesta√ß√£o espec√≠fica. </p><br><p>  <em>Os problemas que surgem ao escrever esses adaptadores quando voc√™ precisa interagir com terceiros √© um t√≥pico rico em hist√≥rias diferentes.</em>  <em>Em nossa pr√°tica, encontramos coisas diferentes, respostas do formul√°rio: "√© claro que voc√™ pode implementar essa fun√ß√£o conforme descrito no protocolo que lhe fornecemos, mas n√£o dou garantias. A√≠ vem nossa pessoa doente em duas semanas, que √© para tudo isso responde, e voc√™ pede a ele confirma√ß√£o ".</em>  <em>Al√©m disso, tais situa√ß√µes n√£o s√£o incomuns: "aqui est√° o nome de usu√°rio e a senha do nosso servidor, v√° l√° e configure tudo sozinho".</em> </p><br><p>  <em>Acho isso particularmente interessante quando nos integramos a um parceiro de pagamento, que, por sua vez, j√° havia se integrado √† nossa plataforma e efetuado pagamentos com sucesso por meio de n√≥s (isso geralmente acontece, as especificidades comerciais do setor de pagamentos).</em>  <em>Em resposta √† nossa solicita√ß√£o de um ambiente de teste, o parceiro respondeu que n√£o possu√≠a um ambiente de teste como tal, mas poderia obter tr√°fego para integra√ß√£o com o RBC, ou seja, com nossa plataforma, onde poder√≠amos nos envolver.</em>  <em>√â assim que n√≥s, por meio de um parceiro, nos integramos uma vez.</em> </p><br><p>  Assim, resolvemos simplesmente o problema de implementar a conex√£o paralela em massa de v√°rios sistemas de pagamento e outros terceiros.  Na grande maioria dos casos, voc√™ n√£o precisa tocar no c√≥digo da plataforma para isso, basta escrever os adaptadores e adicionar mais instrumentos de pagamento √† enumera√ß√£o. </p><br><p>  Como resultado, conseguimos esse esquema de trabalho - procuramos fora dos microsservi√ßos da API do RBKmoney (os chamamos de API comum ou capi *, voc√™ os viu no c√¥nsul acima), que validam os dados de entrada de acordo com a especifica√ß√£o p√∫blica do Swagger, autorizam clientes, transmitem esses m√©todos para nossas chamadas internas de eleva√ß√£o e envia solicita√ß√µes da cadeia para o pr√≥ximo microsservi√ßo.  Al√©m disso, esses servi√ßos implementam outro requisito de plataforma, cuja especifica√ß√£o t√©cnica foi formulada como: "o sistema sempre deve ter a oportunidade de adquirir um gato". </p><br><p>  Quando precisamos fazer uma chamada para algum sistema externo, os microsservi√ßos internos extraem os m√©todos de eleva√ß√£o do adaptador de protocolo correspondente, eles os traduzem para o idioma de um banco ou sistema de pagamento espec√≠fico e os enviam. </p><br><h3 id="trudnosti-obratnoy-sovmestimosti-protokolov">  Dificuldades de compatibilidade com vers√µes anteriores do protocolo </h3><br><p>  A plataforma est√° em constante evolu√ß√£o, novas fun√ß√µes s√£o adicionadas, antigas s√£o alteradas.  Em tais circunst√¢ncias, voc√™ deve investir no suporte √† compatibilidade com vers√µes anteriores ou atualizar constantemente os microsservi√ßos dependentes.  E se a situa√ß√£o em que o campo obrigat√≥rio se tornar opcional for simples, voc√™ n√£o poder√° fazer nada; no caso contr√°rio, precisar√° gastar recursos adicionais. </p><br><p>  Com um conjunto de protocolos internos, as coisas ficam mais f√°ceis.  O setor de pagamentos raramente muda para que apare√ßam alguns m√©todos de intera√ß√£o fundamentalmente novos.  Tomemos, por exemplo, uma tarefa comum para n√≥s - conectar um novo provedor a um novo instrumento de pagamento.  Por exemplo, processamento de carteira local, que permite processar pagamentos no Cazaquist√£o em tenge.  Essa √© uma nova carteira para nossa plataforma, mas, em princ√≠pio, n√£o difere da mesma carteira Qiwi - ela sempre possui alguns identificadores e m√©todos exclusivos que permitem debitar / cancelar o d√©bito nela. </p><br><p>  Assim, nossa especifica√ß√£o de elevador para todos os fornecedores de carteiras √© assim: </p><br><pre> <code class="plaintext hljs">typedef string DigitalWalletID struct DigitalWallet { 1: required DigitalWalletProvider provider 2: required DigitalWalletID id } enum DigitalWalletProvider { qiwi rbkmoney }</code> </pre> <br><p>  e adicionar um novo meio de pagamento na forma de uma nova carteira simplesmente complementa a enumera√ß√£o: </p><br><pre> <code class="plaintext hljs">enum DigitalWalletProvider { qiwi rbkmoney newwallet }</code> </pre> <br><p>  Agora, resta aumentar todos os microsservi√ßos usando essa especifica√ß√£o, sincronizando com o assistente de reposit√≥rio com a especifica√ß√£o e implementando-os via CI / CD. </p><br><p>  Protocolos externos s√£o mais complicados.  Cada atualiza√ß√£o da especifica√ß√£o Swagger, especialmente sem compatibilidade com vers√µes anteriores, √© quase imposs√≠vel de aplicar dentro de um per√≠odo de tempo razo√°vel - √© improv√°vel que nossos parceiros mantenham recursos gratuitos para desenvolvedores especificamente para atualizar nossa plataforma. </p><br><p>  <em>E √†s vezes isso √© simplesmente imposs√≠vel, ocasionalmente encontramos situa√ß√µes como: "o programador nos escreveu e foi embora, levou as fontes conosco, como trabalhamos, n√£o sabemos, funciona e n√£o tocamos".</em> </p><br><p>  Portanto, investimos no suporte √† compatibilidade com vers√µes anteriores em protocolos externos.  Em nossa arquitetura, isso √© um pouco mais f√°cil - j√° que usamos adaptadores de protocolo separados para cada vers√£o espec√≠fica da API comum, deixamos os microsservi√ßos capi antigos para trabalhar, alterando apenas a parte que parece uma triagem dentro da plataforma, se necess√°rio.  Assim, os microsservi√ßos <code>capi-v1</code> , <code>capi-v2</code> , <code>capi-v3</code> e assim por diante aparecem e permanecem conosco para sempre. </p><br><p>  O que acontecer√° quando o <code>capi-v33</code> , provavelmente teremos que descontinuar algumas vers√µes antigas. </p><br><p>  <em>Nesse ponto, geralmente come√ßo a entender muito bem empresas como a Microsoft e toda a sua dor no suporte √† compatibilidade com vers√µes anteriores de solu√ß√µes que est√£o funcionando h√° d√©cadas.</em> </p><br><h2 id="nastraivaem-sistemu">  Personalize o sistema </h2><br><p>  E, encerrando o t√≥pico, mostraremos como gerenciamos as configura√ß√µes de plataforma espec√≠ficas da empresa. </p><br><p>  Apenas efetuar um pagamento n√£o √© t√£o f√°cil quanto parece.  Para cada pagamento, o cliente comercial deseja anexar um grande n√∫mero de condi√ß√µes - desde a comiss√£o at√©, em princ√≠pio, a possibilidade de uma implementa√ß√£o bem-sucedida, dependendo da hora do dia.  N√≥s nos propusemos a tarefa de digitalizar todo o conjunto de condi√ß√µes que um cliente comercial pode apresentar agora e no futuro e aplicamos esse conjunto a cada pagamento rec√©m-lan√ßado. </p><br><p>  Como resultado, decidimos desenvolver nosso pr√≥prio DSL, para o qual parafusamos ferramentas para um gerenciamento conveniente que nos permite descrever o modelo de neg√≥cios da maneira correta: a escolha dos adaptadores de protocolo, uma descri√ß√£o do plano de postagem, segundo o qual o dinheiro ser√° espalhado nas contas do sistema, estabelecendo limites, comiss√µes, categorias e outras coisas espec√≠ficas ao sistema de pagamento. </p><br><p>  Por exemplo, quando queremos receber uma comiss√£o de 1% pela aquisi√ß√£o de cart√µes do maestro e do MS e espalh√°-la nas contas dentro do sistema, configuramos o dom√≠nio da seguinte maneira: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"cash_flow"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"decisions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"if_"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"any_of"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_tool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bank_card"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"definition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_system_is"</span></span>: <span class="hljs-string"><span class="hljs-string">"maestro"</span></span> } } } } }, { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_tool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bank_card"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"definition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_system_is"</span></span>: <span class="hljs-string"><span class="hljs-string">"mastercard"</span></span> } } } } } ] }, <span class="hljs-attr"><span class="hljs-attr">"then_"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"system"</span></span>: <span class="hljs-string"><span class="hljs-string">"settlement"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"destination"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"provider"</span></span>: <span class="hljs-string"><span class="hljs-string">"settlement"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"volume"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"share"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"parts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"p"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"q"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"of"</span></span>: <span class="hljs-string"><span class="hljs-string">"operation_amount"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"details"</span></span>: <span class="hljs-string"><span class="hljs-string">"1% processing fee"</span></span> } ] } } ] } }</code> </pre> <br><p>  ,         ,   .     ,             JSON.    ,    ,    ,  .        ,  ,     .  ,  CVS/SVN-. </p><br><p>    "               ". , ,     ,     1%,   ,    ,    .    ,        ,   .         ,         . </p><br><p> <em> cvs-like        ,       .   ,    ‚Äî  stateless, ,               .         .         .</em> </p><br><p> <em>    -     .            ,      ,   .     ,    ,                   .</em> </p><br><p> <em>             .     ,   10   ,     ,           .</em> </p><br><p>     , ,    ,   -,       woorl-.    -        JSON-  .    -  JS,       ,      UX: </p><br><p><img src="https://habrastorage.org/webt/c0/ni/ge/c0nigeglg1reebztmvml6svc7ia.jpeg"></p><br><p>           ,    ,         ,          . </p><br><p>     , , . </p><br><p>        ,     ,       SaltStack. </p><br><p> ,    ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt443518/">https://habr.com/ru/post/pt443518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt443508/index.html">Jogos educativos de tabuleiro para programadores</a></li>
<li><a href="../pt443510/index.html">Notebook Compaq Armada 7700 - como um desenvolvimento da linha Compaq LTE</a></li>
<li><a href="../pt443512/index.html">Hackathon de An√°lise de Dados em Nizhny Novgorod</a></li>
<li><a href="../pt443514/index.html">Escrevendo sua camada de rede no Swift: abordagem orientada a protocolo</a></li>
<li><a href="../pt443516/index.html">Hacker Geohot decidiu libertar pessoas da simula√ß√£o de IA</a></li>
<li><a href="../pt443520/index.html">Escolhendo um carro para um especialista em TI ou dicas para bules de uma chaleira</a></li>
<li><a href="../pt443522/index.html">Hospedagem: op√ß√µes, compara√ß√µes, estat√≠sticas do usu√°rio</a></li>
<li><a href="../pt443524/index.html">Fa√ßa voc√™ mesmo anima√ß√µes em Flash no Unity3D. Parte Um, L√≠rico</a></li>
<li><a href="../pt443526/index.html">Dos algoritmos ao c√¢ncer: palestras da Escola de Bioinform√°tica</a></li>
<li><a href="../pt443528/index.html">Amazon lan√ßou o Open Distro for Elasticsearch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>