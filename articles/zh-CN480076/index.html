<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ€ ğŸ‘¨ğŸ¿â€ğŸš’ ğŸº å¯¹æ¥è‡ªå„ç§æ¥æºçš„æ•°æ®è¿›è¡Œå¤šå¤„ç†å’Œæ ¸å¯¹ ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦ ğŸ•´ğŸ¿ ğŸ§˜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å“ˆHaï¼ 

 è€ƒè™‘åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤šæ ·æ€§ï¼Œç›®æ ‡å­˜å‚¨ä¸­å·²éªŒè¯ä¿¡æ¯çš„å¯ç”¨æ€§æ˜¯æ•°æ®ä¸€è‡´æ€§çš„é‡è¦æ ‡å‡†ã€‚ 

 æœ‰è®¸å¤šæ–¹æ³•å’Œæ–¹æ³•å¯ä»¥è¾¾åˆ°è¿™ç§æ•ˆæœï¼Œæˆ‘ä»¬å°†é‡ç‚¹æ”¾åœ¨å’Œè§£ä¸Šï¼Œæœ¬æ–‡åœ¨æœ¬æ–‡ä¸­è®¨è®ºäº†å…¶ç†è®ºæ–¹é¢ã€‚ æˆ‘å»ºè®®è€ƒè™‘è¯¥ç³»ç»Ÿçš„å®é™…å®ç°ï¼Œè¯¥ç³»ç»Ÿå¯æ‰©å±•å¹¶é€‚ç”¨äºå¤§é‡æ•°æ®ã€‚ 

 å¦‚ä½•åœ¨è‰¯å¥½çš„æ—§Pythonä¸Šå®ç°è¿™ç§æƒ…å†µ-è¯·...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¯¹æ¥è‡ªå„ç§æ¥æºçš„æ•°æ®è¿›è¡Œå¤šå¤„ç†å’Œæ ¸å¯¹</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480076/">å“ˆHaï¼ <br><br> è€ƒè™‘åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤šæ ·æ€§ï¼Œç›®æ ‡å­˜å‚¨ä¸­å·²éªŒè¯ä¿¡æ¯çš„å¯ç”¨æ€§æ˜¯æ•°æ®ä¸€è‡´æ€§çš„é‡è¦æ ‡å‡†ã€‚ <br><br> æœ‰è®¸å¤šæ–¹æ³•å’Œæ–¹æ³•å¯ä»¥è¾¾åˆ°è¿™ç§æ•ˆæœï¼Œæˆ‘ä»¬å°†é‡ç‚¹æ”¾åœ¨å’Œè§£ä¸Šï¼Œæœ¬æ–‡<a href="https://habr.com/ru/post/428443/">åœ¨æœ¬æ–‡</a>ä¸­è®¨è®ºäº†å…¶ç†è®ºæ–¹é¢<a href="https://habr.com/ru/post/428443/">ã€‚</a> æˆ‘å»ºè®®è€ƒè™‘è¯¥ç³»ç»Ÿçš„å®é™…å®ç°ï¼Œè¯¥ç³»ç»Ÿå¯æ‰©å±•å¹¶é€‚ç”¨äºå¤§é‡æ•°æ®ã€‚ <br><br> å¦‚ä½•åœ¨è‰¯å¥½çš„æ—§Pythonä¸Šå®ç°è¿™ç§æƒ…å†µ-è¯·åˆ‡å…¥é˜…è¯»ï¼ èµ°å§ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ic/zx/hg/iczxhgu9zvlumwggetuoblxm1ra.jpeg"></div><br>  <a href="https://www.megapixl.com/alexdobysh-stock-images-videos-portfolio" rel="nofollow">ï¼ˆå›¾ç‰‡æ¥æºï¼‰</a> <br><a name="habracut"></a><br><h2> å¼•è¨€ </h2><br> å‡è®¾ä¸€ä¸ªé‡‘èæœºæ„æœ‰å‡ ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæˆ‘ä»¬é¢ä¸´ç€éªŒè¯è¿™äº›ç³»ç»Ÿä¸­çš„äº¤æ˜“å¹¶å°†å¯¹å¸åçš„æ•°æ®ä¸Šä¼ åˆ°ç›®æ ‡å­˜å‚¨çš„ä»»åŠ¡ã€‚ <br><br> ä½œä¸ºæ•°æ®æºï¼Œåœ¨PostgreSQLæ•°æ®åº“ä¸­è·å–ä¸€ä¸ªå¤§æ–‡æœ¬æ–‡ä»¶å’Œä¸€ä¸ªè¡¨ã€‚ å‡è®¾è¿™äº›æºä¸­çš„æ•°æ®å…·æœ‰ç›¸åŒçš„äº‹åŠ¡ï¼Œä½†æ˜¯å®ƒä»¬å¯èƒ½å…·æœ‰å·®å¼‚ï¼Œå› æ­¤éœ€è¦å¯¹å…¶è¿›è¡ŒéªŒè¯å¹¶å°†å…¶å†™å…¥æœ€ç»ˆå­˜å‚¨ä¸­çš„å·²éªŒè¯æ•°æ®ä»¥è¿›è¡Œåˆ†æã€‚ <br><br> æ­¤å¤–ï¼Œæœ‰å¿…è¦åœ¨åŒä¸€æ•°æ®åº“ä¸Šå¹¶è¡Œå¯åŠ¨å¤šä¸ªå¯¹å¸ï¼Œå¹¶ä½¿ç”¨å¤šå¤„ç†åŠŸèƒ½ä½¿ç³»ç»Ÿé€‚åº”å¤§é‡éœ€æ±‚ã€‚ <br><br>  <a href="https://docs.python.org/dev/library/multiprocessing.html" rel="nofollow">å¤šå¤„ç†</a>æ¨¡å—éå¸¸é€‚åˆåœ¨Pythonä¸­å¹¶è¡ŒåŒ–æ“ä½œï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œå®ƒè§„é¿äº†æŸäº›GILç¼ºé™·ã€‚ æˆ‘ä»¬å°†åœ¨ä¸‹é¢ä½¿ç”¨æ­¤åº“çš„åŠŸèƒ½ã€‚ <br><br><h2> æ­£åœ¨å¼€å‘çš„ç³»ç»Ÿæ¶æ„ </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/je/dm/hu/jedmhumxsx9d-mxu-bbfbzqbulq.png"></div><br> ä½¿ç”¨çš„ç»„ä»¶ï¼š <br><br><ul><li>  <b>éšæœºæ•°æ®ç”Ÿæˆå™¨</b> -ç”ŸæˆCSVæ–‡ä»¶å¹¶åœ¨å…¶åŸºç¡€ä¸Šå¡«å……æ•°æ®åº“è¡¨çš„Pythonè„šæœ¬ï¼› </li><li>  <b>æ•°æ®æº</b> -PostgreSQLæ•°æ®åº“ä¸­çš„CSVæ–‡ä»¶å’Œè¡¨ï¼› </li><li>  <b>é€‚é…å™¨</b> -åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªé€‚é…å™¨ï¼Œå°†ä»å®ƒä»¬çš„æºï¼ˆCSVæˆ–æ•°æ®åº“ï¼‰ä¸­æå–æ•°æ®å¹¶å°†ä¿¡æ¯è¾“å…¥ä¸­é—´æ•°æ®åº“ï¼› </li><li>  <b>æ•°æ®åº“</b> -å…±æœ‰ä¸‰éƒ¨åˆ†ï¼šåŸå§‹æ•°æ®ï¼Œå­˜å‚¨é€‚é…å™¨è·å–çš„ä¿¡æ¯çš„ä¸­é—´æ•°æ®åº“ä»¥åŠåŒ…å«æ¥è‡ªè¿™ä¸¤ä¸ªæºçš„å·²åè°ƒäº‹åŠ¡çš„â€œå¹²å‡€â€æ•°æ®åº“ã€‚ </li></ul><br><h2> åˆæ­¥è®­ç»ƒ </h2><br> ä½œä¸ºæ•°æ®å­˜å‚¨å·¥å…·ï¼Œæˆ‘ä»¬å°†<a href="https://hub.docker.com/_/postgres" rel="nofollow">åœ¨Dockerå®¹å™¨ä¸­</a>ä½¿ç”¨<a href="https://hub.docker.com/_/postgres" rel="nofollow">PostgreSQLæ•°æ®åº“ï¼Œ</a>å¹¶é€šè¿‡<a href="https://hub.docker.com/r/dpage/pgadmin4/" rel="nofollow">åœ¨å®¹å™¨ä¸­è¿è¡Œçš„pgAdmin</a>ä¸æˆ‘ä»¬çš„æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼š <br><br><pre><code class="bash hljs">docker run --name pg -d -e <span class="hljs-string"><span class="hljs-string">"POSTGRES_USER=my_user"</span></span> -e <span class="hljs-string"><span class="hljs-string">"POSTGRES_PASSWORD=my_password"</span></span> postgres</code> </pre> <br> è¿è¡ŒpgAdminï¼š <br><br><pre> <code class="bash hljs">docker run -p 80:80 -e <span class="hljs-string"><span class="hljs-string">"PGADMIN_DEFAULT_EMAIL=user@domain.com"</span></span> -e <span class="hljs-string"><span class="hljs-string">"PGADMIN_DEFAULT_PASSWORD=12345"</span></span> -d dpage/pgadmin4</code> </pre> <br> ä¸€åˆ‡å¼€å§‹ä¹‹åï¼Œè¯·ä¸è¦å¿˜è®°åœ¨é…ç½®æ–‡ä»¶ï¼ˆconf / db.iniï¼‰ä¸­æŒ‡å®šæ•°æ®åº“çš„è¿æ¥å­—ç¬¦ä¸²ï¼ˆå¯¹äºåŸ¹è®­ç¤ºä¾‹ï¼Œå¯ä»¥ï¼ï¼‰ï¼š <br><br><pre> <code class="bash hljs">[POSTGRESQL] db_url=postgresql://my_user:my_password@172.17.0.2:5432/my_user</code> </pre><br> åŸåˆ™ä¸Šï¼Œå®¹å™¨çš„ä½¿ç”¨æ˜¯å¯é€‰çš„ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ•°æ®åº“æœåŠ¡å™¨ã€‚ <br><br><h2> è¾“å…¥äº§ç”Ÿ </h2><br>  Pythonè„šæœ¬<b>generate_test_data</b>è´Ÿè´£ç”Ÿæˆæµ‹è¯•æ•°æ®ï¼Œè¯¥æ•°æ®éœ€è¦ç”Ÿæˆæ‰€éœ€æ•°é‡çš„æ¡ç›®ã€‚ å¯ä»¥é€šè¿‡<b>GenerateTestData</b>ç±»çš„ä¸»è¦åŠŸèƒ½è½»æ¾è·Ÿè¸ªæ“ä½œé¡ºåºï¼š <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta"> @m.timing def run(self, num_rows): """ Run the process """ m.info('START!') self.create_db_schema() self.create_folder('data') self.create_csv_file(num_rows) self.bulk_copy_to_db() self.random_delete_rows() self.random_update_rows() m.info('END!')</span></span></code> </pre> <br> å› æ­¤ï¼Œè¯¥å‡½æ•°æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š <br><br><ul><li> åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ¶æ„ï¼ˆæˆ‘ä»¬åˆ›å»ºæ‰€æœ‰ä¸»è¦æ¶æ„å’Œè¡¨ï¼‰ï¼› </li><li> åˆ›å»ºä¸€ä¸ªç”¨äºå­˜å‚¨æµ‹è¯•æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼› </li><li> ç”Ÿæˆå…·æœ‰ç»™å®šè¡Œæ•°çš„æµ‹è¯•æ–‡ä»¶ï¼› </li><li> å°†æ•°æ®æ‰¹é‡æ’å…¥ç›®æ ‡è¡¨transaction_db_raw.transaction_log; </li><li> æ„å¤–åˆ é™¤è¯¥è¡¨ä¸­çš„å¤šè¡Œï¼› </li><li> æ­¤è¡¨ä¸­å‡ è¡Œçš„éšæœºæ›´æ–°ã€‚ </li></ul><br> åˆ é™¤å’Œä¿®æ”¹æ˜¯å¿…éœ€çš„ï¼Œä»¥ä¾¿æ¯”è¾ƒçš„å¯¹è±¡è‡³å°‘æœ‰ä¸€äº›å·®å¼‚ã€‚ èƒ½å¤Ÿæ‰¾åˆ°è¿™äº›å·®å¼‚å¾ˆé‡è¦ï¼ <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@m.timing @m.wrapper(m.entering, m.exiting) def random_delete_rows(self): """ Random deleting some rows from the table """ sql_command = sql.SQL(""" delete from {0}.{1} where ctid = any(array( select ctid from {0}.{1} tablesample bernoulli (1) ))""").format(sql.Identifier(self.schema_raw), sql.Identifier(self.raw_table_name)) try: rows = self.database.execute(sql_command) m.info('Has been deleted [%s rows] from table %s' % (rows, self.raw_table_name)) except psycopg2.Error as err: m.error('Oops! Delete random rows has been FAILED. Reason: %s' % err.pgerror) @m.timing @m.wrapper(m.entering, m.exiting) def random_update_rows(self): """ Random update some rows from the table """ sql_command = sql.SQL(""" update {0}.{1} set transaction_amount = round(random()::numeric, 2) where ctid = any(array( select ctid from {0}.{1} tablesample bernoulli (1) ))""").format(sql.Identifier(self.schema_raw), sql.Identifier(self.raw_table_name)) try: rows = self.database.execute(sql_command) m.info('Has been updated [%s rows] from table %s' % (rows, self.raw_table_name)) except psycopg2.Error as err: m.error('Oops! Delete random rows has been FAILED. Reason: %s' % err.pgerror)</span></span></code> </pre> <br> ç”Ÿæˆæµ‹è¯•æ•°æ®é›†å¹¶éšåå°†å…¶è®°å½•ä¸ºCSVæ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶å¦‚ä¸‹ï¼š <br><br><ul><li> åˆ›å»ºä¸€ä¸ªéšæœºäº‹åŠ¡UIDï¼› </li><li> åˆ›å»ºä¸€ä¸ªéšæœºçš„UIDå¸å·ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨åä¸ªå”¯ä¸€çš„å¸å·ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶é€šè¿‡æ›´æ”¹â€œ random_accountsâ€å‚æ•°æ¥æ›´æ”¹æ­¤å€¼ï¼‰ï¼› </li><li> äº¤æ˜“æ—¥æœŸ-ä»é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æ—¥æœŸï¼ˆinitial_dateï¼‰å¼€å§‹çš„éšæœºæ—¥æœŸï¼› </li><li> äº¤æ˜“ç±»å‹ï¼ˆäº¤æ˜“/ä½£é‡‘ï¼‰ï¼› </li><li> äº¤æ˜“é‡‘é¢ï¼› </li><li> æ•°æ®ç”Ÿæˆçš„ä¸»è¦å·¥ä½œç”±<b>TestDataCreator</b>ç±»çš„<i>generate_test_data_by_chunk</i>æ–¹æ³•æ‰§è¡Œï¼š </li></ul><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@m.timing def generate_test_data_by_chunk(self, chunk_start, chunk_end): """ Generating and saving to the file """ num_rows_mp = chunk_end - chunk_start new_rows = [] for _ in range(num_rows_mp): transaction_uid = uuid.uuid4() account_uid = choice(self.list_acc) transaction_date = (self.get_random_date(self.date_in, 0) .__next__() .strftime('%Y-%m-%d %H:%M:%S')) type_deal = choice(self.list_type_deal) transaction_amount = randint(-1000, 1000) new_rows.append([transaction_uid, account_uid, transaction_date, type_deal, transaction_amount]) self.write_in_file(new_rows, chunk_start, chunk_end)</span></span></code> </pre> <br><blockquote> æ­¤åŠŸèƒ½çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯åœ¨å¤šä¸ªå¹¶è¡Œå¼‚æ­¥è¿›ç¨‹ä¸­å¯åŠ¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½ä¼šç”Ÿæˆè‡ªå·±çš„50Kè®°å½•éƒ¨åˆ†ã€‚ è¿™ä¸ªâ€œèŠ¯ç‰‡â€å°†ä½¿æ‚¨è¶³å¤Ÿå¿«åœ°åœ¨å‡ ç™¾ä¸‡è¡Œä¸Šåˆ›å»ºæ–‡ä»¶ </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_csv_writing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Writing the test data into csv file """</span></span> pool = mp.Pool(mp.cpu_count()) jobs = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> chunk_start, chunk_end <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.divide_into_chunks(<span class="hljs-number"><span class="hljs-number">0</span></span>, self.num_rows): jobs.append(pool.apply_async(self.generate_test_data_by_chunk, (chunk_start, chunk_end))) <span class="hljs-comment"><span class="hljs-comment"># wait for all jobs to finish for job in jobs: job.get() # clean up pool.close() pool.join()</span></span></code> </pre> <br> æ–‡æœ¬æ–‡ä»¶å®Œæˆåï¼Œå¤„ç†bulk_insertå‘½ä»¤ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ•°æ®å‡è½å…¥<b>transaction_db_raw.transaction_log</b>è¡¨ä¸­<b>ã€‚</b> <br><br> æ­¤å¤–ï¼Œè¿™ä¸¤ä¸ªæºå°†åŒ…å«å®Œå…¨ç›¸åŒçš„æ•°æ®ï¼Œå¯¹å¸ä¸ä¼šå‘ç°ä»»ä½•æœ‰è¶£çš„å†…å®¹ï¼Œå› æ­¤æˆ‘ä»¬åˆ é™¤å¹¶æ›´æ”¹äº†æ•°æ®åº“ä¸­çš„å‡ ä¸ªéšæœºè¡Œã€‚ <br><br> è¿è¡Œè„šæœ¬å¹¶ç”ŸæˆåŒ…å«10,000è¡Œäº¤æ˜“çš„æµ‹è¯•CSVæ–‡ä»¶ï¼š <br><br><pre> <code class="bash hljs">./generate_test_data.py 10000</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/cp/hm/4ccphmc5dcjcgxuy54p_9limlz4.png"></div><br> å±å¹•æˆªå›¾æ˜¾ç¤ºå·²æ¥æ”¶åˆ°10Kè¡Œçš„æ–‡ä»¶ï¼Œå°†10Kè¡ŒåŠ è½½åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åä»æ•°æ®åº“ä¸­åˆ é™¤äº†112è¡Œï¼Œå¹¶æ›´æ”¹äº†108è¡Œï¼Œç»“æœï¼šæ•°æ®åº“ä¸­çš„æ–‡ä»¶å’Œè¡¨ç›¸å·®220ä¸ªæ¡ç›®ã€‚ <br><br> æ‚¨é—®ï¼šâ€œå—¯ï¼Œå¤šå¤„ç†åœ¨å“ªé‡Œï¼Ÿâ€ <br> å½“æ‚¨ç”Ÿæˆæ›´å¤§çš„æ–‡ä»¶æ—¶ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„å·¥ä½œï¼Œè€Œä¸æ˜¯10Kæ¡è®°å½•ï¼Œè€Œæ˜¯1Mæ¡è®°å½•ã€‚ æˆ‘ä»¬ä¼šå°è¯•å—ï¼Ÿ <br><br><pre> <code class="bash hljs">./generate_test_data.py 1000000</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rw/_a/ne/rw_aneqnairixqk-wglpqxgjvkc.png"></div><br> åŠ è½½æ•°æ®ï¼Œåˆ é™¤å’Œæ›´æ”¹éšæœºè®°å½•åï¼Œæˆ‘ä»¬ä»è¡¨ä¸­çœ‹åˆ°äº†æ–‡æœ¬æ–‡ä»¶çš„åŒºåˆ«ï¼š19,939è¡Œï¼ˆå…¶ä¸­10022æ¡æ˜¯éšæœºåˆ é™¤çš„ï¼Œè€Œ9917æ¡æ˜¯æ›´æ”¹çš„ï¼‰ã€‚ <br><br><blockquote> å›¾ç‰‡æ˜¾ç¤ºè®°å½•çš„ç”Ÿæˆæ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¸€è‡´çš„ã€‚ è¿™æ„å‘³ç€ä¸‹ä¸€ä¸ªè¿‡ç¨‹å¯ä»¥åœ¨ä¸è€ƒè™‘å¼€å§‹é¡ºåºçš„æƒ…å†µä¸‹ç«‹å³å¼€å§‹ï¼Œè€Œå‰ä¸€ä¸ªè¿‡ç¨‹å°±å®Œæˆäº†ã€‚ ä¸èƒ½ä¿è¯ç»“æœä¸è¾“å…¥çš„é¡ºåºç›¸åŒã€‚ </blockquote><br><div class="spoiler">  <b class="spoiler_title">è‚¯å®šæ›´å¿«å—ï¼Ÿ</b> <div class="spoiler_text"> åœ¨15.5ç§’å†…â€œå‘æ˜â€äº†ä¸åœ¨æœ€å¿«çš„è™šæ‹Ÿæœºä¸Šçš„100ä¸‡è¡Œ-è¿™æ˜¯ä¸€ä¸ªå€¼å¾—é€‰æ‹©çš„é€‰æ‹©ã€‚ åœ¨ä¸ä½¿ç”¨å¤šå¤„ç†çš„æƒ…å†µä¸‹æŒ‰é¡ºåºå¯åŠ¨äº†åŒä¸€ä»£ï¼Œæˆ‘å¾—åˆ°çš„ç»“æœæ˜¯ï¼šæ–‡ä»¶ç”Ÿæˆçš„é€Ÿåº¦æ…¢äº†ä¸‰å€å¤šï¼ˆè¶…è¿‡äº†52ç§’è€Œä¸æ˜¯15.5ç§’ï¼‰ï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/kb/ck/sbkbckylzluoyyslyflwak5udrq.png"></div><br></div></div><br><h2>  CSVé€‚é…å™¨ </h2><br> è¯¥é€‚é…å™¨å¯¹è¡Œè¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œä»…ä¿ç•™ç¬¬ä¸€åˆ—ï¼ˆäº‹åŠ¡æ ‡è¯†ç¬¦ï¼‰ä¸å˜ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„<i>æ•°æ®</i>ä¿å­˜åˆ°<i>data / transaction_hashed.csv</i>æ–‡ä»¶ä¸­ã€‚ ä»–çš„å·¥ä½œçš„æœ€åä¸€æ­¥æ˜¯ä½¿ç”¨COPYå‘½ä»¤å°†æ­¤æ–‡ä»¶åŠ è½½åˆ°<b>reconciliation_db</b>æ¨¡å¼çš„ä¸´æ—¶è¡¨ä¸­<b>ã€‚</b> <br><br> æœ€ä½³çš„æ–‡ä»¶è¯»å–æ˜¯é€šè¿‡å‡ ä¸ªå¹¶è¡Œè¿‡ç¨‹æ‰§è¡Œçš„ã€‚ æˆ‘ä»¬é€è¡Œè¯»å–ï¼Œæ¯ä¸ªè¯»å–5å…†å­—èŠ‚ã€‚ é€šè¿‡ç»éªŒæ–¹æ³•è·å¾—æ•°å­—â€œ 5å…†å­—èŠ‚â€ã€‚ æ­£æ˜¯ç”±äºåªæœ‰ä¸€å°æ®µæ–‡å­—ï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿåœ¨æœ€çŸ­çš„æ—¶é—´å†…è¯»å–è™šæ‹Ÿæœºä¸Šçš„å¤§æ–‡ä»¶ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨æ­¤å‚æ•°åœ¨æ‚¨çš„ç¯å¢ƒä¸­è¿›è¡Œå®éªŒï¼Œå¹¶æŸ¥çœ‹è¿è¡Œæ—¶é—´å°†å¦‚ä½•å˜åŒ–ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@m.timing def process_wrapper(self, chunk_start, chunk_size): """ Read a particular chunk """ with open(self.file_name_raw, newline='\n') as file: file.seek(chunk_start) lines = file.read(chunk_size).splitlines() for line in lines: self.process(line) def chunkify(self, size=1024*1024*5): """ Return a new chunk """ with open(self.file_name_raw, 'rb') as file: chunk_end = file.tell() while True: chunk_start = chunk_end file.seek(size, 1) file.readline() chunk_end = file.tell() if chunk_end &gt; self.file_end: chunk_end = self.file_end yield chunk_start, chunk_end - chunk_start break else: yield chunk_start, chunk_end - chunk_start @m.timing def run_reading(self): """ The main method for the reading """ # init objects pool = mp.Pool(mp.cpu_count()) jobs = [] m.info('Run csv reading...') # create jobs for chunk_start, chunk_size in self.chunkify(): jobs.append(pool.apply_async(self.process_wrapper, (chunk_start, chunk_size))) # wait for all jobs to finish for job in jobs: job.get() # clean up pool.close() pool.join() m.info('CSV file reading has been completed')</span></span></code> </pre> <br> è¯»å–1Mè®°å½•ä¸Šå…ˆå‰åˆ›å»ºçš„æ–‡ä»¶çš„ç¤ºä¾‹ï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9p/z1/zr/9pz1zrkzeelnep_r8oppk0sxhok.png"></div><br> å±å¹•å¿«ç…§æ˜¾ç¤ºäº†å¦‚ä½•ä¸ºå½“å‰å¯¹å¸è¿è¡Œåˆ›å»ºä¸€ä¸ªå…·æœ‰å”¯ä¸€åç§°çš„ä¸´æ—¶è¡¨ã€‚ æ¥ä¸‹æ¥æ˜¯éƒ¨åˆ†å¼‚æ­¥è¯»å–æ–‡ä»¶å¹¶è·å–æ¯ä¸€è¡Œçš„å“ˆå¸Œå€¼ã€‚ å°†æ•°æ®ä»é€‚é…å™¨æ’å…¥ç›®æ ‡è¡¨å³å¯å®Œæˆæ­¤é€‚é…å™¨çš„å·¥ä½œã€‚ <br><blockquote> ä¸ºæ¯ä¸ªå¯¹å¸è¿‡ç¨‹ä½¿ç”¨å…·æœ‰å”¯ä¸€åç§°çš„ä¸´æ—¶è¡¨ï¼Œå¯ä»¥ä½¿æ‚¨åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­é¢å¤–å¹¶è¡ŒåŒ–å¯¹å¸è¿‡ç¨‹ã€‚ </blockquote><br><h2>  PostgreSQLé€‚é…å™¨ </h2><br> ç”¨äºå¤„ç†è¡¨ä¸­å­˜å‚¨çš„æ•°æ®çš„é€‚é…å™¨ä¸æ–‡ä»¶é€‚é…å™¨çš„é€»è¾‘å¤§è‡´ç›¸åŒï¼š <br><br><ul><li> è¯»å–è¡¨çš„æŸäº›éƒ¨åˆ†ï¼ˆå¦‚æœå¾ˆå¤§ï¼Œåˆ™è¶…è¿‡10ä¸‡ä¸ªæ¡ç›®ï¼‰ï¼Œå¹¶å¯¹é™¤äº‹åŠ¡æ ‡è¯†ç¬¦ä¹‹å¤–çš„æ‰€æœ‰åˆ—è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼› </li><li> ç„¶åå°†å·²å¤„ç†çš„æ•°æ®æ’å…¥åˆ°<b>reconciliation_db</b>è¡¨ä¸­<b>ã€‚</b>  <b>å­˜å‚¨_ $ï¼ˆintï¼ˆtime.timeï¼ˆï¼‰ï¼‰</b> ã€‚ </li></ul><br> è¯¥é€‚é…å™¨çš„ä¸€ä¸ªæœ‰è¶£ç‰¹æ€§æ˜¯å®ƒä½¿ç”¨ä¸€ä¸ªåˆ°æ•°æ®åº“çš„è¿æ¥æ± ï¼Œè¯¥æ± å°†é€šè¿‡ç´¢å¼•åœ¨è¡¨ä¸­æœç´¢å¿…è¦çš„æ•°æ®å¹¶è¿›è¡Œå¤„ç†ã€‚ <br><br> æ ¹æ®è¡¨çš„å¤§å°ï¼Œè®¡ç®—å¤„ç†æ‰€éœ€çš„è¿›ç¨‹æ•°ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­å°†å…¶åˆ’åˆ†ä¸º10ä¸ªä»»åŠ¡ã€‚ <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Read the data from the postgres and shared those records with each processor to perform their operation using threads """</span></span> threads_array = self.get_threads(<span class="hljs-number"><span class="hljs-number">0</span></span>, self.max_id_num_row, self.pid_max) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pid <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(threads_array) + <span class="hljs-number"><span class="hljs-number">1</span></span>): m.info(<span class="hljs-string"><span class="hljs-string">'Process %s'</span></span> % pid) <span class="hljs-comment"><span class="hljs-comment"># Getting connection from the connection pool select_conn = self._select_conn_pool.getconn() select_conn.autocommit = 1 # Creating 10 process to perform the operation process = Process(target=self.process_data, args=(self.data_queque, pid, threads_array[pid-1][0], threads_array[pid-1][1], select_conn)) process.daemon = True process.start() process.join() select_conn.close()</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pw/kt/kk/pwktkkisxg3sud4dyss_gtyi4gy.png"></div><br><h2> æœç´¢å·®å¼‚ </h2><br> æˆ‘ä»¬ç»§ç»­éªŒè¯ä»ä¸¤ä¸ªé€‚é…å™¨æ¥æ”¶åˆ°çš„æ•°æ®ã€‚ <br><br> ä½¿ç”¨SQLè¯­è¨€çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¯¹å¸ï¼ˆæˆ–æ¥æ”¶å·®å¼‚æŠ¥å‘Šï¼‰å‘ç”Ÿåœ¨æ•°æ®åº“çš„æœåŠ¡å™¨ç«¯ã€‚ <br><br>  SQLæŸ¥è¯¢éå¸¸ç®€å•-å®ƒåªæ˜¯ä¸€ä¸ªè¡¨è”æ¥ï¼Œé€šè¿‡äº‹åŠ¡IDå°†æ•°æ®ä»é€‚é…å™¨ä¼ é€’åˆ°è‡ªèº«ï¼š <br><br><pre> <code class="python hljs">sql_command = sql.SQL(<span class="hljs-string"><span class="hljs-string">""" select s1.adapter_name, count(s1.transaction_uid) as tran_count from {0}.{1} s1 full join {0}.{1} s2 on s2.transaction_uid = s1.transaction_uid and s2.adapter_name != s1.adapter_name and s2.hash = s1.hash where s2.transaction_uid is null group by s1.adapter_name;"""</span></span>).format(sql.Identifier(self.schema_target), sql.Identifier(self.storage_table))</code> </pre><br> è¾“å‡ºä¸ºæŠ¥å‘Šï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5c/ou/gy/5cougys1gkflsplq2hvkoleooto.png"></div><br> æ£€æŸ¥ä¸Šé¢å›¾ç‰‡ä¸­çš„æ‰€æœ‰å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚ æˆ‘ä»¬è®°å¾—ä»æ•°æ®åº“è¡¨ä¸­åˆ é™¤äº†9917ï¼Œå¹¶æ›´æ”¹äº†10022è¡Œã€‚ æŠ¥å‘Šä¸­å…±æ˜¾ç¤º19939è¡Œã€‚ <br><br><h2> æ±‡æ€»è¡¨ </h2><br> ä»…ä¿ç•™å°†åœ¨å„ä¸ªæ–¹é¢ï¼ˆé€šè¿‡å“ˆå¸Œï¼‰åŒ¹é…çš„ä¸åŒé€‚é…å™¨ä¸­çš„â€œå¹²å‡€â€äº‹åŠ¡æ’å…¥å­˜å‚¨è¡¨ä¸­ã€‚ æ­¤è¿‡ç¨‹ç”±ä»¥ä¸‹SQLæŸ¥è¯¢æ‰§è¡Œï¼š <br><br><pre> <code class="python hljs">sql_command = sql.SQL(<span class="hljs-string"><span class="hljs-string">""" with reconcil_data as ( select s1.transaction_uid from {0}.{1} s1 join {0}.{1} s2 on s2.transaction_uid = s1.transaction_uid and s2.adapter_name != s1.adapter_name where s2.hash = s1.hash and s1.adapter_name = 'postresql_adapter' ) insert into {2}.transaction_log select t.transaction_uid, t.account_uid, t.transaction_date, t.type_deal, t.transaction_amount from {3}.transaction_log t join reconcil_data r on t.transaction_uid = r.transaction_uid where not exists ( select 1 from {2}.transaction_log tl where tl.transaction_uid = t.transaction_uid ) """</span></span>).format(sql.Identifier(self.schema_target), sql.Identifier(self.storage_table), sql.Identifier(self.schema_db_clean), sql.Identifier(self.schema_raw))</code> </pre><br> æˆ‘ä»¬ç”¨ä½œé€‚é…å™¨çš„ä¸­é—´æ•°æ®å­˜å‚¨çš„ä¸´æ—¶è¡¨å¯ä»¥åˆ é™¤ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uq/sr/te/uqsrte2g0thu2woasaxqojdbc88.png"></div><br><h2> ç»“è®º </h2><br> åœ¨å®Œæˆå·¥ä½œçš„è¿‡ç¨‹ä¸­ï¼Œå¼€å‘äº†ä¸€ç§ç”¨äºåè°ƒæ¥è‡ªå„ç§æ¥æºçš„æ•°æ®çš„ç³»ç»Ÿï¼šæ–‡æœ¬æ–‡ä»¶å’Œæ•°æ®åº“ä¸­çš„è¡¨æ ¼ã€‚ æœ€å°‘ä½¿ç”¨å…¶ä»–å·¥å…·ã€‚ <br><br> ä¹Ÿè®¸è€ç»ƒçš„è¯»è€…å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œä½¿ç”¨è¯¸å¦‚Apache Sparkä¹‹ç±»çš„æ¡†æ¶ï¼Œå†åŠ ä¸Šå°†æºæ•°æ®è½¬æ¢ä¸ºé•¶æœ¨åœ°æ¿æ ¼å¼ï¼Œå¯ä»¥å¤§å¤§åŠ å¿«æ­¤è¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤§æ‰¹é‡äº¤æ˜“è€Œè¨€ã€‚ ä½†æ˜¯è¿™é¡¹å·¥ä½œçš„ä¸»è¦ç›®æ ‡æ˜¯ç”¨è£¸Pythonç¼–å†™ç³»ç»Ÿå¹¶ç ”ç©¶å¤šå¤„ç†æ•°æ®å¤„ç†ã€‚ æˆ‘è®¤ä¸ºæˆ‘ä»¬å·²ç»å¤„ç†äº†ä»€ä¹ˆã€‚ <br><br> æ•´ä¸ªé¡¹ç›®çš„æºä»£ç ä½äº<a href="https://github.com/igorgorbenko/transact_reconciliation" rel="nofollow">æˆ‘åœ¨GitHubä¸Šçš„å­˜å‚¨åº“ä¸­</a> ï¼Œå»ºè®®æ‚¨ç†Ÿæ‚‰ä¸€ä¸‹å®ƒã€‚ <br><br> æˆ‘å¾ˆä¹æ„å›ç­”æ‰€æœ‰é—®é¢˜å¹¶ç»“è¯†æ‚¨çš„æ„è§ã€‚ <br><br> ç¥ä½ æˆåŠŸï¼ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN480076/">https://habr.com/ru/post/zh-CN480076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN480062/index.html">10ä¸ªæ§åˆ¶ç³»ç»Ÿã€‚ åœ¨ä»»åŠ¡ä¸Šè¿›è¡Œäº¤æµå’Œå…±äº«æ–‡ä»¶åœ¨å“ªé‡Œæ›´æ–¹ä¾¿ï¼Ÿ</a></li>
<li><a href="../zh-CN480064/index.html">å­¦ä¹ æŒ‰ä¸»é¢˜åˆ†ç»„çš„å•è¯</a></li>
<li><a href="../zh-CN480068/index.html">[æ›´æ–°]æˆ‘ä»¬çš„äººæ°‘é­åˆ°æ®´æ‰“ï¼Œæˆ‘ä»¬ä¼šä¿æŒæ²‰é»˜å—ï¼Ÿ</a></li>
<li><a href="../zh-CN480070/index.html">ååº”æ”¶ç›Šï¼šä¼ä¸šçš„ç¦æ°”ï¼Ÿ</a></li>
<li><a href="../zh-CN480072/index.html">Kubernetesï¼šä¸ºä»€ä¹ˆè®¾ç½®ç³»ç»Ÿèµ„æºç®¡ç†å¦‚æ­¤é‡è¦ï¼Ÿ</a></li>
<li><a href="../zh-CN480078/index.html">Reactå¤–è®¾ä¸Šçš„æ–°å‰ç«¯åº“</a></li>
<li><a href="../zh-CN480080/index.html">æ‚¨åœ¨åšç¬”è®°åº”ç”¨ç¨‹åºæ—¶éœ€è¦ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="../zh-CN480082/index.html">åœ¨MySQLä¸­ä¸ºZabbixä½¿ç”¨åˆ†åŒºå’Œå¤§é‡ç›‘è§†å¯¹è±¡</a></li>
<li><a href="../zh-CN480086/index.html">å¦‚ä½•ç¬¦åˆ152-FZçš„è¦æ±‚ï¼Œä¿æŠ¤å®¢æˆ·çš„ä¸ªäººæ•°æ®ï¼Œè€Œä¸æ˜¯è¸©æˆ‘ä»¬çš„è€™å­</a></li>
<li><a href="../zh-CN480088/index.html">DevOps-å¥½ï¼Œä½†æ˜¯è¯¥æ€ä¹ˆåŠï¼Ÿ å¦‚ä½•å‡å°‘ä½“åŠ›åŠ³åŠ¨å¹¶å–å¾—ç†æƒ³çš„ç»“æœ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>