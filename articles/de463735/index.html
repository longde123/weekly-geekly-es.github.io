<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐲 ☑️ 🤘🏾 Qrator Filtering Network Configuration Delivery System 👷 👨‍💻 🧑🏽‍🤝‍🧑🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR : Client-Server-Architektur unseres internen Konfigurationsmanagement-Tools QControl. 
 Im Untergeschoss befindet sich ein zweischichtiges Tran...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Qrator Filtering Network Configuration Delivery System</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/463735/"><img src="https://habrastorage.org/webt/m2/ak/w7/m2akw7igwdnpnlkl-wtyczkznlc.jpeg"><br><br>  <b>TL; DR</b> : Client-Server-Architektur unseres internen Konfigurationsmanagement-Tools QControl. <br>  Im Untergeschoss befindet sich ein zweischichtiges Transportprotokoll, das mit gzip-komprimierten Nachrichten ohne Dekomprimierung zwischen Endpunkten arbeitet.  Verteilte Router und Endpunkte erhalten die Konfigurationsaktualisierungen, und das Protokoll selbst ermöglicht die Installation von lokalisierten Zwischenrelais.  Es basiert auf einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">differenziellen Backup</a> -Design („kürzlich stabil“, weiter unten erläutert) und verwendet die JMESpath-Abfragesprache und Jinja-Vorlagen für das Rendern der Konfiguration. <br><br>  Qrator Labs betreibt ein global verteiltes Schadensbegrenzungsnetzwerk und unterhält es.  Unser Netzwerk ist Anycast, basierend auf der Ankündigung unserer Subnetze über BGP.  Als BGP-Anycast-Netzwerk, das sich physisch in mehreren Regionen der Erde befindet, können wir illegitimen Datenverkehr näher am Internet-Backbone verarbeiten und filtern - Tier-1-Betreiber. <br><br>  Ein geografisch verteiltes Netzwerk zu sein, birgt jedoch seine Schwierigkeiten.  Die Kommunikation zwischen den Network Points of Presence (PoP) ist für einen Sicherheitsanbieter unerlässlich, um eine kohärente Konfiguration für alle Netzwerkknoten zu erhalten und diese zeitnah und zusammenhängend zu aktualisieren.  Um den Kunden den bestmöglichen Service bieten zu können, mussten wir einen Weg finden, um die Konfigurationsdaten zwischen verschiedenen Kontinenten zuverlässig zu synchronisieren. <br><blockquote>  Am Anfang gab es das Wort ..., das schnell zu einem Kommunikationsprotokoll wurde, das aktualisiert werden musste. </blockquote><a name="habracut"></a><br>  Der Eckpfeiler der Existenz von QControl und der Hauptgrund dafür, viel Zeit und Mühe in die Erstellung eines solchen Protokolls zu investieren, ist die Notwendigkeit, eine maßgebliche Quelle für die Konfiguration zu erhalten und schließlich unsere PoPs damit zu synchronisieren.  Speicher war nur eine von mehreren erforderlichen Funktionen der QControl-Entwicklung.  Darüber hinaus brauchten wir auch die Integration in die bestehende und zukünftige Peripherie, intelligente (und anpassbare) Datenvalidierungen und Zugriffsdifferenzierung.  Darüber hinaus wollten wir, dass dieses System die Dinge durch Befehle verwaltet, nicht durch manuelle Dateimodifikationen.  Vor QControl wurden Daten mehr oder weniger manuell an die Präsenzpunkte gesendet.  Wenn ein PoP im Moment nicht verfügbar war und wir vergessen haben, es später zu aktualisieren, wurde die Konfiguration desynchronisiert und eine zeitaufwändige Fehlerbehebung war erforderlich, um es wieder synchron zu machen. <br><br>  Hier ist das System, das wir uns ausgedacht haben: <br><img src="https://habrastorage.org/getpro/habr/post_images/ee1/a25/5c0/ee1a255c01c5119a0f59191782817efb.png" alt="Bild"><br>  Der Konfigurationsserver ist für die Datenüberprüfung und -speicherung verantwortlich.  Der Router verfügt über verschiedene Endpunkte zum Empfangen und Weiterleiten von Konfigurationsaktualisierungen von Clients und Supportteams an Server und von Server an PoPs. <br><br>  Die Qualität der Internetverbindung ist auf der ganzen Welt immer noch sehr unterschiedlich. Um dies zu veranschaulichen, stellen wir uns eine einfache Traceroute von Prag, der Tschechischen Republik nach Singapur und Hongkong vor. <br><br> <a href=""><img src="https://habrastorage.org/webt/ob/pl/vc/obplvcdpqlc8as-nra_jnpv4hbc.png" alt="Bild"></a> <br>  MTR von Prag nach Singapur <br><br> <a href=""><img src="https://habrastorage.org/webt/4z/xo/7s/4zxo7sr_qqrg6cdlipwwvujohto.png" alt="Bild"></a> <br>  Gleicher zweiter Screenshot mit Traceroute nach Hong Kong <br><br>  Hohe Latenzzeiten bedeuten schlechte Geschwindigkeit.  Es gibt auch einen hohen Paketverlust.  Bandbreitennummern kompensieren dieses Problem nicht, das beim Aufbau dezentraler Netzwerke immer berücksichtigt werden sollte. <br><br>  Die vollständige PoP-Konfiguration ist ein ziemlich bedeutender Datenblock und muss über unzuverlässige Verbindungen an viele verschiedene Empfänger übertragen werden.  Obwohl sich die Konfiguration häufig ändert, ändert sie sich glücklicherweise in kleinen Schritten. <br><br><h3>  Neuestes stabiles Design </h3><br>  Es ist eine recht einfache Entscheidung, ein verteiltes Netzwerk basierend auf inkrementellen Updates aufzubauen.  Obwohl es einige Probleme mit den Diffs gibt, sind sie schwer richtig zu erstellen: Wir müssen alle Diffs zwischen Referenzpunkten irgendwo speichern, um sie erneut senden zu können, wenn jemand etwas verloren hat.  Jedes Ziel sollte sie kohärent anwenden.  Wenn es mehrere Ziele gibt, kann dies im gesamten Netzwerk viel Zeit in Anspruch nehmen.  Der Adressat sollte auch in der Lage sein, fehlende Teile anzufordern, und natürlich muss der zentrale Teil diese Anfrage genau beantworten und nur die fehlenden Daten senden. <br><br>  Was wir am Ende gebaut haben, ist eine ziemliche Sache - wir haben nur eine Referenzschicht, die feste „stabile“ und nur ein Diff, „neu“ dafür.  Jede aktuelle Version basiert auf dem neuesten Stable und reicht aus, um Konfigurationsdaten neu zu erstellen.  Wenn ein neuer Neuzugang das Ziel erreicht, ist der alte verfügbar. <br><br>  Es macht uns manchmal die Notwendigkeit, eine neue stabile Konfiguration zu senden, weil die jüngsten zu groß werden.  Ein wichtiger Hinweis hierbei ist auch, dass wir all dies durch Senden / Multicasting-Updates erreichen können, ohne uns Gedanken über den Empfang von Zielen machen zu müssen, die die Teile zusammenbauen können.  Sobald wir überprüfen, ob jeder den richtigen Stall hat, werden alle nur mit dem frischen Neugeborenen gefüttert.  Sollen wir sagen, dass es funktioniert?  Es tut.  Stables werden auf dem Konfigurationsserver und den Empfängern zwischengespeichert, wobei die zuletzt erstellten bei Bedarf neu erstellt werden. <br><br><h3>  Zweischichtige Transportarchitektur </h3><br>  Warum genau haben wir unseren Transport aus zwei Schichten aufgebaut?  Die Antwort ist ziemlich einfach: Wir wollten das Routing von der Anwendung trennen und uns vom OSI-Modell mit seinen Transport- und Anwendungsebenen inspirieren lassen.  Daher haben wir das Transportprotokoll (Thrift) vom Serialisierungsformat für Befehle auf hoher Ebene (msgpack) getrennt.  Aus diesem Grund schaut ein Router (der Multicast / Broadcast / Relay ausführt) weder in das msgpack, noch extrahiert oder komprimiert er die Nutzdaten und führt nur die Übertragung durch. <br><br>  Sparsamkeits- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wiki</a> : <br>  <i>Mit Apache Thrift können Sie Datentypen und Dienstschnittstellen in einer einfachen Definitionsdatei definieren.</i>  <i>Ausgehend von dieser Datei generiert der Compiler Code, mit dem auf einfache Weise RPC-Clients und -Server erstellt werden können, die nahtlos über Programmiersprachen hinweg kommunizieren.</i>  <i>Anstatt eine Menge Boilerplate-Code zu schreiben, um Ihre Objekte zu serialisieren und zu transportieren und Remote-Methoden aufzurufen.</i> <br><br>  Wir haben das Thrift-Framework aufgrund seines RPC und der gleichzeitigen Unterstützung mehrerer Sprachen verwendet.  Wie immer sind die einfachen Teile einfach zu erstellen: der Client und der Server.  Der Router war jedoch ziemlich hart zu knacken, was teilweise auf das Fehlen einer gebrauchsfertigen Lösung zu diesem Zeitpunkt zurückzuführen war. <br><br><img src="https://habrastorage.org/webt/l8/so/6v/l8so6vrzh0u_feb60p6ehjbubs0.png" align="left">  Es gibt einige andere Optionen, wie den Protobuf / gRPC. Als wir mit unserem Projekt begannen, war der gRPC jedoch noch nicht ausgereift und wir zögerten, ihn zu verwenden. <br><br>  Natürlich könnten (und sollten!) Wir ein eigenes Rad schaffen.  Es wäre einfacher, ein benutzerdefiniertes Protokoll für das zu erstellen, was wir zusammen mit dem Router benötigen, da der Client-Server einfacher zu programmieren ist als ein funktionierender Router mit Thrift.  Es gibt jedoch eine traditionelle Negativität gegenüber benutzerdefinierten Protokollen und Implementierungen beliebter Bibliotheken, und es gibt immer die Frage, wie wir sie anschließend in andere Sprachen portieren können.  Also beschlossen wir, die Wheely-Ideen fallen zu lassen. <br><br>  Msgpack <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beschreibung</a> : <br>  <i>MessagePack ist ein effizientes binäres Serialisierungsformat.</i>  <i>Sie können damit Daten zwischen mehreren Sprachen wie JSON austauschen.</i>  <i>Aber es ist schneller und kleiner.</i>  <i>Kleine Ganzzahlen werden in ein einzelnes Byte codiert, und typische kurze Zeichenfolgen erfordern zusätzlich zu den Zeichenfolgen selbst nur ein zusätzliches Byte.</i> <br><br>  Auf der ersten Ebene haben wir eine Sparsamkeit mit den Mindestinformationen, die der Router zum Senden einer Nachricht benötigt.  Auf der zweiten Ebene haben wir msgpack-Strukturen komprimiert. <br>  Wir haben für das msgpack gestimmt, weil es im Vergleich zu JSON schneller und kompakter ist.  Noch wichtiger ist jedoch, dass benutzerdefinierte Datentypen unterstützt werden, die einige aufregende Funktionen wie „White-Outs“ und die Übertragung von Rohdaten ermöglichen. <br><br>  <b>Jmespath</b> <br>  <i>JMESPath ist eine Abfragesprache für JSON.</i> <br>  Dies ist die einzige Beschreibung, die wir aus der offiziellen JMESPath-Dokumentation erhalten, aber tatsächlich ist es viel mehr als nur das.  Mit JMESPath können beliebige baumartige Strukturen gesucht und gefiltert und sogar Datentransformationen im laufenden Betrieb angewendet werden.  Wir verwenden diese Abfragesprache, um relevante Informationen aus dem großen Konfigurations-Blob abzurufen. <br>  Während die gesamte Konfiguration eine baumartige Struktur aufweist, extrahieren wir die relevanten Unterbäume für verschiedene Konfigurationsziele. <br><br>  Es ist auch flexibel genug, um den Unterbaum unabhängig von einer Konfigurationsvorlage oder anderen Konfigurations-Plugins zu ändern.  Um es noch besser zu machen, ist JMES Path leicht erweiterbar und ermöglicht das Schreiben von benutzerdefinierten Filtern und Datentransformationsroutinen.  Es braucht jedoch etwas Brainpower, um zu verstehen. <br><br>  <b>Jinja</b> <br>  Für einige Ziele müssen wir die Konfiguration in Dateien rendern, daher brauchten wir eine Vorlagen-Engine, bei der Jinja eine offensichtliche Wahl ist.  Jinja generiert eine Konfigurationsdatei aus der Vorlage und den am Zielpunkt empfangenen Daten. <br><br>  Zum Rendern der Konfigurationsdatei benötigen wir eine jmespath-Anforderung, eine Vorlage für die Pfad- und Zieldatei sowie eine Vorlage für die Konfiguration selbst.  An dieser Stelle sollten Sie auch die Dateizugriffsrechte angeben.  All dies wurde glücklicherweise in einer Datei zusammengefasst - vor der Konfigurationsvorlage haben wir einen YAML-Header eingefügt, der den Rest beschreibt.  Zum Beispiel: <br> <code>--- <br> selector: "[@][?@.fft._meta.version == `42`] | items([0].fft_config || `{}`)" <br> destination_filename: "fft/{{ match[0] }}.json" <br> file_mode: 0644 <br> reload_daemons: [fft] <br> ... <br> {{ dict(match[1]) | json(indent=2, sort_keys=True) }} <br></code> <br>  Um die Konfiguration für eine neue Peripherie vorzunehmen, fügen wir eine neue Vorlagendatei hinzu. Es sind keine Änderungen am Quellcode und keine PoP-Software-Updates erforderlich. <br><br>  Was hat sich nach der Implementierung des QControl-Konfigurationsmanagement-Tools geändert? <br>  In erster Linie haben wir in unserem gesamten Netzwerk kohärente und zuverlässige Konfigurationsaktualisierungen erhalten. <br>  Zweitens geben wir ein leistungsstarkes Tool zur Validierung und Änderung der Konfiguration in die Hände unseres Supportteams und unserer Kunden. <br><br>  Wir haben dies erreicht, indem wir ein kürzlich stabiles Design verwendet haben, um die Kommunikation zwischen dem Konfigurationsserver und den Konfigurationsempfängern zu vereinfachen, ein zweischichtiges Kommunikationsprotokoll zur Unterstützung von Nutzlast-unabhängigen Routern zu verwenden und die Jinja-basierte Konfigurations-Rendering-Engine zu implementieren, um eine Vielzahl zu unterstützen von Konfigurationsdateien für unsere vielfältige Peripherie. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de463735/">https://habr.com/ru/post/de463735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de463719/index.html">Tools für Projektmanagementmethoden (Teil 2)</a></li>
<li><a href="../de463725/index.html">Kleine Freude # 9: Konsolenanwendungen mit menschlichem Gesicht</a></li>
<li><a href="../de463727/index.html">So gelangen Sie in der Entwicklungsnische zu Google in der EU / USA und finden Kunden mit großem Budget</a></li>
<li><a href="../de463729/index.html">Treffen mit dem Gründer von NSTR Viktor Chernikov</a></li>
<li><a href="../de463733/index.html">Mesh VS WiFi: Was soll man für Wireless wählen?</a></li>
<li><a href="../de463737/index.html">Problemlösung mit pwnable.kr 21 - horcuxes. Rückgabeorientierte Programmierung und ROP-Ketten</a></li>
<li><a href="../de463739/index.html">Qrator Filter Netzwerkkonfigurations-Managementsystem</a></li>
<li><a href="../de463741/index.html">Mit Firefox (bereits behoben) und Chrome können Sie den Alt-Svc-Header zum Scannen von Intranet-Ports verwenden</a></li>
<li><a href="../de463745/index.html">C ++ zu komplizieren ist unvermeidlich. Und nicht nur C ++</a></li>
<li><a href="../de463747/index.html">Greifen Sie auf Eigenschaften im Jsonb-Feld für Npgsql zu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>