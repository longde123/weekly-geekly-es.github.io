<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😙 🀄️ 🧑🏿‍🤝‍🧑🏼 Nous traitons WebKit dans 1C, par exemple, l'intégration de TinyMCE dans un formulaire géré dans UT 11.4 👩🏻‍🔧 ✌🏼 🉑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beaucoup savent déjà que dans la sortie de la plate-forme 8.3.14.1565, le navigateur Internet Explorer a été remplacé par le Web-Kit, c'est en fait un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous traitons WebKit dans 1C, par exemple, l'intégration de TinyMCE dans un formulaire géré dans UT 11.4</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481768/">  Beaucoup savent déjà que dans la sortie de la plate-forme 8.3.14.1565, le navigateur Internet Explorer a été remplacé par le Web-Kit, c'est en fait un grand pas en avant, mais je suis sûr, comme moi, que ce n'est pas encore clair.  Il y avait une expérience d'utilisation de web-kit dans 1C, appelant JS de 1C et appelant 1C de JS.  Essayons de comprendre ensemble en quoi l'un diffère de l'autre et en même temps, faisons quelque chose d'utile.  Oui, et sûrement beaucoup devront réécrire leurs métiers similaires après la mise à jour vers une nouvelle plate-forme, donc j'espère que mon expérience sera utile. <br><a name="habracut"></a><br>  Tout a commencé avec le fait que la tâche a surgi: «Nous voulons, en UT, entrer une description formatée pour le produit afin qu'il vole plus tard vers la boutique en ligne», car la description standard du produit arrive en trait plein sans césure et n'a pas l'air très bien.  Immédiatement, il y avait un désir d'utiliser un document formaté, il y a un simple éditeur, et vous pouvez le télécharger en HTML.  Mais dès que j'ai montré le code HTML généré par le document formaté aux développeurs Web, ils ont immédiatement agité la main et ont dit que cela ne fonctionnerait pas.  Le site a déjà ses propres styles pour afficher les éléments de bloc nécessaires et le comportement de ce type de texte peut devenir imprévisible. <br><br>  La fonction Get HTML d'un document formaté renvoie une page HTML entièrement formée, avec la structure entière des balises, et ce qui est le plus désagréable, avec des styles en ligne.  Cela ressemble à ceci. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-Type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"X-UA-Compatible"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IE=Edge"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"format-detection"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"telephone=no"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css">{</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">8px</span></span></span><span class="css">;} </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">p</span></span></span><span class="css">{</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">line-height</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">1.15</span></span></span><span class="css">;</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">white-space</span></span></span><span class="css">:pre-wrap;} </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">ol</span></span></span><span class="css">,</span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">ul</span></span></span><span class="css">{</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin-top</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin-bottom</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;} </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">img</span></span></span><span class="css">{</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border</span></span></span><span class="css">:none;} </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">li</span></span></span><span class="css">&gt;</span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">p</span></span></span><span class="css">{</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">display</span></span></span><span class="css">:inline;} </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-decoration: underline;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"font-weight: bold;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"color: #ff0000;font-weight: normal;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Et si obtenir le contenu de la balise body est une tâche simple, je ne voulais pas analyser et découper les attributs de style des balises. <br><br>  TinyMCE ramène une belle mise en page.  Vous autoriser les styles en ligne uniquement dans le cas de la couleur, ce qui est déjà beaucoup mieux. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"color: #ff0000;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Il a été décidé d'intégrer TinyMCE, un éditeur de texte tiers.  De plus, l'expérience de son intégration avec la communauté 1C est déjà assez large. <br><br>  C'était peut-être une erreur à ce moment-là, et il suffisait d'analyser le texte généré par un document formaté, mais nous avons ce que nous avons. <br><br><h4>  1. Caractéristiques de la solution </h4><br>  Étant donné que 1C ne permet pas de télécharger des fichiers locaux du système de fichiers vers la page dans le champ HTML, pour cela, vous avez certainement besoin d'un serveur Web ou au moins l'adresse de ce fichier dans un stockage temporaire, placez la bibliothèque Tiny js à côté de 1C et chargez-la dans les en-têtes du document HTML vous ne pouvez pas - vous devrez également créer un fichier avec une mise en page HTML qui forme en interne une fenêtre d'éditeur prête à l'emploi et qui est déjà connecté au document HTML. <br><br>  En général, en fait, vous pouvez charger une bibliothèque si vous obtenez une adresse dans le référentiel si elle a été compilée dans un fichier, et Tiny, en plus de la bibliothèque principale, contient également des fichiers js de plug-in, un gestionnaire de style et des styles, des fichiers de crack eux-mêmes , icônes, etc., et comme vous le comprenez, cela complique grandement la tâche.  À un moment donné, il y avait même une idée de compiler toutes ces choses dans un seul fichier et de ne pas connaître les problèmes, mais il a fallu beaucoup de temps pour comprendre les outils.  Ensuite, TinyMCE Builder a été trouvé sur le site officiel, qui compile tous les js dans un seul fichier et ce serait une petite victoire s'il faisait de même avec css, mais non, css se trouvait toujours à côté de plusieurs dossiers. <br><br>  TinyMCE crée un iframe pour la fenêtre d'édition, qui est lui-même un document HTML incorporé dans la page, donc les événements qui se produisent dans cet iframe 1C ne peuvent pas être suivis, plus à ce sujet ci-dessous. <br><br>  La configuration de UT 11.4 au moment du développement avait un mode de compatibilité de 8.3.12, donc en fait maintenant il utilisait IE comme navigateur intégré, mais une nouvelle mise à jour impliquait une transition vers de nouvelles versions qui utilisent déjà le web-kit. <br><br><h4>  2. Premières étapes </h4><br>  Les principales différences dans l'utilisation du kit Web: <br><br>  L'objet principal des champs HTML a maintenant une structure différente et pour travailler avec le contenu de la page, vous devez utiliser la propriété <b>defaultView</b> <br><br><pre> <code class="1c hljs">.HTML.Document.DefaultView</code> </pre> <br>  précédemment utilisé la propriété <b>parentWindow</b> pour cette <br><br><pre> <code class="1c hljs">.HTML.Document.parentWindow</code> </pre> <br>  L'interdiction d'utiliser eval, qui était utilisé universellement pour appeler le code JS.  Quelque chose comme ça <br><br>  Elements.FieldHTML.Document.parentWindow.eval ("alert ('Call code from 1C')") <br>  Mais vous pouvez accéder aux méthodes directement depuis 1C. <br><br>  Elements.Description HTML.Document.DefaultView.NameMethodJS (); <br>  Et j'ai rapidement créé des fonctions d'encapsulation pour toutes les méthodes Tiny dont j'ai besoin. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tinyMCE.activeEditor.getContent({<span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-string"><span class="hljs-string">"text"</span></span>}); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tinyMCE.activeEditor.setContent(text); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHTML</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tinyMCE.activeEditor.getContent(); }</code> </pre> <br>  Qui s'est en outre adressé à partir de 1C afin <br><br><pre> <code class="1c hljs">HTML = .HTML.Document.DefaultView; HTML = HTML.GetHTML();  = HTML.GetText();</code> </pre> <br>  Bien que l'on puisse se débrouiller avec des appels directs à l'objet éditeur, par exemple, <br><br><pre> <code class="1c hljs">.HTML..defaultView.tinyMCE.activeEditor.getContent()</code> </pre> <br>  Le traitement de la publication a été immédiatement téléchargé (un respect distinct pour l'auteur), ce qui m'a montré beaucoup de choses intéressantes.  Cela a plus ou moins fonctionné sur IE, mais le copier-coller ne fonctionnait pas sur le webkit, au début, cela a causé une stupeur, mais plus tard, il est devenu clair que c'était à cause de l'iframe que le champ HTML n'était pas activé en cliquant à l'intérieur, car le clic s'est effectivement produit dans le document joint HTML dont les événements se sont coincés quelque part sur le chemin du 1C.  Par conséquent, si vous appuyez sur Ctrl + C à un endroit du formulaire et essayez de le coller dans le champ de l'éditeur, le texte sera inséré dans ce champ d'où il a été copié car le champ HTML du document n'est pas activé.  La même chose se produit dans le cas contraire, les raccourcis clavier pour copier-coller ne fonctionnent pas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/759/7b5/9e3/7597b59e3048362a6cc6d715e64c43f3.gif" alt="image"><br><br>  Au début, l'idée est venue qu'il s'agissait d'un jambage Tiny, et il bloque la pâte directe du tampon, comme CKEditor, qui offre une fenêtre distincte pour le collage à partir du tampon.  Mais pour vérifier que c'était assez facile, j'ai créé un document vide avec un champ de saisie et j'ai essayé de copier et coller <br><br><img src="https://habrastorage.org/getpro/habr/post_images/496/d00/ca5/496d00ca55f4a4ed0b593f56575b8336.gif" alt="image"><br><br>  Comme vous pouvez le voir, tout fonctionne.  Le problème se situe donc quelque part dans Tiny ou en interaction avec 1C. <br><br><h4>  3. Décision </h4><br>  Pour résoudre le problème avec l'interaction du navigateur et de 1C, l'astuce habituelle a été appliquée, j'ai créé un bouton invisible sur la page HTML, et prévu de cliquer dessus depuis JS lorsque les événements nécessaires se sont produits à l'intérieur de la page que 1C intercepterait dans l'événement HTML Press.  Mais à quel événement réaliser un programme presse? <br><br>  La disposition ressemble à ceci: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"editor"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button1c"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display: none"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Et une fonction pour déclencher un événement de clic de bouton <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clickButton</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ button1c.click(); }</code> </pre> <br>  Auparavant, il était possible de transférer un objet de forme 1C dans le champ HTML en tant qu'objet, et en raison du fait qu'IE connecté à 1C via COM, le formulaire lui-même était en quelque sorte converti en un objet que IE comprenait et il était possible d'appeler des fonctions d'exportation de forme 1C directement à partir du code JS .  Maintenant c'est impossible. <br><br>  Nous avons étudié la documentation de l'API Tiny et trouvé une construction pour intercepter les gestionnaires d'événements et une combinaison appropriée d'événements qui devraient activer le champ HTML du document <br><br><pre> <code class="javascript hljs">tinymce.activeEditor.on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{clickButton(e)}); tinymce.activeEditor.on(<span class="hljs-string"><span class="hljs-string">'KeyDown'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{clickButton(e)});</code> </pre> <br>  Vous devez mettre ce code à l'endroit où Tiny a déjà été initialisé.  Je l'ai fait dans le gestionnaire de <b>chargement</b> de l'objet <b>fenêtre</b> .  Mais vous pouvez le faire plus magnifiquement et placer le code lors de l'initialisation de Tiny dans le paramètre: <br><br><pre> <code class="javascript hljs">init_instance_callback</code> </pre> <br>  Maintenant, tout devrait être en ordre.  Et le formulaire devrait fonctionner comme il se doit ... <br><br>  C'est devenu beaucoup mieux, le champ HTML a vraiment commencé à être activé, mais pas toujours, pour une raison quelconque, certains clics n'ont pas entraîné le déplacement du focus vers le champ: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e91/403/d67/e91403d6763d389bcbb7b95a884e07e9.gif" alt="image"><br><br>  Cet enregistrement montre que si vous cliquez sur la ligne où le curseur clignote, le focus du champ fonctionne comme il se doit, mais si vous cliquez ci-dessous, le champ ne s'active pas. <br><br>  C'était un artefact ennuyeux, et les tentatives de comprendre ce qui se passait n'ont donné aucune solution.  J'ai émis des alertes vers le gestionnaire et des alertes ont été affichées, mais 1C n'a pas répondu à l'événement <br><br><img src="https://habrastorage.org/getpro/habr/post_images/531/81f/f82/53181ff82d52da46e812d260056e6d79.gif" alt="image"><br><br>  Soudain, l'idée m'est venue à l'esprit: que se passe-t-il si 1C ne parvient pas à traiter l'événement sur le terrain, et si vous ralentissez un peu l'exécution du script JS et voyez ce qui se passe.  La fonction de pause dans JS a été rapidement implémentée en utilisant des promesses et une attente asynchrone.  Comme vous pouvez le voir dans JS, il manque également par défaut et rien, les gens vivent). <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sleep</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ms</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> setTimeout(resolve, ms)); } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clickButton</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); button1c.click(); }</code> </pre> <br>  Ici, je règle le retard sur une milliseconde, avant de cliquer sur le bouton.  Et le tour est joué.  1C a commencé à traiter le clic d'un bouton à temps. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4fd/c95/937/4fdc959377f0ec372414c1db88959d9e.gif" alt="image"><br><br><h4>  4. Nous finissons l'échange </h4><br>  Étant donné que pour stocker la nouvelle description au format HTML, un nouvel attribut a été ajouté au répertoire, nous devons remplacer la valeur du champ typique lors du déchargement.  Pour ce faire, dans le module ExchangeSiteRemoveable, ajoutez la fonction GetTexts of RequestsCatalog à l'extension et écrivez-y: <br><br><pre> <code class="1c hljs">. = <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(., <span class="hljs-string"><span class="hljs-string">"."</span></span>, <span class="hljs-string"><span class="hljs-string">".HTML_HTML"</span></span>);</code> </pre> <br>  C’est tout.  Nous entamons l'échange et tout fonctionne, il ne reste plus qu'à effectuer des modifications sur le site, si nécessaire, afin que la description du produit soit perçue comme une mise en page et non comme une chaîne. <br><br><h4>  Résumé </h4><br>  Dans cet exemple, j'ai essayé l'interaction de JS WebKit et 1C, collecté le râteau et trouvé une solution. <br><br>  Peut-être que pour résoudre ce problème, il était plus facile d'analyser et d'effacer le texte HTML d'un document formaté, mais ce ne serait pas si intéressant et pourrait poser des problèmes avec certaines options de mise en forme complexes. <br><br>  Merci d'avoir lu. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481768/">https://habr.com/ru/post/fr481768/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481754/index.html">Moi bot et mon poinçon</a></li>
<li><a href="../fr481756/index.html">Comment organiser les DDoS à de bonnes fins?</a></li>
<li><a href="../fr481758/index.html">Statistiques de construction, d'approvisionnement et de visites à l'ISS</a></li>
<li><a href="../fr481762/index.html">Équations pour la cuisine sous le sapin de Noël</a></li>
<li><a href="../fr481764/index.html">Pourquoi l'énergie verte a-t-elle un avenir difficile?</a></li>
<li><a href="../fr481776/index.html">Services de jeux 5G et cloud - testez comment cela fonctionne à Moscou</a></li>
<li><a href="../fr481778/index.html">Analyse des logiciels malveillants Skeleton Key</a></li>
<li><a href="../fr481780/index.html">MyOffice a plus de 200 nouvelles fonctionnalités</a></li>
<li><a href="../fr481782/index.html">A propos des problèmes de traducteur Python et repenser la langue</a></li>
<li><a href="../fr481784/index.html">Comment Kafka est devenu réalité</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>