<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•§ üåê üë©‚Äçüë¶ L'histoire d'une animation ü§æüèæ üçÑ ‚úäüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois, le designer a appel√© le front-end et a demand√© de faire une "toile d'araign√©e" derri√®re le verre embu√©. Mais il s'est av√©r√© que ce n'√©tait p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'histoire d'une animation</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/450832/">  Une fois, le designer a appel√© le front-end et a demand√© de faire une "toile d'araign√©e" derri√®re le verre embu√©.  Mais il s'est av√©r√© que ce n'√©tait pas une ¬´toile d'araign√©e¬ª, mais une grille hexagonale, et non derri√®re la vitre, mais elle est all√©e au loin, et le front-end n'√©tait pas familier avec WebGL, et j'ai d√ª apprendre toute l'animation dans le processus de dessin.  Ce front-end √©tait <b>Yuri Artyukh</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">akella</a> ). <br><br><img src="https://habrastorage.org/webt/4b/db/la/4bdblauwhfg83othzzcjlfdjzf0.jpeg"><br><br>  Yuri est engag√© dans la composition depuis longtemps et le dimanche enregistre des flux avec l'analyse de projets r√©els.  Il n'est pas un pro de WebGL, ne fait pas de cartes dessus, n'√©crit pas dans Web assembler, mais il aime apprendre quelque chose de nouveau.  √Ä <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FrontendConf</a> RIT ++, Yuri a expliqu√© comment effectuer une animation de la mise en page √† la livraison au client afin que tout le monde soit satisfait et apprenne WebGL en cours de route.  L'histoire vient du point de vue de la premi√®re personne et comprend: Three.js, GLSL, Canvas 2D, des graphiques et un peu de math√©matiques. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Eq_rXOyOX0I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  Toile d'araign√©e derri√®re un verre brumeux </h2><br>  D'une certaine mani√®re, je me suis assis et j'ai travaill√© sur un projet important.  Ensuite, le designer du studio, qui aime beaucoup les effets sp√©ciaux, appelle et demande: "Pouvez-vous faire une toile d'araign√©e, comme si derri√®re une vitre embu√©e?" <br><br>  Ceci, bien s√ªr, d√©crit imm√©diatement tout le probl√®me.  Comme il s'est av√©r√© plus tard, la "toile d'araign√©e" derri√®re le verre brumeux √©tait la suivante. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/da/0z/bn/da0zbnmw-g-0_jwatgdtvlevqk4.jpeg" width="600"></div><br><br>  Il s'agit d'une grille hexagonale, mais pour le concepteur, pour une raison quelconque, une "toile d'araign√©e".  Verre brumeux - cette grille va au loin.  Difficult√©s de communication.  Imaginez √† quel point il est difficile d'√™tre introverti et de faire des animations?  Mais je suis juste comme √ßa et c'est ce que je fais. <br><br>  Ce "web" ne ressemble pas √† une animation, apr√®s quoi vous pouvez r√©diger un rapport sur un cas r√©ussi, ouvrir une startup, obtenir un milliard d'investissements, avoir un tas de fans et lancer une fus√©e dans l'espace.  De quoi s'agit-il?  Une ligne brune sur fond blanc-gris, comme trac√©e par une souris.  Plus tard, il s'est av√©r√© qu'elle devrait aller le long des bords, mais plus √† ce sujet plus tard.  En g√©n√©ral, le nom de code est ¬´le Web derri√®re le verre brumeux¬ª. <br><br>  Sur le site avec cette animation, il y avait plusieurs autres options pour la ¬´toile d'araign√©e¬ª: sur un fond gris en haut, sur un blanc en dessous.  Il fallait le rendre interactif pour qu'il r√©ponde au mouvement de la souris de l'utilisateur. <br><br>  La premi√®re chose que les concepteurs m'ont demand√©, c'est √† quel point c'est difficile et combien cela co√ªtera.  Quelques pens√©es m'ont travers√© la t√™te: comment dessiner une ligne et une telle grille, comment la faire ralentir, comment cela devrait fonctionner.  Je n'ai jamais rencontr√© cela auparavant.  Mais, en tant que personne engag√©e dans le d√©veloppement, il a r√©pondu: " <i>√áa, c'est facile, nous le ferons ..."</i> <br><br>  J'aime m'impliquer dans des aventures √©tranges, car quand je fais √ßa, je souffre g√©n√©ralement. <br><br><blockquote>  La souffrance vient de la croissance.  Elle est in√©vitablement associ√©e √† la souffrance - vous ne pouvez pas √™tre satisfait de tout, vivre heureux et en m√™me temps vous d√©velopper professionnellement. </blockquote><br><h2>  Three.js </h2><br>  J'ai imm√©diatement commenc√© √† r√©fl√©chir √† la mani√®re de r√©soudre le probl√®me.  Comme tout √©tait en 3D, je me suis souvenu de <b>Three.js</b> .  Il s'agit de la biblioth√®que la plus populaire mentionn√©e lors de toutes les conf√©rences.  Cette biblioth√®que rend WebGL plus simple, plus pratique et plus agr√©able que le simple WebGL natif. <br><br>  Three.js a de nombreux objets pr√™ts √† l'emploi.  <b>PlaneGeometry</b> est le premier objet qui m'a paru parfait.  Ceci est un plan primitif.  La biblioth√®que poss√®de toutes sortes d'hexagones, de dod√©ca√®dres, d'icosa√®dres, de cylindres, mais il existe un plan simple √† partir de nombreux triangles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1b/d6/zh/1bd6zhhmntwqmvhlzc6fe8pt5u8.jpeg" width="600"></div><br>  <i>Il y a beaucoup de triangles, car j'ai besoin d'ondes d√©taill√©es - la surface doit s'inqui√©ter.</i> <br><br>  Si vous regardez √† l'int√©rieur de Three.js, alors en fait ce plan est un simple objet JS avec une liste de toutes les coordonn√©es des points. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ma/4l/2s/ma4l2so6e_q2_njrkzrjsdibylu.jpeg" width="600"></div><br><br>  Dans mon cas, j'ai un plan de 50 √ó 50 carr√©s, donc j'avais besoin de 2601 sommets.  Pourquoi 50 √ó 50 = 2601?  Ce sont les math√©matiques de l'√©cole.  La coordonn√©e z = 0, parce que le plan, y = 1, parce que c'est la premi√®re rang√©e de sommets de 50 pi√®ces, et x change. <br><br>  Mais pourquoi ai-je besoin d'un avion, dois-je le plier d'une mani√®re ou d'une autre?  La premi√®re chose que vous pouvez faire avec un tableau est d'effectuer des op√©rations math√©matiques sur celui-ci.  Par exemple, parcourez la boucle <code>for each</code> boucle et affectez la coordonn√©e z √† la valeur sinus de la coordonn√©e x. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rl/4t/vx/rl4tvxjhweazbjcjjakkaxv38nw.jpeg" width="600"></div><br><br>  Il s'est av√©r√© quelque chose de similaire √† une onde sinuso√Ødale, car la valeur de la hauteur de chaque sommet sera √©gale au sinus de cette valeur le long de l'axe x.  Pour compliquer cela d'une fa√ßon ou d'une autre (maintenant ce sera un moment math√©matique difficile, pr√©parez-vous) - J'ajouterai du temps au sinus, et cette toile bougera, simplement parce que les math√©matiques fonctionnent de cette fa√ßon.  Si vous ajoutez du temps √† la coordonn√©e x, le graphique se d√©place horizontalement.  Si coordonner y - se d√©placera verticalement.  Je m'int√©ressais au mouvement horizontal - je voulais que mon oc√©an s'inqui√®te. <br><br>  Le concepteur ne s'attendait pas √† ce que je poss√®de une sinuso√Øde qui rampe de gauche √† droite.  Il voulait que ce soit beau, comme une toile d'araign√©e, un oc√©an ou tout ce qui √©tait dans sa t√™te.  Par cons√©quent, l'option avec une sinuso√Øde ne convenait pas.  Il a fallu une sorte de hasard.  L'avion n'aurait pas d√ª √™tre pr√©visible comme une onde sinuso√Ødale.  Mais si vous appelez au hasard pour chacun de ces pics, nous obtenons alors une impr√©visibilit√© tr√®s √©lev√©e. <br><br>  L'essence du caract√®re al√©atoire est qu'il est al√©atoire et ind√©pendant.  Chaque sommet al√©atoire ne d√©pend en aucune fa√ßon de ses voisins.  Au hasard, aucun param√®tre n'est transmis, il ne se soucie pas des voisins. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xi/_i/-z/xi_i-z1fxtzdkobj8rvyw5zdwum.jpeg" width="600"></div><br><br>  Le r√©sultat est une courbe bris√©e qui ne ressemble √† l'oc√©an ou au Web qu'√† distance.  Plus appropri√© comme illustration pour un film sur les "hackers" et les cambriolages informatiques. <br><br>  Si vous regardez au hasard du point de vue de chaque point de l'√©cran, cela ressemble √† du bruit blanc - beaucoup de petits points blancs et noirs.  Chaque point est noir et blanc - 0 ou 1. <br><br>  Mais ce dont j'ai besoin pour cr√©er un oc√©an de vagues devrait ressembler √† ceci. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ko/gf/4r/kogf4rlg2l22xip6a0bnppd2oym.jpeg" width="600"></div><br>  <i>Il ressemble au brouillard, aux nuages ‚Äã‚Äãet aux montagnes.</i> <br><br>  Il existe des fonctions al√©atoires qui renvoient de telles images.  Ils sont appel√©s bruits ou <b>bruit</b> : bruit simplex, bruit Perlin.  Perlin au nom du bruit est le nom du cr√©ateur de l'algorithme de bruit de gradient, qui renvoie un beau hasard.  Il l'a cr√©√© en travaillant sur les effets sp√©ciaux de la premi√®re partie du film "Tron".  Cet algorithme math√©matique existait auparavant, mais maintenant il est activement utilis√© dans les films et les jeux. <br><br>  Lorsque des cartes al√©atoires sont g√©n√©r√©es dans "Heroes of Might and Magic III" (pour ceux de plus de 30 ans) ou dans des strat√©gies., Vous pouvez g√©n√©ralement voir quelque chose de similaire.  C'est toujours la m√™me fonction qui renvoie ces bruits. <br><br>  Il y a tout un mouvement ¬´Art g√©n√©ratif¬ª.  Les participants g√©n√®rent des illustrations, des paysages, en utilisant la fonction de bruit.  Par exemple, dans l'image ci-dessous, un paysage pseudo-naturel de l'un des artistes.  On ne sait pas imm√©diatement s'il s'agit de math√©matiques ou de la topographie d'une montagne.  La t√¢che de l'art g√©n√©ratif est pr√©cis√©ment de g√©n√©rer math√©matiquement un paysage qui ne se distingue pas du pr√©sent. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qe/lw/ky/qelwkyrefwhms3hhd_gbd7azazs.jpeg" width="600"></div><br><br>  Il s'est av√©r√© que, contrairement au hasard, cette fonction prend des param√®tres, car les points doivent d√©pendre des voisins les plus proches d'eux.  Si vous utilisez la fonction de bruit au lieu du caract√®re al√©atoire habituel, vous obtenez quelque chose comme √ßa. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ce/og/ti/ceogtizjdrzw3kfbrdz6n1cnqra.jpeg" width="600"></div><br>  <i>Le noir et le blanc sont tout simplement la hauteur: 0 sont des vall√©es noires, 1 sont des pics blancs.</i>  <i>Il transforme une surface ondul√©e.</i> <br><br>  Cette fonction est pr√©sente sur tous les PL car elle n'est qu'un algorithme - sinus, cosinus, multiplication. <br><br>  Je peux faire la distorsion de la m√™me mani√®re en parcourant tous les sommets de mon objet PlaneGeometry, en affectant chaque valeur √† la fonction de bruit: <br><br><pre> <code class="javascript hljs">geometry.vertices.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> { vz = noise(vx, vy, time); });</code> </pre> <br>  La fonction ne prend que 30 √† 40 lignes, mais est math√©matiquement complexe. <br><br>  Il existe des fonctions de bruit de toutes dimensions: unidimensionnelles, bidimensionnelles, tridimensionnelles.  Dans mon cas, il s'agit d'un bruit tridimensionnel, car trois param√®tres lui sont transmis.  En plus des coordonn√©es spatiales des plans x et y, je transmets le temps - la surface se tordra constamment, changera de position. <br><br><h2>  Three.js!  == GPU </h2><br>  Quand j'ai commenc√© l'algorithme, les vagues ont commenc√© √† bouger.  Quand je fais quelque chose pour le Web, je regarde toujours dans le profileur, et maintenant je le regarde aussi. Voil√† √† quoi ressemblaient les vagues. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9r/os/qg/9rosqgaqfwrqwxnnzmxhhw-1szq.jpeg" width="600"></div><br><br>  Sur l'√©cran, un cadre est dessin√© par le navigateur.  Les cadres sont indiqu√©s par des lignes verticales en pointill√©s gris.  A l'int√©rieur du cadre, 2/3 du temps est occup√© par l'ex√©cution de la fonction bruit.  Lorsque vous animez quelque chose sur le Web, vous utilisez au mieux le cadre d'animation de demande, qui s'ex√©cute toutes les 16 ms.  La trame toutes les 16 ms compte la fonction de bruit pour 2600 sommets.  Pour chaque sommet, un mouvement de haut en bas et une hauteur sont consid√©r√©s.  Sur chaque trame suivante, les valeurs sont recalcul√©es, car la surface doit vivre dans le temps. <br><br>  Il s'est av√©r√© que la fonction de bruit, qui a tourn√© 2600 fois, prend d√©j√† 2/3 du cadre sur mon ordinateur.  Et ce n'est pas tout le cadre.  Lors du d√©veloppement d'animations, c'est d√©j√† un drapeau rouge. <br><br><blockquote>  Aucune animation ne doit occuper plus de la moiti√© du cadre. </blockquote><br>  Si plus, il y a un risque √©lev√© de perdre le cadre lors de toute interaction, tout bouton, tout survol. <br><br>  Par cons√©quent, c'√©tait un drapeau rouge difficile.  J'ai r√©alis√© que Three.js n'est pas n√©cessairement WebGL.  Malgr√© le fait que j'ai sembl√© utiliser Three.js, j'ai tout dessin√© en 3D, il a √©t√© rendu en WebGL, je n'ai pas obtenu de performances fantastiques de WebGL.  Je n'ai que 2 600 sommets - ce n'est pas suffisant pour WebGL.  Par exemple, sur chaque carte, il y a des milliers d'objets, chacun compos√© de dizaines de triangles.  Estimez l'√©chelle: des centaines de milliers sont normales, mais il n'y a que 2600 pics. <br><br><h2>  Vertex Shader </h2><br>  Apr√®s un probl√®me avec les cadres, j'ai d√©couvert qu'il y avait des shaders.  Il en existe seulement deux types: <br><br><ul><li>  Vertex Shader; <br></li><li>  Shader de fragment. <br></li></ul><br>  Je m'int√©ressais au vertex shader - Vertex Shader.  Si nous r√©√©crivons l'animation dessus, cela ressemble √† ceci: <br><br><pre> <code class="javascript hljs">position.z = noise( vec3(position.x, position.y, time) );</code> </pre> <br>  <code>Position.z</code> - coordonn√©es z du composant de chaque point avec ses propres types de donn√©es.  <code>vec3</code> indique qu'il y aura trois param√®tres. <br><br><blockquote>  Il n'y a pas de boucle dans le shader. </blockquote><br>  Avant cela, dans le script, je mettais un <code>for each</code> boucle, et pour chaque sommet, les calculs se faisaient en boucle.  La diff√©rence entre les shaders et les non-shaders est l'absence de cycle. <br><br><blockquote>  Shader - c'est le cycle. </blockquote><br>  Il est ex√©cut√© en parall√®le pour tous les sommets √† la fois.  C'est sa signification principale, sa mission, sa puce et sa mission. <br><br>  Le GPU sur la carte vid√©o a un c≈ìur plus grand, contrairement au processeur principal.  Sur le processeur, il y en a beaucoup moins, mais il est capable d'effectuer des calculs universels plus rapidement.  Des calculs tr√®s simples sont disponibles sur la carte vid√©o, mais il existe de nombreux c≈ìurs, ce qui vous permet de parall√©liser de nombreux calculs.  C'est ce qui se produit g√©n√©ralement dans les shaders.  La signification du vertex shader est que le bruit sera calcul√© en parall√®le pour 2600 sommets dans le shader sur la carte vid√©o. <br><br>  Si vous regardez le profileur, l'apparence de l'animation ne changera pas, mais elle ressemblera √† ceci. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/k7/xv/et/k7xvetot_x1xphmbrtsfkifz8mc.jpeg" width="600"></div><br><br>  <b>Rien n'est ex√©cut√© sur la CPU</b> .  Bien s√ªr, un autre fil sur le GPU a √©t√© ajout√© ci-dessous.  Il existe √©galement des threads sur le GPU, le CPU, les Web-travailleurs, mais ces calculs seront d√©j√† effectu√©s dans un thread s√©par√© sur la carte vid√©o. <br><br>  Bien s√ªr, ce n'est pas gratuit.  La carte vid√©o au travail est plus chauff√©e que le processeur principal.  Par cons√©quent, souvent lorsque vous visitez des sites avec des animations similaires, les fans commencent √† travailler pour vous.  En effet, lorsque la carte vid√©o est allum√©e, elle n√©cessite un refroidissement, contrairement au reste du temps.  Sur les appareils mobiles, cela est plus important que sur les ordinateurs de bureau - les t√©l√©phones portables s'√©puisent simplement plus rapidement.  Mais en m√™me temps, vous obtenez un gain de performances assez radical. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/x-/zr/hhx-zrjk_c8ftrd4hjdqhohcn1a.jpeg" width="600"></div><br>  <i>Le r√©sultat est une telle surface - c'est le bruit perlin habituel.</i>  <i>Si vous le d√©marrez et ne changez que l'heure, des vagues fra√Æches sont obtenues.</i> <br><br>  Mais ce n'est pas tout.  Je devais encore "toiles d'araign√©e" - une grille hexagonale √† la surface.  Ayant de l'exp√©rience en mise en page, la mani√®re la plus simple et la plus √©vidente est de s√©lectionner un fragment qui peut √™tre r√©p√©t√©.  Fait int√©ressant, pour une grille hexagonale, elle n'est pas carr√©e, mais rectangulaire.  Si vous r√©p√©tez le motif sous forme de rectangle, vous obtenez une grille.  La biblioth√®que Three.js vous permet de superposer png et de ne pas apprendre tout WebGL avant cela.  J'ai d√©coup√© png et l'ai mis √† la surface, il s'est av√©r√© quelque chose comme √ßa. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8n/gc/p0/8ngcp0pi_2s1st4ubwo8sgh8zps.jpeg" width="600"></div><br><br>  √Ä premi√®re vue, ce dont vous avez besoin!  Mais seulement au d√©but.  Cela ne me convenait pas, car l'animation √©tait requise pour le site de crypto-monnaie - tout devrait √™tre ¬´cher, riche¬ª. <br><br>  Lorsque vous utilisez des textures png et qu'elles sont proches de l'appareil photo, vous pouvez voir que les bords de l'√©l√©ment le plus proche sont flous.  Il n'y a aucun sentiment que l'image est claire.  Le png semble s'√™tre √©tendu dans le navigateur.  Le probl√®me est que dans WebGL, il n'y a aucun moyen d'utiliser des textures vectorielles au sens plein du terme.  J'ai donc pleur√©, puis j'ai lu sur Internet que <b>GLSL</b> r√©sout ce probl√®me. <br><br>  GLSL est un langage de type C dans lequel les shaders sont √©crits.  Tout le monde a peur de l'utiliser, car ce sont des shaders, WebGL - rien n'est clair!  Mais j'ai d√©couvert qu'il √©tait possible de faire des images claires dessus et je me suis tourn√© vers le deuxi√®me type de shader. <br><br><h2>  Shader de fragment </h2><br>  Ce shader fait la m√™me chose que le vertex.  Mais, si le sommet construit une surface polyligne, effectuant des calculs pour chaque sommet, le shader Fragment calcule la couleur pour chaque pixel de la surface. <br><br>  La fonction de <code>fragment shader ‚Äì step(a,b)</code> plus √©l√©mentaire <code>fragment shader ‚Äì step(a,b)</code> .  Il ne renvoie que 0 et 1: <br><br><ul><li>  si a&gt; b, alors 0; <br></li><li>  si a &lt;b, alors 1. <br></li></ul><br>  J'ai fait une pseudo-impl√©mentation dans JS pour montrer √† quel point cette fonction est simple. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">step</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a &lt; b) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br>  Lorsque vous travaillez dans WebGL, g√©n√©ralement sur n'importe quel objet, il existe un syst√®me de coordonn√©es.  S'il s'agit d'un objet carr√©, le syst√®me de coordonn√©es est primitif: points (0,0), (0,1), (1,0), (1,1). <br><br>  Un Fragment Shader est ex√©cut√© pour chaque pixel.  Si Vertex Shader est de 2600 fois par image, alors Fragment Shader est ex√©cut√© autant de fois qu'il y a de pixels.  Peut-√™tre un million de fois pour chaque image, si la surface est de 1000 √ó 1000 px.  Cela semble effrayant, mais tout simplement parce que peu de gens connaissent les ressources des cartes vid√©o √† notre √©poque. <br><br>  Si vous utilisez la fonction step (a, b) avec les coordonn√©es de ces pixels, vous pouvez ex√©cuter la fonction step avec le param√®tre 0.4 et passer la coordonn√©e x de chaque pixel √† chaque point. <br><br>  Il s'av√®re que tout ce qui est inf√©rieur √† 0,4 sera 0, tout ce qui est sup√©rieur √† 1. Dans WebGL, les nombres et les couleurs sont une seule et m√™me chose.  Chaque couleur est un num√©ro.  Blanc - 1, noir - 0. Il y en a trois en RVB, mais c'est toujours 0.0.0 et 1.1.1. <br><br><img src="https://habrastorage.org/webt/0g/yn/u8/0gynu8ekf6ms9lbsxses7zlnsq8.jpeg"><br><br>  Si nous ex√©cutons cette √©tape de fonction plus compliqu√©e, nous obtenons du blanc sur la gauche.  Cette fonction sera ex√©cut√©e pour chaque point de l'√©cran et consid√©rera qu'il s'agit de 0 ou 1. C'est normal, ne vous en faites pas. <br><br>  Si vous multipliez ces deux expressions, vous obtenez une bande blanche verticale.  Si vous faites de m√™me sur un axe diff√©rent, vous pouvez dessiner un carr√© blanc: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ed/-m/bd/ed-mbd_kkdxv-lfxhmgk4iixr3o.jpeg" width="600"></div><br>  <i>Ce devrait √™tre le point culminant - nous avons dessin√© un carr√© blanc!</i> <br><br><blockquote>  En utilisant des combinaisons d'une seule fonction, vous pouvez dessiner tout ce que vous voulez. </blockquote><br>  Si vous vous souvenez, les √©l√©ments du motif √©taient inclin√©s.  Si vous faites une surface inclin√©e, qui se compose uniquement de couleurs noir et blanc, elle sera nervur√©e et non liss√©e.  Les c√¥tes attirent votre attention - c'est moche.  Pour rendre la surface lisse pour l'≈ìil, non seulement des pixels noirs et blancs sont n√©cessaires, mais √©galement des demi-teintes grises. <br><br><h3>  Smoothstep </h3><br>  Les shaders ont une fonction lisse.  Il fait la m√™me chose que step, mais interpole entre 0 et 1 pour qu'il y ait un gradient. <br><br><img src="https://habrastorage.org/webt/70/ie/sj/70iesjc9whr9omw98d6vgdegn7u.jpeg"><br>  <i>De gauche √† droite, apr√®s compression maximale.</i> <br><br>  Si vous compressez cette fonction autant que possible, vous obtenez une ligne √† gradient minimal.  C'est exactement ce dont vous avez besoin pour g√©n√©rer une ligne parfaitement lisse √† n'importe quel angle dans le shader Fragment. <br><br>  J'ai donc pu faire un carr√© blanc avec des bords lisses.  S'il y a un carr√© blanc, vous pouvez faire 3 carr√©s blancs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mk/vj/yj/mkvjyjhkpspu2gyr07ljvav8f0e.jpeg" width="600"></div><br>  <i>Les carr√©s peuvent √™tre tourn√©s, utilisez les fonctions sinus et cosinus.</i> <br><br>  Ensuite, j'ai d√ª utiliser du papier et une feuille pour briser mon mod√®le. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hp/a4/yz/hpa4yzizs2urt92ucauxlgwr3ny.jpeg" width="600"></div><br>  <i>Capture d'√©cran de la production.</i> <br><br>  L√†, tout est li√© √† 23 degr√©s de multiplicit√© diff√©rents, il n'a donc pas √©t√© tr√®s difficile de calculer les coordonn√©es de tous ces points.  Et puis vous pouvez obtenir un tel mod√®le. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wr/81/kt/wr81ktna90gxloib0ainetldwrk.jpeg" width="600"></div><br><br>  J'ai dessin√© un fragment et je l'ai r√©p√©t√© plusieurs fois.  Vous pouvez clairement voir le mode de d√©bogage, o√π le motif se r√©p√®te.  Tous les fragments sont ex√©cut√©s en utilisant les fonctions param√©triques <code>step</code> et <code>smoothstep</code> .  Cela signifie qu'en cr√©ant un motif pour incliner l'avion, vous pouvez g√©n√©rer un nombre infini de ces motifs.  Si √† l'int√©rieur du fragment, nous modifions l'√©paisseur du trait ou la taille des hexagones, nous obtenons alors de nombreux autres motifs. <br><br>  J'ai tordu les param√®tres et trouv√© un nombre infini de motifs.  C‚Äôest comme ¬´l‚Äôart g√©n√©ratif¬ª - ce qui a √©t√© fait n‚Äôest pas clair, mais joliment. <br><br><h3>  SDF </h3><br>  Ensuite, j'ai d√©couvert qu'il existe √©galement <b>des champs de distance sign√©s - g√©n√©rant des images avec une carte de distance</b> .  SDF est utilis√© dans les cartes ou dans les jeux informatiques pour dessiner des textes et des objets, car il est optimal.  Dans WebGL, il est difficile de dessiner du texte d'une mani√®re diff√©rente, particuli√®rement lisse et d√©limit√©e. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-k/il/9h/-kil9h7eyazgilry_p6tqdmqvxw.jpeg" width="600"></div><br><br>  Il s'agit d'un format math√©matique difficile √† utiliser en dehors de WebGL.  L'id√©e est simple, mais √©l√©gante et donne un bel effet. <br><br>  Si nous voulons dessiner une √©toile claire, alors pour cela, nous devons enregistrer l'image sur la droite - c'est l'image g√©n√©r√©e de l'image.  Il existe d√©j√† un algorithme existant qui transforme toute image claire en une image floue.  Apr√®s cela, il peut √™tre utilis√© pour g√©n√©rer une version claire, mais en m√™me temps, nous n'obtenons pas une image, mais plusieurs.  √Ä partir d'une image claire de la m√™me taille, vous pouvez g√©n√©rer la m√™me chose, mais en plus grand.  Ce sera avec des erreurs, mais l'approche est math√©matiquement int√©ressante. <br><br>  Par exemple, si vous prenez une photo d'une taille de 128 √ó 128 px, alors √† partir d'une photo de petite taille, vous pouvez obtenir une image claire plusieurs fois plus grande que la source.  C'est l'une des raisons pour lesquelles ils utilisent SDF - une police floue p√®se souvent moins que dans un format vectoriel optimis√©. <br><br>  Bien s√ªr, il y a une limitation.  Il est impossible d'augmenter les lettres √† 1000 px, m√™me 100 px auront l'air moche.  Mais √† quelle fr√©quence des polices de cette taille sont-elles n√©cessaires? <br><br>  Fragment shader, dessin de rectangles, propagation - √† l'aide de ces perturbations, j'ai finalement r√©ussi √† trouver la surface souhait√©e. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/t1/nf/5h/t1nf5hhliercxy0q6axrs4bmosm.jpeg" width="600"></div><br><br><h2>  De nouvelles conditions </h2><br>  Elle √©tait comme il se doit: se tortillant, tous les √©l√©ments √©taient clairs.  Tout √©tait comme je le voulais, mais il s'est av√©r√© qu'il y avait plus: <br><br>  <i>- Et laissez-le bouger avec la souris et un nouveau chemin est en train d'√™tre trac√©.</i>  <i>Et les nids d'abeilles sont mis en valeur!</i> <br><br>  Il a √©t√© suppos√© que lorsque l'utilisateur d√©place la souris, il ouvre m√©taphoriquement son chemin √©pineux le long de la "toile d'araign√©e" cass√©e en utilisant le service. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/da/0z/bn/da0zbnmw-g-0_jwatgdtvlevqk4.jpeg" width="600"></div><br><br>  Ce n'est pas difficile de d√©crire la t√¢che avec des mots, mais comment la mettre en ≈ìuvre?  La premi√®re chose que j'ai pens√© - puisque j'ai une grille hexagonale, elle a probablement d√©j√† √©t√© √©tudi√©e.  Puis je suis tomb√© sur un article int√©ressant ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">R√©f√©rence de grille hexagonale et guide d'impl√©mentation</a> ¬ª.  L'auteur y a collect√© des documents pendant 20 ans.  Il est cool sans aucun doute, et l'article est divin pour ceux qui aiment les algorithmes et les math√©matiques.  Il contient de nombreuses donn√©es int√©ressantes sur les maillages hexagonaux. <br><br>  L'article est long, mais il contient des approches math√©matiques int√©ressantes: comment construire un syst√®me de coordonn√©es sur une grille hexagonale, comment num√©roter ces hexagones, puis les r√©f√©rencer l√† o√π il est utilis√©.  Il s'av√®re que cela a toujours √©t√© sous mes yeux, car dans les vieux jeux informatiques, des filets hexagonaux sont utilis√©s partout. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hp/l5/eb/hpl5ebbnsk_y4wwpe68txgddw3a.jpeg" width="600"></div><br>  <i>Si vous √™tes d√©j√† r√©gl√© sur une case hexagonale - regardez le ch√¢teau.</i>  <i>Sur d'autres textures, une grille hexagonale est √©galement devin√©e.</i> <i><br><br></i> <div style="text-align:center;"> <i><img src="https://habrastorage.org/webt/pm/t3/dr/pmt3dricwm2bhfavsrk4alsb_4i.jpeg" width="600"></i> </div> <i><br></i>  <i>Dans "Civilisation", tout est g√©n√©ralement √©vident.</i> <br><br>  Il √©tait √©galement int√©ressant de savoir que si vous faites une coupe transversale le long de la diagonale d'un cube en trois dimensions, qui se compose de nombreux petits cubes, alors, d'une part, ce sont des cubes, et de l'autre, des hexagones r√©guliers. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yi/or/en/yiorenlgrsykxcxcajtomaq-rf0.jpeg" width="600"></div><br><br>  La section transversale d'un cube en trois dimensions donne une grille hexagonale en deux dimensions.  C'√©tait amusant d'apprendre que les cubes en trois dimensions sont en quelque sorte connect√©s avec des hexagones en deux dimensions. <br><br>  Dans l'article, y compris, il y avait un algorithme pour trouver le chemin le long de la grille hexagonale.  J'ai d√ª chercher un moyen de faire de la hauteur √† travers la souris. <br><br>  Les algorithmes de recherche de chemin sont complexes et simples.  Le plus primitif consiste √† tracer une ligne entre les points et √† voir dans quels hexagones cette ligne tombe.  Il s'av√®re donc que dans le pass√©, les unit√©s allaient du point A au point B. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gz/f1/qj/gzf1qjc4ygip7wfnbfam_x3gl1c.jpeg" width="600"></div><br>  <i>J'avais besoin de quelque chose comme √ßa.</i> <br><br>  Mais ce n'est pas ce dont j'ai besoin.  Ici, le chemin est trac√© le long des zones d'hexagones, et j'ai besoin le long des bords.  J'ai d√ª r√©soudre le probl√®me diff√©remment. <br><br><h3>  Canvas2d </h3><br>  Il y a peut-√™tre de meilleures fa√ßons, mais la mienne est plus int√©ressante.  Au d√©but, je viens de dessiner <b>Canvas2D</b> pour mon d√©bogage - √©tape # 1. <br><br><img src="https://habrastorage.org/webt/c0/jb/sx/c0jbsx3mwra1bhrek7v7lsmzs6u.jpeg"><br><br>  Avant cela, il y avait WebGL, Three.js, shaders, et c'est juste Canvas2D!  J'ai dessin√© tous les points de la grille hexagonale dessus.  Si vous regardez attentivement, ce sont les m√™mes hexagones.  Ensuite, je me suis souvenu des graphiques qui stockent des informations sur la fa√ßon dont les points sont connect√©s les uns aux autres, et j'ai connect√© chaque point √† trois voisins et j'ai obtenu un graphique - √©tape num√©ro 2. Pour cela, j'ai utilis√© de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">beaux graphiques</a> Open Source. <br><br>  Un graphique est simplement un ensemble de points et d'informations sur la fa√ßon dont ils sont connect√©s.  Ils sont bien √©tudi√©s, il existe de nombreux bons algorithmes pour tous les go√ªts pour trouver le chemin du point A au point B √† l'int√©rieur du graphique.  Toutes les cartes utilisent ce type d'algorithmes. <br><br>  Cela ressemble √† ceci. <br><br><pre> <code class="javascript hljs">graph = createGraph( ); graph.addNode(..); <span class="hljs-comment"><span class="hljs-comment">// 1000 nodes graph.addLink(..); // 3000 links graph.pathFinder(Start, Finish); //0.01s</span></span></code> </pre> <br>  Nous construisons un graphique, ajoutons 1000 points et toutes les connexions entre eux, Ensuite, nous passons l' <code>id</code> chaque point - le premier est connect√© au troisi√®me, le troisi√®me au cinqui√®me.  Pas besoin d'inventer quoi que ce soit, il existe un algorithme optimis√© avec une fonction toute faite qui vous permettra de trouver ce chemin. <br><br>  Cet algorithme fonctionne moins qu'une trame.  Bien s√ªr, cela prend une sorte de ressource, mais vous n'avez pas besoin de l'ex√©cuter toutes les 16 ms, mais uniquement lorsque le chemin change. <br><br>  J'ai donc pu construire cet itin√©raire √† l'√©tape 3. Dans Canvas2D, il a commenc√© √† ressembler √† ceci: le chemin le plus court du point A au point B - tout, comme dans la vie.  √Ä premi√®re vue, il semble que ce ne soit pas le chemin le plus court, mais il s'av√®re qu'il y a beaucoup de chemins les plus courts du point A au point B le long de la grille hexagonale. <br><br>  Dans WebGL, toutes les images sont des nombres.  L√†, vous pouvez transf√©rer des textures dans le shader, par exemple, j'ai essay√© de transf√©rer des png.  Il n'y a aucune diff√©rence pour le navigateur - il est pass√© png ou Canvas2D.  Pour le navigateur Canvas2D, c'est la m√™me chose que l'image finale, bitmap.  Par cons√©quent, j'ai d'abord dessin√© cette image sous la forme d'un serpent.      ‚Ññ 4. <br><br>  Canvas2D       .     Canvas2D    ,     ‚Äî        .  ,   .   ,       Canvas2D  3D,  ,       . <br><br>  , ,   WebGL     ‚Äî  ,     ¬´, ¬ª,     . <br><br> ,     ,      Canvas2D,     ,          ,    .     Canvas2D   ,         WebGL,       . <br><br><img src="https://habrastorage.org/webt/z6/uk/kv/z6ukkv00x1pzffhp1ctfd7q7tiw.jpeg"><br> <i> :  ,     ,    .</i> <br><br>   ,   --. ,    ,         ¬´¬ª . <br><br><h2>     ? </h2><br>    : ¬´   ?   ?¬ª  ,     : ¬´,  !¬ª.    ,  .       . <br><br>   ,      WebGL. ,      .          ,     WebGL.     2  ‚Äî ,    . <br><br> , ,    . ,   . <br><br><img src="https://habrastorage.org/webt/yx/0s/kk/yx0skkl_xmwk-ekewducomsgvxs.jpeg">        ,     .   ,   ,  ,     3D   ‚Äî      . <br><br>   ,            .     ,   ,      . <br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FrontendConf</a>   .       ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    Canvas</a> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  RxJS</a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JSX  React</a> . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>    30     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .       ,  ,   . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450832/">https://habr.com/ru/post/fr450832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450822/index.html">Cadres en voie de disparition</a></li>
<li><a href="../fr450824/index.html">L'√©tat du CSS</a></li>
<li><a href="../fr450826/index.html">Comment parler avec le microcontr√¥leur de JS</a></li>
<li><a href="../fr450828/index.html">Quand la ville s'endort ...</a></li>
<li><a href="../fr450830/index.html">Nikita Dubko sur les conf√©rences, le syndrome des imposteurs et les reportages</a></li>
<li><a href="../fr450834/index.html">Analyser les sites - et est-ce g√©n√©ralement l√©gal en Russie?</a></li>
<li><a href="../fr450836/index.html">Sur rails derri√®re les nuages: comment laver le verre dans un gratte-ciel</a></li>
<li><a href="../fr450838/index.html">Pourquoi l'unit√© n'est pas attribu√©e aux nombres premiers et quand elle √©tait g√©n√©ralement consid√©r√©e comme un nombre</a></li>
<li><a href="../fr450840/index.html">La derni√®re lampe de poche est fatigu√©e ou le scintillement sauvera-t-il la Bi√©lorussie (upd. Spinner?)</a></li>
<li><a href="../fr450844/index.html">Introduction √† l'exemple de mappage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>