<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍⚖️ ♂️ 🎅🏽 Pourquoi écrivons-nous la logique métier dans Lua 🤵🏻 👩‍🚀 🏔️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, Habr. Dans cet article, nous voulons parler de comment et pourquoi nous utilisons un langage de programmation avec le beau nom Lua chez IPONWEB...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pourquoi écrivons-nous la logique métier dans Lua</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iponweb/blog/469049/">  Salut, Habr.  Dans cet article, nous voulons parler de comment et pourquoi nous utilisons un langage de programmation avec le beau nom Lua chez IPONWEB. <br><br>  Lua est un langage de programmation intégrable basé sur des scripts avec un interprète gratuit et open source en C. Il a été développé en 1993 au Brésil, dans la division Tecgraf de l'Université catholique de Rio de Janeiro, et ses ancêtres étaient DEL (Data-Entry Language) et SOL (Simple Object Language) développé précédemment.  L'un des ancêtres, la langue SOL, a indirectement participé au «baptême» du nouveau-né - «Sol» est traduit du portugais par «soleil», et la nouvelle langue a été nommée «Lua», «lune». <br><br>  La facilité d'intégration de Lua dans des moteurs écrits dans des langages «système» en a fait un langage de script populaire pour les jeux vidéo.  Par exemple, les scripts sont écrits en Lua dans Grim Fandango et Baldur's Gate.  Ceux qui jouent à World of Warcraft ont probablement entendu parler de Lua plus d'une ou deux fois - c'est là que des add-ons pour le jeu sont écrits qui facilitent la vie des joueurs hardcore, des fans occasionnels, des fans pour mesurer leur efficacité et des autres habitants du monde du jeu.  En dehors de gamedev, Lua est utilisé comme langage de script des systèmes embarqués (téléviseurs, imprimantes, panneaux de voiture), ainsi que des applications, par exemple, le VLC Media Player.  Lua utilise des outils tels que Tarantool, Redis et OpenResty en tant que langage intégré.  Lua a également été utilisé comme langage d'extension pour les codes de calcul Fortran simulant le comportement thermomécanique du combustible nucléaire. <br><br><h3>  Pourquoi Lua? </h3><br><a name="habracut"></a>  IPONWEB est un développeur de plateformes très chargées pour les entreprises travaillant dans le domaine de la publicité en ligne: DSP, SSP, agences de publicité et annonceurs.  Nous avons parlé <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en</a> détail de notre travail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans cet article</a> .  Au début, nous avons développé la logique métier de nos plateformes en C ++, mais nous nous sommes vite rendu compte que ce n'était pas le meilleur choix.  Pour minimiser les coûts, les performances de la plate-forme sont importantes, ainsi que la vitesse de développement, et le développement C ++ s'est avéré trop lent pour nous, et la complexité de l'ajout de fonctionnalités a également été affectée.  Nous avons décidé d'isoler l'interprétation de la logique métier du code serveur de bas niveau, nous avons commencé à chercher un langage approprié pour cela et nous nous sommes installés sur Lua.  C'était en 2008, les implémentations JavaScript qui nous convenaient n'existaient pas encore, Perl, Python et Ruby étaient trop lents et pas faciles à intégrer.  Et il y avait le langage Lua, pas très célèbre, mais populaire dans le développement de jeux, et ce que nous voulions était similaire aux besoins des développeurs de jeux - nous avions besoin d'un moteur rapide pour les opérations de bas niveau et d'un langage rapide facile à construire pour la logique métier. <br><br>  Lua est vraiment une langue très rapide.  Une augmentation supplémentaire de la vitesse peut être <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">obtenue en</a> utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LuaJIT</a> , l'environnement d'exécution de Lua 5.1, qui comprend un compilateur JIT traceur (nous utilisons notre propre fork, dont nous avons déjà <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parlé</a> ).  Puisque nous écrivons la logique métier pour les systèmes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RTB</a> , la vitesse est essentielle pour nous: en RTB, en moyenne, il y a 120 millisecondes pour traiter chaque demande entrante.  Dans le même temps, seules 10 à 15 millisecondes sont allouées pour l'exécution de code et le reste du temps attend une réponse d'autres services.  Si, par exemple, un utilisateur ne remarque même pas un retard d'une demi-seconde lors du chargement d'un site sur le réseau, alors pour RTB ces 500 millisecondes sont une période de temps énorme.  La réponse à la question de la rapidité de Lua est qu'elle est suffisamment rapide pour que nous puissions y écrire de la logique métier pendant de nombreuses années et rester dans le domaine de la RTB.  Si la langue que nous avons choisie n'était pas assez rapide, nous n'aurions personne pour écrire la plate-forme.  Est-ce à dire que RTB ne peut pas être écrit dans d'autres langues?  Ça ne veut pas dire.  Mais nous écrivons RTB en Lua et gérons avec succès nos tâches commerciales et celles de nos clients.  Un bon exemple de la vitesse de Lua sur le serveur est ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">benchmark</a> OpenResty. <br><br>  Lua en tant que langage intégré présente de nombreux avantages: il est minimaliste, compact, avec une très petite bibliothèque standard.  Sa fonctionnalité est complètement dupliquée en C, ce qui fournit une interaction facile et «transparente» entre Lua et C. Lua a un seuil de connexion assez bas par rapport à de nombreuses autres langues: la plupart des programmeurs qui viennent travailler dans IPONWEB n'ont jamais écrit sur Lua auparavant, mais ils en ont assez plusieurs jours pour s'engager pleinement dans le travail. <br><br>  Voici un exemple simple de ciblage d'une audience publicitaire. <br><br><pre><code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">-- deal: ,  ,      --     ( ,    ..) -- imp:   (impression opportunity),  --       local function can_be_shown(deal, imp) local targeting = deal.targeting --    if not targeting then return true end --         -- (,    ,   ): if targeting.media_type then if not passes_targeting(targeting.media_type, imp.details.media_type) then return false end end --        : if targeting.size then if not passes_targeting(targeting.size, imp.details.sizes) then return false end end return true end</span></span></code> </pre> <br>  Et voici à quoi ressemble un simple gestionnaire (gestionnaire d'événements). <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> adm_cache = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">'modules.adm_cache'</span></span> <span class="hljs-comment"><span class="hljs-comment">-- adm = "ad markup" local config = require 'modules.config' local util = require 'modules.util' local AbstractHandler = require 'handlers.abstract' local ImpRenderHandler = AbstractHandler:new({is_server_request = false}) local IMP_RENDER_TEMPLATE = config.get('imp_render_template') local IMP_RENDER_BILLING = {name = 'free', type = 'in'} --   ,  . --   ( ,   ) . --          . function ImpRenderHandler:handle(params) local user_id = self.uuid local cache_id = get_param('id') if not cache_id or cache_id == '' then return self:process_bad_request({reason = '"id" parameter is expected', user_id = user_id}) end local adm = adm_cache.get(cache_id) if not adm then return self:process_bad_request({reason = 'No adm in cache', user_id = user_id}) end update_billing(IMP_RENDER_BILLING) self:log_request('imp_render', {adm = adm, user_id = user_id, cache_id = cache_id}) local content = util.expand_macro(IMP_RENDER_TEMPLATE, {ADM = adm}) return {200, content = content} end return ImpRenderHandler</span></span></code> </pre> <br>  La simplicité de Lua permet non seulement un développement rapide, mais vous permet également de faire beaucoup de travail avec peu d'effort.  La plate-forme IPONWEB est une solution générale adaptée aux besoins d'un client particulier, tandis qu'un développeur et un gestionnaire peuvent mener le projet.  Lire le code sur Lua peut non seulement les développeurs eux-mêmes, mais aussi les chefs de projet, et parfois les clients.  Ensemble, nous découvrons rapidement le problème, trouvons sa cause et sa solution.  Souvent, le chef de projet informe le développeur du problème et suggère immédiatement un moyen de le résoudre. <br><br>  Dans le même temps, la simplicité de Lua peut être trompeuse, tandis que le minimalisme et la compacité ont un inconvénient.  Si le code est écrit, par exemple, en Perl ou Python, le développeur a à sa disposition d'énormes référentiels de modules prêts à l'emploi, Ruby a RubyGems, et de nombreux autres langages ont des référentiels riches.  Et Lua a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LuaRocks</a> et les trois mille modules qui s'y trouvent.  De plus, même si LuaRocks a le bon module, il est fort probable que vous devrez travailler dur pour l'utiliser dans une entreprise particulière.  Lua fournit de bons outils pour créer un environnement sécurisé pour exécuter du code (bacs à sable), et lorsque vous travaillez dans des bacs à sable, certaines fonctions peuvent être désactivées.  Cela signifie que les modules LuaRocks peuvent ne pas fonctionner s'ils utilisent des fonctions bloquées par l'environnement sécurisé de l'entreprise.  C’est le prix de la compacité et de l’intégration, mais cela en vaut le prix - les langages avec batteries, comme par exemple Python, ne sont pas construits de manière plus compliquée que Lua. <br><br><h3>  Comment ça marche? </h3><br>  La base de notre plateforme est un serveur HTTP personnalisable avec une API pratique et extensible qui fournit un ensemble de fonctions pour le développeur Lua et est adapté aux tâches du marché publicitaire.  Ce serveur traite des centaines de millions de demandes et écrit des téraoctets de journaux par jour.  Les demandes entrantes sont réparties uniformément sur les threads système et à l'intérieur des threads système se trouvent des sandbox. <br><br><img src="https://habrastorage.org/webt/ee/bx/sn/eebxsntveokgzzaz2ffyplaconc.png" alt="image"><br><br>  Lorsqu'une demande arrive sur le serveur, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">coroutine</a> est créée à l'intérieur du sandbox dans lequel cette demande est tombée, qui traite la demande.  Les coroutines fonctionnent indépendamment les unes des autres, chaque coroutine créée est mise en file d'attente pour exécution.  La durée de vie de chaque coroutine (le temps total de traitement de la demande, en tenant compte de la réponse attendue des services impliqués: base de données, métriques, serveur de budget) ne doit pas dépasser 120 millisecondes. <br><br><img src="https://habrastorage.org/webt/cz/sk/d3/czskd3si2n2k2mott6inf7f9qtk.png"><br><br>  En bref, le processus de traitement des demandes peut être décrit comme suit: <br><br><ol><li>  Chaque demande reçue est analysée et passe un contrôle standard pour l'exactitude. </li><li>  Lancement de Corutin, qui est responsable du traitement de cette demande.  À l'intérieur de chaque bac à sable, il existe de nombreuses coroutines à différents statuts. </li><li>  Le traitement des demandes démarre, ce qui peut avoir deux résultats: <br><ul><li>  Le traitement s'est terminé avec succès. </li><li>  Corutin transfère le contrôle au serveur.  Cela se produit généralement lorsque coroutine attend une réponse d'autres services.  Dans de tels cas, le travail de la corutine est suspendu jusqu'à ce qu'une réponse arrive ou que le temps d'attente expire.  Lors du transfert de contrôle, le serveur commence à traiter la requête suivante.  Il peut s'agir d'une nouvelle demande ou d'une demande qui reçoit une réponse de tous les services impliqués et est prête à continuer d'exécuter le code.  L'ordre de traitement des demandes est déterminé par les exigences de la logique métier. </li></ul></li></ol><br><img src="https://habrastorage.org/webt/bp/jv/gg/bpjvgg7pkb_394aojxgg2ykskqg.png"><br>  L'utilisation de la corutine est un autre sujet intéressant qui mérite une discussion détaillée.  Par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> détaille comment les corutines peuvent être utilisées pour créer des cinématiques dans les jeux vidéo.  Et les coroutines sur le serveur d'applications devraient consacrer un article séparé, et peut-être à l'avenir nous le ferons. <br><br><h3>  Et ensuite? </h3><br>  Et puis, peut-être, l'utilisation de Lua dans IPONWEB sera étendue.  Nous avons des idées sur la façon dont vous pouvez toujours utiliser Lua dans notre entreprise, et lorsque ces idées seront mises en œuvre, nous partagerons certainement de nouvelles expériences.  La commodité et les capacités de Lua en tant que langage de script intégré peuvent nous aider, en particulier, à accélérer le traitement des données client.  Mais cela reste du domaine des plans et des perspectives. <br><br>  En résumé, nous pouvons dire que notre choix du langage de la logique métier, fait il y a 11 ans, continue de se justifier, nous permettant de faire face avec succès à nos propres tâches métier et de nous aider à résoudre les problèmes de nos clients.  Facile à lire, facile à intégrer, rapide et facile à apprendre, Lua a été et reste l'un des meilleurs langages de script, dont la portée n'est en aucun cas limitée au développement de jeux.  La logique métier IPONWEB écrite dessus n'en est qu'un exemple. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469049/">https://habr.com/ru/post/fr469049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469037/index.html">Contrôleur industriel. Système de collecte de données. ACS</a></li>
<li><a href="../fr469039/index.html">Plus qu'un jeu: maîtriser le Mahjong avec l'IA et l'apprentissage automatique</a></li>
<li><a href="../fr469041/index.html">Comment protéger votre système ERP?</a></li>
<li><a href="../fr469043/index.html">C / C ++ de Python (API C)</a></li>
<li><a href="../fr469045/index.html">Python dans Visual Studio Code - Version de septembre 2019</a></li>
<li><a href="../fr469051/index.html">Le connecteur Azure Cloud Shell dans Windows Terminal</a></li>
<li><a href="../fr469053/index.html">Une nouvelle série de vidéos pour les débutants pour apprendre la programmation Python</a></li>
<li><a href="../fr469055/index.html">Pratique zen en espace ouvert</a></li>
<li><a href="../fr469059/index.html">Nouveautés de ML.NET et Model Builder</a></li>
<li><a href="../fr469061/index.html">Version Rust 1.38.0: compilation en pipeline, # [obsolète] pour les macros et std :: any :: type_name</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>