<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äç‚öñÔ∏è ‚ôÇÔ∏è üéÖüèΩ Pourquoi √©crivons-nous la logique m√©tier dans Lua ü§µüèª üë©‚ÄçüöÄ üèîÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, Habr. Dans cet article, nous voulons parler de comment et pourquoi nous utilisons un langage de programmation avec le beau nom Lua chez IPONWEB...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pourquoi √©crivons-nous la logique m√©tier dans Lua</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iponweb/blog/469049/">  Salut, Habr.  Dans cet article, nous voulons parler de comment et pourquoi nous utilisons un langage de programmation avec le beau nom Lua chez IPONWEB. <br><br>  Lua est un langage de programmation int√©grable bas√© sur des scripts avec un interpr√®te gratuit et open source en C. Il a √©t√© d√©velopp√© en 1993 au Br√©sil, dans la division Tecgraf de l'Universit√© catholique de Rio de Janeiro, et ses anc√™tres √©taient DEL (Data-Entry Language) et SOL (Simple Object Language) d√©velopp√© pr√©c√©demment.  L'un des anc√™tres, la langue SOL, a indirectement particip√© au ¬´bapt√™me¬ª du nouveau-n√© - ¬´Sol¬ª est traduit du portugais par ¬´soleil¬ª, et la nouvelle langue a √©t√© nomm√©e ¬´Lua¬ª, ¬´lune¬ª. <br><br>  La facilit√© d'int√©gration de Lua dans des moteurs √©crits dans des langages ¬´syst√®me¬ª en a fait un langage de script populaire pour les jeux vid√©o.  Par exemple, les scripts sont √©crits en Lua dans Grim Fandango et Baldur's Gate.  Ceux qui jouent √† World of Warcraft ont probablement entendu parler de Lua plus d'une ou deux fois - c'est l√† que des add-ons pour le jeu sont √©crits qui facilitent la vie des joueurs hardcore, des fans occasionnels, des fans pour mesurer leur efficacit√© et des autres habitants du monde du jeu.  En dehors de gamedev, Lua est utilis√© comme langage de script des syst√®mes embarqu√©s (t√©l√©viseurs, imprimantes, panneaux de voiture), ainsi que des applications, par exemple, le VLC Media Player.  Lua utilise des outils tels que Tarantool, Redis et OpenResty en tant que langage int√©gr√©.  Lua a √©galement √©t√© utilis√© comme langage d'extension pour les codes de calcul Fortran simulant le comportement thermom√©canique du combustible nucl√©aire. <br><br><h3>  Pourquoi Lua? </h3><br><a name="habracut"></a>  IPONWEB est un d√©veloppeur de plateformes tr√®s charg√©es pour les entreprises travaillant dans le domaine de la publicit√© en ligne: DSP, SSP, agences de publicit√© et annonceurs.  Nous avons parl√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en</a> d√©tail de notre travail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans cet article</a> .  Au d√©but, nous avons d√©velopp√© la logique m√©tier de nos plateformes en C ++, mais nous nous sommes vite rendu compte que ce n'√©tait pas le meilleur choix.  Pour minimiser les co√ªts, les performances de la plate-forme sont importantes, ainsi que la vitesse de d√©veloppement, et le d√©veloppement C ++ s'est av√©r√© trop lent pour nous, et la complexit√© de l'ajout de fonctionnalit√©s a √©galement √©t√© affect√©e.  Nous avons d√©cid√© d'isoler l'interpr√©tation de la logique m√©tier du code serveur de bas niveau, nous avons commenc√© √† chercher un langage appropri√© pour cela et nous nous sommes install√©s sur Lua.  C'√©tait en 2008, les impl√©mentations JavaScript qui nous convenaient n'existaient pas encore, Perl, Python et Ruby √©taient trop lents et pas faciles √† int√©grer.  Et il y avait le langage Lua, pas tr√®s c√©l√®bre, mais populaire dans le d√©veloppement de jeux, et ce que nous voulions √©tait similaire aux besoins des d√©veloppeurs de jeux - nous avions besoin d'un moteur rapide pour les op√©rations de bas niveau et d'un langage rapide facile √† construire pour la logique m√©tier. <br><br>  Lua est vraiment une langue tr√®s rapide.  Une augmentation suppl√©mentaire de la vitesse peut √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">obtenue en</a> utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LuaJIT</a> , l'environnement d'ex√©cution de Lua 5.1, qui comprend un compilateur JIT traceur (nous utilisons notre propre fork, dont nous avons d√©j√† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parl√©</a> ).  Puisque nous √©crivons la logique m√©tier pour les syst√®mes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RTB</a> , la vitesse est essentielle pour nous: en RTB, en moyenne, il y a 120 millisecondes pour traiter chaque demande entrante.  Dans le m√™me temps, seules 10 √† 15 millisecondes sont allou√©es pour l'ex√©cution de code et le reste du temps attend une r√©ponse d'autres services.  Si, par exemple, un utilisateur ne remarque m√™me pas un retard d'une demi-seconde lors du chargement d'un site sur le r√©seau, alors pour RTB ces 500 millisecondes sont une p√©riode de temps √©norme.  La r√©ponse √† la question de la rapidit√© de Lua est qu'elle est suffisamment rapide pour que nous puissions y √©crire de la logique m√©tier pendant de nombreuses ann√©es et rester dans le domaine de la RTB.  Si la langue que nous avons choisie n'√©tait pas assez rapide, nous n'aurions personne pour √©crire la plate-forme.  Est-ce √† dire que RTB ne peut pas √™tre √©crit dans d'autres langues?  √áa ne veut pas dire.  Mais nous √©crivons RTB en Lua et g√©rons avec succ√®s nos t√¢ches commerciales et celles de nos clients.  Un bon exemple de la vitesse de Lua sur le serveur est ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">benchmark</a> OpenResty. <br><br>  Lua en tant que langage int√©gr√© pr√©sente de nombreux avantages: il est minimaliste, compact, avec une tr√®s petite biblioth√®que standard.  Sa fonctionnalit√© est compl√®tement dupliqu√©e en C, ce qui fournit une interaction facile et ¬´transparente¬ª entre Lua et C. Lua a un seuil de connexion assez bas par rapport √† de nombreuses autres langues: la plupart des programmeurs qui viennent travailler dans IPONWEB n'ont jamais √©crit sur Lua auparavant, mais ils en ont assez plusieurs jours pour s'engager pleinement dans le travail. <br><br>  Voici un exemple simple de ciblage d'une audience publicitaire. <br><br><pre><code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">-- deal: ,  ,      --     ( ,    ..) -- imp:   (impression opportunity),  --       local function can_be_shown(deal, imp) local targeting = deal.targeting --    if not targeting then return true end --         -- (,    ,   ): if targeting.media_type then if not passes_targeting(targeting.media_type, imp.details.media_type) then return false end end --        : if targeting.size then if not passes_targeting(targeting.size, imp.details.sizes) then return false end end return true end</span></span></code> </pre> <br>  Et voici √† quoi ressemble un simple gestionnaire (gestionnaire d'√©v√©nements). <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> adm_cache = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">'modules.adm_cache'</span></span> <span class="hljs-comment"><span class="hljs-comment">-- adm = "ad markup" local config = require 'modules.config' local util = require 'modules.util' local AbstractHandler = require 'handlers.abstract' local ImpRenderHandler = AbstractHandler:new({is_server_request = false}) local IMP_RENDER_TEMPLATE = config.get('imp_render_template') local IMP_RENDER_BILLING = {name = 'free', type = 'in'} --   ,  . --   ( ,   ) . --          . function ImpRenderHandler:handle(params) local user_id = self.uuid local cache_id = get_param('id') if not cache_id or cache_id == '' then return self:process_bad_request({reason = '"id" parameter is expected', user_id = user_id}) end local adm = adm_cache.get(cache_id) if not adm then return self:process_bad_request({reason = 'No adm in cache', user_id = user_id}) end update_billing(IMP_RENDER_BILLING) self:log_request('imp_render', {adm = adm, user_id = user_id, cache_id = cache_id}) local content = util.expand_macro(IMP_RENDER_TEMPLATE, {ADM = adm}) return {200, content = content} end return ImpRenderHandler</span></span></code> </pre> <br>  La simplicit√© de Lua permet non seulement un d√©veloppement rapide, mais vous permet √©galement de faire beaucoup de travail avec peu d'effort.  La plate-forme IPONWEB est une solution g√©n√©rale adapt√©e aux besoins d'un client particulier, tandis qu'un d√©veloppeur et un gestionnaire peuvent mener le projet.  Lire le code sur Lua peut non seulement les d√©veloppeurs eux-m√™mes, mais aussi les chefs de projet, et parfois les clients.  Ensemble, nous d√©couvrons rapidement le probl√®me, trouvons sa cause et sa solution.  Souvent, le chef de projet informe le d√©veloppeur du probl√®me et sugg√®re imm√©diatement un moyen de le r√©soudre. <br><br>  Dans le m√™me temps, la simplicit√© de Lua peut √™tre trompeuse, tandis que le minimalisme et la compacit√© ont un inconv√©nient.  Si le code est √©crit, par exemple, en Perl ou Python, le d√©veloppeur a √† sa disposition d'√©normes r√©f√©rentiels de modules pr√™ts √† l'emploi, Ruby a RubyGems, et de nombreux autres langages ont des r√©f√©rentiels riches.  Et Lua a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LuaRocks</a> et les trois mille modules qui s'y trouvent.  De plus, m√™me si LuaRocks a le bon module, il est fort probable que vous devrez travailler dur pour l'utiliser dans une entreprise particuli√®re.  Lua fournit de bons outils pour cr√©er un environnement s√©curis√© pour ex√©cuter du code (bacs √† sable), et lorsque vous travaillez dans des bacs √† sable, certaines fonctions peuvent √™tre d√©sactiv√©es.  Cela signifie que les modules LuaRocks peuvent ne pas fonctionner s'ils utilisent des fonctions bloqu√©es par l'environnement s√©curis√© de l'entreprise.  C‚Äôest le prix de la compacit√© et de l‚Äôint√©gration, mais cela en vaut le prix - les langages avec batteries, comme par exemple Python, ne sont pas construits de mani√®re plus compliqu√©e que Lua. <br><br><h3>  Comment √ßa marche? </h3><br>  La base de notre plateforme est un serveur HTTP personnalisable avec une API pratique et extensible qui fournit un ensemble de fonctions pour le d√©veloppeur Lua et est adapt√© aux t√¢ches du march√© publicitaire.  Ce serveur traite des centaines de millions de demandes et √©crit des t√©raoctets de journaux par jour.  Les demandes entrantes sont r√©parties uniform√©ment sur les threads syst√®me et √† l'int√©rieur des threads syst√®me se trouvent des sandbox. <br><br><img src="https://habrastorage.org/webt/ee/bx/sn/eebxsntveokgzzaz2ffyplaconc.png" alt="image"><br><br>  Lorsqu'une demande arrive sur le serveur, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">coroutine</a> est cr√©√©e √† l'int√©rieur du sandbox dans lequel cette demande est tomb√©e, qui traite la demande.  Les coroutines fonctionnent ind√©pendamment les unes des autres, chaque coroutine cr√©√©e est mise en file d'attente pour ex√©cution.  La dur√©e de vie de chaque coroutine (le temps total de traitement de la demande, en tenant compte de la r√©ponse attendue des services impliqu√©s: base de donn√©es, m√©triques, serveur de budget) ne doit pas d√©passer 120 millisecondes. <br><br><img src="https://habrastorage.org/webt/cz/sk/d3/czskd3si2n2k2mott6inf7f9qtk.png"><br><br>  En bref, le processus de traitement des demandes peut √™tre d√©crit comme suit: <br><br><ol><li>  Chaque demande re√ßue est analys√©e et passe un contr√¥le standard pour l'exactitude. </li><li>  Lancement de Corutin, qui est responsable du traitement de cette demande.  √Ä l'int√©rieur de chaque bac √† sable, il existe de nombreuses coroutines √† diff√©rents statuts. </li><li>  Le traitement des demandes d√©marre, ce qui peut avoir deux r√©sultats: <br><ul><li>  Le traitement s'est termin√© avec succ√®s. </li><li>  Corutin transf√®re le contr√¥le au serveur.  Cela se produit g√©n√©ralement lorsque coroutine attend une r√©ponse d'autres services.  Dans de tels cas, le travail de la corutine est suspendu jusqu'√† ce qu'une r√©ponse arrive ou que le temps d'attente expire.  Lors du transfert de contr√¥le, le serveur commence √† traiter la requ√™te suivante.  Il peut s'agir d'une nouvelle demande ou d'une demande qui re√ßoit une r√©ponse de tous les services impliqu√©s et est pr√™te √† continuer d'ex√©cuter le code.  L'ordre de traitement des demandes est d√©termin√© par les exigences de la logique m√©tier. </li></ul></li></ol><br><img src="https://habrastorage.org/webt/bp/jv/gg/bpjvgg7pkb_394aojxgg2ykskqg.png"><br>  L'utilisation de la corutine est un autre sujet int√©ressant qui m√©rite une discussion d√©taill√©e.  Par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> d√©taille comment les corutines peuvent √™tre utilis√©es pour cr√©er des cin√©matiques dans les jeux vid√©o.  Et les coroutines sur le serveur d'applications devraient consacrer un article s√©par√©, et peut-√™tre √† l'avenir nous le ferons. <br><br><h3>  Et ensuite? </h3><br>  Et puis, peut-√™tre, l'utilisation de Lua dans IPONWEB sera √©tendue.  Nous avons des id√©es sur la fa√ßon dont vous pouvez toujours utiliser Lua dans notre entreprise, et lorsque ces id√©es seront mises en ≈ìuvre, nous partagerons certainement de nouvelles exp√©riences.  La commodit√© et les capacit√©s de Lua en tant que langage de script int√©gr√© peuvent nous aider, en particulier, √† acc√©l√©rer le traitement des donn√©es client.  Mais cela reste du domaine des plans et des perspectives. <br><br>  En r√©sum√©, nous pouvons dire que notre choix du langage de la logique m√©tier, fait il y a 11 ans, continue de se justifier, nous permettant de faire face avec succ√®s √† nos propres t√¢ches m√©tier et de nous aider √† r√©soudre les probl√®mes de nos clients.  Facile √† lire, facile √† int√©grer, rapide et facile √† apprendre, Lua a √©t√© et reste l'un des meilleurs langages de script, dont la port√©e n'est en aucun cas limit√©e au d√©veloppement de jeux.  La logique m√©tier IPONWEB √©crite dessus n'en est qu'un exemple. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469049/">https://habr.com/ru/post/fr469049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469037/index.html">Contr√¥leur industriel. Syst√®me de collecte de donn√©es. ACS</a></li>
<li><a href="../fr469039/index.html">Plus qu'un jeu: ma√Ætriser le Mahjong avec l'IA et l'apprentissage automatique</a></li>
<li><a href="../fr469041/index.html">Comment prot√©ger votre syst√®me ERP?</a></li>
<li><a href="../fr469043/index.html">C / C ++ de Python (API C)</a></li>
<li><a href="../fr469045/index.html">Python dans Visual Studio Code - Version de septembre 2019</a></li>
<li><a href="../fr469051/index.html">Le connecteur Azure Cloud Shell dans Windows Terminal</a></li>
<li><a href="../fr469053/index.html">Une nouvelle s√©rie de vid√©os pour les d√©butants pour apprendre la programmation Python</a></li>
<li><a href="../fr469055/index.html">Pratique zen en espace ouvert</a></li>
<li><a href="../fr469059/index.html">Nouveaut√©s de ML.NET et Model Builder</a></li>
<li><a href="../fr469061/index.html">Version Rust 1.38.0: compilation en pipeline, # [obsol√®te] pour les macros et std :: any :: type_name</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>