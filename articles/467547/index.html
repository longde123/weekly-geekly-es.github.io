<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìó üèôÔ∏è üëµüèª Omitir bloqueos ILV con DNSTap y BGP ‚ô¶Ô∏è üì∫ üî§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El tema est√° bastante fuera de escena, lo s√©. Por ejemplo, hay un excelente art√≠culo , pero solo se considera all√≠ la parte IP de la lista de bloqueo....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Omitir bloqueos ILV con DNSTap y BGP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467547/"><p><img src="https://habrastorage.org/webt/zg/if/qq/zgifqqqqol7bai9dlh3_e-3cgn8.png"></p><br><p>  El tema est√° bastante fuera de escena, lo s√©.  Por ejemplo, hay un excelente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> , pero solo se considera all√≠ la parte IP de la lista de bloqueo.  Tambi√©n agregaremos dominios. </p><br><p>  Debido al hecho de que los tribunales y el ILV bloquean todo a derecha e izquierda, y los proveedores est√°n tratando de no caer bajo las multas emitidas por "Revizorro", las p√©rdidas asociadas de las cerraduras son bastante grandes.  S√≠, y entre los sitios bloqueados "legalmente" hay muchos √∫tiles (hola, rutracker) </p><br><p>  Vivo fuera de la jurisdicci√≥n del ILV, pero mis padres, parientes y amigos se quedaron en casa.  Por lo tanto, se decidi√≥ idear una forma de evitar bloqueos que sea f√°cil para aquellos que est√°n lejos de TI, preferiblemente sin su participaci√≥n. </p><br><p>  En este art√≠culo, no describir√© las cosas b√°sicas de la red en pasos, pero describir√© los principios generales de c√≥mo se puede implementar este esquema.  Por lo tanto, es imprescindible conocer c√≥mo funciona la red en general y en Linux en particular. </p><a name="habracut"></a><br><h1 id="tipy-blokirovok">  Tipos de cerraduras </h1><br><p>  Primero, vamos a actualizar lo que est√° bloqueado. </p><br><p>  Hay varios tipos de bloqueos en XML paginado de ILV: </p><br><ul><li>  IP </li><li>  Dominio </li><li>  URL </li></ul><br><p>  Para simplificar, los reduciremos a dos: IP y dominio, y simplemente retiraremos el dominio del bloqueo de URL (m√°s precisamente, ya lo hemos hecho por nosotros). </p><br><p>  Las buenas personas de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Roskomsvoboda han</a> implementado una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API</a> maravillosa a trav√©s de la cual podemos obtener lo que necesitamos: </p><br><ul><li>  IP: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://api.reserve-rbl.ru/api/v2/ips/json</a> </li><li>  Dominios: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://api.reserve-rbl.ru/api/v2/domains/json</a> </li></ul><br><h1 id="dostup-k-zablokirovannym-saytam">  Acceder a sitios bloqueados </h1><br><p>  Para hacer esto, necesitamos algunos VPS extranjeros peque√±os, preferiblemente con tr√°fico ilimitado, hay muchos de esos 3-5 d√≥lares.  Debe llevarlo al extranjero para que el ping no sea muy grande, pero tenga en cuenta que Internet y la geograf√≠a no siempre coinciden.  Y dado que no hay SLA por 5 d√≥lares, es mejor tomar m√°s de 2 piezas de diferentes proveedores para la tolerancia a fallas. </p><br><p>  A continuaci√≥n, necesitamos configurar el t√∫nel encriptado desde el enrutador del cliente al VPS.  Utilizo Wireguard como el m√°s r√°pido y f√°cil de configurar desde  Tambi√©n tengo enrutadores cliente basados ‚Äã‚Äãen Linux ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">APU2</a> o algo en OpenWRT).  En el caso de algunos Mikrotik / Cisco, puede usar protocolos disponibles en ellos como OpenVPN y GRE-over-IPSEC. </p><br><h1 id="identifikaciya-i-perenapravlenie-interesuyuschego-traffika">  Identificaci√≥n y redireccionamiento del tr√°fico de inter√©s. </h1><br><p>  Por supuesto, puede concluir completamente todo el tr√°fico de Internet a trav√©s del extranjero.  Pero, muy probablemente, la velocidad de trabajar con contenido local se ver√° muy afectada por esto.  Adem√°s, los requisitos de ancho de banda en el VPS ser√°n mucho m√°s altos. </p><br><p>  Por lo tanto, necesitaremos de alguna manera asignar tr√°fico a sitios bloqueados y enviarlo selectivamente al t√∫nel.  Incluso si llega una parte del tr√°fico "extra", sigue siendo mucho mejor que conducir todo a trav√©s de un t√∫nel. </p><br><p>  Para administrar el tr√°fico, utilizaremos el protocolo BGP y anunciaremos rutas a las redes necesarias desde nuestro VPS a los clientes.  Como demonio BGP, tomemos BIRD, como uno de los m√°s funcionales y convenientes. </p><br><h3 id="ip">  IP </h3><br><p>  Con el bloqueo de IP, todo est√° claro: solo anunciamos todas las IP bloqueadas con VPS.  El problema es que hay alrededor de 600 mil subredes en la lista que ofrece la API, y la gran mayor√≠a de ellas son hosts / 32.  Tal cantidad de rutas puede ser confusa para los enrutadores de clientes d√©biles. </p><br><p>  Por lo tanto, se decidi√≥ resumir a la red / 24 al procesar la lista si hay 2 o m√°s hosts en ella.  Por lo tanto, el n√∫mero de rutas se redujo a ~ 100 mil.  El gui√≥n para esto ser√° el siguiente. </p><br><h3 id="domeny">  Dominios </h3><br><p>  Es m√°s complicado y hay varias formas.  Por ejemplo, puede colocar Squid transparente en cada enrutador de cliente y hacer intercepciones HTTP y espiar en el protocolo de enlace TLS para obtener la URL solicitada en el primer caso y el dominio de SNI en el segundo. </p><br><p>  Pero debido a todos los nuevos TLS1.3 + eSNI, el an√°lisis HTTPS se est√° volviendo cada vez menos real cada d√≠a.  Y la infraestructura en el lado del cliente se est√° volviendo m√°s complicada: tendr√° que usar al menos OpenWRT. </p><br><p>  Por lo tanto, decid√≠ tomar el camino de interceptar respuestas a consultas DNS.  Aqu√≠, tambi√©n, cualquier DNS sobre TLS / HTTPS comienza a elevarse por encima de nuestras cabezas, pero podemos (por ahora) controlar esta parte en el cliente, ya sea deshabilitarlo o usar nuestro propio servidor para DoT / DoH. </p><br><h4 id="kak-perehvatyvat-dns">  ¬øC√≥mo interceptar DNS? </h4><br><p>  Tambi√©n puede haber varios enfoques. </p><br><ul><li>  Intercepci√≥n de tr√°fico DNS a trav√©s de PCAP o NFLOG <br>  Ambos m√©todos de intercepci√≥n se implementan en la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sidmat</a> .  Pero no se ha admitido durante mucho tiempo y la funcionalidad es muy primitiva, por lo que debe escribir un enlace de todos modos. </li><li>  An√°lisis de registro del servidor DNS <br>  Desafortunadamente, los recurrentes que conozco no saben c√≥mo registrar respuestas, sino solo solicitudes.  En principio, esto es l√≥gico, porque a diferencia de las solicitudes, las respuestas tienen una estructura compleja y es dif√≠cil escribirlas en forma de texto. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DNSTap</a> <br>  Afortunadamente, muchos de ellos ya admiten DNSTap para estos fines. </li></ul><br><h4 id="chto-takoe-dnstap">  ¬øQu√© es DNSTap? </h4><br><p><img src="https://habrastorage.org/webt/gc/4g/qs/gc4gqsppif5ypkbf06ok0oihll4.png"></p><br><p>  Este es un protocolo cliente-servidor basado en Protocol Buffers y Frame Streams para transferir desde un servidor DNS a un recopilador de consultas y respuestas DNS estructuradas.  De hecho, el servidor DNS transmite metadatos de solicitudes y respuestas (tipo de mensaje, IP cliente / servidor, etc.) m√°s mensajes DNS completos en la forma (binaria) en la que trabaja con ellos a trav√©s de la red. </p><br><p>  Es importante comprender que en el paradigma DNSTap, el servidor DNS act√∫a como un cliente y el recopilador como un servidor.  Es decir, el servidor DNS se conecta al recopilador, y no al rev√©s. </p><br><p>  Hoy DNSTap es compatible con todos los servidores DNS populares.  Pero, por ejemplo, BIND en muchas distribuciones (como Ubuntu LTS) a menudo se construye por alguna raz√≥n sin su soporte.  Por lo tanto, no nos molestaremos en reconstruir, sino que tomaremos un recursor m√°s ligero y r√°pido: Sin consolidar. </p><br><h4 id="chem-lovit-dnstap">  ¬øC√≥mo atrapar DNSTap? </h4><br><p>  Existen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">varias</a> utilidades <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de</a> CLI para trabajar con una secuencia de eventos DNSTap, pero no funcionan bien para nuestra tarea.  As√≠ que decid√≠ inventar mi propia bicicleta que haga lo que sea necesario: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><strong>dnstap-bgp</strong></a> </p><br><p>  Algoritmo de Operaci√≥n: </p><br><ul><li>  Cuando se inicia, carga una lista de dominios de un archivo de texto, los invierte (habr.com -&gt; com.habr), excluye l√≠neas discontinuas, duplicados y subdominios (es decir, si habr.com y www.habr.com est√°n en la lista, se cargar√° solo el primero) y crea un √°rbol de prefijos para una b√∫squeda r√°pida en esta lista </li><li>  Actuando como un servidor DNSTap, espera una conexi√≥n desde el servidor DNS.  En principio, es compatible con sockets UNIX y TCP, pero los servidores DNS que conozco solo pueden usar sockets UNIX </li><li>  Los paquetes DNSTap entrantes se deserializan primero en la estructura Protobuf, y luego el mensaje DNS binario en s√≠, ubicado en uno de los campos Protobuf, se analiza al nivel de los registros RR de DNS </li><li>  Comprueba si el host solicitado (o su dominio principal) est√° en la lista cargada; de lo contrario, la respuesta se ignora </li><li>  Solo se selecciona A / AAAA / CNAME RR de la respuesta y se extraen las direcciones IPv4 / IPv6 correspondientes. </li><li>  Las direcciones IP se almacenan en cach√© con TTL personalizados y se anuncian a todos los pares BGP configurados </li><li>  Al recibir una respuesta que indica una IP ya almacenada en cach√©, su TTL se actualiza </li><li>  Despu√©s de la expiraci√≥n de TTL, el registro se elimina del cach√© y de los anuncios BGP </li></ul><br><p>  Funcionalidad adicional: </p><br><ul><li>  Releyendo la lista de dominios por SIGHUP </li><li>  Sincronizaci√≥n de cach√© con otras instancias <strong>dnstap-bgp a</strong> trav√©s de HTTP / JSON </li><li>  Duplicaci√≥n de la cach√© en el disco (en la base de datos BoltDB) para restaurar su contenido despu√©s de un reinicio </li><li>  Soporte para cambiar a un espacio de nombres de red diferente (por qu√© esto se describir√° a continuaci√≥n) </li><li>  Soporte IPv6 </li></ul><br><p>  Limitaciones: </p><br><ul><li>  Dominios IDN a√∫n no admitidos </li><li>  Pocas configuraciones de BGP </li></ul><br><p>  He compilado paquetes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RPM y DEB</a> para una f√°cil instalaci√≥n.  Deber√≠a funcionar en todos los sistemas operativos relativamente recientes con systemd, como  No tienen dependencias. </p><br><h1 id="shema">  Esquema </h1><br><p>  Entonces, comencemos a ensamblar todos los componentes juntos.  Como resultado, deber√≠amos obtener algo como esta topolog√≠a de red: <br><img src="https://habrastorage.org/webt/cm/ks/uo/cmksuol_njfgyjznmlf3oj6u94m.png"></p><br><p>  La l√≥gica del trabajo, creo, est√° clara en el diagrama: </p><br><ul><li>  El cliente tiene nuestro servidor configurado como DNS, y las consultas DNS tambi√©n deben pasar por la VPN.  Esto es necesario para que el proveedor no pueda usar la intercepci√≥n de DNS para bloquear. </li><li>  Cuando se abre el sitio, el cliente env√≠a una consulta DNS del formulario "¬øqu√© IP tiene xxx.org?" </li><li>  <strong>Unbound</strong> resuelve xxx.org (o lo toma de la cach√©) y env√≠a una respuesta al cliente "xxx.org tiene tal y tal IP", duplic√°ndolo en paralelo a trav√©s de DNSTap </li><li>  <strong>dnstap-bgp</strong> anuncia estas direcciones en <strong>BIRD</strong> por BGP si el dominio est√° en la lista de bloqueados </li><li> <strong>BIRD</strong> anuncia la ruta a estas IP con el enrutador <code>next-hop self</code> client del <code>next-hop self</code> </li><li>  Los paquetes posteriores del cliente a estas IP pasan por el t√∫nel </li></ul><br><p>  En el servidor, para rutas a sitios bloqueados, tengo una tabla separada dentro de BIRD y no se cruza con el sistema operativo. </p><br><p>  Hay un inconveniente en este esquema: el primer paquete SYN del cliente probablemente tendr√° tiempo de salir a trav√©s del proveedor nacional desde  La ruta no se anuncia al instante.  Y aqu√≠ las opciones son posibles dependiendo de c√≥mo el proveedor hace el bloqueo.  Si solo deja caer el tr√°fico, entonces no hay problemas.  Y si lo redirige a algunos DPI, entonces (te√≥ricamente) son posibles los efectos especiales. </p><br><p>  Los milagros tambi√©n son posibles con clientes que no observan DNS TTL, lo que puede hacer que el cliente use algunas entradas desactualizadas de su cach√© podrido en lugar de preguntar Unbound. </p><br><p>  En la pr√°ctica, ni el primero ni el segundo me causaron problemas, pero su kilometraje puede variar. </p><br><h2 id="nastroyka-servera">  Configuraci√≥n del servidor </h2><br><p>  Para facilitar el rodaje, escrib√≠ un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">papel para Ansible</a> .  Puede configurar tanto servidores como clientes basados ‚Äã‚Äãen Linux (dise√±ados para distribuciones basadas en deb).  Todas las configuraciones son bastante obvias y est√°n configuradas en <em>Inventory.yml</em> .  Este rol se ha eliminado de mi gran libro de jugadas, por lo que puede contener errores. </p><br><p>  Veamos los componentes principales. </p><br><h3 id="bgp">  BGP </h3><br><p>  Al iniciar dos demonios BGP en el mismo host, surge un problema fundamental: BIRD no quiere aumentar el emparejamiento BGP con un host local (o con cualquier interfaz local).  De la palabra en absoluto.  Buscar en Google y leer listas de correo no ayud√≥, afirman que es por dise√±o.  Quiz√°s haya alguna forma, pero no la encontr√©. </p><br><p>  Puedes probar otro demonio BGP, pero me gusta BIRD y se usa conmigo en todas partes, no quiero producir entidades. </p><br><p>  Por lo tanto, escond√≠ dnstap-bgp dentro del espacio de nombres de la red, que est√° conectado a la ra√≠z a trav√©s de la interfaz veth: es como una tuber√≠a cuyos extremos sobresalen en un espacio de nombres diferente.  En cada uno de estos extremos colgamos las direcciones IP privadas p2p que no salen del host, por lo que pueden ser cualquiera.  Este es el mismo mecanismo que se utiliza para acceder a los procesos dentro del <em>amado</em> Docker y otros contenedores. </p><br><p>  Para esto, se escribi√≥ un <a href="">script</a> y en dnstap-bgp se agreg√≥ la funcionalidad descrita anteriormente para arrastrarse por el cabello a otro espacio de nombres.  Debido a esto, debe ejecutarse como root o devolverse al binario CAP_SYS_ADMIN a trav√©s del comando setcap. </p><br><div class="spoiler">  <b class="spoiler_title">Script de ejemplo para crear espacio de nombres</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash NS="dtap" IP="/sbin/ip" IPNS="$IP netns exec $NS $IP" IF_R="veth-$NS-r" IF_NS="veth-$NS-ns" IP_R="192.168.149.1" IP_NS="192.168.149.2" /bin/systemctl stop dnstap-bgp || true $IP netns del $NS &gt; /dev/null 2&gt;&amp;1 $IP netns add $NS $IP link add $IF_R type veth peer name $IF_NS $IP link set $IF_NS netns $NS $IP addr add $IP_R remote $IP_NS dev $IF_R $IP link set $IF_R up $IPNS addr add $IP_NS remote $IP_R dev $IF_NS $IPNS link set $IF_NS up /bin/systemctl start dnstap-bgp</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">dnstap-bgp.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">namespace = "dtap" domains = "/var/cache/rkn_domains.txt" ttl = "168h" [dnstap] listen = "/tmp/dnstap.sock" perm = "0666" [bgp] as = 65000 routerid = "192.168.149.2" peers = [ "192.168.149.1", ]</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bird.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">router id 192.168.1.1; table rkn; # Clients protocol bgp bgp_client1 { table rkn; local as 65000; neighbor 192.168.1.2 as 65000; direct; bfd on; next hop self; graceful restart; graceful restart time 60; export all; import none; } # DNSTap-BGP protocol bgp bgp_dnstap { table rkn; local as 65000; neighbor 192.168.149.2 as 65000; direct; passive on; rr client; import all; export none; } # Static routes list protocol static static_rkn { table rkn; include "rkn_routes.list"; import all; export none; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">rkn_routes.list</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">route 3.226.79.85/32 via "ens3"; route 18.236.189.0/24 via "ens3"; route 3.224.21.0/24 via "ens3"; ...</code> </pre> </div></div><br><h3 id="dns">  DNS </h3><br><p>  De forma predeterminada, en Ubuntu, el binario Unbound est√° sujeto por el perfil de AppArmor, lo que evita que se conecte a los sockets DNSTap all√≠.  Puede eliminar este perfil o deshabilitarlo: </p><br><pre> <code class="plaintext hljs"># cd /etc/apparmor.d/disable &amp;&amp; ln -s ../usr.sbin.unbound . # apparmor_parser -R /etc/apparmor.d/usr.sbin.unbound</code> </pre> <br><p>  Esto probablemente deber√≠a agregarse al libro de jugadas.  Es ideal, por supuesto, corregir el perfil y emitir los derechos necesarios, pero era demasiado vago. </p><br><div class="spoiler">  <b class="spoiler_title">unbound.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">server: chroot: "" port: 53 interface: 0.0.0.0 root-hints: "/var/lib/unbound/named.root" auto-trust-anchor-file: "/var/lib/unbound/root.key" access-control: 192.168.0.0/16 allow remote-control: control-enable: yes control-use-cert: no dnstap: dnstap-enable: yes dnstap-socket-path: "/tmp/dnstap.sock" dnstap-send-identity: no dnstap-send-version: no dnstap-log-client-response-messages: yes</code> </pre> </div></div><br><h3 id="skachivanie-i-obrabotka-spiskov">  Descarga y procesamiento de listas </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Script para descargar y procesar una lista de direcciones IP</a> <br>  Descarga la lista, resume antes del prefijo <em>pfx</em> .  En <em>dont_add</em> y <em>dont_summarize,</em> puede indicarle a IP y redes que omitan o no resuman.  Lo necesitaba porque  mi subred VPS estaba en la lista de bloqueo :) </p><br><p>  Lo curioso es que la API RosKomSvoboda bloquea las solicitudes con el agente de usuario predeterminado de Python.  Parece un gui√≥n que Kiddy lo entendi√≥.  Por lo tanto, lo cambiamos a Firelis. </p><br><p>  Hasta ahora, solo funciona con IPv4 porque  IPv6 es peque√±o, pero ser√° f√°cil de solucionar.  A menos que sea necesario usar tambi√©n bird6. </p><br><div class="spoiler">  <b class="spoiler_title">rkn.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 import json, urllib.request, ipaddress as ipa url = 'https://api.reserve-rbl.ru/api/v2/ips/json' pfx = '24' dont_summarize = { # ipa.IPv4Network('1.1.1.0/24'), } dont_add = { # ipa.IPv4Address('1.1.1.1'), } req = urllib.request.Request( url, data=None, headers={ 'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.47 Safari/537.36' } ) f = urllib.request.urlopen(req) ips = json.loads(f.read().decode('utf-8')) prefix32 = ipa.IPv4Address('255.255.255.255') r = {} for i in ips: ip = ipa.ip_network(i) if not isinstance(ip, ipa.IPv4Network): continue addr = ip.network_address if addr in dont_add: continue m = ip.netmask if m != prefix32: r[m] = [addr, 1] continue sn = ipa.IPv4Network(str(addr) + '/' + pfx, strict=False) if sn in dont_summarize: tgt = addr else: tgt = sn if not sn in r: r[tgt] = [addr, 1] else: r[tgt][1] += 1 o = [] for n, v in r.items(): if v[1] == 1: o.append(str(v[0]) + '/32') else: o.append(n) for k in o: print(k)</span></span></code> </pre> </div></div><br><p>  <a href="">Script para actualizar</a> <br>  Comienza en mi corona una vez al d√≠a, tal vez vale la pena tirar de ella cada 4 horas, porque  En mi opini√≥n, este es el per√≠odo de actualizaci√≥n que ILV requiere de los proveedores.  Adem√°s, hay otras cerraduras urgentes adicionales que pueden volar m√°s r√°pido. </p><br><p>  Hace lo siguiente: </p><br><ul><li>  Ejecuta el primer script y actualiza la lista de rutas ( <code>rkn_routes.list</code> ) para BIRD </li><li>  Recargar P√ÅJARO </li><li>  Actualiza y limpia la lista de dominios para dnstap-bgp </li><li>  Reubicar dnstap-bgp </li></ul><br><div class="spoiler">  <b class="spoiler_title">rkn_update.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ROUTES="/etc/bird/rkn_routes.list" DOMAINS="/var/cache/rkn_domains.txt" # Get &amp; summarize routes /opt/rkn.py | sed 's/\(.*\)/route \1 via "ens3";/' &gt; $ROUTES.new if [ $? -ne 0 ]; then rm -f $ROUTES.new echo "Unable to download RKN routes" exit 1 fi if [ -e $ROUTES ]; then mv $ROUTES $ROUTES.old fi mv $ROUTES.new $ROUTES /bin/systemctl try-reload-or-restart bird # Get domains curl -s https://api.reserve-rbl.ru/api/v2/domains/json -o - | jq -r '.[]' | sed 's/^\*\.//' | sort | uniq &gt; $DOMAINS.new if [ $? -ne 0 ]; then rm -f $DOMAINS.new echo "Unable to download RKN domains" exit 1 fi if [ -e $DOMAINS ]; then mv $DOMAINS $DOMAINS.old fi mv $DOMAINS.new $DOMAINS /bin/systemctl try-reload-or-restart dnstap-bgp</span></span></code> </pre> </div></div><br><p>  Fueron escritos sin pensarlo mucho, as√≠ que si ves lo que se puede mejorar, an√≠mate. </p><br><h2 id="nastroyka-klienta">  Configuraci√≥n del cliente </h2><br><p>  Aqu√≠ dar√© ejemplos de enrutadores Linux, pero en el caso de Mikrotik / Cisco esto deber√≠a ser a√∫n m√°s simple. </p><br><p>  Primero, configure BIRD: </p><br><div class="spoiler">  <b class="spoiler_title">bird.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">router id 192.168.1.2; table rkn; protocol device { scan time 10; }; # Servers protocol bgp bgp_server1 { table rkn; local as 65000; neighbor 192.168.1.1 as 65000; direct; bfd on; next hop self; graceful restart; graceful restart time 60; rr client; export none; import all; } protocol kernel { table rkn; kernel table 222; scan time 10; export all; import none; }</code> </pre> </div></div><br><p>  Por lo tanto, sincronizaremos las rutas recibidas de BGP con la tabla de enrutamiento del n√∫cleo n√∫mero 222. </p><br><p>  Despu√©s de eso, es suficiente pedirle al n√∫cleo que mire esta placa antes de mirar el valor predeterminado: </p><br><pre> <code class="plaintext hljs"># ip rule add from all pref 256 lookup 222 # ip rule 0: from all lookup local 256: from all lookup 222 32766: from all lookup main 32767: from all lookup default</code> </pre> <br><p>  Todo lo que queda es configurar DHCP en el enrutador para distribuir la direcci√≥n IP del t√∫nel del servidor como DNS y el esquema est√° listo. </p><br><h1 id="nedostatki">  Desventajas </h1><br><p>  Con el algoritmo actual para crear y procesar una lista de dominios, <code>youtube.com</code> y sus CDN entran en √©l. </p><br><p>  Y esto lleva al hecho de que todos los videos pasar√°n por la VPN, que puede obstruir todo el canal.  Quiz√°s valga la pena compilar una lista de dominios de excepci√≥n populares que est√°n bloqueados en el ILV por el momento.  Y om√≠talos mientras analizas. </p><br><h1 id="zaklyuchenie">  Conclusi√≥n </h1><br><p>  El m√©todo descrito le permite omitir casi todos los bloqueos que los proveedores implementan actualmente. </p><br><p>  En principio, <em>dnstap-bgp</em> puede usarse para cualquier otro prop√≥sito donde se requiere un cierto nivel de control de tr√°fico basado en un nombre de dominio.  Solo tenga en cuenta que hoy en d√≠a miles de sitios pueden colgar en la misma direcci√≥n IP (para algunos Cloudflare, por ejemplo), por lo que este m√©todo tiene una precisi√≥n bastante baja. </p><br><p>  Pero para las necesidades de evitar las cerraduras, esto es suficiente. </p><br><p>  ¬°Adiciones, ediciones, misiones de extracci√≥n son bienvenidas! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467547/">https://habr.com/ru/post/467547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467531/index.html">M√°quina de estado reactivo</a></li>
<li><a href="../467533/index.html">Escuchar ruido informativo: m√∫sica y videos que nadie deber√≠a haber encontrado</a></li>
<li><a href="../467539/index.html">Foro CA / B votado contra acortar certificados SSL a 397 d√≠as</a></li>
<li><a href="../467543/index.html">Ssh-chat, parte 2</a></li>
<li><a href="../467545/index.html">ShIoTiny: un reloj sin resorte o tiempo real y c√≥mo trabajar con √©l</a></li>
<li><a href="../467549/index.html">SpaceX planea implementar una red de Internet satelital antes de lo planeado</a></li>
<li><a href="../467551/index.html">Frontend Weekly Digest (9-15 de septiembre de 2019)</a></li>
<li><a href="../467555/index.html">¬øQu√© tan bien conoces CSS? (+ mini-prueba)</a></li>
<li><a href="../467557/index.html">El resumen de materiales frescos del mundo del front-end para la √∫ltima semana No. 380 (8 al 15 de septiembre de 2019)</a></li>
<li><a href="../467559/index.html">Eventos digitales en Mosc√∫ del 16 al 22 de septiembre.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>