<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí© üìó üòñ MVCC en PostgreSQL-5. Vac√≠o en la p√°gina y actualizaciones CALIENTES üë©üèΩ‚Äçüé® üßöüèº üë©‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Solo para recordarle, ya discutimos cuestiones relacionadas con el aislamiento , hicimos una digresi√≥n sobre la estructura de datos de bajo nivel , y ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MVCC en PostgreSQL-5. Vac√≠o en la p√°gina y actualizaciones CALIENTES</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/483768/">  Solo para recordarle, ya discutimos cuestiones relacionadas con el <a href="https://habr.com/ru/company/postgrespro/blog/467437/">aislamiento</a> , hicimos una digresi√≥n sobre <a href="https://habr.com/ru/company/postgrespro/blog/469087/">la estructura de datos de bajo nivel</a> , y luego exploramos las <a href="https://habr.com/ru/company/postgrespro/blog/477648/">versiones de fila</a> y observamos c√≥mo se obtienen las <a href="https://habr.com/ru/company/postgrespro/blog/479512/">instant√°neas de datos</a> de las versiones de fila. <br><br>  Ahora procederemos a dos problemas estrechamente relacionados: <em>vac√≠o en la p√°gina</em> y <em>actualizaciones CALIENTES</em> .  Ambas t√©cnicas pueden referirse a optimizaciones;  son importantes, pero pr√°cticamente no est√°n cubiertos en la documentaci√≥n. <br><br><h1>  Aspiraci√≥n en la p√°gina durante actualizaciones peri√≥dicas </h1><br>  Al acceder a una p√°gina para una actualizaci√≥n o lectura, si PostgreSQL entiende que la p√°gina se est√° quedando sin espacio, puede hacer un vac√≠o r√°pido en la p√°gina.  Esto sucede en cualquiera de los casos: <br><br><ol><li>  Una actualizaci√≥n anterior en esta p√°gina no encontr√≥ suficiente espacio para asignar una nueva versi√≥n de fila en la misma p√°gina.  Tal situaci√≥n se recuerda en el encabezado de la p√°gina, y la pr√≥xima vez que la p√°gina se vac√≠e. </li><li> La p√°gina tiene m√°s del <code>fillfactor</code> de <code>fillfactor</code> por ciento lleno.  En este caso, el vac√≠o se realiza de inmediato sin posponer hasta el siguiente. </li></ol><a name="habracut"></a><br>  <code>fillfactor</code> es un par√°metro de almacenamiento que se puede definir para una tabla (y para un √≠ndice).  PostgresSQL inserta una nueva fila en una p√°gina solo si la p√°gina tiene menos del <code>fillfactor</code> de <code>fillfactor</code> por ciento lleno.  El espacio restante est√° reservado para las nuevas tuplas que se crean como resultado de las actualizaciones.  El valor predeterminado para las tablas es 100, es decir, no se reserva espacio (y el valor predeterminado para los √≠ndices es 90). <br><br>  El vac√≠o en la p√°gina elimina las tuplas que no son visibles en ninguna instant√°nea (aquellas que est√°n m√°s all√° del horizonte de transacciones de la base de datos, que se discuti√≥ la <a href="https://habr.com/ru/company/postgrespro/blog/479512/">√∫ltima vez</a> ), pero lo hace estrictamente dentro de una p√°gina de tabla.  Los punteros a las tuplas aspiradas no se liberan, ya que se puede hacer referencia a ellos desde √≠ndices, y hay un √≠ndice en otra p√°gina.  El vac√≠o en la p√°gina nunca llega m√°s all√° de una p√°gina de tabla, sino que funciona muy r√°pidamente. <br><br>  Por las mismas razones, el mapa de espacio libre no se actualiza;  esto tambi√©n reserva el espacio extra para actualizaciones en lugar de para inserciones.  El mapa de visibilidad tampoco se actualiza. <br><br>  El hecho de que una p√°gina se pueda aspirar durante las lecturas significa que una consulta SELECT puede implicar el cambio de p√°ginas.  Este es un caso m√°s como este, adem√°s de un cambio diferido de bits de pista, discutido anteriormente. <br><br>  Consideremos un ejemplo de c√≥mo funciona.  Creemos una tabla e √≠ndices en ambas columnas. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> hot(id <span class="hljs-type"><span class="hljs-type">integer</span></span>, s <span class="hljs-type"><span class="hljs-type">char</span></span>(<span class="hljs-number"><span class="hljs-number">2000</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (fillfactor = <span class="hljs-number"><span class="hljs-number">75</span></span>); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> hot_id <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> hot(id); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> hot_s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> hot(s);</code> </pre><br>  Si la columna <code>s</code> almacena solo caracteres latinos, cada versi√≥n de fila ocupar√° 2004 bytes m√°s 24 bytes de un encabezado.  Establecemos el par√°metro de almacenamiento del <code>fillfactor</code> al 75%, que reserva suficiente espacio para tres filas. <br><br>  Para examinar convenientemente el contenido de la p√°gina de la tabla, recreemos una funci√≥n ya familiar agregando dos campos m√°s a la salida: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> heap_page(relname <span class="hljs-type"><span class="hljs-type">text</span></span>, pageno <span class="hljs-type"><span class="hljs-type">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>(ctid tid, state <span class="hljs-type"><span class="hljs-type">text</span></span>, xmin <span class="hljs-type"><span class="hljs-type">text</span></span>, xmax <span class="hljs-type"><span class="hljs-type">text</span></span>, hhu <span class="hljs-type"><span class="hljs-type">text</span></span>, hot <span class="hljs-type"><span class="hljs-type">text</span></span>, t_ctid tid) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$<span class="pgsql"><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> (pageno,lp)::</span><span class="hljs-type"><span class="pgsql"><span class="hljs-type">text</span></span></span><span class="pgsql">::tid </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> ctid, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> lp_flags </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'unused'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'normal'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">2</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'redirect to '</span></span></span><span class="pgsql">||lp_off </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">3</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'dead'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> state, t_xmin || </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">256</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">' (c)'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">512</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">' (a)'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ELSE</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">''</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> xmin, t_xmax || </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1024</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">' (c)'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">2048</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">' (a)'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ELSE</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">''</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> xmax, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask2 &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">16384</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'t'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> hhu, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CASE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHEN</span></span></span><span class="pgsql"> (t_infomask2 &amp; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">32768</span></span></span><span class="pgsql">) &gt; </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">0</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">THEN</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'t'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> hot, t_ctid </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> heap_page_items(get_raw_page(relname,pageno)) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ORDER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">BY</span></span></span><span class="pgsql"> lp; $$</span><span class="undefined"></span></span><span class="pgsql"><span class="undefined"></span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>;</code> </pre><br>  Tambi√©n creemos una funci√≥n para mirar en la p√°gina de √≠ndice: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> index_page(relname <span class="hljs-type"><span class="hljs-type">text</span></span>, pageno <span class="hljs-type"><span class="hljs-type">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>(itemoffset <span class="hljs-type"><span class="hljs-type">smallint</span></span>, ctid tid) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$<span class="pgsql"><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> itemoffset, ctid </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> bt_page_items(relname,pageno); $$</span><span class="undefined"></span></span><span class="pgsql"><span class="undefined"></span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>;</code> </pre><br>  Veamos c√≥mo funciona el vac√≠o en la p√°gina.  Para hacer esto, insertamos una fila y la cambiamos varias veces: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span>); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'B'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'C'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'D'</span></span>;</code> </pre><br>  Hay cuatro tuplas en la p√°gina ahora: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+----------+----------+-----+-----+-------- (0,1) | normal | 3979 (c) | 3980 (c) | | | (0,2) (0,2) | normal | 3980 (c) | 3981 (c) | | | (0,3) (0,3) | normal | 3981 (c) | 3982 | | | (0,4) (0,4) | normal | 3982 | 0 (a) | | | (0,4) (4 rows)</code> </pre><br>  Como se esperaba, acabamos de superar el umbral del <code>fillfactor</code> .  Esto queda claro por la diferencia entre el <code>pagesize</code> y <code>upper</code> valores <code>upper</code> : excede el umbral igual al 75% del tama√±o de la p√°gina, lo que hace 6144 bytes. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> lower, upper, pagesize <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> page_header(get_raw_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre><pre> <code class="plaintext hljs"> lower | upper | pagesize -------+-------+---------- 40 | 64 | 8192 (1 row)</code> </pre><br>  Entonces, cuando se accede a la p√°gina la pr√≥xima vez, debe ocurrir un vac√≠o en la p√°gina.  Vamos a ver esto. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'E'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+----------+-------+-----+-----+-------- (0,1) | dead | | | | | (0,2) | dead | | | | | (0,3) | dead | | | | | (0,4) | normal | 3982 (c) | 3983 | | | (0,5) (0,5) | normal | 3983 | 0 (a) | | | (0,5) (5 rows)</code> </pre><br>  Todas las tuplas muertas (0,1), (0,2) y (0,3) son aspiradas;  despu√©s de eso se agrega una nueva tupla (0.5) en el espacio liberado. <br><br>  Las tuplas que sobrevivieron a la aspiraci√≥n se mueven f√≠sicamente hacia direcciones altas de la p√°gina para que todo el espacio libre est√© representado por un √°rea continua.  Los valores de los punteros se modifican en consecuencia.  Gracias a esto, no surgen problemas con la fragmentaci√≥n del espacio libre en una p√°gina. <br><br>  Los punteros a las tuplas aspiradas no se pueden liberar ya que se hace referencia a ellos desde la p√°gina de √≠ndice.  Veamos la primera p√°gina del √≠ndice <code>hot_s</code> (porque la p√°gina cero est√° ocupada por metainformaci√≥n): <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> index_page(<span class="hljs-string"><span class="hljs-string">'hot_s'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> itemoffset | ctid ------------+------- 1 | (0,1) 2 | (0,2) 3 | (0,3) 4 | (0,4) 5 | (0,5) (5 rows)</code> </pre><br>  Tambi√©n vemos la misma imagen en el otro √≠ndice: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> index_page(<span class="hljs-string"><span class="hljs-string">'hot_id'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> itemoffset | ctid ------------+------- 1 | (0,5) 2 | (0,4) 3 | (0,3) 4 | (0,2) 5 | (0,1) (5 rows)</code> </pre><br>  Puede notar que los punteros a las filas de la tabla siguen aqu√≠ en orden inverso, pero esto no hace ninguna diferencia ya que todas las tuplas tienen el mismo valor: id = 1.  Pero en el √≠ndice anterior, los punteros est√°n ordenados por los valores de <code>s</code> , y esto es esencial. <br><br>  Con acceso al √≠ndice, PostgreSQL puede obtener (0,1), (0,2) o (0,3) como identificadores de tupla.  Luego intentar√° obtener la versi√≥n de fila adecuada de la p√°gina de la tabla, pero debido al estado "muerto" del puntero, PostgreSQL descubrir√° que tal versi√≥n ya no existe y la ignorar√°.  (En realidad, una vez que descubri√≥ que la versi√≥n de una fila de la tabla no est√° disponible, PostgreSQL cambiar√° el estado del puntero en la p√°gina de √≠ndice para no acceder m√°s a la p√°gina de la tabla). <br><br>  Es esencial que el vac√≠o en la p√°gina funcione solo dentro de una p√°gina de tabla y no aspire las p√°ginas de √≠ndice. <br><br><h1>  Actualizaciones CALIENTES </h1><br>  ¬øPor qu√© no es bueno almacenar referencias a todas las versiones de fila en el √≠ndice? <br><br>  Primero, para cualquier cambio de la fila, todos los √≠ndices creados para la tabla deben actualizarse: una vez que se ha creado una nueva versi√≥n, se debe hacer referencia a ella.  Y debemos hacer esto en cualquier caso, incluso si se cambian los campos que no est√°n indexados.  Obviamente, esto no es muy eficiente. <br><br>  En segundo lugar, los √≠ndices acumulan referencias a tuplas hist√≥ricas, que luego deben aspirarse junto con las tuplas mismas (discutiremos un poco m√°s adelante c√≥mo se hace). <br><br>  Adem√°s, B-tree en PostgreSQL tiene los detalles de implementaci√≥n.  Si una p√°gina de √≠ndice no tiene espacio suficiente para insertar una nueva fila, la p√°gina se divide en dos y todos los datos se distribuyen entre ellas.  Esto se llama divisi√≥n de una p√°gina.  Sin embargo, cuando se eliminan las filas, las dos p√°ginas de √≠ndice no se fusionan en una sola.  Debido a esto, el tama√±o del √≠ndice puede no reducirse incluso si se elimina una parte significativa de los datos. <br><br>  Naturalmente, cuantos m√°s √≠ndices se crean en una tabla, se encuentran m√°s complejidades. <br><br>  Sin embargo, si se cambia un valor en una columna que no est√° indexada en absoluto, no tiene sentido crear una fila de √°rbol B adicional que contenga el mismo valor de la clave.  As√≠ es exactamente c√≥mo funciona la optimizaci√≥n llamada <em>actualizaci√≥n HOT</em> ( <em>actualizaci√≥n</em> de Tupla solo de mont√≥n). <br><br>  Durante esta actualizaci√≥n, la p√°gina de √≠ndice contiene solo una fila, que hace referencia a la primera versi√≥n de la fila en la p√°gina de la tabla.  Y ya est√° dentro de la p√°gina de la tabla, que se organiza una cadena de tuplas: <br><br><ul><li>  Las filas actualizadas que est√°n en la cadena est√°n etiquetadas con el bit Heap Hot Updated. </li><li>  Las filas a las que no se hace referencia desde el √≠ndice se etiquetan con el bit Heup Only Tuple. </li><li>  Como de costumbre, las versiones de fila est√°n vinculadas a trav√©s del campo <code>ctid</code> . </li></ul><br>  Si durante la exploraci√≥n del √≠ndice, PostgreSQL accede a una p√°gina de tabla y encuentra una tupla etiquetada como Heap Hot Updates, entiende que no debe detenerse, sino que debe seguir la cadena HOT, considerando cada tupla en ella.  Ciertamente, para todas las tuplas obtenidas de esta manera, la visibilidad se verifica antes de devolverlas al cliente. <br><br>  Para observar c√≥mo funciona una actualizaci√≥n HOT, eliminemos un √≠ndice y borremos la tabla. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> hot_s; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">TRUNCATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> hot;</code> </pre><br>  Ahora rehacemos la inserci√≥n y actualizaci√≥n de una fila. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span>); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'B'</span></span>;</code> </pre><br>  Y esto es lo que vemos en la p√°gina de la tabla: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+----------+-------+-----+-----+-------- (0,1) | normal | 3986 (c) | 3987 | t | | (0,2) (0,2) | normal | 3987 | 0 (a) | | t | (0,2) (2 rows)</code> </pre><br>  Hay una cadena de cambios en la p√°gina: <br><br><ul><li>  El indicador Heap Hot Updated indica que se debe seguir la cadena <code>ctid</code> . </li><li>  El indicador Tupla de solo almacenamiento din√°mico indica que esta tupla no est√° referenciada desde los √≠ndices. </li></ul><br>  La cadena crecer√° (dentro de la p√°gina) con m√°s cambios: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'C'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'D'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+----------+----------+-----+-----+-------- (0,1) | normal | 3986 (c) | 3987 (c) | t | | (0,2) (0,2) | normal | 3987 (c) | 3988 (c) | t | t | (0,3) (0,3) | normal | 3988 (c) | 3989 | t | t | (0,4) (0,4) | normal | 3989 | 0 (a) | | t | (0,4) (4 rows)</code> </pre><br>  Pero solo hay una referencia a la cabeza de la cadena en el √≠ndice: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> index_page(<span class="hljs-string"><span class="hljs-string">'hot_id'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> itemoffset | ctid ------------+------- 1 | (0,1) (1 row)</code> </pre><br>  Para enfatizar, las actualizaciones HOT funcionan en el caso en que los campos para actualizar no est√°n indexados en absoluto.  De lo contrario, alg√∫n √≠ndice contendr√≠a una referencia directamente a una nueva versi√≥n de fila, y esto es incompatible con el concepto de esta optimizaci√≥n. <br><br>  La optimizaci√≥n funciona solo dentro de una p√°gina y, por lo tanto, un recorrido adicional por la cadena no necesita acceso a otras p√°ginas y no afecta el rendimiento. <br><br><h1>  Vac√≠o en la p√°gina durante las actualizaciones CALIENTES </h1><br>  Aspirar durante las actualizaciones CALIENTES es un caso especial, pero importante, de vac√≠o en la p√°gina. <br><br>  Como antes, ya hemos excedido el umbral del <code>fillfactor</code> , por lo que la pr√≥xima actualizaci√≥n debe causar un vac√≠o en la p√°gina.  Pero esta vez hay una cadena de actualizaciones en la p√°gina.  La cabeza de esta cadena HOT siempre debe permanecer donde est√°, ya que el √≠ndice hace referencia a ella, mientras que el resto de los punteros se pueden liberar: se sabe que no tienen referencias desde el exterior. <br><br>  Para no tocar el puntero de la cabeza, se usa direccionamiento indirecto: el puntero al que hace referencia el √≠ndice - (0,1) en este caso - adquiere el estado de "redireccionamiento", que redirige a la tupla apropiada. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'E'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+-------+-----+-----+-------- (0,1) | redirect to 4 | | | | | (0,2) | normal | 3990 | 0 (a) | | t | (0,2) (0,3) | unused | | | | | (0,4) | normal | 3989 (c) | 3990 | t | t | (0,2) (4 rows)</code> </pre><br>  Tenga en cuenta que: <br><br><ul><li>  Las tuplas (0,1), (0,2) y (0,3) se eliminaron por aspiraci√≥n. </li><li>  El puntero de la cabeza (0,1) permanece, pero adquiri√≥ el estado de "redirecci√≥n". </li><li>  La nueva versi√≥n de la fila sobrescribi√≥ (0,2) ya que no hab√≠a referencias a esa tupla con seguridad, y el puntero se solt√≥ (estado "no utilizado"). </li></ul><br>  Hagamos una actualizaci√≥n varias veces m√°s: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'F'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'G'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+----------+-----+-----+-------- (0,1) | redirect to 4 | | | | | (0,2) | normal | 3990 (c) | 3991 (c) | t | t | (0,3) (0,3) | normal | 3991 (c) | 3992 | t | t | (0,5) (0,4) | normal | 3989 (c) | 3990 (c) | t | t | (0,2) (0,5) | normal | 3992 | 0 (a) | | t | (0,5) (5 rows)</code> </pre><br>  La pr√≥xima actualizaci√≥n hace que la aspiradora en la p√°gina vuelva a aparecer: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'H'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+-------+-----+-----+-------- (0,1) | redirect to 5 | | | | | (0,2) | normal | 3993 | 0 (a) | | t | (0,2) (0,3) | unused | | | | | (0,4) | unused | | | | | (0,5) | normal | 3992 (c) | 3993 | t | t | (0,2) (5 rows)</code> </pre><br>  Nuevamente, algunas de las tuplas se aspiran y el puntero a la cabeza de la cadena se mueve en consecuencia. <br><br>  Conclusi√≥n: si las columnas que no est√°n indexadas se actualizan con frecuencia, puede tener sentido reducir el par√°metro <code>fillfactor</code> para reservar espacio en la p√°gina para las actualizaciones.  Sin embargo, debemos tener en cuenta que cuanto menor sea el <code>fillfactor</code> , m√°s espacio libre queda en una p√°gina, por lo que aumenta el tama√±o f√≠sico de la tabla. <br><br><h1>  Rotura de una cadena CALIENTE </h1><br>  Si la p√°gina carece de espacio libre para asignar una nueva tupla, la cadena se romper√°.  Y tendremos que hacer una referencia separada del √≠ndice a la versi√≥n de fila ubicada en una p√°gina diferente. <br><br>  Para reproducir esta situaci√≥n, comencemos una transacci√≥n concurrente y construyamos la instant√°nea de datos en ella. <br><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPEATABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span>; | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> hot;</code> </pre><pre> <code class="plaintext hljs">| count | ------- | 1 | (1 row)</code> </pre><br>  La instant√°nea no permitir√° aspirar las tuplas de la p√°gina.  Ahora hagamos una actualizaci√≥n en la primera sesi√≥n: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'I'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'J'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'K'</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+----------+-----+-----+-------- (0,1) | redirect to 2 | | | | | (0,2) | normal | 3993 (c) | 3994 (c) | t | t | (0,3) (0,3) | normal | 3994 (c) | 3995 (c) | t | t | (0,4) (0,4) | normal | 3995 (c) | 3996 | t | t | (0,5) (0,5) | normal | 3996 | 0 (a) | | t | (0,5) (5 rows)</code> </pre><br>  En la pr√≥xima actualizaci√≥n, la p√°gina no tendr√° suficiente espacio, pero el vac√≠o en la p√°gina no podr√° aspirar nada: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> hot <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> s = <span class="hljs-string"><span class="hljs-string">'L'</span></span>;</code> </pre><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- snapshot no longer needed</span></span></code> </pre><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+---------------+----------+----------+-----+-----+-------- (0,1) | redirect to 2 | | | | | (0,2) | normal | 3993 (c) | 3994 (c) | t | t | (0,3) (0,3) | normal | 3994 (c) | 3995 (c) | t | t | (0,4) (0,4) | normal | 3995 (c) | 3996 (c) | t | t | (0,5) (0,5) | normal | 3996 (c) | 3997 | | t | (1,1) (5 rows)</code> </pre><br>  En la tupla (0,5), hay una referencia a (1,1), que se encuentra en la p√°gina 1. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> heap_page(<span class="hljs-string"><span class="hljs-string">'hot'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> ctid | state | xmin | xmax | hhu | hot | t_ctid -------+--------+------+-------+-----+-----+-------- (1,1) | normal | 3997 | 0 (a) | | | (1,1) (1 row)</code> </pre><br>  Ahora hay dos filas en el √≠ndice, cada una de las cuales apunta al comienzo de su cadena HOT: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> index_page(<span class="hljs-string"><span class="hljs-string">'hot_id'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><pre> <code class="plaintext hljs"> itemoffset | ctid ------------+------- 1 | (1,1) 2 | (0,1) (2 rows)</code> </pre><br><blockquote>  Desafortunadamente, la documentaci√≥n carece pr√°cticamente de informaci√≥n sobre el vac√≠o en la p√°gina y las actualizaciones HOT, y debe buscar respuestas en el c√≥digo fuente.  Te aconsejo que comiences con <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%3Ba%3Dblob%3Bf%3Dsrc/backend/access/heap/README.HOT%3Bhb%3DHEAD">README.HOT</a> . <br></blockquote><br>  <a href="https://habr.com/ru/company/postgrespro/blog/484106/">Sigue leyendo</a> . </div></div><p>Source: <a href="https://habr.com/ru/post/483768/">https://habr.com/ru/post/483768/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../483754/index.html">¬øC√≥mo medir la mejora del equipo?</a></li>
<li><a href="../483756/index.html">Hacemos solicitudes HTTP, degradamos con gracia (y no una sola brecha)</a></li>
<li><a href="../483758/index.html">Las 10 nuevas empresas de desarrollo de aplicaciones m√≥viles pueden asociarse en 2020</a></li>
<li><a href="../483762/index.html">GitLab 12.6 lanzado con calificaciones de seguridad del proyecto y materiales de lanzamiento</a></li>
<li><a href="../483766/index.html">Los tribunales como una herramienta de pirater√≠a social o un poco sobre la fiabilidad de la informaci√≥n en las bases de datos de WHOIS</a></li>
<li><a href="../483770/index.html">Hacia la automatizaci√≥n SSL</a></li>
<li><a href="../483774/index.html">El resumen de eventos para profesionales de recursos humanos en TI para enero de 2020</a></li>
<li><a href="../483776/index.html">Introducci√≥n al m√©todo diferencial sem√°ntico en 5 minutos.</a></li>
<li><a href="../483778/index.html">Semana de la seguridad 03: Principios responsables del informe de errores</a></li>
<li><a href="../483780/index.html">¬øQu√© es la holgura y c√≥mo funciona?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>