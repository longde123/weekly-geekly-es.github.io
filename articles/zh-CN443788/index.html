<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔊 🏬 👏🏾 Mikrotik RouterOS中静态路由的基础 🙋🏽 ➰ 🛒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="路由是为TCP / IP网络上的数据包传输找到最佳路径的过程。 连接到IPv4网络的任何设备都包含一个进程表和路由表。 


 本文不是HOWTO，而是以RouterOS中的静态路由为例进行说明，我有意省略了其余设置（例如，用于访问Internet的srcnat），因此理解此材料需要一定程度的网络和...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mikrotik RouterOS中静态路由的基础</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443788/"><p> 路由是为TCP / IP网络上的数据包传输找到最佳路径的过程。 连接到IPv4网络的任何设备都包含一个进程表和路由表。 </p><br><p> 本文不是HOWTO，而是以RouterOS中的静态路由为例进行说明，我有意省略了其余设置（例如，用于访问Internet的srcnat），因此理解此材料需要一定程度的网络和RouterOS知识。 </p><a name="habracut"></a><br><h3 id="kommutaciya-i-marshrutizaciya"> 交换与路由 </h3><br><p><img src="https://habrastorage.org/webt/5v/h7/a2/5vh7a2relrje9g9e5kbonuogsqw.png"></p><br><p> 交换是在一个Layer2网段（以太网，ppp等）内交换数据包的过程。 如果设备发现数据包接收者与它原来在同一以太网子网上，则它会使用arp协议识别mac地址，并绕过路由器直接发送数据包。  ppp（点对点）连接只能有两个成员，并且数据包始终发送到相同的0xff地址。 </p><br><p> 路由是在第2层网段之间传输数据包的过程。 如果设备要发送数据包（其接收者在以太网段之外），则会查看其路由表，然后将数据包传递给网关，该网关知道进一步向何处发送数据包（或者可能不知道，数据包的原始发送者并不知道这一点）。 </p><br><p> 考虑路由器的最简单方法是将其作为连接到两个或多个Layer2网段并能够在它们之间传输数据包的设备，从而从路由表中确定最佳路由。 </p><br><p> 如果一切对您都清楚或您已经知道，请继续阅读。 我强烈建议其他人阅读一篇简短但非常全面的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文章</a> 。 </p><br><h3 id="marshrutizaciya-v-routeros-i-packetflow"> 在RouterOS和PacketFlow中进行路由 </h3><br><p> 几乎所有与静态路由相关的功能都在<em>系统</em>软件包中。  <em>路由</em>包增加了对动态路由算法（RIP，OSPF，BGP，MME），路由过滤器和BFD的支持。 </p><br><p>用于配置路由的主菜单： <code>[IP]-&gt;[Route]</code> 。 复杂的方案可能需要在<code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code>使用路由标签对数据包进行初步标签（ <code>PREROUTING</code>和<code>OUTPUT</code>链）。 </p><br><p>  PacketFlow上有三个地方可以决定路由IP数据包： <br><img src="https://habrastorage.org/webt/pk/ie/mp/pkiempktzjkwz6tcwrnwyl1c1dc.png"></p><br><ol><li> 路由器收到的路由数据包。 在此阶段，决定将数据包转到本地进程还是将进一步发送到网络。 传输数据包接收<em>输出接口</em> </li><li> 路由本地传出数据包。 传出数据包接收<em>输出接口</em> </li><li> 传出数据包的附加路由步骤使您可以在<code>[Output|Mangle]</code>更改路由决策。 </li></ol><br><ul><li> 块1、2中的数据包路径取决于<code>[IP]-&gt;[Route]</code>的规则 </li><li> 步骤1、2和3中的数据包路径取决于<code>[IP]-&gt;[Route]-&gt;[Rules]</code> </li><li> 可以使用<code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code>影响块1、3中的数据包路径。 </li></ul><br><h3 id="rib-fib-routing-cache">  RIB，FIB，路由缓存 </h3><br><p><img src="https://habrastorage.org/webt/fw/jc/ku/fwjckuzqzyxo4udazveb8uhotuq.png"></p><br><p>  <strong>路由信息库</strong> <br> 收集来自动态路由协议的路由，来自ppp和dhcp的路由，静态和连接的路由的基础。 该数据库包含除管理员过滤的路由以外的所有路由。 </p><br><p>  <em>按照惯例</em> ，我们可以假设<code>[IP]-&gt;[Route]</code>显示RIB。 </p><br><p>  <strong>转发信息库</strong> <br><img src="https://habrastorage.org/webt/kt/jn/q1/ktjnq1ebrd0--d9afkseuixtap8.png"></p><br><p> 从RIB出发的最佳航线路线所依据的基地。  FIB中的所有路由均处于活动状态，并用于转发数据包。 如果路由变为非活动状态（由管理员（系统）禁用，或者应该通过其发送数据包的接口处于非活动状态），则会从FIB中删除该路由。 </p><br><p> 为了确定路由，在FIB表中使用以下IP数据包数据： </p><br><ul><li> 源地址 </li><li> 目的地址 </li><li> 源接口 </li><li> 路由标记 </li><li> 服务条款（DSCP） </li></ul><br><p> 进入FIB软件包需要经历以下阶段： </p><br><ul><li> 软件包是为本地路由器进程设计的吗？ </li><li> 软件包是否属于PBR系统或用户规则？ <br><ul><li> 如果是这样，则将数据包发送到指定的路由表。 </li></ul></li><li> 数据包发送到主表 </li></ul><br><p>  <em>按照惯例</em> ，我们可以假设<code>[IP]-&gt;[Route Active=yes]</code>显示FIB。 </p><br><p>  <strong>路由缓存</strong> <br> 路由缓存机制。 路由器会记住数据包的发送位置，如果有相似的数据包（大概来自同一连接），它将沿着相同的路由启动它们，而无需检查FIB。 定期清除路由缓存。 </p><br><p> 对于管理员来说，RouterOS没有查看和管理路由缓存的方法，但是有了它，您可以在<code>[IP]-&gt;[Settings]</code>中将其禁用。 </p><br><p>  <em>此机制已从Linux 3.6内核中删除，但是RouterOS仍使用内核3.3.5，可能是路由缓存是原因之一。</em> </p><br><h3 id="dialog-dobavleniya-marshruta"> 路线添加对话框 </h3><br><p> <code>[IP]-&gt;[Route]-&gt;[+]</code> <br> <img src="https://habrastorage.org/webt/th/lb/el/thlbel_kvf2gk-s2125imh_z7cg.png"></p><br><ol><li> 要为其创建路由的子网（默认值：0.0.0.0/0） </li><li> 数据包将发送到的网关IP或接口（可能有多个，请参阅下面的ECMP） </li><li> 检查网关可用性 </li><li> 记录类型 </li><li> 路线距离（公制） </li><li> 路由表 </li><li> 通过此路由的本地出站数据包的IP </li><li> 范围的目的和目标范围写在本文的末尾。 </li></ol><br><p>  <strong>路线标志</strong> <br><img src="https://habrastorage.org/webt/ai/ro/iv/airoivo1bmk3lgbqj_hivpbjdyc.png"></p><br><ul><li>  X-路由被管理员<code>disabled=yes</code> （ <code>disabled=yes</code> ） </li><li>  A-路由用于传输数据包。 </li><li>  D-动态添加的路由（BGP，OSPF，RIP，MME，PPP，DHCP，已连接） </li><li>  C-子网直接连接到路由器 </li><li>  S-静态路线 </li><li>  r，b，o，m-路由是由一种动态路由协议添加的 </li><li>  B，U，P-过滤路由（丢弃数据包而不是发送数据包） </li></ul><br><h3 id="chto-ukazyvat-v-gateway-ip-adres-ili-interfeys"> 在网关中指定什么：ip地址或接口？ </h3><br><p> 该系统允许您同时指定它们两者，但不会发誓，并且如果做错了事也不会给出提示。 </p><br><p>  <strong>IP地址</strong> <br> 网关地址必须可以通过Layer2访问。 对于以太网，这意味着路由器必须在活动接口之一上具有来自同一子网的IP地址，对于ppp-网关地址在活动接口之一上列为子网地址。 <br> 如果不满足第2层的可用性条件，则该路由被认为是不活动的，并且不属于FIB。 </p><br><p>  <strong>介面</strong> <br> 一切都更加复杂，路由器的行为取决于接口的类型： </p><br><ul><li>  PPP（异步，PPTP，L2TP，SSTP，PPPoE，OpenVPN *）假定连接只有两个参与者，并且数据包将始终发送到网关进行传输，如果网关检测到它是接收者本身，它将把数据包传输到其本地进程。 <br><img src="https://habrastorage.org/webt/90/-g/xk/90-gxkgtlplrv8sstcs4r70bxx4.png"></li><li> 以太网假定有很多参与者，并且将使用数据包接收器的地址向arp接口发送请求，这是所连接路由的正常预期行为。 <br> 但是，当您尝试将接口用作远程子网的路由时，会遇到以下情况：路由处于活动状态，ping传递到网关，但未从指定的子网到达收件人。 如果通过嗅探器查看接口，则会看到带有来自远程子网地址的arp请求。 <br><img src="https://habrastorage.org/webt/62/si/qp/62siqpa8gbtxi-8x4eymxgv19vi.png"></li></ul><br><p><img src="https://habrastorage.org/webt/i6/-n/nb/i6-nnbyrlylq0jk6pqwefb_2qz8.png"></p><br><p> 尽可能尝试将IP地址指定为网关。 例外是连接的路由（自动创建）和PPP（异步，PPTP，L2TP，SSTP，PPPoE，OpenVPN *）接口。 </p><br><p>  <em>OpenVPN不包含PPP标头，但是您可以使用OpenVPN接口名称来创建路由。</em> </p><br><h3 id="more-specific-route"> 更具体的路线 </h3><br><p> 路由的基本规则。 在确定数据包路由时，描述较小子网（具有最大子网掩码）的路由具有较高的优先级。 条目在路由表中的位置与选择无关-基本规则是“更具体”。 </p><br><p><img src="https://habrastorage.org/webt/sm/cy/i9/smcyi9gkebkm8iq-yjcbev8-vs0.png"></p><br><p> 指定方案中的所有路由均处于活动状态（位于FIB中），因为 指向不同的子网并且不会相互冲突。 </p><br><p> 如果其中一个网关不可用，则关联的路由将被视为不活动（已从FIB删除），并且将从其余路由中搜索数据包。 </p><br><p> 子网为0.0.0.0/0的路由有时具有特殊的意义，称为“默认路由”或“最后的网关”。 实际上，它没有什么神奇的功能，它仅包含所有可能的IPv4地址，但是这些名称很好地描述了其目的-它指示网关，在该网关处转发没有其他更准确路由的数据包。 </p><br><p>  IPv4的最大可能子网掩码为/ 32；此路由指向特定主机，可以在路由表中使用。 </p><br><p>  <em>了解更特定的路由是任何TCP / IP设备的基础。</em> </p><br><h3 id="distance"> 距离 </h3><br><p> 距离（或度量）是对通过多个网关可访问的一个子网的路由进行管理性过滤所必需的。 度量值较低的路由被认为是优先级，将在FIB中。 如果具有较低度量标准的路由停止活动，则在FIB中它将被具有较高度量标准的路由替换。 <br><img src="https://habrastorage.org/webt/dz/yz/mh/dzyzmhb2y_fjqpbkbp2juyhfxsi.png"></p><br><p> 如果有多个具有相同度量标准的通往同一子网的路由，则路由器将在其内部逻辑的指导下仅将其中一条添加到FIB表中。 </p><br><p> 指标的取值范围是0到255： <br><img src="https://habrastorage.org/webt/rh/fk/j1/rhfkj1shnnjhqmvwhcc7o0itq8i.png"></p><br><ul><li>  0-所连接路由的度量。 管理员无法设置距离0 </li><li>  1-254-管理员可用于设置路由的度量。 值较低的指标优先。 </li><li>  255-管理员可用于设置路由的度量。 与1-254不同，度量值为255的路由始终保持不活动状态，并且不属于FIB </li><li> 特殊指标。 从动态路由协议接收的路由具有标准度量值 </li></ul><br><h3 id="check-gateway"> 检查网关 </h3><br><p> 检查网关-MikroTik RoutesOS扩展，用于通过icmp或arp检查网关的可用性。 每10秒一次（无法更改），一个请求将发送到网关，如果没有两次回答，则认为该路由不可用，并将其从FIB中删除。 如果检查网关禁用了验证路由，它将继续执行，并且一次成功的检查后，路由将再次变为活动状态。 <br><img src="https://habrastorage.org/webt/a_/km/vd/a_kmvd8xeoeyrnjqz78ciry1ja4.png"></p><br><p> 检查网关会禁用配置网关的条目以及指定网关的所有其他条目（在所有路由表和ecmp路由中）。 </p><br><p> 通常，如果网关的数据包丢失没有问题，则检查网关可以正常工作。  Check网关不知道在被检查网关外部进行通信会发生什么，因为还需要以下附加工具：脚本，递归路由，动态路由协议。 </p><br><p> 大多数VPN和隧道协议都包含用于检查连接活动的内置工具，因此为它们启用检查网关是网络和设备性能的额外（但很小）负载。 </p><br><h3 id="ecmp-marshruty">  ECMP路线 </h3><br><p> 等价多路径-使用Round Robin算法同时使用多个网关将数据包发送到收件人。 </p><br><p> 管理员通过为一个子网指定多个网关来创建ECMP路由（如果有两个等效的OSPF路由，则为自动创建）。 <br><img src="https://habrastorage.org/webt/4v/gz/yh/4vgzyh240kmasdj186yz2c3ovws.png"></p><br><p>  ECMP用于平衡两个通道之间的负载，理论上，如果ecmp路由中有两个通道，则对于每个数据包，传出通道都应该不同。 但是路由缓存机制沿第一个数据包到达的路由从连接发送数据包，结果，我们得到了一种针对每个连接的负载平衡。 </p><br><p> 如果禁用路由缓存，则ECMP路由中的数据包将被正确分割，但是NAT存在问题。  NAT规则仅处理来自连接的第一个数据包（其余的将自动处理），并且情况是具有一个源地址的数据包来自不同的接口。 <br><img src="https://habrastorage.org/webt/gj/cw/bl/gjcwblj73dmsczyhyqyuchcpdw0.png"></p><br><p> 检查网关（RouterOS错误）在ECMP路由中不起作用。 但是，如果您创建其他验证路径，则会绕开此限制，这将禁用ECMP中的条目。 </p><br><h3 id="filtraciya-sredstvami-routing"> 路由过滤 </h3><br><p>  “类型”选项确定如何处理软件包： </p><br><ul><li> 单播-发送到指定的网关（接口） </li><li> 黑洞-丢包 </li><li> 禁止，无法访问-丢弃数据包并向发送方发送icmp消息 </li></ul><br><p> 通常，当您需要以错误的方式保护发送数据包的安全时，通常会使用过滤，当然您可以通过防火墙对其进行过滤。 </p><br><h3 id="para-primerov"> 几个例子 </h3><br><p> 用于解决有关路由的基本问题。 </p><br><p>  <strong>典型的家用路由器</strong> <br><img src="https://habrastorage.org/webt/2a/fk/xx/2afkxxlv7lhluitqufsybt3s5pg.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1</code> </pre> <br><ol><li> 到0.0.0.0/0的静态路由（默认路由） </li><li> 与提供者的接口上的连接路由 </li><li>  LAN接口上的连接路由 </li></ol><br><p>  <strong>典型的PPPoE家庭路由器</strong> <br><img src="https://habrastorage.org/webt/im/wn/8p/imwn8pafrqins6erowkhiek2dqa.png"></p><br><ol><li> 静态路由到默认路由，自 这在连接属性中指示 </li><li>  PPP连接的连接路由 </li><li>  LAN接口上的连接路由 </li></ol><br><p>  <strong>具有两个提供商和冗余的典型家庭路由器</strong> <br><img src="https://habrastorage.org/webt/wq/2a/v0/wq2av0eskridghrj9yroknjz76o.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 distance=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><ol><li> 通过具有度量标准1的第一个提供程序的静态路由到默认路由，并检查网关的可用性 </li><li> 通过具有度量标准2的第二个提供程序的静态路由到默认路由 </li><li> 连通路线 </li></ol><br><p> 到0.0.0.0/0的流量通过10.10.10.1，而此网关可用，否则它将切换到10.20.20.1 </p><br><p>  <em>这样的方案可以被认为是信道预留，但是它也不是没有缺点。</em>  <em>如果中断发生在提供商的网关外部（例如，运营商网络内部），则您的路由器将不知道该中断，并将继续认为该路由处于活动状态。</em> </p><br><p>  <strong>典型的家用路由器具有两个提供程序，冗余和ECMP</strong> <br><img src="https://habrastorage.org/webt/un/fj/aw/unfjawyzmjdzo6_ekmmg93vlsk8.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1,10.20.20.1 distance=1</code> </pre> <br><ol><li> 检查Chack网关的静态路由 </li><li>  ECMP路线 </li><li> 连通路线 </li></ol><br><p> 用于检查蓝色的路由（非活动路由的颜色），但这不会影响检查网关的操作。 在当前版本（6.44）RoS中，将自动优先级赋予ECMP路由，但是最好将测试路由添加到其他路由表中（选项<code>routing-mark</code> ） </p><br><p>  Speedtest和其他类似站点上的速度不会提高（ECMP按连接而不是数据包划分流量），但p2p应用程序应加载得更快。 </p><br><p>  <strong>通过路由过滤</strong> <br><img src="https://habrastorage.org/webt/gv/bj/nh/gvbjnhvblrebv9051hd_x8adklo.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 add dst-address=192.168.200.0/24 gateway=10.30.30.1 distance=1 add dst-address=192.168.200.0/24 gateway=10.10.10.1 distance=2 type=blackhole</code> </pre> <br><ol><li> 静态路由到默认路由 </li><li> 通过ipip隧道到192.168.200.0/24的静态路由 </li><li> 禁止通过提供商的路由器到192.168.200.0/24的静态路由 </li></ol><br><p> 过滤选项，禁用ipip接口时，隧道流量不会进入提供商的路由器。 很少需要这种方案，因为 可以通过防火墙实施阻止。 </p><br><p>  <strong>路由回路</strong> <br> 路由循环是指ttl过期之前，数据包在路由器之间运行的情况。 通常，这是配置错误的结果，在大型网络中，应谨慎执行动态路由协议，在小型网络中应将其处理。 </p><br><p> 看起来像这样： <br><img src="https://habrastorage.org/webt/ii/h8/-v/iih8-vpacnim4b6flslcvy-v0eg.png"></p><br><p> 示例（最简单）如何获得相似的结果： <br><img src="https://habrastorage.org/webt/ky/9v/gv/ky9vgvnxvno8x79cbu79be0_buu.png"></p><br><p> 路由循环示例没有实际用途，但是它表明路由器不了解其邻居的路由表。 </p><br><h3 id="policy-base-routing-i-dopolnitelnye-tablicy-marshrutizacii"> 策略库路由和其他路由表 </h3><br><p> 选择路由时，路由器仅使用数据包标头（目标地址）中的一个字段-这是基本路由。 基于其他条件的路由，例如源地址，流量类型（ToS），不使用ECMP的平衡，是指策略基础路由（PBR），并使用其他路由表。 </p><br><p><img src="https://habrastorage.org/webt/cf/31/fj/cf31fjsrsjd2aszbzkl_hmg9wuw.png"></p><br><p>  <em>“更特定的路由”</em>是在路由表中选择路由的基本规则。 </p><br><p> 默认情况下，所有路由规则都添加到主表中。 管理员可以创建任意数量的其他路由表，并将数据包路由到它们。 不同表中的规则不会相互冲突。 如果程序包在指定的表中找不到合适的规则，它将转到主表。 </p><br><p> 通过防火墙的分发示例： <br><img src="https://habrastorage.org/webt/uw/nd/jz/uwndjzt8mtfett8l84vg-n65p90.png"></p><br><ul><li>  192.168.100.10-&gt; 8.8.8.8 <br><ol><li> 来自192.168.100.10的流量会在<code>[Prerouting|Mangle]</code>收到<em>via-isp1标签</em> 。 </li><li> 在“路由”阶段，在<em>via-isp1</em>表中<em>，</em>搜索<em>一条路由</em> ，直到8.8.8.8。 </li><li> 找到路由，将流量发送到网关10.10.10.1 </li></ol></li><li>  192.168.200.20-&gt; 8.8.8.8 <br><ol><li> 来自192.168.200.20的流量会在<code>[Prerouting|Mangle]</code>收到<em>via-isp2标签</em> </li><li> 在“路由”阶段， <em>via-isp2</em>表<em>搜索</em>的路由最高可达8.8.8.8。 </li><li> 找到路由，将流量发送到网关10.20.20.1 </li></ol></li><li> 如果其中一个网关（10.10.10.1或10.20.20.1）不可用，则数据包将转到<em>主</em>表并在其中寻找合适的路由 </li></ul><br><h3 id="problemy-terminologii"> 术语问题 </h3><br><p>  RouterOS存在某些术语问题。 <br> 在<code>[IP]-&gt;[Routes]</code>使用规则时，会显示路由表，尽管它说标签： <br><img src="https://habrastorage.org/webt/8i/kh/kh/8ikhkhsxvmlwnh9hd9g-quxnk18.png"></p><br><p> 在<code>[IP]-&gt;[Routes]-&gt;[Rule]</code>一切正确，在表操作的条件标签中： <br><img src="https://habrastorage.org/webt/0m/hl/5j/0mhl5jj73m7rfm4rvtb5qwpbix4.png"></p><br><h3 id="kak-otpravit-paket-v-opredelennuyu-tablicu-marshrutizacii"> 如何将数据包发送到特定的路由表 </h3><br><p>  RouterOS提供了几种工具： </p><br><ul><li>  <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> </li><li>  <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code>路由标签（ <code>action=mark-routing</code> ） </li><li>  VRF </li></ul><br><p>  <strong>规则<code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br> 规则是按顺序处理的，如果数据包符合规则的条件，则不会继续进行。 </p><br><p> 路由规则使您可以扩展路由功能，不仅依赖于收件人地址，而且还依赖于源地址和接收数据包的接口。 </p><br><p><img src="https://habrastorage.org/webt/hg/ip/py/hgippyt0pgilh0l9zouqqqpbsoe.png"></p><br><p> 规则由条件和动作组成： </p><br><ul><li> 条件。 他们实际上重复了在FIB中检查数据包的标志列表；仅缺少ToS。 </li><li> 动作 <br><ul><li> 查找-将数据包发送到表 </li><li> 仅在表中查找-将包锁定在表中，如果未找到路由，则包将不会进入主表 </li><li> 丢弃-丢弃数据包 </li><li> 无法到达-删除发件人通知数据包 </li></ul></li></ul><br><p> 在FIB中，绕过规则<code>[IP]-&gt;[Route]-&gt;[Rules]</code>处理到本地进程的流量： <br><img src="https://habrastorage.org/webt/yk/f4/gt/ykf4gt4ywwzgbklpyzlyulije8k.png"></p><br><p>  <strong>标记<code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br> 路由标签允许您使用几乎所有防火墙条件为数据包设置网关： <br><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><p>  <em>实际上，因为并非所有人都讲得通，所以有些人可能工作不稳定。</em> </p><br><p><img src="https://habrastorage.org/webt/6b/_m/om/6b_mom-f6nde0zyuy-mr62asho4.png"></p><br><p> 有两种标记包装的方法： </p><br><ul><li> 立即设置<em>路由标记</em> </li><li> 首先设置<em>连接标记</em> ，然后基于<em>连接标记</em>设置<em>路由标记</em> </li></ul><br><p> 在有关防火墙的文章中，我写道第二种选择是可取的，因为 在标记路由的情况下，可以减少cpu的负载-这并非完全正确。 这些标记方法并不总是等效的，通常用于解决各种问题。 </p><br><h3 id="primery-ispolzovaniya"> 使用范例 </h3><br><p> 我们继续使用“基于策略的路由”的示例，向他们展示为什么需要所有这些更加容易。 </p><br><p>  <strong>MultiWAN和响应传出（输出）流量</strong> <br>  MultiWAN配置的一个常见问题：Mikrotik仅可通过“活动”提供程序从Internet访问。 <br><img src="https://habrastorage.org/webt/ob/1p/ph/ob1pph0eph9qvz9nqvt759mptiq.png"></p><br><p> 与路由器请求的IP无关，在生成响应时，它将在路由表中查找通过isp1的路由处于活动状态的路由。 此外，这样的分组很可能在到达接收者的途中被过滤。 </p><br><p>  <em>另一个有趣的观点。</em>  <em>如果在ether1接口上配置了“简单”源nat： <code>/ip fi nat add out-interface=ether1 action=masquerade</code>数据包将通过src进入网络。</em>  <em>地址= 10.10.10.100，这将使情况进一步恶化。</em> </p><br><p> 有几种方法可以解决此问题，但是任何一种方法都需要附加的路由表： <br><img src="https://habrastorage.org/webt/g9/65/vy/g965vychbnzbsksplywfc3npi90.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping distance=1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping distance=2 add dst-address=0.0.0.0/0 gateway=10.10.10.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 routing-mark=over-isp2</code> </pre> <br><p>  <strong>使用<code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br> 指定将用于具有指定源IP的数据包的路由表。 <br><img src="https://habrastorage.org/webt/na/lm/b3/nalmb3u0yrde35z0mzdjm1xygr4.png"></p><br><pre> <code class="plaintext hljs">/ip route rule add src-address=10.10.10.100/32 action=lookup-only-in-table table=over-isp1 add src-address=10.20.20.200/32 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>  <em>您可以使用<code>action=lookup</code> ，但是对于本地传出流量，此选项完全排除了来自错误接口的连接。</em> </p><br><ul><li> 系统生成带有Src的响应数据包。 地址：10.20.20.200 </li><li> 在路由决策（2）阶段，检查<code>[IP]-&gt;[Routes]-&gt;[Rules]</code> ，并将数据包发送到<em>over-isp2</em>路由表 </li><li> 根据路由表，必须通过ether2接口将数据包发送到网关10.20.20.1 </li></ul><br><p><img src="https://habrastorage.org/webt/k-/zf/sg/k-zfsgxxdpqbufnwoobbno8d_aq.png"></p><br><p> 与使用Mangle表不同，此方法不需要有效的Connection Tracker。 </p><br><p>  <strong>使用<code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br> 连接从传入的数据包开始，因此我们对其进行标记（ <code>action=mark-connection</code> ），对于来自标记的连接的传出数据包，我们设置了路由标签（ <code>action=mark-routing</code> ）。 <br><img src="https://habrastorage.org/webt/lg/4v/ni/lg4vni1mt8eteade7mcitz_3s3g.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle #   add chain=input in-interface=ether1 connection-state=new action=mark-connection new-connection-mark=from-isp1 add chain=input in-interface=ether2 connection-state=new action=mark-connection new-connection-mark=from-isp2 #      add chain=output connection-mark=from-isp1 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=output connection-mark=from-isp2 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p> <em>      ip,     <code>dst-address</code>  .</em> </p><br><ul><li>   ether2    .    <code>[INPUT|Mangle]</code>         <em>from-isp2</em> </li><li>      Src. Address: 10.20.20.200 </li><li>   Routing Decision(2)          10.20.20.1   ether1.        <code>[OUTPUT|Filter]</code> </li><li>   <code>[OUTPUT|Mangle]</code>       <em>from-isp2</em>      <em>over-isp2</em> </li><li>   Routing Adjusment(3)             </li><li>            10.20.20.1   ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/rd/mr/qs/rdmrqst9dam9m7r9s4jsnudwdly.png"></p><br><h3 id="multiwan-i-otvetnyy-dst-nat-trafik"> MultiWAN   dst-nat  </h3><br><p>  ,        ( web)             . </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether1 action=dst-nat to-address=192.168.100.100 add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether2 action=dst-nat to-address=192.168.100.100</code> </pre> <br><p>     ,      Firewall Mangle,     : <br><img src="https://habrastorage.org/webt/3w/9i/pq/3w9ipqogda4itpjkpvqbw7ewxrg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting connection-state=new in-interface=ether1 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp1 add chain=prerouting connection-state=new in-interface=ether2 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp2 add chain=prerouting connection-mark=web-input-isp1 in-interface=ether3 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting connection-mark=web-input-isp2 in-interface=ether3 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/fb/qf/np/fbqfnpzfpcshxwzl2ruppyjh5qw.png"><br> <em>    NAT,      .</em> </p><br><h3 id="multiwan-i-ishodyaschie-soedineniya"> MultiWAN    </h3><br><p>    PBR    vpn (  SSTP)     . </p><br><p><img src="https://habrastorage.org/webt/pt/jg/m3/ptjgm36vdijiuvygzwl8csvwg5q.png"></p><br><p>   : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=192.168.100.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 routing-mark=over-isp3 add dst-address=0.0.0.0/0 gateway=192.168.100.1 distance=1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 distance=2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 distance=3</code> </pre> <br><p>  : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output dst-address=10.10.10.100 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp1 passtrough=no add chain=output dst-address=10.10.10.101 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp2 passtrough=no add chain=output dst-address=10.10.10.102 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp3 passtrough=no</code> </pre> <br><p>   NAT,        Src. Address: </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=srcnat out-interface=ether1 action=masquerade add chain=srcnat out-interface=ether2 action=masquerade add chain=srcnat out-interface=ether3 action=masquerade</code> </pre> <br><p> : </p><br><ul><li>     SSTP </li><li>   Routing Decision (2)     ,     main.       Src. Address    ether1 </li><li>  <code>[Output|Mangle]</code>        </li><li>         Routing Adjusment        </li><li>       Src. Address  ether1,   <code>[Nat|Srcnat]</code>       </li></ul><br><p> ,        : <br><img src="https://habrastorage.org/webt/i9/gd/x0/i9gdx0o9s0iqnr4shoxdtfqnh2i.png"></p><br><p> Connection Tracker   <code>[Mangle]</code>  <code>[Srcnat]</code> ,       ,      <code>Replay Dst. Address</code>    NAT: <br><img src="https://habrastorage.org/webt/ps/op/qa/psopqak9ysxfem9lebg7woyizk4.png"></p><br><p>  VPN  (      )         : <br><img src="https://habrastorage.org/webt/s7/nc/jz/s7ncjzninvkxn_a6-p3wdd5ywnw.png"></p><br><p> <strong> </strong> <br>   ,         : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=10.10.10.100 gateway=192.168.100.1 add dst-address=10.10.10.101 gateway=192.168.200.1 add dst-address=10.10.10.102 gateway=192.168.0.1</code> </pre> <br><p>              . ,        vpn      ,     6   <code>[IP]-&gt;[Routes]</code>  <code>type=blackhole</code> .    — 3   <code>[IP]-&gt;[Route]-&gt;[Rules]</code> . </p><br><h3 id="raspredelenie-soedineniy-polzovateley-po-kanalam-svyazi">       </h3><br><p> ,  .      : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2</code> </pre> <br><p> <strong> <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br><img src="https://habrastorage.org/webt/-m/4o/jv/-m4ojve7wspajkjoc00afbpsbru.png"></p><br><pre> <code class="plaintext hljs">/ip route rules add src-address=192.168.100.0/25 action=lookup-only-in-table table=over-isp1 add src-address=192.168.100.128/25 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>action=lookup</code> ,           main     .     —   . </p><br><p> <strong>   <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>     ip .       . <em>  layer7,      ,      ,       .</em> <br><img src="https://habrastorage.org/webt/u8/k5/yi/u8k5yito7_iuseo5cki-nhkaz5o.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address-list=users-over-isp1 dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 add chain=prerouting src-address-list=users-over-isp2 dst-address-type=!local action=mark-routing new-routing-mark=over-isp2</code> </pre> <br><p> ""        <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : </p><br><pre> <code class="plaintext hljs">/ip route rules add routing-mark=over-isp1 action=lookup-only-in-table table=over-isp1 add routing-mark=over-isp2 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>[IP]-&gt;[Firewall]-&gt;[Filter]</code> : </p><br><pre> <code class="plaintext hljs">/ip firewall filter add chain=forward routing-mark=over-isp1 out-interface=!ether1 action=reject add chain=forward routing-mark=over-isp2 out-interface=!ether2 action=reject</code> </pre> <br><p> <strong>  <code>dst-address-type=!local</code></strong> <br>   <code>dst-address-type=!local</code>           (dns, winbox, ssh, ...).       ,          ,   <code>dst-address-table</code> . </p><br><p>     <code>[IP]-&gt;[Route]-&gt;[Rules]</code>   ,      .   ,    FIB    <code>[PREROUTING|Mangle]</code>           main,    .    Routing Rules,            User PBR      . </p><br><p> <strong> <code>[IP]-&gt;[Firewall]-&gt;[Mangle action=route]</code></strong> <br>      <code>[Prerouting|Mangle]</code>            ,    : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address=192.168.100.0/25 action=route gateway=10.10.10.1 add chain=prerouting src-address=192.168.128.0/25 action=route gateway=10.20.20.1</code> </pre> <br><p>  <code>route</code>        ( <code>[IP]-&gt;[Route]-&gt;[Rules]</code> ).          ,    <code>action=route</code>    <code>action=mark-route</code> ,     (    <code>passtrough</code> ),   . <br> <em> wiki            ,               .</em> </p><br><h3 id="dinamicheskaya-balansirovka-na-osnove-ppc">     PPC </h3><br><p> Per Connection Classificator —     ECMP.    ECMP       (ECMP     ,     Routing Cache   ). </p><br><p> PCC  <em> </em>  ip ,    32-     <em></em> .       <em></em>    ,    . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> .  ,  . <br><img src="https://habrastorage.org/webt/md/xn/kz/mdxnkzst4p7nxatp2bnvjbrlsoe.png"></p><br><p>    : </p><br><pre> <code class="plaintext hljs">192.168.100.10: 192+168+100+10 = 470 % 3 = 2 192.168.100.11: 192+168+100+11 = 471 % 3 = 0 192.168.100.12: 192+168+100+12 = 472 % 3 = 1</code> </pre> <br><p>      src.address   : <br><img src="https://habrastorage.org/webt/sq/dn/rt/sqdnrtcsgypqle5ftv2rg23xvmg.png"></p><br><pre> <code class="plaintext hljs">#  /ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=3 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=1 routing-mark=over-isp3 #    /ip firewall mangle add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/0 action=mark-connection new-connection-mark=conn-over-isp1 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/1 action=mark-connection new-connection-mark=conn-over-isp2 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/2 action=mark-connection new-connection-mark=conn-over-isp3 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp1 action=mark-routing new-routing-mark=over-isp1 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp2 action=mark-routing new-routing-mark=over-isp2 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp3 action=mark-routing new-routing-mark=over-isp3</code> </pre> <br><p>      : <code>in-interface=br-lan</code> ,    <code>action=mark-routing</code>               . </p><br><h3 id="pereklyuchenie-kanalov-svyazi">    </h3><br><p> Check ping —  ,        IP ,                 ,            ,   check ping          . <br>           BGP,                 . </p><br><p>   ,        ip    ,      ,  google dns: 8.8.8.8. 8.8.4.4.    Mikrotik      . </p><br><p> <strong>    </strong> <br>      Multihop BGP               MikroTik,          check gateway       . </p><br><p>         scope/target scope       : <br><img src="https://habrastorage.org/webt/_m/kz/aw/_mkzawioocf0friubndc9q2pofw.png"></p><br><ol><li>           scope      main      target scope </li><li>     ,        </li><li>   connected        </li></ol><br><p>        ,    : <br><img src="https://habrastorage.org/webt/s4/jo/tv/s4jotv0vsxcofu8pcod2uzugfo4.png"></p><br><ul><li> 1-3  connected    ,       </li><li> 4-6   connected   ""  </li></ul><br><p>        RIB,   FIB    : <code>0.0.0.0/0 via 10.10.10.1 on ether1</code> . </p><br><p> <strong>      </strong> <br><img src="https://habrastorage.org/webt/f1/gd/hj/f1gdhjwli1fqi4yk7i-cfdyf2l0.png"></p><br><p> : <br><img src="https://habrastorage.org/webt/d8/bb/ae/d8bbaepprp0wswv54ly0ryzphhc.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=8.8.8.8 check-gateway=ping distance=1 target-scope=10 add dst-address=8.8.8.8 gateway=10.10.10.1 scope=10 add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><p>  ,      10.10.10.1: <br><img src="https://habrastorage.org/webt/k6/nq/a9/k6nqa98jmecubjxx8e2zndbclcc.png"></p><br><p> Check gateway          ping'   8.8.8.8,  (   main)    10.10.10.1. </p><br><p>      10.10.10.1  8.8.8.8,    ,   (  ping)  8.8.8.8    10.10.10.1: <br><img src="https://habrastorage.org/webt/hj/v2/tg/hjv2tg5bnkaae2gyr7iunr74kt4.png"></p><br><p>      ether1,    ,    8.8.8.8    : <br><img src="https://habrastorage.org/webt/rt/_d/ad/rt_dadf8--ghn5pmgyg7q1ya258.png"></p><br><p>  ,    NetWatch      8.8.8.8.    NetWatch            .     : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=8.8.8.8 gateway=10.20.20.1 distance=100 type=blackhole</code> </pre> <br><p><img src="https://habrastorage.org/webt/ks/6e/k3/ks6ek3swyj9uyiih0bkbef1i6eu.png"></p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ,    NetWatch   . </p><br><p>  ,      8.8.8.8       ,       dns    . </p><br><h3 id="para-slov-pro-virtual-routing-and-forwarding-vrf">    Virtual Routing and Forwarding (VRF) </h3><br><p>  VRF         ,        (    MPLS)    L3VPN     : <br><img src="https://habrastorage.org/webt/hk/0l/ep/hk0lep0gncmeajzj1pkp2wix6yk.png"></p><br><p>  VRF  Mikrotik         ,   ip      VRF,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> . </p><br><p>   vrf: <br><img src="https://habrastorage.org/webt/gl/g8/k8/glg8k8isgjjsgyjodp7-rnqq5fi.png"></p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0</code> </pre> <br><p>     ether2 ,   ping      vrf (  ),   ping    : <br><img src="https://habrastorage.org/webt/pz/a7/h_/pza7h_xts_jyk6czos89h47q45u.png"></p><br><p>            main (  vrf   route leaking): <br><img src="https://habrastorage.org/webt/on/p-/5z/onp-5z4cvah-erroi_flwnjn2ik.png"></p><br><pre> <code class="plaintext hljs">/ip route add distance=1 gateway=172.17.0.1@main routing-mark=vrf1 add distance=1 gateway=172.17.0.1%wlan1 routing-mark=vrf2</code> </pre> <br><p> <em>    route leaking:   : <code>172.17.0.1@main</code>    : <code>172.17.0.1%wlan1</code> .</em> </p><br><p>        <code>[PREROUTING|Mangle]</code> : <br><img src="https://habrastorage.org/webt/ge/w3/pa/gew3paz7vdzqkzc0-pt0mz5b6yg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting in-interface=ether1 action=mark-connection new-connection-mark=from-vrf1 passthrough=no add chain=prerouting connection-mark=from-vrf1 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting in-interface=ether2 action=mark-connection new-connection-mark=from-vrf2 passthrough=no add chain=prerouting connection-mark=from-vrf2 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/i8/dd/kx/i8ddkxzzdogtht7gvzyo-rzcr-g.png"></p><br><p> <strong>   </strong> <br>            VRF  netmap: <br><img src="https://habrastorage.org/webt/yl/vx/kb/ylvxkbg-tyalsczpx9datttwgs0.png"></p><br><p>  : </p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 add address=192.168.0.1/24 interface=ether3 network=192.168.0.0</code> </pre> <br><p>  firewall: </p><br><pre> <code class="plaintext hljs">#        /ip firewall mangle add chain=prerouting dst-address=192.168.101.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting dst-address=192.168.102.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf2 passthrough=no # netmap   ""     /ip firewall nat add chain=dstnat dst-address=192.168.101.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24 add chain=dstnat dst-address=192.168.102.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">#      route leaking,       connected  /ip route add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf1 add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf2</code> </pre> <br><p> <strong>    dhcp    </strong> <br> VRF   ,       (  dhcp client)    . </p><br><p>    vrf: </p><br><pre> <code class="plaintext hljs">/ip route vrf add interface=ether1 routing-mark=over-isp1</code> </pre> <br><p>     (  )   <em>over-isp1</em> : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output out-interface=!br-lan action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting in-interface=br-lan dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 passthrough=no</code> </pre> <br><p> ,      : </p><br><pre> <code class="plaintext hljs">/interface bridge add name=bare /ip route add dst-address=0.0.0.0/0 gateway=bare</code> </pre> <br><p>            Routing decision (2)  <code>[OUTPUT|Mangle]</code>    ,         0.0.0.0/0   main   . <br><img src="https://habrastorage.org/webt/ff/p-/qh/ffp-qhi41y5wxswp6wzrtp69bjk.png"></p><br><h3 id="cepochki-connected-in-i-dynamic-in-v-routing---filters">  <code>connected-in</code>  <code>dynamic-in</code>  <code>[Routing] -&gt; [Filters]</code> </h3><br><p>   (  ) —           (      <em>routing</em> ),        : </p><br><ul><li> connected-in —  connected  </li><li> dynamic-in —     PPP  DCHP </li></ul><br><p>      ,     : distance, routing-mark, comment, scope, target scope, ... </p><br><p>         -  Routing Filters (  ),    Routing Filters,           .     Routing Filters      . </p><br><p> <strong> Routing Mark   </strong> <br>    .     VPN            .     -      : </p><br><pre> <code class="plaintext hljs">#  vpn    default route    /interface pptp-client add connect-to=XXXX add-default-route=yes default-route-distance=101 ... add connect-to=YYYY add-default-route=yes default-route-distance=100 ... #             /routing filter add chain=dynamic-in distance=100 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn1 add chain=dynamic-in distance=101 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn2</code> </pre> <br><p> <em>  ,  ,    vrf  ppp ,    0.0.0.0/0     main.      .</em> </p><br><p> <strong> Connected </strong> <br>    : </p><br><pre> <code class="plaintext hljs">/route filter add chain=connected-in prefix=192.168.100.0/24 action=reject</code> </pre> <br><h3 id="instrumenty-otladki">   </h3><br><p> RouterOS      : </p><br><ul><li> <code>[Tool]-&gt;[Torch]</code> —      </li><li> <code>/ip route check</code> —        ,      </li><li> <code>/ping routing-table=&lt;name&gt;</code>  <code>/tool traceroute routing-table=&lt;name&gt;</code> — ping       </li><li> <code>action=log</code>  <code>[IP]-&gt;[Firewall]</code> —  ,       packet flow,         </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN443788/">https://habr.com/ru/post/zh-CN443788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN443774/index.html">神经生物学如何干预美国总统大选</a></li>
<li><a href="../zh-CN443776/index.html">中国在购买地铁时引入了实验性面部识别系统</a></li>
<li><a href="../zh-CN443780/index.html">MCDM项目。 第1部分。概念</a></li>
<li><a href="../zh-CN443782/index.html">开发人员现在可以在他们的Steam游戏中使用Valve的网络API</a></li>
<li><a href="../zh-CN443786/index.html">在莫斯科Mobius 2018的HeadHunter展台分析第二届Android测验竞赛</a></li>
<li><a href="../zh-CN443790/index.html">幸存者的错误</a></li>
<li><a href="../zh-CN443792/index.html">使用PostgreSQL时的典型错误。 第二部分</a></li>
<li><a href="../zh-CN443794/index.html">房地产销售领域中IT初创公司的主要方向</a></li>
<li><a href="../zh-CN443798/index.html">Zotero hacks：无限的同步存储及其与rmarkdown的平滑使用</a></li>
<li><a href="../zh-CN443804/index.html">C＃是低级语言吗？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>