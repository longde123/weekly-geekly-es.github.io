<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ”Š ğŸ¬ ğŸ‘ğŸ¾ Mikrotik RouterOSä¸­é™æ€è·¯ç”±çš„åŸºç¡€ ğŸ™‹ğŸ½ â° ğŸ›’</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è·¯ç”±æ˜¯ä¸ºTCP / IPç½‘ç»œä¸Šçš„æ•°æ®åŒ…ä¼ è¾“æ‰¾åˆ°æœ€ä½³è·¯å¾„çš„è¿‡ç¨‹ã€‚ è¿æ¥åˆ°IPv4ç½‘ç»œçš„ä»»ä½•è®¾å¤‡éƒ½åŒ…å«ä¸€ä¸ªè¿›ç¨‹è¡¨å’Œè·¯ç”±è¡¨ã€‚ 


 æœ¬æ–‡ä¸æ˜¯HOWTOï¼Œè€Œæ˜¯ä»¥RouterOSä¸­çš„é™æ€è·¯ç”±ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œæˆ‘æœ‰æ„çœç•¥äº†å…¶ä½™è®¾ç½®ï¼ˆä¾‹å¦‚ï¼Œç”¨äºè®¿é—®Internetçš„srcnatï¼‰ï¼Œå› æ­¤ç†è§£æ­¤ææ–™éœ€è¦ä¸€å®šç¨‹åº¦çš„ç½‘ç»œå’Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mikrotik RouterOSä¸­é™æ€è·¯ç”±çš„åŸºç¡€</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443788/"><p> è·¯ç”±æ˜¯ä¸ºTCP / IPç½‘ç»œä¸Šçš„æ•°æ®åŒ…ä¼ è¾“æ‰¾åˆ°æœ€ä½³è·¯å¾„çš„è¿‡ç¨‹ã€‚ è¿æ¥åˆ°IPv4ç½‘ç»œçš„ä»»ä½•è®¾å¤‡éƒ½åŒ…å«ä¸€ä¸ªè¿›ç¨‹è¡¨å’Œè·¯ç”±è¡¨ã€‚ </p><br><p> æœ¬æ–‡ä¸æ˜¯HOWTOï¼Œè€Œæ˜¯ä»¥RouterOSä¸­çš„é™æ€è·¯ç”±ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œæˆ‘æœ‰æ„çœç•¥äº†å…¶ä½™è®¾ç½®ï¼ˆä¾‹å¦‚ï¼Œç”¨äºè®¿é—®Internetçš„srcnatï¼‰ï¼Œå› æ­¤ç†è§£æ­¤ææ–™éœ€è¦ä¸€å®šç¨‹åº¦çš„ç½‘ç»œå’ŒRouterOSçŸ¥è¯†ã€‚ </p><a name="habracut"></a><br><h3 id="kommutaciya-i-marshrutizaciya"> äº¤æ¢ä¸è·¯ç”± </h3><br><p><img src="https://habrastorage.org/webt/5v/h7/a2/5vh7a2relrje9g9e5kbonuogsqw.png"></p><br><p> äº¤æ¢æ˜¯åœ¨ä¸€ä¸ªLayer2ç½‘æ®µï¼ˆä»¥å¤ªç½‘ï¼Œpppç­‰ï¼‰å†…äº¤æ¢æ•°æ®åŒ…çš„è¿‡ç¨‹ã€‚ å¦‚æœè®¾å¤‡å‘ç°æ•°æ®åŒ…æ¥æ”¶è€…ä¸å®ƒåŸæ¥åœ¨åŒä¸€ä»¥å¤ªç½‘å­ç½‘ä¸Šï¼Œåˆ™å®ƒä¼šä½¿ç”¨arpåè®®è¯†åˆ«macåœ°å€ï¼Œå¹¶ç»•è¿‡è·¯ç”±å™¨ç›´æ¥å‘é€æ•°æ®åŒ…ã€‚  pppï¼ˆç‚¹å¯¹ç‚¹ï¼‰è¿æ¥åªèƒ½æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œå¹¶ä¸”æ•°æ®åŒ…å§‹ç»ˆå‘é€åˆ°ç›¸åŒçš„0xffåœ°å€ã€‚ </p><br><p> è·¯ç”±æ˜¯åœ¨ç¬¬2å±‚ç½‘æ®µä¹‹é—´ä¼ è¾“æ•°æ®åŒ…çš„è¿‡ç¨‹ã€‚ å¦‚æœè®¾å¤‡è¦å‘é€æ•°æ®åŒ…ï¼ˆå…¶æ¥æ”¶è€…åœ¨ä»¥å¤ªç½‘æ®µä¹‹å¤–ï¼‰ï¼Œåˆ™ä¼šæŸ¥çœ‹å…¶è·¯ç”±è¡¨ï¼Œç„¶åå°†æ•°æ®åŒ…ä¼ é€’ç»™ç½‘å…³ï¼Œè¯¥ç½‘å…³çŸ¥é“è¿›ä¸€æ­¥å‘ä½•å¤„å‘é€æ•°æ®åŒ…ï¼ˆæˆ–è€…å¯èƒ½ä¸çŸ¥é“ï¼Œæ•°æ®åŒ…çš„åŸå§‹å‘é€è€…å¹¶ä¸çŸ¥é“è¿™ä¸€ç‚¹ï¼‰ã€‚ </p><br><p> è€ƒè™‘è·¯ç”±å™¨çš„æœ€ç®€å•æ–¹æ³•æ˜¯å°†å…¶ä½œä¸ºè¿æ¥åˆ°ä¸¤ä¸ªæˆ–å¤šä¸ªLayer2ç½‘æ®µå¹¶èƒ½å¤Ÿåœ¨å®ƒä»¬ä¹‹é—´ä¼ è¾“æ•°æ®åŒ…çš„è®¾å¤‡ï¼Œä»è€Œä»è·¯ç”±è¡¨ä¸­ç¡®å®šæœ€ä½³è·¯ç”±ã€‚ </p><br><p> å¦‚æœä¸€åˆ‡å¯¹æ‚¨éƒ½æ¸…æ¥šæˆ–æ‚¨å·²ç»çŸ¥é“ï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚ æˆ‘å¼ºçƒˆå»ºè®®å…¶ä»–äººé˜…è¯»ä¸€ç¯‡ç®€çŸ­ä½†éå¸¸å…¨é¢çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a> ã€‚ </p><br><h3 id="marshrutizaciya-v-routeros-i-packetflow"> åœ¨RouterOSå’ŒPacketFlowä¸­è¿›è¡Œè·¯ç”± </h3><br><p> å‡ ä¹æ‰€æœ‰ä¸é™æ€è·¯ç”±ç›¸å…³çš„åŠŸèƒ½éƒ½åœ¨<em>ç³»ç»Ÿ</em>è½¯ä»¶åŒ…ä¸­ã€‚  <em>è·¯ç”±</em>åŒ…å¢åŠ äº†å¯¹åŠ¨æ€è·¯ç”±ç®—æ³•ï¼ˆRIPï¼ŒOSPFï¼ŒBGPï¼ŒMMEï¼‰ï¼Œè·¯ç”±è¿‡æ»¤å™¨å’ŒBFDçš„æ”¯æŒã€‚ </p><br><p>ç”¨äºé…ç½®è·¯ç”±çš„ä¸»èœå•ï¼š <code>[IP]-&gt;[Route]</code> ã€‚ å¤æ‚çš„æ–¹æ¡ˆå¯èƒ½éœ€è¦åœ¨<code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code>ä½¿ç”¨è·¯ç”±æ ‡ç­¾å¯¹æ•°æ®åŒ…è¿›è¡Œåˆæ­¥æ ‡ç­¾ï¼ˆ <code>PREROUTING</code>å’Œ<code>OUTPUT</code>é“¾ï¼‰ã€‚ </p><br><p>  PacketFlowä¸Šæœ‰ä¸‰ä¸ªåœ°æ–¹å¯ä»¥å†³å®šè·¯ç”±IPæ•°æ®åŒ…ï¼š <br><img src="https://habrastorage.org/webt/pk/ie/mp/pkiempktzjkwz6tcwrnwyl1c1dc.png"></p><br><ol><li> è·¯ç”±å™¨æ”¶åˆ°çš„è·¯ç”±æ•°æ®åŒ…ã€‚ åœ¨æ­¤é˜¶æ®µï¼Œå†³å®šå°†æ•°æ®åŒ…è½¬åˆ°æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯å°†è¿›ä¸€æ­¥å‘é€åˆ°ç½‘ç»œã€‚ ä¼ è¾“æ•°æ®åŒ…æ¥æ”¶<em>è¾“å‡ºæ¥å£</em> </li><li> è·¯ç”±æœ¬åœ°ä¼ å‡ºæ•°æ®åŒ…ã€‚ ä¼ å‡ºæ•°æ®åŒ…æ¥æ”¶<em>è¾“å‡ºæ¥å£</em> </li><li> ä¼ å‡ºæ•°æ®åŒ…çš„é™„åŠ è·¯ç”±æ­¥éª¤ä½¿æ‚¨å¯ä»¥åœ¨<code>[Output|Mangle]</code>æ›´æ”¹è·¯ç”±å†³ç­–ã€‚ </li></ol><br><ul><li> å—1ã€2ä¸­çš„æ•°æ®åŒ…è·¯å¾„å–å†³äº<code>[IP]-&gt;[Route]</code>çš„è§„åˆ™ </li><li> æ­¥éª¤1ã€2å’Œ3ä¸­çš„æ•°æ®åŒ…è·¯å¾„å–å†³äº<code>[IP]-&gt;[Route]-&gt;[Rules]</code> </li><li> å¯ä»¥ä½¿ç”¨<code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code>å½±å“å—1ã€3ä¸­çš„æ•°æ®åŒ…è·¯å¾„ã€‚ </li></ul><br><h3 id="rib-fib-routing-cache">  RIBï¼ŒFIBï¼Œè·¯ç”±ç¼“å­˜ </h3><br><p><img src="https://habrastorage.org/webt/fw/jc/ku/fwjckuzqzyxo4udazveb8uhotuq.png"></p><br><p>  <strong>è·¯ç”±ä¿¡æ¯åº“</strong> <br> æ”¶é›†æ¥è‡ªåŠ¨æ€è·¯ç”±åè®®çš„è·¯ç”±ï¼Œæ¥è‡ªpppå’Œdhcpçš„è·¯ç”±ï¼Œé™æ€å’Œè¿æ¥çš„è·¯ç”±çš„åŸºç¡€ã€‚ è¯¥æ•°æ®åº“åŒ…å«é™¤ç®¡ç†å‘˜è¿‡æ»¤çš„è·¯ç”±ä»¥å¤–çš„æ‰€æœ‰è·¯ç”±ã€‚ </p><br><p>  <em>æŒ‰ç…§æƒ¯ä¾‹</em> ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾<code>[IP]-&gt;[Route]</code>æ˜¾ç¤ºRIBã€‚ </p><br><p>  <strong>è½¬å‘ä¿¡æ¯åº“</strong> <br><img src="https://habrastorage.org/webt/kt/jn/q1/ktjnq1ebrd0--d9afkseuixtap8.png"></p><br><p> ä»RIBå‡ºå‘çš„æœ€ä½³èˆªçº¿è·¯çº¿æ‰€ä¾æ®çš„åŸºåœ°ã€‚  FIBä¸­çš„æ‰€æœ‰è·¯ç”±å‡å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶ç”¨äºè½¬å‘æ•°æ®åŒ…ã€‚ å¦‚æœè·¯ç”±å˜ä¸ºéæ´»åŠ¨çŠ¶æ€ï¼ˆç”±ç®¡ç†å‘˜ï¼ˆç³»ç»Ÿï¼‰ç¦ç”¨ï¼Œæˆ–è€…åº”è¯¥é€šè¿‡å…¶å‘é€æ•°æ®åŒ…çš„æ¥å£å¤„äºéæ´»åŠ¨çŠ¶æ€ï¼‰ï¼Œåˆ™ä¼šä»FIBä¸­åˆ é™¤è¯¥è·¯ç”±ã€‚ </p><br><p> ä¸ºäº†ç¡®å®šè·¯ç”±ï¼Œåœ¨FIBè¡¨ä¸­ä½¿ç”¨ä»¥ä¸‹IPæ•°æ®åŒ…æ•°æ®ï¼š </p><br><ul><li> æºåœ°å€ </li><li> ç›®çš„åœ°å€ </li><li> æºæ¥å£ </li><li> è·¯ç”±æ ‡è®° </li><li> æœåŠ¡æ¡æ¬¾ï¼ˆDSCPï¼‰ </li></ul><br><p> è¿›å…¥FIBè½¯ä»¶åŒ…éœ€è¦ç»å†ä»¥ä¸‹é˜¶æ®µï¼š </p><br><ul><li> è½¯ä»¶åŒ…æ˜¯ä¸ºæœ¬åœ°è·¯ç”±å™¨è¿›ç¨‹è®¾è®¡çš„å—ï¼Ÿ </li><li> è½¯ä»¶åŒ…æ˜¯å¦å±äºPBRç³»ç»Ÿæˆ–ç”¨æˆ·è§„åˆ™ï¼Ÿ <br><ul><li> å¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™å°†æ•°æ®åŒ…å‘é€åˆ°æŒ‡å®šçš„è·¯ç”±è¡¨ã€‚ </li></ul></li><li> æ•°æ®åŒ…å‘é€åˆ°ä¸»è¡¨ </li></ul><br><p>  <em>æŒ‰ç…§æƒ¯ä¾‹</em> ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾<code>[IP]-&gt;[Route Active=yes]</code>æ˜¾ç¤ºFIBã€‚ </p><br><p>  <strong>è·¯ç”±ç¼“å­˜</strong> <br> è·¯ç”±ç¼“å­˜æœºåˆ¶ã€‚ è·¯ç”±å™¨ä¼šè®°ä½æ•°æ®åŒ…çš„å‘é€ä½ç½®ï¼Œå¦‚æœæœ‰ç›¸ä¼¼çš„æ•°æ®åŒ…ï¼ˆå¤§æ¦‚æ¥è‡ªåŒä¸€è¿æ¥ï¼‰ï¼Œå®ƒå°†æ²¿ç€ç›¸åŒçš„è·¯ç”±å¯åŠ¨å®ƒä»¬ï¼Œè€Œæ— éœ€æ£€æŸ¥FIBã€‚ å®šæœŸæ¸…é™¤è·¯ç”±ç¼“å­˜ã€‚ </p><br><p> å¯¹äºç®¡ç†å‘˜æ¥è¯´ï¼ŒRouterOSæ²¡æœ‰æŸ¥çœ‹å’Œç®¡ç†è·¯ç”±ç¼“å­˜çš„æ–¹æ³•ï¼Œä½†æ˜¯æœ‰äº†å®ƒï¼Œæ‚¨å¯ä»¥åœ¨<code>[IP]-&gt;[Settings]</code>ä¸­å°†å…¶ç¦ç”¨ã€‚ </p><br><p>  <em>æ­¤æœºåˆ¶å·²ä»Linux 3.6å†…æ ¸ä¸­åˆ é™¤ï¼Œä½†æ˜¯RouterOSä»ä½¿ç”¨å†…æ ¸3.3.5ï¼Œå¯èƒ½æ˜¯è·¯ç”±ç¼“å­˜æ˜¯åŸå› ä¹‹ä¸€ã€‚</em> </p><br><h3 id="dialog-dobavleniya-marshruta"> è·¯çº¿æ·»åŠ å¯¹è¯æ¡† </h3><br><p> <code>[IP]-&gt;[Route]-&gt;[+]</code> <br> <img src="https://habrastorage.org/webt/th/lb/el/thlbel_kvf2gk-s2125imh_z7cg.png"></p><br><ol><li> è¦ä¸ºå…¶åˆ›å»ºè·¯ç”±çš„å­ç½‘ï¼ˆé»˜è®¤å€¼ï¼š0.0.0.0/0ï¼‰ </li><li> æ•°æ®åŒ…å°†å‘é€åˆ°çš„ç½‘å…³IPæˆ–æ¥å£ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼Œè¯·å‚é˜…ä¸‹é¢çš„ECMPï¼‰ </li><li> æ£€æŸ¥ç½‘å…³å¯ç”¨æ€§ </li><li> è®°å½•ç±»å‹ </li><li> è·¯çº¿è·ç¦»ï¼ˆå…¬åˆ¶ï¼‰ </li><li> è·¯ç”±è¡¨ </li><li> é€šè¿‡æ­¤è·¯ç”±çš„æœ¬åœ°å‡ºç«™æ•°æ®åŒ…çš„IP </li><li> èŒƒå›´çš„ç›®çš„å’Œç›®æ ‡èŒƒå›´å†™åœ¨æœ¬æ–‡çš„æœ«å°¾ã€‚ </li></ol><br><p>  <strong>è·¯çº¿æ ‡å¿—</strong> <br><img src="https://habrastorage.org/webt/ai/ro/iv/airoivo1bmk3lgbqj_hivpbjdyc.png"></p><br><ul><li>  X-è·¯ç”±è¢«ç®¡ç†å‘˜<code>disabled=yes</code> ï¼ˆ <code>disabled=yes</code> ï¼‰ </li><li>  A-è·¯ç”±ç”¨äºä¼ è¾“æ•°æ®åŒ…ã€‚ </li><li>  D-åŠ¨æ€æ·»åŠ çš„è·¯ç”±ï¼ˆBGPï¼ŒOSPFï¼ŒRIPï¼ŒMMEï¼ŒPPPï¼ŒDHCPï¼Œå·²è¿æ¥ï¼‰ </li><li>  C-å­ç½‘ç›´æ¥è¿æ¥åˆ°è·¯ç”±å™¨ </li><li>  S-é™æ€è·¯çº¿ </li><li>  rï¼Œbï¼Œoï¼Œm-è·¯ç”±æ˜¯ç”±ä¸€ç§åŠ¨æ€è·¯ç”±åè®®æ·»åŠ çš„ </li><li>  Bï¼ŒUï¼ŒP-è¿‡æ»¤è·¯ç”±ï¼ˆä¸¢å¼ƒæ•°æ®åŒ…è€Œä¸æ˜¯å‘é€æ•°æ®åŒ…ï¼‰ </li></ul><br><h3 id="chto-ukazyvat-v-gateway-ip-adres-ili-interfeys"> åœ¨ç½‘å…³ä¸­æŒ‡å®šä»€ä¹ˆï¼šipåœ°å€æˆ–æ¥å£ï¼Ÿ </h3><br><p> è¯¥ç³»ç»Ÿå…è®¸æ‚¨åŒæ—¶æŒ‡å®šå®ƒä»¬ä¸¤è€…ï¼Œä½†ä¸ä¼šå‘èª“ï¼Œå¹¶ä¸”å¦‚æœåšé”™äº†äº‹ä¹Ÿä¸ä¼šç»™å‡ºæç¤ºã€‚ </p><br><p>  <strong>IPåœ°å€</strong> <br> ç½‘å…³åœ°å€å¿…é¡»å¯ä»¥é€šè¿‡Layer2è®¿é—®ã€‚ å¯¹äºä»¥å¤ªç½‘ï¼Œè¿™æ„å‘³ç€è·¯ç”±å™¨å¿…é¡»åœ¨æ´»åŠ¨æ¥å£ä¹‹ä¸€ä¸Šå…·æœ‰æ¥è‡ªåŒä¸€å­ç½‘çš„IPåœ°å€ï¼Œå¯¹äºppp-ç½‘å…³åœ°å€åœ¨æ´»åŠ¨æ¥å£ä¹‹ä¸€ä¸Šåˆ—ä¸ºå­ç½‘åœ°å€ã€‚ <br> å¦‚æœä¸æ»¡è¶³ç¬¬2å±‚çš„å¯ç”¨æ€§æ¡ä»¶ï¼Œåˆ™è¯¥è·¯ç”±è¢«è®¤ä¸ºæ˜¯ä¸æ´»åŠ¨çš„ï¼Œå¹¶ä¸”ä¸å±äºFIBã€‚ </p><br><p>  <strong>ä»‹é¢</strong> <br> ä¸€åˆ‡éƒ½æ›´åŠ å¤æ‚ï¼Œè·¯ç”±å™¨çš„è¡Œä¸ºå–å†³äºæ¥å£çš„ç±»å‹ï¼š </p><br><ul><li>  PPPï¼ˆå¼‚æ­¥ï¼ŒPPTPï¼ŒL2TPï¼ŒSSTPï¼ŒPPPoEï¼ŒOpenVPN *ï¼‰å‡å®šè¿æ¥åªæœ‰ä¸¤ä¸ªå‚ä¸è€…ï¼Œå¹¶ä¸”æ•°æ®åŒ…å°†å§‹ç»ˆå‘é€åˆ°ç½‘å…³è¿›è¡Œä¼ è¾“ï¼Œå¦‚æœç½‘å…³æ£€æµ‹åˆ°å®ƒæ˜¯æ¥æ”¶è€…æœ¬èº«ï¼Œå®ƒå°†æŠŠæ•°æ®åŒ…ä¼ è¾“åˆ°å…¶æœ¬åœ°è¿›ç¨‹ã€‚ <br><img src="https://habrastorage.org/webt/90/-g/xk/90-gxkgtlplrv8sstcs4r70bxx4.png"></li><li> ä»¥å¤ªç½‘å‡å®šæœ‰å¾ˆå¤šå‚ä¸è€…ï¼Œå¹¶ä¸”å°†ä½¿ç”¨æ•°æ®åŒ…æ¥æ”¶å™¨çš„åœ°å€å‘arpæ¥å£å‘é€è¯·æ±‚ï¼Œè¿™æ˜¯æ‰€è¿æ¥è·¯ç”±çš„æ­£å¸¸é¢„æœŸè¡Œä¸ºã€‚ <br> ä½†æ˜¯ï¼Œå½“æ‚¨å°è¯•å°†æ¥å£ç”¨ä½œè¿œç¨‹å­ç½‘çš„è·¯ç”±æ—¶ï¼Œä¼šé‡åˆ°ä»¥ä¸‹æƒ…å†µï¼šè·¯ç”±å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œpingä¼ é€’åˆ°ç½‘å…³ï¼Œä½†æœªä»æŒ‡å®šçš„å­ç½‘åˆ°è¾¾æ”¶ä»¶äººã€‚ å¦‚æœé€šè¿‡å—…æ¢å™¨æŸ¥çœ‹æ¥å£ï¼Œåˆ™ä¼šçœ‹åˆ°å¸¦æœ‰æ¥è‡ªè¿œç¨‹å­ç½‘åœ°å€çš„arpè¯·æ±‚ã€‚ <br><img src="https://habrastorage.org/webt/62/si/qp/62siqpa8gbtxi-8x4eymxgv19vi.png"></li></ul><br><p><img src="https://habrastorage.org/webt/i6/-n/nb/i6-nnbyrlylq0jk6pqwefb_2qz8.png"></p><br><p> å°½å¯èƒ½å°è¯•å°†IPåœ°å€æŒ‡å®šä¸ºç½‘å…³ã€‚ ä¾‹å¤–æ˜¯è¿æ¥çš„è·¯ç”±ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰å’ŒPPPï¼ˆå¼‚æ­¥ï¼ŒPPTPï¼ŒL2TPï¼ŒSSTPï¼ŒPPPoEï¼ŒOpenVPN *ï¼‰æ¥å£ã€‚ </p><br><p>  <em>OpenVPNä¸åŒ…å«PPPæ ‡å¤´ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨OpenVPNæ¥å£åç§°æ¥åˆ›å»ºè·¯ç”±ã€‚</em> </p><br><h3 id="more-specific-route"> æ›´å…·ä½“çš„è·¯çº¿ </h3><br><p> è·¯ç”±çš„åŸºæœ¬è§„åˆ™ã€‚ åœ¨ç¡®å®šæ•°æ®åŒ…è·¯ç”±æ—¶ï¼Œæè¿°è¾ƒå°å­ç½‘ï¼ˆå…·æœ‰æœ€å¤§å­ç½‘æ©ç ï¼‰çš„è·¯ç”±å…·æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚ æ¡ç›®åœ¨è·¯ç”±è¡¨ä¸­çš„ä½ç½®ä¸é€‰æ‹©æ— å…³-åŸºæœ¬è§„åˆ™æ˜¯â€œæ›´å…·ä½“â€ã€‚ </p><br><p><img src="https://habrastorage.org/webt/sm/cy/i9/smcyi9gkebkm8iq-yjcbev8-vs0.png"></p><br><p> æŒ‡å®šæ–¹æ¡ˆä¸­çš„æ‰€æœ‰è·¯ç”±å‡å¤„äºæ´»åŠ¨çŠ¶æ€ï¼ˆä½äºFIBä¸­ï¼‰ï¼Œå› ä¸º æŒ‡å‘ä¸åŒçš„å­ç½‘å¹¶ä¸”ä¸ä¼šç›¸äº’å†²çªã€‚ </p><br><p> å¦‚æœå…¶ä¸­ä¸€ä¸ªç½‘å…³ä¸å¯ç”¨ï¼Œåˆ™å…³è”çš„è·¯ç”±å°†è¢«è§†ä¸ºä¸æ´»åŠ¨ï¼ˆå·²ä»FIBåˆ é™¤ï¼‰ï¼Œå¹¶ä¸”å°†ä»å…¶ä½™è·¯ç”±ä¸­æœç´¢æ•°æ®åŒ…ã€‚ </p><br><p> å­ç½‘ä¸º0.0.0.0/0çš„è·¯ç”±æœ‰æ—¶å…·æœ‰ç‰¹æ®Šçš„æ„ä¹‰ï¼Œç§°ä¸ºâ€œé»˜è®¤è·¯ç”±â€æˆ–â€œæœ€åçš„ç½‘å…³â€ã€‚ å®é™…ä¸Šï¼Œå®ƒæ²¡æœ‰ä»€ä¹ˆç¥å¥‡çš„åŠŸèƒ½ï¼Œå®ƒä»…åŒ…å«æ‰€æœ‰å¯èƒ½çš„IPv4åœ°å€ï¼Œä½†æ˜¯è¿™äº›åç§°å¾ˆå¥½åœ°æè¿°äº†å…¶ç›®çš„-å®ƒæŒ‡ç¤ºç½‘å…³ï¼Œåœ¨è¯¥ç½‘å…³å¤„è½¬å‘æ²¡æœ‰å…¶ä»–æ›´å‡†ç¡®è·¯ç”±çš„æ•°æ®åŒ…ã€‚ </p><br><p>  IPv4çš„æœ€å¤§å¯èƒ½å­ç½‘æ©ç ä¸º/ 32ï¼›æ­¤è·¯ç”±æŒ‡å‘ç‰¹å®šä¸»æœºï¼Œå¯ä»¥åœ¨è·¯ç”±è¡¨ä¸­ä½¿ç”¨ã€‚ </p><br><p>  <em>äº†è§£æ›´ç‰¹å®šçš„è·¯ç”±æ˜¯ä»»ä½•TCP / IPè®¾å¤‡çš„åŸºç¡€ã€‚</em> </p><br><h3 id="distance"> è·ç¦» </h3><br><p> è·ç¦»ï¼ˆæˆ–åº¦é‡ï¼‰æ˜¯å¯¹é€šè¿‡å¤šä¸ªç½‘å…³å¯è®¿é—®çš„ä¸€ä¸ªå­ç½‘çš„è·¯ç”±è¿›è¡Œç®¡ç†æ€§è¿‡æ»¤æ‰€å¿…éœ€çš„ã€‚ åº¦é‡å€¼è¾ƒä½çš„è·¯ç”±è¢«è®¤ä¸ºæ˜¯ä¼˜å…ˆçº§ï¼Œå°†åœ¨FIBä¸­ã€‚ å¦‚æœå…·æœ‰è¾ƒä½åº¦é‡æ ‡å‡†çš„è·¯ç”±åœæ­¢æ´»åŠ¨ï¼Œåˆ™åœ¨FIBä¸­å®ƒå°†è¢«å…·æœ‰è¾ƒé«˜åº¦é‡æ ‡å‡†çš„è·¯ç”±æ›¿æ¢ã€‚ <br><img src="https://habrastorage.org/webt/dz/yz/mh/dzyzmhb2y_fjqpbkbp2juyhfxsi.png"></p><br><p> å¦‚æœæœ‰å¤šä¸ªå…·æœ‰ç›¸åŒåº¦é‡æ ‡å‡†çš„é€šå¾€åŒä¸€å­ç½‘çš„è·¯ç”±ï¼Œåˆ™è·¯ç”±å™¨å°†åœ¨å…¶å†…éƒ¨é€»è¾‘çš„æŒ‡å¯¼ä¸‹ä»…å°†å…¶ä¸­ä¸€æ¡æ·»åŠ åˆ°FIBè¡¨ä¸­ã€‚ </p><br><p> æŒ‡æ ‡çš„å–å€¼èŒƒå›´æ˜¯0åˆ°255ï¼š <br><img src="https://habrastorage.org/webt/rh/fk/j1/rhfkj1shnnjhqmvwhcc7o0itq8i.png"></p><br><ul><li>  0-æ‰€è¿æ¥è·¯ç”±çš„åº¦é‡ã€‚ ç®¡ç†å‘˜æ— æ³•è®¾ç½®è·ç¦»0 </li><li>  1-254-ç®¡ç†å‘˜å¯ç”¨äºè®¾ç½®è·¯ç”±çš„åº¦é‡ã€‚ å€¼è¾ƒä½çš„æŒ‡æ ‡ä¼˜å…ˆã€‚ </li><li>  255-ç®¡ç†å‘˜å¯ç”¨äºè®¾ç½®è·¯ç”±çš„åº¦é‡ã€‚ ä¸1-254ä¸åŒï¼Œåº¦é‡å€¼ä¸º255çš„è·¯ç”±å§‹ç»ˆä¿æŒä¸æ´»åŠ¨çŠ¶æ€ï¼Œå¹¶ä¸”ä¸å±äºFIB </li><li> ç‰¹æ®ŠæŒ‡æ ‡ã€‚ ä»åŠ¨æ€è·¯ç”±åè®®æ¥æ”¶çš„è·¯ç”±å…·æœ‰æ ‡å‡†åº¦é‡å€¼ </li></ul><br><h3 id="check-gateway"> æ£€æŸ¥ç½‘å…³ </h3><br><p> æ£€æŸ¥ç½‘å…³-MikroTik RoutesOSæ‰©å±•ï¼Œç”¨äºé€šè¿‡icmpæˆ–arpæ£€æŸ¥ç½‘å…³çš„å¯ç”¨æ€§ã€‚ æ¯10ç§’ä¸€æ¬¡ï¼ˆæ— æ³•æ›´æ”¹ï¼‰ï¼Œä¸€ä¸ªè¯·æ±‚å°†å‘é€åˆ°ç½‘å…³ï¼Œå¦‚æœæ²¡æœ‰ä¸¤æ¬¡å›ç­”ï¼Œåˆ™è®¤ä¸ºè¯¥è·¯ç”±ä¸å¯ç”¨ï¼Œå¹¶å°†å…¶ä»FIBä¸­åˆ é™¤ã€‚ å¦‚æœæ£€æŸ¥ç½‘å…³ç¦ç”¨äº†éªŒè¯è·¯ç”±ï¼Œå®ƒå°†ç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”ä¸€æ¬¡æˆåŠŸçš„æ£€æŸ¥åï¼Œè·¯ç”±å°†å†æ¬¡å˜ä¸ºæ´»åŠ¨çŠ¶æ€ã€‚ <br><img src="https://habrastorage.org/webt/a_/km/vd/a_kmvd8xeoeyrnjqz78ciry1ja4.png"></p><br><p> æ£€æŸ¥ç½‘å…³ä¼šç¦ç”¨é…ç½®ç½‘å…³çš„æ¡ç›®ä»¥åŠæŒ‡å®šç½‘å…³çš„æ‰€æœ‰å…¶ä»–æ¡ç›®ï¼ˆåœ¨æ‰€æœ‰è·¯ç”±è¡¨å’Œecmpè·¯ç”±ä¸­ï¼‰ã€‚ </p><br><p> é€šå¸¸ï¼Œå¦‚æœç½‘å…³çš„æ•°æ®åŒ…ä¸¢å¤±æ²¡æœ‰é—®é¢˜ï¼Œåˆ™æ£€æŸ¥ç½‘å…³å¯ä»¥æ­£å¸¸å·¥ä½œã€‚  Checkç½‘å…³ä¸çŸ¥é“åœ¨è¢«æ£€æŸ¥ç½‘å…³å¤–éƒ¨è¿›è¡Œé€šä¿¡ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå› ä¸ºè¿˜éœ€è¦ä»¥ä¸‹é™„åŠ å·¥å…·ï¼šè„šæœ¬ï¼Œé€’å½’è·¯ç”±ï¼ŒåŠ¨æ€è·¯ç”±åè®®ã€‚ </p><br><p> å¤§å¤šæ•°VPNå’Œéš§é“åè®®éƒ½åŒ…å«ç”¨äºæ£€æŸ¥è¿æ¥æ´»åŠ¨çš„å†…ç½®å·¥å…·ï¼Œå› æ­¤ä¸ºå®ƒä»¬å¯ç”¨æ£€æŸ¥ç½‘å…³æ˜¯ç½‘ç»œå’Œè®¾å¤‡æ€§èƒ½çš„é¢å¤–ï¼ˆä½†å¾ˆå°ï¼‰è´Ÿè½½ã€‚ </p><br><h3 id="ecmp-marshruty">  ECMPè·¯çº¿ </h3><br><p> ç­‰ä»·å¤šè·¯å¾„-ä½¿ç”¨Round Robinç®—æ³•åŒæ—¶ä½¿ç”¨å¤šä¸ªç½‘å…³å°†æ•°æ®åŒ…å‘é€åˆ°æ”¶ä»¶äººã€‚ </p><br><p> ç®¡ç†å‘˜é€šè¿‡ä¸ºä¸€ä¸ªå­ç½‘æŒ‡å®šå¤šä¸ªç½‘å…³æ¥åˆ›å»ºECMPè·¯ç”±ï¼ˆå¦‚æœæœ‰ä¸¤ä¸ªç­‰æ•ˆçš„OSPFè·¯ç”±ï¼Œåˆ™ä¸ºè‡ªåŠ¨åˆ›å»ºï¼‰ã€‚ <br><img src="https://habrastorage.org/webt/4v/gz/yh/4vgzyh240kmasdj186yz2c3ovws.png"></p><br><p>  ECMPç”¨äºå¹³è¡¡ä¸¤ä¸ªé€šé“ä¹‹é—´çš„è´Ÿè½½ï¼Œç†è®ºä¸Šï¼Œå¦‚æœecmpè·¯ç”±ä¸­æœ‰ä¸¤ä¸ªé€šé“ï¼Œåˆ™å¯¹äºæ¯ä¸ªæ•°æ®åŒ…ï¼Œä¼ å‡ºé€šé“éƒ½åº”è¯¥ä¸åŒã€‚ ä½†æ˜¯è·¯ç”±ç¼“å­˜æœºåˆ¶æ²¿ç¬¬ä¸€ä¸ªæ•°æ®åŒ…åˆ°è¾¾çš„è·¯ç”±ä»è¿æ¥å‘é€æ•°æ®åŒ…ï¼Œç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ç§é’ˆå¯¹æ¯ä¸ªè¿æ¥çš„è´Ÿè½½å¹³è¡¡ã€‚ </p><br><p> å¦‚æœç¦ç”¨è·¯ç”±ç¼“å­˜ï¼Œåˆ™ECMPè·¯ç”±ä¸­çš„æ•°æ®åŒ…å°†è¢«æ­£ç¡®åˆ†å‰²ï¼Œä½†æ˜¯NATå­˜åœ¨é—®é¢˜ã€‚  NATè§„åˆ™ä»…å¤„ç†æ¥è‡ªè¿æ¥çš„ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ï¼ˆå…¶ä½™çš„å°†è‡ªåŠ¨å¤„ç†ï¼‰ï¼Œå¹¶ä¸”æƒ…å†µæ˜¯å…·æœ‰ä¸€ä¸ªæºåœ°å€çš„æ•°æ®åŒ…æ¥è‡ªä¸åŒçš„æ¥å£ã€‚ <br><img src="https://habrastorage.org/webt/gj/cw/bl/gjcwblj73dmsczyhyqyuchcpdw0.png"></p><br><p> æ£€æŸ¥ç½‘å…³ï¼ˆRouterOSé”™è¯¯ï¼‰åœ¨ECMPè·¯ç”±ä¸­ä¸èµ·ä½œç”¨ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨åˆ›å»ºå…¶ä»–éªŒè¯è·¯å¾„ï¼Œåˆ™ä¼šç»•å¼€æ­¤é™åˆ¶ï¼Œè¿™å°†ç¦ç”¨ECMPä¸­çš„æ¡ç›®ã€‚ </p><br><h3 id="filtraciya-sredstvami-routing"> è·¯ç”±è¿‡æ»¤ </h3><br><p>  â€œç±»å‹â€é€‰é¡¹ç¡®å®šå¦‚ä½•å¤„ç†è½¯ä»¶åŒ…ï¼š </p><br><ul><li> å•æ’­-å‘é€åˆ°æŒ‡å®šçš„ç½‘å…³ï¼ˆæ¥å£ï¼‰ </li><li> é»‘æ´-ä¸¢åŒ… </li><li> ç¦æ­¢ï¼Œæ— æ³•è®¿é—®-ä¸¢å¼ƒæ•°æ®åŒ…å¹¶å‘å‘é€æ–¹å‘é€icmpæ¶ˆæ¯ </li></ul><br><p> é€šå¸¸ï¼Œå½“æ‚¨éœ€è¦ä»¥é”™è¯¯çš„æ–¹å¼ä¿æŠ¤å‘é€æ•°æ®åŒ…çš„å®‰å…¨æ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨è¿‡æ»¤ï¼Œå½“ç„¶æ‚¨å¯ä»¥é€šè¿‡é˜²ç«å¢™å¯¹å…¶è¿›è¡Œè¿‡æ»¤ã€‚ </p><br><h3 id="para-primerov"> å‡ ä¸ªä¾‹å­ </h3><br><p> ç”¨äºè§£å†³æœ‰å…³è·¯ç”±çš„åŸºæœ¬é—®é¢˜ã€‚ </p><br><p>  <strong>å…¸å‹çš„å®¶ç”¨è·¯ç”±å™¨</strong> <br><img src="https://habrastorage.org/webt/2a/fk/xx/2afkxxlv7lhluitqufsybt3s5pg.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1</code> </pre> <br><ol><li> åˆ°0.0.0.0/0çš„é™æ€è·¯ç”±ï¼ˆé»˜è®¤è·¯ç”±ï¼‰ </li><li> ä¸æä¾›è€…çš„æ¥å£ä¸Šçš„è¿æ¥è·¯ç”± </li><li>  LANæ¥å£ä¸Šçš„è¿æ¥è·¯ç”± </li></ol><br><p>  <strong>å…¸å‹çš„PPPoEå®¶åº­è·¯ç”±å™¨</strong> <br><img src="https://habrastorage.org/webt/im/wn/8p/imwn8pafrqins6erowkhiek2dqa.png"></p><br><ol><li> é™æ€è·¯ç”±åˆ°é»˜è®¤è·¯ç”±ï¼Œè‡ª è¿™åœ¨è¿æ¥å±æ€§ä¸­æŒ‡ç¤º </li><li>  PPPè¿æ¥çš„è¿æ¥è·¯ç”± </li><li>  LANæ¥å£ä¸Šçš„è¿æ¥è·¯ç”± </li></ol><br><p>  <strong>å…·æœ‰ä¸¤ä¸ªæä¾›å•†å’Œå†—ä½™çš„å…¸å‹å®¶åº­è·¯ç”±å™¨</strong> <br><img src="https://habrastorage.org/webt/wq/2a/v0/wq2av0eskridghrj9yroknjz76o.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 distance=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><ol><li> é€šè¿‡å…·æœ‰åº¦é‡æ ‡å‡†1çš„ç¬¬ä¸€ä¸ªæä¾›ç¨‹åºçš„é™æ€è·¯ç”±åˆ°é»˜è®¤è·¯ç”±ï¼Œå¹¶æ£€æŸ¥ç½‘å…³çš„å¯ç”¨æ€§ </li><li> é€šè¿‡å…·æœ‰åº¦é‡æ ‡å‡†2çš„ç¬¬äºŒä¸ªæä¾›ç¨‹åºçš„é™æ€è·¯ç”±åˆ°é»˜è®¤è·¯ç”± </li><li> è¿é€šè·¯çº¿ </li></ol><br><p> åˆ°0.0.0.0/0çš„æµé‡é€šè¿‡10.10.10.1ï¼Œè€Œæ­¤ç½‘å…³å¯ç”¨ï¼Œå¦åˆ™å®ƒå°†åˆ‡æ¢åˆ°10.20.20.1 </p><br><p>  <em>è¿™æ ·çš„æ–¹æ¡ˆå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¿¡é“é¢„ç•™ï¼Œä½†æ˜¯å®ƒä¹Ÿä¸æ˜¯æ²¡æœ‰ç¼ºç‚¹ã€‚</em>  <em>å¦‚æœä¸­æ–­å‘ç”Ÿåœ¨æä¾›å•†çš„ç½‘å…³å¤–éƒ¨ï¼ˆä¾‹å¦‚ï¼Œè¿è¥å•†ç½‘ç»œå†…éƒ¨ï¼‰ï¼Œåˆ™æ‚¨çš„è·¯ç”±å™¨å°†ä¸çŸ¥é“è¯¥ä¸­æ–­ï¼Œå¹¶å°†ç»§ç»­è®¤ä¸ºè¯¥è·¯ç”±å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚</em> </p><br><p>  <strong>å…¸å‹çš„å®¶ç”¨è·¯ç”±å™¨å…·æœ‰ä¸¤ä¸ªæä¾›ç¨‹åºï¼Œå†—ä½™å’ŒECMP</strong> <br><img src="https://habrastorage.org/webt/un/fj/aw/unfjawyzmjdzo6_ekmmg93vlsk8.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1,10.20.20.1 distance=1</code> </pre> <br><ol><li> æ£€æŸ¥Chackç½‘å…³çš„é™æ€è·¯ç”± </li><li>  ECMPè·¯çº¿ </li><li> è¿é€šè·¯çº¿ </li></ol><br><p> ç”¨äºæ£€æŸ¥è“è‰²çš„è·¯ç”±ï¼ˆéæ´»åŠ¨è·¯ç”±çš„é¢œè‰²ï¼‰ï¼Œä½†è¿™ä¸ä¼šå½±å“æ£€æŸ¥ç½‘å…³çš„æ“ä½œã€‚ åœ¨å½“å‰ç‰ˆæœ¬ï¼ˆ6.44ï¼‰RoSä¸­ï¼Œå°†è‡ªåŠ¨ä¼˜å…ˆçº§èµ‹äºˆECMPè·¯ç”±ï¼Œä½†æ˜¯æœ€å¥½å°†æµ‹è¯•è·¯ç”±æ·»åŠ åˆ°å…¶ä»–è·¯ç”±è¡¨ä¸­ï¼ˆé€‰é¡¹<code>routing-mark</code> ï¼‰ </p><br><p>  Speedtestå’Œå…¶ä»–ç±»ä¼¼ç«™ç‚¹ä¸Šçš„é€Ÿåº¦ä¸ä¼šæé«˜ï¼ˆECMPæŒ‰è¿æ¥è€Œä¸æ˜¯æ•°æ®åŒ…åˆ’åˆ†æµé‡ï¼‰ï¼Œä½†p2påº”ç”¨ç¨‹åºåº”åŠ è½½å¾—æ›´å¿«ã€‚ </p><br><p>  <strong>é€šè¿‡è·¯ç”±è¿‡æ»¤</strong> <br><img src="https://habrastorage.org/webt/gv/bj/nh/gvbjnhvblrebv9051hd_x8adklo.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 add dst-address=192.168.200.0/24 gateway=10.30.30.1 distance=1 add dst-address=192.168.200.0/24 gateway=10.10.10.1 distance=2 type=blackhole</code> </pre> <br><ol><li> é™æ€è·¯ç”±åˆ°é»˜è®¤è·¯ç”± </li><li> é€šè¿‡ipipéš§é“åˆ°192.168.200.0/24çš„é™æ€è·¯ç”± </li><li> ç¦æ­¢é€šè¿‡æä¾›å•†çš„è·¯ç”±å™¨åˆ°192.168.200.0/24çš„é™æ€è·¯ç”± </li></ol><br><p> è¿‡æ»¤é€‰é¡¹ï¼Œç¦ç”¨ipipæ¥å£æ—¶ï¼Œéš§é“æµé‡ä¸ä¼šè¿›å…¥æä¾›å•†çš„è·¯ç”±å™¨ã€‚ å¾ˆå°‘éœ€è¦è¿™ç§æ–¹æ¡ˆï¼Œå› ä¸º å¯ä»¥é€šè¿‡é˜²ç«å¢™å®æ–½é˜»æ­¢ã€‚ </p><br><p>  <strong>è·¯ç”±å›è·¯</strong> <br> è·¯ç”±å¾ªç¯æ˜¯æŒ‡ttlè¿‡æœŸä¹‹å‰ï¼Œæ•°æ®åŒ…åœ¨è·¯ç”±å™¨ä¹‹é—´è¿è¡Œçš„æƒ…å†µã€‚ é€šå¸¸ï¼Œè¿™æ˜¯é…ç½®é”™è¯¯çš„ç»“æœï¼Œåœ¨å¤§å‹ç½‘ç»œä¸­ï¼Œåº”è°¨æ…æ‰§è¡ŒåŠ¨æ€è·¯ç”±åè®®ï¼Œåœ¨å°å‹ç½‘ç»œä¸­åº”å°†å…¶å¤„ç†ã€‚ </p><br><p> çœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><img src="https://habrastorage.org/webt/ii/h8/-v/iih8-vpacnim4b6flslcvy-v0eg.png"></p><br><p> ç¤ºä¾‹ï¼ˆæœ€ç®€å•ï¼‰å¦‚ä½•è·å¾—ç›¸ä¼¼çš„ç»“æœï¼š <br><img src="https://habrastorage.org/webt/ky/9v/gv/ky9vgvnxvno8x79cbu79be0_buu.png"></p><br><p> è·¯ç”±å¾ªç¯ç¤ºä¾‹æ²¡æœ‰å®é™…ç”¨é€”ï¼Œä½†æ˜¯å®ƒè¡¨æ˜è·¯ç”±å™¨ä¸äº†è§£å…¶é‚»å±…çš„è·¯ç”±è¡¨ã€‚ </p><br><h3 id="policy-base-routing-i-dopolnitelnye-tablicy-marshrutizacii"> ç­–ç•¥åº“è·¯ç”±å’Œå…¶ä»–è·¯ç”±è¡¨ </h3><br><p> é€‰æ‹©è·¯ç”±æ—¶ï¼Œè·¯ç”±å™¨ä»…ä½¿ç”¨æ•°æ®åŒ…æ ‡å¤´ï¼ˆç›®æ ‡åœ°å€ï¼‰ä¸­çš„ä¸€ä¸ªå­—æ®µ-è¿™æ˜¯åŸºæœ¬è·¯ç”±ã€‚ åŸºäºå…¶ä»–æ¡ä»¶çš„è·¯ç”±ï¼Œä¾‹å¦‚æºåœ°å€ï¼Œæµé‡ç±»å‹ï¼ˆToSï¼‰ï¼Œä¸ä½¿ç”¨ECMPçš„å¹³è¡¡ï¼Œæ˜¯æŒ‡ç­–ç•¥åŸºç¡€è·¯ç”±ï¼ˆPBRï¼‰ï¼Œå¹¶ä½¿ç”¨å…¶ä»–è·¯ç”±è¡¨ã€‚ </p><br><p><img src="https://habrastorage.org/webt/cf/31/fj/cf31fjsrsjd2aszbzkl_hmg9wuw.png"></p><br><p>  <em>â€œæ›´ç‰¹å®šçš„è·¯ç”±â€</em>æ˜¯åœ¨è·¯ç”±è¡¨ä¸­é€‰æ‹©è·¯ç”±çš„åŸºæœ¬è§„åˆ™ã€‚ </p><br><p> é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è·¯ç”±è§„åˆ™éƒ½æ·»åŠ åˆ°ä¸»è¡¨ä¸­ã€‚ ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„å…¶ä»–è·¯ç”±è¡¨ï¼Œå¹¶å°†æ•°æ®åŒ…è·¯ç”±åˆ°å®ƒä»¬ã€‚ ä¸åŒè¡¨ä¸­çš„è§„åˆ™ä¸ä¼šç›¸äº’å†²çªã€‚ å¦‚æœç¨‹åºåŒ…åœ¨æŒ‡å®šçš„è¡¨ä¸­æ‰¾ä¸åˆ°åˆé€‚çš„è§„åˆ™ï¼Œå®ƒå°†è½¬åˆ°ä¸»è¡¨ã€‚ </p><br><p> é€šè¿‡é˜²ç«å¢™çš„åˆ†å‘ç¤ºä¾‹ï¼š <br><img src="https://habrastorage.org/webt/uw/nd/jz/uwndjzt8mtfett8l84vg-n65p90.png"></p><br><ul><li>  192.168.100.10-&gt; 8.8.8.8 <br><ol><li> æ¥è‡ª192.168.100.10çš„æµé‡ä¼šåœ¨<code>[Prerouting|Mangle]</code>æ”¶åˆ°<em>via-isp1æ ‡ç­¾</em> ã€‚ </li><li> åœ¨â€œè·¯ç”±â€é˜¶æ®µï¼Œåœ¨<em>via-isp1</em>è¡¨ä¸­<em>ï¼Œ</em>æœç´¢<em>ä¸€æ¡è·¯ç”±</em> ï¼Œç›´åˆ°8.8.8.8ã€‚ </li><li> æ‰¾åˆ°è·¯ç”±ï¼Œå°†æµé‡å‘é€åˆ°ç½‘å…³10.10.10.1 </li></ol></li><li>  192.168.200.20-&gt; 8.8.8.8 <br><ol><li> æ¥è‡ª192.168.200.20çš„æµé‡ä¼šåœ¨<code>[Prerouting|Mangle]</code>æ”¶åˆ°<em>via-isp2æ ‡ç­¾</em> </li><li> åœ¨â€œè·¯ç”±â€é˜¶æ®µï¼Œ <em>via-isp2</em>è¡¨<em>æœç´¢</em>çš„è·¯ç”±æœ€é«˜å¯è¾¾8.8.8.8ã€‚ </li><li> æ‰¾åˆ°è·¯ç”±ï¼Œå°†æµé‡å‘é€åˆ°ç½‘å…³10.20.20.1 </li></ol></li><li> å¦‚æœå…¶ä¸­ä¸€ä¸ªç½‘å…³ï¼ˆ10.10.10.1æˆ–10.20.20.1ï¼‰ä¸å¯ç”¨ï¼Œåˆ™æ•°æ®åŒ…å°†è½¬åˆ°<em>ä¸»</em>è¡¨å¹¶åœ¨å…¶ä¸­å¯»æ‰¾åˆé€‚çš„è·¯ç”± </li></ul><br><h3 id="problemy-terminologii"> æœ¯è¯­é—®é¢˜ </h3><br><p>  RouterOSå­˜åœ¨æŸäº›æœ¯è¯­é—®é¢˜ã€‚ <br> åœ¨<code>[IP]-&gt;[Routes]</code>ä½¿ç”¨è§„åˆ™æ—¶ï¼Œä¼šæ˜¾ç¤ºè·¯ç”±è¡¨ï¼Œå°½ç®¡å®ƒè¯´æ ‡ç­¾ï¼š <br><img src="https://habrastorage.org/webt/8i/kh/kh/8ikhkhsxvmlwnh9hd9g-quxnk18.png"></p><br><p> åœ¨<code>[IP]-&gt;[Routes]-&gt;[Rule]</code>ä¸€åˆ‡æ­£ç¡®ï¼Œåœ¨è¡¨æ“ä½œçš„æ¡ä»¶æ ‡ç­¾ä¸­ï¼š <br><img src="https://habrastorage.org/webt/0m/hl/5j/0mhl5jj73m7rfm4rvtb5qwpbix4.png"></p><br><h3 id="kak-otpravit-paket-v-opredelennuyu-tablicu-marshrutizacii"> å¦‚ä½•å°†æ•°æ®åŒ…å‘é€åˆ°ç‰¹å®šçš„è·¯ç”±è¡¨ </h3><br><p>  RouterOSæä¾›äº†å‡ ç§å·¥å…·ï¼š </p><br><ul><li>  <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> </li><li>  <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code>è·¯ç”±æ ‡ç­¾ï¼ˆ <code>action=mark-routing</code> ï¼‰ </li><li>  VRF </li></ul><br><p>  <strong>è§„åˆ™<code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br> è§„åˆ™æ˜¯æŒ‰é¡ºåºå¤„ç†çš„ï¼Œå¦‚æœæ•°æ®åŒ…ç¬¦åˆè§„åˆ™çš„æ¡ä»¶ï¼Œåˆ™ä¸ä¼šç»§ç»­è¿›è¡Œã€‚ </p><br><p> è·¯ç”±è§„åˆ™ä½¿æ‚¨å¯ä»¥æ‰©å±•è·¯ç”±åŠŸèƒ½ï¼Œä¸ä»…ä¾èµ–äºæ”¶ä»¶äººåœ°å€ï¼Œè€Œä¸”è¿˜ä¾èµ–äºæºåœ°å€å’Œæ¥æ”¶æ•°æ®åŒ…çš„æ¥å£ã€‚ </p><br><p><img src="https://habrastorage.org/webt/hg/ip/py/hgippyt0pgilh0l9zouqqqpbsoe.png"></p><br><p> è§„åˆ™ç”±æ¡ä»¶å’ŒåŠ¨ä½œç»„æˆï¼š </p><br><ul><li> æ¡ä»¶ã€‚ ä»–ä»¬å®é™…ä¸Šé‡å¤äº†åœ¨FIBä¸­æ£€æŸ¥æ•°æ®åŒ…çš„æ ‡å¿—åˆ—è¡¨ï¼›ä»…ç¼ºå°‘ToSã€‚ </li><li> åŠ¨ä½œ <br><ul><li> æŸ¥æ‰¾-å°†æ•°æ®åŒ…å‘é€åˆ°è¡¨ </li><li> ä»…åœ¨è¡¨ä¸­æŸ¥æ‰¾-å°†åŒ…é”å®šåœ¨è¡¨ä¸­ï¼Œå¦‚æœæœªæ‰¾åˆ°è·¯ç”±ï¼Œåˆ™åŒ…å°†ä¸ä¼šè¿›å…¥ä¸»è¡¨ </li><li> ä¸¢å¼ƒ-ä¸¢å¼ƒæ•°æ®åŒ… </li><li> æ— æ³•åˆ°è¾¾-åˆ é™¤å‘ä»¶äººé€šçŸ¥æ•°æ®åŒ… </li></ul></li></ul><br><p> åœ¨FIBä¸­ï¼Œç»•è¿‡è§„åˆ™<code>[IP]-&gt;[Route]-&gt;[Rules]</code>å¤„ç†åˆ°æœ¬åœ°è¿›ç¨‹çš„æµé‡ï¼š <br><img src="https://habrastorage.org/webt/yk/f4/gt/ykf4gt4ywwzgbklpyzlyulije8k.png"></p><br><p>  <strong>æ ‡è®°<code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br> è·¯ç”±æ ‡ç­¾å…è®¸æ‚¨ä½¿ç”¨å‡ ä¹æ‰€æœ‰é˜²ç«å¢™æ¡ä»¶ä¸ºæ•°æ®åŒ…è®¾ç½®ç½‘å…³ï¼š <br><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><p>  <em>å®é™…ä¸Šï¼Œå› ä¸ºå¹¶éæ‰€æœ‰äººéƒ½è®²å¾—é€šï¼Œæ‰€ä»¥æœ‰äº›äººå¯èƒ½å·¥ä½œä¸ç¨³å®šã€‚</em> </p><br><p><img src="https://habrastorage.org/webt/6b/_m/om/6b_mom-f6nde0zyuy-mr62asho4.png"></p><br><p> æœ‰ä¸¤ç§æ ‡è®°åŒ…è£…çš„æ–¹æ³•ï¼š </p><br><ul><li> ç«‹å³è®¾ç½®<em>è·¯ç”±æ ‡è®°</em> </li><li> é¦–å…ˆè®¾ç½®<em>è¿æ¥æ ‡è®°</em> ï¼Œç„¶ååŸºäº<em>è¿æ¥æ ‡è®°</em>è®¾ç½®<em>è·¯ç”±æ ‡è®°</em> </li></ul><br><p> åœ¨æœ‰å…³é˜²ç«å¢™çš„æ–‡ç« ä¸­ï¼Œæˆ‘å†™é“ç¬¬äºŒç§é€‰æ‹©æ˜¯å¯å–çš„ï¼Œå› ä¸º åœ¨æ ‡è®°è·¯ç”±çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å‡å°‘cpuçš„è´Ÿè½½-è¿™å¹¶éå®Œå…¨æ­£ç¡®ã€‚ è¿™äº›æ ‡è®°æ–¹æ³•å¹¶ä¸æ€»æ˜¯ç­‰æ•ˆçš„ï¼Œé€šå¸¸ç”¨äºè§£å†³å„ç§é—®é¢˜ã€‚ </p><br><h3 id="primery-ispolzovaniya"> ä½¿ç”¨èŒƒä¾‹ </h3><br><p> æˆ‘ä»¬ç»§ç»­ä½¿ç”¨â€œåŸºäºç­–ç•¥çš„è·¯ç”±â€çš„ç¤ºä¾‹ï¼Œå‘ä»–ä»¬å±•ç¤ºä¸ºä»€ä¹ˆéœ€è¦æ‰€æœ‰è¿™äº›æ›´åŠ å®¹æ˜“ã€‚ </p><br><p>  <strong>MultiWANå’Œå“åº”ä¼ å‡ºï¼ˆè¾“å‡ºï¼‰æµé‡</strong> <br>  MultiWANé…ç½®çš„ä¸€ä¸ªå¸¸è§é—®é¢˜ï¼šMikrotikä»…å¯é€šè¿‡â€œæ´»åŠ¨â€æä¾›ç¨‹åºä»Internetè®¿é—®ã€‚ <br><img src="https://habrastorage.org/webt/ob/1p/ph/ob1pph0eph9qvz9nqvt759mptiq.png"></p><br><p> ä¸è·¯ç”±å™¨è¯·æ±‚çš„IPæ— å…³ï¼Œåœ¨ç”Ÿæˆå“åº”æ—¶ï¼Œå®ƒå°†åœ¨è·¯ç”±è¡¨ä¸­æŸ¥æ‰¾é€šè¿‡isp1çš„è·¯ç”±å¤„äºæ´»åŠ¨çŠ¶æ€çš„è·¯ç”±ã€‚ æ­¤å¤–ï¼Œè¿™æ ·çš„åˆ†ç»„å¾ˆå¯èƒ½åœ¨åˆ°è¾¾æ¥æ”¶è€…çš„é€”ä¸­è¢«è¿‡æ»¤ã€‚ </p><br><p>  <em>å¦ä¸€ä¸ªæœ‰è¶£çš„è§‚ç‚¹ã€‚</em>  <em>å¦‚æœåœ¨ether1æ¥å£ä¸Šé…ç½®äº†â€œç®€å•â€æºnatï¼š <code>/ip fi nat add out-interface=ether1 action=masquerade</code>æ•°æ®åŒ…å°†é€šè¿‡srcè¿›å…¥ç½‘ç»œã€‚</em>  <em>åœ°å€= 10.10.10.100ï¼Œè¿™å°†ä½¿æƒ…å†µè¿›ä¸€æ­¥æ¶åŒ–ã€‚</em> </p><br><p> æœ‰å‡ ç§æ–¹æ³•å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼Œä½†æ˜¯ä»»ä½•ä¸€ç§æ–¹æ³•éƒ½éœ€è¦é™„åŠ çš„è·¯ç”±è¡¨ï¼š <br><img src="https://habrastorage.org/webt/g9/65/vy/g965vychbnzbsksplywfc3npi90.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping distance=1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping distance=2 add dst-address=0.0.0.0/0 gateway=10.10.10.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 routing-mark=over-isp2</code> </pre> <br><p>  <strong>ä½¿ç”¨<code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br> æŒ‡å®šå°†ç”¨äºå…·æœ‰æŒ‡å®šæºIPçš„æ•°æ®åŒ…çš„è·¯ç”±è¡¨ã€‚ <br><img src="https://habrastorage.org/webt/na/lm/b3/nalmb3u0yrde35z0mzdjm1xygr4.png"></p><br><pre> <code class="plaintext hljs">/ip route rule add src-address=10.10.10.100/32 action=lookup-only-in-table table=over-isp1 add src-address=10.20.20.200/32 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>  <em>æ‚¨å¯ä»¥ä½¿ç”¨<code>action=lookup</code> ï¼Œä½†æ˜¯å¯¹äºæœ¬åœ°ä¼ å‡ºæµé‡ï¼Œæ­¤é€‰é¡¹å®Œå…¨æ’é™¤äº†æ¥è‡ªé”™è¯¯æ¥å£çš„è¿æ¥ã€‚</em> </p><br><ul><li> ç³»ç»Ÿç”Ÿæˆå¸¦æœ‰Srcçš„å“åº”æ•°æ®åŒ…ã€‚ åœ°å€ï¼š10.20.20.200 </li><li> åœ¨è·¯ç”±å†³ç­–ï¼ˆ2ï¼‰é˜¶æ®µï¼Œæ£€æŸ¥<code>[IP]-&gt;[Routes]-&gt;[Rules]</code> ï¼Œå¹¶å°†æ•°æ®åŒ…å‘é€åˆ°<em>over-isp2</em>è·¯ç”±è¡¨ </li><li> æ ¹æ®è·¯ç”±è¡¨ï¼Œå¿…é¡»é€šè¿‡ether2æ¥å£å°†æ•°æ®åŒ…å‘é€åˆ°ç½‘å…³10.20.20.1 </li></ul><br><p><img src="https://habrastorage.org/webt/k-/zf/sg/k-zfsgxxdpqbufnwoobbno8d_aq.png"></p><br><p> ä¸ä½¿ç”¨Mangleè¡¨ä¸åŒï¼Œæ­¤æ–¹æ³•ä¸éœ€è¦æœ‰æ•ˆçš„Connection Trackerã€‚ </p><br><p>  <strong>ä½¿ç”¨<code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br> è¿æ¥ä»ä¼ å…¥çš„æ•°æ®åŒ…å¼€å§‹ï¼Œå› æ­¤æˆ‘ä»¬å¯¹å…¶è¿›è¡Œæ ‡è®°ï¼ˆ <code>action=mark-connection</code> ï¼‰ï¼Œå¯¹äºæ¥è‡ªæ ‡è®°çš„è¿æ¥çš„ä¼ å‡ºæ•°æ®åŒ…ï¼Œæˆ‘ä»¬è®¾ç½®äº†è·¯ç”±æ ‡ç­¾ï¼ˆ <code>action=mark-routing</code> ï¼‰ã€‚ <br><img src="https://habrastorage.org/webt/lg/4v/ni/lg4vni1mt8eteade7mcitz_3s3g.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle #   add chain=input in-interface=ether1 connection-state=new action=mark-connection new-connection-mark=from-isp1 add chain=input in-interface=ether2 connection-state=new action=mark-connection new-connection-mark=from-isp2 #      add chain=output connection-mark=from-isp1 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=output connection-mark=from-isp2 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p> <em>      ip,     <code>dst-address</code>  .</em> </p><br><ul><li>   ether2    .    <code>[INPUT|Mangle]</code>         <em>from-isp2</em> </li><li>      Src. Address: 10.20.20.200 </li><li>   Routing Decision(2)          10.20.20.1   ether1.        <code>[OUTPUT|Filter]</code> </li><li>   <code>[OUTPUT|Mangle]</code>       <em>from-isp2</em>      <em>over-isp2</em> </li><li>   Routing Adjusment(3)             </li><li>            10.20.20.1   ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/rd/mr/qs/rdmrqst9dam9m7r9s4jsnudwdly.png"></p><br><h3 id="multiwan-i-otvetnyy-dst-nat-trafik"> MultiWAN   dst-nat  </h3><br><p>  ,        ( web)             . </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether1 action=dst-nat to-address=192.168.100.100 add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether2 action=dst-nat to-address=192.168.100.100</code> </pre> <br><p>     ,      Firewall Mangle,     : <br><img src="https://habrastorage.org/webt/3w/9i/pq/3w9ipqogda4itpjkpvqbw7ewxrg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting connection-state=new in-interface=ether1 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp1 add chain=prerouting connection-state=new in-interface=ether2 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp2 add chain=prerouting connection-mark=web-input-isp1 in-interface=ether3 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting connection-mark=web-input-isp2 in-interface=ether3 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/fb/qf/np/fbqfnpzfpcshxwzl2ruppyjh5qw.png"><br> <em>    NAT,      .</em> </p><br><h3 id="multiwan-i-ishodyaschie-soedineniya"> MultiWAN    </h3><br><p>    PBR    vpn (  SSTP)     . </p><br><p><img src="https://habrastorage.org/webt/pt/jg/m3/ptjgm36vdijiuvygzwl8csvwg5q.png"></p><br><p>   : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=192.168.100.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 routing-mark=over-isp3 add dst-address=0.0.0.0/0 gateway=192.168.100.1 distance=1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 distance=2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 distance=3</code> </pre> <br><p>  : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output dst-address=10.10.10.100 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp1 passtrough=no add chain=output dst-address=10.10.10.101 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp2 passtrough=no add chain=output dst-address=10.10.10.102 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp3 passtrough=no</code> </pre> <br><p>   NAT,        Src. Address: </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=srcnat out-interface=ether1 action=masquerade add chain=srcnat out-interface=ether2 action=masquerade add chain=srcnat out-interface=ether3 action=masquerade</code> </pre> <br><p> : </p><br><ul><li>     SSTP </li><li>   Routing Decision (2)     ,     main.       Src. Address    ether1 </li><li>  <code>[Output|Mangle]</code>        </li><li>         Routing Adjusment        </li><li>       Src. Address  ether1,   <code>[Nat|Srcnat]</code>       </li></ul><br><p> ,        : <br><img src="https://habrastorage.org/webt/i9/gd/x0/i9gdx0o9s0iqnr4shoxdtfqnh2i.png"></p><br><p> Connection Tracker   <code>[Mangle]</code>  <code>[Srcnat]</code> ,       ,      <code>Replay Dst. Address</code>    NAT: <br><img src="https://habrastorage.org/webt/ps/op/qa/psopqak9ysxfem9lebg7woyizk4.png"></p><br><p>  VPN  (      )         : <br><img src="https://habrastorage.org/webt/s7/nc/jz/s7ncjzninvkxn_a6-p3wdd5ywnw.png"></p><br><p> <strong> </strong> <br>   ,         : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=10.10.10.100 gateway=192.168.100.1 add dst-address=10.10.10.101 gateway=192.168.200.1 add dst-address=10.10.10.102 gateway=192.168.0.1</code> </pre> <br><p>              . ,        vpn      ,     6   <code>[IP]-&gt;[Routes]</code>  <code>type=blackhole</code> .    â€” 3   <code>[IP]-&gt;[Route]-&gt;[Rules]</code> . </p><br><h3 id="raspredelenie-soedineniy-polzovateley-po-kanalam-svyazi">       </h3><br><p> ,  .      : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2</code> </pre> <br><p> <strong> <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br><img src="https://habrastorage.org/webt/-m/4o/jv/-m4ojve7wspajkjoc00afbpsbru.png"></p><br><pre> <code class="plaintext hljs">/ip route rules add src-address=192.168.100.0/25 action=lookup-only-in-table table=over-isp1 add src-address=192.168.100.128/25 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>action=lookup</code> ,           main     .     â€”   . </p><br><p> <strong>   <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>     ip .       . <em>  layer7,      ,      ,       .</em> <br><img src="https://habrastorage.org/webt/u8/k5/yi/u8k5yito7_iuseo5cki-nhkaz5o.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address-list=users-over-isp1 dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 add chain=prerouting src-address-list=users-over-isp2 dst-address-type=!local action=mark-routing new-routing-mark=over-isp2</code> </pre> <br><p> ""        <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : </p><br><pre> <code class="plaintext hljs">/ip route rules add routing-mark=over-isp1 action=lookup-only-in-table table=over-isp1 add routing-mark=over-isp2 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>[IP]-&gt;[Firewall]-&gt;[Filter]</code> : </p><br><pre> <code class="plaintext hljs">/ip firewall filter add chain=forward routing-mark=over-isp1 out-interface=!ether1 action=reject add chain=forward routing-mark=over-isp2 out-interface=!ether2 action=reject</code> </pre> <br><p> <strong>  <code>dst-address-type=!local</code></strong> <br>   <code>dst-address-type=!local</code>           (dns, winbox, ssh, ...).       ,          ,   <code>dst-address-table</code> . </p><br><p>     <code>[IP]-&gt;[Route]-&gt;[Rules]</code>   ,      .   ,    FIB    <code>[PREROUTING|Mangle]</code>           main,    .    Routing Rules,            User PBR      . </p><br><p> <strong> <code>[IP]-&gt;[Firewall]-&gt;[Mangle action=route]</code></strong> <br>      <code>[Prerouting|Mangle]</code>            ,    : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address=192.168.100.0/25 action=route gateway=10.10.10.1 add chain=prerouting src-address=192.168.128.0/25 action=route gateway=10.20.20.1</code> </pre> <br><p>  <code>route</code>        ( <code>[IP]-&gt;[Route]-&gt;[Rules]</code> ).          ,    <code>action=route</code>    <code>action=mark-route</code> ,     (    <code>passtrough</code> ),   . <br> <em> wiki            ,               .</em> </p><br><h3 id="dinamicheskaya-balansirovka-na-osnove-ppc">     PPC </h3><br><p> Per Connection Classificator â€”     ECMP.    ECMP       (ECMP     ,     Routing Cache   ). </p><br><p> PCC  <em> </em>  ip ,    32-     <em></em> .       <em></em>    ,    . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> .  ,  . <br><img src="https://habrastorage.org/webt/md/xn/kz/mdxnkzst4p7nxatp2bnvjbrlsoe.png"></p><br><p>    : </p><br><pre> <code class="plaintext hljs">192.168.100.10: 192+168+100+10 = 470 % 3 = 2 192.168.100.11: 192+168+100+11 = 471 % 3 = 0 192.168.100.12: 192+168+100+12 = 472 % 3 = 1</code> </pre> <br><p>      src.address   : <br><img src="https://habrastorage.org/webt/sq/dn/rt/sqdnrtcsgypqle5ftv2rg23xvmg.png"></p><br><pre> <code class="plaintext hljs">#  /ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=3 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=1 routing-mark=over-isp3 #    /ip firewall mangle add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/0 action=mark-connection new-connection-mark=conn-over-isp1 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/1 action=mark-connection new-connection-mark=conn-over-isp2 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/2 action=mark-connection new-connection-mark=conn-over-isp3 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp1 action=mark-routing new-routing-mark=over-isp1 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp2 action=mark-routing new-routing-mark=over-isp2 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp3 action=mark-routing new-routing-mark=over-isp3</code> </pre> <br><p>      : <code>in-interface=br-lan</code> ,    <code>action=mark-routing</code>               . </p><br><h3 id="pereklyuchenie-kanalov-svyazi">    </h3><br><p> Check ping â€”  ,        IP ,                 ,            ,   check ping          . <br>           BGP,                 . </p><br><p>   ,        ip    ,      ,  google dns: 8.8.8.8. 8.8.4.4.    Mikrotik      . </p><br><p> <strong>    </strong> <br>      Multihop BGP               MikroTik,          check gateway       . </p><br><p>         scope/target scope       : <br><img src="https://habrastorage.org/webt/_m/kz/aw/_mkzawioocf0friubndc9q2pofw.png"></p><br><ol><li>           scope      main      target scope </li><li>     ,        </li><li>   connected        </li></ol><br><p>        ,    : <br><img src="https://habrastorage.org/webt/s4/jo/tv/s4jotv0vsxcofu8pcod2uzugfo4.png"></p><br><ul><li> 1-3  connected    ,       </li><li> 4-6   connected   ""  </li></ul><br><p>        RIB,   FIB    : <code>0.0.0.0/0 via 10.10.10.1 on ether1</code> . </p><br><p> <strong>      </strong> <br><img src="https://habrastorage.org/webt/f1/gd/hj/f1gdhjwli1fqi4yk7i-cfdyf2l0.png"></p><br><p> : <br><img src="https://habrastorage.org/webt/d8/bb/ae/d8bbaepprp0wswv54ly0ryzphhc.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=8.8.8.8 check-gateway=ping distance=1 target-scope=10 add dst-address=8.8.8.8 gateway=10.10.10.1 scope=10 add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><p>  ,      10.10.10.1: <br><img src="https://habrastorage.org/webt/k6/nq/a9/k6nqa98jmecubjxx8e2zndbclcc.png"></p><br><p> Check gateway          ping'   8.8.8.8,  (   main)    10.10.10.1. </p><br><p>      10.10.10.1  8.8.8.8,    ,   (  ping)  8.8.8.8    10.10.10.1: <br><img src="https://habrastorage.org/webt/hj/v2/tg/hjv2tg5bnkaae2gyr7iunr74kt4.png"></p><br><p>      ether1,    ,    8.8.8.8    : <br><img src="https://habrastorage.org/webt/rt/_d/ad/rt_dadf8--ghn5pmgyg7q1ya258.png"></p><br><p>  ,    NetWatch      8.8.8.8.    NetWatch            .     : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=8.8.8.8 gateway=10.20.20.1 distance=100 type=blackhole</code> </pre> <br><p><img src="https://habrastorage.org/webt/ks/6e/k3/ks6ek3swyj9uyiih0bkbef1i6eu.png"></p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ,    NetWatch   . </p><br><p>  ,      8.8.8.8       ,       dns    . </p><br><h3 id="para-slov-pro-virtual-routing-and-forwarding-vrf">    Virtual Routing and Forwarding (VRF) </h3><br><p>  VRF         ,        (    MPLS)    L3VPN     : <br><img src="https://habrastorage.org/webt/hk/0l/ep/hk0lep0gncmeajzj1pkp2wix6yk.png"></p><br><p>  VRF  Mikrotik         ,   ip      VRF,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> . </p><br><p>   vrf: <br><img src="https://habrastorage.org/webt/gl/g8/k8/glg8k8isgjjsgyjodp7-rnqq5fi.png"></p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0</code> </pre> <br><p>     ether2 ,   ping      vrf (  ),   ping    : <br><img src="https://habrastorage.org/webt/pz/a7/h_/pza7h_xts_jyk6czos89h47q45u.png"></p><br><p>            main (  vrf   route leaking): <br><img src="https://habrastorage.org/webt/on/p-/5z/onp-5z4cvah-erroi_flwnjn2ik.png"></p><br><pre> <code class="plaintext hljs">/ip route add distance=1 gateway=172.17.0.1@main routing-mark=vrf1 add distance=1 gateway=172.17.0.1%wlan1 routing-mark=vrf2</code> </pre> <br><p> <em>    route leaking:   : <code>172.17.0.1@main</code>    : <code>172.17.0.1%wlan1</code> .</em> </p><br><p>        <code>[PREROUTING|Mangle]</code> : <br><img src="https://habrastorage.org/webt/ge/w3/pa/gew3paz7vdzqkzc0-pt0mz5b6yg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting in-interface=ether1 action=mark-connection new-connection-mark=from-vrf1 passthrough=no add chain=prerouting connection-mark=from-vrf1 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting in-interface=ether2 action=mark-connection new-connection-mark=from-vrf2 passthrough=no add chain=prerouting connection-mark=from-vrf2 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/i8/dd/kx/i8ddkxzzdogtht7gvzyo-rzcr-g.png"></p><br><p> <strong>   </strong> <br>            VRF  netmap: <br><img src="https://habrastorage.org/webt/yl/vx/kb/ylvxkbg-tyalsczpx9datttwgs0.png"></p><br><p>  : </p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 add address=192.168.0.1/24 interface=ether3 network=192.168.0.0</code> </pre> <br><p>  firewall: </p><br><pre> <code class="plaintext hljs">#        /ip firewall mangle add chain=prerouting dst-address=192.168.101.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting dst-address=192.168.102.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf2 passthrough=no # netmap   ""     /ip firewall nat add chain=dstnat dst-address=192.168.101.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24 add chain=dstnat dst-address=192.168.102.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">#      route leaking,       connected  /ip route add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf1 add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf2</code> </pre> <br><p> <strong>    dhcp    </strong> <br> VRF   ,       (  dhcp client)    . </p><br><p>    vrf: </p><br><pre> <code class="plaintext hljs">/ip route vrf add interface=ether1 routing-mark=over-isp1</code> </pre> <br><p>     (  )   <em>over-isp1</em> : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output out-interface=!br-lan action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting in-interface=br-lan dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 passthrough=no</code> </pre> <br><p> ,      : </p><br><pre> <code class="plaintext hljs">/interface bridge add name=bare /ip route add dst-address=0.0.0.0/0 gateway=bare</code> </pre> <br><p>            Routing decision (2)  <code>[OUTPUT|Mangle]</code>    ,         0.0.0.0/0   main   . <br><img src="https://habrastorage.org/webt/ff/p-/qh/ffp-qhi41y5wxswp6wzrtp69bjk.png"></p><br><h3 id="cepochki-connected-in-i-dynamic-in-v-routing---filters">  <code>connected-in</code>  <code>dynamic-in</code>  <code>[Routing] -&gt; [Filters]</code> </h3><br><p>   (  ) â€”           (      <em>routing</em> ),        : </p><br><ul><li> connected-in â€”  connected  </li><li> dynamic-in â€”     PPP  DCHP </li></ul><br><p>      ,     : distance, routing-mark, comment, scope, target scope, ... </p><br><p>         -  Routing Filters (  ),    Routing Filters,           .     Routing Filters      . </p><br><p> <strong> Routing Mark   </strong> <br>    .     VPN            .     -      : </p><br><pre> <code class="plaintext hljs">#  vpn    default route    /interface pptp-client add connect-to=XXXX add-default-route=yes default-route-distance=101 ... add connect-to=YYYY add-default-route=yes default-route-distance=100 ... #             /routing filter add chain=dynamic-in distance=100 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn1 add chain=dynamic-in distance=101 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn2</code> </pre> <br><p> <em>  ,  ,    vrf  ppp ,    0.0.0.0/0     main.      .</em> </p><br><p> <strong> Connected </strong> <br>    : </p><br><pre> <code class="plaintext hljs">/route filter add chain=connected-in prefix=192.168.100.0/24 action=reject</code> </pre> <br><h3 id="instrumenty-otladki">   </h3><br><p> RouterOS      : </p><br><ul><li> <code>[Tool]-&gt;[Torch]</code> â€”      </li><li> <code>/ip route check</code> â€”        ,      </li><li> <code>/ping routing-table=&lt;name&gt;</code>  <code>/tool traceroute routing-table=&lt;name&gt;</code> â€” ping       </li><li> <code>action=log</code>  <code>[IP]-&gt;[Firewall]</code> â€”  ,       packet flow,         </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN443788/">https://habr.com/ru/post/zh-CN443788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN443774/index.html">ç¥ç»ç”Ÿç‰©å­¦å¦‚ä½•å¹²é¢„ç¾å›½æ€»ç»Ÿå¤§é€‰</a></li>
<li><a href="../zh-CN443776/index.html">ä¸­å›½åœ¨è´­ä¹°åœ°é“æ—¶å¼•å…¥äº†å®éªŒæ€§é¢éƒ¨è¯†åˆ«ç³»ç»Ÿ</a></li>
<li><a href="../zh-CN443780/index.html">MCDMé¡¹ç›®ã€‚ ç¬¬1éƒ¨åˆ†ã€‚æ¦‚å¿µ</a></li>
<li><a href="../zh-CN443782/index.html">å¼€å‘äººå‘˜ç°åœ¨å¯ä»¥åœ¨ä»–ä»¬çš„Steamæ¸¸æˆä¸­ä½¿ç”¨Valveçš„ç½‘ç»œAPI</a></li>
<li><a href="../zh-CN443786/index.html">åœ¨è«æ–¯ç§‘Mobius 2018çš„HeadHunterå±•å°åˆ†æç¬¬äºŒå±ŠAndroidæµ‹éªŒç«èµ›</a></li>
<li><a href="../zh-CN443790/index.html">å¹¸å­˜è€…çš„é”™è¯¯</a></li>
<li><a href="../zh-CN443792/index.html">ä½¿ç”¨PostgreSQLæ—¶çš„å…¸å‹é”™è¯¯ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN443794/index.html">æˆ¿åœ°äº§é”€å”®é¢†åŸŸä¸­ITåˆåˆ›å…¬å¸çš„ä¸»è¦æ–¹å‘</a></li>
<li><a href="../zh-CN443798/index.html">Zotero hacksï¼šæ— é™çš„åŒæ­¥å­˜å‚¨åŠå…¶ä¸rmarkdownçš„å¹³æ»‘ä½¿ç”¨</a></li>
<li><a href="../zh-CN443804/index.html">Cï¼ƒæ˜¯ä½çº§è¯­è¨€å—ï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>