<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤦🏿 👤 👩‍🎨 Seperti apa bentuk arsip zip dan apa yang bisa kita lakukan dengannya. Bagian 3 - Aplikasi Praktis 👆 🙌🏿 👨‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kelanjutan artikel Bagaimana tampilan arsip zip dan apa yang dapat kita lakukan dengannya. Bagian 2 - Deskriptor dan Kompresi Data . 

 Pembaca yang b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Seperti apa bentuk arsip zip dan apa yang bisa kita lakukan dengannya. Bagian 3 - Aplikasi Praktis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484520/">  <i>Kelanjutan artikel <a href="https://habr.com/ru/post/472966/">Bagaimana tampilan arsip zip dan apa yang dapat kita lakukan dengannya.</a></i>  <i><a href="https://habr.com/ru/post/472966/">Bagian 2 - Deskriptor dan Kompresi Data</a> .</i> <br><br>  Pembaca yang budiman, saya sekali lagi menyambut Anda untuk pemindahan Pemrograman Tidak Konvensional dalam PHP.  Untuk memahami apa yang terjadi, saya sarankan Anda membaca dua artikel sebelumnya tentang arsip zip: <a href="https://habr.com/ru/post/471066/">Seperti apa bentuk arsip zip dan apa yang bisa kita lakukan dengannya</a> ? <a href="https://habr.com/ru/post/471066/">Seperti apa arsip zip itu</a> <a href="https://habr.com/ru/post/472966/">dan apa yang bisa kita lakukan dengannya.</a>  <a href="https://habr.com/ru/post/472966/">Bagian 2 - Deskriptor dan Kompresi Data</a> <br><br>  Sebelumnya, saya berbicara tentang cara membuat arsip hanya menggunakan kode PHP dan tidak menggunakan perpustakaan dan ekstensi (termasuk <a href="https://www.php.net/manual/ru/book.zip.php">zip</a> standar), dan juga menyebutkan beberapa skenario penggunaan.  Hari ini saya akan mencoba memberikan contoh dari salah satu skenario ini. <br><br>  Kami akan menyimpan gambar dalam arsip di server jauh, dan jika perlu, menunjukkan gambar tertentu kepada pengguna tanpa mengunduh atau membongkar arsip, tetapi hanya menerima data dari server itu sendiri, secara khusus mengambil gambar dan tidak lebih (well, tidak ada yang membatalkan overhead untuk header) tapi tetap saja). <br><a name="habracut"></a><br><h3>  Memasak </h3><br>  Salah satu proyek kesayangan saya memiliki skrip sederhana yang saya gunakan untuk mengunduh banyak gambar dan menyimpannya ke arsip.  Skrip menerima daftar tautan di json untuk memasukkan STDIN, memberikan arsipnya sendiri ke STDOUT, dan json dengan struktur array di STDERR (tentu saja, ini sedikit berlebihan dan tidak perlu membuat arsip menggunakan PHP asli, Anda dapat menggunakan alat yang lebih sesuai untuk ini, dan kemudian hanya baca strukturnya - saya akan mencoba untuk menyoroti poin ini di masa depan, tetapi pada tahap ini, menurut saya, itu akan menjadi lebih jelas). <br><br>  Script ini, dengan beberapa modifikasi, saya kutip di bawah ini: <br><br><div class="spoiler">  <b class="spoiler_title">zip.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof(STDIN)) { $buffer .= fread(STDIN, <span class="hljs-number"><span class="hljs-number">4096</span></span>); } $photos = json_decode($buffer, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); $skeleton = [<span class="hljs-string"><span class="hljs-string">'files'</span></span> =&gt; []]; $written = <span class="hljs-number"><span class="hljs-number">0</span></span>; [$written, $skeleton] = writeZip($written, $skeleton, $photos); $CDFH_Offset = $written; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $index =&gt; $info) { $written += fwrite(STDOUT, $info[<span class="hljs-string"><span class="hljs-string">'CDFH'</span></span>]); $skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index][<span class="hljs-string"><span class="hljs-string">'CDFH'</span></span>] = base64_encode($info[<span class="hljs-string"><span class="hljs-string">'CDFH'</span></span>]); } $skeleton[<span class="hljs-string"><span class="hljs-string">'EOCD'</span></span>] = pack(<span class="hljs-string"><span class="hljs-string">'LSSSSLLS'</span></span>, <span class="hljs-number"><span class="hljs-number">0x06054b50</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $records = count($skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>]), $records, $written - $CDFH_Offset, $CDFH_Offset, <span class="hljs-number"><span class="hljs-number">0</span></span>); $written += fwrite(STDOUT, $skeleton[<span class="hljs-string"><span class="hljs-string">'EOCD'</span></span>]); $skeleton[<span class="hljs-string"><span class="hljs-string">'EOCD'</span></span>] = base64_encode($skeleton[<span class="hljs-string"><span class="hljs-string">'EOCD'</span></span>]); fwrite(STDERR, json_encode($skeleton)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeZip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($written, $skeleton, $files)</span></span></span><span class="hljs-function"> </span></span>{ $c = curl_init(); curl_setopt_array($c, [ CURLOPT_RETURNTRANSFER =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, CURLOPT_TIMEOUT =&gt; <span class="hljs-number"><span class="hljs-number">50</span></span>, CURLOPT_FOLLOWLOCATION =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, ]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($files <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $index =&gt; $url) { $fileName = $index . <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>; $i++ ) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { curl_setopt($c, CURLOPT_URL, $url); [$content, $code, $contentLength] = [ curl_exec($c), (int) curl_getinfo($c, CURLINFO_HTTP_CODE), (int) curl_getinfo($c, CURLINFO_CONTENT_LENGTH_DOWNLOAD) ]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($code !== <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"[{$index}] "</span></span> . <span class="hljs-string"><span class="hljs-string">'Photo download error ('</span></span> . $code . <span class="hljs-string"><span class="hljs-string">'): '</span></span> . curl_error($c)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strlen($content) !== $contentLength) { var_dump(strlen($content), $contentLength); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"[{$index}] "</span></span> . <span class="hljs-string"><span class="hljs-string">'Different content-length'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> === $imageSize = @getimagesizefromstring($content)) || $imageSize[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || $imageSize[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"[{$index}] "</span></span> . <span class="hljs-string"><span class="hljs-string">'Broken image'</span></span>); } [$width, $height] = $imageSize; $t = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\Throwable $t) {} } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($t !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Error: '</span></span> . $index . <span class="hljs-string"><span class="hljs-string">' &gt; '</span></span> . $url, <span class="hljs-number"><span class="hljs-number">0</span></span>, $t); } $fileInfo = [ <span class="hljs-string"><span class="hljs-string">'versionToExtract'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'generalPurposeBitFlag'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'compressionMethod'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'modificationTime'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">28021</span></span>, <span class="hljs-string"><span class="hljs-string">'modificationDate'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">20072</span></span>, <span class="hljs-string"><span class="hljs-string">'crc32'</span></span> =&gt; hexdec(hash(<span class="hljs-string"><span class="hljs-string">'crc32b'</span></span>, $content)), <span class="hljs-string"><span class="hljs-string">'compressedSize'</span></span> =&gt; $size = strlen($content), <span class="hljs-string"><span class="hljs-string">'uncompressedSize'</span></span> =&gt; $size, <span class="hljs-string"><span class="hljs-string">'filenameLength'</span></span> =&gt; strlen($fileName), <span class="hljs-string"><span class="hljs-string">'extraFieldLength'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, ]; $LFH_Offset = $written; $skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index] = [ <span class="hljs-string"><span class="hljs-string">'LFH'</span></span> =&gt; pack(<span class="hljs-string"><span class="hljs-string">'LSSSSSLLLSSa*'</span></span>, <span class="hljs-number"><span class="hljs-number">0x04034b50</span></span>, ...array_values($fileInfo + [<span class="hljs-string"><span class="hljs-string">'filename'</span></span> =&gt; $fileName])), <span class="hljs-string"><span class="hljs-string">'CDFH'</span></span> =&gt; pack(<span class="hljs-string"><span class="hljs-string">'LSSSSSSLLLSSSSSLLa*'</span></span>, <span class="hljs-number"><span class="hljs-number">0x02014b50</span></span>, <span class="hljs-number"><span class="hljs-number">798</span></span>, ...array_values($fileInfo + [ <span class="hljs-string"><span class="hljs-string">'fileCommentLength'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'diskNumber'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'internalFileAttributes'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'externalFileAttributes'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2176057344</span></span>, <span class="hljs-string"><span class="hljs-string">'localFileHeaderOffset'</span></span> =&gt; $LFH_Offset, <span class="hljs-string"><span class="hljs-string">'filename'</span></span> =&gt; $fileName, ])), <span class="hljs-string"><span class="hljs-string">'width'</span></span> =&gt; $width, <span class="hljs-string"><span class="hljs-string">'height'</span></span> =&gt; $height, ]; $written += fwrite(STDOUT, $skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index][<span class="hljs-string"><span class="hljs-string">'LFH'</span></span>]); $written += fwrite(STDOUT, $content); $skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index][<span class="hljs-string"><span class="hljs-string">'LFH'</span></span>] = base64_encode($skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index][<span class="hljs-string"><span class="hljs-string">'LFH'</span></span>]); } curl_close($c); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [$written, $skeleton]; }</code> </pre> </div></div><br>  Mari kita simpan di suatu tempat, panggil zip.php dan coba jalankan. <br><br>  Saya sudah memiliki daftar tautan yang sudah jadi, saya sarankan menggunakannya, karena ada gambar tentang ~ 18MB, dan kita perlu ukuran arsip total tidak melebihi 20MB (sedikit kemudian saya akan memberi tahu alasannya) - <a href="">https://gist.githubusercontent.com /userqq/d0ca3aba6b6762c9ce5bc3ace92a9f9e/raw/70f446eb98f1ba6838ad3c19c3346cba371fd263/photos.json</a> <br><br>  Kami akan berlari seperti ini: <br><br><pre> <code class="bash hljs">$ curl -s \ https://gist.githubusercontent.com/userqq/d0ca3aba6b6762c9ce5bc3ace92a9f9e/raw/70f446eb98f1ba6838ad3c19c3346cba371fd263/photos.json \ | php zip.php \ 2&gt; structure.json \ 1&gt; photos.zip</code> </pre> <br>  Ketika skrip selesai bekerja, pada output kita harus mendapatkan dua file - <i>photos.zip</i> , saya sarankan memeriksanya dengan perintah: <br><br><pre> <code class="bash hljs">$ unzip -tq photos.zip</code> </pre> <br>  dan <i>structure.json</i> , di mana kami menyimpan json dengan base64 dari semua yang ada di arsip kami, kecuali data itu sendiri - semua struktur LFH dan CDFH, serta EOCD.  Saya belum melihat aplikasi praktis EOCD secara terpisah dari arsip, tetapi posisi LFH diimbangi relatif terhadap awal file dan panjang data ditunjukkan dalam CDFH.  Jadi, mengetahui panjangnya LFH, kita tentu bisa tahu dari posisi apa data akan mulai dan di mana itu akan berakhir. <br><br>  Sekarang kita perlu mengunggah file kita ke beberapa server jarak jauh. <br><br>  Sebagai contoh, saya akan menggunakan bot telegram - ini adalah yang termudah, itulah mengapa sangat penting untuk masuk ke dalam batas 20MB. <br><br>  Daftarkan bot dengan @BotFather, jika Anda belum memilikinya, tulis sesuatu untuk bot Anda, cari pesan Anda di <a href="https://api.telegram.org/bot%257B%257BTOKEN%257D%257D/getUpdates">https://api.telegram.org/bot{{TOKEN►►/getUpdates</a> , dari mana kami mengisolasi pesan tersebut dari properti. .id = ini adalah id dari bot obrolan Anda. <br><br>  Isi arsip kami dengan Anda, diperoleh pada langkah sebelumnya: <br><br><pre> <code class="bash hljs">$ curl -F document=@<span class="hljs-string"><span class="hljs-string">"photos.zip"</span></span> <span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/bot{{TOKEN}}/sendDocument?chat_id={{CHAT ID}}"</span></span> &gt; stored.json</code> </pre> <br>  Sekarang kita sudah memiliki dua file json - <i>structure.json</i> dan <i>disimpan.json</i> . <br><br>  Dan jika semuanya berjalan dengan baik, maka file tersimpan.json akan berisi json dengan bidang ok sama dengan true, dan juga result.document.file_id, yang kita butuhkan. <br><br><h3>  Prototipe </h3><br>  Sekarang semuanya sudah siap, mari kita mulai bisnis: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> define(<span class="hljs-string"><span class="hljs-string">'TOKEN'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    $structure = json_decode(file_get_contents('structure.json'), true, 512, JSON_THROW_ON_ERROR); $stored = json_decode(file_get_contents('stored.json'), true, 512, JSON_THROW_ON_ERROR); $selectedFile = $structure['files'][array_rand($structure['files'])]; $LFH = base64_decode($selectedFile['LFH']); $CDFH = base64_decode($selectedFile['CDFH']); $fileLength = unpack('Llen', substr($CDFH, 24, 4))['len']; $fileStart = unpack('Lpos', substr($CDFH, 42, 4))['pos'] + strlen($LFH); $fileEnd = $fileStart + $fileLength; $response = json_decode(file_get_contents('https://api.telegram.org/bot' . TOKEN . '/getFile?' . http_build_query([ 'file_id' =&gt; $stored['result']['document']['file_id'] ])), true, 512, JSON_THROW_ON_ERROR); header('Content-Type: image/jpeg'); readfile('https://api.telegram.org/file/bot' . TOKEN . '/' . $response['result']['file_path'], false, stream_context_create([ 'http' =&gt; ['header' =&gt; "Range: bytes={$fileStart}-{$fileEnd}"] ]));</span></span></code> </pre><br>  Dalam skrip ini, kami memilih file acak dari daftar yang kami miliki di arsip, menemukan posisi awal LFH, menambahkan panjang LFH ke dalamnya, dan dengan demikian mendapatkan posisi awal data dari file tertentu dalam arsip. <br><br>  Menambahkan panjang file ke ini, kita mendapatkan posisi akhir data. <br><br>  Tetap mendapatkan alamat file itu sendiri (ini dalam kasus tertentu dengan telegram) dan kemudian cukup dengan membuat permintaan dengan <code>Range: bytes=&lt;-&gt;-&lt;-&gt;</code> tajuk <code>Range: bytes=&lt;-&gt;-&lt;-&gt;</code> <br><br>  (dengan asumsi server mendukung permintaan Rentang) <br><br>  Akibatnya, ketika mengakses skrip yang ditentukan, kita akan melihat konten gambar acak dari arsip kami. <br><br><h3>  Tidak, yah, ini tidak serius ... </h3><br>  Tidak perlu dikatakan bahwa permintaan untuk <i>getFile</i> harus di-cache, karena telegram menjamin bahwa tautan tersebut akan hidup selama setidaknya satu jam.  Secara umum, contoh ini baik untuk apa-apa selain menunjukkan bahwa itu berfungsi. <br><br>  Mari kita coba sedikit lebih keras - jalankan semuanya dengan amphp.  Lagi pula, orang-orang mendistribusikan statika dalam produksi di node.js, tetapi apa yang mencegah kita (tentu saja, terlepas dari akal sehat)?  Kami juga memiliki sinkronisasi di sini, Anda tahu. <br><br>  Kami membutuhkan 3 paket: <br><br><ul><li>  <b>amphp / http-server</b> - jelas, server tempat kami akan mendistribusikan file </li><li>  <b>amphp / artax</b> - http-client yang dengannya kami akan mengeluarkan data, serta memperbarui tautan langsung ke file dalam cache. </li><li>  <b>amphp / parallel</b> adalah library untuk multithreading dan <b>sebagainya</b> .  Tapi jangan takut, kita hanya perlu SharedMemoryParcel darinya, yang akan melayani kita sebagai cache im-memory. </li></ul><br>  Kami menempatkan dependensi yang diperlukan: <br><br><pre> <code class="bash hljs">$ composer require amphp/http-server amphp/artax amphp/parallel</code> </pre> <br>  Dan tulis ini <br><br><div class="spoiler">  <b class="spoiler_title">Skrip</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> define(<span class="hljs-string"><span class="hljs-string">'TOKEN'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    use Amp\Artax\DefaultClient; use Amp\Artax\Request as ArtaxRequest; use Amp\Http\Server\RequestHandler\CallableRequestHandler; use Amp\Http\Server\Server as HttpServer; use Amp\Http\Server\Request; use Amp\Http\Server\Response; use Amp\Http\Status; use Amp\Parallel\Sync\SharedMemoryParcel; use Amp\Socket; use Psr\Log\NullLogger; require 'vendor/autoload.php'; Amp\Loop::run(function () { $structure = json_decode(file_get_contents('structure.json'), true, 512, JSON_THROW_ON_ERROR); $stored = json_decode(file_get_contents('stored.json'), true, 512, JSON_THROW_ON_ERROR); $parcel = SharedMemoryParcel::create($id = bin2hex(random_bytes(10)), []); $client = new DefaultClient(); $handler = function (Request $request) use ($parcel, $client, $structure, $stored) { $cached = yield $parcel-&gt;synchronized(function (array $value) use ($client, $stored) { if (!isset($value['file_path']) || $value['expires'] &lt;= time()) { $response = yield $client-&gt;request('https://api.telegram.org/bot' . TOKEN . '/getFile?' . http_build_query([ 'file_id' =&gt; $stored['result']['document']['file_id'] ])); $json = json_decode(yield $response-&gt;getBody(), true, 512, JSON_THROW_ON_ERROR); $value = ['file_path' =&gt; $json['result']['file_path'], 'expires' =&gt; time() + 55 * 60]; } return $value; }); $selectedFile = $structure['files'][array_rand($structure['files'])]; $LFH = base64_decode($selectedFile['LFH']); $CDFH = base64_decode($selectedFile['CDFH']); $fileLength = unpack('Llen', substr($CDFH, 24, 4))['len']; $fileStart = unpack('Lpos', substr($CDFH, 42, 4))['pos'] + strlen($LFH); $fileEnd = $fileStart + $fileLength; $request = (new ArtaxRequest('https://api.telegram.org/file/bot' . TOKEN . '/' . $cached['file_path'])) -&gt;withHeader('Range', "bytes={$fileStart}-{$fileEnd}"); $response = yield $client-&gt;request($request); if (!in_array($response-&gt;getStatus(), [200, 206])) { return new Response(Status::SERVICE_UNAVAILABLE, ['content-type' =&gt; 'text/plain'], "Service Unavailable."); } return new Response(Status::OK, ['content-type' =&gt; 'image/jpeg'], $response-&gt;getBody()); }; $server = new HttpServer([Socket\listen("0.0.0.0:10051")], new CallableRequestHandler($handler), new NullLogger); yield $server-&gt;start(); Amp\Loop::onSignal(SIGINT, function (string $watcherId) use ($server) { Amp\Loop::cancel($watcherId); yield $server-&gt;stop(); }); });</span></span></code> </pre></div></div><br>  Apa yang kami dapatkan sebagai hasilnya: kami sekarang memiliki cache tempat kami menyimpan tautan ke dokumen selama 55 menit, yang juga memastikan bahwa kami tidak akan meminta tautan beberapa kali berturut-turut jika kami menerima banyak permintaan pada saat cache berakhir.  Nah, semua ini jelas lebih mudah daripada readfile dengan PHP-FPM (atau, Tuhan melarang, PHP-CGI). <br><br>  Lebih lanjut, Anda dapat meningkatkan kumpulan instance amphp - SharedMemoryParcel, dengan namanya, mengisyaratkan bahwa cache kami akan meleset di antara proses / utas.  Nah, atau, jika Anda masih memiliki keprihatinan yang sehat tentang keandalan desain ini, maka <a href="https://habr.com/ru/post/460685/">proxy_pass dan nginx</a> . <br><br>  Secara umum, idenya masih jauh dari baru dan bahkan di tahun-tahun berjenggot, DownloadMaster memungkinkan Anda untuk mengunduh file tertentu dari arsip Zip tanpa mengunduh seluruh arsip, oleh karena itu tidak perlu menyimpan struktur secara terpisah, tetapi menyimpan beberapa permintaan.  Bagaimana jika, misalnya, kami ingin mem-proxy file ke pengguna dengan cepat, itu sangat memengaruhi kecepatan permintaan. <br><br>  Mengapa ini bisa berguna?  Untuk menyimpan inode, misalnya, ketika Anda memiliki puluhan juta file kecil dan tidak ingin menyimpannya secara langsung dalam database, Anda dapat menyimpannya dalam arsip, mengetahui offset untuk menerima satu file. <br><br>  Atau jika Anda menyimpan file dari jarak jauh.  Dalam telegram, 20mb, tentu saja, Anda tidak bisa berkeliling, tetapi siapa tahu, ada opsi lain. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id484520/">https://habr.com/ru/post/id484520/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id484504/index.html">Membuat ionizer udara kurang dari $ 10</a></li>
<li><a href="../id484506/index.html">Saya seorang fotografer dan saya akan menjadikan diri saya alat yang berfungsi</a></li>
<li><a href="../id484512/index.html">TOP 25 ICO terbesar: ada apa dengan mereka sekarang?</a></li>
<li><a href="../id484514/index.html">Routing Universal untuk Aplikasi Bereaksi</a></li>
<li><a href="../id484518/index.html">Kami mendapatkan video dari kamera melalui DVRIP menggunakan PHP</a></li>
<li><a href="../id484522/index.html">Konferensi DEFCON 27. Peretasan polisi. Bagian 2</a></li>
<li><a href="../id484526/index.html">Mempersiapkan proyek SDL2 untuk dijalankan di android</a></li>
<li><a href="../id484528/index.html">Bagaimana saya memindahkan proyek hobi saya ke k8s</a></li>
<li><a href="../id484530/index.html">Mesin CNC untuk pemrosesan plasma / modifikasi bahan polimer</a></li>
<li><a href="../id484532/index.html">Tentang makna geometris kode Gray</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>