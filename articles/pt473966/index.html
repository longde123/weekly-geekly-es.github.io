<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêΩ üèõÔ∏è üõµ A pedido dos desenvolvedores incorporados: detectando erros no Amazon FreeRTOS üïå üë©üèº‚Äçüíº ‚óªÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qualquer pessoa que programa microcontroladores provavelmente conhece o FreeRTOS, ou pelo menos ouviu falar desse sistema operacional. Os desenvolvedo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>A pedido dos desenvolvedores incorporados: detectando erros no Amazon FreeRTOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/473966/">  Qualquer pessoa que programa microcontroladores provavelmente conhece o FreeRTOS, ou pelo menos ouviu falar desse sistema operacional.  Os desenvolvedores da Amazon decidiram aprimorar as habilidades desse sistema operacional para trabalhar com os servi√ßos da AWS Internet of Things.  Foi assim que o Amazon FreeRTOS apareceu.  N√≥s, desenvolvedores do analisador de c√≥digo est√°tico do PVS-Studio, fomos solicitados por correio e em coment√°rios para verificar esses projetos.  Bem, agora pegue o que voc√™ pediu.  Continue lendo para descobrir o que saiu disso. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cee/9b7/a98/cee9b7a984f45dc365b4baea89adb019.png"></div><br><a name="habracut"></a><br><h2>  Brevemente sobre projetos </h2><br>  Para come√ßar, vou falar um pouco sobre o precursor do projeto que est√° sendo testado - FreeRTOS (o c√≥digo-fonte est√° dispon√≠vel aqui por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ).  Como afirma a Wikipedia, o FreeRTOS √© um sistema operacional multitarefa em tempo real para sistemas embarcados. <br><br>  Est√° escrito no bom e velho C, o que n√£o √© de surpreender - este sistema operacional deve funcionar em condi√ß√µes t√≠picas de microcontroladores: baixo poder de processamento, uma pequena quantidade de RAM e similares.  A linguagem C permite que voc√™ trabalhe com recursos em um n√≠vel baixo e tenha alto desempenho, portanto, √© mais adequado para desenvolver um sistema operacional desse tipo. <br><br>  Agora, de volta √† Amazon, que est√° sempre em movimento, desenvolvendo v√°rias dire√ß√µes promissoras.  Por exemplo, a Amazon est√° desenvolvendo um mecanismo AAA Amazon Lumberyard, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tamb√©m verificamos</a> . <br><br>  Uma dessas dire√ß√µes √© a Internet das Coisas (IoT).  Para se desenvolver nessa √°rea, a Amazon decidiu criar seu pr√≥prio sistema operacional - e eles tomaram o n√∫cleo do FreeRTOS como base. <br><br>  O sistema resultante, o Amazon FreeRTOS, est√° posicionado para "fornecer uma conex√£o segura ao Amazon Web Services, como o AWS IoT Core ou o AWS IoT Greengrass".  O c√≥digo fonte deste projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° dispon√≠vel</a> no Github. <br><br>  Neste artigo, descobriremos se h√° erros no FreeRTOS, bem como a seguran√ßa do sistema operacional Amazon em termos de an√°lise de c√≥digo est√°tico. <br><br><h2>  O curso da verifica√ß√£o </h2><br>  A verifica√ß√£o foi realizada usando a ferramenta de busca autom√°tica de erros - o analisador de c√≥digo est√°tico PVS-Studio.  √â capaz de detectar erros em programas escritos em C, C ++, C # e Java. <br><br>  Antes da an√°lise, temos que construir o projeto.  Dessa forma, estarei confiante de que tenho todas as depend√™ncias necess√°rias e que o projeto est√° pronto para ser verificado.  Pode-se verificar o projeto de v√°rias maneiras - por exemplo, usando um sistema de monitoramento de compila√ß√£o.  Nesse caso, eu realizei a an√°lise usando o plug-in do Visual Studio - √© bom que os reposit√≥rios de ambos os projetos contenham os conjuntos de arquivos de projeto que facilitam a compila√ß√£o no Windows. <br><br>  Eu apenas tive que criar projetos para ter tudo pronto para a verifica√ß√£o.  Em seguida, executei a an√°lise e - voila!  - Eu tenho um relat√≥rio de analisador pronto na minha frente. <br><br>  As bibliotecas de terceiros inclu√≠das nesses projetos tamb√©m podem conter erros e, √© claro, tamb√©m podem afetar o programa.  No entanto, eu os exclu√≠ da an√°lise por uma quest√£o de pureza da narrativa. <br><br>  Assim, os projetos s√£o analisados, os relat√≥rios s√£o recebidos, erros interessantes s√£o destacados.  √â hora de obter a sua revis√£o! <br><br><h2>  O que o FreeRTOS oculta </h2><br>  Inicialmente, esperava escrever dois artigos separados: um para cada sistema operacional.  Eu j√° estava esfregando as m√£os?  enquanto eu me preparava para escrever um bom artigo sobre o FreeRTOS.  Antecipando a descoberta de pelo menos alguns erros interessantes (como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CWE-457</a> ), eu estava observando avisos esparsos do analisador e ... n√£o encontrei nada.  N√£o encontrei nenhum erro interessante. <br><br>  Muitos dos avisos emitidos pelo analisador n√£o eram relevantes para o FreeRTOS.  Por exemplo, esses avisos eram falhas de 64 bits, como <i>converter tamanho_t</i> para <i>uint32_t</i> .  Isso est√° relacionado ao fato de o FreeRTOS estar funcionando em dispositivos com um tamanho de ponteiro n√£o superior a 32 bits. <br><br>  Eu verifiquei minuciosamente todos os avisos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V1027</a> indicando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vazamentos</a> entre ponteiros para estruturas n√£o relacionadas.  Se as estruturas fundidas tiverem o mesmo alinhamento, esse vazamento ser√° um erro.  E eu n√£o encontrei um √∫nico elenco perigoso! <br><br>  Todos os outros lugares suspeitos estavam associados ao estilo de codifica√ß√£o ou receberam um coment√°rio explicando por que foi feito dessa maneira e por que n√£o foi um erro. <br><br>  Ent√£o, eu gostaria de atrair os desenvolvedores do FreeRTOS.  Gente, voc√™ √© demais!  Quase n√£o vimos projetos t√£o limpos e de alta qualidade como o seu.  E foi um prazer ler o c√≥digo limpo, limpo e bem documentado.  Tiremos o chap√©u para voc√™s. <br><br>  Mesmo n√£o encontrando nenhum bug interessante naquele dia, eu sabia que n√£o iria parar por a√≠.  Eu estava voltando para casa com a firme confian√ßa de que a vers√£o da Amazon teria 100% de algo interessante e que amanh√£ eu definitivamente pegaria bugs suficientes para o artigo.  Como voc√™ deve ter adivinhado, eu estava certa. <br><br><h2>  O que o Amazon FreeRTOS oculta </h2><br>  A vers√£o do sistema da Amazon acabou sendo ... para dizer o m√≠nimo, um pouco pior.  O legado do FreeRTOS permaneceu t√£o limpo, enquanto as novas melhorias ocultaram muitas quest√µes interessantes. <br><br>  Alguns fragmentos tiveram a l√≥gica do programa quebrada, alguns manipularam ponteiros incorretamente.  Em alguns lugares, o c√≥digo pode levar a um comportamento indefinido, e houve casos em que o programador simplesmente n√£o sabia sobre o padr√£o de erro que cometeu.  Eu at√© encontrei v√°rias vulnerabilidades potenciais s√©rias. <br><br>  Parece que eu reforcei a introdu√ß√£o.  Vamos come√ßar a descobrir erros! <br><br><h3>  Quebra da l√≥gica do programa </h3><br>  Vamos come√ßar com lugares problem√°ticos que obviamente indicam que o programa n√£o funciona da maneira esperada pelo programador.  O manuseio suspeito de matrizes vir√° primeiro: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Pool of request and associated response buffers, * handles, and configurations. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> _requestPool_t _requestPool = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _scheduleAsyncRequest(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reqIndex, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currentRange) { .... <span class="hljs-comment"><span class="hljs-comment">/* Set the user private data to use in the asynchronous callback context. */</span></span> _requestPool.pRequestDatas[reqIndex].pConnHandle = &amp;_connHandle; _requestPool.pRequestDatas[reqIndex].pConnConfig = &amp;_connConfig; _requestPool.pRequestDatas[reqIndex].reqNum = reqIndex; _requestPool.pRequestDatas[reqIndex].currRange = currentRange; _requestPool.pRequestDatas[reqIndex].currDownloaded = <span class="hljs-number"><span class="hljs-number">0</span></span>; _requestPool.pRequestDatas[reqIndex].numReqBytes = numReqBytes; .... _requestPool.pRequestDatas-&gt;scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  O PVS-Studio emitiu dois avisos para este trecho de c√≥digo: <br><br><ul><li>  V619 A matriz '_requestPool.pRequestDatas' est√° sendo utilizada como um ponteiro para um √∫nico objeto.  iot_demo_https_s3_download_async.c 973 </li><li>  V574 O ponteiro '_requestPool.pRequestDatas' √© usado simultaneamente como uma matriz e como um ponteiro para um √∫nico objeto.  Verifique as linhas: 931, 973. iot_demo_https_s3_download_async.c 973 </li></ul><br>  Apenas para o caso, deixe-me lembr√°-lo: o nome da matriz √© o ponteiro para o seu primeiro elemento.  Ou seja, se <i>_requestPool.pRequestDatas</i> for uma matriz de estruturas, <i>_requestPool.pRequestDatas [i] .scheduled</i> √© uma avalia√ß√£o do membro <i>agendado</i> da estrutura da matriz <i>i.E</i> se escrevermos <i>_requestPool.pRequestDatas-&gt; agendadas</i> , ser√° poss√≠vel que um membro da primeira estrutura de array ser√° acessado. <br><br>  No trecho do c√≥digo acima, √© o que acontece.  Na √∫ltima linha, o valor apenas do membro da primeira estrutura da matriz √© alterado.  Por si s√≥, esse acesso j√° √© suspeito, mas aqui o caso √© ainda mais claro: a matriz <i>_requestPool.pRequestDatas</i> √© avaliada por √≠ndice em todo o corpo da fun√ß√£o.  Mas no final, a opera√ß√£o de indexa√ß√£o foi esquecida. <br><br>  Pelo que entendi, a √∫ltima linha deve ficar assim: <br><br><pre> <code class="cpp hljs">_requestPool.pRequestDatas[reqIndex].scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br>  O pr√≥ximo erro est√° em uma fun√ß√£o pequena, ent√£o eu darei isso completamente: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Return true if the string " pcString" is found * inside the token pxTok in JSON file pcJson. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BaseType_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvGGDJsoneq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcJson, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">jsmntok_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pxTok, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcString )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ulStringSize = ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;end - ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;start; BaseType_t xStatus = pdFALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pxTok-&gt;type == JSMN_STRING ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>( pcString ) == ulStringSize ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>( &amp;pcJson[ pxTok-&gt;start ], <span class="hljs-comment"><span class="hljs-comment">// &lt;= pcString, ulStringSize ) == 0 ) { xStatus = pdTRUE; } } } return xStatus; }</span></span></code> </pre> <br>  <b>Aviso do PVS-Studio:</b> V642 [CWE-197] Salvar o resultado da fun√ß√£o 'strncmp' dentro da vari√°vel do tipo 'curto' √© inadequado.  Os bits significativos podem ser perdidos quebrando a l√≥gica do programa.  aws_greengrass_discovery.c 637 <br><br>  Vamos dar uma olhada na defini√ß√£o da fun√ß√£o strncmp: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strncmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count )</span></span></span></span>;</code> </pre> <br>  No exemplo, o resultado do tipo <i>int</i> , com tamanho de 32 bits, √© convertido em uma vari√°vel do tipo <i>int16_t</i> .  Com essa convers√£o "restritiva", os bits mais antigos do valor retornado ser√£o perdidos.  Por exemplo, se a fun√ß√£o <i>strncmp</i> retornar <i>0x00010000</i> , a unidade ser√° perdida durante a convers√£o e a condi√ß√£o ser√° executada. <br><br>  √â realmente estranho ver esse elenco na condi√ß√£o.  Por que √© necess√°rio aqui, se um <i>int</i> comum pode ser comparado a zero?  Por outro lado, se um programador desejava que essa fun√ß√£o √†s vezes retornasse <i>verdadeira,</i> mesmo que n√£o devesse, por que n√£o apoiar um comportamento t√£o complicado com um coment√°rio?  Mas desta forma √© algum tipo de backdoor.  Enfim, estou inclinado a pensar que √© um erro.  O que voc√™ acha? <br><br><h3>  Comportamento indefinido e indicadores </h3><br>  Aqui vem um grande exemplo.  Ele cobre uma desrefer√™ncia potencial de ponteiro nulo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _networkReceiveCallback(....) { IotHttpsReturnCode_t status = IOT_HTTPS_OK; _httpsResponse_t* pCurrentHttpsResponse = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; IotLink_t* pQItem = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">/* Get the response from the response queue. */</span></span> IotMutex_Lock(&amp;(pHttpsConnection-&gt;connectionMutex)); pQItem = IotDeQueue_PeekHead(&amp;(pHttpsConnection-&gt;respQ)); IotMutex_Unlock(&amp;(pHttpsConnection-&gt;connectionMutex)); <span class="hljs-comment"><span class="hljs-comment">/* If the receive callback is invoked * and there is no response expected, * then this a violation of the HTTP/1.1 protocol. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pQItem == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { IotLogError(....); fatalDisconnect = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; status = IOT_HTTPS_NETWORK_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> iotCleanup; } .... iotCleanup : <span class="hljs-comment"><span class="hljs-comment">/* Report errors back to the application. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != IOT_HTTPS_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pCurrentHttpsResponse-&gt;isAsync &amp;&amp; pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback) { pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback(....); } pCurrentHttpsResponse-&gt;syncStatus = status; } .... }</code> </pre> <br>  <b>Aviso do PVS-Studio:</b> V522 [CWE-690] Pode haver desreferenciamento de um ponteiro nulo em potencial 'pCurrentHttpsResponse'.  iot_https_client.c 1184 <br><br>  O √∫ltimo bloco <i>if</i> cont√©m desrefer√™ncias problem√°ticas.  Vamos descobrir o que est√° acontecendo aqui. <br><br>  A fun√ß√£o come√ßa com as vari√°veis <i>pCurrentHttpsResponse</i> e <i>pQItem</i> inicializadas pelo valor <i>NULL</i> e a vari√°vel <i>status</i> √© inicializada pelo valor <i>IOT_HTTPS_OK</i> , o que significa que est√° tudo correto. <br><br>  A <i>pQItem</i> adicional √© atribu√≠do o valor, retornado da fun√ß√£o <i>IotDeQueue_PeekHead</i> , que retorna o ponteiro para o in√≠cio da fila com v√≠nculo duplo. <br><br>  O que acontece se a fila estiver vazia?  Nesse caso, a fun√ß√£o <i>IotDeQueue_PeekHead</i> retornar√° <i>NULL:</i> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotDeQueue_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotDeQueue_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pQueue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IotListDouble_PeekHead(pQueue); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotListDouble_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotListDouble_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pList)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* @[declare_linear_containers_list_double_peekhead] */</span></span></span><span class="hljs-function"> </span></span>{ IotLink_t* pHead = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pList != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IotListDouble_IsEmpty(pList) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { pHead = pList-&gt;pNext; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pHead; }</code> </pre> <br>  Al√©m disso, a condi√ß√£o <i>pQItem == NULL</i> se tornar√° verdadeira e o fluxo de controle ser√° passado por <i>goto</i> para a parte inferior da fun√ß√£o.  A essa altura, o ponteiro <i>pCurrentHttpsResponse</i> permanecer√° nulo, enquanto o <i>status</i> n√£o ser√° igual a <i>IOT_HTTPS_OK</i> .  No final, chegaremos ao mesmo <i>se</i> ramo, e ... boom!  Bem, voc√™ conhece as conseq√º√™ncias de tal desrefer√™ncia. <br><br>  Ok  Foi um exemplo um pouco complicado.  Agora, sugiro que voc√™ d√™ uma olhada em uma desreferencia√ß√£o potencial muito simples e compreens√≠vel: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PKI_mbedTLSSignatureToPkcs11Signature</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxSignaturePKCS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxMbedSignature )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xReturn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> * pxNextLength; <span class="hljs-comment"><span class="hljs-comment">/* The 4th byte contains the length of the R component */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ucSigComponentLength = pxMbedSignature[ <span class="hljs-number"><span class="hljs-number">3</span></span> ]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if( ( pxSignaturePKCS == NULL ) || ( pxMbedSignature == NULL ) ) { xReturn = FAILURE; } .... }</span></span></code> </pre> <br>  <b>Aviso do PVS-Studio:</b> V595 [CWE-476] O ponteiro 'pxMbedSignature' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 52, 54. iot_pki_utils.c 52 <br><br>  Esta fun√ß√£o recebe ponteiros para <i>uint8_t</i> .  Ambos os ponteiros s√£o verificados quanto a <i>NULL</i> , o que √© uma boa pr√°tica - essas situa√ß√µes devem ser resolvidas imediatamente. <br><br>  Mas aqui est√° o problema: quando o <i>pxMbedSignature</i> for verificado, ele j√° ser√° desreferenciado literalmente uma linha acima.  Ta-daa! <br><br>  Outro exemplo de c√≥digo especulativo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">CK_RV </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vAppendSHA256AlgorithmIdentifierSequence</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x32ByteHashedMessage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x51ByteHashOidBuffer )</span></span></span><span class="hljs-function"> </span></span>{ CK_RV xResult = CKR_OK; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> xOidSequence[] = pkcs11STUFF_APPENDED_TO_RSA_SIG; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( x32ByteHashedMessage == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) || ( x51ByteHashOidBuffer == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) ) { xResult = CKR_ARGUMENTS_BAD; } <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( x51ByteHashOidBuffer, xOidSequence, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( &amp;x51ByteHashOidBuffer[ <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ], x32ByteHashedMessage, <span class="hljs-number"><span class="hljs-number">32</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xResult; }</code> </pre> <br>  <b>Avisos do PVS-Studio:</b> <br><br><ul><li>  V1004 [CWE-628] O ponteiro 'x51ByteHashOidBuffer' foi usado sem seguran√ßa ap√≥s ser verificado com rela√ß√£o ao nullptr.  Verifique as linhas: 275, 280. iot_pkcs11.c 280 </li><li>  V1004 [CWE-628] O ponteiro 'x32ByteHashedMessage' foi usado sem seguran√ßa ap√≥s ser verificado no nullptr.  Verifique as linhas: 275, 281. iot_pkcs11.c 281 </li></ul><br>  O analisador avisa que os par√¢metros de fun√ß√£o que s√£o ponteiros s√£o usados ‚Äã‚Äãcom seguran√ßa ap√≥s a verifica√ß√£o de <i>NULL</i> .  De fato, os argumentos s√£o verificados.  Mas, se algum deles n√£o for <i>NULL</i> , nenhuma a√ß√£o ser√° tomada, exceto a escrita em <i>xResult.</i>  Esta se√ß√£o do c√≥digo diz: "Sim, ent√£o os argumentos acabaram sendo ruins.  Vamos notar agora, e voc√™ - continue, continue. <br><br>  Resultado: <i>NULL</i> ser√° passado para o <i>memcpy.</i>  O que pode resultar disso?  Onde os valores ser√£o copiados e quais?  De fato, adivinhar n√£o ajudar√°, pois o padr√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">afirma claramente</a> que essa chamada leva a um comportamento indefinido (consulte a se√ß√£o 1). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf7/7d6/856/cf77d6856666f6a1529a1744832bd5bf.png" alt="Figura 3"></div><br><br>  Existem outros exemplos de manipula√ß√£o incorreta de ponteiros no relat√≥rio do analisador encontrado no Amazon FreeRTOS, mas acho que dados exemplos s√£o suficientes para mostrar os recursos do PVS-Studio na detec√ß√£o de tais erros.  Vamos dar uma olhada em algo novo. <br><br><h3>  VERDADEIRO! = 1 </h3><br>  Houve v√°rios erros relacionados ao padr√£o, os quais, infelizmente, geralmente s√£o ignorados. <br><br>  O fato √© que o tipo <i>bool</i> (de C ++) √© diferente do tipo <i>BOOL</i> (comumente usado em C).  O primeiro pode conter apenas um valor <i>verdadeiro</i> ou <i>falso</i> .  O segundo √© o typedef de um tipo inteiro ( <i>int</i> , <i>long</i> e outros).  O valor <i>0</i> √© "false" para ele e qualquer outro valor diferente de zero √© "true". <br><br>  Como n√£o h√° tipo booleano interno em C, essas constantes s√£o definidas por conveni√™ncia: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FALSE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TRUE 1</span></span></code> </pre> <br>  Vejamos o exemplo. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mbedtls_hardware_poll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* output, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* olen)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lStatus = MBEDTLS_ERR_ENTROPY_SOURCE_FAILED; HCRYPTPROV hProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Unferenced parameter. */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)data; <span class="hljs-comment"><span class="hljs-comment">/* * This is port-specific for the Windows simulator, * so just use Crypto API. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptAcquireContextA( &amp;hProv, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptGenRandom(hProv, len, output)) { lStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; *olen = len; } CryptReleaseContext(hProv, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lStatus; }</code> </pre> <br>  <b>Avisos do PVS-Studio:</b> <br><br><ul><li>  V676 [CWE-253] √â incorreto comparar a vari√°vel do tipo BOOL com TRUE.  aws_entropy_hardware_poll.c 48 </li><li>  V676 [CWE-253] √â incorreto comparar a vari√°vel do tipo BOOL com TRUE.  A express√£o correta √©: 'FALSE! = CryptGenRandom (hProv, len, output)'.  aws_entropy_hardware_poll.c 51 </li></ul><br>  Voc√™ encontrou um erro?  N√£o duvide, est√° aqui :) As fun√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><i>CryptAcquireContextA</i></a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><i>CryptGenRandom</i></a> s√£o fun√ß√µes padr√£o do cabe√ßalho <i>wincrypt.h</i> .  Se for bem-sucedido, eles retornam o valor diferente de zero.  Deixe-me enfatizar que √© <i>diferente de zero</i> .  Portanto, teoricamente, poderia haver qualquer valor diferente de zero: <i>1</i> , <i>314</i> , <i>42</i> , <i>420</i> . <br><br>  Aparentemente, o programador que estava escrevendo a fun√ß√£o a partir do exemplo n√£o estava pensando nisso e, no final, os valores resultantes s√£o comparados a um. <br><br>  Qual a probabilidade de a condi√ß√£o <i>TRUE == CryptGenRandom (....)</i> n√£o ser atendida?  Dif√≠cil dizer.  Talvez, <i>CryptGenRandom</i> possa retornar 1 com mais frequ√™ncia do que outros valores, mas talvez retorne apenas 1. N√£o podemos ter certeza disso: a implementa√ß√£o dessa fun√ß√£o criptogr√°fica est√° oculta aos olhos dos programadores mortais :) <br><br>  √â importante lembrar que essas compara√ß√µes s√£o potencialmente perigosas.  Em vez de: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == GetBOOL())</code> </pre> <br>  Use uma vers√£o mais segura do c√≥digo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FALSE != GetBOOL())</code> </pre> <br><h3>  Problemas de otimiza√ß√£o </h3><br>  V√°rios avisos do analisador estavam relacionados a estruturas de opera√ß√£o lenta.  Por exemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">"/"</span></span>); .... }</code> </pre> <br>  <b>Aviso do PVS-Studio:</b> V817 √â mais eficiente procurar o caractere '/' do que uma string.  iot_demo_https_common.c 205 <br><br>  √â curto e simples, n√£o √©?  A fun√ß√£o <i>strstr</i> √© usada aqui para pesquisar apenas um caractere, passado no par√¢metro como uma string (est√° entre aspas duplas). <br><br>  Este local pode potencialmente ser otimizado substituindo <i>strstr</i> por <i>strchr</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); .... }</code> </pre> <br>  Dessa forma, a pesquisa funcionar√° um pouco mais r√°pido.  Uma coisa pequena, mas agrad√°vel. <br><br>  Bem, essas otimiza√ß√µes s√£o boas, mas o analisador tamb√©m encontrou outro lugar, que poderia ser otimizado de uma maneira muito mais percept√≠vel: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vRunOTAUpdateDemo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { .... xConnectInfo.cleanSession = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; xConnectInfo.clientIdentifierLength = (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(clientcredentialIOT_THING_NAME); xConnectInfo.pClientIdentifier = clientcredentialIOT_THING_NAME; .... } }</code> </pre> <br>  <b>Aviso do PVS-Studio:</b> V814 Desempenho reduzido.  A fun√ß√£o 'strlen' foi chamada v√°rias vezes dentro do corpo de um loop.  aws_iot_ota_update_demo.c 235 <br><br>  Hmm ... Dentro do loop, a cada itera√ß√£o, chama-se <i>strlen</i> que avalia o comprimento da mesma linha a cada vez.  N√£o √© a opera√ß√£o mais eficaz :) <br><br>  Vamos dar uma olhada na defini√ß√£o de <i>clientcredentialIOT_THING_NAME</i> : <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * @brief Host name. * * @todo Set this to the unique name of your IoT Thing. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> clientcredentialIOT_THING_NAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span></span></code> </pre> <br>  O usu√°rio √© solicitado a inserir o nome do dispositivo aqui.  Por padr√£o, est√° vazio e, neste caso, est√° tudo bem.  E se um usu√°rio quiser inserir um nome longo e bonito l√°?  Por exemplo, eu adoraria chamar minha ideia de " <i>A m√°quina de caf√© apaixonada e sofisticada BarBarista-N061E, The Ultimate Edition</i> ".  Voc√™ pode imaginar como seria minha surpresa se minha linda m√°quina de caf√© come√ßasse a trabalhar um pouco mais devagar depois disso?  Inc√¥modo! <br><br>  Para corrigir o erro, vale a pena tomar <i>strlen</i> fora do loop do corpo.  Afinal, o nome do dispositivo n√£o muda durante o funcionamento do programa.  Oh, <i>constexpr</i> de C ++ seria perfeitamente aqui ... <br><br>  Ok, bem, n√£o vamos dourar o l√≠rio.  Como observou meu colega Andrey Karpov, os compiladores modernos sabem o que √© <i>strlen</i> e ele pessoalmente os assistia usando uma constante em c√≥digo bin√°rio se entender que o comprimento da linha n√£o pode mudar.  Portanto, h√° uma boa chance de que, no modo de compila√ß√£o do release, em vez de uma avalia√ß√£o real do comprimento da linha, o valor pr√©-avaliado seja usado.  No entanto, isso nem sempre funciona, portanto, escrever esse c√≥digo n√£o √© uma boa pr√°tica. <br><br><h2>  Algumas palavras sobre MISRA </h2><br>  O analisador PVS-Studio possui um grande conjunto de regras para verificar seu c√≥digo quanto √† conformidade com os padr√µes MISRA C e MISRA C.  Quais s√£o esses padr√µes? <br><br>  MISRA √© o padr√£o de codifica√ß√£o para sistemas embarcados altamente respons√°veis.  Ele cont√©m um conjunto de regras e diretrizes estritas para escrever c√≥digo e configurar um processo de desenvolvimento.  Essas regras s√£o bastante e visam n√£o apenas eliminar erros graves, mas tamb√©m v√°rios "odores de c√≥digo".  Tamb√©m visa escrever o c√≥digo mais compreens√≠vel e leg√≠vel. <br><br>  Portanto, seguir o padr√£o MISRA n√£o apenas ajuda a evitar erros e vulnerabilidades, mas tamb√©m reduz significativamente a probabilidade de aparecerem no c√≥digo j√° existente. <br><br>  O MISRA √© usado nas ind√∫strias aeroespacial, m√©dica, automotiva e militar, onde as vidas humanas dependem da qualidade do software incorporado. <br><br>  Aparentemente, os desenvolvedores do Amazon FreeRTOS conhecem esse padr√£o e geralmente o seguem.  Essa abordagem √© absolutamente razo√°vel: se voc√™ escreve um sistema operacional de base ampla para sistemas embarcados, deve pensar em seguran√ßa. <br><br>  No entanto, eu encontrei muitas viola√ß√µes do padr√£o MISRA.  N√£o vou dar exemplos de regras como "n√£o use uni√£o" ou "fun√ß√£o deve ter apenas um retorno no final do corpo" - infelizmente, elas n√£o s√£o espetaculares, como a maioria das regras MISRA.  Prefiro dar exemplos de viola√ß√µes que podem levar a s√©rias conseq√º√™ncias. <br><br>  Vamos come√ßar com macros: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FreeRTOS_ms_to_tick(ms) ( ( ms * configTICK_RATE_HZ + 500 ) / 1000 )</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SOCKETS_htonl( ulIn ) ( ( uint32_t ) \ ( ( ( ulIn &amp; 0xFF ) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 24 ) | ( ( ulIn &amp; 0xFF00 ) &lt;&lt; 8 ) \ | ( ( ulIn &amp; 0xFF0000 ) &gt;&gt; 8 ) | ( ( ulIn &amp; 0xFF000000 ) &gt;&gt; 24 ) ) )</span></span></span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEFT_ROTATE( x, c ) ( ( x </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; c ) | ( x &gt;&gt; ( 32 - c ) ) )</span></span></span></span></code> </pre> <br>  <b>Avisos do PVS-Studio:</b> <br><br><ul><li>  V2546 [MISRA C 20.7] A macro e seus par√¢metros devem estar entre par√™nteses.  Considere inspecionar o par√¢metro 'ms' da macro 'FreeRTOS_ms_to_tick'.  FreeRTOS_IP.h 201 </li><li>  V2546 [MISRA C 20.7] A macro e seus par√¢metros devem estar entre par√™nteses.  Considere inspecionar o par√¢metro 'ulIn' da macro 'SOCKETS_htonl'.  iot_secure_sockets.h 512 </li><li>  V2546 [MISRA C 20.7] A macro e seus par√¢metros devem estar entre par√™nteses.  Considere inspecionar os par√¢metros 'x', 'c' da macro 'LEFT_ROTATE'.  iot_device_metrics.c 90 </li></ul><br>  Sim, √© exatamente isso que voc√™ est√° pensando.  Os par√¢metros dessas macros n√£o est√£o entre colchetes.  Se algu√©m acidentalmente escreve algo como <br><br><pre> <code class="cpp hljs">val = LEFT_ROTATE(A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span>, B);</code> </pre> <br>  essa "chamada" de uma macro ser√° expandida para: <br><br><pre> <code class="cpp hljs">val = ( ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; B ) | ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; ( <span class="hljs-number"><span class="hljs-number">32</span></span> - B ) ) );</code> </pre> <br>  Lembra das prioridades das opera√ß√µes?  Primeiro, √© feita uma mudan√ßa bit a bit, e somente depois dela - um bit ou "bit".  Portanto, a l√≥gica do programa ser√° quebrada.  Um exemplo mais simples: o que aconteceria se a express√£o " <i>x + y</i> " fosse passada na macro <i>FreeRTOS_ms_to_tick</i> ?  Um dos principais objetivos do MISRA √© evitar tais situa√ß√µes. <br><br>  Alguns podem argumentar: "Se voc√™ tem programadores que n√£o sabem disso, nenhum padr√£o pode ajud√°-lo!"  Eu n√£o vou concordar com isso.  Os programadores tamb√©m s√£o pessoas e, por mais experiente que seja, tamb√©m podem se cansar e cometer um erro no final do dia.  Essa √© uma das raz√µes pelas quais a MISRA recomenda enfaticamente o uso de ferramentas de an√°lise autom√°tica para testar a conformidade de um projeto. <br><br>  Deixe-me abordar os desenvolvedores do Amazon FreeRTOS: O PVS-Studio encontrou mais 12 macros inseguras, ent√£o voc√™ precisa ter cuidado com elas :) <br><br>  Outra viola√ß√£o interessante de MISRA: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Callback for an asynchronous request to notify * that the response is complete. * * @param[in] 0pPrivData - User private data configured * with the HTTPS Client library request configuration. * @param[in] respHandle - Identifier for the current response finished. * @param[in] rc - Return code from the HTTPS Client Library * signaling a possible error. * @param[in] status - The HTTP response status. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _responseCompleteCallback(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pPrivData, IotHttpsResponseHandle_t respHandle, IotHttpsReturnCode_t rc, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> status) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* pUploadSuccess = (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>*)pPrivData; <span class="hljs-comment"><span class="hljs-comment">/* When the remote server response with 200 OK, the file was successfully uploaded. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == IOT_HTTPS_STATUS_OK) { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Post to the semaphore that the upload is finished. */</span></span> IotSemaphore_Post(&amp;(_uploadFinishedSem)); }</code> </pre> <br>  Voc√™ pode encontrar o bug voc√™ mesmo? <br><br>  <b>Aviso do PVS-Studio: As</b> fun√ß√µes V2537 [MISRA C 2.7] n√£o devem ter par√¢metros n√£o utilizados.  Considere inspecionar o par√¢metro: 'rc'.  iot_demo_https_s3_upload_async.c 234 <br><br>  D√™ uma olhada: o par√¢metro <i>rc</i> n√£o √© usado em nenhum lugar do corpo da fun√ß√£o.  Enquanto o coment√°rio da fun√ß√£o diz claramente que esse par√¢metro √© um c√≥digo de retorno de outra fun√ß√£o e que pode sinalizar um erro.  Por que esse par√¢metro n√£o √© tratado de forma alguma?  Algo est√° claramente errado aqui. <br><br>  No entanto, mesmo sem esses coment√°rios, os par√¢metros n√£o utilizados frequentemente apontam para a l√≥gica quebrada do programa.  Caso contr√°rio, por que voc√™ precisa deles na assinatura da fun√ß√£o? <br><br>  Aqui eu dei uma pequena fun√ß√£o que √© boa para um exemplo no artigo.  Al√©m disso, encontrei 10 outros par√¢metros n√£o utilizados.  Muitos deles s√£o usados ‚Äã‚Äãem fun√ß√µes maiores e n√£o √© f√°cil detect√°-los. <br><br>  Suspeita, eles n√£o foram encontrados antes.  Afinal, os compiladores detectam facilmente esses casos. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b80/6c7/bb9/b806c7bb94c335ce2712e9b46cffc560.png" alt="Figura 1"></div><br><br><h2>  Conclus√£o </h2><br>  Esses n√£o foram todos os problemas encontrados pelo analisador, mas o artigo j√° se mostrou bastante amplo.  Espero que, gra√ßas a isso, os desenvolvedores do Amazon FreeRTOS sejam capazes de corrigir algumas das defici√™ncias e talvez queiram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">experimentar o PVS-Studio</a> por conta pr√≥pria.  Dessa forma, ser√° mais conveniente investigar completamente os avisos.  Na verdade, trabalhar com uma interface conveniente √© muito mais f√°cil do que olhar para um relat√≥rio de texto. <br><br>  Obrigado por ler nossos artigos!  Vejo voc√™ na pr√≥xima publica√ß√£o: D <br><br>  PS Aconteceu que este artigo foi publicado em 31 de outubro. Feliz Dia das Bruxas, rapazes e meninas! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473966/">https://habr.com/ru/post/pt473966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473952/index.html">Como escrevi AI para estrat√©gia baseada em turnos</a></li>
<li><a href="../pt473956/index.html">Informa√ß√µes secretas de uma companhia telef√¥nica de traficantes de drogas</a></li>
<li><a href="../pt473958/index.html">Os japoneses da NICT introduziram um cluster de fibra de trabalho com uma largura de banda de 1 Pbit / s</a></li>
<li><a href="../pt473960/index.html">Estrat√©gias de localiza√ß√£o de conte√∫do</a></li>
<li><a href="../pt473962/index.html">O modo escuro est√° agora em todo lugar. Isso √© t√£o √∫til? (no final da p√≥s-pesquisa)</a></li>
<li><a href="../pt473972/index.html">Por ordem dos desenvolvedores incorporados: procurando bugs no Amazon FreeRTOS</a></li>
<li><a href="../pt473974/index.html">Intercom'19 - uma confer√™ncia sobre automa√ß√£o de comunica√ß√µes da Voximplant ser√° realizada em 14 de novembro</a></li>
<li><a href="../pt473976/index.html">AWS Elasticsearch: produto fundamentalmente defeituoso</a></li>
<li><a href="../pt473978/index.html">Tanta dor, tanta dor, caixa registradora como 2: 0</a></li>
<li><a href="../pt473980/index.html">Tecnologia e o mundo real: 4 startups que est√£o mudando o futuro do design de interiores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>