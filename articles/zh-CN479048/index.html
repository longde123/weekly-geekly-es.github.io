<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ”´ ğŸ¤³ ğŸ¤š ç”¨äºå‡äººçš„Node.jsæµæˆ–å¦‚ä½•ä½¿ç”¨æµ ğŸ¯ ğŸ’‡ğŸ¼ ğŸ™‹ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘è®¤ä¸ºè®¸å¤šäººä¸æ­¢ä¸€æ¬¡å¬è¯´è¿‡Node js Streamsï¼Œä½†æ˜¯ä»æœªä½¿ç”¨è¿‡å®ƒï¼Œæˆ–è€…åœ¨ä¸è€ƒè™‘å®ƒä»¬å¦‚ä½•å·¥ä½œï¼Œç®¡é“åŒ–æµå’Œè§„èŒƒçš„æƒ…å†µä¸‹ä½¿ç”¨äº†å®ƒã€‚ è®©æˆ‘ä»¬æ‰¾å‡ºä»€ä¹ˆæ˜¯æµï¼Œç®¡é“ï¼ˆç®¡é“ï¼‰ï¼Œå—ï¼ˆå—ï¼ˆæ•°æ®çš„ä¸€éƒ¨åˆ†ï¼‰ä»¥åŠæ‰€æœ‰è¿™äº›ï¼‰ï¼‰ 



 ä¸ºä»€ä¹ˆäº†è§£æµåœ¨Node jsä¸­çš„å·¥ä½œåŸç†ä¸ºä½•å¾ˆé‡è¦ï¼Ÿ ç­”æ¡ˆå¾ˆç®€å•ï¼šNode js...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç”¨äºå‡äººçš„Node.jsæµæˆ–å¦‚ä½•ä½¿ç”¨æµ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479048/"> æˆ‘è®¤ä¸ºè®¸å¤šäººä¸æ­¢ä¸€æ¬¡å¬è¯´è¿‡Node js Streamsï¼Œä½†æ˜¯ä»æœªä½¿ç”¨è¿‡å®ƒï¼Œæˆ–è€…åœ¨ä¸è€ƒè™‘å®ƒä»¬å¦‚ä½•å·¥ä½œï¼Œç®¡é“åŒ–æµå’Œè§„èŒƒçš„æƒ…å†µä¸‹ä½¿ç”¨äº†å®ƒã€‚ è®©æˆ‘ä»¬æ‰¾å‡ºä»€ä¹ˆæ˜¯æµï¼Œç®¡é“ï¼ˆç®¡é“ï¼‰ï¼Œå—ï¼ˆå—ï¼ˆæ•°æ®çš„ä¸€éƒ¨åˆ†ï¼‰ä»¥åŠæ‰€æœ‰è¿™äº›ï¼‰ï¼‰ <br><br><img src="https://habrastorage.org/webt/m8/iv/cp/m8ivcpkrvfaq1vfm53mhxafmzna.jpeg"><br><a name="habracut"></a><br> ä¸ºä»€ä¹ˆäº†è§£æµåœ¨Node jsä¸­çš„å·¥ä½œåŸç†ä¸ºä½•å¾ˆé‡è¦ï¼Ÿ ç­”æ¡ˆå¾ˆç®€å•ï¼šNode jsä¸­çš„è®¸å¤šå†…ç½®æ¨¡å—éƒ½å®ç°äº†æµï¼Œä¾‹å¦‚HTTPè¯·æ±‚/å“åº”ï¼Œfsè¯»/å†™ï¼Œzlibï¼Œcryptoï¼ŒTCPå¥—æ¥å­—ç­‰ã€‚ æ‚¨è¿˜éœ€è¦æµï¼Œä¾‹å¦‚ï¼Œåœ¨å¤„ç†å¤§æ–‡ä»¶ï¼Œå¤„ç†å›¾ç‰‡æ—¶ã€‚ æ‚¨å¯èƒ½æ²¡æœ‰åœ¨ç¼–å†™è‡ªå·±çš„æµï¼Œä½†æ˜¯äº†è§£å®ƒçš„å·¥ä½œåŸç†å°†ä½¿æ‚¨å˜å¾—æ›´æœ‰èƒ½åŠ›ã€‚ <br><br> å› æ­¤ï¼Œä»€ä¹ˆæ˜¯æµï¼ˆåœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘å°†ä»£æ›¿æµï¼ˆæµï¼‰ä½¿ç”¨ï¼‰ã€‚ æµæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œæ‚¨å¯ä»¥ç”¨å®ƒæ¥å¤„ç†å°éƒ¨åˆ†çš„æ•°æ®ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨å°‘é‡çš„RAMã€‚ åŒæ ·ï¼Œåœ¨å®ƒçš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ªéƒ¨åˆ†çš„å¤„ç†åˆ†æˆå½¼æ­¤ç‹¬ç«‹çš„æ¨¡å—ï¼ˆå‡½æ•°æˆ–ç±»ï¼‰ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³å‹ç¼©éƒ¨åˆ†æ•°æ®ï¼Œç„¶ååŠ å¯†å¹¶å†™å…¥æ–‡ä»¶ã€‚ ä¸»è¦æ€æƒ³ä¸æ˜¯å¤„ç†æ•´ä¸ªæ•°æ®ï¼Œè€Œæ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å¤„ç†éƒ¨åˆ†æ•°æ®ã€‚ <br><br>  Node jsä¸­æœ‰4ç§æµï¼š <br><br><ul><li> å¯è¯»çš„ </li><li> å¯å†™-å†™ä½œ </li><li> åŒé¢-è¯»å†™ </li><li> è½¬æ¢-ä¸€ç§å¯ä»¥ä¿®æ”¹æ•°æ®çš„åŒå·¥æµ </li></ul><br> æ‚¨å¯ä»¥åœ¨å®˜æ–¹ç½‘ç«™ä¸Šæ‰¾åˆ°æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œç°åœ¨è®©æˆ‘ä»¬ç»§ç»­ç»ƒä¹ ã€‚ <br><br><h3> ç®€å•çš„ä¾‹å­ </h3><br> æˆ‘è®¤ä¸ºè®¸å¤šäººç”šè‡³æ²¡æœ‰æ„è¯†åˆ°å°±å·²ç»ä½¿ç”¨äº†æµã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»…å°†æ–‡ä»¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚ <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// 1 - ( )      ,         const getFile = async (req, res, next) =&gt; { const fileStream = fs.createReadStream('path to file'); res.contentType('application/pdf'); fileStream.pipe(res); }; // 2 - (  )         const getFile = async (req, res, next) =&gt; { const file = fs.readFileSync('path to file'); res.contentType('application/pdf'); res.send(file); };</span></span></code> </pre> <br> å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œåœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸‹è½½äº†æ–‡ä»¶çš„ä¸€éƒ¨åˆ†å¹¶å‘é€ï¼Œå› æ­¤æ²¡æœ‰åŠ è½½æœåŠ¡å™¨çš„RAMã€‚ åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç«‹å³å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°RAMä¸­ï¼Œç„¶åå†å‘é€ã€‚ <br><br> åœ¨æœ¬æ–‡çš„è¿›ä¸€æ­¥éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åˆ†åˆ«åˆ†ææ¯ä¸ªæµã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ç»§æ‰¿æˆ–ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºæµã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Readable } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 1 -   const myReadable = new Readable(opt); // 2 -   class myReadable extends Readable { constructor(opt) { super(opt); } }</span></span></code> </pre><br> åœ¨æ‰€æœ‰ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨2æ–¹æ³•ã€‚ <br><br><h3> å¯è¯»æµ </h3><br> è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨NodeJSä¸­åˆ›å»ºReadableæµã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Readable } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">myReadable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Readable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(opt) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(opt); } _read(size) {} }</code> </pre><br> ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ç±»æ¥å—ä¸€ç»„å‚æ•°ã€‚ æˆ‘ä»¬å°†åªè€ƒè™‘å¯¹Readableæµå…·æœ‰ä¸€èˆ¬ç†è§£æ‰€å¿…éœ€çš„é‚£äº›ï¼Œå…¶ä½™çš„æ‚¨å¯ä»¥åœ¨æ–‡æ¡£ä¸­çœ‹åˆ°ã€‚ æˆ‘ä»¬å¯¹highWaterMarkå‚æ•°å’Œ_readæ–¹æ³•æ„Ÿå…´è¶£ã€‚ <br><br>  highWaterMarkæ˜¯å†…éƒ¨æµç¼“å†²åŒºçš„æœ€å¤§å­—èŠ‚æ•°ï¼ˆé»˜è®¤ä¸º16kbï¼‰ï¼Œè¾¾åˆ°è¯¥å€¼æ—¶ï¼Œå°†ä»èµ„æºä¸­è¯»å–çš„æ•°æ®å°†è¢«æŒ‚èµ·ã€‚ ä¸ºäº†ç»§ç»­é˜…è¯»ï¼Œæˆ‘ä»¬éœ€è¦é‡Šæ”¾å†…éƒ¨ç¼“å†²åŒºã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ç®¡é“ï¼Œæ¢å¤æˆ–è®¢é˜…æ•°æ®äº‹ä»¶æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ <br><br>  _readæ˜¯ç§æœ‰æ–¹æ³•çš„å®ç°ï¼Œè¯¥æ–¹æ³•ç”±Readableç±»çš„å†…éƒ¨æ–¹æ³•è°ƒç”¨ã€‚ è¿ç»­è°ƒç”¨å®ƒï¼Œç›´åˆ°æ•°æ®å¤§å°è¾¾åˆ°highWaterMarkã€‚ <br><br> å¥½å§ï¼Œæˆ‘ä»¬æ„Ÿå…´è¶£çš„æœ€åä¸€ä¸ªæ–¹æ³•æ˜¯å¯è¯»ã€‚ å®ƒè¿”å›trueï¼Œä½†æ˜¯ä¸€æ—¦ç¼“å†²åŒºå·²æ»¡ï¼Œå¯¹æ­¤æ–¹æ³•çš„è°ƒç”¨å°†å¼€å§‹è¿”å›falseã€‚ å¯ä»¥ç”±å¯è¯»._readæ–¹æ³•æ§åˆ¶ã€‚ <br><br> ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­æ¥æ¾„æ¸…è¿™ç§æƒ…å†µã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Counter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Readable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(opt) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(opt); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._max = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index = <span class="hljs-number"><span class="hljs-number">0</span></span>; } _read() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index += <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._max) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buf = Buffer.from(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">._index}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Added: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">._index}</span></span></span><span class="hljs-string">. Could be added? `</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(buf)); } } } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> counter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Counter({ <span class="hljs-attr"><span class="hljs-attr">highWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Received: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${counter.read().toString()}</span></span></span><span class="hljs-string">`</span></span>);</code> </pre><br> é¦–å…ˆï¼Œæˆ‘è¦è¯´counter.readï¼ˆï¼‰ä¸æ˜¯æˆ‘ä»¬åœ¨è¯¥ç±»ä¸­å®ç°çš„_readã€‚ è¯¥æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œè€Œè¯¥æ–¹æ³•æ˜¯å…¬å…±çš„ï¼Œå®ƒä»å†…éƒ¨ç¼“å†²åŒºè¿”å›æ•°æ®ã€‚ å½“æˆ‘ä»¬æ‰§è¡Œæ­¤ä»£ç æ—¶ï¼Œåœ¨æ§åˆ¶å°ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š <br><br><img src="https://habrastorage.org/webt/lg/yt/ih/lgytihuwtk4wpqbwz2p5xz2iudo.jpeg"><br><br> å‘ç”Ÿä»€ä¹ˆäº‹äº† å½“åˆ›å»ºæ–°çš„Counterï¼ˆ{highWaterMarkï¼š2}ï¼‰æµæ—¶ï¼Œæˆ‘ä»¬è¡¨ç¤ºå†…éƒ¨ç¼“å†²åŒºçš„å¤§å°ä¸º2ä¸ªå­—èŠ‚ï¼Œå³ å¯ä»¥å­˜å‚¨2ä¸ªå­—ç¬¦ï¼ˆ1ä¸ªå­—ç¬¦= 1ä¸ªå­—èŠ‚ï¼‰ã€‚ è°ƒç”¨counter.readï¼ˆï¼‰ä¹‹åï¼Œæµå¼€å§‹è¯»å–ï¼Œå°†â€œ 1â€å†™å…¥å†…éƒ¨ç¼“å†²åŒºå¹¶è¿”å›ã€‚ ç„¶åä»–ç»§ç»­é˜…è¯»ï¼Œå†™ä¸ºâ€œ 2â€ã€‚ å½“å®ƒå†™ä¸ºâ€œ 3â€æ—¶ï¼Œç¼“å†²åŒºå°†å·²æ»¡ï¼Œå¯è¯»æ€§ã€‚pushå°†è¿”å›falseï¼Œæµå°†ç­‰å¾…ç›´åˆ°å†…éƒ¨ç¼“å†²åŒºè¢«é‡Šæ”¾ã€‚ å› ä¸º åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæ²¡æœ‰é‡Šæ”¾ç¼“å†²åŒºçš„é€»è¾‘ï¼Œè„šæœ¬å°†ç»“æŸã€‚ <br><br> å¦‚å‰æ‰€è¿°ï¼Œä¸ºäº†ç¡®ä¿è¯»å–ä¸è¢«ä¸­æ–­ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­æ¸…é™¤å†…éƒ¨ç¼“å†²åŒºã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬è®¢é˜…äº†dataäº‹ä»¶ã€‚ ç”¨ä»¥ä¸‹ä»£ç æ›¿æ¢æœ€åä¸¤è¡Œã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> counter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Counter({ <span class="hljs-attr"><span class="hljs-attr">highWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }); counter.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, chunk =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Received: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${chunk.toString()}</span></span></span><span class="hljs-string">`</span></span>); });</code> </pre><br> ç°åœ¨ï¼Œå¦‚æœè¿è¡Œæ­¤ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä¸€åˆ‡æ­£å¸¸è¿è¡Œï¼Œå¹¶ä¸”æ§åˆ¶å°ä¸­æ˜¾ç¤ºäº†1åˆ°1000ä¹‹é—´çš„æ•°å­—ã€‚ <br><br><h3> ä¹¦é¢æµ </h3><br> å®é™…ä¸Šï¼Œå®ƒä¸Readableæµéå¸¸ç›¸ä¼¼ï¼Œä»…ç”¨äºå†™å…¥æ•°æ®ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Writable } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">myWritable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Writable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(opt) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(opt); } _write(chunk, encoding, callback) {} }</code> </pre><br> å®ƒæ¥å—ç±»ä¼¼çš„å‚æ•°ï¼Œä¾‹å¦‚Readable Streamã€‚ æˆ‘ä»¬å¯¹highWaterMarkå’Œ_writeæ„Ÿå…´è¶£ã€‚ <br><br>  _writeæ˜¯ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œç”±Writableç±»çš„å†…éƒ¨æ–¹æ³•è°ƒç”¨ä»¥å†™å…¥ä¸€æ®µæ•°æ®ã€‚ å®ƒåŒ…å«3ä¸ªå‚æ•°ï¼šå—ï¼ˆæ•°æ®çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œç¼–ç ï¼ˆå¦‚æœå—æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™è¿›è¡Œç¼–ç ï¼‰ï¼Œå›è°ƒï¼ˆåœ¨æˆåŠŸæˆ–ä¸æˆåŠŸå†™å…¥ä¹‹åè°ƒç”¨çš„å‡½æ•°ï¼‰ã€‚ <br><br>  highWaterMarkæ˜¯å†…éƒ¨æµç¼“å†²åŒºçš„æœ€å¤§å­—èŠ‚æ•°ï¼ˆé»˜è®¤ä¸º16kbï¼‰ï¼Œè¾¾åˆ°è¯¥å€¼æ—¶stream.writeå°†å¼€å§‹è¿”å›falseã€‚ <br><br> è®©æˆ‘ä»¬ç”¨è®¡æ•°å™¨é‡å†™å‰é¢çš„ç¤ºä¾‹ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Writable } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Counter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Writable</span></span></span><span class="hljs-class"> </span></span>{ _write(chunk, encoding, callback) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(chunk.toString()); callback(); } } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> counter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Counter({ <span class="hljs-attr"><span class="hljs-attr">highWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>; i += <span class="hljs-number"><span class="hljs-number">1</span></span>) { counter.write(Buffer.from(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${i}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>)); }</code> </pre><br> å®é™…ä¸Šï¼Œä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæœ‰è¶£çš„ç»†å¾®å·®åˆ«å€¼å¾—è®°ä½ï¼ å½“åˆ›å»ºæ–°çš„Counterï¼ˆ{highWaterMarkï¼š2}ï¼‰æµæ—¶ï¼Œæˆ‘ä»¬è¡¨ç¤ºå†…éƒ¨ç¼“å†²åŒºçš„å¤§å°ä¸º2ä¸ªå­—èŠ‚ï¼Œå³ å¯ä»¥å­˜å‚¨2ä¸ªå­—ç¬¦ï¼ˆ1ä¸ªå­—ç¬¦= 1ä¸ªå­—èŠ‚ï¼‰ã€‚ å½“è®¡æ•°å™¨è¾¾åˆ°10æ—¶ï¼Œæ¯æ¬¡å†™è°ƒç”¨éƒ½ä¼šå¡«å……ç¼“å†²åŒºï¼›å› æ­¤ï¼Œå¦‚æœå†™æ˜¯é’ˆå¯¹æ…¢é€Ÿæºçš„ï¼Œåˆ™åœ¨è°ƒç”¨writeæ—¶æ‰€æœ‰å…¶ä»–æ•°æ®å°†ä¿å­˜åˆ°RAMï¼Œè¿™å¯èƒ½å¯¼è‡´å…¶æº¢å‡ºï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå½“ç„¶æ²¡å…³ç³»ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¼“å†²åŒºæ˜¯2ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å¯¹äºå¤§æ–‡ä»¶ï¼Œæ‚¨éœ€è¦è®°ä½è¿™ä¸€ç‚¹ï¼‰ã€‚ å½“å‡ºç°è¿™ç§æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç­‰åˆ°æµå†™å…¥æ•°æ®çš„å½“å‰éƒ¨åˆ†ï¼Œé‡Šæ”¾å†…éƒ¨ç¼“å†²åŒºï¼ˆè§¦å‘è€—ç”¨äº‹ä»¶ï¼‰ï¼Œç„¶åæ‰èƒ½æ¢å¤è®°å½•æ•°æ®ã€‚ è®©æˆ‘ä»¬é‡å†™æˆ‘ä»¬çš„ç¤ºä¾‹ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Writable } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { once } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'events'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Counter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Writable</span></span></span><span class="hljs-class"> </span></span>{ _write(chunk, encoding, callback) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(chunk.toString()); callback(); } } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> counter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Counter({ <span class="hljs-attr"><span class="hljs-attr">highWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }); <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">async</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>; i += <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> canWrite = counter.write(Buffer.from(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${i}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Can we write bunch of data? </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${canWrite}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!canWrite) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> events.once(counter, <span class="hljs-string"><span class="hljs-string">'drain'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'drain event fired.'</span></span>); } } })();</code> </pre><br> åœ¨v11.13.0ä¸­æ·»åŠ äº†events.onceæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿æ‚¨å¯ä»¥åˆ›å»ºpromiseå¹¶ç­‰å¾…ç‰¹å®šäº‹ä»¶æ‰§è¡Œä¸€æ¬¡ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ£€æŸ¥æ˜¯å¦å¯ä»¥å°†æ•°æ®å†™å…¥æµï¼Œå¦åˆ™ï¼Œè¯·ç­‰å¾…ç›´åˆ°ç¼“å†²åŒºé‡Šæ”¾åç»§ç»­è®°å½•ã€‚ <br><br> ä¹ä¸€çœ‹ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸å¿…è¦çš„æ“ä½œï¼Œä½†æ˜¯å½“å¤„ç†å¤§é‡æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œæ–‡ä»¶å¤§å°è¶…è¿‡10GBçš„æ–‡ä»¶ï¼‰è€Œå¿˜è®°æ‰§è¡Œæ­¤æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°å†…å­˜æ³„æ¼ã€‚ <br><br><h3> åŒå·¥æµ </h3><br> å®ƒç»“åˆäº†Readableå’ŒWritableæµï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»ç¼–å†™_readå’Œ_writeä¸¤ä¸ªæ–¹æ³•çš„å®ç°ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Duplex } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">myDuplex</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Duplex</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(opt) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(opt); } _read(size) {} _write(chunk, encoding, callback) {} }</code> </pre><br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹å¯ä¼ é€’ç»™æ„é€ å‡½æ•°çš„2ä¸ªå‚æ•°æ„Ÿå…´è¶£ï¼Œå®ƒä»¬æ˜¯å¯è¯»é«˜æ°´ä½æ ‡è®°å’Œå¯å†™é«˜æ°´ä½æ ‡è®°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä½¿æˆ‘ä»¬å¯ä»¥åˆ†åˆ«ä¸ºå¯è¯»æµå’Œå¯å†™æµæŒ‡å®šå†…éƒ¨ç¼“å†²åŒºçš„å¤§å°ã€‚ è¿™å°±æ˜¯åœ¨Duplexæµçš„å¸®åŠ©ä¸‹å‰ä¸¤ä¸ªç¤ºä¾‹çš„å®ç°çš„æ ·å­ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Duplex } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> events = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'events'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Counter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Duplex</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(opt) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(opt); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._max = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index = <span class="hljs-number"><span class="hljs-number">0</span></span>; } _read() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index += <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._max) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buf = Buffer.from(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">._index}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(buf); } } _write(chunk, encoding, callback) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(chunk.toString()); callback(); } } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> counter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Counter({ <span class="hljs-attr"><span class="hljs-attr">readableHighWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">writableHighWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }); <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">async</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> chunk = counter.read(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (chunk !== <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> canWrite = counter.write(chunk); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Can we write bunch of data? </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${canWrite}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!canWrite) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> events.once(counter, <span class="hljs-string"><span class="hljs-string">'drain'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'drain event fired.'</span></span>); } chunk = counter.read(); } })();</code> </pre><br> æˆ‘è®¤ä¸ºæ­¤ä»£ç ä¸éœ€è¦è§£é‡Šï¼Œå› ä¸ºå®ƒä¸ä»¥å‰ç›¸åŒï¼Œä»…åœ¨ä¸€ä¸ªç±»ä¸­ã€‚ <br><br><h3> è½¬æ¢æµ </h3><br> è¯¥æµæ˜¯åŒå·¥æµã€‚ éœ€è¦è½¬æ¢æ•°æ®å—å¹¶å°†å…¶è¿›ä¸€æ­¥å‘é€åˆ°é“¾ä¸‹ã€‚ å¯ä»¥ä¸æµçš„å…¶ä½™éƒ¨åˆ†ç›¸åŒçš„æ–¹å¼æ¥å®ç°å®ƒã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Transform } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">myTransform</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Transform</span></span></span><span class="hljs-class"> </span></span>{ _ transform(chunk, encoding, callback) {} }</code> </pre><br> æˆ‘ä»¬å¯¹_transformæ–¹æ³•æ„Ÿå…´è¶£ã€‚ <br><br>  _transformæ˜¯ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œç”±Transformç±»çš„å†…éƒ¨æ–¹æ³•è°ƒç”¨ä»¥è½¬æ¢æ•°æ®å—ã€‚ å®ƒåŒ…å«3ä¸ªå‚æ•°ï¼šå—ï¼ˆæ•°æ®çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œç¼–ç ï¼ˆå¦‚æœå—æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™è¿›è¡Œç¼–ç ï¼‰ï¼Œå›è°ƒï¼ˆåœ¨æˆåŠŸæˆ–ä¸æˆåŠŸå†™å…¥åè°ƒç”¨çš„å‡½æ•°ï¼‰ã€‚ <br><br> ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæ•°æ®éƒ¨åˆ†å°†å‘ç”Ÿå˜åŒ–ã€‚ åœ¨æ­¤æ–¹æ³•å†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨transform.pushï¼ˆï¼‰é›¶æ¬¡æˆ–å¤šæ¬¡ï¼Œä»¥æäº¤æ›´æ”¹ã€‚ å®Œæˆæ•°æ®è½¬æ¢åï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ªå›è°ƒï¼Œè¯¥å›è°ƒå°†å‘é€æ·»åŠ åˆ°transform.pushï¼ˆï¼‰ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚ æ­¤å›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”™è¯¯ã€‚ å¦å¤–ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨transform.pushï¼ˆï¼‰ï¼Œè€Œæ˜¯å°†æ›´æ”¹åçš„æ•°æ®ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°å‘é€åˆ°å›è°ƒå‡½æ•°ï¼ˆä¾‹å¦‚ï¼šcallbackï¼ˆç©ºï¼Œæ•°æ®ï¼‰ï¼‰ã€‚ ä¸ºäº†äº†è§£å¦‚ä½•ä½¿ç”¨è¿™ç§ç±»å‹çš„æµï¼Œè®©æˆ‘ä»¬åˆ†æstream.pipeæ–¹æ³•ã€‚ <br><br>  stream.pipe-æ­¤æ–¹æ³•ç”¨äºå°†Readableæµè¿æ¥åˆ°Writableæµï¼Œå¹¶åˆ›å»ºæµé“¾ã€‚ è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è¯»å–éƒ¨åˆ†æ•°æ®å¹¶å°†å…¶ä¼ è¾“åˆ°ä¸‹ä¸€ä¸ªæµè¿›è¡Œå¤„ç†ï¼Œç„¶åå†ä¼ è¾“åˆ°ä¸‹ä¸€ä¸ªæµï¼Œä¾æ­¤ç±»æ¨ã€‚ <br><br> è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªTransformæµï¼Œå®ƒå°†åœ¨æ¯ä¸ªæ•°æ®çš„å¼€å¤´å’Œç»“å°¾æ·»åŠ *å­—ç¬¦ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CounterReader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Readable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(opt) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(opt); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._max = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index = <span class="hljs-number"><span class="hljs-number">0</span></span>; } _read() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index += <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._index &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._max) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buf = Buffer.from(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">._index}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(buf); } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CounterWriter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Writable</span></span></span><span class="hljs-class"> </span></span>{ _write(chunk, encoding, callback) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(chunk.toString()); callback(); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CounterTransform</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Transform</span></span></span><span class="hljs-class"> </span></span>{ _transform(chunk, encoding, callback) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resultString = <span class="hljs-string"><span class="hljs-string">`*</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${chunk.toString(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'utf8'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">*`</span></span>; callback(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, resultString); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { callback(err); } } } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> counterReader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CounterReader({ <span class="hljs-attr"><span class="hljs-attr">highWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> counterWriter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CounterWriter({ <span class="hljs-attr"><span class="hljs-attr">highWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> counterTransform = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CounterTransform({ <span class="hljs-attr"><span class="hljs-attr">highWaterMark</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }); counterReader.pipe(counterTransform).pipe(counterWriter);</code> </pre><br> åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†å…ˆå‰ç¤ºä¾‹ä¸­çš„Readableå’ŒWritableæµï¼Œè¿˜æ·»åŠ äº†Transformã€‚ å¦‚æ‚¨æ‰€è§ï¼Œç»“æœéå¸¸ç®€å•ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬ç ”ç©¶äº†æµçš„æ’åˆ—æ–¹å¼ã€‚ å®ƒä»¬çš„ä¸»è¦æ¦‚å¿µæ˜¯éƒ¨åˆ†å¤„ç†æ•°æ®ï¼Œè¿™éå¸¸æ–¹ä¾¿å¹¶ä¸”ä¸éœ€è¦å¤§é‡èµ„æºã€‚ è€Œä¸”ï¼Œæµå¯ä»¥ä¸è¿­ä»£å™¨ä¸€èµ·ä½¿ç”¨ï¼Œè¿™ä½¿å®ƒä»¬ä½¿ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªå®Œå…¨ä¸åŒçš„æ•…äº‹ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479048/">https://habr.com/ru/post/zh-CN479048/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479036/index.html">è‹±ç‰¹å°”æ— æ³•æ»¡è¶³å¯¹å¤„ç†å™¨çš„éœ€æ±‚ã€‚ æƒ æ™®å’Œæˆ´å°”å› æ­¤è€Œå—è‹¦</a></li>
<li><a href="../zh-CN479038/index.html">æ•°å­—è½¬æ¢Leroy Merlinï¼šè®¾è®¡ç”¨äºå¤„ç†å®¢æˆ·å‘¼å«çš„æ¥å£</a></li>
<li><a href="../zh-CN479040/index.html">è§†è§‰å›å½’æµ‹è¯•ã€‚ é‡æ–°å¼€æœº</a></li>
<li><a href="../zh-CN479042/index.html">Yæ–¹æ³•æ˜¯æ„å»ºé­”æ–¹çš„ä¸€ç§éå¸¸ç®€å•çš„æ–¹æ³•</a></li>
<li><a href="../zh-CN479044/index.html">æˆ‘åœ¨NOR Flashä¸­å®ç°ç¯å½¢ç¼“å†²åŒº</a></li>
<li><a href="../zh-CN479050/index.html">ITé¢†åŸŸçš„ä¸“åˆ©ç ”ç©¶ã€‚ å¹´è½»æˆ˜å£«çš„å†ç¨‹ã€‚ ç¬¬äºŒéƒ¨åˆ† ä¸“åˆ©ç ”ç©¶çš„ä¿¡æ¯æ¥æº</a></li>
<li><a href="../zh-CN479052/index.html">[Supercomputing 2019]ã€‚ å¤šäº‘å­˜å‚¨ä½œä¸ºæ–°é‡‘å£«é¡¿DC1000Mé©±åŠ¨å™¨çš„åº”ç”¨ç¨‹åº</a></li>
<li><a href="../zh-CN479054/index.html">æ˜ŸæœŸäº”æ‰‹æœºæŠ•ç¥¨</a></li>
<li><a href="../zh-CN479056/index.html">è°ˆäººç”Ÿï¼Ÿ DREAMå›¢é˜Ÿå‚åŠ Alexaå¥–SocialbotæŒ‘æˆ˜èµ›3</a></li>
<li><a href="../zh-CN479058/index.html">ä½œä¸ºäº‹ä»¶ç®¡ç†è¿‡ç¨‹è¿›è¡Œç›‘è§†</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>