<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèçÔ∏è üòê ‚õé Almacenamiento eficiente de cientos de millones de archivos peque√±os. Soluci√≥n autohospedada üèÄ üâê üßëüèΩ‚Äçü§ù‚Äçüßëüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Estimada comunidad, este art√≠culo se centrar√° en el almacenamiento eficiente y la entrega de cientos de millones de archivos peque√±os. En esta etapa, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Almacenamiento eficiente de cientos de millones de archivos peque√±os. Soluci√≥n autohospedada</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484312/"><img src="https://habrastorage.org/webt/32/yq/2a/32yq2adas-fjtcztdzu7fhyhiss.png"><br><br>  Estimada comunidad, este art√≠culo se centrar√° en el almacenamiento eficiente y la entrega de cientos de millones de archivos peque√±os.  En esta etapa, se propone la soluci√≥n final para sistemas de archivos compatibles con POSIX con soporte completo para bloqueos, incluidos los de cl√∫ster, e incluso sin muletas. <br><br>  Por lo tanto, para este prop√≥sito escrib√≠ mi propio servidor especializado. <br>  En el curso de esta tarea, fue posible resolver el problema principal, en el camino para ahorrar espacio en disco y RAM, que nuestro sistema de archivos del cl√∫ster consumi√≥ sin piedad.  En realidad, tal cantidad de archivos es perjudicial para cualquier sistema de archivos en cl√∫ster. <a name="habracut"></a><br><br>  La idea es esta: <br><br>  En palabras simples, los archivos peque√±os se cargan a trav√©s del servidor, se guardan directamente en el archivo y tambi√©n se leen, y los archivos grandes se colocan cerca.  Esquema: 1 carpeta = 1 archivo, en total tenemos varios millones de archivos con archivos peque√±os, y no varios cientos de millones de archivos.  Y todo esto est√° completamente implementado, sin scripts y archivos plegables en archivos tar / zip. <br><br>  Intentar√© acortarlo, me disculpo de antemano si la publicaci√≥n ser√° amplia. <br><br>  Todo comenz√≥ con el hecho de que no pude encontrar un servidor adecuado en el mundo que pudiera guardar los datos recibidos a trav√©s del protocolo HTTP directamente en los archivos, por lo que no hubo inconvenientes inherentes a los archivos ordinarios y repositorios de objetos.  Y la raz√≥n de la b√∫squeda fue un grupo de 10 servidores que crecieron a un origen de gran escala, en el que ya se hab√≠an acumulado 250,000,000 de archivos peque√±os, y la tendencia de crecimiento no iba a detenerse. <br><br>  <b>Aquellos a quienes no les gusta leer art√≠culos y un poco de documentaci√≥n es m√°s f√°cil:</b> <br><br>  <a href="" rel="nofollow">aqu√≠</a> y <a href="" rel="nofollow">aqu√≠</a> <br><br>  <b>Actualizaci√≥n</b>  <b>Se elimin√≥ nginx de la imagen del acoplador.</b> <br><br>  Y docker al mismo tiempo: <br><pre><code class="bash hljs">docker run -d --restart=always -e bindaddr=127.0.0.1:9699 \ -e host=localhost -e root=/var/storage -v /var/storage:/var/storage --name wzd \ -p 80:9699 eltaline/wzd</code> </pre> <br>  Siguiente: <br><br>  <b>Actualizaci√≥n</b>  <b>En la versi√≥n 1.1.0, ya apareci√≥ el m√©todo de autenticaci√≥n HTTPS / POST / IP, etc.</b> <br><br>  Si hay muchos archivos, se necesitan recursos significativos y, lo que es m√°s ofensivo, algunos de ellos se desperdician.  Por ejemplo, cuando se utiliza un sistema de archivos en cl√∫ster (en este caso, MooseFS), un archivo, independientemente del tama√±o real, siempre ocupa al menos 64 KB.  Es decir, para archivos de 3, 10 o 30 KB de tama√±o, se requieren 64 KB en el disco.  Si un cuarto de bill√≥n de archivos, perdemos de 2 a 10 terabytes.  No ser√° posible crear nuevos archivos hasta el infinito ya que existe una limitaci√≥n en el propio MooseFS: no m√°s de mil millones con una r√©plica de cada archivo. <br><br>  A medida que aumenta el n√∫mero de archivos, necesita mucha RAM para los metadatos.  Los volcados de metadatos grandes frecuentes tambi√©n contribuyen al desgaste de los SSD. <br><br>  <b>Servidor WZD.</b>  <b>Ponemos los discos en orden.</b> <br><br>  El servidor est√° escrito en Go.  En primer lugar, necesitaba reducir la cantidad de archivos.  Como hacerlo  Debido al archivo, pero en este caso sin compresi√≥n, ya que mis archivos son im√°genes s√≥lidas y recortadas.  BoltDB vino al rescate, que a√∫n ten√≠a que ser privado de fallas, esto se refleja en la documentaci√≥n. <br><br>  En total, en lugar de un cuarto de bill√≥n de archivos, en mi caso solo quedaron 10 millones de archivos de Bolt.  Si tuviera la oportunidad de cambiar la estructura actual de llenar archivos de directorio, entonces ser√≠a posible reducir a aproximadamente 1 mill√≥n de archivos. <br><br>  Todos los archivos peque√±os se empaquetan en archivos Bolt, reciben autom√°ticamente los nombres de los directorios en los que se encuentran, y todos los archivos grandes permanecen al lado de los archivos, no tiene sentido empacarlos, esto es personalizable.  Peque√±o - archivo, grande - dejar sin cambios.  El servidor funciona de forma transparente con ambos. <br><br>  <b>Arquitectura y caracter√≠sticas del servidor wZD.</b> <br><br><img src="https://habrastorage.org/webt/uu/yu/t1/uuyut1do539zyzy3qs9atm_h9xg.png"><br><br>  El servidor ejecuta Linux, BSD, Solaris y OSX.  Prob√© solo la arquitectura AMD64 en Linux, pero tambi√©n deber√≠a ser adecuada para ARM64, PPC64, MIPS64. <br><br>  <b>Caracter√≠sticas clave:</b> <br><br><ul><li>  Multihilo; </li><li>  Multi-servidor, proporcionando tolerancia a fallas y balanceo de carga; </li><li>  M√°xima transparencia para el usuario o desarrollador; </li><li>  M√©todos HTTP admitidos: GET, HEAD, PUT y DELETE; </li><li>  Gesti√≥n del comportamiento de lectura y escritura a trav√©s de encabezados de clientes; </li><li>  Soporte para hosts virtuales personalizables; </li><li>  Admite integridad de datos CRC al escribir / leer; </li><li>  Memorias intermedias semidin√°micas para un consumo m√≠nimo de memoria y un ajuste √≥ptimo del rendimiento de la red; </li><li>  Compactaci√≥n de datos retrasada </li><li>  Adem√°s, se ofrece un archivador wZA multiproceso para la migraci√≥n de archivos sin detener el servicio. </li></ul><br>  <b>Experiencia real:</b> <br><br>  He estado desarrollando y probando el servidor y el archivador en datos en vivo durante bastante tiempo, ahora funciona con √©xito en un cl√∫ster que incluye 250,000,000 de peque√±os archivos (im√°genes) ubicados en 15,000,000 de directorios en discos SATA separados.  Un cl√∫ster de 10 servidores es un servidor Origin instalado detr√°s de una red CDN.  Para su mantenimiento, se utilizan 2 servidores Nginx + 2 servidores wZD. <br><br>  Para aquellos que deciden usar este servidor, tiene sentido planificar la estructura del directorio antes de usar, si corresponde.  Inmediatamente haga una reserva de que el servidor no est√° dise√±ado para insertar todo en el archivo 1 Bolt. <br><br>  <b>Pruebas de rendimiento:</b> <br><br>  Cuanto menor sea el tama√±o del archivo archivado, m√°s r√°pido se realizar√°n las operaciones GET y PUT en √©l.  Compare el tiempo total que el cliente HTTP escribe en archivos normales y en archivos Bolt, y tambi√©n lee.  Compara el trabajo con archivos de 32 KB, 256 KB, 1024 KB, 4096 KB y 32768 KB de tama√±o. <br><br>  Cuando se trabaja con archivos Bolt, se verifica la integridad de los datos de cada archivo (se usa CRC), antes de escribir y tambi√©n despu√©s de escribir, la lectura se realiza sobre la marcha y el recuento, esto naturalmente presenta demoras, pero lo principal es la seguridad de los datos. <br><br>  Realic√© pruebas de rendimiento en SSD, ya que en los discos SATA las pruebas no muestran una diferencia clara. <br><br>  <b>Actualizaci√≥n (v1.1.0), rendimiento mejorado en un 5-25%.</b> <br><br>  <b>Gr√°ficos basados ‚Äã‚Äãen resultados de pruebas:</b> <br><br><img src="https://habrastorage.org/webt/mi/ok/np/mioknp3lbcmd6vd87l255wksyg0.png"><br><img src="https://habrastorage.org/webt/zz/7b/k_/zz7bk_uhudvy71kyrdk5qe6fulc.png"><br><br>  Como puede ver, para archivos peque√±os, la diferencia en el tiempo de lectura y escritura entre archivos archivados y no archivados es peque√±a. <br><br>  Obtendremos una imagen completamente diferente con la prueba de leer y escribir archivos de 32 MB: <br><br><img src="https://habrastorage.org/webt/mo/br/xw/mobrxwox3c6o-kq3qjnj7vdaymu.png"><br><br>  La diferencia horaria entre la lectura de archivos es de 5 a 25 ms.  Con la grabaci√≥n, las cosas son peores, la diferencia es de unos 150 ms.  Pero en este caso, no es necesario cargar archivos grandes, esto simplemente no tiene sentido, pueden vivir separados de los archivos. <br><br>  * T√©cnicamente, este servidor tambi√©n se puede utilizar para tareas que requieren NoSQL. <br><br>  <b>M√©todos b√°sicos de trabajo con el servidor wZD:</b> <br><br>  Descargar archivo regular: <br><pre> <code class="bash hljs">curl -X PUT --data-binary @test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  Cargar un archivo en el archivo Bolt (si no se excede el par√°metro del servidor fmaxsize, que determina el tama√±o m√°ximo de archivo que se puede incluir en el archivo, si se excede, el archivo se cargar√° como siempre al lado del archivo): <br><pre> <code class="bash hljs">curl -X PUT -H <span class="hljs-string"><span class="hljs-string">"Archive: 1"</span></span> --data-binary @test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  Descargar un archivo (si hay archivos con el mismo nombre en el disco y en el archivo comprimido, entonces, al descargar, se le da prioridad al archivo descomprimido): <br><pre> <code class="bash hljs">curl -o test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  Descargar un archivo del archivo Bolt (forzado): <br><pre> <code class="bash hljs">curl -o test.jpg -H <span class="hljs-string"><span class="hljs-string">"FromArchive: 1"</span></span> http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br><br>  Una descripci√≥n de otros m√©todos est√° en la documentaci√≥n. <br><br>  <a href="" rel="nofollow">Documentaci√≥n WZD</a> <br>  <a href="" rel="nofollow">Documentaci√≥n de WZA</a> <br><br>  Hasta ahora, el servidor solo admite HTTP, todav√≠a no funciona con HTTPS.  El m√©todo POST tampoco es compatible (a√∫n no se ha decidido si es necesario o no). <br><br>  Cualquiera que profundice en el c√≥digo fuente encontrar√° un caramelo all√≠, no a todos les encanta, pero no vincul√© el c√≥digo principal a las funciones del marco web, excepto el controlador de interrupciones, para que en el futuro pueda reescribir r√°pidamente a casi cualquier motor. <br><br>  <b>Tarea:</b> <br><br><ul><li>  Desarrollo de nuestro propio replicador y distribuidor + geo para la posibilidad de uso en sistemas grandes sin FS grupales (Todo para un adulto) </li><li>  La capacidad de revertir completamente los metadatos de restauraci√≥n cuando se pierde por completo (si usa un distribuidor) </li><li>  Protocolo nativo para la posibilidad de usar conexiones de red permanentes y controladores para diferentes lenguajes de programaci√≥n </li><li>  Caracter√≠sticas avanzadas del uso del componente NoSQL </li><li>  Compresiones de diferentes tipos (gzip, zstd, snappy) para archivos o valores dentro de archivos Bolt y para archivos ordinarios </li><li>  Cifrado de diferentes tipos para archivos o valores dentro de archivos Bolt y para archivos ordinarios </li><li>  Conversi√≥n de video de servidor retrasada, incluida GPU </li></ul><br>  Eso es todo, espero que este servidor sea √∫til para alguien, licencia BSD-3, doble derecho de autor, ya que no habr√≠a una compa√±√≠a donde yo trabajara, tampoco escribir√≠a un servidor.  Soy un desarrollador en singular.  Agradecer√≠a los errores encontrados y las solicitudes de funciones. </div></div><p>Source: <a href="https://habr.com/ru/post/484312/">https://habr.com/ru/post/484312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../484300/index.html">Powershell funcional con clases: no es un ox√≠moron, lo garantizo</a></li>
<li><a href="../484302/index.html">Slurm DevOps: una teta que funciona mejor en 3 d√≠as que una hermosa gr√∫a en un futuro lejano</a></li>
<li><a href="../484304/index.html">China adopt√≥ su "Paquete de primavera"</a></li>
<li><a href="../484306/index.html">La capacidad de aprendizaje puede ser una revisi√≥n indecidible</a></li>
<li><a href="../484310/index.html">Biblioteca JavaScript de Webix a trav√©s de los ojos de un principiante. Parte 2. Trabajar con formularios</a></li>
<li><a href="../484320/index.html">Crear un microservicio en Quarkus, Kotlin y Gradle</a></li>
<li><a href="../484326/index.html">Salta a Londres o mi pasant√≠a en Jump Trading</a></li>
<li><a href="../484328/index.html">Paul Graham anuncia nuevo lenguaje de programaci√≥n Bel</a></li>
<li><a href="../484330/index.html">[Nginx] C√≥mo vencer a response_status = 0</a></li>
<li><a href="../484332/index.html">Centrarse en la gesti√≥n de tareas. C√≥mo hacemos nuestro sistema de gesti√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>