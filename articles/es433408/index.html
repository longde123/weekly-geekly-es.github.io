<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßî üèûÔ∏è üå•Ô∏è Manejo eficiente de la memoria en Node.js üçì üë©üèº‚Äçü§ù‚Äçüë®üèø üéÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los programas, en el curso del trabajo, utilizan la memoria de acceso aleatorio de las computadoras. En JavaScript, en el entorno de Node.js, puede es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Manejo eficiente de la memoria en Node.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/433408/"> Los programas, en el curso del trabajo, utilizan la memoria de acceso aleatorio de las computadoras.  En JavaScript, en el entorno de Node.js, puede escribir proyectos de servidor de varias escalas.  La organizaci√≥n del trabajo con memoria es siempre una tarea dif√≠cil y responsable.  Al mismo tiempo, si en lenguajes como C y C ++, los programadores est√°n muy involucrados en la gesti√≥n de la memoria, JS tiene mecanismos autom√°ticos que, al parecer, eliminan por completo la responsabilidad del programador para un trabajo eficiente con la memoria.  Sin embargo, este no es el caso.  El c√≥digo mal escrito para Node.js puede interferir con el funcionamiento normal de todo el servidor en el que se ejecuta. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/ky/5_/vb/ky5_vbvpcy_6qqxal9bewmiffmk.jpeg"></a> <br><br>  El material, cuya traducci√≥n publicamos hoy, se centrar√° en el trabajo efectivo con memoria en el entorno de Node.js.  En particular, aqu√≠ se discutir√°n conceptos tales como flujos, memorias intermedias y el m√©todo de flujo <code>pipe()</code> .  Node.js v8.12.0 se utilizar√° en los experimentos.  Un repositorio con c√≥digo de ejemplo se puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Tarea: copiar un archivo enorme</font> </h2><br>  Si se le pide a alguien que cree un programa para copiar archivos en Node.js, lo m√°s probable es que escriba inmediatamente sobre lo que se muestra a continuaci√≥n.  <code>basic_copy.js</code> el archivo que contiene este c√≥digo <code>basic_copy.js</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fileName = process.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> destPath = process.argv[<span class="hljs-number"><span class="hljs-number">3</span></span>]; fs.readFile(fileName, (err, data) =&gt; {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err;   fs.writeFile(destPath || <span class="hljs-string"><span class="hljs-string">'output'</span></span>, data, (err) =&gt; {       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err;   });     <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'New file has been created!'</span></span>); });</code> </pre> <br>  Este programa crea controladores para leer y escribir un archivo con un nombre dado e intenta escribir datos de archivo despu√©s de leerlo.  Para archivos peque√±os, este enfoque est√° funcionando. <br><br>  Supongamos que nuestra aplicaci√≥n necesita copiar un archivo enorme (consideraremos archivos "enormes" de m√°s de 4 GB) durante el proceso de copia de seguridad de datos.  Por ejemplo, tengo un archivo de video de 7,4 GB de tama√±o que, usando el programa descrito anteriormente, intentar√© copiar desde mi directorio actual al directorio <code>Documents</code> .  Aqu√≠ est√° el comando para comenzar a copiar: <br><br><pre> <code class="javascript hljs">$ node basic_copy.js cartoonMovie.mkv ~<span class="hljs-regexp"><span class="hljs-regexp">/Documents/</span></span>bigMovie.mkv</code> </pre> <br>  En Ubuntu, despu√©s de ejecutar este comando, se mostr√≥ un mensaje de error relacionado con un desbordamiento del b√∫fer: <br><br><pre> <code class="javascript hljs">/home/shobarani/Workspace/basic_copy.js:<span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err;            ^ <span class="hljs-built_in"><span class="hljs-built_in">RangeError</span></span>: File size is greater than possible Buffer: <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span> bytes   at FSReqWrap.readFileAfterStat [<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> oncomplete] (fs.js:<span class="hljs-number"><span class="hljs-number">453</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>)</code> </pre> <br>  Como puede ver, la operaci√≥n de lectura de archivos fall√≥ debido al hecho de que Node.js permite que solo 2 GB de datos se lean en el b√∫fer.  ¬øC√≥mo superar esta limitaci√≥n?  Al realizar operaciones que utilizan intensivamente el subsistema de E / S (copiar archivos, procesarlos, comprimirlos), es necesario tener en cuenta las capacidades de los sistemas y las limitaciones asociadas con la memoria. <br><br><h2>  <font color="#3AC1EF">Streams y Buffers en Node.js</font> </h2><br>  Para solucionar el problema descrito anteriormente, necesitamos un mecanismo con el que podamos dividir grandes cantidades de datos en peque√±os fragmentos.  Tambi√©n necesitaremos estructuras de datos para almacenar estos fragmentos y trabajar con ellos.  Un b√∫fer es una estructura de datos que le permite almacenar datos binarios.  A continuaci√≥n, debemos poder leer datos del disco y escribirlos en el disco.  Esta oportunidad nos puede dar flujos.  Hablemos de buffers e hilos. <br><br><h3>  <font color="#3AC1EF">‚ñçBuffers</font> </h3><br>  Se puede crear un b√∫fer inicializando el objeto <code>Buffer</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Buffer(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 10 -    console.log(buffer); //  &lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;</span></span></code> </pre> <br>  En las versiones de Node.js m√°s nuevas que la 8, es mejor usar la siguiente construcci√≥n para crear buffers: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Buffer.alloc(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(buffer); <span class="hljs-comment"><span class="hljs-comment">//  &lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;</span></span></code> </pre> <br>  Si ya tenemos algunos datos, como una matriz o algo similar, se puede crear un b√∫fer basado en estos datos. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name = <span class="hljs-string"><span class="hljs-string">'Node JS DEV'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buffer = Buffer.from(name); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(buffer) <span class="hljs-comment"><span class="hljs-comment">//  &lt;Buffer 4e 6f 64 65 20 4a 53 20 44 45 5&gt;</span></span></code> </pre> <br>  Los b√∫feres tienen m√©todos que le permiten "mirarlos" y descubrir qu√© datos hay all√≠; estos son los m√©todos <code>toString()</code> y <code>toJSON()</code> . <br><br>  Nosotros, en el proceso de optimizaci√≥n del c√≥digo, no crearemos buffers nosotros mismos.  Node.js crea estas estructuras de datos autom√°ticamente cuando trabaja con flujos o sockets de red. <br><br><h3>  <font color="#3AC1EF">‚ñç Streams</font> </h3><br>  Las corrientes, si nos dirigimos al lenguaje de la ciencia ficci√≥n, se pueden comparar con los portales de otros mundos.  Hay cuatro tipos de transmisiones: <br><br><ul><li>  Una secuencia para leer (los datos se pueden leer de ella). </li><li>  Secuencia para grabaci√≥n (se le pueden enviar datos). </li><li>  Flujo d√∫plex (est√° abierto para leer datos de √©l y para enviarle datos). </li><li>  Transformaci√≥n de flujo (un flujo d√∫plex especial que le permite procesar datos, por ejemplo, comprimirlos o verificar su correcci√≥n). </li></ul><br>  Necesitamos flujos porque el objetivo vital de la API de flujo en Node.js, y en particular el m√©todo <code>stream.pipe()</code> , es limitar el almacenamiento en b√∫fer de datos a niveles aceptables.  Esto se hace para que trabajar con fuentes y receptores de datos que difieren en diferentes velocidades de procesamiento no desborde la memoria disponible. <br><br>  En otras palabras, para resolver el problema de copiar un archivo grande, necesitamos alg√∫n tipo de mecanismo que nos permita no sobrecargar el sistema. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b3/456/6b4/6b34566b47ab3f6e2a0207edd9d7e53b.png"></div><br>  <i><font color="#999999">Secuencias y almacenamientos intermedios (seg√∫n la documentaci√≥n de Node.js)</font></i> <br><br>  El diagrama anterior muestra dos tipos de transmisiones: transmisiones legibles y transmisiones grabables.  El m√©todo <code>pipe()</code> es un mecanismo muy simple que le permite adjuntar hilos para leer a hilos para escribir.  Si el esquema anterior no es particularmente claro para usted, entonces est√° bien.  Despu√©s de analizar los siguientes ejemplos, puede manejarlo f√°cilmente.  En particular, ahora consideraremos ejemplos de procesamiento de datos utilizando el m√©todo <code>pipe()</code> . <br><br><h2>  <font color="#3AC1EF">Soluci√≥n 1. Copiar archivos usando flujos</font> </h2><br>  Considere la soluci√≥n al problema de copiar un archivo enorme, del que hablamos anteriormente.  Esta soluci√≥n se puede basar en dos hilos y se ver√° as√≠: <br><br><ul><li>  Esperamos que la siguiente pieza de datos aparezca en la secuencia para leer. </li><li>  Escribimos los datos recibidos en la secuencia para su grabaci√≥n. </li><li>  Monitoreamos el progreso de la operaci√≥n de copia. </li></ul><br>  Llamaremos al programa que implementa esta idea <code>streams_copy_basic.js</code> .  Aqu√≠ est√° su c√≥digo: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*         . : Naren Arya */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> stream = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fileName = process.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> destPath = process.argv[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> readable = fs.createReadStream(fileName); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> writeable = fs.createWriteStream(destPath || <span class="hljs-string"><span class="hljs-string">"output"</span></span>); fs.stat(fileName, (err, stats) =&gt; {   <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileSize = stats.size;   <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = <span class="hljs-number"><span class="hljs-number">1</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileArray = fileName.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>);     <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.duplicate = destPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileArray[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'_Copy.'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileArray[<span class="hljs-number"><span class="hljs-number">1</span></span>];   } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) {       <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.exception(<span class="hljs-string"><span class="hljs-string">'File name is invalid! please pass the proper one'</span></span>);   }     process.stdout.write(<span class="hljs-string"><span class="hljs-string">`File: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.duplicate}</span></span></span><span class="hljs-string"> is being created:`</span></span>);     readable.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, (chunk)=&gt; {       <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> percentageCopied = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(chunk.length * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.counter</span></span></span><span class="hljs-function">) / </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileSize</span></span></span><span class="hljs-function">) * 100;       </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">process</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stdout</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">clearLine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;  //          </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">process</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stdout</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cursorTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">);       </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">process</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stdout</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">write</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">`</span></span></span><span class="hljs-subst"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string"><span class="hljs-subst">${</span></span></span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">Math</span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-string"><span class="hljs-subst">.round(percentageCopied)}</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%`</span></span></span></span></span><span class="hljs-function">);       </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">writeable</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">write</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">chunk</span></span></span><span class="hljs-function">);       </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">counter</span></span></span><span class="hljs-function"> += 1;   });     </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">readable</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'end'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, (e</span></span></span><span class="hljs-function">) =&gt;</span></span> {       process.stdout.clearLine();  <span class="hljs-comment"><span class="hljs-comment">//          process.stdout.cursorTo(0);       process.stdout.write("Successfully finished the operation");       return;   });     readable.on('error', (e) =&gt; {       console.log("Some error occurred: ", e);   });     writeable.on('finish', () =&gt; {       console.log("Successfully created the file copy!");   });  });</span></span></code> </pre> <br>  Esperamos que el usuario ejecute este programa para proporcionarle dos nombres de archivo.  El primero es el archivo fuente, el segundo es el nombre de su futura copia.  Creamos dos secuencias: una secuencia para leer y una secuencia para escribir, transfiriendo datos del primero al segundo.  Tambi√©n hay algunos mecanismos auxiliares.  Se utilizan para supervisar el proceso de copia y para enviar la informaci√≥n correspondiente a la consola. <br><br>  Usamos el mecanismo de eventos aqu√≠, en particular, estamos hablando de suscribirnos a los siguientes eventos: <br><br><ul><li>  <code>data</code> : se llama cuando se lee un dato. </li><li>  <code>end</code> : se llama cuando se leen datos de la secuencia de lectura. </li><li>  <code>error</code> : se llama si se produce un error al leer los datos. </li></ul><br>  Con este programa, se copia un archivo de 7,4 GB sin mensajes de error. <br><br><pre> <code class="javascript hljs">$ time node streams_copy_basic.js cartoonMovie.mkv ~<span class="hljs-regexp"><span class="hljs-regexp">/Documents/</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>kdemo.mkv</code> </pre> <br>  Sin embargo, hay un problema.  Se puede identificar observando datos sobre el uso de los recursos del sistema por diversos procesos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aec/40c/5e6/aec40c5e612c14dd6421aff48f711f7c.png"></div><br>  <i><font color="#999999">Datos de uso de recursos del sistema</font></i> <br><br>  Tenga en cuenta que el proceso de <code>node</code> , despu√©s de copiar el 88% del archivo, ocupa 4,6 GB de memoria.  Esto es mucho, tal manejo de la memoria puede interferir con el trabajo de otros programas. <br><br><h3>  <font color="#3AC1EF">‚ñç Razones para el consumo excesivo de memoria</font> </h3><br>  Preste atenci√≥n a la velocidad de lectura de datos del disco y escritura de datos en el disco de la ilustraci√≥n anterior (columnas de lectura de disco y escritura de disco).  A saber, aqu√≠ puede ver los siguientes indicadores: <br><br><pre> <code class="javascript hljs">Disk Read: <span class="hljs-number"><span class="hljs-number">53.4</span></span> MiB/s Disk Write: <span class="hljs-number"><span class="hljs-number">14.8</span></span> MiB/s</code> </pre> <br>  Tal diferencia en las velocidades de lectura del registro de datos significa que la fuente de datos los produce mucho m√°s r√°pido de lo que el receptor puede recibirlos y procesarlos.  La computadora tiene que almacenar en la memoria los fragmentos de datos le√≠dos hasta que se escriben en el disco.  Como resultado, vemos tales indicadores de uso de memoria. <br><br>  En mi computadora, este programa se ejecut√≥ durante 3 minutos y 16 segundos.  Aqu√≠ hay informaci√≥n sobre el progreso de su implementaci√≥n: <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">17.16</span></span>s user <span class="hljs-number"><span class="hljs-number">25.06</span></span>s system <span class="hljs-number"><span class="hljs-number">21</span></span>% cpu <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">16.61</span></span> total</code> </pre> <br><h2>  <font color="#3AC1EF">Soluci√≥n 2. Copiar archivos usando flujos y con ajuste autom√°tico de la velocidad de lectura y escritura de datos</font> </h2><br>  Para hacer frente al problema anterior, podemos modificar el programa para que durante la copia de archivos, las velocidades de lectura y escritura se configuren autom√°ticamente.  Este mecanismo se llama contrapresi√≥n.  Para usarlo, no necesitamos hacer nada especial.  Es suficiente, utilizando el m√©todo <code>pipe()</code> , conectar la secuencia de lectura a la secuencia de escritura, y Node.js ajustar√° autom√°ticamente las velocidades de transferencia de datos. <br><br>  Llame a este programa <code>streams_copy_efficient.js</code> .  Aqu√≠ est√° su c√≥digo: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*          pipe(). : Naren Arya */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> stream = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fileName = process.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> destPath = process.argv[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> readable = fs.createReadStream(fileName); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> writeable = fs.createWriteStream(destPath || <span class="hljs-string"><span class="hljs-string">"output"</span></span>); fs.stat(fileName, (err, stats) =&gt; {   <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileSize = stats.size;   <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = <span class="hljs-number"><span class="hljs-number">1</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileArray = fileName.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>);     <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.duplicate = destPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileArray[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'_Copy.'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileArray[<span class="hljs-number"><span class="hljs-number">1</span></span>];   } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) {       <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.exception(<span class="hljs-string"><span class="hljs-string">'File name is invalid! please pass the proper one'</span></span>);   }     process.stdout.write(<span class="hljs-string"><span class="hljs-string">`File: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.duplicate}</span></span></span><span class="hljs-string"> is being created:`</span></span>);     readable.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, (chunk) =&gt; {       <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> percentageCopied = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(chunk.length * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.counter</span></span></span><span class="hljs-function">) / </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileSize</span></span></span><span class="hljs-function">) * 100;       </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">process</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stdout</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">clearLine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;  //          </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">process</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stdout</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cursorTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">);       </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">process</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stdout</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">write</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">`</span></span></span><span class="hljs-subst"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string"><span class="hljs-subst">${</span></span></span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">Math</span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-string"><span class="hljs-subst">.round(percentageCopied)}</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%`</span></span></span></span></span><span class="hljs-function">);       </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">counter</span></span></span><span class="hljs-function"> += 1;   });   </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">readable</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'error'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, (e</span></span></span><span class="hljs-function">) =&gt;</span></span> {       <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Some error occurred: "</span></span>, e);   });     writeable.on(<span class="hljs-string"><span class="hljs-string">'finish'</span></span>, () =&gt; {       process.stdout.clearLine();  <span class="hljs-comment"><span class="hljs-comment">//          process.stdout.cursorTo(0);       process.stdout.write("Successfully created the file copy!");   });     readable.pipe(writeable); //  !  });</span></span></code> </pre> <br>  La principal diferencia entre este programa y el anterior es que el c√≥digo para copiar fragmentos de datos se reemplaza con la siguiente l√≠nea: <br><br><pre> <code class="javascript hljs">readable.pipe(writeable); <span class="hljs-comment"><span class="hljs-comment">//  !</span></span></code> </pre> <br>  En el coraz√≥n de todo lo que sucede aqu√≠ est√° el m√©todo <code>pipe()</code> .  Controla las velocidades de lectura y escritura, lo que lleva al hecho de que la memoria ya no est√° sobrecargada. <br><br>  Ejecute el programa <br><br><pre> <code class="javascript hljs">$ time node streams_copy_efficient.js cartoonMovie.mkv ~<span class="hljs-regexp"><span class="hljs-regexp">/Documents/</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>kdemo.mkv</code> </pre> <br>  Estamos copiando el mismo archivo enorme.  Ahora veamos c√≥mo funciona el trabajo con la memoria y con el disco. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0a5/79e/77a/0a579e77a95a32ea0f5dcfd7afdd2274.png"></div><br>  <i><font color="#999999">Al usar pipe (), las velocidades de lectura y escritura se configuran autom√°ticamente</font></i> <br><br>  Ahora vemos que el proceso de <code>node</code> consume solo 61.9 MB de memoria.  Si observa los datos sobre el uso del disco, puede ver lo siguiente: <br><br><pre> <code class="javascript hljs">Disk Read: <span class="hljs-number"><span class="hljs-number">35.5</span></span> MiB/s Disk Write: <span class="hljs-number"><span class="hljs-number">35.5</span></span> MiB/s</code> </pre> <br>  Gracias al mecanismo de contrapresi√≥n, las velocidades de lectura y escritura ahora son siempre iguales entre s√≠.  Adem√°s, el nuevo programa funciona 13 segundos m√°s r√°pido que el anterior. <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">12.13</span></span>s user <span class="hljs-number"><span class="hljs-number">28.50</span></span>s system <span class="hljs-number"><span class="hljs-number">22</span></span>% cpu <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">03.35</span></span> total</code> </pre> <br>  Al usar el m√©todo <code>pipe()</code> , pudimos reducir el tiempo de ejecuci√≥n del programa y el consumo de memoria en un 98.68%. <br><br>  En este caso, 61,9 MB es el tama√±o del b√∫fer creado por el flujo de lectura de datos.  Podemos establecer este tama√±o nosotros mismos, utilizando el m√©todo <code>read()</code> de la secuencia para leer datos: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> readable = fs.createReadStream(fileName); readable.read(no_of_bytes_size);</code> </pre> <br>  Aqu√≠ copiamos el archivo en el sistema de archivos local, sin embargo, se puede usar el mismo enfoque para optimizar muchas otras tareas de entrada y salida de datos.  Por ejemplo, esto funciona con flujos de datos, cuya fuente es Kafka, y el receptor es la base de datos.  De acuerdo con el mismo esquema, es posible organizar la lectura de datos de un disco, comprimi√©ndolos, como dicen, "sobre la marcha", y volvi√©ndolos a escribir en el disco ya en forma comprimida.  De hecho, hay muchos otros usos para la tecnolog√≠a aqu√≠ descrita. <br><br><h2>  <font color="#3AC1EF">Resumen</font> </h2><br>  Uno de los objetivos de este art√≠culo era demostrar lo f√°cil que es escribir programas malos en Node.js, a pesar de que esta plataforma proporciona excelentes API para el desarrollador.  Con un poco de atenci√≥n a esta API, puede mejorar la calidad de los proyectos de software del lado del servidor. <br><br>  <b>Estimados lectores!</b>  ¬øC√≥mo trabaja con buffers e hilos en Node.js? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/n0/ry/op/n0ryop7wfykgkeicz3mtuwghrcu.jpeg"></a> </div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433408/">https://habr.com/ru/post/es433408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433398/index.html">Pensamiento funcional Parte 7</a></li>
<li><a href="../es433400/index.html">Tutorial React Parte 2: Componentes funcionales</a></li>
<li><a href="../es433402/index.html">Pensamiento funcional Parte 8</a></li>
<li><a href="../es433404/index.html">Tutorial React Parte 3: Archivos de componentes, estructura del proyecto</a></li>
<li><a href="../es433406/index.html">Pensamiento funcional Parte 9</a></li>
<li><a href="../es433410/index.html">Pensamiento funcional Parte 10</a></li>
<li><a href="../es433412/index.html">Pensamiento funcional Parte 11: Final</a></li>
<li><a href="../es433414/index.html">Prueba de PRTG Network Monitor y comparaci√≥n con Zabbix</a></li>
<li><a href="../es433420/index.html">Resultados de ZeroNights 2018</a></li>
<li><a href="../es433424/index.html">¬øEs posible cargar un nivel intransitable en Super Mario Maker?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>