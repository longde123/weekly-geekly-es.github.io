<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóÉÔ∏è üèπ üëô Interop√©rabilit√© s√©curis√©e dans les syst√®mes distribu√©s ü§§ ü§¨ üíê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Habr! 

 Je m'appelle Alexey Solodky, je suis d√©veloppeur PHP chez Badoo. Et aujourd'hui, je vais partager une version texte de mon discours pou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Interop√©rabilit√© s√©curis√©e dans les syst√®mes distribu√©s</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/413555/"><img src="https://habrastorage.org/webt/ag/m-/8r/agm-8r1daffwnqqhzqagmayd4uc.png" width="800"><br><br>  Salut Habr! <br><br>  Je m'appelle Alexey Solodky, je suis d√©veloppeur PHP chez Badoo.  Et aujourd'hui, je vais partager une version texte de mon discours pour le premier Badoo PHP Meetup.  Une vid√©o de ceci et d'autres rapports du mitap peut √™tre trouv√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Tout syst√®me compos√© d'au moins deux composants (et si vous avez √† la fois PHP et une base de donn√©es, alors ce sont deux composants), fait face √† des classes enti√®res de risques dans l'interaction entre ces composants. <br><br>  Le d√©partement plateforme dans lequel je travaille int√®gre de nouveaux services internes √† notre application.  Et en r√©solvant ces probl√®mes, nous avons accumul√© une exp√©rience que je veux partager. <br><br>  Notre backend est un monolithe PHP interagissant avec de nombreux services (il en existe actuellement environ 50).  Les services interagissent rarement entre eux.  Mais les probl√®mes dont je parle dans l'article sont √©galement pertinents pour l'architecture de microservices.  En effet, dans ce cas, les services interagissent tr√®s activement les uns avec les autres, et plus vous avez d'interaction, plus vous avez de probl√®mes. <br><br>  R√©fl√©chissez √† ce qu'il faut faire lorsque le service tombe en panne ou s'√©mousse, comment organiser la collecte des m√©triques et que faire lorsque tout ce qui pr√©c√®de ne vous sauve pas. <br><a name="habracut"></a><br><h2>  Panne de service </h2><br>  T√¥t ou tard, le serveur sur lequel votre service est install√© tombera.  Cela arrivera √† coup s√ªr, et vous ne pouvez pas vous d√©fendre contre cela - ne faites que r√©duire la probabilit√©.  Vous pouvez √™tre d√©√ßu par le mat√©riel, le r√©seau, le code, le d√©ploiement infructueux - n'importe quoi.  Et plus vous avez de serveurs, plus cela se produit souvent. <br><br>  Comment faire survivre vos services dans un monde o√π les serveurs plantent constamment?  Une approche g√©n√©rale pour r√©soudre cette classe de probl√®mes est la redondance. <br><br>  La redondance est utilis√©e partout √† diff√©rents niveaux: du fer √† des datacenters entiers.  Par exemple, RAID1 pour se prot√©ger contre les pannes de disque dur ou une alimentation de secours pour votre serveur en cas de panne du premier.  En outre, ce sch√©ma est largement appliqu√© aux bases de donn√©es.  Par exemple, vous pouvez utiliser ma√Ætre-esclave pour cela. <br><br>  Consid√©rons les probl√®mes typiques de redondance en utilisant le sch√©ma le plus simple comme exemple: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/9b/rb/lo9brbsy29ca8b0i-1ygtyckncq.png" width="300"></div><br>  L'application communique exclusivement avec le ma√Ætre, tandis qu'en arri√®re-plan, de mani√®re asynchrone, les donn√©es sont transf√©r√©es √† l'esclave.  Lorsque le ma√Ætre tombe en panne, nous passerons √† l'esclave et continuerons de travailler. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/lt/o5/galto5cgws3ed44dfwhnqq9zvd4.png" width="300"></div><br><br>  Apr√®s avoir restaur√© le ma√Ætre, nous en faisons juste un nouvel esclave, et l'ancien se transforme en ma√Ætre. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6h/c8/gc/6hc8gc6qzhzso3xscnjblfn1frm.png" width="300"></div><br>  Le sch√©ma est simple, mais il a m√™me de nombreuses nuances caract√©ristiques de tout sch√©ma redondant. <br><br><h3>  Charge </h3><br>  Disons qu'un serveur de l'exemple ci-dessus peut supporter environ 100 000 RPS.  Maintenant, la charge est de 60k RPS, et tout fonctionne comme une horloge. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/99/gw/j1/99gwj19rezs-ywa-hdopmqcudk8.png" width="300"></div><br>  Mais au fil du temps, la charge sur l'application, et donc la charge sur le ma√Ætre, augmente.  Vous pouvez souhaiter l'√©quilibrer en d√©pla√ßant une partie de la lecture vers un esclave. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sv/r4/si/svr4sicizgym8gqndznsygpi0-o.png" width="300"></div><br>  √áa a l'air plut√¥t bien.  Tient la charge, le serveur n'est plus inactif.  Mais c'est une mauvaise id√©e.  Il est important de se rappeler pourquoi vous avez initialement √©lev√© l'esclave - pour y basculer en cas de probl√®me avec le principal.  Si vous avez commenc√© √† charger les deux serveurs, alors lorsque votre ma√Ætre se bloque - et t√¥t ou tard il se bloque - vous devrez commuter le trafic principal du ma√Ætre vers le serveur de sauvegarde, et il est d√©j√† charg√©.  Une telle surcharge rendra votre syst√®me terriblement lent ou le d√©sactivera compl√®tement. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9t/py/la/9tpylanqp3whk7tcr4csdln6yo0.png" width="300"></div><br><h3>  Les donn√©es </h3><br>  Le principal probl√®me lors de l'ajout d'une tol√©rance aux pannes √† un service est l'√©tat local.  Si votre service est sans √©tat, c'est-√†-dire qu'il ne stocke aucune donn√©e modifiable, sa mise √† l'√©chelle ne pose pas de probl√®me.  Nous soulevons juste autant de cas que nous en avons besoin et √©quilibrons les demandes entre eux. <br><br>  Dans le cas o√π le service est avec √©tat, nous ne pouvons plus le faire.  Vous devez r√©fl√©chir √† la fa√ßon de stocker les m√™mes donn√©es sur toutes les instances de notre service afin qu'elles restent coh√©rentes. <br><br>  Pour r√©soudre ce probl√®me, l'une des deux approches est utilis√©e: r√©plication synchrone ou asynchrone.  Dans le cas g√©n√©ral, je vous conseille d'utiliser l'option asynchrone, car elle est g√©n√©ralement plus simple et plus rapide √† √©crire et, selon les circonstances, voyez si vous devez passer en synchrone. <br><br>  Une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">coh√©rence</a> importante √† prendre en compte lors de l'utilisation de la r√©plication asynchrone est la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">coh√©rence √©ventuelle</a> .  Cela signifie qu'√† un moment donn√© sur diff√©rents esclaves, les donn√©es peuvent √™tre en retard sur le ma√Ætre par des intervalles de temps impr√©visibles et diff√©rents. <br>  Par cons√©quent, vous ne pouvez pas lire les donn√©es √† chaque fois √† partir d'un serveur al√©atoire, car des r√©ponses diff√©rentes peuvent alors arriver aux m√™mes demandes des utilisateurs.  Pour contourner ce probl√®me, le m√©canisme des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sessions persistantes est utilis√©</a> , ce qui garantit que toutes les demandes d'un utilisateur vont √† une seule instance. <br><br>  Les avantages d'une approche synchrone sont que les donn√©es sont toujours dans un √©tat coh√©rent et que le risque de perdre des donn√©es est plus faible (car il est consid√©r√© comme enregistr√© uniquement apr√®s que tous les serveurs l'ont fait).  Cependant, vous devez payer pour cela avec la vitesse d'√©criture et la complexit√© du syst√®me lui-m√™me (par exemple, divers algorithmes de quorum pour la protection contre le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">split-brain</a> ). <br><br><h3>  Conclusions </h3><br><ul><li>  <b>R√©serve.</b>  Si les donn√©es elles-m√™mes et la disponibilit√© d'un service particulier sont importantes, assurez-vous que votre service survivra √† la chute d'une machine particuli√®re. <br></li><li>  <b>Lors du calcul de la charge, tenez compte de la chute de certains serveurs.</b>  Si votre cluster poss√®de quatre serveurs, assurez-vous que lorsqu'un tombera, les trois autres tireront la charge. <br></li><li>  <b>Choisissez le type de r√©plication en fonction des t√¢ches.</b> <br></li><li>  <b>Ne mettez pas tous vos ≈ìufs dans le m√™me panier.</b>  Assurez-vous que vous √™tes suffisamment √©loign√© des serveurs.  Selon l'importance de la disponibilit√© des services, vos serveurs peuvent se trouver dans des racks diff√©rents dans un centre de donn√©es, ou dans diff√©rents centres de donn√©es dans diff√©rents pays.  Tout d√©pend de la quantit√© de catastrophes que vous souhaitez et √™tes pr√™t √† survivre. <br></li></ul><br><h2>  Service de silence </h2><br>  √Ä un moment donn√©, votre service peut commencer √† fonctionner tr√®s lentement.  Ce probl√®me peut se produire pour de nombreuses raisons: charge excessive, retards r√©seau, probl√®mes mat√©riels ou erreurs de code.  Cela ressemble √† un probl√®me pas si terrible, mais en fait, il est plus insidieux qu'il n'y para√Æt. <br><br>  Imaginez: un utilisateur demande une page.  Nous acc√©dons simultan√©ment et s√©quentiellement aux quatre d√©mons pour l'attirer.  Ils r√©pondent rapidement, tout fonctionne bien. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vo/u9/q5/vou9q5svtrqqptnxti-vkeuhmbm.png" width="400"></div><br>  Supposons que ce cas soit g√©r√© en utilisant nginx avec un nombre fixe de travailleurs PHP FPM (avec dix, par exemple).  Si chaque demande est trait√©e pendant environ 20 ms, alors √† l'aide de calculs simples, on peut comprendre que notre syst√®me est capable de traiter environ cinq cents demandes par seconde. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/h2/o2/tqh2o239lvw7qiobm8scwzrjma4.png" width="450"></div><br>  Que se passe-t-il lorsque l'un de ces quatre services commence √† √©mousser et que le traitement des demandes passe de 20 ms √† un d√©lai d'expiration de 1000 ms?  Il est important de se rappeler que lorsque nous travaillons avec le r√©seau, le retard peut √™tre infiniment grand.  Par cons√©quent, vous devez toujours d√©finir un d√©lai d'expiration (dans ce cas, il est √©gal √† une seconde). <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rn/uq/ae/rnuqaevpyknuwpgd9a94oygknia.png" width="400"></div><br>  Il s'av√®re que le backend est oblig√© d'attendre l'expiration du d√©lai et de recevoir et traiter l'erreur du d√©mon.  Cela signifie que l'utilisateur re√ßoit la page en une seconde au lieu de dix millisecondes.  Lent, mais pas fatal. <br><br>  Mais quel est le vrai probl√®me ici?  Le fait est que lorsque nous traitons chaque demande par seconde, le d√©bit tombe tragiquement √† dix demandes par seconde.  Et le onzi√®me utilisateur ne pourra plus obtenir de r√©ponse, m√™me s'il a demand√© une page qui n'est en aucun cas associ√©e √† un service ennuyeux.  Tout simplement parce que les dix employ√©s attendent un d√©lai d'attente et ne peuvent pas traiter de nouvelles demandes. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sk/tn/dz/sktndzfsfdbjsgobqxmm5sy_xkw.png" width="450"></div><br>  Il est important de comprendre que ce probl√®me ne peut √™tre r√©solu en augmentant le nombre de travailleurs.  Apr√®s tout, chaque travailleur a besoin d'une certaine quantit√© de RAM pour son travail, m√™me s'il n'effectue pas de travail r√©el, mais se bloque simplement en pr√©vision d'un d√©lai d'attente.  Par cons√©quent, si vous ne limitez pas le nombre de travailleurs en fonction des capacit√©s de votre serveur, l'augmentation de plus en plus de nouveaux travailleurs mettra l'ensemble du serveur.  Ce cas est un exemple d'√©chec en cascade, lorsque la chute d'un service, m√™me si elle n'est pas critique pour l'utilisateur, provoque une d√©faillance de l'ensemble du syst√®me. <br><br><h3>  Solution </h3><br>  Il existe un motif appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">disjoncteur</a> .  Sa t√¢che est assez simple: il doit √† un moment donn√© supprimer un service ennuyeux.  Pour cela, un proxy est plac√© entre le service et les travailleurs.  Il peut s'agir de code PHP avec stockage ou d'un d√©mon sur l'h√¥te local.  Il est important de noter que si vous avez plusieurs instances (votre service est r√©pliqu√©), ce proxy doit suivre s√©par√©ment chacune d'entre elles. <br><br>  Nous avons √©crit notre impl√©mentation de ce mod√®le.  Mais pas parce que nous aimons √©crire du code, mais parce que lorsque nous avons r√©solu ce probl√®me il y a de nombreuses ann√©es, il n'y avait pas de solutions toutes faites. <br><br>  Je vais maintenant d√©crire en termes g√©n√©raux notre impl√©mentation et comment elle permet d'√©viter ce probl√®me.  Et plus sur elle et ses diff√©rences par rapport √† d'autres solutions peuvent √™tre entendues <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans un rapport de Mikhail Kurmaev sur Highload Siberia</a> fin juin.  La transcription de son rapport sera √©galement sur ce blog. <br><br>  Cela ressemble √† ceci: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dz/em/-d/dzem-dkkbiq6qx04cknxzdo99bc.png" width="500"></div><br>  Il existe un service Sphinx abstrait, auquel est confront√© un disjoncteur.  Le disjoncteur stocke le nombre de connexions actives √† un d√©mon sp√©cifique.  D√®s que cette valeur atteint le seuil que nous avons d√©fini en pourcentage des travailleurs FPM disponibles sur la machine, nous pensons que le service a commenc√© √† ralentir.  Une fois le premier seuil atteint, nous envoyons une notification au responsable du service.  Une telle situation est soit un signe que les limites doivent √™tre revues, soit un signe avant-coureur de probl√®mes d'ennui. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_g/ou/k6/_gouk6h_xfurcn_o04rslmiwsh8.png" width="500"></div><br>  Si la situation empire et que le nombre de travailleurs inhibiteurs atteint le deuxi√®me seuil - dans notre production, il est d'environ 10% - nous supprimons compl√®tement cet h√¥te.  Plus pr√©cis√©ment, le service continue de fonctionner, mais nous cessons de lui envoyer des demandes.  Le navigateur Circuit les rejette et donne imm√©diatement une erreur aux travailleurs, comme si le service mentait. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/co/ao/pd/coaopdx7tp0swvu8qu0t01jf81u.png" width="500"></div><br>  De temps en temps, nous ignorons automatiquement une demande d'un travailleur pour voir si le service a pris vie.  S'il r√©pond ad√©quatement, alors nous l'incluons √† nouveau dans le travail. <br><br>  Tout cela est fait afin de r√©duire la situation au sch√©ma de r√©plication pr√©c√©dent.  Au lieu d'attendre une seconde avant de r√©aliser que l'h√¥te n'est pas disponible, nous obtenons imm√©diatement une erreur et allons √† l'h√¥te de sauvegarde. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9c/s8/iz/9cs8iz-aepaztqroslluwwregt0.png" width="400"></div><br><br><h3>  Impl√©mentations </h3><br>  Heureusement, l'Open Source ne reste pas immobile, et aujourd'hui vous pouvez prendre une solution cl√© en main sur Github. <br><br>  Il existe deux approches principales pour impl√©menter un disjoncteur: une biblioth√®que au niveau du code et un d√©mon autonome qui proc√®de par procuration aux requ√™tes par lui-m√™me. <br><br>  L'option avec la biblioth√®que est plus appropri√©e si vous avez un monolithe principal en PHP, qui interagit avec plusieurs services, et les services ne communiquent presque pas entre eux.  Voici quelques impl√©mentations disponibles: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ganesha</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Disjoncteur PHP</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Phystrix</a> <br></li></ul><br>  Si vous avez de nombreux services dans diff√©rentes langues et qu'ils interagissent tous, l'option au niveau du code devra √™tre dupliqu√©e dans toutes ces langues.  Cela est g√™nant dans le support et conduit finalement √† des diff√©rences dans les impl√©mentations. <br><br>  Mettre un d√©mon dans ce cas est beaucoup plus facile.  Dans ce cas, vous n'avez pas besoin de modifier sp√©cialement le code.  Le d√©mon essaie de rendre l'interaction transparente.  Cependant, cette option est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">beaucoup plus compliqu√©e sur le plan architectural</a> . <br><br>  Voici quelques options (la fonctionnalit√© y est plus riche, mais il y a aussi un disjoncteur): <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Envoy√©</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Linkerd</a> <br></li></ul><br><h3>  Conclusions </h3><br><ul><li>  Ne comptez pas sur le r√©seau. <br></li><li>  Toutes les demandes r√©seau doivent avoir un d√©lai d'attente, car le r√©seau peut donner un temps infiniment long. <br></li><li>  Utilisez un disjoncteur si vous souhaitez √©viter les plantages d'applications en cascade en raison du ralentissement d'un petit service. <br></li></ul><br><h2>  Surveillance et t√©l√©m√©trie </h2><br><h3>  Qu'est-ce que √ßa donne </h3><br><ul><li>  <b>Pr√©visibilit√©.</b>  Il est important de pr√©dire quelle est la charge et ce qu'elle sera dans un mois afin d'augmenter rapidement le nombre d'instances de service.  Cela est particuli√®rement vrai si vous avez affaire √† une infrastructure de fer, car la commande de nouveaux serveurs prend du temps. </li><li>  <b>Enqu√™te sur les incidents.</b>  T√¥t ou tard, quelque chose va mal de toute fa√ßon, et vous devrez enqu√™ter.  Et il est important d'avoir suffisamment de donn√©es pour comprendre le probl√®me et √™tre en mesure d'√©viter de telles situations √† l'avenir. </li><li>  <b>Pr√©vention des accidents.</b>  Id√©alement, vous devez comprendre quels mod√®les conduisent √† des plantages.  Il est important de garder une trace de ces mod√®les et d'en informer l'√©quipe en temps opportun. </li></ul><br><br><h3>  Que mesurer </h3><br>  <b>Mesures d'int√©gration</b> <br><br>  Puisque nous parlons de l'interaction entre les services, nous surveillons tout ce qui est possible en relation avec la communication du service avec l'application.  Par exemple: <br><br><ul><li>  nombre de demandes; <br></li><li>  temps de traitement des demandes (y compris les centiles); <br></li><li>  nombre d'erreurs logiques; <br></li><li>  nombre d'erreurs syst√®me. <br></li></ul><br>  Il est important de distinguer les erreurs logiques des erreurs syst√®me.  Si le service tombe, c'est une situation r√©guli√®re: nous passons simplement au second.  Mais ce n'est pas si effrayant.  Si vous commencez une sorte d'erreur logique, par exemple, des donn√©es √©tranges arrivent dans le service ou le quittent, alors cela doit d√©j√† √™tre √©tudi√©.  Tr√®s probablement, l'erreur est li√©e √† un bogue dans le code.  Elle-m√™me ne passera pas. <br><br>  <b>Mesures internes</b> <br><br>  Par d√©faut, le service est une bo√Æte noire qui fait son travail de mani√®re incompr√©hensible.  Il est toujours souhaitable de comprendre et de collecter le maximum de donn√©es que le service peut fournir.  Si le service est une base de donn√©es sp√©cialis√©e qui stocke certaines donn√©es de votre logique m√©tier, gardez une trace exacte de la quantit√© de donn√©es, de quel type il s'agit et d'autres mesures de contenu.  Si vous avez une interaction asynchrone, il est √©galement important de surveiller les files d'attente √† travers lesquelles votre service communique: leur vitesse d'arriv√©e et de d√©part, l'heure √† diff√©rentes √©tapes (si vous avez plusieurs points interm√©diaires), le nombre d'√©v√©nements dans la file d'attente. <br><br>  Voyons quelles mesures peuvent √™tre collect√©es en utilisant memcached comme exemple: <br><br><ul><li>  rapport succ√®s / √©chec; <br></li><li>  temps de r√©ponse pour diverses op√©rations; <br></li><li>  RPS de diverses op√©rations; <br></li><li>  ventilation des m√™mes donn√©es sur diff√©rentes cl√©s; <br></li><li>  cl√©s les plus charg√©es; <br></li><li>  toutes les m√©triques internes fournies par la commande stats. <br></li></ul><br><br><h3>  Comment faire </h3><br>  Si vous avez une petite entreprise, un petit projet et quelques serveurs, alors c'est une bonne solution pour connecter une sorte de SaaS pour la collecte et la visualisation - c'est plus facile et moins cher.  Dans ce cas, le SaaS poss√®de g√©n√©ralement des fonctionnalit√©s √©tendues et n'a pas √† se soucier de beaucoup de choses.  Exemples de tels services: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Datadog</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rollbar</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nouvelle relique</a> <br></li></ul><br>  Alternativement, vous pouvez toujours installer Zabbix, Grafana ou toute autre solution auto-h√©berg√©e sur votre propre machine. <br><br><h3>  Conclusions </h3><br><ul><li>  <b>Collectez toutes les m√©triques que vous pouvez.</b>  Les donn√©es ne sont pas superflues.  Lorsque vous devrez enqu√™ter sur quelque chose, vous direz merci pour votre pr√©voyance. </li><li>  <b>N'oubliez pas l'interaction asynchrone.</b>  Si vous avez des lignes qui atteignent progressivement, il est important de comprendre √† quelle vitesse elles atteignent, ce qui arrive √† vos √©v√©nements √† la jonction entre les services. </li><li>  <b>Si vous √©crivez votre service, apprenez-lui √† donner des statistiques sur le travail.</b>  Une partie des donn√©es peut √™tre mesur√©e sur la couche d'int√©gration lorsque nous communiquons avec ce service.  Le reste du service devrait √™tre en mesure de fournir des statistiques selon la commande conditionnelle.  Par exemple, dans tous nos services sur Go, cette fonctionnalit√© est standard. </li><li>  <b>Personnalisez les d√©clencheurs.</b>  <b>Les graphiques sont bons, mais seulement pendant que vous les regardez.</b>  Il est important que vous disposiez d'un syst√®me personnalis√© qui vous permettra de savoir si quelque chose ne va pas. </li></ul><br><h2>  Memento mori </h2><br>  Et maintenant un peu de tristes choses.  Vous pouvez avoir l'impression que ce qui pr√©c√®de est une panac√©e, et maintenant rien ne tombera jamais.  Mais m√™me si vous appliquez tout ce qui est d√©crit ci-dessus, de toute fa√ßon, quelque chose tombera.  Il est important de consid√©rer cela. <br>  Les raisons de la chute sont multiples.  Par exemple, vous pouvez choisir un sch√©ma de r√©plication insuffisamment parano√Øaque.  Une m√©t√©orite est tomb√©e dans votre centre de donn√©es, puis dans le second.  Ou vous venez de d√©ployer le code avec une erreur d√©licate qui est apparue de mani√®re inattendue. <br><br>  Par exemple, √† Badoo, il y a une page "Les gens √† proximit√©".  L√†, les utilisateurs recherchent d'autres personnes √† proximit√© pour discuter avec eux. <br><br><img src="https://habrastorage.org/webt/3q/l4/xm/3ql4xmmqeobxu4vsrqygagstflw.png"><br><br>  Maintenant, pour rendre la page, le backend effectue des appels synchrones vers environ sept services.  Pour plus de clart√©, r√©duisez ce nombre √† deux.  Un service est responsable du rendu du bloc central avec des photos.  Le second concerne le bloc publicitaire en bas √† gauche.  Ceux qui veulent devenir plus visibles peuvent y arriver.  Si nous avons un service qui affiche cette publicit√©, le bloc dispara√Æt tout simplement. <br><br><img src="https://habrastorage.org/webt/rg/tu/pj/rgtupjtztftw7pgvxpwg7auwa1q.png"><br><br>  La plupart des utilisateurs ne savent m√™me pas ce fait: notre √©quipe r√©pond rapidement, et bient√¥t le bloc r√©appara√Æt simplement. <br><br>  Mais nous ne pouvons pas supprimer discr√®tement toutes les fonctionnalit√©s.  Si nous perdons le service responsable de la partie centrale de la page, cela ne fonctionnera pas pour se cacher.  Par cons√©quent, il est important de dire √† l'utilisateur dans sa langue ce qui se passe. <br><br><img src="https://habrastorage.org/webt/eh/1q/c3/eh1qc3sr6laokkydqscq_ydilue.png"><br><br>  Il est √©galement souhaitable que la d√©faillance d'un service n'entra√Æne pas une d√©faillance en cascade.  Pour chaque service, un code doit √™tre √©crit pour g√©rer sa chute, sinon l'application peut se bloquer dans son ensemble. <br><br>  Mais ce n'est pas tout.  Parfois, quelque chose tombe, sans lequel vous ne pouvez pas vivre du tout.  Par exemple, une base de donn√©es centrale ou un service de session.  Il est important de travailler correctement et de montrer √† l'utilisateur quelque chose de suffisant, de le divertir d'une mani√®re ou d'une autre, pour dire que tout est sous contr√¥le.  Dans le m√™me temps, il est important que tout soit vraiment sous contr√¥le et que les moniteurs soient inform√©s du probl√®me. <br><br><img src="https://habrastorage.org/webt/e6/hs/wt/e6hswt9cdlv2kfnt47zuujzyoyq.png"><br><br><img src="https://habrastorage.org/webt/lr/ch/g9/lrchg9mdfortw-jjnzi9ejdzr8u.png"><br><br><h3>  Mourir si bien </h3><br><ul><li>  <b>Pr√©parez-vous pour l'automne.</b>  Il n'y a pas de solution miracle, alors posez toujours des pailles au cas o√π le service tomberait compl√®tement, m√™me si vous utilisez la redondance. </li><li>  <b>√âvitez les √©checs en cascade</b> lorsque des probl√®mes avec l'un des services tuent l'application enti√®re. </li><li>  <b>D√©sactivez la fonctionnalit√© utilisateur non critique.</b>  C'est normal.  De nombreux services sont utilis√©s uniquement pour des besoins internes et n'affectent pas les fonctionnalit√©s fournies.  Par exemple, un service de statistiques.  Peu importe √† l'utilisateur que des statistiques soient collect√©es aupr√®s de vous ou non.  Il est important pour lui que le site fonctionne. </li></ul><br><h2>  R√©sum√© </h2><br>  Pour int√©grer de mani√®re fiable le nouveau service dans le syst√®me, nous √©crivons une API wrapper sp√©ciale autour de lui dans Badoo, qui assume les t√¢ches suivantes: <br><br><ul><li>  √©quilibrage de charge; </li><li>  d√©lais d'attente; </li><li>  basculement logique; </li><li>  disjoncteur; </li><li>  surveillance et t√©l√©m√©trie; </li><li>  logique d'autorisation; </li><li>  s√©rialisation et d√©s√©rialisation des donn√©es. </li></ul><br>  Il est pr√©f√©rable de vous assurer que tous ces √©l√©ments sont √©galement couverts dans votre couche d'int√©gration.  Surtout si vous utilisez un client API Open-Source pr√™t √† l'emploi.  Il est important de se rappeler que la couche d'int√©gration est une source de risque accru de d√©faillance en cascade de votre application. <br><br>  Merci de votre attention! <br><br>  <b>Litt√©rature</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rel√¢chez-le!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ing√©nierie de fiabilit√© du site</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cr√©ation de microservices</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413555/">https://habr.com/ru/post/fr413555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413545/index.html">L'humour dans l'image de marque - pourquoi ce n'est pas toujours bon</a></li>
<li><a href="../fr413547/index.html">D√©couvrez 2 millions de sessions sans t√™te</a></li>
<li><a href="../fr413549/index.html">Cours de d√©veloppement Web</a></li>
<li><a href="../fr413551/index.html">D√©filement et attention (√©tude 2018)</a></li>
<li><a href="../fr413553/index.html">Le registraire REG.RU a priv√© le partenaire de l'acc√®s √† 70 000 domaines et a pris ses services pour lui-m√™me</a></li>
<li><a href="../fr413557/index.html">NewSQL: SQL ne va nulle part</a></li>
<li><a href="../fr413559/index.html">D√©gradation du Web ou comment rendre le Web lisible par l'homme</a></li>
<li><a href="../fr413561/index.html">Vitesse d'arbre d'expression Linq compil√©e</a></li>
<li><a href="../fr413563/index.html">4 fa√ßons d'importer un package dans Go</a></li>
<li><a href="../fr413565/index.html">Analyse de piratage Kubernetes - Porte d√©rob√©e via Kubelet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>