<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😇 💝 📝 ATtiny4上的LED魔术按钮 👚 😹 🙄</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SESAM 


我很久以前曾经有触摸感应式奇迹开关SESAM 。 我真的很喜欢他。 但是时代在变，它不再适合室内装饰，因此它完全不适合与各种时尚的节能灯一起使用。 我喜欢其中的管理原则。 短按传感器即可打开/关闭灯，长按可调节亮度。 谁在乎 -断路器是西门子S576B的类似产品K145AP2 （仍...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ATtiny4上的LED魔术按钮</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411263/"><h4 id="sezam">  SESAM </h4><br><p>我很久以前曾经有触摸感应式奇迹开关<em>SESAM</em> 。 我真的很喜欢他。 但是时代在变，它不再适合室内装饰，因此它完全不适合与各种时尚的节能灯一起使用。 我喜欢其中的管理原则。 短按传感器即可打开/关闭灯，长按可调节亮度。 谁<em>在乎</em> -断路器是<em>西门子S576B的类似产品K145AP2</em> （仍在销售K145AP2）。 </p><br><p> 根据削减，我的版本模拟了该芯片的操作。 </p><a name="habracut"></a><br><p> 不久前，我为自己准备了一个铝制的LED灯带，上面有一个漫射器，这引起了我对开关的疑问。 准备工作有点麻烦。 这样一来，它就挂在电线上了-换上普通的开关并不美观-破坏了视线，而且实在无处可去。 </p><br><p> 我决定在16mm刨花板的末端建造一个开关，并为一个开关和一个调光器。 使它摸起来，盖上贴纸，家具制造商用螺栓将面具遮住。 </p><br><h4 id="zhelezo"> 铁 </h4><br><p> 从传感器开始。 我尝试了将电荷转移到<em>ATtiny13A</em>的原理。 该选项正在运行，但是我懒得去理会自动调整参数等。 他也没有拿完成品。 </p><br><p> 然后，我决定尝试在<em>QTouch</em>库上实现传感器。 作为<em>ATtiny10</em>传感器。 有一个现成的实用程序，可将<em>ATtiny10</em>变成具有所有优点的触摸按钮。 但是在输出中，二进制文件很难在其中添加代码。 我考虑了该怎么做，上网了，然后我提到了<em>TTP223-</em>一个触摸按钮的控制器。 这个选项非常适合我。 </p><br><p> 作为MK，选择权落在<em>ATtiny4上</em> 。 与16位定时器<em>TTP223</em>一样小。 是的，很长一段时间以来，我想对这些修补纸做一些有用的事情。 </p><br><p> 作为关键-旧主板上的<em>P3055LD</em> 。 </p><br><h4 id="pechatnaya-plata"> 电路板 </h4><br><p> 在开发印刷电路板时，我从以下事实开始：刨花板末端的孔需要尽可能的小，我决定7毫米的直径就足够了。 该板的尺寸为7x28mm，分为两层。 </p><br><p> 后来，在对板进行焊接时，很明显，该板无法装入7mm的孔中，至少9mm-它没有考虑元件的高度。 带有标签的想法也以某种方式停止了。 然后一个家具桩吸引了我的眼球！ 专为10mm孔设计，内径恰好7mm！ 一切都巧合！ </p><br><p> 传感器本身贴在一条单独的围巾上，该围巾焊接在主端上。 在图片中您可以看到。 </p><br><div class="spoiler">  <b class="spoiler_title">图片</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/geektimes/post_images/c90/811/124/c908111247ab756b2667c342f63910ef.jpg" alt="漂亮图片"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/8e7/bb2/c17/8e7bb2c177c2f1f1940cc7a9edf1d7c6.jpg" alt="漂亮图片"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/626/916/1bb/6269161bb3a78aa01bd7f6b77119af5d.jpg" alt="漂亮图片"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e14/976/8f0/e149768f0a162a2598003f83d5741e4a.jpg" alt="漂亮图片"></p></div></div><br><h4 id="programma"> 程序 </h4><br><p> 控制程序用汇编器编写。 每32毫秒（看门狗定时器）对传感器进行一次轮询。 根据当前状态和按压持续时间，执行某些操作。 工作逻辑与原型<em>K145AP2</em>略有不同 </p><br><p> 如果指示灯熄灭（通电后的状态）： </p><br><ul><li> 短按可以关闭时的相同水平打开照明。 首次以最大亮度打开时 </li><li> 长按可最大程度地打开灯光。 </li></ul><br><p> 如果指示灯亮： </p><br><ul><li> 短按可关闭灯 </li><li> 长按可更改亮度。 反复长按可改变亮度的变化方向 </li></ul><br><p> 程序过短的按下（干扰）将被忽略。 亮度由PWM系数（16位）设置。  PWM频率约为122 Hz（8,000,000 Hz / 2 16≈122 Hz） </p><br><p>  <strong>为了从实际亮度中补偿对照明亮度的心理生理感知，沿立方抛物线的一部分发生了后者的变化</strong> 。 通常使用表格进行此操作，但是在我的版本中，系数是计算得出的。 该系数随PWM频率而变化，也就是说，当亮度改变时，每个脉冲都有其自己的持续时间。 最小PWM值受软件限制。 </p><br><p>  MK大部分时间与<em>TTP223</em>一起休眠并消耗约16微安培的电流。 也就是说，该电路非常适合具有自主电源的设备。 </p><br><p>  <em>ATtiny4有</em>六个引脚。 两个用于电源，一个默认用于复位。 我已经涉及了两个。 只剩一个。 我想到了如何使用它。 然后我想起了一个新朋友的带有Force Touch触控板的笔记本电脑。 作为实验，我决定做类似的事情。 我不需要太大的可靠性，而且旧手机有很多振动马达。 结果，我在程序中实现了这样的功能：当达到调整极限时，在自由输出上会出现短脉冲。 在<em>K145AP2中，</em>到达调整边界时，调整方向改变。 因此，需要一些技巧以最大或最小程度从传感器上移开手。 在我的实现中，到达边界时，调整停止。 从一个边界到另一个边界的总调整时间约为4秒。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="推！">GitHub上</a>可用的代码 </p><br><h4 id="tpi-cherez-arduinu"> 通过Arduino的TPI </h4><br><p> 另外，我注意到MK的编程。 我的<em>JTAGICE3</em>不支持TPI编程接口。 但是，幸运的是， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">好人在Arduin</a>上<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">写了一个草图来编写</a>这个小东西。 并不是马上，但是一切对我来说都是可行的，固件被淹没了，一切都正常了。 除arduins外，还需要4个电阻。 整个过程画在草图上。 </p><br><h4 id="itog"> 总结 </h4><br><p> 魔术按钮已安装并按预期工作。 电流消耗和尺寸使其可以嵌入具有自主电源的设备中。 </p><br><p> 我没有从振动中得到预期的效果。 这里显然需要对安装站点进行实验。 </p><br><p> 在原型<em>K145AP2</em>和<em>Siemens S576B</em>类似物中，有一个结论“睡眠”。 在这种模式下，亮度下降非常缓慢，直到完全关闭为止。 按照制造商的计划，为此在床头附近安装了一个附加传感器。  PWM定时器的16位使能该模式。 </p><br><p> 这是来自未来的想法。 </p><br><div class="spoiler">  <b class="spoiler_title">按钮到位</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/geektimes/post_images/757/2da/2b5/7572da2b50cf61fc18aef6e609b80650.jpg" alt="漂亮图片"></p></div></div><br><p> 像一切。 </p><br><p> 谢谢大家！ </p><br><p>  UPD：如我所愿，我将PWM频率提高到接近1kHz。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="推！">GitHub</a>代码 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN411263/">https://habr.com/ru/post/zh-CN411263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN411253/index.html">中子星的合并终结了暗物质和暗能量的替代</a></li>
<li><a href="../zh-CN411255/index.html">以太坊上数百万用户的去中心化应用</a></li>
<li><a href="../zh-CN411257/index.html">在美国，他们制造了一种激光系统，可以用声音吓the敌人</a></li>
<li><a href="../zh-CN411259/index.html">我们将水表连接到智能家居</a></li>
<li><a href="../zh-CN411261/index.html">假肢的振动响应：改善仿生肢体控制的新方法</a></li>
<li><a href="../zh-CN411265/index.html">间谍案件（第3部分）</a></li>
<li><a href="../zh-CN411267/index.html">谁是真正的诺基亚品牌智能手机的幕后推手？</a></li>
<li><a href="../zh-CN411269/index.html">“ LOAD”的三个组成部分</a></li>
<li><a href="../zh-CN411271/index.html">特斯拉Autopilot电动汽车在困难的路段上纠缠不清</a></li>
<li><a href="../zh-CN411273/index.html">对robolits吸引力的首次研究</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>