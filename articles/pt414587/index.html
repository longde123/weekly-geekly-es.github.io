<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèæ üñêüèø ‚ú≥Ô∏è Drone aut√¥nomo DIY com controle sobre a Internet. Parte 2 sobre software üêá üàµ üõÄüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta √© uma continua√ß√£o da hist√≥ria de um drone aut√¥nomo. A primeira parte falou sobre hardware, esta falar√° sobre software. Para come√ßar, um pequeno p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Drone aut√¥nomo DIY com controle sobre a Internet. Parte 2 sobre software</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414587/">  Esta √© uma continua√ß√£o da hist√≥ria de um drone aut√¥nomo.  A <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira parte</a> falou sobre hardware, esta falar√° sobre software.  Para come√ßar, um pequeno programa educacional sobre a intera√ß√£o do operador com o helic√≥ptero.  Aqui est√° um layout t√≠pico para a maioria dos drones auto-montados: <br><br><img src="https://habrastorage.org/webt/f6/jn/na/f6jnnadl96jkvjtcngwxhxogkcu.png" alt="imagem"><br><br>  E aqui est√° o esquema para drones avan√ßados: <br><br><img src="https://habrastorage.org/webt/gz/5t/bg/gz5tbg7qqv82_5t86usnrsyhgsg.png" alt="imagem"><br><a name="habracut"></a><br>  √â assim que os drones de brinquedo funcionam, controlados a partir de um smartphone: <br><br><img src="https://habrastorage.org/webt/zr/tu/7r/zrtu7r2febul6zxzy2uzrkpf8rq.png" alt="imagem"><br><br>  Voc√™ pode controlar o drone pela Internet (se voc√™ tiver um cart√£o SIM com um endere√ßo IP est√°tico): <br><br><img src="https://habrastorage.org/webt/ae/d1/yk/aed1yk46dzosxybjpglxk6bwu5i.png" alt="imagem"><br><br>  Ou ent√£o, se o endere√ßo IP for din√¢mico: <br><br><img src="https://habrastorage.org/webt/v2/x_/jo/v2x_jo1dtumefo_wekedrufda0o.png" alt="imagem"><br><br>  Para confiabilidade e redund√¢ncia dos canais de comunica√ß√£o, a √∫ltima op√ß√£o pode ser desenvolvida para esse estado: <br><br><img src="https://habrastorage.org/webt/x6/yz/ho/x6yzhoievpeggh8ya7jo8cmxvo4.png" alt="imagem"><br><br>  A seguir, descreverei o processo de instala√ß√£o do controlador de v√¥o Emlid Navio 2 e do microcomputador Raspberry Pi 3. <br><br><img src="https://habrastorage.org/webt/7g/lr/cv/7glrcvssoyxvii2swoekbsrkuf8.jpeg" alt="imagem"><br>  Por√©m, com pequenas modifica√ß√µes, essas configura√ß√µes s√£o adequadas para qualquer controlador de v√¥o, com o qual voc√™ pode se comunicar por meio do protocolo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MAVLink</a> em conjunto com qualquer computador em uma fam√≠lia de sistemas operacionais Linux. <br><br><img src="https://habrastorage.org/webt/bq/6c/my/bq6cmyprlzet6b8w4kemu_nn_ao.png" alt="imagem"><br><br>  <b><u>Importante!</u></b>  <b><u>A configura√ß√£o deve ser feita com a energia desligada nos controladores de velocidade, para que os motores n√£o d√™em partida acidentalmente.</u></b> <br><br><h3>  Software de controle Drone para PC e tablets </h3><br>  Para controlar o UAV, programas especiais GCS (Ground Control Station) s√£o usados.  Mais adiante, no texto, usarei essa abrevia√ß√£o.  Gostei do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">QGroundControl</a> , um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GCS</a> multi-plataforma de c√≥digo aberto (Windows, Linux, MacOS, iOS, Android) que se tornou parte do projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DroneCode</a> .  Mas existem alternativas, gratuitas e comerciais: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">APM Planner</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MissionPlanner</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UgCS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LibrePilot</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OpenPilot</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tower</a> (DroidPlanner) para Android, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MAVPilot</a> (iOS), <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SidePilot</a> (iOS).  Bem como o console <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MAVProxy</a> . <br><br><h3>  Instale uma imagem do sistema operacional em um cart√£o SD </h3><br>  Para opera√ß√£o normal do piloto autom√°tico, √© altamente recomend√°vel usar cart√µes SD "r√°pidos" (classe 10).  Os cart√µes de mem√≥ria lenta n√£o t√™m tempo para salvar os registros do piloto autom√°tico, mesmo em baixa frequ√™ncia, como resultado, eles acabam distorcidos ou n√£o s√£o gravados.  A evid√™ncia disso pode ser um erro " <i>No IO heartbeat</i> ", que pode ser observado no console do MAVLink (como assistir ao console do MAVLink √© descrito abaixo).  Ao comprar, observe a capacidade de gravar v√≠deos em 4K: provavelmente ser√° um SD r√°pido.  Infelizmente, descobri isso depois da queda do drone, quando foi necess√°rio analisar os logs e descobrir o motivo.  Os logs eram ileg√≠veis para v√°rios GCS.  O motivo para desligar os motores durante o voo acabou sendo banal: esqueci de ajustar a tens√£o m√≠nima da bateria nas configura√ß√µes para opera√ß√£o √† prova de falhas. <br><br>  Portanto, fa√ßa o download da imagem final do Raspbian Stretch com Ardupilot e ROS pr√©-instalados do Emlid na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">p√°gina de instru√ß√µes original</a> .  E n√≥s o escrevemos em um cart√£o de mem√≥ria usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Etcher</a> ou qualquer outro programa similar. <br><br>  Para conectar o Raspberry √† sua rede Wi-Fi imediatamente ap√≥s ligar, voc√™ precisa editar o arquivo <i>wpa_supplicant.conf</i> na raiz do cart√£o SD.  Ele deve conter as seguintes linhas: <br><br><pre><code class="bash hljs">network={ ssid=<span class="hljs-string"><span class="hljs-string">"_wifi_"</span></span> psk=<span class="hljs-string"><span class="hljs-string">"_wifi_"</span></span> }</code> </pre> <br>  Voc√™ tamb√©m pode configur√°-lo sem WiFi conectando um computador de placa √∫nica ao roteador com um cabo Ethernet.  Agora remova o cart√£o SD do PC, insira-o no Raspberry e ligue a alimenta√ß√£o.  Ap√≥s meio minuto, ele deve aparecer no painel de administra√ß√£o do roteador na p√°gina de dispositivos conectados ( <i>nome do host do</i> navio). <br><br><h3>  Atualizando o kit de distribui√ß√£o e instalando os pacotes necess√°rios </h3><br>  Abra o cliente SSH e conecte-se ao Raspberry (endere√ßo IP local do navio em vez de <i>RASPBERRY_IP_ADDRESS</i> ): <br><br><pre> <code class="bash hljs">ssh pi@RASPBERRY_IP_ADDRESS</code> </pre> <br>  Senha padr√£o: <i>framboesa</i> .  Antes de tudo, √© necess√°rio expandir o sistema de arquivos do sistema operacional para todo o volume do cart√£o SD: <br><br><pre> <code class="bash hljs">sudo raspi-config --expand-rootfs</code> </pre> <br>  e reinicie: <br><br><pre> <code class="bash hljs">sudo reboot</code> </pre> <br>  Ap√≥s a reinicializa√ß√£o, conecte-se novamente e atualize a distribui√ß√£o: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get dist-upgrade -y</code> </pre> <br>  Instale pacotes adicionais: <br><br><pre> <code class="bash hljs">sudo apt-get install autoconf automake libtool pkg-config libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libraspberrypi-dev gstreamer1.0-tools gstreamer1.0-plugins-good gstreamer1.0-plugins-bad</code> </pre> <br>  e compile o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wrapper gst-rpicamsrc</a> para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gstreamer</a> e a c√¢mera nativa Raspicam: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/thaytan/gst-rpicamsrc.git rpicamsrc <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> rpicamsrc chmod +x autogen.sh ./autogen.sh --prefix=/usr --libdir=/usr/lib/arm-linux-gnueabihf/ make sudo make install</code> </pre> <br>  Verifique se a c√¢mera funciona (o arquivo de v√≠deo test.h264 √© criado): <br><br><pre> <code class="bash hljs">gst-launch-1.0 rpicamsrc bitrate=1000000 ! filesink location=test.h264</code> </pre> <br>  Se o gstreamer iniciar, aguarde alguns segundos para que o v√≠deo seja gravado.  Voc√™ pode interromper o processo pressionando <i>Ctrl + C.</i>  Se houver v√≠deo, a c√¢mera est√° funcionando. <br><br><h3>  Configurar e iniciar o Ardupilot </h3><br>  Os lan√ßamentos de novas vers√µes do Ardupilot est√£o um pouco atrasados ‚Äã‚Äãna montagem da Emlid.  Se a funcionalidade necess√°ria estiver dispon√≠vel na vers√£o mais recente, voc√™ poder√° instal√°-la a partir da fonte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">usando esta instru√ß√£o</a> . <br><br>  Os desenvolvedores do Navio adicionaram um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utilit√°rio de ferramenta Emlid</a> simples e conveniente aos seus sensores para verificar os sensores e configurar o Ardupilot.  Primeiro, verifique se o Raspberry v√™ o controlador Navio: <br><br><pre> <code class="bash hljs">emlidtool info</code> </pre> <br>  Se em resposta a este comando produz algo como: <br><br><pre> <code class="bash hljs">Vendor: Emlid Limited Product: Navio 2 Issue: Emlid 2018-06-05 831f3b08594f2da17dccae980a2e3659115ef71f Kernel: 4.14.34-emlid-v7+ RCIO firmware: 0xcaec2284</code> </pre> <br>  significa que ele v√™.  Verifique o status dos sensores (mostre a lista e o status): <br><br><pre> <code class="bash hljs">emlidtool <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre> <br>  e controladores de controlador PWM no kernel do Linux: <br><br><pre> <code class="bash hljs">cat /sys/kernel/rcio/status/alive</code> </pre> <br>  0 = n√£o est√° funcionando, 1 = est√° funcionando. <br><br>  O firmware do controlador PWM √© atualizado da seguinte maneira: <br><br><pre> <code class="bash hljs">sudo emlidtool rcio update</code> </pre> <br>  Agora configure o Ardupilot: <br><br><pre> <code class="bash hljs">sudo emlidtool ardupilot</code> </pre> <br>  Uma GUI de texto com menus passo a passo ser√° aberta no terminal.  Selecionamos o helic√≥ptero da vers√£o mais recente, digite <i>arducopter</i> , <i>inicie</i> automaticamente na inicializa√ß√£o ( <i>Na inicializa√ß√£o: habilite</i> ), inicie ap√≥s a configura√ß√£o ( <i>Ardupilot: start</i> ). <br><br><img src="https://habrastorage.org/webt/w8/p7/yn/w8p7ynlxvrqybsaqrdkqxbk68yy.png" alt="imagem"><br><br>  Sa√≠mos pelo item de menu <i>Sair</i> . <br><br>  Verifique se o Ardupilot foi iniciado: <br><br><pre> <code class="bash hljs">sudo systemctl status arducopter</code> </pre> <br>  Observe que o arquivo de inicializa√ß√£o no systemd √© chamado <u>arducopter</u> , pois a op√ß√£o <i>helic√≥ptero</i> foi configurada. <br><br>  Agora precisamos configurar o Ardupilot para que ele nos envie telemetria.  Para fazer isso, edite o arquivo de configura√ß√£o: <br><br><pre> <code class="bash hljs">sudo nano /etc/default/arducopter</code> </pre> <br>  Ele deve conter as seguintes linhas: <br><br><pre> <code class="bash hljs">TELEM1=<span class="hljs-string"><span class="hljs-string">"-A udp:127.0.0.1:14550"</span></span> ARDUPILOT_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TELEM1</span></span></span><span class="hljs-string">"</span></span></code> </pre> <br>  Salve o arquivo ( <i>Ctrl + X</i> e <i>Y</i> ) e reinicie o Ardupilot: <br><br><pre> <code class="bash hljs">sudo systemctl daemon-reload sudo systemctl restart arducopter</code> </pre> <br>  Voc√™ pode verificar o status do processo Ardupilot com o seguinte comando: <br><br><pre> <code class="bash hljs">sudo systemctl status arducopter</code> </pre> <br>  Com essas configura√ß√µes, o Ardupilot transmitir√° a telemetria (pacotes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MAVLink</a> ) para a porta UDP local 14550. Em seguida, o script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MAVProxy</a> (descri√ß√£o abaixo) far√° a telemetria de l√° e a enviar√° para o GCS ou o script, al√©m de enviar pacotes com comandos na dire√ß√£o oposta. <br><br>  Em vez do endere√ßo e da porta locais, voc√™ pode gravar o endere√ßo IP de um PC ou tablet na rede local e os pacotes ser√£o transmitidos imediatamente para l√°. <br><br><img src="https://habrastorage.org/webt/8p/no/vv/8pnovvpynimp8tvucgtqnbvqhls.png" alt="imagem"><br><br>  No entanto, essa abordagem √© justificada se os dados de telemetria n√£o forem usados ‚Äã‚Äãem nenhum outro lugar e o dispositivo com GCS tiver um endere√ßo IP est√°tico.  Caso contr√°rio, toda vez que voc√™ precisar registrar um novo Ardupilot nas configura√ß√µes.  Para se comunicar com o piloto autom√°tico por TCP, v√°rios GCSs com endere√ßos din√¢micos e alguns outros scripts no computador de bordo poderiam simultaneamente, √© mais conveniente usar o MAVProxy. <br><br><img src="https://habrastorage.org/webt/lt/gu/o6/ltguo6ghxcrnv8syshno6arbwi8.png" alt="imagem"><br><br>  Este script (escrito em Python) pode receber pacotes MAVLink para um endere√ßo UDP local e retransmiti-los para v√°rios endere√ßos IP locais ou remotos, via UDP e TCP.  Os pacotes s√£o enviados nas duas dire√ß√µes para o Ardupilot¬Æ GCS.  Al√©m disso, o MAVProxy √© um GCS completo, mas com uma interface de texto. <br><br><h3>  MAVProxy </h3><br>  O MAVProxy j√° est√° instalado na imagem do Navio.  Tamb√©m pode ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instalado</a> em um PC (Windows, Linux, MacOS) para comunica√ß√£o adicional com o piloto autom√°tico no modo de console. <br><br>  Depois de verificar se o Ardupilot est√° funcionando, execute o script MAVProxy no Raspberry com este comando: <br><br><pre> <code class="bash hljs">mavproxy.py --master=udp:127.0.0.1:14550</code> </pre> <br>  O <i>par√¢metro --master = udp: 127.0.0.1: 14550</i> define a fonte de dados para o script.  Esta √© a porta UDP local que foi registrada no arquivo de configura√ß√£o do Ardupilot.  Ap√≥s executar o comando, o MAVProxy se conectar√° a essa porta e exibir√° mensagens do piloto autom√°tico, semelhantes √†s minhas: <br><br><pre> <code class="bash hljs">pi@navio:~ $ mavproxy.py --master=udp:127.0.0.1:14550 Connect udp:127.0.0.1:14550 source_system=255 Failed to load module: No module named adsb. Use <span class="hljs-string"><span class="hljs-string">'set moddebug 3'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the MAVProxy console to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> traceback Log Directory: Telemetry <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>: mav.tlog Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> heartbeat from 127.0.0.1:14550 MAV&gt; online system 1 STABILIZE&gt; Mode STABILIZE fence breach GPS lock at 0 meters APM: APM:Copter V3.5.5 (88a1ecdd) APM: Frame: UNKNOWN APM: PreArm: RC Roll not configured APM: PreArm: Compass not calibrated APM: PreArm: 3D Accel calibration needed APM: PreArm: check firmware or FRAME_CLASS APM: PreArm: Throttle below Failsafe</code> </pre> <br>  Como o piloto autom√°tico ainda n√£o foi calibrado e n√£o est√° totalmente ajustado, as mensagens tamb√©m falam eloq√ºentemente sobre isso.  Nesse modo, voc√™ pode se comunicar com o piloto autom√°tico atrav√©s de comandos.  Se o drone estivesse totalmente ajustado, uma sequ√™ncia de dois comandos levaria ao arranque dos motores e o drone decolaria a uma altura de 20 m: <br><br><pre> <code class="bash hljs">arm throttle takeoff 20</code> </pre> <br>  Um piloto autom√°tico n√£o calibrado n√£o voa, mas exibe mensagens com motivos pelos quais n√£o pode fazer isso. <br><br><h3>  Estabelecendo comunica√ß√£o com o drone na rede local </h3><br>  Pare o script ( <i>Ctrl + C</i> ) e execute-o novamente desta forma: <br><br><pre> <code class="bash hljs">mavproxy.py --master=udp:127.0.0.1:14550 --out=tcpin:0.0.0.0:5762</code> </pre> <br>  Com o par√¢metro adicional <i>--out = tcpin: 0.0.0.0: 5762, o</i> MAVProxy escutar√° na porta 5762 as conex√µes TCP de entrada do GCS.  Assim que o GCS se conectar, os pacotes de dados come√ßar√£o a se mover entre o drone e o GCS.  Vamos tentar conectar a partir de um PC: <br><br><img src="https://habrastorage.org/webt/8e/zz/eb/8ezzebgztbjr6nkllbyefkdots0.png" alt="imagem"><br><br>  Se a conex√£o for bem-sucedida, o GCS mostrar√° v√°rias mensagens com uma solicita√ß√£o para calibrar os sensores e carregar os par√¢metros integrados com seus valores atuais: <br><br><img src="https://habrastorage.org/webt/mz/gy/co/mzgycobpds-e3bk7i5szgplvvey.png" alt="imagem"><br><br><img src="https://habrastorage.org/webt/i1/bx/ms/i1bxms-du1v9tbqpemtfv-sgodw.png" alt="imagem"><br><br><h3>  Calibra√ß√£o de sensores e ajuste dos par√¢metros do piloto autom√°tico </h3><br>  A calibra√ß√£o do piloto autom√°tico pode ser feita em praticamente qualquer GCS.  A documenta√ß√£o do Ardupilot descreve em detalhes.  Primeiro, definimos o tipo de quadro.  Eu tenho um layout padr√£o de 4 motores, ent√£o esse √© o <i>Quad X.</i> <br><br><img src="https://habrastorage.org/webt/mv/gc/bi/mvgcbi8augohhzhrcfrnosuia-s.png" alt="imagem"><br><br>  O primeiro v√¥o ainda √© melhor realizado no modo manual.  Conectamos e calibramos o controle de r√°dio (receptor e transmissor). <br><br><img src="https://habrastorage.org/webt/dj/ay/xw/djayxw3ulzuaabk4ubn3qavp0d4.png" alt="imagem"><br><br>  Resta calibrar o aceler√¥metro e a b√∫ssola. <br><br><img src="https://habrastorage.org/webt/bm/rs/1r/bmrs1rhiwgxu2udg11td3t8slak.png" alt="imagem"><br><br>  Para que o Ardupilot veja e leve em considera√ß√£o dados de sensores externos, defina os par√¢metros necess√°rios: <br><br>  Para <u>PX4Flow</u> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">calibra√ß√£o do pr√≥prio sensor e atualiza√ß√£o de firmware</a> ) <br><br> <code>FLOW_ENABLE = 1 (Enabled) <br> FLOW_ADDR = 0 (0 =     042)</code> <br> <br>  Para alt√≠metro a laser <u>VL53L0X</u> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√£o</a> ) <br><br> <code>RNGFND_TYPE = 16 (VL53L0X) <br> RNGFND_ORIENT = 25 (  ) <br> RNGFND_ADDR = 41 (I2C-   ).   - 0x29,     = 41. <br> RNGFND_SCALING = 1 <br> RNGFND_MIN_CM = 5 <br> RNGFND_MAX_CM = 120 <br> RNGFND_GNDCLEAR = 15 (    ,     )</code> <br> <br>  Para <u>IRLock</u> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√µes detalhadas</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wiki IR-Lock</a> ) <br><br> <code>PLND_ENABLED = 1 <br> PLND_TYPE = 2 <br> PLND_BUS = 1</code> <br> <br>  Para sonar de vista frontal ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√£o</a> ) <br><br> <code>RNGFND2_TYPE = 2 (MaxbotixI2C sonar) <br> RNGFND2_ORIENT = 0 (  ) <br> RNGFND2_MAX_CM = 700 (   )</code> <br> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lista</a> completa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">de op√ß√µes do</a> Ardupilot. <br><br>  Agora reinicie o Ardupilot no menu GCS, reconecte-se √† placa e abra a janela do MAVLink Inspector para ver os dados dos sensores. <br><br><img src="https://habrastorage.org/webt/6z/x_/8z/6zx_8zmfbc4nflyaxyz-h2yv8zs.png" alt="imagem"><br><br>  Infelizmente, as leituras do IR-Lock n√£o s√£o vis√≠veis aqui. Para a an√°lise de seu trabalho, voc√™ precisar√° examinar os registros a bordo.  Como fazer isso √© descrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Resta definir as configura√ß√µes de seguran√ßa e voc√™ pode iniciar o drone: <br><br><img src="https://habrastorage.org/webt/ex/jp/x-/exjpx-pjkbvzmugdr-r1ujqpziw.png" alt="imagem"><br><br>  Como configurar a suspens√£o girosc√≥pica e controlar a c√¢mera principal em detalhes Escreverei em um dos seguintes artigos, os principais pontos s√£o descritos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h3>  Transmiss√£o de v√≠deo </h3><br>  Vamos verificar como a transmiss√£o de v√≠deo funciona na rede WiFi.  Com este comando, voc√™ pode executar o v√≠deo em uma porta TCP no Raspberry usando o utilit√°rio raspivid nativo da c√¢mera Raspicam: <br><br><pre> <code class="bash hljs">raspivid -t 0 -hf -fps 25 -w 640 -h 480 -o - | gst-launch-1.0 fdsrc ! h264parse ! rtph264pay config-interval=1 pt=96 ! gdppay ! tcpserversink host=0.0.0.0 port=5001</code> </pre> <br>  Mas este comando faz a mesma coisa, apenas usando o wrapper rpi-camsrc compilado anteriormente para o gstreamer: <br><br><pre> <code class="bash hljs">gst-launch-1.0 rpicamsrc sensor-mode=4 ! h264parse ! rtph264pay config-interval=1 pt=96 ! gdppay ! tcpserversink host=0.0.0.0 port=5001</code> </pre> <br>  Nos dois casos, a transmiss√£o h264 est√° dispon√≠vel no endere√ßo IP do Raspberry na porta 5001. <br><br>  Voc√™ pode v√™-lo executando esse comando no seu PC (o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gstreamer</a> deve estar instalado); em vez de <i>RPI_ADDRESS,</i> especifique o endere√ßo Raspberry na rede: <br><br><pre> <code class="bash hljs">gst-launch-1.0 -v tcpclientsrc host=RPI_ADDRESS port=5001 ! gdpdepay ! rtph264depay ! avdec_h264 ! videoconvert ! autovideosink sync=<span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br>  Como resultado, a janela com o v√≠deo deve abrir. <br><br>  Quase todo GCS possui um reprodutor de v√≠deo embutido que pode exibir um fluxo de v√≠deo RTSP.  Para criar um servidor RTSP a partir de um Raspberry, voc√™ pode usar o console <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">VLC player</a> .  Instala√ß√£o: <br><br><pre> <code class="bash hljs">sudo apt-get install vlc</code> </pre> <br>  A transmiss√£o de v√≠deo come√ßa da seguinte maneira: <br><br><pre> <code class="bash hljs">raspivid -o - -t 0 -n -w 320 -h 240 -fps 25 | cvlc -vvv stream:///dev/stdin --sout <span class="hljs-string"><span class="hljs-string">'#rtp{sdp=rtsp://:8554/live}'</span></span> :demux=h264</code> </pre> <br>  O v√≠deo est√° dispon√≠vel em (em vez de <i>RPI_ADDRESS</i> , endere√ßo de framboesa): <br><br> <code>rtsp://RPI_ADDRESS:8554/live</code> <br> <br>  Configura√ß√£o do GCS: <br><br><img src="https://habrastorage.org/webt/uk/x8/hu/ukx8huklwh9kxu5glz289xkzenq.png" alt="imagem"><br><br><img src="https://habrastorage.org/webt/7r/og/gw/7roggwghpf_arhxggulllplkr6i.png" alt="imagem"><br><br>  O endere√ßo do stream pode ser usado para conectar v√°rios players em dispositivos diferentes, mas como a captura e transmiss√£o de v√≠deo para Raspberry √© um processo muito demorado, √© melhor para v√°rios consumidores de v√≠deo usar um servidor externo (descri√ß√£o abaixo). <br><br><h3>  Telemetria pela Internet </h3><br>  Para que o GCS se conecte via Internet a um drone com um endere√ßo IP din√¢mico, √© necess√°rio um servidor intermedi√°rio com um IP est√°tico no qual o script MAVProxy ser√° iniciado.  Para esses fins, aproveitei o aluguel de servidores em nuvem de um dos fornecedores conhecidos.  Para o MAVProxy, a configura√ß√£o mais m√≠nima √© adequada, mas como usarei o mesmo servidor para retransmitir v√≠deo, escolhi a op√ß√£o com um pouco mais de mem√≥ria (um n√∫cleo e 1 GB de mem√≥ria, Ubuntu 18.04).  Para o atraso m√≠nimo na passagem de dados entre a placa e o GCS, o servidor deve estar localizado na m√°xima proximidade geogr√°fica do drone e do GCS. <br><br><img src="https://habrastorage.org/webt/eu/yl/3i/euyl3i1m1s5zjyjl5suhj0gw4sg.png" alt="imagem"><br><br>  Instale o MAVProxy no servidor.  Primeiras depend√™ncias: <br><br><pre> <code class="bash hljs">sudo apt-get install python-dev python-opencv python-wxgtk3.0 python-pip python-matplotlib python-pygame python-lxml python-yaml</code> </pre> <br>  e ent√£o o pr√≥prio script atrav√©s do PIP: <br><br><pre> <code class="bash hljs">sudo pip install MAVProxy</code> </pre> <br>  escreva o caminho: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"export PATH=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PATH</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME</span></span></span><span class="hljs-string">/.local/bin"</span></span> &gt;&gt; ~/.bashrc</code> </pre> <br>  e execute o script com os seguintes par√¢metros: <br><br><pre> <code class="bash hljs">mavproxy.py --master=udp:0.0.0.0:15001 --out=tcpin:0.0.0.0:15002</code> </pre> <br>  O MAVProxy escuta na porta 15001 os pacotes de telemetria recebidos do drone via UDP e a porta 15002 a conex√£o TCP de entrada do GCS. <br><br>  Execute o MAVProxy no Raspberry com mais um par√¢metro, para que a telemetria tamb√©m seja transmitida para o servidor (em vez de <i>SERVER_IP, o</i> endere√ßo do seu servidor): <br><br><pre> <code class="bash hljs">mavproxy.py --master=udp:127.0.0.1:14550 --out=tcpin:0.0.0.0:5762 --out=udpout:SERVER_IP:15001</code> </pre> <br>  Ap√≥s iniciar o script no computador de bordo, as mensagens do piloto autom√°tico ser√£o exibidas no console do servidor.  Como mencionado acima, o MAVProxy √© um GCS completo com uma interface de texto e, neste estado, j√° √© poss√≠vel editar par√¢metros e controlar o drone atrav√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">comandos</a> no console do servidor. <br><br>  Conecte o GCS no PC ou tablet ao servidor.  As configura√ß√µes de conex√£o s√£o as mesmas da rede local; somente, em vez do endere√ßo IP do Raspberry, especificamos o endere√ßo do servidor e a porta 15002. <br><br><img src="https://habrastorage.org/webt/8m/ed/rc/8medrcfonj1lsyr1wvufdi2elom.png" alt="imagem"><br><br>  Agora voc√™ pode conectar um modem USB 4G ao Raspberry e avaliar o atraso com o qual o horizonte na tela reage. <br><br><h3>  V√≠deo na Internet </h3><br><img src="https://habrastorage.org/webt/7i/w2/ow/7iw2owafcz4bjjmwu116q9tr65i.png" alt="imagem"><br><br>  Para retransmitir o v√≠deo, instale o VLC player no servidor: <br><br><pre> <code class="bash hljs">sudo apt-get install vlc</code> </pre> <br>  Ap√≥s a instala√ß√£o, execute-o como um rel√© da porta UDP 5001 no canal RTSP <i><b>SERVER_IP: 8554 / live</b></i> : <br><br><pre> <code class="bash hljs">cvlc -vvv udp://@:5001 --sout <span class="hljs-string"><span class="hljs-string">'#rtp{sdp=rtsp://:8554/live}'</span></span> :demux=h264</code> </pre> <br>  A bordo, iniciaremos a transmiss√£o de v√≠deo da c√¢mera para o servidor via UDP (em vez do endere√ßo do servidor <i>SERVER_IP</i> ): <br><br><pre> <code class="bash hljs">gst-launch-1.0 rpicamsrc bitrate=1000000 ! video/x-h264,width=640,height=480,framerate=25/1 ! h264parse ! udpsink host=SERVER_IP port=5001</code> </pre> <br>  O endere√ßo de fluxo agora pode ser usado como fonte de v√≠deo nas configura√ß√µes do GCS ou aberto em qualquer player que suporte esse protocolo. <br><br>  Agora voc√™ pode planejar a rota do voo e iniciar o drone pela Internet, tendo sido ativado anteriormente, por exemplo, usando o assistente de telefone. <br><br>  Obviamente, devido ao tempo de viagem relativamente longo de v√≠deo e telemetria pela rede, esse m√©todo dificilmente √© adequado para v√¥os FPV no modo manual entre obst√°culos. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/43rqRE9f1hA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Assuntos para publica√ß√µes subsequentes: <br><br><ul><li>  Op√ß√µes para carregar automaticamente o drone na minha casa de p√°ssaros e em qual parei. </li><li>  Implementando o GCS baseado na Web usando o MAVProxy, NodeJS, socket.io e um servidor de m√≠dia para gerenciar v√°rios drones simultaneamente. </li><li>  Canais de comunica√ß√£o redundantes e sistemas de resgate por drones </li><li>  Vis√£o de m√°quina e lidares para evitar colis√µes com obst√°culos </li></ul><br>  Para continuar ... </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt414587/">https://habr.com/ru/post/pt414587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt414577/index.html">Devilution: projeto de engenharia reversa de Diablo</a></li>
<li><a href="../pt414579/index.html">A IA do Google aprendeu a prever quando um paciente morrer√° (mas nem tudo √© t√£o sombrio)</a></li>
<li><a href="../pt414581/index.html">Onde est√° o bot√£o dele ?! Como uma pessoa simples pode descarregar dados do Kibana e Elasticsearch e n√£o sobrecarregar os desenvolvedores</a></li>
<li><a href="../pt414583/index.html">RIT ++, Tech RaDarts e tudo-tudo-tudo</a></li>
<li><a href="../pt414585/index.html">Como meu String.getBytes (UTF_8) quebrou e o que eu fiz com ele</a></li>
<li><a href="../pt414595/index.html">Bloqueio de Roskomnadzor pelo Hino da Federa√ß√£o Russa</a></li>
<li><a href="../pt414597/index.html">Pergunte a Ethan: Qu√£o perto as civiliza√ß√µes alien√≠genas podem se unir?</a></li>
<li><a href="../pt414601/index.html">Quando as montanhas eram altas e os laptops eram grandes: um pouco mais da hist√≥ria da TI</a></li>
<li><a href="../pt414605/index.html">Mini imp√©rios</a></li>
<li><a href="../pt414609/index.html">O 2018 PWA (Progressive Web Apps) pode ser uma competi√ß√£o digna para aplicativos nativos?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>