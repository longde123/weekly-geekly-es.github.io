<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕘 🔁 🏇🏾 Wir stellen eine "intelligente" Steuerung für die Klimaanlage des ESP8266 her 🧕🏿 🙌🏻 😨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Sommer ist gekommen, mit ihm ist Hitze und auch Zeit, Klimaanlagen einzuschalten. Und wenn Sie moderne Technologien und Smart Home mögen, dann möc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir stellen eine "intelligente" Steuerung für die Klimaanlage des ESP8266 her</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419963/">  Der Sommer ist gekommen, mit ihm ist Hitze und auch Zeit, Klimaanlagen einzuschalten.  Und wenn Sie moderne Technologien und Smart Home mögen, dann möchten Sie die Klimatisierung irgendwie intelligent (oder zumindest auf moderne Weise) durchführen.  Im Folgenden finden Sie eine Reihe von Notizen zu meinem Versuch, das Wetter in ein Haus mit Sprachsteuerung und plattformübergreifender Benutzeroberfläche zu integrieren. <br><br><h2>  Herausforderung </h2><br>  Es gibt vier Klimaanlagen in der Wohnung, Sie müssen lernen, wie man sie handhabt: <br><br><ul><li>  Über die Weboberfläche (ich habe es Home Assistant, der sich auf einem separaten Raspberry Pi dreht, aber im Idealfall möchte ich eine einfache Verbindung zu jedem System); </li><li>  Voice (Google Assistant wird dies tun und dann an Alice denken); </li><li>  Skripte; </li><li>  Billig ... </li></ul><br><a name="habracut"></a><h2>  Marktforschung </h2><br><h3>  Native Lösung </h3><br>  Vielleicht werde ich es nicht einmal sagen.  Die Entscheidung des Herstellers meiner Klimaanlagen umfasste eine Reihe von Kabeln, mindestens zwei zusätzliche Module für jede Einheit und einen Preis von etwa 200 USD pro Raum.  Plus ein proprietäres Protokoll, eine alte Anwendung und all das.  Durchstreichen. <br><br><h3>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sensibo Himmel</a> </h3><br>  Ungefähr 100 US-Dollar pro Zimmer, funktioniert nativ mit Google Assistant und IFTTT, sieht wunderschön aus, ist aber immer noch etwas teuer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gw/yk/1c/gwyk1cvd9ukjhx9swiorxomydaw.jpeg"></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tado °</a> - ähnlich (und noch teurer). <br><br><h3>  Xiaomi Aqara / Mi Home, Broadlink RM Pro / Mini </h3><br>  Universelle IR-Sender, von denen einige theoretisch die erforderlichen Klimaanlagen „out of the box“ unterstützen, mit einer Sünde, die sie in zwei Hälften mit dem Home Assistant integrieren, aber im Allgemeinen - eine mittelmäßige Lösung, obwohl der Preis bereits viel näher an dem erschwinglichen liegt (20-35 USD pro Zimmer, abhängig von den Fähigkeiten) )  Ja, und Bewerbungen auf Chinesisch (in einigen Fällen) sind nicht das, was ich anstrebte. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/jy/ox/5ejyoxdz-way61igy_qqt1xk1n8.jpeg"></div><br><h3>  DIY </h3><br>  Der billigste und flexibelste Weg, über den ich noch mehr sprechen werde. <br><br><h2>  Komponentenauswahl </h2><br>  Es gibt etwas zu überlegen, aber im Allgemeinen werden wir brauchen: <br><br><h3>  Eisen </h3><br><h4>  Controller </h4><br>  Wir nehmen dumm ESP8266 und zur Vereinfachung der Firmware und der Stromversorgung werden wir D1 mini verwenden.  Wir werden das System natürlich über WiFi verwalten. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lj/ky/l1/ljkyl1s6uubm_thvjuhnj6zggoi.jpeg"></div><br><h4>  IR-Sender </h4><br>  Für den Prototyp werden wir eine einfache IR-LED, einen Widerstand und einen Transistor verwenden und dann darüber nachdenken, wie dies verbessert werden kann. <br><br><h4>  Temperatursensor </h4><br>  Es macht mehr Spaß damit, Sie können die Zieltemperatur einstellen und automatisch ein- und ausschalten.  Um loszulegen, nimm dumm DHT22. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cc/qb/tm/ccqbtm6-pkoe1xnxzetkaj8by98.jpeg"></div><br><h4>  Bildschirm </h4><br>  Wir werden den aktuellen Status des Systems (zum Debuggen) und möglicherweise die aktuelle IP-Adresse anzeigen (wird es nützlich sein?). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/br/ha/gd/brhagdvncv5xxv8dos3nk_c9saw.jpeg"></div><br><h3>  Software </h3><br><h4>  IDE </h4><br>  Wir werden alles in der Arduino IDE (mit der ich noch nie gearbeitet habe) mithilfe offener Bibliotheken implementieren. <br>  Viel später, als das Projekt bereits funktionierte, wechselte ich mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PlatformIO-</a> Plugin zu Visual Studio Code. <br><br><h4>  Protokoll </h4><br>  Wir werden mit Home Assistant über MQTT ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PubSubClient-</a> Bibliothek) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">kommunizieren</a> , weil  Es ist ein offenes Protokoll, für das es eine spezielle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Komponente gibt</a> . <br><br>  Die Konfiguration sieht beispielsweise folgendermaßen aus: <br><br><pre><code class="hljs pgsql">climate: - platform: mqtt <span class="hljs-type"><span class="hljs-type">name</span></span>: Living Room HVAC modes: - "off" - "auto" - "heat" - "cool" - "dry" - "fan" swing_modes: - "auto" - "off" fan_modes: - "auto" - "low" - "medium" - "high" mode_command_topic: "livingroom/meteo/mode/set" mode_state_topic: "livingroom/meteo/mode" temperature_command_topic: "livingroom/meteo/target/set" temperature_state_topic: "livingroom/meteo/target" fan_mode_command_topic: "livingroom/meteo/fan/set" fan_mode_state_topic: "livingroom/meteo/fan" swing_mode_command_topic: "livingroom/meteo/swing/set" swing_mode_state_topic: "livingroom/meteo/swing" current_temperature_topic: "livingroom/meteo/temperature"</code> </pre> <br><h4>  Management </h4><br>  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HeatpumpIR-</a> Bibliothek hilft uns, Signale an die Klimaanlage zu senden (das Klimaanlagenmodell ist immer noch fest codiert). <br><br><h4>  Verschiedenes </h4><br>  Sie benötigen mehr Bibliotheken für den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Timer</a> , für die Arbeit mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dem Temperatursensor</a> und mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bildschirm</a> , aber das sind Kleinigkeiten.  Wir werden WiFiManager und ArduinoOTA mit der üblichen Geste hinzufügen, um die Firmware über die Weboberfläche und nicht über USB zu aktualisieren. <br><br><h2>  Prototyp (00) </h2><br>  Wir kaufen zufällige Komponenten auf aliexpress, setzen sie auf einem Wahnbrett zusammen und testen die Idee. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n2/ve/_3/n2ve_3e4xbgeselooxb_z34j2zq.jpeg"></div><br>  Wir verstehen das: <br><br><ul><li>  Der Bildschirm wurde zu groß bestellt und hat zu viele Beine. </li><li>  Eine LED trifft nicht sehr weit und ist nicht sehr zuverlässig. </li></ul><br>  Aber insgesamt funktioniert die Idee!  Die „native“ HLK-Komponente wird in der Home Assistant-Oberfläche angezeigt. Dies bedeutet, dass die Steuerung von überall auf der Welt bereits in unserer Tasche ist.  Durch die native Integration von Home Assistant in Google Assistant werden Sprachbefehle und Feedback hinzugefügt: Sie können den Assistenten nach der Temperatur im Raum fragen und er antwortet sowohl auf das Ziel als auch auf die aktuelle Temperatur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sy/wv/zh/sywvzhrpxflr_8k7izcu-gkwfms.png"></div><br>  Das Ändern der Zieltemperatur, der Blasgeschwindigkeit und des Klimamodus in der Weboberfläche ist ebenfalls vorhanden (und funktioniert vor allem!). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/ly/4k/zvly4k9nokvr_n_x0gc0knfurfk.png"></div><br><h2>  Testprobe (01) </h2><br>  Lassen Sie uns ein paar Komponenten ändern: Bestellen Sie einen kleineren Bildschirm und arbeiten Sie mit I2C (und wir verwenden eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">andere</a> Bibliothek). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9c/ld/zp/9cldzpkypgzfejdxaqujwm17qkq.jpeg"></div><br>  Wir ersetzen auch die IR-LED durch ein fertiges Modul. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pu/ob/ml/puobml0kneoraufy6fft9x9vt1g.jpeg"></div><br>  Es stellte sich heraus, dass es sich nicht lohnt, Module mit einer LED (auf dem Foto links) bei aliexpress zu bestellen: Sie enthalten keinen Transistor, und eines der Beine (VCC), die sie haben, ist im Wesentlichen eine Täuschung. <br><br>  Wenn Sie jedoch ein Modul mit zwei LEDs bestellen (auf dem Foto rechts), sind bereits alle erforderlichen Komponenten vorhanden, und ein solches Modul kann einfach und natürlich angeschlossen werden und endet etwas weiter. <br><br>  Es war auch Zeit, alles auf meiner Leiterplatte zusammenzufügen ... Es war einer der schwierigsten Momente für eine Person, die niemals Leiterplatten entworfen hat, und sicher habe ich alles falsch gemacht. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z3/ea/sc/z3eascuagsayu7zqhb7_shrp0ia.png"></div><br>  Für das Design habe ich EasyEDA verwendet, ich habe fertige Produkte für OSHPark bestellt (auch hier könnte man sicher eine billigere Option finden), und als Ergebnis habe ich so etwas bekommen: <br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/webt/bs/cf/jr/bscfjrgse7belqqio_hc-3zmdwi.jpeg"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/webt/l8/-q/dd/l8-qddx1ifl49weei8ic6wbrntm.jpeg"></div></td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rb/3l/iv/rb3liv9-vm-pnsaueafbpendiui.jpeg"></div><br>  Der Knopf wurde im letzten Moment hinzugefügt und ein Platz dafür wurde völlig zufällig gefunden.  Es stellte sich heraus, dass mit der Taste alles ein bisschen mehr Spaß macht. Sie können den Bildschirm nicht immer eingeschaltet lassen (was für OLED schlecht ist), sondern den Status durch Drücken anzeigen. <br><br>  Nun, es ist schon gut, es bleibt noch der Fall hinzuzufügen.  Führen Sie dazu Blender aus, führen Sie eine Reihe von Parallelepipeds aus und wenden Sie eine Reihe von Booleschen Operationen an ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fl/ig/h_/fligh_cx6xgegg5lrsoydl2azji.png"></div><br>  Und an den 3D-Drucker senden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/au/b8/ck/aub8ck2fywfbds1ytgiwbc5ia6s.jpeg"></div><br>  Insgesamt stellte sich heraus, dass es billig (weniger als 10 US-Dollar pro Exemplar), flexibel (es funktioniert mit fast jeder Klimaanlage), einfach zu integrieren, per Sprache zu steuern und über das Internet aus einer Entfernung von fünf Metern zu erreichen ist.  Im Allgemeinen über das, was ich wollte. <br><br>  Wie würde das alles ein bisschen besser gemacht werden? <br><br><h2>  Serienmodell (02) </h2><br>  Es gibt eine Reihe von Richtungen zur Verbesserung des resultierenden Produkts (genauer gesagt Verbesserungsmöglichkeiten, die es ermöglichen würden, ein Experiment in ein Produkt umzuwandeln): <br><br><ol><li>  Der Temperatursensor kann kleiner und genauer genommen werden, z. B. BME280, HTU21D oder Si7021, wodurch Sie ihn an denselben Beinen wie den Bildschirm (I2C) aufhängen, die Größe des fertigen Geräts erheblich reduzieren und das Leiterplattenlayout vereinfachen können.  In der Praxis stellte sich heraus, dass derselbe BME280 durch die Erwärmung des ESP8266 selbst stark beeinflusst wird und die ausgegebenen Messwerte angepasst werden müssen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sr/ws/wo/srwswovbxfecsxk0nre5sjqjm3m.jpeg"></div></li><li>  (Es folgt aus dem ersten Absatz) Es ist nicht üblich, den ESP8266 ständig laufen zu lassen. Sie müssen regelmäßig in den Tiefschlaf gehen und nur gelegentlich aufwachen, um Zeugnisse zu senden und Befehle zu empfangen. </li><li>  (folgt aus dem zweiten Punkt) Normales MQTT ist nicht mehr sehr gut geeignet. Sie müssen MQTT-SN verwenden, damit die Steuerbefehle beim Aufwachen gespeichert und an die Steuerung übermittelt werden. </li><li>  Durch die Implementierung der oben genannten Elemente können Sie die "verkabelte" Stromversorgung der Batterie ändern. </li><li>  Die derzeitige Methode zur Befestigung von Bauteilen auf einer Leiterplatte (herkömmliches Löten) ist schwierig zu implementieren und nicht flexibel genug: Es ist sinnvoll, die Header so zu löten, dass dieselben Temperatursensoren wie Handschuhe ausgetauscht werden können. </li><li>  Schließlich (im Gegensatz zum vorherigen Absatz) sind die fertigen Module trotzdem gut und einfach, aber etwas umständlich. Idealerweise würde anstelle des D1 mini ein bloßer ESP8266 verwendet, und der Temperatursensor, die Taste und die IR-LEDs würden auf eine Platine gelötet ( wie bei seriellen Produkten), was die Größe des Geräts und seinen seriellen Preis verringern würde; </li><li>  Auf jeden Fall wäre es schön, in die Firmware die Möglichkeit aufzunehmen, Ihr Klimamodell mit einem Klick einfach auszuwählen ... </li></ol><br><h2>  Fazit </h2><br>  Es war ein herrliches Abenteuer und ich habe viel verstanden.  Ich habe zum Beispiel verstanden, warum serielle Geräte so teuer sind und wie viel Aufwand erforderlich wäre, um mit ihnen auf das gleiche Niveau zu kommen.  Andererseits habe ich zum ersten Mal in diesem Projekt viel getan (in der Arduino IDE gearbeitet, Leiterplatten bestellt, ein Modell für einen 3D-Drucker erstellt), und diese Erfahrung war von unschätzbarem Wert.  Der Quellcode wird jedoch nicht angezeigt: Ich schäme mich für sie :) <br><br>  Aber ich habe mein Ziel immer noch erreicht, und die billige und flexible Steuerung von Klimaanlagen erwies sich als durchaus erreichbar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de419963/">https://habr.com/ru/post/de419963/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de419949/index.html">Welche Video-Codecs (nicht) verwenden Browser für Videoanrufe?</a></li>
<li><a href="../de419951/index.html">Erfahrung mit WebRTC. Yandex Vortrag</a></li>
<li><a href="../de419953/index.html">Ich schreibe ein Buch über das erste „unser“ Startup, das die Welt erobert hat: Hilfe</a></li>
<li><a href="../de419955/index.html">Funktionen des FIFO-UART-Puffers in ESP32</a></li>
<li><a href="../de419961/index.html">Die Zusammenfassung interessanter Materialien für den mobilen Entwickler # 265 (6. August - 12. August)</a></li>
<li><a href="../de419965/index.html">Konfigurationsfunktionen für ExtremeXOS-Switches</a></li>
<li><a href="../de419969/index.html">Verschleierung in Ruby. Verstecke auch Klassen vor der obersten Ebene</a></li>
<li><a href="../de419971/index.html">Das Raketenlabor repariert, erweitert und beschleunigt</a></li>
<li><a href="../de419973/index.html">Digitale Veranstaltungen in Moskau vom 13. bis 19. August</a></li>
<li><a href="../de419975/index.html">Wie wir von Windows Corporate weggelaufen sind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>