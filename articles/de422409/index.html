<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüé§ üê∑ üê° Python: Metaprogrammierung in der Produktion. Teil eins üë¥ üéà ü§∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Viele Leute denken, dass Metaprogrammierung in Python den Code unn√∂tig kompliziert, aber wenn Sie ihn richtig verwenden, k√∂nnen Sie komplexe Entwurfsm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python: Metaprogrammierung in der Produktion. Teil eins</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/binarydistrict/blog/422409/"><p>  Viele Leute denken, dass <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Metaprogrammierung</a> in Python den Code unn√∂tig kompliziert, aber wenn Sie ihn richtig verwenden, k√∂nnen Sie komplexe Entwurfsmuster schnell und elegant implementieren.  Dar√ºber hinaus verwenden bekannte Python-Frameworks wie Django, DRF und SQLAlchemy Metaklassen, um eine einfache Erweiterbarkeit und eine einfache Wiederverwendung von Code zu erm√∂glichen. </p><br><p><img src="https://habrastorage.org/webt/ls/ty/gh/lstyghddpotgif7f6jg8cl6kcbi.jpeg"></p><br><p>  In diesem Artikel werde ich Ihnen erkl√§ren, warum Sie keine Angst haben sollten, Metaprogrammierung in Ihren Projekten zu verwenden, und zeigen, f√ºr welche Aufgaben es am besten ist.  Weitere Informationen zu Metaprogrammierungsoptionen finden Sie im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Advanced Python-</a> Kurs. </p><a name="habracut"></a><br><p>  Erinnern wir uns zun√§chst an die Grundlagen der Metaprogrammierung in Python.  Es ist nicht √ºberfl√ºssig hinzuzuf√ºgen, dass alles, was unten geschrieben wird, f√ºr Python Version 3.5 und h√∂her gilt. </p><br><h2 id="kratkiy-ekskurs-v-model-dannyh-python">  Eine kurze Tour durch das Python-Datenmodell </h2><br><p>  Wir alle wissen also, dass alles in Python ein Objekt ist, und es ist kein Geheimnis, dass es f√ºr jedes Objekt eine bestimmte Klasse gibt, von der es generiert wurde, zum Beispiel: </p><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; type(f) &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  Der Typ des Objekts oder der Klasse, mit der das Objekt generiert wurde, kann mithilfe der integrierten Typfunktion bestimmt werden, die eine ziemlich interessante Aufrufsignatur aufweist (wir werden etwas sp√§ter darauf eingehen).  Der gleiche Effekt kann erzielt werden, indem das Attribut <code>__class__</code> f√ºr ein beliebiges Objekt abgeleitet wird. </p><br><p>  Um Funktionen zu erstellen, wird eine bestimmte integrierte Klassenfunktion <code>function</code> .  Mal sehen, was wir damit machen k√∂nnen.  Nehmen Sie dazu das Leerzeichen aus dem Modul f√ºr integrierte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Typen</a> : </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> types <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FunctionType &gt;&gt;&gt; FunctionType &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">help</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FunctionType)</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(code, globals[, name[, argdefs[, closure]]])</span></span></span><span class="hljs-class"> | | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">code</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dictionary</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">overrides</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">code</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">argdefs</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tuple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specifies</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">argument</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">values</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">closure</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tuple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">supplies</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bindings</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">free</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variables</span></span></span><span class="hljs-class">.</span></span></code> </pre> <br><p>  Wie wir sehen k√∂nnen, ist jede Funktion in Python eine Instanz der oben beschriebenen Klasse.  Versuchen wir nun, eine neue Funktion zu erstellen, ohne auf ihre Deklaration durch <code>def</code> .  Dazu m√ºssen wir lernen, wie Codeobjekte mit der im Interpreter integrierten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kompilierungsfunktion erstellt</a> werden: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,    "Hello, world!" &gt;&gt;&gt; code = compile('print("Hello, world!")', '&lt;repl&gt;', 'eval') &gt;&gt;&gt; code &lt;code object &lt;module&gt; at 0xdeadbeef, file "&lt;repl&gt;", line 1&gt; #  ,     , #      &gt;&gt;&gt; func = FunctionType(code, globals(), 'greetings') &gt;&gt;&gt; func &lt;function &lt;module&gt; at 0xcafefeed&gt; &gt;&gt;&gt; func.__name__ 'greetings' &gt;&gt;&gt; func() Hello, world!</span></span></code> </pre> <br><p>  Gro√üartig!  Mit Hilfe von Meta-Tools haben wir gelernt, wie man Funktionen im laufenden Betrieb erstellt, aber in der Praxis wird dieses Wissen selten verwendet.  Schauen wir uns nun an, wie Klassenobjekte und Instanzobjekte dieser Klassen erstellt werden: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; user = User() &gt;&gt;&gt; type(user) &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(User)</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  Es ist offensichtlich, dass die <code>User</code> zum Erstellen einer <code>user</code> wird. Es ist viel interessanter, sich die <code>type</code> anzusehen, mit der die <code>User</code> selbst erstellt wird.  Hier wenden wir uns der zweiten Option zum Aufrufen der integrierten Typfunktion zu, die in Kombination eine Metaklasse f√ºr jede Klasse in Python darstellt.  Eine Metaklasse ist per Definition eine Klasse, deren Instanz eine andere Klasse ist.  Mit Metaklassen k√∂nnen wir den Prozess zum Erstellen einer Klasse anpassen und den Prozess zum Erstellen einer Instanz einer Klasse teilweise steuern. </p><br><p>  Gem√§√ü der Dokumentation gibt der zweite Signaturtyp <code>type(name, bases, attrs)</code> - einen neuen Datentyp oder, wenn auf einfache Weise - eine neue Klasse zur√ºck, und das <code>__name__</code> wird zum <code>__name__</code> -Attribut der zur√ºckgegebenen Klasse, <code>bases</code> - die Liste der √ºbergeordneten Klassen wird als <code>__bases__</code> verf√ºgbar <code>__bases__</code> . Nun, <code>attrs</code> - ein <code>attrs</code> Objekt, das alle Attribute und Methoden der Klasse enth√§lt, wird in <code>__dict__</code> .  Das Prinzip der Funktion kann in Python als einfacher Pseudocode beschrieben werden: </p><br><pre> <code class="python hljs">type(name, bases, attrs) ~ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(bases)</span></span></span><span class="hljs-class">:</span></span> attrs</code> </pre> <br><p>  Mal sehen, wie Sie mit nur dem Typaufruf eine v√∂llig neue Klasse erstellen k√∂nnen: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>User = type(<span class="hljs-string"><span class="hljs-string">'User'</span></span>, (), {}) &gt;&gt;&gt; User &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  Wie Sie sehen, m√ºssen wir das Schl√ºsselwort <code>class</code> nicht verwenden, um eine neue Klasse zu erstellen. Die Typfunktion verzichtet darauf. Schauen wir uns nun ein komplizierteres Beispiel an: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SuperUser</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(User)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Encapsulate domain logic to work with super users"""</span></span> group_name = <span class="hljs-string"><span class="hljs-string">'admin'</span></span> @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">f'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.group_name}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.name}</span></span></span><span class="hljs-string">'</span></span>.lower() <span class="hljs-comment"><span class="hljs-comment">#     SuperUser "" CustomSuperUser = type( #   'SuperUser', #  ,      (User, ), #         { '__doc__': 'Encapsulate domain logic to work with super users', 'group_name': 'admin', 'login': property(lambda self: f'{self.group_name}/{self.name}'.lower()), } ) assert SuperUser.__doc__ == CustomSuperUser.__doc__ assert SuperUser('Vladimir').login == CustomSuperUser('Vladimir').login</span></span></code> </pre> <br><p>  Wie Sie den obigen Beispielen entnehmen k√∂nnen, ist die Beschreibung von Klassen und Funktionen mit den Schl√ºsselw√∂rtern <code>class</code> und <code>def</code> nur syntaktischer Zucker, und alle Arten von Objekten k√∂nnen durch gew√∂hnliche Aufrufe integrierter Funktionen erstellt werden.  Lassen Sie uns abschlie√üend dar√ºber sprechen, wie Sie die dynamische Erstellung von Klassen in realen Projekten verwenden k√∂nnen. </p><br><h2 id="dinamicheskoe-sozdanie-form-i-validatorov">  Erstellen Sie dynamisch Formulare und Validatoren </h2><br><p>  Manchmal m√ºssen wir Informationen vom Benutzer oder von anderen externen Quellen nach einem zuvor bekannten Datenschema validieren.  Zum Beispiel m√∂chten wir das Benutzeranmeldeformular im Admin-Bereich √§ndern - Felder l√∂schen und hinzuf√ºgen, die Strategie ihrer Validierung √§ndern usw. </p><br><p>  Versuchen wir zur Veranschaulichung, dynamisch ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Django-</a> Formular zu erstellen, dessen Beschreibung im folgenden <code>json</code> Format gespeichert ist: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"fist_name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_length"</span></span>: <span class="hljs-number"><span class="hljs-number">25</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"last_name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_length"</span></span>: <span class="hljs-number"><span class="hljs-number">30</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"age"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"int"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"min_value"</span></span>: <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_value"</span></span>: <span class="hljs-number"><span class="hljs-number">99</span></span> } }</code> </pre> <br><p>  Erstellen Sie nun basierend auf der obigen Beschreibung eine Reihe von Feldern und ein neues Formular mit der bereits bekannten Typfunktion: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> forms fields_type_map = { <span class="hljs-string"><span class="hljs-string">'str'</span></span>: forms.CharField, <span class="hljs-string"><span class="hljs-string">'int'</span></span>: forms.IntegerField, } <span class="hljs-comment"><span class="hljs-comment"># form_description ‚Äì  json    deserialized_form_description: dict = json.loads(form_description) form_attrs = {} #            for field_name, field_description in deserialized_form_description.items(): field_class = fields_type_map[field_description.pop('type')] form_attrs[field_name] = field_class(**field_description) user_form_class = type('DynamicForm', (forms.Form, ), form_attrs) &gt;&gt;&gt; form = user_form_class({'age': 101}) &gt;&gt;&gt; form &lt;DynamicForm bound=True, valid=Unknown, fields=(fist_name;last_name;age)&gt; &gt;&gt;&gt; form.is_valid() False &gt;&gt;&gt; form.errors {'fist_name': ['This field is required.'], 'last_name': ['This field is required.'], 'age': ['Ensure this value is less than or equal to 99.']}</span></span></code> </pre> <br><p>  Gro√üartig!  Jetzt k√∂nnen Sie das erstellte Formular in die Vorlage √ºbertragen und f√ºr den Benutzer rendern.  Der gleiche Ansatz kann mit anderen Frameworks f√ºr die Datenvalidierung und -pr√§sentation ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DRF-Serializer</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Marshmallow</a> und andere) verwendet werden. </p><br><h2 id="konfiguriruem-sozdanie-novogo-klassa-cherez-metaklass">  Konfigurieren der Erstellung einer neuen Klasse √ºber die Metaklasse </h2><br><p>  Oben haben wir uns die bereits abgeschlossene Metaklasse angesehen, aber meistens erstellen Sie im Code Ihre eigenen Metaklassen und verwenden sie, um die Erstellung neuer Klassen und ihrer Instanzen zu konfigurieren.  Im allgemeinen Fall sieht das "Leerzeichen" einer Metaklasse folgenderma√üen aus: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaClass</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   : mcs ‚Äì  ,  &lt;__main__.MetaClass&gt; name ‚Äì ,  ,     ,  "User" bases ‚Äì   -,  (SomeMixin, AbstractUser) attrs ‚Äì dict-like ,         cls ‚Äì  ,  &lt;__main__.User&gt; extra_kwargs ‚Äì  keyword-     args  kwargs ‚Äì          """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(mcs, name, bases, attrs) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, name, bases, attrs, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(cls) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__prepare__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, cls, bases, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__prepare__(mcs, cls, bases, **kwargs) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__call__(*args, **kwargs)</code> </pre> <br><p>  Um diese Metaklasse zum Konfigurieren der <code>User</code> , wird die folgende Syntax verwendet: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=MetaClass)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(cls) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name</code> </pre> <br><p>  Das Interessanteste ist die Reihenfolge, in der der Python-Interpreter die Metaklassen-Metamethode zum Zeitpunkt der Erstellung der Klasse selbst aufruft: </p><br><ol><li>  Der Interpreter ermittelt und findet die √ºbergeordneten Klassen f√ºr die aktuelle Klasse (falls vorhanden). </li><li>  Der Interpreter definiert eine Metaklasse (in unserem Fall <code>MetaClass</code> ). </li><li>  Die Methode <code>MetaClass.__prepare__</code> wird <code>MetaClass.__prepare__</code> Sie sollte ein diktartiges Objekt zur√ºckgeben, in das die Attribute und Methoden der Klasse geschrieben werden.  Danach wird das Objekt √ºber das Argument <code>MetaClass.__new__</code> <code>attrs</code> .  Wir werden etwas sp√§ter in den Beispielen √ºber die praktische Anwendung dieser Methode sprechen. </li><li>  Der Interpreter liest den Hauptteil der <code>User</code> Klasse und generiert Parameter, um sie an die <code>MetaClass</code> Metaklasse zu √ºbergeben. </li><li>  Die <code>MetaClass.__new__</code> Methode <code>MetaClass.__new__</code> - die <code>MetaClass.__new__</code> Methode gibt das erstellte Klassenobjekt zur√ºck.  Wir haben die Argumente <code>name</code> , <code>attrs</code> und <code>attrs</code> bereits getroffen, als wir sie an die <code>type</code> Funktion √ºbergeben haben, und wir werden etwas sp√§ter √ºber den Parameter <code>**extra_kwargs</code> sprechen.  Wenn der Typ des <code>attrs</code> Arguments mit <code>__prepare__</code> ge√§ndert wurde, muss es in ein <code>__prepare__</code> konvertiert werden, bevor es an den Methodenaufruf <code>super()</code> wird. </li><li>  Die <code>MetaClass.__init__</code> Methode <code>MetaClass.__init__</code> - die Initialisierungsmethode, mit der Sie dem Klassenobjekt in der Klasse zus√§tzliche Attribute und Methoden hinzuf√ºgen k√∂nnen.  In der Praxis wird es in F√§llen verwendet, in denen Metaklassen von anderen Metaklassen geerbt werden, andernfalls ist alles, was in <code>__init__</code> getan werden kann, besser in <code>__new__</code> .  Beispielsweise kann der Parameter <code>__slots__</code> <strong>nur</strong> in der Methode <code>__new__</code> werden, indem er in das <code>attrs</code> Objekt geschrieben wird. </li><li>  In diesem Schritt wird die Klasse als erstellt betrachtet. </li></ol><br><p>  Erstellen Sie nun eine Instanz unserer <code>User</code> und sehen Sie sich die Aufrufkette an: </p><br><pre> <code class="python hljs">user = User(name=<span class="hljs-string"><span class="hljs-string">'Alyosha'</span></span>)</code> </pre> <br><ol><li>  Zum Zeitpunkt des Aufrufs von <code>User(...)</code> ruft <code>User(...)</code> Interpreter die <code>MetaClass.__call__(name='Alyosha')</code> -Methode auf, bei der das Klassenobjekt und die √ºbergebenen Argumente √ºbergeben werden. </li><li>  <code>MetaClass.__call__</code> ruft <code>User.__new__(name='Alyosha')</code> - eine Konstruktormethode, die eine Instanz der <code>User</code> Klasse erstellt und zur√ºckgibt </li><li>  Als <code>MetaClass.__call__</code> ruft <code>MetaClass.__call__</code> <code>User.__init__(name='Alyosha')</code> - eine Initialisierungsmethode, die der erstellten Instanz neue Attribute hinzuf√ºgt. </li><li>  <code>MetaClass.__call__</code> gibt die erstellte und initialisierte Instanz der <code>User</code> Klasse zur√ºck. </li><li>  Zu diesem Zeitpunkt wird eine Instanz der Klasse als erstellt betrachtet. </li></ol><br><p>  Diese Beschreibung deckt nat√ºrlich nicht alle Nuancen der Verwendung von Metaklassen ab, aber es reicht aus, mit der Metaprogrammierung zu beginnen, um einige Architekturmuster zu implementieren.  Vorw√§rts zu den Beispielen! </p><br><h2 id="abstraktnye-klassy">  Abstrakte Klassen </h2><br><p>  Das allererste Beispiel finden Sie in der Standardbibliothek: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ABCMeta</a> - Mit einer Metaklasse k√∂nnen Sie jede unserer Klassen als abstrakt deklarieren und alle Nachkommen dazu zwingen, vordefinierte Methoden, Eigenschaften und Attribute zu implementieren. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasePlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   supported_formats   run        """</span></span> @property @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">supported_formats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; list:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, input_data: dict)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p>  Wenn nicht alle abstrakten Methoden und Attribute im Erben implementiert sind, erhalten wir beim Versuch, eine Instanz der <code>TypeError</code> zu erstellen, einen <code>TypeError</code> : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Processing video...'</span></span>) plugin = VideoPlugin() <span class="hljs-comment"><span class="hljs-comment"># TypeError: Can't instantiate abstract class VideoPlugin # with abstract methods supported_formats</span></span></code> </pre> <br><p>  Die Verwendung abstrakter Klassen hilft dabei, die Basisklassenschnittstelle sofort zu reparieren und zuk√ºnftige Vererbungsfehler zu vermeiden, z. B. Tippfehler im Namen einer √ºberschriebenen Methode. </p><br><h2 id="sistema-plaginov-s-avtomaticheskoy-registraciey">  Automatisches Registrierungs-Plugin-System </h2><br><p>  Sehr oft wird die Metaprogrammierung verwendet, um verschiedene Entwurfsmuster zu implementieren.  Fast jedes bekannte Framework verwendet Metaklassen, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Registrierungsobjekte</a> zu erstellen.  Solche Objekte speichern Links zu anderen Objekten und erm√∂glichen den schnellen Empfang an einer beliebigen Stelle im Programm.  Betrachten Sie ein einfaches Beispiel f√ºr die automatische Registrierung von Plugins zum Abspielen von Mediendateien in verschiedenen Formaten. </p><br><p>  Metaklassenimplementierung: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegistryMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" ,      .     " " -&gt; " " """</span></span> _registry_formats = {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> cls: <span class="hljs-string"><span class="hljs-string">'BasePlugin'</span></span> = super().__new__(mcs, name, bases, attrs) <span class="hljs-comment"><span class="hljs-comment">#     (BasePlugin) if inspect.isabstract(cls): return cls for media_format in cls.supported_formats: if media_format in mcs._registry_formats: raise ValueError(f'Format {media_format} is already registered') #       mcs._registry_formats[media_format] = cls return cls @classmethod def get_plugin(mcs, media_format: str): try: return mcs._registry_formats[media_format] except KeyError: raise RuntimeError(f'Plugin is not defined for {media_format}') @classmethod def show_registry(mcs): from pprint import pprint pprint(mcs._registry_formats)</span></span></code> </pre> <br><p>  Und hier sind die Plugins selbst. Wir √ºbernehmen die <code>BasePlugin</code> Implementierung aus dem vorherigen Beispiel: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasePlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=RegistryMeta)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> supported_formats = [<span class="hljs-string"><span class="hljs-string">'mpg'</span></span>, <span class="hljs-string"><span class="hljs-string">'mov'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> supported_formats = [<span class="hljs-string"><span class="hljs-string">'mp3'</span></span>, <span class="hljs-string"><span class="hljs-string">'flac'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ...</code> </pre> <br><p>  Nach dem Ausf√ºhren dieses Codes registriert der Interpreter 4 Formate und 2 Plugins in unserer Registrierung, die diese Formate verarbeiten k√∂nnen: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>RegistryMeta.show_registry() {<span class="hljs-string"><span class="hljs-string">'flac'</span></span>: &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mov</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mp3</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mpg</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt;} &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegistryMeta</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_plugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-class"><span class="hljs-params"><span class="hljs-string">'mov'</span></span></span></span><span class="hljs-class"><span class="hljs-params">)</span></span></span><span class="hljs-class"> &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">video</span></span></span><span class="hljs-class">...</span></span></code> </pre> <br><p>  Es ist erw√§hnenswert, dass eine weitere interessante Nuance der Arbeit mit Metaklassen vorhanden ist. Dank der nicht offensichtlichen Reihenfolge der Methodenaufl√∂sung k√∂nnen wir die <code>show_registry</code> Methode nicht nur f√ºr die <code>RegistyMeta</code> Klasse <code>RegistyMeta</code> , sondern f√ºr jede andere Klasse, von der es sich um eine Metaklasse handelt: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>AudioPlugin.get_plugin(<span class="hljs-string"><span class="hljs-string">'avi'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># RuntimeError: Plugin is not found for avi</span></span></code> </pre> <br><h2 id="ispolzovanie-imen-atributov-v-kachestve-metadannyh">  Verwenden von Attributnamen als Metadaten </h2><br><p>  Mithilfe von Metaklassen k√∂nnen Sie Klassenattributnamen als Metadaten f√ºr andere Objekte verwenden.  Nichts ist klar?  Aber ich bin sicher, dass Sie diesen Ansatz schon oft gesehen haben, zum Beispiel die deklarative Deklaration von Modellfeldern in Django: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Book</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> title = models.Charfield(max_length=<span class="hljs-number"><span class="hljs-number">250</span></span>)</code> </pre> <br><p>  Im obigen Beispiel ist <code>title</code> der Name des Python-Bezeichners. Er wird auch verwendet, um die Spalte in der <code>book</code> zu benennen, obwohl wir dies nirgendwo explizit angegeben haben.  Ja, solche ‚ÄûMagie‚Äú kann mit Hilfe der Metaprogrammierung realisiert werden.  Implementieren wir beispielsweise ein System zum √úbertragen von Anwendungsfehlern an das Front-End, sodass jede Nachricht einen lesbaren Code enth√§lt, mit dem die Nachricht in eine andere Sprache √ºbersetzt werden kann.  Wir haben also ein Nachrichtenobjekt, das in <code>json</code> konvertiert werden kann: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, code=None)</span></span></span><span class="hljs-function">:</span></span> self.text = text self.code = code <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_json</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps({<span class="hljs-string"><span class="hljs-string">'text'</span></span>: self.text, <span class="hljs-string"><span class="hljs-string">'code'</span></span>: self.code})</code> </pre> <br><p>  Alle unsere Fehlermeldungen werden in einem separaten "Namespace" gespeichert: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Messages</span></span></span><span class="hljs-class">:</span></span> not_found = Message(<span class="hljs-string"><span class="hljs-string">'Resource not found'</span></span>) bad_request = Message(<span class="hljs-string"><span class="hljs-string">'Request body is invalid'</span></span>) ... &gt;&gt;&gt; Messages.not_found.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Resource not found"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: null}</code> </pre> <br><p>  Jetzt m√∂chten wir, dass der <code>code</code> nicht <code>null</code> , sondern nicht <code>not_found</code> wird. Dazu schreiben wir die folgende Metaklasse: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaMessage</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs.items(): <span class="hljs-comment"><span class="hljs-comment">#          Message #    code    # ( code   ) if isinstance(value, Message) and value.code is None: value.code = attr return super().__new__(mcs, name, bases, attrs) class Messages(metaclass=MetaMessage): ...</span></span></code> </pre> <br><p>  Mal sehen, wie unsere Beitr√§ge jetzt aussehen: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>Messages.not_found.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Resource not found"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: <span class="hljs-string"><span class="hljs-string">"not_found"</span></span>} &gt;&gt;&gt; Messages.bad_request.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Request body is invalid"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: <span class="hljs-string"><span class="hljs-string">"bad_request"</span></span>}</code> </pre> <br><p>  Was du brauchst!  Jetzt wissen Sie, was zu tun ist, damit Sie anhand des Datenformats leicht den Code finden k√∂nnen, der sie verarbeitet. </p><br><h2 id="keshirovanie-metadannyh-o-klasse-i-ego-naslednikah">  Zwischenspeichern von Metadaten √ºber eine Klasse und ihre Nachkommen </h2><br><p>  Ein weiterer h√§ufiger Fall ist das Zwischenspeichern statischer Daten in der Phase der Klassenerstellung, um keine Zeit mit der Berechnung zu verschwenden, w√§hrend die Anwendung ausgef√ºhrt wird.  Dar√ºber hinaus k√∂nnen einige Daten aktualisiert werden, wenn neue Instanzen von Klassen erstellt werden, z. B. ein Z√§hler f√ºr die Anzahl der erstellten Objekte. </p><br><p>  Wie kann das genutzt werden?  Angenommen, Sie entwickeln ein Framework zum Erstellen von Berichten und Tabellen und haben ein solches Objekt: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=MetaRow)</span></span></span><span class="hljs-class">:</span></span> name: str age: int ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self.counter = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> kwargs.items(): setattr(self, attr, value) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__str__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> out = [self.counter] <span class="hljs-comment"><span class="hljs-comment">#  __header__      for name in self.__header__[1:]: out.append(getattr(self, name, 'N/A')) return ' | '.join(map(str, out))</span></span></code> </pre> <br><p>  Wir m√∂chten den Z√§hler beim Erstellen einer neuen Zeile speichern und erh√∂hen und den Header der resultierenden Tabelle im Voraus generieren.  Metaklasse zur Rettung! </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaRow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      row_count = 0 def __new__(mcs, name, bases, attrs): cls = super().__new__(mcs, name, bases, attrs) #          cls.__header__ = ['‚Ññ'] + sorted(attrs['__annotations__'].keys()) return cls def __call__(cls, *args, **kwargs): #      row: 'Row' = super().__call__(*args, **kwargs) #    cls.row_count += 1 #     row.counter = cls.row_count return row</span></span></code> </pre> <br><p>  Zwei Dinge m√ºssen hier gekl√§rt werden: </p><br><ul><li>  Die <code>Row</code> Klasse hat keine Klassenattribute mit den Namen <code>name</code> und <code>age</code> Dies sind <code>attrs</code> , daher befinden sie sich nicht in den <code>attrs</code> W√∂rterbuchschl√ºsseln. Um eine Liste der Felder zu erhalten, verwenden wir das <code>__annotations__</code> . </li><li>  Die Operation <code>cls.row_count += 1</code> sollte Sie irref√ºhren: wie?  Schlie√ülich ist <code>cls</code> eine <code>Row</code> Klasse und hat nicht das Attribut <code>row_count</code> .  Alles ist wahr, aber wie ich oben erkl√§rt habe - wenn die erstellte Klasse kein Attribut oder keine Methode hat, die sie aufrufen m√∂chten, geht der Interpreter weiter entlang der Kette von Basisklassen - wenn keine darin enthalten sind, wird eine Suche in der Metaklasse durchgef√ºhrt.  In solchen F√§llen ist es besser, einen anderen Datensatz zu verwenden, um niemanden zu verwirren: <code>MetaRow.row_count += 1</code> . </li></ul><br><p>  Sehen Sie, wie elegant Sie jetzt die gesamte Tabelle anzeigen k√∂nnen: </p><br><pre> <code class="python hljs">rows = [ Row(name=<span class="hljs-string"><span class="hljs-string">'Valentin'</span></span>, age=<span class="hljs-number"><span class="hljs-number">25</span></span>), Row(name=<span class="hljs-string"><span class="hljs-string">'Sergey'</span></span>, age=<span class="hljs-number"><span class="hljs-number">33</span></span>), Row(name=<span class="hljs-string"><span class="hljs-string">'Gosha'</span></span>), ] print(<span class="hljs-string"><span class="hljs-string">' | '</span></span>.join(Row.__header__)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rows: print(row)</code> </pre> <br><pre> <code class="hljs ruby">‚Ññ <span class="hljs-params"><span class="hljs-params">| age |</span></span> name <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 25 |</span></span> Valentin <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-params"><span class="hljs-params">| 33 |</span></span> Sergey <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-params"><span class="hljs-params">| N/A |</span></span> Gosha</code> </pre> <br><p>  Das Anzeigen und Arbeiten mit einer Tabelle kann √ºbrigens in einer separaten <code>Sheet</code> Klasse zusammengefasst werden. </p><br><h2 id="prodolzhenie-sleduet">  Fortsetzung folgt... </h2><br><p>  Im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">n√§chsten Teil</a> dieses Artikels werde ich beschreiben, wie Sie Metaklassen zum Debuggen Ihres Anwendungscodes verwenden, wie Sie die Erstellung einer Metaklasse parametrisieren und grundlegende Beispiele f√ºr die Verwendung der <code>__prepare__</code> -Methode zeigen.  Bleib dran! </p><br><p>  Ausf√ºhrlicher √ºber Metaklassen und Deskriptoren in Python werde ich im Rahmen von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Advanced Python berichten</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de422409/">https://habr.com/ru/post/de422409/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de422397/index.html">‚ÄûHauptsache, ich habe es bestanden‚Äú: Was und wie werden zuk√ºnftige IT-Spezialisten in Berlin unterrichtet?</a></li>
<li><a href="../de422399/index.html">Der Prozess der Code√ºberpr√ºfung in hh.ru.</a></li>
<li><a href="../de422401/index.html">Ein weiteres C ++ - Plugin-Framework</a></li>
<li><a href="../de422403/index.html">20. September, Moskau - ein Treffen f√ºr Analysten</a></li>
<li><a href="../de422407/index.html">Suchen und sortieren Sie verwandte Texte</a></li>
<li><a href="../de422411/index.html">Neue Rollen in Unternehmen im Zeitalter des Service</a></li>
<li><a href="../de422413/index.html">Anwendung von Arm Mbed OS. Feinabstimmung</a></li>
<li><a href="../de422415/index.html">Python: Metaprogrammierung in der Produktion. Teil zwei</a></li>
<li><a href="../de422417/index.html">Slavik und GMT + 3 oder Nutzen f√ºr Menschen</a></li>
<li><a href="../de422419/index.html">Nicht ohne Panik in Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>