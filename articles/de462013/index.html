<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤳🏾 🌊 😬 Verlauf des Docker-Speicher-Migrationsproblems (Docker-Root) 😔 🧑🏽‍🤝‍🧑🏽 🌷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spätestens vor ein paar Tagen wurde auf einem der Server entschieden, den Docker-Speicher (das Verzeichnis, in dem der Docker alle Dateien von Contain...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verlauf des Docker-Speicher-Migrationsproblems (Docker-Root)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462013/"> Spätestens vor ein paar Tagen wurde auf einem der Server entschieden, den Docker-Speicher (das Verzeichnis, in dem der Docker alle Dateien von Containern und Images speichert) auf eine separate Partition zu verschieben <br>  besaß mehr Kapazität.  Die Aufgabe scheint trivial zu sein und war kein Problem ... <br><a name="habracut"></a><br>  Erste Schritte: <br><br>  1. Halten Sie an und töten Sie alle Container unserer Anwendung: <br><br><pre><code class="bash hljs">docker-compose down</code> </pre> <br>  Wenn es viele Container gibt und diese sich in unterschiedlicher Zusammensetzung befinden, können Sie dies tun: <br><br><pre> <code class="bash hljs">docker rm -f $(docker ps -q)</code> </pre> <br>  2. Stoppen Sie den Docker-Daemon: <br><br><pre> <code class="bash hljs">systemctl stop docker</code> </pre> <br>  3. Verschieben Sie das Verzeichnis an den gewünschten Speicherort: <br><br><pre> <code class="bash hljs">cp -r /var/lib/docker /docker/data/storage</code> </pre> <br>  4. Wir informieren den Dämon des Dockers, in einem neuen Verzeichnis zu suchen.  Es gibt verschiedene Möglichkeiten: Verwenden Sie entweder das Flag -g, um den Dämon auf einen neuen Pfad zu verweisen, oder die von uns verwendeten systemd-Konfigurationen.  Nun, oder Symlink.  Ich werde nicht viel malen, das Internet ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">voll von</a> Handbüchern zum Portieren von Docker-Root an einen neuen Ort. <br><br>  5. Wir starten den Docker-Dämon und sehen, dass er dort aussieht, wo er sein sollte: <br><br><pre> <code class="bash hljs">systemctl status docker</code> </pre> <br>  In einer der Ausgabezeilen sollten wir sehen: <br><pre> <code class="bash hljs">├─19493 /usr/bin/dockerd --data-root=/docker/data/storage</code> </pre> <br>  Wir haben sichergestellt, dass die Option an den Daemon übergeben wurde. Jetzt prüfen wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">,</a> ob sie angewendet wurde (danke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">inkvizitor68sl</a> ). <br><pre> <code class="bash hljs">docker info | awk <span class="hljs-string"><span class="hljs-string">'/Root Dir/ {print $NF}'</span></span></code> </pre> <br>  6. Wir starten unsere Bewerbung: <br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  7. Überprüfen Sie <br><br>  Und hier beginnt der Spaß, DBMS, MQ, alles ist gut!  Die Basis ist intakt, alles funktioniert ... bis auf Nginx.  Wir haben unsere eigene Nginx-Baugruppe mit Kerberos <s>und Kurtisanen</s> .  Das Anzeigen der Protokolle des Containers zeigte an, dass er nicht in / var / tmp schreiben konnte - Berechtigung verweigert.  Ich strecke meine Finger mit Whisky aus und versuche die Situation zu analysieren ... Wie ist das?  Das Docker-Image hat sich nicht geändert.  Wir haben gerade das Verzeichnis verschoben.  Es hat immer funktioniert, und hier ist es für Sie ... Um zu experimentieren, ging ich mit Stiften in den Container und änderte die Rechte an diesem Verzeichnis, es gab <u>root, root 755</u> , gab <u>root, root 777</u> .  Und alles begann ... Ein Gedanke klang in meinem Kopf - eine Art Unsinn ... Ich dachte, vielleicht habe ich etwas nicht berücksichtigt ... <br><br>  Ich entschied, dass uns die Zugriffsrechte auf die Dateien während der Übertragung gefallen haben.  Sie haben die Anwendung, den Docker-Daemon, gestoppt, das neue Verzeichnis gelöscht und bereits mit <code>rsync -a</code> eine Kopie des Verzeichnisses / var / lib / docker erstellt. <br><br>  Ich denke, jetzt ist alles in Ordnung. Wir erhöhen den Docker, die Anwendung. <br><br>  III ... das Problem bleibt ... Mein Auge zuckte.  Ich eilte zur Konsole meiner virtuellen Maschine, wo ich verschiedene Tests durchführe. Ich hatte dieses Nginx-Image und bin in den Container geklettert. Hier befinden sich die Root- und Root-777-Rechte im Verzeichnis / var / tmp. Das sind dieselben, die ich mit meinen Händen einrichten musste .  Aber die Bilder sind identisch! <br><br>  <u>Überall verwendete FS xfs.</u> <br><br>  Ich habe durch den Befehl verglichen <br><br><pre> <code class="bash hljs">docker inspect my-nginx:12345</code> </pre> <br>  Alle Hashes sind identisch, alle eins zu eins.  Sowohl auf dem Server als auch auf meiner Virtualka.  Ich habe das lokale Nginx-Image gelöscht und erneut mit der Registrierung gespoolt, die sich aus mehreren Gründen auf demselben Computer befindet.  Und das Problem ist das gleiche ... Jetzt zuckte mein zweites Auge. <br><br>  Ich kann mich nicht erinnern, welche Gedanken in meinem Kopf waren, abgesehen von den Schreien von "AAAAAAA" und anderen Dingen.  Auf der Straße um 4 Uhr morgens wurden die Docker-Quellen verwendet, um das Prinzip des Hashing von Bildebenen zu verstehen.  Er öffnete die dritte Energiedose.  Und am Ende wurde mir klar, dass beim Hashing nur die Datei, ihr Inhalt, aber <b>nicht das Zugriffsrecht</b> berücksichtigt werden!  Das heißt, auf mysteriöse Weise wurden Rechte geschlagen und Selinux ist deaktiviert, acl wird nicht verwendet, klebriges Bit ist nicht vorhanden. <br><br>  Ich habe das lokale Image gelöscht, auch das Image aus der Docker-Registrierung gelöscht und erneut gestartet.  Und es hat funktioniert.  Es stellt sich heraus, dass während der Übertragung die Rechte sowohl innerhalb des lokalen Bildes als auch innerhalb des in der Registrierung liegenden Bildes geschlagen wurden.  Wie gesagt, aus mehreren Gründen befand es sich im selben Auto.  Und als Ergebnis in einem Verzeichnis / var / lib / docker. <br><br>  Und die Frage vorwegzunehmen, ob sie versuchten, den Blick des Hafenarbeiters auf den alten Katalog zurückzubringen - nein, die Umstände ließen es leider nicht zu.  Ja, und wollte es wirklich herausfinden. <br><br>  Nach dem Schreiben dieses Artikels scheint mir die Lösung des Problems offensichtlich zu sein, aber zum Zeitpunkt der Analyse schien dies nicht der Fall zu sein.  Ich habe ehrlich gegoogelt und keine ähnlichen Situationen gefunden. <br><br>  Fazit: Ich habe das Problem gelöst, ich habe den Grund nicht verstanden = ( <br><br>  Wenn jemand eine Vision über die möglichen Ursachen dieses Problems kennt / vermutet / hatte - ich würde mich sehr freuen, Sie in den Kommentaren zu sehen! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de462013/">https://habr.com/ru/post/de462013/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de462003/index.html">Wie ich PWA auf Svelte bei Google Play gepostet habe</a></li>
<li><a href="../de462005/index.html">Funktionen von Google PageSpeed: Verbesserte Website-Bewertung und verbessertes Suchranking</a></li>
<li><a href="../de462007/index.html">Entwicklung robuster Python-Skripte</a></li>
<li><a href="../de462009/index.html">Programmtrends: Was ist im Jahr 2020 zu erwarten?</a></li>
<li><a href="../de462011/index.html">Web-Geoservices. Überblick über moderne Lösungen</a></li>
<li><a href="../de462015/index.html">SAP-Berichtsuniversum</a></li>
<li><a href="../de462021/index.html">Wie man aufhört, dasselbe zu tun</a></li>
<li><a href="../de462023/index.html">Cascadeur: Die Zukunft der Spielanimation</a></li>
<li><a href="../de462025/index.html">Relationales Netzwerkdatenmodell</a></li>
<li><a href="../de462027/index.html">Wie Dark 50ms Code einsetzt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>