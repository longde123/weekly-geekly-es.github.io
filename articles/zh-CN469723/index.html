<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍💼 🌎 🧖🏿 在Yandex.Cloud和Python的无服务器功能上为Alice创建有状态技能 🧚 🍉 🥗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="让我们从新闻开始。 昨天，Yandex.Cloud宣布推出无服务器计算服务Yandex Cloud Functions 。 这意味着：您只编写服务代码（例如Web应用程序或聊天机器人），而Cloud本身会在其启动时创建和维护虚拟机，甚至在负载增加时也可以复制它们。 完全没有必要思考，这非常方便。 费...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>在Yandex.Cloud和Python的无服务器功能上为Alice创建有状态技能</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469723/"><p> 让我们从新闻开始。 昨天，Yandex.Cloud宣布推出无服务器计算服务<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Yandex Cloud Functions</a> 。 这意味着：您只编写服务代码（例如Web应用程序或聊天机器人），而Cloud本身会在其启动时创建和维护虚拟机，甚至在负载增加时也可以复制它们。 完全没有必要思考，这非常方便。 费用仅在计算期间发生。 </p><br><p>但是，有些可能根本不付款。 这些是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Alice外部技能</a> （即内置在其中的聊天机器人）的开发人员。 任何开发人员都可以编写，托管和注册这种技能，从今天起，甚至不需要托管该技能，只需以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">无服务器功能</a>的形式将其代码上传到云中即可。 </p><br><p> 但是有一些细微差别。 首先，您的宠物代码可能需要一些依赖关系，并且将它们引入云中并非易事。 其次，任何普通的聊天机器人都需要将对话的状态存储在某个地方（因此是有状态的）； 如何在最简单的无服务器功能中做到这一点？ 第三，如何快速而肮脏地为Alice或某种具有非零绘图的机器人编写技能？ 关于这些细微差别，实际上是一篇文章。 </p><br><img src="https://habrastorage.org/webt/zw/u9/xd/zwu9xdyjusoxljngms6bjjz02cq.png" alt="图片"><a name="habracut"></a><br><h3> 道德训练 </h3><br><p> 对于不耐烦的人：在将函数上传到云之前，我会收集一个make文件中的必要依赖项，并将对话状态存储在Yandex Object Storage中（它支持S3 API），并使用我自己的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">tgalice</a>库来管理对话。 结果就是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这样的</a>演示技能。 现在，让我们更详细地了解所有这些。 </p><br><p> 为了减少耐心：在深入探讨有关困难的故事之前，我强烈建议从简单的故事开始。 即，创建一个单文件回声测深仪功能，在Dialogs开发人员控制台中注册并测试它； 有关详细信息，请参见“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">云</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">对话框</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">博客”</a> 。 只有这样才能继续。 </p><br><p> 如果您想立即感觉到我们正在为之奋斗，请让Alice <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">启用“ IT星座”技术。</a> 将出现以下对话框： </p><br><p>爱丽丝：嗨！ 您具有Aishish Horoscope的技能。 说“开始”以找出星星向您承诺的内容。 <br> 用户：开始 <br> 答：请输入您的名字。 <br> 于：Vasisuali <br> 答：现在告诉我您的出生年份。 只有四个数字，仅此而已。 <br> 于：第二 <br> 答：请再试一次。 您的出生年份是-四位数。 <br>  U：2002 <br>  A：太好了！ 现在命名您的出生月份。 <br>  U：二月 <br>  A：太好了！ 最后，告诉我您的出生日期-只有一个数字，只有一个或两个数字。 <br>  U：18 <br> 答：谢谢Vasisuali！ 现在我们知道：您今年17岁，您是水瓶座。 当然，您在这里很幸运！ 星星告诉你： <code>   ,  ,  .</code> </p><br><p> 问题是，为了保持这样简单的对话，您需要记住用户的姓名和出生日期，在无服务器环境中，这并非易事。 将上下文存储在RAM中或磁盘上的文件将无法工作，因为  Yandex.Cloud可以在多个虚拟机上同时运行该功能，并可以在它们之间任意切换。 我们将不得不使用某种外部存储。 在Yandex.Cloud中，对象存储被选为一种非常便宜且不复杂的存储（即可能很快）。 作为一种免费的替代方法，您可以尝试在很远的地方免费获得一片<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">蒙加蒙加</a> 。 对象存储（它支持S3接口）和Mongo都有方便的Python包装器。 </p><br><p> 另一个问题是，要在对象存储，MongoDB以及任何其他数据库或数据仓库中运行，需要一些外部依赖项，这些依赖项需要与函数代码一起上传到Yandex Functions。 我想方便地做到这一点。 这样做很方便（例如heroku），但是不会成功，但是您可以通过编写脚本来构建环境（make-file）来创造一些基本的舒适感。 </p><br><h3> 如何运行星座运势 </h3><br><ol><li> 准备自己：去一些Linux机器。 原则上，您可能也可以使用Windows，但是随后您必须想像一下make文件的启动。 在任何情况下，您都需要安装不低于3.6的Python。 </li><li> 用github克隆自己<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一个星座技巧的例子</a> 。 </li><li> 在Y.Cloud中注册： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https</a> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">//cloud.yandex.ru</a> </li><li> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">对象存储中</a>为自己创建两个存储桶，用任何名称<code>{BUCKET NAME}</code>和<code>tgalice-test-cold-storage</code>命名它们（此第二个名称现在在我的示例的<code>main.py</code>了硬编码）。 仅在部署时需要第一个存储桶，第二个存储桶用于存储对话状态。 </li><li> 创建一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">服务帐户</a> ，为其指定<code>editor</code>角色，并为其获取静态信用卡<code>{KEY ID}</code>和<code>{KEY VALUE}</code> -我们将使用它们来记录对话的状态。 所有这些都是必需的，以便Y.Cloud中的功能可以从Y.Cloud中访问存储库。 我希望有一天，授权会自动进行，但是暂时-这样。 </li><li>  （可选）安装<code>yc</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">命令行界面</a> 。 您可以通过Web界面创建功能，但是CLI的好处在于，各种创新都可以更快地出现在其中。 </li><li> 现在，您实际上可以准备依赖程序集：在带有<code>make all</code>技能示例的文件夹中的命令提示符处运行。 一堆库（通常和往常一样是不必要的）将安装在<code>dist</code>文件夹中。 </li><li> 将上一步中获得的<code>dist.zip</code>档案倒入对象存储中（放入<code>{BUCKET NAME}</code> ）。 如果需要，您可以从命令行执行此操作，例如，使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWS CLI</a> 。 </li><li> 通过Web界面或使用<code>yc</code>实用程序创建无服务器功能。 对于该实用程序，该命令将如下所示： </li></ol><br><pre> <code class="plaintext hljs">yc serverless function version create\ --function-name=horoscope\ --environment=AWS_ACCESS_KEY_ID={KEY ID},AWS_SECRET_ACCESS_KEY={KEY VALUE}\ --runtime=python37\ --package-bucket-name={BUCKET NAME}\ --package-object-name=dist.zip\ --entrypoint=main.alice_handler\ --memory=128M\ --execution-timeout=3s</code> </pre> <br><p> 手动创建函数时，所有参数均以相同的方式填充。 </p><br><p> 现在，可以通过开发人员控制台测试您创建的功能，然后修改和发布该技能。 </p><br><p><img src="https://habrastorage.org/webt/ux/f9/d3/uxf9d3wqso088fktufbfmsoumh8.jpeg"></p><br><h3> 内幕是什么 </h3><br><p>  makefile实际上包含一个相当简单的脚本，用于安装依赖项并将其放入<code>dist.zip</code>存档中，如下所示： </p><br><pre> <code class="plaintext hljs">mkdir -p dist/ pip3 install -r requirements.txt --target dist/ cp main.py dist/main.py cp form.yaml dist/form.yaml cd dist &amp;&amp; zip --exclude '*.pyc' -r ../dist.zip ./*</code> </pre> <br><p> 其余的是包装在<code>tgalice</code>库中的一些简单工具。 填写用户数据的过程由form.yaml <code>form.yaml</code>描述： </p><br><pre> <code class="plaintext hljs">form_name: 'horoscope_form' start: regexp: '|(|)' suggests: -  fields: - name: 'name' question: ,   . - name: 'year' question:      .   ,  . validate_regexp: '^[0-9]{4}$' validate_message: ,   .     -  . - name: 'month' question: !     . options: -  ... -  validate_message: ,   ,    . ,    ,   . - name: 'day' question: ! ,      -  ,     . validate_regexp: '[0123]?\d$' validate_message: ,   .       (, );     .</code> </pre> <br><p> 解析此配置并计算最终结果的工作由python类承担 </p><br><pre> <code class="plaintext hljs">class CheckableFormFiller(tgalice.dialog_manager.form_filling.FormFillingDialogManager): SIGNS = { '': '', ... } def handle_completed_form(self, form, user_object, ctx): response = tgalice.dialog_manager.base.Response( text=', {}!   :  {} ,   {}. \n' '  , , !   : {}'.format( form['fields']['name'], 2019 - int(form['fields']['year']), self.SIGNS[form['fields']['month']], random.choice(FORECASTS), ), user_object=user_object, ) return response</code> </pre> <br><p> 更准确地说，基类<code>FormFillingDialogManager</code>填写“表单”，子类<code>handle_completed_form</code>的方法说明准备就绪时该怎么做。 </p><br><p> 除了用户对话的主要流程外，您还需要打招呼，并在“帮助”命令上提供帮助，并从“退出”命令上退出技能。  <code>tgalice</code>也为此提供了一个模板，因此整个对话框管理器由以下部分组成： </p><br><pre> <code class="plaintext hljs">dm = tgalice.dialog_manager.CascadeDialogManager( tgalice.dialog_manager.GreetAndHelpDialogManager( greeting_message=DEFAULT_MESSAGE, help_message=DEFAULT_MESSAGE, exit_message=' ,    " " !' ), CheckableFormFiller(`form.yaml`, default_message=DEFAULT_MESSAGE) )</code> </pre> <br><p>  <code>CascadeDialogManager</code>工作原理很简单：它将尝试将其所有组件依次应用于对话框的当前状态，然后选择第一个合适的组件。 </p><br><p> 作为对每条消息的回答，对话框管理器返回一个<code>Response</code>对象，该对象可以进一步转换为纯文本，或者转换为Alice或Telegram中的消息-取决于启动程序的位置。 它还包含对话的更改状态，必须保存。 所有此类厨房都使用另一个类<code>DialogConnector</code>进行操作，因此在Yandex Functions上启动该技能的直接脚本如下所示： </p><br><pre> <code class="plaintext hljs">... session = boto3.session.Session() s3 = session.client( service_name='s3', endpoint_url='https://storage.yandexcloud.net', aws_access_key_id=os.environ['AWS_ACCESS_KEY_ID'], aws_secret_access_key=os.environ['AWS_SECRET_ACCESS_KEY'], region_name='ru-central1', ) storage = tgalice.session_storage.S3BasedStorage(s3_client=s3, bucket_name='tgalice-test-cold-storage') connector = tgalice.dialog_connector.DialogConnector(dialog_manager=dm, storage=storage) alice_handler = connector.serverless_alice_handler</code> </pre> <br><p> 如您所见，大多数代码都创建了到Object Storage S3接口的连接。 可以直接<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在tgalice代码中</a>了解如何直接使用此连接。 <br> 最后一行创建<code>alice_handler</code>函数-我们在设置<code>--entrypoint=main.alice_handler</code>时命令Yandex.Cloud拉出的<code>--entrypoint=main.alice_handler</code> 。 </p><br><p> 实际上，仅此而已。 程序集的Makefile，类似于S3的对象存储（用于存储上下文）以及tgalice python库。 再加上python的无服务器功能和表达能力，这足以培养健康人的技能。 </p><br><p> 您可能会问，为什么需要创建<code>tgalice</code> ？ 所有将JSON从请求传输到响应，再从存储传输到内存，反之亦然的无聊代码都位于其中。 还有一个常规的控制器应用程序，一个用于了解“二月”类似于“二月”的功能，以及其他针对穷人的NLU。 根据我的想法，这应该已经足够了，以便您可以在yaml文件中绘制技能原型，而又不会被技术细节所干扰。 </p><br><p> 如果您想要更严重的NLU，可以根据自己的技能来固定<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Rasa</a>或<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DeepPavlov</a> ，但是要配置它们，您将需要带有手鼓的其他舞蹈，尤其是在无服务器上。 如果您根本不想编写代码，则应使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Aimylogic之</a>类的可视构造<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">函数</a> 。 创建tgalice时，我在想某种中间路径。 让我们看看会发生什么。 </p><br><p> 好吧，现在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">加入他们的技能开发人员聊天</a> ，阅读<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a> ，并创造精彩的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">技能</a> ！ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN469723/">https://habr.com/ru/post/zh-CN469723/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN469703/index.html">普通的阿瓦隆</a></li>
<li><a href="../zh-CN469707/index.html">配置VSCode以与Scala一起使用</a></li>
<li><a href="../zh-CN469709/index.html">Blitz Engine和Battle Prime：ECS和网络代码</a></li>
<li><a href="../zh-CN469717/index.html">让光线发光</a></li>
<li><a href="../zh-CN469721/index.html">Dell OptiPlex 7070 Ultra：将任何显示器变成一体的模块化计算机</a></li>
<li><a href="../zh-CN469725/index.html">旅行者太阳能系统指南</a></li>
<li><a href="../zh-CN469731/index.html">使用IRO.Mvc.MvcExceptionHandler处理ASP.NET异常</a></li>
<li><a href="../zh-CN469733/index.html">遥控车：首次购买-底盘和动力总成</a></li>
<li><a href="../zh-CN469735/index.html">从任意正数计算n次方根的算法</a></li>
<li><a href="../zh-CN469737/index.html">木制玩具，第五部分-1991年</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>