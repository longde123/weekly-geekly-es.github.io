<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèΩ ‚å®Ô∏è ‚õ∞Ô∏è Como o malware evita caixas de areia com o Visual Basic üå∂Ô∏è üëí üëº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todos os dias, no JSOC CERT, encontramos eventos de diferentes caixas de prote√ß√£o que funcionam como parte das solu√ß√µes AntiAPT de nossos clientes e p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como o malware evita caixas de areia com o Visual Basic</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/473086/">  Todos os dias, no JSOC CERT, encontramos eventos de diferentes caixas de prote√ß√£o que funcionam como parte das solu√ß√µes AntiAPT de nossos clientes e permitem que milhares de arquivos do tr√°fego da Web e de email passem por eles.  Vale a pena notar que os modernos sistemas Sandbox em seu desenvolvimento foram muito mais al√©m do que simplesmente interceptar chamadas do sistema no Modo Kernel e fun√ß√µes da API no Modo Usu√°rio.  Cada vez mais, eles usam seu pr√≥prio hypervisor, um sistema para emular a atividade do usu√°rio, instrumenta√ß√£o din√¢mica, hash e clustering em se√ß√µes de c√≥digo, an√°lise de cobertura de c√≥digo etc.  Essa variedade de tecnologias cria a ilus√£o de que, se um arquivo n√£o funciona na caixa de areia e n√£o mostra sua ‚Äúcara verdadeira‚Äù, ent√£o provavelmente √© o APT ou uma tecnologia inovadora para detectar um ambiente virtual, do qual a comunidade IB ainda n√£o est√° ciente.  Mas ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sc/cl/os/scclosmhrxygm1sxytg94as3z_i.jpeg"></div><a name="habracut"></a><br>  Como n√£o conhecemos os recursos internos do trabalho de caixas de areia comerciais, em alguns casos, verificamos duas vezes - analisamos manualmente as amostras que passaram no teste.  Recentemente, descobrimos v√°rias vezes que algumas caixas de prote√ß√£o comerciais (por raz√µes objetivas, n√£o podemos dizer quais) n√£o detectaram determinados arquivos maliciosos durante a an√°lise din√¢mica e, se o analisador est√°tico tamb√©m estava silencioso, o arquivo foi ignorado. <br><br>  A verifica√ß√£o da sandbox conseguiu ignorar fam√≠lias de malware conhecidas como Pony, Loki e Hawkeye.  Apenas uma coisa os uniu - eles foram cobertos por um empacotador escrito em Visual Basic. <br><br>  Dado que essas fam√≠lias HPE h√° muito n√£o s√£o novidade, o veredicto "positivo" da sandbox √© muito deprimente.  Portanto, decidimos descrever o princ√≠pio geral de opera√ß√£o desse empacotador e as observa√ß√µes feitas por n√≥s ao longo de algum tempo. <br>  O esquema geral do trabalho do empacotador √© condicionalmente dividido em 4 etapas e √© mostrado no diagrama abaixo. <br><br><img src="https://habrastorage.org/webt/fk/c9/of/fkc9of6pras7-cd55luw1l1mpai.jpeg"><br><br>  O ponto de entrada de um arquivo malicioso parece t√≠pico dos aplicativos Visual Basic: <br><br><img src="https://habrastorage.org/webt/vj/ia/he/vjiaheueiyapa2swzf8_cqrwzka.jpeg"><br><br>  N√≥s encontramos v√°rias op√ß√µes para esse empacotador, e o c√≥digo do VB Wrapper mudou com frequ√™ncia, mas a tarefa executada permaneceu a mesma: transferir o controle para o c√≥digo do Est√°gio 1. Em amostras anteriores, o controle foi transferido usando as fun√ß√µes de API da classe Enum * (por exemplo, EnumWindows, EnumCalendarInfo, etc.). e) para o qual o endere√ßo Est√°gio 1 do c√≥digo foi indicado como par√¢metro.  Recentemente, observamos que o controle √© transferido diretamente. <br><br><h2>  Etapa 1 </h2><br>  A ger√™ncia recebe o c√≥digo Est√°gio 1. Este c√≥digo n√£o √© criptografado, mas √© ofuscado.  Os m√©todos de ofusca√ß√£o variam de amostra para amostra, mas o algoritmo de opera√ß√£o geral n√£o muda: <br><br><ol><li>  Um ciclo com muitas instru√ß√µes (incluindo lixo) que gera a chave necess√°ria para decodificar o c√≥digo do Est√°gio 2.  A peculiaridade desse trecho de c√≥digo √© que n√£o h√° fun√ß√µes de suspens√£o, mas devido ao grande n√∫mero de itera√ß√µes, sua execu√ß√£o leva em m√©dia 1-2 minutos. </li><li>  Descriptografia (XOR regular) e transfer√™ncia de controle para o c√≥digo do Est√°gio 2. </li></ol><br>  A captura de tela abaixo mostra exemplos de m√©todos de ofusca√ß√£o usados: <br><br><img src="https://habrastorage.org/webt/--/p-/xl/--p-xlue_skm9loofz_wj3tmeic.jpeg"><br><br><h2>  2 etapa </h2><br>  A principal tarefa do c√≥digo no Est√°gio 2 √© verificar o ambiente e implementar m√©todos anti-depura√ß√£o.  Algumas se√ß√µes do c√≥digo s√£o criptografadas (descriptografadas antes da execu√ß√£o e, depois disso, criptografadas novamente com o mesmo algoritmo XOR) para dificultar a detec√ß√£o por assinaturas.  Ap√≥s a descriptografia, os recursos caracter√≠sticos s√£o vis√≠veis, segundo os quais o c√≥digo do Est√°gio 2 pode ser reconhecido por an√°lise manual. <br><br><img src="https://habrastorage.org/webt/eb/n8/oq/ebn8oqw9vqcysrl-c98pdfdrdjq.jpeg"><br><br>  A lista de verifica√ß√µes √© bastante grande e difere em diferentes vers√µes do empacotador, por isso, forneceremos alguns m√©todos encontrados em todas as vers√µes com capturas de tela e, no final, listaremos a lista inteira na tabela. <br><br><h4>  1) GetTickCount + Sleep </h4><br>  O registro de data e hora atual √© obtido, o modo de suspens√£o √© chamado por 2 segundos, ap√≥s o qual outro registro de data e hora √© obtido imediatamente. <br><br>  Depois disso, a diferen√ßa entre as marcas √© verificada (se 2 segundos realmente passaram). <br><br><img src="https://habrastorage.org/webt/mp/ip/pj/mpippjhsogyg_uvk0eikkuehm_w.jpeg"><br><br><h4>  2) SetErrorMode </h4><br>  Verifica a opera√ß√£o correta da chamada da API SetErrorMode.  A fun√ß√£o √© chamada duas vezes seguidas com os par√¢metros 0x800 e 0x0, ap√≥s o qual o resultado da segunda chamada √© verificado: deve ser igual a 0x800. <br><br><img src="https://habrastorage.org/webt/gp/kr/vx/gpkrvxff7l4irukw4oqifs6ai4a.jpeg"><br><br><h4>  3) SetLastError </h4><br>  Primeiro, √© chamado um SetLastError com um par√¢metro 0x5, ap√≥s o qual √© verificado se o valor do √∫ltimo c√≥digo de erro no TEB est√° definido corretamente (ou seja, √© 0x5). <br><br><img src="https://habrastorage.org/webt/3k/am/vh/3kamvhsb_z6nw8tlchtlcuhxa0q.jpeg"><br><br><h4>  4) Verificando o movimento do cursor </h4><br>  O c√≥digo entra em um loop sem fim, esperando o mouse se mover. <br><br><img src="https://habrastorage.org/webt/aq/1w/wo/aq1wwopzjhbmihs8mxnmmkcxoma.jpeg"><br><br><h4>  5) DbgBreakPoint e DbgUiRemoteBreakin </h4><br>  Essas fun√ß√µes s√£o modificadas para impedir que o depurador se conecte ao processo. <br><br><img src="https://habrastorage.org/webt/aw/we/qd/awweqdnasj4ztgfjk1bdv-lcfw4.jpeg"><br><table border="1"><tbody><tr><td><p>  T√©cnica <br></p><br></td><td><p>  Coment√°rio <br></p><br></td></tr><tr><td><p>  GetTickCount + Sleep <br></p><br></td><td><p>  Verificando timestamps <br></p><br></td></tr><tr><td><p>  SetErrorMode <br></p><br></td><td><p>  Verificando se a fun√ß√£o est√° funcionando corretamente <br></p><br></td></tr><tr><td><p>  SetLastError <br></p><br></td><td><p>  Verificando se a fun√ß√£o est√° funcionando corretamente <br></p><br></td></tr><tr><td><p>  GetCursorPos <br></p><br></td><td><p>  Verifique o movimento do cursor <br></p><br></td></tr><tr><td><p>  Dbgbreakpoint <br></p><br></td><td><p>  Modifica√ß√£o de fun√ß√£o para impedir a conex√£o do depurador <br></p><br></td></tr><tr><td><p>  DbgUiRemoteBreakin <br></p><br></td><td><p>  Modifica√ß√£o de fun√ß√£o para impedir a conex√£o do depurador <br></p><br></td></tr><tr><td><p>  Exclus√£o de gancho <br></p><br></td><td><p>  Os primeiros 5 bytes de fun√ß√µes s√£o restaurados no ntdll.dll, caso haja ganchos <br></p><br></td></tr><tr><td><p>  NtSetInformationThread <br></p><br></td><td><p>  Par√¢metro 0x11 (ThreadHideFromDebugger) <br></p><br></td></tr><tr><td><p>  GetThreadContext + verifique DR <br></p><br></td><td><p>  Registros de depura√ß√£o DR0-DR3, DR6, DR7 s√£o verificados. <br></p><br></td></tr><tr><td><p>  Verificar pontos de interrup√ß√£o <br></p><br></td><td><p>  As instru√ß√µes INT3 (0xCC), int 3 (0xCD 0x03) e ud2 (0x0F 0x0B) no in√≠cio de algumas fun√ß√µes s√£o verificadas <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x0) <br></p><br></td><td><p>  Os registros EAX, ECX, EDX s√£o verificados <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x40000000) <br></p><br></td><td><p>  Os registros EAX, ECX, EDX s√£o verificados <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x1) <br></p><br></td><td><p>  31¬∫ bit ECX verificado <br></p><br></td></tr><tr><td><p>  PEB (sendo depurado) <br></p><br></td><td><p>  Verifica o valor 0x1 <br></p><br></td></tr><tr><td><p>  PEB (NtGlobalFlag) <br></p><br></td><td><p>  Valor verificado 0x70 <br></p><br></td></tr><tr><td><p>  NtQueryInformationProcess <br></p><br></td><td><p>  Chamado com sinalizadores ProcessDebugPort (0x7), ProcessDebugFlags (0x1F), ProcessDebugObjectHandle (0x1E) <br></p><br></td></tr><tr><td><p>  Verifica√ß√£o do nome do processo <br></p><br></td><td><p>  As strings "amostra", "caixa de areia", "v√≠rus", "malware", "auto". S√£o verificadas <br></p><br></td></tr></tbody></table><br>  Se todas as t√©cnicas do est√°gio 2 forem conclu√≠das, a linha de comandos ser√° verificada quanto √† conformidade com o formato especial.  Se a verifica√ß√£o falhar, as seguintes a√ß√µes ser√£o executadas: <br><br>  1) A fun√ß√£o CreateProcess √© chamada com o sinalizador CREATE_SUSPENDED para reiniciar o processo atual.  Nesse caso, a linha de comando tem o formato necess√°rio. <br>  2) Usando as fun√ß√µes GetContextThread e SetContextThread, o ponto de entrada √© alterado para um novo, localizado no c√≥digo do Est√°gio 1. <br>  3) Repita as etapas 1 e 2 (incluindo um ciclo longo e todas as verifica√ß√µes).  Dessa vez, a verifica√ß√£o da linha de comando √© bem-sucedida e o processo prossegue para a pr√≥xima etapa. <br><br><h2>  3 etapa </h2><br>  Nesse est√°gio, o corpo do v√≠rus principal √© descriptografado e a t√©cnica Process Hollowing √© executada no processo atual, ap√≥s o qual o controle √© transferido para o ponto de entrada do v√≠rus principal. <br><br><h2>  Li√ß√£o aprendida </h2><br>  N√£o podemos dizer exatamente o que causa essa ou aquela sandbox nesse caso, mas quero acreditar que a possibilidade de usar as t√©cnicas descritas no artigo por malware foi fornecida pelos fornecedores por um longo tempo, e o problema est√° apenas no longo atraso na primeira etapa do trabalho do empacotador . <br><br>  Apesar de as caixas de areia modernas serem posicionadas principalmente como parte dos sistemas de prote√ß√£o contra ataques de APT, nossas observa√ß√µes sugerem que mesmo fam√≠lias maliciosas conhecidas pela comunidade penetram na infraestrutura com const√¢ncia invej√°vel.  Como n√£o h√° garantias de que a amostra que contornou o sandbox n√£o ter√° algumas t√©cnicas de desvio de antiv√≠rus em seu arsenal, voc√™ n√£o pode confiar nesse monte de solu√ß√µes protetoras.  Nesses casos, um processo de monitoramento adequadamente constru√≠do, incluindo eventos de seguran√ßa da informa√ß√£o dos hosts finais, pode garantir uma resposta oportuna e minimizar poss√≠veis danos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473086/">https://habr.com/ru/post/pt473086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473066/index.html">√Årvores de quadrante e reconhecimento de colis√£o</a></li>
<li><a href="../pt473072/index.html">Como a Gazpromneft cria um caminho digital para um cliente corporativo</a></li>
<li><a href="../pt473078/index.html">Gerencie facilmente configura√ß√µes de microsservi√ßos com o microconfig.io</a></li>
<li><a href="../pt473082/index.html">Como escrevemos microsservi√ßos e por que n√£o o fazemos rapidamente</a></li>
<li><a href="../pt473084/index.html">"Ivan" √© uma profiss√£o de bot de bate-papo. Ou experimentos criativos com assistentes virtuais</a></li>
<li><a href="../pt473090/index.html">Revis√£o do PocketBook 632 e 632 Aqua - pequenos leitores principais de 6 polegadas com tinta E</a></li>
<li><a href="../pt473092/index.html">AMA com Habr, n¬∫ 13: not√≠cias importantes para usu√°rios e empresas</a></li>
<li><a href="../pt473094/index.html">Hist√≥rias incr√≠veis de desenvolvedores, parte 5: Segredos do Universo</a></li>
<li><a href="../pt473096/index.html">Estruturas de dados avan√ßadas. Parte Um: Gr√°fico Ac√≠clico Direcional</a></li>
<li><a href="../pt473098/index.html">Compilando o FFmpeg no WebAssembly (= ffmpeg.js): Parte 1 - Culin√°ria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>