<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äç‚úàÔ∏è üåª üç´ PDA (Pocket Travel Computer): registrador GPS de circuitos üöï ü§±üèª üë®üèæ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Meu projeto de hobby √© um registrador GPS . Os coment√°rios at√© sugeriram cham√°-lo de ‚ÄúComputador de Viagem‚Äù, como O registro √© apenas uma pequena part...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PDA (Pocket Travel Computer): registrador GPS de circuitos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454434/">  Meu projeto de hobby √© um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">registrador GPS</a> .  Os coment√°rios at√© sugeriram cham√°-lo de ‚ÄúComputador de Viagem‚Äù, como  O registro √© apenas uma pequena parte de todos os recursos do dispositivo.  Muito j√° foi implementado, mas a maioria ainda precisa ser feita. <br><br>  Nos artigos anteriores, descrevi a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">transi√ß√£o do arduino para o STM32</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">STMCube / HAL</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">falei um pouco sobre o sistema de compila√ß√£o</a> , o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gerenciador de inicializa√ß√£o</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">constru√≠ um dispositivo USB composto</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aumentamos sua velocidade</a> .  Tudo isso foi feito em uma placa de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ensaio</a> baseada na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">placa Blue Pill STM32F103CB</a> e em um ouri√ßo de fios.  Chegou a hora do dispositivo tomar forma, tanto eletr√¥nica (circuito) quanto f√≠sica (corpo). <br><br><img src="https://habrastorage.org/webt/0g/et/tj/0gettjt59u77r2mjpz73hyfn7sc.jpeg"><br><br>  Os problemas que tive que resolver nesta fase est√£o muito interconectados.  Ao escolher componentes para um projeto, voc√™ precisa imaginar aproximadamente em qual alojamento eles podem ser inseridos.  E vice-versa, o caso deve ser feito para os componentes dispon√≠veis e as placas, que, novamente, precisam ser feitas de olho no gabinete.  Em geral, um emaranhado de quest√µes interconectadas.  Voc√™ pode, √© claro, pegar uma caixa maior e empurrar qualquer coisa para l√°, mas queria algo compacto e leve. <br><br>  Antes de come√ßar imediatamente, quero observar que essa n√£o √© a vers√£o final do dispositivo.  Provavelmente haver√° erros no esquema, algo n√£o funcionar√° como pretendido, nos coment√°rios eles indicar√£o solu√ß√µes mais corretas, algumas abordagens ser√£o repensadas.  Eu acho que a segunda ou at√© terceira vers√£o do dispositivo n√£o pode ser evitada.  Portanto, terei prazer em seus coment√°rios construtivos. <br><br>  Sob o corte, ele tem v√°rias contas, mas ser√° de engenharia. <br><a name="habracut"></a><br><h2>  O que e porque </h2><br>  O registrador GPS Holux M241 √© meu fiel companheiro em todas as viagens.  Ele est√° comigo h√° muitos milhares de quil√¥metros.  A faixa que o registrador grava √© usada principalmente para geotagging de fotos, mas a rota em si tamb√©m √© interessante.  √â divertido descobrir a rapidez com que voc√™ foi esquiar, qual rota o seu avi√£o voou, que vis√£o apenas brilhou do lado de fora da janela do √¥nibus.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> eu fiz uma pequena revis√£o deste dispositivo. <br><br>  Infelizmente, h√° muito que os recursos deste dispositivo n√£o me agradam: estou cansado de mexer com baterias que sempre ficam no momento mais inoportuno.  Tamb√©m existe uma velocidade USB muito baixa, uma pequena quantidade de flash interno, um mecanismo inconveniente para mesclar trilhas, pouca informa√ß√£o est√° dispon√≠vel no visor, baixa precis√£o, um od√¥metro muito primitivo, nenhuma informa√ß√£o sobre sat√©lites e muito mais. <br><br>  Sim, pode-se procurar o que os rastreadores modernos oferecem - com certeza j√° existe um dispositivo √† venda que atende aos meus requisitos.  Mas isso √© um hobby, quero tentar fazer algo complexo, interessante, √∫til e necess√°rio.  Deixe estar, mesmo que eu o use. <br><br>  O objetivo do projeto como um todo √© criar um dispositivo semelhante em algo, apenas recheado com a minha lista de desejos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">No primeiro artigo</a> da s√©rie, detalhei meus requisitos para o dispositivo.  Em resumo, eu gostaria de fazer o seguinte: <br><br><ul><li>  Recicle o sistema de energia, transfira para uma bateria de l√≠tio </li><li>  colocar uma exibi√ß√£o mais informativa </li><li>  GPS mais preciso </li><li>  expanda o flash com cart√£o SD </li><li>  adicione b√∫ssola e aceler√¥metro </li><li>  Tamb√©m quero redesenhar o sistema de registro para cuspir faixas no formato necess√°rio. </li></ul><br>  Al√©m dos requisitos t√©cnicos e da lista de desejos, tamb√©m existem requisitos n√£o t√©cnicos (n√£o funcionais).  Ent√£o, eu gostaria de criar dispositivos complexos a partir do zero, para descobrir como v√°rios componentes eletr√¥nicos funcionam, como program√°-los, como criar uma placa e projetar um gabinete. <br><br>  Por que voc√™ precisa de um dispositivo separado se todos os telefones modernos t√™m GPS, uma tela grande e muita mem√≥ria?  Bem, primeiro de tudo, n√£o tenho certeza de que um telefone com GPS ligado no modo de grava√ß√£o de faixa possa suportar o dia inteiro.  Eu realmente n√£o gostaria de ficar em um pa√≠s desconhecido sem telefone.  Al√©m disso, eu pessoalmente uso um dispositivo separado √© simplesmente mais confort√°vel. <br><br>  Talvez com o tempo, o conceito do dispositivo mude.  Ent√£o, por exemplo, agora est√° se tornando cada vez mais l√≥gico abandonar a tela e conectar-se ao telefone via bluetooth, e fazer todos os truques l√≥gicos no telefone.  Essa ideia √© muito robusta e tentadora.  Mas, nesta fase, eu ainda gostaria de ter uma exibi√ß√£o - sempre tenho tempo para abandon√°-la. <br><br>  Durante o primeiro ano e meio, desenvolvi o dispositivo em v√°rios tipos de placas de depura√ß√£o (primeiro arduino nano, depois STM32F103 comprimido azul, depois STM32F407VE).  Eu tive que conectar perif√©ricos na fia√ß√£o e adquiri os m√≥dulos.  Como resultado, um ouri√ßo feito de fios apareceu em cima da mesa, o que n√£o funcionou para testar a recep√ß√£o do GPS na rua - √†s vezes voc√™ nem conseguia mover os fios sem interromper a conex√£o em algum lugar.  E, em seguida, depura√ß√£o feliz. <br><br>  Toda vez, sentado para escrever funcionalidades √∫teis, me deparava com o fato de que alguma outra parte do sistema parou de funcionar normalmente e tinha que passar horas depurando algo completamente n√£o relacionado.  Por exemplo, o componente mais importante do sistema - o receptor GPS - acabou sendo o menos desenvolvido, porque  Eu tive que partir para depurar USB, cart√µes SD, configurar bibliotecas e assim por diante. <br><br>  Finalmente, me cansei disso e decidi fazer minha placa de depura√ß√£o - este ser√° o t√≥pico do artigo de hoje.  Os objetivos que estabeleci para mim nesta parte do projeto foram os seguintes: <br><br><ul><li>  Fa√ßa uma placa de depura√ß√£o que n√£o ter√° problemas com componentes sem contato </li><li>  Decidir sobre as principais solu√ß√µes t√©cnicas e esquem√°ticas </li><li>  Decida sobre os componentes que usarei a seguir </li><li>  Decida aproximadamente sobre o layout e o corpo </li><li>  O circuito deve ser geral o suficiente para poder experimentar diferentes componentes e seus modos </li></ul><br>  E embora o objetivo final seja um dispositivo de bateria compacto, hoje n√£o farei coisas como <br><br><ul><li>  modos de pot√™ncia de ajuste fino </li><li>  configura√ß√£o de consumo </li><li>  modos de sono </li></ul><br><br>  Lidarei com a configura√ß√£o de consumo quando a placa e o c√≥digo principal estiverem prontos.  A prop√≥sito, o c√≥digo de hoje tamb√©m n√£o ser√°, mas voltarei definitivamente a essa pergunta, pois haver√° material interessante o suficiente. <br><br><h2>  Componentes </h2><br>  Vamos come√ßar com os componentes e perif√©ricos.  Ao longo do caminho, estimaremos o n√∫mero de pernas do microcontrolador necess√°rias para conectar este zool√≥gico, bem como os par√¢metros de pot√™ncia.  Porque  √© um projeto de hobby que escolhi componentes do que realmente posso comprar nas lojas / ebay / ali e tamb√©m do que pode ser soldado em casa (bem, tamb√©m do que j√° estava em meus suprimentos pessoais).  Talvez alguns microcircuitos espec√≠ficos possam resolver o problema melhor, mas a quest√£o da acessibilidade e pre√ßo √© importante para mim. <br><br><ul><li>  O principal componente de um registrador GPS, √© claro, ser√° um <b>receptor GPS</b> .  No meu caso, este √© um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Beitian BN-880</a> bastante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">complicado,</a> baseado no chip UBlox M8N.  A b√∫ssola no chip HMC5883L tamb√©m est√° integrada no m√≥dulo. <br><br>  Conex√£o: UART de 2 pinos para GPS e I2C de 2 pinos para b√∫ssola <br>  Fonte de alimenta√ß√£o: De 2.7V <br>  Consumo: 50mA <br><br><ul><li>  Tamb√©m encomendou um m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Beitial BN-220</a> .  N√£o possui b√∫ssola, mas a antena √© mais compacta (20x20mm versus 30x30).  Ainda n√£o est√° claro como isso afetar√° a qualidade da recep√ß√£o.  Precisa testar.  Mas, a julgar pela folha de dados, este m√≥dulo pode funcionar a partir de 1.4V, o que deve ter um efeito positivo no tempo de opera√ß√£o do dispositivo. </li><li>  Aqui, de fato, tudo est√° de alguma forma enlameado.  Parece que o BN-880 √© baseado no UBlox M8N, enquanto o BN-220 √© baseado no U-blox M8030-KT.  Mas em algumas fontes, parece que parece ser a mesma coisa.  Mais precisamente, o M8N √© um m√≥dulo e o M8030-KT √© um chipset interno.  Estou preocupado com o problema de energia nessa confus√£o - o M8N √© anunciado a partir de 2.7V, enquanto o M8030-KT √© de 1.4V. </li><li>  Como alternativa, tamb√©m tenho o m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.aliexpress.com/item/1PC-SIM868-GSM-GPRS-Bluetooth-GNSS-SMS-GSM-Module-Instead-of-SIM808-SIM908/32821272639.html%3Fspm%3Da2g0s.9042311.0.0.27424c4dTkhPkq)%2520(%25D0%25BE%25D1%2582%25D0%25BB%25D0%25B0%25D0%25B4%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F%2520%25D0%25BF%25D0%25BB%25D0%25B0%25D1%2582%25D0%25B0%2520">SIM868 por a√≠</a> .  em que, al√©m do GPS, h√° tamb√©m um m√≥dulo GSM / GPRS e Bluetooth.  Enquanto assusta com sua complexidade e dificuldade de conex√£o.  Voc√™ precisar√° jogar com o quadro de depura√ß√£o primeiro. </li></ul></li><li>  A principal diferen√ßa entre o dispositivo e "apenas uma caixa preta" √© a presen√ßa de uma <b>tela</b> .  Nos primeiros prot√≥tipos, conectei o monitor via I2C, mas a carga do barramento foi de cerca de 25%.  Mas o ponto nem est√° na propor√ß√£o percentual, mas no fato de a transfer√™ncia do buffer de tela demorar cerca de 25ms, durante os quais √© imposs√≠vel se comunicar com outros dispositivos no barramento.  Isso pode ser um problema, portanto, √© necess√°rio colocar o monitor em um barramento I2C separado ou considerar a conex√£o via SPI <br><br>  Conex√£o: 2 fios I2C ou 3 fios SPI (exibi√ß√£o somente para grava√ß√£o, portanto a linha MISO n√£o √© usada, mas um sinal de dados / comando separado √© usado) <br>  Fonte de alimenta√ß√£o: 3V <br>  Consumo: 25mA <br></li><li>  Para controlar o dispositivo, usarei <b>2 bot√µes</b> que ocupam 2 pernas do processador, respectivamente <br></li><li>  No dispositivo original (Holux M241, do qual copiei originalmente a funcionalidade), era imposs√≠vel assistir a faixa em um ponto arbitr√°rio no tempo.  Era necess√°rio conectar o dispositivo ao computador e mesclar os dados com um programa especial.  Parece-me que a capacidade de assistir a uma faixa em um telefone celular ou tablet a qualquer momento ser√° muito popular.  Para isso, comprei um m√≥dulo <b>Bluetooth</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HM-13</a> .  Este m√≥dulo √© selecionado porque possui SPP al√©m do BLE. <br><br>  Conex√£o: 2 fios UART, 1 fio de status (conectado / n√£o conectado) <br>  Fonte de alimenta√ß√£o: 2.5V - 3.9V <br>  Consumo: 50mA (embora a figura 13mA esteja ao lado da folha de dados. Talvez este seja o valor m√©dio e de pico) <br></li><li>  Como me disseram, n√£o faz sentido manter o receptor ligado se voc√™ apenas se sentar para descansar ou jantar em um caf√©.  Portanto, decidi adicionar o <b>aceler√¥metro</b> MMA8452 e us√°-lo para determinar se o dispositivo est√° em repouso ou se estamos nos movendo para algum lugar. <br><br>  Conex√£o: 2 fios I2C, 1 fio para interrup√ß√£o <br>  Fonte de alimenta√ß√£o de 2V a 3.6V com algum consumo microsc√≥pico <br></li><li>  A faixa do GPS ser√° gravada no <b>cart√£o SD</b> .  Eu j√° tentei usar o cart√£o no modo SPI e isto √©, para dizer o m√≠nimo, lento.  Especialmente no registro.  Modo correto para cart√£o SD - SDIO <br><br>  Conex√£o: 6 fios <br>  Fonte de alimenta√ß√£o: From 1.8V <br>  O consumo √© desconhecido, mas acho que n√£o mais que 20mA <br></li><li>  Para economizar energia, faz sentido desligar a energia dos dispositivos que n√£o est√£o em uso no momento.  T√£o perto de cada consumidor, colocarei um <b>transistor</b> , que controlarei um sinal separado do microcontrolador <br><br>  Conex√£o: 5 sinais, um p√© por consumidor (GPS, Bluetooth, aceler√¥metro, cart√£o SD, tela) <br><br>  UPD com base em coment√°rios.  Desabilitar o aceler√¥metro n√£o faz sentido - ele j√° consome um centavo.  √â prov√°vel que alguns dispositivos sempre funcionem (por exemplo, um cart√£o SD) - no futuro poderei remover esses transistores.  Alguns dispositivos (como GPS) podem desconectar-se sob comando da interface.  Se, de acordo com os resultados do teste, esta parte funcionar bem - eu tamb√©m recusarei um transistor externo.  Enquanto isso, estou fazendo a taxa total m√°xima poss√≠vel, deixe esses transistores serem todos.  Al√©m disso, ainda n√£o decidi sobre a periferia. </li><li>  <b>Um LED de duas cores</b> para exibi√ß√£o de status (que tal sem um LED piscando?).  Seria poss√≠vel colocar um tricolor, mas at√© agora n√£o vejo a necessidade. <br><br>  Conex√£o: 2 pinos <br>  Consumo: 10mA <br></li><li>  Al√©m do Bluetooth, um mecanismo mais cl√°ssico para mesclar faixas ser√° implementado - via <b>USB</b> .  Para isso, ser√£o envolvidas 4 linhas - um par diferencial para dados, 1 pino para detectar que o dispositivo est√° conectado ao USB e outro pino para conex√£o l√≥gica (por que eu preciso desses 2 pinos que descreverei abaixo) <br></li><li>  O apetite vem com a comida.  Desde que comecei a enfiar tudo no dispositivo dos meus sonhos, por que n√£o adicionar um <b>tweeter</b> ?  Bem, ou um <b>motor de vibra√ß√£o</b> .  Ainda n√£o criei um caso de usu√°rio. <br><br>  Conex√£o: 1 fio <br></li><li>  O dispositivo ainda precisar√° estar ligado.  Enquanto o chip PT1502 est√° me olhando como um carregador de bateria de l√≠tio e um <b>controlador de energia</b> .  Para se comunicar com o microcircuito, voc√™ precisar√° usar 2 fios: um para gerenciamento de energia e outro para um sinal de bateria descarregada.  Por uma quest√£o de interesse, ser√° poss√≠vel medir a tens√£o da bateria usando outra linha. <br></li><li>  Obviamente, a carga de uma bateria de l√≠tio √© incorreta para medir com base na tens√£o.  Portanto, adicionei um <b>chip</b> especial <b>para medidor de pot√™ncia INA219</b> <br><br>  Tens√£o de alimenta√ß√£o: 3-5V, recomendo 3.3V <br>  Conex√£o: 2 fios I2C <br><br>  Como ser√° visto abaixo, uma tens√£o de alimenta√ß√£o de 3V cria algum desconforto na conex√£o.  Eu preferiria que o contador do chip fosse alimentado a partir de 2.7V ou inferior.  Mas depois de passar por v√°rias op√ß√µes com base no pre√ßo / caixa / disponibilidade, ainda n√£o encontrei nada em 2,7V.  Serei grato pela ajuda. <br></li><li>  Resta apenas fornecer uma interface de depura√ß√£o <b>SWD</b> (3 fios) e um <b>UART de depura√ß√£o</b> (mais 2 fios) <br></li></ul><br>  Eu sempre estava interessado na quest√£o de por que s√£o necess√°rios controladores com um grande n√∫mero de portas e contei facilmente 39 patas necess√°rias para a minha funcionalidade.  E isso n√£o est√° contando quartzo, redefini√ß√£o e pot√™ncia.  E existem id√©ias para o que fazer com uma d√∫zia a mais (por exemplo, o monitor pode ser conectado via interface paralela Intel 8080 ou Motorola 6800). <br><br>  Obviamente, voc√™ pode parafusar os extratores da porta I2C para reduzir o n√∫mero de pernas usadas.  Mas em primeiro lugar, esses s√£o componentes adicionais na placa, em segundo lugar, a parte do software se torna muito mais complicada e, em terceiro lugar, pequenos microcontroladores ainda t√™m pouca mem√≥ria e, onde h√° mem√≥ria suficiente, h√° tamb√©m portas suficientes.  Portanto, n√£o vejo motivo para complicar tudo - que haja 39 linhas. <br><br><h2>  Nutri√ß√£o </h2><br>  Com a fonte de alimenta√ß√£o, nem tudo √© t√£o claro.  Provavelmente, voc√™ pode alimentar todos os dispositivos de 3,3V e se acalmar.  Mas n√≥s, no entanto, vamos fabricar um dispositivo m√≥vel, o que significa que precisamos pensar em economizar energia.  Ent√£o voc√™ precisa tentar escolher uma tens√£o de alimenta√ß√£o menor.  Abaixo, vou estimar que tipo de economia voc√™ pode tentar alcan√ßar. <br><br>  Aqui est√£o os dados para todos os dispositivos na placa - desta forma, √© mais conveniente escolher o dom√≠nio de energia ao qual conectar este ou aquele dispositivo. <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>Dispositivo</b> </td><td>  <b>Faixa de pot√™ncia</b> </td><td>  <b>Dom√≠nio de energia</b> </td><td>  <b>comunica√ß√£o</b> </td></tr><tr><td>  CPU </td><td>  2 - 3.6V </td><td>  2V </td></tr><tr><td>  Aceler√¥metro </td><td>  2 - 3.6V </td><td>  2V </td><td>  I2C </td></tr><tr><td>  Cart√£o sd </td><td>  1.8V ou 3.6V </td><td>  2V </td><td>  SDIO </td></tr><tr><td>  Exibi√ß√£o </td><td>  1,65 - 3,3V <br>  ou 3 - 5V </td><td>  2V </td><td>  I2C ou SPI </td></tr><tr><td>  GPS </td><td>  2.7 - 5.5V <br>  ou de 1.4V </td><td>  2.7V </td><td>  UART </td></tr><tr><td>  Bluetooth </td><td>  2.5 - 3.9V </td><td>  2.7V </td><td>  UART </td></tr><tr><td>  Medidor de energia (INA219) </td><td>  3 - 5.5V </td><td>  3v </td><td>  I2C </td></tr><tr><td>  Campainha </td><td>  3V - 5V </td><td>  Vbat </td></tr></tbody></table></div><br>  A partir da placa, √© f√°cil ver que alguns dos dispositivos podem operar com voltagens suficientemente baixas (de 1,8V).  Outros podem trabalhar confortavelmente a partir de 2.7V.  Finalmente, os dispositivos restantes abaixo de 3V n√£o podem funcionar.  O squeaker, para o bem, geralmente precisa de 5V, mas para mim ser√° alimentado pela tens√£o mais alta - a partir da bateria, n√£o importa quanto ela seja. <br><br>  Com o poder da tela ainda n√£o est√° totalmente esclarecido.  Na descri√ß√£o dos m√≥dulos de exibi√ß√£o com ali, a faixa √© de 3 a 5V, enquanto na folha de dados do controlador de matriz SSD1309 a faixa √© de 1,65 a 3,3V.  Presumo que seja necess√°rio 3V para girar o conversor de impulso na placa do m√≥dulo de exibi√ß√£o, enquanto 1,65V √© suficiente para a l√≥gica.  Como ser√° visto nas discuss√µes sobre o layout, faz sentido abandonar o m√≥dulo da tela e conectar a tela diretamente, o que alimentar√° a tela a partir do dom√≠nio 2B. <br><br>  Tenho o mesmo racioc√≠nio sobre o GPS - fontes diferentes indicam tens√µes de alimenta√ß√£o diferentes.  At√© o momento, n√£o compreendo qual m√≥dulo utilizarei no final, ent√£o deixe o receptor sair no dom√≠nio de 2,7V. <br><br>  Com um cart√£o SD, n√£o est√° nada claro.  A especifica√ß√£o diz obscuramente que, em geral, o cart√£o deve ser alimentado a partir de 3,3V, mas os cart√µes modernos s√£o inteligentes o suficiente e podem entender que est√£o presos em um dispositivo de baixa tens√£o e podem mudar para 1,8V.  Mas o mecanismo para escolher alimentos n√£o √© muito claro.  Vou alimentar o cart√£o de 2B e ver o que acontece.  N√£o vai funcionar - vai funcionar a partir de 3V. <br><br>  Assim, 4 barramentos de pot√™ncia aparecem - 2V, 2.7V, 3V e uma bateria.  Gostaria de colocar todos os consumidores que est√£o comendo e trabalhando constantemente (e este √© o controlador e o GPS) no barramento de menor tens√£o, mas no momento ainda n√£o decidi sobre o m√≥dulo GPS (e, portanto, sua fonte de alimenta√ß√£o - 2 ou 2,7V), o que significa que ser√° necess√°rio algum tipo de solu√ß√£o universal.  Vou tentar separar a placa para que seja f√°cil aplicar uma ou outra tens√£o. <br><br>  De onde voc√™ tira tantas tens√µes diferentes?  Mesmo nos est√°gios iniciais do projeto, observei o microcircuito PT1502 e at√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">consegui experiment√°-lo em outro projeto</a> .  Al√©m do carregador para a bateria de l√≠tio, este microcircuito possui at√© 3 fontes de energia - um pulso e 2 comutadores lineares.  Aqui, no entanto, a tens√£o n√£o √© regulada em um deles e √© de 3V - tentarei alimentar o INA219 a partir dele.  As 2 fontes de energia restantes n√£o s√£o um problema, porque  L√° voc√™ pode escolher a voltagem. <br><br>  A estimativa de consumo n√£o √© muito bem sucedida.  O pico de consumo √© indicado nas folhas de dados - isso √© suficiente para calcular a pot√™ncia dos principais transistores, mas n√£o o suficiente para estimar a capacidade necess√°ria da bateria.  Por enquanto, selecionarei a bateria com base no espa√ßo dispon√≠vel no gabinete e j√° medirei o consumo real. <br><br>  A quest√£o pode surgir, mas como combinar dispositivos com tens√µes operacionais diferentes?  Vamos acertar. <br><br><ul><li>       Five Volt Tolerant ( UART2   PA2/PA3),      3.3         </li><li>      2,          .     ‚Äî   MMA8452Q         (  ‚Äú‚Äù   ) </li><li> SD       ,   ,      . </li><li> GPS  Bluetooth     ‚Äú‚Äù   .      ‚Äú‚Äù  </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, algumas palavras sobre o motivo de eu estar lutando pela redu√ß√£o da tens√£o de alimenta√ß√£o. </font><font style="vertical-align: inherit;">Um chip em um conversor DC-DC pulsado, que pode trocar volts por amperes (se voc√™ n√£o levar em conta as perdas do pr√≥prio conversor, √© claro). </font><font style="vertical-align: inherit;">Para ser mais preciso, troque uma tens√£o mais alta por uma corrente mais baixa por uma tens√£o mais baixa e uma corrente mais alta. </font><font style="vertical-align: inherit;">Nesse caso, estamos mais interessados ‚Äã‚Äãno racioc√≠nio reverso - se voc√™ alimentar uma carga de baixa tens√£o atrav√©s de DC-DC, o consumo de corrente de toda essa estrutura juntamente com o conversor ser√° menor que o consumo de corrente da pr√≥pria carga. </font><font style="vertical-align: inherit;">Bem, como a capacidade da bateria √© medida em mAh, a redu√ß√£o do consumo atual aumentar√° a vida √∫til da bateria.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conde?</font></font></b> <div class="spoiler_text">   ,        90%,        DC-DC        .  .      ,      DC-DC   . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a> .   900    4.1  3.5 (      ).  DC-DC    90% (   ).    100.            . <br><br> ,      900  100  9 .          ‚Äî 9.3     3.3, 11.4   2.7,   15    2. ,    ,    ,        . <br></div></div><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Microcontrolador </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abordei a quest√£o de escolher um microcontrolador, pensativo - brinquei com o configurador por um longo tempo, ponderando os pr√≥s e os contras de cada uma das op√ß√µes. Eu realmente gostei dos microcontroladores STM32, por isso n√£o vejo o ponto de olhar na dire√ß√£o de outros controladores sem necessidade especial. Al√©m disso, na linha STM32 existem controladores para todos os gostos e para qualquer periferia. A experi√™ncia adquirida nas etapas anteriores do meu projeto nos permite restringir a escolha do controlador com base na lista de perif√©ricos, liga√ß√µes de software j√° escritas, bem como nos recursos que eu gostaria de implementar no futuro.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, √© √≥bvio que 20kb de mem√≥ria do meu STM32F103CB s√£o definitivamente pequenos - n√£o h√° buffers de tamanho decente suficientes para se comunicar com um cart√£o SD e USB. </font><font style="vertical-align: inherit;">Eu nem comecei a implementar grande parte da funcionalidade planejada, mas ela j√° levou mais de 19kb. </font><font style="vertical-align: inherit;">Mas com o poder de processamento, como se viu, isso n√£o √© particularmente necess√°rio. </font><font style="vertical-align: inherit;">Se toda a comunica√ß√£o com perif√©ricos for inserida no DMA, apenas alguns por cento permanecer√£o no compartilhamento do processador central. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tendo estimado a lista do que preciso do controlador, calculei o seguinte:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 128kb flash (atualmente s√£o usados ‚Äã‚Äãcerca de 50k) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40 kb de mem√≥ria (agora s√£o tirados 19k) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40 p√©s de GPIO (veja o racioc√≠nio acima) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40MHz (voc√™ n√£o precisa de muito, o principal √© ter menos consumo) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DMA (eu realmente gostei) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 2x I2C,&gt; = 3x UART,&gt; = 1 SPI </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SDIO (a unidade flash atrav√©s do SPI √© muito lenta) </font></font></li><li>  USB Full Speed,  High Speed </li><li>  (      ) </li><li>       LCD  (         FSMC) </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os microcontroladores STMicroelectornics s√£o apenas uma moeda de dez centavos - para todos os gostos, cores e carteiras. No come√ßo, tentei escolher um controlador para prosseguir com a s√©rie. As r√©guas L0 e F0 s√£o muito fracas e n√£o h√° mem√≥ria suficiente, S7 e H7, pelo contr√°rio, s√£o muito chiques, n√£o h√° SDIO em L4 (UPD: SDIO √©, eles simplesmente n√£o o mencionaram na p√°gina de t√≠tulo da s√©rie). Entre o restante da s√©rie, voc√™ pode escolher algo com base nas minhas necessidades, pois n√£o tenho requisitos espec√≠ficos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A s√©rie STM32WB impressiona com a presen√ßa do Bluetooth, mas o gabinete VFQFPN68 esfria um pouco o desejo de us√°-lo em projetos de hobby. E eu n√£o encontrei esses controladores no varejo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apontei para o gabinete LQFP64 - suficiente no n√∫mero de pernas, mas n√£o muito grande ao mesmo tempo e pode ser soldado em casa. √â bom que exista um configurador CubeMX onde voc√™ possa selecionar o que precisa com filtros. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optei pelo controlador STM32F103RB por tr√™s raz√µes. Primeiro, eu j√° estudei bem a s√©rie F103 com o quadro Blue Pill. Em geral, o controlador STM32F103CB me convinha completamente, apenas a mem√≥ria n√£o era suficiente. Em segundo lugar, eu j√° tenho um gerenciador de inicializa√ß√£o e um c√≥digo de baixo n√≠vel para este controlador, enquanto outros precisar√£o ser refeitos. E em terceiro lugar, h√° cerca de um ano, eu j√° estava feliz em comprar 3pcs STM32F103RB. Ent√£o, n√£o fiz um estudo detalhado dos controladores dispon√≠veis, mas simplesmente peguei um controlador mais grosso da linha F103. N√£o jogue fora agora :)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como j√° observei, n√£o tenho requisitos espec√≠ficos de desempenho ou perif√©ricos. </font><font style="vertical-align: inherit;">Mas se eu encontrar algo, lembre-se de que j√° tenho controladores da linha F4 (se algo mais poderoso for necess√°rio) ou L152RD, se voc√™ precisar decidir algo com consumo (UPD: eu tamb√©m olhei para L433RC). </font><font style="vertical-align: inherit;">O que agrada, com o STM32, quase todos os controladores de pino a pino s√£o compat√≠veis, e F4 e L1 / L4 podem ser soldados quase sem alterar a placa. </font><font style="vertical-align: inherit;">Voc√™ pode at√© coletar e comparar o consumo com diferentes MKs.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Algumas palavras sobre o corpo e o layout </font></font></h2><br>  Decidimos os detalhes.  √â hora de desenhar um diagrama, tra√ßar o quadro e tentar encaix√°-lo no estojo.  Ou n√£o?  Para admitir, no come√ßo eu apenas segui esse caminho, mas depois cheguei √† conclus√£o de que tudo precisa ser feito na ordem inversa.  Bem, ou pelo menos ao mesmo tempo. <br><br>  Eu gostaria de obter um dispositivo compacto.  Para isso, √© necess√°rio entender com precis√£o o tamanho do espa√ßo dispon√≠vel, por sua vez, para entender onde colocar a placa e seu tamanho, qual o tamanho da bateria, onde colocar os bot√µes, a tela, o conector USB e outros componentes externos, al√©m de descobrir como montar os componentes e voc√™ pode se √© conveniente colocar fios entre eles.  √â simplesmente in√∫til come√ßar a levantar um quadro sem entender todas essas coisas.  Acontece que voc√™ precisa primeiro lidar com o corpo e o layout e depois seguir para o circuito. <br><br>  Al√©m disso, no processo de desenhar o caso, tive que revisar a sele√ß√£o de componentes v√°rias vezes.  Ent√£o, inicialmente, pensei em usar uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tela barata de 128x64 de 0,96 ‚Äù</a> (√°rea de trabalho 21,7 x 11,2 mm), mas essa tela parecia completamente microsc√≥pica no fundo de uma caixa muito maior.  Em seguida, foi encomendada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma tela de 1,3 "</a> (√°rea de trabalho 29,4 x 14,7 mm), mas n√£o ficou muito melhor.  Ent√£o, obtive <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma tela de 1,54 ‚Äù</a> (35 x 17,5 mm) - parece mais ou menos normal com ela.  Esta √© atualmente a principal op√ß√£o de trabalho. <br><br>  De acordo com as estimativas, uma tela de 1,8 ‚Äù-2‚Äù teria parecido melhor, mas elas j√° v√™m em cores e com resolu√ß√£o mais alta e, portanto, o buffer da tela ser√° grande o suficiente para o meu controlador (35kb em vez de 1kb).  Bem, inserir telas grandes no gabinete tamb√©m pode ser um problema, porque  os suportes de aterrissagem para esses m√≥dulos s√£o significativamente maiores que a √°rea ativa da tela. <br><br>  Enquanto eu escrevia este artigo em todos, os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">monitores monocrom√°ticos de 2,42 "</a> apareceram com a mesma resolu√ß√£o (128x64) e exatamente a mesma encaderna√ß√£o de 1,54".  Encomendei um para o meu teste - h√° uma chance de coloc√°-lo no meu caso sem um aumento significativo no dispositivo. <br><br>  Outro ponto significativo na fase de trabalho do gabinete foi o entendimento de que o m√≥dulo de tela adquirido ocupa muito espa√ßo e reduz significativamente o espa√ßo da placa principal.  Portanto, decidi abandonar o m√≥dulo de exibi√ß√£o final e, em vez disso, coloquei a exibi√ß√£o e sua liga√ß√£o na minha placa.  O n√∫mero de pe√ßas no circuito aumentou um pouco, mas o design como um todo foi significativamente simplificado e tornou-se mais compacto. <br><br>  Eu tenho pensamentos semelhantes sobre o t√≥pico do m√≥dulo GPS.  N√£o √© t√£o grande, mas n√£o importa o tamanho ou a interfer√™ncia, ou a antena est√° fechada por alguma bateria.  Pode ser uma boa ideia colocar o recheio do m√≥dulo na sua placa e colocar a antena em outro lugar. <br><br>  O trabalho no gabinete tamb√©m possibilitou determinar o tamanho e a capacidade da bateria.  No volume dispon√≠vel, uma bateria de 900mAh foi encontrada - vamos nos concentrar nela.  Gostaria que meu dispositivo funcionasse com uma bateria de 15 a 20 horas, o que significa que o consumo deve estar no n√≠vel de 45-60mA. <br><br>  No momento, n√£o posso terminar o trabalho no casco.  Em primeiro lugar, a quest√£o da escolha de alguns componentes (tela, GPS) ainda est√° em aberto.  Em segundo lugar, n√£o est√° claro se meu circuito come√ßar√° em princ√≠pio ou se ser√° necess√°rio mudar radicalmente alguma coisa.  E, em terceiro lugar, a placa √© compacta demais - n√£o tenho certeza de que posso dissolv√™-la, solda e depur√°-la.  Portanto, neste artigo ainda vou me concentrar em quest√µes de circuitos, seguirei em etapas mais simples e compreens√≠veis e falarei sobre o caso na pr√≥xima vez.  Aqui voc√™ tem algumas renderiza√ß√µes e fotos para sementes. <br><br><img src="https://habrastorage.org/webt/4j/ff/l-/4jffl-arvuselp1d93s5muqazqy.png"><br><br><img src="https://habrastorage.org/webt/o2/a9/ve/o2a9vejujirpcxe634dzikwqc0e.png"><br><br><img src="https://habrastorage.org/webt/a9/hu/ka/a9huka9xfxi-g0wegdzhb8ezonm.jpeg"><br><br><img src="https://habrastorage.org/webt/az/nl/b2/aznlb21azpqtsfgoaim0occrvgc.jpeg"><br><br><h2>  Esquema </h2><br>  Agora voc√™ pode fazer eletr√¥nicos.  Descreverei as solu√ß√µes de circuitos com detalhes suficientes.  Primeiro de tudo, para os mesmos rec√©m-chegados em eletr√¥nica que eu sou, bem como uma sinopse para mim.  Engenheiros eletr√¥nicos experientes podem percorrer os circuitos e retroceder para a pr√≥xima se√ß√£o. <br><br>  Vamos come√ßar com nutri√ß√£o. <br><br>  O dispositivo ser√° alimentado por uma bateria de l√≠tio, o que significa que voc√™ precisa de um controlador de carregamento.  Al√©m disso, alguns componentes t√™m um limite superior de tens√£o de cerca de 3,6V, enquanto uma bateria pode facilmente acabar com mais de 4V.  Ent√£o, voc√™ precisa de uma fonte de energia reduzida.  Como j√° descobrimos, precisaremos de v√°rias tens√µes diferentes. <br><br>  Eu j√° mencionei que vou usar o chip PT1502.  Cabe bem, porque  implementa um controlador de carregamento, 3 fontes de energia e um circuito de dispositivo de comuta√ß√£o de bot√£o.  O microcircuito cont√©m v√°rios blocos funcionais, que dividi no diagrama para maior clareza.  O circuito em si √© um circuito de folha de dados ligeiramente revisado.  Aqui est√° o controlador de carga da bateria de l√≠tio <br><br><img src="https://habrastorage.org/webt/7y/p7/sk/7yp7skuez7vcdpdzr33f6rhtfk4.png"><br><br>  O resistor R3 define a corrente de carga.  Por padr√£o, isso corresponde a 470mA.  Talvez de acordo com os resultados do teste, reduzirei o valor desse resistor para 510 Ohms, o que fornecer√° uma corrente de carga de cerca de 900mA (1C). <br><br>  O controlador pode relatar o modo de carga atual com o p√© CHG_STAT.  Al√©m disso, ele sabe dar sinais at√© 3 - est√° carregando, n√£o est√° carregando e j√° foi carregado, mas ainda est√° conectado √† tomada.  Na primeira vers√£o, o transistor interno pressiona o p√© no ch√£o e isso pode ser facilmente reconhecido pelo controlador.  Na segunda modalidade, o transistor √© completamente fechado e a perna entra em um estado de alta imped√¢ncia.  Usando uma energiza√ß√£o, esse sinal tamb√©m √© f√°cil de ler pelo controlador. <br><br>  Mas com o terceiro estado n√£o √© t√£o simples.  L√°, o transistor est√° entreaberto e uma corrente de 20 ŒºA flui atrav√©s dele.  Para considerar tal condi√ß√£o, fui solicitado a escolher um elevador para que cerca de metade da nutri√ß√£o estivesse na minha perna.  Ent√£o ser√° poss√≠vel detectar facilmente esse estado usando o ADC.  Usando a lei de Ohm, obtemos R5 = 1V / 20mkA = 50k. <br><br>  Como eu disse, o chip PT1502 n√£o √© apenas um carregador, mas tamb√©m um controlador complicado para toda a energia.  O microcircuito monitora as tens√µes no circuito e, usando o sinal RESET, pode controlar o processador principal (eles dizem que voc√™ ainda precisa inicializar cedo, a energia ainda n√£o se estabilizou). <br><br><img src="https://habrastorage.org/webt/21/z3/f1/21z3f1tkkpvqsph462qukz0_anu.png"><br><br>  Al√©m disso, o microcircuito pode iniciar o dispositivo com o toque de um bot√£o (BTN1) e tamb√©m, mediante um sinal do microcontrolador (PWR_HOLD), concluir a opera√ß√£o e desligar a energia.  Bem, para sinalizar ao processador que a bateria est√° ficando sem sinal BAT_LOW. <br><br>  E esta √© a principal fonte de energia. <br><br><img src="https://habrastorage.org/webt/nb/5x/tc/nb5xtc2txxl98wz1pfwgmzsr49u.png"><br><br>  A tens√£o de sa√≠da √© definida pela tens√£o no terminal BUCKFB e √© definida como 2V com energia da bateria.  Mas com energia de dois volts, um problema foi descoberto - o USB n√£o funcionar√°.  I.e.  a bateria ser√° carregada, mas n√£o ser√° capaz de transmitir dados - o microcontrolador simplesmente n√£o pode transmitir sinais para um barramento USB de amplitude suficiente.  Datashit recomenda uma tens√£o de pelo menos 2,7V, melhor que 3,3V. <br><br>  Para n√£o bloquear outra fonte de energia e pensar em como alternar entre elas, decidi apenas ajustar a propor√ß√£o do divisor R1 / R4 + R7.  Com essa inclus√£o, o impulso opera continuamente.  Assim que o dispositivo √© conectado ao USB, o transistor se abre e desvia o R7.  A propor√ß√£o dos resistores de acionamento muda e obtemos 3,16V na sa√≠da (ainda podemos jogar com as classifica√ß√µes e sustentar at√© 3,3V). <br><br>  O PT1502 tamb√©m possui 2 controles lineares. <br><br><img src="https://habrastorage.org/webt/1c/s0/tj/1cs0tjf8eerkuske4_dyqithygm.png"><br><br>  Os componentes de baixo consumo (INA219) ou de curta dura√ß√£o (bluetooth) ser√£o conectados a esses controladores; portanto, a efici√™ncia dessas fontes n√£o ser√° um problema.  A tens√£o de alimenta√ß√£o do LDO2 pode ser ajustada usando os sinais LDO2_SETx. <br><br>  Como ainda tenho d√∫vidas em aberto sobre a tens√£o de alimenta√ß√£o, decidi separar os jumpers para selecionar o modo LDO2_SETx.  Al√©m disso, para poder medir o consumo real no barramento correspondente, tamb√©m levo o jumper JP1 / JP2 / JP3 ao pente. <br><br>  Terminando o t√≥pico das fontes de alimenta√ß√£o, precisamos mencionar a pot√™ncia da tela.  Escrevi um pouco mais alto que, em nome da compacidade, tive que abandonar o m√≥dulo de tela adquirido e pegar a tela com as tiras na placa.  Esta tela requer um conversor de impulso especial de 7-16V.  Convenientemente, esta fonte pode ser ligada e desligada usando o sinal EN.  O circuito em si √© copiado da folha de dados do booster, exatamente o mesmo √© usado nos m√≥dulos de exibi√ß√£o com todos. <br><br><img src="https://habrastorage.org/webt/oi/bd/zm/oibdzmvkie49fxcjamxcvszh9gw.png"><br><br><div class="spoiler">  <b class="spoiler_title">PT1505</b> <div class="spoiler_text">  Navegando na Internet em busca de alternativas ao chip PT1502, me deparei com sua irm√£ mais velha - o chip PT1505.  √â quase o mesmo controlador de energia, mas com uma atualiza√ß√£o adicional.  Com esse controlador, seria poss√≠vel reduzir o n√∫mero de elementos no quadro.  Infelizmente, n√£o encontrei chips PT1505 √† venda. <br><br>  A prop√≥sito, ficarei grato se voc√™ conhecer controladores de energia semelhantes de outros fabricantes. <br></div></div><br>  Agora um pouco sobre o poder do microcontrolador.  O microcircuito √© grande e possui 6 linhas de energia - 4 para a parte digital, 1 fonte de alimenta√ß√£o anal√≥gica e uma para o rel√≥gio.  De acordo com a folha de dados do STM32F103, em todas as linhas de energia (talvez, exceto no rel√≥gio), deve haver um capacitor de 100nF ao longo do capacitor e outro comum em 4,7uF. <br><br>  Mas na folha de dados do STM32F4, diz-se que, embora os microcontroladores sejam praticamente compat√≠veis em termos de sa√≠das, eles ainda possuem esquemas de energia um pouco diferentes.  Portanto, nos dois terminais, deve haver capacitores de 2,2 mkF entre o terminal e o terra (e n√£o entre o terra e a energia, como em F1).  Portanto, eu tive que considerar as duas op√ß√µes e um microcontrolador espec√≠fico para soldar apenas parte dos capacitores. <br><br><img src="https://habrastorage.org/webt/vv/ai/a4/vvaia45dk-cjpdj9jrypfecczug.png"><br><br>  Continuando o t√≥pico da nutri√ß√£o, voc√™ precisa descobrir como medi-la.  Voc√™ pode confiar no sinal BAT_LOW e solicitar ao usu√°rio que se enrole rapidamente se a bateria estiver fraca.  Mas √© exatamente isso que eu n√£o gostei no Holux M-241 original, porque  esse sinal apareceu tarde demais e foi f√°cil perder.  Preciso de algum tipo de indicador mais informativo de energia da bateria. <br><br><img src="https://habrastorage.org/webt/2r/6l/0g/2r6l0gd1bdyewq--m8zij_nugxs.png"><br><br>  Por precau√ß√£o, coloquei o divisor mais comum para medir a tens√£o da bateria.  Mas no caso de baterias de l√≠tio, este √© apenas um indicador informativo e n√£o deve ser invocado.  Para leituras mais honestas da bateria na Internet, eles sugerem o uso de um "pendente". <br><br><img src="https://habrastorage.org/webt/an/3u/nc/an3uncm2tjzd-pu3n6ns8vqnhz0.png"><br><br>  Este pequeno microchip conta a quantidade de energia que passou por ele de ou para a bateria.  As medi√ß√µes s√£o feitas no desvio R10.  As leituras do microcircuito podem ser lidas atrav√©s do I2C.  O microcircuito √© capaz de medir a tens√£o na bateria, a corrente que passa atrav√©s do resistor e tamb√©m multiplicar uma pela outra.  Infelizmente, ela n√£o sabe como acumular o valor das horas que passaram por Watt *; portanto, ter√° que fazer uma pesquisa constante. <br><br>  Vamos para a parte digital.  O cora√ß√£o de todo o sistema √© o microcontrolador STM32F103RB. <br><br><img src="https://habrastorage.org/webt/hm/ws/ma/hmwsma-hii28gwjrskmvmfsytl4.png"><br><br>  A fita na forma de dois quartzo foi retirada de outros esquemas encontrados na Internet (verificados duas vezes na folha de dados).  Eu n√£o preciso inicializar a partir da RAM, mas porque o sinal BOOT1 puxou para o ch√£o.  O BOOT0 pode ser selecionado com um jumper para inicializar a partir da mem√≥ria flash principal ou do carregador de inicializa√ß√£o UART integrado (por exemplo, para o firmware principal do dispositivo) <br><br>  Em seguida √© o LED. <br><br><img src="https://habrastorage.org/webt/ja/bg/ah/jabgahdeoppmxzipfiqu5mpd9dq.png"><br><br>  Como a tens√£o de alimenta√ß√£o principal varia de 2 a 3,3V, os LEDs n√£o devem ser conectados a ela - o brilho e o consumo de corrente variam muito.  Portanto, os LEDs I ser√£o conectados ao barramento de 2,7V, os resistores limitadores de corrente s√£o calculados de acordo.  Como o microcontrolador n√£o ser√° capaz de fornecer mais de 2V em seu p√© quando alimentado por uma bateria, o modo push-pull do GPIO n√£o pode ser usado.  Somente dreno aberto. <br><br>  N√£o h√° nada de especial a dizer sobre o bot√£o de redefini√ß√£o. <br><br><img src="https://habrastorage.org/webt/6x/eq/is/6xeqise0ghoatscub44uzcykfoq.png"><br><br>  Como um dispositivo de tr√™s volts (INA219) estar√° no barramento I2C, voc√™ tamb√©m precisar√° usar chaves de tr√™s volts <br><br><img src="https://habrastorage.org/webt/xj/yi/n7/xjyin76yz6g_sg7vo9t2s4eqrms.png"><br><br>  Um conector SWD tamb√©m √© padr√£o.  √â necess√°rio um diodo para alternar a energia entre a bateria e a energia externa do programador. <br><br><img src="https://habrastorage.org/webt/vl/s7/pw/vls7pw9grlfznf3gfo1_yglclqw.png"><br><br>  Antecipando as exclama√ß√µes de que eles n√£o fazem isso e que essa conex√£o realmente n√£o desconecta a bateria.  Sim, ele n√£o desliga, mas o diodo n√£o √© para isso.  Isso √© necess√°rio para poder alimentar o dispositivo do programador se a bateria n√£o estiver conectada.  E se estiver conectado, deixe funcionar.  Bem, se a bateria estiver conectada, voc√™ precisar√° proteger o pr√≥prio programador de 4,2V na bateria. <br><br>  Mas os bot√µes devem residir em mais detalhes. <br><br><img src="https://habrastorage.org/webt/gg/du/gi/ggdugivqqx7iqjimaqwkbsiehru.png"><br><br>  O fato √© que o primeiro bot√£o n√£o ser√° apenas um bot√£o, mas tamb√©m funcionar√° como uma chave de dispositivo - o sinal BTN1 √© conectado ao chip do controlador de energia PT1502.  Quando o dispositivo √© desligado, a energia n√£o √© fornecida ao microcontrolador e a outros consumidores.  √â por isso que o bot√£o est√° conectado n√£o √† energia (VCC), mas √† bateria (BAT).  Pressionando este bot√£o, o PT1502 liga todas as fontes de energia e inicia o microcontrolador.  Depois disso, o bot√£o pode funcionar como um bot√£o normal.  Para n√£o queimar o microcontrolador com uma alta tens√£o da bateria, constru√≠ um pequeno divisor de tens√£o que direciona o sinal BTN1 para os quadros necess√°rios (no entanto, √© poss√≠vel sem isso - o microcontrolador possui entradas tolerantes a 5V) <br><br>  O segundo bot√£o n√£o √© digno de nota.  Dentro do processador, uma tra√ß√£o no ch√£o ser√° inclu√≠da e o bot√£o alimentar√° uma unidade na linha ... <br><br>  Passe sem problemas para a periferia pesada.  USB <br><br><img src="https://habrastorage.org/webt/hj/vn/tg/hjvntgq_-3sjzwjv03t0dqd--gg.png"><br><br>  O conector USB fica preso no dispositivo e a eletricidade est√°tica pode caminhar at√© l√°.  Acontece que existem microcircuitos especiais (como o STF202-22) que protegem os microcontroladores de influ√™ncias externas. <br><br>  Mas algo mais √© interessante aqui.  Um resistor de 1,5k est√° oculto dentro do chip STF202, que √© conectado entre a perna VBUS e a linha D +.  Esse resistor √© necess√°rio de acordo com a especifica√ß√£o USB - informa ao host que ele est√° preso em algo.  Em muitos circuitos, esse resistor est√° sempre conectado entre a alimenta√ß√£o e a linha D +.  Assim que o host v√™ esse resistor na linha D +, ele imediatamente come√ßa a se comunicar com o dispositivo.  Isso nem sempre √© apropriado, pois  Alguns dispositivos podem n√£o estar imediatamente prontos para a comunica√ß√£o. <br><br>  Este √© apenas o meu caso.  Existe um truque simples para isso (espionado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ).  Voc√™ pode ativar e desativar esse resistor usando um transistor: queremos comunica√ß√£o - ligamos o resistor, queremos apenas ser alimentados por USB - desligue-o.  Quando voc√™ coloca seu celular em USB, ele geralmente pergunta ‚Äúo que faremos?  Mesclagem de dados ou apenas cobran√ßa? ‚Äù  - em termos de eletr√¥nica, trata-se apenas de conectar um resistor de pull-up. <br><br>  Mas como voc√™ sabe se um dispositivo est√° preso no USB?  Para fazer isso, forneci o sinal USB_PLUGGED, que √© removido do divisor mais simples. <br><br><img src="https://habrastorage.org/webt/hx/lr/u5/hxlru5qf7wv13uxeseybbyhhpdi.png"><br><br>  5V do USB tamb√©m podem ser alimentados diretamente no p√© do microcontrolador - eles ainda s√£o tolerantes a 5V.  Mas deixe-o j√° atrav√©s do divisor. <br><br>  Aceler√¥metro agora <br><br><img src="https://habrastorage.org/webt/-g/t1/5j/-gt15jf_cub3nubnrpsbr5hiusa.png"><br><br>  O esquema √© retirado de uma folha de dados.  O m√≥dulo √© conectado via I2C, mas, para sinalizar ao microcontrolador que h√° novidades, tamb√©m √© usada uma linha de interrup√ß√£o.  Al√©m disso, como o INA219 de tr√™s volts ainda est√° pendurado no mesmo barramento I2C, as pernas de comunica√ß√£o do aceler√¥metro tamb√©m s√£o alimentadas pelo barramento 3B para coordenar os n√≠veis. <br><br>  Eu j√° mencionei que gostaria de economizar energia e desligar aparelhos n√£o utilizados.  Portanto, a energia do aceler√¥metro √© ligada pelo transistor. <br><br>  A prop√≥sito, gostei muito do chamado  transistores digitais - um transistor completo com dois resistores.  Isso economiza um pouco de espa√ßo no quadro.  √â uma pena que, com energia de dois volts, eu n√£o consegui pegar um transistor digital com pelo menos alguma corrente decente - 20-30 mA no m√°ximo.  Portanto, consumidores mais vorazes precisavam estar conectados aos MOSFETs. <br><br>  V√° em frente GPS <br><br><img src="https://habrastorage.org/webt/vr/l-/hm/vrl-hm0a27os6lit3ont256xd1g.png"><br><br>  O GPS est√° localizado em uma placa separada e √© conectado atrav√©s de um loopback.  Como ainda n√£o decidi o m√≥dulo GPS, forneci 2 fontes de alimenta√ß√£o diferentes.  Al√©m do transistor de pot√™ncia no lado da placa do processador, n√£o h√° nada mais interessante. <br><br>  Vou apenas dizer algumas palavras sobre os UARTs.  Inicialmente, planejei usar todos os 3 - um para upload de firmware e depura√ß√£o, o segundo para GPS e o terceiro para Bluetooth.  Mas o UART3 est√° nos mesmos pinos que o I2C No. 2, que eu originalmente planejava usar para a tela.  Eu tive que escolher  Como resultado, cheguei √† conclus√£o de que posso fazer upload de firmware e depurar atrav√©s do mesmo UART reservado para GPS (√© claro, o GPS ter√° que ser desativado).  Bem, se voc√™ precisar estrear o pr√≥prio GPS, ou seja, USB CDC (no qual voc√™ pode fazer upload de logs) e SWD.  Um pouco mais tarde, abandonei a ideia de usar o I2C No. 2, para que o UART3 se libertasse, mas em nome da economia de bateria, decidi me concentrar em dois UARTs. <br><br>  Bluetooth <br><br><img src="https://habrastorage.org/webt/r2/m6/zt/r2m6ztztpabt1_2yprjrdava5nq.png"><br><br>  O Bluetooth √© conectado de acordo com o esquema da folha de dados.  O pino PIO1 pode operar em dois modos.  No primeiro, um LED est√° conectado a ele e o m√≥dulo pisca com esse LED.  Piscadelas diferentes significam status diferente.  Em outro modo, esse pino funciona como digital - quando a comunica√ß√£o √© estabelecida e 0, se n√£o.  Os modos s√£o alternados pelos comandos AT durante a inicializa√ß√£o do m√≥dulo. <br><br>  Cart√£o SD <br><br>  Embora o esquema de conex√£o do cart√£o SD seja padr√£o, por algum motivo, foi muito dif√≠cil para mim.  Existem muitas op√ß√µes de conex√£o diferentes na Internet e n√£o √© t√£o f√°cil descobrir qual √© a correta. <br><br><img src="https://habrastorage.org/webt/9g/mi/xh/9gmixhnhcfhlo0s98wcmfz1dubk.png"><br><br>  Na maioria das vezes, eu tinha perguntas em buchas.  Ocasionalmente, existem esquemas onde eles colocam resistores em 1k.  Alguns circuitos colocam resistores de 22 Ohm, aparentemente como prote√ß√£o contra est√°tica.  No entanto, a maioria dos circuitos n√£o oferece resistores de passagem, e provavelmente vou seguir o mesmo caminho.  Eu tamb√©m n√£o vou ter est√°tica desde  A unidade flash ficar√° dentro do gabinete. <br><br>  Parece-me que o transistor de pot√™ncia tamb√©m n√£o ser√° procurado, acho que o cart√£o sempre funcionar√° - √© um registrador.  Mas como essa √© uma placa de teste, deixe estar.  O mesmo aconteceu com a bobina - aparentemente essa inclus√£o no original foi feita paran√≥ica ou o cart√£o foi usado em um ambiente com pouca energia ou interfer√™ncia.  Eu acho que solda l√° um resistor zero e tenta sem uma bobina. <br><br>  Exibi√ß√£o <br><br>  Tive a oportunidade de conectar um dos m√≥dulos de exibi√ß√£o a todos via SPI e comparar com a conex√£o via I2C.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o houve dificuldades particulares e o c√≥digo s√≥ precisava ser desperdi√ßado um pouco. Ao mesmo tempo, a velocidade do SPI √© uma ordem de magnitude superior √† do I2C. Depois de adicionar os dados da folha de dados sobre consumo (4 mA para SPI versus 10 mA para I2C), a necessidade de resistores pull-up para I2C, decidi conectar o monitor via SPI. </font></font><br><br><img src="https://habrastorage.org/webt/zn/zx/yh/znzxyhs4tcmv4fyyhb-hfxzihns.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infelizmente, o sinal BS0 n√£o √© emitido para o loop da tela e, portanto, voc√™ n√£o pode selecionar o modo SPI de 3 fios, apenas o SPI de 4 fios. A diferen√ßa na linha D / C adicional (dados / comando), que no caso do modo 3 fios √© transmitida pelo nono bit dos dados SPI. No entanto, talvez o modo 4 fios seja melhor, porque O SPI no STM32 pode transmitir apenas 8 bits. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O restante do esquema corresponde √† folha de dados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E, finalmente, o squeaker. Nada de especial - basta ligar o transistor.</font></font><br><br><img src="https://habrastorage.org/webt/b9/nk/9u/b9nk9uzbod6oeswokssk4nhfvsq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caso haja um vibromotor em vez de um tweeter, forneci um diodo de prote√ß√£o. </font><font style="vertical-align: inherit;">No entanto, ouvi a opini√£o de que um diodo de prote√ß√£o tamb√©m n√£o prejudica o tweeter.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Em ferro </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acima, descrevi meus pensamentos sobre o assunto do corpo. Na verdade, eu at√© tentei criar uma placa para este caso. Infelizmente, o quadro estava muito apertado. Eu tive que usar a instala√ß√£o frente e verso, mudar dos componentes 1206 para 0805, mas, mesmo assim, os componentes na placa estavam muito apertados. Al√©m disso, todas as mudan√ßas no esquema foram dolorosas, porque Eu tive que recriar quase metade do placar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por isso, brinquei com ela por v√°rias semanas, mas o conselho me derrotou e abandonei o projeto por quase um ano. Pontap√© tornar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui neste artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mas, na verdade, este √© apenas um prot√≥tipo e o primeiro de v√°rios. Por que se preocupar com uma placa super compacta, onde voc√™ n√£o pode rastejar com um ferro de solda ou um oscilosc√≥pio, se voc√™ pode depurar tudo em uma placa grande?</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, voc√™ n√£o precisa criar uma placa t√£o grande como um iPhone, mas √© bem poss√≠vel acessar as camadas promocionais de 100x100mm 2 do JLCPCB. </font><font style="vertical-align: inherit;">Voc√™ pode praticamente se limitar. </font><font style="vertical-align: inherit;">Portanto, na placa h√° uma enorme tela de 2,42 ‚Äù, jumpers para medir o consumo em todas as linhas de energia, capacitores de energia onde voc√™ precisa e n√£o precisa e, em geral, um monte de pe√ßas que n√£o podem ser instaladas. </font><font style="vertical-align: inherit;">Ainda h√° um lugar.</font></font><br><br><img src="https://habrastorage.org/webt/nm/ig/vr/nmigvrrichuyvfy4vddfogpnquu.png"><br><br><img src="https://habrastorage.org/webt/sr/cy/ed/srcyeditmbixylghywsn15j-qas.png"><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est√° no Photo View</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/d-/co/ru/d-coru_uwsrkpvz44tirfmisedg.png"><br><br><img src="https://habrastorage.org/webt/5w/pq/xk/5wpqxktdsgqt1auvgeh4wnhbaz4.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o h√° muito a dizer sobre a fia√ß√£o. Dividi a maioria das linhas de sinal e campo ao longo da camada superior, enquanto a inferior estava quase completamente enterrada no subsolo. Infelizmente, o layout ainda era bastante denso e algumas linhas de sinal precisavam ser arrastadas ao longo da camada inferior por metade do painel. Por esse motivo, a terra √© "rasgada" em alguns lugares em v√°rias ilhas pouco conectadas. Espero que isso n√£o seja um problema. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu n√£o fiz a terra sob a antena bluetooth, mas ainda assim tive que arrastar uma das linhas de sinal por essa zona. No entanto, esta √© a linha BT_ON, ao longo da qual os sinais geralmente n√£o s√£o executados (√© ligado ou desligado l√°), o que significa que n√£o deve afetar particularmente o sinal.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O ver√£o estava chegando e eu estava planejando levar o aluguel comigo de f√©rias. Para que empregadas dom√©sticas em hot√©is n√£o tenham medo de uma placa de depura√ß√£o simples com um ventilador de fios, seria bom escond√™-la no caso. N√£o pude negar a mim mesma o prazer e desenvolvi o caso e o conselho ao mesmo tempo. Portanto, havia placas de montagem no gabinete, montando o suporte da tela. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O m√≥dulo GPS √© um sandu√≠che de v√°rias placas e uma antena de 12 mm de espessura. Decidi n√£o prend√™-lo em cima do tabuleiro, mas coloc√°-lo no mesmo n√≠vel. Isso reduziu a espessura da caixa, mas cortou um canto do quadro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algumas fotos do quadro e o dispositivo final (nesta fase do projeto). </font></font><br><br><img src="https://habrastorage.org/webt/sr/yk/-g/sryk-gs6dpsw3cjk4mx7fhj4khw.jpeg"><br><br><img src="https://habrastorage.org/webt/i7/hm/im/i7hmimruqywcfpkw9q5qudxkyog.jpeg"><br><br><img src="https://habrastorage.org/webt/r_/wo/bj/r_wobjeewfmg8fohrp_nmehi1c4.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bateria se encaixa bem embaixo da tela, mas tive que fazer uma pequena caixa para elevar a tela para mais perto da tampa superior.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algumas palavras no quadro de montagem. Eu soldava tudo em cerca de tr√™s noites e, cerca de uma semana √† noite, levava tempo para depurar e verificar do lado do software. Para minha surpresa, n√£o houve dificuldades fundamentais na cria√ß√£o do quadro e quase tudo come√ßou como deveria. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verificou-se que a soldagem 0805 n√£o era muito mais dif√≠cil de soldar do que 1206, √© bastante comest√≠vel em casa com uma lupa. Voc√™ pode at√© balan√ßar em 0603. Mas com a solda do microcontrolador e o conector da tela (eles t√™m um passo de 0,5 mm), tive que mexer. No YouTube, de alguma forma, parece com as pessoas - eu apenas gastei com um ferro de soldar e √© isso, mas todas as minhas conclus√µes ficaram instantaneamente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o sem pequenos problemas. Em alguns lugares n√£o havia bebida, em algum lugar havia um ‚Äúranho‚Äù. A pegada do conector USB estava errada - ele tirou algumas conclus√µes menos do que o necess√°rio (portanto, confie na pegada da Internet!). Eu tive que dobrar as conclus√µes um pouco para que elas se tornassem nos trilhos. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O conector do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> monitor </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">FPC</font></a><font style="vertical-align: inherit;"> comprado em Ali acabou por estar com os contatos abaixo, enquanto eu precisava dos contatos na parte superior (eu nunca suspeitava dessa diferen√ßa antes). Eu tive que "explodir" o conector da placa de v√≠deo padr√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois de colocar a placa no estojo, descobriu-se que n√£o era poss√≠vel desconectar a bateria simplesmente puxando o conector, mas eu n√£o queria deixar a placa depurada energizada. Eu tive que apertar um bot√£o.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao instalar a placa, descobriu-se que n√£o h√° contato com o solo em nenhum lugar em que voc√™ pudesse conectar a sonda ao oscilosc√≥pio. Eu tive que me agarrar ao conector USB com um crocodilo. Ser√° necess√°rio fornecer locais de teste na pr√≥xima vers√£o do quadro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os circuitos tamb√©m revelaram problemas. Portanto, era um fato completamente inesperado que o chip PT1502 no pino RESET gerasse uma tens√£o de 3V (eu tinha certeza absoluta de que havia algo como um coletor aberto). Como resultado, esses 3Vs vazaram para a linha de energia, mesmo que eu planejasse ter apenas 2V l√°. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° um diagrama simplificado do que aconteceu. </font></font><br><img src="https://habrastorage.org/webt/ag/rw/tg/agrwtgjika-hvgzl_die2gokf4c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gra√ßas √† grande mente e aos caras do easyelectronics.ru, essa junta foi decidida adicionando um diodo. Ap√≥s uma pequena cirurgia, essa parte funcionou como deveria.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, o m√≥dulo bluetooth (alimentado por 2,5V) conectei acidentalmente √† energia principal (2V), em vez dos 3V fixos. Agora, o bluetooth pode funcionar para mim apenas quando o USB est√° conectado, quando a tens√£o da energia principal sobe para 3.3V. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em princ√≠pio, seria poss√≠vel acenar com o bisturi e soldar o bluetooth na pot√™ncia correta, mas o UART2 ao qual o bluetooth est√° conectado n√£o √© tolerante a 5V (ele mesmo o leu na folha de dados na fase de an√°lise, ele pr√≥prio observou isso no texto acima e acabou se esquecendo ao conectar a placa ) Portanto, conectar o bluetooth √† energia √© maior do que a pot√™ncia do microcontrolador √© dif√≠cil ... Na pr√≥xima vers√£o da placa, eu apenas conectei o bluetooth a algum outro UART.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O conversor DC-DC com tens√£o vari√°vel tamb√©m funcionou conforme o planejado - quando alimentado por uma bateria, ele fornece 2V e quando voc√™ conecta o USB sobe para 3,16V (voc√™ precisa brincar com as classifica√ß√µes e atingir 3,3V). Mas aqui mais uma falha do circuito surgiu: voc√™ tamb√©m precisa aumentar a tens√£o quando alimentado pelo programador. Eu acho que isso est√° sendo tratado adicionando outro diodo. Vou tentar jogar um pouco mais tarde.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, durante o trabalho no quadro, ainda n√£o entendi como alimentar adequadamente o cart√£o SD contra subtens√£o. Uma pesquisa r√°pida no Google n√£o levou a nada. Aparentemente, voc√™ precisa mergulhar na leitura de especifica√ß√µes de p√°ginas restritas (que, al√©m disso, est√£o parcialmente fechadas). Enquanto isso, curto-circuito no R7 e a placa agora √© alimentada por 3,16V (3,3V) fixos. Vou deixar assim pelos pr√≥ximos meses, enquanto trabalharei na parte do software. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falando em software. Surpreendentemente (embora bastante esperado), mas em geral tudo come√ßou sem problemas. Como alternei entre microcontroladores da mesma s√©rie (do F103CB para o F103RC), n√£o precisei alterar a parte do software. Apenas corrigimos os n√∫meros dos pinos, mas adicionamos a inclus√£o de transistores. No entanto, houve dois momentos n√£o triviais com os quais tive que mexer.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O primeiro √© a energia da bateria. </font><font style="vertical-align: inherit;">Eu depurei a placa usando a alimenta√ß√£o USB e tudo funcionou bem em geral. </font><font style="vertical-align: inherit;">Mas o conselho persistentemente n√£o quis ligar a bateria.</font></font> I.e.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele pode funcionar (se voc√™ lig√°-lo quando o USB estiver conectado e, em seguida, puxar o cabo), mas n√£o funciona para iniciar com um cabo frio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De acordo com o design do chip PT1502, a placa deve come√ßar assim. </font><font style="vertical-align: inherit;">O usu√°rio pressiona o bot√£o BTN1 e ap√≥s um ter√ßo de segundo o chip liga todas as fontes de energia. </font><font style="vertical-align: inherit;">Quando tudo est√° bem com a energia, o PT1502 "libera" o sinal RESET, iniciando assim o microcontrolador. </font><font style="vertical-align: inherit;">O processador, por sua vez, define o sinal PWR_HOLD como um, sinalizando que foi iniciado. </font><font style="vertical-align: inherit;">Depois disso, o PT1502 fornece eletricidade regularmente ao circuito at√© o microcontrolador baixar o sinal PWR_HOLD para zero.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas isso √© em teoria. De fato, assim que o processador define o sinal PWR_HOLD, a placa √© desligada instantaneamente. Trabalhei com p√° em todo o circuito de energia, observei as formas de onda dos sinais principais, embaralhei o c√≥digo no gerenciador de inicializa√ß√£o para frente e para tr√°s, mas n√£o consegui entender o problema. Tamb√©m pequei pela aus√™ncia de um resistor pull-down na linha PWR_HOLD, que esqueci de instalar, mas √© recomendado por uma folha de dados (e √© provavelmente necess√°rio). Mas adicion√°-lo com um dossel n√£o resolveu o problema. E somente quando emprestei um oscilosc√≥pio de quatro canais tudo ficou claro.</font></font><br><br><img src="https://habrastorage.org/webt/ix/ie/xf/ixiexf-lau1vggfbwu9ta4ys_hq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando o usu√°rio pressiona o bot√£o (linha laranja), o chip PT1502 liga a energia (linha roxa). Tudo isso acontece muito tempo (300 ms) antes dos eventos nessa forma de onda. E ent√£o algo interessante acontece. O PT1502 libera RESET (linha azul), o processador inicia e, por algum motivo, reduz a linha do bot√£o para zero. Mesmo que o microcontrolador ainda esteja tentando aumentar a linha POWER_HOLD (linha verde) - √© tarde demais, o PT1502 j√° desligou todas as fontes de energia. Depois, h√° mais algumas convuls√µes, mas o circuito ainda morre silenciosamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A quest√£o √©: de onde veio o zero no bot√£o? √â tudo sobre um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erro impercept√≠vel no carregador de inicializa√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , devido ao qual o modo de sa√≠da foi definido no p√© BTN1 (talvez milagres tamb√©m tenham ocorrido nas outras pernas naquele momento) e um sinal baixo apareceu l√°.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que mais teve que lutar √© com o cart√£o SD. Simplesmente n√£o havia m√≥dulo SDIO no antigo microcontrolador, ent√£o tive que estudar essa pe√ßa do zero. Passei quase o dia inteiro tentando obter um mapa, copiando trechos de c√≥digo de exemplos na Internet e o que o CubeMX gerou. Embora o cart√£o fosse perfeitamente leg√≠vel em um computador, ele persistentemente n√£o queria iniciar no meu circuito. Pequei por solda deficiente, resistores de pull-up selecionados incorretamente, circuitos desajeitados e folha de dados interpretada incorretamente. Mas, para minha surpresa, outro cart√£o com o mesmo c√≥digo e na mesma placa foi iniciado sem problemas. Ser√° necess√°rio estudar esse assunto com mais detalhes.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Houve outro problema com o cart√£o. Cutucando linhas diferentes com um oscilosc√≥pio, vi atividade apenas na linha D0, enquanto no D1-D3 houve sil√™ncio - a placa funcionava no modo de bit √∫nico. No HAL, mesmo a fun√ß√£o HAL_SD_ConfigWideBusOperation () foi encontrada, o que pode ativar o modo de transfer√™ncia de 4 bits. Infelizmente, quando o cart√£o foi alternado para o modo de 4 bits, os perif√©ricos SDIO entraram no RX FIFO Overrun profundo e pararam de funcionar.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema acabou sendo muito interessante. </font><font style="vertical-align: inherit;">Acontece que dentro da fun√ß√£o HAL_SD_ReadBlocks () h√° um certo loop que controla os sinalizadores SDIO. </font><font style="vertical-align: inherit;">Quando novos dados chegam do cart√£o, esse c√≥digo transfere os bytes do buffer FIFO interno para a mem√≥ria do usu√°rio. </font><font style="vertical-align: inherit;">Portanto, o cart√£o transmitiu bytes t√£o rapidamente que o c√≥digo em HAL_SD_ReadBlocks () simplesmente n√£o teve tempo para transferir os dados. </font><font style="vertical-align: inherit;">Eu tive que diminuir temporariamente a frequ√™ncia do rel√≥gio do cart√£o. </font><font style="vertical-align: inherit;">Bem, no futuro eu usarei DMA e esse problema n√£o deve surgir em princ√≠pio.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conclus√£o e pr√≥ximos passos </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqueles que neste lugar esperavam ver o dispositivo pronto, terei que decepcionar - apenas a placa de teste est√° conclu√≠da e, mesmo assim, apenas o peda√ßo de ferro. Agora voc√™ precisa dar vida a ele, fazer a programa√ß√£o, ajustar os modos e o consumo. Bem, na verdade, escreva um c√≥digo de log - √© por isso que todo o projeto foi iniciado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, para mim, pessoalmente, esta etapa √© uma conquista muito grande e importante. A eletr√¥nica n√£o √© minha especialidade e estou muito feliz que o dispositivo tenha sido iniciado. Consegui bombear o suficiente no projeto de circuitos, combinando v√°rios dispositivos, conectando a placa, escolhendo componentes e muito mais.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vou falar sobre o software outra vez. </font><font style="vertical-align: inherit;">Bem como sobre as nuances das configura√ß√µes. </font><font style="vertical-align: inherit;">O fato √© que todo esse preenchimento deve primeiro ser revivido e testado. </font><font style="vertical-align: inherit;">No momento, conseguimos iniciar todos os dispositivos na placa (bem, exceto o tweeter), mas apenas na quantidade de "ele come√ßou e de alguma forma responde". </font><font style="vertical-align: inherit;">Nenhuma l√≥gica de processamento ainda foi gravada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planos para o futuro pr√≥ximo:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conduza a eletr√¥nica em modos diferentes, verifique se o circuito ainda funciona. </font><font style="vertical-align: inherit;">Corrija batentes na segunda vers√£o do quadro</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Me√ßa o consumo de toda a periferia e encontre maneiras de otimizar o consumo. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Monte v√°rias op√ß√µes de placas em diferentes microcontroladores (por exemplo, L152 ou L433) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Leia atentamente a especifica√ß√£o SD e descubra como conectar corretamente o cart√£o no modo de sinaliza√ß√£o de baixa tens√£o (1,8V) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Experimente diferentes m√≥dulos de GPS e, finalmente, decida qual deles eu vou seguir </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Encomende um chip de b√∫ssola separado (por exemplo, HMC5883L ou HSCDTD008A) e tente us√°-los de alguma forma </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fa√ßa refatora√ß√£o de c√≥digo interno, atualize todas as principais bibliotecas, come√ßando com HAL </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por fim, comece a escrever recursos. </font><font style="vertical-align: inherit;">Na verdade, implemente o objetivo do dispositivo</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre isso, permita-me me despedir. </font><font style="vertical-align: inherit;">Eu ficaria grato por coment√°rios construtivos, id√©ias e conselhos sobre design de circuitos e layout de placas de circuito. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fontes: </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo bootloader </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plata </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habita√ß√£o</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt454434/">https://habr.com/ru/post/pt454434/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt454424/index.html">5 erros comuns ao usar componentes de arquitetura do Android</a></li>
<li><a href="../pt454426/index.html">ARTificial: no in√≠cio da intelig√™ncia artificial</a></li>
<li><a href="../pt454428/index.html">O que a Apple introduziu na WWDC e o que os desenvolvedores de iOS pensam sobre isso</a></li>
<li><a href="../pt454430/index.html">Vida de part√≠culas 3D</a></li>
<li><a href="../pt454432/index.html">Arqueologia divertida: o guia de estilo R sob a lupa</a></li>
<li><a href="../pt454436/index.html">Mesquinho alegria mesquinho # 1: loguru</a></li>
<li><a href="../pt454440/index.html">Petty Little Fun # 2: Estrelinha</a></li>
<li><a href="../pt454442/index.html">Como escolher uma rede proxy para o seu neg√≥cio: 3 dicas pr√°ticas</a></li>
<li><a href="../pt454444/index.html">N√≥s perfilamos o carregamento do Habr ou como 189 solicita√ß√µes na p√°gina tornam a influ√™ncia</a></li>
<li><a href="../pt454446/index.html">O que h√° de novo no C # 8?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>