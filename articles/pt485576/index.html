<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüéì üéÑ üç• Recursos para estabelecer uma conex√£o entre participantes em um jogo de rede ponto a ponto ü§ü ‚òëÔ∏è üë®‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Essa √© uma cole√ß√£o de informa√ß√µes necess√°rias para implementar o est√°gio de estabelecimento de uma conex√£o entre os participantes de um jogo de rede p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Recursos para estabelecer uma conex√£o entre participantes em um jogo de rede ponto a ponto</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485576/"> Essa √© uma cole√ß√£o de informa√ß√µes necess√°rias para implementar o est√°gio de estabelecimento de uma conex√£o entre os participantes de um jogo de rede ponto a ponto usando o protocolo UDP. <br><br>  O artigo foi desenvolvido para desenvolvedores de jogos iniciantes.  Tentei escrever um artigo que eu gostaria de ler no momento em que estava come√ßando a entender esse t√≥pico: para que todas as nuances necess√°rias sejam coletadas em um s√≥ lugar, mas ao mesmo tempo n√£o exista nada de sup√©rfluo, em linguagem simples e com imagens visuais.  Talvez algu√©m venha a calhar. <br><br>  √â improv√°vel que desenvolvedores de jogos experientes encontrem algo novo para si aqui.  Mas serei grato pelos coment√°rios e coment√°rios. <br><br><div style="text-align:center;"> <a href="https://habr.com/ru/post/485576/"><img src="https://habrastorage.org/webt/pg/wy/7h/pgwy7h2hgc0rws8_5-btx0brno8.png"></a> </div><br><a name="habracut"></a><br><h2>  Jogo em rede com arquitetura ponto a ponto </h2><br><ul><li>  Cada jogador armazena todo o estado do mundo do jogo e o processa de forma s√≠ncrona com outros jogadores.  Cada jogador passa as a√ß√µes do usu√°rio para todos os outros jogadores.  O jogador principal que coleta os outros jogadores √© chamado servidor e o restante s√£o clientes.  O servidor √© o principal apenas na fase de coleta de jogadores.  E durante o jogo n√£o h√° computador principal. <br></li><li>  Essa abordagem possui os seguintes recursos: <br><ul><li>  O tr√°fego n√£o depende da complexidade do mundo do jogo, mas apenas do n√∫mero de jogadores.  Nesse modo, <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25B8%25D1%258F_%25D0%25B2_%25D1%2580%25D0%25B5%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25BC_%25D0%25B2%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B8" rel="nofollow">as estrat√©gias em tempo real</a> geralmente funcionam, onde voc√™ precisa processar milhares de unidades. <br></li><li>  O volume de tr√°fego √© da ordem de N¬≤, onde N √© o n√∫mero de jogadores.  Portanto, essa abordagem √© aplic√°vel apenas a jogos com um pequeno n√∫mero de jogadores. <br></li><li>  Como os dados s√£o transmitidos diretamente entre jogadores sem um servidor intermedi√°rio, os atrasos na transmiss√£o (atrasos) s√£o m√≠nimos.  Mas se pelo menos um dos jogadores tiver problemas de comunica√ß√£o, isso afetar√° todos os jogadores. <br></li><li>  √â necess√°rio estabelecer canais de comunica√ß√£o entre todos os players.  Mas se os players estiverem em redes locais diferentes, isso nem sempre √© poss√≠vel. <br></li></ul></li><li>  Voc√™ pode usar TCP ou UDP para transferir dados no jogo. <br><ul><li>  <a href="https://ru.wikipedia.org/wiki/Transmission_Control_Protocol" rel="nofollow">O TCP (Transmission Control Protocol)</a> fornece entrega confi√°vel de fluxos de bytes.  Isso simplifica a implementa√ß√£o do jogo, mas n√£o h√° controle sobre os atrasos na transmiss√£o de dados. <br></li><li>  <a href="https://ru.wikipedia.org/wiki/UDP" rel="nofollow">O UDP (User Datagram Protocol)</a> √© um protocolo simples de transfer√™ncia de pacotes sem garantia de entrega.  Por√©m, devido √† sua simplicidade, o UDP √© usado em sistemas em tempo real quando √© inaceit√°vel aguardar pacotes atrasados ‚Äã‚Äãou perdidos.  O uso do UDP pode reduzir os atrasos no jogo, mas complica a implementa√ß√£o do jogo. <br></li></ul>  Este artigo descreve o uso do UDP. <br></li></ul><br><h2>  Estabelecendo uma conex√£o na rede local </h2><br><ul><li>  Para estabelecer uma conex√£o entre jogadores, o cliente precisa saber o endere√ßo IP do servidor e a porta que o programa do jogo escuta. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n3/di/2u/n3di2usgoz4bj4cyqcmbk3txocy.png"></div><br><ul><li>  Por exemplo, o computador do jogador A tem um endere√ßo IP 192.168.1.2 na rede local.  O jogador A inicia o programa do jogo em seu computador no modo servidor e o programa escuta na porta 50120. O jogador A, de alguma forma, comunica essas informa√ß√µes ao jogador B. <br></li><li>  O computador do jogador B tem um endere√ßo IP 192.168.1.5 na rede local.  O jogador B inicia o programa do jogo em seu computador no modo cliente e o programa ocupa a porta 50150. O jogador B insere o endere√ßo do servidor 192.168.1.2‚ñ∫0120 no programa do jogo e o programa envia uma solicita√ß√£o ao servidor no endere√ßo especificado. <br></li><li>  O servidor est√° no modo de espera e, ap√≥s receber uma solicita√ß√£o do jogador B, descobrir√° seu endere√ßo 192.168.1.5‚ñ∫0150.  Assim, o cliente e o servidor estabeleceram uma conex√£o e podem iniciar o jogo. <br></li></ul></li><li>  Se v√°rios clientes estiverem conectados ao servidor, o servidor dever√° enviar a cada um deles os endere√ßos de outros clientes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f9/zu/zg/f9zuzgexmd5bqe8fxgypsynspyu.png"></div><br>  No exemplo da figura, o servidor A envia ao cliente B o endere√ßo do cliente C (192.168.1.6‚ñ∫0160) e o cliente C envia o endere√ßo do cliente B (192.168.1.5‚ñ∫0150).  Assim, todos os jogadores ser√£o capazes de estabelecer conex√µes "cada uma com cada uma". <br></li><li>  Cada vez que o jogo inicia, o servidor pode solicitar qualquer porta livre do sistema operacional.  Mas √© mais conveniente usar a mesma porta todas as vezes, para que o cliente n√£o precise inserir uma nova porta todas as vezes. <br><br>  Todas as portas s√£o divididas em tr√™s faixas: <br><ul><li>  [0, 1023] - bem conhecido (sist√™mico). <br></li><li>  [1024, 49151] - registrado (usu√°rio).  A porta do servidor deve ser selecionada neste intervalo. <br></li><li>  [49152, 65535] - din√¢mico (privado).  Aqui, o sistema operacional aloca portas tempor√°rias para programas. <br></li></ul><br>  Na Wikipedia, voc√™ pode ver uma lista de <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BA_%25D0%25BF%25D0%25BE%25D1%2580%25D1%2582%25D0%25BE%25D0%25B2_TCP_%25D0%25B8_UDP" rel="nofollow">portas reservadas</a> .  Em seguida, por exemplo, a porta 49094 para o servidor do jogo √© selecionada. <br></li><li>  Um computador pode ter v√°rias interfaces de rede, reais (Ethernet, WiFi) e virtuais (VPN).  Cada interface de rede possui seu pr√≥prio endere√ßo IP.  O programa pode fornecer ao usu√°rio do servidor a oportunidade de selecionar a interface de rede pela qual ele aguardar√° as solicita√ß√µes do cliente.  Mas √© conveniente usar um endere√ßo IP especial curinga <a href="https://en.wikipedia.org/wiki/0.0.0.0" rel="nofollow">0.0.0.0</a> .  Se o programa abrir um soquete com esse endere√ßo IP, ele ouvir√° a porta especificada para todas as interfaces de rede deste computador.  Assim, o jogador n√£o precisa pensar qual interface de rede escolher. <br></li><li>  Voc√™ tamb√©m pode ajudar o cliente e determinar automaticamente o endere√ßo IP do servidor.  Se o cliente enviar uma solicita√ß√£o para um <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B8%25D1%2580%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25B5%25D1%2589%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B5%25D1%2581" rel="nofollow">endere√ßo IP de broadcast</a> especial <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B8%25D1%2580%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25B5%25D1%2589%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B5%25D1%2581" rel="nofollow">(broadcast)</a> , todos os computadores da rede local o receber√£o. <br><br>  Por exemplo, se o endere√ßo de rede for 192.168.1.0, a m√°scara de sub-rede for 255.255.255.0, o endere√ßo IP de broadcast ser√° 192.168.1.255. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4y/yj/ot/4yyjotxuzbtirqk2pewwm_npmd8.png"></div><br>  Se todos os servidores de jogos estiverem escutando na porta 49094, o pacote enviado para o endere√ßo 192.168.1.255-00-009094 ser√° recebido por todos os servidores de jogos nesta rede.  Cada servidor enviar√° uma confirma√ß√£o ao remetente.  E assim o cliente receber√° uma lista de todos os servidores de jogos em sua rede e poder√° selecionar o servidor de que precisa. <br></li><li>  Se todos os players estiverem na mesma rede local, o estabelecimento de conex√µes ‚Äúcada uma com cada uma‚Äù ser√° bastante simples.  Pode haver problemas com o acesso do cliente √† porta do servidor devido ao Firewall.  Mas isso depende do sistema operacional e das configura√ß√µes de seguran√ßa. <br></li></ul><br><h2>  Estabelecendo uma conex√£o de uma rede local com um servidor na Internet </h2><br><ul><li>  Como regra, os computadores n√£o est√£o conectados diretamente √† Internet, mas atrav√©s de um roteador.  E, como regra, o roteador realiza <a href="https://ru.wikipedia.org/wiki/NAT" rel="nofollow">a convers√£o de endere√ßos de rede (NAT, Network Address Translation)</a> . <br><br>  Por exemplo, o cliente C est√° na rede local e tem acesso √† Internet atrav√©s do roteador B, enquanto o servidor A tem um endere√ßo IP p√∫blico na Internet.  Deixe que eles tenham os seguintes endere√ßos: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/cf/qt/gqcfqtu-vneghva8qq7v2do7lxo.png"></div><br><ul><li>  O endere√ßo da Internet do servidor A √© 203.0.113.2.  O programa do servidor escuta na porta 49094. <br></li><li>  O endere√ßo do roteador B na Internet √© 203.0.113.5.  O endere√ßo do roteador B na rede local √© 192.168.1.1. <br></li><li>  O endere√ßo do cliente C na rede local √© 192.168.1.5.  O programa cliente ocupa a porta 50150 e envia um pacote ao servidor em 203.0.113.2-00-009094. <br></li><li>  O roteador B √© o <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25BB%25D1%258E%25D0%25B7_%25D0%25BF%25D0%25BE_%25D1%2583%25D0%25BC%25D0%25BE%25D0%25BB%25D1%2587%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258E" rel="nofollow">gateway padr√£o</a> em sua rede local.  Ou seja, todos os pacotes com endere√ßos que n√£o pertencem √† rede local atual s√£o enviados a ele. <br></li><li>  O roteador possui uma tabela de convers√£o de endere√ßos: (endere√ßo interno: porta interna) - (endere√ßo externo: porta externa).  Tendo recebido um pacote do cliente para o servidor 203.0.113.2-00-009094, o roteador seleciona qualquer porta externa livre, por exemplo 52050, e cria uma entrada na tabela de convers√£o de endere√ßos: 192.168.1.5‚ñ∫0150 - 203.0.113.5‚ñ∫2050. <br></li><li>  O roteador substitui o endere√ßo interno do remetente 192.168.1.5/100150 no pacote pelo endere√ßo externo 203.0.113.5/102050 e transfere o pacote alterado para o servidor. <br></li><li>  O servidor recebe um pacote com o endere√ßo do remetente 203.0.113.5‚ñ∫ 2020 e envia uma resposta para esse endere√ßo, ou seja, para o roteador. <br></li><li>  Depois de receber o pacote do servidor, o roteador procura o endere√ßo do destinat√°rio em sua tabela de convers√£o de endere√ßos, executa a substitui√ß√£o reversa do endere√ßo externo do destinat√°rio 203.0.113.5‚ñ∫2050 pelo endere√ßo interno 192.168.1.5‚ñ∫0150 e envia o pacote para esse endere√ßo, ou seja, o cliente. <br></li><li>  Se o cliente enviar pacotes subsequentes para o servidor, o roteador examinar√° o endere√ßo do remetente para verificar se esse registro j√° existe na tabela e, se houver, ele usar√° a porta externa alocada anteriormente, neste caso 52050. <br></li><li>  Assim, o cliente e o servidor estabeleceram uma conex√£o atrav√©s do NAT e podem iniciar o jogo.  Mas o servidor n√£o conhece o endere√ßo interno do cliente em sua rede local e considera que o cliente √© um roteador. <br></li><li>  A entrada na tabela de convers√£o de endere√ßos √© v√°lida por um determinado per√≠odo de tempo, geralmente de 1 a 3 minutos.  Portanto, o cliente e o servidor precisam trocar pacotes periodicamente para que o registro que os conecte n√£o seja exclu√≠do.  Se o cliente enviar um novo pacote ao servidor ap√≥s a exclus√£o do registro, uma porta externa diferente poder√° ser alocada para o novo registro no roteador e, para o servidor, ser√° outro cliente com um endere√ßo diferente. <br></li></ul></li><li>  Como regra, o roteador do usu√°rio n√£o est√° conectado diretamente √† Internet, mas est√° localizado na rede interna do provedor da Internet.  Ou seja, o cliente est√° por tr√°s de dois NATs. <br><br>  Por exemplo, assim: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7u/ht/cw/7uhtcwvuy-lojgg6_sxifcd_ucc.png"></div><br>  Ou seja, √© realizada uma convers√£o dupla de endere√ßos de rede. <br></li><li>  Existem diferentes tipos de NAT: <br><ul><li>  NAT de cone completo <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gn/ar/8u/gnar8u7m0xlyigrhgihadyqe0d0.png"></div><br><ul><li>  Depois que uma entrada √© criada na tabela de convers√£o de endere√ßos (endere√ßo interno: porta interna) - (endere√ßo externo: porta externa), todos os pacotes do remetente (endere√ßo interno: porta interna) s√£o transmitidos atrav√©s de (endere√ßo externo: porta externa) para qualquer endere√ßo de destinat√°rio. <br></li><li>  Qualquer servidor externo pode enviar pacotes para (endere√ßo interno: porta interna), enviando pacotes para (endere√ßo externo: porta externa). <br></li></ul>  Por exemplo, o cliente C envia pacotes para os servidores A e D usando o mesmo endere√ßo externo 203.0.113.5‚ñ∫ 202050.  Se o servidor E enviar um pacote para este endere√ßo 203.0.113.5‚ñ∫ 202050, o roteador o passar√° para o cliente C. <br></li><li>  NAT de cone com restri√ß√£o de endere√ßo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i6/on/ao/i6onaojluqotmemktgufswzg-ia.png"></div><br><ul><li>  Depois que uma entrada √© criada na tabela de convers√£o de endere√ßos (endere√ßo interno: porta interna) - (endere√ßo externo: porta externa), todos os pacotes do remetente (endere√ßo interno: porta interna) s√£o transmitidos atrav√©s de (endere√ßo externo: porta externa) para qualquer endere√ßo de destinat√°rio. <br></li><li>  Um servidor externo (endere√ßo do servidor: porta do servidor) pode enviar pacotes para (endere√ßo interno: porta interna), enviando pacotes para (endere√ßo externo: porta externa) somente se (endere√ßo interno: porta interna) tiver enviado pacotes anteriormente para (endere√ßo do servidor: qualquer porta). <br></li></ul>  Por exemplo, o cliente C envia pacotes para os servidores A e D usando o mesmo endere√ßo externo 203.0.113.5‚ñ∫ 202050.  O servidor D pode enviar um pacote para o cliente C atrav√©s do endere√ßo de roteador 203.0.113.5‚ñ∫ 202050 a partir de qualquer uma de suas portas.  Mas o roteador n√£o passa pacotes do servidor E. <br></li><li>  Cone com restri√ß√£o de porta NAT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kr/6v/di/kr6vdi2regppcywwajtz-1basdy.png"></div><br><ul><li>  Depois que uma entrada √© criada na tabela de convers√£o de endere√ßos (endere√ßo interno: porta interna) - (endere√ßo externo: porta externa), todos os pacotes do remetente (endere√ßo interno: porta interna) s√£o transmitidos atrav√©s de (endere√ßo externo: porta externa) para qualquer endere√ßo de destinat√°rio. <br></li><li>  Um servidor externo (endere√ßo do servidor: porta do servidor) pode enviar pacotes para (endere√ßo interno: porta interna), enviando pacotes para (endere√ßo externo: porta externa) somente se (endere√ßo interno: porta interna) tiver enviado pacotes anteriormente para (endere√ßo do servidor: porta servidor). <br></li></ul>  Por exemplo, o cliente C envia pacotes para os servidores A e D usando o mesmo endere√ßo externo 203.0.113.5‚ñ∫ 202050.  O roteador n√£o passar√° pacotes do servidor E ou de outra porta D. <br></li><li>  NAT sim√©trico (NAT sim√©trico). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ha/lr/98halr7veiq_ibj_irj2lxixcec.png"></div><br><ul><li>  Se o mesmo remetente interno (endere√ßo interno: porta interna) enviar pacotes para diferentes destinat√°rios (endere√ßo do servidor: porta do servidor), uma porta externa separada ser√° alocada para cada endere√ßo de destinat√°rio e uma entrada separada ser√° usada na tabela de convers√£o de endere√ßos. <br></li><li>  Somente o servidor externo (endere√ßo do servidor: porta do servidor) que recebeu o pacote do remetente interno (endere√ßo interno: porta interna) pode enviar o pacote de volta. <br></li></ul>  Por exemplo, o cliente C envia pacotes para o servidor A usando um endere√ßo externo 203.0.113.5‚ñ∫ 202050 e para o servidor D usando outro endere√ßo externo 203.0.113.5.  O roteador n√£o passar√° pacotes do servidor E ou de outra porta D. <br></li></ul></li><li>  Se v√°rios clientes estiverem conectados ao servidor do jogo, para um jogo ponto a ponto, voc√™ precisar√° estabelecer uma conex√£o diretamente entre cada par de clientes ignorando o servidor. <br><br>  Por exemplo, dois clientes C e E conectados ao servidor A: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ai/if/ym/aiifymcc-epffu0da8rkksj_4es.png"></div><br><ul><li>  O cliente C tem um endere√ßo interno 192.168.1.5/100150 e um endere√ßo externo 203.0.113.5/102050. <br></li><li>  O cliente E tem um endere√ßo interno 192.168.2.5:50250 e um endere√ßo externo 203.0.113.6-062060. <br></li><li>  O servidor deve informar a cada cliente o endere√ßo externo do outro cliente. <br></li><li>  Normalmente, os roteadores usam um NAT do tipo cone cone com restri√ß√£o de porta.  O roteador passa pacotes para o cliente apenas do remetente (endere√ßo IP e porta) para o qual o cliente enviou pacotes anteriormente.  E se o cliente C enviar um pacote para o cliente E, o roteador D n√£o perder√° esse pacote. <br></li><li>  Nesse caso, o m√©todo de <a href="https://en.wikipedia.org/wiki/UDP_hole_punching" rel="nofollow">perfura√ß√£o UDP</a> √© usado.  Ambos os clientes devem enviar pacotes UDP para o outro.  Assim que o cliente C enviar um pacote ao cliente E, o roteador B estar√° pronto para receber pacotes do cliente E. Da mesma forma, assim que o cliente E enviar um pacote ao cliente C, o roteador D estar√° pronto para receber pacotes do cliente C. Os primeiros pacotes do cliente que iniciaram transmitir primeiro ser√° perdido.  Mas assim que o segundo cliente tamb√©m come√ßar a enviar pacotes, os dois poder√£o trocar pacotes. <br></li><li>  Mas se o roteador usar NAT sim√©trico, uma nova porta externa ser√° alocada para cada destinat√°rio.  E, como regra, n√£o h√° como descobrir qual porta o roteador alocou.  Portanto, se pelo menos um dos roteadores usar o NAT sim√©trico, ser√° imposs√≠vel estabelecer uma conex√£o entre os clientes. <br></li></ul></li><li>  Se dois clientes estiverem na mesma rede local, eles conhecer√£o apenas os endere√ßos externos um do outro. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jj/si/a4/jjsia4y7k50gk3esxa_5hvzx3ks.png"></div><br>  Por exemplo, o cliente C envia um pacote para o cliente D em seu endere√ßo externo 203.0.113.5Point2051.  O roteador B deve processar esse pacote como se tivesse sido recebido de uma rede externa, substitua o endere√ßo do destinat√°rio 203.0.113.5‚ñ∫ 20201 pelo endere√ßo interno do cliente D 192.168.1.6‚ñ∫0060 e envie o pacote ao cliente D de volta √† rede local.  Essa fun√ß√£o do roteador √© chamada de <a href="https://ru.wikipedia.org/wiki/NAT" rel="nofollow">loopback</a> <a href="https://en.wikipedia.org/wiki/Hairpinning" rel="nofollow">NAT</a> ( <a href="https://en.wikipedia.org/wiki/Hairpinning" rel="nofollow">hairpinning NAT</a> ).  Se o loopback NAT estiver desativado no roteador, ser√° imposs√≠vel estabelecer uma conex√£o entre os clientes. <br></li><li>  Os clientes podem estar localizados em redes locais diferentes, mas t√™m acesso √† Internet por meio de um provedor comum. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q8/dj/yo/q8djyoaqbhaq6z3_wxc7_afbphk.png"></div><br>  Se o loopback NAT estiver desativado no equipamento do provedor de servi√ßos da Internet, ser√° imposs√≠vel estabelecer uma conex√£o entre os clientes. <br></li><li>  O que devo fazer se o NAT sim√©trico for usado no roteador ou o loopback do NAT estiver desativado? <br><br>  Pelo que entendi, a √∫nica maneira confi√°vel de resolver esses problemas √© transferir pacotes n√£o diretamente entre clientes, mas atrav√©s de um servidor.  √â necess√°rio implementar essa fun√ß√£o no programa do jogo dentro da estrutura da arquitetura ponto a ponto ou implementar a arquitetura cliente-servidor. <br><br>  Ou voc√™ pode usar programas de terceiros para criar uma VPN, por exemplo, <a href="https://ru.wikipedia.org/wiki/LogMeIn_Hamachi" rel="nofollow">LogMeIn Hamachi</a> . <br></li></ul><br><h2>  Estabelecendo uma conex√£o entre LANs na Internet </h2><br><ul><li>  Como regra, nenhum dos players possui um endere√ßo IP p√∫blico e est√£o em redes locais diferentes atr√°s do NAT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/56/cr/up/56crup-geun05fnbtaokha2vqia.png"></div><br>  Por exemplo, nesse esquema, o cliente C enviar√° pacotes ao servidor A em seu endere√ßo externo 203.0.113.2-022020, no qual a porta √© selecionada pelo roteador B. Portanto, escolher a porta interna do servidor A n√£o importa e voc√™ pode selecionar qualquer porta.  Nesse caso, em vez da porta 49094, o servidor A pode solicitar qualquer porta livre do sistema operacional, por exemplo 50120. <br></li><li>  Para que o servidor A e o cliente C estabele√ßam uma conex√£o, primeiro, cada um deles precisa descobrir de alguma forma seu endere√ßo externo. <br><br>  Voc√™ pode usar o protocolo <a href="https://ru.wikipedia.org/wiki/STUN" rel="nofollow">STUN (Utilit√°rios de transfer√™ncia de sess√£o para NAT) para isso</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sk/lj/cm/skljcmi1c5ztbt6law8nf_ylsy0.png"></div><br>  O protocolo STUN permite que o cliente localizado atr√°s do NAT determine seu endere√ßo IP e porta externos. <br><br>  As mensagens STUN s√£o enviadas em pacotes UDP. <br><br>  O cliente pode acessar qualquer um dos servidores STUN p√∫blicos.  Uma lista de servidores p√∫blicos STUN pode ser encontrada na <a href="https://ru.wikipedia.org/wiki/STUN" rel="nofollow">Wikipedia</a> .  Ou pesquise <a href="https://www.google.com/search%3Fq%3Dpublic%2BSTUN%2Bservers%2Blist" rel="nofollow">"lista p√∫blica de servidores STUN"</a> . <br><br>  Este m√©todo n√£o √© aplic√°vel se pelo menos um dos players do roteador usar "NAT sim√©trico". <br></li><li>  Depois que cada um dos jogadores souber seu endere√ßo externo, ele deve, de alguma forma, dar seu endere√ßo a todos os outros jogadores. <br><br>  Para que os jogadores possam trocar seus endere√ßos, voc√™ pode usar seu servidor p√∫blico.  No diagrama, √© chamado de servidor de endere√ßo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ev/e_/fi/eve_fiqezp76wwmjfexsb0vlzka.png"></div><br>  Isso n√£o requer necessariamente um servidor dedicado.  Voc√™ pode usar qualquer hospedagem com um <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B5%25D0%25B1-%25D1%2581%25D0%25B5%25D1%2580%25D0%25B2%25D0%25B5%25D1%2580" rel="nofollow">servidor web</a> e com o suporte de qualquer linguagem de script, como PHP.  Usando o <a href="https://ru.wikipedia.org/wiki/HTTP" rel="nofollow">protocolo HTTP,</a> cada jogador deve enviar seu endere√ßo externo para o servidor de endere√ßos.  E, em seguida, solicite os endere√ßos de todos os outros jogadores. <br></li><li>  Por exemplo, cada servidor de jogo pode registrar seu identificador exclusivo (ID do jogo) no servidor de endere√ßo.  Voc√™ pode usar qualquer sequ√™ncia como o ID do jogo, por exemplo, o apelido (alias) do usu√°rio do servidor.  De alguma forma, o usu√°rio do servidor informa o ID do jogo aos jogadores que ele deseja convidar para o jogo.  E esses jogadores poder√£o ingressar no jogo solicitando, pelo servidor do endere√ßo, os endere√ßos externos de todos os participantes deste jogo. <br></li><li>  Depois que cada jogador recebe os endere√ßos externos de todos os outros jogadores, eles podem estabelecer conex√µes um para cada usando o <a href="https://en.wikipedia.org/wiki/UDP_hole_punching" rel="nofollow">m√©todo de perfura√ß√£o UDP</a> . <br></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485576/">https://habr.com/ru/post/pt485576/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485554/index.html">Objetivos e principais resultados (OKR) - Nossa experi√™ncia de implementa√ß√£o em fases</a></li>
<li><a href="../pt485556/index.html">Foram necess√°rios 12 anos para criar uma se√ß√£o do mapa cerebral de Drosophila, os esfor√ßos de 250 pessoas e US $ 40 milh√µes</a></li>
<li><a href="../pt485558/index.html">Sem mosquitos! Vis√£o geral do mosquito "fito-muni√ß√£o"</a></li>
<li><a href="../pt485562/index.html">Navegar na Internet com um Gamepad (Javascript)</a></li>
<li><a href="../pt485564/index.html">Engenharia reversa do protocolo Ngrok v2</a></li>
<li><a href="../pt485578/index.html">Mahjong com crian√ßas: para qu√™, quando e como</a></li>
<li><a href="../pt485582/index.html">Paul Graham: ‚ÄúUm investidor como um rebanho de animais‚Äù (2013)</a></li>
<li><a href="../pt485584/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n¬∫ 399 (20 - 26 de janeiro de 2020)</a></li>
<li><a href="../pt485586/index.html">Paul Graham: Id√©ias para Startups (Ideas for Startups, 2005)</a></li>
<li><a href="../pt485592/index.html">PHP Digest No. 172 (14 a 27 de janeiro de 2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>