<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèø üßùüèº üèÖ Anotasi Versi Hebat di JPA üëâüèΩ üî© üï¥üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendahuluan 
 Jadi mari kita mulai! Apa yang dimaksud dengan anotasi Versi di JPA? 

 Singkatnya, dia bertanggung jawab untuk memblokir di JPA. Anotas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Anotasi Versi Hebat di JPA</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434836/"><h3>  Pendahuluan </h3><br>  Jadi mari kita mulai!  Apa yang dimaksud dengan <i>anotasi Versi</i> di JPA? <br><br>  Singkatnya, dia bertanggung jawab untuk memblokir di JPA.  Anotasi ini memecahkan salah satu masalah yang mungkin timbul sebagai akibat dari transaksi paralel. <br><br><h4>  Masalah apa yang bisa muncul? </h4><br><ol><li>  <b>Pembaruan yang hilang</b> dapat terjadi dalam situasi di mana dua transaksi yang berjalan secara paralel mencoba memperbarui data yang sama. </li><li>  <b>Pembacaan kotor</b> terjadi ketika transaksi melihat perubahan yang belum disimpan oleh transaksi lain.  Dalam kasus seperti itu, masalah dapat terjadi karena kemunduran transaksi kedua, tetapi data telah dibaca terlebih dahulu. </li><li>  <b>Pembacaan</b> non-berulang terjadi ketika transaksi pertama telah menerima data, dan transaksi kedua telah mengubahnya dan berhasil melakukan itu sampai akhir transaksi pertama.  Dengan kata lain, ketika dalam transaksi yang sama permintaan yang sama untuk mendapatkan, misalnya, seluruh tabel, mengembalikan hasil yang berbeda. </li><li>  <b>Pembacaan hantu</b> adalah masalah yang mirip dengan bacaan berulang, dengan pengecualian bahwa jumlah baris yang berbeda dikembalikan. </li></ol><br><h4>  Secara singkat tentang keputusan mereka </h4><br><ol><li>  READ UNCOMMITED - diselesaikan menggunakan anotasi Versi di JPA (ini persis artikel) </li><li>  READ COMMITED - memungkinkan hanya membaca perubahan yang dilakukan </li><li>  BACA YANG BERULANG - sedikit lebih rumit di sini.  Transaksi kami "tidak melihat" perubahan pada data yang sebelumnya dibaca, dan transaksi lainnya tidak dapat mengubah data yang masuk ke dalam transaksi kami. </li><li>  SERIALIZABLE - eksekusi transaksi berurutan </li></ol><br>  Setiap paragraf berikutnya mencakup semua yang sebelumnya, dengan kata lain, itu dapat menggantikan solusi yang ditunjukkan sebelumnya.  Dengan demikian, SERIALIZABLE memiliki tingkat isolasi tertinggi, dan READ UNCOMMITED memiliki tingkat isolasi terendah. <br><a name="habracut"></a><br><h3>  Versi </h3><br>  Versi memecahkan masalah dengan <b>pembaruan yang hilang</b> .  Bagaimana tepatnya, sekarang kita akan lihat. <br><br>  Sebelum beralih ke kode, ada baiknya menyebutkan bahwa ada dua jenis kunci: <i>optimis</i> dan <i>pesimistis</i> .  Perbedaannya adalah bahwa yang pertama dipandu oleh situasi di mana banyak transaksi mencoba mengubah satu bidang pada saat yang sama, jarang terjadi, sementara yang lain dipandu oleh situasi yang berlawanan.  Sesuai dengan ini, ada perbedaan dalam logika eksekusi mereka. <br><br>  Dalam kunci <i>optimis</i> , ketika melakukan ke database, nilai bidang yang ditandai sebagai versi dibandingkan pada saat data diterima dan saat ini.  Jika sudah berubah, yaitu, beberapa transaksi lain ada di depan kami dan berhasil mengubah data, maka dalam hal ini transaksi kami membuat kesalahan, dan Anda harus memulai kembali. <br><br>  Saat menggunakan kunci <i>optimis</i> , tingkat daya saing yang lebih tinggi dipastikan ketika mengakses database, tetapi dalam hal ini Anda harus mengulangi transaksi yang tidak punya waktu untuk melakukan perubahan sebelum yang lain. <br><br>  Dalam yang <i>pesimistis</i> , kunci diberlakukan segera sebelum modifikasi data yang diduga pada semua lini yang diduga mempengaruhi modifikasi tersebut. <br><br>  Dan ketika menggunakan kunci <i>pesimistis</i> , tidak adanya kontradiksi selama pelaksanaan transaksi dijamin, karena menempatkan sisanya ke mode siaga (tetapi butuh waktu), akibatnya, menurunkan tingkat kompetisi. <br><br><h3>  LockModeType atau cara mengatur kunci </h3><br>  Kunci dapat diatur dengan memanggil metode tampilan EntityManager. <br><br><pre><code class="javascript hljs">entityManager.lock(myObject, LockModeType.OPTIMISTIC);</code> </pre> <br>  LockModeType mendefinisikan strategi penguncian. <br><br>  LockModeType dapat terdiri dari 6 jenis (2 di antaranya <i>optimis</i> , dan 3 tipe <i>pesimistis</i> ): <br><br><ol><li>  NONE - tidak ada kunci </li><li>  OPTIMIS </li><li>  OPTIMISTIC_FORCE_INCREMENT </li><li>  PESSIMISTIC_READ </li><li>  PESSIMISTIC_WRITE </li><li>  PESSIMISTIC_FORCE_INCREMENT </li></ol><br><div class="spoiler">  <b class="spoiler_title">Buat Entitas kami</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import lombok.Getter; import lombok.Setter; import javax.persistence.*; @EntityListeners(OperationListenerForMyEntity.class) @Entity public class MyEntity{ @Version private long version; @Id @GeneratedValue @Getter @Setter private Integer id; @Getter @Setter private String value; @Override public String toString() { return "MyEntity{" + "id=" + id + ", version=" + version + ", value='" + value + '\'' + '}'; } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Mari kita buat kelas di mana semua metode Callback akan diimplementasikan.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import javax.persistence.*; public class OperationListenerForMyEntity { @PostLoad public void postLoad(MyEntity obj) { System.out.println("Loaded operation: " + obj); } @PrePersist public void prePersist(MyEntity obj) { System.out.println("Pre-Persistiting operation: " + obj); } @PostPersist public void postPersist(MyEntity obj) { System.out.println("Post-Persist operation: " + obj); } @PreRemove public void preRemove(MyEntity obj) { System.out.println("Pre-Removing operation: " + obj); } @PostRemove public void postRemove(MyEntity obj) { System.out.println("Post-Remove operation: " + obj); } @PreUpdate public void preUpdate(MyEntity obj) { System.out.println("Pre-Updating operation: " + obj); } @PostUpdate public void postUpdate(MyEntity obj) { System.out.println("Post-Update operation: " + obj); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Main.java</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import javax.persistence.*; import java.util.concurrent.*; //        ,   . public class Main { //  , ..  EntityManagerFactory  ,     . private static EntityManagerFactory entityManagerFactory = Persistence.createEntityManagerFactory("ru.easyjava.data.jpa.hibernate"); public static void main(String[] args) { //  10 (  ,       ). ExecutorService es = Executors.newFixedThreadPool(10); try { //  persistFill()   - . persistFill(); for(int i=0; i&lt;10; i++){ int finalI = i; es.execute(() -&gt; { //      updateEntity(finalI) ,  java       .    java -  ,      id,       , id    ,       (  ,      persistFill(),  id       500). updateEntity(finalI); }); } es.shutdown(); try { es.awaitTermination(10, TimeUnit.SECONDS); } catch (InterruptedException e) { e.printStackTrace(); } } finally { entityManagerFactory.close(); } } //         . private static void updateEntity(int index) { //  EntityManager  ,     ,    . EntityManager em = entityManagerFactory.createEntityManager(); MyEntity myEntity = null; try { em.getTransaction().begin(); //        1. myEntity = em.find(MyEntity.class, 1); //   sout,       "" . System.out.println("load = "+index); //       (  LockModeType.*). em.lock(myEntity, LockModeType.OPTIMISTIC); //   Value,  ,        . myEntity.setValue("WoW_" + index); em.getTransaction().commit(); em.close(); System.out.println("--Greeter updated : " + myEntity +" __--__ "+ index); }catch(RollbackException ex){ System.out.println(", =" + myEntity); } } public static void persistFill() { MyEntity myEntity = new MyEntity(); myEntity.setValue("JPA"); EntityManager em = entityManagerFactory.createEntityManager(); em.getTransaction().begin(); em.persist(myEntity); em.getTransaction().commit(); em.close(); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Pertama kali dijalankan dengan metode updateEntity yang dikomentari</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Pre-Persistiting operation: MyEntity{id=null, version=0, value='JPA'} Post-Persist operation: MyEntity{id=531, version=0, value='JPA'}  .  id   find   .</code> </pre><br></div></div><br><h6>  LockModeType.OPTIMISTIC </h6><br>  Ini adalah blok <i>optimis</i> , well, ini sangat logis.  Seperti yang saya tulis di atas, nilai bidang versi dibandingkan, jika berbeda, kesalahan dilemparkan.  Lihat ini. <br><br><div class="spoiler">  <b class="spoiler_title">Hasil:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Loaded operation: MyEntity{id=531, version=0, value='JPA'} load = 3 Loaded operation: MyEntity{id=531, version=0, value='JPA'} load = 2 Pre-Updating operation: MyEntity{id=531, version=0, value='WoW_2'} Pre-Updating operation: MyEntity{id=531, version=0, value='WoW_3'} Loaded operation: MyEntity{id=531, version=0, value='JPA'} load = 9 Pre-Updating operation: MyEntity{id=531, version=0, value='WoW_9'} Loaded operation: MyEntity{id=531, version=0, value='JPA'} load = 1 Pre-Updating operation: MyEntity{id=531, version=0, value='WoW_1'} Post-Update operation: MyEntity{id=531, version=1, value='WoW_1'} --Greeter updated : MyEntity{id=531, version=1, value='WoW_1'} __--__ 1 , =MyEntity{id=531, version=0, value='WoW_2'} , =MyEntity{id=531, version=0, value='WoW_3'} Loaded operation: MyEntity{id=531, version=1, value='WoW_1'} load = 4 Pre-Updating operation: MyEntity{id=531, version=1, value='WoW_4'} Post-Update operation: MyEntity{id=531, version=2, value='WoW_4'} --Greeter updated : MyEntity{id=531, version=2, value='WoW_4'} __--__ 4 , =MyEntity{id=531, version=0, value='WoW_9'} Loaded operation: MyEntity{id=531, version=2, value='WoW_4'} load = 0 Pre-Updating operation: MyEntity{id=531, version=2, value='WoW_0'} Post-Update operation: MyEntity{id=531, version=3, value='WoW_0'} --Greeter updated : MyEntity{id=531, version=3, value='WoW_0'} __--__ 0 Loaded operation: MyEntity{id=531, version=3, value='WoW_0'} load = 6 Pre-Updating operation: MyEntity{id=531, version=3, value='WoW_6'} Post-Update operation: MyEntity{id=531, version=4, value='WoW_6'} Loaded operation: MyEntity{id=531, version=4, value='WoW_6'} load = 5 Pre-Updating operation: MyEntity{id=531, version=4, value='WoW_5'} Post-Update operation: MyEntity{id=531, version=5, value='WoW_5'} --Greeter updated : MyEntity{id=531, version=4, value='WoW_6'} __--__ 6 --Greeter updated : MyEntity{id=531, version=5, value='WoW_5'} __--__ 5 Loaded operation: MyEntity{id=531, version=5, value='WoW_5'} load = 7 Pre-Updating operation: MyEntity{id=531, version=5, value='WoW_7'} Post-Update operation: MyEntity{id=531, version=6, value='WoW_7'} Loaded operation: MyEntity{id=531, version=5, value='WoW_5'} load = 8 Pre-Updating operation: MyEntity{id=531, version=5, value='WoW_8'} --Greeter updated : MyEntity{id=531, version=6, value='WoW_7'} __--__ 7 , =MyEntity{id=531, version=5, value='WoW_8'}</code> </pre><br></div></div><br>  Pengamatan: Seperti yang Anda lihat dari hasil, aliran 3, 2, 9, dan 1 adalah yang pertama kali dimuat, dan metode panggilan balik Pra-Pembaruan dipanggil untuk itu.  Utas pertama tempat metode Post-Update dipanggil adalah 1, seperti yang dapat Anda lihat dari hasil, bidang yang ditandai dengan anotasi Versi telah diubah (bertambah 1).  Karenanya, semua utas yang tersisa 2, 3, 9 melempar pengecualian.  Dan sebagainya.  Hasilnya adalah nilai = WoW_7, versi = 6. Memang, Post-Update terakhir di utas 7 dengan versi = 6. <br><br><h6>  LockModeType.OPTIMISTIC_FORCE_INCREMENT </h6><br>  Ini bekerja sesuai dengan algoritma yang sama dengan LockModeType.OPTIMISTIC, kecuali bahwa setelah komit nilai bidang Versi secara paksa meningkat sebesar 1. Sebagai hasilnya, setelah setiap komit, bidang akan meningkat sebesar 2 (peningkatan yang dapat dilihat di Post-Update + peningkatan paksa) .  Pertanyaan  Mengapa  Jika setelah komit kami ingin "menyulap" data yang sama, dan kami tidak memerlukan transaksi pihak ketiga yang dapat memecah antara komit pertama dan penutupan transaksi kami. <br><br>  <b>Penting!</b>  Jika Anda mencoba mengubah data menjadi sama, maka dalam hal ini metode Pra-Pembaruan dan Pasca-Pembaruan tidak akan dipanggil.  Tutup semua transaksi dapat terjadi.  Misalnya, beberapa transaksi dibaca bersamaan dengan kami, tetapi karena panggilan ke metode pra dan pasca (pembaruan) memerlukan waktu, transaksi yang mencoba mengubah data (ke yang sama) akan segera dieksekusi.  Ini akan menghasilkan kesalahan dari sisa transaksi. <br><br><h6>  LockModeType.PESSIMISTIC_READ, LockModeType.PESSIMISTIC_WRITE dan LockModeType.PESSIMISTIC_FORCE_INCREMENT </h6><br>  Karena pekerjaan dari jenis kunci yang tersisa terlihat serupa, maka saya akan menulis semuanya sekaligus dan mempertimbangkan hasilnya hanya oleh PESSIMISTIC_READ. <br><br>  LockModeType.PESSIMISTIC_READ - kunci baca <i>pesimistis</i> . <br>  LockModeType.PESSIMISTIC_WRITE - kunci tulis <i>pesimis</i> (dan baca). <br>  LockModeType.PESSIMISTIC_FORCE_INCREMENT - kunci tulis <i>pesimis</i> (dan baca) dengan peningkatan paksa bidang Versi. <br><br>  Sebagai akibat dari penguncian tersebut, penantian yang lama akan terjadi, yang pada gilirannya dapat menyebabkan kesalahan. <br><br><div class="spoiler">  <b class="spoiler_title">Hasil pada LockModeType.PESSIMISTIC_READ (tidak disajikan secara keseluruhan):</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">load = 0 Pre-Updating operation: MyEntity{id=549, version=5, value='WoW_0'} Post-Update operation: MyEntity{id=549, version=6, value='WoW_0'} Loaded operation: MyEntity{id=549, version=6, value='WoW_0'} load = 8 Pre-Updating operation: MyEntity{id=549, version=6, value='WoW_8'} Loaded operation: MyEntity{id=549, version=6, value='WoW_0'} load = 4 Pre-Updating operation: MyEntity{id=549, version=6, value='WoW_4'} ... ERROR: :   :  22760    ExclusiveLock  " (0,66)  287733   271341";   20876.  20876    ShareLock  " 8812";   22760.</code> </pre><br></div></div><br>  Akibatnya, utas 4 dan 8 memblokir satu sama lain, yang menyebabkan konflik yang tidak dapat diselesaikan.  Sebelum ini, tidak ada yang mengganggu utas 0.  Situasi serupa dengan semua utas hingga 0. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id434836/">https://habr.com/ru/post/id434836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id434822/index.html">Program RRT "Mobil dengan sumber energi baru." Apa yang diharapkan pada 2019</a></li>
<li><a href="../id434824/index.html">Polit-Teknik Elektro. Pemodelan proses sosial-politik oleh sirkuit listrik</a></li>
<li><a href="../id434826/index.html">Tempat tidur tepat waktu, atau 5 tanda masalah tersembunyi di tim</a></li>
<li><a href="../id434828/index.html">Menjadi seorang profesional. Kebiasaan yang berguna dari desainer UX</a></li>
<li><a href="../id434830/index.html">Komponen Bereaksi Akhir</a></li>
<li><a href="../id434838/index.html">Membuat bot untuk berpartisipasi dalam Piala AI Rusia 2018 CodeBall</a></li>
<li><a href="../id434840/index.html">Bagaimana saya melakukan "Buku Harian Anda" - atau situasi di pasar buku harian elektronik</a></li>
<li><a href="../id434842/index.html">Peternakan kota bisa sangat efektif, tetapi tidak sekarang</a></li>
<li><a href="../id434844/index.html">Pemulihan kemampuan kognitif 100 pasien (terjemahan artikel oleh Dale Bredesen)</a></li>
<li><a href="../id434848/index.html">Dewan Direksi Tesla termasuk dua direktur independen - Larry Ellison dan Caitlin Wilson-Thompson</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>