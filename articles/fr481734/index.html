<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîÆ üß• üèì Exp√©rience avec les imprimantes √† cartes, partie 1 üë®üèΩ‚Äçüéì üë≥ ü¶ã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article sera utile pour ceux qui commencent √† travailler avec des imprimantes √† cartes ( Evolis Primacy et Smart-51 ) et des cartes cod√©es NFC com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exp√©rience avec les imprimantes √† cartes, partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481734/"><p>  Cet article sera utile pour ceux qui commencent √† travailler avec des imprimantes √† cartes ( <strong>Evolis Primacy</strong> et <strong>Smart-51</strong> ) et des cartes cod√©es NFC comme <strong>Mifare Classic</strong> et <strong>Mifare DESFire EV2</strong> .  Dans la premi√®re partie, nous d√©crirons l'impression g√©n√©rale de travailler avec des imprimantes √† cartes, ainsi que les probl√®mes auxquels nous avons d√ª faire face.  Dans la deuxi√®me partie, il est pr√©vu de montrer des parties plus pratiques: code, conseils d'utilisation. </p><br><h3 id="1-kak-poyavilas-zadacha">  1. Comment la t√¢che est-elle apparue </h3><br><p>  Nous d√©veloppons un syst√®me de billetterie √©lectronique, qui comprend l'utilisation de cartes NFC.  Chaque carte NFC poss√®de un <strong>num√©ro</strong> convivial et un <strong>identifiant</strong> individuel.  <strong>Le num√©ro</strong> doit √™tre imprim√© sur la carte et l' <strong>ID est</strong> √©crit sur la puce NFC.  L'une des t√¢ches consistait √† √©tablir une production stable de cartes de transport. </p><br><p>  √Ä la premi√®re √©tape, le probl√®me a √©t√© r√©solu de la mani√®re la plus simple: les impressions avec des <strong>num√©ros</strong> sont imprim√©es par le fournisseur de cartes NFC et les identifiants sont enregistr√©s par nous √† l'aide de lecteurs de bureau, de logiciels sp√©ciaux et de personnes.  Apr√®s avoir re√ßu les cartes du fournisseur, il est n√©cessaire d'enregistrer la carte dans le syst√®me et d'associer l' <strong>ID</strong> et le <strong>num√©ro les</strong> uns aux autres.  En tant que lecteur de bureau, nous avons utilis√© le lecteur Z-2 [1]. </p><br><p>  Le processus ressemblait √† ceci: </p><br><ul><li>  L'op√©rateur prend une carte.  Le num√©ro de carte est d√©j√† imprim√© sur la carte, mais l'enregistrement de la carte dans le syst√®me et l'enregistrement de l' <strong>ID</strong> dans la puce NFC est requis </li><li>  L'op√©rateur place la carte sur le lecteur Z-2 et enregistre le <strong>num√©ro</strong> dans le syst√®me de billetterie √©lectronique en saisissant manuellement le <strong>num√©ro de</strong> carte.  Pour le regroupement et l'enregistrement, un appel √† l'API HTTPS est effectu√© </li><li>  L'op√©rateur prend la carte suivante et la fait √† nouveau. </li></ul><br><p>  Une solution simple et rapide avec un <em>petit</em> inconv√©nient.  L'influence du facteur humain g√©n√®re des cartes fant√¥mes pour lesquelles le <strong>num√©ro</strong> imprim√© sur la carte ne correspond pas √† l' <strong>ID de</strong> lien - <strong>num√©ro</strong> dans la base de donn√©es syst√®me. </p><a name="habracut"></a><br><p>  Ainsi, l'√©nonc√© suivant du probl√®me est n√©: il est n√©cessaire d'imprimer le <strong>num√©ro</strong> , de noter l' <strong>ID</strong> et d'enregistrer les cartes NFC dans le syst√®me de mani√®re <strong>atomique</strong> et avec une implication humaine minimale. </p><br><p>  Dans cet article, nous d√©crirons tout l'√©quipement avec lequel nous avons travaill√© et tous les pi√®ges.  Au final, nous essaierons de dire quel √©quipement nous semble le mieux. </p><br><h3 id="11-nfc-karty">  1.1.  Cartes NFC </h3><br><p>  Nous avons examin√© les cartes NFC MIFARE Classic 1K et MIFARE DESFire EV2.  MIFARE Classic est le plus courant et le plus vuln√©rable √† la copie.  Cependant, ils continuent d'√™tre populaires dans des endroits comme les universit√©s et les transports publics.  Lors de la gestion des flux de tr√©sorerie, une solution plus fiable est n√©cessaire.  Les cartes MIFARE DESFire EV2 sont donc devenues une alternative.  Il s'agit de l'un des derniers types de cartes utilisant des algorithmes de cryptage DES, TDES (2KTDES, 3KTDES) et AES [2, 3].  En bref sur chaque carte: </p><br><p>  <em>MIFARE Classic</em> </p><br><p>  La carte m√©moire est un secteur et des blocs.  La premi√®re unit√© de m√©moire est un secteur.  Il y a 16 secteurs sur la carte, chacun ayant 4 blocs de donn√©es.  La m√©moire de chaque bloc est de 16 octets.  Pour lire et / ou √©crire des donn√©es, le lecteur doit se connecter au secteur.  Un bloc sp√©cial dans chaque secteur, le bloc de remorque, est con√ßu pour stocker les cl√©s.  Tout d'abord, pour travailler avec le secteur, vous devez vous connecter au bloc remorque.  Le bloc de remorque stocke √©galement 16 octets: 6 octets par type de cl√© A, 4 octets par droit d'acc√®s, 6 octets par type de cl√© B. </p><br><p>  La figure 1 [4] montre clairement les secteurs, les blocs et les cl√©s. </p><br><br><p><img src="https://habrastorage.org/webt/lj/mr/as/ljmrasis1ncssiee0chfn8ougie.png"><br>  Figure 1 - P√©riph√©rique m√©moire dans Mifare Classic </p><br><p>  <em>MIFARE DESFire</em> </p><br><p>  Le p√©riph√©rique de carte ressemble √† un syst√®me de fichiers.  La carte se compose d'applications et de fichiers.  Sur la carte, il y a une application principale (application) avec l'ID - 000000 (0x00, 0x00, 0x00).  √Ä l'int√©rieur de l'application principale, vous pouvez cr√©er une nouvelle application et cr√©er des fichiers de donn√©es √† l'int√©rieur. <br>  Les caract√©ristiques des cartes DESFire sont pr√©sent√©es dans la figure 2 [5].  Chaque application se voit attribuer ses propres cl√©s d'acc√®s aux fichiers d'application. </p><br><p><img src="https://habrastorage.org/webt/6q/xc/6f/6qxc6fkpk9i2jjpocy9v6iwgf0c.png"><br>  Figure 2 - Caract√©ristiques des cartes Mifare DESFire </p><br><h3 id="12-printery-kak-reshenie">  1.2.  Les imprimantes comme solution </h3><br><p>  Pour accomplir cette t√¢che, des imprimantes de cartes sp√©ciales sont utilis√©es.  √Ä l'heure actuelle, il existe de nombreuses soci√©t√©s diff√©rentes qui fournissent ces imprimantes.  Par exemple: Evolis, Smart, Zebra, Datacard, etc. Nous avons utilis√© les imprimantes <strong>Evolis Primacy</strong> et <strong>Smart-51</strong> .  Ces imprimantes ont beaucoup en commun au c≈ìur du travail: elles utilisent toutes deux des cartouches de bande pour l'impression et ont un principe de nettoyage similaire.  Il existe √©galement des diff√©rences - diff√©rents encodeurs NFC.  Les deux imprimantes peuvent √™tre compl√©t√©es ou remplac√©es en fonction des besoins du client. </p><br><p>  Les programmateurs pour cartes NFC s'appuient sur les normes ISO / IEC 14443A et ISO / IEC 7816-4 pour DESFire, ISO / IEC 14443 Type A pour Classic.  Cependant, selon le fabricant, les programmeurs peuvent soit accepter des commandes natives conform√©ment aux normes, soit encapsuler les commandes natives sp√©cifiquement pour un programmeur particulier.  Nous sommes face √† l'un et √† l'autre. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Primaut√© d'Evolis </th><th>  Smart-51 </th></tr></thead><tbody><tr><td>  Imprimer </td><td>  Le ruban est utilis√© pour l'impression (couleur ou monochrome).  Une cassette de bande enti√®re est fournie. </td><td>  Le ruban est utilis√© pour l'impression (couleur ou monochrome).  Seule la bande est fournie, une cartouche et est livr√©e avec l'imprimante elle-m√™me.  Un rouleau de nettoyage est inclus avec le ruban. </td></tr><tr><td>  Encodeur </td><td>  Encodeur Elyctis.  Facile √† utiliser car  prend en charge l'interaction avec les biblioth√®ques Windows par d√©faut pour la communication avec les cartes NFC, winscard. </td><td>  Encodeur DUALi.  Le support technique fournit un SDK sp√©cial pour travailler avec l'encodeur. </td></tr><tr><td>  Le nettoyage </td><td>  Pour maintenir l'imprimante en √©tat de fonctionnement, elle n√©cessite un nettoyage constant.  Il existe deux types de nettoyage: p√©riodique (apr√®s chaque 1000 cartes) et √©tendu (apr√®s 5000 cartes).  Le respect du programme de nettoyage est une condition pr√©alable √† l'accord de garantie. </td><td>  Le nettoyage est requis apr√®s l'utilisation du ruban imprim√©.  Selon le type de bande et la taille de l'image √† imprimer, un nettoyage sera n√©cessaire apr√®s 2 √† 4 000 cartes. </td></tr><tr><td>  Logement </td><td>  Le bo√Ætier en plastique permet √† l'imprimante d'√™tre assez l√©g√®re.  L'int√©rieur est facilement accessible, car les parois de l'imprimante s'ouvrent des deux c√¥t√©s. </td><td>  Le bo√Ætier m√©tallique rend l'imprimante fiable pour son fonctionnement.  Certains entrailles ne sont visibles qu'en ouvrant le capot sup√©rieur. </td></tr><tr><td>  Logiciels </td><td>  Livr√© avec le logiciel sp√©cial "Evolis Print Center" et CardPresso.  Le premier est n√©cessaire pour les param√®tres de l'imprimante, √©quip√© de divers assistants.  Le second logiciel vous permet de tester rapidement les capacit√©s de l'imprimante pour l'impression et l'encodage. </td><td>  Aucun logiciel distinct pour contr√¥ler l'imprimante n'est requis.  Assez de propri√©t√©s d'imprimante dans la liste des p√©riph√©riques Windows.  Livr√© avec le logiciel SmartID pour l'impression et l'encodage. </td></tr></tbody></table></div><br>  Tableau 1 - Comparaison d'Evolis Primacy et de Smart-51 <br><h3 id="2-eksperimenty">  2. Exp√©riences </h3><br><p>  En g√©n√©ral, le travail avec les imprimantes peut √™tre divis√© en plusieurs parties: communication avec le support technique, √©tude de l'interaction des cartes et des encodeurs, impression. </p><br><h3 id="21-vpechatlenie-ot-tehnicheskoy-podderzhki">  2.1.  Impression de support technique </h3><br><p>  Le travail avec les imprimantes comprenait une communication constante avec le support technique, car nous devions √©crire notre propre logiciel.  Dans les deux cas, nous avons davantage parl√© avec les distributeurs d'entreprises de notre pays et des pays voisins. </p><br><p>  Les distributeurs Evolis sont pour la plupart toujours en contact.  Cependant, presque imm√©diatement, les d√©tails des probl√®mes ont montr√© la n√©cessit√© d'une communication avec les repr√©sentants d'Evolis.  Malheureusement, ils ne nous ont pas communiqu√© leurs contacts et ont d√ª √©changer des messages via un distributeur.  Cependant, cela ne concernait que les probl√®mes d'impression; pour les probl√®mes de codage, nous avons re√ßu le courrier d'un repr√©sentant Elyctis.  La communication directe avec Elyctis a grandement simplifi√© le processus d'encodage.  Purement technique, nous nous sommes imm√©diatement compris et il n'y a pas eu de malentendu.  Dans le cas des exemples d'impression et de code pour Evolis Primacy, la communication s'est √† un moment donn√© arr√™t√©e.  Fondamentalement, l'impression n√©gative a √©t√© faite par les moments o√π les exemples d'impression recto verso ne fonctionnaient pas pour nous et il a fallu beaucoup de temps pour le prouver.  Je suis arriv√© aux enregistrements des processus d'impression sur vid√©o, apr√®s quoi des conseils plus productifs d'Evolis ont suivi. </p><br><p>  L'une des derni√®res questions du support technique Evolis √©tait de savoir comment connecter l'imprimante via Ethernet.  Pour le moment, nous connectons l'imprimante via USB √† l'ordinateur portable, ce qui est tol√©rable en pr√©sence de 1-2 imprimantes.  Les r√©ponses attendent toujours.  Cependant, une r√©ponse a d√©j√† √©t√© re√ßue d'Elyctis que leur encodeur pour l'imprimante Evolis Primacy ne fournit pas de connexion r√©seau. </p><br><p>  Communiquer avec le support technique Smart-51 se r√©sumait √©galement √† communiquer avec les repr√©sentants de l'entreprise via un distributeur.  Au tout d√©but, tout s'est bien pass√©.  Quand il s'agissait d'encoder des cartes comme Mifare DESFire, des probl√®mes ont commenc√©.  Des difficult√©s ont √©t√© caus√©es par des √©quipes sp√©cifiques que vous ne trouverez pas sur Internet.  Pour cette raison, il vous suffisait de copier certaines parties du code de travail fourni par le fabricant √† titre d'exemple.  Cependant, une copie irr√©fl√©chie ne m√®ne pas au bien.  En cons√©quence, deux semaines ont √©t√© pass√©es √† expliquer l'erreur au fabricant, du c√¥t√© duquel l'homme √©tait clairement assis, pas tr√®s proche des subtilit√©s du syst√®me, mais avec lui une documentation g√©n√©rale.  Un pr√©cipit√© d√©sagr√©able est rest√©, mais il a tr√®s bien commenc√©. </p><br><p>  La communication par le biais d'un distributeur n'a aucun avantage, aucun inconv√©nient solide.  Par exemple: </p><br><ol><li>  R√©ponses diff√©r√©es, car la personne responsable du c√¥t√© du distributeur peut √™tre occup√©e √† d'autres choses ou partir en vacances. </li><li>  Lorsque le distributeur se trouve dans un autre pays, il s'agit donc de jours f√©ri√©s suppl√©mentaires et non de jours ouvrables.  Dans le cas de Smart-51, la communication a eu lieu avec la participation de personnes de 3 pays. </li><li>  Les r√©ponses ne sont pas transmises.  Le texte de la r√©ponse est ins√©r√© dans une nouvelle lettre du distributeur.  Pour cette raison, les fichiers joints sont parfois perdus et n'atteignent pas imm√©diatement. </li><li>  Il n'y a aucune certitude claire que votre message a atteint le fabricant inchang√©. </li></ol><br><p>  Vous trouverez ci-dessous un tableau avec le nombre de lettres qui ont constitu√© la communication avec l'assistance technique.  Fondamentalement, les questions pour Evolis et Smart √©taient √† peu pr√®s les m√™mes.  Par exemple, "Pourquoi l'impression n'est-elle pas d'une couleur uniforme? Avez-vous des exemples de code en C # ou Java?"  et des questions plus sp√©cifiques sur les raisons pour lesquelles quelque chose ne fonctionne pas comme pr√©vu. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Evolis </th><th>  Elyctis </th><th>  Smart-51 </th></tr></thead><tbody><tr><td>  Nombre de lettres </td><td>  97 </td><td>  37 </td><td>  61 </td></tr></tbody></table></div><br>  Tableau 2 - Comparaison du nombre d'e-mails avec le support technique <br><h3 id="22-kodirovka">  2.2.  Encodage </h3><br><p>  La communication avec le lecteur se fait via les commandes APDU.  APDU (Application Protocol Data Unit) est un format standard pour la communication entre une carte et un lecteur.  Cet article d√©crira les √©quipes APDU de base pour MIFARE Classic et MIFARE DESFire. </p><br><div class="scrollable-table"><table><thead><tr><th>  Le titre </th><th>  La taille </th><th>  La description </th></tr></thead><tbody><tr><td>  CLA </td><td>  1 octet </td><td>  Octets de classe </td></tr><tr><td>  Ins </td><td>  1 octet </td><td>  Octet d'instruction </td></tr><tr><td>  P1 </td><td>  1 octet </td><td>  Param√®tre 1 </td></tr><tr><td>  P2 </td><td>  1 octet </td><td>  Param√®tre 2 </td></tr><tr><td>  Longueur des donn√©es </td><td>  1 octet </td><td>  Taille des donn√©es transmises </td></tr><tr><td>  Les donn√©es </td><td>  ... </td><td>  Donn√©es transmises </td></tr><tr><td>  Longueur de donn√©es attendue </td><td>  1 octet </td><td>  La taille des donn√©es attendues dans la r√©ponse </td></tr></tbody></table></div><br>  Tableau 3 - Format des commandes APDU <br><div class="scrollable-table"><table><thead><tr><th>  Le titre </th><th>  La taille </th><th>  La description </th></tr></thead><tbody><tr><td>  SW1 </td><td>  1 octet </td><td>  Code d'erreur ou de r√©ussite courant </td></tr><tr><td>  SW2 </td><td>  1 octet </td><td>  Code d'erreur d√©taill√© </td></tr><tr><td>  Les donn√©es </td><td>  ... </td><td>  Renvoyer les donn√©es </td></tr></tbody></table></div><br>  Tableau 4 - Format de r√©ponse APDU <br><p>  Une description de tous les codes de r√©ponse possibles peut √™tre trouv√©e ici [6].  Un dispositif pour communiquer des cartes avec un lecteur peut √™tre trouv√© √† [7]. </p><br><p>  Un bref algorithme de codage est le suivant: </p><br><ol><li>  Obtenez l'UID de la carte.  Il s'agit d'un num√©ro unique, il est flash√© par le fournisseur et ne change pas. </li><li>  Lisez les donn√©es de chaque secteur: <br>  2.1 Connectez-vous au secteur √† l'aide de la cl√© par d√©faut (0x00 ou 0xFF) <br>  2.2 Lire les donn√©es de trois blocs de donn√©es </li><li>  Si les donn√©es lues sont vides, acc√©dez √† l'enregistrement de donn√©es <br>  3.1 Connectez-vous au secteur √† l'aide de la cl√© par d√©faut (0x00 ou 0xFF) <br>  3.2 √âcrire des donn√©es dans trois blocs de donn√©es sectoriels <br>  3.3 Cr√©er une nouvelle cl√© bas√©e sur l'UID de la carte <br>  3.4 Remplacez la cl√© d'autorisation dans le bloc de fin par une nouvelle cl√©. </li></ol><br><h3 id="221-elyctis">  2.2.1.  Elyctis </h3><br><p>  L'imprimante Evolis utilise un <strong>lecteur ELYCTIS CL</strong> .  En utilisant la biblioth√®que <strong>WinSCard</strong> (C ++ et C #) et jnasmartcardio (java), vous pouvez facilement interagir avec le lecteur.  Afin de cr√©er rapidement un logiciel avec une interface assez simple, il a √©t√© d√©cid√© d'√©crire du code en <strong>C #</strong> .  G√©n√©ralement, notre √©quipe √©crit du code en Java, ce qui a rendu la transition vers C # moins p√©nible.  Egalement en faveur de C #, le fait que Windows est plus adapt√© pour travailler avec des imprimantes. </p><br><p>  Le tableau ci-dessous montre des exemples de commandes APDU natives accept√©es par le lecteur Elyctis. </p><br><div class="scrollable-table"><table><thead><tr><th>  La description </th><th>  Les donn√©es </th><th>  APDU </th></tr></thead><tbody><tr><td>  Obtention d'une carte UID </td><td>  - </td><td>  <strong>0xFF 0xCA 0x00 0x00 0x00</strong> </td></tr><tr><td>  Chargement de la cl√© d'autorisation dans la m√©moire du lecteur </td><td>  Touche 6 octets </td><td>  Un exemple de chargement d'une cl√© par d√©faut.  <strong>0xFF 0x82 0x20 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00</strong> </td></tr><tr><td>  Se connecter </td><td>  Num√©ro de bloc d'autorisation de secteur (3e bloc de secteur) et type de cl√© (A - 0x60 ou B - 0x61) </td><td>  Un exemple d'autorisation au secteur 1. Les num√©ros de bloc de ce secteur sont 4-7, le bloc de fin est le num√©ro 7. <strong>0xFF 0x86 0x00 0x00 0X05 0x01 0x00 0x07 0X60 0x00 0x00</strong> </td></tr><tr><td>  Lecture des donn√©es d'un bloc </td><td>  - </td><td>  Un exemple de lecture des donn√©es du bloc 4 (1er bloc du secteur 1).  Le num√©ro de secteur est entr√© dans le param√®tre 2. 0xFF 0xB0 0x00 0x04 0x00 0x10 </td></tr><tr><td>  √âcriture de donn√©es dans le bloc </td><td>  16 octets de donn√©es </td><td>  Un exemple d'√©criture de donn√©es dans le bloc 4. <strong>0xFF 0xD6 0x00 0x04 0x10 0x11 0x22 0x33 0x44 0x55 0x66 0x77 0x88 0x11 0x22 0x33 0x44 0x55 0x66 0x77 0x88 0x00</strong> </td></tr></tbody></table></div><br>  Tableau 5 - Exemples de commandes APDU pour Mifare Classic <br><p>  Apr√®s avoir v√©rifi√© que l'encodage des cartes comme Mifare Classic a r√©ussi, nous sommes pass√©s aux <strong>commandes pour DESFire</strong> .  Par r√©f√©rence [8], vous pouvez trouver des exemples simples de commandes avec des explications.  Cependant, d√©j√† dans l'√©quipe d'autorisation, nous sommes tomb√©s sur un comportement de lecteur int√©ressant.  Bref, le lecteur a lui-m√™me fait pleine autorisation.  Il s'est av√©r√© que le support technique d'Elyctis nous a fourni un firmware sp√©cial qui comprenait l' <em>intelligence easyDESFire</em> .  Il suffit de d√©terminer l'algorithme de chiffrement utilis√© par le lecteur.  Dans notre cas, c'√©tait 3DES. </p><br><p>  Dans des cas normaux, l'autorisation est effectu√©e en √©changeant plusieurs messages. </p><br><ol><li>  Nous envoyons la commande APDU pour autorisation: <strong>0x90 0x0A 0x00 0x00 0x00 0x00</strong> . </li><li>  Selon l'algorithme, un tableau de 8 octets al√©atoires encod√©s par la cl√© de la carte vient en r√©ponse √† la commande; nous le d√©signons par <strong>RandBEnc</strong> . </li><li>  <strong>Nous d√©chiffrons RandBEnc</strong> et faisons un d√©calage d'octet vers la gauche.  Notons le r√©sultat de <strong>RandBLeft</strong> . </li><li>  Nous g√©n√©rons de notre c√¥t√© un tableau de 8 octets al√©atoires, <strong>RandA</strong> . </li><li>  <strong>Nous regroupons RandA</strong> et <strong>RandBLeft</strong> , <strong>chiffrons</strong> avec la cl√© de la carte et envoyons le tableau r√©sultant de 16 octets. </li><li>  Nous obtenons la cl√© de session en r√©ponse, nous connectant ainsi √† l'application sur la carte. </li></ol><br><p>  Plus de d√©tails sur le processus d'autorisation peuvent √™tre trouv√©s ici [9].  Le code du github est √©galement tr√®s utile [10]. </p><br><p>  Pendant l'encodage, des probl√®mes sont survenus avec l'utilisation des commandes de la source [8].  Avec l'aide du support technique d'Elyctis, nous avons re√ßu les commandes n√©cessaires adapt√©es √† l' <em>intelligence easyDESFire</em> . </p><br><p>  Lors de l'encodage sur Elyctis, un gros <strong>probl√®me du</strong> lecteur a √©t√© r√©v√©l√© - le <strong>retard de communication</strong> .  Tr√®s souvent, les signaux n'atteignent pas le lecteur, de sorte que la m√™me commande doit parfois √™tre envoy√©e plusieurs fois.  Ce comportement est moins courant, mais est toujours remarqu√© lors de l'envoi de commandes d'impression.  Par cons√©quent, l'envoi de toutes les commandes a lieu dans une boucle, jusqu'√† l'ex√©cution r√©ussie. </p><br><h3 id="222-duali">  2.2.2.  DUALi </h3><br><p>  Le fabricant donne son SDK pour travailler avec un encodeur DUALi.  Au stade de travailler avec Mifare Classic, les commandes de lecture et d'√©criture pouvaient √™tre extraites du code mod√®le que les distributeurs nous avaient donn√©.  Les exemples √©taient en C ++, Visual Basic, Java.  Cependant, il √©tait possible de compiler enti√®rement le code uniquement en C ++.  A la premi√®re demande d'un exemple de code C #, on nous a refus√©, ou plut√¥t, le distributeur n'en a pas.  Il n'y a pas de programmeurs C ++ confiants dans notre √©quipe, donc √©crire tout le code a √©t√© grandement compliqu√© par des choses assez simples.  Par exemple: </p><br><ol><li>  Travailler avec des tableaux <br>  Lors du passage d'un tableau en tant que param√®tre √† une fonction, nous n'avons pas transmis la taille du tableau.  Pour d√©terminer la longueur du tableau, la fonction sizeOf () a √©t√© utilis√©e.  Cependant, la fonction a constamment renvoy√© une taille de 4, quelle que soit la taille r√©elle du tableau.  Ce comportement n'a pas √©t√© imm√©diatement enregistr√©, car certains tableaux √©taient en effet de taille 4. </li><li>  Configurer toutes les biblioth√®ques <br>  Beaucoup de douleur a √©t√© ressentie lors de l'installation de tous les environnements n√©cessaires.  Nous sommes trop habitu√©s √† des choses comme maven et apt (sur Ubuntu).  Notre programme √©tait cens√© appeler l'API backend via des requ√™tes HTTP et crypter les donn√©es en Base64.  Pour cela, il a √©t√© d√©cid√© d'utiliser les biblioth√®ques libcurl et openssl.  L'√©criture du programme lui-m√™me a eu lieu dans l'environnement Microsoft Visual Studio.  La plus longue histoire avec l'installation de libcurl. </li></ol><br><p>  Le SDK lui-m√™me est une biblioth√®que de DLL √©crite en C ++.  Gr√¢ce √† l'exemple de code, nous avons √©crit assez rapidement un programme pour interagir avec la carte Mifare Classic.  Comme mentionn√© ci-dessus, les commandes APDU pour DUALi √©taient tr√®s sp√©cifiques, √† savoir que les deux premiers octets ne correspondaient pas √† ceux qui peuvent √™tre trouv√©s sur Internet.  Pour cette raison, j'ai d√ª les copier √† l'aveugle, car, en principe, tout fonctionne comme pr√©vu.  Les probl√®mes commencent par les tests avec les cartes DESFire. </p><br><p>  Le principe des commandes APDU pour <strong>DESFire</strong> dans DUALi est au moins compr√©hensible.  Il y a deux octets pour <strong>{CLA, INS}</strong> , ils ne changent pas, et en fait ils disent que la commande est destin√©e √† des cartes comme DESFire.  Les param√®tres 1 et 2 ne changent pas non plus.  Les donn√©es transmises contiennent d√©j√† une partie de la commande native DESFire, √† savoir les octets <strong>{INS, Data}</strong> .  Pendant environ une semaine, nous n'avons pas pu obtenir les r√©ponses attendues aux commandes simples, par exemple, la commande "s√©lectionner l'application".  Au tout d√©but du code, nous avons laiss√© l'ex√©cution APDU de la commande GetCardStatus, qui n'√©tait pas un format de commande pour DESFire.  Cependant, elle a travaill√© et d√©livr√© des cartes UID.  Il s'est av√©r√© que, apr√®s l'ex√©cution de GetCardStatus DESFire, les √©quipes ont cess√© de fonctionner.  Cette omission a √©t√© d√©termin√©e par nos forces, apr√®s un dialogue d'une semaine avec le fournisseur, qui n'a abouti √† rien. </p><br><p>  Apr√®s un mois de fonctionnement stable de notre programme, nous sommes arriv√©s √† la n√©cessit√© de r√©√©crire le programme en C #.  La principale raison √©tait la mise en place de CI.  Le programme C ++ a √©t√© compil√© √† l'aide de Microsoft Visual Studio.  Tous nos serveurs fonctionnent sous Linux, donc le lancement du docker avec Windows et le n√©cessaire Visual Studio ToolKit n'√©tait pas possible.  Bien s√ªr, vous pouvez cr√©er une machine virtuelle avec Windows et tout configurer pour C ++, mais je ne voulais pas vraiment.  Apr√®s avoir demand√© √† plusieurs reprises un exemple de code C # au fabricant, nous avons re√ßu un exemple.  Vous pouvez l'√©crire vous-m√™me, sur la base des d√©finitions de m√©thode dans l'exemple d'interface C ++, mais il s'est av√©r√© que toutes les fonctions n'√©taient pas d√©crites.  L'exemple a beaucoup aid√© et √† la fin nous avons r√©√©crit le programme en C # et mis en place CI. </p><br><h3 id="23-pechat">  2.3.  Imprimer </h3><br><p>  √Ä premi√®re vue, il semble que l'impression ne devrait pas poser de probl√®mes, car nous utilisons en premier lieu des imprimantes d'impression.       ,    ,            . </p><br><p>       .       ,       ,   . </p><br><h3 id="231-pechat-na-evolis-primacy"> 2.3.1.   Evolis Primacy </h3><br><p>     JSON ,   HTTP .    Evolis Services Provider,          .      8 : </p><br><ol><li>      </li><li>   </li><li>   :  ,   ,  . . </li><li>    </li><li>     </li><li>    </li><li>   </li><li>    </li></ol><br><p>     -  4-6, . .               .      .         SDK,       .     . <br>      : </p><br><ol><li>   <br>       . </li><li>   <br>      . </li></ol><br><p>                    .          ,      .           .    ,   .          .         .      ,   ,         ,  3. </p><br><img src="https://habrastorage.org/webt/pa/4_/i8/pa4_i8xhdbhicczzxejgvzayzne.jpeg" alt="drawing" width="300"><br><p>  3 ‚Äî    </p><br><p>     3         . </p><br><p>             , . .    QR-.      ,        QR-  .     ,     ,  4  6 . </p><br><p>   , Evolis ,   Evolis Print Center,     ,    ,              .            . </p><br><h3 id="232-pechat-na-smart-51"> 2.3.2.   Smart-51 </h3><br><p>     ,     SmartID,     .      ,      Evolis.        : </p><br><ol><li>   ,        . </li><li>     ,     . </li></ol><br><p>          ,     .       Smart-51.   : </p><br><ol><li>      </li><li>    ,  . </li><li>   </li><li>   </li><li>    ,   QR- </li><li>   </li><li>   </li><li>    </li></ol><br><p>    ,     User Manuals .      ,         ,        . </p><br><h3 id="233-obschie-problemy-s-pechatyu"> 2.3.3.     </h3><br><p>    ,        .      ,      ,         .           .        .      ,    . </p><br><p>      Evolis Primacy    100 ,   0,76 .      ,  86 .   Smart-51    100 ,          .   ,      . </p><br><h3 id="3-rezultaty"> 3.  </h3><br><p>         .        .        .     17 .        . </p><br><div class="scrollable-table"><table><thead><tr><th>  </th><th>  ,  </th><th>  ,  </th><th>  Total </th></tr></thead><tbody><tr><td> Evolis Primacy </td><td> ‚âà 10 </td><td> ‚âà 10 </td><td> ‚âà 20 </td></tr><tr><td> Smart-51 </td><td> ‚âà 17 </td><td> ‚âà 6 </td><td> ‚âà 23 </td></tr></tbody></table></div><br><img src="https://habrastorage.org/webt/aa/tu/r2/aatur26peetmxaj2ynj4jxwxshm.jpeg" alt="drawing" width="400"><br><p> ) </p><br><img src="https://habrastorage.org/webt/ll/y1/ed/lly1edhu6n42rdbybxn4-gwvniu.jpeg" alt="drawing" width="400"><br><p> ) <br>  4 ‚Äî  :  ‚Äî  ,  ‚Äî   </p><br><h3 id="4-zaklyuchenie"> 4.  </h3><br><p>         NFC   -.      , ..      .   Smart-51   Evolis Primacy.    Evolis       ,     . Smart-51             .       Smart-51      Evolis.              ,   .  Evolis Primacy   ,     .      .  Smart-51    .   ,          . </p><br><p>       , ..         .              ,         . </p><br><h3 id="spisok-literatury">  Les r√©f√©rences </h3><br><ol><li> <a href="https://ironlogic.ru/il.nsf/htm/ru_z2usb">https://ironlogic.ru/il.nsf/htm/ru_z2usb</a> </li><li> <a href="https://www.nxp.com/products/rfid-nfc/mifare-hf/mifare-desfire/mifare-desfire-ev2:MIFARE_DESFIRE_EV2_2K_8K">https://www.nxp.com/products/rfid-nfc/mifare-hf/mifare-desfire/mifare-desfire-ev2:MIFARE_DESFIRE_EV2_2K_8K</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf">https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf">https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf">https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf</a> </li><li> <a href="https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses/">https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses/</a> </li><li> Advanced Card Systems Guide <a href="http://downloads.acs.com.hk/drivers/en/API-ACR122U-2.02.pdf">http://downloads.acs.com.hk/drivers/en/API-ACR122U-2.02.pdf</a> </li><li> Mifare Desfire communication example <a href="https://ridrix.wordpress.com/2009/09/19/mifare-desfire-communication-example/">https://ridrix.wordpress.com/2009/09/19/mifare-desfire-communication-example/</a> </li><li> Mifare DESFire Data Sheet <a href="http://neteril.org/files/M075031_desfire.pdf">http://neteril.org/files/M075031_desfire.pdf</a> </li><li>   GitHub  DESFire <a href="">https://github.com/EsupPortail/esup-nfc-tag-server/blob/master/src/main/java/nfcjlib/core/DESFireEV1.java</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481734/">https://habr.com/ru/post/fr481734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481716/index.html">Programmation r√©active, √ßa vaut le coup de tout laisser tomber et de se pr√©cipiter vers le r√™ve</a></li>
<li><a href="../fr481718/index.html">11 facteurs et astuces de vie qui augmenteront votre efficacit√©</a></li>
<li><a href="../fr481726/index.html">Laravel Routage localis√©</a></li>
<li><a href="../fr481728/index.html">Pry -> REPL pour Ruby, qui en vaut la peine</a></li>
<li><a href="../fr481730/index.html">√âcout√© MPow T6 - un excellent casque TWS avec des commandes pratiques</a></li>
<li><a href="../fr481736/index.html">Sur quoi construire l'infrastructure Wi-Fi 6?</a></li>
<li><a href="../fr481738/index.html">T√¢ches de programmation - Une mauvaise fa√ßon d'√©valuer les qualifications des d√©veloppeurs seniors</a></li>
<li><a href="../fr481740/index.html">La lumi√®re bleue perturbe-t-elle le biorythme humain?</a></li>
<li><a href="../fr481742/index.html">Strat√©gie Apple. Lier l'OS au mat√©riel - avantage ou inconv√©nient concurrentiel?</a></li>
<li><a href="../fr481746/index.html">Configuration de l'environnement dans la CLI. Terminal WSL / Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>