<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì∑ üßìüèº üéõÔ∏è Hidroponia no peitoril da janela ou C ++ 11 em microcontroladores AVR üîï üë©üèª üíÜüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O projeto n√£o cont√©m Arduino
 
 
 Originalmente, esse projeto tinha que parecer diferente - uma estrutura monumental composta por um pedestal com lata...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hidroponia no peitoril da janela ou C ++ 11 em microcontroladores AVR</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/385135/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O projeto n√£o cont√©m Arduino</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/911/af2/659/911af265948b47c6933b93c9ff846e34.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Originalmente, esse projeto tinha que parecer diferente - uma estrutura monumental composta por um pedestal com latas e bombas, um aqu√°rio montado sobre ele e um o√°sis de tomate em cima. Planejou-se uma cachoeira no para√≠so de um o√°sis de tomate e formas de vida de peixes no aqu√°rio, cujo principal requisito era a capacidade de comer os habitantes n√£o planejados do aqu√°rio e manter o copo limpo; os principais candidatos s√£o somiki e gourami. Como voc√™ deve ter adivinhado, meu lema √© "a pregui√ßa √© o motor do progresso" (e o que voc√™ pode fazer para n√£o limpar o aqu√°rio e n√£o molhar os tomates).</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um monumento a esse lema provavelmente teria sido erguido se ainda n√£o tivesse entrado em colapso na fase de coordena√ß√£o dos esbo√ßos com sua esposa. Ela n√£o se inspirou na id√©ia de fazer dessa bandura a principal decora√ß√£o da sala de estar, e nem a cachoeira a convenceu disso. Mas a id√©ia de um sistema aut√¥nomo, uma simbiose de biologia e eletr√¥nica, n√£o queria sair da minha cabe√ßa, e o projeto reduziu-se ao tamanho de um vaso de flores - a aquaponia se transformou em hidroponia, a vida dos peixes foi salva.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A id√©ia principal da hidroponia √© o uso de uma solu√ß√£o aquosa de nutrientes em vez do solo. Isso permite que uma ordem de magnitude acelere o crescimento das plantas. No entanto, n√£o se pode apenas baixar as ra√≠zes na √°gua - elas precisam de oxig√™nio, sem as quais come√ßar√£o a morrer. Nesse sentido, existem op√ß√µes - soprar √°gua constantemente com um compressor, como em um aqu√°rio, ou inundar periodicamente as ra√≠zes com uma solu√ß√£o nutritiva e dren√°-la depois de algum tempo. A primeira op√ß√£o tem uma desvantagem - o zumbido constante do compressor. A segunda op√ß√£o tem uma vantagem - a maioria das ra√≠zes est√° no ar, respirando ativamente, e o efeito de acelerar o crescimento deve ser ainda maior. Al√©m disso, eles s√£o imersos em um substrato de gr√¢nulos porosos especiais que ret√™m a umidade. A escolha foi √≥bvia, tomei a segunda op√ß√£o como base.No caso dos peixes, o sistema pode estar quase completamente fechado - as secre√ß√µes de peixes s√£o processadas por bact√©rias especiais em um biofiltro, o produto processado √© alimentado √†s plantas, uma camada de areia filtra a √°gua e a √°gua limpa √© devolvida ao aqu√°rio. Em um caso ideal, as ra√ß√µes s√£o ocasionalmente polvilhadas em um alimentador autom√°tico, e os tomates se juntam dos arbustos. Mas n√£o cresceu juntos, talvez seja para melhor - quem sabe como terminaria o pedido pelo correio de uma cepa das bact√©rias necess√°rias.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, o dispositivo do tomateiro ganhou contornos. </font><font style="vertical-align: inherit;">Dois vasos - o mais baixo com √°gua, o superior com um substrato e uma planta. </font><font style="vertical-align: inherit;">Para inunda√ß√µes, usaremos uma pequena bomba chinesa com motor DC, para drenagem, usaremos um sif√£o autom√°tico. </font><font style="vertical-align: inherit;">O princ√≠pio de opera√ß√£o do sif√£o no v√≠deo:</font></font><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/5wZ9PQepQYI%3Ffeature%3Doembed&amp;usg=ALkJrhjgq9hGrX7bWeDjIl9JXa5sSpHiUg" frameborder="0" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hidroponia com um sif√£o semelhante:</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/ZHaiVhVZ3kM%3Ffeature%3Doembed&amp;usg=ALkJrhjzut0aEVhY_jTNchrF6RZ8a8jUfQ" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√©rebro do dispositivo √© o microcontrolador ATMEGA328P (simplesmente porque o placer estava √† m√£o). Suas tarefas incluem gerenciar as inunda√ß√µes e descargas de acordo com um cronograma, monitorar o n√≠vel da √°gua no tanque e sinalizar sua falta, controlar a ilumina√ß√£o da usina (queremos ter uma certa dura√ß√£o m√≠nima da luz do dia; quando a luz natural termina, a luz artificial √© ativada gradualmente), uma interface de usu√°rio para visualiza√ß√£o o status, gerenciamento e configura√ß√£o de toda essa economia. Obviamente, isso requer algum tipo de solu√ß√£o para o sensor de n√≠vel de √°gua, sensores de luz, um rel√≥gio em tempo real e algum tipo de terminal do usu√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de descrever os detalhes, uma lista de recursos do projeto: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> voc√™ pode ver fotos do resultado e do processo de fabrica√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√≠deo curto:</font></font><br>
<br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/C_qit2_2rrY%3Ffeature%3Doembed&amp;usg=ALkJrhjdB1skY3oWkaB5ag0q_74y5OvoQw" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O projeto est√° dispon√≠vel no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L√°, nas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vers√µes, √© apresentado um</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> arquivo com o projeto de pe√ßa eletr√¥nica no KiCAD e os projetos de sinos e assobios de design no SolidWorks (arquivos STL para impress√£o s√£o anexados).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recursos do conjunto do firmware</font></font></b><div class="spoiler_text">      ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>    ¬´ ¬ª.    ,   , ,        USB    AVR (,   ,    ,     ,      ),               .  -    ,     ,    'ADK_ROOT'     ,        'scons'.<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esquema da parte eletr√¥nica: </font></font><br>
<br>
<img src="https://habrastorage.org/files/cfc/96b/dad/cfc96bdad51648caa640d661ac6ffc40.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais detalhes, uma descri√ß√£o das armadilhas e um pouco de c√≥digo. </font><font style="vertical-align: inherit;">Descri√ß√£o dos problemas de software </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no final</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Talvez algu√©m esteja interessado em ver um novo exemplo de trabalho com I2C, um valcoder, um m√≥dulo RTC e uma tela gr√°fica. </font><font style="vertical-align: inherit;">Todo o c√≥digo do projeto foi escrito "do zero" sem o uso de solu√ß√µes de terceiros (porque eu posso).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor de n√≠vel de √°gua</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A quest√£o mais sens√≠vel foi decidida primeiro. Havia, √© claro, uma variante de algum tipo de flutuador para que, por exemplo, movesse o trilho no qual o c√≥digo Gray foi aplicado e os sensores √≥pticos fossem lidos. Mas realmente n√£o parecia confi√°vel. A pesquisa no eBay n√£o deu resultado - havia interruptores de b√≥ia (atingiram o n√≠vel desejado ou n√£o) ou eletrodos e leituras imersos com base na condutividade do meio, mas isso foi imediatamente observado, pois a composi√ß√£o da √°gua mudava constantemente junto com a condutividade dos fertilizantes e dissolu√ß√£o adicionados impurezas do substrato. Como resultado, surgiu a id√©ia de usar um tel√™metro ultrass√¥nico, um daqueles que geralmente s√£o colocados em rob√¥s diferentes. Conforme planejado, o sensor √© colocado na tampa do tanque e o sinal √© refletido diretamente da superf√≠cie da √°gua. Foi adquirido o HC-SR04 (a escolha do menor valor da dist√¢ncia m√≠nima de trabalho - ele tem 2cm),e o conceito foi verificado em um balde de √°gua. Descobriu-se que funcionava por si pr√≥prio (havia receios de que n√£o houvesse reflexo normal da superf√≠cie da √°gua ou que n√£o houvesse diretividade suficiente do feixe e haveria reflexos indesejados nas paredes do tanque). A prop√≥sito, o tel√™metro tamb√©m era uma op√ß√£o de backup, mas infravermelho. Na superf√≠cie da √°gua era para jogar uma b√≥ia com um refletor. O √∫nico problema √© a dist√¢ncia m√≠nima de trabalho de 10 cm (daquelas que encontrei), que j√° √© um pouco demais para as dimens√µes especificadas.Na superf√≠cie da √°gua era para jogar uma b√≥ia com um refletor. O √∫nico problema √© a dist√¢ncia m√≠nima de trabalho de 10 cm (daquelas que encontrei), que j√° √© um pouco demais para as dimens√µes especificadas.Na superf√≠cie da √°gua era para jogar uma b√≥ia com um refletor. O √∫nico problema √© a dist√¢ncia m√≠nima de trabalho de 10 cm (daquelas que encontrei), que j√° √© um pouco demais para as dimens√µes especificadas.</font></font><br>
<br>
<img src="https://habrastorage.org/files/ee1/7ac/b85/ee17acb8500c4a94b65014c08d3df694.jpg"><br>
<img src="https://habrastorage.org/files/cd2/558/d46/cd2558d46164418f95b883a60c20c213.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acordo com os resultados do projeto, essa abordagem est√° funcionando e pode ser usada na pr√°tica, sem problemas. Vale a pena tomar medidas para isolar a placa da umidade (veda√ß√£o no caso). Isso √© apenas o pr√≥prio sensor permanecer aberto, talvez ele ainda esteja por a√≠.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A interface do sensor √© simples - um pulso √© enviado √† entrada do acionador, que aciona um sinal de eco. Um pulso √© gerado na sa√≠da de eco, cuja dura√ß√£o √© igual ao tempo desde o in√≠cio da radia√ß√£o at√© a aceita√ß√£o do sinal de eco refletido. Medindo a dura√ß√£o do pulso, conhecendo a velocidade do som e o fato de o sinal ir para o objeto e voltar, voc√™ pode calcular a dist√¢ncia. No projeto, isso √© implementado na classe LevelGauge. Para medir o comprimento do pulso, √© usada a capacidade de hardware da ‚Äúcaptura de entrada‚Äù do MK AVR. Nesse caso, o temporizador do hardware √© redefinido na borda ascendente do pulso e, no valor descendente do temporizador, o hardware √© armazenado no registro ICR1 e √© gerada uma interrup√ß√£o. Assim, √© poss√≠vel medir a dura√ß√£o do pulso com precis√£o suficiente e um consumo m√≠nimo de tempo do processador.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo com esse modelo de sensor, uma falha foi notada - quando a energia era aplicada, a linha de eco permanecia constantemente ativa. </font><font style="vertical-align: inherit;">Ele ignorou aplicando um pulso ao gatilho e esperando at√© o primeiro ciclo de eco-localiza√ß√£o passar.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luz de fundo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A luz de fundo √© feita por tr√™s LEDs de ader√™ncia. </font><font style="vertical-align: inherit;">Inclinei a moldura triangular do perfil de alum√≠nio e colei os LEDs com ep√≥xi. </font><font style="vertical-align: inherit;">Encomendei um estabilizador de corrente chin√™s a 700mA para alimenta√ß√£o. </font><font style="vertical-align: inherit;">Quedas de cerca de tr√™s volts em cada diodo, o estabilizador requer uma diferen√ßa entre as tens√µes de entrada e sa√≠da de pelo menos dois volts, e eu iria alimentar a wunderwafer inteira de uma fonte de alimenta√ß√£o de 12 volts. </font><font style="vertical-align: inherit;">A partir daqui, √© f√°cil calcular por que exatamente tr√™s LEDs.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os diodos s√£o brancos quentes. Pareceu-me natural, o espectro solar e tudo isso. Mas, como descobri mais tarde, depois que as pedi, as plantas geralmente usam uma combina√ß√£o de vermelho e azul. Tanto quanto eu entendo, toda a quest√£o √© apenas em efici√™ncia. Se voc√™ tem uma fazenda grande com ilumina√ß√£o 24 horas, est√° interessado em que toda a energia gasta seja gasta para sempre. Sob ilumina√ß√£o branca, as folhas verdes refletem o componente verde, uma parte significativa da energia gasta em ilumina√ß√£o ser√° desperdi√ßada.</font></font><br>
<br>
<img src="https://habrastorage.org/files/b75/39b/561/b7539b5610cf43039f95a393567ce5ce.jpg"><br>
<img src="https://habrastorage.org/files/6e3/a21/084/6e3a2108427a44518658b276d5affe3c.JPG"><br>
<img src="https://habrastorage.org/files/1af/253/8d1/1af2538d188c4dfe962d915a09bb2fba.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma caracter√≠stica importante do estabilizador √© a presen√ßa de uma entrada para regula√ß√£o PWM, que eu uso para ajustar o brilho. Aqui est√° outro rake chin√™s. Em primeiro lugar, acabou sendo apenas uma fun√ß√£o de ativa√ß√£o / desativa√ß√£o atual. Ou seja, eu esperava que a corrente de sa√≠da n√£o fosse modulada e seu valor dependesse do ciclo de trabalho do sinal PWM, mas a corrente simplesmente repetiu os pulsos na entrada de controle. Mas isso n√£o √© t√£o ruim, outra emboscada foi que o regulador reage inadequadamente ao PWM com uma frequ√™ncia bastante alta. Eu tive que abaix√°-lo para 300Hz, no qual funcionava mais ou menos normalmente. O sinal PWM √© gerado pelo microcontrolador no hardware usando um dos temporizadores.</font></font><br>
<br>
<img src="https://habrastorage.org/files/fde/4a1/3d6/fde4a13d69f04e909fe2fafbcb526ed4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra parte importante do conjunto da luz de fundo s√£o os sensores de luz. Fototransistores foram selecionados nesta fun√ß√£o. E sim, existem dois deles - um acima dos LEDs para medir a luz natural, o segundo sob os LEDs para fornecer feedback. √â verdade que a funcionalidade de extens√£o autom√°tica da luz do dia ainda n√£o foi implementada, como no ver√£o, e n√£o era necess√°ria (e a motiva√ß√£o √© um assunto s√©rio). Supunha-se que, assim que o primeiro sensor detecta uma diminui√ß√£o no n√≠vel de ilumina√ß√£o (e o tempo alocado para o dia ainda n√£o expirou), a luz √© regulada para que o segundo sensor produza um n√≠vel correspondente √† ilumina√ß√£o desejada. Para fazer isso, voc√™ precisa implementar um controlador PID simples no c√≥digo. Por√©m, enquanto estiver na interface, voc√™ poder√° ver apenas as leituras atuais do sensor e aumentar manualmente o brilho da luz de fundo desejada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Preste aten√ß√£o na conex√£o dos sensores. </font><font style="vertical-align: inherit;">Cada um deles tem duas faixas fixas, que s√£o selecionadas conectando a zero o resistor correspondente. </font><font style="vertical-align: inherit;">O p√© do microcontrolador, conectado ao segundo resistor, neste momento √© transferido para um estado de alta resist√™ncia. </font><font style="vertical-align: inherit;">Voc√™ pode ativar os dois resistores simultaneamente, e haver√° tr√™s faixas de medi√ß√£o fixas. </font><font style="vertical-align: inherit;">O sinal dos resistores do emissor √© passado atrav√©s de um circuito RC para filtrar os pulsos moduladores - a luz dos LEDs pulsa junto com o sinal PWM no regulador de corrente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bomba</font></font></h4><br>
<img src="https://habrastorage.org/files/a13/933/895/a13933895d9f4546a4ab7e54e87c056b.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O equipamento chin√™s mais barato, com um motor DC. </font><font style="vertical-align: inherit;">Emboscadas, √© claro, est√£o dispon√≠veis. </font><font style="vertical-align: inherit;">Apesar de dizer 12V, ele n√£o funciona por muito tempo nessa tens√£o. </font><font style="vertical-align: inherit;">Um queimou antes da montagem da estrutura. </font><font style="vertical-align: inherit;">O esquema prev√™ PWM para ele, a pot√™ncia m√°xima √© configurada na interface, na pr√°tica, n√£o foi definida acima de 70%. </font><font style="vertical-align: inherit;">J√° neste n√≠vel, ele uiva descontroladamente no trabalho, mas na maioria das vezes ele trabalha com uma pot√™ncia muito mais baixa - cerca de 30% e burburinho. </font><font style="vertical-align: inherit;">Sobre seus modos de opera√ß√£o abaixo, na descri√ß√£o da l√≥gica das inunda√ß√µes. </font><font style="vertical-align: inherit;">O capacitor maior (C8 no diagrama) deve ser posicionado mais pr√≥ximo ao circuito de energia da bomba, caso contr√°rio, haver√° grande interfer√™ncia em todo o circuito (na pr√°tica, verificou-se que o regulador de corrente para LEDs √© mais sens√≠vel a eles, a m√∫sica leve inicia).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rel√≥gio de tempo real</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Havia uma id√©ia maluca de usar os recursos do microcontrolador para esses prop√≥sitos. O gerador de rel√≥gio de quartzo tem uma precis√£o muito boa, em outro projeto essa abordagem funcionou bem. Mas o problema √© que absolutamente todos os temporizadores de hardware j√° foram utilizados para outros fins. N√£o havia escolha a n√£o ser encontrar o m√≥dulo RTC externo. Elogie os chineses, eles est√£o l√° e s√£o baratos. </font></font><br>
<br>
<img src="https://habrastorage.org/files/16f/8e2/404/16f8e24047b9445f969a1d1e9333b4bc.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√≥dulo baseado no DS3231 possui uma interface I2C, sua pr√≥pria fonte de alimenta√ß√£o redundante - o tempo n√£o vai dar errado com o apag√£o. H√° uma sa√≠da de meandro em v√°rias frequ√™ncias fixas - 1 kHz, 4 kHz e 8 kHz. Isso foi muito √∫til para sinais de √°udio - novamente, voc√™ n√£o precisa carregar o MCU e n√£o havia temporizadores livres para isso. A EEPROM de 32Kbit √© um b√¥nus, mas n√£o √© usada neste projeto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Surpreendentemente, √© muito preciso: em poucos meses, perdi a for√ßa por v√°rios segundos. </font><font style="vertical-align: inherit;">Ele afirmou que leva em considera√ß√£o a influ√™ncia da temperatura na frequ√™ncia do gerador, e aparentemente isso funciona. </font><font style="vertical-align: inherit;">Se, no entanto, o tempo acabar, existe a possibilidade de corre√ß√£o da frequ√™ncia do software. </font><font style="vertical-align: inherit;">As leituras do sensor de temperatura est√£o dispon√≠veis e, neste projeto, s√£o exibidas na interface. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A classe Rtc √© respons√°vel por trabalhar com este m√≥dulo no c√≥digo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exibi√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° muito tempo eu queria fazer algo com uma exibi√ß√£o gr√°fica. </font><font style="vertical-align: inherit;">Procurar a interface mais barata com o I2C deu essa op√ß√£o.</font></font><br>
<br>
<img src="https://habrastorage.org/files/629/1fb/ecc/6291fbeccac04dfe854f3a3e45b2a2a3.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OLED monocrom√°tico exibe 128x64 pixels com base no popular controlador SSD1306. Ao escolher, voc√™ precisa examinar atentamente a descri√ß√£o - o mesmo chip suporta outras interfaces, exceto I2C, e existem op√ß√µes sem ele. Ou eles escrevem que √© universal, tamb√©m suporta I2C, mas, na realidade, ser√° necess√°rio modificar levemente a placa reorganizando os nulos em outros sites. Portanto, se voc√™ planeja usar o I2C, √© melhor escolher um em que apenas o I2C seja exibido na placa, haver√° menos problemas com uma placa que n√£o possua quase nenhuma documenta√ß√£o (documenta√ß√£o apenas para o chip). Esta vers√£o funciona a partir de 5V, a placa possui um regulador de 3,3V necess√°rio para o controlador. Eu conheci cr√≠ticas que, em algumas vers√µes, pode n√£o ser.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A exibi√ß√£o geralmente √© satisfeita. Notei apenas um recurso desagrad√°vel - o brilho de uma linha de pixels depende de quantos pixels est√£o acesos. Quanto mais iluminado, menor o brilho. O contraste entre as linhas pode ser vis√≠vel se √°reas completamente preenchidas com alguns elementos estreitos se alternarem na tela. Mas, na pr√°tica, isso n√£o √© vis√≠vel nas minhas fotos e n√£o √© impressionante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O controlador pode ser configurado para operar em v√°rios modos de exibi√ß√£o do conte√∫do da mem√≥ria da tela em uma matriz de pixels. Era mais conveniente para mim quando cada byte √© mapeado em uma coluna vertical com oito pixels de altura e as colunas v√£o horizontalmente da esquerda para a direita, preenchendo a tela com linhas de oito pixels de altura. Nesse modo, √© mais conveniente desenhar texto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Freq√ºentemente, √© praticada uma abordagem na qual a mem√≥ria de exibi√ß√£o √© duplicada no RAM MCU - primeiro, todas as a√ß√µes com a imagem s√£o executadas na RAM e, em seguida, todos os pixels alterados s√£o copiados para a mem√≥ria de exibi√ß√£o. Neste projeto, essa abordagem n√£o √© usada para economizar recursos. Todos os locais alterados s√£o redesenhados imediatamente na mem√≥ria de exibi√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conforme sugerido nos coment√°rios, as telas OLED desaparecem com o tempo. Eu tamb√©m suspeitava disso (lembrando o que √© o protetor de tela) e providenciei que a exibi√ß√£o desligasse alguns minutos ap√≥s a √∫ltima atividade nos controles. Ele liga quando liga ou pressiona o codificador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No c√≥digo, o trabalho com a exibi√ß√£o √© implementado na classe Display. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Valkoder:</font></font><br>
<br>
<img src="https://habrastorage.org/files/ee6/a1e/6b5/ee6a1e6b5921493bb395675e2805f2c6.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na minha opini√£o, o valcoder √© a melhor op√ß√£o de controle para dispositivos que tenham pelo menos alguma interface de usu√°rio. √â compacto e muito confort√°vel. √â conveniente para eles folhear e selecionar itens de menu, alterar os valores de quaisquer par√¢metros, alternar modos, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para conectar, s√£o necess√°rias tr√™s pernas de entrada do microcontrolador. Um para o bot√£o (voc√™ pode pressionar a al√ßa), dois para o pr√≥prio valcoder. H√° um sinal de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo cinza</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do codificador </font><font style="vertical-align: inherit;">. A cada passo do turno, um bit muda em duas linhas. A sequ√™ncia determina a dire√ß√£o da rota√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo parece ser simples, mas, aparentemente, os desenvolvedores nem sempre s√£o capazes de oferecer suporte de alta qualidade a esse dispositivo. Por exemplo, na minha impressora 3D, h√° uma placa RAMPS e uma placa com uma tela e o mesmo codificador est√° conectado. O firmware Marlin funciona com ele, mas a experi√™ncia de us√°-lo √© muito ruim - n√£o h√° sensa√ß√£o de confiabilidade - quando voc√™ clica no bot√£o ao gir√°-lo, a interface geralmente para no item de menu ou no valor do par√¢metro errado no qual era esperado. Com rota√ß√£o r√°pida, parece que os cliques est√£o pulando. Em algum momento, a troca n√£o come√ßa durante os cliques, mas em algum lugar √© muito desagrad√°vel. Sim, o que √© Marlin, √†s vezes tenho o mesmo sentimento no sistema multim√≠dia embutido no carro. Nesse sentido, algumas dicas (e, √© claro, examinam o c√≥digo nas proximidades da classe RotEnc).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, um ponto bastante √≥bvio para quem conecta qualquer bot√£o ao microcontrolador - voc√™ precisa lidar com o ressalto. Esse codificador mec√¢nico e suas linhas de sinal s√£o, de fato, os mesmos bot√µes, e eles tamb√©m t√™m uma conversa. Primeiro, filtramos a conversa e depois processamos a sequ√™ncia de estados das linhas de sinal. Pode haver valcoders com sensores √≥pticos, isso j√° depende dos esquemas de processamento de sinal deles. Se as pernas de um fototransistor forem trazidas diretamente para fora, ele poder√° se agitar com rota√ß√£o lenta, mas se houver algum esquema de processamento que introduza histerese, a supress√£o de software n√£o ser√° necess√°ria. Mas esses dispositivos s√£o mais caros e raramente s√£o usados ‚Äã‚Äãem dispositivos amadores, os mais comuns s√£o mec√¢nicos, alguns d√≥lares por lote.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em segundo lugar, um ponto um pouco menos √≥bvio, provavelmente um daqueles em que Marlin se queimou - a al√ßa tem posi√ß√µes est√°veis ‚Äã‚Äãdurante a rota√ß√£o - clica (clica). Este modelo possui quatro etapas de uma sequ√™ncia de c√≥digo para cada clique. Portanto, voc√™ precisa responder aos cliques, e n√£o √†s etapas da sequ√™ncia. E o mais importante √© sincronizar com posi√ß√µes est√°veis. Muitos simplesmente inserem a constante STEPS_PER_CLICK e, por exemplo, respondem a cada quarto passo. Mas o problema √© que o sinal n√£o √© perfeito, as seq√º√™ncias podem n√£o estar totalmente corretas. Com uma determinada ortografia, o c√≥digo pode "se perder", como resultado, cada quarto passo ser√° obtido em algum lugar no meio do clique, o que ser√° desconfort√°vel para o usu√°rio. Ao mesmo tempo, a posi√ß√£o fixa da al√ßa para um modelo espec√≠fico corresponde a um valor de c√≥digo fixo,deve ser anexado a ele.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terceiro, novamente, um ponto bastante √≥bvio para desenvolvedores mais ou menos experientes de sistemas de microcontroladores - use interrup√ß√µes de hardware para alterar o estado das linhas de entrada. </font><font style="vertical-align: inherit;">No m√≠nimo, haver√° menos risco de "perder" as etapas da sequ√™ncia. </font><font style="vertical-align: inherit;">Mas, em geral, como voc√™ sabe, as interrup√ß√µes s√£o tudo. </font><font style="vertical-align: inherit;">O MCU deve dormir sempre que poss√≠vel, acordando apenas com interrup√ß√µes - da periferia externa ou de um timer para executar uma tarefa atrasada. </font><font style="vertical-align: inherit;">Esses s√£o os princ√≠pios do bom design da arquitetura do sistema.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design como um todo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â feito de materiais improvisados ‚Äã‚Äãe v√°rias pe√ßas impressas em uma impressora 3D da ABS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O princ√≠pio de opera√ß√£o do sif√£o √© ilustrado no v√≠deo acima. Para mim, √© um tubo de PVC externo e um tubo interno com um funil no final. Para o sif√£o cl√°ssico, √© necess√°rio outro joelho, mas j√° era dif√≠cil faz√™-lo construtivamente para mim. Quando foram encontrados problemas com o dreno, um pequeno banho foi preso na parede do tanque inferior, na qual a extremidade do tubo interno estava imersa, criando resist√™ncia ao dreno, para que o sif√£o pudesse funcionar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descobriu-se que o ABS √© um material muito hidrof√≥bico. A √°gua literalmente n√£o transborda; eu at√© tive que refazer o funil do sif√£o. Vale a pena considerar essa propriedade, √© imposs√≠vel criar alguns sistemas hidr√°ulicos em miniatura (por exemplo, eu queria criar superf√≠cies guia no funil do sif√£o, torcer a √°gua, melhorar a resposta do sif√£o. Mas com essas dimens√µes e hidrofobicidade do ABS, isso n√£o faz sentido) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tamb√©m tentei primeiro colar tudo junto com uma pistola de cola quente. N√£o funciona - no come√ßo tudo parecia estar bem, mas depois de alguns dias caiu. A melhor op√ß√£o √© a √Åsia Central. Os detalhes, mesmo debaixo d'√°gua, mant√™m-se firmes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O maior erro de c√°lculo no design s√£o os recipientes transparentes. Esqueci completamente o fato de que a √°gua brota na luz. Eu tive que envolv√™-lo com material opaco. Bem, voc√™ pode adicionar periodicamente permanganato de pot√°ssio para desinfec√ß√£o, isso n√£o parece prejudicar as plantas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O algoritmo de inunda√ß√£o √© o seguinte - primeiro a bomba √© ligada com baixa pot√™ncia e enche silenciosamente todo o tanque superior. O processo √© monitorado por um sensor de n√≠vel. Quando a √°gua come√ßa a transbordar atrav√©s do funil do sif√£o, a diminui√ß√£o do n√≠vel no tanque inferior para, o que √© detectado pelo sensor. Um pequeno fluxo criado com baixa pot√™ncia n√£o √© suficiente para acionar um sif√£o. A bomba para, o volume bombeado para o tanque superior √© lembrado. As ra√≠zes s√£o mantidas na solu√ß√£o por v√°rios minutos, ap√≥s os quais a bomba liga novamente. Primeiro, em baixa pot√™ncia, at√© que a √°gua atinja o funil novamente (durante o tempo de inatividade, ele cai mais baixo devido ao efeito do sif√£o) e, quando o n√≠vel do funil √© atingido, a bomba liga para aumentar a pot√™ncia, fornecendo um fluxo suficiente para o sif√£o funcionar. √â garantido que o fluxo atrav√©s do sif√£o seja superior ao fluxo da bomba,Como resultado, o n√≠vel no tanque inferior come√ßa a subir, isso √© detectado pelo sensor e a bomba para.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os ciclos de inunda√ß√£o iniciam-se periodicamente, em intervalos de tempo fixos e configur√°veis, do amanhecer ao anoitecer. </font><font style="vertical-align: inherit;">De acordo com o plano, o amanhecer deveria ser fixado pelo sensor de luz, e a dura√ß√£o da luz do dia, se necess√°rio, era estendida ao valor definido, mas at√© ent√£o as m√£os n√£o o alcan√ßavam. </font><font style="vertical-align: inherit;">O hor√°rio do amanhecer √© simplesmente definido nas configura√ß√µes.</font></font><br>
<br>
<a name="cpp11"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E onde est√° o C ++ 11?</font></font></h4><br>
<a name="cpp11"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez algu√©m duvide que o C ++ 11 possa ser √∫til na programa√ß√£o de microcontroladores (entre aqueles que geralmente sabem que os microcontroladores podem ser programados em C ++). </font><font style="vertical-align: inherit;">Vou tentar dar exemplos espec√≠ficos dos benef√≠cios do C ++ 11 nessa √°rea (al√©m de pequenas coisas √≥bvias e agrad√°veis, como constexpr, override, default etc.).</font></font><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coloca√ß√£o de recursos de sequ√™ncia</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muitas pessoas sabem que a RAM nos microcontroladores √© um recurso muito limitado. Isso pode ser um problema se seu aplicativo, por exemplo, tiver uma interface com o usu√°rio e seu programa usar um n√∫mero bastante grande de linhas. Se no c√≥digo para escrever algo como</font></font><br>
<pre><code class="cpp hljs">PromptUser(<span class="hljs-string">"Are you sure you want to format SD-card?"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a linha passada nos argumentos ser√° colocada na se√ß√£o de dados inicializados (doravante, o comportamento do compilador GCC para a plataforma AVR) - ou seja, na √°rea de RAM, que na inicializa√ß√£o (antes que a fun√ß√£o principal seja chamada) seja inicializada a partir da mem√≥ria flash do programa. A fun√ß√£o PromptUser () passar√° um ponteiro para o local desejado na RAM. Se voc√™ usar uma abordagem semelhante ao longo do programa, a RAM terminar√° rapidamente (no ATMEGA328P usado neste projeto, s√£o apenas 2 kilobytes e tamb√©m para BSS, heap e stack). Para contornar essa limita√ß√£o, fun√ß√µes como PromptUser () aprendem a trabalhar n√£o com ponteiros para RAM, mas com ponteiros para uma regi√£o na mem√≥ria flash do programa. Voc√™ pode ler a partir da√≠ apenas com a ajuda de instru√ß√µes especiais, que, por exemplo, no avr-libc, est√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">agrupadas</font></a><font style="vertical-align: inherit;"> em fun√ß√µes da fam√≠lia </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_read_ [byte | word | dword | ...]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, a cadeia de caracteres deve primeiro ser colocada em uma vari√°vel equipada com o atributo PROGMEM, que informa ao compilador que deve ser colocada na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mem√≥ria do programa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> prompt[] PROGMEM = <span class="hljs-string">"Are you sure you want to format SD-card?"</span>;<font></font>
PromptUser(prompt);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© inconveniente se voc√™ deseja declarar todas as linhas centralmente. </font><font style="vertical-align: inherit;">Ent√£o voc√™ deve primeiro declarar sua declara√ß√£o no arquivo de cabe√ßalho:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> prompt[] PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E em um arquivo .cpp separado, defina:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> prompt[] PROGMEM = <span class="hljs-string">"Are you sure you want to format SD-card?"</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duplica√ß√£o de c√≥digo, o que n√£o √© bom, e muito inconveniente quando existem muitas dessas linhas. </font><font style="vertical-align: inherit;">Sim, isso pode ser contornado criando uma macro complicada e incluindo o arquivo de cabe√ßalho em um arquivo .cpp separado, no qual a macro ser√° expandida para a defini√ß√£o, enquanto em outros contextos ser√° expandida para a declara√ß√£o. </font><font style="vertical-align: inherit;">Mas com o C ++ 11, h√° uma op√ß√£o mais limpa se voc√™ usar a inicializa√ß√£o dos membros da classe ao declarar. </font><font style="vertical-align: inherit;">No arquivo de cabe√ßalho, declare a classe com as linhas:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEF_STR(__name, __text) \</span><font></font><span class="hljs-meta">
    const char __name[sizeof(__text)] = __text;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Strings</span> {</span><font></font>
<span class="hljs-keyword">public</span>:<font></font>
    DEF_STR(Prompt, <span class="hljs-string">"Are you sure you want to format SD-card?"</span>)<font></font>
    DEF_STR(OtherString, <span class="hljs-string">"..."</span>)<font></font>
    ‚Ä¶<font></font>
} __attribute__((packed));<font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> Strings strings PROGMEM;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No arquivo .cpp:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> Strings strings PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora todas as linhas s√£o declaradas em um s√≥ lugar, colocadas na mem√≥ria do programa e voc√™ pode acess√°-las assim:</font></font><br>
<pre><code class="cpp hljs">PromptUser(strings.prompt);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste projeto, uma abordagem baseada no mesmo princ√≠pio √© usada para determinar bitmaps - v√°rias imagens exibidas em uma exibi√ß√£o gr√°fica.</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/** Bitmap descriptor. */</span><font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Bitmap</span> {</span><font></font>
    <span class="hljs-comment">/** Pointer to data array if in data memory. Offset of data array relatively</span><font></font><span class="hljs-comment">
     * to Bitmaps class instance start address if in program memory.</span><font></font><span class="hljs-comment">
     */</span><font></font>
    <span class="hljs-keyword">const</span> u8 *data;<font></font>
    <span class="hljs-comment">/** Number of pages in the bitmap. */</span><font></font>
    u8 numPages,<font></font>
    <span class="hljs-comment">/** Number of columns in the bitmap. */</span><font></font>
       numColumns;<font></font>
} __PACKED;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;u8... data&gt;</span><font></font><span class="hljs-function">
<span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">static</span> u8</span><font></font><span class="hljs-function">
<span class="hljs-title">Bitmap_NumDataBytes</span><span class="hljs-params">()</span></span><font></font><span class="hljs-function">
</span>{<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">sizeof</span>...(data);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/** Define bitmap.</span><font></font><span class="hljs-comment">
 * @param __name Name for accessing.</span><font></font><span class="hljs-comment">
 * @param __numPages Number of pages in the bitmap. Number of columns defined as</span><font></font><span class="hljs-comment">
 *      total number of data bytes divided by number of pages.</span><font></font><span class="hljs-comment">
 * @param __VA_ARGS__ Data bytes.</span><font></font><span class="hljs-comment">
 */</span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEF_BITMAP(__name, __numPages, ...) \</span><font></font><span class="hljs-meta">
    const u8 __CONCAT(__name, __data__) \</span><font></font><span class="hljs-meta">
        [Bitmap_NumDataBytes<span class="hljs-meta-string">&lt;__VA_ARGS__&gt;()] = { __VA_ARGS__ }; \</span></span><font></font>
    <span class="hljs-keyword">const</span> Bitmap __name { \<font></font>
        <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">const</span> u8 *&gt;(OFFSETOF(Bitmaps, __CONCAT(__name, __data__))), \<font></font>
        __numPages, \<font></font>
        <span class="hljs-keyword">sizeof</span>(__CONCAT(__name, __data__)) / __numPages};<font></font>
<font></font>
<span class="hljs-comment">/** Global bitmaps repository. Stored in program memory. */</span><font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bitmaps</span> {</span><font></font>
<span class="hljs-keyword">public</span>:<font></font>
<font></font>
    <span class="hljs-comment">/** Thermometer icon. */</span><font></font>
    DEF_BITMAP(Thermometer, <span class="hljs-number">1</span>,<font></font>
        <span class="hljs-number">0b01101010</span>,<font></font>
        <span class="hljs-number">0b10011110</span>,<font></font>
        <span class="hljs-number">0b10000001</span>,<font></font>
        <span class="hljs-number">0b10011110</span>,<font></font>
        <span class="hljs-number">0b01101010</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-comment">/** Sun icon. */</span><font></font>
    DEF_BITMAP(Sun, <span class="hljs-number">1</span>,<font></font>
        <span class="hljs-number">0b00100100</span>,<font></font>
        <span class="hljs-number">0b00011000</span>,<font></font>
        <span class="hljs-number">0b10100101</span>,<font></font>
        <span class="hljs-number">0b01000010</span>,<font></font>
        <span class="hljs-number">0b01000010</span>,<font></font>
        <span class="hljs-number">0b10100101</span>,<font></font>
        <span class="hljs-number">0b00011000</span>,<font></font>
        <span class="hljs-number">0b00100100</span><font></font>
    )<font></font>
    ...<font></font>
};<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> Bitmaps bitmaps PROGMEM;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diferen√ßa √© que, al√©m dos pr√≥prios dados da imagem, tamb√©m √© necess√°rio colocar atributos (tamanhos da imagem). </font><font style="vertical-align: inherit;">Cada byte define uma coluna de oito pixels. </font><font style="vertical-align: inherit;">As colunas podem preencher uma ou mais linhas; seu n√∫mero √© indicado pelo segundo par√¢metro ap√≥s o nome. </font><font style="vertical-align: inherit;">Acontece que a altura dos bitmaps deve ser um m√∫ltiplo de oito para uma largura arbitr√°ria, o que √© bastante aceit√°vel para este projeto.</font></font><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Literais bin√°rios</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ j√° deve ter notado que os bitmaps no exemplo anterior usam literais bin√°rios para determinar. </font><font style="vertical-align: inherit;">Isso √© realmente muito conveniente - voc√™ pode editar bitmaps simples diretamente no c√≥digo, especialmente se o editor permitir destac√°-los. </font><font style="vertical-align: inherit;">Por exemplo, defini√ß√µes de caracteres de fonte no arquivo font.h:</font></font><br>
<br>
<img src="https://habrastorage.org/files/8f4/a54/0c9/8f4a540c9a8a42ff9315c8d4cd307d93.png"><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelos vari√°veis</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Onde ent√£o sem eles ent√£o. </font><font style="vertical-align: inherit;">Bem, por exemplo, os comandos para o controlador de exibi√ß√£o podem ter um comprimento de um a v√°rios bytes. </font><font style="vertical-align: inherit;">Enviado com o seguinte c√≥digo:</font></font><br>
<br>
<pre><code class="cpp hljs">SendCommand(Command::DISPLAY_ON);<font></font>
SendCommand(Command::SET_COM_PINS, COM_PINS | COM_PINS_ALTERNATIVE);<font></font>
SendCommand(Command::SET_COLUMN_ADDRESS, curVp.minCol, curVp.maxCol);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conveniente, n√£o √©?</font></font><br>
<pre><code class="cpp hljs">    <span class="hljs-comment">/** Queue command sending.</span><font></font><span class="hljs-comment">
     * @param bytes Up to MAX_CMD_SIZE bytes of command data.</span><font></font><span class="hljs-comment">
     */</span><font></font>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... TByte&gt;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span></span><font></font><span class="hljs-function">
    <span class="hljs-title">SendCommand</span><span class="hljs-params">(TByte... bytes)</span></span><font></font><span class="hljs-function">
    </span>{<font></font>
        cmdSize = <span class="hljs-keyword">sizeof</span>...(bytes);<font></font>
        controlSent = <span class="hljs-literal">false</span>;<font></font>
        cmdInProgress = <span class="hljs-literal">true</span>;<font></font>
        SetCmdByte(<span class="hljs-keyword">sizeof</span>...(bytes) - <span class="hljs-number">1</span>, bytes...);<font></font>
        i2cBus.RequestTransfer(DISPLAY_ADDRESS, <span class="hljs-literal">true</span>,<font></font>
                               CommandTransferHandler);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... TByte&gt;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span></span><font></font><span class="hljs-function">
    <span class="hljs-title">SetCmdByte</span><span class="hljs-params">(<span class="hljs-keyword">int</span> idx, u8 byte, TByte... bytes)</span></span><font></font><span class="hljs-function">
    </span>{<font></font>
        cmdBuf[idx] = byte;<font></font>
        SetCmdByte(idx - <span class="hljs-number">1</span>, bytes...);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span></span><font></font><span class="hljs-function">
    <span class="hljs-title">SetCmdByte</span><span class="hljs-params">(<span class="hljs-keyword">int</span>, u8 byte)</span></span><font></font><span class="hljs-function">
    </span>{<font></font>
        cmdBuf[<span class="hljs-number">0</span>] = byte;<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O arquivo variant.h descreve uma classe que se assemelha vagamente a boost :: variant usando modelos variados. √â usado para organizar as p√°ginas da interface do usu√°rio. O ponto est√° novamente na economia de mem√≥ria - onde o gerenciamento din√¢mico de mem√≥ria √© um luxo inadmiss√≠vel, voc√™ precisa se esquivar (embora 2K ainda seja muito, voc√™ n√£o podia se esquivar, mas na mesma linha ATMEGA seu tamanho atinge 512 bytes e cada byte por conta). Na minha interface, uma p√°gina √© exibida na tela a qualquer momento. Assim, para todas as p√°ginas voc√™ pode usar o mesmo peda√ßo de mem√≥ria, o que √© chamado de uni√£o em C. Para classes em C ++, isso geralmente √© chamado de variante. Ao contr√°rio da uni√£o, precisamos lembrar de chamar o destruidor do conte√∫do anterior antes de chamar o construtor do novo.</font></font><br>
<br>
<pre><code class="cpp hljs">    Variant&lt;MainPage,<font></font>
            Menu,<font></font>
            LinearValueSelector,<font></font>
            TimeSelector&gt; curPage;<font></font>
    ...<font></font>
    <span class="hljs-comment">/** Get type code for the specified page class. */</span><font></font>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TPage</span>&gt;</span><font></font><span class="hljs-class">
    <span class="hljs-title">static</span> <span class="hljs-title">constexpr</span> <span class="hljs-title">u8</span></span><font></font><span class="hljs-class">
    <span class="hljs-title">GetPageTypeCode</span>()</span><font></font><span class="hljs-class">
    {</span><font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">decltype</span>(curPage)::GetTypeCode&lt;TPage&gt;();<font></font>
    }<font></font>
...<font></font>
curPage.Engage(nextPageTypeCode, page);<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para a compila√ß√£o, os binutils GCC e GNU s√£o usados ‚Äã‚Äãpara a plataforma AVR (no Ubuntu h√° um pacote pronto gcc-avr). </font><font style="vertical-align: inherit;">Os detalhes do processo de montagem foram dados acima. </font><font style="vertical-align: inherit;">Os par√¢metros para o compilador s√£o parecidos com este (omitimentos e inclus√µes espec√≠ficos do projeto s√£o omitidos): </font><font style="vertical-align: inherit;">
Link: </font><font style="vertical-align: inherit;">
Converte a se√ß√£o de c√≥digo em formato hexadecimal: </font><font style="vertical-align: inherit;">
Crie uma imagem EEPROM: </font><font style="vertical-align: inherit;">
Firmware para o microcontrolador: </font><font style="vertical-align: inherit;">
PS Os primeiros tomates j√° estavam maduros e n√£o tinham um sabor muito bom. </font><font style="vertical-align: inherit;">Aparentemente, eles n√£o gostaram de algo na dieta. </font><font style="vertical-align: inherit;">Provavelmente tem que mudar a cultura.</font></font><br>
<code>avr-g++ -o build/native-debug/src/firmware/cpu/lighting.cpp.o -c -fno-exceptions -fno-rtti -std=c++1y -Wall -Werror -Wextra -ggdb3 -Os -mcall-prologues -mmcu=atmega328p -fshort-wchar -fshort-enums src/firmware/cpu/lighting.cpp<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-g++ -o build/native-debug/src/firmware/cpu/cpu -mmcu=atmega328p build/native-debug/src/firmware/cpu/adc.cpp.o build/native-debug/src/firmware/cpu/application.cpp.o ‚Ä¶<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-objcopy -j .text -j .data -O ihex build/native-debug/src/firmware/cpu/cpu build/native-debug/src/firmware/cpu/cpu_rom.hex<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-objcopy -j .eeprom --change-section-lma .eeprom=0 -O ihex build/native-debug/src/firmware/cpu/cpu build/native-debug/src/firmware/cpu/cpu_eeprom.hex<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avrdude -p atmega328p -c avrisp2 -P /dev/avrisp -U flash:w:build/native-debug/src/firmware/cpu/cpu_rom.hex:i<br>
</code><br>
<br><font style="vertical-align: inherit;"></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt385135/">https://habr.com/ru/post/pt385135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt385121/index.html">Surrealismo Algor√≠tmico: Um Guia para Com√©rcio de Alta Frequ√™ncia por 900 Milh√µes de Microssegundos. Parte 1</a></li>
<li><a href="../pt385123/index.html">A Station New Horizons enviou uma foto de um pequeno sat√©lite de Plut√£o Styx</a></li>
<li><a href="../pt385125/index.html">Reddit escolheu qual imagem ir√° para a lua em 2017</a></li>
<li><a href="../pt385129/index.html">Sensor de ilumina√ß√£o sem fio CR2450</a></li>
<li><a href="../pt385131/index.html">Calma durante a noite, apenas n√£o dorme PC: indo silenciosamente</a></li>
<li><a href="../pt385137/index.html">Movimento global de desmantelamento de pain√©is urbanos</a></li>
<li><a href="../pt385139/index.html">Rob√¥s Tesla Motors</a></li>
<li><a href="../pt385141/index.html">Cannybots: rob√¥s para ensinar as crian√ßas a programar</a></li>
<li><a href="../pt385145/index.html">Uma sele√ß√£o de rastreadores onde voc√™ pode alterar as correias</a></li>
<li><a href="../pt385147/index.html">Rob√¥s podem tornar a reciclagem mais barata e segura</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>