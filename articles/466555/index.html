<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèº üõ•Ô∏è üçò 6 lecciones aprendidas al encontrar una soluci√≥n a un problema masivo en gitlab.com. Parte 1 ‚úãüèø üëÖ üë®‚Äçüë®‚Äçüëß‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El material, la primera parte de la traducci√≥n que publicamos hoy, est√° dedicado a un problema a gran escala que surgi√≥ en gitlab.com. Aqu√≠ hablaremos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>6 lecciones aprendidas al encontrar una soluci√≥n a un problema masivo en gitlab.com. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/466555/">  El material, la primera parte de la traducci√≥n que publicamos hoy, est√° dedicado a un problema a gran escala que surgi√≥ en gitlab.com.  Aqu√≠ hablaremos sobre c√≥mo la encontraron, c√≥mo pelearon con ella y c√≥mo, finalmente, la resolvieron.  Adem√°s, ante este problema, el equipo de gitlab.com descubri√≥ cu√°l es la tiran√≠a de los relojes. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/qk/zt/9j/qkzt9jqmpe2gmprxe33pdce_3kq.jpeg"></a> <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La segunda parte</a> . <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">El problema</font> </h2><br>  Comenzamos a recibir mensajes de clientes que, al trabajar con gitlab.com, peri√≥dicamente encuentran errores al ejecutar solicitudes de extracci√≥n.  Los errores generalmente ocurren al realizar tareas de CI o durante la operaci√≥n de otros sistemas automatizados similares.  Los mensajes de error se ve√≠an as√≠: <br><br><pre><code class="plaintext hljs">ssh_exchange_identification: connection closed by remote host fatal: Could not read from remote repository</code> </pre> <br>  La situaci√≥n se complic√≥ a√∫n m√°s por el hecho de que los mensajes de error aparec√≠an de forma irregular y, como parec√≠a, de forma impredecible.  No pudimos reproducirlos a voluntad, no pudimos identificar ning√∫n signo obvio de lo que estaba sucediendo en los gr√°ficos o en los registros.  Los mensajes de error en s√≠ mismos tampoco aportaron muchos beneficios.  El cliente SSH fue informado de que la conexi√≥n se interrumpi√≥, pero la raz√≥n de esto podr√≠a ser cualquier cosa: un cliente fallido o una m√°quina virtual inestable, un firewall que no controlamos, acciones extra√±as del proveedor o un problema con nuestra aplicaci√≥n. <br><br>  Nosotros, trabajando en el esquema GIT-over-SSH, estamos lidiando con un gran n√∫mero de conexiones, aproximadamente 26 millones por d√≠a.  Este es un promedio de 300 conexiones por segundo.  Por lo tanto, un intento de seleccionar una peque√±a cantidad de conexiones fallidas del flujo de datos existente prometi√≥ ser una tarea dif√≠cil.  Lo bueno de esta situaci√≥n es que nos gusta resolver problemas complejos. <br><br><h2>  <font color="#3AC1EF">Primera pista</font> </h2><br>  Contactamos a uno de nuestros clientes (gracias a Hubert Holtz, de Atalanda), quien se encontr√≥ con un problema varias veces al d√≠a.  Esto nos dio un punto de apoyo.  Hubert pudo proporcionarnos una direcci√≥n IP p√∫blica adecuada.  Esto significaba que pod√≠amos capturar paquetes en nuestros nodos front-end HAProxy para tratar de aislar el problema confiando en un conjunto de datos que es m√°s peque√±o de lo que podr√≠a llamarse "todo el tr√°fico SSH".  A√∫n mejor, la compa√±√≠a us√≥ un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">puerto ssh alternativo</a> .  Esto significaba que necesit√°bamos analizar la situaci√≥n en solo dos servidores HAProxy, y no en diecis√©is. <br><br>  El an√°lisis de paquetes, sin embargo, no fue particularmente divertido.  A pesar de las restricciones en aproximadamente 6.5 horas, se recolectaron paquetes de aproximadamente 500 MB.  Encontramos compuestos de corta duraci√≥n.  Se estableci√≥ la conexi√≥n TCP, el cliente envi√≥ el identificador, despu√©s de lo cual nuestro servidor HAProxy se desconect√≥ inmediatamente utilizando la secuencia TCP FIN correcta.  Como resultado, tuvimos a nuestra disposici√≥n la primera pista excelente.  Ella nos permiti√≥ concluir que la conexi√≥n se cerr√≥ definitivamente por iniciativa de gitlab.com, y no por algo entre nosotros y el cliente.  Esto significaba que nos enfrentamos a un problema que podemos investigar y corregir. <br><br>  <b>Lecci√≥n n√∫mero 1.</b>  El men√∫ de estad√≠sticas de la herramienta Wireshark tiene un mont√≥n de herramientas √∫tiles a las que, antes de este caso, no he prestado mucha atenci√≥n. <br><br>  En particular, estamos hablando del elemento del men√∫ <code>Conversations</code> , que puede demostrar informaci√≥n b√°sica sobre los datos capturados sobre las conexiones TCP.  Hay informaci√≥n sobre tiempo, paquetes, bytes.  Los datos que se muestran en la ventana correspondiente se pueden ordenar.  Deber√≠a usar esta herramienta desde el principio en lugar de jugar manualmente con los datos capturados.  Luego me di cuenta de que necesitaba buscar conexiones con una peque√±a cantidad de paquetes.  La ventana <code>Conversations</code> le permiti√≥ prestarles atenci√≥n de inmediato.  Despu√©s de eso, pude encontrar otros compuestos similares y asegurarme de que la primera conexi√≥n no fuera un fen√≥meno anormal. <br><br><h2>  <font color="#3AC1EF">Inmersi√≥n de registro</font> </h2><br>  ¬øQu√© caus√≥ que HAProxy se desconectara del cliente?  El servidor, por supuesto, no hizo esto de manera arbitraria: lo que estaba sucediendo deber√≠a haber tenido alguna raz√≥n m√°s profunda;  si lo desea, "otro nivel de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tortugas</a> ".  Hubo la sensaci√≥n de que el pr√≥ximo objeto de estudio deber√≠an ser los registros HAProxy.  Nuestros registros se almacenaron en GCP BigQuery.  Esto es conveniente, ya que tenemos muchos registros, y necesit√°bamos analizarlos exhaustivamente.  Pero primero, pudimos identificar la entrada de registro para uno de los incidentes, que se encontr√≥ en los paquetes capturados.  Confiamos en el tiempo y en el puerto TCP, que fue un logro importante en nuestro estudio.  El detalle m√°s interesante en el registro encontrado fue el <code>t_state</code> (Estado de terminaci√≥n), que ten√≠a el valor <code>SD</code> .  Aqu√≠ hay un extracto de la documentaci√≥n de HAProxy: <br><br><pre> <code class="plaintext hljs">    S:  ,     .    D:     DATA.</code> </pre> <br>  El significado del significado de <code>D</code> se explica de manera muy simple.  La conexi√≥n TCP se estableci√≥ correctamente, se enviaron datos.  Esto coincidi√≥ con la evidencia obtenida de los paquetes capturados.  Un valor de <code>S</code> significaba que HAProxy recibi√≥ un mensaje de error RST o ICMP del backend.  Pero no pudimos encontrar inmediatamente una pista de por qu√© estaba sucediendo esto.  La raz√≥n de esto podr√≠a ser cualquier cosa, desde una red inestable (por ejemplo, una falla o congesti√≥n) hasta un problema de nivel de aplicaci√≥n.  Al usar BigQuery para agregar datos en backends de Git, descubrimos que el problema no est√° vinculado a ninguna m√°quina virtual en particular.  Necesit√°bamos m√°s informaci√≥n. <br><br>  Quiero se√±alar que las entradas de registro con el valor <code>SD</code> no eran algo especial, caracter√≠stico solo para nuestro problema.  En el puerto ssh alternativo, recibimos muchas solicitudes relacionadas con el escaneo de HTTPS.  Esto condujo al hecho de que el valor <code>SD</code> cay√≥ en los registros cuando el servidor SSH vio el mensaje <code>TLS ClientHello</code> mientras esperaba recibir un saludo SSH.  Esto condujo brevemente nuestra investigaci√≥n de una manera indirecta. <br><br>  Habiendo capturado algo de tr√°fico entre el HAProxy y el servidor Git y nuevamente usando las herramientas de Wireshark, descubrimos r√°pidamente que el SSHD en el servidor Git se desconect√≥ del TCP FIN-ACK inmediatamente despu√©s de un protocolo de enlace de tres v√≠as de TCP.  HAProxy todav√≠a no envi√≥ el primer paquete de datos, pero estaba a punto de hacerlo.  Cuando envi√≥ el paquete, el servidor Git le respondi√≥ con TCP RST.  Como resultado, ahora hemos descubierto la raz√≥n por la cual HAProxy escribi√≥ en los registros sobre la falla de conexi√≥n con el valor <code>SD</code> .  SSH cerr√≥ la conexi√≥n, haci√©ndolo de manera intencional y correcta, y RST fue solo un artefacto del hecho de que el servidor SSH recibi√≥ el paquete despu√©s de FIN-ACK.  No significaba nada m√°s. <br><br><h2>  <font color="#3AC1EF">Horario elocuente</font> </h2><br>  Al observar y analizar registros con valores <code>SD</code> en BigQuery, nos dimos cuenta de que los errores tienen una relaci√≥n pronunciada con el tiempo.  Es decir, encontramos picos en el n√∫mero de conexiones fallidas en los primeros 10 segundos de cada minuto.  Se observaron durante 5-6 segundos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/788/a83/19d/788a8319de4af6f082786f673f6bbb65.png"><br>  <i><font color="#999999">Errores de conexi√≥n agrupados en minutos a segundos</font></i> <br><br>  Este gr√°fico se basa en datos recopilados durante muchas horas.  El hecho de que el patr√≥n detectado de distribuci√≥n de errores result√≥ ser estable indica que la causa de los errores se manifiesta de manera estable en minutos y horas individuales y, posiblemente a√∫n peor, aparece de manera estable en diferentes momentos del d√≠a.  Es muy interesante que el tama√±o pico promedio es aproximadamente 3 veces mayor que la carga base.  Esto significaba que nos enfrentamos con un problema no trivial de escalado.  Como resultado, simplemente conectar "m√°s recursos" en forma de m√°quinas virtuales adicionales, dise√±adas para ayudarnos a hacer frente a las cargas m√°ximas, en teor√≠a podr√≠a ser inaceptablemente costoso.  Esto tambi√©n indic√≥ que estamos llegando a alg√∫n tipo de restricci√≥n severa.  Como resultado, recibimos la primera pista sobre el problema sist√©mico fundamental que causa errores.  Lo llam√© la tiran√≠a de las horas. <br><br>  Cron o sistemas de programaci√≥n similares a menudo no difieren en la capacidad de personalizar la ejecuci√≥n de tareas al segundo m√°s cercano.  Si tales sistemas tienen tales capacidades, no se usan con mucha frecuencia debido al hecho de que las personas prefieren considerar el tiempo, dividido en intervalos, expresados ‚Äã‚Äãpor hermosos n√∫meros redondos.  Como resultado, las tareas comienzan al comienzo de un minuto u hora, o en otros momentos similares.  Si las tareas necesitaran un par de segundos para preparar el comando <code>git fetch</code> para descargar materiales de gitlab.com, esto podr√≠a explicar el patr√≥n que encontramos cuando la carga en el sistema aumenta bruscamente durante varios segundos cada minuto.  En esos momentos, aumenta el n√∫mero de errores. <br><br>  <b>Lecci√≥n n√∫mero 2.</b>  Aparentemente, mucha gente usa la sincronizaci√≥n horaria correctamente configurada (a trav√©s de NTP o usando otros mecanismos). <br><br>  Si nadie sincronizara el tiempo, entonces nuestro problema no se habr√≠a manifestado tan claramente.  Buenas tardes, NTP! <br><br>  Pero, ¬øqu√© hace que SSH se desconecte? <br><br><h2>  <font color="#3AC1EF">M√°s cerca del n√∫cleo del problema</font> </h2><br>  Al estudiar la documentaci√≥n de SSHD, descubrimos el par√°metro <code>MaxStartups</code> .  Controla el n√∫mero m√°ximo de conexiones no autenticadas.  Parece plausible que el l√≠mite de conexi√≥n se agote cuando al comienzo del minuto el sistema est√° sujeto a la carga creada por una r√°faga de llamadas de tareas programadas de todo Internet.  El par√°metro <code>MaxStartups</code> consta de tres n√∫meros.  El primero es el l√≠mite inferior (el n√∫mero de conexiones al llegar que comienzan las interrupciones en las conexiones).  El segundo es el porcentaje de compuestos que exceden el l√≠mite inferior de los compuestos que deben romperse al azar.  El tercer valor es el n√∫mero m√°ximo absoluto de conexiones, despu√©s de lo cual se rechazan todas las conexiones nuevas.  El valor predeterminado de MaxStartups se ve como 10: 30: 100, nuestra configuraci√≥n se ve como 100: 30: 200.  Esto indic√≥ que en el pasado hemos aumentado los l√≠mites de conexi√≥n est√°ndar.  Tal vez, es hora de aumentarlos nuevamente. <br><br>  Result√≥ ser un poco desagradable que desde que se instal√≥ OpenSSH 7.2 en nuestros servidores, la √∫nica forma de ver los l√≠mites establecidos en <code>MaxStartups</code> fue cambiar al nivel de <code>Debug</code> depuraci√≥n.  Con este enfoque, una avalancha de datos cae en los registros.  Por lo tanto, activamos brevemente este modo en uno de los servidores.  Afortunadamente, despu√©s de un par de minutos qued√≥ claro que el n√∫mero de conexiones exced√≠a los l√≠mites establecidos en <code>MaxStartups</code> , como resultado de lo cual se produjo una desconexi√≥n temprana. <br><br>  Result√≥ que en OpenSSH 7.6 (esta versi√≥n viene con Ubuntu 18.04) se organiza un enfoque m√°s conveniente para registrar lo que est√° relacionado con <code>MaxStartups</code> .  Aqu√≠ solo necesita cambiar al modo de registro <code>Verbose</code> .  Aunque no es lo ideal, sigue siendo mejor que cambiar al nivel de <code>Debug</code> . <br><br>  <b>Lecci√≥n n√∫mero 3.</b>  Se considera una buena forma de escribir informaci√≥n interesante en los registros a niveles de registro est√°ndar, y la informaci√≥n sobre una desconexi√≥n intencional por cualquier motivo es ciertamente interesante para los administradores del sistema. <br><br>  Ahora que hemos descubierto la causa del problema, surgi√≥ la pregunta sobre c√≥mo resolverlo.  Podr√≠amos aumentar los valores en el par√°metro <code>MaxStartups</code> , pero ¬øcu√°nto nos costar√≠a?  Ciertamente, esto requerir√≠a un poco de memoria adicional, pero ¬øconducir√≠a a consecuencias adversas en aquellas partes del sistema donde se procesan las solicitudes?  Solo pod√≠amos pensarlo, as√≠ que decidimos tomar y probar la nueva configuraci√≥n de <code>MaxStartups</code> .  Es decir, los cambiamos por lo siguiente: 150: 30: 300.  Anteriormente, parec√≠an 100: 30: 200, es decir, aumentamos el n√∫mero de conexiones en un 50%.  Esto ha tenido un fuerte efecto positivo en el sistema.  Al mismo tiempo, no se observaron algunos efectos negativos, como el aumento de la carga en los procesadores. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/616/59e/d44/61659ed4470148fb4bc6d6f0115becb7.png"><br>  <i><font color="#999999">El n√∫mero de errores antes y despu√©s de aumentar MaxStartups en un 50%</font></i> <br><br>  Tenga en cuenta la reducci√≥n significativa de errores despu√©s de la marca de tiempo 1:15.  Esto indica claramente que pudimos eliminar una parte significativa de los errores, aunque algunos de ellos todav√≠a estaban presentes.  Es interesante observar que los errores se agrupan alrededor de marcas de tiempo representadas por hermosos n√∫meros redondos.  Este es el comienzo de la hora, cada 30, 15 y 10 minutos.  Sin lugar a dudas, la tiran√≠a del reloj continu√≥.  Al comienzo de cada hora, se observa el pico m√°s alto de errores.  Esto, dado lo que ya hemos descubierto, parece bastante comprensible.  Muchas personas simplemente planean ejecutar tareas cada hora que se ejecuta 0 minutos despu√©s del comienzo de la hora.  Este hecho confirm√≥ nuestra teor√≠a de que los picos de error son causados ‚Äã‚Äãpor el lanzamiento de tareas programadas.  Esto indic√≥ que est√°bamos en el camino correcto para resolver el problema ajustando los l√≠mites del sistema. <br><br>  Para nuestro placer, cambiar el l√≠mite de <code>MaxStartups</code> no condujo a efectos negativos notables.  El uso de la CPU en los servidores SSH se mantuvo en el mismo nivel que antes, la carga en nuestros sistemas tampoco aument√≥.  Fue muy agradable, considerando que ahora aceptamos m√°s conexiones, de aquellas que simplemente se habr√≠an roto antes.  Adem√°s, la situaci√≥n no empeor√≥ por el hecho de que hicimos esto en un momento en que nuestros sistemas estaban muy cargados.  Todo parec√≠a prometedor. <br><br>  Continuar√° ... <br><br>  <b>Estimados lectores!</b>  ¬øQu√© herramientas utilizas para analizar el tr√°fico y los registros? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/it/t5/3p/itt53pns2iucwylb3bwn1fmmtnu.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/466555/">https://habr.com/ru/post/466555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../466543/index.html">Los pr√©stamos semanales # 17 de Habr / Sberbank ser√°n aprobados por AI - aterrador, publicidad en productos de c√≥digo abierto - dudoso</a></li>
<li><a href="../466547/index.html">Feliz d√≠a del programador</a></li>
<li><a href="../466549/index.html">Principios generales de funcionamiento de QEMU-KVM</a></li>
<li><a href="../466551/index.html">Titiritero con ES6 en un nodo y navegador, o por qu√© Zora es el mejor marco de prueba en su nicho</a></li>
<li><a href="../466553/index.html">6 lecciones aprendidas al encontrar una soluci√≥n a un problema masivo en gitlab.com. Parte 2</a></li>
<li><a href="../466557/index.html">C√≥mo crear un dise√±o para el sitio y no permanecer extremo</a></li>
<li><a href="../466559/index.html">Let es el nuevo Var</a></li>
<li><a href="../466561/index.html">¬øNecesita opciones absolutamente transparentes? - los tengo</a></li>
<li><a href="../466563/index.html">KOST: lo que se incluye en la nueva pila de tecnolog√≠a para desarrollar aplicaciones en la nube</a></li>
<li><a href="../466565/index.html">Python + OpenCV + Keras: haga reconocimiento de texto en media hora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>