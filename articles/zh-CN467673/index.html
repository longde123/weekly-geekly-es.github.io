<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒ³ â˜®ï¸ ğŸ––ğŸ¾ å†…ç½®GoåŠŸèƒ½ ğŸ¤ğŸ¼ ğŸ‘©ğŸ¿â€âš–ï¸ ğŸ‘¨ğŸ½â€ğŸš’</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Goå…è®¸æ‚¨ç¼–å†™æ±‡ç¼–ç¨‹åºã€‚ ä½†æ˜¯è¯¥è¯­è¨€çš„ä½œè€…ç¼–å†™äº†è¿™æ ·ä¸€ä¸ªæ ‡å‡†åº“ï¼Œå› æ­¤ä¸å¿…è¿™æ ·åšã€‚ æœ‰å¤šç§æ–¹æ³•å¯ä»¥åŒæ—¶ç¼–å†™å¯ç§»æ¤å’Œå¿«é€Ÿçš„ä»£ç ã€‚ æ€ä¹ˆäº† æ¬¢è¿å…‰ä¸´ã€‚ 

 å¼€å§‹åœ¨æ±‡ç¼–å™¨ä¸­ç¼–å†™å‡½æ•°éå¸¸ç®€å•ã€‚ ä¾‹å¦‚ï¼Œå£°æ˜ï¼ˆæ­£å‘å£°æ˜ï¼‰ Addå‡½æ•°ï¼Œè¯¥å‡½æ•°æ·»åŠ 2 int64ï¼š 



 func Add(a int64, b ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å†…ç½®GoåŠŸèƒ½</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467673/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/v5/jg/mv/v5jgmvuskpn_epxwt8vt6vd1dny.png" width="200"></div><br>  Goå…è®¸æ‚¨ç¼–å†™æ±‡ç¼–ç¨‹åºã€‚ ä½†æ˜¯è¯¥è¯­è¨€çš„ä½œè€…ç¼–å†™äº†è¿™æ ·ä¸€ä¸ªæ ‡å‡†åº“ï¼Œå› æ­¤ä¸å¿…è¿™æ ·åšã€‚ æœ‰å¤šç§æ–¹æ³•å¯ä»¥åŒæ—¶ç¼–å†™å¯ç§»æ¤å’Œå¿«é€Ÿçš„ä»£ç ã€‚ æ€ä¹ˆäº† æ¬¢è¿å…‰ä¸´ã€‚ <br><a name="habracut"></a><br> å¼€å§‹åœ¨æ±‡ç¼–å™¨ä¸­ç¼–å†™å‡½æ•°éå¸¸ç®€å•ã€‚ ä¾‹å¦‚ï¼Œå£°æ˜ï¼ˆæ­£å‘å£°æ˜ï¼‰ <code>Add</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°æ·»åŠ 2 int64ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64</span></span></span></span><span class="hljs-function"><span class="hljs-params">, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int64</span></span></span></span></code> </pre><br> è¿™æ˜¯æ­£å¸¸åŠŸèƒ½ï¼Œä½†åŠŸèƒ½ä½“ç¼ºå¤±ã€‚ å°è¯•ç¼–è¯‘è½¯ä»¶åŒ…æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå‘èª“ã€‚ <br><br><pre> <code class="bash hljs">% go build examples/asm ./decl.go:4:6: missing <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> body</code> </pre><br> æ·»åŠ æ‰©å±•åä¸º.sçš„æ–‡ä»¶ï¼Œå¹¶åœ¨æ±‡ç¼–å™¨ä¸­å®ç°è¯¥åŠŸèƒ½ã€‚ <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">TEXT</span></span> Â·Add(SB),<span class="hljs-number"><span class="hljs-number">$0</span></span>-24 MOVQ a+0(FP), AX ADDQ b+8(FP), AX MOVQ AX, ret+16(FP) RET</code> </pre><br> ç°åœ¨ï¼Œæ‚¨å¯ä»¥ç¼–è¯‘ï¼Œæµ‹è¯•å¹¶å°†â€œ <code>Add</code>ç”¨ä½œå¸¸è§„åŠŸèƒ½ã€‚ è¯­è¨€å¼€å‘äººå‘˜è‡ªå·±åœ¨<abbr title="æŸ¥æ‰¾$ {GOROOT} / src -name'* .s'| xargsç›®å½•å| uniq --count | sort --reverse --numeric-sort |å¤´çº¿= 20; ï¼ƒä½¿ç”¨asmçš„é¡¶çº§è½¯ä»¶åŒ…">è¿è¡Œæ—¶ï¼Œmathï¼Œbytealgï¼Œsyscallï¼Œreflectï¼Œcrypto</abbr>åŒ…ä¸­å¹¿æ³›ä½¿ç”¨äº†æ­¤æ–¹æ³•ã€‚ è¿™ä½¿æ‚¨å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯­è¨€ä¸­æœªè¡¨ç¤ºçš„</a>ç¡¬ä»¶å¤„ç†å™¨ä¼˜åŒ–å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‘½ä»¤</a> ã€‚ <br><br> ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜-æ— æ³•ä¼˜åŒ–å’Œå†…ç½®ï¼ˆå†…è”ï¼‰asmä¸Šçš„å‡½æ•°ã€‚ æ²¡æœ‰è¿™ä¸ªï¼Œå¼€é”€å¯èƒ½ä¼šä»¤äººæœ›è€Œå´æ­¥ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Result <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkAddNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { r = <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>(i) + <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>(i) } Result = r } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkAddAsm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { r = Add(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>(i), <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>(i)) } Result = r }</code> </pre><br><pre> <code class="plaintext hljs">BenchmarkAddNative-8 1000000000 0.300 ns/op BenchmarkAddAsm-8 606165915 1.930 ns/op</code> </pre><br> å¯¹äºå†…è”æ±‡ç¼–ç¨‹åºï¼Œæœ‰ä¸€äº›å»ºè®®ï¼Œä¾‹å¦‚gccä¸­çš„<code>asm(...)</code>æŒ‡ä»¤ã€‚ ä»–ä»¬éƒ½æ²¡æœ‰è¢«æ¥å—ã€‚ ä»£æ›¿æ­¤ï¼Œæ·»åŠ <abbr title="è¿™å¯èƒ½ä¸æ˜¯å®˜æ–¹åç§°ï¼Œä½†ä¼šå‡ºç°åœ¨ç¼–è¯‘å™¨çš„ä»£ç å’Œæµ‹è¯•ä¸­ã€‚">å†…åœ¨</abbr>å‡½æ•°ã€‚ <br><br>  Goå†…ç½®å‡½æ•°ä»¥çº¯Goè¯­è¨€ç¼–å†™ã€‚ ä½†æ˜¯ç¼–è¯‘å™¨çŸ¥é“å¯ä»¥ç”¨æ›´ä¼˜åŒ–çš„æ–¹æ³•ä»£æ›¿å®ƒä»¬ã€‚ åœ¨Go 1.13ä¸­ï¼ŒåµŒå…¥å¼å‡½æ•°åŒ…å«åœ¨<code>math/bits</code>å’Œ<code>sync/atomic</code> ã€‚ <br><br> è¿™äº›è½¯ä»¶åŒ…ä¸­çš„åŠŸèƒ½å…·æœ‰ç²¾ç¾çš„ç­¾åã€‚ å®é™…ä¸Šï¼Œå®ƒä»¬é‡å¤å¤„ç†å™¨å‘½ä»¤çš„ç­¾åã€‚ å¦‚æœç›®æ ‡ä½“ç³»ç»“æ„æ”¯æŒï¼Œè¿™ä½¿ç¼–è¯‘å™¨å¯ä»¥ç”¨æ±‡ç¼–å™¨æŒ‡ä»¤é€æ˜åœ°æ›¿æ¢å‡½æ•°è°ƒç”¨ã€‚ <br><br> ä¸‹é¢ï¼Œæˆ‘æƒ³è°ˆè°ˆgoç¼–è¯‘å™¨ä½¿ç”¨å†…ç½®å‡½æ•°åˆ›å»ºæ›´é«˜æ•ˆâ€‹â€‹ä»£ç çš„ä¸¤ç§ä¸åŒæ–¹å¼ã€‚ <br><br><h4> äººå£æ•° </h4><br> æ•°å­—çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„æ­¤å•ä½æ•°ç›®æ˜¯é‡è¦çš„å¯†ç åŸè¯­ã€‚ ç”±äºè¿™æ˜¯ä¸€é¡¹é‡è¦çš„æ“ä½œï¼Œå› æ­¤å¤§å¤šæ•°ç°ä»£cpuéƒ½æä¾›äº†ç¡¬ä»¶å®ç°ã€‚ <br>  <code>math/bits</code>åŒ…åœ¨<code>OnesCount*</code>å‡½æ•°ä¸­æä¾›äº†æ­¤æ“ä½œã€‚ å®ƒä»¬è¢«è¯†åˆ«å¹¶è¢«<code>POPCNT</code>å¤„ç†å™¨<code>POPCNT</code>å–ä»£ã€‚ <br><br> ä¸ºäº†äº†è§£å¦‚ä½•æé«˜æ•ˆç‡ï¼Œè®©æˆ‘ä»¬æ¯”è¾ƒ3ç§å®ç°ã€‚ é¦–å…ˆæ˜¯<abbr title="Cç¼–ç¨‹è¯­è¨€ç¬¬äºŒç‰ˆï¼Œ1998å¹´">Kerniganç®—æ³•</abbr> ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kernighan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(count </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> { count++ x &amp;= x - <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count }</code> </pre><br> ç®—æ³•çš„å¾ªç¯æ•°ä¸è®¾ç½®çš„ä½æ•°ä¸€è‡´ã€‚ æ›´å¤šä½-æ›´é•¿çš„æ‰§è¡Œæ—¶é—´ï¼Œè¿™å¯èƒ½å¯¼è‡´ç¬¬ä¸‰æ–¹æ¸ é“ä¸Šçš„ä¿¡æ¯æ³„æ¼ã€‚ <br><br> ç¬¬äºŒç§ç®—æ³•æ¥è‡ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Hacker's Delight</a> ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hackersdelight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint8</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> m1 = <span class="hljs-number"><span class="hljs-number">0</span></span>b0101010101010101010101010101010101010101010101010101010101010101 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> m2 = <span class="hljs-number"><span class="hljs-number">0</span></span>b0011001100110011001100110011001100110011001100110011001100110011 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> m4 = <span class="hljs-number"><span class="hljs-number">0</span></span>b0000111100001111000011110000111100001111000011110000111100001111 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> h1 = <span class="hljs-number"><span class="hljs-number">0</span></span>b0000000100000001000000010000000100000001000000010000000100000001 x -= (x &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; m1 x = (x &amp; m2) + ((x &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) &amp; m2) x = (x + (x &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)) &amp; m4 <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8</span></span>((x * h1) &gt;&gt; <span class="hljs-number"><span class="hljs-number">56</span></span>) }</code> </pre><br> åˆ†è€Œæ²»ä¹‹çš„ç­–ç•¥ä½¿è¯¥ç‰ˆæœ¬å¯ä»¥ä»é•¿æ•´æ•°å¼€å§‹ä¸ºOï¼ˆlog 2ï¼‰å·¥ä½œï¼Œå¹¶ä¸”ä»ä½æ•°å¼€å§‹åœ¨æ’å®šæ—¶é—´å†…å·¥ä½œï¼Œè¿™å¯¹äºå¯†ç å­¦å¾ˆé‡è¦ã€‚ è®©æˆ‘ä»¬å°†æ€§èƒ½ä¸<code>math/bits.OnesCount64</code>è¿›è¡Œæ¯”è¾ƒã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkKernighan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { r = kernighan(<span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>(i)) } runtime.KeepAlive(r) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkPopcnt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { r = hackersdelight(<span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>(i)) } runtime.KeepAlive(r) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkMathBitsOnesCount64</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { r = bits.OnesCount64(<span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>(i)) } runtime.KeepAlive(r) }</code> </pre><br> è€å®è¯´ï¼Œæˆ‘ä»¬å°†ç›¸åŒçš„å‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼šä»0åˆ°bNçš„åºåˆ—è¿™å¯¹äºKerniganæ–¹æ³•æ›´æ˜¯å¦‚æ­¤ï¼Œå› ä¸ºå…¶æ‰§è¡Œæ—¶é—´éšè¾“å…¥å‚æ•°çš„ä½æ•°è€Œå¢åŠ ã€‚  <abbr title="å¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œè¯·å°è¯•å°†0xdeadbeefä¼ é€’ç»™æ¯ä¸ªå‡½æ•°å¹¶æŸ¥çœ‹ç»“æœã€‚">âš</abbr> <br><br><pre> <code class="plaintext hljs">BenchmarkKernighan-4 100000000 12.9 ns/op BenchmarkPopcnt-4 485724267 2.63 ns/op BenchmarkMathBitsOnesCount64-4 1000000000 0.673 ns/op</code> </pre><br>  <code>math/bits.OnesCount64</code>èµ¢å¾—é€Ÿåº¦4æ¬¡ã€‚ ä½†æ˜¯å®ƒç¡®å®ä½¿ç”¨ç¡¬ä»¶å®ç°ï¼Œè¿˜æ˜¯ç¼–è¯‘å™¨åªæ˜¯æ›´å¥½åœ°ä¼˜åŒ–äº†Hackers Delightçš„ç®—æ³•ï¼Ÿ ç°åœ¨æ˜¯æ—¶å€™è¿›å…¥æ±‡ç¼–ç¨‹åºäº†ã€‚ <br><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -c <span class="hljs-comment"><span class="hljs-comment">#    </span></span></code> </pre><br> æœ‰ä¸€ä¸ªç”¨äºæ‹†å¸goå·¥å…·objdumpçš„ç®€å•å®ç”¨ç¨‹åºï¼Œä½†æ˜¯æˆ‘ï¼ˆä¸åŸå§‹æ–‡ç« çš„ä½œè€…ä¸åŒï¼‰ï¼Œæˆ‘å°†ä½¿ç”¨IDAã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nb/fj/q1/nbfjq1wg43hutueud_3c3pzbt4o.png"></div><br> è¿™é‡Œæœ‰å¾ˆå¤šäº‹æƒ…ã€‚ æœ€é‡è¦çš„æ˜¯ï¼šæ­£å¦‚æˆ‘ä»¬å¸Œæœ›çš„é‚£æ ·ï¼Œx86 <code>POPCNT</code>æŒ‡ä»¤å·²å†…ç½®åœ¨æµ‹è¯•æœ¬èº«çš„ä»£ç ä¸­ã€‚ è¿™ä½¿æ ‡è®°æ ‡è®°æ¯”å…¶ä»–æ ‡è®°æ›´å¿«ã€‚ <br><br> è¿™ä¸ªåˆ†æ”¯å¾ˆæœ‰è¶£ã€‚ <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">cmp</span></span> cs:runtime_x86HasPOPCNT, 0 jz lable</code> </pre><br> æ˜¯çš„ï¼Œè¿™æ˜¯æ±‡ç¼–ç¨‹åºä¸Šçš„polyphileã€‚ å¹¶éæ‰€æœ‰å¤„ç†å™¨éƒ½æ”¯æŒ<code>POPCNT</code> ã€‚ ç¨‹åºå¯åŠ¨æ—¶ï¼Œåœ¨æ‚¨çš„<code>main</code>ä¹‹å‰ï¼Œ <code>runtime.cpuinit</code>å‡½æ•°æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„æŒ‡ä»¤å¹¶å°†å…¶ä¿å­˜åœ¨<code>runtime.x86HasPOPCNT</code> ã€‚ ç¨‹åºæ¯æ¬¡æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨<code>POPCNT</code>æˆ–ä½¿ç”¨polyfileã€‚ ç”±äº<code>runtime.x86HasPOPCNT</code>çš„å€¼åœ¨åˆå§‹åŒ–åä¸ä¼šæ›´æ”¹ï¼Œå› æ­¤å¤„ç†å™¨åˆ†æ”¯çš„é¢„æµ‹ç›¸å¯¹å‡†ç¡®ã€‚ <br><br><h4> åŸå­è®¡æ•°å™¨ </h4><br> å†…éƒ¨å‡½æ•°æ˜¯å¸¸è§„çš„Goä»£ç ï¼›å®ƒä»¬å¯ä»¥åœ¨æŒ‡ä»¤æµä¸­å†…è”ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŸå­åŒ…åŠŸèƒ½çš„å¥‡æ€ªç­¾åä¸­çš„æ–¹æ³•å¯¹è®¡æ•°å™¨è¿›è¡ŒæŠ½è±¡ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"sync/atomic"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> counter <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint64</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> atomic.LoadUint64((*<span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>)(c)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint64</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> atomic.AddUint64((*<span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>)(c), <span class="hljs-number"><span class="hljs-number">1</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint64</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> atomic.SwapUint64((*<span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>)(c), <span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint64</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c counter c.inc() c.get() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.reset() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { F() }</code> </pre><br> æœ‰äººä¼šè®¤ä¸ºè¿™æ ·çš„OOPä¼šå¢åŠ å¼€é”€ã€‚ ä½†æ˜¯Goä¸æ˜¯Javaï¼Œé™¤éæ‚¨æ˜ç¡®ä½¿ç”¨æ¥å£ï¼Œå¦åˆ™è¯¥è¯­è¨€ä¸ä¼šåœ¨è¿è¡Œæ—¶ä½¿ç”¨ç»‘å®šã€‚ ä¸Šé¢çš„ä»£ç å°†åˆ†è§£ä¸ºé«˜æ•ˆçš„å¤„ç†å™¨æŒ‡ä»¤æµã€‚ ä¸»è¦æ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nx/cp/ps/nxcppsylwv0dy0gzvoixw43iq3s.png"></div><br> ä¸ºäº†ã€‚  <code>c.inc</code>å˜æˆ<code>lock xadd [rax], 1</code> -x86çš„åŸå­åŠ æ³•ã€‚  <code>c.get</code>æˆä¸ºé€šå¸¸çš„<code>mov</code>æŒ‡ä»¤ï¼Œåœ¨x86ä¸­å·²ç»æ˜¯åŸå­çš„ã€‚  <code>c.reset</code>æˆä¸ºç©ºå¯„å­˜å™¨å’Œå†…å­˜ä¹‹é—´<code>xchg</code>çš„åŸå­äº¤æ¢ã€‚ <br><br><h4> ç»“è®º </h4><br> åµŒå…¥å¼å‡½æ•°æ˜¯ä¸€ç§ç®€æ´çš„è§£å†³æ–¹æ¡ˆï¼Œæ— éœ€æ‰©å±•è¯­è¨€è§„èŒƒå³å¯æä¾›å¯¹ä½çº§æ“ä½œçš„è®¿é—®ã€‚ å¦‚æœè¯¥ä½“ç³»ç»“æ„æ²¡æœ‰ç‰¹å®šçš„åŒæ­¥/åŸå­åŸè¯­ï¼ˆå¦‚æŸäº›ARMå˜ä½“ï¼‰æˆ–æ•°å­¦/ä½è¿ç®—ï¼Œåˆ™ç¼–è¯‘å™¨å°†å®Œå…¨æ’å…¥ä¸€ä¸ªå¤šæ–‡ä»¶ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN467673/">https://habr.com/ru/post/zh-CN467673/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN467663/index.html">æ”¯æŒ.NET Coreä¸­çš„ç‰¹å®šäºç¡¬ä»¶çš„æŒ‡ä»¤ï¼ˆç°åœ¨ä¸ä»…é™äºSIMDï¼‰</a></li>
<li><a href="../zh-CN467665/index.html">ROSå¡è½¦æ‰‹æ¨è½¦ã€‚ ç¬¬5éƒ¨åˆ†ã€‚åœ¨rvizå’Œå‡‰äº­ä¸­å·¥ä½œï¼šxacroï¼Œæ–°ä¼ æ„Ÿå™¨</a></li>
<li><a href="../zh-CN467667/index.html">ç»„ç»‡é¡¹ç›®è®¡åˆ’ï¼ˆç¬¬4éƒ¨åˆ†ï¼‰</a></li>
<li><a href="../zh-CN467669/index.html">è§‚çœ‹å…¨æ–‡ï¼šå……åˆ†åˆ©ç”¨ç§»åŠ¨å¹³å°ä¸Šçš„å®æ—¶è§†é¢‘</a></li>
<li><a href="../zh-CN467671/index.html">NLXå¤å¤ç”µè„‘</a></li>
<li><a href="../zh-CN467675/index.html">åœ¨SwiftUIä¸­ä½¿ç”¨Storeå¯¹è±¡å»ºæ¨¡åº”ç”¨ç¨‹åºçŠ¶æ€</a></li>
<li><a href="../zh-CN467677/index.html">æµ‹è¯•æˆ–ç±»å‹</a></li>
<li><a href="../zh-CN467679/index.html">PyCrunch-IDEä¸­çš„æ™ºèƒ½æµ‹è¯•æ‰§è¡Œå’Œå¯è§†ä»£ç è¦†ç›–</a></li>
<li><a href="../zh-CN467681/index.html">SOAPè·¯ç”±ç»•è¡Œæ¼æ´</a></li>
<li><a href="../zh-CN467683/index.html">è¯•å›¾ç»„æˆéç»„åˆï¼šå¯¹æ¥æ–¹æ¡ˆ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>