<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏿‍🤝‍🧑🏻 🏳️ 📚 Yii1 / yii2身份验证共享 🙍🏼 📦 🚣🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="如果没有第一部分 ，本文就没有意义，在第一部分中有一个答案“为什么要这样做”。 

 它是关于将项目从yii1顺利迁移到yii2的技术。 其实质是yii1上的项目分支和yii2上的新版本在一个虚拟主机中的同一域上一起工作，并且迁移是逐步进行的，而且步调很小（通过页面，控制器，模块等）。 

 第一部...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Yii1 / yii2身份验证共享</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419999/"><img src="https://habrastorage.org/webt/ax/qo/vv/axqovvxw6vehedogcejd1obzehs.jpeg" alt="图片"><br><br> 如果没有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第一部分</a> ，本文就没有意义<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">，在第一部分</a>中有一个答案“为什么要这样做”。 <br><br> 它是关于将项目从yii1顺利迁移到yii2的技术。 其实质是yii1上的项目分支和yii2上的新版本在一个虚拟主机中的同一域上一起工作，并且迁移是逐步进行的，而且步调很小（通过页面，控制器，模块等）。 <br><br> 第一部分是关于如何在现有虚拟主机上的yii2上运行一个裸项目。 使两个分支机构一起工作而不相互干扰。 <br><br> 之后，最困难的阶段开始了：您需要为开始创建一个最小的基础架构。 我将挑出2个任务：重复设计和端到端用户身份验证。 <br><br> 设计的重复是无聊的第一位。 如果您不走运，只需复制/还原旧的“ 1合1”即可。 就我个人而言，我总是与重新设计结合在一起。 即 界面和设计已得到重大更新，在这方面，工作并不愚蠢。 但这里有他自己的一面-我非常注意界面和设计，恰恰相反，有人更喜欢后端和控制台。 但是，无论喜好如何，都无法克服此任务-您将必须创建一个界面，并且工作量将很大。 <br><br> 端到端身份验证更加有趣，并且工作量将减少。 与第一篇文章一样，不会有任何启示。 本文的特征：首次解决此问题的人员的教程。 <br><br> 如果这是您的情况，那么请参考更多详细信息 <br><a name="habracut"></a><br> 首先，您需要在分支之间拆分功能。 因为 可以理解，迁移阶段只是在开始阶段，然后很可能所有与用户进行的工作（注册，身份验证，密码恢复等）都保留在旧站点上。  yii2上的新分支应该只看到已经通过身份验证的用户。 <br><br>  yii1 / yii2的身份验证机制略有不同，您需要调整yii2代码，以便它可以看到经过身份验证的用户。 因为 身份验证数据存储在会话中，您只需要在用于读取会话数据的参数上达成一致即可。 <br><br> 在来自yii1的会话中，这是以某种方式存储的： <br><br><pre><code class="php hljs">print_r($_SESSION); <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [<span class="hljs-number"><span class="hljs-number">34e60</span></span>d27092d90364d1807021107e5a3__id] =&gt; <span class="hljs-number"><span class="hljs-number">123456</span></span> [<span class="hljs-number"><span class="hljs-number">34e60</span></span>d27092d90364d1807021107e5a3__name] =&gt; tester [<span class="hljs-number"><span class="hljs-number">34e60</span></span>d27092d90364d1807021107e5a3__states] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( ) )</code> </pre> <br> 它如何与您一起存储-例如，检查yii1的不同版本中prefixKey的生成方式是否不同。 <br><br> 这是您需要的yii1数据 <br><br><pre> <code class="php hljs">Yii::app()-&gt;user-&gt;getStateKeyPrefix() Yii::app()-&gt;name Yii::app()-&gt;getBasePath() Yii::app()-&gt;getId() get_class(Yii::app()-&gt;user)</code> </pre><br> 最简单的方法是制作测试页并在其上显示所有必要的数据-将来将需要它们。 <br><br><h2>  yii2中的身份验证 </h2><br> 在Yii2中，我们需要的所有功能都位于用户组件（ <u>\ yii \ web \ User</u> ）中，该组件控制身份验证状态。 <br><br><ul><li> 在其<u>getIdentity（）</u>方法中， <u>调用了renewAuthStatus（）</u> ，其中，通过<u>$ idParam</u>变量中的密钥查找身份验证会话（默认情况下，其中存储了“ __id”）； </li><li> 在会话变量中，用户ID是使用键<u>$ idParam</u>存储的（例如，来自<u>app / model / User</u> ）。 </li></ul><br>  <i>认证算法<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在官方指南中有</a>详细<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">描述</a> 。</i> <br><br> 当然，在yii1中，会话使用其他密钥存储。 因此，您需要使yii2使用与yii1中存储的相同的键来查找用户ID。 <br><br>  <b>为此：</b> <br><br>  1.将负责管理身份验证状态的用户组件的类更改为我们自己的类，该类继承自<u>config / web.php中的yii</u> <u>/ web / User</u> <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'components'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'app\models\WebUser'</span></span>, <span class="hljs-string"><span class="hljs-string">'identityClass'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'app\models\User'</span></span>, ], ]</code> </pre><br>  2.在<u>app \ models \ WebUser中</u>调整<u>$ idParam</u>的值。 <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  idParam (    //    ) $this-&gt;idParam = $this-&gt;getIdParamYii1(); }</span></span></code> </pre> <br> 在扰流器下，将有一些方法以某种方式模仿yii1的类似行为。 <br><br> 通常，您可以仅从<u>yii1</u>复制原始的<u>_keyPrefix</u> （甚至<u>立即</u>复制<u>idParam</u> ），而不模拟其生成，但是就像“复制难以理解的垃圾”指令一样。 <br><br> 确实，您可以复制，因为yii1中的_keyPrefix几乎是静态的。 它取决于用户组件的类名称和应用程序ID，而应用程序ID又从应用程序的位置及其名称获得。 <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   yii1  _keyPrefix $this-&gt;_keyPrefix = md5('Yii.'.get_class($this).'.'.Yii::app()-&gt;getId()); //   - ID  $this-&gt;_id=sprintf('%x',crc32($this-&gt;getBasePath().$this-&gt;name));</span></span></code> </pre><br> 如果我们仅将自己限制在身份验证任务中，则复制_keyPrefix值将大大减少工作量。 但我将举例说明更广泛的用途。 <br><br><div class="spoiler">  <b class="spoiler_title">用户组件（app \ models \ WebUser）</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">web</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebUser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *    cookies  yii2, *     yii1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $autoRenewCookie = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * _keyPrefix    CWebUser  Yii1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_keyPrefix; <span class="hljs-comment"><span class="hljs-comment">/** *    Yii1,    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $paramsYii1 = [ <span class="hljs-comment"><span class="hljs-comment">//    user   Yii1 'classUserComponent' =&gt; 'CWebUser', // ID  Yii1 //  ,  Yii::app()-&gt;getId() 'appId' =&gt; '', //     Yii1 'appName' =&gt; 'My Web Application', //     yii1  \Yii::getAlias('@app') 'relPath' =&gt; '../htdocs/protected', ]; public function init() { //  idParam (    //    ) $this-&gt;idParam = $this-&gt;getIdParamYii1(); } }</span></span></code> </pre><br> 以及其他方法（WebUser）。  <i>分开以便于观看。</i> <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *     Yii1,    ID  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIdParamYii1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getStateKeyPrefix() . <span class="hljs-string"><span class="hljs-string">'__id'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** *    Yii 1 * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStateKeyPrefix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_keyPrefix !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_keyPrefix; $class = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;paramsYii1[<span class="hljs-string"><span class="hljs-string">'classUserComponent'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_keyPrefix = md5(<span class="hljs-string"><span class="hljs-string">'Yii.'</span></span> . $class . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getAppIdYii1()); } <span class="hljs-comment"><span class="hljs-comment">/** *   getId()  CApplication * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string ID  Yii1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAppIdYii1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;paramsYii1[<span class="hljs-string"><span class="hljs-string">'appId'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;paramsYii1[<span class="hljs-string"><span class="hljs-string">'appId'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;paramsYii1[<span class="hljs-string"><span class="hljs-string">'appId'</span></span>] = sprintf(<span class="hljs-string"><span class="hljs-string">'%x'</span></span>, crc32(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getBasePathYii1() . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;paramsYii1[<span class="hljs-string"><span class="hljs-string">'appName'</span></span>])); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string    Yii1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBasePathYii1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $basePath = realpath(\Yii::getAlias(<span class="hljs-string"><span class="hljs-string">'@app'</span></span>) . DIRECTORY_SEPARATOR . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;paramsYii1[<span class="hljs-string"><span class="hljs-string">'relPath'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$basePath) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidConfigException(<span class="hljs-string"><span class="hljs-string">'basePath  yii1  .'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $basePath; }</code> </pre><br>  <i>仅对于“ <u>同意会话密钥的格式</u> ”的任务，方法的分解有点复杂，但是它们对于以下示例很有用。</i> <br></div></div><br> 之后，在yii2上的新分支中，对先前在yii1中授权的用户的识别开始起作用。 理想情况下，必须停止在此位置，因为滑行路径会进一步开始。 <br><br><h2>  yii2中的用户登录 </h2><br> 同意会话中用户ID的存储格式后，即使“自动”用户登录也可能会通过yii2起作用。 <br><br>  <i>我认为在战斗模式下使用yii2上的登录表单而不禁用yii1上的相应表单是不正确的，但是，基本的功能在稍加协调之后就可以使用。</i> <br><br> 因为 我们认为，在进行用户注册以及相应的密码哈希处理后，我们留在yii1中，然后对于通过yii2进行的有效登录，我们需要确保yii2中保存的密码的验证方法可以理解在Yii1中进行了哈希处理和存储的内容。 <br><br> 检查这些方法的作用。 <br><br> 例如，如果在Yii2中，条件标准用户模型User将按以下方式验证密码： <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validatePassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($password)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> \Yii::$app-&gt;getSecurity()-&gt;validatePassword($password, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;password); }</code> </pre><br> 然后，从<u>yii \ base \ Security</u> （Yii2）中查看<u>validatePassword（$ password，$ hash）</u> <u>方法</u> 。 <br><br><div class="spoiler">  <b class="spoiler_title">validatePassword（）</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validatePassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($password, $hash)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_string($password) || $password === <span class="hljs-string"><span class="hljs-string">''</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidArgumentException(<span class="hljs-string"><span class="hljs-string">'Password must be a string and cannot be empty.'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!preg_match(<span class="hljs-string"><span class="hljs-string">'/^\$2[axy]\$(\d\d)\$[\.\/0-9A-Za-z]{22}/'</span></span>, $hash, $matches) || $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">4</span></span> || $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">30</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidArgumentException(<span class="hljs-string"><span class="hljs-string">'Hash is invalid.'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (function_exists(<span class="hljs-string"><span class="hljs-string">'password_verify'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password_verify($password, $hash); } $test = crypt($password, $hash); $n = strlen($test); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($n !== <span class="hljs-number"><span class="hljs-number">60</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;compareString($test, $hash); }</code> </pre></div></div><br> 如果在Yii1上，用户模型中的密码哈希是这样完成的： <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($password)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CPasswordHelper::hashPassword($password); }</code> </pre><br> 然后与<u>yii</u> <u>\ framework \ utils \ CPasswordHelper中的</u> <u>verifyPassword（$ password，$ hash）</u>进行比较 <br><br><div class="spoiler">  <b class="spoiler_title">hashPassword（）</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($password,$cost=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">13</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::checkBlowfish(); $salt=<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::generateSalt($cost); $hash=crypt($password,$salt); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!is_string($hash) || (function_exists(<span class="hljs-string"><span class="hljs-string">'mb_strlen'</span></span>) ? mb_strlen($hash, <span class="hljs-string"><span class="hljs-string">'8bit'</span></span>) : strlen($hash))&lt;<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CException(Yii::t(<span class="hljs-string"><span class="hljs-string">'yii'</span></span>,<span class="hljs-string"><span class="hljs-string">'Internal error while generating hash.'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $hash; }</code> </pre><br></div></div><br> 如果哈希和验证方法不同，则需要在<u>app \ model \ User</u>中的<u>validatePassword（）中</u>更改验证。 <br><br> 从框架的最新版本的框中，可以兼容Yii1 / Yii2密码哈希。 但这并不意味着它们将与您兼容，或者将来会重合。  Yii1中项目的哈希方法和Yii2新项目中的验证方法的概率很高。 <br><br><h2> 在Yii2中自动登录yii1的cookie </h2><br><blockquote> 由于Yii2上的分支机构已经知道如何透明地使用Yii1的用户身份验证数据，为什么不通过cookie设置自动登录？ <br></blockquote> 如果您有这种想法，建议您不要这样做。 我认为没有充分的理由在不将用户工作（首先是身份验证）转移到此线程的情况下在Yii2上启用自动登录。 即 我的意思是以下情况： <br><br>  <i>用户身份验证是在Yii1上执行的，但是Yii2分支应该能够对Yii1中存储的cookie进行自动登录。</i> <i><br></i> <br> 老实说，这是一个坦率的变态。 这样做并非易事而优雅，只是在这之间的界限介于有意识和合理的移徙任务与不必要的自行车的发明之间。 <br><br> 困难在于，Yii的两个分支机构都受到保护，免受假Cookie的影响，因此很难就方法达成一致。 <br><br><ul><li>  Yii2涉及的组件是：用户（ <u>\ yii \ web \ User</u> ）， <u>请求</u> ， <u>安全性</u> + <u>CookieCollection</u> </li><li> 在Yii1中： <u>CWebUser</u> ， <u>CHttpRequest</u> ， <u>CSecurityManager</u> ， <u>CStatePersister</u> ， <u>CCookieCollection</u> </li></ul><br> 但是，情况不同。 以下是如何使用自行车进行自动登录的示例。 <br><br> 在yii2中，我们对<u>\ yii \ web \ User</u>中的<u>getIdentityAndDurationFromCookie（）</u>方法感兴趣。 在此方法的第一行中，应获取所需的cookie： <br><br><pre> <code class="php hljs">$value = Yii::$app-&gt;getRequest()-&gt;getCookies()-&gt;getValue(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;identityCookie[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]);</code> </pre> <br> 但是她不会，因为  <u>Yii :: $ app-&gt; getRequest（）-&gt; getCookies（）</u>集合将为空，因为在<u>Request</u> cookie中，验证是通过<u>loadCookies（）</u>加载的，并且当然不会通过。 <br><br> 分叉最简单的方法是通过覆盖<u>getIdentityAndDurationFromCookie（）</u>来实现标准行为。 例如，像这样： <br><br><ol><li> 直接从超全局$ _COOKIE下载所需的cookie，以免<s>破坏</s>标准的cookie加载机制。 <br><br> 标识cookie的名称仅为_keyPrefix，我们已经知道如何接收（或复制）了。 因此，我们在<u>init（）中</u>更改了标准<u>$ identityCookie</u> 。 <br></li><li>  “大约与yii1中一样”解密所得的cookie。 如你所愿。 例如，我从<u>CSecurityManager</u>复制了必需的方法。 </li></ol><br> 实际上，下面是代码。 <br><br><div class="spoiler">  <b class="spoiler_title">我们在应用程序/模型/ WebUser中工作</b> <div class="spoiler_text">  1.按照ii1设置的名称identityCookie cookie <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;idParam = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getIdParamYii1(); <span class="hljs-comment"><span class="hljs-comment">//     $this-&gt;identityCookie = ['name' =&gt; $this-&gt;getStateKeyPrefix()]; }</span></span></code> </pre><br><br>  2.再添加两种方法 <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIdentityAndDurationFromCookie</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $id = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getIdIdentityFromCookiesYii1(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$id) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } $class = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;identityClass; $identity = $class::findOne($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($identity !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'identity'</span></span> =&gt; $identity, <span class="hljs-string"><span class="hljs-string">'duration'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** *  ID identity  cookies,   yii1 * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> null|integer  ID     null */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIdIdentityFromCookiesYii1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_COOKIE[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;identityCookie[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]])) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; $cookieValue = $_COOKIE[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;identityCookie[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]]; <span class="hljs-comment"><span class="hljs-comment">// Cookies  yii1 ,  $utilSecurity = new UtilYii1Security($this-&gt;getBasePathYii1()); $data = $utilSecurity-&gt;validateData($cookieValue); if ($data === false) { return null; } $data = @unserialize($data); if (is_array($data) &amp;&amp; isset($data[0], $data[1], $data[2], $data[3])) { list($id, $name, $duration, $states) = $data; return $id; } return null; }</span></span></code> </pre><br></div></div><br> 该代码使用某个<u>UtilYii1Security</u>类-这是对<u>CSecurityManager</u>的必要方法的修改后的复制粘贴，因此，一方面看起来像原始的，但有一些简化。 例如，在<u>CSecurityManager中，有</u>多个用于生成HMAC（基于哈希的消息身份验证代码）的选项，这取决于php版本和mbstring的存在。 但是因为 已知yii1与yii2在相同的环境中工作，然后简化了任务，并因此简化了代码。 <br><br> 因为 很显然，这里写了一个明显的拐杖，所以没有必要尝试使其通用并赋予它优美的形状，足以在您的条件下对其进行“研磨”。 <br><br><div class="spoiler">  <b class="spoiler_title">UtilYii1Security.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">components</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *   CSecurityManager  Yii1, *     * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">base</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">base</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">base</span></span>\<span class="hljs-title"><span class="hljs-title">InvalidConfigException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UtilYii1Security</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * ,   yii1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STATE_VALIDATION_KEY = <span class="hljs-string"><span class="hljs-string">'Yii.CSecurityManager.validationkey'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *  ,    yii1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $hashAlgorithm = <span class="hljs-string"><span class="hljs-string">'sha1'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   cookies */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_validationKey; <span class="hljs-comment"><span class="hljs-comment">/** *    Yii1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $basePath; <span class="hljs-comment"><span class="hljs-comment">/** *      yii1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $stateFile; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $basePath -    Yii1 *        stateFile */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($basePath)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;basePath = $basePath; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stateFile = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;basePath . DIRECTORY_SEPARATOR . <span class="hljs-string"><span class="hljs-string">'runtime'</span></span> . DIRECTORY_SEPARATOR . <span class="hljs-string"><span class="hljs-string">'state.bin'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!realpath(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stateFile)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidConfigException(<span class="hljs-string"><span class="hljs-string">'    '</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $key = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_string($data)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $len = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;computeHMAC(<span class="hljs-string"><span class="hljs-string">'test'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;strlen($data) &gt;= $len) { $hmac = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;substr($data, <span class="hljs-number"><span class="hljs-number">0</span></span>, $len); $data2 = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;substr($data, $len, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;strlen($data)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;compareString($hmac, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;computeHMAC($data2, $key)) ? $data2 : <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">computeHMAC</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $key = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($key === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) $key = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getValidationKey(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hash_hmac(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hashAlgorithm, $data, $key); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValidationKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_validationKey !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_validationKey; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($key = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loadStateValidationKey(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::STATE_VALIDATION_KEY)) !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_validationKey = $key; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_validationKey; } <span class="hljs-comment"><span class="hljs-comment">//  validationKey    Yii1 private function loadStateValidationKey($key) { $content = $this-&gt;loadState(); if ($content) { $content = unserialize($content); if (isset($content[$key])) return $content[$key]; } return false; } //      Yii1 protected function loadState() { $filename = $this-&gt;stateFile; $file = fopen($filename, "r"); if ($file &amp;&amp; flock($file, LOCK_SH)) { $contents = @file_get_contents($filename); flock($file, LOCK_UN); fclose($file); return $contents; } return false; } public function compareString($expected, $actual) { $expected .= "\0"; $actual .= "\0"; $expectedLength = $this-&gt;strlen($expected); $actualLength = $this-&gt;strlen($actual); $diff = $expectedLength - $actualLength; for ($i = 0; $i &lt; $actualLength; $i++) $diff |= (ord($actual[$i]) ^ ord($expected[$i % $expectedLength])); return $diff === 0; } private function strlen($string) { return mb_strlen($string, '8bit'); } private function substr($string, $start, $length) { return mb_substr($string, $start, $length, '8bit'); } }</span></span></code> </pre><br></div></div><br><h2> 行动顺序 </h2><br> 从身份验证的方式从yii1迁移到yii2时，我遵循以下顺序： <br><br><ol><li> 在分支之间进行透明的用户身份验证。 <br> 即 以便yii2分支接受通过yii1认证的用户。 它很快，并不困难。 <br></li><li> 将身份验证（用户登录）从yii1转移到yii2。 <br> 在旧分支中同时禁用它。 请注意，此后，cookie的自动登录将停止工作，因为  yii1中的cookie不再适合，并且yii2上仍然很少有新页面。 </li><li> 至少将网站的主页移植到yii2 <br> 这样您就可以对存储在yii2中的新cookie使用自动登录。 <br> 自动登录的存在（至少在主登录中）将有助于掩盖前一个分支上丢失的自动登录。 <br></li><li> 检查yii1是否了解yii2中已认证的身份。 <br> 通过协商会话密钥。 <br></li><li> 将用户注册转移到yii2。 <br> 传输必须在先前存储的密码哈希的协调下完成。 也许保留旧的哈希格式或引入新的哈希格式，但这样登录名就可以理解这两种类型。 </li><li> 考虑为用户添加站点服务，以使yii2“开箱即用”。 <br> 我的意思是实现用户的<u>IdentityInterface</u>接口，该接口允许通过令牌进行身份验证，恢复密码等。 也许您已经拥有合适的安全带，但是突然之间没有？ 然后，这是一个以最小的努力改进服务的好选择。 <br><br> 如果是，那么这将导致在yii2中（至少部分地）实现（迁移）个人帐户。 <br> 如果为“否”，那么您仍然应该考虑个人帐户的迁移（即使没有新产品）。 <br></li></ol><br><h4>  PS： </h4><br> 它并不总是描述特定任务中的明确解决方案，并且并非所有解决方案都需要应用。 <br><br> 描述它们并不是为了说“像我一样做”。 例如，可以使yii1的cookie自动进入yii2自动登录，但是，说得通一点也不好（并且应该以某种方式证明这种拐杖是合理的）。 <br><br> 但是我已经花了一些时间来逐步进行项目迁移，如果有人根据我的经验将他救出来，我会感到很高兴。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN419999/">https://habr.com/ru/post/zh-CN419999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN419989/index.html">新西兰禁止使用塑料袋</a></li>
<li><a href="../zh-CN419991/index.html">自主无人机将从机场驱赶成群的鸟类</a></li>
<li><a href="../zh-CN419993/index.html">TypeScript面试：20个问题和答案</a></li>
<li><a href="../zh-CN419995/index.html">对新的Angular编译器Ivy的研究</a></li>
<li><a href="../zh-CN419997/index.html">解析JavaScript中的“模块”模式</a></li>
<li><a href="../zh-CN420001/index.html">推出3CX v15.5 Update 6 BETA和WebRTC浏览器软件电话</a></li>
<li><a href="../zh-CN420003/index.html">JavaFX上带有按钮的窗口：</a></li>
<li><a href="../zh-CN420005/index.html">不专业的公寓视频监控既有趣又便宜</a></li>
<li><a href="../zh-CN420007/index.html">FidgetPen，怪异的灯和分离器立方体：认识Allocacoc</a></li>
<li><a href="../zh-CN420009/index.html">产品设计的精妙之处</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>