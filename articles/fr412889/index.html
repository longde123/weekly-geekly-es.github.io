<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêñ üë≥ ‚ñ™Ô∏è D√©veloppement d'appareils intelligents utilisant l'exemple d'un contr√¥leur de plancher chauffant sur ESP8266 üë®üèø ü§ö üèë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je souhaite partager mon exp√©rience dans le d√©veloppement d'un appareil intelligent. Dans cette publication, je d√©crirai le mat√©riel (bri√®vement) et l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©veloppement d'appareils intelligents utilisant l'exemple d'un contr√¥leur de plancher chauffant sur ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412889/">  Je souhaite partager mon exp√©rience dans le d√©veloppement d'un appareil intelligent.  Dans cette publication, je d√©crirai le mat√©riel (bri√®vement) et le logiciel (plus en d√©tail). <br><br>  Le contr√¥leur est con√ßu pour analyser les lectures des capteurs (filaires et sans fil) et maintenir la temp√©rature r√©gl√©e (y compris le calendrier, y compris les jours de la semaine) dans chaque zone individuelle en allumant / √©teignant la chaudi√®re et en contr√¥lant les boucles de chauffage du plancher d'eau √† l'aide des t√™tes thermiques du collecteur. <br><a name="habracut"></a><br><h2>  Mat√©riel informatique </h2><br>  En tant que contr√¥leur, ESP8266 (WeMos D1 mini) a √©t√© s√©lectionn√©,  a le wifi √† bord.  Au lieu d'ESP8266, tout autre contr√¥leur ou micro-ordinateur peut √™tre utilis√© - les id√©es g√©n√©rales resteront inchang√©es, l'essentiel est qu'un serveur WEB prenant en charge les sockets WEB puisse √™tre d√©ploy√© sur le syst√®me s√©lectionn√©.  Les √©l√©ments suivants ont √©galement √©t√© utilis√©s dans le projet: <br><br><ul><li>  RTC: DS3231 - il est n√©cessaire de d√©terminer le jour de la semaine et l'heure actuelle.  Le projet a √©t√© con√ßu comme un appareil autonome qui peut fonctionner sans Internet, donc NTP ne convient pas. </li><li>  Capteurs de temp√©rature sans fil: NoName, 433 MHz, de la station m√©t√©o chinoise - une solution cl√© en main, ils fonctionnent sur piles.  De quoi d'autre avez-vous besoin?  Mais il faut que la p√©riode de transfert des donn√©es ne soit pas fixe.  Le probl√®me est que la p√©riode de transmission est de 35 secondes et ne nage pas beaucoup.  Et il y a des situations o√π les signaux de deux capteurs se chevauchent.  Dans ce cas, un ou deux capteurs tombent du syst√®me pendant un certain temps.  Le probl√®me peut √™tre r√©solu en utilisant des capteurs similaires, dans lesquels la commutation de canaux modifie √©galement la p√©riode de transmission des donn√©es. </li><li>  R√©cepteur 433 MHz: Rxb6 - Les critiques sur Internet et l'exp√©rience personnelle ne sont pas un mauvais r√©cepteur. </li><li>  Capteurs de temp√©rature filaires: DS18B20 - tr√®s pratique car vous n'avez pas besoin de conna√Ætre √† l'avance le nombre de capteurs. </li><li>  Ma√Ætre de bus 1Wire: DS2482-100 - Le protocole 1Wire est tr√®s sensible aux temporisations, donc toutes les impl√©mentations du ma√Ætre de bus de programme utilisent le retard, ce qui n'est pas tr√®s bon pour le multit√¢che.  En utilisant cette puce, vous pouvez profiter du bus 1Wire et vous d√©barrasser de ses d√©fauts en diffusant 1Wire &lt;-&gt; i2c.  Le protocole i2c a une ligne de synchronisation, gr√¢ce √† laquelle il n'est pas critique pour les temporisations et est souvent impl√©ment√© dans le mat√©riel des contr√¥leurs. </li><li>  Horloge de surveillance: TPL5000DGST - la disponibilit√© continue n'est pas si importante pour ce projet, mais l'accessibilit√© est tr√®s importante.  L'ESP8266 a une minuterie de surveillance int√©gr√©e.  Mais comme la pratique l'a montr√©, il existe parfois des situations o√π il ne peut pas faire face et le syst√®me se bloque.  Une minuterie de surveillance mat√©rielle externe est con√ßue pour faire face aux situations d'urgence.  Configur√© pour un d√©lai de 64 secondes.  Attach√© √† la jambe TX - pendant le fonctionnement, le syst√®me √©crit constamment des informations de d√©bogage sur Serial et le manque d'activit√© pendant plus d'une minute indique un blocage du syst√®me. </li><li>  Extenseur de port: 74HC595 - l'utilisation de cet extenseur n√©cessite 4 branches du contr√¥leur - trois pour transmettre l'√©tat et une pour que les relais ne cliquent pas lorsque l'alimentation est appliqu√©e.  La prochaine fois, j'utiliserai PCF8574 - le bus i2c est toujours utilis√©, c'est-√†-dire  aucune branche MCU suppl√©mentaire n'est requise et les sorties 1 sont d√©finies lorsque l'alimentation est appliqu√©e. </li><li>  Module relais: NoName, 8 canaux, 5V - il n'y a rien √† dire, sauf que le relais est activ√© √† un niveau bas aux entr√©es du module.  Les relais statiques ne sont pas autoris√©s dans ce projet, car  Les contacts de la chaudi√®re doivent √™tre commut√©s par un contact sec - en g√©n√©ral, je ne connais pas la tension et le courant continu ou alternatif sur les contacts. </li></ul><br><h2>  Syst√®me d'exploitation </h2><br>  Le syst√®me d'exploitation est l'ensemble des logiciels qui assurent l'op√©rabilit√© du programme d'application.  Le syst√®me d'exploitation est √©galement une couche entre le mat√©riel et le programme d'application, fournissant une interface de haut niveau pour acc√©der aux ressources mat√©rielles.  Dans le cas d'ESP, les composants du syst√®me d'exploitation peuvent √™tre consid√©r√©s: <br><br><h3>  Syst√®me de fichiers </h3><br>  Le projet utilise SPIFFS, tout semble clair ici, c'est la mani√®re la plus simple.  Pour acc√©der facilement aux fichiers sur l'appareil depuis l'ext√©rieur, j'utilise la biblioth√®que nailbuster / esp8266FTPServer. <br><br><h3>  Syst√®me d'allocation de temps CPU </h3><br>  C'est l'une des principales fonctions du syst√®me d'exploitation et ESP ne fera pas exception.  Pour l'ex√©cution parall√®le de diff√©rents flux de l'algorithme, l'objet global (singleton) Timers est responsable.  La classe est assez simple et offre les fonctionnalit√©s suivantes: <br><br><ul><li>  Ex√©cution p√©riodique de la fonction, avec un intervalle sp√©cifi√©.  Exemple d'initialisation du minuteur: <br><br><pre><code class="cpp hljs">Timers.add(doLoop, <span class="hljs-number"><span class="hljs-number">6000</span></span>, F(<span class="hljs-string"><span class="hljs-string">"OneWireSensorsClass::doLoop"</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//   ‚Äì  </span></span></code> </pre> </li><li>  Une seule ex√©cution d'une fonction apr√®s une p√©riode de temps sp√©cifi√©e.  Par exemple, une analyse retard√©e des r√©seaux WiFi est effectu√©e de cette fa√ßon: <br><br><pre> <code class="cpp hljs">Timers.once([]() { WiFi.scanNetworks(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);}, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> </li></ul><br>  Ainsi, la fonction de boucle ressemble √† ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ESP.wdtFeed(); Timers.doLoop(); CPULoadInfo.doLoop(); }</code> </pre><br>  En pratique, la fonction de boucle contient quelques lignes suppl√©mentaires, qui seront d√©crites ci-dessous. <br>  Une liste de la classe Timers est jointe. <br><br><h3>  Comptabilit√© du temps CPU </h3><br>  Fonction de service sans application pratique.  N√©anmoins, elle l'est.  Impl√©ment√© par le singleton CPULoadInfo.  Lorsque l'objet est initialis√©, le nombre d'it√©rations de la boucle vide est mesur√© pendant une courte p√©riode: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPULoadInfoClass::init() { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currTime = millis(); <span class="hljs-comment"><span class="hljs-comment">//      1 while ((millis() - currTime) &lt; 10) { delay(0); MaxLoopsInSecond++; } MaxLoopsInSecond *= 100; }</span></span></code> </pre> <br>  Ensuite, nous comptons le nombre d'appels de proc√©dure de boucle par seconde, nous calculons la charge du processeur en pourcentage et enregistrons les donn√©es dans le tampon: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPULoadInfoClass::doLoop() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> prevTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currTime = millis(); LoopsInSecond++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((currTime - prevTime) &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) { memmove(CPULoadPercentHistory, &amp;CPULoadPercentHistory[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CPULoadPercentHistory) - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> load = ((MaxLoopsInSecond - LoopsInSecond) * <span class="hljs-number"><span class="hljs-number">100</span></span>) / MaxLoopsInSecond; CPULoadPercentHistory[<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CPULoadPercentHistory) - <span class="hljs-number"><span class="hljs-number">1</span></span>] = load; prevTime = currTime; LoopsInSecond = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  L'utilisation de cette approche vous permet d'obtenir la m√™me utilisation du processeur par chaque thread individuel (si vous connectez ce sous-syst√®me √† la classe Timers), mais comme je l'ai dit - je ne vois aucune application pratique pour cela. <br><br><h3>  Syst√®me d'entr√©e-sortie </h3><br>  Pour communiquer avec l'utilisateur, les interfaces UART-USB et WEB sont utilis√©es.  Je pense √† UART, je n'ai pas besoin de parler en d√©tail.  La seule chose √† laquelle il faut faire attention est la commodit√© et la compatibilit√© avec les non-ESP, la fonction serialEvent () est impl√©ment√©e: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶ if (Serial.available()) serialEvent(); // ‚Ä¶ }</span></span></code> </pre><br>  Avec l'interface WEB, tout est beaucoup plus int√©ressant.  Nous y consacrons une section distincte. <br><br><h3>  Interface WEB </h3><br>  Dans le cas des appareils intelligents, √† mon avis, l'interface WEB est la solution la plus conviviale. <br><br>  Je consid√®re que l'utilisation d'un √©cran connect√© √† l'appareil est une pratique obsol√®te - il est impossible de cr√©er une interface simple, pratique et belle lorsque vous utilisez un petit √©cran et un ensemble limit√© de boutons. <br><br>  L'utilisation de programmes sp√©cifiques pour contr√¥ler l'appareil impose des restrictions √† l'utilisateur, ajoute la n√©cessit√© de d√©velopper et de prendre en charge ces programmes, et oblige √©galement le d√©veloppeur √† prendre soin de la livraison de ces programmes aux terminaux de l'utilisateur.  Dans le bon sens, l'application devrait √™tre publi√©e dans les magasins d'applications Google, Apple et Windows, et √©galement disponible dans les r√©f√©rentiels Linux sous la forme de packages deb et rpm - sinon, l'acc√®s √† l'interface de l'appareil peut √™tre difficile pour une partie de l'audience. <br><br>  L'acc√®s √† l'interface WEB de l'appareil est disponible depuis n'importe quel syst√®me d'exploitation - Linux, Windows, Android, MacOS, sur le bureau, ordinateur portable, tablette, smartphone - juste pour avoir un navigateur.  Bien s√ªr, le d√©veloppeur de l'interface WEB doit prendre en compte les caract√©ristiques des diff√©rents appareils, mais cela concerne principalement la taille et la r√©solution.  L'acc√®s √† l'interface WEB d'un appareil intelligent dans une maison / un appartement / un chalet est facilement accessible de l'ext√©rieur via Internet - maintenant, il est difficile d'imaginer une maison / un appartement dans lequel il y a des appareils intelligents et aucun routeur et Internet, et dans le routeur, cet acc√®s est configur√© en quelques clics (pour ceux qui compl√®tement hors sujet, les mots-cl√©s aideront - "redirection de port" et "DNS dynamique").  Dans le cas d'une r√©sidence d'√©t√©, l'acc√®s peut √™tre fourni via un routeur 3G. <br><br>  Pour impl√©menter l'interface WEB, un serveur WEB est requis.  J'utilise la biblioth√®que me-no-dev / ESPAsyncWebServer.  Cette biblioth√®que offre les fonctionnalit√©s suivantes: <br><br><ul><li>  Retour de contenu statique, y compris  avec support de compression gzip.  Les r√©pertoires virtuels sont pris en charge, avec la possibilit√© de sp√©cifier un fichier principal (qui est g√©n√©ralement index.htm) pour chaque r√©pertoire. </li><li>  Affectation de fonctions de rappel √† diff√©rentes URL en fonction du type de demande (GET, POST, ...) </li><li>  Prise en charge des sockets WEB sur le m√™me port (cela est important lors de la redirection de port). </li><li>  Autorisation de base.  De plus, l'autorisation est d√©finie individuellement pour chaque URL.  Ceci est important car  par exemple, Google Chrome, lors de la cr√©ation d'un raccourci de page sur l'√©cran principal, demande une ic√¥ne et un fichier manifeste et ne transf√®re pas les donn√©es d'autorisation.  Par cons√©quent, certains fichiers sont plac√©s dans un r√©pertoire virtuel et l'autorisation est d√©sactiv√©e pour ce r√©pertoire. </li></ul><br><h3>  Syst√®me d'exploitation des services HTTP </h3><br>  Dans le projet en cours, tous les param√®tres du syst√®me d'exploitation sont effectu√©s √† l'aide des services HTTP.  Le service HTTP est une petite fonctionnalit√© ind√©pendante de r√©cup√©ration / modification de donn√©es disponible via HTTP.  Ensuite, consid√©rez une liste de ces services. <br><br><h4>  Aide </h4><br>  L'impl√©mentation de toute liste de commandes, je pense qu'il est juste de commencer par l'impl√©mentation de l'√©quipe HELP.  Voici le bloc d'initialisation du serveur WEB: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HTTPserverClass::init() { <span class="hljs-comment"><span class="hljs-comment">//SERVER INIT help_info.concat(F("/'doc_hame.ext': load file from server. Allow methods: HTTP_GET\n")); AsyncStaticWebHandler&amp; handler = server.serveStatic("na/", SPIFFS, "na/"); serveStaticHandlerNA = &amp;handler; //       server.serveStatic("/", SPIFFS, "/"); //    //info //       help_info.concat(F("/info: get system info. Allow methods: HTTP_GET\n")); server.on("/info", HTTP_GET, handleInfo); ‚Ä¶ server.on("/help", HTTP_GET, [](AsyncWebServerRequest *request) { request-&gt;send(200, ContentTypesStrings[ContentTypes::text_plain], help_info.c_str()); }); //    setAuthentication(ConfigStore.getAdminName(), ConfigStore.getAdminPassword()); DefaultHeaders::Instance().addHeader("Access-Control-Allow-Origin", "*"); //  -  //   server.begin(); //       DEBUG_PRINT(F("HTTP server started")); }</span></span></code> </pre><br>  Pourquoi ai-je besoin d'un syst√®me d'aide, je pense que √ßa ne vaut pas la peine de le dire.  Certains d√©veloppeurs reportent la mise en ≈ìuvre du syst√®me d'aide pour plus tard, mais ce ¬´plus tard¬ª ne se produit g√©n√©ralement pas.  Il est beaucoup plus facile de le mettre en ≈ìuvre au d√©but du projet et de le compl√©ter pendant le d√©veloppement du projet. <br>  Dans mon projet, une liste de services possibles s'affiche √©galement avec une erreur 404 - la page est introuvable.  Actuellement mis en ≈ìuvre les services suivants: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://tc-demo.vehs.ru/help</a> <br><br><pre> <code class="hljs sql">/'doc_hame.ext': <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> server. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /info: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> info. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> (eg: <span class="hljs-number"><span class="hljs-number">20140527</span></span>T123456). <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /uptime: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> uptime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> (eg: <span class="hljs-number"><span class="hljs-number">123</span></span>D123456). <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /rtc: <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> RTC time. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> ? [dir=...] &amp; [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /edit: edit files. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_PUT, HTTP_DELETE, HTTP_POST /wifi: edit wifi settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /wifi-<span class="hljs-keyword"><span class="hljs-keyword">scan</span></span> ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wifi <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /wifi-info ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wifi info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /ap: edit soft ap settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: edit <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-info ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> flash. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /restart: restart system. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /ws: web socket url. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-keyword"><span class="hljs-keyword">help</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> URLs. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET</code> </pre><br>  Comme vous pouvez le voir, dans la liste des services, il n'y a pas de services d'application.  Tous les services HTTP sont li√©s au syst√®me d'exploitation.  Chaque service effectue une petite t√¢che.  De plus, si le service n√©cessite la saisie de donn√©es, alors, sur demande, GET renvoie un formulaire de saisie minimaliste: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> USE_RTC_CLOCK help_info.concat(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc: set RTC time. Allow methods: HTTP_GET, HTTP_POST\n"</span></span></span><span class="hljs-meta">)); const char* urlNTP = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc"</span></span></span><span class="hljs-meta">; server.on(urlNTP, HTTP_GET, [](AsyncWebServerRequest *request) { DEBUG_PRINT(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc"</span></span></span><span class="hljs-meta">)); request-&gt;send(200, ContentTypesStrings[ContentTypes::text_html], String(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&lt;head&gt;&lt;title&gt;RTC time&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form method=\"post\" action=\"rtc\"&gt;&lt;input name=\"newtime\" length=\"15\" placeholder=\"yyyyMMddThhmmss\"&gt;&lt;button type=\"submit\"&gt;set&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;"</span></span></span><span class="hljs-meta">))); }); server.on(urlNTP, HTTP_POST, handleSetRTC_time); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// USE_RTC_CLOCK</span></span></span></span></code> </pre><br><img src="https://habrastorage.org/webt/cr/-6/na/cr-6napgtebfgiquecvuezhxqia.png"><br><br>  Plus tard, ce service est utilis√© dans une interface plus jolie: <br><br><img src="https://habrastorage.org/webt/tt/mn/-o/ttmn-oyhy9v3lygwrk0jk2wzp2o.png"><br><br><h2>  Logiciels d'application </h2><br>  Enfin, nous sommes arriv√©s au point pour lequel le syst√®me a √©t√© cr√©√©.  √Ä savoir - √† la mise en ≈ìuvre de la t√¢che appliqu√©e. <br><br>  Toute application doit recevoir les donn√©es source, les traiter et produire le r√©sultat.  Il est √©galement possible que le syst√®me signale l'√©tat actuel. <br><br>  Les donn√©es sources du r√©gulateur de chauffage par le sol sont: <br><br><ul><li>  Donn√©es de capteur - le syst√®me n'est pas li√© √† des capteurs sp√©cifiques.  Un identifiant unique est g√©n√©r√© pour chaque capteur.  Pour les capteurs radio, leur identifiant est compl√©t√© par des z√©ros √† 16 bits; pour les capteurs 1Wire, le CRC16 est calcul√© en fonction de leur identifiant interne et utilis√© comme identifiant du capteur.  Ainsi, tous les capteurs ont des identifiants d'une longueur de 2 octets. </li><li>  Donn√©es sur les zones de chauffage - le nombre de zones n'est pas fixe, le nombre maximum est limit√© par le module relais utilis√©.  Compte tenu de cette limitation, l'interface WEB a √©galement √©t√© d√©velopp√©e. </li><li>  Temp√©rature et programme cibles - J'ai essay√© de faire les r√©glages les plus flexibles, vous pouvez cr√©er plusieurs sch√©mas de chauffage et vous pouvez m√™me attribuer votre propre sch√©ma de r√©glages √† chaque zone. </li></ul><br>  Ainsi, il existe un certain nombre de param√®tres qui doivent √™tre d√©finis d'une mani√®re ou d'une autre, et il existe un certain nombre de param√®tres que le syst√®me signale comme l'√©tat actuel. <br>  Pour la communication entre le contr√¥leur et le monde ext√©rieur, j'ai impl√©ment√© un interpr√©teur de commandes qui m'a permis de mettre en ≈ìuvre √† la fois le contr√¥le du contr√¥leur et la r√©ception des donn√©es d'√©tat.  Les commandes sont transmises au contr√¥leur sous une forme lisible par l'homme et peuvent √™tre transmises via une prise UART ou WEB (si vous le souhaitez, vous pouvez impl√©menter la prise en charge d'autres protocoles, par exemple telnet). <br>  La ligne de commande commence par le caract√®re ¬´#¬ª et se termine par un caract√®re nul ou un caract√®re de nouvelle ligne.  Toutes les commandes se composent d'un nom de commande et d'un op√©rande, s√©par√©s par deux points.  Pour certaines commandes, l'op√©rande est facultatif; dans ce cas, les deux-points et l'op√©rande ne sont pas sp√©cifi√©s.  Les commandes d'une ligne sont s√©par√©es par une virgule.  Par exemple: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#ZonesInfo</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">SensorsInfo</span></span></code> </pre> <br>  Et bien s√ªr, la liste des commandes commence par la commande Aide, qui affiche une liste de toutes les commandes valides (pour plus de commodit√©, les commandes transmises commencent par un '&gt;' au lieu de '#'): <br><br><pre> <code class="hljs dos">&gt;<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Help</span></span> SetZonesCount Zone SetName SetSensor ... LoadCfg SaveCfg #<span class="hljs-built_in"><span class="hljs-built_in">Cmd</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">Help</span></span>,CmdRes:Ok</code> </pre> <br>  Une caract√©ristique de l'impl√©mentation de l'interpr√©teur de commandes est que les informations sur le r√©sultat de l'ex√©cution de la commande sont √©galement √©mises sous la forme d'une commande ou d'un ensemble de commandes: <br><br><pre> <code class="hljs css">&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">help</span></span> ‚Ä¶ <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Help</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span> &gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:123</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Zone</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Value</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:123</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Error</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Error</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Zone</span></span> 123 <span class="hljs-selector-tag"><span class="hljs-selector-tag">not</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">range</span></span> 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">-5</span></span> &gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">SchemasInfo</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#SchemasCount</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DOWs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0b0000000</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DOWs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0b0000000</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:SchemasInfo</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre><br>  C√¥t√© client WEB, un shell est √©galement impl√©ment√© qui accepte ces commandes et les convertit en une vue graphique.  Par exemple: <br><br><pre> <code class="hljs css">&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zonesInfo</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Sensor</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0x5680</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DeltaT</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:-20</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ZonesInfo</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre> <br>  L'interface WEB a envoy√© une requ√™te au contr√¥leur concernant la zone num√©ro 3, et en r√©ponse a re√ßu le nom de la zone, l'identifiant du capteur associ√© √† la zone, l'identifiant du circuit affect√© √† la zone et la correction de temp√©rature de la zone.  La coquille ne comprend pas les nombres fractionnaires, donc la temp√©rature est transmise en dixi√®mes de degr√©, c'est-√†-dire  12,3 degr√©s est de 123 dixi√®mes. <br><br>  La caract√©ristique cl√© est que le contr√¥leur r√©pond √† tous les clients √† la fois pour n'importe quelle commande, quelle que soit la m√©thode d'entr√©e de la commande.  Cela vous permet d'afficher imm√©diatement le changement d'√©tat dans toutes les sessions de l'interface WEB.  Parce que  Le transport d'√©change principal entre le contr√¥leur et l'interface WEB est les sockets WEB, puis le contr√¥leur peut transmettre des donn√©es sans demande, par exemple, lorsque de nouvelles donn√©es proviennent de capteurs: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#sensor</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0x5A20</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:w433th</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">battery</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">button_tx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">channel</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">temperature</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:228</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">humidity</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:34</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">uptime_label</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:130308243</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">time_label</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20180521T235126</span></span></code> </pre> <br>  Ou, par exemple, que ces zones doivent √™tre mises √† jour: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#Zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">TargetTemp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:220</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CurrentTemp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:228</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Error</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre><br>  L'interface WEB du contr√¥leur est bas√©e sur l'utilisation de commandes texte.  Sur l'un des onglets de l'interface, il y a un terminal avec lequel vous pouvez saisir des commandes sous forme de texte.  En outre, cet onglet, √† des fins de d√©bogage, vous permet de savoir quelles commandes l'interface WEB envoie et re√ßoit avec diverses actions utilisateur. <br><br>  L'interpr√©teur de commandes facilite la modification et l'augmentation des fonctionnalit√©s de l'appareil en modifiant les commandes existantes et en en ajoutant de nouvelles.  Dans le m√™me temps, le d√©bogage d'un tel syst√®me est grandement simplifi√©, car  la communication avec le contr√¥leur s'effectue exclusivement dans un langage lisible par l'homme. <br><br><h2>  Conclusion </h2><br>  En utilisant une approche similaire, √† savoir: <br><br><ul><li>  S√©paration du logiciel en syst√®me d'exploitation et programme d'application </li><li>  Impl√©mentation des param√®tres du syst√®me d'exploitation sous la forme de services HTTP minimalistes </li><li>  S√©paration de la logique syst√®me de la pr√©sentation des donn√©es </li><li>  Utilisation de protocoles de communication lisibles par l'homme </li></ul><br>  vous permet de cr√©er des solutions compr√©hensibles par les utilisateurs et les d√©veloppeurs.  Ces solutions sont faciles √† modifier.  Sur la base de telles solutions, il est facile de construire de nouveaux appareils avec une logique compl√®tement diff√©rente, mais qui fonctionneront sur les m√™mes principes.  Vous pouvez cr√©er une ligne d'appareils avec le m√™me type d'interface: <br><br><img src="https://habrastorage.org/webt/5b/mg/mh/5bmgmh1jpuzsrdjpreb6jw_yopy.png"><br><br>  Comme vous pouvez le voir, dans ce projet, seules les trois premi√®res pages de l'interface sont directement li√©es √† l'application et les autres sont presque universelles. <br><br>  Dans cette publication, je ne d√©cris que mon opinion sur la construction d'appareils intelligents, et en aucun cas je ne pr√©tends √™tre la v√©rit√© ultime. <br><br>  Pour qui ce sujet est int√©ressant - √©crivez, peut-√™tre que je me trompe sur quelque chose, mais peut-√™tre que certains d√©tails ont du sens √† d√©crire plus en d√©tail. <br><br>  Qu'est-il arriv√© √† la fin: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fiasco.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'histoire d'un IoT fait maison</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412889/">https://habr.com/ru/post/fr412889/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412877/index.html">Ruth√©nium (Ru) - le quatri√®me √©l√©ment aux propri√©t√©s ferromagn√©tiques √† temp√©rature ambiante</a></li>
<li><a href="../fr412879/index.html">Num√©ro 24: Formation informatique - probl√®mes et d√©fis actuels des grandes entreprises</a></li>
<li><a href="../fr412881/index.html">Bj√∂rn Straustrup: Probl√®me de programmation</a></li>
<li><a href="../fr412885/index.html">Science pathologique</a></li>
<li><a href="../fr412887/index.html">R√©sum√© des √©v√©nements informatiques de juin</a></li>
<li><a href="../fr412891/index.html">Citrix XenServer 7.0 I / O non optimis√© Agent de gestion non install√©</a></li>
<li><a href="../fr412893/index.html">Pour atteindre un programmeur senior en quatre ans: la m√©thode "School 21"</a></li>
<li><a href="../fr412895/index.html">Vesta Matveeva: la lutte contre la cybercriminalit√© est un choix moral</a></li>
<li><a href="../fr412897/index.html">Surveillance des produits Atlassian avec Prometheus</a></li>
<li><a href="../fr412899/index.html">Week-end lecture: 30 documents sur le son, l'histoire des marques audio et l'industrie cin√©matographique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>