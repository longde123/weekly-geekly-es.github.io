<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§úüèΩ üìß üë§ Wie wir auf Patroni einen zuverl√§ssigen PostgreSQL-Cluster aufgebaut haben üë©üèº‚Äçüöí üë≤üèΩ üë©‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Heutzutage ist immer und √ºberall eine hohe Verf√ºgbarkeit von Diensten erforderlich, nicht nur bei gro√üen, teuren Projekten. Vor√ºbergehend nicht verf√ºg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie wir auf Patroni einen zuverl√§ssigen PostgreSQL-Cluster aufgebaut haben</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/452846/"><img src="https://habrastorage.org/getpro/habr/post_images/17a/6e9/29d/17a6e929d3e8e24203871d573b17ef0d.jpg"><br><br>  Heutzutage ist immer und √ºberall eine hohe Verf√ºgbarkeit von Diensten erforderlich, nicht nur bei gro√üen, teuren Projekten.  Vor√ºbergehend nicht verf√ºgbare Websites mit der Meldung "Entschuldigung, Wartung wird durchgef√ºhrt" treten weiterhin auf, verursachen jedoch normalerweise ein herablassendes L√§cheln.  F√ºgen Sie dazu das Leben in den Clouds hinzu. Wenn Sie einen zus√§tzlichen Server starten m√∂chten, ben√∂tigen Sie nur einen Aufruf der API, und Sie m√ºssen nicht √ºber den "Eisen" -Betrieb nachdenken.  Und es gibt keine Entschuldigung mehr, warum das kritische System nicht zuverl√§ssig mithilfe von Clustertechnologien und Redundanz erstellt wurde. <br><br>  Wir werden Ihnen sagen, welche L√∂sungen wir in Betracht gezogen haben, um die Zuverl√§ssigkeit der Datenbanken in unseren Diensten sicherzustellen, und worauf wir gekommen sind.  Plus eine Demo mit weitreichenden Schlussfolgerungen. <br><a name="habracut"></a><br><h2>  Verm√§chtnis in der Hochverf√ºgbarkeitsarchitektur </h2><br>  Dies zeigt sich noch besser im Zusammenhang mit der Entwicklung verschiedener OpenSource-Systeme.  Alte L√∂sungen mussten bei steigender Nachfrage Hochverf√ºgbarkeitstechnologien hinzuf√ºgen.  Und ihre Qualit√§t war anders.  L√∂sungen der n√§chsten Generation stellen die hohe Verf√ºgbarkeit in den Mittelpunkt ihrer Architektur.  Beispielsweise positioniert MongoDB den Cluster als Hauptanwendungsfall.  Der Cluster wird horizontal skaliert, was ein starker Wettbewerbsvorteil dieses DBMS ist. <br><br>  Zur√ºck zu PostgreSQL.  Dies ist eines der √§ltesten beliebten OpenSource-Projekte, dessen erste Ver√∂ffentlichung im 95. Jahr des letzten Jahrhunderts erfolgte.  Das Projektteam betrachtete Hochverf√ºgbarkeit lange Zeit nicht als eine Aufgabe, die vom System angegangen werden muss.  Daher wurde die Replikationstechnologie zum Erstellen von Datenkopien erst 2006 in Version 8.2 integriert, aber abgelegt (Protokollversand).  Im Jahr 2010 wurde die Streaming-Replikation in Version 9.0 ver√∂ffentlicht und ist die Grundlage f√ºr die Erstellung einer Vielzahl von Clustern.  Dies ist in der Tat sehr √ºberraschend f√ºr Leute, die PostgreSQL nach Enterprise SQL oder modernem NoSQL kennenlernen - die Standardl√∂sung aus der Community besteht nur aus ein paar Master-Replikaten mit synchroner oder asynchroner Replikation.  Gleichzeitig wird der Assistent manuell im Drain umgeschaltet, und es wird auch vorgeschlagen, das Problem des Clientwechsels unabh√§ngig zu l√∂sen. <br><br><h2>  Wie wir uns entschieden haben, zuverl√§ssiges PostgreSQL zu machen und was wir daf√ºr gew√§hlt haben </h2><br>  PostgreSQL w√§re jedoch nicht so beliebt geworden, wenn es nicht eine gro√üe Anzahl von Projekten und Tools gegeben h√§tte, mit denen eine fehlertolerante L√∂sung erstellt werden kann, die keine st√§ndige Aufmerksamkeit erfordert.  Seit dem Start von DBaaS sind in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mail.ru Cloud Solutions</a> (MCS) einzelne PostgreSQL-Server und Master-Replikatpaare mit asynchroner Replikation verf√ºgbar. <br><br>  Nat√ºrlich wollten wir das Leben aller vereinfachen und die PostgreSQL-Installation verf√ºgbar machen, die als Grundlage f√ºr leicht zug√§ngliche Dienste dienen kann, die Sie nachts nicht st√§ndig √ºberwachen und aufwachen m√ºssen, um den Wechsel vorzunehmen.  In diesem Segment gibt es sowohl alte bew√§hrte L√∂sungen als auch eine Generation neuer Dienstprogramme, die die neuesten Entwicklungen nutzen. <br><br>  Das Problem der Hochverf√ºgbarkeit beruht heute nicht mehr auf Redundanz (selbstverst√§ndlich), sondern auf Konsens - einem Algorithmus zur Auswahl eines F√ºhrers (Wahl des F√ºhrers).  Meistens ereignen sich schwere Unf√§lle nicht aufgrund fehlender Server, sondern aufgrund von Konsensproblemen: Ein neuer Leiter stieg nicht aus, zwei Leiter erschienen in verschiedenen Rechenzentren usw.  Ein Beispiel ist ein Absturz im Github MySQL-Cluster - sie haben ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">detailliertes Post-Mortem geschrieben</a> . <br><br>  Die mathematische Grundlage in dieser Angelegenheit ist sehr ernst.  Einerseits gibt es einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CAP-Satz</a> , der die M√∂glichkeit der Konstruktion von HA-L√∂sungen theoretisch einschr√§nkt, andererseits mathematisch erprobte Algorithmen zur Konsensbestimmung wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Paxos</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Raft</a> .  Auf dieser Basis gibt es sehr beliebte DCS (dezentrale Konsenssysteme) - Zookeeper, etcd, Consul.  Wenn das Entscheidungssystem mit einem eigenen Algorithmus arbeitet, der unabh√§ngig geschrieben wurde, sollten Sie daher √§u√üerst vorsichtig sein.  Nachdem wir eine Vielzahl von Systemen analysiert hatten, entschieden wir uns f√ºr Patroni - ein Open-Source-System, das haupts√§chlich von Zalando entwickelt wurde. <br><br>  Als lyrischen Exkurs m√∂chte ich sagen, dass wir auch Multi-Master-L√∂sungen in Betracht gezogen haben, dh Cluster, die horizontal auf die Aufnahme skaliert werden k√∂nnen.  Aus zwei Hauptgr√ºnden entschieden sie sich jedoch, keinen solchen Cluster zu erstellen.  Erstens weisen solche L√∂sungen eine hohe Komplexit√§t und dementsprechend mehr Schwachstellen auf.  Es wird schwierig sein, in allen F√§llen eine stabile Entscheidung zu treffen.  Zweitens ist PostgreSQL in diesem Fall nicht mehr rein (nativ), einige Funktionen sind nicht verf√ºgbar, und bei einigen Anwendungen k√∂nnen beim Arbeiten versteckte Fehler auftreten. <br><br><h2>  Patroni </h2><br>  Wie funktioniert Patroni?  Die Entwickler haben das Rad nicht neu erfunden und vorgeschlagen, eine der bew√§hrten DCS-L√∂sungen als Grundlage zu verwenden.  Alle Probleme mit der Synchronisierung von Konfigurationen, der Wahl eines Leiters und dem Quorum werden ihm gegeben.  Wir haben etcd daf√ºr gew√§hlt. <br><br>  Dar√ºber hinaus befasst sich Patroni mit der korrekten Anwendung aller Einstellungen in PostgreSQL und den Replikationseinstellungen sowie mit der Ausf√ºhrung von Befehlen bei Umschaltung und Failover (dh regul√§ren und nicht standardm√§√üigen Vermittlungsassistenten).  Insbesondere k√∂nnen Sie in der MCS-Cloud einen Cluster aus einem Assistenten, einem synchronen Replikat und einem oder mehreren asynchronen Replikaten erstellen.  Das Vorhandensein eines synchronen Replikats gew√§hrleistet die Sicherheit von Daten auf mindestens 2 Servern, und dieses Replikat ist der Hauptkandidat f√ºr den Master. <br><br>  Da etcd auf denselben Servern bereitgestellt wird, wird empfohlen, dass die Anzahl der Server 3 oder 5 betr√§gt, um den optimalen Quorumwert zu erzielen.  Ein solcher Cluster wird zum Lesen horizontal skaliert (ich habe oben √ºber das Skalieren zum Schreiben geschrieben).  Es sollte jedoch ber√ºcksichtigt werden, dass asynchrone Replikate insbesondere bei hohen Lasten hinterherhinken. <br><br>  Die Verwendung solcher Read-Standby-Replikate ist f√ºr Berichts- oder Analyseaufgaben gerechtfertigt und entlastet den Master-Server. <br><br>  Wenn Sie einen solchen Cluster selbst erstellen m√∂chten, ben√∂tigen Sie: <br><br><ul><li>  Bereiten Sie 3 oder mehr Server vor, konfigurieren Sie die IP-Adressierung und die Firewall-Regeln zwischen ihnen. <br></li><li>  Installieren Sie Pakete f√ºr Dienste etcd, Patroni, PostgreSQL; <br></li><li>  etcd cluster konfigurieren; <br></li><li>  Konfigurieren Sie den Patroni-Dienst f√ºr die Arbeit mit PostgreSQL. <br></li></ul><br>  Das hei√üt, insgesamt m√ºssen Sie ein Dutzend Konfigurationsdateien korrekt zusammenstellen und d√ºrfen nirgendwo einen Fehler machen.  Zu diesem Zweck lohnt es sich auf jeden Fall, ein Konfigurationsmanagement-Tool wie beispielsweise Ansible zu verwenden.  Es gibt jedoch noch keinen hochverf√ºgbaren TCP-Balancer.  Es ist eine separate Arbeit. <br><br>  F√ºr diejenigen, die einen vorgefertigten Cluster ben√∂tigen, aber nicht mit all dem herumst√∂bern m√∂chten, haben wir versucht, unser Leben zu vereinfachen und einen vorgefertigten Cluster auf Patroni in unserer Cloud erstellt. Er kann kostenlos getestet werden.  Zus√§tzlich zum Cluster selbst haben wir Folgendes getan: <br><br><ul><li>  TCP-Balancer  An verschiedenen Ports zeigt es immer auf das aktuelle Master-, synchrone bzw. asynchrone Replikat. <br></li><li>  API zum Wechseln des aktiven Patroni-Assistenten. <br></li></ul><br>  Sie k√∂nnen sowohl √ºber die MCS-Cloud-API als auch √ºber die Webkonsole verbunden werden. <br><br><h2>  Demo </h2><br>  Um die Funktionen des PostgreSQL-Clusters in der MCS-Cloud zu testen, sehen wir uns an, wie sich eine Live-Anwendung bei Problemen mit dem DBMS verh√§lt. <br><br>  Das Folgende ist der Code f√ºr eine Anwendung, die k√ºnstliche Ereignisse protokolliert und dies dem Bildschirm meldet.  Im Fehlerfall meldet es dies und setzt seine Arbeit in einem Zyklus fort, bis wir es mit der Kombination Strg + C stoppen. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __future__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_function <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> random <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> randint <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sleep <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: connection = psycopg2.connect(user = <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, password = <span class="hljs-string"><span class="hljs-string">"P@ssw0rd"</span></span>, host = <span class="hljs-string"><span class="hljs-string">"89.208.87.38"</span></span>, port = <span class="hljs-string"><span class="hljs-string">"5432"</span></span>, database = <span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>) cursor = connection.cursor() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT version();"</span></span>) record = cursor.fetchone() print(<span class="hljs-string"><span class="hljs-string">"Connection opened to"</span></span>, record[<span class="hljs-number"><span class="hljs-number">0</span></span>]) cursor.execute( <span class="hljs-string"><span class="hljs-string">"INSERT INTO log VALUES ({});"</span></span>.format(randint(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>))) connection.commit() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT COUNT(event_id) from log;"</span></span>) record = cursor.fetchone() print(<span class="hljs-string"><span class="hljs-string">"Logged a value, overall count: {}"</span></span>.format(record[<span class="hljs-number"><span class="hljs-number">0</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> error: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"Error while connecting to PostgreSQL"</span></span>, error) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> connection: cursor.close() connection.close() print(<span class="hljs-string"><span class="hljs-string">"Connection closed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(datetime.now()) main() sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(<span class="hljs-string"><span class="hljs-string">"Caught error:\n"</span></span>, e) sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: print(<span class="hljs-string"><span class="hljs-string">"exit"</span></span>)</code> </pre> <br>  Eine Anwendung ben√∂tigt PostgreSQL, um zu funktionieren.  Erstellen Sie mithilfe der API einen Cluster in der MCS-Cloud.  In einem regul√§ren Terminal, in dem die Variable OS_TOKEN ein Token f√ºr den Zugriff auf die API enth√§lt (Sie k√∂nnen es mit dem Befehl openstack token issue abrufen), geben wir die folgenden Befehle ein: <br><br>  Erstellen Sie einen Cluster: <br><br><pre> <code class="bash hljs">cat &lt;&lt;EF &gt; pgc10.json {<span class="hljs-string"><span class="hljs-string">"cluster"</span></span>:{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"postgres10"</span></span>,<span class="hljs-string"><span class="hljs-string">"allow_remote_access"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-string"><span class="hljs-string">"datastore"</span></span>:{<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"postgresql"</span></span>,<span class="hljs-string"><span class="hljs-string">"version"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>},<span class="hljs-string"><span class="hljs-string">"databases"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>}],<span class="hljs-string"><span class="hljs-string">"users"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"databases"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>}],<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>,<span class="hljs-string"><span class="hljs-string">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"P@ssw0rd"</span></span>}],<span class="hljs-string"><span class="hljs-string">"instances"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}},{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}},{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}}]}} EOF curl -s -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OS_TOKEN</span></span></span><span class="hljs-string">"</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Accept: application/json'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> \ -d @pgc10.json https://infra.mail.ru:8779/v1.0/ce2a41bbd1434013b85bdf0ba07c770f/clusters</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/f2c/aee/463/f2caee46351a0f304dac92483739a3c5.png"><br><br>  Wenn der Cluster in den Status AKTIV wechselt, erhalten alle Felder die aktuellen Werte - der Cluster ist bereit. <br><br>  In der GUI: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b2/0de/606/8b20de6065c6c703282c27f96a67724f.png"><br><br>  Versuchen wir, eine Verbindung herzustellen und eine Tabelle zu erstellen: <br><br><pre> <code class="bash hljs">psql -h 89.208.87.38 -U admin -d myproddb Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user admin: psql (11.1, server 10.7) Type <span class="hljs-string"><span class="hljs-string">"help"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>. myproddb=&gt; CREATE TABLE <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> (event_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> NOT NULL); CREATE TABLE myproddb=&gt; INSERT INTO <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> VALUES (1),(2),(3); INSERT 0 3 myproddb=&gt; SELECT * FROM <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>; event_id ---------- 1 2 3 (3 rows) myproddb=&gt;</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/e04/c3f/7df/e04c3f7dfae02ca66e1f4163eb5b52d0.png"><br><br>  In der Anwendung geben wir die aktuellen Einstellungen f√ºr die Verbindung zu PostgreSQL an.  Wir werden die Adresse des TCP-Balancers angeben, wodurch das manuelle Umschalten auf die Adresse des Assistenten entf√§llt.  F√ºhren Sie es aus.  Wie Sie sehen k√∂nnen, werden die Ereignisse erfolgreich in der Datenbank protokolliert. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e37/fd2/33c/e37fd233cc670185c6da974e8ef54f9f.png"><br><br><h2>  Geplanter Hauptschalter </h2><br>  Jetzt werden wir den Betrieb unserer Anwendung w√§hrend des geplanten Wechsels des Assistenten testen: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0d4/7de/e5d/0d47dee5d56f84efe7ade9790a219c8f.png"><br><br>  Wir beobachten die Anwendung.  Wir sehen, dass die Anwendung wirklich unterbrochen ist, aber es dauert nur wenige Sekunden, in diesem speziellen Fall maximal 9. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a52/d80/a34/a52d80a34309b6a0e771ca01a722a448.png"><br><br><h2>  Auto fallen </h2><br>  Versuchen wir nun, den Fall einer virtuellen Maschine, des aktuellen Masters, zu simulieren.  Es w√§re m√∂glich, die virtuelle Maschine einfach √ºber die Horizon-Schnittstelle auszuschalten, nur wird sie regelm√§√üig heruntergefahren.  Ein solcher Wechsel wird von allen Diensten, einschlie√ülich Patroni, verarbeitet. <br><br>  Wir brauchen ein unvorhersehbares Herunterfahren.  Aus diesem Grund habe ich unsere Administratoren zu Testzwecken gebeten, die virtuelle Maschine - den aktuellen Master - auf ungew√∂hnliche Weise auszuschalten. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/101/231/8c8/1012318c85c30c4717e6db5df430afc3.png"><br><br>  Gleichzeitig funktionierte unsere Anwendung weiter.  Nat√ºrlich kann ein solcher Notschalter des Masters nicht unbemerkt bleiben. <br><br><pre> <code class="bash hljs">2019-03-29 10:45:56.071234 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 453 Connection closed 2019-03-29 10:45:59.205463 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 454 Connection closed 2019-03-29 10:46:02.661440 Error <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connecting to PostgreSQL server closed the connection unexpectedly This probably means the server terminated abnormally before or <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> processing the request. Caught error: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> variable <span class="hljs-string"><span class="hljs-string">'connection'</span></span> referenced before assignment ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.. -  -   2019-03-29 10:46:30.930445 Error <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connecting to PostgreSQL server closed the connection unexpectedly This probably means the server terminated abnormally before or <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> processing the request. Caught error: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> variable <span class="hljs-string"><span class="hljs-string">'connection'</span></span> referenced before assignment 2019-03-29 10:46:31.954399 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 455 Connection closed 2019-03-29 10:46:35.409800 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 456 Connection closed ^Cexit</code> </pre><br>  Wie Sie sehen, konnte die Anwendung ihre Arbeit in weniger als 30 Sekunden fortsetzen.  Ja, eine bestimmte Anzahl von Dienstbenutzern hat Zeit, Probleme zu bemerken.  Dies ist jedoch ein schwerwiegender Serverfehler, der nicht so h√§ufig auftritt.  Gleichzeitig h√§tte es die Person (Administrator) kaum geschafft, so schnell zu reagieren, wenn sie nicht mit einem Umschaltskript in der Konsole gesessen h√§tte. <br><br><h2>  Fazit </h2><br>  Es scheint mir, dass ein solcher Cluster einen enormen Vorteil f√ºr Administratoren bietet.  Tats√§chlich sind schwerwiegende Ausf√§lle und Ausf√§lle der Datenbankserver f√ºr die Anwendung und dementsprechend f√ºr den Benutzer nicht erkennbar.  Sie m√ºssen nicht schnell etwas reparieren und zu tempor√§ren Konfigurationen, Servern usw. wechseln.  Wenn Sie diese L√∂sung in Form eines vorgefertigten Dienstes in der Cloud verwenden, m√ºssen Sie keine Zeit mit der Vorbereitung verschwenden.  Es wird m√∂glich sein, etwas interessanteres zu tun. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de452846/">https://habr.com/ru/post/de452846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de452836/index.html">Web-Tools oder wo man einen Pentester startet?</a></li>
<li><a href="../de452838/index.html">3CX-Integration mit Office 365 √ºber die Azure-API</a></li>
<li><a href="../de452840/index.html">VMware EMPOWER 2019 Konferenz: Wie war der erste Tag?</a></li>
<li><a href="../de452842/index.html">SMPP - Peer-to-Peer-Kurznachrichtenprotokoll</a></li>
<li><a href="../de452844/index.html">Transformation oder Obsz√∂nit√§t: Wie man Telekommunikationsbetreiber "digitalisiert"</a></li>
<li><a href="../de452848/index.html">Was wird am 1. Februar 2020 passieren?</a></li>
<li><a href="../de452850/index.html">Systeme in Kassetten: Wie Ingenieure die Funktionen von Spielekonsolen erweiterten</a></li>
<li><a href="../de452852/index.html">Fernarbeit: Mythen in der Nacht</a></li>
<li><a href="../de452854/index.html">Vom normalen Benutzer zum vollwertigen Serveradministrator (XSS, LFI, Web-Shell)</a></li>
<li><a href="../de452856/index.html">Warum Indie-Projekte nicht live ver√∂ffentlicht werden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>