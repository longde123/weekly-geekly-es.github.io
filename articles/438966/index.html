<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèæ üêé üë®üèº‚Äçüíº Historial errante de documentaci√≥n de Haproxy, o qu√© buscar al configurarlo üöö üÄÑÔ∏è üçå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola de nuevo 

 La √∫ltima vez, hablamos sobre elegir una herramienta en Ostrovok.ru para resolver el problema de enviar un gran n√∫mero de solicitudes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Historial errante de documentaci√≥n de Haproxy, o qu√© buscar al configurarlo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/438966/">  Hola de nuevo <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La √∫ltima vez,</a> hablamos sobre elegir una herramienta en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ostrovok.ru</a> para resolver el problema de enviar un gran n√∫mero de solicitudes a servicios externos, sin poner a nadie al mismo tiempo.  El art√≠culo termin√≥ con una selecci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Haproxy</a> .  Hoy compartir√© los matices que tuve que enfrentar al usar esta soluci√≥n. <br><br><img src="https://habrastorage.org/webt/ns/mz/sb/nsmzsbtu2c1rgib_avecisgyrlk.jpeg"><br><a name="habracut"></a><br><h3>  Configuraci√≥n de haproxy </h3><br>  La primera dificultad fue que la opci√≥n <code>maxconn</code> es diferente seg√∫n el contexto: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">maxconn (ajuste de rendimiento);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">maxconn (opciones de enlace);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">maxconn (opciones de servidor y servidor predeterminado).</a> </li></ul><br>  Por costumbre, solo ajust√© la primera opci√≥n ( <code>performance tuning</code> ).  Esto es lo que dice la documentaci√≥n sobre esta opci√≥n: <br><blockquote>  Establece el n√∫mero m√°ximo de conexiones simult√°neas por proceso en &lt;n√∫mero&gt;.  Se <br>  es equivalente al argumento de la l√≠nea de comandos "-n".  Los representantes dejar√°n de aceptar <br>  conexiones cuando se alcanza este l√≠mite. <br></blockquote><br>  Parecer√≠a que lo que se necesita.  Sin embargo, cuando me di cuenta de que las nuevas conexiones al proxy no funcionaban de inmediato, comenc√© a leer la documentaci√≥n con m√°s cuidado, y all√≠ ya encontr√© el segundo par√°metro ( <code>bind options</code> ): <br><blockquote>  Limita los sockets a este n√∫mero de conexiones concurrentes.  Extra√±o <br>  las conexiones permanecer√°n en la cartera de pedidos del sistema hasta que se conecte <br>  liberado  Si no se especifica, el l√≠mite ser√° el mismo que el maxconn de la interfaz. <br></blockquote><br>  Entonces, <code>frontends maxconn</code> , luego busque <code>frontends maxconn</code> : <br><blockquote>  Fijar el n√∫mero m√°ximo de conexiones concurrentes en una interfaz <br>  ... <br>  De forma predeterminada, este valor se establece en 2000. <br></blockquote><br>  Genial, lo que necesitas.  Agregar a la configuraci√≥n: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 ... defaults mode http maxconn 524288</code> </pre><br>  La siguiente mordaza fue que Haproxy es de un solo subproceso.  Estoy muy acostumbrado al modelo en Nginx, por lo que este matiz siempre me ha deprimido.  Pero no se desespere: <i>Willy Tarreau (desarrollador de Haproxy</i> ) entendi√≥ lo que estaba haciendo, por lo que agreg√≥ la opci√≥n: <code>nbproc</code> . <br><br>  Sin embargo, directamente en la documentaci√≥n dice: <br><blockquote>  UTILIZANDO M√öLTIPLES PROCESOS <br>  ES M√ÅS DIF√çCIL DE DEPURAR Y EST√Å REALMENTE DESCURRIDO. <br></blockquote>  Esta opci√≥n realmente puede causar dolor de cabeza en caso de que necesite: <br><br><ul><li>  limite el n√∫mero de solicitudes / conexiones a los servidores (ya que no tendr√° un solo proceso con un contador, sino muchos procesos, y cada uno tiene su propio contador); </li><li>  Recopile estad√≠sticas del socket de administraci√≥n de Haproxy </li><li>  activar / desactivar backends a trav√©s del z√≥calo de control; </li><li>  ... tal vez algo m√°s.  ¬Ø \ _ („ÉÑ) _ / ¬Ø </li></ul><br>  Sin embargo, los dioses nos dieron procesadores multin√∫cleo, por lo que me gustar√≠a usarlos al m√°ximo.  En mi caso, hab√≠a cuatro n√∫cleos en dos n√∫cleos f√≠sicos.  Para Haproxy, seleccion√© el primer n√∫cleo, y se ve√≠a as√≠: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">nbproc</span></span> 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3</code> </pre><br>  Usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cpu-map,</a> vinculamos los procesos de Haproxy a un n√∫cleo espec√≠fico.  El programador del sistema operativo ya no necesita pensar d√≥nde planificar Haproxy, manteniendo as√≠ el <code>content switch</code> fr√≠o y el cach√© de la CPU caliente. <br><br><h4>  Hay muchos tampones, pero no en nuestro caso. </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tune.bufsize</a> : en nuestro caso no fue necesario ejecutarlo, pero si tiene errores con el c√≥digo <code>400 (Bad Request)</code> , este es probablemente su caso. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhg4u2N6R7NjZcAwURHZzgjOaj5paQ#tune.">tune.http.cookielen</a> : si distribuye cookies grandes a los usuarios, entonces, para evitar da√±os durante la transmisi√≥n a trav√©s de la red, tambi√©n puede tener sentido aumentar este b√∫fer. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhg4u2N6R7NjZcAwURHZzgjOaj5paQ#tune.">tune.http.maxhdr</a> es otra posible fuente de 400 c√≥digos de respuesta si tiene demasiados encabezados. </li></ul><br><h4>  Ahora considere las cosas de nivel inferior </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tune.rcvbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tune.rcvbuf.server</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tune.sndbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tune.sndbuf.server</a> : la documentaci√≥n dice lo siguiente: <br><blockquote>  Normalmente, nunca debe establecerse, y el tama√±o predeterminado (0) permite que el kernel ajuste autom√°ticamente este valor dependiendo de la cantidad de memoria disponible. <br></blockquote><br>  Pero para m√≠, lo obvio es mejor que lo impl√≠cito, as√≠ que forc√© los valores de estas opciones para estar seguros del ma√±ana. <br><br>  Y otro par√°metro que no est√° relacionado con los buffers, pero que es bastante importante es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tune.maxaccept</a> . <br><blockquote>  Establece el n√∫mero m√°ximo de conexiones consecutivas que un proceso puede aceptar en un <br>  fila antes de cambiar a otro trabajo.  En modo de proceso √∫nico, n√∫meros m√°s altos <br>  dar un mejor rendimiento a altas velocidades de conexi√≥n.  Sin embargo en multiproceso <br>  modos, mantener un poco de equidad entre los procesos generalmente es mejor <br>  aumentar el rendimiento <br></blockquote><br>  En nuestro caso, se generan muchas solicitudes de proxy, por lo que elev√© este valor para aceptar m√°s solicitudes a la vez.  Sin embargo, como dice la documentaci√≥n, vale la pena probar que en modo de subprocesos m√∫ltiples la carga se distribuye de la manera m√°s uniforme posible entre los procesos. <br><br>  Todos los par√°metros juntos: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">tune</span></span>.bufsize 16384 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432</code> </pre><br><h4>  Lo que nunca sucede son los tiempos de espera.  ¬øQu√© har√≠amos sin ellos? </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">timeout connect</a> : tiempo para establecer una conexi√≥n con el backend.  Si la conexi√≥n con el backend no es muy buena, entonces es mejor deshabilitarla antes de que se agote el tiempo hasta que la red vuelva a la normalidad. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cliente de</a> tiempo de espera: tiempo de espera para la transmisi√≥n de los primeros bytes de datos.  Ayuda a desconectar a quienes hacen solicitudes "en reserva". </li></ul><br><div class="spoiler">  <b class="spoiler_title">Kulstory sobre el cliente HTTP en Go</b> <div class="spoiler_text">  Go tiene un cliente HTTP normal que tiene la capacidad de mantener un grupo de conexiones a los servidores.  Entonces sucedi√≥ una historia interesante, en la que participaron el tiempo de espera y el grupo de conexiones descritos anteriormente en el cliente HTTP.  Una vez que un desarrollador se quej√≥ de que peri√≥dicamente tiene 408 errores de un proxy.  Examinamos el c√≥digo del cliente y vimos la siguiente l√≥gica all√≠: <br><br><ul><li>  Estamos tratando de tomar una conexi√≥n gratuita establecida del grupo; </li><li>  si no funciona, comience la instalaci√≥n de una nueva conexi√≥n en goroutine; </li><li>  revise la piscina nuevamente; </li><li>  si hay libre en la piscina, la tomamos y colocamos la nueva en la piscina, si no, use la nueva. </li></ul><br>  ¬øYa entendiste qu√© es la sal? <br><br>  Si el cliente ha establecido una nueva conexi√≥n, pero no la ha utilizado, luego de cinco segundos el servidor la cierra y el caso ha terminado.  El cliente detecta esto solo cuando ya obtiene la conexi√≥n del grupo e intenta usarla.  Vale la pena tener esto en cuenta. <br></div></div><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servidor de tiempo de espera</a> : el tiempo m√°ximo para esperar una respuesta del servidor. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">timeout client-fin</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">timeout server-fin</a> : aqu√≠ nos protegemos de las conexiones semicerradas para no acumularlas en la tabla del sistema operativo. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhg4u2N6R7NjZcAwURHZzgjOaj5paQ#timeout%20">timeout http-request</a> es uno de los tiempos de espera m√°s adecuados.  Le permite cortar clientes lentos que no pueden realizar una solicitud HTTP en el tiempo asignado para ellos. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhg4u2N6R7NjZcAwURHZzgjOaj5paQ#timeout%20">tiempo de espera http-keep-alive</a> : espec√≠ficamente en nuestro caso, si una conexi√≥n de <code>keep-alive</code> bloquea sin solicitudes durante m√°s de 50 segundos, lo m√°s probable es que algo haya salido mal y la conexi√≥n se pueda cerrar, liberando as√≠ memoria para algo nuevo luz </li></ul><br>  Todos los tiempos de espera juntos: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">defaults</span></span> mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s</code> </pre><br><h4>  Registro  ¬øPor qu√© es tan dif√≠cil? </h4><br>  Como escrib√≠ anteriormente, la mayor√≠a de las veces en mis decisiones uso Nginx, por lo tanto, me siento mimado por su sintaxis y la simplicidad de modificar los formatos de registro.  Me gust√≥ especialmente la caracter√≠stica asesina: formatee los registros en forma de json y luego anal√≠celos con cualquier biblioteca est√°ndar. <br><br>  ¬øQu√© tenemos en Haproxy?  Existe tal oportunidad, solo usted puede escribir exclusivamente en syslog, y la sintaxis de configuraci√≥n est√° un poco m√°s ajustada. <br>  Te dar√© una configuraci√≥n de ejemplo con comentarios: <br><br><pre> <code class="apache hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,     ,    (   # error.log  nginx) log 127.0.0.1:2514 len 8192 local1 notice emerg #    -  access.log log 127.0.0.1:2514 len 8192 local7 info</span></span></code> </pre><br>  El dolor particular es causado por tales momentos: <br><ul><li>  nombres de variables cortos, y especialmente sus combinaciones como% HU o% fp </li><li>  el formato no se puede dividir en varias l√≠neas, por lo que debe escribir el footfoot en una l√≠nea.  dif√≠cil de agregar / eliminar elementos nuevos / innecesarios </li><li>  para que algunas variables funcionen, deben declararse expl√≠citamente a trav√©s del encabezado de solicitud de captura </li></ul><br>  Como resultado, para obtener algo interesante, tienes que tener tal pa√±o: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">log</span></span>-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}'</code> </pre><br><h4>  Bueno, parecer√≠a, peque√±as cosas, pero agradables </h4><br>  Describ√≠ el formato del registro anterior, pero no es tan simple.  Para depositar algunos elementos en √©l, como: <br><br><ul><li>  http_host </li><li>  http_referer, </li><li>  http_user_agent, </li></ul><br>  primero necesita capturar estos datos de la solicitud ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">captura</a> ) y ponerlos en una matriz de valores capturados. <br><br>  Aqu√≠ hay un ejemplo: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128</code> </pre><br>  Como resultado, ahora podemos acceder a los elementos que necesitamos de esta manera: <br>  <code>%[capture.req.hdr(N)]</code> , donde N es el n√∫mero de secuencia de la definici√≥n del grupo de captura. <br>  En el ejemplo anterior, el encabezado del Host estar√° en el n√∫mero 0 y el User-Agent estar√° en el n√∫mero 2. <br><br>  Haproxy tiene una peculiaridad: resuelve las direcciones DNS de los backends al inicio y, si no puede resolver ninguna de las direcciones, cae la muerte de los valientes. <br><br>  En nuestro caso, esto no es muy conveniente, ya que hay muchos backends, no los gestionamos, y es mejor obtener 503 de Haproxy que todo el servidor proxy se negar√° a iniciar debido a un solo proveedor.  La siguiente opci√≥n nos ayuda con esto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">init-addr</a> . <br><br>  Una l√≠nea tomada directamente de la documentaci√≥n nos permite ver todos los m√©todos disponibles para resolver una direcci√≥n y, en el caso de un archivo, simplemente posponer este asunto para m√°s adelante y avanzar: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">default</span></span>-server init-addr last,libc,none</code> </pre> <br>  Y finalmente, mi favorito: selecci√≥n de backend. <br>  La sintaxis para la configuraci√≥n de selecci√≥n de back-end de Haproxy es familiar para todos: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">use_backend</span></span> &lt;backend1_name&gt; if &lt;condition1&gt; use_backend &lt;backend2_name&gt; if &lt;condition2&gt; default-backend &lt;backend3&gt;</code> </pre><br>  Pero, en palabras, de alguna manera no es muy.  Ya he descrito todos los backends de forma automatizada (ver el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo anterior</a> ), tambi√©n ser√≠a posible generar <code>use_backend</code> aqu√≠, el mal negocio no es complicado, pero no quer√≠a hacerlo.  Como resultado, se encontr√≥ otra forma: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 #   host_present      Host acl host_present hdr(host) -m len gt 0 #    ,     use_backend %[req.hdr(host),lower,field(1,'.')] if host_present #      ,    default_backend default backend default mode http server no_server 127.0.0.1:65535</code> </pre><br>  Por lo tanto, estandarizamos los nombres de backends y urls por los cuales puede acceder a ellos. <br><br>  Bueno, ahora compilando de los ejemplos anteriores en un archivo: <br><br><div class="spoiler">  <b class="spoiler_title">Versi√≥n completa de configuraci√≥n</b> <div class="spoiler_text"><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 nbproc 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3 tune.bufsize 16384 tune.comp.maxlevel 1 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432 stats socket /run/haproxy.sock mode 600 level admin log /dev/stdout local0 debug defaults mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s default-server init-addr last,libc,none log 127.0.0.1:2514 len 8192 local1 notice emerg log 127.0.0.1:2514 len 8192 local7 info log-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}' frontend http bind *:80 http-request del-header X-Forwarded-For http-request del-header X-Forwarded-Port http-request del-header X-Forwarded-Proto capture request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 acl host_present hdr(host) -m len gt 0 use_backend %[req.hdr(host),lower,field(1,'.')] if host_present default_backend default backend default mode http server no_server 127.0.0.1:65535 resolvers dns hold valid 1s timeout retry 100ms nameserver dns1 127.0.0.1:53</code> </pre><br></div></div><br>  Gracias a quienes leyeron hasta el final.  Sin embargo, esto no es todo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La pr√≥xima vez</a> veremos cosas de nivel inferior relacionadas con la optimizaci√≥n del sistema en s√≠, en el que trabaja Haproxy, para que √©l y su sistema operativo se sientan c√≥modos juntos, y haya suficiente hierro para todos. <br><br>  Hasta pronto! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/438966/">https://habr.com/ru/post/438966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../438956/index.html">Magnetitis en los dientes: secuenciaci√≥n de transcriptomos del tejido de la c√°scara de molusco radula</a></li>
<li><a href="../438958/index.html">ILV confirm√≥ la existencia de su "estaci√≥n espacial"</a></li>
<li><a href="../438960/index.html">C√≥mo renunci√© a Ruby a favor de Python mientras trabajaba en un backend</a></li>
<li><a href="../438962/index.html">En su mayor parte, una perspectiva positiva para el futuro de los chips.</a></li>
<li><a href="../438964/index.html">¬øQui√©n est√° realmente detr√°s de las populares VPN gratuitas?</a></li>
<li><a href="../438968/index.html">Marcado de zapatos en Rusia: el mercado no est√° listo, pero tendr√° que funcionar</a></li>
<li><a href="../438970/index.html">Se dice que Haskell es un lenguaje para genios y acad√©micos. Derecho?</a></li>
<li><a href="../438972/index.html">El cerebro desde adentro (visualizaci√≥n del paso del patr√≥n a trav√©s del modelo de red neuronal artificial)</a></li>
<li><a href="../438974/index.html">La realidad virtual ayuda a lidiar con los trastornos mentales</a></li>
<li><a href="../438976/index.html">El libro "Primavera. Todos los patrones de dise√±o ¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>