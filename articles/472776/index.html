<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ üî™ üë®‚Äçüë¶‚Äçüë¶ Copia de seguridad Parte 7: Conclusiones üíå üíÜ üíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta nota completa el ciclo de respaldo. Hablar√° sobre la organizaci√≥n l√≥gica de un servidor dedicado (o VPS), conveniente para la copia de seguridad,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Copia de seguridad Parte 7: Conclusiones</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/472776/"><p><img src="https://habrastorage.org/webt/0j/nc/w0/0jncw0g7k55eoykgop-7y2vcdgi.jpeg"></p><br><p>  Esta nota completa el ciclo de respaldo.  Hablar√° sobre la organizaci√≥n l√≥gica de un servidor dedicado (o VPS), conveniente para la copia de seguridad, y tambi√©n ofrecer√° la opci√≥n de restaurar r√°pidamente el servidor desde una copia de seguridad sin ning√∫n tiempo de inactividad en caso de accidente. </p><a name="habracut"></a><br><h2 id="ishodnye-dannye">  Datos de origen </h2><br><p>  Un servidor dedicado a menudo tiene al menos dos discos duros que se utilizan para organizar una matriz RAID del primer nivel (espejo).  Esto es necesario para poder continuar con el servidor si falla una unidad.  Si se trata de un servidor dedicado ordinario, puede haber un controlador RAID de hardware separado con tecnolog√≠a de almacenamiento en cach√© activa en los SSD, de modo que, adem√°s de los discos duros normales, se puedan conectar uno o m√°s SSD.  A veces se ofrecen servidores dedicados, en los que solo SATADOM est√° presente desde discos locales (discos peque√±os, estructuralmente, una unidad flash USB conectada al puerto SATA), o incluso una unidad flash USB peque√±a (8-16 GB) com√∫n conectada a un puerto interno especial, y los datos se toman del sistema de almacenamiento conectado a trav√©s de una red de almacenamiento dedicada (Ethernet 10G, FC, etc.), y hay servidores dedicados que se cargan directamente desde el sistema de almacenamiento.  No considerar√© tales opciones, ya que en tales casos la tarea de hacer una copia de seguridad del servidor pasa sin problemas al especialista que da servicio al sistema de almacenamiento, por lo general, existen varias tecnolog√≠as patentadas para crear instant√°neas de estado, deduplicaci√≥n incorporada y otras alegr√≠as del administrador del sistema discutidas en las partes anteriores de esta serie.  El volumen de la matriz de discos de un servidor dedicado puede alcanzar varias decenas de terabytes, dependiendo de la cantidad y el volumen de discos conectados al servidor.  En el caso de VPS, los vol√∫menes son m√°s modestos: generalmente no m√°s de 100 GB (pero hay m√°s), y las tarifas para tal VPS pueden ser f√°cilmente m√°s caras que los servidores dedicados m√°s baratos del mismo proveedor de alojamiento.  El VPS a menudo tiene una unidad, porque debajo estar√° el almacenamiento (o algo hiperconvergente).  A veces, VPS tiene varios discos con diferentes caracter√≠sticas, para diferentes prop√≥sitos: </p><br><ul><li>  sistema peque√±o: para instalar el sistema operativo; </li><li>  grande: almacenamiento de datos del usuario. </li></ul><br><p>  Al reinstalar el sistema utilizando el panel de control, el disco con los datos del usuario no se sobrescribe, pero el sistema se vuelve a cargar por completo.  Adem√°s, en el caso de VPS, el host puede ofrecer un bot√≥n que tome una instant√°nea del estado del VPS (o disco), sin embargo, si instala su sistema operativo u olvida activar el servicio deseado dentro del VPS, algunos de los datos a√∫n pueden perderse.  Adem√°s del bot√≥n, generalmente se ofrece un servicio de almacenamiento de datos, muy a menudo muy limitado.  Por lo general, esta es una cuenta con acceso FTP o SFTP, a veces junto con SSH, con un shell truncado (por ejemplo, rbash) o una restricci√≥n en la ejecuci√≥n de comandos a trav√©s de claves_autorizadas (a trav√©s de ForcedCommand). </p><br><p>  Un servidor dedicado est√° conectado a la red por dos puertos con una velocidad de 1 Gbit / s, a veces pueden ser tarjetas con una velocidad de 10 Gbit / s.  VPS a menudo tiene una interfaz de red.  Con mayor frecuencia, los centros de datos no limitan la velocidad de la red dentro del centro de datos, sino que limitan la velocidad del acceso a Internet. </p><br><p>  Una carga t√≠pica de dicho servidor dedicado o VPS es un servidor web, base de datos, servidor de aplicaciones.  A veces se pueden instalar varios servicios de soporte adicionales, incluso para un servidor web o una base de datos: motor de b√∫squeda, sistema de correo, etc. </p><br><p>  Un servidor especialmente preparado act√∫a como un espacio para almacenar copias de seguridad, se describir√° con m√°s detalle a continuaci√≥n. </p><br>
<h2 id="logicheskaya-organizaciya-diskovoy-sistemy">  Organizaci√≥n de disco l√≥gico </h2><br><p>  Si hay un controlador RAID, o es un VPS con un disco, y tampoco hay preferencias particulares para el subsistema de disco (por ejemplo, un disco r√°pido separado para la base de datos): todo el espacio libre se divide de la siguiente manera: se crea una partici√≥n, se crea un grupo de vol√∫menes LVM encima. , crea varios vol√∫menes: 2 peque√±os del mismo tama√±o que se usan como sistema de archivos ra√≠z (se cambian alternativamente con actualizaciones para permitir una reversi√≥n r√°pida, la idea se espi√≥ desde la distribuci√≥n Calcular Linux), otra es para la partici√≥n de intercambio, el resto es gratis  Este espacio se divide en peque√±os vol√∫menes, que se utilizan como sistema de archivos ra√≠z para contenedores completos, discos para m√°quinas virtuales, sistemas de archivos para cuentas en / home (cada cuenta tiene su propio sistema de archivos), sistemas de archivos para contenedores de aplicaciones. </p><br><p>  Nota importante: los vol√∫menes deben ser completamente autosuficientes, es decir  no debe depender tanto el uno del otro como del sistema de archivos ra√≠z.  En el caso de m√°quinas virtuales o contenedores, este punto se observa autom√°ticamente.  Si se trata de contenedores de aplicaciones o directorios de inicio, deber√≠a pensar en separar los archivos de configuraci√≥n del servidor web y otros servicios de manera que se eliminen al m√°ximo las dependencias de los vol√∫menes entre ellos.  Por ejemplo, cada sitio se ejecuta con su propio usuario, los archivos de configuraci√≥n del sitio est√°n en el directorio de inicio del usuario, en la configuraci√≥n del servidor web, los archivos de configuraci√≥n del sitio no se incluyen a trav√©s de /etc/nginx/conf.d/ <em>.conf, sino, por ejemplo, / home /</em> /configs/nginx/*.conf </p><br><p>  Si hay varios discos, puede crear un RAID de software (y configurar su almacenamiento en cach√© en SSD, si es necesario y una oportunidad), adem√°s de los cuales se puede ensamblar LVM de acuerdo con las reglas sugeridas anteriormente.  Tambi√©n en este caso, puede usar ZFS o BtrFS, pero aqu√≠ vale la pena considerarlo varias veces: ambos requieren un enfoque mucho m√°s serio de los recursos, adem√°s, ZFS no viene con el kernel de Linux. </p><br><p>  Independientemente del esquema utilizado, siempre vale la pena calcular de antemano la velocidad aproximada de escritura de cambios en los discos y luego calcular el tama√±o del espacio libre que se reservar√° para crear im√°genes.  Por ejemplo, si nuestro servidor escribe datos a una velocidad de 10 megabytes por segundo, y el tama√±o de toda la matriz de datos es de 10 terabytes, el tiempo de sincronizaci√≥n puede ser de hasta un d√≠a (22 horas; esta cantidad se transmitir√° a trav√©s de la red 1 gbit / s), vale la pena reservar aproximadamente 800 GB  En realidad, el n√∫mero ser√° menor; puede dividirlo de manera segura por el n√∫mero de vol√∫menes l√≥gicos. </p><br><h2 id="ustroystvo-servera-hraneniya-rezervnyh-kopiy">  Dispositivo de servidor de almacenamiento de respaldo </h2><br><p>  La principal diferencia entre el servidor para almacenar copias de seguridad son los discos grandes, baratos y relativamente lentos.  Dado que los discos duros modernos ya han superado la barra de 10 TB en un disco, es obligatorio usar sistemas de archivos o RAID con sumas de verificaci√≥n, porque durante la reconstrucci√≥n de la matriz o la restauraci√≥n del sistema de archivos (¬°varios d√≠as!), El segundo disco puede fallar debido a una mayor carga.  En discos con una capacidad de hasta 1 TB, esto no era tan sensible.  Para simplificar la descripci√≥n, supongo que el espacio en disco se divide en dos partes de aproximadamente el mismo tama√±o (de nuevo, por ejemplo, usando LVM): </p><br><ul><li>  vol√∫menes correspondientes a los servidores utilizados para almacenar datos de usuario (se implementar√° la √∫ltima copia de seguridad realizada para la verificaci√≥n); </li><li>  vol√∫menes utilizados como repositorios de BorgBackup (los datos para las copias de seguridad llegar√°n directamente aqu√≠). </li></ul><br><p>  El principio de funcionamiento es que se crean vol√∫menes separados para cada servidor en el repositorio BorgBackup, donde ir√°n los datos de los servidores de batalla.  Los repositorios funcionan en el modo de solo agregar, lo que elimina la posibilidad de eliminaci√≥n intencional de datos y debido a la deduplicaci√≥n y la limpieza peri√≥dica de los repositorios de las copias de seguridad antiguas (hay copias anuales, mensuales durante el √∫ltimo a√±o, semanalmente durante el √∫ltimo mes, diariamente durante la √∫ltima semana, posiblemente en especial casos - por hora para el √∫ltimo d√≠a: total 24 + 7 + 4 + 12 + anual - aproximadamente 50 copias para cada servidor). <br>  En los repositorios de BorgBackup, solo el modo agregar no est√° activado; en cambio, ForcedCommand se usa en .ssh / Authorizedkeys de aproximadamente el siguiente plan: </p><br><pre><code class="plaintext hljs">from=" ",command="/usr/local/bin/borg serve --append-only --restrict-to-path /home/servername/borgbackup/",no-pty,no-agent-forwarding,no-port-forwarding,no-X11-forwarding,no-user-rc AAAAA.......</code> </pre> <br><p>  Se coloca un contenedor de secuencia de comandos encima de la ruta especificada encima de borg, que, adem√°s de iniciar el binario con los par√°metros, tambi√©n inicia el proceso de restaurar la copia de seguridad despu√©s de eliminar los datos.  Para hacer esto, el script del contenedor crea un archivo de etiqueta al lado del repositorio correspondiente.  La √∫ltima copia de seguridad realizada despu√©s del proceso de carga de datos se restaura autom√°ticamente al volumen l√≥gico correspondiente. </p><br><p>  Este dise√±o le permite limpiar peri√≥dicamente las copias de seguridad innecesarias, y tampoco permite que los servidores de batalla eliminen nada en el servidor de almacenamiento de copias de seguridad. </p><br><h2 id="process-rezervnogo-kopirovaniya">  Proceso de respaldo </h2><br><p>  El iniciador de la copia de seguridad es el servidor dedicado en s√≠ o VPS, ya que dicho esquema brinda m√°s control sobre el proceso de copia de seguridad desde este servidor.  En primer lugar, se toma una instant√°nea del estado del sistema de archivos ra√≠z activo, que se monta y carga mediante BorgBackup en el servidor de almacenamiento de respaldo.  Despu√©s de completar la captura de datos, la imagen se desmonta y se elimina. </p><br><p>  Si hay una peque√±a base de datos (hasta 1 GB para cada sitio), se realiza un volcado de la base de datos, que se guarda en el volumen l√≥gico correspondiente, donde se encuentra el resto de los datos del mismo sitio, pero de modo que el volcado no sea accesible a trav√©s del servidor web.  Si las bases de datos son grandes, debe configurar una miner√≠a de datos "activa", por ejemplo, utilizando xtrabackup para MySQL o WAL con archive_command en PostgreSQL.  En este caso, la base de datos se restaurar√° por separado de estos sitios. </p><br><p>  Si se utilizan contenedores o m√°quinas virtuales, debe configurar qemu-guest-agent, CRIU u otras tecnolog√≠as necesarias.  En otros casos, la mayor√≠a de las veces no se necesitan configuraciones adicionales: solo cree instant√°neas de vol√∫menes l√≥gicos, que luego se procesan de manera similar a una instant√°nea del estado del sistema de archivos ra√≠z.  Despu√©s de tomar los datos, las im√°genes se eliminan. </p><br><p>  Se realiza m√°s trabajo en el servidor de almacenamiento de respaldo: </p><br><ul><li>  Se verifica la √∫ltima copia de seguridad realizada en cada repositorio. </li><li>  busca un archivo de etiqueta que indique que el proceso de captura de datos se ha completado, </li><li>  los datos se est√°n expandiendo al volumen local correspondiente, </li><li>  el archivo de etiqueta se elimina </li></ul><br><h2 id="process-vosstanovleniya-rabotosposobnosti-servera">  Proceso de recuperaci√≥n del servidor </h2><br><p>  Si el servidor principal muere, se inicia un servidor dedicado similar, que se carga desde alguna imagen est√°ndar.  Lo m√°s probable es que la descarga se realice a trav√©s de la red, sin embargo, el t√©cnico del centro de datos que realiza la configuraci√≥n del servidor puede copiar inmediatamente esta imagen est√°ndar en uno de los discos.  La descarga se realiza en la RAM, despu√©s de lo cual comienza el proceso de recuperaci√≥n: </p><br><ul><li>  se realiza una solicitud para conectar el dispositivo de bloque a trav√©s de iscsi \ nbd u otro protocolo similar del volumen l√≥gico que contiene el sistema de archivos ra√≠z del servidor muerto;  Dado que el sistema de archivos ra√≠z debe ser peque√±o, este paso debe completarse en unos minutos.  Tambi√©n se realiza la recuperaci√≥n del cargador de arranque; </li><li>  se recrea la estructura de los vol√∫menes l√≥gicos locales, los vol√∫menes l√≥gicos se conectan desde el servidor de respaldo utilizando el m√≥dulo del n√∫cleo dm_clone: ‚Äã‚Äãcomienza la recuperaci√≥n de datos y los cambios se escriben inmediatamente en los discos locales </li><li>  se inicia un contenedor con todos los discos f√≠sicos disponibles: el servidor est√° completamente restaurado, pero con un rendimiento reducido; </li><li>  una vez completada la sincronizaci√≥n de datos, los vol√∫menes l√≥gicos del servidor de respaldo se desconectan, el contenedor se apaga y el servidor se reinicia; </li></ul><br><p>  Despu√©s del reinicio, el servidor tendr√° todos los datos que estaban en el momento de la copia de seguridad, y tambi√©n incluir√° todos los cambios que se realizaron durante el proceso de recuperaci√≥n. </p><br><div class="spoiler">  <b class="spoiler_title">Otros art√≠culos de ciclo</b> <div class="spoiler_text"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Copia de seguridad, parte 1: ¬øPor qu√© necesita una copia de seguridad, una descripci√≥n general de los m√©todos y las tecnolog√≠as?</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Copia de seguridad, Parte 2: Descripci√≥n general y prueba de herramientas de copia de seguridad basadas en rsync</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Copia de seguridad, Parte 3: Descripci√≥n general y prueba de duplicidad, duplicaci√≥n</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Copia de seguridad, Parte 4: Descripci√≥n general y prueba de zbackup, restic, borgbackup</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Backup, Parte 5: Prueba de Bacula y Veeam Backup para Linux</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Copia de seguridad: parte solicitada por los lectores: revisi√≥n de AMANDA, UrBackup, BackupPC</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Copia de seguridad, Parte 6: Comparaci√≥n de herramientas de copia de seguridad</a> <br>  Copia de seguridad Parte 7: Conclusiones </p></div></div><br><p>  Los invito a discutir la opci√≥n propuesta en los comentarios, ¬°gracias por su atenci√≥n! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472776/">https://habr.com/ru/post/472776/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472762/index.html">An√°lisis t√©cnico del exploit checkm8</a></li>
<li><a href="../472766/index.html">Parametrizaci√≥n desde archivo en py.test</a></li>
<li><a href="../472768/index.html">C√≥mo contratar, despedir y regresar de la administraci√≥n al desarrollo: video de Badoo Techleads Meetup # 5</a></li>
<li><a href="../472770/index.html">Organizaci√≥n de la interfaz en Unity con UI Canvas</a></li>
<li><a href="../472772/index.html">Busque incidentes y reclamos similares. M√©tricas y Optimizaci√≥n</a></li>
<li><a href="../472778/index.html">5 maneras de usar la Raspberry Pi</a></li>
<li><a href="../472780/index.html">¬øPor qu√© evitar amigos o c√≥mo perd√≠ todas mis ventajas?</a></li>
<li><a href="../472782/index.html">Por qu√© 3D Dolor de cabeza / Parte 8 Desenfoque y el futuro de 3D</a></li>
<li><a href="../472790/index.html">Antig√ºedades: i-Mate Jasjar, un comunicador para empresas</a></li>
<li><a href="../472792/index.html">Computadora basada en v√°lvulas NOR: dentro de la computadora de control a bordo Apollo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>