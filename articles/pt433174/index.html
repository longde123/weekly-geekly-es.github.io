<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüöí üìú ‚ûø Nem todos os patches s√£o igualmente √∫teis. üéì üëù üßò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este post continua a discuss√£o sobre melhorias de desempenho que poderiam se tornar realidade se n√£o fosse pelos diferentes mas. A parte anterior sobr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nem todos os patches s√£o igualmente √∫teis.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433174/"><p> Este post continua a discuss√£o sobre melhorias de desempenho que poderiam se tornar realidade se n√£o fosse pelos diferentes mas.  A parte anterior sobre o <code>StringBuilder</code> est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  Aqui, examinamos v√°rias "melhorias" rejeitadas devido √† falta de compreens√£o das sutilezas da especifica√ß√£o da linguagem, casos de canto n√£o √≥bvios e outros motivos.  Vamos l√°! </p><a name="habracut"></a><br><h4 id="kogda-nichto-ne-predveschaet-bedy">  Quando nada pressagia problemas </h4><br><p>  Acho que cada um de n√≥s trabalhou com os m√©todos <code>Collections.emptySet()</code> / <code>Collections.emptyList()</code> .  Esses s√£o m√©todos muito √∫teis que permitem retornar uma cole√ß√£o imut√°vel vazia sem criar um novo objeto.  Olhando dentro da classe <code>EmptyList</code> veremos isso: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmptyList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Iterator&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> emptyIterator(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object[] toArray() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } }</code> </pre> <br><p>  V√™ um forte potencial de melhoria?  O m√©todo <code>EmptyList.iterator()</code> retorna um iterador vazio da presen√ßa. Por que n√£o fazer a mesma coisa com seus ouvidos para a matriz retornada pelo m√©todo <code>toArray()</code> ? </p><br><div class="spoiler">  <b class="spoiler_title">Existe um mas, e √© chamado de documenta√ß√£o</b> <div class="spoiler_text"><blockquote>  A matriz retornada ser√° "segura", pois nenhuma lista a ela √© mantida por esta lista.  (Em outras palavras, esse m√©todo deve alocar uma nova matriz, mesmo que essa lista seja apoiada por uma matriz).  O chamador fica livre para modificar a matriz retornada. </blockquote><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">http://mail.openjdk.java.net/pipermail/core-libs-dev/2017-September/049170.html</a> <br>  <a href="" rel="nofollow">http://hg.openjdk.java.net/jdk/jdk12/file/ffac5eabbf28/src/java.base/share/classes/java/util/List.java#l185</a> </p></div></div><br><p>  Em outras palavras, o m√©todo sempre deve retornar uma <strong>nova</strong> matriz. </p><br><p>  Voc√™ dir√°: "Ele √© imut√°vel! O que pode dar errado!?" </p><br><p>  Somente especialistas experientes podem responder a esta pergunta: </p><br><blockquote>  - Quem √© respons√°vel? <br>  - Especialistas respons√°veis ‚Äã‚ÄãPaul Sandoz e Tagir Valeev </blockquote><br><div class="spoiler">  <b class="spoiler_title">A resposta dos especialistas</b> <div class="spoiler_text"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">http://mail.openjdk.java.net/pipermail/core-libs-dev/2017-September/049171.html</a> </p><br><blockquote>  Observe tamb√©m que isso altera o comportamento vis√≠vel.  E. g.  algu√©m pode sincronizar no objeto de matriz retornado pela chamada toArray, portanto essa altera√ß√£o pode causar o <strong>compartilhamento</strong> indesejado de <strong>bloqueios</strong> . <br><br>  Uma vez sugeri uma melhoria semelhante: retornar EMPTY_LIST de Arrays.asList () quando a matriz fornecida tiver tamanho zero.  Foi recusado pelo mesmo motivo [1]. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">http://mail.openjdk.java.net/pipermail/core-libs-dev/2015-September/035197.html</a> <br><br>  A prop√≥sito, provavelmente √© razo√°vel que Arrays.asList verifique o comprimento da matriz como: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T... a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(a.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Collections.emptyList(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(a); }</code> </pre> <br><br>  Parece razo√°vel, certo?  Por que criar uma nova lista para uma matriz vazia se voc√™ pode fazer uma lista pronta de gra√ßa? <br>  H√° uma raz√£o para n√£o fazer isso.  No momento, Arrays.asList n√£o especifica restri√ß√µes √† identidade da lista retornada.  Adicionar a micro-otimiza√ß√£o mudar√° isso.  √â um caso de ponta e um caso de uso question√°vel tamb√©m, mas considerando que eu deixaria as coisas de maneira conservadora. </blockquote></div></div><br><p>  Esta afirma√ß√£o provavelmente causar√° confus√£o: </p><br><blockquote>  E. g.  algu√©m pode sincronizar no objeto de matriz retornado pela chamada toArray, portanto essa altera√ß√£o pode causar o compartilhamento indesejado de bloqueios. </blockquote><p>  Voc√™ dir√°: "Quem em s√£ consci√™ncia ser√° sincronizado no array (!) Retornado (!!!) da cole√ß√£o!?" </p><br><p>  N√£o parece muito convincente, mas o idioma oferece essa oportunidade, o que significa que existe a possibilidade de um determinado usu√°rio fazer isso (ou at√© j√° o fez).  Em seguida, a altera√ß√£o proposta alterar√°, na melhor das hip√≥teses, o comportamento do c√≥digo e, na pior das hip√≥teses, levar√° a uma falha na sincroniza√ß√£o (v√° mais tarde, pegue)  O risco √© t√£o injustificado e o ganho esperado √© t√£o insignificante que √© melhor deixar tudo como est√°. </p><br><p>  Em geral, a capacidade de sincronizar em qualquer objeto, kmk, foi o erro dos desenvolvedores de idiomas.  Em primeiro lugar, o cabe√ßalho de cada objeto cont√©m uma estrutura respons√°vel pela sincroniza√ß√£o e, em segundo lugar, nos encontramos na situa√ß√£o descrita acima, quando um objeto aparentemente imut√°vel n√£o pode ser retornado v√°rias vezes, pois pode ser sincronizado com ele. </p><br><p>  A moral dessa f√°bula √© a seguinte: especifica√ß√£o e compatibilidade com vers√µes anteriores s√£o vacas sagradas de Java.  Nem tente invadi-los: o guarda atira sem aviso. </p><br><h4 id="staraeshsya-staraeshsya">  Tentando, tentando ... </h4><br><p>  Existem v√°rias classes baseadas em matriz no JDK de uma s√≥ vez e todas elas implementam os m√©todos <code>List.indexOf()</code> e <code>List.lastIndexOf()</code> : </p><br><ul><li>  java.util.ArrayList </li><li>  java.util.Arrays $ ArrayList </li><li>  java.util.Vector </li><li>  java.util.concurrent.CopyOnWriteArrayList </li></ul><br><p>  O c√≥digo desses m√©todos nessas classes √© repetido quase um para um.  Muitos aplicativos e estruturas tamb√©m oferecem suas solu√ß√µes para o mesmo problema: </p><br><ul><li>  <a href="" rel="nofollow">org.hibernate.bytecode.enhance.internal.tracker.SimpleFieldTracker</a> </li><li>  <a href="" rel="nofollow">com.intellij.util.ArrayUtil</a> </li><li>  <a href="" rel="nofollow">com.intellij.util.ArrayUtilRt</a> </li><li>  <a href="" rel="nofollow">org.springframework.oxm.jibx.JibxMarshaller</a> </li></ul><br><p>  Como resultado, temos um c√≥digo perdido que precisa ser compilado (√†s vezes v√°rias vezes), que ocorre no ReserverCodeCache, que precisa ser testado e que simplesmente vagueia de classe para classe sem quase nenhuma altera√ß√£o. </p><br><p>  Os desenvolvedores, por sua vez, gostam muito de escrever algo como </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = Arrays.asList(array).indexOf(obj); <span class="hljs-comment"><span class="hljs-comment">//  boolean contains = Arrays.asList(array).contains(obj); //    boolean contains = Arrays.stream(names).anyMatch(nm -&gt; nm.equals(name));</span></span></code> </pre> <br><p>  Gostaria de introduzir m√©todos de utilidade generalizados no JDK e us√°-los em qualquer lugar, conforme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">sugerido</a> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">O patch √©</a> t√£o simples quanto dois centavos: </p><br><p>  1) implementa√ß√µes de <code>List.indexOf()</code> e <code>List.lastIndexOf()</code> movem-se para <code>java.util.Arrays</code> <br>  2) em vez disso, <code>Arrays.indexOf()</code> e <code>Arrays.lastIndexOf()</code> s√£o chamados, respectivamente </p><br><p>  Parece que o que poderia dar errado?  O ganho dessa abordagem √© [aparentemente] √≥bvio.  Mas o artigo √© sobre falhas, ent√£o pense no que pode dar errado. </p><br><blockquote>  - Quem √© respons√°vel? <br>  - Especialistas respons√°veis ‚Äã‚ÄãMartin Buchholz e Paul Sandoz </blockquote><br><div class="spoiler">  <b class="spoiler_title">IMHO, um pouco tenso, mas mesmo assim</b> <div class="spoiler_text"><p>  Martin Buchholz: </p><br><blockquote>  Sergey, eu meio que mantenho todas essas classes de cole√ß√£o e, ocasionalmente, tamb√©m queria ter os m√©todos indexOf em Array.java.  Mas: <br><br>  Matrizes geralmente s√£o desencorajadas.  Quaisquer novos m√©todos est√°ticos em Arrays (ou, onde eu realmente os quero, no pr√≥prio objeto de matriz! Requer uma altera√ß√£o na linguagem java!) Ir√° encontrar resist√™ncia. <br><br>  N√≥s lamentamos o suporte a nulos em cole√ß√µes, para que classes mais recentes, como ArrayDeque, n√£o as suportem. <br><br>  Outra variante que os usu√°rios podem querer √© que tipo de compara√ß√£o de igualdade usar. <br><br>  N√≥s lamentamos ter ArrayList com √≠ndice inicial baseado em zero - teria sido melhor ter o comportamento da matriz circular do ArrayDeque desde o primeiro dia. <br><br>  O c√≥digo para pesquisar fatias de matriz √© muito pequeno, portanto voc√™ n√£o est√° economizando muito.  √â f√°cil cometer um erro de um por um, mas isso tamb√©m √© verdade para uma API Arrays. </blockquote><p>  Paul Sandoz: </p><br><blockquote>  Eu n√£o iria t√£o longe a ponto de dizer que as matrizes s√£o desencorajadas, eu a giraria positivamente como "use com cuidado", pois s√£o espinhosas, por exemplo, sempre mut√°veis. Elas certamente poderiam ser melhoradas. Eu ficaria muito feliz em ver as matrizes implementarem uma matriz comum 'ish interface, poderemos progredir ap√≥s os tipos de valor sedimentos. <br><br>  Quaisquer novas adi√ß√µes ao Arrays seriam encontradas com alguma resist√™ncia, pelo menos por mim :-) Isso nunca adiciona apenas um ou dois m√©todos, muitos outros querem que o passeio tamb√©m (todos os primitivos e variantes de intervalo).  Portanto, qualquer novo recurso precisa ser suficientemente ben√©fico e, nesse caso, n√£o acho que os benef√≠cios sejam fortes o suficiente (como uma poss√≠vel press√£o no cache do c√≥digo de redu√ß√£o). </blockquote><p>  Paul. </p></div></div><br><p>  Correspond√™ncia: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">http://mail.openjdk.java.net/pipermail/core-libs-dev/2018-March/051968.html</a> </p><br><p>  A moral dessa f√°bula √© a seguinte: seu peda√ßo engenhoso pode ser abatido para revis√£o simplesmente porque eles n√£o ter√£o nenhum valor especial nele.  Bem, sim, h√° um c√≥digo duplicado, mas isso n√£o incomoda ningu√©m, ent√£o deixe-o vivo. </p><br><h4 id="uluchsheniya-dlya-arraylist-a-ih-est-u-menya">  Melhorias para ArrayList?  Eu tenho eles </h4><br><p><del>  Ciclomotor </del>  o patch n√£o √© meu, vou post√°-lo para voc√™ pensar.  A proposta em si foi apresentada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">aqui</a> e parece muito atraente.  Veja voc√™ mesmo: </p><br><div class="spoiler">  <b class="spoiler_title">Altera√ß√£o proposta</b> <div class="spoiler_text"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Link</a> </p></div></div><br><p>  A olho nu, a proposta √© muito, muito l√≥gica.  Voc√™ pode medir o desempenho usando uma <a href="" rel="nofollow">refer√™ncia</a> simples: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Benchmark) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayListBenchmark</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Benchmark) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Data</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Param</span></span>({<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-string"><span class="hljs-string">"100"</span></span>, <span class="hljs-string"><span class="hljs-string">"1000"</span></span>, <span class="hljs-string"><span class="hljs-string">"10000"</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size; ArrayList&lt;Integer&gt; arrayRandom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;Integer&gt;(size); <span class="hljs-meta"><span class="hljs-meta">@Setup</span></span>(Level.Invocation) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initArrayList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); rand.setSeed(System.currentTimeMillis()); <span class="hljs-comment"><span class="hljs-comment">// Populate the ArrayList with size-5 elements for (int i = 0; i &lt; size - 5; i++) { Integer r = rand.nextInt() % 256; arrayRandom.add(r); } } } @Benchmark public ArrayList construct_new_array_list(Data d) { ArrayList al = new ArrayList(d.arrayRandom); // once a new ArrayList is created add a new element al.add(new Integer(900)); return al; } }</span></span></code> </pre> <br><p>  Resumo: </p><br><pre> <code class="plaintext hljs">Benchmark (size) Mode Cnt Score Error Units  construct_new_array_list 10 thrpt 25 388.212 ¬± 23.110 ops/s construct_new_array_list 100 thrpt 25 90.208 ¬± 7.995 ops/s construct_new_array_list 1000 thrpt 25 23.289 ¬± 1.687 ops/s construct_new_array_list 10000 thrpt 25 7.659 ¬± 0.560 ops/s  construct_new_array_list 10 thrpt 25 562.678 ¬± 37.370 ops/s construct_new_array_list 100 thrpt 25 119.791 ¬± 13.232 ops/s construct_new_array_list 1000 thrpt 25 33.811 ¬± 3.812 ops/s construct_new_array_list 10000 thrpt 25 10.889 ¬± 0.564 ops/s</code> </pre> <br><p>  Nada mal para uma mudan√ßa t√£o simples.  O principal √© que parece n√£o haver problema.  Honestamente, crie uma matriz, copie honestamente os dados e n√£o se esque√ßa do tamanho.  Agora eles devem definitivamente aceitar o patch! </p><br><div class="spoiler">  <b class="spoiler_title">Mas l√° estava</b> <div class="spoiler_text"><p>  Martin Buchholz: </p><br><blockquote>  N√£o h√° d√∫vida de que podemos otimizar o caso de ArrayList -&gt; ArrayList, mas e todas as outras implementa√ß√µes de Collection?  ArrayDeque e CopyOnWriteArrayList v√™m √† mente. <br>  ArrayList √© uma classe popular a ser usada para fazer c√≥pias de cole√ß√µes.  Onde voc√™ para? <br><br>  Uma subclasse patol√≥gica de ArrayList pode decidir n√£o armazenar elementos na matriz de backup, com a quebra resultante. <br><br>  A solu√ß√£o aben√ßoada para o problema de c√≥pia de lista √© provavelmente List.copyOf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/List.html#copyOf(java .util.Collection</a> ), que pode fazer a otimiza√ß√£o que voc√™ espera. </blockquote><p>  Alan Bateman </p><br><blockquote>  ArrayList n√£o √© final; portanto, √© poss√≠vel que algu√©m o tenha estendido para usar algo diferente de elementData.  Pode ser mais seguro usar a identidade da classe do que instanceof. </blockquote></div></div><br><p>  Nada me pro√≠be desassociar de <code>ArrayList</code> e armazenar dados em uma lista vinculada.  Ent√£o, uma <code>c instanceof ArrayList</code> retornar√° a verdade, chegaremos √† √°rea de c√≥pia e cairemos com seguran√ßa. </p><br><p>  A moral dessa f√°bula √© a seguinte: uma <em>poss√≠vel</em> mudan√ßa de comportamento pode ser a causa do fracasso.  Em outras palavras, √© preciso ter em mente a probabilidade at√© da mudan√ßa mais absurda, se for permitida pelos meios da linguagem.  E sim, poderia ter dado certo se <code>ArrayList</code> tivesse declarado <code>final</code> desde o in√≠cio. </p><br><h4 id="snova-specifikaciya">  Especifica√ß√£o novamente </h4><br><p>  Ao depurar meu aplicativo, acidentalmente ca√≠ nas entranhas do Spring e encontrei o seguinte <a href="" rel="nofollow">c√≥digo</a> : </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//      paramTypes for (Constructor&lt;?&gt; candidate : candidates) { Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes(); if (constructorToUse != null &amp;&amp; argsToUse != null &amp;&amp; argsToUse.length &gt; paramTypes.length) { // Already found greedy constructor that can be satisfied -&gt; // do not look any further, there are only less greedy constructors left. break; } if (paramTypes.length &lt; minNrOfArgs) { continue; }</span></span></code> </pre> <br><p>  Felizmente, entrando em <code>java.lang.reflect.Constructor.getParameterTypes()</code> rolei o c√≥digo um pouco mais baixo e achei um lindo: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;?&gt;[] getParameterTypes() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parameterTypes.clone(); } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritDoc</span></span></span><span class="hljs-comment">} * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@since</span></span></span><span class="hljs-comment"> 1.8 */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParameterCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parameterTypes.length; }</code> </pre> <br><p>  Voc√™ v√™ sim?  Se precisarmos descobrir o n√∫mero de argumentos do construtor / m√©todo, chame <code>java.lang.reflect.Method.getParameterCount()</code> e fa√ßa isso sem copiar a matriz.  Verifique se o jogo vale a pena no caso mais simples, no qual o m√©todo n√£o possui par√¢metros: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Thread) <span class="hljs-meta"><span class="hljs-meta">@BenchmarkMode</span></span>(Mode.AverageTime) <span class="hljs-meta"><span class="hljs-meta">@OutputTimeUnit</span></span>(TimeUnit.NANOSECONDS) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodToStringBenchmark</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Method method; <span class="hljs-meta"><span class="hljs-meta">@Setup</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ method = getClass().getMethod(<span class="hljs-string"><span class="hljs-string">"toString"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParameterCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> method.getParameterCount(); } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParameterTypes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> method.getParameterTypes().length; } }</code> </pre> <br><p>  Na minha m√°quina e com o JDK 11, acontece assim: </p><br><pre> <code class="plaintext hljs">Benchmark Mode Cnt Score Error Units getParameterCount avgt 25 2,528 ¬± 0,085 ns/op getParameterCount:¬∑gc.alloc.rate avgt 25 ‚âà 10‚Åª‚Å¥ MB/sec getParameterCount:¬∑gc.alloc.rate.norm avgt 25 ‚âà 10‚Åª‚Å∑ B/op getParameterCount:¬∑gc.count avgt 25 ‚âà 0 counts getParameterTypes avgt 25 7,299 ¬± 0,410 ns/op getParameterTypes:¬∑gc.alloc.rate avgt 25 1999,454 ¬± 89,929 MB/sec getParameterTypes:¬∑gc.alloc.rate.norm avgt 25 16,000 ¬± 0,001 B/op getParameterTypes:¬∑gc.churn.G1_Eden_Space avgt 25 2003,360 ¬± 91,537 MB/sec getParameterTypes:¬∑gc.churn.G1_Eden_Space.norm avgt 25 16,030 ¬± 0,045 B/op getParameterTypes:¬∑gc.churn.G1_Old_Gen avgt 25 0,004 ¬± 0,001 MB/sec getParameterTypes:¬∑gc.churn.G1_Old_Gen.norm avgt 25 ‚âà 10‚Åª‚Åµ B/op getParameterTypes:¬∑gc.count avgt 25 2380,000 counts getParameterTypes:¬∑gc.time avgt 25 1325,000 ms</code> </pre> <br><p>  O que podemos fazer sobre isso?  Podemos procurar o uso do antipadr√£o <code>Method.getParameterTypes().length</code> no JDK (pelo menos em <code>java.base</code> ) e substitu√≠-lo onde for necess√°rio: </p><br><p> <code>java.lang.invoke.MethodHandleProxies</code> </p> <br><p><img src="https://habrastorage.org/webt/l_/3j/h1/l_3jh1hu3swdedxqktlxboz0tu0.png"></p><br><p> <code>java.util.concurrent.ForkJoinTask</code> </p> <br><p><img src="https://habrastorage.org/webt/0o/rt/q7/0ortq71mnf3-bwsa4wyi-jmzf5y.png"></p><br><p> <code>java.lang.reflect.Executable</code> </p> <br><p><img src="https://habrastorage.org/webt/sm/_h/pm/sm_hpm8eahlmqavobjqg9gejvse.png"></p><br><p> <code>sun.reflect.annotation.AnnotationType</code> </p> <br><p><img src="https://habrastorage.org/webt/yw/bv/il/ywbvil_doi3fzy6uzkpcm42g6zu.png"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">O patch</a> foi enviado junto com uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">carta de apresenta√ß√£o</a> . </p><br><p>  De repente, verificou-se que durante v√°rios anos houve uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">tarefa semelhante,</a> e at√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">mudan√ßas foram</a> preparadas para isso.  Os coment√°rios observaram um aumento de desempenho bastante decente para essas mudan√ßas simples.  No entanto, eles e meu adesivo est√£o limpos at√© agora e ficam im√≥veis.  Porque  Provavelmente porque os desenvolvedores est√£o ocupados demais com coisas mais necess√°rias e estupidamente n√£o colocam as m√£os nelas. </p><br><p>  A moral desta f√°bula √© a seguinte: suas mudan√ßas engenhosas podem congelar simplesmente devido √† falta de trabalhadores. </p><br><p>  Mas este n√£o √© o fim!  Durante a discuss√£o sobre a racionalidade da substitui√ß√£o descrita em outros projetos, camaradas mais experientes apresentaram uma contraproposta: talvez voc√™ n√£o deva fazer a substitui√ß√£o de <code>Method.getParameterTypes().length -&gt; Method.getParameterCount()</code> com suas m√£os, mas confiar isso ao compilador?  Isso √© poss√≠vel e ser√° "legal"? </p><br><p>  Vamos tentar verificar usando o teste: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arrayClone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object[] objects = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[<span class="hljs-number"><span class="hljs-number">3</span></span>]; objects[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"azaza"</span></span>; objects[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">365</span></span>; objects[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">9876L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object[] clone = objects.clone(); assertEquals(objects.length, clone.length); assertSame(objects[<span class="hljs-number"><span class="hljs-number">0</span></span>], clone[<span class="hljs-number"><span class="hljs-number">0</span></span>]); assertSame(objects[<span class="hljs-number"><span class="hljs-number">1</span></span>], clone[<span class="hljs-number"><span class="hljs-number">1</span></span>]); assertSame(objects[<span class="hljs-number"><span class="hljs-number">2</span></span>], clone[<span class="hljs-number"><span class="hljs-number">2</span></span>]); }</code> </pre> <br><p>  que passa e mostra que, se a matriz clonada n√£o sair do escopo, ela poder√° ser exclu√≠da porque o acesso a qualquer elemento de suas c√©lulas ou ao campo de <code>length</code> pode ser obtido a partir do original. </p><br><p>  O JDK pode fazer isso?  Verificamos: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Thread) <span class="hljs-meta"><span class="hljs-meta">@BenchmarkMode</span></span>(Mode.AverageTime) <span class="hljs-meta"><span class="hljs-meta">@OutputTimeUnit</span></span>(TimeUnit.NANOSECONDS) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayAllocationEliminationBenchmark</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">baseline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[length].length; } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">baselineClone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[length].clone().length; } }</code> </pre> <br><p>  Sa√≠da para JDK 13: </p><br><pre> <code class="plaintext hljs">Benchmark Mode Cnt Score Error Units baseline avgt 50 6,135 ¬± 0,140 ns/op baseline:¬∑gc.alloc.rate.norm avgt 50 56,000 ¬± 0,001 B/op clone avgt 50 18,359 ¬± 0,619 ns/op clone:¬∑gc.alloc.rate.norm avgt 50 112,000 ¬± 0,001 B/op</code> </pre> <br><p>  Acontece que o openjdk n√£o sabe como lan√ßar um <code>new int[length]</code> , diferente do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Graal</a> , hehe: </p><br><pre> <code class="plaintext hljs">Benchmark Mode Cnt Score Error Units baseline avgt 25 2,470 ¬± 0,156 ns/op baseline:¬∑gc.alloc.rate.norm avgt 25 0,005 ¬± 0,008 B/op lone avgt 25 13,086 ¬± 1,059 ns/op lone:¬∑gc.alloc.rate.norm avgt 25 112,113 ¬± 0,115 B/op</code> </pre> <br><p>  Acontece que voc√™ pode ajustar um pouco o compilador de otimiza√ß√£o do openjdk para que ele possa fazer o que o Graal pode fazer.  Como nem todos podem entrar em um an√∫ncio positivo no c√≥digo da VM e registrar algo significativo, eu me limitei a uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">carta</a> na qual eu declarava minhas observa√ß√µes. </p><br><p>  Acabou, e existem v√°rias sutilezas.  Vladimir Ivanov <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">indica</a> que: </p><br><blockquote>  Considerando que n√£o h√° como aumentar / diminuir as matrizes Java, <br>  A transforma√ß√£o "cloned_array.length =&gt; original_array.length" est√° correta <br>  independentemente de a variante clonada escapar ou n√£o. <br><br>  Al√©m disso, a transforma√ß√£o j√° est√° l√°: <br><br>  <a href="" rel="nofollow">http://hg.openjdk.java.net/jdk/jdk/file/tip/src/hotspot/share/opto/memnode.cpp#l2388</a> <br><br>  N√£o analisei os benchmarks que voc√™ mencionou, mas parece que <br>  O acesso cloned_array.length n√£o √© a raz√£o pela qual a matriz clonada ainda √© <br>  l√°. <br><br>  Em rela√ß√£o √†s suas outras id√©ias, redirecione os acessos da inst√¢ncia clonada para <br>  original √© problem√°tico (no caso geral), pois o compilador precisa provar <br>  n√£o houve altera√ß√µes nas duas vers√µes e os acessos indexados tornam ainda mais <br>  mais dif√≠cil.  E os pontos seguros tamb√©m causam problemas (para rematerializa√ß√£o). <br><br>  Mas concordo que seria bom cobrir (pelo menos) casos simples de <br>  c√≥pia defensiva. </blockquote><p>  Ou seja, bater em um clone parece ser poss√≠vel, e n√£o particularmente dif√≠cil.  Mas com a convers√£o </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[arrayLength].length;</code> </pre> <br><p>  -&gt; </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len = arrayLength;</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">dificuldades</a> surgem: </p><br><blockquote>  N√£o eliminamos aloca√ß√µes de matrizes que n√£o possuem um comprimento conhecido <br>  porque eles podem causar uma exce√ß√£o NegativeArraySize.  Nesse caso, n√≥s <br>  deve ser capaz de provar que o comprimento √© positivo. <br><br>  Enfim - Eu tenho um patch quase pronto que substitui o array n√£o utilizado <br>  aloca√ß√µes com uma guarda adequada. </blockquote><p>  Em outras palavras, voc√™ n√£o pode simplesmente tirar e jogar fora a cria√ß√£o de uma matriz, porque, de acordo com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">especifica√ß√£o, a</a> execu√ß√£o <em>deve</em> gerar uma <code>NegativeArraySizeException</code> e n√£o h√° nada que possamos fazer sobre isso: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arrayWithNwgativeSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newLen = -<span class="hljs-number"><span class="hljs-number">3</span></span>; length = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[newLen].length; <span class="hljs-comment"><span class="hljs-comment">//  new Object[newLen]  fail(); } catch (NegativeArraySizeException e) { assert length == 0; } }</span></span></code> </pre> <br><p>  Por que o Graal foi capaz?  Acho que o motivo √© que o valor do campo <code>length</code> no benchmark acima era constante e sempre igual a 10, o que permitiu ao criador de perfil concluir que a verifica√ß√£o de um valor negativo n√£o √© necess√°ria, o que significa que ele pode ser removido junto com a cria√ß√£o do pr√≥prio array.  Corrija nos coment√°rios se eu cometi um erro. </p><br><p>  Isso √© tudo por hoje :) Adicione seus exemplos nos coment√°rios, vamos entender. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433174/">https://habr.com/ru/post/pt433174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433144/index.html">Lan√ßamento do .NET Core 2.2. Novidades (1 de 3)</a></li>
<li><a href="../pt433146/index.html">[competi√ß√£o] Os 25 principais consoles de jogos (abane os velhos tempos)</a></li>
<li><a href="../pt433152/index.html">Transferimos o Zimbra da infraestrutura de servidor √∫nico para v√°rios servidores</a></li>
<li><a href="../pt433168/index.html">Por que um programador faz um est√°gio na cozinha - uma conversa com o Dodo Pizza sobre gemba, .NET e abertura</a></li>
<li><a href="../pt433172/index.html">Apertamos o modo multijogador no jogo para celular "Crie palavras de palavras" no iOS e Android escritas em C ++</a></li>
<li><a href="../pt433176/index.html">API remota do Docker de autentica√ß√£o de certificado com verifica√ß√£o de revoga√ß√£o</a></li>
<li><a href="../pt433178/index.html">Como restauramos um arquivo .wav danificado</a></li>
<li><a href="../pt433180/index.html">Resolvendo problemas de tipo de dados no Ruby ou Torne os dados confi√°veis ‚Äã‚Äãnovamente</a></li>
<li><a href="../pt433182/index.html">√â poss√≠vel treinar um agente para negociar no mercado de a√ß√µes com refor√ßos? Implementa√ß√£o da linguagem R</a></li>
<li><a href="../pt433184/index.html">Lan√ßamento do ASP.NET Core 2.2. Novidades (2 de 3)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>