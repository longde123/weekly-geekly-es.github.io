<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèΩ üóæ üêπ Nous v√©rifions la vuln√©rabilit√© ferm√©e et obtenons quatre nouveaux CVE üí∞ üêé üâë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On m'a demand√© de continuer la s√©rie d'articles sur la fermeture des vuln√©rabilit√©s et sur la fa√ßon dont elles sont ferm√©es (notre premier article peu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous v√©rifions la vuln√©rabilit√© ferm√©e et obtenons quatre nouveaux CVE</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/430408/">  On m'a demand√© de continuer la s√©rie d'articles sur la fermeture des vuln√©rabilit√©s et sur la fa√ßon dont elles sont ferm√©es (notre premier article peut √™tre lu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ).  La derni√®re fois, nous avons d√©couvert que m√™me si le fabricant signale la fermeture de la vuln√©rabilit√©, alors en r√©alit√©, tout pourrait ne pas l'√™tre. <br><br><img src="https://habrastorage.org/webt/me/ds/nj/medsnjr0lbtdxy9vots_csy_bbg.jpeg"><br><a name="habracut"></a><br><h3>  Crit√®res de s√©lection: </h3><br>  Les crit√®res de s√©lection pour les vuln√©rabilit√©s consid√©r√©es cette fois √©taient les m√™mes (√† l'exception que cette fois, je voulais examiner d'autres types de vuln√©rabilit√©s): <br><br><ul><li>  il devrait y avoir un exploit - nous voulons voir qu'avant la mise √† jour, tout √©tait <s>bien</s> mal <s>exploit√©</s> , et apr√®s cela il est devenu bon; </li><li>  la vuln√©rabilit√© doit √™tre critique (id√©alement RCE) et avoir un score √©lev√©; </li><li>  le produit doit √™tre open source; </li><li>  le produit ne doit pas √™tre abandonn√© et utilis√© activement; </li><li>  la vuln√©rabilit√© devrait √™tre relativement nouvelle; </li><li>  comme toujours, l'essentiel est que nous-m√™mes nous int√©ressions. </li></ul><br><h3>  Quoi et comment j'ai choisi: </h3><br>  Je suis all√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vulners.com</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">j'ai</a> demand√© √† montrer tous les exploits avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exploit-db.com</a> au cours des deux derni√®res semaines.  Cette fois dans la cat√©gorie Web, presque tous les exploits ont √©t√© cr√©√©s par Ihsan Sencan, mais en raison du fait qu'ils concernent le plus souvent des injections SQL dans de vieilles applications et plugins non pris en charge, je les ai supprim√©s.  Parmi les produits restants, seul l'outil de gestion de projet ProjeQtOr 7.2.5 avec la vuln√©rabilit√© CVE-2018-18924 est entr√© dans la cat√©gorie ¬´non abandonn√© et en d√©veloppement actif¬ª. <br>  Cette vuln√©rabilit√© r√©pondait √† tous les crit√®res de s√©lection: <br><br><ul><li>  il y a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exploit</a> ; </li><li>  Vuln√©rabilit√© RCE (bien qu'elle n√©cessite l'autorisation de l'utilisateur); </li><li>  le produit est assez open source; </li><li> le produit n'est pas abandonn√©, en 2018 il y avait 28 versions et seulement sourceforge.net il y avait 702 t√©l√©chargements (et la plupart des t√©l√©chargements de mise √† jour r√©solvent le probl√®me CVE, ce qui indique tr√®s probablement que les gens ont vu CVE et ont commenc√© √† mettre √† jour); </li><li>  CVE du 4 novembre, un exploit du 25 octobre, cela r√©pond aux exigences de nouveaut√©; </li><li>  J'ai regard√© le probl√®me et sa solution, je me suis int√©ress√© (plus √† ce sujet plus tard). </li></ul><br><h4>  Comprendre l'outil de gestion de projet ProjeQtOr </h4><br>  Nous lisons la description de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exploit</a> et la description <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CVE sur nist.gov</a> , nous comprenons que la version 7.2.5 n'est vuln√©rable que pour un utilisateur autoris√©.  Et aussi que vous pouvez t√©l√©charger un fichier .shtml en tant qu'image, bien que le message d'erreur <i>"Ce fichier n'est pas une image valide"</i> sera affich√©, mais le fichier sera toujours enregistr√© dans les images sur le serveur et accessible via un lien direct dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">h√¥te / fichiers / images / nom_image</a> . <br><br><img src="https://habrastorage.org/webt/8d/wu/0x/8dwu0x1uezs-x_ws7egw9szchue.png"><br><br>  L'acc√®s via un lien direct est bon, mais ici vous devez encore deviner le nom avec lequel le fichier sera t√©l√©charg√©.  Nous avons de la chance, et ce n'est pas al√©atoire, mais il est g√©n√©r√© √† partir de l'heure actuelle au format: ann√©e, mois, jour, heures, minutes, secondes.  Le r√©sultat est un tel num√©ro 20181114140320. Ensuite, l'ID utilisateur, puis le nom de fichier d'origine passent par le trait de soulignement.  Il y a pas mal d'inconnues: <br><br><ul><li>  Fuseau horaire sur le serveur </li><li>  si l'horloge du serveur est en panne; </li><li>  ID utilisateur </li></ul><br>  Et encore une fois, nous avons de la chance: si vous t√©l√©chargez une image valide, tous ces param√®tres nous seront signal√©s.  Il n'est pas difficile de passer en revue plusieurs options de liens (plusieurs, car il y a des secondes, mais il est difficile de les entrer tout de suite). <br><br><img src="https://habrastorage.org/webt/zq/ce/lh/zqcelhvlhrk7496dafoiqart2nk.png"><br><br>  En g√©n√©ral, l'obtention du nom de fichier n'est pas un probl√®me.  Nous continuons.  Et nous pensons, pourquoi ne pas simplement t√©l√©charger un script php?  Nous essayons de le t√©l√©charger, la m√™me fen√™tre appara√Æt, mais le fichier n'appara√Æt pas dans le r√©pertoire.  Il est temps de regarder le code! <br><br>  Le script uploadImage.php est responsable du t√©l√©chargement de l'image sur le serveur dans la version 7.2.5. Nous sommes int√©ress√©s par les lignes 100 √† 117. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadedFile[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>])) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { traceHack(<span class="hljs-string"><span class="hljs-string">"Try to upload php file as image in CKEditor"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ! move_uploaded_file($uploadedFile[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>], $uploadfile)) { $error = htmlGetErrorMessage(i18n(<span class="hljs-string"><span class="hljs-string">'errorUploadFile'</span></span>,<span class="hljs-string"><span class="hljs-string">'hacking ?'</span></span>)); errorLog(i18n(<span class="hljs-string"><span class="hljs-string">'errorUploadFile'</span></span>,<span class="hljs-string"><span class="hljs-string">'hacking ?'</span></span>)); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadfile)) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); } }</code> </pre> <br>  La ligne 100 est charg√©e de v√©rifier l'extension du fichier: s'il s'agit de php ou phtm, le fichier est rejet√© et non enregistr√©.  Par cons√©quent, les fichiers php n'apparaissent pas dans le r√©pertoire "files / images /".  La ligne 115 cr√©e l'erreur que nous voyons, mais ne fait rien avec le fichier. <br><br>  Eh bien, ne quittons pas l'exploit et t√©l√©chargeons le fichier avec l'extension .shtml.  Ici, il vaut la peine de faire une petite digression et de dire ce qu'est le .shtml et avec quoi il est mang√©. <br><br><h4>  SHTML et SSI </h4><br>  D√©finition Wikip√©dia: <br><br>  SSI (Server Side includes - inclusion c√¥t√© serveur) - un langage simple pour l '"assemblage" dynamique de pages Web sur le serveur √† partir des composants individuels et la livraison du document HTML re√ßu au client.  Impl√©ment√© dans le serveur Web Apache √† l'aide du module mod_include.  La fonctionnalit√© incluse dans les param√®tres par d√©faut du serveur Web vous permet d'inclure des fichiers HTML, par cons√©quent, pour utiliser les instructions, le fichier doit se terminer par l'extension .shtml, .stm ou .shtm. <br><br>  Dans vos propres mots: <br><br>  SHTML est du HTML qui peut ex√©cuter des jeux d'instructions c√¥t√© serveur.  De l'utile, il y a une fonction exec qui ex√©cute des commandes arbitraires sur le serveur (oui, nous pouvons t√©l√©charger le fichier en utilisant le code HTML et l'ex√©cuter). <br><br>  Voici un exemple de code pour ex√©cuter du code arbitraire: <br><br><pre> <code class="php hljs">&lt;!--<span class="hljs-comment"><span class="hljs-comment">#exec cmd=‚Äùls‚Äù --&gt;</span></span></code> </pre> <br>  La bonne nouvelle est que cette fonctionnalit√© n'est pas activ√©e par d√©faut sur le serveur Apache2, et pour l'activer, vous devez danser avec un tambourin.  En quelques heures de s√©lection de la configuration, j'ai pu faire fonctionner le retour des variables d'environnement, mais pas la commande.  Voici mon code SSI: <br><br><pre> <code class="php hljs">&lt;html&gt; &lt;head&gt; &lt;title&gt;thegeekstuff.com&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; Today is &lt;!--<span class="hljs-comment"><span class="hljs-comment">#echo var="DATE_LOCAL" --&gt; &lt;!--#exec cmd="ls" --&gt; &lt;/p&gt; &lt;/body&gt; &lt;/html&gt;  : Today is Wednesday, 14-Nov-2018 17:29:14 MSK [an error occurred while processing this directive]</span></span></code> </pre><br>  Si quelqu'un vous dit quoi √©crire dans la config pour qu'elle fonctionne correctement, j'adorerais la lire. <br><br><h4>  Exploiter la vuln√©rabilit√© </h4><br>  Si les √©toiles convergent, vous pouvez t√©l√©charger le fichier shtml et ex√©cuter des commandes arbitraires (ou, comme moi, voir l'heure sur le serveur). <br><br><h4>  Regarder le patch </h4><br>  La prochaine version est 7.2.6, mais il n'y a pas de changement concernant la vuln√©rabilit√© qui nous int√©resse (nist.gov tromp√© √† nouveau). <br><br>  Nous regardons la version 7.2.7 et il semble que tout soit corrig√© (les d√©veloppeurs eux-m√™mes disent que tout est corrig√© juste dans cette version).  Il y a deux changements cl√©s: <br><br>  1. Parmi les extensions interdites, "shtm" a √©t√© ajout√© (si les 4 premiers caract√®res sont tels, shtml tombe √©galement ici): <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'shtm'</span></span>) {</code> </pre> <br><br>  2. Les fichiers qui ne sont pas des images sont maintenant supprim√©s: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadfile)) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); kill($uploadfile); }</code> </pre> <br>  Il semblerait que vous pouvez diverger, car les non-images sont supprim√©es et shtml n'essaie m√™me pas de persister.  Mais je n‚Äôaimais pas toujours s‚Äôils essayaient de r√©soudre un probl√®me avec les listes noires.  Par exemple, dans certains pays, les entreprises interdisent les r√©seaux sociaux.  Cela conduit au fait que les utilisateurs commencent √† utiliser les ¬´miroirs¬ª des r√©seaux sociaux, o√π leurs noms d'utilisateur et mots de passe sont vol√©s.  Leurs mots de passe co√Øncident avec les mots de passe d'entreprise, mais il peut alors y avoir des probl√®mes bien plus importants qu'un employ√© feuilletant un instagram autour d'une tasse de caf√©. <br><br>  Dans la programmation Web et sa s√©curit√©, les listes noires sont √©galement mauvaises. <br><br><h4>  Contournez la liste noire de ProjeQtOr </h4><br>  Eh bien, tout est simple.  Tout d'abord, voyons quels fichiers Apache2 + PHP peut interpr√©ter avec les param√®tres par d√©faut (tout a √©t√© install√© sur Ubuntu 16.04 avec un r√©f√©rentiel mis √† jour).  La directive ¬´FilesMatch¬ª est responsable de la capacit√© d'interpr√©ter les fichiers.  Nous effectuons une recherche avec la commande "grep -r" &lt;FilesMatch "/ etc / apache2" et voici le r√©sultat: <br><br><pre> <code class="php hljs">/etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">".+\.ph(p[3457]?|t|tml)$"</span></span>&gt; /etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">".+\.phps$"</span></span>&gt; /etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"^\.ph(p[3457]?|t|tml|ps)$"</span></span>&gt; /etc/apache2/sites-available/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl.conf: &lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"\.(cgi|shtml|phtml|php)$"</span></span>&gt; /etc/apache2/apache2.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"^\.ht"</span></span>&gt;</code> </pre> <br>  Dans la configuration default-ssl.conf, toutes les extensions sont simplement list√©es dans leur int√©gralit√©; ce sont: cgi, shtml, phtml, php.  H√©las, tout sauf cgi est filtr√© dans ProjeQtOr. <br><br>  La configuration php7.0.conf est beaucoup plus int√©ressante, les extensions y sont d√©finies par l'expression r√©guli√®re.  Nous obtenons: <br><table><tbody><tr><th>  Extension </th><th>  Ce qui est filtr√© </th></tr><tr><td>  php </td><td>  substr ($ ext, 0,3) == 'php' </td></tr><tr><td>  php3 </td><td>  substr ($ ext, 0,3) == 'php' </td></tr><tr><td>  php4 </td><td>  substr ($ ext, 0,3) == 'php' </td></tr><tr><td>  php5 </td><td>  substr ($ ext, 0,3) == 'php' </td></tr><tr><td>  php7 </td><td>  substr ($ ext, 0,3) == 'php' </td></tr><tr><td>  pht </td><td>  RIEN </td></tr><tr><td>  phtml3 </td><td>  substr ($ ext, 0.4) == 'phtm' </td></tr></tbody></table><br>  G√©nial, une extension de fichier non filtr√©e est trouv√©e.  Nous v√©rifions qu'il est vraiment interpr√©t√©. <br><br>  Cr√©ez un fichier test.pht avec le contenu suivant: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> phpinfo();</code> </pre> <br>  Nous allons √† ce fichier dans le navigateur et voyons des informations sur le php install√©.  Remarquablement, la liste noire a √©t√© contourn√©e, tandis que pour les param√®tres non par d√©faut, pour une raison quelconque, d'autres extensions d'interpr√©tation pourraient √™tre autoris√©es. <br><br>  Nous chargeons notre fichier de test dans l'outil de gestion de projet ProjeQtOr.  Bien s√ªr, nous obtenons une erreur, car ce n'est pas une image (dans la version ant√©rieure √† 7.2.7, nous avons d√©j√† l'ex√©cution de code sur le serveur, car changer phpinfo en ex√©cutant des commandes n'est pas difficile).  Dans la version 7.2.7, le fichier est supprim√© et le code n'est pas ex√©cut√©. <br><br>  Mais nous ne sommes pas f√¢ch√©s et ne contournons pas le contr√¥le de l'image. <br><br><h4>  Image PHP </h4><br>  La v√©rification si le fichier t√©l√©charg√© est une image dans l'outil de gestion de projet ProjeQtOr est effectu√©e par la fonction getimagesize, qui regarde simplement l'en-t√™te du fichier transf√©r√©. <br><br>  Profitant du fait qu'il peut y avoir des ordures dans le fichier php et que l'interpr√©tation du code php ne commence qu'avec les caract√®res ¬´&lt;? Php¬ª, nous √©crivons un petit code qui √©crit d'abord l'image, puis le code php dont nous avons besoin.  Comme image, nous enverrons une capture d'√©cran de la fen√™tre d'erreur.  3 lignes de code python et vous avez termin√©: <br><br><pre> <code class="python hljs">data = open (<span class="hljs-string"><span class="hljs-string">'test.png'</span></span>,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() data += open (<span class="hljs-string"><span class="hljs-string">'test.pht'</span></span>,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() open (<span class="hljs-string"><span class="hljs-string">'new_pht_png.pht'</span></span>,<span class="hljs-string"><span class="hljs-string">'wb'</span></span>).write(data)</code> </pre> <br>  Vous pourriez probablement √©crire un en-t√™te d'image valide au d√©but du fichier, mais c'est plus facile, et plus encore, l'image est affich√©e dans tous les visualiseurs. <br><br>  Nous t√©l√©chargeons cette cr√©ation sur le serveur et, voil√†, elle est charg√©e (et affich√©e dans la visionneuse sous forme d'image), et il est √©galement agr√©able de voir le nom complet avec lequel ce fichier a √©t√© t√©l√©charg√©. <br><br><img src="https://habrastorage.org/webt/xi/px/mh/xipxmhyuzvcaqbxl28pcrrezd1q.png"><br><br>  Nous allons dans le fichier t√©l√©charg√© <a href="">localhost / files / images / 20181114171730_1_new_pht_png.pht</a> et voyons l'image t√©l√©charg√©e sous forme de texte, et la sortie phpinfo en dessous.  Il est clair que remplacer phpinfo par un simple shell web n'est pas difficile.  Par exemple, ceci: &lt;? Php system ($ _ GET ['cmd']); <br><br><img src="https://habrastorage.org/webt/m-/kv/ad/m-kvadznv4ev99yge_zwwsgzf6m.png"><br><br>  Une fois que vous avez commenc√© √† s√©lectionner les t√©l√©chargements de fichiers, vous devez terminer le travail et voir o√π il y a d'autre t√©l√©chargement de fichiers avec ou sans listes noires. <br><br><h4>  Un autre t√©l√©chargement de fichier </h4><br>  Nous regarderons dans la derni√®re version disponible.  En supposant que vous utilisez la m√™me fonction pour t√©l√©charger des fichiers comme auparavant, c'est-√†-dire  move_uploaded_file, nous le recherchons dans le r√©pertoire du projet "grep -r" move_uploaded_file "./".  Nous obtenons les 5 fichiers suivants: <br><br>  ./tool/uploadImage.php <br>  ./tool/saveDocumentVersion.php <br>  ./tool/uploadPlugin.php <br>  ./tool/import.php <br>  ./tool/saveAttachment.php <br><br>  File uploadImage.php - d√©j√† regard√©. <br>  File saveDocumentVersion.php - t√©l√©charge les versions des documents (comme son nom l'indique).  Nous essayons de t√©l√©charger un document et de le regarder (pour commencer, nous chargerons toujours une image).  Apr√®s le t√©l√©chargement, nous voyons que l'extension .1 est ajout√©e au fichier.  Nous regardons dans le code comment le nom est obtenu (cela se fait √† la ligne 229): <br><br><pre> <code class="php hljs">$uploadfile = $dv-&gt;getUploadFileName();</code> </pre> <br>  La fonction getUploadFileName est d√©clar√©e dans le fichier DocumentVersionMain.php.  L√†, √† la ligne 227, nous voyons que ¬´.¬ª Est ajout√© au nom renvoy√©.  et l'ID du document.  Nous ne pouvons pas contourner m√™me le point ajout√©: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $uploaddir . $paramPathSeparator . $fileName . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id;</code> </pre> <br>  Le fichier uploadPlugin.php n'est accessible qu'aux administrateurs et le fait que le plugin puisse avoir un mauvais code est tr√®s logique et difficile √† √©liminer sans avoir √† entrer la validation du plugin (comme le font les CMS populaires).  Bien s√ªr, lorsque vous essayez de t√©l√©charger quelque chose, il se charge avec succ√®s, puis il est ex√©cut√©. <br><br>  Le fichier import.php n'est √©galement disponible que pour les administrateurs.  Lors du t√©l√©chargement d'un fichier, on nous dit qu'il doit s'agir d'un fichier csv ou d'un fichier xlsx.  Bien s√ªr, nous essayons de charger le fichier php et voyons une erreur: <br><br><h4>  ERREUR - Le type de fichier fourni et le format de fichier s√©lectionn√© ne correspondent pas </h4><br>  Importation abandonn√©e <br><br>  Le probl√®me est que, comme dans le bogue d'origine de CVE, le fichier n'est pas supprim√©, mais reste disponible dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">localhost / files / attach / import / test.php</a> . <br><br>  Le fichier saveAttachment est utilis√© lors du chargement de pi√®ces jointes (par exemple, lors du chargement de votre propre image).  Le script PHP n'y rampe pas, car il y a une protection du formulaire: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'shtm'</span></span>) { $attachment‚ÜífileName.=<span class="hljs-string"><span class="hljs-string">".projeqtor"</span></span>;</code> </pre> <br>  il s'av√®re que les fichiers d'extension php *, phtm *, shtm * l'extension ".projeqtor" est ajout√©e, c'est-√†-dire, √©videmment notre fichier pht y rampera (m√™me sans explorer les images).  Nous essayons, et nous obtenons tout √† l'adresse <a href="">localhost / files / attach / attachment_1 / test.pht</a> . <br><br>  R√©sultat total de cinq emplacements de t√©l√©chargement de fichiers rapidement trouv√©s: <br><br><ul><li>  r√©ussi √† charger le script php ou pht 4 fois; </li><li>  la validation de la liste noire est en deux; </li><li>  la validation de la liste blanche n'est nulle part; </li><li>  une fois n'a pas r√©ussi √† t√©l√©charger le fichier (n'a pas pu t√©l√©charger, mais n'a pas pu s'ex√©cuter), car  l'expansion changeait </li></ul><br><h3>  Conclusions sur l'outil de gestion de projet ProjeQtOr et CVE-2018-18924 </h3><br><br><ul><li>  la vuln√©rabilit√© signal√©e a √©t√© pratiquement √©limin√©e; </li><li>  il existe d'autres vuln√©rabilit√©s dans le code (signal√©es aux d√©veloppeurs, et ils ont m√™me promis des listes blanches d'extensions); </li><li>  une configuration correcte du serveur Apache2 pourrait nous sauver de tout (limiter les formats ex√©cutables aux seuls n√©cessaires, interdire l'ex√©cution de scripts dans les dossiers utilisateurs); </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nist.gov</a> ne <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contient</a> pas la derni√®re version vuln√©rable. </li></ul><br><h3>  Note de ma√Ætresse </h3><br><ul><li>  refuser les listes noires dans la mesure du possible (je ne sais pas o√π cela est impossible); </li><li>  soyez prudent et attentif lors du traitement des fichiers t√©l√©charg√©s (il vaut mieux qu'ils soient au m√™me endroit, et non r√©partis par 5); </li><li>  un serveur Web correctement configur√© √©vite de nombreux probl√®mes dans le code du projet (il est important d'√©crire du code et de bien configurer le serveur). </li></ul><br><h3>  R√©ponse d√©taill√©e des d√©veloppeurs </h3><br>  La premi√®re r√©ponse des d√©veloppeurs √©tait quelque chose comme ¬´nous avons tout corrig√©, alors voyez le code corrig√©¬ª.  J'ai d√ª peindre en d√©tail o√π se trouvent certains probl√®mes et comment ils peuvent √™tre exploit√©s. <br><br>  Il a ensuite re√ßu une r√©ponse d√©taill√©e: ¬´oui, il y a des probl√®mes, et ils seront corrig√©s dans la version 7.3.0.  Des listes blanches seront √©galement ajout√©es pour les images √† la fois pour xlslx et csv. ¬ª  Ils ont √©galement √©crit qu'ils avaient recommand√© d'ajouter les r√©pertoires ¬´pi√®ces jointes¬ª et ¬´documents¬ª en dehors de l'acc√®s Web dans les instructions d'installation. <br><br>  Les d√©veloppeurs m'ont permis d'enregistrer CVE et d'√©crire un article apr√®s la mise √† jour (qui est sorti et est disponible en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t√©l√©chargement</a> ). <br><br><h3>  Conclusion </h3><br>  Comme je l'ai √©crit au d√©but, pas mal de gens ont t√©l√©charg√© la mise √† jour d√©cidant CVE (plus de 500 t√©l√©chargements), et c'est cool que les gens mettent √† jour leur logiciel vuln√©rable, mais c'est triste que le logiciel reste vuln√©rable. <br><br>  En cons√©quence, quatre CVE m'ont √©t√© attribu√©s ainsi qu'√† notre entreprise: CVE-2018-19307, CVE-2018-19308, CVE-2018-19309, CVE-2018-19310. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr430408/">https://habr.com/ru/post/fr430408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr430398/index.html">Comment comprendre que vous n'√™tes pas le bienvenu ou discuter des m√©thodes de retrait des travailleurs de l'entreprise</a></li>
<li><a href="../fr430400/index.html">Exp√©rience de l'utilisation d'un hybride clavier et souris dans la programmation</a></li>
<li><a href="../fr430402/index.html">Qu'est-ce que developer.android.com ne dit rien sur RecyclerView?</a></li>
<li><a href="../fr430404/index.html">Nous collectons des donn√©es sur le comportement des clients sur le site</a></li>
<li><a href="../fr430406/index.html">C ++ 20 et modules, mise en r√©seau, coroutines, gammes, graphiques. R√©sultats de la r√©union √† San Diego</a></li>
<li><a href="../fr430410/index.html">¬´Il faudra toujours se d√©velopper¬ª: un entretien avec Evgeny Kuvshinov (ManyChat) sur le d√©veloppement dans une startup</a></li>
<li><a href="../fr430412/index.html">Logique floue contre PID. Nous croisons le h√©risson et le serpent. Moteur d'a√©ronef et algorithmes de contr√¥le des centrales nucl√©aires</a></li>
<li><a href="../fr430414/index.html">Azure DevOps pour Commodore 64?</a></li>
<li><a href="../fr430418/index.html">Exp√©rience personnelle en utilisant des capteurs de proximit√© en d√©veloppement</a></li>
<li><a href="../fr430420/index.html">Conf√©rence "Contenu" - d√©sormais avec prise en charge de l'hyper-threading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>