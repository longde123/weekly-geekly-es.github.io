<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘ˆğŸ¿ ğŸš¶ğŸ¿ ğŸš Menggunakan Ansible, Terraform, Docker, Konsul, Nomad di awan (Alexey Vakhov, Uchi.ru) âœ³ï¸ ğŸ’… ğŸƒ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Artikel ini adalah transkrip laporan video dari Alexei Vakhov dari Uchi.ru â€œAwan di awanâ€ 


 Uchi.ru adalah platform online untuk pendidikan sekolah,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menggunakan Ansible, Terraform, Docker, Konsul, Nomad di awan (Alexey Vakhov, Uchi.ru)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439382/"><p>  Artikel ini adalah transkrip laporan video dari Alexei Vakhov dari Uchi.ru â€œAwan di awanâ€ </p><br><p>  Uchi.ru adalah platform online untuk pendidikan sekolah, lebih dari 2 juta siswa, kelas interaktif memutuskan bersama kami.  Semua proyek kami di-host sepenuhnya di cloud publik, 100% aplikasi bekerja dalam wadah, mulai dari yang terkecil, untuk penggunaan internal, dan berakhir dengan produksi besar dengan permintaan 1 k + per detik.  Kebetulan kami memiliki 15 kluster buruh pelabuhan terisolasi (bukan Kubernetes, sic!) Di lima penyedia cloud.  Lima belas ratus aplikasi pengguna, yang jumlahnya terus bertambah. </p><br><p>  Saya akan berbicara tentang hal-hal yang sangat spesifik: bagaimana kita beralih ke wadah, bagaimana kita mengelola infrastruktur, masalah yang kita temui, apa yang berhasil dan apa yang tidak. </p><br><p>  Selama laporan, kami akan membahas: </p><br><ul><li>  Motivasi untuk pemilihan teknologi dan fitur bisnis </li><li>  Alat: Ansible, Terraform, Docker, Github Flow, Consul, Nomad, Prometheus, Shaman - antarmuka web untuk Nomad. </li><li>  Menggunakan Federasi Cluster untuk Mengelola Infrastruktur Terdistribusi </li><li>  Peluncuran NoOps, lingkungan pengujian, sirkuit aplikasi (pengembang membuat perubahan sendiri secara praktis sendiri) </li><li>  Menghibur cerita dari latihan </li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/C7utdhh6UCk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Siapa yang peduli, tolong, di bawah kucing. </p><a name="habracut"></a><br><p>  Nama saya Alexey Vakhov.  Saya bekerja sebagai direktur teknis di Uchi.ru.  Kami host di awan publik.  Kami secara aktif menggunakan Terraform, Ansible.  Sejak itu, kami sepenuhnya beralih ke Docker.  Sangat puas.  Betapa bahagianya, betapa bahagianya kita - saya akan memberi tahu. </p><br><p><img src="https://habrastorage.org/webt/l3/zh/6x/l3zh6xrikma1bku1ks6vo7hixva.png"></p><br><p>  Perusahaan Uchi.ru bergerak dalam produksi produk untuk pendidikan sekolah.  Kami memiliki platform utama di mana anak-anak menyelesaikan masalah interaktif di berbagai mata pelajaran di Rusia, Brasil, dan Amerika Serikat.  Kami menyelenggarakan olimpiade online, kontes, klub, kamp.  Setiap tahun kegiatan ini berkembang. </p><br><p><img src="https://habrastorage.org/webt/ms/m8/8h/msm88h-eoc67vkjnokat3ssq_wo.png"></p><br><p>  Dari sudut pandang teknik, tumpukan web klasik (Ruby, Python, NodeJS, Nginx, Redis, ELK, PostgreSQL).  Fitur utamanya adalah banyak aplikasi.  Aplikasi dihosting di seluruh dunia.  Setiap hari ada peluncuran dalam produksi. </p><br><p>  Fitur kedua adalah skema kami sangat sering berubah.  Mereka meminta untuk membuat aplikasi baru, menghentikan yang lama, menambahkan cron untuk pekerjaan latar belakang.  Setiap 2 minggu ada Olimpiade baru - ini adalah aplikasi baru.  Semua itu diperlukan untuk menemani, memantau, mencadangkan.  Karena itu, lingkungannya superdinamik.  Dinamisme adalah kesulitan utama kita. </p><br><p><img src="https://habrastorage.org/webt/gm/dn/vu/gmdnvuag9g19b-bkzqbamcrwdw8.png"></p><br><p>  Unit kerja kami adalah situs.  Dalam hal penyedia cloud, ini adalah Project.  Situs kami adalah entitas yang sepenuhnya terisolasi dengan API dan subnet pribadi.  Ketika kami memasuki negara itu, kami mencari penyedia cloud lokal.  Tidak di mana-mana ada Google dan Amazon.  Kadang-kadang terjadi bahwa tidak ada API untuk penyedia cloud.  Secara lahiriah kami menerbitkan VPN dan HTTP, HTTPS ke penyeimbang.  Semua layanan lain berkomunikasi di dalam cloud. </p><br><p><img src="https://habrastorage.org/webt/vz/b6/w2/vzb6w2yehx_arktffwsjxildnhe.png"></p><br><p>  Untuk setiap situs kami telah membuat repositori Ansible kami sendiri.  Repositori memiliki hosts.yml, playbook, peran, dan 3 folder rahasia, yang akan saya bicarakan nanti.  Ini adalah terraform, ketentuan, perutean.  Kami adalah penggemar standardisasi.  Repositori kami harus selalu disebut "nama situs yang mungkin".  Kami membakukan setiap nama file, struktur internal.  Ini sangat penting untuk otomatisasi lebih lanjut. </p><br><p><img src="https://habrastorage.org/webt/v3/a0/kk/v3a0kke8aauqojk4hj5blhgwmt4.png"></p><br><p>  Kami menyiapkan Terraform satu setengah tahun yang lalu, jadi kami menggunakannya.  Terraform tanpa modul, tanpa struktur file (struktur datar digunakan).  Struktur file Terraform: 1 server - 1 file, pengaturan jaringan dan pengaturan lainnya.  Menggunakan terraform, kami menggambarkan server, drive, domain, s3-bucket, jaringan, dan sebagainya.  Terraform di situs sepenuhnya mempersiapkan setrika. </p><br><p><img src="https://habrastorage.org/webt/wq/qz/ly/wqqzly1s4_6brivoh4hkeyvexmu.png"></p><br><p>  Terraform membuat server, lalu ensemble menggulung server ini.  Karena kami menggunakan versi sistem operasi yang sama di mana-mana, kami menulis semua peran dari awal.  Peran yang memungkinkan biasanya diterbitkan di Internet untuk semua sistem operasi yang tidak berfungsi di mana pun.  Kami semua mengambil peran Ansible dan hanya meninggalkan apa yang kami butuhkan.  Peran Anonim yang Standar.  Kami memiliki 6 buku pedoman dasar.  Ketika diluncurkan, Ansible menginstal daftar perangkat lunak standar: OpenVPN, PostgreSQL, Nginx, Docker.  Kubernet yang tidak kita gunakan. </p><br><p><img src="https://habrastorage.org/webt/fh/x4/i4/fhx4i4ztn5fvmjj6uivdbkdrub8.png"></p><br><p>  Kami menggunakan Konsul + Pengembara.  Ini adalah program yang sangat sederhana.  Jalankan 2 program yang ditulis dalam Golang di setiap server.  Konsul bertanggung jawab atas Penemuan Layanan, pemeriksaan kesehatan dan nilai kunci untuk menyimpan konfigurasi.  Nomad bertanggung jawab atas penjadwalan, untuk peluncuran.  Nomad meluncurkan wadah, menyediakan peluncuran, termasuk pembaruan bergulir pada pemeriksaan kesehatan, memungkinkan Anda untuk menjalankan wadah sespan.  Cluster mudah diperluas atau sebaliknya untuk mengurangi.  Nomad mendukung cron terdistribusi. </p><br><p><img src="https://habrastorage.org/webt/dc/ic/sm/dcicsmnhzdduqbnxsdpe6ewkvws.png"></p><br><p>  Setelah kami memasuki situs, Ansible mengeksekusi playbook yang terletak di direktori ketentuan.  Playbook dalam direktori ini bertanggung jawab untuk menginstal perangkat lunak di cluster buruh pelabuhan yang digunakan administrator.  Instal prometheus, grafana, dan perangkat lunak dukun rahasia. </p><br><p>  Dukun adalah dasbor web untuk nomad.  Nomad adalah level rendah dan saya tidak ingin membiarkan pengembang di dalamnya.  Dalam dukun kami melihat daftar aplikasi, kami memberi pengembang tombol penyebaran untuk aplikasi.  Pengembang dapat mengubah konfigurasi: tambahkan wadah, variabel lingkungan, mulai layanan. </p><br><p><img src="https://habrastorage.org/webt/cm/jw/ry/cmjwryicd-9dvhlpg--bhfrfe9w.png"></p><br><p>  Dan akhirnya, komponen terakhir dari situs ini adalah perutean.  Routing disimpan dalam penyimpanan K / V dari konsul, yaitu, ada tautan antara hulu, layanan, url, dll.  Di setiap penyeimbang, ada template Konsul yang menghasilkan konfigurasi nginx dan membuatnya reload.  Suatu hal yang sangat dapat diandalkan, kami tidak pernah memiliki masalah dengannya.  Fitur skema ini adalah bahwa lalu lintas menerima nginx standar dan Anda selalu dapat melihat konfigurasi mana yang dihasilkan dan berfungsi seperti dengan nginx standar. </p><br><p><img src="https://habrastorage.org/webt/rn/ew/7g/rnew7gm_fe4gcc57clp3f41ob68.png"></p><br><p>  Dengan demikian, setiap situs terdiri dari 5 lapisan.  Dengan terraform, kami menyesuaikan perangkat keras.  Mungkin kita melakukan konfigurasi dasar dari server, menempatkan docker-cluster.  Provision menggulung perangkat lunak sistem.  Routing mengarahkan lalu lintas di dalam situs.  Aplikasi berisi aplikasi pengguna dan aplikasi administrator. </p><br><p>  Kami mendebug lapisan ini untuk waktu yang lama sehingga mereka identik mungkin.  Penyediaan, pencocokan perutean 100% antar situs.  Oleh karena itu, untuk pengembang, setiap situs sama persis. </p><br><p>  Jika profesional TI beralih dari proyek ke proyek, mereka jatuh ke lingkungan yang benar-benar khas.  Dalam keadaan tidak memungkinkan, kami tidak dapat membuat pengaturan firewall dan VPN sama untuk penyedia cloud lainnya.  Dengan jaringan, semua penyedia cloud bekerja secara berbeda.  Terraform ada di mana-mana sendiri, karena berisi desain khusus untuk setiap penyedia cloud. </p><br><p><img src="https://habrastorage.org/webt/36/kg/ti/36kgtipfv8rl9lhjevdjhhiwp5m.png"></p><br><p>  Kami memiliki 14 lokasi produksi.  Muncul pertanyaan: bagaimana cara mengelolanya?  Kami membuat situs master ke-15, di mana kami hanya mengizinkan admin.  Dia bekerja pada skema federasi. </p><br><p>  Ide itu diambil dari prometheus.  Ada mode di prometheus ketika kami menginstal prometheus di setiap situs.  Kami menerbitkan Prometheus melalui otorisasi autentikasi dasar HTTPS.  Master Prometheus hanya mengambil metrik yang diperlukan dari prometheus jarak jauh.  Hal ini memungkinkan untuk membandingkan metrik aplikasi di cloud yang berbeda, menemukan aplikasi yang paling banyak diunduh atau dibongkar.  Notifikasi terpusat (peringatan) melewati master prometheus untuk admin.  Pengembang menerima peringatan dari prometheus lokal. </p><br><p><img src="https://habrastorage.org/webt/cw/c9/yd/cwc9yd3hpmbhbxvlz0ygacktloa.png"></p><br><p>  Dukun dikonfigurasi dengan cara yang sama.  Melalui situs utama, administrator dapat menggunakan, mengkonfigurasi di situs mana pun melalui satu antarmuka.  Kami memecahkan kelas masalah yang cukup besar tanpa meninggalkan situs master ini. </p><br><p><img src="https://habrastorage.org/webt/kz/ul/hi/kzulhi1jrz8c3bssubwqzremd6g.png"></p><br><p>  Saya akan memberitahu Anda bagaimana kami beralih ke buruh pelabuhan.  Proses ini sangat lambat.  Kami menyeberang sekitar 10 bulan.  Pada musim panas 2017, kami memiliki 0 kontainer produksi.  Pada bulan April 2018, kami melakukan galangan kapal dan meluncurkan aplikasi terbaru kami ke dalam produksi. </p><br><p><img src="https://habrastorage.org/webt/h5/9t/ib/h59tibngi0uru-f4vehjhnq3e1c.png"></p><br><p>  Kami berasal dari dunia batu delima di rel.  Dulu ada 99% aplikasi Ruby on Rails.  Rails bergulir melalui Capistrano.  Secara teknis, Capistrano berfungsi sebagai berikut: pengembang meluncurkan cap deploy, capistrano pergi ke semua server aplikasi melalui ssh, mengambil versi terbaru dari kode, mengumpulkan aset, migrasi basis data.  Capistrano membuat symlink ke versi kode yang baru dan mengirimkan sinyal USR2 ke aplikasi web.  Pada sinyal ini, server web mengambil kode baru. </p><br><p><img src="https://habrastorage.org/webt/il/us/4e/ilus4ejwfkd6cvjnmjrcln2ugyy.png"></p><br><p>  Langkah terakhir di buruh pelabuhan tidak dilakukan seperti itu.  Di buruh pelabuhan, Anda harus menghentikan wadah lama, angkat wadah baru.  Ini menimbulkan pertanyaan: bagaimana cara mengalihkan lalu lintas?  Di dunia cloud, penemuan layanan bertanggung jawab untuk ini. </p><br><p><img src="https://habrastorage.org/webt/k3/il/ig/k3iligqv5uphvlp1l3cvkmbggem.png"></p><br><p>  Karena itu, kami menambahkan konsul ke setiap situs.  Konsul ditambahkan karena mereka menggunakan Terraform.  Kami membungkus semua konfigurasi nginx dalam template konsul.  Secara formal, hal yang sama, tetapi kami sudah siap secara dinamis mengelola lalu lintas di dalam situs. </p><br><p><img src="https://habrastorage.org/webt/u9/qg/ag/u9qgagdnxiwo4lowkqi7micapqu.png"></p><br><p>  Selanjutnya, kami menulis skrip ruby â€‹â€‹yang mengumpulkan gambar di salah satu server, mendorongnya ke dalam registri, lalu pergi dengan ssh ke setiap server, mengambil yang baru dan menghentikan wadah lama, mendaftarkannya dalam konsul.  Para pengembang juga terus menjalankan penyebaran topi, tetapi layanan sudah berjalan di buruh pelabuhan. </p><br><p>  Saya ingat ada dua versi naskah, yang kedua ternyata cukup maju, ada pembaruan yang bergulir, ketika sejumlah kecil kontainer berhenti, yang baru bangun, konsul Helfcheki menunggu dan pindah. </p><br><p><img src="https://habrastorage.org/webt/07/fx/gk/07fxgkf2fcvnhs8gpfjfrygalxs.png"></p><br><p>  Kemudian mereka menyadari bahwa ini adalah metode buntu.  Skrip meningkat menjadi 600 baris.  Langkah selanjutnya dalam penjadwalan manual kami mengganti Nomad.  Menyembunyikan detail pekerjaan dari pengembang.  Artinya, mereka masih disebut cap deploy, tetapi di dalamnya sudah ada teknologi yang sama sekali berbeda. </p><br><p><img src="https://habrastorage.org/webt/4j/o-/ms/4jo-ms4v5mx1q4cn6sqt6n0jr4a.png"></p><br><p>  Dan pada akhirnya, kami memindahkan penyebaran ke UI dan mengambil akses ke server, meninggalkan tombol penempatan hijau dan antarmuka kontrol. </p><br><p>  Pada prinsipnya, transisi semacam itu ternyata tentu saja panjang, tetapi kami menghindari masalah yang saya temui beberapa kali. </p><br><p>  Ada beberapa jenis tumpukan warisan, sistem, atau sesuatu seperti itu.  Khachennaya sudah hanya di tutup.  Pengembangan versi baru dimulai.  Setelah beberapa bulan atau beberapa tahun, tergantung pada ukuran perusahaan, dalam versi baru kurang dari setengah fungsi yang diperlukan diimplementasikan, dan versi lama masih lolos.  Dan yang baru itu juga menjadi sangat warisan.  Dan sekarang saatnya untuk memulai versi ketiga yang baru dari awal.  Secara umum, ini adalah proses tanpa akhir. </p><br><p>  Karenanya, kami selalu memindahkan seluruh tumpukan secara keseluruhan.  Dalam langkah-langkah kecil, bengkok, dengan kruk, tetapi seluruhnya.  Kami tidak dapat memutakhirkan misalnya mesin buruh pelabuhan di satu situs.  Perlu untuk memperbarui di mana-mana, jika ada keinginan. </p><br><p><img src="https://habrastorage.org/webt/qy/31/jr/qy31jrpbehnyyrcozqaxnj41jk8.png"></p><br><p>  Peluncuran.  Semua instruksi buruh pelabuhan mengeluarkan 10 kontainer nginx, atau 10 kontainer redis, ke buruh pelabuhan.  Ini adalah contoh yang buruk, karena gambar sudah dirakit, gambarnya ringan.  Kami mengemas aplikasi rel kami di buruh pelabuhan.  Ukuran gambar buruh pelabuhan adalah 2-3 gigabyte.  Mereka akan keluar tidak begitu cepat. </p><br><p><img src="https://habrastorage.org/webt/2q/lx/bf/2qlxbfo5lnhpjfxcjtlljrntgxy.png"></p><br><p>  Masalah kedua datang dari web hipster.  Sebuah web hipster selalu Github Flow.  Pada tahun 2011, ada posting pembuatan zaman yang Github Flow mengarahkan, sehingga seluruh web bergulir.  Seperti apa bentuknya?  Cabang induk selalu produksi.  Saat menambahkan fungsionalitas baru, kami membuat cabang.  Saat merger kami melakukan peninjauan kode, menjalankan tes, meningkatkan lingkungan pementasan.  Lingkungan pementasan tampak bisnis.  Pada waktu X, jika semuanya berhasil, maka kami menggabungkan cabang menjadi master dan mulai berproduksi. </p><br><p>  Pada capistrano, ini berfungsi dengan baik, karena diciptakan untuk ini.  Docker selalu menjual pipa kepada kami.  Merakit wadah.  Wadah dapat ditransfer ke pengembang, tester, ditransfer ke produksi.  Tetapi pada saat penggabungan master, kodenya sudah berbeda.  Semua gambar buruh pelabuhan yang dikumpulkan dari cabang fitur, mereka tidak dikumpulkan dari master. </p><br><p><img src="https://habrastorage.org/webt/vl/th/8g/vlth8gjbcyby-rpamtltaijqxcy.png"></p><br><p>  Bagaimana kami melakukannya?  Kami mengumpulkan gambar, menaruhnya di registri buruh pelabuhan lokal.  Dan setelah itu kami melakukan sisa operasi: migrasi, penyebaran ke produksi. </p><br><p><img src="https://habrastorage.org/webt/1i/kb/yu/1ikbyuh88pytsfprkkwdi6_6ppq.png"></p><br><p>  Untuk merakit gambar ini dengan cepat, kami menggunakan Docker-in-Docker.  Di Internet, semua orang menulis bahwa ini anti-pola, macet.  Kami tidak memiliki hal semacam itu.  Berapa banyak yang sudah bekerja dengannya tidak pernah punya masalah.  Kami meneruskan direktori / var / lib / docker ke server utama menggunakan volume Persistent.  Semua gambar perantara ada di server utama.  Merakit gambar baru pas dalam beberapa menit. </p><br><p><img src="https://habrastorage.org/webt/6q/_g/67/6q_g67tuzx_n078pff6-aisdvdc.png"></p><br><p>  Untuk setiap aplikasi, kami membuat registri buruh pelabuhan internal lokal dan volume build kami.  Karena buruh pelabuhan menyimpan semua lapisan pada disk dan sulit dibersihkan.  Sekarang kita tahu pemanfaatan disk masing-masing registry buruh pelabuhan lokal.  Kami tahu berapa banyak disk yang dibutuhkan.  Anda dapat menerima peringatan melalui Grafana terpusat dan bersih.  Sementara kita membersihkan tangan mereka.  Tapi kami akan mengotomatiskannya. </p><br><p><img src="https://habrastorage.org/webt/mf/py/wj/mfpywjgwpsj0tbqb6vvvyzz8_1u.png"></p><br><p>  Poin lain.  Gambar Docker dikumpulkan.  Sekarang gambar ini perlu diurai menjadi server.  Saat menyalin gambar buruh pelabuhan besar, jaringan tidak mengatasinya.  Di cloud kami memiliki 1 Gbit / s.  Ada shutdown global di cloud.  Sekarang kami sedang menyebarkan gambar buruh pelabuhan ke 4 server produksi berat.  Pada grafik Anda dapat melihat disk bekerja pada 1 paket server.  Kemudian paket server kedua digunakan.  Di bawah ini Anda dapat melihat pemanfaatan saluran.  Sekitar 1 Gbit / s kami hampir menarik.  Tidak ada banyak akselerasi di sana lagi. </p><br><p><img src="https://habrastorage.org/webt/lk/eo/hl/lkeohl4fjm-y97kmp3hyogr3p1a.png"></p><br><p>  Produksi favorit saya adalah Afrika Selatan.  Ada besi yang sangat mahal dan lambat.  Empat kali lebih mahal daripada di Rusia.  Ada internet yang sangat buruk.  Internet tingkat modem, tetapi tidak buggy.  Di sana kami meluncurkan aplikasi dalam 40 menit, dengan mempertimbangkan penyetelan cache, parameter batas waktu. </p><br><p><img src="https://habrastorage.org/webt/zl/8x/ig/zl8xig0k9liveeiuzoykh-ctgwm.png"></p><br><p>  Masalah terakhir yang membuat saya khawatir sebelum buruh pelabuhan menghubungi adalah beban.  Padahal, bebannya sama dengan tanpa buruh pelabuhan dengan besi identik.  Satu-satunya nuansa yang kami temukan hanya satu poin.  Jika Anda mengumpulkan log dari mesin Docker melalui driver fluentd bawaan, maka pada muatan sekitar 1000 rps, buffer fluentd internal mulai dikotori dan permintaan mulai melambat.  Kami mengeluarkan logging di wadah sespan.  Dalam nomad, ini disebut log-shipper.  Wadah kecil tergantung di sebelah wadah aplikasi besar.  Satu-satunya tugas adalah mengambilnya dan mengirimkannya ke repositori terpusat. </p><br><p><img src="https://habrastorage.org/webt/8r/fv/7x/8rfv7xzfamwjrwemisa1laingzy.png"></p><br><p>  Apa masalah / solusi / tantangannya.  Saya mencoba menganalisis apa tugas itu.  Fitur dari masalah kami adalah: </p><br><ul><li>  banyak aplikasi independen </li><li>  perubahan infrastruktur yang berkelanjutan </li><li>  Aliran Github dan gambar buruh pelabuhan besar </li></ul><br><p><img src="https://habrastorage.org/webt/da/xm/jm/daxmjmflat8cz4a5b-2nmx4pip4.png"></p><br><p>  Solusi kami </p><br><ul><li>  Federasi kelompok buruh pelabuhan.  Dari sudut pandang penanganan itu sulit.  Tapi buruh pelabuhan pandai meluncurkan fungsionalitas bisnis dalam produksi.  Kami bekerja dengan data pribadi dan kami memiliki sertifikasi di setiap negara.  Di lokasi yang terisolasi, sertifikasi semacam itu mudah dilewati.  Selama sertifikasi, semua pertanyaan muncul: di mana Anda hosting, bagaimana Anda memiliki penyedia cloud, di mana Anda menyimpan data pribadi, di mana Anda membuat cadangan, siapa yang memiliki akses ke data.  Ketika semuanya terisolasi, akan lebih mudah untuk menggambarkan lingkaran tersangka dan untuk memantau semua ini jauh lebih mudah. </li><li>  Orkestrasi.  Jelas kubernet itu.  Dia ada di mana-mana.  Tetapi saya ingin mengatakan bahwa Konsul + Nomad adalah solusi produksi sepenuhnya. </li><li>  Perakitan gambar.  Anda dapat dengan cepat membuat gambar di Docker-in-Docker. </li><li>  Saat menggunakan Docker, menahan beban 1000 rps juga dimungkinkan. </li></ul><br><p>  Vektor arah pengembangan </p><br><p>  Sekarang salah satu masalah besar adalah ketidaksinkronan versi perangkat lunak di situs.  Sebelumnya, kami menyiapkan server dengan tangan.  Kemudian kami menjadi insinyur devops.  Sekarang konfigurasikan server menggunakan ansible.  Sekarang kita memiliki penyatuan total, standardisasi.  Kami memperkenalkan pemikiran biasa ke dalam kepala.  Kami tidak dapat memperbaiki PostgreSQL dengan tangan kami di server.  Jika Anda memerlukan beberapa penyesuaian pada hanya 1 server, maka kami pikir bagaimana menyebarkan pengaturan ini di mana-mana.  Jika Anda tidak membuat standar, maka akan ada kebun binatang pengaturan. </p><br><p>  Saya senang dan sangat senang bahwa kami dapat keluar dari kotak secara gratis, infrastruktur kerja yang benar-benar bagus. </p><br><p><img src="https://habrastorage.org/webt/w6/nz/pw/w6nzpwpzt1tsxifw0gksrvoplpg.png"></p><br><p>  Anda dapat menambahkan kepada saya di facebook.  Jika kita melakukan sesuatu yang baik, saya akan menulis tentang itu. </p><br><p>  Pertanyaan: </p><br><p>  Apa keuntungan Templat Konsul dari Templat Ansible, misalnya, untuk mengkonfigurasi aturan firewall dan banyak lagi? </p><br><p>  Jawab: Sekarang kami memiliki lalu lintas dari penyeimbang eksternal pergi langsung ke kontainer.  Tidak ada seorang pun di antara keduanya.  Konfigurasi terbentuk di sana yang meneruskan alamat IP dan port cluster.  Juga, kami memiliki semua pengaturan keseimbangan di K / V di Konsul.  Kami memiliki ide untuk memberikan pengaturan perutean kepada pengembang melalui antarmuka yang aman sehingga mereka tidak merusak apa pun. </p><br><p>  Pertanyaan: Mengenai homogenitas semua situs.  Apakah benar-benar tidak ada permintaan dari bisnis atau dari pengembang yang Anda butuhkan untuk meluncurkan sesuatu yang tidak standar di situs ini?  Misalnya, tarantool dengan cassandra. </p><br><p>  Jawaban: Itu terjadi, tetapi sangat jarang.  Ini kami membuat artefak terpisah internal.  Ada masalah seperti itu, tetapi jarang terjadi. </p><br><p>  Pertanyaan: Solusi untuk masalah pengiriman adalah dengan menggunakan registry buruh pelabuhan pribadi di setiap situs dan dari sana sudah cepat untuk mendapatkan gambar buruh pelabuhan. </p><br><p>  Jawaban: Bagaimanapun, penyebaran akan berjalan ke jaringan, karena kami sedang menyebarkan gambar buruh pelabuhan ke 15 server di sana secara bersamaan.  Kami bersandar pada jaringan.  Di dalam jaringan, 1 Gbit / s. </p><br><p>  Pertanyaan: Begitu banyak kontainer buruh pelabuhan yang didasarkan pada tumpukan teknologi yang kira-kira sama? </p><br><p>  Jawaban: Ruby, Python, NodeJS. </p><br><p>  Pertanyaan: Seberapa sering Anda menguji atau memeriksa gambar buruh pelabuhan Anda untuk pembaruan?  Bagaimana Anda mengatasi masalah pembaruan, misalnya, ketika glibc, openssl perlu diperbaiki di semua buruh pelabuhan? </p><br><p>  Jawaban: Jika Anda menemukan kesalahan seperti itu, kerentanan, maka kami duduk selama seminggu dan memperbaikinya.  Jika Anda perlu meluncurkan, maka kami dapat meluncurkan seluruh cloud (semua aplikasi) dari awal hingga federasi.  Kita bisa mengklik semua tombol hijau untuk penyebaran aplikasi dan meninggalkan untuk minum teh. </p><br><p>  Pertanyaan: Apakah Anda akan melepaskan dukun Anda di opensource? </p><br><p>  Jawaban: Di sini Andrei (menunjuk ke orang dari penonton) menjanjikan kita untuk mengeluarkan dukun di musim gugur.  Tetapi di sana Anda perlu menambahkan dukungan untuk kubernetes.  Opensource harus selalu lebih baik. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id439382/">https://habr.com/ru/post/id439382/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id439372/index.html">Ingin Bermain Detektif? Temukan Bug dalam Fungsi dari Komandan Tengah Malam</a></li>
<li><a href="../id439374/index.html">Bagi mereka yang ingin bermain detektif: temukan kesalahan dalam fungsi dari Midnight Commander</a></li>
<li><a href="../id439376/index.html">Klub Bunga</a></li>
<li><a href="../id439378/index.html">Buku (sedang?). Refleksi pada sifat pikiran. Bagian I</a></li>
<li><a href="../id439380/index.html">Bagaimana saya membuat ekstensi untuk Atom dan Kode VS: pengalaman dan sumber pribadi</a></li>
<li><a href="../id439384/index.html">Pemodelan Metropolis</a></li>
<li><a href="../id439388/index.html">Robot dalam Jurnalisme, atau Cara Menggunakan Kecerdasan Buatan untuk Membuat Konten</a></li>
<li><a href="../id439390/index.html">Inovasi terbaik jejaring sosial pada tahun 2018</a></li>
<li><a href="../id439392/index.html">Musim kejuaraan 2019 terbuka! SNA Hackathon Ala ML Boot Camp 8 dimulai</a></li>
<li><a href="../id439394/index.html">Sebagai seorang programmer, kernel datacenter menulis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>