<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò¢ üëßüèº üåµ Nous collectons les journaux du pare-feu Mikrotik dans une base de donn√©es üôçüèΩ üë®üèø‚Äçüíª üßóüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bon apr√®s-midi 

 Je veux vous dire avec quelle facilit√© et naturellement vous pouvez configurer un serveur de collecte de m√©tadonn√©es de trafic r√©sea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous collectons les journaux du pare-feu Mikrotik dans une base de donn√©es</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427159/">  Bon apr√®s-midi <br><br>  Je veux vous dire avec quelle facilit√© et naturellement vous pouvez configurer un serveur de collecte de m√©tadonn√©es de trafic r√©seau pour les routeurs Mikrotik. <br><br>  <b>Objectif:</b> L'objectif sera de stocker les journaux de pare-feu ¬´m√¢ch√©s¬ª dans une base de donn√©es pour une analyse plus approfondie. <br><br>  <b>Moyens:</b> Toute nouvelle distribution Linux avec rsyslogd v8 et sup√©rieur convient √† la mise en ≈ìuvre, peut-√™tre que la syntaxe propos√©e fonctionnera √©galement sur v7.  Nous avons √©galement besoin d'un SGBD, j'ai choisi mariadb.  La croissance de la base de donn√©es variera par rapport au nombre de r√®gles enregistr√©es, car la taille du lecteur est √† votre discr√©tion, dans mon cas, 30 √† 40 r√®gles sont enregistr√©es, ce qui repr√©sente environ 1 200 000 lignes par jour.  Au cours du mois d'utilisation de la base de donn√©es, index compris, elle est pass√©e √† 3,8 Go. <br><br>  <b>M√©canique: le</b> routeur envoie un journal au serveur distant via UDP.  √Ä l'aide d'expressions r√©guli√®res, le serveur rsyslog nettoie les cha√Ænes d'informations inutiles, g√©n√®re une insertion SQL et l'envoie au SGBD.  Le SGBD, √† l'aide d'un d√©clencheur avant l'insertion, effectue un nettoyage et une s√©paration suppl√©mentaires des champs qui n'ont pas pu √™tre analys√©s dans rsyslog. <br><a name="habracut"></a><br><h4>  <b>Configurer RSYSLOG</b> </h4><br>  Modification du fichier /etc/rsyslog.conf <br>  Ajoutez-y les lignes suivantes: <br><br><pre><code class="plaintext hljs">module(load="ommysql") module(load="imudp") input(type="imudp" port="514")</code> </pre> <br>  Ainsi, nous chargeons les modules n√©cessaires et ouvrons le port 514 UDP. <br><br>  La ligne de journal de Mikrotik ressemble √† ceci: <br><br><pre> <code class="plaintext hljs">20180927155341 BLOCKSMKNETS forward: in:ether6 - LocalTORF out:VLAN55 - RT_INET, src-mac 00:15:17:31:b8:d7, proto TCP (SYN), 192.168.0.234:2457-&gt;192.168.6.14:65535, len 60</code> </pre> <br>  Comme vous pouvez le voir, beaucoup d'extra pour le stockage dans la base de donn√©es et une s√©lection claire sera difficile. <br>  En th√©orie, je dois ajouter de telles donn√©es: <br><br><pre> <code class="plaintext hljs">20180927155341 ether6 VLAN5 192.168.0.234 2457 192.168.6.14 65535 00:15:17:31:b8:d7 TCP SYN forward BLOCKSMKNETS 60</code> </pre> <br>  Je n'ai pas pu obtenir une telle ligne en utilisant un seul rsyslog.  Les habitu√©s de Rsyslog utilisent POSIX ERE / BRE, il n'y a donc aucun moyen d'appliquer des fonctionnalit√©s comme lookahead ou lookbehind. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Il</a> existe un outil qui vous permet de d√©boguer les habitu√©s, essayez-le, vous pouvez peut-√™tre s√©parer le port de l'adresse, ainsi que le nom de l'interface de in: et out:.  Gardez juste √† l'esprit que certains protocoles sport et dport sont manquants. <br><br>  En g√©n√©ral, ma sortie √©tait la suivante: <br><br><pre> <code class="plaintext hljs">20180927155341 in:ether6 out:VLAN5 192.168.0.234:2457 192.168.6.14:65535 00:15:17:31:b8:d7 TCP (SYN) forward BLOCKSMKNETS 60</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Il</a> existe de la documentation sur la fa√ßon de cuisiner les habitu√©s de rsyslog. <br><br>  Dans la forme finale, le fichier de configuration pour recevoir le journal de Mikrotik /etc/rsyslog.d/20-remote.conf ressemblera √† ceci: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog,"insert into traflog.traffic (datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len) values ('%timereported:::date-mysql%', '%msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end%', '%msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end%', '%msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end%', '%msg:R,ERE,0,DFLT:[ax]+--end%', '%msg:F,32:2%', '%msg:R,ERE,0,DFLT:[0-9]+$--end%' )",SQL if ($fromhost-ip == '192.168.0.230') and ($syslogtag contains "firewall") then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="rsyslogger" template="tpl_traflog") stop}</code> </pre><br>  Dans la premi√®re ligne, la description du mod√®le (mod√®le) est une ligne de code SQL pour le transf√©rer vers le SGBD. <br>  La deuxi√®me ligne est la condition lorsque l'action se produira, c'est-√†-dire l'enregistrement dans le SGBD. <br>  La condition ressemble √† ceci: si la source du journal = 192.168.0.230 ( <code>if ($fromhost-ip == '192.168.0.230')</code> ) Et si la ligne msg contient "pare-feu" (et ($ syslogtag contient "pare-feu")), alors en utilisant le module ommysql avec les param√®tres de connexion ( <code>then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="..."</code> ) nous appelons le mod√®le tpl_traflog ( <code>template="tpl_traflog")</code> ), et apr√®s cela, nous arr√™tons le traitement de la ligne ( <code>stop}</code> ). <br><br>  Il est possible que dans votre cas, quelque chose se passe mal, cela peut √™tre d√ª aux noms des interfaces ou des pr√©fixes de journal, peut-√™tre autre chose.  Pour le d√©bogage, nous allons proc√©der comme suit, commenter la deuxi√®me ligne, ajouter un nouveau mod√®le et deux nouvelles conditions: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog_test,"%timereported:::date-mysql% %msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end% %msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end% %msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end% %msg:R,ERE,0,DFLT:[ax]+--end% %msg:F,32:2% %msg:R,ERE,0,DFLT:[0-9]+$--end%\n" if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" )} if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" template="tpl_traflog_test" ) stop}</code> </pre> <br>  Red√©marrez l'enregistreur. <br><br>  Le mod√®le tpl_traflog_test est similaire √† tpl_traflog, mais sans SQL INSERT. <br><br>  La premi√®re condition ajoute la ligne non trait√©e% msg% au fichier /var/log/remote/192.168.0.230.log, car le mod√®le n'est pas sp√©cifi√©. <br><br>  La deuxi√®me condition ajoute la ligne trait√©e au m√™me fichier. <br>  Il sera donc plus pratique de comparer. <br>  Ensuite, pr√©parez la base de donn√©es. <br><br><h4>  <b>Nous pr√©parons une DB</b> </h4><br>  Nous allons baisser le param√®tre SGBD, tout est standard ici. <br><br>  Nous d√©marrons la console mysql et ex√©cutons le code suivant: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   create database traflog character set utf8 collate utf8_bin; use traflog; --  create table traffic (id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, datetime DATETIME, inif VARCHAR(20), outif VARCHAR(20), src VARCHAR(21), sport INT(5), dst VARCHAR(21), dport INT(5), smac VARCHAR(17), proto VARCHAR(4), flags VARCHAR(11), chain VARCHAR(8), logpref VARCHAR(24), len INT(5)) ENGINE=MYISAM; --  create user rsyslogger@localhost identified by '...'; grant all privileges on traflog.* to rsyslogger@localhost;</span></span></code> </pre><br>  La table est pr√™te, l'utilisateur l'est. <br><br>  Ajoutez maintenant un d√©clencheur, il fera ce que l'enregistreur n'a pas r√©ussi √† s√©parer l'adresse du port, nettoyez les noms des interfaces, supprimez les crochets du drapeau: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   traffic DELIMITER // create TRIGGER delim_ip_port_flags BEFORE insert ON traffic FOR EACH ROW begin set NEW.inif = REGEXP_REPLACE ((NEW.inif), 'in:', '' ); set NEW.outif = REGEXP_REPLACE ((NEW.outif), 'out:', '' ); set NEW.sport = REGEXP_REPLACE ((NEW.src), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.src = REGEXP_REPLACE ((NEW.src), ':[0-9]+', '' ); set NEW.dport = REGEXP_REPLACE ((NEW.dst), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.dst = REGEXP_REPLACE ((NEW.dst), ':[0-9]+', '' ); set NEW.flags = REGEXP_REPLACE ((NEW.flags), '\\(|\\)', '' ); end // delimiter ;</span></span></code> </pre> <br>  REGEXP_REPLACE recherche le deuxi√®me param√®tre apr√®s le point d√©cimal (saison r√©guli√®re) et le remplace par le troisi√®me param√®tre, dans notre cas, il n'y a rien entre guillemets, par cons√©quent, il supprime simplement ce qu'il trouve. <br><br>  Faisons un insert de test, semblable √† la fa√ßon dont l'enregistreur fera: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   insert into traffic (datetime, inif, outif, src, dst, smac, proto, chain, logpref) values (20180730075437, 'in:ether6', 'out:VLAN55', '192.168.0.234:4997', '192.168.6.18:65535', '00:15:17:31:b8:d7', 'TCP', '(SYN)', 'forward', 'BLOCKSMKNETS');</span></span></code> </pre> <br>  Voyons ce qui s'est pass√©: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tarffic;</code> </pre> <br>  Si tout est correct, passez √† autre chose.  Sinon, recherchez l'erreur. <br><br>  Ajoutez au moins un index.  Je ne suis pas un ma√Ætre dans la cr√©ation d'index, mais si je comprends bien, dans mysql, il est plus correct d'utiliser des index avec diff√©rents champs correspondants pour diff√©rentes requ√™tes, car une requ√™te ne peut utiliser qu'un seul index (ou je me trompe?).  Si vous comprenez, faites-le √† votre discr√©tion. <br>  Je dois souvent faire des demandes avec un pr√©fixe sp√©cifique, j'ai donc ajout√© cet index: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  create index traffic_index on traffic (datetime,logpref,src);</span></span></code> </pre> <br>  C'est fait. <br><br>  Vous devez maintenant commencer √† envoyer sur le routeur, ajouter les param√®tres et l'action du serveur de journalisation distant, ajouter l'option de journalisation √† l'une des r√®gles de pare-feu, ajouter un pr√©fixe de 24 caract√®res maximum. <br><br>  Dans la console Mikrotik, cela ressemble √† ceci: <br><br><pre> <code class="plaintext hljs">/system logging action set 3 remote=192.168.0.94 src-address=192.168.0.230 add name=remote2 remote=192.168.0.19 syslog-facility=local6 target=remote /system logging add action=remote topics=error,account,critical,event,info add action=remote2 topics=firewall /ip firewall filter ... add action=drop chain=input comment="drop ssh brute forcers" dst-port=22,8291 log=yes log-prefix=DROP_SSH_BRUTE protocol=tcp src-address-list=ssh_blacklist ...</code> </pre><br>  O√π 192.168.0.230 est l'adresse du routeur, 192.168.0.19 est l'adresse du serveur de journaux pour les journaux de pare-feu et 192.168.0.94 est un autre serveur de journaux, j'ai des journaux syst√®me Mikrotik qui s'y trouvent, nous n'en avons pas besoin maintenant.  Notre configuration est distante2. <br><br>  Ensuite, voyez ce qui se trouve dans le fichier: <br><br><pre> <code class="plaintext hljs">tail -f /var/log/remote/192.168.0.230.log</code> </pre> <br>  Les lignes du routeur doivent √™tre √©parpill√©es dans le fichier, √† moins bien s√ªr que votre r√®gle ne soit d√©clench√©e assez souvent. <br><br>  Si certains champs sont manquants, c'est-√†-dire que la s√©quence datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len n'est pas suivie, vous pouvez essayer de modifier le param√®tre dans les mod√®les de d√©bogage de l'enregistreur, remplacer BLANK par DLFT.  Ensuite, au lieu du vide de n'importe quel champ, certaines lettres appara√Ætront, je ne me souviens pas d√©j√† lesquelles.  Si cela se produit, alors quelque chose ne va pas avec le programme r√©gulier et vous devez le r√©parer. <br><br>  Si tout s'est d√©roul√© comme il se doit, d√©sactivez les conditions de test et le mod√®le. <br><br>  Vous devez √©galement ex√©cuter la configuration par d√©faut dans /etc/rsyslog.d/ ci-dessous, je l'ai renomm√© en 50-default.conf afin que les journaux distants ne soient pas vers√©s dans le journal syst√®me / var / log / message <br>  Red√©marrez l'enregistreur. <br><br>  Attendons un peu que notre base de donn√©es soit pleine.  Ensuite, nous pouvons commencer la s√©lection. <br><br>  <b>Quelques requ√™tes pour un exemple:</b> <br><br><div class="spoiler">  <b class="spoiler_title">Pour voir la taille de la base de donn√©es et le nombre de lignes:</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"database"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_length + index_length)/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"size Mb"</span></span>, TABLE_ROWS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"count rows"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.tables <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> table_schema; +<span class="hljs-comment"><span class="hljs-comment">--------------------+---------+------------+ | database | size Mb | count rows | +--------------------+---------+------------+ | information_schema | 0.17 | NULL | | traflog | 3793.39 | 21839553 | +--------------------+---------+------------+ 2 rows in set (0.48 sec)</span></span></code> </pre><br>  Pr√®s de 4 Go ont augment√© en un mois, mais cela d√©pend du nombre et des propri√©t√©s des r√®gles de pare-feu enregistr√©es <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Nombre de pr√©fixes enregistr√©s</b> <div class="spoiler_text">  Le nombre de pr√©fixes enregistr√©s n'est pas √©gal au nombre de r√®gles, certaines r√®gles fonctionnent avec un seul pr√©fixe, mais combien de pr√©fixes au total?  et combien de r√®gles ont √©t√© √©labor√©es pour eux?: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> logpref,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------------+----------------+ | logpref | count(logpref) | +----------------------+----------------+ | ACCEPT_TORF_INET | 14582602 | | ACCEPT_SMK_PPP | 1085791 | | DROP_FORWARD_INVALID | 982374 | | REJECT_BNK01 | 961503 | | ACCEPT_MMAX_TORF | 802455 | | ACCEPT_TORF_PPP | 736803 | | SMTP_DNAT | 689533 | | ACCEPT_SMK_INET | 451411 | | ACCEPT_INET_TORF | 389857 | | BLOCK_SMKNETS | 335424 | | DROP_SMTP_BRUTE | 285850 | | ACCEPT_ROZN_TORF | 154811 | | ACCEPT_TORF_MMAX | 148393 | | DROP_ETHALL_ETHALL | 80679 | | ACCEPT_SMTP | 48921 | | DROP_SMTP_DDOS | 32190 | | RDP_DNAT | 28757 | | ACCEPT_TORF_ROZN | 18456 | | SIP_DNAT | 15494 | | 1CWEB_DNAT | 6406 | | BLOCKSMKNETS | 5789 | | DROP_SSH_BRUTE | 3162 | | POP_DNAT | 1997 | | DROP_RDP_BRUTE | 442 | | DROP_BNK01 | 291 | | DROPALL | 138 | | ACCEPT_RTP_FORWARD | 90 | | REJECT_SMTP_BRUTE | 72 | | L2TP_INPUT_ACCEPT | 33 | +----------------------+----------------+ 29 rows in set (2 min 51.03 sec)</span></span></code> </pre> <br>  ACCEPT_TORF_INET est le leader, par ce pr√©fixe vous pouvez trouver tous ceux qui sont all√©s sur Internet √† partir de notre r√©seau local, les protocoles et les ports sont enregistr√©s, le temps viendra et l'acc√®s sera ferm√© pour certains.  Il existe des donn√©es de r√©f√©rence pour les futurs travaux sur les bogues. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Chef de lance smtp</b> <div class="spoiler_text">  Voyons qui aujourd'hui a essay√© d'acc√©der au serveur smtp: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'SMTP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> datetime &gt; <span class="hljs-string"><span class="hljs-string">'2018101600000000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 191.96.249.92 | 12440 | | 191.96.249.24 | 4556 | | 191.96.249.61 | 4537 | | 185.255.31.122 | 3119 | | 178.57.79.250 | 226 | | 185.36.81.174 | 216 | | 185.234.219.32 | 211 | | 89.248.162.145 | 40 | | 45.125.66.157 | 32 | | 188.165.124.31 | 21 | +----------------+--------------+ 10 rows in set, 1 warning (21.36 sec)</span></span></code> </pre> <br>  De toute √©vidence, le n≈ìud 191.96.249.92 est le gagnant aujourd'hui.  Voyons dans quelles r√®gles enregistr√©es il est toujours apparu: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport),logpref <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> src=<span class="hljs-string"><span class="hljs-string">'191.96.249.92'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------------+-------+--------------+-----------------+ | src | dport | count(dport) | logpref | +---------------+-------+--------------+-----------------+ | 191.96.249.92 | 25 | 226989 | SMTP_DNAT | | 191.96.249.92 | 25 | 170714 | DROP_SMTP_BRUTE | | 191.96.249.92 | 25 | 2907 | DROP_SMTP_DDOS | | 191.96.249.92 | 25 | 2061 | ACCEPT_SMTP | +---------------+-------+--------------+-----------------+ 4 rows in set (10 min 44.21 sec)</span></span></code> </pre><br>  Celui-ci est sp√©cialis√© uniquement dans smtp, ~ 1% des hits pour avoir essay√© de deviner le mot de passe ou pour avoir envoy√© des ordures, le reste est all√© aux bains. <br><br>  La demande a pris 10 minutes, c'est beaucoup, les index actuels ne lui conviennent pas, ou vous pouvez reformuler la demande, mais maintenant nous n'en parlerons pas. <br></div></div><br>  √Ä l'avenir, il est pr√©vu de visser l'interface Web avec des requ√™tes et des formulaires standard. <br>  Le vecteur est donn√©, j'esp√®re que cet article vous sera utile. <br><br>  Merci √† tous! <br><br>  <b>R√©f√©rences:</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation Rsyslog</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation mysql</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation de journalisation Mikrotik</a> <br><br>  Merci √† la communaut√© LOR pour les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conseils.</a> <br><br>  <b>UPD.1</b> <br>  Ajout du champ des drapeaux √† la base de donn√©es, vous pouvez maintenant suivre la dur√©e de la connexion en attrapant SYN, FIN. <br>  Correction de quelques bugs dans les habitu√©s de rsyslog, ainsi que des d√©clencheurs mysql. <br><br>  Curieusement, la r√®gle par d√©faut defconf: drop invalid supprime tous les derniers paquets de connexions TCP, par cons√©quent, tous les n≈ìuds qui tentent de fermer la connexion en science √©chouent, envoyant plusieurs FIN.  Est-ce bien? <br><br>  J'ai ajout√© une r√®gle permettant la travers√©e TCP avec les drapeaux ACK, FIN. <br><br>  Sous le spoiler SQL, une proc√©dure qui affiche l'heure des connexions TCP au cours des cinq derni√®res minutes <br><div class="spoiler">  <b class="spoiler_title">connections_list ()</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connections_list; DELIMITER // <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> connections_list() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> logid <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> done <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datefin DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datesyn DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conntime <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsrc <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,datetime,src,sport,dst,dport <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> flags=<span class="hljs-string"><span class="hljs-string">'SYN'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> done=<span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> conn_syn_fin; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> connless(datestart DATETIME,dateend DATETIME,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>,src <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),sport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>,dst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),dport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> conn_syn_fin (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'TCP_FIN'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%SYN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); OPEN cur; read_loop: LOOP FETCH cur INTO logid,datesyn,connsrc,connsport,conndst,conndport; IF done THEN LEAVE read_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> datefin=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&gt;logid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src=connsrc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sport=connsport <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dst=conndst <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dport=conndport <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> conntime=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timediff</span></span>(datefin,datesyn)); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> connless (datestart,dateend,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>,src,sport,dst,dport) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> (datesyn,datefin,conntime,connsrc,connsport,conndst,conndport); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; CLOSE cur; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; // DELIMITER ;</code> </pre><br></div></div><br>  √Ä la suite de la proc√©dure, deux tables temporaires seront cr√©√©es. <br>  La table <b>conn_syn_fin</b> contient des entr√©es de journal avec les drapeaux SYN et FIN, puis une recherche est effectu√©e √† l'aide du curseur dans cette table. <br>  Le tableau <b>connless</b> contient une liste de connexions, ouvertes et termin√©es, termin√©es ont une dur√©e d'ouverture, respectivement, non. <br>  Notez le temps d'√©chantillonnage moins cinq minutes de l'heure actuelle.  Ma demande est lente.  Lentement, il passe par la recherche du curseur, traite environ 10 enregistrements par seconde, a essay√© de l'acc√©l√©rer dans tous les sens, mais le temps d'ex√©cution est toujours le m√™me. <br>  Notez √©galement que cette proc√©dure est uniquement √† des fins de d√©monstration.  Si vous devez faire une s√©lection pour un src / sport / dst / dport sp√©cifique, il est pr√©f√©rable de faire une proc√©dure distincte similaire √† celle-ci.  Si vous √™tes un ma√Ætre SQL, vous pouvez mieux √©crire votre requ√™te. <br><br><div class="spoiler">  <b class="spoiler_title">appeler connections_list ();</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> connections_list(); +<span class="hljs-comment"><span class="hljs-comment">---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | datestart | dateend | duration | src | sport | dst | dport | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | 2019-03-20 14:12:19 | 2019-03-20 14:13:14 | 00:00:55 | 192.168.0.81 | 41868 | 87.250.250.207 | 443 | | 2019-03-20 14:12:25 | NULL | NULL | 192.168.0.65 | 49311 | 52.5.23.125 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54433 | 217.69.139.42 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54434 | 217.69.139.42 | 443 | | 2019-03-20 14:12:32 | NULL | NULL | 192.168.0.119 | 37977 | 209.85.233.95 | 443 | ... | 2019-03-20 14:17:12 | NULL | NULL | 192.168.0.119 | 39331 | 91.213.158.131 | 443 | | 2019-03-20 14:17:13 | NULL | NULL | 192.168.0.90 | 63388 | 87.240.185.236 | 443 | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ 399 rows in set (33.17 sec) Query OK, 0 rows affected (33.18 sec)</span></span></code> </pre><br></div></div><br><br>  Une fois la proc√©dure termin√©e, les tables temporaires <b>conn_syn_fin</b> et <b>connless</b> restent, vous pouvez les regarder plus en d√©tail si vous trouvez quelque chose de suspect ou non fiable.  Apr√®s avoir d√©marr√© la proc√©dure, les anciennes tables sont supprim√©es et de nouvelles apparaissent.  √âcrivez si vous trouvez une erreur. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427159/">https://habr.com/ru/post/fr427159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427147/index.html">¬´Mod√®le de r√©f√©rence BIAN¬ª pour le secteur bancaire ou comment arr√™ter de r√©inventer la roue</a></li>
<li><a href="../fr427149/index.html">Haut-parleurs RADIOTEHNIKA S-30 anciens √† nouveaux</a></li>
<li><a href="../fr427151/index.html">Le processus √©ducatif en informatique: olympiades, bourses, programmes de soutien et communaut√©s de l'Universit√© ITMO</a></li>
<li><a href="../fr427153/index.html">ADN M√©canismes de stockage et de traitement des informations. Partie II</a></li>
<li><a href="../fr427155/index.html">Southampton Filter Bus - La premi√®re √©tape vers des villes plus propres</a></li>
<li><a href="../fr427163/index.html">Un nouveau mat√©riau contribuera √† rendre les centrales solaires thermiques plus efficaces</a></li>
<li><a href="../fr427165/index.html">Comment d√©velopper des tests d'int√©gration pour Atlassian Jira Server (jira-func-test-plugin)</a></li>
<li><a href="../fr427169/index.html">Tesla a discr√®tement supprim√© l'option de pilote automatique complet</a></li>
<li><a href="../fr427171/index.html">La s√©curit√© vous laisse</a></li>
<li><a href="../fr427173/index.html">La t√©l√©phonie est-elle moins ch√®re que gratuite?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>