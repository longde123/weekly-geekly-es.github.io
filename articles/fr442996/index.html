<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèø üñºÔ∏è üíï R√©duire la gestion des exceptions C ++ sur x64 üåµ üßï üö£üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Visual Studio 2019 Preview 3 introduit une nouvelle fonctionnalit√© pour r√©duire la taille binaire de la gestion des exceptions C ++ (try / catch et de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©duire la gestion des exceptions C ++ sur x64</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/442996/"><img width="140" align="left" src="https://habrastorage.org/webt/gq/ke/xi/gqkexi_dekwffzpjqtx04zp7ee8.png"><p>  Visual Studio 2019 Preview 3 introduit une nouvelle fonctionnalit√© pour r√©duire la taille binaire de la gestion des exceptions C ++ (try / catch et destructeurs automatiques) sur x64.  Surnomm√© FH4 (pour __CxxFrameHandler4, voir ci-dessous), j'ai d√©velopp√© un nouveau formatage et traitement pour les donn√©es utilis√©es pour la gestion des exceptions C ++ qui est ~ <strong>60%</strong> plus petit que l'impl√©mentation existante, ce qui entra√Æne une r√©duction binaire globale jusqu'√† <strong>20%</strong> pour les programmes utilisant intensivement C ++ gestion des exceptions. </p><br>  Cet article dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">blog</a> . <a name="habracut"></a><br><br><h2>  Comment activer cette fonction? </h2><br><p>  FH4 est actuellement <strong>d√©sactiv√© par d√©faut</strong> car les modifications d'ex√©cution requises pour les applications du magasin n'ont pas pu √™tre int√©gr√©es dans la version actuelle.  Pour activer FH4 pour les applications non Store, passez l'indicateur non document√© ¬´/ d2FH4¬ª au compilateur MSVC dans Visual Studio 2019 Preview 3 et au-del√†. </p><br><p>  Nous pr√©voyons d'activer FH4 par d√©faut une fois le runtime Store mis √† jour.  Nous esp√©rons le faire dans Visual Studio 2019 Update 1 et mettrons √† jour ce post que nous en savons plus. </p><br><h2>  Modifications des outils </h2><br><p>  Toute installation de Visual Studio 2019 Preview 3 et au-del√† aura les modifications dans le compilateur et le runtime C ++ pour prendre en charge FH4.  Les modifications du compilateur existent en interne sous l'indicateur ¬´/ d2FH4¬ª susmentionn√©.  Le runtime C ++ arbore une nouvelle DLL appel√©e vcruntime140_1.dll qui est automatiquement install√©e par VCRedist.  Cela est n√©cessaire pour exposer le nouveau gestionnaire d'exceptions __CxxFrameHandler4 qui remplace l'ancienne routine __CxxFrameHandler3.  La liaison statique et le d√©ploiement local de l'application du nouveau runtime C ++ sont √©galement pris en charge. </p><br><p>  Maintenant sur les trucs amusants!  Le reste de cet article couvrira les r√©sultats internes de l'essai de FH4 sur Windows, Office et SQL, suivis de d√©tails techniques plus approfondis derri√®re cette nouvelle technologie. </p><br><h2>  Motivation et r√©sultats </h2><br><p>  Il y a environ un an, nos partenaires du projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">C ++ / WinR</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">T</a> sont venus √† l'√©quipe Microsoft C ++ avec un d√©fi: dans quelle mesure pourrions-nous r√©duire la taille binaire de la gestion des exceptions C ++ pour les programmes qui l'utilisaient beaucoup? </p><br><p>  Dans le contexte d'un programme utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">C ++ / WinRT</a> , ils nous ont indiqu√© un composant Windows Microsoft.UI.Xaml.dll qui √©tait connu pour avoir une grande empreinte binaire en raison de la gestion des exceptions C ++.  J'ai confirm√© que c'√©tait effectivement le cas et g√©n√©r√© la r√©partition de la taille binaire avec le __CxxFrameHandler3 existant, illustr√© ci-dessous.  Les pourcentages dans le c√¥t√© droit du graphique sont des <strong>pourcentages de la taille binaire totale</strong> occup√©e par des tables de m√©tadonn√©es sp√©cifiques et le code d√©crit. </p><br><h2> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/350/cf5/402/350cf5402f932176e7c40f0af3f61161.png" alt="R√©partition de la taille de Microsoft.UI.Xaml.dll √† l'aide de __CxxFrameHandler3" width="720" height="480"></a> </h2><br><p>  Je ne discuterai pas dans cet article de ce que font les structures sp√©cifiques sur le c√¥t√© droit du graphique (voir la pr√©sentation de James McNellis sur le fonctionnement du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©roulement de la pile sur Windows</a> pour plus de d√©tails).  Cependant, en regardant le total des m√©tadonn√©es et du code, un √©norme <strong>26,4%</strong> de la taille binaire a √©t√© utilis√© par la gestion des exceptions C ++.  C'est un espace √©norme et entravait l'adoption de C ++ / WinRT. </p><br><p>  Nous avons apport√© des modifications dans le pass√© pour r√©duire la taille de la gestion des exceptions C ++ dans le compilateur sans modifier l'ex√©cution.  Cela inclut la suppression des m√©tadonn√©es pour les r√©gions de code qui ne peuvent pas lancer et replier des √©tats logiquement identiques.  Cependant, nous arrivions √† la fin de ce que nous pouvions faire avec le compilateur et ne serions pas en mesure de faire une br√®che significative dans quelque chose d'aussi gros.  L'analyse a montr√© qu'il y avait des gains importants √† gagner mais n√©cessitait des changements fondamentaux dans les donn√©es, le code et l'ex√©cution.  Nous sommes donc all√©s de l'avant et nous les avons fait. </p><br><p>  Avec le nouveau __CxxFrameHandler4 et les m√©tadonn√©es qui l'accompagnent, la r√©partition de la taille de Microsoft.UI.XAML.dll est d√©sormais la suivante: </p><br><h2> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e1d/a71/041/e1da71041bf442276ae15eb605a21e6a.png" alt="R√©partition de la taille de Microsoft.UI.Xaml.dll √† l'aide de __CxxFrameHandler4" width="720" height="481"></a> </h2><br><p>  La taille binaire utilis√©e par la gestion des exceptions C ++ chute de <strong>64%,</strong> ce qui entra√Æne une diminution globale de la taille binaire de <strong>18,6%</strong> sur ce binaire.  Chaque type de structure a diminu√© de taille par degr√©s stup√©fiants: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Eh donn√©es</strong> </td><td>  <strong>__CxxFrameHandler3 Taille (octets)</strong> </td><td>  <strong>__CxxFrameHandler4 Taille (octets)</strong> </td><td>  <strong>% De r√©duction de taille</strong> </td></tr><tr><td>  Entr√©es Pdata </td><td>  147 864 </td><td>  118,260 </td><td>  20,0% </td></tr><tr><td>  D√©tendez les codes </td><td>  224,284 </td><td>  92 810 </td><td>  58,6% </td></tr><tr><td>  Infos fonction </td><td>  255,440 </td><td>  27 755 </td><td>  89,1% </td></tr><tr><td>  Cartes IP2State </td><td>  186 944 </td><td>  45 098 </td><td>  75,9% </td></tr><tr><td>  D√©tendez-vous sur les cartes </td><td>  80,952 </td><td>  69 757 </td><td>  13,8% </td></tr><tr><td>  Cartes des gestionnaires de captures </td><td>  52 060 </td><td>  6 147 </td><td>  88,2% </td></tr><tr><td>  Essayez des cartes </td><td>  51 960 </td><td>  5 196 </td><td>  90,0% </td></tr><tr><td>  Funtets Dtor </td><td>  54 570 </td><td>  45,739 </td><td>  16,2% </td></tr><tr><td>  Attrapez des funclets </td><td>  102 400 </td><td>  4,301 </td><td> 95,8% </td></tr><tr><td>  Total </td><td>  <strong>1,156,474</strong> </td><td>  <strong>415 063</strong> </td><td>  <strong>64,1%</strong> </td></tr></tbody></table><p>  Combin√©, le passage √† __CxxFrameHandler4 a fait chuter la taille globale de Microsoft.UI.Xaml.dll de 4,4 Mo √† 3,6 Mo. </p><br><p>  L'essai de FH4 sur un ensemble repr√©sentatif de binaires Office montre une r√©duction de taille de ~ 10% dans les DLL qui utilisent fortement les exceptions.  M√™me dans Word et Excel, qui sont con√ßus pour minimiser l'utilisation des exceptions, il y a toujours une r√©duction significative de la taille binaire. </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Binaire</strong> </td><td>  <strong>Ancienne taille (Mo)</strong> </td><td>  <strong>Nouvelle taille (Mo)</strong> </td><td>  <strong>% De r√©duction de taille</strong> </td><td>  <strong>La description</strong> </td></tr><tr><td>  chart.dll </td><td>  17,27 </td><td>  15.10 </td><td>  12,6% </td><td>  Prise en charge de l'interaction avec des tableaux et des graphiques </td></tr><tr><td>  Csi.dll </td><td>  9,78 </td><td>  8.66 </td><td>  11,4% </td><td>  Prise en charge de l'utilisation de fichiers stock√©s dans le cloud </td></tr><tr><td>  Mso20Win32Client.dll </td><td>  6.07 </td><td>  5.41 </td><td>  11,0% </td><td>  Code commun partag√© entre toutes les applications Office </td></tr><tr><td>  Mso30Win32Client.dll </td><td>  8.11 </td><td>  7h30 </td><td>  9,9% </td><td>  Code commun partag√© entre toutes les applications Office </td></tr><tr><td>  oart.dll </td><td>  18,21 </td><td>  16.20 </td><td>  11,0% </td><td>  Fonctionnalit√©s graphiques partag√©es entre les applications Office </td></tr><tr><td>  wwlib.dll </td><td>  42,15 </td><td>  41.12 </td><td>  2,5% </td><td>  Binaire principal de Microsoft Word </td></tr><tr><td>  excel.exe </td><td>  52,86 </td><td>  50,29 </td><td>  4,9% </td><td>  Binaire principal de Microsoft Excel </td></tr></tbody></table><p>  Le test de FH4 sur les binaires SQL de base montre une r√©duction de 4 √† 21% de la taille, principalement √† partir de la compression des m√©tadonn√©es d√©crite dans la section suivante: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Binaire</strong> </td><td>  <strong>Ancienne taille (Mo)</strong> </td><td>  <strong>Nouvelle taille (Mo)</strong> </td><td>  <strong>% De r√©duction de taille</strong> </td><td>  <strong>La description</strong> </td></tr><tr><td>  sqllang.dll </td><td>  47.12 </td><td>  44,33 </td><td>  5,9% </td><td>  Services de haut niveau: analyseur de langage, classeur, optimiseur et moteur d'ex√©cution </td></tr><tr><td>  sqlmin.dll </td><td>  48.17 </td><td>  45,83 </td><td>  4,8% </td><td>  Services de bas niveau: moteur de transactions et de stockage </td></tr><tr><td>  qds.dll </td><td>  1,42 </td><td>  1,33 </td><td>  6,3% </td><td>  Fonctionnalit√© de magasin de requ√™tes </td></tr><tr><td>  SqlDK.dll </td><td>  3.19 </td><td>  3.05 </td><td>  4,4% </td><td>  Abstractions SQL OS: m√©moire, threads, planification, etc. </td></tr><tr><td>  autoadmin.dll </td><td>  1,77 </td><td>  1,64 </td><td>  7,3% </td><td>  Logique du conseiller de r√©glage de base de donn√©es </td></tr><tr><td>  xedetours.dll </td><td>  0,45 </td><td>  0,36 </td><td>  21,6% </td><td>  Enregistreur de donn√©es de vol pour les requ√™tes </td></tr></tbody></table><h2>  La technologie </h2><br><p>  Lors de l'analyse de ce qui a caus√© la si grande exception de gestion des donn√©es C ++ dans Microsoft.UI.Xaml.dll, j'ai trouv√© deux principaux coupables: </p><br><ol><li>  Les structures de donn√©es elles-m√™mes sont grandes: les tables de m√©tadonn√©es √©taient de taille fixe avec des champs de d√©calages relatifs √† l'image et des entiers de quatre octets chacun.  Une fonction avec un seul try / catch et un ou deux destructeurs automatiques avait plus de 100 octets de m√©tadonn√©es. </li><li>  Les structures de donn√©es et le code g√©n√©r√©s ne pouvaient pas √™tre fusionn√©s.  Les tables de m√©tadonn√©es contenaient des d√©calages relatifs √† l'image qui emp√™chaient le pliage de COMDAT (le processus o√π l'√©diteur de liens peut plier des √©l√©ments de donn√©es identiques pour √©conomiser de l'espace) √† moins que les fonctions qu'ils repr√©sentaient soient identiques.  De plus, les funclets catch (code d√©crit √† partir des blocs catch du programme) ne pouvaient pas √™tre pli√©s m√™me s'ils √©taient identiques au code car leurs m√©tadonn√©es sont contenues dans leurs parents. </li></ol><br><p>  Pour r√©soudre ces probl√®mes, FH4 restructure les m√©tadonn√©es et le code de sorte que: </p><br><ol><li>  Les valeurs de taille fixe pr√©c√©dentes ont √©t√© compress√©es √† l'aide d'un codage entier de longueur variable qui supprime&gt; 90% des champs de m√©tadonn√©es de quatre octets √† un.  Les tables de m√©tadonn√©es sont d√©sormais √©galement de longueur variable avec un en-t√™te pour indiquer si certains champs sont pr√©sents pour √©conomiser de l'espace lors de l'√©mission de champs vides. </li><li>  Tous les d√©calages relatifs √† l'image qui peuvent √™tre relatifs √† la fonction ont √©t√© rendus relatifs √† la fonction.  Cela permet au COMDAT de se replier entre des m√©tadonn√©es de diff√©rentes fonctions avec des caract√©ristiques similaires (pensez aux instanciations de mod√®le) et permet de compresser ces valeurs.  Les funclets de capture ont √©t√© repens√©s pour ne plus avoir leurs m√©tadonn√©es stock√©es dans celles de leurs parents afin que tous les funclets de capture identiques au code puissent maintenant √™tre pli√©s en une seule copie dans le binaire. </li></ol><br><p>  Pour illustrer cela, regardons la d√©finition d'origine de la table de m√©tadonn√©es Info fonction utilis√©e pour __CxxFrameHandler3.  Il s'agit de la table de d√©marrage de l'ex√©cution lors du traitement d'EH et pointe vers les autres tables de m√©tadonn√©es.  Ce code est disponible publiquement dans toute installation VS, recherchez &lt;chemin d'installation VS&gt; \ VC \ Tools \ MSVC \ &lt;version&gt; \ include \ ehdata.h: </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s_FuncInfo</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> magicNumber:<span class="hljs-number"><span class="hljs-number">29</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Identifies version of compiler unsigned int bbtFlags:3; // flags that may be set by BBT processing __ehstate_t maxState; // Highest state number plus one (thus // number of entries in unwind map) int dispUnwindMap; // Image relative offset of the unwind map unsigned int nTryBlocks; // Number of 'try' blocks in this function int dispTryBlockMap; // Image relative offset of the handler map unsigned int nIPMapEntries; // # entries in the IP-to-state map. NYI (reserved) int dispIPtoStateMap; // Image relative offset of the IP to state map int dispUwindHelp; // Displacement of unwind helpers from base int dispESTypeList; // Image relative list of types for exception specifications int EHFlags; // Flags for some features. } FuncInfo;</span></span></code> </pre> <br><p>  Cette structure est de taille fixe contenant 10 champs de 4 octets de long.  Cela signifie que chaque fonction qui a besoin de la gestion des exceptions C ++ par d√©faut encourt 40 octets de m√©tadonn√©es. </p><br><p>  Passons maintenant √† la nouvelle structure de donn√©es (&lt;chemin d'installation VS&gt; \ VC \ Tools \ MSVC \ &lt;version&gt; \ include \ ehdata4_export.h): </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FuncInfoHeader</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> isCatch : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 1 if this represents a catch funclet, 0 otherwise uint8_t isSeparated : 1; // 1 if this function has separated code segments, 0 otherwise uint8_t BBT : 1; // Flags set by Basic Block Transformations uint8_t UnwindMap : 1; // Existence of Unwind Map RVA uint8_t TryBlockMap : 1; // Existence of Try Block Map RVA uint8_t EHs : 1; // EHs flag set uint8_t NoExcept : 1; // NoExcept flag set uint8_t reserved : 1; }; uint8_t value; }; }; struct FuncInfo4 { FuncInfoHeader header; uint32_t bbtFlags; // flags that may be set by BBT processing int32_t dispUnwindMap; // Image relative offset of the unwind map int32_t dispTryBlockMap; // Image relative offset of the handler map int32_t dispIPtoStateMap; // Image relative offset of the IP to state map uint32_t dispFrame; // displacement of address of function frame wrt establisher frame, only used for catch funclets };</span></span></code> </pre> <br><p>  Notez que: </p><br><ol><li>  Le nombre magique a √©t√© supprim√©, l'√©mission de 0x19930522 √† chaque fois devient un probl√®me lorsqu'un programme a des milliers de ces entr√©es. </li><li>  EHFlags a √©t√© d√©plac√© dans l'en-t√™te tandis que dispESTypeList a √©t√© supprim√© en raison de la suppression de la prise en charge des sp√©cifications d'exceptions dynamiques en C ++ 17.  Le compilateur prendra par d√©faut l'ancienne __CxxFrameHandler3 si des sp√©cifications d'exceptions dynamiques sont utilis√©es. </li><li>  Les longueurs des autres tables ne sont plus enregistr√©es dans ¬´Function Info 4¬ª.  Cela permet au pliage COMDAT de plier davantage les tables point√©es m√™me si la table ¬´Function Info 4¬ª elle-m√™me ne peut pas √™tre pli√©e. </li><li>  (Non explicitement affich√©) Les champs dispFrame et bbtFlags sont maintenant des entiers de longueur variable.  La repr√©sentation de haut niveau le laisse comme uint32_t pour un traitement facile. </li><li>  bbtFlags, dispUnwindMap, dispTryBlockMap et dispFrame peuvent √™tre omis selon les champs d√©finis dans l'en-t√™te. </li></ol><br><p>  Compte tenu de tout cela, la taille moyenne de la nouvelle structure ¬´Function Info 4¬ª est d√©sormais de 13 octets (en-t√™te de 1 octet + trois d√©calages relatifs d'image de 4 octets par rapport √† d'autres tables), ce qui peut r√©duire encore plus si certaines tables ne sont pas n√©cessaires.  Les longueurs des tables ont √©t√© d√©plac√©es, mais ces valeurs sont d√©sormais compress√©es et 90% d'entre elles dans Microsoft.UI.Xaml.dll se sont av√©r√©es tenir dans un seul octet.  Dans l'ensemble, cela signifie que la taille moyenne pour repr√©senter les m√™mes donn√©es fonctionnelles dans le nouveau gestionnaire est de 16 octets par rapport aux 40 octets pr√©c√©dents - une am√©lioration assez spectaculaire! </p><br><p>  Pour le pliage, regardons le nombre de tables et de funclets uniques avec l'ancien et le nouveau gestionnaire: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  Eh donn√©es </td><td>  Compter dans __CxxFrameHandler3 </td><td>  Compter dans __CxxFrameHandler4 </td><td>  % De r√©duction </td></tr><tr><td>  Entr√©es Pdata </td><td>  12 322 </td><td>  9 855 </td><td>  20,0% </td></tr><tr><td>  Infos fonction </td><td>  6 386 </td><td>  2 747 </td><td>  57,0% </td></tr><tr><td>  Entr√©es de carte IP2State </td><td>  6 363 </td><td>  2,148 </td><td>  66,2% </td></tr><tr><td>  D√©tendre les entr√©es de la carte </td><td>  1 487 </td><td>  1,464 </td><td>  1,5% </td></tr><tr><td>  Cartes des gestionnaires de captures </td><td>  2,603 </td><td>  601 </td><td>  76,9% </td></tr><tr><td>  Essayez des cartes </td><td>  2 598 </td><td>  648 </td><td>  75,1% </td></tr><tr><td>  Funtets Dtor </td><td>  2,301 </td><td>  1,527 </td><td>  33,6% </td></tr><tr><td>  Attrapez des funclets </td><td>  2,603 </td><td>  84 </td><td>  <strong><em>96,8%</em></strong> </td></tr><tr><td>  Total </td><td>  <strong>36,663</strong> </td><td>  <strong>19 074</strong> </td><td>  <strong>48,0%</strong> </td></tr></tbody></table><p>  Le nombre d'entr√©es de donn√©es EH uniques diminue de <strong>48% par</strong> rapport √† la cr√©ation d'opportunit√©s de repli suppl√©mentaires en supprimant les RVA et en repensant les funclets de capture.  Je veux sp√©cifiquement appeler le nombre de funclets catch en italique en vert: il passe de 2.603 √† seulement 84. Ceci est une cons√©quence de la conversion de HRESULTs C ++ / WinRT en exceptions C ++ qui g√©n√®re beaucoup de funclets catch identiques au code qui peuvent maintenant √™tre pli√©.  Certes, une baisse de cette ampleur se situe dans le haut de gamme des r√©sultats, mais d√©montre n√©anmoins les √©conomies de taille potentielles que le pliage peut r√©aliser lorsque les structures de donn√©es sont con√ßues en tenant compte de cela. </p><br><h2>  Performances </h2><br><p>  Avec la conception introduisant la compression et modifiant l'ex√©cution du runtime, les performances de gestion des exceptions √©taient affect√©es.  L'impact est cependant <strong>positif</strong> : les performances de gestion des exceptions <strong>s'am√©liorent</strong> avec __CxxFrameHandler4 par opposition √† __CxxFrameHandler3.  J'ai test√© le d√©bit en utilisant un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">programme de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rence</a> qui se d√©roule √† travers 100 cadres de pile chacun avec un essai / capture et 3 objets automatiques √† d√©truire.  Cela a √©t√© ex√©cut√© 50 000 fois pour profiler le temps d'ex√©cution, ce qui a conduit √† des temps d'ex√©cution globaux de: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td></td><td>  <strong>__CxxFrameHandler3</strong> </td><td>  <strong>__CxxFrameHandler4</strong> </td></tr><tr><td>  <strong>Temps d'ex√©cution</strong> </td><td>  4.84s </td><td>  4,25 s </td></tr></tbody></table><p>  Le profilage a montr√© que la d√©compression introduit un temps de traitement suppl√©mentaire, mais son co√ªt est compens√© par moins de magasins pour le stockage local des threads dans la nouvelle conception d'ex√©cution. </p><br><h2>  Plans futurs </h2><br><p>  Comme mentionn√© dans le titre, FH4 n'est actuellement activ√© que pour les binaires x64.  Cependant, les techniques d√©crites sont extensibles √† ARM32 / ARM64 et dans une moindre mesure x86.  Nous recherchons actuellement de bons exemples (comme Microsoft.UI.Xaml.dll) pour motiver l'extension de cette technologie √† d'autres plates-formes - si vous pensez que vous avez un bon cas d'utilisation, faites-le nous savoir! </p><br><p>  Le processus d'int√©gration des modifications d'ex√©cution pour les applications Store pour prendre en charge FH4 est en cours.  Une fois cela fait, le nouveau gestionnaire sera activ√© par d√©faut afin que tout le monde puisse obtenir ces √©conomies de taille binaire sans effort suppl√©mentaire. </p><br><h2>  Remarques de cl√¥ture </h2><br><p>  Pour tous ceux qui pensent que leurs binaires x64 pourraient faire un peu de r√©duction: essayez FH4 (via '/ d2FH4') aujourd'hui!  Nous sommes ravis de voir quelles √©conomies cela peut apporter maintenant que cette fonctionnalit√© est disponible dans la nature.  Bien s√ªr, si vous rencontrez des probl√®mes, veuillez nous en informer dans les commentaires ci-dessous, par e-mail ( <a href="">visualcpp@microsoft.com</a> ) ou via la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">communaut√© des d√©veloppeurs</a> .  Vous pouvez √©galement nous trouver sur Twitter ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@VisualC</a> ). </p><br><p>  Merci √† Kenny Kerr de nous avoir dirig√© vers Microsoft.UI.Xaml.dll, Ravi Pinjala pour avoir collect√© les chiffres sur Office et Robert Roessler pour avoir test√© cela sur SQL. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442996/">https://habr.com/ru/post/fr442996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442984/index.html">Modification du bloc d'alimentation de l'ordinateur IBM 5150 mod√®le A 230 V</a></li>
<li><a href="../fr442986/index.html">Pilote automatique Tesla: strat√©gie de mise en ≈ìuvre</a></li>
<li><a href="../fr442988/index.html">Machine virtuelle DIY</a></li>
<li><a href="../fr442992/index.html">La calculatrice Windows est d√©sormais open-source</a></li>
<li><a href="../fr442994/index.html">Annonce de l'Open Sourcing de Windows Calculator</a></li>
<li><a href="../fr442998/index.html">Analyses sous tapis: un examen de 18 nouvelles ann√©es</a></li>
<li><a href="../fr443000/index.html">Une mise √† jour des versions C # et des outils C #</a></li>
<li><a href="../fr443002/index.html">L'√©tat actuel de la science de la conscience</a></li>
<li><a href="../fr443004/index.html">Ma copine et le premier jeu vid√©o. D√©veloppement de l'unit√©. Partie 1</a></li>
<li><a href="../fr443006/index.html">Sortie de Grafana v6 - nouvelles fonctionnalit√©s d'un outil de visualisation ouvert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>