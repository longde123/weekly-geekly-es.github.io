<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÆ üó∫Ô∏è üé¥ MassTransit, Saga e RabbitMQ para implementar um gerenciador de processos üë®üèø‚Äçü§ù‚Äçüë®üèΩ ‚úåÔ∏è üë®‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma vez, enfrentamos a tarefa de automatizar v√°rios fluxos de trabalho em uma grande empresa. Para n√≥s, isso significava reunir cerca de 10 sistemas n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MassTransit, Saga e RabbitMQ para implementar um gerenciador de processos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/412793/"><p>  Uma vez, enfrentamos a tarefa de automatizar v√°rios fluxos de trabalho em uma grande empresa.  Para n√≥s, isso significava reunir cerca de 10 sistemas no momento do lan√ßamento.  Al√©m disso, tudo tinha que ser conectado de forma ass√≠ncrona, escal√°vel e confi√°vel. </p><br><p>  O processo simplificado pode ser descrito como uma sequ√™ncia de a√ß√µes em diferentes sistemas, que n√£o podem ser totalmente automatizados, pois requer participa√ß√£o humana.  Por exemplo, para selecionar determinadas a√ß√µes ou coordena√ß√£o elementar, necess√°rias para passar para a pr√≥xima etapa do processo. </p><br><p>  Para resolver esse problema, decidimos usar a arquitetura de mensagens atrav√©s do barramento de dados, e o MassTransit com sua Saga em conjunto com o RabbitMQ nos convinha perfeitamente. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8f9/896/b2a/8f9896b2aade49a732cf10b63b8276ec.jpg" alt="imagem"><a name="habracut"></a></p><h2>  Como √© a Saga? </h2><br>  Saga √© uma implementa√ß√£o do modelo do Process Manager do livro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Enterprise Application Integration Templates</a> , que permite descrever um processo como uma m√°quina de estado.  Um evento chega na entrada, Saga realiza uma sequ√™ncia de a√ß√µes.  Ao mesmo tempo, em qualquer est√°gio da Saga, a decis√£o de uma pessoa pode ser necess√°ria.  Em seguida, ela cria uma tarefa no rastreador e "adormece" por tempo indeterminado, aguardando novos eventos. <br><p>  Saga √© baseado em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Automatonymous</a> .  √â declarativamente descrito em uma classe herdada de MassTransitStateMachine &lt;&gt;.  Para o Saga, voc√™ precisa descrever todos os estados, eventos executados e a√ß√µes executadas quando determinados eventos ocorrem.  O estado atual √© armazenado no banco de dados. </p><br><p>  Primeiro, descrevemos todos os estados e eventos da Saga e damos nomes compreens√≠veis.  √â assim: </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateMachine</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingTaskCreated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingTaskTakedToWork { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingDecisionAboutTask { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State Rejected { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;IStartWorkflowCommand&gt; StartWorkflowCommandReceived { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskCreatedNotification&gt; TaskCreated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskTakedToWorkNotification&gt; TaskTakedToWork { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskDeclinedNotification&gt; TaskDeclined { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskApprovedNotification&gt; TaskApproved { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildStateMachine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InstanceState(x =&gt; x.CurrentState); Event(() =&gt; StartWorkflowCommandReceived, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId) .SelectId(context =&gt; context.Message.CorrelationId)); Event(() =&gt; TaskCreated, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskTakedToWork, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskDeclined, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskApproved, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); } }</code> </pre> <br><p>  Lan√ßamos uma classe parcial, onde declaramos uma lista de todos os estados e eventos, e o m√©todo BuildStateMachine, que descreve a correla√ß√£o de eventos com o Saga.  Para fazer isso, um par√¢metro especial CorrelationId √© passado em cada evento - este √© o Guid, que √© executado entre todos os sistemas conectados e nos sistemas de monitoramento. </p><br><p>  Portanto, se surgirem problemas, podemos restaurar toda a imagem do que est√° acontecendo pelos logs de todos os sistemas conectados.  Enviamos CorrelationId em mensagens da Saga, os sistemas enviam de volta em notifica√ß√µes para que possamos correlacionar a mensagem com uma Saga espec√≠fica. </p><br><p>  Aqui est√° um exemplo da pr√≥pria classe de m√°quina de estado: </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed partial <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> StateMachine : MassTransitStateMachine&lt;WorkflowSaga&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> StateMachine() { BuildStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">Initially</span></span>(WhenStartWorkflowCommandReceived()); During(AwaitingTaskCreatedInPlanner, WhenTaskCreated()); During(AwaitingTaskTakedToWork, WhenTaskTakedToWork()); During(AwaitingDecisionAboutTask, WhenTaskApproved(), WhenTaskDeclined()); } private EventActivityBinder&lt;WorkflowSaga, IStartWorkflowCommand&gt; WhenStartWorkflowCommandReceived() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(StartWorkflowCommandReceived) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.SaveConfigurationRequestInfo(ctx.Data)) .Send(TaskManagerQueue, ctx =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CreateTaskCommand(ctx.Instance)) .TransitionTo(AwaitingTaskCreated); } private EventActivityBinder&lt;WorkflowSaga, TaskCreatedNotification&gt; WhenTaskCreated() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(DPORPApproveTaskCreatedInPlanner) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.SaveCreatedTaskInfo(ctx.Data)) .Send(MailServiceQueue, ctx =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NotifyRequestAuthorThatWorkflowStarted(ctx.Instance)) .TransitionTo(AwaitingTaskTakedToWork); } private EventActivityBinder&lt;WorkflowSaga, TaskTakedToWorkNotification&gt; WhenTaskTakedToWork() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskTakedToWork) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsTakedToWork(ctx.Data)) .TransitionTo(AwaitingDecisionAboutTask); } private EventActivityBinder&lt;WorkflowSaga, TaskApprovedNotification&gt; WhenTaskApproved() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskApproved) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsApproved(ctx.Data)) .Finalize(); } private EventActivityBinder&lt;WorkflowSaga, TaskDeclinedNotification&gt; WhenTaskDeclined() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskDeclined) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsDeclined(ctx.Data)) .TransitionTo(Rejected); } }</code> </pre><br><p>  O construtor descreve os estados.  A recep√ß√£o de cada evento √© feita em um m√©todo separado, a fim de manter a legibilidade.  Toda a l√≥gica de constru√ß√£o de mensagens √© realizada nas pr√≥prias mensagens; caso contr√°rio, com a crescente complexidade do sistema, Saga aumenta rapidamente. </p><br><p>  Deve-se tomar cuidado no desenvolvimento de conven√ß√µes e na manuten√ß√£o da legibilidade.  Devido √† imperatividade do C #, √© muito dif√≠cil declarar uma descri√ß√£o dos estados e a√ß√µes nele.  Mesmo para m√°quinas de estado simples, o verdadeiro inferno come√ßa. </p><br><p>  Agora, algumas palavras sobre o SagaInstance.  SagaInstance √© uma classe herdada de SagaStateMachineInstance.  Consiste em objetos e campos que caracterizam a m√°quina de estado.  Grosso modo, essa √© a mem√≥ria de Saga.  Armazenamos todos os dados da Saga que ela precisar√° ao longo de sua vida.  Tamb√©m nesta classe √© descrita a l√≥gica das mudan√ßas nesses dados no decorrer do trabalho. </p><br><p>  Aqui est√° um exemplo: </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WorkflowSaga : SagaStateMachineInstance , ISagaWithState , ICreatedOnOffset , IModifiedOnOffset , ICreatedBy&lt;string&gt; , IModifiedBy&lt;string&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Guid CorrelationId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string CurrentState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string InitialRequestViewUrl { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestAuthor { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestText { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> byte[] RowVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string CreatedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string ModifiedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset CreatedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset ModifiedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset CompletedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> virtual ICollection&lt;RelatedTask&gt; RelatedTasks { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveGabrielConfigurationRequestInfo( ICreateGabrielConfigurationRequestCommand command) { CorrelationId = command.CorrelationId; RequestNumber = command.RequestNumber; RequestAuthor = command.Author; RequestText = command.RequestText; InitialRequestViewUrl = command.InitialRequestViewUrl; CreatedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveCreatedTaskInfo(ITaskCreationInfo taskCreationInfo) { RelatedPlannerTasks.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RelatedPlannerTask(taskCreationInfo)); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsTakedToWork(ITaskUpdatedInfo taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.TakedToWork); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsApproved(TaskApprovedNotification taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.Completed, taskInfo.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); CompletedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsDeclined(TaskDeclinedNotification taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.Declined, taskInfo.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); CompletedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } private <span class="hljs-type"><span class="hljs-type">void</span></span> UpdateTaskInfo(ITaskUpdatedInfo taskInfo, TaskStatus taskStatus, string <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { var task = RelatedTasks.Single(t =&gt; t.Number == taskInfo.Number); task.ModifiedBy = taskInfo.TaskModifiedBy; task.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>; task.Status = taskStatus; } }</code> </pre><br><p>  Um exemplo mostra que em SagaInstance CorrelationId √© armazenado para correla√ß√£o de eventos com Saga e CurrentState para armazenar o estado atual de Saga. </p><br><h2>  Tratamento de erros </h2><br><p>  O que acontece com o Saga se ocorrer um erro durante o processamento da mensagem?  Esta √© uma quest√£o importante, porque todo mundo quer que a m√°quina de estado permane√ßa sempre consistente, mesmo que algo d√™ errado.  E com o MassTransit, Saga est√° indo bem. </p><br><p>  Como voc√™ j√° notou, nos exemplos acima, n√£o h√° um √∫nico bloco catch de tentativa para lidar com exce√ß√µes.  O motivo √© simples: eles n√£o s√£o necess√°rios l√°.  Se ocorrer uma exce√ß√£o durante o processamento da mensagem, a mensagem ser√° retornada √† fila e todas as altera√ß√µes ser√£o revertidas.  Como estamos fazendo todas as manipula√ß√µes de dados na mesma transa√ß√£o que o Saga, a transa√ß√£o n√£o ser√° fechada. </p><br><p>  Em geral, a manipula√ß√£o de algo diferente de Saga na pr√≥pria Saga √© uma m√° pr√°tica.  De acordo com o livro ‚ÄúModelos de integra√ß√£o para aplicativos corporativos‚Äù, o gerente de processos deve permanecer o mais fino e burro poss√≠vel: basta dar comandos aos sistemas e monitorar o status, mas ele pr√≥prio n√£o deve fazer nada. </p><br><p>  Obviamente, h√° cen√°rios mais complexos quando voc√™ precisa executar algumas a√ß√µes de compensa√ß√£o para lidar com exce√ß√µes.  Em seguida, o manipulador de m√°quina de estado ‚Äú.Catch‚Äù √© usado para capturar uma exce√ß√£o de um determinado tipo e, em seguida, executar a l√≥gica de compensa√ß√£o. </p><br><p>  E se voc√™ apenas precisa prometer uma exce√ß√£o, √© melhor usar um observador (Observer). </p><br><p>  Agora imagine a situa√ß√£o em que j√° executamos o comando Enviar durante o processamento da mensagem, ap√≥s o qual ocorreu uma exce√ß√£o.  O que acontecer√° com o comando enviado nesta etapa?  Afinal, tudo o que voou para longe n√£o pode ser devolvido?  Mas aqui tudo est√° pensado. </p><br><p>  Ao configurar o barramento, voc√™ pode ativar a op√ß√£o UseInMemoryOutbox.  Esta op√ß√£o permite que voc√™ n√£o envie mensagens at√© que a etapa atual seja conclu√≠da.  Se ocorrer uma exce√ß√£o, as mensagens n√£o ser√£o enviadas.  Aqui est√° um trecho da documenta√ß√£o: </p><br><pre> <code class="hljs pgsql">/// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Includes an outbox <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the consume <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span>, which delays outgoing messages <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span> /// <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the pipeline <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the outbox <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>. At this <span class="hljs-type"><span class="hljs-type">point</span></span>, the message execution pipeline should be /// nearly complete <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> the ack remaining. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> an <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> thrown, the messages are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> sent/published. /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="configurator"&gt;The pipe configurator&lt;/param&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> UseInMemoryOutbox(this IConsumePipeConfigurator configurator)</code> </pre> <br><h2>  Testes </h2><br><p>  √Ä primeira vista, testar uma m√°quina de estado ass√≠ncrona ainda √© um prazer.  Mas aqui est√° tudo bem.  O MassTransit fornece uma boa estrutura de escrita de teste que atende totalmente a todas as nossas necessidades para testar uma m√°quina de estado. </p><br><p>  A estrutura fornece ao InMemory uma implementa√ß√£o do barramento de dados (InMemoryTestHarness), que permite enviar e receber mensagens ignorando o RabbitMQ ou outra fila. </p><br><p>  Bem, como um exemplo: </p><br><pre> <code class="hljs pgsql">[TestFixture] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SagaTests : TestFixtureBase { protected const string HostName = "HostName"; protected InMemoryTestHarness Harness; protected StateMachine StateMachine; protected StateMachineSagaTestHarness&lt;GabrielConfigurationRequestSaga, StateMachine&gt; Saga; [SetUp] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SetUp() { StateMachine = (StateMachine)Kernel. <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>&lt;MassTransitStateMachine&lt;WorkflowSaga&gt;&gt;(); Harness = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> InMemoryTestHarness(HostName); Saga = Harness .StateMachineSaga&lt;WorkflowSaga, StateMachine&gt;(StateMachine); } [TearDown] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TearDown() { await Harness.Stop(); } protected async Task&lt;WorkflowSaga&gt; InitializeSaga() { await Harness.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); var command = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TestStartWorkflowCommand { CorrelationId = SagaId, Author = RequestAuthor, InitialRequestViewUrl = InitialRequestViewUrl, RequestText = RequestText, RequestNumber = RequestNumber, }; await Harness.InputQueueSendEndpoint .Send&lt;IStartWorkflowCommand&gt;(command); //    ,  consume    , // ,  Saga  ,    <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(Harness.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;IStartWorkflowCommand&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); var currentSaga = Saga.Created.Contains(SagaId); currentSaga.RelatedPlannerTasks = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;RelatedPlannerTask&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSaga; } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task CheckCurrntStateWhenStartWorkflowCommand() { var saga = await InitializeSaga(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsNotNull(saga); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(StateMachine .AwaitingORDTApproveTaskCreatedInPlanner.Name, saga.CurrentState); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WhenTaskCreated : SagaTestsBase { private async Task&lt;WorkflowSaga&gt; InitializeState() { var saga = await InitializeSaga(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); saga.CurrentState = StateMachine.AwaitingTaskCreated.Name; InitializeRelatedTask(saga); await SendTaskCreatedNotification(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(Harness.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;TaskCreatedNotification&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> saga; } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task SaveWorkflowDataWhenTaskCreated() { var saga = await InitializeState(); var taskInfo = saga.RelatedPlannerTasks .First(task =&gt; task.PlannerTaskType == PlannerTaskType.DPORPApprove); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskNumber, taskInfo.Number); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskUrl, taskInfo.TaskUrl); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(SagaId, taskInfo.SagaCorrelationId); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskStatus.Created, taskInfo.Status); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, taskInfo.ModifiedBy); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(saga.CurrentState, StateMachine.AwaitingTaskTakedToWork.Name); } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task SendsMailWhenTaskCreated() { var mailConsumer = Harness .Consumer&lt;MockConsumer&lt;ISendEmailMessageWithTemplateCommand&gt;&gt; (RabbitMqRouting.QueueNames .SendEmailsQueueName); await InitializeState(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(mailConsumer.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;ISendEmailMessageWithTemplateCommand&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); } private async Task SendTaskCreatedNotification() { await Harness.InputQueueSendEndpoint .Send(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TaskCreatedNotification { TaskUrl = TaskUrl, Number = TaskNumber, TaskModifiedBy = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, CorrelationId = SagaId }); } }</code> </pre><br><p>  Os testes s√£o bem r√°pidos.  Por exemplo, no computador de um √∫nico desenvolvedor, 850 testes s√£o executados em cerca de 21 segundos. </p><br><h2>  Dicas √∫teis </h2><br><p>  Em conclus√£o, damos uma lista de dicas √∫teis com base em nossa experi√™ncia. </p><br><ol><li><p>  Contratos e esquemas de comunica√ß√£o de barramento s√£o melhor colocados em um nuget privado.  Portanto, voc√™ n√£o ter√° diferen√ßas nos nomes nos lados de envio e recebimento.  Voc√™ tamb√©m pode colocar constantes com filas de nomes e hosts no nuget.  Nuget √© personaliz√°vel por dia.  E tamb√©m alguns controles de origem suportam nuget, existem feeds privados pagos. </p><br></li><li><p>  Entenda as diferen√ßas entre Enviar e Publicar.  Use Enviar se voc√™ tiver um assinante e souber exatamente o nome da fila para a qual voc√™ enviou o comando.  A publica√ß√£o foi projetada para enviar alertas de transmiss√£o.  Detalhes no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> . </p><br></li><li><p>  Se voc√™ precisar criar uma mensagem de Solicita√ß√£o / Resposta, √© melhor adicionar o nome da fila da resposta ao contrato do que usar o esquema de Solicita√ß√£o / Resposta do MassTransit, o que o pr√≥prio MassTransit sugere evitar.  Uma vez que isso reduz muito a confiabilidade.  Voc√™ est√° perdendo todos os benef√≠cios da assincronia.  Mas se voc√™ ainda precisar obter uma resposta em um tempo limitado, √© melhor usar uma chamada direta.  √â melhor escrever isso no mesmo livro, "Modelos de integra√ß√£o de aplicativos corporativos". </p><br></li><li><p>  Saga deve ser magra.  Tente levar toda a l√≥gica pesada para outros sistemas.  E Saga deve passar pelos estados e espalhar as mensagens para a esquerda e para a direita. </p><br></li><li><p>  Adicione a todas as mensagens CorrelationId, que ser√£o executadas entre os sistemas.  Portanto, √© muito mais f√°cil analisar os logs e vincular todas as mensagens em uma √∫nica imagem.  Masstransit tamb√©m faz o mesmo.  CorrelationId √© adicionado √†s mensagens ao herdar da interface CorrelatedBy. <br></p><br>  Configure logs e monitoramento em seus sistemas, isso nunca ser√° prejudicial.  Nossa experi√™ncia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste artigo</a> . <br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt412793/">https://habr.com/ru/post/pt412793/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt412783/index.html">Instalando o proxy MTProto Telegram da origem no Centos 7</a></li>
<li><a href="../pt412785/index.html">Mestre em Gest√£o e Freelancer. A hist√≥ria em tr√™s partes</a></li>
<li><a href="../pt412787/index.html">Incorporando o Git em um sistema de desenvolvimento corporativo</a></li>
<li><a href="../pt412789/index.html">‚ÄúAjuda no trabalho‚Äù: como tornar os bots de bate-papo mais inteligentes</a></li>
<li><a href="../pt412791/index.html">Melhorando o desempenho do sistema de videovigil√¢ncia e prevenindo falhas</a></li>
<li><a href="../pt412795/index.html">E vamos tirar conclus√µes da discuss√£o do artigo "O que h√° de errado com o retorno dos Geektimes a Habr"</a></li>
<li><a href="../pt412797/index.html">Sobre os perigos da CDN, servi√ßos e fontes do Google</a></li>
<li><a href="../pt412799/index.html">Sempre em contato: Mango Talker - messenger e softphone</a></li>
<li><a href="../pt412801/index.html">Estudo: hackers roubam milh√µes de d√≥lares devido √† baixa seguran√ßa das trocas de criptomoedas</a></li>
<li><a href="../pt412803/index.html">Um olhar mais profundo sobre as v√°rias plataformas de contratos inteligentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>