<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯзФЁЯП╝ ЁЯЫ╢ ЁЯПг Linux рдХреЗ рд▓рд┐рдП x86_64 ELF рдлрд╝рд╛рдЗрд▓ рдкреИрдХрд░ рдмрдирд╛рдирд╛ ЁЯУ░ ЁЯЩЗ ЁЯТи</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдкрд░рд┐рдЪрдп 
 рдпрд╣ рдкреЛрд╕реНрдЯ linux x86_64 рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд░рд▓ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓ рдкреИрдХрд░ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдЧреАред рдпрд╣ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдкрд╛рдардХ рд╕реА рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛, x86_64 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Linux рдХреЗ рд▓рд┐рдП x86_64 ELF рдлрд╝рд╛рдЗрд▓ рдкреИрдХрд░ рдмрдирд╛рдирд╛</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483368/"><h2>  рдкрд░рд┐рдЪрдп </h2><br>  рдпрд╣ рдкреЛрд╕реНрдЯ linux x86_64 рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд░рд▓ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓ рдкреИрдХрд░ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдЧреАред  рдпрд╣ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдкрд╛рдардХ рд╕реА рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рднрд╛рд╖рд╛, x86_64 рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рд▓рд┐рдП рдЕрд╕реЗрдВрдмрд▓реА рднрд╛рд╖рд╛ рдФрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдИрдПрд╕рдЖрдИ рдлрд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рд╛рде рдкрд░рд┐рдЪрд┐рдд рд╣реИред  рд╕реНрдкрд╖реНрдЯрддрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд▓реЗрдЦ рдореЗрдВ рддреНрд░реБрдЯрд┐ рд╕реЗ рдирд┐рдкрдЯрдиреЗ рдХреЛ рдХреЛрдб рд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдФрд░ рдХреБрдЫ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЛ рдирд╣реАрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рдерд╛, рдкреВрд░рд╛ рдХреЛрдб рдЬреАрдердм ( <a href="https://github.com/cyberfined/cryload">рд▓реЛрдбрд░</a> , <a href="https://github.com/cyberfined/cryptor">рдкреИрдХрд░</a> ) рдХреЗ рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред <br><br>  рд╡рд┐рдЪрд╛рд░ рдпрд╣ рд╣реИ: рд╣рдо ELF рдлрд╝рд╛рдЗрд▓ рдХреЛ рдкреИрдХрд░ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рд╣рдореЗрдВ рдЖрдЙрдЯрдкреБрдЯ рдкрд░ рдирд┐рдореНрди рд╕рдВрд░рдЪрдирд╛ рдХреЗ рд╕рд╛рде рдПрдХ рдирдпрд╛ рдорд┐рд▓рддрд╛ рд╣реИ: <br><div class="scrollable-table"><table><tbody><tr><td colspan="2">  рдИрдПрд▓рдПрдл рд╣реЗрдбрд░ </td></tr><tr><td colspan="2">  рдХрд╛рд░реНрдпрдХреНрд░рдо рдХрд╛ рд╢реАрд░реНрд╖рдХ </td></tr><tr><td rowspan="3">  рдХреЛрдб рд╕реЗрдЧрдореЗрдВрдЯ </td><td>  рдкреИрдХреЗрдЬреНрдб рдИрдПрд▓рдПрдл рдлрд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдбрд░ </td></tr><tr><td>  рдкреИрдХреНрдб ELF рдлрд╝рд╛рдЗрд▓ <br></td></tr><tr><td>  рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдбреЗрдЯрд╛ рдХреЗ 256 рдмрд╛рдЗрдЯреНрд╕ </td></tr></tbody></table></div><a name="habracut"></a><br>  рд╕рдВрдкреАрдбрд╝рди рдХреЗ рд▓рд┐рдП, рд╣рдлрд╝рдореИрди рдПрд▓реНрдЧреЛрд░рд┐рджрдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд▓рд┐рдП - рдПрдИрдПрд╕-рд╕реАрдЯреАрдЖрд░ рдПрдХ 256-рдмрд┐рдЯ рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде, рдЕрд░реНрдерд╛рддреН рдХреЛрдХреЗрдХ рдЯрд╛рдЗрди <a href="https://github.com/kokke/tiny-AES-c">-рдПрдИрдПрд╕-рд╕реА</a> рд╕реЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрдиред  рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдбреЗрдЯрд╛ рдХреЗ 256 рдмрд╛рдЗрдЯреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдИрдПрд╕ рдХреБрдВрдЬреА рдФрд░ рдЖрд░рдВрднреАрдХрд░рдг рд╡реЗрдХреНрдЯрд░ рдХреЛ рдЫрджреНрдо рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд╕рдВрдЦреНрдпрд╛ рдЬрдирд░реЗрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдиреАрдЪреЗ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { seed = (<span class="hljs-number"><span class="hljs-number">1103515245</span></span>*seed + <span class="hljs-number"><span class="hljs-number">12345</span></span>) % <span class="hljs-number"><span class="hljs-number">256</span></span>; key[i] = buf[seed]; }</code> </pre> <br>  рдпрд╣ рдирд┐рд░реНрдгрдп рд░рд┐рд╡рд░реНрд╕ рдЗрдВрдЬреАрдирд┐рдпрд░рд┐рдВрдЧ рдХреЛ рдЬрдЯрд┐рд▓ рдмрдирд╛рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рдХреЗ рдХрд╛рд░рдг рд╣реБрдЖ рдерд╛ред  рдЖрдЬ рддрдХ, рдореИрдВрдиреЗ рдорд╣рд╕реВрд╕ рдХрд┐рдпрд╛ рдХрд┐ рдЬрдЯрд┐рд▓рддрд╛ рдирд┐рд░рд░реНрдердХ рд╣реИ, рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рдЗрд╕реЗ рджреВрд░ рдХрд░рдирд╛ рд╢реБрд░реВ рдирд╣реАрдВ рдХрд┐рдпрд╛, рдХреНрдпреЛрдВрдХрд┐ рдореИрдВ рдЙрд╕ рдкрд░ рд╕рдордп рдФрд░ рдКрд░реНрдЬрд╛ рдЦрд░реНрдЪ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рдерд╛ред <br><br><h2>  рд▓реЛрдбрд░ </h2><br>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдмреВрдЯ рд▓реЛрдбрд░ рдХреА рд╕рдореАрдХреНрд╖рд╛ рдХреА рдЬрд╛рдПрдЧреАред  рд▓реЛрдбрд░ рдореЗрдВ рдХреЛрдИ рдирд┐рд░реНрднрд░рддрд╛ рдирд╣реАрдВ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП, рдЗрд╕рд▓рд┐рдП рдорд╛рдирдХ рд╕реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╕реЗ рд╕рднреА рдЖрд╡рд╢реНрдпрдХ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд╕реНрд╡рддрдВрддреНрд░ рд░реВрдк рд╕реЗ рд▓рд┐рдЦрдирд╛ рд╣реЛрдЧрд╛ (рдЗрди рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди <a href="">рд╕рдВрджрд░реНрдн</a> рджреНрд╡рд╛рд░рд╛ рдЙрдкрд▓рдмреНрдз рд╣реИ)ред  рдпрд╣ рднреА рд╕реНрдерд┐рддрд┐ рд╕реНрд╡рддрдВрддреНрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред <br><br><h3>  _Start рдлрд╝рдВрдХреНрд╢рди </h3><br>  рдмреВрдЯрд▓реЛрдбрд░ _start рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдмрд╕ argc рдФрд░ argv рд╕реЗ рдЧреБрдЬрд░рддрд╛ рд╣реИ: <br><br><pre> <code class="plaintext hljs">.extern main .globl _start .text _start: movq (%rsp), %rdi movq %rsp, %rsi addq $8, %rsi call main</code> </pre><br><h3>  рдореБрдЦреНрдп рд╕рдорд╛рд░реЛрд╣ </h3><br>  Main.c рдлрд╝рд╛рдЗрд▓ рдХрдИ рдмрд╛рд╣рд░реА рдЪрд░ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдиреЗ рд╕реЗ рд╢реБрд░реВ рд╣реЛрддреА рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* loader_end; <span class="hljs-comment"><span class="hljs-comment">//    , .   //  ELF . extern size_t payload_size; //   ELF  extern size_t key_seed; //     // -   . extern size_t iv_seed; //     // -    </span></span></code> </pre><br>  рдкреИрдХрд░ рдореЗрдВ рдЪрд░ (Elf64_Sym) рдХреЗ рдЕрдиреБрд░реВрдк рд╡рд░реНрдгреЛрдВ рдХреА рд╕реНрдерд┐рддрд┐ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдФрд░ рдЙрдирдХреЗ рдореВрд▓реНрдпреЛрдВ рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдирдореЗрдВ рд╕реЗ рд╕рднреА рдХреЛ рдмрд╛рд╣рд░реА рдШреЛрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br>  рдореБрдЦреНрдп рдХрд╛рд░реНрдп рдЕрдкрдиреЗ рдЖрдк рдореЗрдВ рдХрд╛рдлреА рд╕рд░рд▓ рд╣реИред  рдкрд╣рд▓рд╛ рдХрджрдо рдПрдХ рднрд░реЗ рд╣реБрдП рдИрдПрд▓рдПрдл рдлрд╝рд╛рдЗрд▓, рдПрдХ 256-рдмрд╛рдЗрдЯ рдмрдлрд░, рдФрд░ рд╕реНрдЯреИрдХ рдХреЗ рд╢реАрд░реНрд╖ рдкрд░ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИред  рдлрд┐рд░ рдИрдПрд▓рдПрдл рдлрд╝рд╛рдЗрд▓ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдФрд░ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдлрд┐рд░ рдЗрд╕реЗ рд▓реЛрдб_рдлреНрд▓реЛ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдореЗрдореЛрд░реА рдореЗрдВ рд╕рд╣реА рд╕реНрдерд╛рди рдкрд░ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдЕрдВрдд рдореЗрдВ, рдЖрд░рдПрд╕рдкреА рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛ рдореВрд▓реНрдп рдЗрд╕рдХреА рдореВрд▓ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд▓реМрдЯрддрд╛ рд╣реИ, рдФрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдПрдВрдЯреНрд░реА рдкреЙрдЗрдВрдЯ рдкрд░ рдПрдХ рдХреВрдж рд╣реЛрддрд╛ рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SET_STACK(sp) __asm__ __volatile__ (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %0, %%rsp"</span></span></span><span class="hljs-meta">::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta">(sp)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> JMP(addr) __asm__ __volatile__ (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jmp *%0"</span></span></span><span class="hljs-meta">::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta">(addr)) int main(int argc, char **argv) { uint8_t *payload = (uint8_t*)&amp;loader_end; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//    // ELF  uint8_t *entropy_buf = payload + payload_size; //   256- //  void *rsp = argv-1; //     struct AES_ctx ctx; AES_init_ctx_iv(&amp;ctx, entropy_buf, key_seed, iv_seed); //  AES AES_CTR_xcrypt_buffer(&amp;ctx, payload, payload_size); //  ELF memset(&amp;ctx, 0, sizeof(ctx)); //   AES size_t decoded_payload_size; //  ELF char *decoded_payload = huffman_decode((char*)payload, payload_size, &amp;decoded_payload_size); //     ELF  , //   ET_EXEC  NULL. void *load_addr = elf_load_addr(rsp, decoded_payload, decoded_payload_size); load_addr = load_elf(load_addr, decoded_payload); //  ELF  , //    //  . memset(decoded_payload, 0, decoded_payload_size); //   ELF munmap(decoded_payload, decoded_payload_size); //   //    //  ELF     AES AES_init_ctx_iv(&amp;ctx, entropy_buf, key_seed, iv_seed); AES_CTR_xcrypt_buffer(&amp;ctx, payload, payload_size); memset(&amp;ctx, 0, sizeof(ctx)); SET_STACK(rsp); //    JMP(load_addr); //       }</span></span></span></span></code> </pre><br>  рдПрдИрдПрд╕ рдФрд░ рд╡рд┐рдШрдЯрд┐рдд рдИрдПрд▓рдПрдл рдлрд╝рд╛рдЗрд▓ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рд░реАрд╕реЗрдЯ рдХрд░рдирд╛ рд╕реБрд░рдХреНрд╖рд╛ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ - рддрд╛рдХрд┐ рдХреБрдВрдЬреА рдФрд░ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдП рдЧрдП рдбреЗрдЯрд╛ рдХреЛ рдХреЗрд╡рд▓ рдЙрдкрдпреЛрдЧ рдХреЗ рд╕рдордп рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рдПред <br><br>  рдЖрдЧреЗ рдХреБрдЫ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред <br><br><h3>  load_elf </h3><br>  рдореИрдВрдиреЗ рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЕрдкрдиреЗ рдпреВрдЬрд░рд▓реИрдВрдбрдПрдХреНрд╕ec рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рд╕реЗ рдЙрдкрдирд╛рдо рдмреЗрдбрд┐рдЧрд░ рдХреЗ рд╕рд╛рде рдЬреАрдердм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рд▓рд┐рдпрд╛ рдФрд░ рдЗрд╕реЗ рдЕрдВрддрд┐рдо рд░реВрдк рджрд┐рдпрд╛, рдХреНрдпреЛрдВрдХрд┐ рдореВрд▓ рдлрд╝рдВрдХреНрд╢рди ET_DYN рдЬреИрд╕реА рдлрд╝рд╛рдЗрд▓реЛрдВ рдкрд░ рдХреНрд░реИрд╢ рд╣реЛ рдЧрдпрд╛ред  рд╡рд┐рдлрд▓рддрд╛ рдЗрд╕ рддрдереНрдп рдХреЗ рдХрд╛рд░рдг рд╣реБрдИ рдХрд┐ рдПрдордПрдордПрдкреА рдкреНрд░рдгрд╛рд▓реА рдХреЙрд▓ рдХреЗ рдкрд╣рд▓реЗ рддрд░реНрдХ рдХрд╛ рдореВрд▓реНрдп NULL рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдкрддрд╛ рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЗ рдХрд╛рдлреА рдХрд░реАрдм рд▓реМрдЯ рдЖрдпрд╛ рдерд╛, рдмрд╛рдж рдореЗрдВ рдореИрдордк рдХреЛ рдХреЙрд▓ рдФрд░ рдЙрдирдХреЗ рджреНрд╡рд╛рд░рд╛ рджрд┐рдП рдЧрдП рдкрддреЗ рдкрд░ рд╕реЗрдЧрдореЗрдВрдЯ рдХреЙрдкреА рдХрд░рдиреЗ рдХреЗ рджреМрд░рд╛рди, рдореБрдЦреНрдп рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХрд╛ рдХреЛрдб рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рд╕реЗрдЧрдлреЙрд▓реНрдЯ рд╣реБрдЖред  рдЗрд╕рд▓рд┐рдП, рд▓реЛрдбрд┐рдВрдЧ / рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рд╢реБрд░реБрдЖрддреА рдкрддреЗ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред  рдлрд╝рдВрдХреНрд╢рди рд╕реНрд╡рдпрдВ рд╕рднреА рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬрд╛рддрд╛ рд╣реИ, рдПрд▓рдИрдПрдл рдлрд╝рд╛рдЗрд▓ рдХреЗ PT_LOAD рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддрд╛ рд╣реИ (рдЗрд╕рдХреА рд╕рдВрдЦреНрдпрд╛ рдкреГрд╖реНрда рдЖрдХрд╛рд░ рдХрд╛ рдПрдХ рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП), рдЖрд╡рдВрдЯрд┐рдд рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░реЛрдВ рдореЗрдВ рдЙрдирдХреА рд╕рд╛рдордЧреНрд░реА рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рдЗрди рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП рдЗрд╕реА рдкрдврд╝рдиреЗ, рд▓рд┐рдЦрдиреЗ, рдирд┐рд╖реНрдкрд╛рджрди рдЕрдзрд┐рдХрд╛рд░ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      #define PAGEUP(x) (((unsigned long)x + 4095)&amp;(~4095)) //      #define PAGEDOWN(x) ((unsigned long)x&amp;(~4095)) void* load_elf(void *load_addr, void *mapped) { Elf64_Ehdr *ehdr = mapped; Elf64_Phdr *phdr = mapped + ehdr-&gt;e_phoff; void *text_segment = NULL; unsigned long initial_vaddr = 0; unsigned long brk_addr = 0; for(size_t i = 0; i &lt; ehdr-&gt;e_phnum; i++, phdr++) { unsigned long rounded_len, k; void *segment; //   PT_LOAD,    if(phdr-&gt;p_type != PT_LOAD) continue; if(text_segment != 0 &amp;&amp; ehdr-&gt;e_type == ET_DYN) { //  ET_DYN phdr-&gt;p_vaddr    , //        //    ,      //     load_addr = text_segment + phdr-&gt;p_vaddr - initial_vaddr; load_addr = (void*)PAGEDOWN(load_addr); } else if(ehdr-&gt;e_type == ET_EXEC) { //  ET_EXEC phdr-&gt;p_vaddr     load_addr = (void*)PAGEDOWN(phdr-&gt;p_vaddr); } //        rounded_len = phdr-&gt;p_memsz + (phdr-&gt;p_vaddr % 4096); rounded_len = PAGEUP(rounded_len); //        segment = mmap(load_addr, rounded_len, PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, -1, 0); if(ehdr-&gt;e_type == ET_EXEC) load_addr = (void*)phdr-&gt;p_vaddr; else load_addr = segment + (phdr-&gt;p_vaddr % 4096); //         memcpy(load_addr, mapped + phdr-&gt;p_offset, phdr-&gt;p_filesz); if(!text_segment) { text_segment = segment; initial_vaddr = phdr-&gt;p_vaddr; } unsigned int protflags = 0; if(phdr-&gt;p_flags &amp; PF_R) protflags |= PROT_READ; if(phdr-&gt;p_flags &amp; PF_W) protflags |= PROT_WRITE; if(phdr-&gt;p_flags &amp; PF_X) protflags |= PROT_EXEC; mprotect(segment, rounded_len, protflags); //   // , ,  k = phdr-&gt;p_vaddr + phdr-&gt;p_memsz; if(k &gt; brk_addr) brk_addr = k; } if (ehdr-&gt;e_type == ET_EXEC) { brk(PAGEUP(brk_addr)); //  ET_EXEC ehdr-&gt;e_entry     load_addr = (void*)ehdr-&gt;e_entry; } else { //  ET_DYN ehdr-&gt;e_entry    , //           load_addr = (void*)ehdr + ehdr-&gt;e_entry; } return load_addr; //       }</span></span></code> </pre><br><h3>  elf_load_addr </h3><br>  ET_EXEC ELF рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдпрд╣ рдлрд╝рдВрдХреНрд╢рди NULL рд▓реМрдЯрд╛рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреА рдлрд╛рдЗрд▓реЗрдВ рдЙрдирдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрддреЗ рдкрд░ рд╕реНрдерд┐рдд рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред  ET_DYN рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд▓рд┐рдП, рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо (рдпрд╛рдиреА, рдмреВрдЯрд▓реЛрдбрд░) рдХреЗ рдЖрдзрд╛рд░ рдкрддреЗ рдХреЗ рдмреАрдЪ рдЕрдВрддрд░ рдХреЗ рдмрд░рд╛рдмрд░ рдкрддрд╛, рдореЗрдореЛрд░реА рдореЗрдВ ELF рдХреЛ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдореЗрдореЛрд░реА рдХреА рдорд╛рддреНрд░рд╛, рдФрд░ 4096, 4096 - рдЕрдВрддрд░рд╛рд▓ рддрд╛рдХрд┐ рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЗ рдареАрдХ рдмрдЧрд▓ рдореЗрдВ ELF рдлрд╝рд╛рдЗрд▓ рдХреЛ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣рд▓реЗ рдЧрдгрдирд╛ рдирд╣реАрдВ рдХреА рдЬрд╛рддреА рд╣реИред  рдЗрд╕ рдкрддреЗ рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдпрд╣ рдЬрд╛рдВрдЪрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рдЕрдВрддрд░рд┐рдд рд╣реИ, рджрд┐рдП рдЧрдП рдкрддреЗ рд╕реЗ рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЗ рдЖрдзрд╛рд░ рдкрддреЗ рддрдХ, рдЕрдирдкреИрдХреНрдб рдИрдПрд▓рдПрдл рдлрд╝рд╛рдЗрд▓ рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдЗрд╕рдХреЗ рдЕрдВрдд рддрдХ рдХрд╛ рдХреНрд╖реЗрддреНрд░ред  рдЪреМрд░рд╛рд╣реЗ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдкрддреЗ рдХреЛ рдЕрдирдкреИрдХ рдХрд┐рдП рдЧрдП рдИрдПрд▓рдПрдл рдХреЗ рдкреНрд░рд╛рд░рдВрдн рдкрддреЗ рдФрд░ рдЗрд╕реЗ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдореЗрдореЛрд░реА рдХреА рдорд╛рддреНрд░рд╛ рдХреЗ рдмреАрдЪ рдЕрдВрддрд░ рдХреЗ рдмрд░рд╛рдмрд░ рд▓реМрдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЕрдиреНрдпрдерд╛ рдкрд╣рд▓реЗ рд╕реЗ рдЧрдгрдирд╛ рдХрд┐рдП рдЧрдП рдкрддреЗ рдХреЛ рд╡рд╛рдкрд╕ рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br>  рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХрд╛ рдЖрдзрд╛рд░ рдкрддрд╛ рд╕рд╣рд╛рдпрдХ рд╡реЗрдХреНрдЯрд░ (ELF рд╕рд╣рд╛рдпрдХ рд╡реЗрдХреНрдЯрд░) рд╕реЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рдХрд╛ рдкрддрд╛ рдирд┐рдХрд╛рд▓рдХрд░ рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рд╕реНрдЯреИрдХ рдореЗрдВ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдХреЗ рд╕рдВрдХреЗрдд рдХреЗ рдмрд╛рдж рд╕реНрдерд┐рдд рд╣реИ, рдФрд░ рдЗрд╕рдХреЗ рд╕рд╛рде ELF рд╣реЗрдбрд░ рдХреЗ рдЖрдХрд╛рд░ рдХреЛ рдШрдЯрд╛рдХрд░: <br><br><pre> <code class="plaintext hljs">      ---------------------------------------------------------------------------    -&gt; [ argc ] 8 [ argv[0] ] 8 [ argv[1] ] 8 [ argv[..] ] 8 * x [ argv[n тАУ 1] ] 8 [ argv[n] ] 8 (= NULL) [ envp[0] ] 8 [ envp[1] ] 8 [ envp[..] ] 8 [ envp[term] ] 8 (= NULL) [ auxv[0] (Elf64_auxv_t) ] 16 [ auxv[1] (Elf64_auxv_t) ] 16 [ auxv[..] (Elf64_auxv_t) ] 16 [ auxv[term] (Elf64_auxv_t) ] 16 (= AT_NULL) [  ] 0 - 16 [    ] &gt;= 0 [   ] &gt;= 0 [   ] 8 (= NULL) &lt;    &gt; 0 ---------------------------------------------------------------------------</code> </pre><br>  рд╡рд╣ рд╕рдВрд░рдЪрдирд╛ рдЬрд┐рд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╕рд╣рд╛рдпрдХ рд╡реЗрдХреНрдЯрд░ рдХреЗ рдкреНрд░рддреНрдпреЗрдХ рддрддреНрд╡ рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> a_type; <span class="hljs-comment"><span class="hljs-comment">//   union { uint64_t a_val; //  } a_un; } Elf64_auxv_t;</span></span></code> </pre><br>  рдорд╛рдиреНрдп a_type рдорд╛рдиреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ AT_PHDR рд╣реИ, a_val рддрдм рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░реЗрдЧрд╛ред  рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд elf_load_addr рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдХреЛрдб рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elf_base_addr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rsp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *base_addr = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> argc = *(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>*)rsp; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **envp = rsp + (argc+<span class="hljs-number"><span class="hljs-number">2</span></span>)*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    //   while(*envp++); //        Elf64_auxv_t *aux = (Elf64_auxv_t*)envp; //    //  for(; aux-&gt;a_type != AT_NULL; aux++) { //        if(aux-&gt;a_type == AT_PHDR) { //   ELF ,     //      base_addr = (void*)(aux-&gt;a_un.a_val тАУ sizeof(Elf64_Ehdr)); break; } } return base_addr; } size_t elf_memory_size(void *mapped) { Elf64_Ehdr *ehdr = mapped; Elf64_Phdr *phdr = mapped + ehdr-&gt;e_phoff; size_t mem_size = 0, segment_len; for(size_t i = 0; i &lt; ehdr-&gt;e_phnum; i++, phdr++) { if(phdr-&gt;p_type != PT_LOAD) continue; segment_len = phdr-&gt;p_memsz + (phdr-&gt;p_vaddr % 4096); mem_size += PAGEUP(segment_len); } return mem_size; } void* elf_load_addr(void *rsp, void *mapped, size_t mapped_size) { Elf64_Ehdr *ehdr = mapped; if(ehdr-&gt;e_type == ET_EXEC) return NULL; size_t mem_size = elf_memory_size(mapped) + 0x1000; void *load_addr = elf_base_addr(rsp); if(mapped &lt; load_addr &amp;&amp; mapped + mapped_size &gt; load_addr - mem_size) load_addr = mapped; return load_addr - mem_size; }</span></span></code> </pre><br><h3>  рд▓рд┐рдВрдХрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╡рд┐рд╡рд░рдг </h3><br>  рдЙрдкрд░реЛрдХреНрдд рд╡рд░реНрдгрд┐рдд рдмрд╛рд╣рд░реА рдЪрд░ рдХреЗ рд▓рд┐рдП рд╡рд░реНрдгреЛрдВ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рдФрд░ рдпрд╣ рднреА рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рд╕рдВрдХрд▓рди рдХреЗ рдмрд╛рдж рдХреЛрдб рдФрд░ рд▓реЛрдбрд░ рдбреЗрдЯрд╛ рдПрдХ рд╣реА .text рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рд╣реИрдВред  рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдЗрд╕ рдЕрдиреБрднрд╛рдЧ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рдХрд╛рдЯрдХрд░ рд▓реЛрдбрд░ рдорд╢реАрди рдХреЛрдб рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдирд┐рдХрд╛рд▓рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред  рдЗрди рд▓рдХреНрд╖реНрдпреЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд▓рд┐рдВрдХрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд▓рд┐рдЦреА рдЧрдИ рдереА: <br><br><pre> <code class="plaintext hljs">ENTRY(_start) SECTIONS { . = 0; .text :{ *(.text) *(.text.startup) *(.data) *(.rodata) payload_size = .; QUAD(0) key_seed = .; QUAD(0) iv_seed = .; QUAD(0) loader_end = .; } }</code> </pre><br>  рдпрд╣ рд╕рдордЭрд╛рдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ QUAD (0) рд╢реВрдиреНрдп рдХреЗ 8 рдмрд╛рдЗрдЯреНрд╕ рд░рдЦрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдмрдЬрд╛рдп рдкреИрдХрд░ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдореВрд▓реНрдпреЛрдВ рдХреЛ рд╕реНрдерд╛рдирд╛рдкрдиреНрди рдХрд░реЗрдЧрд╛ред  рдорд╢реАрди рдХреЛрдб рдХреЛ рдХрд╛рдЯрдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рдЫреЛрдЯреА рд╕реА рдЙрдкрдпреЛрдЧрд┐рддрд╛ рд▓рд┐рдЦреА рдЧрдИ рдереА, рдЬреЛ рдорд╢реАрди рдХреЛрдб рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдмреВрдЯрд▓реЛрдбрд░ рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдмреВрдЯрд▓реЛрдбрд░ рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рдХреА рд╢рд┐рдлреНрдЯ рдХреЛ рд▓рд┐рдЦрддрд╛ рд╣реИ, рдмреВрдЯ рд▓реЛрдбрд░ рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдкреЗрд▓реЛрдб_рд╕рд╛рдЗрдЬ, рдХреА_рдПрдбреЗрдб рдФрд░ iv_seed рдЕрдХреНрд╖рд░реЛрдВ рдХреЗ рдореВрд▓реНрдпреЛрдВ рдХреА рднрд░рдкрд╛рдИ рдХрд░рддрд╛ рд╣реИред  рдЗрд╕ рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХрд╛ рдХреЛрдб <a href="">рдпрд╣рд╛рдБ</a> рдЙрдкрд▓рдмреНрдз <a href="">рд╣реИ</a> ред  рдпрд╣ рдмреВрдЯрд▓реЛрдбрд░ рд╡рд┐рд╡рд░рдг рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред <br><br><h2>  рд╕реАрдзреЗ рдкреИрдХрд░ </h2><br>  рдкреИрдХрд░ рдХреЗ рдореБрдЦреНрдп рдХрд╛рд░реНрдп рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВред  рдпрд╣ рджреЛ рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рддрд░реНрдХреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ: рдЗрдирдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдирд╛рдо argv [1] рд╣реИ рдФрд░ рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдирд╛рдо argv [2] рд╣реИред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдЗрдирдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдореЗрдореЛрд░реА рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдкреИрдХрд░ рдХреЗ рд╕рд╛рде рд╕рдВрдЧрддрддрд╛ рдХреЗ рд▓рд┐рдП рдЬрд╛рдБрдЪ рдХреА рдЬрд╛рддреА рд╣реИред  рдкреИрдХрд░ рдХреЗрд╡рд▓ рджреЛ рдкреНрд░рдХрд╛рд░ рдХреА рдИрдПрд▓рдПрдл рдлрд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: ET_EXEC рдФрд░ ET_DYN, рдФрд░ рдХреЗрд╡рд▓ рд╕рд╛рдВрдЦреНрдпрд┐рдХреАрдп рд░реВрдк рд╕реЗ рд╕рдВрдХрд▓рд┐рдд рд▓реЛрдЧреЛрдВ рдХреЗ рд╕рд╛рдеред  рдЗрд╕ рдкреНрд░рддрд┐рдмрдВрдз рдХреЛ рд╢реБрд░реВ рдХрд░рдиреЗ рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рдерд╛ рдХрд┐ рд╡рд┐рднрд┐рдиреНрди рд▓рд┐рдирдХреНрд╕ рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдореЗрдВ рд╕рд╛рдЭрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рд╕рдВрд╕реНрдХрд░рдг рд╣реИрдВ, рдЕрд░реНрдерд╛рддред  рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдХрд┐ рдПрдХ рдЧрддрд┐рд╢реАрд▓ рд╕рдВрдХрд▓рд┐рдд рдХрд╛рд░реНрдпрдХреНрд░рдо рдореВрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рд╕рд┐рд╕реНрдЯрдо рдкрд░ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛрдЧрд╛ред  рдореБрдЦреНрдп рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рд╕рдВрдмрдВрдзрд┐рдд рдХреЛрдб: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> mapped_size; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *mapped = map_file(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], &amp;mapped_size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(check_elf(mapped) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  рдЙрд╕рдХреЗ рдмрд╛рдж, рдпрджрд┐ рдЗрдирдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рд╕рдВрдЧрддрддрд╛ рдЬрд╛рдВрдЪ рд╕реЗ рдЧреБрдЬрд░рддреА рд╣реИ, рддреЛ рдпрд╣ рд╕рдВрдкреАрдбрд╝рд┐рдд рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> comp_size; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *comp_buf = huffman_encode(mapped, &amp;comp_size);</code> </pre><br>  рдЕрдЧрд▓рд╛, рдПрдИрдПрд╕ рд╕реНрдерд┐рддрд┐ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИ, рдФрд░ рд╕рдВрдХреБрдЪрд┐рдд рдИрдПрд▓рдПрдл рдлрд╝рд╛рдЗрд▓ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХреА рдЬрд╛рддреА рд╣реИред  рдПрдИрдПрд╕ рдХреА рд╕реНрдерд┐рддрд┐ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдВрд░рдЪрдирд╛ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AES_ENTROPY_BUFSIZE 256 typedef struct { uint8_t entropy_buf[AES_ENTROPY_BUFSIZE]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// 256-  size_t key_seed; //      size_t iv_seed; //       struct AES_ctx ctx; //  AES-CTR } AES_state_t;</span></span></span></span></code> </pre><br>  рдореБрдЦреНрдп рдореЗрдВ рдХреЛрдбрд┐рдВрдЧ: <br><br><pre> <code class="cpp hljs">AES_state_t aes_st; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; AES_ENTROPY_BUFSIZE; i++) state.entropy_buf[i] = rand() % <span class="hljs-number"><span class="hljs-number">256</span></span>; state.key_seed = rand(); state.iv_seed = rand(); AES_init_ctx_iv(&amp;state.ctx, state.entropy_buf, state.key_seed, state.iv_seed); AES_CTR_xcrypt_buffer(&amp;aes_st.ctx, comp_buf, comp_size);</code> </pre><br>  рдЙрд╕рдХреЗ рдмрд╛рдж, рдмреВрдЯрд▓реЛрдбрд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╕рдВрд░рдЪрдирд╛ рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдмреВрдЯрд▓реЛрдбрд░ рдореЗрдВ рдкреЗрд▓реЛрдб_рд╕рд╛рдЗрдЬрд╝, рдХреА_рд╕реЗрдб рдФрд░ iv_seed рд╡реИрд▓реНрдпреВ рдХреЛ рдкрд┐рдЫрд▓реЗ рдЪрд░рдг рдореЗрдВ рдЙрддреНрдкрдиреНрди рдЙрди рд▓реЛрдЧреЛрдВ рдореЗрдВ рдмрджрд▓ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рдПрдИрдПрд╕ рд╕реНрдЯреЗрдЯ рд░реАрд╕реЗрдЯ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред  рдмреВрдЯрд▓реЛрдбрд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *loader_begin; <span class="hljs-comment"><span class="hljs-comment">//      size_t entry_offset; //       size_t *payload_size_patch_offset; //     // ELF    size_t *key_seed_pacth_offset; //     //       size_t *iv_seed_patch_offset; //     //     //    size_t loader_size; //     } loader_t;</span></span></code> </pre><br>  рдореБрдЦреНрдп рдореЗрдВ рдХреЛрдбрд┐рдВрдЧ: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">loader_t</span></span> loader; init_loader(&amp;loader); *loader.payload_size_patch_offset = comp_size; *loader.key_seed_pacth_offset = aes_st.key_seed; *loader.iv_seed_patch_offset = aes_st.iv_seed; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;aes_st.ctx, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(aes_st.ctx));</code> </pre><br>  рдЕрдВрддрд┐рдо рднрд╛рдЧ рдореЗрдВ, рд╣рдо рдПрдХ рдЖрдЙрдЯрдкреБрдЯ рдлрд╛рдЗрд▓ рдмрдирд╛рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдИрдПрд▓рдПрдл рд╣реЗрдбрд░, рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░, рдПрдХ рд▓реЛрдбрд░ рдХреЛрдб, рдПрдХ рд╕рдВрдкреАрдбрд╝рд┐рдд рдФрд░ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдИрдПрд▓рдПрдл рдлрд╛рдЗрд▓ рдФрд░ рдПрдХ 256 рдмрд╛рдЗрдЯ рдмрдлрд░ рд▓рд┐рдЦрддреЗ рд╣реИрдВ: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> out_fd = open(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>], O_WRONLY | O_CREAT | O_TRUNC, <span class="hljs-number"><span class="hljs-number">0755</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  //   write_elf_ehdr(out_fd, &amp;loader); //  ELF  write_elf_phdr(out_fd, &amp;loader, comp_size); //    write(out_fd, loader.loader_begin, loader.loader_size); //   write(out_fd, comp_buf, comp_size); //     ELF write(out_fd, aes_st.entropy_buf, AES_ENTROPY_BUFSIZE); //  // 256- </span></span></code> </pre><br>  рдкреИрдХрд░ рдХрд╛ рдореБрдЦреНрдп рдХреЛрдб рдпрд╣рд╛рдВ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рдлрд┐рд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдпреЛрдВ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛: рдмреВрдЯрд▓реЛрдбрд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХрд╛ рдХрд╛рд░реНрдп, рдИрдПрд▓рдПрдл рд╣реЗрдбрд░ рд▓рд┐рдЦрдиреЗ рдХрд╛ рдХрд╛рд░реНрдп рдФрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рд▓рд┐рдЦрдиреЗ рдХрд╛ рдХрд╛рд░реНрдпред <br><br><h3>  рдЖрд░рдВрднрд┐рдХ рдмреВрдЯрд▓реЛрдбрд░ рдЬрд╛рдирдХрд╛рд░реА </h3><br>  рд▓реЛрдбрд░ рдорд╢реАрди рдХреЛрдб рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рд╕рд░рд▓ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреИрдХрд░ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдореЗрдВ рдПрдореНрдмреЗрдбреЗрдб рд╣реИ: <br><br><pre> <code class="plaintext hljs">.data .globl _loader_begin .globl _loader_end _loader_begin: .incbin "loader" _loader_end:</code> </pre><br>  рд╕реНрдореГрддрд┐ рдореЗрдВ рдЗрд╕рдХрд╛ рдкрддрд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореБрдЦреНрдп рдЪрд░ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд░ рдШреЛрд╖рд┐рдд рдХрд┐рдП рдЧрдП рд╣реИрдВ: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* _loader_begin; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* _loader_end;</code> </pre><br>  рдЕрдЧрд▓рд╛, init_loader рдлрд╝рдВрдХреНрд╢рди рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдорд╛рдиреЛрдВ рдХреЛ рдХреНрд░рдорд┐рдХ рд░реВрдк рд╕реЗ рдЗрд╕рдореЗрдВ рдкрдврд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ: рдмреВрдЯрд▓реЛрдбрд░ (рдПрдВрдЯреНрд░реА_рдСрдлрд╕реЗрдЯ) рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рдХреА рднрд░рдкрд╛рдИ, рдмреВрдЯрд▓реЛрдбрд░ (рдкреЗрд▓реЛрдбред Size_patch_offset) рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рд▓реЛрдб рдХрд┐рдП рдЧрдП ELF рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЖрдХрд╛рд░ рдХреА рдкрд╛рд░реА, рдмреВрдЯрд▓реЛрдбрд░ рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдХреБрдВрдЬреА рдХреЗ рд▓рд┐рдП рдЬрдирд░реЗрдЯрд░ рдХреЗ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдореВрд▓реНрдп рдХреА рдкрд╛рд░реАред рдмреВрдЯрд▓реЛрдбрд░ (iv_seed_patch_offset) рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗред  рдлрд┐рд░, рд▓реЛрдбрд░ рдкрддреЗ рдХреЛ рдЕрдВрддрд┐рдо рддреАрди рдорд╛рдиреЛрдВ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЬрдм рдмрд┐рдВрджреБрдУрдВ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдФрд░ рдЙрдиреНрд╣реЗрдВ рдорд╛рди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдЙрди рд▓реЗрдЖрдЙрдЯ рдЪрд░рдгреЛрдВ (QUAD (0)) рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╢реВрдиреНрдп рдХреЛ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВрдЧреЗ рдЬрд┐рдирдХреА рд╣рдореЗрдВ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_loader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loader_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *l)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *loader_begin = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)&amp;_loader_begin; l-&gt;entry_offset = *(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>*)loader_begin; loader_begin += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>); l-&gt;payload_size_patch_offset = *(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)loader_begin; loader_begin += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*); l-&gt;key_seed_pacth_offset = *(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)loader_begin; loader_begin += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*); l-&gt;iv_seed_patch_offset = *(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)loader_begin; loader_begin += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*); l-&gt;payload_size_patch_offset = (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)l-&gt;payload_size_patch_offset + loader_begin; l-&gt;key_seed_pacth_offset = (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)l-&gt;key_seed_pacth_offset + loader_begin; l-&gt;iv_seed_patch_offset = (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)l-&gt;iv_seed_patch_offset + loader_begin; l-&gt;loader_begin = loader_begin; l-&gt;loader_size = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)&amp;_loader_end - loader_begin; }</code> </pre><br><br><h3>  write_elf_ehdr </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_elf_ehdr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loader_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *loader)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ELF  Elf64_Ehdr ehdr; memset(ehdr.e_ident, 0, sizeof(ehdr.e_ident)); memcpy(ehdr.e_ident, ELFMAG, SELFMAG); ehdr.e_ident[EI_CLASS] = ELFCLASS64; ehdr.e_ident[EI_DATA] = ELFDATA2LSB; ehdr.e_ident[EI_VERSION] = EV_CURRENT; ehdr.e_ident[EI_OSABI] = ELFOSABI_NONE; ehdr.e_type = ET_DYN; ehdr.e_machine = EM_X86_64; ehdr.e_version = EV_CURRENT; ehdr.e_entry = sizeof(Elf64_Ehdr) + sizeof(Elf64_Phdr) + loader-&gt;entry_offset; ehdr.e_phoff = sizeof(Elf64_Ehdr); ehdr.e_shoff = 0; ehdr.e_flags = 0; ehdr.e_ehsize = sizeof(Elf64_Ehdr); ehdr.e_phentsize = sizeof(Elf64_Phdr); ehdr.e_phnum = 1; ehdr.e_shentsize = sizeof(Elf64_Shdr); ehdr.e_shnum = 0; ehdr.e_shstrndx = 0; write(fd, &amp;ehdr, sizeof(ehdr)); //     return 0; }</span></span></code> </pre><br>  рдпрд╣рд╛рдВ рдИрдПрд▓рдПрдл рд╣реЗрдбрд░ рдХрд╛ рдорд╛рдирдХ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝реЗрд╢рди рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рдЙрд╕рдХреЗ рдмрд╛рдж рдХреЗ рд▓реЗрдЦрди рдореЗрдВ, рдХреЗрд╡рд▓ рдПрдХ рдЪреАрдЬ рдЬреЛ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рд╡рд╣ рдпрд╣ рд╣реИ рдХрд┐ ET_DYN ELF рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ рдкрд╣рд▓реЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рджреНрд╡рд╛рд░рд╛ рд╡рд░реНрдгрд┐рдд рд╕реЗрдЧрдореЗрдВрдЯ рдореЗрдВ рди рдХреЗрд╡рд▓ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛрдб, рдмрд▓реНрдХрд┐ рдИрдПрд▓рдПрдл рд╣реЗрдбрд░ рдФрд░ рд╕рднреА рд╣реЗрдбрд░ рднреА рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рдХрд╛рд░реНрдпрдХреНрд░рдоред  рдЗрд╕рд▓рд┐рдП, рдЗрд╕рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдСрдлрд╕реЗрдЯ рд╢реВрдиреНрдп рдХреЗ рдмрд░рд╛рдмрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЖрдХрд╛рд░ рдИрдПрд▓рдПрдл рд╣реЗрдбрд░, рд╕рднреА рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛрдб рдХреЗ рдЖрдХрд╛рд░ рдХрд╛ рдпреЛрдЧ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдФрд░ рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рдИрдПрд▓рдПрдл рд╣реЗрдбрд░ рдХреЗ рдЖрдХрд╛рд░ рдХреЗ рдпреЛрдЧ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╕рднреА рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рдХрд╛ рдЖрдХрд╛рд░ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛрдб рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдСрдлрд╕реЗрдЯред <br><br><h3>  write_elf_phdr </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_elf_phdr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loader_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *loader, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> payload_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    Elf64_Phdr phdr; phdr.p_type = PT_LOAD; phdr.p_offset = 0; phdr.p_vaddr = 0; phdr.p_paddr = 0; phdr.p_filesz = sizeof(Elf64_Ehdr) + sizeof(Elf64_Phdr) + loader-&gt;loader_size + payload_size + AES_ENTROPY_BUFSIZE; phdr.p_memsz = phdr.p_filesz; phdr.p_flags = PF_R | PF_W | PF_X; phdr.p_align = 0x1000; write(fd, &amp;phdr, sizeof(phdr)); //      }</span></span></code> </pre><br>  рдпрд╣рд╛рдВ, рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдПрдХ рдлрд╛рдЗрд▓ рдкрд░ рд▓рд┐рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЖрдкрдХреЛ рдлрд╝рд╛рдЗрд▓ рдХреА рд╢реБрд░реБрдЖрдд рдФрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рджреНрд╡рд╛рд░рд╛ рд╡рд░реНрдгрд┐рдд рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ рдЖрдХрд╛рд░ рдХреЗ рд╕рд╛рдкреЗрдХреНрд╖ рдСрдлрд╕реЗрдЯ рдкрд░ рдзреНрдпрд╛рди рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдПред  рдЬреИрд╕рд╛ рдХрд┐ рдкрд┐рдЫрд▓реЗ рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╣реИ, рдЗрд╕ рд╣реЗрдбрд░ рджреНрд╡рд╛рд░рд╛ рд╡рд░реНрдгрд┐рдд рд╕реЗрдЧрдореЗрдВрдЯ рдореЗрдВ рди рдХреЗрд╡рд▓ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛрдб, рдмрд▓реНрдХрд┐ рдИрдПрд▓рдПрдл рд╣реЗрдбрд░ рдФрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реЗрдбрд░ рднреА рд╢рд╛рдорд┐рд▓ рд╣реИрдВред  рд╣рдо рд▓реЗрдЦрди рдХреЗ рд▓рд┐рдП рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛрдб рдХреЗ рд╕рд╛рде рд╕реЗрдЧрдореЗрдВрдЯ рдХреЛ рднреА рд╕реБрд▓рдн рдмрдирд╛рддреЗ рд╣реИрдВ, рдпрд╣ рдЗрд╕ рддрдереНрдп рдХреЗ рдХрд╛рд░рдг рд╣реИ рдХрд┐ рдмреВрдЯрд▓реЛрдбрд░ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдПрдИрдПрд╕ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди "рдЬрдЧрд╣ рдореЗрдВ" рдбреЗрдЯрд╛ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдФрд░ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рддрд╛ рд╣реИред <br><br><h2>  рдкреИрдХрд░ рдХреЗ рдХрд╛рдо рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреБрдЫ рддрдереНрдп </h2><br>  рдкрд░реАрдХреНрд╖рдг рдХреЗ рджреМрд░рд╛рди, рдпрд╣ рджреЗрдЦрд╛ рдЧрдпрд╛ рдХрд┐ рдЗрд╕ рдирд┐рд░реНрджреЗрд╢ рдкрд░ рд╢реБрд░реВ рд╣реЛрдиреЗ рдкрд░ glibc рдХреЗ рд╕рд╛рде рд╕рдВрдХрд▓рд┐рдд рдХрд╛рд░реНрдпрдХреНрд░рдо рд╕реАрдЧрдлреЙрд▓реНрдЯ рдореЗрдВ рдЬрд╛рддреЗ рд╣реИрдВ: <br><br><pre>  movq% fs: 0x28,% rax </pre><br>  рдореБрдЭреЗ рдкрддрд╛ рдирд╣реАрдВ рдЪрд▓рд╛ рдХрд┐ рдРрд╕рд╛ рдХреНрдпреЛрдВ рд╣реЛрддрд╛ рд╣реИ, рдореБрдЭреЗ рдЦреБрд╢реА рд╣реЛрдЧреА рдЕрдЧрд░ рдЖрдк рдЗрд╕ рд╡рд┐рд╖рдп рдкрд░ рдЬрд╛рдирдХрд╛рд░реА рд╕рд╛рдЭрд╛ рдХрд░реЗрдВрдЧреЗред  Glibc рдХреЗ рдмрдЬрд╛рдп, рдЖрдк musl-libc рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд╕рдм рдХреБрдЫ рдмрд┐рдирд╛ рдЕрд╕рдлрд▓рддрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдкреИрдХрд░ рдХреЛ рд╕рд╛рдВрдЦреНрдпрд┐рдХреАрдп рд░реВрдк рд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдЧреЛрд▓рдВрдЧ рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рдХреЗ рд╕рд╛рде рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ http рд╕рд░реНрд╡рд░ред  рдЧреЛрд▓рдВрдЧ рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рдХреА рдкреВрд░реНрдг рд╕реНрдерд┐рд░ рджреБрд░реНрдШрдЯрдирд╛рдУрдВ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЭрдВрдбреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП: <br><br><pre>  CGO_ENABLED = 0 go -a -ldflags '-extldflags "-static"' рдЬрд╛рдУред </pre><br>  рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд┐рдВрдХрд░ рдХреЗ рдмрд┐рдирд╛ ET_DYN ELF рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рд╛рде рдкреИрдХрд░ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред  рд╕рдЪ рд╣реИ, рдЗрди рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп, elf_load_addr рдлрд╝рдВрдХреНрд╢рди рд╡рд┐рдлрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред  рд╡реНрдпрд╡рд╣рд╛рд░ рдореЗрдВ, рдЗрд╕реЗ рдмреВрдЯрд▓реЛрдбрд░ рд╕реЗ рдХрд╛рдЯрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рдкрддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП 0x10000ред <br><br><h2>  рдирд┐рд╖реНрдХрд░реНрд╖ </h2><br>  рдпрд╣ рдкреИрдХрд░, рдЬрд╛рд╣рд┐рд░ рд╣реИ, рдЕрдкрдиреЗ рдЗрдЪреНрдЫрд┐рдд рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдлрд╛рдЗрд▓реЗрдВ рдЖрд╕рд╛рдиреА рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯреЗрдб рд╣реИрдВред  рдЗрд╕ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдИрдПрд▓рдПрдл рдлрд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдмреЗрд╣рддрд░ рдорд╛рд╕реНрдЯрд░ рдереЗ, рдЙрдиреНрд╣реЗрдВ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХрд╛ рдЕрднреНрдпрд╛рд╕, рд╕рд╛рде рд╣реА рдЕрдзрд┐рдХ рдкреВрд░реНрдг рдкреИрдХрд░ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХреА рддреИрдпрд╛рд░реА рдХрд░рдирд╛ред </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi483368/">https://habr.com/ru/post/hi483368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi483354/index.html">рджреВрд╕рд░реЗ рдорд╣реАрдиреЗ рдХрд╛ рдЕрднрд┐рд╢рд╛рдк</a></li>
<li><a href="../hi483356/index.html">рд╕рд╛рдореБрджрд╛рдпрд┐рдХ рдЧрдгрдирд╛ "рдХреНрдпрд╛?" рдХрд╣рд╛рдБ? рдХрдм? "(ChGK) рдпрд╛ рдПрдХ рдорд┐рддреНрд░ рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐рддрдиреЗ рд╣реИрдВрдбрд╢реЗрдХ?</a></li>
<li><a href="../hi483360/index.html">рдкрд╛рд╡рд░ рдЗрд▓реЗрдХреНрдЯреНрд░рд┐рдХ рдбреНрд░рд╛рдЗрд╡ рдирд┐рдпрдВрддреНрд░рдгред рд╢реМрдХрд┐рдпрд╛ рдЕрдиреБрднрд╡</a></li>
<li><a href="../hi483364/index.html">рдЖрдк рдЕрдкрдиреЗ рдЦрд╛рд▓реА рд╕рдордп рдХреЛ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдкрд░ рдХреЛрдб рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВред</a></li>
<li><a href="../hi483366/index.html">рдЗрдВрдЯрд░рдиреЗрдЯ рдХрд╛ рдЗрддрд┐рд╣рд╛рд╕: рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ</a></li>
<li><a href="../hi483372/index.html">GPU рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реИрдкрдЯреЙрдк рдкрд░ рдбреАрдкрдкрд╛рд╡рд▓реЛрд╡ рдиреНрдпреВрд░рд▓ рдиреЗрдЯрд╡рд░реНрдХ рдХреЛ рдХреИрд╕реЗ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП</a></li>
<li><a href="../hi483374/index.html">REST API рдЕрдиреБрд╢рдВрд╕рд╛рдПрдБ - рдЬрд╛рд╡рд╛ рдФрд░ рд╕реНрдкреНрд░рд┐рдВрдЧ рдореЗрдВ рд╡реЗрдм рд╕реЗрд╡рд╛ рдбрд┐рдЬрд╝рд╛рдЗрди рдЙрджрд╛рд╣рд░рдг</a></li>
<li><a href="../hi483376/index.html">рдПрдХ рдмреНрд▓реИрдХ рд╣реЛрд▓ рдХреА рд╕рддрд╣ рдкрд░</a></li>
<li><a href="../hi483378/index.html">рд╕реА ++ 17 рдореЗрдВ рдУрд╡рд░рд╣реЗрдб рдХреЗ рдмрд┐рдирд╛ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЗ рд╕рд╛рде рдЯрд╛рдЗрдк-рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд╛рд░реНрдп: рдореВрд▓реНрдп-рдЖрдзрд╛рд░рд┐рдд рдореЗрдЯрд╛рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ</a></li>
<li><a href="../hi483380/index.html">Microservices: рдЕрдиреБрдмрдВрдз рдХрд╛ рдЕрдиреБрдкрд╛рд▓рди рдХреИрд╕реЗ рдХрд░реЗрдВ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>