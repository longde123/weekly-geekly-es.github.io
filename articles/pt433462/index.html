<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî≤ ‚ö™Ô∏è ‚úÇÔ∏è Verifica√ß√µes de sa√∫de e degrada√ß√£o gradual de sistemas distribu√≠dos üë®‚Äçüë®‚Äçüëß üëÉüèΩ ü•†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como sempre, obrigado a Fred Hebert e Sargun Dhillon por ler um rascunho deste artigo e oferecer alguns conselhos inestim√°veis. 


 Em sua palestra so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Verifica√ß√µes de sa√∫de e degrada√ß√£o gradual de sistemas distribu√≠dos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/433462/"><img src="https://habrastorage.org/webt/nv/bv/x0/nvbvx0meh2jzpwpvwzgvtpni1jk.png"><br><p>  <i>Como sempre, obrigado a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fred Hebert</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sargun Dhillon</a> por ler um rascunho deste artigo e oferecer alguns conselhos inestim√°veis.</i> </p><br><p>  Em sua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">palestra sobre velocidade,</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tamar Berkovichi,</a> da Box, enfatizou a import√¢ncia das verifica√ß√µes de desempenho para o failover autom√°tico do banco de dados.  Em particular, ela observou que o monitoramento do tempo de execu√ß√£o de consultas ponto a ponto, como m√©todo para determinar a integridade de um banco de dados, √© melhor do que o simples ping (ping). </p><br><blockquote> ... transferindo tr√°fego para outro n√≥ (r√©plica) para eliminar a ina√ß√£o, √© necess√°rio criar prote√ß√£o contra rejei√ß√£o e outras situa√ß√µes de fronteira.  N√£o √© dif√≠cil.  O foco na organiza√ß√£o de um trabalho eficaz √© saber <strong>quando</strong> colocar o banco de dados na primeira posi√ß√£o, ou seja,  Voc√™ deve poder avaliar corretamente a integridade do banco de dados.  Agora, muitos par√¢metros aos quais estamos acostumados a prestar aten√ß√£o - por exemplo, carga do processador, lat√™ncia, taxa de erro - s√£o sinais secund√°rios.  Na verdade, nenhum desses par√¢metros fala da capacidade do banco de dados de processar o tr√°fego do cliente.  Portanto, se voc√™ us√°-los para tomar uma decis√£o sobre a altern√¢ncia, poder√° obter resultados falso-positivos e falso-negativos.  Nosso verificador de integridade realmente realiza consultas simples nos n√≥s do banco de dados e usa os dados em consultas conclu√≠das e com falha para avaliar com mais precis√£o a integridade do banco de dados. </blockquote><p>  Eu discuti isso com um amigo, e ele sugeriu que as verifica√ß√µes de sa√∫de sejam extremamente simples e que o tr√°fego real seja o melhor crit√©rio para avaliar a sa√∫de de um processo. </p><a name="habracut"></a><br><p>  Freq√ºentemente, discuss√µes relacionadas √† implementa√ß√£o de verifica√ß√µes de sa√∫de giram em torno de duas op√ß√µes opostas: testes simples de comunica√ß√£o / sinal ou testes complexos de ponta a ponta.  Neste artigo, quero enfatizar o problema associado ao uso da forma de verifica√ß√µes de integridade acima mencionada para certos tipos de solu√ß√µes de balanceamento de carga, bem como a necessidade de uma abordagem mais detalhada para avaliar a integridade de um processo. </p><br><h3 id="dva-tipa-proverok-rabotosposobnosti">  Dois tipos de exames de sa√∫de </h3><br><p>  As verifica√ß√µes de integridade, mesmo em muitos sistemas modernos, em regra, se enquadram em duas categorias: verifica√ß√µes no n√≠vel do n√≥ e no n√≠vel do servi√ßo. </p><br><p> Por exemplo, o Kubernetes implementa a valida√ß√£o analisando a <em>disponibilidade</em> e a <em>capacidade de sobreviv√™ncia</em> .  A verifica√ß√£o de disponibilidade √© usada para determinar a capacidade da lareira de atender o tr√°fego.  Se a verifica√ß√£o de prontid√£o n√£o for executada, ela ser√° exclu√≠da dos terminais que comp√µem o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servi√ßo</a> e, por isso, no cora√ß√£o, at√© que a verifica√ß√£o seja conclu√≠da, nenhum tr√°fego ser√° roteado.  Por outro lado, uma verifica√ß√£o de sobreviv√™ncia √© usada para determinar se <em>um</em> servi√ßo est√° <em>respondendo</em> a um travamento ou travamento.  Se falhar, o cont√™iner individual no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kubelet ser√° reiniciado</a> .  Da mesma forma, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Consul</a> permite v√°rias formas de <code>checks</code> : <code>checks</code> baseadas em <code>script</code> baseadas em HTTP direcionadas a um URL espec√≠fico, verifica√ß√µes baseadas em TTL ou at√© mesmo aliases. </p><br><p>  O m√©todo mais comum para implementar uma verifica√ß√£o de sa√∫de no n√≠vel de <em>servi√ßo</em> √© determinar o ponto final da verifica√ß√£o de sa√∫de.  Por exemplo, no gRPC, uma pr√≥pria verifica√ß√£o de sa√∫de se torna uma chamada RPC.  O gRPC tamb√©m permite verifica√ß√µes de integridade do n√≠vel de servi√ßo e verifica√ß√µes gerais de <em>integridade do servidor gRPC</em> . </p><br><p>  No passado, as verifica√ß√µes de integridade no n√≠vel do host eram usadas como um sinal para disparar um alerta.  Por exemplo, um alerta com uma carga m√©dia do processador (atualmente considerado um padr√£o anti-design).  Mesmo que a verifica√ß√£o de integridade n√£o seja usada diretamente para notifica√ß√£o, ela ainda serve de base para v√°rias outras decis√µes autom√°ticas de infraestrutura, por exemplo, em rela√ß√£o ao balanceamento de carga e (√†s vezes) circuito aberto.  Em esquemas de dados da grade de servi√ßo, como o Envoy, <em>os</em> dados de <em>verifica√ß√£o de integridade</em> , quando se trata de determinar o roteamento de tr√°fego para uma inst√¢ncia, avan√ßam com rela√ß√£o aos dados de descoberta de servi√ßo. </p><br><h3 id="rabotosposobnost--eto-spektr-a-ne-binarnaya-taksonomiya">  Efici√™ncia √© um espectro, n√£o uma taxonomia bin√°ria </h3><br><p>  Uma solicita√ß√£o de eco, ou ping, pode apenas estabelecer se o servi√ßo est√° <em>funcionando</em> , enquanto testes de ponta a ponta s√£o proxies para estabelecer se o sistema √© capaz de executar uma <em>unidade de trabalho</em> espec√≠fica, onde a unidade de trabalho pode ser uma <em>consulta ao banco de dados</em> ou um <em>c√°lculo espec√≠fico</em> .  Independentemente da forma de uma verifica√ß√£o de sa√∫de, seu <em>resultado √©</em> considerado puramente bin√°rio: "aprovado" ou "reprovado". </p><br><p>  Nas op√ß√µes de infraestrutura din√¢micas e muitas vezes "escal√°veis ‚Äã‚Äãautomaticamente" de hoje, um √∫nico processo que simplesmente "funciona" n√£o importa se n√£o pode executar uma unidade de trabalho espec√≠fica.  Acontece que verifica√ß√µes simplificadas, como testes de eco, s√£o quase in√∫teis. </p><br><p>  √â f√°cil determinar quando um servi√ßo est√° completamente <em>desconectado</em> , mas estabelecer o grau de <em>operacionalidade de um</em> servi√ßo em execu√ß√£o √© muito mais dif√≠cil.  √â bem poss√≠vel que o processo esteja em execu√ß√£o (ou seja, a verifica√ß√£o de integridade seja aprovada) e o tr√°fego seja roteado, mas para executar uma determinada unidade de trabalho, por exemplo, durante o per√≠odo de atraso do servi√ßo p99, isso n√£o √© suficiente. </p><br><p>  Freq√ºentemente, o trabalho n√£o pode ser conclu√≠do porque o processo est√° sobrecarregado.  Em servi√ßos altamente competitivos, o ‚Äúcongestionamento‚Äù est√° claramente correlacionado com o n√∫mero de solicita√ß√µes simult√¢neas processadas por apenas um processo com enfileiramento excessivo, o que pode levar a um aumento no atraso de uma chamada RPC (embora, na maioria das vezes, o servi√ßo de n√≠vel inferior simplesmente coloque a solicita√ß√£o em espera e tente novamente). timeout).  Isso √© especialmente verdadeiro se o terminal de verifica√ß√£o de integridade estiver configurado para retornar automaticamente ao c√≥digo de status HTTP 200, enquanto a opera√ß√£o real realizada pelo servi√ßo envolver E / S ou computa√ß√£o de rede. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/420/7bf/d6b/4207bfd6ba6f7c4afd6892c8f643112d.png" alt="imagem"></p><br><p>  O desempenho do processo √© um espectro.  Antes de tudo, estamos interessados ‚Äã‚Äãna <em>qualidade do servi√ßo</em> , por exemplo, no tempo necess√°rio para o processo restaurar o resultado de uma unidade de trabalho espec√≠fica e na precis√£o do resultado. </p><br><p>  √â poss√≠vel que o processo flutue entre diferentes graus de <em>capacidade</em> de <em>trabalho</em> durante sua vida √∫til: da <em>capacidade</em> total de <em>trabalho</em> (por exemplo, a capacidade de funcionar no n√≠vel esperado de paralelismo) at√© o ponto de inoperabilidade (quando as filas come√ßam a encher) e o ponto em que o processo entra completamente em uma zona inoperante (sentida qualidade de servi√ßo reduzida).  Somente os servi√ßos mais triviais podem ser constru√≠dos com a suposi√ß√£o de que n√£o h√° grau de falha parcial em nenhum per√≠odo em que uma falha parcial implique que algumas fun√ß√µes funcionem e outras sejam desativadas, e n√£o apenas ‚Äúalguns pedidos s√£o executados, outros n√£o s√£o executados‚Äù.  Se a arquitetura do servi√ßo n√£o permitir corrigir corretamente a falha parcial, o <em>cliente</em> corrigir√° automaticamente a tarefa de corre√ß√£o de erros. </p><br><p>  Uma infra-estrutura adapt√°vel e auto-repar√°vel deve ser constru√≠da com o entendimento de que essas flutua√ß√µes s√£o perfeitamente <em>normais</em> .  Tamb√©m √© importante lembrar que essa diferen√ßa s√≥ importa em rela√ß√£o ao balanceamento de carga - para o orquestrador, por exemplo, n√£o faz sentido reiniciar o processo apenas porque o processo est√° √† beira de sobrecarga. </p><br><p>  Em outras palavras, para o n√≠vel de orquestra√ß√£o, √© bastante razo√°vel considerar a operacionalidade do processo como um estado bin√°rio e reiniciar o processo somente ap√≥s uma falha ou congelamento.  Mas na camada de <em>balanceamento de carga</em> (seja um proxy externo, por exemplo, o Envoy ou uma biblioteca interna no lado do cliente), √© extremamente importante que ele atue com base em informa√ß√µes mais detalhadas sobre a operacionalidade do processo - quando tomar as decis√µes apropriadas sobre interromper o circuito e descarregar a carga.  A degrada√ß√£o gradual do servi√ßo √© imposs√≠vel se for imposs√≠vel determinar com precis√£o o n√≠vel de desempenho do servi√ßo a qualquer momento. </p><br><p>  Deixe-me contar por experi√™ncia pr√≥pria: a concorr√™ncia ilimitada √© geralmente o principal fator que leva √† degrada√ß√£o do servi√ßo ou a uma diminui√ß√£o permanente da produtividade.  O balanceamento de carga (e, como conseq√º√™ncia, a perda de carga) geralmente se resume ao gerenciamento eficiente da concorr√™ncia e √† aplica√ß√£o de contrapress√£o, impedindo a sobrecarga do sistema. </p><br><h3 id="neobhodimost-obratnoy-svyazi-pri-primenenii-protivodavleniya">  A necessidade de feedback ao aplicar a contrapress√£o </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Matt Ranney</a> escreveu um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo fenomenal</a> sobre concorr√™ncia ilimitada e a necessidade de contrapress√£o no Node.js.  O artigo inteiro √© curioso, mas a principal conclus√£o (pelo menos para mim) foi a necessidade de feedback entre o processo e sua unidade de sa√≠da (geralmente um balanceador de carga, mas √†s vezes outro servi√ßo). </p><br><blockquote>  O truque √© que, quando os recursos est√£o esgotados, algo deve ser dado em algum lugar.  A demanda est√° crescendo e a produtividade n√£o pode aumentar magicamente.  Para limitar as tarefas recebidas, a primeira coisa a fazer √© definir um limite de velocidade no n√≠vel do site, por endere√ßo IP, usu√°rio, sess√£o ou, na melhor das hip√≥teses, por algum elemento importante para o aplicativo.  Muitos balanceadores de carga podem limitar a velocidade de uma maneira mais complicada do que o servidor Node.js.negoci√°vel, mas geralmente eles n√£o percebem problemas at√© que o processo esteja em uma situa√ß√£o dif√≠cil. </blockquote><p>  Os limites de velocidade e os circuitos abertos baseados em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">limites e limites est√°ticos podem n√£o ser confi√°veis ‚Äã‚Äãe inst√°veis</a> em termos de corre√ß√£o e escalabilidade.  Alguns balanceadores de carga (em particular, HAProxy) fornecem muitas estat√≠sticas sobre o comprimento das filas internas para <em>cada servidor</em> e <em>parte do servidor</em> .  Al√©m disso, o HAProxy permite <code>agent-check</code> (uma verifica√ß√£o auxiliar independente da verifica√ß√£o de integridade normal), que permite que o processo forne√ßa ao servidor proxy um feedback de integridade mais preciso e din√¢mico.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link para documentos</a> : </p><br><blockquote>  A verifica√ß√£o da integridade do agente √© realizada pela conex√£o TCP com a porta, com base no par√¢metro <code>agent-port</code> especificado e na leitura da sequ√™ncia ASCII.  Uma linha consiste em uma s√©rie de palavras separadas por espa√ßos, tabula√ß√µes ou v√≠rgulas em qualquer ordem, terminando opcionalmente em <code>/r</code> / ou <code>/n</code> incluindo os seguintes elementos: <br><br>  - Representa√ß√£o de um valor percentual inteiro positivo de ASCII, por exemplo, <code>75%</code> .  Os valores neste formato determinam o peso em propor√ß√£o ao valor inicial <br>  O valor do servidor ponderado configurado ao iniciar o HAProxy.  Observe que um valor de peso zero √© indicado na p√°gina de estat√≠sticas como <code>DRAIN</code> partir do momento de um impacto semelhante no servidor (ele √© removido do farm LB). <br><br>  - Par√¢metro de string <code>maxconn</code> : seguido por um n√∫mero inteiro (sem espa√ßo).  Valores em <br>  Este formato define o <code>maxconn</code> servidor <code>maxconn</code> .  N√∫mero m√°ximo <br>  as conex√µes declaradas devem ser multiplicadas pelo n√∫mero de balanceadores de carga e v√°rias partes do servidor usando essa verifica√ß√£o de integridade para obter o n√∫mero total de conex√µes que o servidor pode estabelecer.  Por exemplo: <code>maxconn:30</code> <br><br>  - A palavra <code>ready</code> .  Isso traduz o estado administrativo do servidor em <br>  <code>READY</code> , cancelando o <code>MAINT</code> <code>DRAIN</code> ou <code>MAINT</code> . <br><br>  - A palavra <code>drain</code> .  Isso traduz o estado administrativo do servidor em <br>  Modo <code>DRAIN</code> ("drenagem"), ap√≥s o qual o servidor n√£o aceitar√° novas conex√µes, com exce√ß√£o das conex√µes aceitas pelo banco de dados. <br><br>  - A palavra <code>maint</code> .  Isso traduz o estado administrativo do servidor em <br>  Modo <code>MAINT</code> ("manuten√ß√£o"), ap√≥s o qual o servidor n√£o aceita novas conex√µes, e as verifica√ß√µes de integridade s√£o interrompidas. <br><br>  - As palavras <code>down</code> , com <code>failed</code> ou <code>stopped</code> , que podem ser seguidas por uma linha de descri√ß√£o ap√≥s o s√≠mbolo acentuado (#).  Todos eles indicam o status operacional do servidor <code>DOWN</code> ("desativado"), mas como a palavra em si √© exibida na p√°gina de estat√≠sticas, a diferen√ßa permite ao administrador determinar se a situa√ß√£o era esperada: o servi√ßo pode ser intencionalmente parado, alguns testes de confirma√ß√£o podem aparecer, mas n√£o passam, ou ser considerado desativado (sem processo, sem resposta da porta). <br><br>  - A palavra up indica o status operacional do servidor <code>UP</code> (‚Äúon‚Äù) se as verifica√ß√µes de integridade tamb√©m confirmarem a disponibilidade do servi√ßo. <br><br>  Os par√¢metros n√£o reivindicados pelo agente n√£o s√£o alterados.  Por exemplo, um agente pode ser projetado apenas para monitorar o uso do processador e relatar apenas um valor de peso relativo sem interagir com o estado operacional.  Da mesma forma, o programa do agente pode ser projetado como uma interface de usu√°rio final com 3 op√ß√µes, permitindo que o administrador altere apenas o estado administrativo. <br><br>  <strong>No entanto, deve-se ter em mente que apenas o agente pode desfazer suas pr√≥prias a√ß√µes; portanto, se o servidor estiver definido como DRAIN ou DOWN usando o agente, ele dever√° executar outras a√ß√µes equivalentes para reiniciar o servi√ßo.</strong> <br><br>  A falha na conex√£o com o agente n√£o √© considerada um erro, porque a capacidade de conex√£o √© testada executando regularmente uma verifica√ß√£o de sa√∫de, que √© iniciada usando o par√¢metro check.  No entanto, se uma mensagem de desligamento chegar, n√£o ser√° uma boa ideia interromper o agente, pois apenas o agente que est√° relatando o desligamento pode reativar o servidor. </blockquote><p>  Esse esquema de comunica√ß√£o din√¢mica do servi√ßo com a unidade de sa√≠da √© extremamente importante para criar uma infraestrutura auto-adapt√°vel.  Um exemplo seria a arquitetura com a qual trabalhei em um trabalho anterior. </p><br><p>  Eu trabalhava na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">imgix</a> , uma empresa iniciante de processamento de imagens em tempo real.  Usando uma URL de API simples, as imagens s√£o recuperadas e convertidas em tempo real e depois usadas em qualquer lugar do mundo via CDN.  Nossa pilha era bastante complexa ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">como descrito acima</a> ), mas, em suma, nossa infraestrutura inclu√≠a um n√≠vel de balanceamento e balanceamento de carga (em conjunto com o n√≠vel de recebimento de dados da fonte), o n√≠vel de cache da fonte, o n√≠vel de processamento de imagem e o n√≠vel de entrega de conte√∫do. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f58/98a/d1e/f5898ad1e33db764d7551e29d0a7e5dc.png" alt="imagem"></p><br><p>  O n√≠vel de balanceamento de carga foi baseado no servi√ßo Spillway, que atuava como um proxy reverso e intermedi√°rio de solicita√ß√£o.  Era um servi√ßo puramente interno;  no in√≠cio, come√ßamos o nginx, o HAProxy e o Spillway; portanto, ele n√£o foi projetado para concluir o TLS ou executar outras fun√ß√µes desse conjunto incont√°vel que geralmente √© da compet√™ncia do proxy de fronteira. </p><br><p>  O Spillway consistia em dois componentes: a parte do cliente (Spillway FE) e a corretora.  Embora inicialmente ambos os componentes estivessem no mesmo arquivo bin√°rio, em algum momento decidimos separ√°-los em arquivos bin√°rios separados que foram implantados simultaneamente no mesmo host.  Principalmente porque esses dois componentes tinham perfis de desempenho diferentes e a parte do cliente estava quase completamente conectada ao processador.  A tarefa da parte do cliente era executar o processamento preliminar de cada solicita√ß√£o, incluindo a verifica√ß√£o preliminar no n√≠vel do cache de origem, para garantir que a imagem fosse armazenada em cache em nosso data center antes de enviar a solicita√ß√£o de convers√£o de imagem ao executor. </p><br><p>  A qualquer momento, t√≠nhamos uma piscina fixa (cerca de uma d√∫zia, se a mem√≥ria servir) de artistas que poderiam estar conectados ao mesmo corretor Spillway.  Os artistas foram respons√°veis ‚Äã‚Äãpela convers√£o real da imagem (corte, redimensionamento, processamento de PDF, renderiza√ß√£o de GIF etc.).  Eles processaram tudo, desde PDFs de centenas de p√°ginas e GIFs com centenas de quadros a arquivos de imagem simples.  Outra caracter√≠stica do contratante era que, embora todas as redes fossem completamente ass√≠ncronas, n√£o havia convers√µes reais na pr√≥pria GPU.  Como trabalhamos em tempo real, era imposs√≠vel prever como seria o tr√°fego em um determinado momento.  Nossa infraestrutura teve que se adaptar a v√°rias formas de tr√°fego de entrada - sem interven√ß√£o manual do operador. </p><br><p>  Dado os padr√µes de tr√°fego d√≠spares e heterog√™neos que encontramos com frequ√™ncia, tornou-se necess√°rio que os executores se recusassem a aceitar solicita√ß√µes de entrada (mesmo quando totalmente operacionais) se aceitarem a conex√£o amea√ßava sobrecarregar o executor.  Cada solicita√ß√£o ao executante continha um determinado conjunto de metadados sobre a natureza da solicita√ß√£o, o que permitia ao executante determinar se ele era capaz de atender a essa solicita√ß√£o.  Cada executor tinha seu pr√≥prio conjunto de dados estat√≠sticos sobre os pedidos com os quais ele estava trabalhando atualmente.  O funcion√°rio usou essas estat√≠sticas em conjunto com os metadados da solicita√ß√£o e outros dados heur√≠sticos, como dados do tamanho do buffer do soquete, para determinar se ele recebeu a solicita√ß√£o de entrada corretamente.  Se o funcion√°rio determinou que n√£o podia aceitar a solicita√ß√£o, ele criou uma resposta que n√£o diferia da verifica√ß√£o do agente HAProxy, informando seu Spillway sobre sua operacionalidade. </p><br><p>  Spillway monitorou o desempenho de todos os artistas da piscina.  No in√≠cio, tentei enviar uma solicita√ß√£o tr√™s vezes seguidas para diferentes executores (era dada prefer√™ncia √†queles que tinham a imagem original nos bancos de dados locais e que n√£o estavam sobrecarregados) e, se todos os tr√™s executores se recusassem a aceitar a solicita√ß√£o, a solicita√ß√£o era enfileirada no broker na mem√≥ria.  O broker suportou tr√™s formas de filas: a fila LIFO, a fila FIFO e a fila priorit√°ria.  Se todas as tr√™s filas foram preenchidas, o broker simplesmente rejeitou a solicita√ß√£o, permitindo que o cliente (HAProxy) tentasse novamente ap√≥s o per√≠odo de atraso.  Quando uma solicita√ß√£o foi colocada em uma das tr√™s filas, qualquer executor livre pode remov√™-la e process√°-la.  Existem certas dificuldades associadas √† atribui√ß√£o de uma prioridade a uma solicita√ß√£o e √† decis√£o de qual das tr√™s filas (LIFO, FIFO, filas baseadas em prioridade) deve ser colocada, mas este √© um t√≥pico para um artigo separado. </p><br><p>  Para a opera√ß√£o eficaz do servi√ßo, n√£o precisamos discutir essa forma de feedback din√¢mico.  Monitoramos cuidadosamente o tamanho da fila do broker (todas as tr√™s filas) e o Prometheus emitiu um dos principais avisos quando o tamanho da fila excedeu um determinado limite (o que era bastante raro). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f83/768/88c/f8376888c479f9dbcbadbee1c3e9539e.png" alt="imagem"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Imagem da minha apresenta√ß√£o no sistema de monitoramento Prometheus no Google NYC em novembro de 2016</a> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a19/7b7/57c/a197b757cbe5660023612137e3c780d4.png" alt="imagem"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O aviso √© retirado da minha apresenta√ß√£o no sistema de monitoramento Prometheus na confer√™ncia OSCON em maio de 2017.</a> </p><br><p>  No in√≠cio deste ano, a Uber publicou um artigo interessante no qual esclareceu sua abordagem para implementar um n√≠vel de redu√ß√£o de carga com base na qualidade do servi√ßo. </p><br><blockquote>  Analisando falhas nos √∫ltimos seis meses, descobrimos que 28% delas poderiam ser mitigadas ou evitadas pela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">degrada√ß√£o suave</a> . <br><br>  Os tr√™s tipos mais comuns de falhas foram associados aos seguintes fatores: <br><br>  - Altera√ß√µes no esquema da solicita√ß√£o recebida, incluindo congestionamento e n√≥s do operador incorretos. <br>  - Esgotamento de recursos como processador, mem√≥ria, circuito de entrada / sa√≠da ou recursos de rede. <br>  - Falhas de depend√™ncia, incluindo infraestrutura, data warehouse e servi√ßos downstream. <br><br>  Implementamos um detector de sobrecarga baseado no algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CoDel</a> .  Para cada n√≥ de extremidade ativado, um buffer de solicita√ß√£o leve (implementado com base em gourutin e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">canais</a> ) √© adicionado para rastrear atrasos entre o momento de receber o pedido da origem da chamada e o in√≠cio do processamento do pedido no manipulador.         ,   ,      . </blockquote><p>   ,  ,         ,  -      .   2013  Google     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´The Tail at Scale¬ª</a> ,               (   ),        (   )    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8ff/2b5/379/8ff2b5379239a40c0b193f483a85fa86.jpg" alt="imagem"></p><br><p>             ,           .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">      </a> ,         . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6fd/068/1fb/6fd0681fb86c70cff833ae170f53ce5c.png" alt="imagem"></p><br><p> (       ) </p><br><p> ,              ,       : </p><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> , QCon London 2018. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   :    -</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ,  LISA 2017. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   ‚Äì   </a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> , Strangeloop 2017. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  : ,    </a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> , Strangeloop 2017. </li><li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´   ¬ª</a> . </li></ol><br><h3 id="zaklyuchenie">  Conclus√£o </h3><br><p>           ,  TCP/IP ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a>    ), IP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ECN</a> ( IP     )  Ethernet,    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> . </p><br><p>        ,             .               .    ,           .             . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433462/">https://habr.com/ru/post/pt433462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433446/index.html">Semana da Seguran√ßa 51: bug no WordPress 5.0 e no software Logitech, vulnerabilidade de foto do Facebook</a></li>
<li><a href="../pt433448/index.html">An√°lise comparativa de mercados usados Carros alem√£es e franceses no segmento B e C</a></li>
<li><a href="../pt433450/index.html">Cres√ßa e ensine. Como fizemos amizade com o PEGA</a></li>
<li><a href="../pt433456/index.html">Como convencer um cliente ou empresa a usar o Flutter</a></li>
<li><a href="../pt433458/index.html">Alguns benef√≠cios n√£o √≥bvios do Serverless for DevOps</a></li>
<li><a href="../pt433472/index.html">Lan√ßamento do Unity 2018.3</a></li>
<li><a href="../pt433474/index.html">Pil√£o de dentro para fora. Como ele faz isso</a></li>
<li><a href="../pt433476/index.html">50 tons de aipo</a></li>
<li><a href="../pt433478/index.html">Por que o Django √© escolhido na Revista Tinkoff</a></li>
<li><a href="../pt433480/index.html">Hist√≥ria de Holivarny sobre linter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>