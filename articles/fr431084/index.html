<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòñ ü§πüèº üë®üèø‚Äçü§ù‚Äçüë®üèª Dans toute situation incompr√©hensible - √©crire des scripts üïù üà¥ üë®üèæ‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les scripts sont l'un des moyens les plus courants de rendre une application plus flexible, avec la possibilit√© de corriger quelque chose imm√©diatemen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dans toute situation incompr√©hensible - √©crire des scripts</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/431084/"><img src="https://habrastorage.org/webt/a5/ng/5b/a5ng5b6thpfbxpcasm51swkuzgk.jpeg" alt="image"><br><br>  Les scripts sont l'un des moyens les plus courants de rendre une application plus flexible, avec la possibilit√© de corriger quelque chose imm√©diatement.  Bien s√ªr, cette approche pr√©sente √©galement des inconv√©nients; vous devez toujours vous rappeler l'√©quilibre entre la flexibilit√© et la g√©rabilit√©.  Mais dans cet article, nous ne discuterons pas ¬´de mani√®re g√©n√©rale¬ª des avantages et des inconv√©nients de l'utilisation de scripts, nous examinerons des moyens pratiques de mettre en ≈ìuvre cette approche et pr√©senterons √©galement une biblioth√®que qui fournit une infrastructure pratique pour ajouter des scripts aux applications √©crites dans Spring Framework. <br><a name="habracut"></a><br><h2>  Quelques mots d'introduction </h2><br>  Lorsque vous souhaitez ajouter la possibilit√© de modifier la logique m√©tier dans une application sans recompilation ni d√©ploiement ult√©rieur, les scripts sont l'un des moyens qui viennent √† l'esprit en premier lieu.  Souvent, les scripts n'apparaissent pas parce que c'√©tait pr√©vu, mais parce que c'est arriv√©.  Par exemple, dans la sp√©cification, il y a une partie de la logique qui n'est pas compl√®tement claire en ce moment, mais afin de ne pas passer quelques jours suppl√©mentaires (et parfois plus) pour l'analyse, vous pouvez cr√©er un point d'extension et appeler un script - un stub.  Et puis, bien s√ªr, ce script sera r√©√©crit lorsque les exigences deviendront claires. <br><br>  La m√©thode n'est pas nouvelle et ses avantages et inconv√©nients sont bien connus: flexibilit√© - vous pouvez changer la logique d'une application en cours d'ex√©cution et gagner du temps lors d'une r√©installation, mais, d'un autre c√¥t√©, les scripts sont plus difficiles √† tester, d'o√π les √©ventuels probl√®mes de s√©curit√©, de performances, etc. <br><br>  Ces techniques, qui seront discut√©es plus loin, peuvent √™tre utiles √† la fois aux d√©veloppeurs qui utilisent d√©j√† des scripts dans leur application et √† ceux qui y pensent. <br><br><h2>  Rien de personnel, juste des scripts </h2><br>  Avec JSR-233, l'√©criture de scripts en Java est devenue tr√®s simple.  Il existe suffisamment de moteurs de script bas√©s sur cette API (Nashorn, JRuby, Jython et bien d'autres), donc ajouter un peu de magie de script √† votre code n'est pas un probl√®me: <br><br><pre><code class="java hljs">Map&lt;String, Object&gt; parameters = createParametersMap(); ScriptEngineManager manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ScriptEngineManager(); ScriptEngine scriptEngine = manager.getEngineByName(<span class="hljs-string"><span class="hljs-string">"groovy"</span></span>); Object result = scriptEngine.eval(script.getScriptAsString(<span class="hljs-string"><span class="hljs-string">"discount.groovy"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleBindings(parameters));</code> </pre> <br>  De toute √©vidence, si un tel code est dispers√© dans l'application, il se transformera en quelque chose d'incompr√©hensible.  Et, bien s√ªr, si vous avez plusieurs appels de script dans votre application, vous devez cr√©er une classe distincte pour travailler avec eux.  Parfois, vous pouvez aller encore plus loin et cr√©er des classes sp√©ciales qui encapsuleront <code>evaluateGroovy()</code> appels <code>evaluateGroovy()</code> dans des m√©thodes Java typ√©es normales.  Ces m√©thodes auront un code utilitaire assez uniforme, comme dans l'exemple: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyCustomerDiscount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Customer customer, BigDecimal orderAmount)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Object&gt; params = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); params.put(<span class="hljs-string"><span class="hljs-string">"cust"</span></span>, customer); params.put(<span class="hljs-string"><span class="hljs-string">"amount"</span></span>, orderAmount); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (BigDecimal)scripting.evalGroovy(getScriptSrc(<span class="hljs-string"><span class="hljs-string">"discount.groovy"</span></span>), params); }</code> </pre><br>  Cette approche augmente consid√©rablement la transparence lors de l'appel de scripts √† partir du code d'application - vous pouvez imm√©diatement voir quels param√®tres le script accepte, quel type ils sont et ce qui est retourn√©.  L'essentiel est de ne pas oublier d'ajouter aux normes d'√©criture du code une interdiction d'appeler des scripts non issus de m√©thodes typ√©es! <br><br><h2>  Nous pompons des scripts </h2><br>  Malgr√© le fait que les scripts soient simples, si vous en avez beaucoup et que vous les utilisez intensivement, il y a de r√©elles chances de rencontrer des probl√®mes de performances.  Par exemple, si vous utilisez un tas de mod√®les groovy pour g√©n√©rer des rapports et que vous les ex√©cutez en m√™me temps, t√¥t ou tard, cela deviendra l'un des goulots d'√©tranglement dans les performances des applications. <br>  Par cons√©quent, de nombreux frameworks proposent diff√©rents modules compl√©mentaires sur l'API standard pour am√©liorer la vitesse de travail, la mise en cache, la surveillance de l'ex√©cution, l'utilisation de diff√©rents langages de script dans une seule application, etc. <br><br>  Par exemple, un moteur de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script</a> assez ing√©nieux a √©t√© cr√©√© dans CUBA qui prend en charge des fonctionnalit√©s suppl√©mentaires, telles que: <br><br><ol><li>  Capacit√© √† √©crire des scripts en Java et Groovy </li><li>  Cache de classe pour ne pas recompiler les scripts </li><li>  Bac JMX pour contr√¥ler le moteur </li></ol><br>  Tout cela, bien s√ªr, am√©liore les performances et la convivialit√©, mais le moteur de bas niveau reste bas, et vous devez toujours lire le texte du script, passer les param√®tres et appeler l'API pour ex√©cuter le script.  Vous devez donc toujours faire une sorte de wrapper dans chaque projet pour rendre le d√©veloppement encore plus efficace. <br><br>  Et il serait injuste de ne pas mentionner GraalVM - un moteur exp√©rimental qui peut ex√©cuter des programmes dans diff√©rentes langues (JVM et non-JVM) et vous permet d'ins√©rer des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">modules dans ces langues</a> dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des applications Java</a> .  J'esp√®re que Nashorn restera t√¥t ou tard dans l'histoire, et nous aurons l'occasion d'√©crire des parties du code dans diff√©rentes langues en une seule source.  Mais ce n'est qu'un r√™ve. <br><br><h2>  Spring Framework: une offre difficile √† refuser? </h2><br>  Spring a une prise en charge int√©gr√©e de l'ex√©cution des scripts bas√©e sur l'API JDK.  Dans le <code>org.springframework.scripting.*</code> , Vous pouvez trouver de nombreuses classes utiles - toutes afin que vous puissiez facilement utiliser l'API de bas niveau pour les scripts dans votre application. <br><br>  De plus, le niveau de support est plus √©lev√©, il est d√©crit en d√©tail dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> .  En bref - vous devez cr√©er une classe dans un langage de script (par exemple, Groovy) et la publier en tant que bean via une description XML: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lang:groovy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"messenger"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">script-source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"classpath:Messenger.groovy"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lang:property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"I Can Do The Frug"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lang:groovy</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Une fois qu'un bean est publi√©, il peut √™tre ajout√© √† ses classes √† l'aide d'IoC.  Spring fournit une mise √† jour automatique du script lors du changement de texte dans le fichier, vous pouvez accrocher des aspects sur les m√©thodes, etc. <br><br>  Cela a l'air bien, mais vous devez cr√©er de ¬´vraies¬ª classes pour les publier, vous ne pouvez pas √©crire une fonction r√©guli√®re dans un script.  De plus, les scripts ne peuvent √™tre stock√©s que dans le syst√®me de fichiers, pour utiliser la base de donn√©es que vous devez monter dans Spring.  Oui, et beaucoup consid√®rent la configuration XML comme obsol√®te, surtout si l'application a d√©j√† tout sur les annotations.  Bien s√ªr, cela aromatise, mais il faut souvent en tenir compte. <br><br><h2>  Scripts: difficult√©s et id√©es </h2><br>  Ainsi, chaque solution a son propre prix, et si nous parlons de scripts dans les applications Java, alors lors de l'introduction de cette technologie, on peut rencontrer quelques difficult√©s: <br><br><ol><li>  G√©rabilit√©.  Souvent, les appels de script sont dispers√©s dans l'application, et avec les changements de code, il est assez difficile de suivre les appels des scripts n√©cessaires. </li><li>  Capacit√© √† trouver des homologues de num√©rotation.  Si quelque chose ne va pas dans un script particulier, la recherche de tous ses <code>evaluateGroovy()</code> num√©rotation sera un probl√®me, sauf si vous appliquez une recherche par nom de fichier ou par des appels de m√©thode comme <code>evaluateGroovy()</code> </li><li>  La transparence  √âcrire un script n'est pas une t√¢che facile en soi, et c'est encore plus difficile pour ceux qui appellent ce script.  Vous devez vous rappeler comment les param√®tres d'entr√©e sont appel√©s, quel type de donn√©es ils contiennent et quel est le r√©sultat de l'ex√©cution.  Ou regardez le code source du script √† chaque fois. </li><li>  Test et mise √† jour - il n'est pas toujours possible de tester le script dans l'environnement du code de l'application, et m√™me apr√®s l'avoir t√©l√©charg√© sur le serveur ¬´battle¬ª, vous devez d'une mani√®re ou d'une autre √™tre capable de tout restaurer rapidement en cas de probl√®me. </li></ol><br>  Il semble que l'encapsulation des appels de script dans les m√©thodes Java aidera √† r√©soudre la plupart des probl√®mes ci-dessus.  C'est tr√®s bien si de telles classes peuvent √™tre publi√©es dans le conteneur IoC et appeler des m√©thodes avec des noms normaux et significatifs dans leurs services, au lieu d'appeler <code>eval(‚Äúdisc_10_cl.groovy‚Äù)</code> partir d'une classe utilitaire.  Un autre avantage est que le code devient auto-document√©, le d√©veloppeur n'a pas √† se demander quel type d'algorithme est cach√© derri√®re le nom du fichier. <br><br>  En plus de cela, si chaque script sera associ√© √† une seule m√©thode, vous pouvez trouver rapidement tous les homologues de num√©rotation dans l'application en utilisant le menu "Find Usages" de l'EDI et comprendre la place du script dans chaque algorithme de logique m√©tier sp√©cifique. <br><br>  Les tests sont simplifi√©s - ils se transforment en tests de classe ¬´normaux¬ª, en utilisant des cadres familiers, des simulateurs, etc. <br><br>  Tout ce qui pr√©c√®de est tr√®s conforme √† l'id√©e mentionn√©e au d√©but de l'article - des classes ¬´sp√©ciales¬ª pour les m√©thodes qui sont impl√©ment√©es par des scripts.  Mais que se passe-t-il si vous faites un pas de plus et que vous cachez tout le code de service du m√™me type pour appeler des moteurs de script au d√©veloppeur afin qu'il n'y pense m√™me pas (enfin, presque)? <br><br><h2>  R√©f√©rentiels de scripts - concept </h2><br>  L'id√©e est assez simple et devrait √™tre famili√®re √† ceux qui ont au moins une fois travaill√© avec Spring, en particulier avec Spring JPA.  Ce dont vous avez besoin est de cr√©er une interface Java et d'appeler le script lors de l'appel de ses m√©thodes.  Dans JPA, en passant, une approche identique est utilis√©e - l'appel √† CrudRepository est intercept√©, en fonction du nom de la m√©thode et des param√®tres, une demande est cr√©√©e, qui est ensuite ex√©cut√©e par le moteur de base de donn√©es. <br><br>  De quoi a-t-on besoin pour mettre en ≈ìuvre le concept? <br><br>  Tout d'abord, une annotation au niveau de la classe afin que vous puissiez trouver l'interface - le r√©f√©rentiel et cr√©er un bac sur cette base. <br><br>  De plus, les annotations sur les m√©thodes de cette interface seront probablement utiles pour stocker les m√©tadonn√©es n√©cessaires pour appeler la m√©thode.  Par exemple - o√π trouver le texte du script et quel moteur utiliser. <br><br>  Un ajout utile sera la possibilit√© d'utiliser des m√©thodes avec impl√©mentation dans l'interface (alias par d√©faut) - ce code fonctionnera jusqu'√† ce que l'analyste commercial affiche une version plus compl√®te de l'algorithme, et que le d√©veloppeur cr√©e un script bas√© sur <br>  cette information.  Ou laissez l'analyste √©crire le script, et le d√©veloppeur le copie simplement sur le serveur.  Il existe de nombreuses options :-) <br><br>  Supposons donc que pour une boutique en ligne, vous devez effectuer un service pour calculer les remises en fonction du profil de l'utilisateur.  On ne sait pas encore comment proc√©der, mais l'analyste commercial jure que tous les utilisateurs enregistr√©s ont droit √† une remise de 10%, il trouvera le reste aupr√®s du client dans une semaine.  Le service est n√©cessaire d√®s demain - la saison apr√®s tout.  √Ä quoi pourrait ressembler le code dans ce cas? <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ScriptRepository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PricingRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ScriptMethod</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyCustomerDiscount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Customer customer, BigDecimal orderAmount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orderAmount.multiply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"0.9"</span></span>)); } }</code> </pre><br>  Et puis l'algorithme lui-m√™me, √©crit, par exemple, en groovy, arrivera √† temps, l√† les remises seront l√©g√®rement diff√©rentes: <br><br><pre> <code class="plaintext hljs">def age = 50 if ((Calendar.YEAR - customer.birthday.year) &gt;= age) { return orderAmount.multiply(0.75) } else { return orderAmount.multiply(0.9) }</code> </pre><br>  Le but de tout cela est de donner au d√©veloppeur la possibilit√© d'√©crire uniquement le code d'interface et le code de script, et de ne pas <code>getEngine</code> avec tous ces appels √† <code>getEngine</code> , <code>eval</code> et autres.  La biblioth√®que pour travailler avec des scripts devrait faire toute la magie - intercepter l'appel de la m√©thode d'interface, obtenir le texte du script, remplacer les valeurs des param√®tres, obtenir le moteur de script souhait√©, ex√©cuter le script (ou appeler la m√©thode par d√©faut s'il n'y a pas de texte de script) et renvoyer la valeur.  Id√©alement, en plus du code qui a d√©j√† √©t√© √©crit, le programme devrait avoir quelque chose comme ceci: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomerServiceBean</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomerService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PricingRepository pricingRepository; <span class="hljs-comment"><span class="hljs-comment">//Other injected beans here @Override public BigDecimal applyCustomerDiscount(Customer cust, BigDecimal orderAmnt) { if (customer.isRegistered()) { return pricingRepository.applyCustomerDiscount(cust, orderAmnt); } else { return orderAmnt; } //Other service methods here }</span></span></code> </pre><br>  Le d√©fi est lisible, compr√©hensible et pour le faire, il n'est pas n√©cessaire d'avoir des comp√©tences particuli√®res. <br><br>  Ce sont les id√©es sur la base desquelles une petite biblioth√®que pour travailler avec des scripts a √©t√© cr√©√©e.  Il est destin√© aux applications Spring, ce framework a √©t√© utilis√© pour cr√©er la biblioth√®que.  Il fournit une API extensible pour charger des scripts √† partir de diverses sources et les ex√©cuter, ce qui masque le travail de routine avec les moteurs de script. <br><br><h2>  Comment √ßa marche </h2><br>  Pour toutes les interfaces marqu√©es avec <code>@ScriptRepository</code> , les objets proxy sont cr√©√©s lors de l'initialisation du contexte Spring √† l'aide de la m√©thode <code>newProxyInstance</code> de la classe <code>Proxy</code> .  Ces proxys sont publi√©s dans le contexte de Spring en tant que beans singleton, vous pouvez donc d√©clarer un champ de classe avec un type d'interface et y placer l'annotation <code>@Autowired</code> ou <code>@Inject</code> .  Exactement comme pr√©vu. <br><br>  L'analyse et le traitement des interfaces de script sont activ√©s √† l'aide de l'annotation <code>@EnableSriptRepositories</code> , de la m√™me mani√®re que Spring active JPA ou les r√©f√©rentiels pour MongoDB ( <code>@EnableJpaRepositories</code> et <code>@EnableMongoRepositories</code> respectivement).  En tant que param√®tres d'annotation, vous devez sp√©cifier un tableau avec les noms des packages √† analyser. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableScriptRepositories</span></span>(basePackages = {<span class="hljs-string"><span class="hljs-string">"com.example"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.sample"</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CoreConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//More configuration here. }</span></span></code> </pre><br>  Les m√©thodes doivent √™tre annot√©es avec <code>@ScriptMethod</code> (il existe √©galement <code>@GroovyScript</code> et <code>@JavaScript</code> , avec la sp√©cialisation correspondante) pour ajouter des m√©tadonn√©es pour appeler le script.  Bien s√ªr, les m√©thodes par d√©faut dans les interfaces sont prises en charge. <br><br>  La structure g√©n√©rale de la biblioth√®que est illustr√©e dans le diagramme.  Composants surlign√©s en bleu qui doivent √™tre d√©velopp√©s, blanc - qui sont d√©j√† dans la biblioth√®que.  L'ic√¥ne Spring marque les composants disponibles dans le contexte Spring. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rz/h0/xc/rzh0xc48cr_kw1d97y2i3wrbdvu.png"></div><br>  Lorsque la m√©thode d'interface est appel√©e (en fait, l'objet proxy), le gestionnaire d'appel est lanc√©, qui dans le contexte de l'application recherche deux beans: le fournisseur, qui recherchera le texte du script, et l'ex√©cuteur, qui, en fait, le texte trouv√© s'ex√©cutera.  Le gestionnaire renvoie ensuite le r√©sultat √† la m√©thode appelante. <br><br>  Les noms de <code>@ScriptMethod</code> fournisseur et ex√©cuteur sont sp√©cifi√©s dans l'annotation <code>@ScriptMethod</code> , o√π vous pouvez √©galement d√©finir une limite sur le temps d'ex√©cution de la m√©thode.  Voici un exemple de code d'utilisation de la biblioth√®que: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ScriptRepository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PricingRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ScriptMethod</span></span> (providerBeanName = <span class="hljs-string"><span class="hljs-string">"resourceProvider"</span></span>, evaluatorBeanName = <span class="hljs-string"><span class="hljs-string">"groovyEvaluator"</span></span>, timeout = <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyCustomerDiscount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @ScriptParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cust"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Customer customer, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ScriptParam</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"amount"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> BigDecimal orderAmount) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orderAmount.multiply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"0.9"</span></span>)); } }</code> </pre><br>  Vous pouvez remarquer les annotations <code>@ScriptParam</code> - elles sont n√©cessaires pour indiquer les noms des param√®tres lors de leur transmission au script, car le compilateur Java efface les noms d'origine des sources (il existe des moyens de ne pas le faire, mais il vaut mieux ne pas s'y fier).  Vous pouvez omettre les noms des param√®tres, mais dans ce cas, vous devrez utiliser "arg0", "arg1" dans le script, ce qui n'am√©liore pas consid√©rablement la lisibilit√©. <br><br>  Par d√©faut, la biblioth√®que a des fournisseurs pour lire les fichiers .groovy et .js √† partir du disque et les ex√©cuteurs correspondants, qui sont des wrappers sur l'API JSR-233 standard.  Vous pouvez cr√©er vos propres beans pour diff√©rentes sources de script et pour diff√©rents moteurs, pour cela, vous devez impl√©menter les interfaces correspondantes: <code>ScriptProvider</code> et <code>SpringEvaluator</code> .  La premi√®re interface utilise <code>org.springframework.scripting.ScriptSource</code> et la seconde est <code>org.springframework.scripting.ScriptEvaluator</code> .  L'API Spring a √©t√© utilis√©e pour que des classes pr√©d√©finies puissent √™tre utilis√©es si elles sont d√©j√† dans l'application. <br>  Le fournisseur et l'artiste sont recherch√©s par nom pour une plus grande flexibilit√© - vous pouvez remplacer les beans standard de la biblioth√®que de votre application en nommant vos composants avec les m√™mes noms. <br><br><h2>  Test et versioning </h2><br>  Parce que les scripts changent fr√©quemment et facilement, vous devez avoir un moyen de vous assurer que les changements ne cassent rien.  La biblioth√®que est compatible avec JUnit, le r√©f√©rentiel peut simplement √™tre test√© en tant que classe r√©guli√®re dans le cadre d'un test unitaire ou d'int√©gration.  Les biblioth√®ques fictives sont √©galement prises en charge, dans les tests de la biblioth√®que, vous pouvez trouver un exemple de la fa√ßon de faire de la simulation sur la m√©thode du r√©f√©rentiel de scripts. <br><br>  Si le contr√¥le de version est n√©cessaire, vous pouvez cr√©er un fournisseur qui lira diff√©rentes versions de scripts √† partir du syst√®me de fichiers, de la base de donn√©es ou de Git, par exemple.  Il sera donc facile d'organiser un retour √† la version pr√©c√©dente du script en cas de probl√®me sur le serveur principal. <br><br><h2>  Total </h2><br>  La biblioth√®que pr√©sent√©e aidera √† organiser les scripts dans l'application Spring: <br><br><ol><li>  Le d√©veloppeur aura toujours des informations sur les param√®tres dont les scripts ont besoin et ce qui est retourn√©.  Et si les m√©thodes d'interface sont nomm√©es de mani√®re significative, alors ce que fait le script. </li><li>  Les fournisseurs et ex√©cuteurs aideront √† conserver le code pour recevoir des scripts et interagir avec le moteur de script en un seul endroit et ces appels ne seront pas dispers√©s dans le code de l'application. </li><li>  Tous les appels de script peuvent √™tre facilement trouv√©s en utilisant Find Usages. </li></ol><br>  La configuration automatique de Spring Boot, les tests unitaires et la simulation sont pris en charge.  Vous pouvez obtenir des donn√©es sur les m√©thodes de ¬´script¬ª et leurs param√®tres via l'API.  Et vous pouvez √©galement encapsuler le r√©sultat de l'ex√©cution avec un objet ScriptResult sp√©cial, dans lequel il y aura un r√©sultat ou une instance d'exception si vous ne voulez pas d√©ranger avec try ... catch lors de l'appel de scripts.  La configuration XML est prise en charge si elle est requise pour une raison ou une autre.  Et enfin - vous pouvez sp√©cifier un d√©lai d'expiration pour la m√©thode de script, si le besoin s'en fait sentir. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les sources de la biblioth√®que sont ici.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431084/">https://habr.com/ru/post/fr431084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431074/index.html">Guide JavaScript Partie 8: Pr√©sentation des fonctionnalit√©s d'ES6</a></li>
<li><a href="../fr431076/index.html">Les frameworks Node.js les plus populaires de 2018</a></li>
<li><a href="../fr431078/index.html">Guide de gestion des erreurs JavaScript</a></li>
<li><a href="../fr431080/index.html">Comment organiser des bureaux distants et ne pas perdre une √©quipe dans l'espace</a></li>
<li><a href="../fr431082/index.html">Kotlin: √† la recherche d'un responsable marketing</a></li>
<li><a href="../fr431086/index.html">Tout ce que vous vouliez savoir sur PVS-Studio et n'h√©sitez pas √† demander</a></li>
<li><a href="../fr431088/index.html">La gestion des fichiers a mal tourn√© - Partie 1: √† l'origine des ann√©es 90</a></li>
<li><a href="../fr431090/index.html">Un bot VK, un C # et une orange</a></li>
<li><a href="../fr431092/index.html">ROS: carte de profondeur sur le Raspberry Pi "low blood"</a></li>
<li><a href="../fr431094/index.html">Tri solitaire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>