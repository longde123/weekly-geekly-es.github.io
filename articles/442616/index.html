<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôèüèΩ üï∫üèº üë± Aceleramos el procesamiento de eventos a 1.6 millones por segundo üêÅ üèùÔ∏è üçò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cuando los participantes de HighLoad ++ llegaron al informe de Alexander Krasheninnikov , esperaban escuchar sobre el procesamiento de 1,600,000 event...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aceleramos el procesamiento de eventos a 1.6 millones por segundo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/442616/">  Cuando los participantes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HighLoad ++</a> llegaron al informe de <b>Alexander Krasheninnikov</b> , esperaban escuchar sobre el procesamiento de 1,600,000 eventos por segundo.  Las expectativas no se hicieron realidad ... Debido a que durante la preparaci√≥n para el rendimiento, esta cifra aument√≥ a <b>1.800.000</b> , por lo que, en HighLoad ++, la realidad supera las expectativas. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hace 3 a√±os, Alexander cont√≥</a> c√≥mo construyeron un sistema de procesamiento de eventos escalable casi en tiempo real en Badoo.  Desde entonces, ha evolucionado, los vol√∫menes han crecido en el proceso, fue necesario resolver los problemas de escala y tolerancia a fallas, y en alg√∫n momento se requirieron medidas radicales: un <b>cambio en la pila tecnol√≥gica</b> . <br><br><img src="https://habrastorage.org/webt/q8/s-/cq/q8s-cqlxfrv8abkdotnudzeq1u8.jpeg"><br><br>  A partir del descifrado, aprender√° c√≥mo en Badoo reemplaz√≥ el paquete Spark + Hadoop con ClickHouse, <b>guard√≥ el hardware 3 veces y aument√≥ la carga 6 veces</b> , por qu√© y por qu√© medios recopilar estad√≠sticas en el proyecto, y luego qu√© hacer con estos datos. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/5KQsNmRTQmg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <b>Sobre el orador:</b> Alexander Krasheninnikov ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">alexkrash</a> ) - Jefe de Ingenier√≠a de Datos en Badoo.  Est√° involucrado en la infraestructura de BI, escalando las cargas de trabajo y administra los equipos que construyen la infraestructura de procesamiento de datos.  Le encanta todo lo distribuido: Hadoop, Spark, ClickHouse.  Estoy seguro de que se pueden preparar sistemas distribuidos geniales desde OpenSource. <a name="habracut"></a><br><br><h2>  Colecci√≥n de estad√≠sticas </h2><br>  Si no tenemos datos, estamos ciegos y no podemos administrar nuestro proyecto.  Es por eso que necesitamos estad√≠sticas, para <strong>monitorear la viabilidad del proyecto.</strong>  Nosotros, como ingenieros, deber√≠amos esforzarnos por mejorar nuestros productos y, si <strong>lo desea, medirlo.</strong>  Este es mi lema en el trabajo.  En primer lugar, nuestro objetivo son los beneficios comerciales.  Las estad√≠sticas <strong>proporcionan respuestas a preguntas comerciales</strong> .  Las m√©tricas t√©cnicas son m√©tricas t√©cnicas, pero la empresa tambi√©n est√° interesada en los indicadores, y tambi√©n deben tenerse en cuenta. <br><br><h2>  Estad√≠sticas del ciclo de vida </h2><br>  Defino el ciclo de vida de las estad√≠sticas por 4 puntos, cada uno de los cuales discutiremos por separado. <br><br><img src="https://habrastorage.org/webt/pp/kb/p5/ppkbp5uw_stwtzdgmakh9z_ffbw.jpeg"><br><br><h2>  Definir Fase - Formalizaci√≥n </h2><br>  En la aplicaci√≥n, recopilamos varias m√©tricas.  En primer lugar, estas son <strong>m√©tricas comerciales</strong> .  Si tiene un servicio de fotograf√≠a, por ejemplo, se pregunta cu√°ntas fotos se cargan por d√≠a, por hora, por segundo.  Las siguientes m√©tricas son <strong>"semi-t√©cnicas"</strong> : capacidad de respuesta de una aplicaci√≥n m√≥vil o sitio, trabajo de API, qu√© tan r√°pido interact√∫a un usuario con un sitio, instalaci√≥n de la aplicaci√≥n, UX.  <strong>El seguimiento del comportamiento del usuario</strong> es la tercera m√©trica importante.  Estos son sistemas como Google Analytics y Yandex.Metrics.  Tenemos nuestro propio sistema de seguimiento, en el que invertimos mucho. <br><br>  En el proceso de trabajar con estad√≠sticas, muchos usuarios est√°n involucrados, estos son desarrolladores y an√°lisis de negocios.  Es importante que todos hablen el mismo idioma, por lo que debe estar de acuerdo. <br><br><blockquote>  Es posible negociar verbalmente, pero es mucho mejor cuando esto ocurre formalmente, en una estructura clara de eventos. </blockquote><br>  <strong>La formalizaci√≥n de la estructura de los eventos comerciales</strong> es cuando el desarrollador dice cu√°ntos registros tenemos, el analista entiende que se le proporcion√≥ informaci√≥n no solo sobre el n√∫mero total de registros, sino tambi√©n por pa√≠s, g√©nero y otros par√°metros.  Y toda esta informaci√≥n est√° formalizada y es <strong>de dominio p√∫blico para todos los usuarios de la empresa</strong> .  El evento tiene una estructura mecanografiada y una descripci√≥n formal.  Por ejemplo, almacenamos esta informaci√≥n en formato <strong>Protocol Buffers</strong> . <br><br>  Descripci√≥n del evento "Registro": <br><br><pre><code class="plaintext hljs">enum Gender { FEMALE = 1; MALE = 2; } message Registration { required int32 userid =1; required Gender usergender = 2; required int32 time =3; required int32 countryid =4; }</code> </pre> <br>  El evento de registro contiene informaci√≥n sobre el <strong>usuario, el campo, la hora del</strong> evento y el <strong>pa√≠s de</strong> registro del usuario.  Esta informaci√≥n est√° disponible para los analistas y, en el futuro, la empresa comprende lo que recopilamos. <br><br><h3>  ¬øPor qu√© necesito una descripci√≥n formal? </h3><br>  Una descripci√≥n formal es la <strong>uniformidad para los desarrolladores, analistas y el departamento de productos.</strong>  Entonces esta informaci√≥n impregna la descripci√≥n de la l√≥gica empresarial de la aplicaci√≥n.  Por ejemplo, tenemos un sistema interno para describir los procesos comerciales y en √©l hay una pantalla con una nueva funci√≥n. <br><br><img src="https://habrastorage.org/webt/qf/cv/hg/qfcvhgvo39rtidli5fxdq65hx2q.jpeg"><br><br>  En el <strong>documento de requisitos</strong> del <strong>producto</strong> hay una secci√≥n con las instrucciones de que cuando el usuario interact√∫a con la aplicaci√≥n de esta manera, debemos enviar un evento con exactamente los mismos par√°metros.  Posteriormente, podremos validar qu√© tan bien funcionan nuestras caracter√≠sticas y que las medimos correctamente.  Una descripci√≥n formal nos permite comprender mejor c√≥mo guardar estos datos en una base de datos: NoSQL, SQL u otros.  Tenemos <strong>un esquema de datos</strong> , y eso es genial. <br><br>  En algunos sistemas anal√≠ticos que se proporcionan como un servicio, solo hay 10-15 eventos en el almacenamiento secreto.  En nuestro pa√≠s, este n√∫mero ha crecido m√°s de 1000 y no va a detenerse; <strong>es imposible vivir sin un solo registro</strong> . <br><br><h3>  Definir resumen de fase </h3><br>  Decidimos que las <strong>estad√≠sticas, esto es importante</strong> y <strong>describimos un √°rea tem√°tica determinada</strong> , es bueno, puedes seguir viviendo. <br><br><h2>  Fase de recopilaci√≥n: recopilaci√≥n de datos </h2><br>  Decidimos construir el sistema para que cuando ocurra un evento comercial (registro, env√≠o de un mensaje, como) al mismo tiempo que guardamos esta informaci√≥n, enviemos por separado un determinado evento estad√≠stico. <br><br><blockquote>  En el c√≥digo, las estad√≠sticas se env√≠an simult√°neamente con el evento comercial. </blockquote><br>  Se procesa de manera completamente independiente de los almacenes de datos en los que se ejecuta la aplicaci√≥n, porque el <strong>flujo de datos pasa a trav√©s de una tuber√≠a de procesamiento separada.</strong> <br><br>  Descripci√≥n a trav√©s de EDL: <br><br><pre> <code class="plaintext hljs">enum Gender { FEMALE = 1; MALE = 2; } message Registration { required int32 user_id =1; required Gender user_gender = 2; required int32 time =3; required int32 country_id =4; }</code> </pre> <br>  Tenemos una descripci√≥n del evento de registro.  Se genera autom√°ticamente una API, accesible para los desarrolladores desde el c√≥digo, que en 4 l√≠neas le permite enviar estad√≠sticas. <br><br>  API basada en EDL: <br><br><pre> <code class="plaintext hljs">\EDL\Event\Regist ration::create() -&gt;setUserId(100500) -&gt;setGender(Gender: :MALE) -&gt;setTime(time()) -&gt;send();</code> </pre> <br><h3>  Entrega de eventos </h3><br>  Este es nuestro sistema externo.  Hacemos esto porque tenemos servicios incre√≠bles que proporcionan una API para trabajar con datos de fotos, sobre otra cosa.  Todos almacenan datos en bases de datos novedosas, como Aerospike y CockroachDB. <br><br>  Cuando necesita crear alg√∫n tipo de informe, no tiene que ir y luchar: "Chicos, ¬øcu√°nto de esto tienen y cu√°nto?"  - Todos los datos se env√≠an en un flujo separado.  Transportador de procesamiento - sistema externo.  Desde el contexto de la aplicaci√≥n, desatamos todos los datos del repositorio de l√≥gica de negocios y los enviamos a una tuber√≠a separada. <br><br>  La fase de recopilaci√≥n supone la disponibilidad de servidores de aplicaciones.  Tenemos este PHP. <br><br><img src="https://habrastorage.org/webt/az/vo/va/azvova-esx681etff8drvvkigeq.gif"><br><br><h3>  Transporte </h3><br>  Este es un subsistema que nos permite enviar a otra tuber√≠a lo que hicimos desde el contexto de la aplicaci√≥n.  El transporte se selecciona √∫nicamente seg√∫n sus requisitos, seg√∫n la situaci√≥n del proyecto. <br><br>  El transporte tiene caracter√≠sticas, y el primero son <strong>las garant√≠as de entrega.</strong>  Caracter√≠sticas del transporte: al menos una vez, exactamente una vez, elige estad√≠sticas para tus tareas, en funci√≥n de la importancia de estos datos.  Por ejemplo, para los sistemas de facturaci√≥n es inaceptable que las estad√≠sticas muestren m√°s transacciones de las que hay; esto es dinero, no es posible. <br><br>  El segundo par√°metro son los <strong>enlaces para lenguajes de programaci√≥n.</strong>  De alguna manera debemos interactuar con el transporte, por lo que se selecciona de acuerdo con el idioma en el que se escribe el proyecto. <br><br>  El tercer par√°metro es la <strong>escalabilidad.</strong>  Como estamos hablando de millones de eventos por segundo, ser√≠a bueno tener en cuenta la escalabilidad futura. <br><br>  Hay muchas opciones de transporte: aplicaciones RDBMS, Flume, Kafka o LSD.  Usamos <strong>LSD</strong> , esta es nuestra forma especial. <br><br><h3>  Transmisi√≥n en vivo del demonio </h3><br>  El LSD no tiene nada que ver con sustancias prohibidas.  Este es un <strong>demonio de transmisi√≥n animado y muy r√°pido</strong> que no proporciona ning√∫n agente para escribirle.  Podemos ajustarlo, tenemos <strong>integraci√≥n con otros sistemas</strong> : HDFS, Kafka, podemos reorganizar los datos enviados.  El LSD no tiene una llamada de red en INSERT, y puede controlar la topolog√≠a de la red. <br><br>  Lo m√°s importante, este es <strong>OpenSource de Badoo,</strong> no hay raz√≥n para no confiar en este software. <br><br>  Si fuera un demonio perfecto, entonces, en lugar de Kafka, hablar√≠amos de LSD en cada conferencia, pero cada LSD tiene una mosca en la pomada.  Tenemos nuestras propias limitaciones con las que nos sentimos c√≥modos: <strong>no tenemos soporte de replicaci√≥n en LSD</strong> y tiene <strong>al menos una</strong> garant√≠a de entrega.  Adem√°s, para las transacciones de dinero, este no es el transporte m√°s adecuado, pero generalmente necesita comunicarse con dinero exclusivamente a trav√©s de bases de datos "√°cidas", que admiten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ACID</a> . <br><br><h3>  Recopilar resumen de fase </h3><br>  Con base en los resultados de la serie anterior, recibimos una <strong>descripci√≥n formal de los</strong> datos, generamos una <strong>API</strong> excelente y conveniente <strong>para los despachadores de eventos</strong> de ellos, y descubrimos c√≥mo <strong>transferir</strong> estos datos <strong>desde el contexto de la aplicaci√≥n a una tuber√≠a separada</strong> .  Ya no est√° mal, y nos estamos acercando a la siguiente fase. <br><br><h2>  Proceso de fase: procesamiento de datos </h2><br>  Recopilamos datos de registros, subimos fotos, encuestas. ¬øQu√© hacer con todo esto?  De estos datos queremos obtener <strong>gr√°ficos</strong> con una larga historia y <strong>datos sin procesar</strong> .  Los gr√°ficos entienden todo: no es necesario ser un desarrollador para comprender desde la curva que los ingresos de la compa√±√≠a est√°n creciendo.  Utilizamos datos en bruto para informes en l√≠nea y ad-hoc.  Para casos m√°s complejos, nuestros analistas desean realizar consultas anal√≠ticas sobre estos datos.  Tanto eso como esa funcionalidad son necesarios para nosotros. <br><br><h3>  Gr√°ficos </h3><br>  Los gr√°ficos vienen en muchas formas. <br><br><img src="https://habrastorage.org/webt/hu/c7/ap/huc7apcxpcajxhc5k3an8ken4wk.jpeg"><br><br>  O, por ejemplo, un gr√°fico con un historial que muestra datos de 10 a√±os. <br><br><img src="https://habrastorage.org/webt/cq/_z/pc/cq_zpcmcbe2b_nipvwhbtnkme94.jpeg"><br><br>  Los gr√°ficos son incluso as√≠. <br><br><img src="https://habrastorage.org/webt/rs/76/eg/rs76eg23gglv8m1xlaby2gr8vzg.jpeg"><br><br>  Este es el resultado de una prueba AB, y es sorprendentemente similar al edificio Chrysler en Nueva York. <br><br>  Hay dos formas de dibujar un gr√°fico: una <strong>consulta de datos en bruto</strong> y una <strong>serie de tiempo</strong> .  Ambos enfoques tienen desventajas y ventajas, que no analizaremos en detalle.  Utilizamos un <strong>enfoque h√≠brido</strong> : mantenemos una breve cola de datos sin procesar para informes operativos y series de tiempo para almacenamiento a largo plazo.  El segundo se calcula a partir del primero. <br><br><h3>  C√≥mo hemos crecido a 1.8 millones de eventos por segundo </h3><br>  Es una larga historia: millones de RPS no suceden en un d√≠a.  Badoo es una empresa con una d√©cada de historia, y podemos decir que el sistema de procesamiento de datos creci√≥ con la empresa. <br><br><img src="https://habrastorage.org/webt/av/o3/04/avo304ko07jkl4szc5dnz2x7zc8.jpeg"><br><br>  Al principio no ten√≠amos nada.  Comenzamos a recopilar datos: resultaron <strong>5.000 eventos por segundo.</strong>  ¬°Un host MySQL y nada m√°s!  Cualquier DBMS relacional har√° frente a esta tarea, y se sentir√° c√≥modo con ella: tendr√° transaccionalidad, ingresar√° los datos, recibir√° solicitudes, todo funciona bien y bien.  Entonces vivimos por un tiempo. <br><br>  En alg√∫n momento, ocurri√≥ el fragmentaci√≥n funcional: datos de registro, aqu√≠, y sobre fotos, all√≠.  As√≠ que vivimos hasta <strong>200,000 eventos por segundo</strong> y comenzamos a usar varios enfoques combinados: para almacenar datos no brutos, sino <strong>agregados</strong> , pero hasta ahora dentro de la base de datos relacional.  Almacenamos contadores, pero la esencia de la mayor√≠a de las bases de datos relacionales es tal que ser√° imposible ejecutar una <strong>consulta DISTINCT</strong> sobre estos datos: el modelo algebraico de contadores no permite calcular DISTINCT. <br><br>  En Badoo tenemos el lema <strong>"Fuerza imparable"</strong> .  No √≠bamos a parar y crecimos m√°s.  En el momento en que cruzamos el umbral de <strong>200,000 eventos por segundo</strong> , decidimos crear una descripci√≥n formal, de la que habl√© anteriormente.  Antes de eso, hubo un poco de caos, y ahora tenemos un registro estructurado de eventos: comenzamos a escalar el sistema, <strong>conectamos Hadoop</strong> , todos los datos fueron a las <strong>tablas de Hive.</strong> <br><br>  Hadoop es un gran paquete de software, sistema de archivos.  Para la inform√°tica distribuida, Hadoop dice: "Ponga los datos aqu√≠, le dejar√© realizar consultas anal√≠ticas sobre ellos".  As√≠ lo hicimos, escribimos un <strong>c√°lculo regular de todos los gr√°ficos</strong> , result√≥ bien.  Pero los gr√°ficos son valiosos cuando se actualizan r√°pidamente: una vez al d√≠a, ver una actualizaci√≥n del gr√°fico no es tan divertido.  Si lanzamos algo que conduce a un error fatal en la producci√≥n, nos gustar√≠a ver que el gr√°fico caiga de inmediato, y no cada dos d√≠as.  Por lo tanto, todo el sistema comenz√≥ a degradarse despu√©s de un tiempo.  Sin embargo, nos dimos cuenta de que en esta etapa, puede apegarse a la pila de tecnolog√≠a seleccionada. <br><br><blockquote>  Para nosotros, Java era nuevo, nos gust√≥ y entendimos lo que se pod√≠a hacer de manera diferente. </blockquote><br>  En la etapa de 400,000 a <strong>800,000 eventos por segundo</strong> , reemplazamos a Hadoop en su forma m√°s pura y Hive, como ejecutor de consultas anal√≠ticas, con <strong>Spark Streaming</strong> , escribi√≥ un <strong>mapa gen√©rico / reducci√≥n</strong> y c√°lculo incremental de m√©tricas.  Hace 3 a√±os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dije</a> c√≥mo lo hicimos.  Entonces nos pareci√≥ que Spark vivir√≠a para siempre, pero la vida decret√≥ lo contrario: nos encontramos con las limitaciones de Hadoop.  Quiz√°s si tuvi√©ramos otras condiciones, seguir√≠amos viviendo con Hadoop. <br><br>  Otro problema, adem√°s de calcular gr√°ficos en Hadoop, fueron las incre√≠bles consultas SQL de cuatro pisos que fueron conducidas por analistas, y los gr√°ficos no se actualizaron r√°pidamente.  El hecho es que hay un trabajo bastante complicado con el procesamiento de datos operativos, por lo que es en tiempo real, r√°pido y genial. <br><br>  Badoo es atendido por dos centros de datos ubicados en dos lados del Oc√©ano Atl√°ntico, en Europa y Am√©rica del Norte.  Para crear un informe unificado, debe enviar datos de Am√©rica a Europa.  Es en el centro de datos europeo donde guardamos todas las estad√≠sticas estad√≠sticas, porque hay m√°s poder de c√≥mputo.  <strong>Un recorrido de ida y vuelta</strong> entre centros de datos de aproximadamente <strong>200 ms</strong> (la red es bastante delicada) no es lo mismo hacer una solicitud a otro DC que ir al siguiente rack. <br><br>  Cuando comenzamos a formalizar eventos y desarrolladores, y los gerentes de producto se involucraron, a todos les gust√≥ todo, solo hubo un <strong>crecimiento explosivo de eventos</strong> .  En este momento, era hora de comprar hierro en el cl√∫ster, pero realmente no quer√≠amos hacer esto. <br><br>  Cuando superamos el pico de <strong>800,000 eventos por segundo</strong> , descubrimos lo que Yandex hab√≠a subido a OpenSource <strong>ClickHouse</strong> , y decidimos probarlo.  <strong>Llenaron un tren de conos</strong> mientras intentaban hacer algo, y como resultado, cuando todo funcion√≥, hicieron una peque√±a recepci√≥n en el buffet sobre el primer mill√≥n de eventos.  Probablemente, ClickHouse podr√≠a haber terminado el informe. <br><br><blockquote>  Solo toma ClickHouse y vive con √©l. </blockquote><br>  Pero esto no es interesante, por lo que continuaremos hablando sobre el procesamiento de datos. <br><br><h3>  Clickhouse </h3><br>  ClickHouse es una exageraci√≥n de los √∫ltimos dos a√±os y no necesita ser presentado: solo en HighLoad ++ en 2018 recuerdo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">unos cinco informes al</a> respecto, as√≠ como seminarios y reuniones. <br><br>  Esta herramienta est√° dise√±ada para resolver exactamente las tareas que establecemos para nosotros mismos.  Hay <strong>actualizaciones</strong> y chips en <strong>tiempo real</strong> que recibimos de Hadoop: replicaci√≥n, fragmentaci√≥n.  No hab√≠a raz√≥n para no probar ClickHouse, porque entendieron que con la implementaci√≥n en Hadoop ya hab√≠amos roto el fondo.  La herramienta es genial, y la documentaci√≥n generalmente es buena: escrib√≠ all√≠ yo mismo, realmente me gusta todo, y todo es genial.  Pero tuvimos que resolver una serie de problemas. <br><br>  <strong>¬øC√≥mo cambiar todo el flujo de eventos en ClickHouse?</strong>  <strong>¬øC√≥mo combinar datos de dos centros de datos?</strong>  Por el hecho de que acudimos a los administradores y les dijimos: "Chicos, vamos a instalar ClickHouse", no har√°n que la red sea dos veces m√°s gruesa, y el retraso es la mitad.  No, la red sigue siendo tan delgada y peque√±a como el primer salario. <br><br>  <strong>¬øC√≥mo almacenar los resultados</strong> ?  En Hadoop, entendimos c√≥mo dibujar gr√°ficos, pero ¬øc√≥mo hacerlo en el m√°gico ClickHouse?  La varita m√°gica no est√° incluida.  <strong>¬øC√≥mo entregar resultados</strong> al almacenamiento de series temporales? <br><br>  Como dijo mi profesor en el instituto, considere 3 esquemas de datos: estrat√©gico, l√≥gico y f√≠sico. <br><br><h4>  Esquema de almacenamiento estrat√©gico </h4><br>  Tenemos <strong>2 centros de datos</strong> .  Aprendimos que ClickHouse no sabe nada sobre los DC, y acabamos de abrir el cl√∫ster en cada DC.  Ahora los <strong>datos no se mueven a trav√©s del cable cruzado del Atl√°ntico</strong> : todos los datos que ocurrieron en el DC se almacenan localmente en su cl√∫ster.  Cuando deseamos realizar una solicitud sobre los datos combinados, por ejemplo, para averiguar cu√°ntos registros hay en ambos DC, ClickHouse nos brinda esta oportunidad.  Baja latencia y disponibilidad para la solicitud, ¬°solo una obra maestra! <br><br><img src="https://habrastorage.org/webt/mr/dc/-2/mrdc-205rzloz1c2oemavnikcxu.jpeg"><br><br><h4>  Esquema de almacenamiento f√≠sico </h4><br>  Nuevamente, preguntas: ¬øc√≥mo caer√°n nuestros datos en el modelo relacional ClickHouse, qu√© se debe hacer para no perder replicaci√≥n y fragmentaci√≥n?  Todo se describe ampliamente en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n de ClickHouse</a> , y si tiene m√°s de un servidor, se encontrar√° con este art√≠culo.  Por lo tanto, no profundizaremos en lo que est√° en el manual: replicaciones, fragmentos y consultas a todos los datos en fragmentos. <br><br><h4>  L√≥gica de almacenamiento </h4><br>  El diagrama l√≥gico es el m√°s interesante.  En una tuber√≠a procesamos eventos heterog√©neos.  Esto significa que tenemos una <strong>secuencia de eventos heterog√©neos</strong> : registro, voz, carga de fotos, m√©tricas t√©cnicas, seguimiento del comportamiento del usuario: todos estos eventos tienen <strong>atributos</strong> completamente <strong>diferentes</strong> .  Por ejemplo, mir√© la pantalla en un tel√©fono m√≥vil: necesito una identificaci√≥n de pantalla, vot√© por alguien, debes entender si el voto fue a favor o en contra.  Todos estos eventos tienen diferentes atributos, se dibujan diferentes gr√°ficos en ellos, pero todo esto debe procesarse en una sola tuber√≠a.  ¬øC√≥mo ponerlo en el modelo ClickHouse? <br><br>  <strong>Enfoque n. ¬∞ 1: por tabla de eventos.</strong>  Este primer enfoque, extrapolamos de la experiencia adquirida con MySQL: creamos una <strong>tableta para cada evento</strong> en ClickHouse.  Suena bastante l√≥gico, pero nos encontramos con una serie de dificultades. <br><br>  No tenemos restricciones de que el evento cambie su estructura cuando se publique la compilaci√≥n de hoy.  Este parche puede ser realizado por cualquier desarrollador.  El esquema generalmente es mutable en todas las direcciones.  El √∫nico <strong>campo requerido</strong> es el <strong>evento de marca de tiempo</strong> y cu√°l fue el evento.  Todo lo dem√°s cambia sobre la marcha y, en consecuencia, estas placas deben modificarse.  ClickHouse tiene la capacidad de realizar <strong>ALTER en un cl√∫ster</strong> , pero este es un procedimiento delicado y delicado que es dif√≠cil de automatizar para que funcione sin problemas.  Por lo tanto, esto es un menos. <br><br>  Tenemos m√°s de mil eventos diferentes, lo que nos da una <strong>alta tasa de INSERTAR por m√°quina</strong> : registramos constantemente todos los datos en mil tablas.  Para ClickHouse, este es un antipatr√≥n.  Si Pepsi tiene el eslogan: "Vive en grandes sorbos", entonces ClickHouse: <strong>"Vive en grandes lotes"</strong> .  Si esto no se hace, entonces la replicaci√≥n se ahoga, ClickHouse se niega a aceptar nuevas inserciones, un esquema desagradable. <br><br>  <strong>Enfoque n. ¬∞ 2: una mesa amplia</strong> .  Los hombres siberianos intentaron deslizar la motosierra en el riel y aplicar un modelo de datos diferente.  Hacemos una tabla con <strong>mil columnas</strong> , donde cada evento tiene columnas reservadas para sus datos.  Obtenemos una gran <strong>tabla dispersa</strong> ; afortunadamente, esto no fue m√°s all√° del entorno de desarrollo, porque desde los primeros insertos qued√≥ claro que el esquema es absolutamente malo, y no lo haremos. <br><br>  Pero a√∫n as√≠ quiero usar un producto de software tan genial, un poco m√°s para terminar, y ser√° lo que necesita. <br><br>  <strong>Enfoque n. ¬∞ 3: tabla gen√©rica.</strong>  Tenemos una gran tabla en la que almacenamos datos en matrices, porque ClickHouse admite <strong>tipos de datos no escalares</strong> .  Es decir, comenzamos una columna en la que se almacenan los nombres de los atributos, y una columna separada con una matriz en la que se almacenan los valores de los atributos. <br><br><img src="https://habrastorage.org/webt/ot/s3/ro/ots3ronbcjh69ssxujqvbuxeghc.jpeg"><br><br>  ClickHouse aqu√≠ realiza su tarea muy bien.  Si solo tuvi√©ramos que insertar datos, probablemente exprimir√≠amos 10 veces m√°s en la instalaci√≥n actual. <br><br>  Sin embargo, la mosca en la pomada es que tambi√©n es un antipatr√≥n para ClickHouse, <strong>para almacenar matrices de cadenas</strong> .  Esto es malo porque las matrices de filas <strong>ocupan m√°s espacio en disco</strong> : se reducen peor que las columnas simples y son <strong>m√°s dif√≠ciles de procesar</strong> .  Pero para nuestra tarea, cerramos los ojos a esto, ya que las ventajas son mayores. <br><br>  ¬øC√≥mo hacer SELECCIONAR de tal tabla?  Nuestra tarea es contar los registros agrupados por g√©nero.  Primero necesita encontrar en una matriz qu√© posici√≥n corresponde a la columna de g√©nero, luego subir a otra columna con este √≠ndice y obtener los datos. <br><br><img src="https://habrastorage.org/webt/gh/pw/ek/ghpwekgjjrr0eisi8_zjmoi48tk.jpeg"><br><br><h4>  C√≥mo dibujar gr√°ficos en estos datos </h4><br>  Como se describen todos los eventos, tienen una estructura estricta, formamos una consulta SQL de cuatro pisos para cada tipo de evento, la ejecutamos y guardamos los resultados en otra tabla. <br><br>  El problema es que para dibujar dos puntos adyacentes en el gr√°fico, debe <strong>escanear toda la tabla</strong> .  Ejemplo: nos fijamos en el registro por d√≠a.  Este evento es desde la l√≠nea superior hasta la pen√∫ltima.  Escaneado una vez, excelente.  Despu√©s de 5 minutos, queremos dibujar un nuevo punto en el gr√°fico; nuevamente, escaneamos el rango de datos que se cruza con el escaneo anterior, y as√≠ sucesivamente para cada evento.  Suena l√≥gico, pero no se ve muy bien. <br><br>  Adem√°s, cuando tomamos algunas l√≠neas, tambi√©n necesitamos <strong>leer los resultados bajo agregaci√≥n</strong> .  Por ejemplo, hay un hecho de que el siervo de Dios estaba registrado en Escandinavia y era un hombre, y necesitamos calcular las estad√≠sticas resumidas: cu√°ntos registros, cu√°ntos hombres, cu√°ntos de ellos son personas y cu√°ntos son de Noruega.  Esto se llama en t√©rminos de las bases de datos anal√≠ticas <strong>ROLLUP, CUBE</strong> y <strong>GROUPING SETS</strong> : convierte una l√≠nea en varias. <br><br><h4>  Como tratar </h4><br>  Afortunadamente, ClickHouse tiene una herramienta para resolver este problema, a saber, el <strong>estado serializado de las funciones agregadas</strong> .  Esto significa que puede escanear un dato una vez y guardar estos resultados.  Esta es una <strong>caracter√≠stica asesina</strong> .  Hace 3 a√±os hicimos exactamente esto en Spark y Hadoop, y es genial que en paralelo con nosotros, las mejores mentes de Yandex implementaron un an√°logo en ClickHouse. <br><br><h4>  Solicitud lenta </h4><br>  Tenemos una solicitud lenta: contar usuarios √∫nicos para hoy y ayer. <br><br><pre> <code class="plaintext hljs">SELECT uniq(user_id) FROM table WHERE dt IN (today(), yesterday())</code> </pre> <br>  En el plano f√≠sico, podemos hacer SELECCIONAR para el estado de ayer, obtener su representaci√≥n binaria, guardarla en alg√∫n lugar. <br><br><pre> <code class="plaintext hljs">SELECT uniq(user_id), 'xxx' AS ts, uniqState(user id) AS state FROM table WHERE dt IN (today(), yesterday())</code> </pre> <br>  Por hoy, solo cambiamos la condici√≥n de que ser√° hoy: <code>'yyy' AS ts</code> y <code>WHERE dt = today()</code> y marca de tiempo llamaremos ‚Äúxxx‚Äù y ‚Äúaaa‚Äù.            ,        ,    2 . <br><br><pre> <code class="plaintext hljs">SELECT uniqMerge(state) FROM ageagate_table WHERE ts IN ('xxx', 'yyy')</code> </pre> <br><h4>   </h4><br>  : <br><br><ul><li>    ,       ; </li><li>       ; </li><li>  . </li></ul><br>         ,   -      .     <strong>    </strong> .    ,     ,  ,   ,       ClickHouse,  : ¬´,      ! ,    !¬ª <br><br><h4>     </h4><br>   ,      ,    .      <strong>  ,</strong>          .    .    ‚Äî     SQL-,       . ,        ,      . <br><br><img src="https://habrastorage.org/webt/df/0b/o6/df0bo6pb7l6t94sxnrwtpctfcxk.jpeg"><br><br>     ,   -  time series.      :      ,  ,      ,    time series. <br><br>   time series    :   ,    ,    timestamp       .        ,    ,    .              .   ,        ,       ,      ‚Äî  ,    . ,     ,   ClickHouse  -,     ,     . <br><br>      ,       ,      ClickHouse: <br><br><blockquote> ‚Äî    ¬´ ¬ª,    ‚Äî      . </blockquote><br>     time series  2 ,     20   20-80 .   .  ClickHouse   <strong>GraphiteMergeTree</strong> ,    time series,      . <br><br><h4>    </h4><br> <strong>8  ClickHouse</strong> ,   6  -  ,  2  :    2 ‚Äî     ,    . <strong>  1.8 .   </strong>  ,     <strong>500</strong> <strong>   </strong> . ,   1,8 ,       500 !       . <br><br><h3>    Hadoop </h3><br> <strong>   2 </strong> .          .     <strong>3 </strong> ,   CPU ‚Äî  <strong>4</strong> .  ,        . <br><br><h3>   Process </h3><br>     <strong>   </strong> , ,   ,        .   ,    ,    ClickHouse    3 000   . ,  ,   ,      overkill. <br><br>   ,   ,     .   ClickHouse,   <strong>   </strong> . ,  ,   ,    .   ,  8      3‚Äì4     .  ‚Äî     . <br><br><h2>  Present ‚Äî    </h2><br>      ,     ?   time series,     <strong>  time series</strong> ,           ,   ,   . <br><br><img src="https://habrastorage.org/webt/82/uo/qq/82uoqq4jw6amtxph_jgcjpjnwkm.jpeg"><br><br> <strong>Drop Detect ‚Äî    SQL</strong> :  SQL-    ,     ,      . <br><br><img src="https://habrastorage.org/webt/ru/1v/up/ru1vuporiqj-suncjyc-sh06xrk.jpeg"><br><br>     <strong>Anomaly Detection</strong> ‚Äî      .    ,  ,       2%   ,    ‚Äî   40,    ,     ,        ,    . <br><br>    ‚Äî   ,  ,   - ,    Anomaly Detection. <br><br><h3> Anomaly Detection </h3><br>  ,   time series .    : ,  ,    .   time series     <strong></strong> .  ,       ,  .    ,   <strong>drop detection</strong> ‚Äî       ,  . <br><br>     UI. <br><br><img src="https://habrastorage.org/webt/sk/mg/hn/skmghn7mirsubwu-vpm2dq5tols.jpeg"><br><br>    .  -  ,       ‚Äî  .    -,  . <br><br><h3>   Present </h3><br>    ,      ,     <strong> </strong> .     <strong> </strong>    ,   :     1000 ‚Äî alarm,     0 ‚Äî alarm.    . <br><br>   <strong>Anomaly Detection</strong>    ,    .    Anomaly Detection     <strong>Exasol</strong> ,        ClickHouse.        Anomaly Detection  2 ,   . <br><br><h2>   </h2><br>  ,  ,  4    . <br><br>  , <strong>  </strong>  ,     ,     .  , <strong>    </strong> ,      . ,  <strong>    </strong> <strong> </strong> . <br><br><blockquote>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HighLoad++</a>  ,    HighLoad++    -       .        ,        , <strong>    </strong> :) <br><br>  ,    <u><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHP Russia</a></u> ,  ,       .  , ,   ,      1,8 /,     ,      1 . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/442616/">https://habr.com/ru/post/442616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442606/index.html">Objeto de dominio con Lombok: Battle Classic</a></li>
<li><a href="../442608/index.html">Las billeteras fr√≠as del intercambio de criptomonedas QuadrigaCX, cuyo fundador muri√≥, resultaron estar vac√≠as</a></li>
<li><a href="../442610/index.html">Telegram-bot + Google Analytics</a></li>
<li><a href="../442612/index.html">Motor de cart√≥n para un juego de mesa el√©ctrico. C√≥mo lo acercamos a la realidad</a></li>
<li><a href="../442614/index.html">CI / CD usando Jenkins en Kubernetes</a></li>
<li><a href="../442618/index.html">No apto para selfies: ensayo inmunosorbente digital ligado a enzimas utilizando un nuevo chip integrado en un tel√©fono inteligente</a></li>
<li><a href="../442620/index.html">Aprendizaje autom√°tico en monitoreo de TI</a></li>
<li><a href="../442622/index.html">C√≥mo hacer que las corutinas en Unity sean un poco m√°s convenientes</a></li>
<li><a href="../442624/index.html">El libro "Algoritmo perfecto. Los fundamentos</a></li>
<li><a href="../442626/index.html">Habraiting: construyendo una nube de palabras de habla rusa en el ejemplo de los encabezados de Habra</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>