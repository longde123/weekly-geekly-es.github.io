<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôãüèæ üè¨ ‚ôìÔ∏è Big Brother regarde ... lui-m√™me ou une carte avec l'historique des mouvements dans HomeAssistant üí≥ üçç ü•û</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entr√©e 
 Pour ma domotique, j'utilise HomeAssistant depuis longtemps. Une fois qu'un ami m'a demand√©, ils disent, pourquoi HomeAssistant a la possibil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Big Brother regarde ... lui-m√™me ou une carte avec l'historique des mouvements dans HomeAssistant</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448656/"><h3>  Entr√©e </h3><br>  Pour ma domotique, j'utilise HomeAssistant depuis longtemps.  Une fois qu'un ami m'a demand√©, ils disent, pourquoi HomeAssistant a la possibilit√© d'indiquer uniquement la position actuelle du tracker sur la carte, mais il n'est pas possible d'afficher l'itin√©raire complet?  Depuis lors, cette id√©e m'a captiv√©.  Et une fois que j'ai r√©alis√© que je voulais vraiment avoir cette fonction maintenant.  Tous ceux qui sont int√©ress√©s par ce qui en est arriv√©, bienvenue au chat‚Ä¶ <br><a name="habracut"></a><br><h3>  Intelligence </h3><br>  En fait, pour afficher l'itin√©raire, vous devez avoir un ensemble de points avec des coordonn√©es.La premi√®re √©tape consistait donc √† savoir o√π le HomeAssistant stocke les donn√©es n√©cessaires (le cas √©ch√©ant) et comment les extraire de l√†.  Une br√®ve √©tude de la source primaire a imm√©diatement conduit √† la solution: vous avez besoin du module enregistreur inclus pour enregistrer l'√©tat des capteurs souhait√©s dans la base de donn√©es √† diff√©rents moments, ainsi que du module historique, qui vous permet d'obtenir de mani√®re magnifique des donn√©es de la base de donn√©es.  Le module d'historique poss√®de une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API REST</a> bien document√©e.  Ce dont vous avez besoin! <br><br>  Ensuite, vous devez en quelque sorte afficher les donn√©es re√ßues sur la carte.  Il existe de nombreux services diff√©rents qui vous permettent d'afficher l'historique des mouvements.  J'ai probablement essay√© loin de tous, mais je me permettrai de dire quelques mots sur ceux que j'ai v√©rifi√©s: <br>  <b>A.</b>  yandex et google.  En fait pour mes besoins il y a de tout et m√™me plus, mais √† cause des services payants et des fortes restrictions des versions gratuites, ils ne me convenaient pas tout de suite.  Yandex, par exemple, permet une utilisation gratuite uniquement pour les projets ouverts (c'est-√†-dire que n'importe qui devrait pouvoir ouvrir votre ressource √† tout moment et profiter de ses capacit√©s), sans parler d'autres restrictions sur le nombre de demandes.  Seuls les paresseux n'ont pas √©crit sur les modifications des politiques de Google concernant les API.  Pour le moment, si je comprends bien, chaque demande de carte API ou de directions API est pay√©e, plus il y a de demandes - moins cher.  Cependant, chaque utilisateur disposant d'une carte bancaire connect√©e √† son compte b√©n√©ficie d'une limite gratuite de 200 $ par mois.  Tout sur le dessus est imm√©diatement pay√© √† partir de votre carte.  Lier une carte √† un compte n'est pas notre fa√ßon. <br><br>  Correct si j'ai fait une erreur quelque part sur google et / ou yandex. <br><br>  <b>B.</b>  Un tas de cartes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OpenRouteService</a> et OpenRouteService.  En principe, les fonctionnalit√©s ne sont pas tr√®s diff√©rentes de google ou yandex (en tout cas, je ne l'ai pas remarqu√©).  Enti√®rement gratuit (il y a des restrictions sur le nombre de demandes par jour et par minute, s'il est d√©pass√©, il est conseill√© de contacter le support ... il n'y a aucune description des tarifs pay√©s du tout).  Cependant, l'utilisation de la ressource de cartes OpenRouteService s'est av√©r√©e g√™nante (chargement long de l'application et menu large ennuyeux √† gauche, qui s'ouvre par d√©faut et n'est pas d√©sactiv√© par l'API, de plus, le service ne s'ouvre pas correctement √† partir d'appareils mobiles).  En toute honn√™tet√©, les cartes OpenRouteService peuvent √™tre plac√©es sur votre serveur et il est fort possible que vous puissiez tout configurer par vous-m√™me. <br><br>  <b>B.</b>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mapbbcode</a>  Je suis tomb√© sur une impl√©mentation int√©ressante de cartes dans un format simple.  En principe, le projet convient parfaitement √† ma t√¢che, cependant, √† partir de cet article, j'ai appris sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Leaflet</a> et j'ai d√©cid√© de me tourner vers la source.  Finalement, il s'y est arr√™t√© ... <br><br>  <b>G.</b>  D√©pliant.  Tr√®s bonne biblioth√®que js open-source pour les cartes, facile √† apprendre et bien document√©e.  Depuis les puces: permet d'utiliser des tuiles de nombreux services (openstreetmaps, yandex, google, mapbox, microsoft, etc., etc.).  De plus, j'ai utilis√© le plugin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">leaflet.polylineDecorator</a> pour indiquer la direction du mouvement sur la carte. <br><br>  Il convient de mentionner que les deux derni√®res ressources consid√©r√©es ne prennent pas en charge les ¬´itin√©raires¬ª, c'est-√†-dire qu'elles ne savent pas comment connecter des points le long des routes et / ou des trottoirs existants, mais relient simplement les points avec une ligne droite.  Pour moi personnellement, ce n'est pas un probl√®me, mais une √©tape consciente.  Si vous avez besoin de navigation sur les routes, vous devez regarder dans le sens de google, yandex ou openrouteservice gratuit. <br><br><h3>  Impl√©mentation </h3><br>  La demande au module d'historique via l'API REST est assez simple (ci-apr√®s le code sera dans le langage HomeAssistant, c'est-√†-dire python) et vous permet d'obtenir la r√©ponse sous la forme d'un JSON facile √† comprendre: <br><br><pre><code class="python hljs">response = requests.get(self._haddr + <span class="hljs-string"><span class="hljs-string">'/api/history/period/'</span></span> + dayBegin + <span class="hljs-string"><span class="hljs-string">'?filter_entity_id='</span></span> + self._myid, headers={<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: <span class="hljs-string"><span class="hljs-string">'Bearer '</span></span> + self._token, <span class="hljs-string"><span class="hljs-string">'content-type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>}) data = response.json()[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br>  ici self._haddr est l'adresse de votre HA identique √† celle sp√©cifi√©e dans les param√®tres frontend, self._myid est l'identifiant de p√©riph√©rique de device_tracker, dont nous allons construire l'itin√©raire, dayBegin est le d√©but de la p√©riode d'affichage de l'itin√©raire, j'ai s√©lectionn√© le d√©but de la journ√©e en cours par d√©faut, self._token est un jeton longue dur√©e pour acc√©der √† l'API, qui peut √™tre obtenu dans l'interface HomeAssistant. <br><br>  Lorsque l'objet dont nous essayons d'afficher l'historique sur la carte est stationnaire pendant une longue p√©riode ou se d√©place extr√™mement lentement, nous obtenons un tas de points qui sont proches et obstruent la carte.  Pour corriger la situation, laissez le tableau de coordonn√©es r√©sultant passer √† travers le filtre: si la distance entre le point pr√©c√©dent et le suivant est inf√©rieure √† 100 m√®tres, n'affichez pas le point sur la carte.  Pour calculer les distances entre deux points voisins, nous utilisons une formule simplifi√©e avec une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">approximation √©quiangulaire</a> .  L'approximation est applicable lorsque la distance entre des points voisins ne d√©passe pas plusieurs kilom√®tres: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, latA, lonA, latB, lonB)</span></span></span><span class="hljs-function">:</span></span> dst = <span class="hljs-number"><span class="hljs-number">0</span></span> latRadA = math.radians(latA) lonRadA = math.radians(lonA) latRadB = math.radians(latB) lonRadB = math.radians(lonB) x = latRadB - latRadA y = (lonRadB-lonRadA)*math.cos((latRadB+latRadA)*<span class="hljs-number"><span class="hljs-number">0.5</span></span>) dst = <span class="hljs-number"><span class="hljs-number">6371</span></span>*math.sqrt(x*x+y*y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dst</code> </pre> <br>  Ici dst est la distance en km. <br><br>  D√©crire l'API Leaflet ici ne comprend pas l'int√©r√™t.  Pour cela - sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site officiel</a> .  Le module fonctionne comme suit: Toutes les n secondes (je l'ai fix√© √† 300), une requ√™te est faite pour l'historique d'aujourd'hui de l'objet qui m'int√©resse.  Le tableau de coordonn√©es r√©sultant est ex√©cut√© √† travers le filtre de distance, ce qui r√©duit le nombre de points.  De plus, dans le dossier avec la configuration HomeAssistant dans le dossier www, 2 fichiers sont form√©s: index.html et route.html.  Le fichier route.html contient toute la logique de cr√©ation d'une carte.  Et le fichier index.html est un hack de vie pour emp√™cher la mise en cache des pages.  Par d√©faut, HomeAssistant met en cache tout ce qui est possible, et la r√©initialisation du cache uniquement a aid√© √† mettre √† jour les donn√©es sur la carte, ce qui, bien s√ªr, est inacceptable.  Dans le fichier index.html, le contenu de route.html est appel√©, mais avec un param√®tre al√©atoire g√©n√©r√© dynamiquement, qui vous permet de toujours demander la derni√®re version du fichier route.html au serveur: <br><br><pre> <code class="xml hljs">src = 'route.html?datetime=' + (new Date()).getTime() + Math.floor(Math.random() * 1000000)</code> </pre> <br><h3>  Un peu de s√©curit√© </h3><br>  HomeAssistant est con√ßu pour que tous les fichiers √† l'int√©rieur du r√©pertoire www soient publics, c'est-√†-dire que tout fichier √† l'int√©rieur du r√©pertoire www puisse √™tre ouvert dans n'importe quel navigateur sans aucune autorisation, connaissant le lien direct.  Dans le cas de mon module, ce lien est le suivant: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">your_address_homeassistant / local / route / index.html</a> .  Si cela n'est pas critique pour vous, vous pouvez ignorer cette section.  Je suis all√© un peu plus loin et j'ai viss√© l'autorisation √† la page des itin√©raires.  Pour cela, j'ai utilis√© nginx (vous pouvez choisir un autre serveur Web avec prise en charge du proxy inverse) comme serveur proxy.  Le site Web HomeAssistant contient des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions</a> officielles pour la configuration de cette configuration.  Apr√®s avoir configur√© le proxy et v√©rifi√© l'op√©ration, vous devez ajouter une autorisation aux pages n√©cessaires dans la configuration nginx: <br><br><pre> <code class="plaintext hljs">location /local/route/route.html { proxy_pass http://localhost:8123/local/route/route.html; proxy_set_header Host $host; proxy_redirect http:// https://; proxy_http_version 1.1; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; auth_basic "Unauthorized"; auth_basic_user_file /etc/nginx/.htpasswd; }</code> </pre> <br>  Cr√©ez ensuite le fichier "/etc/nginx/.htpasswd" et ex√©cutez les commandes suivantes dans la console: <br><br><pre> <code class="bash hljs">sh -c <span class="hljs-string"><span class="hljs-string">"echo -n 'admin:' &gt;&gt; /etc/nginx/.htpasswd"</span></span> sh -c <span class="hljs-string"><span class="hljs-string">"openssl passwd -apr1 &gt;&gt; /etc/nginx/.htpasswd"</span></span></code> </pre> <br>  admin - remplacez par la connexion d√©sir√©e. <br><br>  Apr√®s cela, red√©marrez nginx et v√©rifiez: lorsque vous essayez d'ouvrir une page avec un itin√©raire, le navigateur doit demander un nom d'utilisateur et un mot de passe.  Je note qu'il s'agit d'une autorisation distincte qui n'a rien √† voir avec l'autorisation de HomeAssistant elle-m√™me. <br><br><h3>  Conclusion </h3><br>  Peut-√™tre tout ce que l'on peut dire sur ce module. <br>  Qui est int√©ress√©, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voici un lien</a> vers le module.  Placez le fichier le long du chemin: config_folder_homeassistant / custom_components / route / sensor.py, n'oubliez pas les droits. <br><br>  S'il n'existe pas, cr√©ez le dossier config_folder_homeassistant / www et donnez-lui les droits appropri√©s. <br><br>  Dans le fichier de configuration configuration.yaml, √©crivez les lignes suivantes: <br><br><pre> <code class="plaintext hljs">sensor: - platform: route name: route entityid: your_device_tracker_entity_id haddr: your_address_homeassistant token: your_long_life_token</code> </pre> <br>  ici your_device_tracker_entity_id est l'ID de votre appareil device_tracker, your_address_homeassistant est l'adresse externe de votre HomeAssistant, your_long_life_token est le jeton d'acc√®s pr√©c√©demment re√ßu dans le frontend HomeAssistant pour utiliser l'API REST. <br><br>  Apr√®s cela, red√©marrez HomeAssistant et profitez.  La carte sera disponible via un lien direct: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">your_address_homeassistant / local / route / index.html</a> .  Si vous le souhaitez, vous pouvez l'ajouter au menu HA √† l'aide de panel_iframe ou √† n'importe quelle fen√™tre HA via la carte de lacet ¬´iframe¬ª. <br>  C'est tout, merci de votre attention. <br><br>  <b>UPD:</b> <br>  Ajout d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> vers GitHub.  Modification de certains endroits (supprim√© de la configuration haddr, obtention automatique de config_dir, ajout de la possibilit√© de d√©finir mon fuseau horaire) <br><br><div class="spoiler">  <b class="spoiler_title">Et √† quoi tout cela ressemble-t-il?</b>  <b class="spoiler_title">Attention, Bluer!</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tw/_v/2_/tw_v2_gufir0tcuzo02dt1e-zig.jpeg" alt="image"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr448656/">https://habr.com/ru/post/fr448656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr448642/index.html">Mod√®le de distribution obligatoire des droits dans FreeBSD</a></li>
<li><a href="../fr448644/index.html">Expressions r√©guli√®res applicatives en tant que foncteur alternatif gratuit</a></li>
<li><a href="../fr448648/index.html">Comment asseoir tout le monde dans la science et ne pas transformer le bureau en foyer de haine</a></li>
<li><a href="../fr448652/index.html">Mozilla WebThings sur Raspberry Pi - pour commencer</a></li>
<li><a href="../fr448654/index.html">Mozilla WebThings - Configuration de la passerelle</a></li>
<li><a href="../fr448658/index.html">Que peut-on faire via le connecteur OBD dans la voiture</a></li>
<li><a href="../fr448662/index.html">"Russia 404": une option non visible</a></li>
<li><a href="../fr448664/index.html">Cr√©er des cartes comme Tinder sur Swift</a></li>
<li><a href="../fr448668/index.html">Agile: le plus gros probl√®me id√©ologique en informatique</a></li>
<li><a href="../fr448670/index.html">Conception d'interface embarqu√©e</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>