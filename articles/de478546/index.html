<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßû üè≥Ô∏è ü§≤üèΩ Websockets Erfahrung in Entwicklung und Betrieb. Wir modifizieren den Kunden üê≠ üèÖ üßû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich begr√º√üe alle, die sich f√ºr dieses Protokoll interessieren, und entschuldige mich im Voraus f√ºr meine √ºberm√§√üig emotionale Bemerkung. Befasst sich ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Websockets Erfahrung in Entwicklung und Betrieb. Wir modifizieren den Kunden</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478546/">  Ich begr√º√üe alle, die sich f√ºr dieses Protokoll interessieren, und entschuldige mich im Voraus f√ºr meine √ºberm√§√üig emotionale Bemerkung.  Befasst sich mit diesem Thema in Eile (wenn n√∂tig), aber f√ºr eine lange Zeit.  In dieser Hinsicht hat sich eine gewisse Praxis zum Entwerfen und Verwenden dieser Technologie angesammelt und gebildet.  Die Service-Implementierungsoption wird <a href="https://habr.com/ru/post/344292/">hier</a> beschrieben.  Seitdem ist viel Wasser geflossen.  Die Grundprinzipien sind dieselben geblieben, aber der Code der Anwendung selbst wurde auf nat√ºrliche Weise ge√§ndert.  An einigen Stellen wurden unkritische Fehler gefunden und behoben, irgendwo wurde die Steuerung von Programmabl√§ufen, Listen offener Verbindungen usw. optimiert. <br><br>  Wie Sie wissen, gibt es neben der Serverseite auch eine Clientseite.  Und hier m√∂chte ich genauer aufh√∂ren und beschreiben, was ich zu bew√§ltigen hatte und was beeinflusst werden konnte.  Wenn Sie JavaScript verwenden, k√∂nnen Sie nat√ºrlich nicht besonders "herumtollen", da alles bereit und geschlossen ist, aber Sie k√∂nnen etwas √ºber den Client in Java erz√§hlen. <br><br>  Egal wie gut Sie als Programmierer sind, es ist immer schwierig, etwas Einzigartiges zu entwickeln und dann Ihre eigenen Verse zu debuggen.  Aus diesem Grund bin ich einmal der Versuchung erlegen, etwas bereits Fertiges zu finden, sodass Sie es sofort in meinen Projekten verwenden k√∂nnen.  Die Auswahlkriterien f√ºr das fertige Modul waren einfach.  Ich wollte einen vollst√§ndigen, funktionierenden Code in Java mit minimalem Overhead erhalten. <br><a name="habracut"></a><br>  Als Ausgew√§hlter habe ich mich f√ºr ein Modul entschieden, das Apache-Bibliotheken verwendet.  Insbesondere diese: <br><br><ul><li>  apache-mime4j-core-0.7.2.jar; </li><li>  httpclient-4.2.1.jar; </li><li>  httpcore-4.2.1.jar; </li><li>  httpmime-4.2.1.jar. </li></ul><br>  Was kann √ºber ihre Verwendung gesagt werden?  Die Apache-Software war schon immer f√ºr ihre Zuverl√§ssigkeit, Raffinesse und Optimalit√§t bekannt.  Der Client f√ºr Android hat erfolgreich funktioniert.  Die fertige * .apk-Datei war nicht kritisch gro√ü.  Es gab keine besonderen Beschwerden √ºber die Arbeit dieser Bibliotheken.  Aber das Leben ist immer schlauer als wir.  Und die Zeit (und dieser Zeitraum betr√§gt ungef√§hr vier bis f√ºnf Jahre) nimmt seine eigenen Anpassungen vor.  Die Anwendung wurde geschrieben, als es eine Version von Android 4.2 - 4.4 gab.  Und der Bedarf an neuen L√∂sungen entstand bereits in diesem Jahr, als Ger√§te mit der Version 10 bereits in vollem Gange waren. <br><br>  Die Entwicklung wurde zu der Zeit auf Eclipse f√ºr Windows 7 durchgef√ºhrt. Das Aktualisieren des Android SDK auf die gew√ºnschte Stufe f√ºhrte dazu, dass die kleine 128-GB-SSD-Festplatte voll war.  Ich musste zu Android Studio wechseln.  Au√üerdem musste ich das Basisbetriebssystem √§ndern.  Ich habe versucht, Ubuntu zu installieren (ich kann mich nicht an die Versionsnummer erinnern) und benutze Studio bereits in dieser Umgebung.  Aber auch hier, Misserfolg, wollte Andriod Studio hartn√§ckig nicht installieren. <br><br>  Warum - schon vergessen.  Am Ende installierte er auf Anraten von Freunden die neueste Version von Linux-Mint, und siehe da, das Toolkit legte es ohne Beschwerden auf.  Dann geschah genau das, worauf alle diese Details zur√ºckzuf√ºhren waren, n√§mlich die Routine, Tests zu schreiben. <br><br>  Also, was wurde in diesem Tyagomotin erwartet?  Beginnen wir mit der Tatsache, dass Apache von der offiziellen Website aktuellere Versionen der oben genannten Bibliotheken kopiert hat.  F√ºgte sie dem Projekt hinzu und ... Und Kompilierungsfehler fielen ein.  Die Zeit ist vergangen, Klassenschnittstellen haben sich ge√§ndert.  Also musste ich (aus Zeitgr√ºnden, um neue Bibliotheken zu studieren) zu den alten Versionen zur√ºckkehren.  Aber ... <br><br>  Andererseits suchen wir nicht nach einfachen Wegen.  Ich dachte, warum brauche ich diese Bibliotheken komplett?  Die Texte dieser Pakete sind.  Was ist, wenn Sie nur die erforderlichen Klassen nehmen und daraus ziehen?  Wenn Sie die Texte des Moduls f√ºr die Arbeit mit Web-Sockets betrachten, sehen Sie au√üerdem nur zwei Klassen aus diesen Bibliotheken. <br><br>  Also habe ich ein neues Projekt erstellt und angefangen, die notwendigen Klassen hinzuzuf√ºgen.  Am Ende stellte sich heraus, dass f√ºr eine erfolgreiche Kompilierung 32 Klassen herausgezogen werden m√ºssen.  Und doch hat das Projekt funktioniert.  Alles atmete.  Die Verbindung zum Web-Socket-Dienst war erfolgreich.  Und alles w√§re in Ordnung, bemerkte aber das folgende f√ºr mich unverst√§ndliche Ereignis.  Beim Schlie√üen der Verbindung hat das f√ºr die Verbindung verantwortliche Modul eine Ausnahme ausgel√∂st: <br><br>  java.io.EOFException <br>  um java.io.DataInputStream.readByte (DataInputStream.java:77) <br>  at com.example.wsci.HybiParser.start (HybiParser.java:112) <br>  at com.example.wsci.WebSocketClient $ 1.run (WebSocketClient.java:144) <br>  bei java.lang.Thread.run (Thread.java:818) <br><br>  Ich war ratlos.  Folgendes verwirrt.  Die Verbindung zum Server war erfolgreich.  Pakete kamen und gingen erfolgreich.  Aber warum genau hat die Schlie√üung eine Ausnahme ausgel√∂st?  Au√üerdem war auf dem Server alles Standard.  Offensichtlich hatten die Kunden irgendwo im Text eine Kleinigkeit, die sich auf die Schlie√üung auswirkte.  Dar√ºber hinaus zeigten die Texte ein solches Merkmal.  Gem√§√ü <a href="https://tools.ietf.org/html/rfc6455">Abschnitt 7.1.1 des Dokuments besteht das</a> Schlie√üen auf der Client-Seite nicht nur aus dem Aufrufen der close () -Methode, sondern auch aus dem Bilden und Senden eines Pakets mit Operationscode 8 (Abschlussoperation).  In diesem Fall w√ºrde der Server sein Abschlusspaket senden, wonach der Client die Verbindung schlie√üen w√ºrde.  In unserem Fall wurde eine solche Abfolge von Anrufen jedoch nicht beobachtet.  Es hat nur die Schlie√üfunktion aufgerufen und das wars.  Im Allgemeinen gab es etwas zu √ºberlegen.  Und je mehr ich die Texte dieses Moduls mit dem Paket-Parser durchgesehen und studiert habe, desto weniger hat es mir gefallen, desto mehr bestand der Wunsch, sie mit meiner Vision des Protokolls neu zu schreiben.  Am Ende wurde beschlossen, diese ‚ÄûArbeitskraft‚Äú auszuf√ºhren. <br><br>  Was passte eigentlich nicht, was l√∂ste in diesen Modulen ‚ÄûB√ºrgerprotest‚Äú aus?  Erstens die Organisation der Interaktion zwischen dem Modul der direkten Verbindung mit dem Server und dem Paket-Parser.  Es stellte sich heraus, dass das Verbindungsmodul mit dem Server interagierte und einen Parser generierte, an den es einen Link als Parameter an sich selbst √ºbergab.  Infolgedessen wurde dem Parser die Befugnis √ºbertragen, Entscheidungen √ºber bevorstehende Netzwerkereignisse zu treffen.  In diesem Zusammenhang stellte sich die Frage, aber ist es gut?  W√§re es nicht besser, wenn das Parser-Modul seine entsprechende Mission erf√ºllen und das Ergebnis seiner Arbeit zur√ºckgeben w√ºrde, aber die Steuerungsentscheidung √ºber Ereignisse von dem Objekt ausgef√ºhrt w√ºrde, das den Parser generiert hat?  In diesem Fall w√ºrde eine strenge Hierarchie der Interaktion zwischen Objekten festgelegt.  (Hier k√∂nnen Sie nat√ºrlich diskutieren, was besser ist - eine Hierarchie oder ein Netzwerk, aber dann entfernen wir uns vom Thema.) <br><br>  Das zweite, was mich dazu brachte, alles neu zu schreiben, war die Struktur des Parsers.  Dieses Objekt (Klasse) sollte zwei Hauptfunktionen erf√ºllen, n√§mlich das Bilden eines Datenpakets zur √úbertragung an den Server und das Parsen von vom Server empfangenen Paketen.  Es waren also diese beiden Funktionen, die im Gro√üen und Ganzen nicht passten.  Und damit. <br><br>  Stellen Sie sich vor, ein Netzwerkereignis ist aufgetreten, ein Paket ist angekommen.  Was hat HybiParser in diesem Fall getan?  Dieses Objekt liest die ersten beiden Bytes byteweise aus dem Eingabestream des Sockets und bestimmt die n√§chsten Aktionen: Analysieren der Datengr√∂√üe, Maske usw.  Infolgedessen wurde dies in mehreren Leseoperationen aus dem Eingabestream des Sockets implementiert.  Dar√ºber hinaus wurde das Parsen durch Lesestufen erschwert, was den Algorithmus weiter erschwerte.  Und wieder stellte sich die Frage, ist es richtig, warum solche Schwierigkeiten?  Ist es nicht besser, ein Paket als eine Operation zu betrachten, zumal die Gr√∂√üe der eingehenden Daten bestimmt werden kann? <br><br>  Der dritte.  Ein kontroverser Aspekt der Arbeit des Parsers scheint der ‚Äûewige‚Äú Paketannahmezyklus zu sein.  Der Zyklus l√§uft in einem separaten Programmstrom ab.  Irgendwann schlie√üt die Steckdose.  Was kommt als n√§chstes, die √ºbliche Ausnahmebehandlung?  Oder was machen?  Nein, ich bin nicht gegen den Mechanismus der Ausnahmen, aber es w√§re einfach sch√∂n, diesen Umstand und die Reaktion darauf im Voraus vorherzusehen.  Beispielsweise konnte ein Synchronisationsmechanismus als L√∂sung vorgeschlagen werden, bei dem die regelm√§√üige Beendigung des Zyklus und dementsprechend der Programmstrom stattfinden wird. <br><br>  Als Ergebnis der Bewertung all dieser Nuancen wurden die folgenden Anforderungen f√ºr den Entwurf der erforderlichen Module ermittelt: <br><br><ul><li>  Module m√ºssen unabh√§ngig von Bibliotheken von Drittanbietern sein. </li><li>  Module sollten einfach und leicht in andere Projekte zu integrieren sein. </li><li>  Module sollten f√ºr zuk√ºnftige Funktionserweiterungen bereit sein. </li></ul><br>  Nun, um nicht f√ºr √ºberm√§√üige Kritik an der vorherigen vorgefertigten L√∂sung verantwortlich zu sein, f√ºgen wir hinzu, dass ein Teil der vorgefertigten und nicht kritisierenden Funktionen sicher auf die neue Implementierung √ºbertragen werden konnte.  Nun, das ist alles und wie sie auf dem XXII. Kongress der KPdSU sagten: ‚ÄûUnsere Ziele sind klar, die Aufgaben sind definiert.  Zu arbeiten, Kameraden!  F√ºr die neuen Siege des Kommunismus! ‚Äú <br><br>  Im Allgemeinen beschreibe ich kurz meinen Vorschlag und konzentriere mich nur auf die wichtigsten Punkte, um Sie nicht zu √ºberladen, lieber Leser, um Ihre wertvolle Zeit nicht zu verlieren. <br>  Die vorgeschlagene Implementierung enth√§lt also nur vier Module (gem√§√ü den obigen Anforderungen der Apache-Bibliothek oder einzelne Klassen davon wurden nicht in das Projekt aufgenommen): <br><br><ul><li>  Modul f√ºr globale Konstanten des WebSocket-Protokolls 07; </li><li>  Hilfsausnahmeklasse; </li><li>  Web-Socket-Client; </li><li>  Modul zum Parsen von Paketen der WebSocket-Protokollstufe 07. </li></ul><br>  In den ersten beiden Modulen ist die Implementierung trivial, es gibt nichts zu beachten.  Das Client-Modul implementiert die Kontrolle √ºber die Verbindung zum Server, und ich m√∂chte auf die folgenden Punkte eingehen.  Die Funktion zum √ñffnen der Verbindung enth√§lt eine Reihe von Headern, die vom Server stammen.  Hier wird das Parsing des Sec-WebSocket-Accept-Schl√ºssels tats√§chlich implementiert, und in unserem Fall wird das Parsing ohne Verwendung der Apache-Bibliotheken durchgef√ºhrt. <br><br>  Achten Sie als n√§chstes auf die Funktionen der Paketschleifensteuerung.  Die Implementierung ist durch ein Synchronisationsobjekt trivial. <br><br>  Der n√§chste zu beachtende Punkt ist die Funktion der Schleife.  Der Zyklus ist nicht "ewig", sondern mit dem Exit unter der Bedingung der √úberpr√ºfung des Synchronisationsobjekts.  In einem Zyklus wird ein ankommendes Paket in einer Operation gelesen.  Das Paket wird vom entsprechenden Objekt zum Parsen analysiert.  Als n√§chstes wird eine Managemententscheidung f√ºr das bevorstehende Netzwerkereignis getroffen. <br><br>  Um die Beschreibung zu vervollst√§ndigen, wird auf die Funktion zum sicheren Trennen der Verbindung hingewiesen.  Dies geschieht wie folgt.  Ein Verbindungsbeendigungspaket wird an den Server gesendet und eine Variable der Runnable-Klasse wird generiert, die dann zur Ausf√ºhrung durch die postDelayed-Funktion im Warteschlangenprozessor abgelegt wird. Einer der Parameter ist die Betriebsverz√∂gerung in Millisekunden.  In der Variablen Runnable enth√§lt die Ausf√ºhrungsfunktion eine Folge von Aufrufen, wenn der Programmstrom beendet und die Verbindung zum Server getrennt wird.  F√ºr den Fall, dass das schlie√üende Antwortpaket fr√ºher eintrifft, wird diese Position in der Verarbeitungsliste gel√∂scht. <br><br>  Die Klasse, die die Analyse von WebSocket-Paketen implementiert, enth√§lt zwei Methoden, die beachtet werden m√ºssen: das Parsen selbst und die Bildung eines Pakets f√ºr die √úbertragung gem√§√ü den relevanten Parametern.  Beim Parsen werden alle Flags und Daten des empfangenen Pakets in √∂ffentlichen Klassenvariablen gespeichert.  Warum √∂ffentlich?  Ja, der Einfachheit halber, um keine zus√§tzlichen get / set-Funktionen f√ºr sie zu erstellen. <br><br>  Nun, eigentlich, lieber Leser.  Das Archiv mit dem Projekt f√ºr Android Studio ist <a href="https://yadi.sk/d/TAODjdYRpyWl5Q">beigef√ºgt</a> .  Ich werde keinen Anspruch auf die Verwendung dieser Texte in Ihren Projekten erheben.  Konstruktive Kritik wird akzeptiert.  Beantworten Sie Fragen so weit wie m√∂glich. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de478546/">https://habr.com/ru/post/de478546/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de478536/index.html">WebRTC √ºber Kurento: Test- und Implementierungserfahrung</a></li>
<li><a href="../de478538/index.html">So √ºberpr√ºfen Sie Ihren Reisepass auf G√ºltigkeit</a></li>
<li><a href="../de478540/index.html">Vorbereitungen f√ºr das zehnte Forum ‚ÄûPositive Hack Days 10: Getting Started‚Äú</a></li>
<li><a href="../de478542/index.html">FigmaGen: Style Automation in der iOS App</a></li>
<li><a href="../de478544/index.html">Vue Storefront: Verzeichnis aus Magento 2 importieren</a></li>
<li><a href="../de478550/index.html">Wie verwalte ich eine Uhr? Analyse der Front-End-Strecke der zweiten Programmiermeisterschaft</a></li>
<li><a href="../de478552/index.html">Zweites Applet, Schlie√üen und transparente Schaltfl√§chen in Verarbeitung 3</a></li>
<li><a href="../de478554/index.html">Webinar "SRE - Hype oder die Zukunft?" 12. Dezember um 11:00 Uhr</a></li>
<li><a href="../de478560/index.html">Sind kostenlose Instant Messenger anonym?</a></li>
<li><a href="../de478564/index.html">Wie wir bei TsIAN Terabytes an Protokollen gez√§hmt haben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>