<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’…ğŸ¾ ğŸ¤°ğŸ» ğŸ‘©ğŸ»â€ğŸ¤â€ğŸ‘¨ğŸ½ Angularä¸­çš„WebSocketsã€‚ ç¬¬2éƒ¨åˆ†ã€‚äº§å“è§£å†³æ–¹æ¡ˆ â™‰ï¸ ğŸ† ğŸ’</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†Angularä¸­é’ˆå¯¹Webå¥—æ¥å­—çš„é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­æˆ‘ä»¬æ„å»ºäº†å…·æœ‰é‡æ–°è¿æ¥å’ŒæœåŠ¡çš„æ€»çº¿ï¼Œå¯ç”¨äºåŸºäºWebSocketSubjectçš„ç»„ä»¶ã€‚ è¿™ç§å®ç°é€‚ç”¨äºå¤§å¤šæ•°ç®€å•æƒ…å†µï¼Œä¾‹å¦‚ï¼Œæ¥æ”¶å’Œå‘é€èŠå¤©æ¶ˆæ¯ç­‰ï¼Œä½†æ˜¯åœ¨æ‚¨éœ€è¦æ„å»ºæ›´çµæ´»å’Œå¯æ§åˆ¶çš„å†…å®¹çš„æƒ…å†µä¸‹ï¼Œå…¶åŠŸèƒ½å¯èƒ½ä¸è¶³ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Angularä¸­çš„WebSocketsã€‚ ç¬¬2éƒ¨åˆ†ã€‚äº§å“è§£å†³æ–¹æ¡ˆ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419099/"><img src="https://habrastorage.org/webt/hf/xh/dl/hfxhdlv7katnrbytwzqmhjy3xom.png" alt="å›¾ç‰‡"><br><br> åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œ</a>æˆ‘ä»¬è®¨è®ºäº†Angularä¸­é’ˆå¯¹Webå¥—æ¥å­—çš„é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­æˆ‘ä»¬æ„å»ºäº†å…·æœ‰é‡æ–°è¿æ¥å’ŒæœåŠ¡çš„æ€»çº¿ï¼Œå¯ç”¨äºåŸºäºWebSocketSubjectçš„ç»„ä»¶ã€‚ è¿™ç§å®ç°é€‚ç”¨äºå¤§å¤šæ•°ç®€å•æƒ…å†µï¼Œä¾‹å¦‚ï¼Œæ¥æ”¶å’Œå‘é€èŠå¤©æ¶ˆæ¯ç­‰ï¼Œä½†æ˜¯åœ¨æ‚¨éœ€è¦æ„å»ºæ›´çµæ´»å’Œå¯æ§åˆ¶çš„å†…å®¹çš„æƒ…å†µä¸‹ï¼Œå…¶åŠŸèƒ½å¯èƒ½ä¸è¶³ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä»‹ç»ä½¿ç”¨Webå¥—æ¥å­—æ—¶çš„ä¸€äº›åŠŸèƒ½ï¼Œå¹¶è®¨è®ºæ‚¨è‡ªå·±å¯èƒ½é‡åˆ°çš„éœ€æ±‚ã€‚ <br><a name="habracut"></a><br> é€šå¸¸ï¼Œåœ¨äººæµè¾ƒå¤§çš„å¤§å‹é¡¹ç›®ä¸­ï¼Œå‰ç«¯è¦é¢å¯¹åœ¨å…¶ä»–æƒ…å†µä¸‹åœ¨åç«¯æ›´å¸¸è§çš„ä»»åŠ¡ã€‚ åœ¨æœåŠ¡å™¨èµ„æºç´§ç¼©çš„æƒ…å†µä¸‹ï¼Œéƒ¨åˆ†é—®é¢˜ä¼šè¿ç§»åˆ°å‰ç«¯åŒºåŸŸï¼Œå› æ­¤ï¼Œè¯¥é¡¹ç›®å…·æœ‰æœ€å¤§çš„å¯æ‰©å±•æ€§å’Œå¯æ§åˆ¶æ€§ã€‚ <br><br> è¿™æ˜¯æœ¬æ–‡å°†ä»‹ç»çš„Webå¥—æ¥å­—å®¢æˆ·ç«¯çš„åŸºæœ¬è¦æ±‚çš„åˆ—è¡¨ï¼š <br><br><ul><li> è‡ªåŠ¨â€œæ™ºèƒ½â€é‡æ–°è¿æ¥ï¼› </li><li> è°ƒè¯•æ¨¡å¼ï¼› </li><li> åŸºäºRxJçš„äº‹ä»¶è®¢é˜…ç³»ç»Ÿï¼› </li><li> æ¥æ”¶å’Œè§£æäºŒè¿›åˆ¶æ•°æ®ï¼› </li><li> åœ¨æ¨¡å‹ä¸ŠæŠ•å½±ï¼ˆæ˜ å°„ï¼‰æ”¶åˆ°çš„ä¿¡æ¯ï¼› </li><li> éšç€æ–°äº‹ä»¶çš„åˆ°æ¥ï¼Œæ§åˆ¶æ¨¡å‹çš„å˜åŒ–ï¼› </li><li> å¿½ç•¥ä»»æ„äº‹ä»¶å¹¶å–æ¶ˆå¿½ç•¥ã€‚ </li></ul><br> è¯·æ›´è¯¦ç»†åœ°è€ƒè™‘æ¯ä¸ªé¡¹ç›®ã€‚ <br><br><h2> é‡æ–°è¿æ¥/å¸è¢‹ </h2><br> æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å†™è¿‡å…³äºé‡æ–°è¿æ¥çš„çŸ¥è¯†ï¼Œæ‰€ä»¥æˆ‘åªå¼•ç”¨éƒ¨åˆ†å†…å®¹ï¼š <br><br><blockquote> å½“ä½¿ç”¨Webå¥—æ¥å­—æ—¶ï¼Œé‡æ–°è¿æ¥æˆ–é‡æ–°è¿æ¥åˆ°æœåŠ¡å™¨çš„ç»„ç»‡æ˜¯è‡³å…³é‡è¦çš„å› ç´ ï¼Œå› ä¸º ç½‘ç»œä¸­æ–­ï¼ŒæœåŠ¡å™¨å´©æºƒæˆ–å…¶ä»–å¯¼è‡´è¿æ¥ä¸­æ–­çš„é”™è¯¯å¯èƒ½å¯¼è‡´åº”ç”¨ç¨‹åºå´©æºƒã€‚ <br> é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œé‡æ–°è¿æ¥å°è¯•ä¸åº”å¤ªé¢‘ç¹ä¸”ä¸åº”æ— é™æœŸåœ°ç»§ç»­ï¼Œä¾‹å¦‚ æ­¤è¡Œä¸ºå¯ä»¥æŒ‚èµ·å®¢æˆ·ç«¯ã€‚ </blockquote><br>  Webå¥—æ¥å­—æœ¬èº«ä¸çŸ¥é“æ–­å¼€è¿æ¥åå¦‚ä½•é‡æ–°è¿æ¥ã€‚ å› æ­¤ï¼Œå¦‚æœæœåŠ¡å™¨é‡æ–°å¯åŠ¨æˆ–æœåŠ¡å™¨å´©æºƒï¼Œæˆ–è€…ç”¨æˆ·é‡æ–°è¿æ¥äº†Internetï¼Œåˆ™è¦ç»§ç»­å·¥ä½œï¼Œè¿˜éœ€è¦é‡æ–°è¿æ¥Webå¥—æ¥å­—ã€‚ <br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œä¸ºäº†è¿›è¡Œé‡æ–°è¿æ¥å’Œè°ƒè¯•ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Reconnecting WebSocket</a> ï¼Œå…¶ä¸­åŒ…å«å¿…è¦çš„åŠŸèƒ½å’Œå…¶ä»–é€‰é¡¹ï¼Œä¾‹å¦‚åœ¨é‡æ–°è¿æ¥ä¹‹é—´æ›´æ”¹Webå¥—æ¥å­—çš„URLï¼Œé€‰æ‹©ä»»æ„WebSocketæ„é€ å‡½æ•°ç­‰ã€‚ å…¶ä»–æ›¿ä»£æ–¹å¼ä¹Ÿæ˜¯åˆé€‚çš„ã€‚ é‡æ–°è¿æ¥ä¸Šä¸€ç¯‡æ–‡ç« ä¸é€‚åˆï¼Œå› ä¸º å®ƒæ˜¯åœ¨WebSocketSubjectä¸‹ç¼–å†™çš„ï¼Œè¿™ä¸€æ¬¡ä¸é€‚ç”¨ã€‚ <br><br><h2>  RxJsäº‹ä»¶è®¢é˜…ç³»ç»Ÿ </h2><br> è¦åœ¨ç»„ä»¶ä¸­ä½¿ç”¨Webå¥—æ¥å­—ï¼Œæ‚¨éœ€è¦è®¢é˜…äº‹ä»¶ï¼Œå¹¶åœ¨å¿…è¦æ—¶å–æ¶ˆè®¢é˜…å®ƒä»¬ã€‚ ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨æµè¡Œçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Pub / Sub</a>è®¾è®¡æ¨¡å¼ã€‚ <br><blockquote>  â€œå‘å¸ƒè€…ï¼è®¢é˜…è€…ï¼ˆengã€‚Publisher-subscriberæˆ–engã€‚Pub / subï¼‰-ç”¨äºä¼ è¾“æ¶ˆæ¯çš„è¡Œä¸ºè®¾è®¡æ¨¡æ¿ï¼Œå…¶ä¸­æ¶ˆæ¯çš„å‘ä»¶äººï¼ˆç§°ä¸ºå‘å¸ƒè€…ï¼ˆengã€‚Publishersï¼‰ï¼‰æ²¡æœ‰ç›´æ¥ç»‘å®šåˆ°ç¨‹åºä»£ç ä¸Šï¼Œè€Œæ˜¯å°†æ¶ˆæ¯å‘é€ç»™è®¢é˜…è€…ï¼ˆengã€‚Subscriberï¼‰ ï¼‰ è€Œæ˜¯å°†æ¶ˆæ¯åˆ†ä¸ºå‡ ç±»ï¼Œå¹¶ä¸”ä¸åŒ…å«æœ‰å…³å…¶è®¢æˆ·çš„ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ åŒæ ·ï¼Œè®¢æˆ·å¤„ç†ä¸€ç±»æˆ–å¤šç±»æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯æ˜¯ä»ç‰¹å®šå‘å¸ƒè€…é‚£é‡Œæå–çš„ã€‚â€ </blockquote><br> è®¢æˆ·ä¸æ˜¯ç›´æ¥ä¸å‘å¸ƒè€…è”ç³»ï¼Œè€Œæ˜¯é€šè¿‡ä¸­é—´æ€»çº¿-ç½‘ç«™æœåŠ¡ã€‚ è¿˜åº”è¯¥å¯ä»¥è®¢é˜…å…·æœ‰ç›¸åŒè¿”å›ç±»å‹çš„å¤šä¸ªäº‹ä»¶ã€‚ æ¯ä¸ªè®¢é˜…éƒ½åˆ›å»ºè‡ªå·±çš„ä¸»é¢˜ï¼Œè¯¥ä¸»é¢˜æ·»åŠ åˆ°ä¾¦å¬å™¨å¯¹è±¡ä¸­ï¼Œä½¿æ‚¨å¯ä»¥å°†Webå¥—æ¥å­—äº‹ä»¶å¯»å€åˆ°å¿…è¦çš„è®¢é˜…ã€‚ åœ¨ä½¿ç”¨RxJs Subjectæ—¶ï¼Œå–æ¶ˆè®¢é˜…ä¼šæœ‰ä¸€äº›å›°éš¾ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç®€å•çš„åƒåœ¾å›æ”¶å™¨ï¼Œå½“æ²¡æœ‰è§‚å¯Ÿè€…çš„ä¾¦å¬å™¨å¯¹è±¡æ—¶ï¼Œå®ƒå°†ä»ä¾¦å¬å™¨å¯¹è±¡ä¸­åˆ é™¤è¿™äº›ä¸»é¢˜ã€‚ <br><br><h2> æ¥æ”¶å’Œè§£æäºŒè¿›åˆ¶æ•°æ® </h2><br>  WebSocketæ”¯æŒäºŒè¿›åˆ¶æ•°æ®ï¼Œæ–‡ä»¶æˆ–æµçš„ä¼ è¾“ï¼Œè¿™é€šå¸¸åœ¨å¤§å‹é¡¹ç›®ä¸­ä½¿ç”¨ã€‚ çœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><blockquote>  0x80ï¼Œ&lt;é•¿åº¦-ä¸€ä¸ªæˆ–å¤šä¸ªå­—èŠ‚&gt;ï¼Œ&lt;æ¶ˆæ¯æ­£æ–‡&gt; </blockquote><br> ä¸ºäº†ä¸é™åˆ¶ä¼ è¾“æ¶ˆæ¯çš„é•¿åº¦ï¼ŒåŒæ—¶åˆä¸æµªè´¹å­—èŠ‚ï¼Œåè®®å¼€å‘äººå‘˜ä½¿ç”¨äº†ä»¥ä¸‹ç®—æ³•ã€‚ é•¿åº¦æŒ‡ç¤ºä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½è¢«å•ç‹¬è€ƒè™‘ï¼šæœ€é«˜å­—èŠ‚æŒ‡ç¤ºå®ƒæ˜¯æœ€åä¸€ä¸ªå­—èŠ‚ï¼ˆ0ï¼‰è¿˜æ˜¯åé¢çš„å…¶ä»–å­—èŠ‚ï¼ˆ1ï¼‰ï¼Œè€Œä½7ä½åŒ…å«å‘é€çš„æ•°æ®ã€‚ å› æ­¤ï¼Œå½“äºŒè¿›åˆ¶æ•°æ®å¸§0x80çš„ç¬¦å·å‡ºç°æ—¶ï¼Œåˆ™è·å–ä¸‹ä¸€ä¸ªå­—èŠ‚å¹¶å°†å…¶å­˜å‚¨åœ¨å•ç‹¬çš„â€œå­˜é’±ç½â€ä¸­ã€‚ ç„¶åï¼Œä¸‹ä¸€ä¸ªå­—èŠ‚ï¼ˆå¦‚æœè®¾ç½®äº†æœ€é«˜æœ‰æ•ˆä½ï¼‰ä¹Ÿå°†ä¼ é€åˆ°â€œå­˜é’±ç½â€ï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°é‡åˆ°æœ€é«˜æœ‰æ•ˆä½ä¸ºé›¶çš„å­—èŠ‚ã€‚ è¯¥å­—èŠ‚æ˜¯é•¿åº¦æŒ‡ç¤ºå™¨ä¸­çš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”ä¹Ÿæ·»åŠ åˆ°â€œå­˜é’±ç½â€ä¸­ã€‚ ç°åœ¨ï¼Œä»å­˜é’±ç½ä¸­çš„å­—èŠ‚ä¸­åˆ é™¤é«˜ä½ï¼Œç„¶ååˆå¹¶å…¶ä½™éƒ¨åˆ†ã€‚ è¿™å°†æ˜¯æ¶ˆæ¯æ­£æ–‡çš„é•¿åº¦-7ä½æ•°å­—ï¼Œæ²¡æœ‰æœ€é«˜æœ‰æ•ˆä½ã€‚ <br><br> å‰ç«¯è§£æå’ŒäºŒè¿›åˆ¶æµæœºåˆ¶å¾ˆå¤æ‚ï¼Œå¹¶ä¸”ä¸æ¨¡å‹ä¸Šçš„æ•°æ®æ˜ å°„ç›¸å…³è”ã€‚ å¯ä»¥å•ç‹¬æ’°å†™ä¸€ç¯‡æ–‡ç« ã€‚ è¿™æ¬¡ï¼Œæˆ‘ä»¬å°†åˆ†æä¸€ä¸ªç®€å•çš„é€‰é¡¹ï¼Œå¦‚æœå¯¹è¯¥ä¸»é¢˜æ„Ÿå…´è¶£çš„è¯ï¼Œå°†ä¸ºä¸‹é¢çš„å‡ºç‰ˆç‰©æä¾›å›°éš¾çš„æ¡ˆä¾‹ã€‚ <br><br><h2> åœ¨æ¨¡å‹ä¸ŠæŠ•å½±ï¼ˆæ˜ å°„ï¼‰æ”¶åˆ°çš„ä¿¡æ¯ </h2><br> ä¸ç®¡æ¥æ”¶åˆ°çš„ä¼ è¾“ç±»å‹å¦‚ä½•ï¼Œéƒ½éœ€è¦å®‰å…¨åœ°é˜…è¯»å’Œä¿®æ”¹ã€‚ å…³äºå¦‚ä½•æ›´å¥½åœ°åšåˆ°è¿™ä¸€ç‚¹å°šæ— å…±è¯†ï¼Œæˆ‘åšæŒ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨æ•°æ®æ¨¡å‹</a>çš„ç†è®ºï¼Œå› ä¸ºæˆ‘è®¤ä¸ºå®ƒå¯¹äºä»¥OOPé£æ ¼è¿›è¡Œç¼–ç¨‹æ˜¯åˆä¹é€»è¾‘ä¸”å¯é çš„ã€‚ <br><blockquote>  â€œæ•°æ®æ¨¡å‹æ˜¯å¯¹è±¡ï¼Œè¿ç®—ç¬¦å’Œå…¶ä»–å…ƒç´ çš„æŠ½è±¡ï¼Œè‡ªç»™è‡ªè¶³çš„é€»è¾‘å®šä¹‰ï¼Œå®ƒä»¬å…±åŒæ„æˆäº†ç”¨æˆ·ä¸ä¹‹äº¤äº’çš„æŠ½è±¡æ•°æ®è®¿é—®æœºå™¨ã€‚  â€œè¿™äº›å¯¹è±¡ä½¿æ‚¨å¯ä»¥å¯¹æ•°æ®ç»“æ„å’Œè¿ç®—ç¬¦è¿›è¡Œå»ºæ¨¡-æ•°æ®çš„è¡Œä¸ºã€‚â€ </blockquote><br> å„ç§ä¸æŠŠå¯¹è±¡å½’ç±»ä¸ºè¡Œä¸ºï¼Œç»“æ„ç­‰çš„å¯¹è±¡çš„æµè¡Œè½®èƒéƒ½ä¼šé€ æˆæ··ä¹±ï¼Œæ§åˆ¶å¾—ä¸å¥½ï¼Œæœ‰æ—¶ä¼šé•¿æ»¡ä¸€äº›ä¸å¸¸è§çš„ä¸œè¥¿ã€‚ ä¾‹å¦‚ï¼Œç‹—ç±»åº”è¯¥åœ¨ä»»ä½•æ¡ä»¶ä¸‹æè¿°ç‹—ã€‚ å¦‚æœå°†ç‹—è§†ä¸ºä¸€ç»„åŒºåŸŸï¼šå°¾å·´ï¼Œé¢œè‰²ï¼Œè„¸éƒ¨ç­‰ï¼Œåˆ™è¯¥ç‹—å¯èƒ½ä¼šé•¿å‡ºé¢å¤–çš„çˆªå­ï¼Œå¹¶ä¸”å°†å‡ºç°å¦ä¸€åªç‹—è€Œä¸æ˜¯å¤´éƒ¨ã€‚ <br><br><img src="https://habrastorage.org/webt/sq/fa/xu/sqfaxulbeyaffws-46gxho3-dcg.jpeg" alt="å›¾ç‰‡"><br><br><h2> éšç€æ–°äº‹ä»¶çš„åˆ°æ¥ï¼Œæ§åˆ¶æ¨¡å‹çš„å˜åŒ– </h2><br> åœ¨æœ¬æ®µä¸­ï¼Œæˆ‘å°†æè¿°åœ¨ä½“è‚²åšå½©ç§»åŠ¨åº”ç”¨ç¨‹åºçš„Webç•Œé¢ä¸Šå·¥ä½œæ—¶é‡åˆ°çš„é—®é¢˜ã€‚ åº”ç”¨ç¨‹åºAPIé€šè¿‡æ¥æ”¶çš„Webå¥—æ¥å­—å·¥ä½œï¼šæ›´æ–°èµ”ç‡ï¼Œæ·»åŠ å’Œåˆ é™¤æ–°ç±»å‹çš„æŠ•æ³¨ï¼Œæœ‰å…³æ¯”èµ›å¼€å§‹æˆ–ç»“æŸçš„é€šçŸ¥ç­‰ã€‚  -æ€»å…±çº¦æœ‰300ä¸ªWebå¥—æ¥å­—äº‹ä»¶ã€‚ åœ¨æ¯”èµ›æœŸé—´ï¼ŒèµŒæ³¨å’Œä¿¡æ¯ä¼šä¸æ–­æ›´æ–°ï¼Œæœ‰æ—¶æ¯ç§’æ›´æ–°2-3æ¬¡ï¼Œå› æ­¤é—®é¢˜åœ¨äºï¼Œåœ¨æ›´æ–°ä¹‹åï¼Œæ— éœ€ä¸­é—´æ§åˆ¶å³å¯æ›´æ–°ç•Œé¢ã€‚ <br><br> å½“ç”¨æˆ·ä»ç§»åŠ¨è®¾å¤‡ç›‘è§†å‡ºä»·æ—¶ï¼ŒåŒæ—¶åœ¨å…¶æ˜¾ç¤ºå™¨ä¸Šæ›´æ–°åˆ—è¡¨æ—¶ï¼Œå‡ºä»·ä»è§†é‡ä¸­æ¶ˆå¤±äº†ï¼Œå› æ­¤ç”¨æˆ·å¿…é¡»å†æ¬¡æœç´¢è·Ÿè¸ªçš„å‡ºä»·ã€‚ æ¯æ¬¡æ›´æ–°éƒ½ä¼šé‡å¤æ­¤è¡Œä¸ºã€‚ <br><br><img src="https://habrastorage.org/webt/tq/5p/e8/tq5pe8qxiepdjj7dx5-jry10bjs.gif" alt="å›¾ç‰‡"><br><br> è¯¥è§£å†³æ–¹æ¡ˆè¦æ±‚å±å¹•ä¸Šæ˜¾ç¤ºçš„å¯¹è±¡å…·æœ‰ä¸å˜æ€§ï¼Œä½†ä¸æ­¤åŒæ—¶ï¼ŒæŠ•æ³¨ç³»æ•°å¿…é¡»æ›´æ”¹ï¼Œä¸ç›¸å…³çš„å‡ºä»·å˜ä¸ºæ— æ•ˆï¼Œå¹¶ä¸”ç›´åˆ°ç”¨æˆ·æ»šåŠ¨å±å¹•åæ‰æ·»åŠ æ–°çš„å‡ºä»·ã€‚ è¿‡æ—¶çš„é€‰é¡¹æœªå­˜å‚¨åœ¨åç«¯ï¼Œå› æ­¤å¿…é¡»è®°ä½è¿™äº›è¡Œï¼Œå¹¶ç”¨â€œ deletedâ€æ ‡å¿—æ ‡è®°ï¼Œä¸ºæ­¤åœ¨Webå¥—æ¥å­—å’Œè®¢é˜…ä¹‹é—´åˆ›å»ºäº†ä¸­é—´æ•°æ®å­˜å‚¨ï¼Œä»¥ç¡®ä¿å¯¹æ›´æ”¹è¿›è¡Œæ§åˆ¶ã€‚ <br><br> åœ¨æ–°æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬è¿˜å°†åˆ›å»ºä¸€ä¸ªæ›¿ä»£å±‚ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬å°†ä½¿ç”¨<a href="">Dexie.js</a> -IndexedDB APIçš„åŒ…è£…å™¨ï¼Œä½†ä»»ä½•å…¶ä»–è™šæ‹Ÿæ•°æ®åº“æˆ–æµè§ˆå™¨æ•°æ®åº“éƒ½å¯ä»¥ã€‚  Reduxæ˜¯å¯ä»¥æ¥å—çš„ã€‚ <br><br><h2> å¿½ç•¥ä»»æ„äº‹ä»¶å¹¶å–æ¶ˆå¿½ç•¥ </h2><br> åœ¨åŒä¸€å®¶å…¬å¸ä¸­ï¼Œç»å¸¸åŒæ—¶å­˜åœ¨å¤šä¸ªç›¸åŒç±»å‹çš„é¡¹ç›®ï¼šç§»åŠ¨ç‰ˆæœ¬å’ŒWebç‰ˆæœ¬ï¼Œä¸ºä¸åŒç”¨æˆ·ç»„è®¾ç½®ä¸åŒçš„ç‰ˆæœ¬ï¼ŒåŒä¸€åº”ç”¨ç¨‹åºçš„é«˜çº§ç‰ˆæœ¬å’ŒæˆªçŸ­ç‰ˆæœ¬ã€‚ <br><br> é€šå¸¸å®ƒä»¬éƒ½ä½¿ç”¨å•ä¸ªä»£ç åº“ï¼Œå› æ­¤æœ‰æ—¶æ‚¨éœ€è¦åœ¨è¿è¡Œæ—¶æˆ–DIæœŸé—´å…³é—­ä¸å¿…è¦çš„äº‹ä»¶ï¼Œè€Œåˆä¸åˆ é™¤è®¢é˜…å¹¶é‡æ–°æ‰“å¼€å®ƒï¼Œå³ å¿½ç•¥å…¶ä¸­çš„ä¸€äº›ï¼Œä»¥å…å¤„ç†ä¸å¿…è¦çš„äº‹ä»¶ã€‚ è¿™æ˜¯ä¸€ä¸ªç®€å•ä½†æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯ä¸ºPub / Subæ€»çº¿å¢åŠ çµæ´»æ€§ã€‚ <br><br> è®©æˆ‘ä»¬ä»æ¥å£çš„æè¿°å¼€å§‹ï¼š <br><br><pre><code class="hljs cmake"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IWebsocketService { //    addEventListener&lt;T&gt;(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[], id?: number): Observable&lt;T&gt;; runtimeIgnore(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]): void; runtimeRemoveIgnore(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]): void; sendMessage(event: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, data: any): void; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface WebSocketConfig { //   DI url: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; ignore?: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]; garbageCollectInterval?: number; options?: Options; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface ITopic&lt;T&gt; { //   Pub/Sub [hash: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]: MessageSubject&lt;T&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IListeners { //    [topic: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]: ITopic&lt;any&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IBuffer { //    ws.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> type: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; data: number[]; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IWsMessage { // ws.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> event: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; buffer: IBuffer; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { //   id: number; text: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> type ITopicDataType = IMessage[] | number | <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]; //  callMessage  </code> </pre> <br> æˆ‘ä»¬å°†ç»§æ‰¿Subjectåˆ›å»ºä¸€ä¸ªåƒåœ¾å›æ”¶å™¨ï¼š <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageSubject</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subject</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( private listeners: IListeners, //    private topic: string, //   private id: string // id  ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-comment"><span class="hljs-comment">/* *   next, *       , *   garbageCollect */</span></span> public next(value?: T): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.closed) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectUnsubscribedError(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isStopped) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {observers} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> len = observers.length; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> copy = observers.slice(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { copy[i].next(value); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!len) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.garbageCollect(); <span class="hljs-comment"><span class="hljs-comment">//   } } } /* * garbage collector * */ private garbageCollect(): void { delete this.listeners[this.topic][this.id]; //  Subject if (!Object.keys(this.listeners[this.topic]).length) { //    delete this.listeners[this.topic]; } } }</span></span></code> </pre> <br> ä¸ä¹‹å‰çš„å®ç°ä¸åŒï¼Œwebsocket.events.tså°†æˆä¸ºWebå¥—æ¥å­—æ¨¡å—çš„ä¸€éƒ¨åˆ† <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WS_API = { <span class="hljs-attr"><span class="hljs-attr">EVENTS</span></span>: { <span class="hljs-attr"><span class="hljs-attr">MESSAGES</span></span>: <span class="hljs-string"><span class="hljs-string">'messages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">COUNTER</span></span>: <span class="hljs-string"><span class="hljs-string">'counter'</span></span>, <span class="hljs-attr"><span class="hljs-attr">UPDATE_TEXTS</span></span>: <span class="hljs-string"><span class="hljs-string">'update-texts'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">COMMANDS</span></span>: { <span class="hljs-attr"><span class="hljs-attr">SEND_TEXT</span></span>: <span class="hljs-string"><span class="hljs-string">'set-text'</span></span>, <span class="hljs-attr"><span class="hljs-attr">REMOVE_TEXT</span></span>: <span class="hljs-string"><span class="hljs-string">'remove-text'</span></span> } };</code> </pre> <br> è¦åœ¨è¿æ¥æ¨¡å—æ—¶è¿›è¡Œé…ç½®ï¼Œè¯·åˆ›å»ºwebsocket.configï¼š <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { InjectionToken } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config: InjectionToken&lt;string&gt; = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InjectionToken(<span class="hljs-string"><span class="hljs-string">'websocket'</span></span>);</code> </pre> <br> ä¸ºä»£ç†åˆ›å»ºæ¨¡å‹ï¼š <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dexie <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'dexie'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { IMessage, IWsMessage } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./websocket.interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { WS_API } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./websocket.events'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> MessagesDatabase extends Dexie { //    Dexie  typescript <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> messages!: Dexie.<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>&lt;IMessage, number&gt;; // id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> constructor() { super(<span class="hljs-string"><span class="hljs-string">'MessagesDatabase'</span></span>); //   this.version(<span class="hljs-number"><span class="hljs-number">1</span></span>).stores({ //   messages: <span class="hljs-string"><span class="hljs-string">'++id,text'</span></span> }); } }</code> </pre> <br> ä¸€ä¸ªç®€å•çš„æ¨¡å‹è§£æå™¨ï¼Œåœ¨å®é™…æƒ…å†µä¸‹æœ€å¥½å°†å…¶åˆ†ä¸ºå‡ ä¸ªæ–‡ä»¶ï¼š <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">export</span></span> const modelParser = (message: <span class="hljs-type"><span class="hljs-type">IWsMessage</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message &amp;&amp; message.buffer) { /*  */ const encodeUint8Array = <span class="hljs-type"><span class="hljs-type">String</span></span>.fromCharCode .apply(<span class="hljs-type"><span class="hljs-type">String</span></span>, new <span class="hljs-type"><span class="hljs-type">Uint8Array</span></span>(message.buffer.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">)); const parseData = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JSON</span></span></span><span class="hljs-class">.parse(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">encodeUint8Array</span></span></span><span class="hljs-class">); let </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDatabase</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IndexedDB</span></span></span><span class="hljs-class"> if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MESSAGES</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDatabase</span></span></span><span class="hljs-class">(); } parseData.forEach((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">) =&gt; { /*   */ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">transaction</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rw'</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">async</span></span></span><span class="hljs-class"> () =&gt; { /* ,    */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">await</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">}).count()) === 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">await</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">add</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">}); console.log(`</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Addded</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> ${</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">}`); } }).catch(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class"> =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">console</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">); }); }); return </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.messages.toArray(); //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">[] } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">COUNTER</span></span></span><span class="hljs-class">) { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Promise</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parseData</span></span></span><span class="hljs-class">)); //    } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPDATE_TEXTS</span></span></span><span class="hljs-class">) { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class"> = []; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parseData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forEach</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textData</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">) =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">push</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textData</span></span></span><span class="hljs-class">); }); return new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Promise</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">)); //     } } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">console</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">log</span></span></span><span class="hljs-class">(`[${</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Date</span></span></span><span class="hljs-class">()}] </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Buffer</span></span></span><span class="hljs-class"> is "undefined"`); } };</span></span></code> </pre> <br>  WebsocketModuleï¼š <br><br><pre> <code class="hljs powershell">@NgModule({ imports: [ <span class="hljs-type"><span class="hljs-type">CommonModule</span></span> ] }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebsocketModule</span></span></span></span> { public <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> config(wsConfig: WebSocketConfig): ModuleWithProviders { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ngModule: WebsocketModule, providers: [{<span class="hljs-type"><span class="hljs-type">provide</span></span>: <span class="hljs-type"><span class="hljs-type">config</span></span>, <span class="hljs-type"><span class="hljs-type">useValue</span></span>: <span class="hljs-type"><span class="hljs-type">wsConfig</span></span>}] }; } }</code> </pre> <br> è®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºæœåŠ¡ï¼š <br><br><pre> <code class="hljs ruby">private <span class="hljs-symbol"><span class="hljs-symbol">listeners:</span></span> IListeners; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   private <span class="hljs-symbol"><span class="hljs-symbol">uniqueId:</span></span> number; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   id  private <span class="hljs-symbol"><span class="hljs-symbol">websocket:</span></span> ReconnectingWebSocket; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   constructor(@Inject(config) private <span class="hljs-symbol"><span class="hljs-symbol">wsConfig:</span></span> WebSocketConfig) { this.uniqueId = -<span class="hljs-number"><span class="hljs-number">1</span></span>; this.listeners = {}; this.wsConfig.ignore = wsConfig.ignore ? wsConfig.ignore : []; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  this.connect(); } ngOnDestroy() { this.websocket.close(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     }</code> </pre> <br> è¿æ¥æ–¹å¼ï¼š <br><br><pre> <code class="hljs coffeescript">private connect(): void { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ReconnectingWebSocket config const options = { connectionTimeout: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    maxRetries: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    ...<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.options }; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReconnectingWebSocket(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.url, [], options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: Event)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket connected!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: CloseEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket close!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: ErrorEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket error!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: MessageEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onMessage(event); }); setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.garbageCollect(); }, (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.garbageCollectInterval || <span class="hljs-number"><span class="hljs-number">10000</span></span>)); }</code> </pre> <br> å¤åˆ¶åƒåœ¾æ”¶é›†å™¨ï¼Œå°†æŒ‰è¶…æ—¶æ£€æŸ¥è®¢é˜…ï¼š <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">garbageCollect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.hasOwnProperty(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> topic = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners[<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topic) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic.hasOwnProperty(key)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> subject = topic[key]; <span class="hljs-comment"><span class="hljs-comment">//  Subject    if (!subject.observers.length) { delete topic[key]; } } }  ,   if (!Object.keys(topic).length) { delete this.listeners[event]; } } } }</span></span></code> </pre> <br> æˆ‘ä»¬æŸ¥çœ‹å‘é€äº‹ä»¶çš„è®¢é˜…ï¼š <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> onMessage(event: MessageEvent): void { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> message = JSON.parse(event.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.hasOwnProperty(name) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.ignore.includes(name)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> topic = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners[name]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> keys = name.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      const isMessage = keys.includes(message.event); const model = modelParser(message); //     if (isMessage &amp;&amp; typeof model !== 'undefined') { model.then((data: ITopicDataType) =&gt; { //   Subject this.callMessage&lt;ITopicDataType&gt;(topic, data); }); } } } }</span></span></code> </pre> <br> ä¸»é¢˜ä¸­çš„å¤´ç›”äº‹ä»¶ï¼š <br><br><pre> <code class="hljs powershell">private callMessage&lt;T&gt;(topic: ITopic&lt;T&gt;, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: T): void { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (const key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topic) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic.hasOwnProperty(key)) { const subject = topic[<span class="hljs-type"><span class="hljs-type">key</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subject) { //   subject.next(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(`[<span class="hljs-variable"><span class="hljs-variable">$</span></span>{Date()}] Topic Subject is <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>`); } } } }</code> </pre> <br> åˆ›å»ºå‘å¸ƒ/å­ä¸»é¢˜ï¼š <br><br><pre> <code class="hljs markdown">private addTopic<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>(topic: string, id?: number): MessageSubject<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> { const token = (++this.uniqueId).toString(); const key = id ? token + id : token; //  id   const hash = sha256.hex(key); // SHA256-   id  if (!this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>]) { this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>] = <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">any</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>{}; } return this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">hash</span></span>] = new MessageSubject<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>(this.listeners, topic, hash); }</code> </pre> <br> è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ï¼š <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> addEventListener&lt;T&gt;(topics: string | string[], id?: number): Observable&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics) { //       const topicsKey = typeof topics === <span class="hljs-string"><span class="hljs-string">'string'</span></span> ? topics : topics.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.addTopic&lt;T&gt;(topicsKey, id).asObservable(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(`[${<span class="hljs-type"><span class="hljs-type">Date</span></span>()}] Can<span class="hljs-string"><span class="hljs-string">'t add EventListener. Type of event is "undefined".`); } }</span></span></code> </pre> <br> æ­¤å¤„çš„æ‰€æœ‰å†…å®¹éƒ½ç»è¿‡æœ‰æ„ç®€åŒ–ï¼Œä½†å¯ä»¥è½¬æ¢ä¸ºäºŒè¿›åˆ¶å®ä½“ï¼Œå°±åƒæœåŠ¡å™¨ä¸€æ ·ã€‚ å°†å‘½ä»¤å‘é€åˆ°æœåŠ¡å™¨ï¼š <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sendMessage(event: string, data: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> = {}): <span class="hljs-type"><span class="hljs-type">void</span></span> { //   ,      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event &amp;&amp; this.websocket.readyState === <span class="hljs-number"><span class="hljs-number">1</span></span>) { this.websocket.send(<span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify({event, data})); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(<span class="hljs-string"><span class="hljs-string">'Send error!'</span></span>); } }</code> </pre> <br> åœ¨è¿è¡Œæ—¶å°†äº‹ä»¶æ·»åŠ åˆ°ignorlistï¼š <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtimeIgnore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">topics: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics &amp;&amp; topics.length) { <span class="hljs-comment"><span class="hljs-comment">//    this.wsConfig.ignore.push(...topics); } }</span></span></code> </pre> <br> ä»å¿½ç•¥åˆ—è¡¨ä¸­åˆ é™¤äº‹ä»¶ï¼š <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtimeRemoveIgnore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">topics: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics &amp;&amp; topics.length) { topics.forEach((topic: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//      const topicIndex = this.wsConfig.ignore.findIndex(t =&gt; t === topic); if (topicIndex &gt; -1) { //    this.wsConfig.ignore.splice(topicIndex, 1); } }); } }</span></span></code> </pre> <br> æˆ‘ä»¬è¿æ¥Webå¥—æ¥å­—æ¨¡å—ï¼š <br><br><pre> <code class="hljs powershell">@NgModule({ declarations: [ <span class="hljs-type"><span class="hljs-type">AppComponent</span></span> ], imports: [ <span class="hljs-type"><span class="hljs-type">BrowserModule</span></span>, <span class="hljs-type"><span class="hljs-type">ReactiveFormsModule</span></span>, <span class="hljs-type"><span class="hljs-type">WebsocketModule.config</span></span>({ <span class="hljs-type"><span class="hljs-type">url</span></span>: <span class="hljs-type"><span class="hljs-type">environment.ws</span></span>, //  <span class="hljs-string"><span class="hljs-string">"ws://mywebsocketurl"</span></span> //    <span class="hljs-type"><span class="hljs-type">ignore</span></span>: [<span class="hljs-type"><span class="hljs-type">WS_API.EVENTS.ANY_1</span></span>, <span class="hljs-type"><span class="hljs-type">WS_API.EVENTS.ANY_2</span></span>], <span class="hljs-type"><span class="hljs-type">garbageCollectInterval</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, //    <span class="hljs-type"><span class="hljs-type">options</span></span>: { <span class="hljs-type"><span class="hljs-type">connectionTimeout</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, //   <span class="hljs-type"><span class="hljs-type">maxRetries</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> //   } }) ], providers: [], bootstrap: [<span class="hljs-type"><span class="hljs-type">AppComponent</span></span>] }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span></span> { }</code> </pre> <br> æˆ‘ä»¬åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ï¼š <br><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Component({ selector: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'app-root'</span></span></span><span class="hljs-meta">, templateUrl: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.html'</span></span></span><span class="hljs-meta">, styleUrls: [</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.css'</span></span></span><span class="hljs-meta">] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OnDestroy { private messages$: Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messagesMulti</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">number</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">string[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FormGroup; constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> fb: FormBuilder, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> wsService: WebsocketService) { } ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.form = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fb.group({ text: [<span class="hljs-literal"><span class="hljs-literal">null</span></span>, [ Validators.required ]] }); <span class="hljs-comment"><span class="hljs-comment">// get messages this.messages$ = this.wsService .addEventListener&lt;IMessage[]&gt;(WS_API.EVENTS.MESSAGES); // get messages multi this.messagesMulti$ = this.wsService .addEventListener&lt;IMessage[]&gt;([ WS_API.EVENTS.MESSAGES, WS_API.EVENTS.MESSAGES_1 ]); // get counter this.counter$ = this.wsService .addEventListener&lt;number&gt;(WS_API.EVENTS.COUNTER); // get texts this.texts$ = this.wsService .addEventListener&lt;string[]&gt;(WS_API.EVENTS.UPDATE_TEXTS); } ngOnDestroy() { } public sendText(): void { if (this.form.valid) { this.wsService .sendMessage(WS_API.COMMANDS.SEND_TEXT, this.form.value.text); this.form.reset(); } } public removeText(index: number): void { this.wsService.sendMessage(WS_API.COMMANDS.REMOVE_TEXT, index); } }</span></span></code> </pre> <br> è¯¥æœåŠ¡å¯ä»¥ä½¿ç”¨äº†ã€‚ <br><br><hr><br> å°½ç®¡æœ¬æ–‡ä¸­çš„ç¤ºä¾‹ä¸æ˜¯æ¯ä¸ªé¡¹ç›®çš„é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œä½†å®ƒæ¼”ç¤ºäº†åœ¨å¤§å‹å’Œå¤æ‚åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨Webå¥—æ¥å­—çš„ä¸€ç§æ–¹æ³•ã€‚ æ‚¨å¯ä»¥å¯ç”¨å®ƒå¹¶æ ¹æ®å½“å‰ä»»åŠ¡å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚ <br><br> è¯¥æœåŠ¡çš„å®Œæ•´ç‰ˆæœ¬å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a>ä¸Š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‰¾åˆ°</a> ã€‚ <br><br> å¯¹äºæ‰€æœ‰é—®é¢˜ï¼Œæ‚¨éƒ½å¯ä»¥åœ¨è¯„è®ºä¸­è”ç³»ï¼Œæ— è®ºæ˜¯é€šè¿‡Telegramè¿˜æ˜¯åœ¨åŒä¸€ä¸ªåœ°æ–¹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„Angularé¢‘é“</a>ä¸Šï¼Œå¯ä»¥ä¸<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æˆ‘</a>è”ç³»ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN419099/">https://habr.com/ru/post/zh-CN419099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN419085/index.html">å¤§çˆ†ç‚¸ä¹‹å‰çš„å¥‡å¼‚æƒ³æ³•å·²ç»è¿‡æ—¶</a></li>
<li><a href="../zh-CN419089/index.html">ç©éª°å­æ—¶å¦‚ä½•ä½œå¼Š-æ¸¸æˆä¸“å®¶æç¤º</a></li>
<li><a href="../zh-CN419091/index.html">æˆ‘ä»¬ä¸­é—´çš„æ”¾å°„æ€§ç‰©ä½“</a></li>
<li><a href="../zh-CN419095/index.html">æˆ‘ä»¬å†™çš„CSSæ›´å¥½ï¼Œæ›´æ¼‚äº®</a></li>
<li><a href="../zh-CN419097/index.html">Mambot-å­•å¦‡ç”µæŠ¥ä¸­çš„æœºå™¨äºº</a></li>
<li><a href="../zh-CN419101/index.html">åœ¨å¤œé—´é»‘å®¢é©¬æ‹‰æ¾ä¸Šåˆ›å»ºæ¸¸æˆ</a></li>
<li><a href="../zh-CN419103/index.html">ç”¨Lispå†™ä¸€ä¸ªç®€å•çš„ç¿»è¯‘å™¨-I</a></li>
<li><a href="../zh-CN419105/index.html">é“¾æ¥åˆ°Slurmå¹¿æ’­ï¼ˆKuberneteså¼ºåŒ–è¯¾ç¨‹ï¼‰</a></li>
<li><a href="../zh-CN419107/index.html">Dell EMC Unityæ–‡ä»¶éƒ¨ä»¶æ¦‚è¿°å’Œé…ç½®ç¤ºä¾‹</a></li>
<li><a href="../zh-CN419109/index.html">è§£é‡Šä¸€ä¸‹Android Pä¸­çš„åˆ˜æµ·ã€‚å¦‚ä½•ä½¿ç”¨Android Cutoutï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>