<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💅🏾 🤰🏻 👩🏻‍🤝‍👨🏽 Angular中的WebSockets。 第2部分。产品解决方案 ♉️ 🍆 💞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在上一篇文章中，我们讨论了Angular中针对Web套接字的通用解决方案，其中我们构建了具有重新连接和服务的总线，可用于基于WebSocketSubject的组件。 这种实现适用于大多数简单情况，例如，接收和发送聊天消息等，但是在您需要构建更灵活和可控制的内容的情况下，其功能可能不足。 在本文中，我...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Angular中的WebSockets。 第2部分。产品解决方案</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419099/"><img src="https://habrastorage.org/webt/hf/xh/dl/hfxhdlv7katnrbytwzqmhjy3xom.png" alt="图片"><br><br> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">上一篇文章中，</a>我们讨论了Angular中针对Web套接字的通用解决方案，其中我们构建了具有重新连接和服务的总线，可用于基于WebSocketSubject的组件。 这种实现适用于大多数简单情况，例如，接收和发送聊天消息等，但是在您需要构建更灵活和可控制的内容的情况下，其功能可能不足。 在本文中，我将介绍使用Web套接字时的一些功能，并讨论您自己可能遇到的需求。 <br><a name="habracut"></a><br> 通常，在人流较大的大型项目中，前端要面对在其他情况下在后端更常见的任务。 在服务器资源紧缩的情况下，部分问题会迁移到前端区域，因此，该项目具有最大的可扩展性和可控制性。 <br><br> 这是本文将介绍的Web套接字客户端的基本要求的列表： <br><br><ul><li> 自动“智能”重新连接； </li><li> 调试模式； </li><li> 基于RxJ的事件订阅系统； </li><li> 接收和解析二进制数据； </li><li> 在模型上投影（映射）收到的信息； </li><li> 随着新事件的到来，控制模型的变化； </li><li> 忽略任意事件并取消忽略。 </li></ul><br> 请更详细地考虑每个项目。 <br><br><h2> 重新连接/卸袋 </h2><br> 我在上一篇文章中写过关于重新连接的知识，所以我只引用部分内容： <br><br><blockquote> 当使用Web套接字时，重新连接或重新连接到服务器的组织是至关重要的因素，因为 网络中断，服务器崩溃或其他导致连接中断的错误可能导致应用程序崩溃。 <br> 重要的是要注意，重新连接尝试不应太频繁且不应无限期地继续，例如 此行为可以挂起客户端。 </blockquote><br>  Web套接字本身不知道断开连接后如何重新连接。 因此，如果服务器重新启动或服务器崩溃，或者用户重新连接了Internet，则要继续工作，还需要重新连接Web套接字。 <br><br> 在本文中，为了进行重新连接和调试，我们将使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Reconnecting WebSocket</a> ，其中包含必要的功能和其他选项，例如在重新连接之间更改Web套接字的URL，选择任意WebSocket构造函数等。 其他替代方式也是合适的。 重新连接上一篇文章不适合，因为 它是在WebSocketSubject下编写的，这一次不适用。 <br><br><h2>  RxJs事件订阅系统 </h2><br> 要在组件中使用Web套接字，您需要订阅事件，并在必要时取消订阅它们。 为此，请使用流行的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Pub / Sub</a>设计模式。 <br><blockquote>  “发布者－订阅者（eng。Publisher-subscriber或eng。Pub / sub）-用于传输消息的行为设计模板，其中消息的发件人（称为发布者（eng。Publishers））没有直接绑定到程序代码上，而是将消息发送给订阅者（eng。Subscriber） ） 而是将消息分为几类，并且不包含有关其订户的信息（如果有）。 同样，订户处理一类或多类消息，这些消息是从特定发布者那里提取的。” </blockquote><br> 订户不是直接与发布者联系，而是通过中间总线-网站服务。 还应该可以订阅具有相同返回类型的多个事件。 每个订阅都创建自己的主题，该主题添加到侦听器对象中，使您可以将Web套接字事件寻址到必要的订阅。 在使用RxJs Subject时，取消订阅会有一些困难，因此，我们将创建一个简单的垃圾回收器，当没有观察者的侦听器对象时，它将从侦听器对象中删除这些主题。 <br><br><h2> 接收和解析二进制数据 </h2><br>  WebSocket支持二进制数据，文件或流的传输，这通常在大型项目中使用。 看起来像这样： <br><blockquote>  0x80，&lt;长度-一个或多个字节&gt;，&lt;消息正文&gt; </blockquote><br> 为了不限制传输消息的长度，同时又不浪费字节，协议开发人员使用了以下算法。 长度指示中的每个字节都被单独考虑：最高字节指示它是最后一个字节（0）还是后面的其他字节（1），而低7位包含发送的数据。 因此，当二进制数据帧0x80的符号出现时，则获取下一个字节并将其存储在单独的“存钱罐”中。 然后，下一个字节（如果设置了最高有效位）也将传送到“存钱罐”，依此类推，直到遇到最高有效位为零的字节。 该字节是长度指示器中的最后一个字节，并且也添加到“存钱罐”中。 现在，从存钱罐中的字节中删除高位，然后合并其余部分。 这将是消息正文的长度-7位数字，没有最高有效位。 <br><br> 前端解析和二进制流机制很复杂，并且与模型上的数据映射相关联。 可以单独撰写一篇文章。 这次，我们将分析一个简单的选项，如果对该主题感兴趣的话，将为下面的出版物提供困难的案例。 <br><br><h2> 在模型上投影（映射）收到的信息 </h2><br> 不管接收到的传输类型如何，都需要安全地阅读和修改。 关于如何更好地做到这一点尚无共识，我坚持<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用数据模型</a>的理论，因为我认为它对于以OOP风格进行编程是合乎逻辑且可靠的。 <br><blockquote>  “数据模型是对象，运算符和其他元素的抽象，自给自足的逻辑定义，它们共同构成了用户与之交互的抽象数据访问机器。  “这些对象使您可以对数据结构和运算符进行建模-数据的行为。” </blockquote><br> 各种不把对象归类为行为，结构等的对象的流行轮胎都会造成混乱，控制得不好，有时会长满一些不常见的东西。 例如，狗类应该在任何条件下描述狗。 如果将狗视为一组区域：尾巴，颜色，脸部等，则该狗可能会长出额外的爪子，并且将出现另一只狗而不是头部。 <br><br><img src="https://habrastorage.org/webt/sq/fa/xu/sqfaxulbeyaffws-46gxho3-dcg.jpeg" alt="图片"><br><br><h2> 随着新事件的到来，控制模型的变化 </h2><br> 在本段中，我将描述在体育博彩移动应用程序的Web界面上工作时遇到的问题。 应用程序API通过接收的Web套接字工作：更新赔率，添加和删除新类型的投注，有关比赛开始或结束的通知等。  -总共约有300个Web套接字事件。 在比赛期间，赌注和信息会不断更新，有时每秒更新2-3次，因此问题在于，在更新之后，无需中间控制即可更新界面。 <br><br> 当用户从移动设备监视出价时，同时在其显示器上更新列表时，出价从视野中消失了，因此用户必须再次搜索跟踪的出价。 每次更新都会重复此行为。 <br><br><img src="https://habrastorage.org/webt/tq/5p/e8/tq5pe8qxiepdjj7dx5-jry10bjs.gif" alt="图片"><br><br> 该解决方案要求屏幕上显示的对象具有不变性，但与此同时，投注系数必须更改，不相关的出价变为无效，并且直到用户滚动屏幕后才添加新的出价。 过时的选项未存储在后端，因此必须记住这些行，并用“ deleted”标志标记，为此在Web套接字和订阅之间创建了中间数据存储，以确保对更改进行控制。 <br><br> 在新服务中，我们还将创建一个替代层，这一次我们将使用<a href="">Dexie.js</a> -IndexedDB API的包装器，但任何其他虚拟数据库或浏览器数据库都可以。  Redux是可以接受的。 <br><br><h2> 忽略任意事件并取消忽略 </h2><br> 在同一家公司中，经常同时存在多个相同类型的项目：移动版本和Web版本，为不同用户组设置不同的版本，同一应用程序的高级版本和截短版本。 <br><br> 通常它们都使用单个代码库，因此有时您需要在运行时或DI期间关闭不必要的事件，而又不删除订阅并重新打开它，即 忽略其中的一些，以免处理不必要的事件。 这是一个简单但有用的功能，可为Pub / Sub总线增加灵活性。 <br><br> 让我们从接口的描述开始： <br><br><pre><code class="hljs cmake"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IWebsocketService { //    addEventListener&lt;T&gt;(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[], id?: number): Observable&lt;T&gt;; runtimeIgnore(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]): void; runtimeRemoveIgnore(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]): void; sendMessage(event: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, data: any): void; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface WebSocketConfig { //   DI url: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; ignore?: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]; garbageCollectInterval?: number; options?: Options; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface ITopic&lt;T&gt; { //   Pub/Sub [hash: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]: MessageSubject&lt;T&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IListeners { //    [topic: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]: ITopic&lt;any&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IBuffer { //    ws.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> type: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; data: number[]; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IWsMessage { // ws.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> event: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; buffer: IBuffer; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { //   id: number; text: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> type ITopicDataType = IMessage[] | number | <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]; //  callMessage  </code> </pre> <br> 我们将继承Subject创建一个垃圾回收器： <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageSubject</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subject</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( private listeners: IListeners, //    private topic: string, //   private id: string // id  ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-comment"><span class="hljs-comment">/* *   next, *       , *   garbageCollect */</span></span> public next(value?: T): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.closed) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectUnsubscribedError(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isStopped) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {observers} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> len = observers.length; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> copy = observers.slice(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { copy[i].next(value); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!len) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.garbageCollect(); <span class="hljs-comment"><span class="hljs-comment">//   } } } /* * garbage collector * */ private garbageCollect(): void { delete this.listeners[this.topic][this.id]; //  Subject if (!Object.keys(this.listeners[this.topic]).length) { //    delete this.listeners[this.topic]; } } }</span></span></code> </pre> <br> 与之前的实现不同，websocket.events.ts将成为Web套接字模块的一部分 <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WS_API = { <span class="hljs-attr"><span class="hljs-attr">EVENTS</span></span>: { <span class="hljs-attr"><span class="hljs-attr">MESSAGES</span></span>: <span class="hljs-string"><span class="hljs-string">'messages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">COUNTER</span></span>: <span class="hljs-string"><span class="hljs-string">'counter'</span></span>, <span class="hljs-attr"><span class="hljs-attr">UPDATE_TEXTS</span></span>: <span class="hljs-string"><span class="hljs-string">'update-texts'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">COMMANDS</span></span>: { <span class="hljs-attr"><span class="hljs-attr">SEND_TEXT</span></span>: <span class="hljs-string"><span class="hljs-string">'set-text'</span></span>, <span class="hljs-attr"><span class="hljs-attr">REMOVE_TEXT</span></span>: <span class="hljs-string"><span class="hljs-string">'remove-text'</span></span> } };</code> </pre> <br> 要在连接模块时进行配置，请创建websocket.config： <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { InjectionToken } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config: InjectionToken&lt;string&gt; = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InjectionToken(<span class="hljs-string"><span class="hljs-string">'websocket'</span></span>);</code> </pre> <br> 为代理创建模型： <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dexie <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'dexie'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { IMessage, IWsMessage } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./websocket.interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { WS_API } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./websocket.events'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> MessagesDatabase extends Dexie { //    Dexie  typescript <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> messages!: Dexie.<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>&lt;IMessage, number&gt;; // id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> constructor() { super(<span class="hljs-string"><span class="hljs-string">'MessagesDatabase'</span></span>); //   this.version(<span class="hljs-number"><span class="hljs-number">1</span></span>).stores({ //   messages: <span class="hljs-string"><span class="hljs-string">'++id,text'</span></span> }); } }</code> </pre> <br> 一个简单的模型解析器，在实际情况下最好将其分为几个文件： <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">export</span></span> const modelParser = (message: <span class="hljs-type"><span class="hljs-type">IWsMessage</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message &amp;&amp; message.buffer) { /*  */ const encodeUint8Array = <span class="hljs-type"><span class="hljs-type">String</span></span>.fromCharCode .apply(<span class="hljs-type"><span class="hljs-type">String</span></span>, new <span class="hljs-type"><span class="hljs-type">Uint8Array</span></span>(message.buffer.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">)); const parseData = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JSON</span></span></span><span class="hljs-class">.parse(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">encodeUint8Array</span></span></span><span class="hljs-class">); let </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDatabase</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IndexedDB</span></span></span><span class="hljs-class"> if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MESSAGES</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDatabase</span></span></span><span class="hljs-class">(); } parseData.forEach((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">) =&gt; { /*   */ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">transaction</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rw'</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">async</span></span></span><span class="hljs-class"> () =&gt; { /* ,    */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">await</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">}).count()) === 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">await</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">add</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">}); console.log(`</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Addded</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> ${</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">}`); } }).catch(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class"> =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">console</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">); }); }); return </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.messages.toArray(); //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">[] } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">COUNTER</span></span></span><span class="hljs-class">) { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Promise</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parseData</span></span></span><span class="hljs-class">)); //    } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPDATE_TEXTS</span></span></span><span class="hljs-class">) { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class"> = []; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parseData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forEach</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textData</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">) =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">push</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textData</span></span></span><span class="hljs-class">); }); return new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Promise</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">)); //     } } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">console</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">log</span></span></span><span class="hljs-class">(`[${</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Date</span></span></span><span class="hljs-class">()}] </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Buffer</span></span></span><span class="hljs-class"> is "undefined"`); } };</span></span></code> </pre> <br>  WebsocketModule： <br><br><pre> <code class="hljs powershell">@NgModule({ imports: [ <span class="hljs-type"><span class="hljs-type">CommonModule</span></span> ] }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebsocketModule</span></span></span></span> { public <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> config(wsConfig: WebSocketConfig): ModuleWithProviders { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ngModule: WebsocketModule, providers: [{<span class="hljs-type"><span class="hljs-type">provide</span></span>: <span class="hljs-type"><span class="hljs-type">config</span></span>, <span class="hljs-type"><span class="hljs-type">useValue</span></span>: <span class="hljs-type"><span class="hljs-type">wsConfig</span></span>}] }; } }</code> </pre> <br> 让我们开始创建服务： <br><br><pre> <code class="hljs ruby">private <span class="hljs-symbol"><span class="hljs-symbol">listeners:</span></span> IListeners; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   private <span class="hljs-symbol"><span class="hljs-symbol">uniqueId:</span></span> number; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   id  private <span class="hljs-symbol"><span class="hljs-symbol">websocket:</span></span> ReconnectingWebSocket; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   constructor(@Inject(config) private <span class="hljs-symbol"><span class="hljs-symbol">wsConfig:</span></span> WebSocketConfig) { this.uniqueId = -<span class="hljs-number"><span class="hljs-number">1</span></span>; this.listeners = {}; this.wsConfig.ignore = wsConfig.ignore ? wsConfig.ignore : []; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  this.connect(); } ngOnDestroy() { this.websocket.close(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     }</code> </pre> <br> 连接方式： <br><br><pre> <code class="hljs coffeescript">private connect(): void { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ReconnectingWebSocket config const options = { connectionTimeout: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    maxRetries: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    ...<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.options }; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReconnectingWebSocket(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.url, [], options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: Event)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket connected!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: CloseEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket close!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: ErrorEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket error!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: MessageEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onMessage(event); }); setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.garbageCollect(); }, (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.garbageCollectInterval || <span class="hljs-number"><span class="hljs-number">10000</span></span>)); }</code> </pre> <br> 复制垃圾收集器，将按超时检查订阅： <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">garbageCollect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.hasOwnProperty(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> topic = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners[<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topic) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic.hasOwnProperty(key)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> subject = topic[key]; <span class="hljs-comment"><span class="hljs-comment">//  Subject    if (!subject.observers.length) { delete topic[key]; } } }  ,   if (!Object.keys(topic).length) { delete this.listeners[event]; } } } }</span></span></code> </pre> <br> 我们查看发送事件的订阅： <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> onMessage(event: MessageEvent): void { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> message = JSON.parse(event.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.hasOwnProperty(name) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.ignore.includes(name)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> topic = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners[name]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> keys = name.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      const isMessage = keys.includes(message.event); const model = modelParser(message); //     if (isMessage &amp;&amp; typeof model !== 'undefined') { model.then((data: ITopicDataType) =&gt; { //   Subject this.callMessage&lt;ITopicDataType&gt;(topic, data); }); } } } }</span></span></code> </pre> <br> 主题中的头盔事件： <br><br><pre> <code class="hljs powershell">private callMessage&lt;T&gt;(topic: ITopic&lt;T&gt;, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: T): void { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (const key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topic) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic.hasOwnProperty(key)) { const subject = topic[<span class="hljs-type"><span class="hljs-type">key</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subject) { //   subject.next(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(`[<span class="hljs-variable"><span class="hljs-variable">$</span></span>{Date()}] Topic Subject is <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>`); } } } }</code> </pre> <br> 创建发布/子主题： <br><br><pre> <code class="hljs markdown">private addTopic<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>(topic: string, id?: number): MessageSubject<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> { const token = (++this.uniqueId).toString(); const key = id ? token + id : token; //  id   const hash = sha256.hex(key); // SHA256-   id  if (!this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>]) { this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>] = <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">any</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>{}; } return this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">hash</span></span>] = new MessageSubject<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>(this.listeners, topic, hash); }</code> </pre> <br> 订阅一个或多个事件： <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> addEventListener&lt;T&gt;(topics: string | string[], id?: number): Observable&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics) { //       const topicsKey = typeof topics === <span class="hljs-string"><span class="hljs-string">'string'</span></span> ? topics : topics.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.addTopic&lt;T&gt;(topicsKey, id).asObservable(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(`[${<span class="hljs-type"><span class="hljs-type">Date</span></span>()}] Can<span class="hljs-string"><span class="hljs-string">'t add EventListener. Type of event is "undefined".`); } }</span></span></code> </pre> <br> 此处的所有内容都经过有意简化，但可以转换为二进制实体，就像服务器一样。 将命令发送到服务器： <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sendMessage(event: string, data: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> = {}): <span class="hljs-type"><span class="hljs-type">void</span></span> { //   ,      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event &amp;&amp; this.websocket.readyState === <span class="hljs-number"><span class="hljs-number">1</span></span>) { this.websocket.send(<span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify({event, data})); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(<span class="hljs-string"><span class="hljs-string">'Send error!'</span></span>); } }</code> </pre> <br> 在运行时将事件添加到ignorlist： <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtimeIgnore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">topics: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics &amp;&amp; topics.length) { <span class="hljs-comment"><span class="hljs-comment">//    this.wsConfig.ignore.push(...topics); } }</span></span></code> </pre> <br> 从忽略列表中删除事件： <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtimeRemoveIgnore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">topics: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics &amp;&amp; topics.length) { topics.forEach((topic: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//      const topicIndex = this.wsConfig.ignore.findIndex(t =&gt; t === topic); if (topicIndex &gt; -1) { //    this.wsConfig.ignore.splice(topicIndex, 1); } }); } }</span></span></code> </pre> <br> 我们连接Web套接字模块： <br><br><pre> <code class="hljs powershell">@NgModule({ declarations: [ <span class="hljs-type"><span class="hljs-type">AppComponent</span></span> ], imports: [ <span class="hljs-type"><span class="hljs-type">BrowserModule</span></span>, <span class="hljs-type"><span class="hljs-type">ReactiveFormsModule</span></span>, <span class="hljs-type"><span class="hljs-type">WebsocketModule.config</span></span>({ <span class="hljs-type"><span class="hljs-type">url</span></span>: <span class="hljs-type"><span class="hljs-type">environment.ws</span></span>, //  <span class="hljs-string"><span class="hljs-string">"ws://mywebsocketurl"</span></span> //    <span class="hljs-type"><span class="hljs-type">ignore</span></span>: [<span class="hljs-type"><span class="hljs-type">WS_API.EVENTS.ANY_1</span></span>, <span class="hljs-type"><span class="hljs-type">WS_API.EVENTS.ANY_2</span></span>], <span class="hljs-type"><span class="hljs-type">garbageCollectInterval</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, //    <span class="hljs-type"><span class="hljs-type">options</span></span>: { <span class="hljs-type"><span class="hljs-type">connectionTimeout</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, //   <span class="hljs-type"><span class="hljs-type">maxRetries</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> //   } }) ], providers: [], bootstrap: [<span class="hljs-type"><span class="hljs-type">AppComponent</span></span>] }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span></span> { }</code> </pre> <br> 我们在组件中使用： <br><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Component({ selector: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'app-root'</span></span></span><span class="hljs-meta">, templateUrl: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.html'</span></span></span><span class="hljs-meta">, styleUrls: [</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.css'</span></span></span><span class="hljs-meta">] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OnDestroy { private messages$: Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messagesMulti</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">number</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">string[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FormGroup; constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> fb: FormBuilder, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> wsService: WebsocketService) { } ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.form = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fb.group({ text: [<span class="hljs-literal"><span class="hljs-literal">null</span></span>, [ Validators.required ]] }); <span class="hljs-comment"><span class="hljs-comment">// get messages this.messages$ = this.wsService .addEventListener&lt;IMessage[]&gt;(WS_API.EVENTS.MESSAGES); // get messages multi this.messagesMulti$ = this.wsService .addEventListener&lt;IMessage[]&gt;([ WS_API.EVENTS.MESSAGES, WS_API.EVENTS.MESSAGES_1 ]); // get counter this.counter$ = this.wsService .addEventListener&lt;number&gt;(WS_API.EVENTS.COUNTER); // get texts this.texts$ = this.wsService .addEventListener&lt;string[]&gt;(WS_API.EVENTS.UPDATE_TEXTS); } ngOnDestroy() { } public sendText(): void { if (this.form.valid) { this.wsService .sendMessage(WS_API.COMMANDS.SEND_TEXT, this.form.value.text); this.form.reset(); } } public removeText(index: number): void { this.wsService.sendMessage(WS_API.COMMANDS.REMOVE_TEXT, index); } }</span></span></code> </pre> <br> 该服务可以使用了。 <br><br><hr><br> 尽管本文中的示例不是每个项目的通用解决方案，但它演示了在大型和复杂应用程序中使用Web套接字的一种方法。 您可以启用它并根据当前任务对其进行修改。 <br><br> 该服务的完整版本可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a>上<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">找到</a> 。 <br><br> 对于所有问题，您都可以在评论中联系，无论是通过Telegram还是在同一个地方<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的Angular频道</a>上，可以与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我</a>联系。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN419099/">https://habr.com/ru/post/zh-CN419099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN419085/index.html">大爆炸之前的奇异想法已经过时</a></li>
<li><a href="../zh-CN419089/index.html">玩骰子时如何作弊-游戏专家提示</a></li>
<li><a href="../zh-CN419091/index.html">我们中间的放射性物体</a></li>
<li><a href="../zh-CN419095/index.html">我们写的CSS更好，更漂亮</a></li>
<li><a href="../zh-CN419097/index.html">Mambot-孕妇电报中的机器人</a></li>
<li><a href="../zh-CN419101/index.html">在夜间黑客马拉松上创建游戏</a></li>
<li><a href="../zh-CN419103/index.html">用Lisp写一个简单的翻译器-I</a></li>
<li><a href="../zh-CN419105/index.html">链接到Slurm广播（Kubernetes强化课程）</a></li>
<li><a href="../zh-CN419107/index.html">Dell EMC Unity文件部件概述和配置示例</a></li>
<li><a href="../zh-CN419109/index.html">解释一下Android P中的刘海。如何使用Android Cutout？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>