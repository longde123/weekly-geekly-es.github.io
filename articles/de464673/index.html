<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖇️ 🕵🏻 👇🏼 TinyFL - Taschenlampentreiber für Mikrocontroller 😳 🆚 🎿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! 


 Ich möchte eine Geschichte darüber erzählen, wie ich auf einer Cree XM-L LED in die Hände eines chinesischen Scheinwerfers gelangt bin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TinyFL - Taschenlampentreiber für Mikrocontroller</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464673/"><p>  Hallo Habr! </p><br><p>  Ich möchte eine Geschichte darüber erzählen, wie ich auf einer Cree XM-L LED in die Hände eines chinesischen Scheinwerfers gelangt bin und was als nächstes damit passiert ist. </p><br><p><img src="https://habrastorage.org/webt/ec/vx/uq/ecvxuq8hlp8-x_b6iacutkxyrmo.jpeg"></p><a name="habracut"></a><br><h2 id="predystoriya">  Hintergrund </h2><br><p>  Es war einmal, als ich bei einer chinesischen Website eine Taschenlampe mit einer hellen LED bestellte.  Die Taschenlampe erwies sich als ziemlich ergonomisch (obwohl es einfacher sein könnte), aber der Fahrer ließ zu wünschen übrig. </p><br><p>  Es schien hell genug, aber der Fahrer hatte nur 3 Modi - sehr hell, hell und Blitz, zwischen denen auf Knopfdruck umgeschaltet wurde.  Um die Taschenlampe einfach ein- und auszuschalten, mussten diese drei Modi jedes Mal sortiert werden.  Außerdem hat diese Taschenlampe beim Einschalten die Batterie bis zum letzten Mal entladen - so dass ein Paar meiner 18650-Dosen tief entladen wurde. </p><br><p>  All dies war unangenehm und nervig, also entschied ich mich irgendwann, meinen Fahrer dafür zu machen, was die weitere Geschichte sein wird. </p><br><div class="spoiler">  <b class="spoiler_title">Taschenlampe mit einem alten Fahrer</b> <div class="spoiler_text"><p>  <em>Hier ist eine Taschenlampe, mit der sich wahrscheinlich viele ähnlich befasst haben</em> <br><img src="https://habrastorage.org/webt/lp/8j/cy/lp8jcyodmsrehdop-qawqouaw-g.jpeg"></p><br><p>  <em>Es sieht aus wie der ursprüngliche Treiber</em> <br><img src="https://habrastorage.org/webt/g-/cr/-w/g-cr-w88dmljau5oknxtpcxbrmu.jpeg"></p></div></div><br><h2 id="tehnicheskoe-zadanie">  Technische Aufgabe </h2><br><p>  Wie Sie wissen, sollte jede Entwicklung gute technische Spezifikationen haben, um ein gutes Ergebnis zu erzielen. Deshalb werde ich versuchen, sie für mich selbst zu formulieren.  Der Fahrer sollte also: </p><br><ul><li>  Ein- und Ausschalten durch kurzes Drücken einer Taste (eine Taste ohne Fixierung).  Vielleicht ist dies der Hauptgrund, warum das alles begann. </li><li>  Haben Sie eine sanfte (stufenlose) Helligkeitsregelung, von der hellsten - "Turbo" bis "Mondlicht", wenn die Diode kaum leuchtet.  Die Helligkeit sollte sich gleichmäßig ändern. </li><li>  Denken Sie an die eingestellte Helligkeit für die freie Zeit. </li><li>  Überwachen Sie die Batterieladung, warnen Sie, wenn sie fast entladen ist (ca. 3,3 V) und schalten Sie sie aus, wenn sie vollständig entladen ist (ca. 2,9 V).  Bei verschiedenen Batterien können diese Parameter unterschiedlich sein.  Dementsprechend sollte die Betriebsspannung im Bereich von 2,7 bis 4,5 V liegen. </li><li>  Haben Sie 2 spezielle Modi - Notsignal und Blitz (na ja, warum nicht?) </li><li>  Um die hintere LED ein- und ausschalten zu können (dies gilt, wenn Sie nachts Fahrrad fahren, so etwas wie eine Begrenzungsleuchte). </li><li>  Schutz gegen Verpolung und statische Elektrizität.  Nicht unbedingt, aber es wird eine schöne Ergänzung sein, denn im Dunkeln können Sie den Akku fälschlicherweise auf die falsche Seite legen. </li><li>  Seien Sie kleiner als der ursprüngliche Treiber, haben Sie aber den gleichen Platzbedarf.  Der chinesische Fahrer ist einfach riesig, es wird nicht einfach sein, ihn größer zu machen. </li></ul><br><p>  Wenn die Taschenlampe modifiziert ist, warum nicht ein Ladegerät mit einem Micro-USB-Anschluss einbauen?  Ich habe immer ein solches Kabel und ein USB-Ladegerät zur Hand und muss nach einem nativen Netzteil suchen. </p><br><h2 id="zhelezo">  Eisen </h2><br><p>  Ich habe einige Erfahrungen mit Arduino, daher wurde beschlossen, einen Fahrer für die AVR-Familie MK zu bauen.  Sie sind weit verbreitet, einfach zu programmieren und verfügen über einen Energiesparmodus (Schlafmodus). </p><br><p>  Der Attiny13a-Mikrocontroller wurde als „Gehirn“ des Fahrers ausgewählt - er ist einer der billigsten Atmel-MCs (jetzt von Microchip absorbiert), er hat alles an Bord - ein GPIO zum Anschließen einer Taste und einer LED, ein Timer zum Erzeugen eines PWM-Signals, ein ADC zum Messen Spannung und EEPROM zum Speichern von Parametern.  Es steht nur 1 KB Flash-Speicher zur Verfügung (aber wie viel wird für eine Taschenlampe benötigt) sowie 64 B RAM und die gleiche Menge an EEPROM. <br>  Attiny13 ist in verschiedenen Gehäuseoptionen erhältlich, insbesondere in DIP-8, die direkt in ein normales Steckbrett mit einem Abstand von 2,54 mm eingesetzt werden können. </p><br><p>  Da nur 3 Drähte von der Rückseite zum Kopf der Taschenlampe verlaufen und der Knopf gegen Masse kurzgeschlossen werden muss (wegen der Unmöglichkeit eines Kurzschlusses mit Plus - später), müssen Sie die LED im Plus schalten - was bedeutet, dass Sie einen P-Kanal-Pol benötigen.  Ich habe AO3401 als solchen Transistor genommen, aber Sie können SI2323 nehmen, es ist teurer, hat aber weniger offenen Kanalwiderstand (40 mOhm, während AO3401 60 mOhm bei 4,5 V hat), daher erwärmt sich der Treiber weniger. </p><br><p>  <em>Von Worten bis zu Taten sammle ich auf einem Steckbrett eine vorläufige Version</em> <br><img src="https://habrastorage.org/webt/6g/tx/89/6gtx89n9apulzr9kwouv9v-vkn8.jpeg"></p><br><p>  Es wird derzeit direkt vom Programmierer mit einer Spannung von 5 V betrieben (tatsächlich weniger aufgrund von Verlusten im USB-Kabel).  Anstelle der LED hat der XM-L bisher eine normale LED an die Beine geklebt und einen schwachen Transistor mit einer hohen Schwellenspannung angebracht. <br>  Dann wurde im Altium Designer-Programm ein Diagramm gezeichnet, das ich durch Schutz gegen Verpolung und ESD ergänzte. </p><br><p><img src="https://habrastorage.org/webt/nt/cv/re/ntcvrepefjh36tyfclmcwze_e4o.png"></p><br><div class="spoiler">  <b class="spoiler_title">Detaillierte Beschreibung und Zweck aller Komponenten</b> <div class="spoiler_text"><h4 id="obyazatelnye-komponenty">  Voraussetzungen: </h4><br><p>  U1 - Attiny13a Mikrocontroller im 8S1-Paket (SSU-Index) </p><br><p>  C1 - Entkopplungskondensator für die Stromversorgung des Mikrocontrollers sollte im Bereich von 0,1 Mikrofarad, Fall 1206 oder 0805, Temperaturkoeffizient X7R liegen </p><br><p>  R1-R2 ist ein Widerstandsteiler zur Messung der Batteriespannung. Hier können beliebige Nennwerte eingestellt werden, hier das Hauptverhältnis (750K / 220K, Teilungsverhältnis 4,41) und der Leckstrom, die größer sind, wenn die Nennwerte erhöht werden (bei Strom beträgt sie etwa 4 μA).  Da ein interner ION verwendet wird (1,1 V, laut Datenblatt kann er zwischen 1,0 V und 1,2 V liegen), sollte die maximale Spannung am Ausgang des Teilers nicht mehr als 1 V betragen. Bei einem Teiler 750/220 beträgt die maximal zulässige Spannung am Eingang des Teilers 4,41 V. mehr als genug für alle Arten von Lithiumbatterien. <br>  Ich habe den Teiler mit diesem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Rechner berechnet</a> . </p><br><p>  R3 - schützt den Ausgang des Mikrocontroller-Ports vor einem Kurzschluss (wenn PB1 plötzlich auf VCC gezogen wird, fließt ein großer Strom durch den Pin und der MC kann durchbrennen). </p><br><p>  R4 - RESET MK an die Stromversorgung ziehen, ohne es ist ein Neustart von Tonabnehmern möglich. </p><br><p>  Q1 - P-Kanal-Feldeffekttransistor im SOT-23-Gehäuse, ich habe den AO3401 installiert, aber jeden anderen mit einer geeigneten Pinbelegung (z. B. SI2323) </p><br><p>  R7 ist ein Strombegrenzungs-Gate-Widerstand.  Da das Gate des Transistors eine bestimmte Kapazität hat, kann beim Laden dieser Kapazität ein großer Strom durch den Pin fließen und der Pin kann ausfallen.  Sie können ihn im Bereich von 100-220 Ohm einstellen (es sollte nicht mehr sein, der Transistor wird für eine lange Zeit in einem halb geschlossenen Zustand sein und sich infolgedessen mehr erwärmen). </p><br><p>  R6 - Widerstands-Pull-Up-Verschluss zur Stromversorgung.  Wenn PB0 in einen hochohmigen Zustand übergeht, wird Logik 1 über diesen Widerstand am Gate Q1 installiert und der Transistor wird geschlossen.  Dies kann aufgrund eines Fehlers im Code oder im Programmiermodus geschehen. </p><br><p>  D2 - "Verriegelungs" -Diode - ermöglicht ein "Durchhängen" der Spannung (wenn die LED für kurze Zeit bei voller Helligkeit aufleuchtet), um den MK für eine Weile vom Kondensator zu speisen, und schützt auch vor Verpolung. <br>  Sie können jede Schottky-Diode mit einem minimalen Spannungsabfall in das SOD323-Gehäuse einbauen, ich habe BAT60 eingesetzt. </p><br><p>  Anfänglich wurde am Feldeffekttransistor ein Schutz gegen Verpolung der Stromversorgung vorgenommen (dies ist auf den durch Beute hergestellten Platinen zu sehen).  Nach der Verkabelung trat ein unangenehmes Merkmal auf: Beim Einschalten der Last trat ein Spannungsabfall auf und der MK wurde neu gestartet, da der Außendienstmitarbeiter den Strom nicht in die entgegengesetzte Richtung begrenzt.  Zuerst habe ich einen 200 uF Elektrolytkondensator zwischen VCC und GND gelötet, aber diese Lösung hat mir wegen ihrer Größe nicht gefallen.  Ich musste den Transistor löten und eine Diode an seine Stelle setzen, da der SOT-23 und der SOD-323 ähnliche Abmessungen haben. </p><br><p>  Insgesamt sind in der Schaltung nur 10 Komponenten für die Installation erforderlich. </p><br><h4 id="neobyazatelnye-komponenty">  Optionale Komponenten: </h4><br><p>  R5 und D1 sind für die Hintergrundbeleuchtung (LED2) verantwortlich.  Die Mindestnennleistung von R5 beträgt 100 Ohm.  Je höher die Bewertung, desto schwächer leuchtet die hintere LED (sie leuchtet im konstanten Modus ohne PWM).  D1 - jede LED im Fall 1206 habe ich grün gesetzt, weil  Optisch sind sie bei gleichen Strömen heller als andere. </p><br><p>  D3 und D4 sind Schutzdioden (TVS), ich habe PESD5V0 (5,0 V) im SOD323-Paket verwendet.  D3 schützt vor Überspannung durch Strom, D4 - per Knopfdruck.  Wenn der Knopf von einer Membran bedeckt ist, hat er keine besondere Bedeutung.  Es lohnt sich wahrscheinlich, bidirektionale Schutzdioden zu verwenden. Andernfalls fließt bei umgekehrter Polarität Strom durch sie und sie brennen aus (siehe CVC einer bidirektionalen Schutzdiode). </p><br><p>  C2 - ein Tantalkondensator in Fall A (ähnlich wie 1206). Es ist sinnvoll, ihn einzustellen, wenn der Treiber instabil ist (die Versorgungsspannung kann bei hohen Schaltströmen der LED gequetscht werden). </p><br><p>  Alle Widerstände der Größe 0603 (für mich ist dies eine angemessene Grenze für das manuelle Löten) </p></div></div><br><p>  Mit den Komponenten ist alles klar, Sie können eine Leiterplatte nach dem obigen Schema herstellen. <br>  Das erste, was zu tun ist, ist ein 3D-Modell der zukünftigen Platine zusammen mit den Löchern zu erstellen - IMHO, in Altium Designer ist dies die bequemste Methode, um die Geometrie der Leiterplatte zu bestimmen. <br>  Ich habe die Abmessungen des alten Treibers und seiner Befestigungslöcher gemessen - die Platine sollte daran befestigt sein, aber kleinere Abmessungen haben (für Vielseitigkeit muss man sie plötzlich woanders bauen). <br>  Ein vernünftiges Minimum ergab sich hier irgendwo um 25x12,5 mm (Seitenverhältnis 2: 1) mit zwei Löchern mit einem Durchmesser von 2 mm für die Befestigung am Lampengehäuse mit nativen Schrauben. </p><br><p>  Ich habe in SolidWorks ein 3D-Modell erstellt und es dann als STEP in Altium Designer exportiert. <br>  Dann habe ich die Komponenten auf die Platine gelegt, die Kontakte in den Ecken hergestellt (es ist bequemer und einfacher, den Boden zu löten), Attiny13 in der Mitte platziert, den Transistor näher an den LED-Kontakten. <br>  Ich breitete die Stromspuren aus, platzierte die restlichen Komponenten, wie sich herausstellte, und teilte die Signalspuren.  Um das Anschließen des Speichers zu vereinfachen, habe ich separate Kontakte herausgebracht, die die Batteriekontakte duplizieren. <br>  Ich habe die gesamte Verkabelung (mit Ausnahme eines Jumpers) auf der obersten Ebene vorgenommen, um mit LUT zu Hause eine Platine herstellen zu können. <br>  Die minimale Breite der Signalpfade beträgt 0,254 mm, die leistungsstarken haben nach Möglichkeit eine maximale Breite. </p><br><p>  <em>So sieht die Kabelplatine in Altium Designer aus</em> <br><img src="https://habrastorage.org/webt/yu/i4/bo/yui4bosmzwqjagvmj_clljr09ck.png"></p><br><p>  Altium Designer hat die Möglichkeit zu sehen, wie das Board in 3D aussehen wird (dazu benötigen Sie Modelle für alle Komponenten, von denen einige selbst erstellt werden mussten). <br>  Vielleicht wird hier jemand sagen, dass der 3D-Modus für den Tracer nicht benötigt wird, aber für mich persönlich ist es eine praktische Funktion, die das Platzieren von Komponenten erleichtert, um das Löten zu vereinfachen. </p><br><p><img src="https://habrastorage.org/webt/my/jk/1r/myjk1rvgvm50odtu4iy77czuy3i.png"></p><br><p>  Zum Zeitpunkt des Schreibens wurden 3 Versionen des Boards hergestellt - die erste für die LUT, die zweite für die industrielle Fertigung und die dritte, endgültig mit einigen Korrekturen. </p><br><h2 id="izgotovlenie-plat">  Brettherstellung </h2><br><h3 id="samodelnyy-sposob">  Selbst gemachter Weg </h3><br><p>  LUT - Laser-Bügeltechnologie, ein Verfahren zur Herstellung von Leiterplatten durch Ätzen einer Maske, die durch Umwandlung von Toner von Papier in Kupfer erhalten wird.  Diese Methode eignet sich hervorragend für einfache, einseitige Boards wie diesen Treiber. <br>  Das Netzwerk hat viele Artikel zu dieser Technologie, daher werde ich nicht auf Details eingehen, sondern Ihnen nur kurz sagen, wie ich es mache. </p><br><p>  Zuerst müssen Sie eine Vorlage vorbereiten, die auf Thermopapier gedruckt wird.  Ich exportiere die Ebene top_layer als PDF und erhalte ein Vektorbild. </p><br><p><img src="https://habrastorage.org/webt/lq/f3/dm/lqf3dmub3ivxcx3y32uijk9dy2a.png"></p><br><p>  Da die Platine klein ist, ist es sinnvoll, ein Stück Leiterplatte mit um ein Vielfaches größeren Abmessungen zu nehmen und das zu tun, was die Industrie als Verkleidung bezeichnet. <br>  Für diese Zwecke ist CorelDraw sehr praktisch, Sie können jedoch jeden anderen Vektoreditor verwenden. <br>  Ich lege Kopien von Vorlagen auf das Dokument, mache 0,5-1 mm Lücken zwischen den Brettern (dies hängt von der Trennmethode ab, dazu später mehr), die Bretter sollten symmetrisch angeordnet sein - sonst ist es schwierig, sie zu trennen. </p><br><p>  Ich nehme ein Stück einseitige Leiterplatte mit Abmessungen, die etwas größer als die zusammengebaute Platte sind, reinige und entfette (ich reibe lieber mit einem Radiergummi und dann mit Alkohol).  Ich drucke eine Vorlage zum Ätzen auf Thermopapier (hier ist es wichtig, nicht zu vergessen, die Vorlage zu spiegeln). <br>  Mit Hilfe eines Bügeleisens und Geduld, die sanft auf Papier streicheln, übersetze ich es in Textolit.  Ich warte bis es abgekühlt ist und ziehe das Papier vorsichtig ab. <br>  Freie Kupferflächen (nicht mit Toner beschichtet) können lackiert oder abgeklebt werden (je kleiner die Kupferfläche ist, desto schneller ist die Ätzreaktion). </p><br><p>  <em>Eine solche Heimverkleidung - eine große Anzahl von Platinen kann Herstellungsfehler ausgleichen</em> <br><img src="https://habrastorage.org/webt/ob/f-/fk/obf-fkjp7lq5fcrxrr_x7rprgw8.jpeg"></p><br><p>  Ich vergifte die Bretter mit Zitronensäure in einer Lösung von Wasserstoffperoxid. Dies ist der günstigste Weg, obwohl er ziemlich langsam ist. <br>  Die Anteile sind wie folgt: Für 100 ml Peroxid sind 3% 30 g Zitronensäure und etwa 5 g Salz, alles wird gemischt und in einen Behälter mit Textolit gegossen. <br>  Das Erwärmen der Lösung beschleunigt die Reaktion, kann jedoch dazu führen, dass sich der Toner ablöst. </p><br><p>  <em>Unbekannte chemische Magie beginnt: Kupfer ist mit Blasen bedeckt und die Lösung nimmt einen blauen Farbton an</em> <br><img src="https://habrastorage.org/webt/bc/jh/pz/bcjhpzjgqcrcmqq1wr8j_def1yw.jpeg"></p><br><p>  Nach einiger Zeit nehme ich die geätzte Platte heraus und reinige sie von Toner.  Ich kann es nicht mit Lösungsmitteln abwaschen, daher entferne ich es mechanisch mit feinkörnigem Schmirgelpapier. </p><br><p>  Jetzt muss die Platte noch verzinnt werden - dies hilft beim Löten, schützt Kupfer vor Oxidation und erleichtert das Löten.  Ich bevorzuge das Verzinnen mit der Rose-Legierung - diese Legierung schmilzt bei einer Temperatur von etwa 95 Grad, wodurch sie in kochendem Wasser verzinnt werden kann (ja, vielleicht nicht die zuverlässigste Zusammensetzung zum Verzinnen, aber für hausgemachte Leiterplatten). </p><br><p><img src="https://habrastorage.org/webt/a5/fs/lk/a5fslka8zacdyhd2mrfad4irlx0.jpeg"></p><br><p>  Nach dem Verzinnen bohre ich ein Brett (für Kontakte verwende ich Hartmetallbohrer f1.0, für Jumper - f0.7), ich bohre mit einem Dremel, weil ich kein anderes Werkzeug habe.  Ich mag es nicht, Textolit wegen des Staubes zu schneiden, deshalb schneide ich nach dem Bohren die Bretter mit einem Büromesser - auf beiden Seiten mache ich mehrere Schnitte in einer Linie und breche sie dann in einen Schnitt.  Dies erinnert an die in der Industrie verwendete V-Cut-Methode, nur dass eine Mühle einen Einschnitt macht. </p><br><p>  <em>Es sieht aus wie eine Platine, die zum Löten bereit ist</em> <br><img src="https://habrastorage.org/webt/xw/3v/6n/xw3v6ns0nrje-n8saj5gobrvces.jpeg"></p><br><p>  Wenn die Karte fertig ist, können Sie mit der Verkabelung der Komponenten beginnen.  Zuerst löte ich eine Kleinigkeit (Widerstände 0603), dann alles andere.  Widerstände befinden sich neben dem MK, so dass das Löten in umgekehrter Reihenfolge problematisch sein kann.  Nach dem Löten überprüfe ich, ob ein Kurzschluss für die Stromversorgung des Treibers vorliegt. Danach kann die Firmware MK bereits gestartet werden. </p><br><p>  <em>Treiber zum Herunterladen der Firmware bereit</em> <br><img src="https://habrastorage.org/webt/4u/au/jk/4uaujk48pqllmzplxcxuy_yfig8.jpeg"></p><br><h3 id="promyshlennyy-sposob">  Industrieller Weg </h3><br><p>  LUT ist schnell und erschwinglich, aber die Technologie hat ihre Nachteile (wie fast alle PP-Herstellungsmethoden für zu Hause).  Es ist problematisch, ein doppelseitiges Brett herzustellen, die Schienen können geätzt werden und man kann nur davon träumen, die Löcher zu metallisieren. </p><br><p>  Glücklicherweise bieten unternehmungslustige Chinesen seit langem Dienstleistungen für die industrielle Herstellung von Leiterplatten an. <br>  Seltsamerweise kostet eine chinesische einschichtige Platine mehr als eine zweilagige Platine, daher habe ich beschlossen, der Leiterplatte eine zweite (untere) Schicht hinzuzufügen.  Strompfade und Masse werden auf dieser Schicht dupliziert.  Es wurde auch möglich, aus dem Transistor (Kupferpolygone auf der unteren Schicht) einen Kühlkörper herzustellen, der es dem Treiber ermöglicht, mit höheren Strömen zu arbeiten. </p><br><p>  <em>Die unterste Ebene der Platine in Altium Designer</em> <br><img src="https://habrastorage.org/webt/x0/hf/b9/x0hfb9uk6flm6d7pat30fzm9lyu.png"></p><br><p>  Für dieses Projekt habe ich beschlossen, eine Leiterplatte auf der PcbWay-Website zu bestellen.  Die Website verfügt über einen praktischen Taschenrechner zur Berechnung der Kosten von Brettern in Abhängigkeit von ihren Parametern, Größen und Mengen.  Nachdem ich die Kosten berechnet hatte, lud ich die zuvor in Altium Designer erstellte Gerber-Datei herunter, die Chinesen überprüften sie und das Board ging in Produktion. </p><br><p>  Die Herstellung eines Satzes von 10 TinyFL-Boards kostete mich 5 US-Dollar.  Bei der Registrierung eines neuen Benutzers wird für die erste Bestellung ein Rabatt von 5 USD gewährt, sodass ich nur für den Versand bezahlt habe, der ebenfalls ungefähr 5 USD kostet. <br>  Auf dieser Site besteht die Möglichkeit, das Projekt öffentlich zugänglich zu machen. Wenn also jemand diese Boards bestellen möchte, können Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dieses Projekt</a> einfach in den Warenkorb legen. </p><br><p>  Nach ein paar Wochen kamen nur die gleichen Boards zu mir <del>  hübsch </del>  industriell hergestellt.  Sie können nur entpackt und mit der Firmware ausgefüllt werden. </p><br><p><img src="https://habrastorage.org/webt/lp/j7/jk/lpj7jktyacb_h-atbtpze-9qzcw.jpeg"></p><br><h2 id="programma-proshivka">  Programm (Firmware) </h2><br><p>  Die Hauptschwierigkeit, die beim Schreiben der Treiberfirmware auftrat, ist die extrem geringe Größe des Flash-Speichers - Attiny13 hat nur 1024 Bytes. <br>  Da die Helligkeitsänderung gleichmäßig ist, bestand eine nicht triviale Aufgabe darin, sie gleichmäßig zu ändern - dafür mussten wir eine Gammakorrektur durchführen. </p><br><h4 id="algoritm-upravleniya-drayverom">  Treibersteuerungsalgorithmus </h4><br><p>  Der Fahrer schaltet sich durch kurzes Drücken der Taste ein, er schaltet sich dadurch aus. <br>  Der ausgewählte Helligkeitsmodus wird für die Dauer des Herunterfahrens gespeichert. </p><br><p>  Wenn Sie während des Betriebs zweimal kurz drücken (Doppelklick), wird die zusätzliche LED ein- und ausgeschaltet. <br>  Durch langes Drücken während des Betriebs ändert sich die Helligkeit der Lampe allmählich.  Wiederholtes langes Drücken ändert die Richtung (stärker / schwächer). </p><br><p>  Der Fahrer überprüft regelmäßig die Batteriespannung. Wenn diese unter den eingestellten Werten liegt, warnt er den Benutzer vor einer Entladung und schaltet sich dann aus, um eine tiefe Entladung zu vermeiden. </p><br><div class="spoiler">  <b class="spoiler_title">Eine detailliertere Beschreibung des Treiberalgorithmus</b> <div class="spoiler_text"><ol><li>  Wenn der MK mit Strom versorgt wird, werden Peripheriegeräte eingerichtet und der MK geht in den Ruhezustand (wenn STARTSLEEP definiert ist).  Wenn der Treiber mit Strom versorgt wird, blinken beide LEDs eine bestimmte Anzahl von Malen, wenn STARTBLINKS definiert ist. </li><li>  Schlaf  Attiny13 schläft im Power-Down-Modus ein (dies ist der wirtschaftlichste Modus, laut Datenblatt beträgt der MK-Verbrauch ~ 1 μA), aus dem es nur durch eine Unterbrechung austreten kann.  In diesem Fall handelt es sich um einen INT0-Interrupt - Drücken einer Taste (Setzen von PC1 auf logische 0). <br>  Auf PC1 sollte ein internes schwaches Pull-up aktiviert sein.  Der ADC und der Komparator sind die Hauptverbraucher von Strom aus der gesamten Peripherie, daher müssen sie auch ausgeschaltet werden.  Während des Ruhezustands werden die Inhalte der Register und des RAM gespeichert, sodass das EEPROM nicht benötigt wird, um sich an die Helligkeit zu erinnern. </li><li>            ,          . </li><li>    —   . <br>  4.1.    —    ( BTN_DBCLICK ). <br>   ,    LED2 <br>  ,    .2 () <br>  4.2.    (,  BTN_ONOFF_DELAY) —    .   : <br><ul><li>    (/)   %  ,   . </li><li>   /  (RATE_MAX / RATE_MIN),   ; </li><li>   n- (AUXMODES_DELAY)     ,   .    —  (   25 ,  8 )    (     50,  1 ).        ,     -    . </li></ul></li><li>       —    ADC2,     . <br><ul><li>      BAT_WARNING –   </li><li>   BAT_WARNING –    ,    . -     . ,         5 . </li><li>   BAT_SHUTDOWN —    .2 (). </li></ul></li></ol></div></div><br><h4 id="upravlenie-yarkostyu-svetodioda">    </h4><br><p>  ,      —   ,     -     ,  . -    ,     ,       .     P-  ,        ,    — ,  .               . <br>      rate, 255 rate = 100% . <br>    1.2      1,     1200000/256 = 4.7 .     (  ),         (,   ,  ,   ).  ,      9.6 (CKSEL[1:0]=10, CKDIV8=1)  4.8  (CKSEL[1:0]=01, CKDIV8=1),      8   4  ,       . </p><br><p> ,         ,         .     ,      (      )      ,         ,  ,               1.5 ,   2        (   Cree XM-L   — 3 ). <br>               ,     (rate=255)     3.          ,        .   ,    RATE_MAX     .   ,     SI2323DS      4 ,     2 ,     . </p><br><h4 id="gamma-korrekciya"> - </h4><br><p>      .     ,   5-10%       ,     75-100%      .     ,   n   ,  ,            ,        . </p><br><p>   ,          -.    ,       1      12   .       ,      rate_step_array.  , ,       . </p><br><h4 id="kontrol-napryazheniya-batarei">    </h4><br><p>  n- (      BAT_PERIOD)    .   ,    VIN      R1-R2,       PB4 (  ADC2   ). </p><br><p>        ,    ,      Vref,          1.1 .        —     ,      (,  1.1       1023  255,   8- ).   ,        6   ,  255     1.1 ,   4.33  (  4.03),      . </p><br><p>     ,        .    BAT_WARNING       (  ,    —    BAT_INFO_STEP,   ),    BAT_SHUTDOWN  . <br>         , ..    ,      . </p><br><p> ,     ,      . ,   4.03  R1 = 1M  R2 = 330,    R = 1330K     4  = 3 . <br>      ()    1 .      ,    ,     (  -       —  ). </p><br><h4 id="vnesenie-izmeneniy-v-proshivku">     </h4><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist nicht schwer zu tun, insbesondere wenn Sie Erfahrung mit Arduino oder nur mit C / C ++ hatten. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selbst wenn es keine solche Erfahrung gab, können Sie fast alle Betriebsparameter konfigurieren, indem Sie die Definitionen der Header-Datei flashlight.h bearbeiten. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um den Quellcode zu bearbeiten, müssen Sie eine Arduino IDE mit Unterstützung für Attiny13 (a) oder Atmel Studio installieren - es ist nicht komplizierter als die Arduino IDE, aber viel praktischer.</font></font></p><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino IDE</font></font></b> <div class="spoiler_text"><p>      Attiny13  IDE.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> . <br>      Tools&gt;Board Attiny13(a)    Tools&gt;Frequency 1.2MHz. <br> ""      .ino,       —      .   ,   —      Arduino IDE.       - ,    .cpp. <br>       ,  ,          *.hex.        . </p></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atmel Studio</font></font></b> <div class="spoiler_text"><p>    IDE    flashlight.atsln,   —   flashlight.h   ()  flashlight.cpp   . <br>         —    . <br>        F7,   ( ,   ,  ).   debug  flashlight.hex,        . </p></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laden Sie die Firmware auf den Mikrocontroller herunter</font></font></b> <div class="spoiler_text"><p>          USBASP     AVRDUDEPROG.      GUI   avrdude,      —      .       (   Attiny13(a),    Fuses    read.   ,      ,   .     programm,      .       flashlight.h </p><br><p><script type="text/javascript">function gtElInit() {var lib = new google.translate.TranslateService();lib.translatePage('ru', 'de', function () {});}</script><script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=gtElInit&amp;client=wt"></script> Um Firmware hochzuladen, gehen Sie zur Registerkarte Programm, wählen Sie die kompilierte Firmware-Datei im HEX-Format (flashlight.hex) in der Flash-Zeile aus und klicken Sie auf Programm.  Der Firmware-Status wird im folgenden Fenster angezeigt.  Wenn der Download nicht erfolgreich ist, handelt es sich möglicherweise um einen schlechten Kontakt. Es lohnt sich, es erneut zu versuchen.  Aus diesem Grund wurde übrigens der Parameter STARTBLINKS erstellt - ein einziges Blinken von LED2 zum Zeitpunkt der Stromversorgung des Fahrers dient als Hinweis auf den Kontakt des Fahrers mit dem Programmierer. <br>  Anstelle von USBASP können Sie mit Arduino Firmware herunterladen. Weitere Details finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> </p><br><p>  <em>USBASP-Programmierer, der über einen Clip mit einer Schleife mit dem Treiber verbunden ist</em> <br><img src="https://habrastorage.org/webt/7f/b2/sy/7fb2syr5zqnwqejhoqpxqqa_-vw.jpeg"></p><br><p>  Um USBASP an eine Tinka anzuschließen, verwende ich einen Clip für ein 8-poliges SOIC.  Kein sehr praktisches Gerät, Sie müssen 10 Minuten quälen, bevor Sie den Kontakt fangen (vielleicht bin ich gerade auf einen defekten Clip gestoßen).  Es gibt auch SOIC-DIP-Adapter, bei denen die Mikroschaltung vor dem Löten eingesetzt und die Firmware hineingegossen wird. Diese Option ist bequemer, aber die Möglichkeit, den Treiber im Stromkreis zu programmieren, geht verloren (dh die Firmware wird nach dem Löten des MK auf die Platine aktualisiert). <br>  Wenn all dies nicht vorhanden ist, können Sie die Drähte einfach an die Klemmen des MK anlöten, die dann am Arduino befestigt werden. </p></div></div><br><h4 id="kalibrovka">  Kalibrierung </h4><br><p>  Die durch den Treiber und die LED fließenden Ströme sollten die Maximalwerte nicht überschreiten.  Für die XM-L-LED sind dies 3 A, für den Treiber hängt es vom verwendeten Transistor ab, zum Beispiel für SI2323 beträgt der maximale Strom etwa 4 A, aber es ist besser, wegen übermäßiger Erwärmung mit niedrigeren Strömen zu fahren.  Um den Strom bei maximaler Helligkeit zu reduzieren, wird der Parameter RATE_MAX verwendet (#define RATE_MAX xx, wobei xx die maximale Helligkeit von 0 bis 255 ist). <br>  Die Kalibrierung des ADC ist kein obligatorisches Verfahren. Wenn Sie jedoch möchten, dass der Fahrer die Schwellenspannung genau überwacht, müssen Sie daran basteln. </p><br><p>  Die Berechnungen ergeben keine hohe Genauigkeit der Messungen, da zum einen die Widerstände innerhalb der Toleranz variieren können (normalerweise 1 bis 5%) und zum anderen das interne Ion eine Streuung von 1,0 bis 1,2 V aufweisen kann. <br>  Daher ist der einzig akzeptable Weg, den Wert in ADC-Einheiten (BAT_WARNING und BAT_SHUTDOWN) einzustellen und ihn experimentell für den gewünschten auszuwählen.  Dazu benötigen Sie Geduld, einen Programmierer und eine einstellbare Stromquelle. <br>  Ich habe den BAT_PERIOD-Wert in der Firmware auf 1000 gesetzt (einmal pro Sekunde die Spannung prüfen) und die Versorgungsspannung schrittweise reduziert.  Als der Fahrer anfing, vor der Entladung zu warnen, ließ ich den aktuellen Wert von BAT_WARNING nach Bedarf. <br>  Dies ist nicht der bequemste Weg. Möglicherweise müssen Sie in Zukunft ein automatisches Kalibrierungsverfahren durchführen, bei dem die Werte im EEPROM gespeichert werden. </p><br><h2 id="sborka-fonarika">  Taschenlampenmontage </h2><br><p>  Wenn das Board fertig war und die Firmware überflutet war, konnten Sie es endlich anstelle des alten Treibers einsetzen.  Ich löte den alten Treiber und löte einen neuen an seiner Stelle. </p><br><div class="spoiler">  <b class="spoiler_title">Der neue Treiber wird gemäß diesem Schema anstelle des alten Treibers angeschlossen</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ar/7c/6j/ar7c6jgy4zprzi6crl9aogualo8.png"></p></div></div><br><p>  Nachdem ich überprüft hatte, ob das Netzteil kurzgeschlossen war, schloss ich das Netzteil an und überprüfte die Funktionsfähigkeit.  Dann habe ich die Ladekarte (TP4056) montiert, dafür musste ich mit einem kleinen Dremel ein Loch in den Ladeanschluss bohren und es mit Heißkleber befestigen (es war wichtig, dass der Kleber nicht in den Anschluss floss, es wäre schwierig, ihn dort herauszuholen). </p><br><p>  Ich habe die Platine nicht mit Schrauben befestigt, weil das Gewinde im Gehäuse durch wiederholtes Verdrehen gerissen ist, sondern einfach Klebstoff darauf gegossen und auch die Drähte an den Lötstellen aufgeklebt hat, damit sie nicht ausfransen.  Ich beschloss, den Treiber und das Ladegerät mit farblosem Acryllack abzudecken, um Korrosion vorzubeugen. </p><br><p><img src="https://habrastorage.org/webt/5g/qs/do/5gqsdoxgldinymg3njvlpsmnxz8.jpeg"></p><br><h2 id="testirovanie-i-raschet-stoimosti-izgotovleniya">  Prüfung und Berechnung der Herstellungskosten </h2><br><p>  Nach allen Vorgängen konnten die Treiber getestet werden.  Der Strom wurde mit einem herkömmlichen Multimeter gemessen und an den offenen Stromkreis der Stromversorgung angeschlossen. </p><br><p>  Leistungsaufnahme des alten Treibers (gemessen bei 4,04 V): </p><br><ol><li>  Im Schlaf - nicht gemessen </li><li>  Maximaler Modus: 0,60 A. </li><li>  Mittlerer Modus: 0,30 A. </li><li>  Stroboskop: 0,28 A. </li></ol><br><p>  Leistungsaufnahme des neuen Treibers (gemessen bei 4,0 V): </p><br><ol><li>  Im Schlafmodus verbraucht es etwa 4 μA, was viel weniger ist als der Selbstentladestrom einer Lithium-Ionen-Batterie.  Der Hauptstrom in diesem Modus fließt durch einen Widerstandsteiler. </li><li>  Im Minimalmodus beträgt das „Mondlicht“ etwa 5 bis 7 mA. Wenn wir davon ausgehen, dass die Kapazität einer 18650-Zelle etwa 2500 mA * h beträgt, erhalten wir etwa <strong>20 Tage Dauerbetrieb</strong> .  MK selbst verbraucht irgendwo 1,2-1,5 mA (bei einer Betriebsfrequenz von 1,2 MHz). </li><li>  Im Maximalmodus verbraucht "Turbo" ungefähr 1,5 A, in diesem Modus arbeitet es ungefähr anderthalb Stunden.  Die LED an solchen Strömen wird sehr heiß, daher ist dieser Modus nicht für den Langzeitbetrieb vorgesehen. </li><li>  Notsignal - verbraucht durchschnittlich ca. 80 mA. In diesem Modus arbeitet die Taschenlampe bis zu 30 Stunden. </li><li>  Stroboskop - verbraucht ca. 0,35 A, arbeitet bis zu 6 Stunden. </li></ol><br><h4 id="cena-voprosa">  Ausgabepreis </h4><br><p>  Wenn Sie Komponenten in Chip und Deep kaufen, werden ungefähr 100 Rubel ausgegeben (60 Rubel Attiny13, ~ 40 Rubel der Rest des losen Pulvers).  Es ist sinnvoll, aus China zu bestellen, wenn mehrere Stücke hergestellt werden - dann ist es in Bezug auf ein Stück billiger, die Chinesen verkaufen normalerweise in Chargen von 10 Stück oder mehr. <br>  Gebühren werden zu einem Preis in der Größenordnung von 300 Rubel für 10 Stück (ohne Lieferung) freigegeben, wenn in China bestellt. <br>  Das Verkabeln und Blinken eines Treibers dauert ungefähr eine Stunde. </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Die chinesische Taschenlampe ist viel praktischer geworden, obwohl ich jetzt Beschwerden über ihre Mechanik habe - der vordere Teil ist zu schwer und der Fokus wird nicht wirklich benötigt. <br>  In Zukunft plane ich, eine Version dieses Treibers für Taschenlampen mit einem Netzschalter (mit Fixierung) herzustellen.  Es stimmt, ich bin verwirrt über die Fülle solcher Projekte.  Glaubst du, es lohnt sich, noch einen zu machen? </p><br><p>  <em>Nahaufnahmetreiber (Version 2_t)</em> <br><img src="https://habrastorage.org/webt/2f/sd/sl/2fsdslzywcu7izjgclyshshwjvy.jpeg"></p><br><p>  <strong>UPD</strong> : Unterstützung für Arduino IDE hinzugefügt. </p><br><p>  Der Quellcode für die Firmware, die Schaltung und die Verkabelung der Karte befindet sich jetzt auf dem Github. Sie können ihn hier herunterladen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/madcatdev/tinyfl_t</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de464673/">https://habr.com/ru/post/de464673/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de464657/index.html">Reverse Engineering elektrisches Gesims AM82TV</a></li>
<li><a href="../de464659/index.html">Anwendungssicherheit oder Einbetten von Sicherheit in die benutzerdefinierte Entwicklung. Persönliche Erfahrung bei AGIMA</a></li>
<li><a href="../de464661/index.html">Wem soll der Entwurf der technischen Umrüstung und des Wiederaufbaus anvertraut werden?</a></li>
<li><a href="../de464665/index.html">Partitionierung in SQL Server</a></li>
<li><a href="../de464671/index.html">Empfangen Sie regelmäßig SMS an Viber- und Telegramm-Instant Messenger (über GoIP-Gateways).</a></li>
<li><a href="../de464675/index.html">Analyse der Lokalisierungsmechanismen der Anwendungsschnittstelle in Splunk</a></li>
<li><a href="../de464677/index.html">Investitionen an der Börse und damit verbundene Kosten: Wie hoch sind die Dienstleistungen eines Maklerunternehmens?</a></li>
<li><a href="../de464679/index.html">Voxgun - ein Service zum Erstellen professioneller Videoinhalte ohne zusätzlichen Aufwand</a></li>
<li><a href="../de464685/index.html">Optischer Telegraph, Mikrowellennetz und Tesla-Turm: ungewöhnliche Kommunikationstürme</a></li>
<li><a href="../de464687/index.html">Wenn Sie die Welt retten wollen, ist Veganismus keine Option</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>