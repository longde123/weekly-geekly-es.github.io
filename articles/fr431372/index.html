<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•É „Ä∞Ô∏è üèâ Interruptions √† partir de p√©riph√©riques externes dans un syst√®me x86. Partie 2. Options de d√©marrage du noyau Linux üë©üèº‚Äç‚öñÔ∏è üßùüèª üë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans la partie pr√©c√©dente, nous avons examin√© l'√©volution de la livraison d'interruption √† partir de dispositifs dans des syst√®mes x86 (PIC ‚Üí APIC ‚Üí M...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Interruptions √† partir de p√©riph√©riques externes dans un syst√®me x86. Partie 2. Options de d√©marrage du noyau Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431372/">  Dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie pr√©c√©dente,</a> nous avons examin√© l'√©volution de la livraison d'interruption √† partir de dispositifs dans des syst√®mes x86 (PIC ‚Üí APIC ‚Üí MSI), une th√©orie g√©n√©rale et tous les termes n√©cessaires. <br><br>  Dans cette partie pratique, nous verrons comment revenir √† l'utilisation des m√©thodes de livraison d'interruption Linux h√©rit√©es, √† savoir, consid√©rer les options de d√©marrage du noyau: <br><br><ul><li>  pci = nomsi </li><li>  noapic </li><li>  nolapic </li></ul><br>  Nous verrons √©galement l'ordre dans lequel l'OS regarde les tables de routage d'interruption (ACPI / MPtable / $ PIR) et quel effet cela aura sur l'ajout d'options de d√©marrage: <br><br><ul><li>  pci = noacpi </li><li>  acpi = noirq </li><li>  acpi = off </li></ul><br>  Vous avez peut-√™tre essay√© des combinaisons de toutes ces options lorsqu'un appareil ne fonctionnait pas en raison d'un probl√®me d'interruption.  Voyons ce qu‚Äôils font exactement et comment ils modifient la sortie de / proc / interrupts. <br><a name="habracut"></a><br><h3>  T√©l√©charger sans options suppl√©mentaires </h3><br>  Nous allons observer les interruptions dans cet article sur une carte personnalis√©e avec Intel Haswell i7 avec le chipset lynxPoint-LP sur lequel s'ex√©cute le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">coreboot</a> . <br><br>  Nous afficherons des informations sur les interruptions via la commande <br><br><pre><code class="bash hljs">cat /proc/interrupts</code> </pre> <br>  Sortie au d√©marrage sans options suppl√©mentaires: <br><br><pre> <code class="bash hljs">CPU0 CPU1 CPU2 CPU3 0: 15 0 0 0 IO-APIC-edge timer 1: 0 1 0 1 IO-APIC-edge i8042 8: 0 0 0 1 IO-APIC-edge rtc0 9: 0 0 0 0 IO-APIC-fasteoi acpi 12: 0 0 0 1 IO-APIC-edge 23: 16 247 7 10 IO-APIC-fasteoi ehci_hcd:usb1 56: 0 0 0 0 PCI-MSI-edge aerdrv,PCIe PME 57: 0 0 0 0 PCI-MSI-edge aerdrv,PCIe PME 58: 0 0 0 0 PCI-MSI-edge aerdrv,PCIe PME 59: 0 0 0 0 PCI-MSI-edge aerdrv,PCIe PME 60: 0 0 0 0 PCI-MSI-edge aerdrv,PCIe PME 61: 0 0 0 0 PCI-MSI-edge aerdrv,PCIe PME 62: 3118 1984 972 3454 PCI-MSI-edge ahci 63: 1 0 0 0 PCI-MSI-edge eth59 64: 2095 57 4 832 PCI-MSI-edge eth59-rx-0 65: 6 18 1 1309 PCI-MSI-edge eth59-rx-1 66: 13 512 2 1 PCI-MSI-edge eth59-rx-2 67: 10 61 232 2 PCI-MSI-edge eth59-rx-3 68: 169 0 0 0 PCI-MSI-edge eth59-tx-0 69: 14 14 4 205 PCI-MSI-edge eth59-tx-1 70: 11 491 3 0 PCI-MSI-edge eth59-tx-2 71: 20 19 134 50 PCI-MSI-edge eth59-tx-3 72: 0 0 0 0 PCI-MSI-edge eth58 73: 2 1 0 152 PCI-MSI-edge eth58-rx-0 74: 3 150 2 0 PCI-MSI-edge eth58-rx-1 75: 2 34 117 2 PCI-MSI-edge eth58-rx-2 76: 153 0 2 0 PCI-MSI-edge eth58-rx-3 77: 4 0 2 149 PCI-MSI-edge eth58-tx-0 78: 4 149 2 0 PCI-MSI-edge eth58-tx-1 79: 4 0 117 34 PCI-MSI-edge eth58-tx-2 80: 153 0 2 0 PCI-MSI-edge eth58-tx-3 81: 66 106 2 101 PCI-MSI-edge snd_hda_intel 82: 928 5657 262 224 PCI-MSI-edge i915 83: 545 56 32 15 PCI-MSI-edge snd_hda_intel NMI: 0 0 0 0 Non-maskable interrupts LOC: 4193 3644 3326 3499 Local timer interrupts SPU: 0 0 0 0 Spurious interrupts PMI: 0 0 0 0 Performance monitoring interrupts IWI: 290 233 590 111 IRQ work interrupts RTR: 3 0 0 0 APIC ICR <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> retries RES: 1339 2163 2404 1946 Rescheduling interrupts CAL: 607 537 475 559 Function call interrupts TLB: 163 202 164 251 TLB shootdowns TRM: 48 48 48 48 Thermal event interrupts THR: 0 0 0 0 Threshold APIC interrupts MCE: 0 0 0 0 Machine check exceptions MCP: 3 3 3 3 Machine check polls ERR: 0 MIS: 0</code> </pre><br>  Le fichier / proc / interrupts fournit un tableau sur le nombre d'interruptions sur chaque processeur sous la forme suivante: <br><br><ul><li>  Premi√®re colonne: num√©ro d'interruption </li><li>  Haut-parleurs CPUx: compteurs d'interruption sur chaque processeur </li><li>  Colonne suivante: type d'interruption: <br><ul><li>  IO-APIC-edge - interruption de front au contr√¥leur I / O APIC </li><li>  IO-APIC-fasteoi - interruption de niveau par contr√¥leur d'E / S APIC </li><li>  PCI-MSI-edge - interruption MSI </li><li>  XT-PIC-XT-PIC - interruption sur le contr√¥leur PIC (voir plus loin) </li></ul></li><li>  Derni√®re colonne: appareil associ√© √† cette interruption </li></ul><br>  Ainsi, comme cela devrait √™tre le cas dans un syst√®me moderne, ils sont utilis√©s pour les p√©riph√©riques et les pilotes qui prennent en charge les interruptions MSI / MSI-X.  Les autres interruptions sont achemin√©es via l'APIC d'E / S. <br><br>  Le sch√©ma de routage d'interruption simplifi√© peut √™tre trac√© comme ceci (chemins actifs marqu√©s en rouge, chemins inutilis√©s en noir). <br><br><img src="https://habrastorage.org/webt/pb/ej/7c/pbej7cfkiyscux6fzyttfbi99my.png"><br><br>  La prise en charge d'un p√©riph√©rique MSI / MSI-X doit √™tre √©tiquet√©e comme capacit√© correspondante dans son espace de configuration PCI. <br><br>  En confirmation, nous donnons un petit fragment de la sortie lspci pour les appareils pour lesquels il est indiqu√© qu'ils utilisent MSI / MSI-X.  Dans notre cas, il s'agit d'un contr√¥leur SATA (interruption ahci), de 2 contr√¥leurs ethernet (interruptions eth58 * et eth59 *), d'un contr√¥leur graphique (i915) et de 2 contr√¥leurs HD Audio (snd_hda_intel). <br><br><pre> <code class="bash hljs">lspci -v</code> </pre> <br><pre> <code class="bash hljs">00:02.0 VGA compatible controller: Intel Corporation Haswell-ULT Integrated Graphics Controller (rev 09) (prog-if 00 [VGA controller]) ... Capabilities: [90] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [d0] Power Management version 2 Capabilities: [a4] PCI Advanced Features Kernel driver <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> use: i915 00:03.0 Audio device: Intel Corporation Haswell-ULT HD Audio Controller (rev 09 ... Capabilities: [60] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [70] Express Root Complex Integrated Endpoint, MSI 00 Kernel driver <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> use: snd_hda_intel 00:1b.0 Audio device: Intel Corporation 8 Series HD Audio Controller (rev 04) ... Capabilities: [60] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [70] Express Root Complex Integrated Endpoint, MSI 00 Capabilities: [100] Virtual Channel Kernel driver <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> use: snd_hda_intel 00:1f.2 SATA controller: Intel Corporation 8 Series SATA Controller 1 [AHCI mode] (rev 04) (prog-if 01 [AHCI 1.0]) ... Capabilities: [80] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [70] Power Management version 3 Capabilities: [a8] SATA HBA v1.0 Kernel driver <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> use: ahci 05:00.0 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) ... Capabilities: [50] MSI: Enable- Count=1/1 Maskable+ 64bit+ Capabilities: [70] MSI-X: Enable+ Count=10 Masked- Capabilities: [a0] Express Endpoint, MSI 00 Kernel driver <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> use: igb 05:00.1 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) ... Capabilities: [50] MSI: Enable- Count=1/1 Maskable+ 64bit+ Capabilities: [70] MSI-X: Enable+ Count=10 Masked- Capabilities: [a0] Express Endpoint, MSI 00 Kernel driver <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> use: igb</code> </pre> <br>  Comme nous pouvons le voir, ces appareils ont la ligne ¬´MSI: Enable +¬ª ou ¬´MSI-X: Enable +¬ª <br><br>  Commen√ßons √† d√©grader le syst√®me.  Tout d'abord, d√©marrez avec l'option pci = nomsi. <br><br><h3>  pci = nomsi </h3><br>  Avec cette option, les interruptions MSI deviendront IO-APIC / XT-PIC selon le contr√¥leur d'interruption utilis√©. <br><br>  Dans ce cas, nous avons toujours le contr√¥leur d'interruption APIC prioritaire, donc l'image sera comme ceci: <br><br><img src="https://habrastorage.org/webt/er/ft/jy/erftjybrd7rm61bmmmhcs3qfzni.png"><br><br>  La sortie de / proc / interrupts: <br><br><pre> <code class="bash hljs"> CPU0 CPU1 CPU2 CPU3 0: 15 0 0 0 IO-APIC-edge timer 1: 0 1 0 1 IO-APIC-edge i8042 8: 0 0 1 0 IO-APIC-edge rtc0 9: 0 0 0 0 IO-APIC-fasteoi acpi 12: 0 0 0 1 IO-APIC-edge 16: 1314 5625 342 555 IO-APIC-fasteoi i915, snd_hda_intel, eth59 17: 5 0 1 34 IO-APIC-fasteoi eth58 21: 2882 2558 963 2088 IO-APIC-fasteoi ahci 22: 26 81 2 170 IO-APIC-fasteoi snd_hda_intel 23: 23 369 8 8 IO-APIC-fasteoi ehci_hcd:usb1 NMI: 0 0 0 0 Non-maskable interrupts LOC: 3011 3331 2435 2617 Local timer interrupts SPU: 0 0 0 0 Spurious interrupts PMI: 0 0 0 0 Performance monitoring interrupts IWI: 197 228 544 85 IRQ work interrupts RTR: 3 0 0 0 APIC ICR <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> retries RES: 1708 2349 1821 1569 Rescheduling interrupts CAL: 520 554 509 555 Function call interrupts TLB: 187 181 205 179 TLB shootdowns TRM: 102 102 102 102 Thermal event interrupts THR: 0 0 0 0 Threshold APIC interrupts MCE: 0 0 0 0 Machine check exceptions MCP: 2 2 2 2 Machine check polls ERR: 0 MIS: 0</code> </pre> <br>  Toutes les interruptions MSI / MSI-X devraient dispara√Ætre.  Au lieu de cela, les appareils utilisent d√©sormais des interruptions IO-APIC-fasteoi. <br><br>  Notez qu'avant l'inclusion de cette option, eth58 et eth59 avaient 9 interruptions chacune!  Et maintenant, un seul √† la fois.  Apr√®s tout, comme nous le rappelons, sans MSI une fonction PCI, une seule interruption est disponible! <br><br>  Quelques informations de dmesg sur l'initialisation des contr√¥leurs Ethernet: <br><br>  - t√©l√©chargement sans option pci = nomsi: <br><br><pre> <code class="bash hljs">igb: Intel(R) Gigabit Ethernet Network Driver - version 5.0.5-k igb: Copyright (c) 2007-2013 Intel Corporation. acpi:acpi_pci_irq_enable: igb 0000:05:00.0: PCI INT A -&gt; GSI 16 (level, low) -&gt; IRQ 16 igb 0000:05:00.0: irq 63 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 64 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 65 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 66 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 67 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 68 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 69 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 70 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 71 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 63 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 64 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 65 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 66 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 67 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 68 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 69 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 70 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: irq 71 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.0: added PHC on eth0 igb 0000:05:00.0: Intel(R) Gigabit Ethernet Network Connection igb 0000:05:00.0: eth0: (PCIe:5.0Gb/s:Width x1) 00:15:d5:03:00:2a igb 0000:05:00.0: eth0: PBA No: 106300-000 igb 0000:05:00.0: Using MSI-X interrupts. 4 rx queue(s), 4 tx queue(s) acpi:acpi_pci_irq_enable: igb 0000:05:00.1: PCI INT B -&gt; GSI 17 (level, low) -&gt; IRQ 17 igb 0000:05:00.1: irq 72 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 73 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 74 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 75 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 76 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 77 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 78 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 79 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 80 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 72 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 73 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 74 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 75 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 76 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 77 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 78 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 79 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: irq 80 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MSI/MSI-X igb 0000:05:00.1: added PHC on eth1 igb 0000:05:00.1: Intel(R) Gigabit Ethernet Network Connection igb 0000:05:00.1: eth1: (PCIe:5.0Gb/s:Width x1) 00:15:d5:03:00:2b igb 0000:05:00.1: eth1: PBA No: 106300-000 igb 0000:05:00.1: Using MSI-X interrupts. 4 rx queue(s), 4 tx queue(s)</code> </pre> <br>  - d√©marrer avec l'option pci = nomsi <br><br><pre> <code class="bash hljs">igb: Intel(R) Gigabit Ethernet Network Driver - version 5.0.5-k igb: Copyright (c) 2007-2013 Intel Corporation. acpi:acpi_pci_irq_enable: igb 0000:05:00.0: PCI INT A -&gt; GSI 16 (level, low) -&gt; IRQ 16 igb 0000:05:00.0: added PHC on eth0 igb 0000:05:00.0: Intel(R) Gigabit Ethernet Network Connection igb 0000:05:00.0: eth0: (PCIe:5.0Gb/s:Width x1) 00:15:d5:03:00:2a igb 0000:05:00.0: eth0: PBA No: 106300-000 igb 0000:05:00.0: Using legacy interrupts. 1 rx queue(s), 1 tx queue(s) acpi:acpi_pci_irq_enable: igb 0000:05:00.1: PCI INT B -&gt; GSI 17 (level, low) -&gt; IRQ 17 igb 0000:05:00.1: added PHC on eth1 igb 0000:05:00.1: Intel(R) Gigabit Ethernet Network Connection igb 0000:05:00.1: eth1: (PCIe:5.0Gb/s:Width x1) 00:15:d5:03:00:2b igb 0000:05:00.1: eth1: PBA No: 106300-000 igb 0000:05:00.1: Using legacy interrupts. 1 rx queue(s), 1 tx queue(s)</code> </pre> <br>  En raison de la r√©duction du nombre d'interruptions par p√©riph√©rique, l'activation de cette option peut limiter consid√©rablement les performances du pilote (cela ne tient pas compte du fait que, selon Intel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Reducing Interrupt Latency Through the Use of Message Signaled Interrupts, les</a> interruptions via MSI sont 3 fois plus rapides que via IO -APIC et 5 fois plus rapide que via PIC). <br><br><h3>  noapic </h3><br>  Cette option d√©sactive les E / S APIC.  Les interruptions MSI peuvent toujours aller √† tous les CPU, mais les interruptions des p√©riph√©riques ne peuvent aller qu'√† CPU0, car le PIC n'est connect√© qu'√† CPU0.  Mais LAPIC fonctionne et d'autres processeurs peuvent fonctionner et g√©rer les interruptions. <br><br><img src="https://habrastorage.org/webt/uw/tf/rt/uwtfrt5lgbpfenyjwb3u_fc4yvq.png"><br><br><pre> <code class="bash hljs"> CPU0 CPU1 CPU2 CPU3 0: 5 0 0 0 XT-PIC-XT-PIC timer 1: 2 0 0 0 XT-PIC-XT-PIC i8042 2: 0 0 0 0 XT-PIC-XT-PIC cascade 8: 1 0 0 0 XT-PIC-XT-PIC rtc0 9: 0 0 0 0 XT-PIC-XT-PIC acpi 12: 172 0 0 0 XT-PIC-XT-PIC ehci_hcd:usb1 56: 0 0 0 0 PCI-MSI-edge aerdrv, PCIe PME 57: 0 0 0 0 PCI-MSI-edge aerdrv, PCIe PME 58: 0 0 0 0 PCI-MSI-edge aerdrv, PCIe PME 59: 0 0 0 0 PCI-MSI-edge aerdrv, PCIe PME 60: 0 0 0 0 PCI-MSI-edge aerdrv, PCIe PME 61: 0 0 0 0 PCI-MSI-edge aerdrv, PCIe PME 62: 2833 2989 1021 811 PCI-MSI-edge ahci 63: 0 1 0 0 PCI-MSI-edge eth59 64: 301 52 9 3 PCI-MSI-edge eth59-rx-0 65: 12 24 3 178 PCI-MSI-edge eth59-rx-1 66: 14 85 6 2 PCI-MSI-edge eth59-rx-2 67: 17 24 307 1 PCI-MSI-edge eth59-rx-3 68: 70 18 8 10 PCI-MSI-edge eth59-tx-0 69: 7 0 0 23 PCI-MSI-edge eth59-tx-1 70: 15 227 2 2 PCI-MSI-edge eth59-tx-2 71: 18 6 27 2 PCI-MSI-edge eth59-tx-3 72: 0 0 0 0 PCI-MSI-edge eth58 73: 1 0 0 27 PCI-MSI-edge eth58-rx-0 74: 1 22 0 5 PCI-MSI-edge eth58-rx-1 75: 1 0 22 5 PCI-MSI-edge eth58-rx-2 76: 23 0 0 5 PCI-MSI-edge eth58-rx-3 77: 1 0 0 27 PCI-MSI-edge eth58-tx-0 78: 1 22 0 5 PCI-MSI-edge eth58-tx-1 79: 1 0 22 5 PCI-MSI-edge eth58-tx-2 80: 23 0 0 5 PCI-MSI-edge eth58-tx-3 81: 187 17 70 7 PCI-MSI-edge snd_hda_intel 82: 698 1647 247 129 PCI-MSI-edge i915 83: 438 135 16 59 PCI-MSI-edge snd_hda_intel NMI: 0 0 0 0 Non-maskable interrupts LOC: 1975 2499 2245 1474 Local timer interrupts SPU: 0 0 0 0 Spurious interrupts PMI: 0 0 0 0 Performance monitoring interrupts IWI: 132 67 429 91 IRQ work interrupts RTR: 3 0 0 0 APIC ICR <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> retries RES: 1697 2178 1903 1541 Rescheduling interrupts CAL: 561 496 534 567 Function call interrupts TLB: 229 254 170 137 TLB shootdowns TRM: 78 78 78 78 Thermal event interrupts THR: 0 0 0 0 Threshold APIC interrupts MCE: 0 0 0 0 Machine check exceptions MCP: 2 2 2 2 Machine check polls ERR: 0 MIS: 0</code> </pre> <br>  Comme vous pouvez le voir, toutes les interruptions IO-APIC- * se sont transform√©es en XT-PIC-XT-PIC, et ces interruptions sont rout√©es uniquement sur CPU0.  Les interruptions MSI restent inchang√©es et vont √† tous les CPU0-3. <br><br><h3>  nolapic </h3><br>  D√©sactive LAPIC.  Les interruptions MSI ne peuvent pas fonctionner sans LAPIC, les E / S APIC ne peuvent pas fonctionner sans LAPIC.  Par cons√©quent, toutes les interruptions des appareils iront au PIC et cela ne fonctionne qu'avec CPU0.  Et sans LAPIC, les autres processeurs ne fonctionneront m√™me pas dans le syst√®me. <br><br><img src="https://habrastorage.org/webt/rm/jd/4t/rmjd4tr9wxvkghj5hzb5wu7fswi.png"><br><br>  La sortie de / proc / interrupts: <br><br><pre> <code class="bash hljs"> CPU0 0: 6416 XT-PIC-XT-PIC timer 1: 2 XT-PIC-XT-PIC i8042 2: 0 XT-PIC-XT-PIC cascade 3: 5067 XT-PIC-XT-PIC aerdrv, aerdrv, PCIe PME, PCIe PME, i915, snd_hda_intel, eth59 4: 32 XT-PIC-XT-PIC aerdrv, aerdrv, PCIe PME, PCIe PME, eth58 5: 0 XT-PIC-XT-PIC aerdrv, PCIe PME 6: 0 XT-PIC-XT-PIC aerdrv, PCIe PME 8: 1 XT-PIC-XT-PIC rtc0 9: 0 XT-PIC-XT-PIC acpi 11: 274 XT-PIC-XT-PIC snd_hda_intel 12: 202 XT-PIC-XT-PIC ehci_hcd:usb1 15: 7903 XT-PIC-XT-PIC ahci NMI: 0 Non-maskable interrupts LOC: 0 Local timer interrupts SPU: 0 Spurious interrupts PMI: 0 Performance monitoring interrupts IWI: 0 IRQ work interrupts RTR: 0 APIC ICR <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> retries RES: 0 Rescheduling interrupts CAL: 0 Function call interrupts TLB: 0 TLB shootdowns TRM: 0 Thermal event interrupts THR: 0 Threshold APIC interrupts MCE: 0 Machine check exceptions MCP: 1 Machine check polls ERR: 0 MIS: 0</code> </pre><br><h3>  Combinaisons: </h3><br>  En fait, il n'y en a qu'un pour la nouvelle version: "noapic pci = nomsi".  Toutes les interruptions des appareils ne peuvent aller vers CPU0 que via le PIC.  Mais LAPIC fonctionne et d'autres processeurs peuvent fonctionner et g√©rer les interruptions. <br><br>  Premi√®rement, parce que vous ne pouvez rien combiner avec ¬´nolapic¬ª, parce que  cette option rendra I / O APIC et MSI indisponibles.  Donc, si vous avez une fois prescrit les options de d√©marrage ¬´noapic nolapic¬ª (ou l'option la plus courante ¬´acpi = off noapic nolapic¬ª), vous avez apparemment tap√© des lettres suppl√©mentaires. <br><br>  Alors, que se passera-t-il avec les options ¬´noapic pci = nomsi¬ª: <br><br><img src="https://habrastorage.org/webt/jx/bu/is/jxbuissu4c453b_5g-4pcs6_d-w.png"><br><br>  La sortie de / proc / interrupts: <br><br><pre> <code class="bash hljs"> CPU0 CPU1 CPU2 CPU3 0: 5 0 0 0 XT-PIC-XT-PIC timer 1: 2 0 0 0 XT-PIC-XT-PIC i8042 2: 0 0 0 0 XT-PIC-XT-PIC cascade 3: 5072 0 0 0 XT-PIC-XT-PIC i915, snd_hda_intel, eth59 4: 32 0 0 0 XT-PIC-XT-PIC eth58 8: 1 0 0 0 XT-PIC-XT-PIC rtc0 9: 0 0 0 0 XT-PIC-XT-PIC acpi 11: 281 0 0 0 XT-PIC-XT-PIC snd_hda_intel 12: 200 0 0 0 XT-PIC-XT-PIC ehci_hcd:usb1 15: 7930 0 0 0 XT-PIC-XT-PIC ahci NMI: 0 0 0 0 Non-maskable interrupts LOC: 2595 2387 2129 1697 Local timer interrupts SPU: 0 0 0 0 Spurious interrupts PMI: 0 0 0 0 Performance monitoring interrupts IWI: 159 90 482 135 IRQ work interrupts RTR: 3 0 0 0 APIC ICR <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> retries RES: 1568 1666 1810 1833 Rescheduling interrupts CAL: 431 556 549 558 Function call interrupts TLB: 124 184 156 274 TLB shootdowns TRM: 116 116 116 116 Thermal event interrupts THR: 0 0 0 0 Threshold APIC interrupts MCE: 0 0 0 0 Machine check exceptions MCP: 2 2 2 2 Machine check polls ERR: 0 MIS: 0</code> </pre> <br><h3>  Interrompre les tables de routage et les options ¬´acpi = noirq¬ª, ¬´pci = noacpi¬ª, ¬´acpi = off¬ª </h3><br>  Comment le syst√®me d'exploitation re√ßoit-il les informations de routage d'interruption des appareils?  Le BIOS pr√©pare les informations pour le syst√®me d'exploitation sous la forme de: <br><br><ul><li>  Tables ACPI (m√©thodes _PIC / _PRT) </li><li>  Tables _MP_ (MPtable) </li><li>  $ Tables PIR </li><li>  Enregistre l'espace de configuration du p√©riph√©rique PCI 0x3C / 0x3D </li></ul><br>  Il convient de noter que le BIOS n'a rien √† faire pour indiquer les interruptions du MSI; toutes les informations ci-dessus sont n√©cessaires uniquement pour les lignes d'interruption APIC / PIC. <br><br>  Les tableaux de la liste ci-dessus sont indiqu√©s par ordre de priorit√©.  Examinons-le plus en d√©tail. <br><br>  Supposons que le BIOS fournisse toutes ces donn√©es et que nous d√©marrions sans aucune option suppl√©mentaire: <br><br><ul><li>  Le syst√®me d'exploitation trouve des tables ACPI </li><li>  L'OS ex√©cute la m√©thode ACPI "_PIC", lui transmet l'argument selon lequel il doit √™tre charg√© en mode APIC.  Ici, le code de m√©thode enregistre g√©n√©ralement le mode s√©lectionn√© dans une variable (disons PICM = 1) </li><li>  Pour obtenir des donn√©es sur les interruptions, le syst√®me d'exploitation appelle la m√©thode ACPI "_PRT".  Il v√©rifie la variable PICM en interne et renvoie le routage pour le cas APIC </li></ul><br>  <b>Si</b> nous <b>d√©marrons</b> avec l'option <b>noapic</b> : <br><br><ul><li>  Le syst√®me d'exploitation trouve des tables ACPI </li><li>  L'OS ex√©cute la m√©thode ACPI "_PIC", lui transmet l'argument selon lequel il est n√©cessaire de d√©marrer en mode PIC.  Ici, le code de m√©thode enregistre g√©n√©ralement le mode s√©lectionn√© dans une variable (disons PICM = 0) </li><li>  Pour obtenir des donn√©es sur les interruptions, le syst√®me d'exploitation appelle la m√©thode ACPI "_PRT".  Il v√©rifie la variable PICM en interne et renvoie le routage pour le cas PIC </li></ul><br>  Si la table ACPI est manquante ou si la fonctionnalit√© de routage d'interruption via ACPI est d√©sactiv√©e √† l'aide des <b>options</b> <b>acpi = noirq</b> ou <b>pci = noacpi</b> (ou si ACPI est compl√®tement d√©sactiv√© √† l'aide d' <b>acpi = off</b> ), le syst√®me d'exploitation recherche la table MPtable (_MP_) pour le routage des interruptions: <br><br><ul><li>  Le syst√®me d'exploitation ne trouve pas / ne recherche pas les tables ACPI </li><li>  Le syst√®me d'exploitation trouve MPtable (_MP_) </li></ul><br>  Si la table ACPI est manquante ou si la fonctionnalit√© de routage d'interruption via ACPI est d√©sactiv√©e √† l'aide des <b>options</b> <b>acpi = noirq</b> ou <b>pci = noacpi</b> (ou ACPI est compl√®tement d√©sactiv√©e √† l'aide d' <b>acpi = off</b> ) et si la table MPtable (_MP_) est manquante (ou si l'option de d√©marrage <b>noapic</b> ou <b>nolapic</b> est <b>pass√©e</b> ): <br><br><ul><li>  Le syst√®me d'exploitation ne trouve / ne voit pas la table ACPI </li><li>  Le syst√®me d'exploitation ne trouve pas / ne regarde pas la table MPtable (_MP_) </li><li>  Le syst√®me d'exploitation trouve la table $ PIR </li></ul><br>  S'il n'y a pas de table $ PIR, ou si elle n'est pas compl√®te, le syst√®me d'exploitation pour deviner les interruptions examinera les valeurs des registres 0x3C / 0x3D dans l'espace de configuration des p√©riph√©riques PCI. <br><br>  Nous r√©sumons tout ce qui pr√©c√®de avec l'image suivante: <br><br><img src="https://habrastorage.org/webt/rj/9s/mk/rj9smkhk7c_ou_fzskxasgeriw8.png"><br><br>  Il ne faut pas oublier que tous les BIOS ne fournissent pas les 3 tables (ACPI / MPtable / $ PIR), donc si vous avez pass√© l'option au chargeur pour refuser d'utiliser ACPI ou ACPI et MPtable pour le routage des interruptions, c'est loin du fait que votre syst√®me d√©marre. <br><br>  <b>Remarque 1</b> : si nous essayons de d√©marrer en mode APIC avec l'option acpi = noirq et sans la pr√©sence de MPtable, l'image des interruptions sera la m√™me que dans le cas d'un d√©marrage normal avec la seule option noapic.  Le syst√®me d'exploitation lui-m√™me passera en mode d'interruption PIC. <br>  Si nous essayons de d√©marrer sans tables ACPI (acpi = off) et sans fournir MPtable, l'image sera comme ceci: <br><pre> <code class="bash hljs"> CPU0 0: 6 XT-PIC-XT-PIC timer 1: 2 XT-PIC-XT-PIC i8042 2: 0 XT-PIC-XT-PIC cascade 8: 0 XT-PIC-XT-PIC rtc0 12: 373 XT-PIC-XT-PIC ehci_hcd:usb1 16: 0 PCI-MSI-edge PCIe PME 17: 0 PCI-MSI-edge PCIe PME 18: 0 PCI-MSI-edge PCIe PME 19: 0 PCI-MSI-edge PCIe PME 20: 0 PCI-MSI-edge PCIe PME 21: 0 PCI-MSI-edge PCIe PME 22: 8728 PCI-MSI-edge ahci 23: 1 PCI-MSI-edge eth59 24: 1301 PCI-MSI-edge eth59-rx-0 25: 113 PCI-MSI-edge eth59-tx-0 26: 0 PCI-MSI-edge eth58 27: 45 PCI-MSI-edge eth58-rx-0 28: 45 PCI-MSI-edge eth58-tx-0 29: 1280 PCI-MSI-edge snd_hda_intel NMI: 2 Non-maskable interrupts LOC: 24076 Local timer interrupts SPU: 0 Spurious interrupts PMI: 2 Performance monitoring interrupts IWI: 2856 IRQ work interrupts RTR: 0 APIC ICR <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> retries RES: 0 Rescheduling interrupts CAL: 0 Function call interrupts TLB: 0 TLB shootdowns TRM: 34 Thermal event interrupts THR: 0 Threshold APIC interrupts MCE: 0 Machine check exceptions MCP: 2 Machine check polls ERR: 0 MIS: 0</code> </pre><br>  Cela se produit car sans l'ACPI de la table MADT ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Multiple APIC Description Table</a> ) et les informations n√©cessaires de MPtable, le syst√®me d'exploitation ne conna√Æt pas les identificateurs APIC (APIC ID) pour les autres processeurs et ne peut pas fonctionner avec eux, mais le LAPIC du processeur principal fonctionne. puisque nous n'avons pas interdit cela, et les interruptions MSI peuvent y arriver.  Autrement dit, ce sera comme ceci: <br><br><img src="https://habrastorage.org/webt/b-/pz/hx/b-pzhxxyugr5iv203wysxfs7-mo.png"><br><br>  <b>Remarque 2</b> : en g√©n√©ral, le routage d'interruption lors de l'utilisation d'ACPI dans le cas d'APIC est identique au routage d'interruption via MPtable.  Et le routage d'interruption ACPI dans le cas de PIC est le m√™me que le routage d'interruption via $ PIR.  Les conclusions de / proc / interruptions ne devraient donc pas diff√©rer.  Cependant, au cours de la recherche, j'ai remarqu√© une √©tranget√©.  Lors du routage via MPtable, pour une raison quelconque, la sortie contient une interruption en cascade ¬´cascade XT-PIC-XT-PIC¬ª. <br><br><pre> <code class="bash hljs"> CPU0 CPU1 CPU2 CPU3 0: 15 0 0 0 IO-APIC-edge timer 1: 2 0 0 0 IO-APIC-edge i8042 2: 0 0 0 0 XT-PIC-XT-PIC cascade 8: 0 1 0 0 IO-APIC-edge rtc0 9: 0 0 0 0 IO-APIC-edge acpi ...</code> </pre><br>  C'est un peu √©trange que cela se produise, mais la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">noyau</a> semble dire que c'est normal. <br><br><h3>  Conclusion: </h3><br>  En conclusion, nous d√©signons √† nouveau les options analys√©es. <br><br>  Options de s√©lection du contr√¥leur d'interruption: <br><br><ul><li>  <b>pci = nomsi</b> - Les interruptions MSI deviendront IO-APIC / XT-PIC en fonction du contr√¥leur d'interruption utilis√© </li><li>  <b>noapic</b> - D√©sactive les E / S APIC.  Les interruptions MSI peuvent toujours aller √† tous les CPU, les autres interruptions des p√©riph√©riques ne peuvent aller qu'√† PIC, et cela ne fonctionne qu'avec CPU0.  Mais LAPIC fonctionne et d'autres processeurs peuvent fonctionner et g√©rer les interruptions </li><li>  <b>noapic pci = nomsi</b> - Toutes les interruptions des appareils ne peuvent aller qu'au PIC, et cela ne fonctionne qu'avec CPU0.  Mais LAPIC fonctionne et d'autres processeurs peuvent fonctionner et g√©rer les interruptions </li><li>  <b>nolapic</b> - D√©sactive LAPIC.  Les interruptions MSI ne peuvent pas fonctionner sans LAPIC, les E / S APIC ne peuvent pas fonctionner sans LAPIC.  Toutes les interruptions des appareils iront au PIC, et cela ne fonctionne qu'avec CPU0.  Et sans LAPIC, le reste du CPU ne fonctionnera pas. </li></ul><br>  Options pour choisir la table de priorit√© pour le routage d'interruption: <br><br><ul><li>  <b>aucune option</b> - routage via APIC √† l'aide des tables ACPI </li><li>  <b>noapic</b> - routage via PIC √† l'aide de tables ACPI </li><li>  <b>acpi = noirq</b> ( <b>pci = noacpi</b> / <b>acpi = off</b> ) - routage via APIC √† l'aide de MPtable </li><li>  <b>acpi = noirq</b> ( <b>pci = noacpi</b> / <b>acpi = off</b> ) <b>noapic</b> ( <b>nolapic</b> ) - routage via PIC √† l'aide de la table $ PIR </li></ul><br>  Dans la partie suivante, nous verrons comment coreboot configure le chipset pour le routage des interruptions. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431372/">https://habr.com/ru/post/fr431372/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431350/index.html">Plans de d√©veloppement du processeur √©lectronique Ba√Økal</a></li>
<li><a href="../fr431354/index.html">Le premier codec vid√©o d'apprentissage automatique a consid√©rablement surpass√© tous les codecs existants, y compris H.265 et VP9</a></li>
<li><a href="../fr431360/index.html">Expliquez la porte d√©rob√©e dans le flux d'√©v√©nements</a></li>
<li><a href="../fr431362/index.html">Comment un designer peut-il se d√©barrasser de la routine et garder son int√©r√™t pour son travail?</a></li>
<li><a href="../fr431370/index.html">Les rapports les plus rapides dans l'ouest sauvage. Et une poign√©e de bugs en plus ...</a></li>
<li><a href="../fr431374/index.html">Jugement dernier: analyse des indicateurs financiers du jeu en acc√®s anticip√©</a></li>
<li><a href="../fr431376/index.html">Migration des donn√©es dans l'entreprise sanglante: quoi analyser pour ne pas submerger le projet</a></li>
<li><a href="../fr431378/index.html">Toute la v√©rit√© sur RTOS. Article # 23. Files d'attente: introduction et services de base</a></li>
<li><a href="../fr431380/index.html">Mitap Netologiya et Skyeng √† propos des comp√©tences g√©n√©rales ¬´Ce qu'un d√©veloppeur doit savoir, sauf le code¬ª</a></li>
<li><a href="../fr431382/index.html">R√©sultats de l'enqu√™te JVM sur les √©cosyst√®mes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>