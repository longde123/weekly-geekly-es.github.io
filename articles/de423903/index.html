<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¥ üèΩ üë∞üèΩ Eintauchen in AD: Wir analysieren erweiterte Angriffe auf Microsoft Active Directory und wie sie erkannt werden üëºüèø üë©üèª‚Äçüè´ üåßÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bild: Pexels 

 In den letzten vier Jahren hat kein einziger Black Hat oder DEF CON Berichte √ºber Angriffe auf Microsoft Active Directory ver√∂ffentlic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Eintauchen in AD: Wir analysieren erweiterte Angriffe auf Microsoft Active Directory und wie sie erkannt werden</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/423903/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/a7/-h/dd/a7-hddi1lio7lql-ftmp3xryg1e.jpeg"></a> <br><br>  <i>Bild: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pexels</a></i> <br><br>  In den letzten vier Jahren hat kein einziger Black Hat oder DEF CON Berichte √ºber Angriffe auf Microsoft Active Directory ver√∂ffentlicht.  Die Teilnehmer sprechen √ºber neue Vektoren und ihre Erfindungen, vergessen jedoch nicht, wie sie erkannt und verhindert werden k√∂nnen.  In diesem Artikel werden beliebte Methoden zum Angriff auf AD vorgestellt und Empfehlungen zum Schutz vor AD gegeben. <a name="habracut"></a><br><br><h2>  Sechs AD-Angriffe, die Sie nicht √ºbersehen k√∂nnen </h2><br>  Viele Hersteller von Sicherheits√ºberwachungssoftware unterst√ºtzen bereits eine Vielzahl von Angriffstechniken in ihren Produkten.  Betrachten wir einige davon. <br><br><h3>  Pass-the-Hash </h3><br>  Diese Technik ist aufgrund der architektonischen Merkmale des NTLM-Authentifizierungsprotokolls m√∂glich, das Microsoft in den neunziger Jahren des letzten Jahrhunderts entwickelt hat.  Um sich bei einem Remote-Host anzumelden, wird ein Kennwort-Hash verwendet, der im Speicher des Computers gespeichert wird, von dem aus die Authentifizierung erfolgt.  Dementsprechend kann es von dort extrahiert werden. <br><br><h3>  Mimikatz </h3><br>  F√ºr den bequemen Betrieb von Pass-the-Hash entwickelte der franz√∂sische Forscher Benjamin Delpy (Benjamin Delpy) 2014 das Mimikatz-Dienstprogramm.  Es erm√∂glicht das Speichern von Klartextkennw√∂rtern und NTLM-Hashes aus dem Speicher. <br><br><h3>  Brute Force </h3><br>  Wenn der Angreifer nicht √ºber gen√ºgend Anmeldeinformationen verf√ºgt, die er von einem Host extrahiert hat, kann er auf eine grobe, aber effektive Methode zum Erraten von Passw√∂rtern zur√ºckgreifen. <br><br><h3>  Netzbenutzer / Domain </h3><br>  Woher bekomme ich ein W√∂rterbuch mit Benutzernamen, um Brute Force durchzuf√ºhren?  Jedes Mitglied der Dom√§ne kann den Befehl net user / domain verwenden, der eine vollst√§ndige Liste der Benutzernamen von AD zur√ºckgibt. <br><br><h3>  Kerberoasting </h3><br>  Wenn die Dom√§ne Kerberos als Authentifizierungsprotokoll verwendet, kann der Angreifer auf einen Kerberoasting-Angriff zur√ºckgreifen.  Jeder in der Dom√§ne authentifizierte Benutzer kann ein Kerberos-Ticket anfordern, um auf den Ticket Granting Service zuzugreifen.  TGS wird mit dem Kennwort-Hash des Kontos verschl√ºsselt, von dem aus der Zieldienst ausgef√ºhrt wird.  Ein Angreifer, der auf diese Weise TGS erhalten hat, kann es jetzt entschl√ºsseln, ein Kennwort abrufen und hat keine Angst vor dem Blockieren, da es offline ausgef√ºhrt wird.  Nach einem erfolgreichen Ergebnis erh√§lt es ein Kennwort von dem Konto, das dem Dienst zugeordnet ist, das h√§ufig privilegiert ist. <br><br><h3>  Psexec </h3><br>  Nachdem der Angreifer die erforderlichen Anmeldeinformationen erhalten hat, steht er vor der Aufgabe, Befehle aus der Ferne auszuf√ºhren.  Das PsExec-Dienstprogramm aus der Sysinternals-Suite ist daf√ºr gut geeignet.  Es hat sich sowohl bei IT-Administratoren als auch bei Angreifern bew√§hrt. <br><br><h2>  Sieben Angriffszauber, um Active Directory zu erfassen </h2><br>  Wir gehen nun zu sieben Zauberspr√ºchen √ºber, mit denen Angreifer die vollst√§ndige Kontrolle √ºber Active Directory √ºbernehmen k√∂nnen.  Wir werden sie in vier Stufen unterteilen: <br><br><ol><li>  Intelligenz. </li><li>  Promotion auf AD. </li><li>  Bedienung. </li><li>  Domain-Erfassung. </li></ol><br>  Im Diagramm sehen Sie alle vier sowie die Techniken, die auf ihnen verwendet werden.  Lassen Sie uns jedes im Detail betrachten. <br><br><img src="https://habrastorage.org/webt/bq/lw/uf/bqlwufggd4wwixlwo6dsb5w66by.png"><br><br><h2>  Stufe 1. Erkundung </h2><br>  Beginnen wir mit der Intelligenzphase. <br><br><h3>  Powerview </h3><br>  Dieses Tool ist Teil des beliebten PowerShell-Frameworks f√ºr Penetrationstests - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PowerSploit</a> .  Es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">basiert</a> auch auf dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">BloodHound-</a> Tool, das ein Diagramm der Objektbeziehungen in AD erstellt. <br><br><img src="https://habrastorage.org/webt/vb/45/xl/vb45xlilemlfooxopnrxytorpq0.png"><br><br>  <i>Grafische Darstellung von Active Directory-Objektbeziehungen</i> <br><br>  Bloodhound bietet sofort folgende Funktionen: <br><br><ul><li>  Suchen Sie nach Konten aller Dom√§nenadministratoren. </li><li>  Suchen Sie nach Hosts, auf denen Dom√§nenadministratoren angemeldet sind. </li><li>  Erstellen Sie mit der Dom√§nenadministrationssitzung den k√ºrzesten Pfad vom Host des Angreifers zum Host. </li></ul><br>  Der letzte Absatz gibt eine Antwort auf die Frage, welche Hosts von einem Angreifer gehackt werden m√ºssen, um zum Dom√§nenadministratorkonto zu gelangen.  Dieser Ansatz verk√ºrzt die Zeit, um die vollst√§ndige Kontrolle √ºber die Dom√§ne zu erlangen, erheblich. <br><br>  PowerView unterscheidet sich von den integrierten Dienstprogrammen zum Abrufen von Daten zu AD-Objekten (z. B. net.exe) darin, dass es auf dem LDAP-Protokoll und nicht auf SAMR ausgef√ºhrt wird.  Das Ereignis 1644 von einem Dom√§nencontroller ist zum Erkennen dieser Aktivit√§t geeignet.  Die Protokollierung dieses Ereignisses wird durch Hinzuf√ºgen des entsprechenden Werts in der Registrierung aktiviert: <br><br> <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostic\\15 Field Engineering = 5</code> <br> <br><img src="https://habrastorage.org/webt/7q/i2/ny/7qi2nyhavykzj4rqdyohz3ou0pi.png"><br><br>  <i>Aktivieren der LDAP-Ereignisprotokollierung 1644</i> <br><br><img src="https://habrastorage.org/webt/aj/6m/1b/aj6m1bzfn0tgimroq6gnxva_7_e.png"><br><br>  <i>Ereignis 1644 mit LDAP-Anforderungsparametern</i> <br><br>  Es ist zu beachten, dass es viele solcher Ereignisse geben kann, und eine gute Alternative zur Ereigniserkennung ist die Verkehrserkennung, da LDAP ein Klartextprotokoll ist. Dementsprechend sind alle Anforderungen im Verkehr perfekt sichtbar. <br><br> <a href=""><img src="https://habrastorage.org/webt/_w/cd/s3/_wcds3rfyfneg4f6fukn2ojjx4q.png"></a> <br><br>  <i>LDAP SearchRequest (Klicken, um das Bild in voller Gr√∂√üe zu √∂ffnen)</i> <br><br>  Ein weiteres wichtiges Merkmal dieses Frameworks ist, dass es in reiner PowerShell geschrieben ist und keine Abh√§ngigkeiten aufweist.  Zur Erkennung hilft uns hier die erweiterte √úberwachungsfunktion, die in PowerShell Version 5 eingef√ºhrt wurde.  Ereignis 4104 zeigt den Hauptteil eines Skripts, in dem nach PowerView-spezifischen Funktionsnamen gesucht werden kann. <br><br><img src="https://habrastorage.org/webt/4g/3q/ri/4g3qri26i-n9yd52ca5s95o-fg0.png"><br><br><h3>  SPN-Scan </h3><br>  Es kann die Angreifer-Start-nmap ersetzen.  Nachdem der Angreifer herausgefunden hat, welche Benutzer und Gruppen sich in AD befinden, ben√∂tigt er Informationen √ºber die verf√ºgbaren Dienste, um das Bild zu vervollst√§ndigen. <br><br><img src="https://habrastorage.org/webt/yt/gp/ro/ytgprok6xzem1x1ihixxn1awb1q.png"><br><br>  Dies wird normalerweise durch Scannen der Ports mit nmap gel√∂st.  Jetzt k√∂nnen diese Informationen aber auch von AD bezogen werden - sie sind dort bereits gespeichert.  Sie k√∂nnen sich das Ergebnis einer solchen Anfrage ansehen: Geben Sie den sogenannten SPN (Service Principal Names) zur√ºck.  Der SPN besteht aus einer Serviceklasse, ist f√ºr jeden Servicetyp eindeutig, dann kommt der Hostname in Form eines vollqualifizierten Dom√§nennamens und f√ºr einige Services - Port. <br><br><img src="https://habrastorage.org/webt/5b/z8/ot/5bz8otu_w7hroldiqy0wscyut-g.png"><br><br>  <i>Spn Beispiele</i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Vollst√§ndige Liste der Dienstprinzipalnamen</a></i> <br><br>  Um SPN Scan zu erkennen, hilft auch die LDAP-Ereignis√ºberwachung. <br>  Es ist wichtig zu beachten, dass der SPN-Scan einen deutlichen Vorteil gegen√ºber dem nmap-Scan hat: Er ist weniger verrauscht.  Wenn Sie nmap verwenden, m√ºssen Sie eine Verbindung zu jedem Knoten herstellen und Pakete an den von Ihnen angegebenen Portbereich senden.  Und um die Liste der SPN zu erhalten, m√ºssen Sie nur eine Anfrage senden. <br><br><h3>  Aufz√§hlung der Remote-Sitzungen </h3><br>  Eine wichtige Aufgabe f√ºr einen Angreifer in der seitlichen Bewegungsphase besteht darin, festzustellen, welcher Benutzer an welcher Maschine angemeldet ist.  Oder er verf√ºgt bereits √ºber Benutzeranmeldeinformationen (Hash- oder Kerberos-Ticket) und sucht nach Hosts, auf denen Sie sich ungehindert anmelden k√∂nnen.  Oder er ist auf der Suche nach einem Host, auf dem eine Live-Domain-Administratorsitzung stattfindet. <br><br>  Dann funktioniert das Szenario: Jagd -&gt; Kompromittierung eines Wirts -&gt; Golf von Mimikatz -&gt; Gewinn. <br><br>  Sie k√∂nnen 2 Ereignisse verwenden, um diese Technik zu erkennen.  4624 ist eine erfolgreiche Anmeldung auf einem Remote-System mit einer Anmeldung vom Typ 3 sowie IPC $ -Netzwerkzugriffsereignissen. Die Nuance ist der Name der Pipe - srvsvc.  Warum eine Pipe so genannt wird, l√§sst sich am Verkehr ablesen. <br><br> <a href=""><img src="https://habrastorage.org/webt/gl/5k/kf/gl5kkf1bkclyx3b5dgkvwhxpeyo.png"></a> <br><br>  <i>Klicken Sie hier, um das Bild in voller Gr√∂√üe zu √∂ffnen.</i> <br><br>  Auf der linken Seite, in den roten Rahmen, Zugriff auf SMB und dann Zugriff auf Pipe - srvsvc.  Mit dieser Pipe k√∂nnen Sie √ºber das spezielle Server Service Remote Protocol interagieren.  Es erm√∂glicht Endhosts, verschiedene Verwaltungsinformationen von ihm zu erhalten, einschlie√ülich  Unter den Abfragen befindet sich eine mit dem Namen NetSessEnum.  Als Ergebnis dieser Anforderung wird eine vollst√§ndige Liste der am Remote-System angemeldeten Benutzer mit IP-Adresse und Benutzernamen zur√ºckgegeben. <br><br> <a href=""><img src="https://habrastorage.org/webt/6z/3-/oa/6z3-oas3amujm5b6kohgowgops0.png"></a> <br><br>  <i>In MaxPatrol SIEM haben wir eine Erkennung basierend auf einer Kombination dieser beiden Ereignisse unter Ber√ºcksichtigung von srvsvc durchgef√ºhrt.</i>  <i>Und eine √§hnliche Verkehrserkennung in PT Network Attack Discovery.</i> <br><br><h2>  Stufe 2. AD-Promotion </h2><br><h3>  Overpass-the-Hash </h3><br>  Die Reinkarnation von Pass-the-Hash.  Fortsetzung des Themas der seitlichen Bewegung.  Was kann ein Angreifer tun, wenn er einen NTLM-Hash hat?  Er kann einen Pass-the-Hash-Angriff ausf√ºhren - aber es gibt bereits Entdeckungen bei ihr.  Daher wurde ein neuer Vektor gefunden - der Overpass-the-Hash-Angriff. <br><br>  Das Kerberos-Protokoll wurde speziell entwickelt, damit Benutzerkennw√∂rter in der einen oder anderen Form nicht √ºber das Netzwerk √ºbertragen werden.  Zu diesem Zweck verschl√ºsselt der Benutzer auf seinem Computer mit seinem Kennwort die Authentifizierungsanforderung.  Als Antwort stellt ihm das Key Distribution Center (ein spezieller Dienst, der auf dem Dom√§nencontroller gehostet wird) ein Ticket aus, um andere Tickets zu erhalten.  Das sogenannte Ticket-Granting Ticket (TGT).  Jetzt gilt der Kunde als authentifiziert und kann innerhalb von 10 Stunden Tickets f√ºr den Zugriff auf andere Dienste beantragen.  Dementsprechend kann der Angreifer, wenn ein angreifender Dumping-Hash eines Benutzers, der Mitglied einer vertrauensw√ºrdigen Gruppe eines f√ºr ihn interessanten Dienstes ist, beispielsweise eines ERP-Systems oder einer Datenbank, einen Pass f√ºr sich selbst ausstellen und sich erfolgreich bei dem f√ºr ihn interessanten Dienst anmelden. <br><br><img src="https://habrastorage.org/webt/6s/iy/qv/6siyqv90fxjresvbwwzhw2ioynw.png"><br><br><h4>  Wie zu erkennen </h4><br>  Wenn der Angreifer f√ºr diesen Angriff die PowerShell-Version von mimikatz verwendet, hilft die Protokollierung des Skriptk√∂rpers.  Denn Invoke-Mimikatz ist eine sehr charakteristische Linie. <br><br><img src="https://habrastorage.org/webt/hh/3v/cu/hh3vcum-h8mlcker6wdmdsjiwfu.png"><br><br><img src="https://habrastorage.org/webt/hh/3v/cu/hh3vcum-h8mlcker6wdmdsjiwfu.png"><br><br>  Oder 4688 ist ein Prozessstartereignis mit erweiterter Befehlszeilen√ºberwachung.  Selbst wenn das Binar umbenannt wird, finden wir in der Befehlszeile einen Befehl, der f√ºr Mimikatz sehr charakteristisch ist. <br><br><img src="https://habrastorage.org/webt/ur/li/cq/urlicqqkfzjpcphbagcrhvzdoxw.png"><br><br>  Overpass-the-Hash-Verkehr kann anhand einer Anomalie erkannt werden, die sich aus der Tatsache ergibt, dass Microsoft die Verwendung der Authentifizierungsanforderung AES256 f√ºr die Verschl√ºsselung aktueller Dom√§nen empfiehlt.  Und mimikatz verschl√ºsselt beim Senden von Authentifizierungsanforderungsdaten die Daten mit dem veralteten ARCFOUR. <br><br> <a href=""><img src="https://habrastorage.org/webt/1n/yh/tr/1nyhtr7fvxksqjh6snv_dwyhtco.png"></a> <br><br>  Im Verkehr wird aufgrund der Merkmale von Mimikatz ein weiterer Unterschied beobachtet.  Es basiert auf dem Unterschied in der Chiffresuite in der legitimen Dom√§ne und dem, was Mimikatz sendet. <br><br><h3>  Goldenes Ticket </h3><br>  Was kann ein Angreifer tun, wenn er einen Passwort-Hash eines speziellen Kontos namens krbtgt hat?  Zuvor haben wir den Fall betrachtet, in dem der Benutzer nicht privilegiert sein k√∂nnte.  Jetzt betrachten wir einen Benutzer mit einem Passwort-Hash, von dem absolut alle Tickets f√ºr andere Tickets (TGT) signiert sind.  Dementsprechend spricht der Angreifer das Key Distribution Center nicht mehr an, er generiert dieses Ticket selbst, da das Golden Ticket im Wesentlichen TGT ist.  Anschlie√üend k√∂nnen Authentifizierungsanforderungen unbegrenzt an jeden Dienst in AD gesendet werden.  Infolgedessen wendet er sich frei dieser Ressource zu - das Goldene Ticket wird nicht ohne Grund als golden bezeichnet. <br><br><img src="https://habrastorage.org/webt/58/z6/vh/58z6vh3afwjzkebygy_jmxu6ee0.png"><br><br><h4>  So erkennen Sie anhand von Ereignissen </h4><br>  Es gibt das Ereignis 4768, das besagt, dass TGT ausgestellt wurde, und das Ereignis 4769, das besagt, dass ein Serviceticket ausgestellt wurde, das f√ºr die Authentifizierung bei einem Dienst in AD erforderlich ist. <br><br><img src="https://habrastorage.org/webt/wx/l5/gx/wxl5gx-fncwjf1oukr1ldumzzv8.png"><br><br>  Hier k√∂nnen wir auf den Unterschied spielen:  W√§hrend eines Angriffs fordert Golden Ticket kein TGT von einem Dom√§nencontroller an (es generiert es selbst), und es muss ein TGS anfordern. Wenn wir einen Unterschied zwischen empfangenem TGT und TGS feststellen, k√∂nnen wir davon ausgehen, dass ein Golden Ticket-Angriff stattfindet. <br><br>  In MaxPatrol SIEM ist es uns gelungen, mithilfe von Tabellenlisten, in denen wir alle ausgegebenen TGT und TGS protokollieren, eine solche Erkennung zu implementieren. <br><br><h3>  WMI Remote Execution </h3><br>  Nachdem die Authentifizierungs- und Autorisierungsaufgabe auf den gew√ºnschten Hosts gel√∂st wurde, kann der Angreifer damit beginnen, Aufgaben remote auszuf√ºhren.  WMI als eingebauter und daf√ºr entwickelter Mechanismus passt perfekt.  In den letzten Jahren bedeutet ‚Äûvom Land leben‚Äú, die eingebauten Windows-Mechanismen in einem Trend zu nutzen.  Zuallererst, weil es Ihnen erlaubt, sich als legitime Aktivit√§t zu tarnen. <br><br> <a href=""><img src="https://habrastorage.org/webt/m-/96/ez/m-96ez5gjcxuckslwxweegfopcu.png"></a> <br><br>  Im Screenshot die Verwendung des integrierten Dienstprogramms wmic.  Es gibt die Adresse des Hosts an, zu dem Sie eine Verbindung herstellen m√∂chten, Anmeldeinformationen, die Anweisung zum Erstellen eines Prozessaufrufs und den Befehl, der auf dem Remote-Host ausgef√ºhrt werden muss. <br><br><h4>  Wie zu erkennen </h4><br>  Bei einer Reihe von Ereignissen einer Remote-Anmeldung 4624 (beachten Sie <br>  Mania on Logon ID) und Ereignis 4688, in denen √ºber das Starten eines Prozesses mit der Befehlszeile gesprochen wird.  4688 - Sie k√∂nnen sehen, dass das √ºbergeordnete Element des gestarteten Prozesses WmiPrvSE.exe ist, ein spezieller WMI-Dienstprozess, der f√ºr die Remoteverwaltung verwendet wird.  Der Befehl, den wir net user / add gesendet haben, ist sichtbar und die Anmelde-ID stimmt mit dem Ereignis 4624 √ºberein. Dementsprechend k√∂nnen wir genau sagen, von welchem ‚Äã‚ÄãHost dieser Befehl ausgef√ºhrt wird. <br><br><img src="https://habrastorage.org/webt/7u/eb/ei/7uebeito5oikpqj5c_uth187-3m.png"><br><br><h4>  Verkehrserkennung </h4><br>  Hier sehen wir deutlich die charakteristischen W√∂rter des Win32-Prozesses create sowie die Befehlszeile, die zum Starten gesendet wird.  Im Screenshot haben wir k√ºrzlich eine Malware kennengelernt, die nach einem √§hnlichen Prinzip wie WannaCry in virtuellen Netzwerken verbreitet wurde, aber anstelle der Verschl√ºsselung einen Miner installiert hat.  Malvar hatte Mimikatz und EthernalBlue bei sich, sie hat die Konten gel√∂scht und sich mit ihrer Hilfe bei all den Hosts angemeldet, die sie im Netzwerk erreichen konnte.  Mit WMI startete sie PowerShell auf ihnen und lud PowerShell-Nutzdaten herunter, die wiederum Mimikatz, EthernalBlue und den Miner enthielten.  Somit wurde eine Kettenreaktion erhalten. <br><br><img src="https://habrastorage.org/webt/xm/jy/yb/xmjyybw60n3mxmjjrnm8wwvsrq8.png"><br><br><h2>  Empfehlungen f√ºr die Stufen 1-3 </h2><br><blockquote>  1. <b>Lange und komplexe Passw√∂rter (&gt; 25 Zeichen) f√ºr Dienstkonten.</b>  Dies l√§sst einem Angreifer keine Chance, einen Kerberoasting-Angriff auszuf√ºhren  Es wird sehr lange dauern, bis es brutal ist. <br><br>  2. <b>PowerShell protokollieren</b> .  Hilft bei der Entdeckung der Verwendung vieler fortschrittlicher Tools zum Angriff auf AD <br><br>  3. <b>Wechseln zu Windows 10, Windows Server 2016.</b> Microsoft hat Credential Guard erstellt: Es ist nicht mehr m√∂glich, NTLM-Hashes und Kerberos-Tickets aus dem Speicher zu sichern <br><br>  4. <b>Strikte Abgrenzung der Rollen</b> .  Es ist gef√§hrlich, den Administrator von AD, DC, allen Servern und Arbeitsmaschinen in einer Rolle zu kombinieren <br><br>  5. <b>Doppelte Passwort√§nderung krbtgt (dies ist das gleiche Konto, mit dem sich TGT-Tickets anmelden)</b> .  J√§hrlich.  Und nachdem der AD-Administrator AD verlassen hat: <br><ul><li>  m√ºssen zweimal gewechselt werden, weil  das aktuelle und das vorherige Passwort werden gespeichert, </li><li>  jedes Jahr √§ndern, inkl.  nach dem Verlassen des Dom√§nenadministrators.  Selbst wenn das Netzwerk bereits kompromittiert ist und die Angreifer das Goldene Ticket ausgestellt haben, macht das √Ñndern des Passworts dieses Ticket unbrauchbar.  Und wieder m√ºssen sie von vorne anfangen. </li></ul><br>  6. <b>Abhilfema√ünahmen mit einer st√§ndig aktualisierten Expertenwissensbasis</b> .  Es ist notwendig, echte tats√§chliche Angriffe zu erkennen. </blockquote><br><h2>  Stufe 4. Domain-Erfassung </h2><br><h3>  DCShadow </h3><br>  Am 24. Januar 2018 stellten Benjamin Delpy und Vincent Le Toux auf der Microsoft BlueHat-Konferenz in Israel das neue Mimikatz-Modul vor, das den DCShadow-Angriff implementiert.  Der Kern des Angriffs besteht darin, dass ein gef√§lschter Dom√§nencontroller erstellt wird, um durch Replikation neue Objekte in AD zu √§ndern und zu erstellen.  Den Forschern gelang es, den Mindestsatz an Kerberos-SPNs zu isolieren, der f√ºr den Replikationsprozess erforderlich ist - sie ben√∂tigen nur 2. Dar√ºber hinaus pr√§sentierten sie eine spezielle Funktion, die die Replikation von Controllern erzwingen kann.  Die Autoren des Angriffs positionieren ihn als Angriff, der Ihr SIEM blind macht.  Weil  Ein gef√§lschter Dom√§nencontroller sendet keine Ereignisse an SIEM. Dies bedeutet, dass Angreifer mit AD verschiedene dunkle Dinge tun k√∂nnen und SIEM nichts davon wei√ü. <br><br><img src="https://habrastorage.org/webt/op/t5/nv/opt5nvhaixi6i8da_2ixv5kivmk.png"><br><br><h4>  Angriffsmuster </h4><br>  Auf dem System, mit dem der Angriff ausgef√ºhrt wird, m√ºssen 2 SPNs hinzugef√ºgt werden, die erforderlich sind, damit sich andere Dom√§nencontroller mithilfe von Kerberos f√ºr die Replikation authentifizieren k√∂nnen.  Weil  Gem√§√ü der Spezifikation wird der Dom√§nencontroller in der AD-Datenbank durch ein Objekt der nTDSDSA-Klasse dargestellt. Es ist erforderlich, ein solches Objekt zu erstellen.  Rufen Sie abschlie√üend die Replikation mit der Funktion DRSReplicaAdd auf. <br><br><h4>  Wie zu erkennen </h4><br>  Wie DCShadow im Verkehr aussieht.  Durch den Datenverkehr sehen wir deutlich das Hinzuf√ºgen eines neuen Objekts zum Konfigurationsschema des Dom√§nencontrollertyps und dann den erzwungenen Start der Replikation <br><br><img src="https://habrastorage.org/webt/fl/fa/xf/flfaxfzh1dwlccjntfdgcs44aui.png"><br><br>  Aufgrund der Tatsache, dass unsere Korrelation die Liste der legitimen Dom√§nencontroller kennt, wird sie ausgel√∂st, wenn die Replikation von einem Dom√§nencontroller erfolgt, der nicht in dieser wei√üen Liste enthalten ist.  Dementsprechend kann die Abteilung f√ºr Informationssicherheit eine Untersuchung durchf√ºhren und bereits verstehen, dass dies ein legitimer Dom√§nencontroller ist, der vom IT-Dienst hinzugef√ºgt wurde, oder ein DCShadow-Angriff. <br><br><h2>  Fazit </h2><br>  Das DCShadow-Beispiel zeigt, dass es neue Angriffsmethoden f√ºr Unternehmen gibt.  In diesem Ozean von Informationssicherheitsereignissen ist es sehr wichtig, auf dem Wellenkamm zu bleiben: Schauen Sie weiter und bewegen Sie sich schnell.  Jeden Tag erforschen wir im PT Expert Security Center neue Bedrohungen und entwickeln Erkennungsmethoden und -werkzeuge f√ºr diese.  Und wir sind bereit, diese Informationen weiter zu teilen. <br><br>  Gepostet <b>von</b> Anton Tyurin, Leiter des Angriffserkennungsteams, Positive Technologies </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de423903/">https://habr.com/ru/post/de423903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de423891/index.html">Ausdrucksb√§ume f√ºr die Unternehmensentwicklung</a></li>
<li><a href="../de423893/index.html">Hallo Welt f√ºr den Empfang von Daten von einem Bluetooth (BLE) -Ger√§t √ºber C #</a></li>
<li><a href="../de423895/index.html">Sie brauchen keinen Anwalt. Das ist aber nicht sicher</a></li>
<li><a href="../de423897/index.html">N√ºtzliche Tipps zur Verwendung des HyperLynx DDR-Assistenten f√ºr die QDR4-Analyse</a></li>
<li><a href="../de423901/index.html">Wenn Geschwindigkeit und Skalierung ben√∂tigt werden: Server von verteilten iOS-Ger√§ten</a></li>
<li><a href="../de423905/index.html">Die Entwickler blieben unbekannt. Yandex Vortrag</a></li>
<li><a href="../de423911/index.html">Die Siliziumphotonik stolpert √ºber den letzten Meter</a></li>
<li><a href="../de423919/index.html">So automatisieren Sie die Erfassung von KPI pro Monat und lassen Benutzer fast zufrieden sein</a></li>
<li><a href="../de423921/index.html">10 Jahre Android: Erinnere dich an alles</a></li>
<li><a href="../de423923/index.html">SAP Leonardo Hackathon von velcom und SAP f√ºr Entwickler aus Wei√ürussland</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>