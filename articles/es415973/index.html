<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüåæ üõÄüèø üîè C√≥mo no romper el cl√∫ster Apache Ignite desde el principio üë©üèø‚Äç‚úàÔ∏è üëñ üßê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola A continuaci√≥n se muestra una transcripci√≥n del video del discurso en la manifestaci√≥n comunitaria Apache Ignite en San Petersburgo el 20 de juni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo no romper el cl√∫ster Apache Ignite desde el principio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/gridgain/blog/415973/"><p>  Hola  A continuaci√≥n se muestra una transcripci√≥n del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video del</a> discurso en la manifestaci√≥n comunitaria Apache Ignite en San Petersburgo el 20 de junio.  Puedes descargar las diapositivas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zrMWgNyvQVI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Hay toda una clase de problemas que enfrentan los usuarios novatos.  Acaban de descargar Apache Ignite, ejecutan las primeras dos, tres, diez veces y nos hacen preguntas que se resuelven de manera similar.  Por lo tanto, propongo crear una lista de verificaci√≥n que le ahorrar√° mucho tiempo y nervios cuando realice sus primeras aplicaciones Apache Ignite.  Hablaremos sobre los preparativos de lanzamiento;  c√≥mo hacer que se agrupe el cl√∫ster;  c√≥mo comenzar algunos c√°lculos en Compute Grid;  C√≥mo preparar un modelo y c√≥digo de datos para que pueda escribir sus datos en Ignite y luego leerlos con √©xito.  Y lo m√°s importante: c√≥mo no romper nada desde el principio. </p><a name="habracut"></a><br><h2>  Preparaci√≥n para el lanzamiento: configure el registro </h2><br><p>  Necesitamos troncos.  Si alguna vez hizo una pregunta en la lista de correo de Apache Ignite o en StackOverflow, como "por qu√© colg√≥ todo", lo m√°s probable es que lo primero que le pidieron enviar fueron todos los registros de todos los nodos. </p><br><p> Naturalmente, el registro de Apache Ignite est√° habilitado de forma predeterminada.  Pero hay matices.  En primer lugar, Apache Ignite escribe un poco en <code>stdout</code> .  Por defecto, comienza en el llamado modo silencioso.  En <code>stdout</code> ver√° solo los errores m√°s terribles, y todo lo dem√°s se guardar√° en un archivo, la ruta a la que Apache Ignite se muestra al principio (de forma predeterminada: <code>${IGNITE_HOME}/work/log</code> ).  No lo borra y mantiene los registros por m√°s tiempo, puede ser muy √∫til. </p><br><p>  <b><code>stdout</code> enciende en el inicio predeterminado</b> </p><br><p><img src="https://habrastorage.org/webt/dg/wf/4r/dgwf4rf9on5vckayvxqzcbtr5tk.png"></p><br><p>  Para que sea m√°s f√°cil descubrir problemas sin entrar en archivos separados y configurar un monitoreo separado para Apache Ignite, puede ejecutarlo en modo detallado con el comando </p><br><pre> <code class="bash hljs">ignite.sh -v</code> </pre> <br><p>  y luego el sistema comenzar√° a escribir sobre todos los eventos en <code>stdout</code> junto con el resto del registro de la aplicaci√≥n. </p><br><p>  ¬°Revisa los registros!  Muy a menudo en ellos puedes encontrar soluciones a tus problemas.  Si el cl√∫ster se ha colapsado, muy a menudo en el registro puede ver mensajes como "Aumentar tal y tal tiempo de espera en tal y tal configuraci√≥n".  Nos ca√≠mos por su culpa.  El es muy peque√±o.  La red no es lo suficientemente buena ". </p><br><h2>  Ensamblaje de racimo </h2><br><h3>  Invitados no invitados </h3><br><p>  El primer problema que muchos enfrentan son los invitados no invitados en su cl√∫ster.  O usted mismo resulta ser un invitado no invitado: inicie un cl√∫ster nuevo y de repente ver√° que en la primera instant√°nea de topolog√≠a en lugar de un nodo tiene dos servidores desde el principio.  ¬øC√≥mo es eso?  Solo lanzaste uno. </p><br><p>  <b>Un mensaje que indica que el cl√∫ster tiene dos nodos.</b> </p><br><p><img src="https://habrastorage.org/webt/l9/fd/kd/l9fdkdt9vvoaryo1fk84agizhvi.png"></p><br><p>  El hecho es que, por defecto, Apache Ignite usa Multicast, y al inicio buscar√° todos los dem√°s Apache Ignite que est√°n en la misma subred, en el mismo grupo de Multicast.  Y si lo hace, intentar√° conectarse.  Y en caso de conexi√≥n fallida, no se iniciar√° en absoluto.  Por lo tanto, en el cl√∫ster de mi computadora port√°til de trabajo, los nodos adicionales del cl√∫ster en la computadora port√°til del colega aparecen regularmente, lo que por supuesto no es muy conveniente. </p><br><p>  ¬øC√≥mo protegerse de esto?  La forma m√°s f√°cil de configurar IP est√°tica.  En lugar de <code>TcpDiscoveryMulticastIpFinder</code> , que se usa de forma predeterminada, hay <code>TcpDiscoveryVmIpFinder</code> .  All√≠, escriba toda la IP y los puertos a los que se est√° conectando.  Esto es mucho m√°s conveniente y lo proteger√° de una gran cantidad de problemas, especialmente en entornos de desarrollo y pruebas. </p><br><h3>  Demasiadas direcciones </h3><br><p>  El proximo problema.  Deshabilit√≥ la multidifusi√≥n, inici√≥ el cl√∫ster, en una sola configuraci√≥n, estableci√≥ una cantidad decente de IP desde diferentes entornos.  Y sucede que inicia el primer nodo en un cl√∫ster nuevo durante 5-10 minutos, aunque todos los siguientes se conectan a √©l en 5-10 segundos. </p><br><p>  Tome una lista de tres direcciones IP.  Para cada uno, prescribimos rangos de 10 puertos.  En total, se obtienen 30 direcciones TCP.  Como Apache Ignite debe intentar conectarse a un cl√∫ster existente antes de crear un nuevo cl√∫ster, verificar√° cada IP por turno.  Es posible que no duela en su computadora port√°til, pero la protecci√≥n de escaneo de puertos a menudo se incluye en algunos entornos nublados.  Es decir, al acceder a un puerto privado en alguna direcci√≥n IP, no recibir√° ninguna respuesta hasta que haya pasado el tiempo de espera.  Por defecto, son 10 segundos.  Y si tiene 3 direcciones de 10 puertos, obtendr√° 3 * 10 * 10 = 300 segundos de espera, esos mismos 5 minutos para conectarse. </p><br><p>  La soluci√≥n es obvia: no registre puertos innecesarios.  Si tiene tres IP, entonces realmente no necesita un rango predeterminado de 10 puertos.  Esto es conveniente cuando prueba algo en la m√°quina local y ejecuta 10 nodos.  Pero en sistemas reales, un solo puerto suele ser suficiente.  O deshabilite la protecci√≥n contra escaneo de puertos en la red interna, si tiene esa oportunidad. </p><br><p>  El tercer problema com√∫n es IPv6.  Puede ver mensajes de error de red extra√±os: no se pudo conectar, no se pudo enviar un mensaje, nodo segmentado.  Esto significa que te has ca√≠do del cl√∫ster.  Muy a menudo, estos problemas son causados ‚Äã‚Äãpor entornos mixtos de IPv4 e IPv6.  Esto no quiere decir que Apache Ignite no sea compatible con IPv6, pero en este momento hay ciertos problemas. </p><br><p>  La soluci√≥n m√°s f√°cil es pasar la opci√≥n a la m√°quina Java </p><br><pre> <code class="hljs objectivec">-Djava.net.preferIPv4Stack=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  Entonces Java y Apache Ignite no usar√°n IPv6.  Esto resuelve una parte importante de los problemas con los cl√∫steres colapsados. </p><br><h2>  Preparaci√≥n de la base del c√≥digo: serializamos correctamente </h2><br><p>  El cl√∫ster se ha reunido, es necesario comenzar algo en √©l.  Uno de los elementos m√°s importantes en la interacci√≥n de su c√≥digo con el c√≥digo Apache Ignite es Marshaller, o serializaci√≥n.  Para escribir algo en la memoria, para persistir, para enviar a trav√©s de la red, Apache Ignite primero serializa sus objetos.  Puede ver mensajes que comienzan con las palabras: "no se puede escribir en formato binario" o "no se puede serializar con BinaryMarshaller".  Solo habr√° una advertencia de este tipo en el registro, pero notable.  Esto significa que necesita ajustar su c√≥digo un poco m√°s para hacer amigos con Apache Ignite. </p><br><p>  Apache Ignite utiliza tres mecanismos para la serializaci√≥n: </p><br><ul><li>  <code>JdkMarshaller</code> : serializaci√≥n regular de Java; </li><li>  <code>OptimizedMarshaller</code> : serializaci√≥n Java ligeramente optimizada, pero los mecanismos son los mismos; </li><li>  <code>BinaryMarshaller</code> es una serializaci√≥n escrita espec√≠ficamente para Apache Ignite, utilizada en todas partes bajo su cap√≥.  Ella tiene una serie de ventajas.  En alg√∫n lugar podemos evitar la serializaci√≥n y deserializaci√≥n adicionales, y en alg√∫n lugar incluso podemos obtener en la API un objeto no deserializado, trabajar con √©l directamente en formato binario, como con algo como JSON. </li></ul><br><p>  <code>BinaryMarshaller</code> podr√° serializar y <code>BinaryMarshaller</code> sus POJO que no tienen m√°s que campos y m√©todos simples.  Pero si tiene una serializaci√≥n personalizada a trav√©s de <code>readObject()</code> y <code>writeObject()</code> , si usa <code>Externalizable</code> , <code>BinaryMarshaller</code> no se las <code>BinaryMarshaller</code> .  Ver√° que su objeto no se puede serializar mediante la grabaci√≥n habitual de campos no transitorios y se dar√° por vencido: volver√° a <code>OptimizedMarshaller</code> . </p><br><p>  Para hacer amigos de tales objetos con Apache Ignite, debe implementar la interfaz <code>Binarylizable</code> .  El es muy simple. </p><br><p>  Por ejemplo, hay un <code>TreeMap</code> est√°ndar de Java.  Tiene serializaci√≥n y deserializaci√≥n personalizadas a trav√©s de objetos de lectura y escritura.  Primero describe algunos campos y luego escribe la longitud y los datos en s√≠ mismos en <code>OutputStream</code> . </p><br><p>  <b>Implementaci√≥n de <code>TreeMap.writeObject()</code></b> </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> java.io.IOException </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Write out the Comparator and any hidden stuff s.defaultWriteObject(); // Write out size (number of Mappings) s.writeInt(size); // Write out keys and values (alternating) for (Iterator&lt;Map.Entry&lt;K,V&gt;&gt; i = entrySet().iterator(); i.hasNext(); ) { Map.Entry&lt;K,V&gt; e = i.next(); s.writeObject(e.getKey()); s.writeObject(e.getValue()); } }</span></span></code> </pre> <br><p>  <code>writeBinary()</code> y <code>readBinary()</code> de <code>Binarylizable</code> funcionan exactamente de la misma manera: <code>BinaryTreeMap</code> envuelve en un <code>TreeMap</code> normal y lo escribe en <code>OutputStream</code> .  Este m√©todo es f√°cil de escribir y aumentar√° enormemente la productividad. </p><br><p>  <b><code>BinaryTreeMap.writeBinary()</code></b> </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeBinary</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BinaryWriter writer)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BinaryObjectException </span></span>{ BinaryRawWriter rewriter = writer. rewrite (); rawWriter.writeObject(map.comparator()); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size = map.size(); rawWriter.writeInt(size); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Map.Entry&lt;Object, Object&gt; entry : ((TreeMap&lt;Object, Object&gt;)map).entrySet()) { rawWriter.writeObject(entry.getKey()); rawWriter.writeObject(entry.getValue()); } }</code> </pre> <br><h2>  Lanzamiento en Compute Grid </h2><br><p>  Ignite no solo le permite almacenar datos, sino tambi√©n ejecutar computaci√≥n distribuida.  ¬øC√≥mo ejecutamos alg√∫n tipo de lambda para que disperse todos los servidores y se ejecute? <br>  Para empezar, ¬øcu√°l es el problema con estos ejemplos de c√≥digo? </p><br><p>  <b>Cual es el problema</b> </p><br><pre> <code class="java hljs">Foo foo = ‚Ä¶; Bar bar = ...; ignite.compute().broadcast( () -&gt; doStuffWithFooAndBar(foo, bar) );</code> </pre> <br><p>  <b>Y si es asi?</b> </p><br><pre> <code class="java hljs">Foo foo = ‚Ä¶; Bar bar = ...; ignite.compute().broadcast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IgniteRunnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doStuffWithFooAndBar(foo, bar); } });</code> </pre> <br><p>  Como puede suponer, muchos familiarizados con las trampas de las lambdas y las clases an√≥nimas, el problema est√° en capturar variables desde el exterior.  Por ejemplo, enviamos lambda.  Utiliza un par de variables que se declaran fuera de lambda.  Esto significa que estas variables viajar√°n con ella y volar√°n a trav√©s de la red a todos los servidores.  Y entonces surgen las mismas preguntas: ¬øson estos objetos amigables con <code>BinaryMarshaller</code> ?  ¬øDe qu√© tama√±o son?  ¬øGeneralmente queremos que se transfieran a alg√∫n lugar, o son estos objetos tan grandes que es mejor pasar alg√∫n tipo de identificaci√≥n y recrear los objetos dentro del lambda que ya est√°n en el otro lado? </p><br><p>  La clase an√≥nima es a√∫n peor.  Si el lambda no puede llevarse esto, t√≠relo, si no se usa, entonces la clase an√≥nima lo tomar√° con seguridad, y esto generalmente no conduce a nada bueno. </p><br><p>  El siguiente ejemplo.  Lambda nuevamente, pero que usa la API Apache Ignite un poco. </p><br><p>  <b>Usar el encendido dentro del cierre de c√°lculo es <em>incorrecto</em></b> </p><br><pre> <code class="java hljs">ignite.compute().broadcast(() -&gt; { IgniteCache foo = ignite.cache(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); String sql = <span class="hljs-string"><span class="hljs-string">"where id = 42"</span></span>; SqlQuery qry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlQuery(<span class="hljs-string"><span class="hljs-string">"Foo"</span></span>, sql).setLocal(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> foo.query(qry); });</code> </pre> <br><p>  En la versi√≥n original, toma el cach√© y localmente hace alg√∫n tipo de consulta SQL.  Este es un patr√≥n cuando necesita enviar una tarea que solo funciona con datos locales en nodos remotos. </p><br><p>  ¬øCu√°l es el problema aqu√≠?  La lambda nuevamente captura el enlace, pero ahora no al objeto, sino al Ignite local en el nodo con el que lo enviamos.  E incluso funciona, porque el objeto Ignite tiene un m√©todo <code>readResolve()</code> , que permite la deserializaci√≥n para reemplazar el Ignite que vino a trav√©s de la red con el local en el nodo donde lo enviamos.  Pero esto tambi√©n a veces conduce a consecuencias indeseables. </p><br><p>  B√°sicamente, simplemente est√° transfiriendo m√°s datos de la red de los que desea.  Si necesita obtener de alg√∫n c√≥digo que no controla el inicio de Apache Ignite o algunas de sus interfaces, entonces lo m√°s simple es usar el m√©todo <code>Ignintion.localIgnite()</code> .  Puede llamarlo desde cualquier hilo que Apache Ignite haya creado y obtener un enlace a un objeto local.  Si tiene lambdas, servicios, cualquier cosa, y comprende que necesita Ignite aqu√≠, le recomiendo este m√©todo. </p><br><p>  <strong>Usamos Ignite dentro del cierre de c√°lculo correctamente, a trav√©s de <code>localIgnite()</code></strong> </p><br><pre> <code class="java hljs">ignite.compute().broadcast(() -&gt; { IgniteCache foo = Ignition.localIgnite().cache(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); String sql = <span class="hljs-string"><span class="hljs-string">"where id = 42"</span></span>; SqlQuery qry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlQuery(<span class="hljs-string"><span class="hljs-string">"Foo"</span></span>, sql).setLocal(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> foo.query(qry); });</code> </pre><br><p>  Y el √∫ltimo ejemplo en esta parte.  Apache Ignite tiene una cuadr√≠cula de servicios que se puede usar para implementar microservicios directamente en un cl√∫ster, y Apache Ignite ayudar√° a mantener en l√≠nea la cantidad correcta de instancias.  Digamos que en este servicio tambi√©n necesitamos un enlace a Apache Ignite.  ¬øC√≥mo conseguirlo?  Podr√≠amos usar <code>localIgnite()</code> , pero luego este enlace tendr√° que guardarse manualmente en el campo. </p><br><p>  <strong>El servicio almacena Ignite en un campo <em>incorrectamente</em> , lo toma como argumento para el constructor</strong> </p><br><pre> <code class="java hljs">MyService s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyService(ignite) ignite.services().deployClusterSingleton(<span class="hljs-string"><span class="hljs-string">"svc"</span></span>, s); ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Ignite ignite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ignite ignite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ignite = ignite; } ... }</code> </pre> <br><p>  Hay una manera m√°s simple.  Todav√≠a tenemos clases completas, y no lambda, por lo que podemos anotar el campo como <code>@IgniteInstanceResource</code> .  Cuando se crea el servicio, Apache Ignite se colocar√° all√≠, y puede usarlo con seguridad.  Le recomiendo encarecidamente que haga exactamente eso, y no intente pasar Apache Ignite y sus hijos al constructor. </p><br><p>  <strong>El servicio usa <code>@IgniteInstanceResource</code></strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@IgniteInstanceResource</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Ignite ignite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } ... }</code> </pre> <br><h2>  Escribir y leer datos </h2><br><h3>  Observando la l√≠nea de base </h3><br><p>  Ahora tenemos un cl√∫ster Apache Ignite y un c√≥digo preparado. </p><br><p>  Imaginemos este escenario: </p><br><ul><li>  Una cach√© <code>REPLICATED</code> : hay copias de datos disponibles en todos los nodos; </li><li>  La persistencia nativa est√° activada: escriba en el disco. </li></ul><br><p>  Comenzamos un nodo.  Como la persistencia nativa est√° habilitada, necesitamos activar el cl√∫ster antes de trabajar con √©l.  Activar  Luego lanzamos algunos nodos m√°s. <br>  Todo parece estar funcionando: escribir y leer est√°n bien.  Todos los nodos tienen copias de los datos; puede detener de forma segura un nodo.  Pero si detiene el primer nodo desde el que inici√≥ el lanzamiento, entonces todo se rompe: los datos desaparecen y las operaciones dejan de pasar. </p><br><p>  La raz√≥n de esto es la topolog√≠a de referencia: los muchos nodos que almacenan datos de persistencia en ellos.  Todos los dem√°s nodos no tendr√°n datos persistentes. </p><br><p>  Este conjunto de nodos por primera vez se determina en el momento de la activaci√≥n.  Y los nodos que agreg√≥ posteriormente ya no se incluyen en el n√∫mero de nodos de l√≠nea de base.  Es decir, una gran cantidad de topolog√≠a de l√≠nea de base consiste en un solo nodo, el primer nodo, cuando se detiene, todo se rompe.  Para evitar que esto suceda, primero inicie todos los nodos y luego active el cl√∫ster.  Si necesita agregar o eliminar un nodo con el comando </p><br><pre> <code class="bash hljs">control.sh --baseline</code> </pre> <br><p>  Puede ver qu√© nodos se enumeran all√≠.  El mismo script puede actualizar la l√≠nea base a su estado actual. </p><br><p>  <b>Ejemplo de <code>control.sh</code></b> </p><br><p><img src="https://habrastorage.org/webt/nw/6d/fy/nw6dfy5onsssvkwsw1vmwaxczm4.png"></p><br><h3>  Colocaci√≥n de datos </h3><br><p>  Ahora que sabemos que los datos est√°n guardados, intente leerlos.  Tenemos soporte SQL, puede hacer <code>SELECT</code> , casi como en Oracle.  Pero al mismo tiempo, podemos escalar y ejecutar cualquier n√∫mero de nodos, los datos se almacenan de manera distribuida.  Veamos un modelo as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Long orgId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Organization</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; }</code> </pre> <br><p>  Solicitud </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Person <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Organization</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> o <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.orgId = o.id</code> </pre> <br><p>  no devolver√° todos los datos.  Que esta mal </p><br><p>  Persona ( <code>Person</code> ) se refiere a la organizaci√≥n ( <code>Organization</code> ) por ID.  Esta es una clave for√°nea cl√°sica.  Pero si intentamos combinar las dos tablas y enviar una consulta SQL, entonces con varios nodos en el cl√∫ster no recibiremos todos los datos. </p><br><p>  El hecho es que, por defecto, SQL <code>JOIN</code> funciona solo dentro de un solo nodo.  Si SQL recorriera constantemente el cl√∫ster para recopilar datos y devolver el resultado completo, ser√≠a incre√≠blemente lento.  Perder√≠amos todos los beneficios de un sistema distribuido.  Entonces, en cambio, Apache Ignite solo mira los datos locales. </p><br><p>  Para obtener los resultados correctos, debemos colocar los datos juntos (colocaci√≥n).  Es decir, para la combinaci√≥n correcta de Persona y Organizaci√≥n, los datos de ambas tablas deben almacenarse en el mismo nodo. </p><br><p>  Como hacerlo  La soluci√≥n m√°s f√°cil es declarar una clave de afinidad.  Este es un valor que determina en qu√© nodo, en qu√© partici√≥n, en qu√© grupo de registros se ubicar√° este o ese valor.  Si declaramos el ID de la organizaci√≥n en <code>Person</code> como una clave de afinidad, esto significar√° que las personas con este ID de organizaci√≥n deben estar en el mismo nodo que la organizaci√≥n con el mismo ID. </p><br><p>  Si por alguna raz√≥n no puede hacer esto, hay otra soluci√≥n menos efectiva: habilitar las uniones distribuidas.  Esto se hace a trav√©s de la API, y el procedimiento depende de lo que use: Java, JDBC u otra cosa.  Luego, <code>JOIN</code> se ejecutar√° m√°s lentamente, pero luego devolver√° los resultados correctos. </p><br><p>  Consideremos c√≥mo trabajar con claves de afinidad.  ¬øC√≥mo entendemos que tal y tal identificaci√≥n, tal y tal campo es adecuado para determinar la afinidad?  Si decimos que todas las personas con el mismo <code>orgId</code> se almacenar√°n juntas, entonces <code>orgId</code> es un grupo indivisible.  No podemos distribuirlo entre varios nodos.  Si la base de datos contiene 10 organizaciones, habr√° 10 grupos indivisibles que se pueden colocar en 10 nodos.  Si hay m√°s nodos en el cl√∫ster, todos los nodos "extra" permanecer√°n sin grupos.  Esto es muy dif√≠cil de definir en tiempo de ejecuci√≥n, as√≠ que pi√©nselo de antemano. </p><br><p>  Si tiene una organizaci√≥n grande y 9 peque√±as, el tama√±o de los grupos ser√° diferente.  Pero Apache Ignite no mira el n√∫mero de registros en grupos de afinidad cuando los distribuye entre nodos.  Por lo tanto, no colocar√° un grupo en un nodo, sino otros 9 en otro para nivelar de alguna manera la distribuci√≥n.  M√°s bien, los pondr√° 5 y 5 (o 6 y 4, o incluso 7 y 3). </p><br><p>  ¬øC√≥mo hacer que los datos se distribuyan uniformemente?  Podemos tener </p><br><ul><li>  Teclas K </li><li>  Una variedad de claves de afinidad; </li><li>  Particiones P, es decir, grandes grupos de datos que Apache Ignite distribuir√° entre nodos; </li><li>  N nodos </li></ul><br><p>  Entonces es necesario que la condici√≥n </p><br><pre> <code class="hljs ruby">K <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>A &gt;&gt; P &gt;&gt; N</code> </pre> <br><p>  donde <code>&gt;&gt;</code> es "mucho m√°s" y los datos se distribuir√°n de manera relativamente uniforme. </p><br><p>  Por cierto, el valor predeterminado es P = 1024. </p><br><p>  Lo m√°s probable es que no tenga √©xito en una distribuci√≥n uniforme.  Este fue el caso en Apache Ignite 1.x a 1.9.  Esto se llamaba <code>FairAffinityFunction</code> y no funcion√≥ muy bien: gener√≥ demasiado tr√°fico entre los nodos.  Ahora el algoritmo se llama <code>RendezvousAffinityFunction</code> .  No proporciona una distribuci√≥n absolutamente honesta, el error entre los nodos ser√° m√°s o menos 5-10%. </p><br><h2>  Lista de verificaci√≥n para nuevos usuarios de Apache Ignite </h2><br><ol><li>  Configurar, leer, almacenar registros </li><li>  Desactiva la multidifusi√≥n, escribe solo las direcciones y puertos que utilizas </li><li>  Deshabilitar IPv6 </li><li>  Prepare sus clases para <code>BinaryMarshaller</code> </li><li>  Lleve un registro de su l√≠nea de base </li><li>  Configurar colocaci√≥n de afinidad </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es415973/">https://habr.com/ru/post/es415973/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es415961/index.html">Almacenamiento distribuido ruso. Como funciona</a></li>
<li><a href="../es415963/index.html">Naive Bayes, o c√≥mo las matem√°ticas te permiten filtrar el spam</a></li>
<li><a href="../es415965/index.html">Qu√© leer en julio: 19 nuevos libros para profesionales digitales</a></li>
<li><a href="../es415967/index.html">SolidFire - Almacenamiento para aquellos ** almacenamiento de odio cking</a></li>
<li><a href="../es415969/index.html">HyperX Pulsefire Surge RGB: un asesino nato</a></li>
<li><a href="../es415975/index.html">Los chinos introdujeron una pistola l√°ser con un alcance de casi un kil√≥metro.</a></li>
<li><a href="../es415977/index.html">T√∫neles y VPN resistentes a DPI</a></li>
<li><a href="../es415979/index.html">Semana de la seguridad 24: Rowhammer en Android y la complejidad de las vulnerabilidades de hardware</a></li>
<li><a href="../es415981/index.html">Google y HTTP</a></li>
<li><a href="../es415983/index.html">Early Universe 5. Desplazamiento al rojo cosmol√≥gico y din√°mica de un universo en expansi√≥n uniforme, parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>