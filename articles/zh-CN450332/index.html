<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💠 🤬 🐸 《巫师3》的渲染方式是如何实现的：闪电，巫师的天赋和其他效果 🙏🏼 👩‍🔧 👆🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="第1部分。拉链 
 在这一部分中，我们将研究《巫师3：狂猎》中的闪电渲染过程。 

 闪电渲染的执行时间比雨幕效果晚一些，但仍在直接渲染过程中进行。 可以在此视频中看到闪电： 


 它们会很快消失，因此最好以0.25的速度观看视频。 

 您会看到这些不是静态图像； 随着时间的流逝，它们的亮度会略...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>《巫师3》的渲染方式是如何实现的：闪电，巫师的天赋和其他效果</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450332/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/abf/ce7/1c4/abfce71c4469b6dcd077723d498c1685.jpg" alt="图片"></div><br><h2> 第1部分。拉链 </h2><br> 在这一部分中，我们将研究《巫师3：狂猎》中的闪电渲染过程。 <br><br> 闪电渲染的执行时间比<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">雨幕</a>效果晚一些，但仍在直接渲染过程中进行。 可以在此视频中看到闪电： <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/VXt4PEEqV2k" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br> 它们会很快消失，因此最好以0.25的速度观看视频。 <br><br> 您会看到这些不是静态图像； 随着时间的流逝，它们的亮度会略有变化。 <br><br> 从细微差别的角度来看，在远处画雨帘有许多相似之处，例如，混合状态（加法混合）和深度相同（启用检查，不进行深度记录）。 <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ba/7e1/f20/4ba7e1f2075dc128baf8b717eeb3ce92.jpg"></div><br>  <i>没有闪电的场景</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3dd/37a/e59/3dd37ae5986de4621766f4fc64525906.jpg"></div><br>  <i>闪电场景</i> <br><br> 就闪电的几何形状而言，巫师3是一个树状网格。 此闪电示例由以下网格表示： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5b7/23c/3dc/5b723c3dc1f934c0f6c14903e2a260cf.jpg"></div><br> 它具有UV坐标和法线向量。 所有这些在顶点着色器阶段都派上用场。 <br><br><h3> 顶点着色器 </h3><br> 让我们看一下组装好的顶点着色器代码： <br><br><pre><code class="cpp hljs">vs_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb1[<span class="hljs-number"><span class="hljs-number">9</span></span>], immediateIndexed dcl_constantbuffer cb2[<span class="hljs-number"><span class="hljs-number">6</span></span>], immediateIndexed dcl_input v0.xyz dcl_input v1.xy dcl_input v2.xyz dcl_input v4.xyzw dcl_input v5.xyzw dcl_input v6.xyzw dcl_input v7.xyzw dcl_output o0.xy dcl_output o1.xyzw dcl_output_siv o2.xyzw, position dcl_temps <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: mov o0.xy, v1.xyxx <span class="hljs-number"><span class="hljs-number">1</span></span>: mov o1.xyzw, v7.xyzw <span class="hljs-number"><span class="hljs-number">2</span></span>: mul r0.xyzw, v5.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].yyyy <span class="hljs-number"><span class="hljs-number">3</span></span>: mad r0.xyzw, v4.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].xxxx, r0.xyzw <span class="hljs-number"><span class="hljs-number">4</span></span>: mad r0.xyzw, v6.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].zzzz, r0.xyzw <span class="hljs-number"><span class="hljs-number">5</span></span>: mad r0.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r0.xyzw <span class="hljs-number"><span class="hljs-number">6</span></span>: mov r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: mad r1.xyz, v0.xyzx, cb2[<span class="hljs-number"><span class="hljs-number">4</span></span>].xyzx, cb2[<span class="hljs-number"><span class="hljs-number">5</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">8</span></span>: dp4 r2.x, r1.xyzw, v4.xyzw <span class="hljs-number"><span class="hljs-number">9</span></span>: dp4 r2.y, r1.xyzw, v5.xyzw <span class="hljs-number"><span class="hljs-number">10</span></span>: dp4 r2.z, r1.xyzw, v6.xyzw <span class="hljs-number"><span class="hljs-number">11</span></span>: add r2.xyz, r2.xyzx, -cb1[<span class="hljs-number"><span class="hljs-number">8</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">12</span></span>: dp3 r1.w, r2.xyzx, r2.xyzx <span class="hljs-number"><span class="hljs-number">13</span></span>: rsq r1.w, r1.w <span class="hljs-number"><span class="hljs-number">14</span></span>: div r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.w <span class="hljs-number"><span class="hljs-number">15</span></span>: mul r1.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">0.000001</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>: mad r2.xyz, v2.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span>: mad r1.xyz, r2.xyzx, r1.wwww, r1.xyzx <span class="hljs-number"><span class="hljs-number">18</span></span>: mov r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">19</span></span>: dp4 o2.x, r1.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">20</span></span>: mul r0.xyzw, v5.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].yyyy <span class="hljs-number"><span class="hljs-number">21</span></span>: mad r0.xyzw, v4.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].xxxx, r0.xyzw <span class="hljs-number"><span class="hljs-number">22</span></span>: mad r0.xyzw, v6.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].zzzz, r0.xyzw <span class="hljs-number"><span class="hljs-number">23</span></span>: mad r0.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r0.xyzw <span class="hljs-number"><span class="hljs-number">24</span></span>: dp4 o2.y, r1.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">25</span></span>: mul r0.xyzw, v5.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].yyyy <span class="hljs-number"><span class="hljs-number">26</span></span>: mad r0.xyzw, v4.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].xxxx, r0.xyzw <span class="hljs-number"><span class="hljs-number">27</span></span>: mad r0.xyzw, v6.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].zzzz, r0.xyzw <span class="hljs-number"><span class="hljs-number">28</span></span>: mad r0.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r0.xyzw <span class="hljs-number"><span class="hljs-number">29</span></span>: dp4 o2.z, r1.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">30</span></span>: mul r0.xyzw, v5.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].yyyy <span class="hljs-number"><span class="hljs-number">31</span></span>: mad r0.xyzw, v4.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].xxxx, r0.xyzw <span class="hljs-number"><span class="hljs-number">32</span></span>: mad r0.xyzw, v6.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].zzzz, r0.xyzw <span class="hljs-number"><span class="hljs-number">33</span></span>: mad r0.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r0.xyzw <span class="hljs-number"><span class="hljs-number">34</span></span>: dp4 o2.w, r1.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">35</span></span>: ret</code> </pre> <br> 顶点着色器防雨帘有很多相似之处，因此我不再重复。 我想向您展示第11-18行的重要区别： <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">11</span></span>: add r2.xyz, r2.xyzx, -cb1[<span class="hljs-number"><span class="hljs-number">8</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">12</span></span>: dp3 r1.w, r2.xyzx, r2.xyzx <span class="hljs-number"><span class="hljs-number">13</span></span>: rsq r1.w, r1.w <span class="hljs-number"><span class="hljs-number">14</span></span>: div r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.w <span class="hljs-number"><span class="hljs-number">15</span></span>: mul r1.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">0.000001</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>: mad r2.xyz, v2.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span>: mad r1.xyz, r2.xyzx, r1.wwww, r1.xyzx <span class="hljs-number"><span class="hljs-number">18</span></span>: mov r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">19</span></span>: dp4 o2.x, r1.xyzw, r0.xyzw</code> </pre> <br> 首先，cb1 [8] .xyz是摄像机的位置，而r2.xyz是世界空间中的位置，也就是说，第11行计算从摄像机到世界位置的矢量。 然后第12-15行计算<i>长度（worldPos-cameraPos）* 0.000001。</i> <br><br>  v2.xyz是传入几何的法线向量。 第16行将其从间隔[0-1]扩展到间隔[-1; 1]。 <br><br> 然后计算世界上的最终位置： <br><br>  <i>finalWorldPos = worldPos +长度（worldPos-cameraPos）* 0.000001 * normalVector</i> <br> 此操作的HLSL代码段将如下所示： <br><br><pre> <code class="cpp hljs"> ... <span class="hljs-comment"><span class="hljs-comment">// final world-space position float3 vNormal = Input.NormalW * 2.0 - 1.0; float lencameratoworld = length( PositionL - g_cameraPos.xyz) * 0.000001; PositionL += vNormal*lencameratoworld; // SV_Posiiton float4x4 matModelViewProjection = mul(g_viewProjMatrix, matInstanceWorld ); Output.PositionH = mul( float4(PositionL, 1.0), transpose(matModelViewProjection) ); return Output;</span></span></code> </pre> <br> 此操作导致网格的较小“爆发”（沿法向矢量的方向）。 我尝试用其他几个值替换0.000001。 结果如下： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6f1/dca/ddb/6f1dcaddbdcd0f6e3c957cd8d2a1121b.jpg"></div><br>  <i>0.000002</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/609/289/c37/609289c37cea41590ffcb94beebae7e5.jpg"></div><br>  <i>0.000005</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/56a/d36/09c/56ad3609c6bbe28990bc8894b163c50d.jpg"></div><br>  <i>0.00001</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/71b/e90/b04/71be90b04a538e953b4a0ee0d4ce2912.jpg"></div><br>  <i>0.000025</i> <br><br><h3> 像素着色器 </h3><br> 好了，我们找到了顶点着色器，现在是时候开始讨论像素着色器的汇编代码了！ <br><br><pre> <code class="cpp hljs"> ps_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb0[<span class="hljs-number"><span class="hljs-number">1</span></span>], immediateIndexed dcl_constantbuffer cb2[<span class="hljs-number"><span class="hljs-number">3</span></span>], immediateIndexed dcl_constantbuffer cb4[<span class="hljs-number"><span class="hljs-number">5</span></span>], immediateIndexed dcl_input_ps linear v0.x dcl_input_ps linear v1.w dcl_output o0.xyzw dcl_temps <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: mad r0.x, cb0[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, cb4[<span class="hljs-number"><span class="hljs-number">4</span></span>].x, v0.x <span class="hljs-number"><span class="hljs-number">1</span></span>: add r0.y, r0.x, l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span>: round_ni r0.y, r0.y <span class="hljs-number"><span class="hljs-number">3</span></span>: ishr r0.z, r0.y, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span>: xor r0.y, r0.y, r0.z <span class="hljs-number"><span class="hljs-number">5</span></span>: imul null, r0.z, r0.y, r0.y <span class="hljs-number"><span class="hljs-number">6</span></span>: imad r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: imad r0.y, r0.y, r0.z, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r0.y, r0.y, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>: round_ni r0.z, r0.x <span class="hljs-number"><span class="hljs-number">10</span></span>: frc r0.x, r0.x <span class="hljs-number"><span class="hljs-number">11</span></span>: add r0.x, -r0.x, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">12</span></span>: ishr r0.w, r0.z, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">13</span></span>: xor r0.z, r0.z, r0.w <span class="hljs-number"><span class="hljs-number">14</span></span>: imul null, r0.w, r0.z, r0.z <span class="hljs-number"><span class="hljs-number">15</span></span>: imad r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>: imad r0.z, r0.z, r0.w, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">18</span></span>: itof r0.yz, r0.yyzy <span class="hljs-number"><span class="hljs-number">19</span></span>: mul r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>) <span class="hljs-number"><span class="hljs-number">20</span></span>: mad r0.y, r0.y, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r0.z <span class="hljs-number"><span class="hljs-number">21</span></span>: mul r0.w, r0.x, r0.x <span class="hljs-number"><span class="hljs-number">22</span></span>: mul r0.x, r0.x, r0.w <span class="hljs-number"><span class="hljs-number">23</span></span>: mul r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">3.000000</span></span>) <span class="hljs-number"><span class="hljs-number">24</span></span>: mad r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r0.w <span class="hljs-number"><span class="hljs-number">25</span></span>: mad r0.x, r0.x, r0.y, r0.z <span class="hljs-number"><span class="hljs-number">26</span></span>: add r0.y, -cb4[<span class="hljs-number"><span class="hljs-number">2</span></span>].x, cb4[<span class="hljs-number"><span class="hljs-number">3</span></span>].x <span class="hljs-number"><span class="hljs-number">27</span></span>: mad_sat r0.x, r0.x, r0.y, cb4[<span class="hljs-number"><span class="hljs-number">2</span></span>].x <span class="hljs-number"><span class="hljs-number">28</span></span>: mul r0.x, r0.x, v1.w <span class="hljs-number"><span class="hljs-number">29</span></span>: mul r0.yzw, cb4[<span class="hljs-number"><span class="hljs-number">0</span></span>].xxxx, cb4[<span class="hljs-number"><span class="hljs-number">1</span></span>].xxyz <span class="hljs-number"><span class="hljs-number">30</span></span>: mul r0.xyzw, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].wxyz <span class="hljs-number"><span class="hljs-number">31</span></span>: mul o0.xyz, r0.xxxx, r0.yzwy <span class="hljs-number"><span class="hljs-number">32</span></span>: mov o0.w, r0.x <span class="hljs-number"><span class="hljs-number">33</span></span>: ret</code> </pre> <br> 好消息：代码并不长。 <br><br> 坏消息： <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">3</span></span>: ishr r0.z, r0.y, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span>: xor r0.y, r0.y, r0.z <span class="hljs-number"><span class="hljs-number">5</span></span>: imul null, r0.z, r0.y, r0.y <span class="hljs-number"><span class="hljs-number">6</span></span>: imad r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: imad r0.y, r0.y, r0.z, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r0.y, r0.y, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>)</code> </pre> <br>  ...这是怎么回事？ <br><br> 老实说，这不是我第一次在Witcher 3着色器中看到这样的汇编代码。 但是当我第一次见到他时，我想：“这到底是什么？” <br><br> 在其他一些TW3着色器中也可以找到类似的内容。 我不会用这个片段来描述我的冒险经历，而只是说答案在于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">整数噪声</a> ： <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// For more details see: http://libnoise.sourceforge.net/noisegen/ float integerNoise( int n ) { n = (n &gt;&gt; 13) ^ n; int nn = (n * (n * n * 60493 + 19990303) + 1376312589) &amp; 0x7fffffff; return ((float)nn / 1073741824.0); }</span></span></code> </pre> <br> 如您所见，在像素着色器中它被调用了两次。 使用该网站上的指南，我们可以了解如何正确实现平滑噪声。 一分钟后，我会再谈这个。 <br><br> 看一下第0行-我们在此基于以下公式进行动画处理： <br><br>  <i>动画=经过时间*动画速度+ TextureUV.x</i> <br> 这些值在将来四舍五入到下侧（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">floor</a> ）（指令<i>round_ni</i> ）后，将成为整数噪声的输入点。 通常，我们计算两个整数的噪声值，然后计算它们之间的最终内插值（有关详细信息，请参见libnoise网站）。 <br><br> 好吧，这是<b>整数</b>噪声，但毕竟，所有前面提到的值（也四舍五入）都是浮点的！ <br><br> 请注意，此处没有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ftoi</a>指令。 我假设CD Projekt Red的程序员<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a>使用了HLSL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">asint</a>内部函数，该函数执行“ reinterpret_cast”浮点值的转换并将它们视为整数模式。 <br><br> 这两个值的插值权重在第10-11行中计算。 <br><br>  <i>插值权重= 1.0-压裂（动画）;</i> <br> 这种方法使我们可以随着时间在值之间进行插值。 <br><br> 为了产生平滑噪声，将此内插器传递给<b>SCurve</b>函数： <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s_curve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x2 = x * x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x3 = x2 * x; <span class="hljs-comment"><span class="hljs-comment">// -2x^3 + 3x^2 return -2.0*x3 + 3.0*x2; }</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/15a/5d0/48e/15a5d048e4fcf9b12c51cad50d7bfc3e.png"></div><br>  <i>平滑步函数[libnoise.sourceforge.net]</i> <br><br> 此功能称为“平滑步伐”。 但是，从汇编代码中可以看到，这<b>不是</b> HLSL <b>的</b>内部<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">平滑步</a>函数。 内部函数会应用限制，以使值均为true。 但是由于我们知道<i>插值权重</i>将始终在[0-1]范围内，因此可以安全地跳过这些检查。 <br><br> 在计算最终值时，将使用几个乘法运算。 了解最终的alpha输出如何根据噪声值而变化。 这很方便，因为它会影响渲染的闪电的不透明度，就像在现实生活中一样。 <br><br> 准备好像素着色器： <br><br><pre> <code class="cpp hljs"> cbuffer cbPerFrame : <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> (b0) { float4 cb0_v0; float4 cb0_v1; float4 cb0_v2; float4 cb0_v3; } cbuffer cbPerFrame : <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> (b2) { float4 cb2_v0; float4 cb2_v1; float4 cb2_v2; float4 cb2_v3; } cbuffer cbPerFrame : <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> (b4) { float4 cb4_v0; float4 cb4_v1; float4 cb4_v2; float4 cb4_v3; float4 cb4_v4; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VS_OUTPUT</span></span></span><span class="hljs-class"> {</span></span> float2 Texcoords : Texcoord0; float4 InstanceLODParams : INSTANCE_LOD_PARAMS; float4 PositionH : SV_Position; }; <span class="hljs-comment"><span class="hljs-comment">// Shaders in TW3 use integer noise. // For more details see: http://libnoise.sourceforge.net/noisegen/ float integerNoise( int n ) { n = (n &gt;&gt; 13) ^ n; int nn = (n * (n * n * 60493 + 19990303) + 1376312589) &amp; 0x7fffffff; return ((float)nn / 1073741824.0); } float s_curve( float x ) { float x2 = x * x; float x3 = x2 * x; // -2x^3 + 3x^2 return -2.0*x3 + 3.0*x2; } float4 Lightning_TW3_PS( in VS_OUTPUT Input ) : SV_Target { // * Inputs float elapsedTime = cb0_v0.x; float animationSpeed = cb4_v4.x; float minAmount = cb4_v2.x; float maxAmount = cb4_v3.x; float colorMultiplier = cb4_v0.x; float3 colorFilter = cb4_v1.xyz; float3 lightningColorRGB = cb2_v2.rgb; // Animation using time and X texcoord float animation = elapsedTime * animationSpeed + Input.Texcoords.x; // Input parameters for Integer Noise. // They are floored and please note there are using asint. // That might be an optimization to avoid "ftoi" instructions. int intX0 = asint( floor(animation) ); int intX1 = asint( floor(animation-1.0) ); float n0 = integerNoise( intX0 ); float n1 = integerNoise( intX1 ); // We interpolate "backwards" here. float weight = 1.0 - frac(animation); // Following the instructions from libnoise, we perform // smooth interpolation here with cubic s-curve function. float noise = lerp( n0, n1, s_curve(weight) ); // Make sure we are in [0.0 - 1.0] range. float lightningAmount = saturate( lerp(minAmount, maxAmount, noise) ); lightningAmount *= Input.InstanceLODParams.w; // 1.0 lightningAmount *= cb2_v2.w; // 1.0 // Calculate final lightning color float3 lightningColor = colorMultiplier * colorFilter; lightningColor *= lighntingColorRGB; float3 finalLightningColor = lightningColor * lightningAmount; return float4( finalLightningColor, lightningAmount ); }</span></span></code> </pre> <br><h3> 总结一下 </h3><br> 在这一部分中，我描述了一种在《巫师3》中渲染闪电的方法。 <br><br> 我很高兴我的着色器产生的汇编代码与原始代码完全匹配！ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/25c/708/e50/25c708e503f4528c313c557abb080222.jpg"></div><br><h2> 第2部分。愚蠢的天空技巧 </h2><br> 这部分将与之前的部分略有不同。 在其中，我想向您展示Sky Shader Witcher 3的某些方面。 <br><br> 为什么使用“愚蠢的把戏”而不是整个着色器？ 好吧，有几个原因。 首先，《巫师3》的天空着色器是相当复杂的野兽。  2015版的像素着色器包含267行汇编代码，Blood and Wine DLC的着色器包含385行。 <br><br> 而且，它们接收到很多输入，这不利于对完整（且可读！）的HLSL代码进行逆向工程。 <br><br> 因此，我决定只展示这些着色器的部分技巧。 如果我发现新的东西，我将补充该职位。 <br><br>  2015版和DLC（2016）之间的差异非常明显。 尤其是，它们包括计算星星和闪烁的差异，以及渲染太阳的不同方法。 <i>血液和葡萄酒</i>着色器甚至可以计算夜间的银河系。 <br><br> 我将从基础知识开始，然后讨论愚蠢的把戏。 <br><br><h3> 基础知识 </h3><br> 像大多数现代游戏一样，《巫师3》使用skydome建模天空。 请看《巫师3》（2015）中用于此目的的半球。 注意：在这种情况下，此网格的边界框在[0,0,0]到[1,1,1]的范围内（Z是指向上方的轴），并且UV平滑分布。 以后我们使用它们。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3cf/49a/34d/3cf49a34dead2ff2e6f2542487edbf65.jpg"></div><br>  skydome背后的想法类似于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">skybox</a>的想法（唯一的区别是所使用的网格）。 在顶点着色器阶段，我们相对于观察者（通常根据摄影机的位置）对天穹进行转换，从而产生一种幻象，即天空实际上距离很远-我们将永远无法到达天空。 <br><br> 如果您阅读了本系列文章的前几部分，那么您就会知道“巫师3”使用的是反深度，即远平面为0.0f，最近的平面为1.0f。 为了在远平面上完成skydome输出，在浏览窗口的参数中，我们将<i>MinDepth</i>设置<i>为</i>与<i>MaxDepth</i>相同的值： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d7/34f/931/2d734f931c687dde42e3bb549a695764.jpg"></div><br> 若要了解在浏览窗口转换期间如何使用<i>MinDepth</i>和<i>MaxDepth字段</i> ，请单击<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a> （docs.microsoft.com）。 <br><br><h3> 顶点着色器 </h3><br> 让我们从顶点着色器开始。 在Witcher 3（2015）中，汇编器着色器代码如下： <br><br><pre> <code class="cpp hljs"> vs_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb1[<span class="hljs-number"><span class="hljs-number">4</span></span>], immediateIndexed dcl_constantbuffer cb2[<span class="hljs-number"><span class="hljs-number">6</span></span>], immediateIndexed dcl_input v0.xyz dcl_input v1.xy dcl_output o0.xy dcl_output o1.xyz dcl_output_siv o2.xyzw, position dcl_temps <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: mov o0.xy, v1.xyxx <span class="hljs-number"><span class="hljs-number">1</span></span>: mad r0.xyz, v0.xyzx, cb2[<span class="hljs-number"><span class="hljs-number">4</span></span>].xyzx, cb2[<span class="hljs-number"><span class="hljs-number">5</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">2</span></span>: mov r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span>: dp4 o1.x, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">4</span></span>: dp4 o1.y, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">5</span></span>: dp4 o1.z, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">6</span></span>: mul r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].yyyy, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">7</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].xxxx, r1.xyzw <span class="hljs-number"><span class="hljs-number">8</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].zzzz, r1.xyzw <span class="hljs-number"><span class="hljs-number">9</span></span>: mad r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.xyzw <span class="hljs-number"><span class="hljs-number">10</span></span>: dp4 o2.x, r0.xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">11</span></span>: mul r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].yyyy, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">12</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].xxxx, r1.xyzw <span class="hljs-number"><span class="hljs-number">13</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].zzzz, r1.xyzw <span class="hljs-number"><span class="hljs-number">14</span></span>: mad r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.xyzw <span class="hljs-number"><span class="hljs-number">15</span></span>: dp4 o2.y, r0.xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">16</span></span>: mul r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].yyyy, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">17</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].xxxx, r1.xyzw <span class="hljs-number"><span class="hljs-number">18</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].zzzz, r1.xyzw <span class="hljs-number"><span class="hljs-number">19</span></span>: mad r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.xyzw <span class="hljs-number"><span class="hljs-number">20</span></span>: dp4 o2.z, r0.xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">21</span></span>: mul r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].yyyy, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">22</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].xxxx, r1.xyzw <span class="hljs-number"><span class="hljs-number">23</span></span>: mad r1.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].zzzz, r1.xyzw <span class="hljs-number"><span class="hljs-number">24</span></span>: mad r1.xyzw, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].wwww, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>), r1.xyzw <span class="hljs-number"><span class="hljs-number">25</span></span>: dp4 o2.w, r0.xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">26</span></span>: ret</code> </pre> <br> 在这种情况下，顶点着色器仅将texcoords和世界空间中的位置传输到输出。 在<i>Blood and Wine中，</i>他还显示了归一化的法线向量。 我会考虑使用2015版，因为它更简单。 <br><br> 查看指定为<b>cb2</b>的常量缓冲区： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/360/38d/fc6/36038dfc67c29ef2934d96314ed46aff.jpg"></div><br> 在这里，我们有一个世界矩阵（按100均匀缩放并相对于摄像机位置进行传输）。 没什么复杂的。  cb2_v4和cb2_v5是用于将顶点位置从间隔[0-1]转换为间隔[-1; 1]的比例/偏差因子。 但是在这里，这些系数“压缩” Z轴（向上）。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e9/774/4c2/7e97744c28b0997b0b11049bee26fa7b.jpg"></div><br> 在本系列的前几部分中，我们有类似的顶点着色器。 通用算法是进一步传递texcoords，然后考虑比例尺/偏差系数<i>来</i>计算<i>Position</i> ，然后在世界空间中计算<i>PositionW</i> ，然后通过将<i>matWorld</i>和<i>matViewProj</i>相乘来计算裁剪空间的最终位置-&gt;使用它们的乘积乘以<i>Position</i>以获得最终的SV_Position 。 <br><br> 因此，此顶点着色器的HLSL应该是这样的： <br><br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InputStruct</span></span></span><span class="hljs-class"> {</span></span> float3 param0 : POSITION; float2 param1 : TEXCOORD; float3 param2 : NORMAL; float4 param3 : TANGENT; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OutputStruct</span></span></span><span class="hljs-class"> {</span></span> float2 param0 : TEXCOORD0; float3 param1 : TEXCOORD1; float4 param2 : SV_Position; }; <span class="hljs-function"><span class="hljs-function">OutputStruct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EditedShaderVS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(in InputStruct IN)</span></span></span><span class="hljs-function"> </span></span>{ OutputStruct OUT = (OutputStruct)<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Simple texcoords passing OUT.param0 = IN.param1; // * Manually construct world and viewProj martices from float4s: row_major matrix matWorld = matrix(cb2_v0, cb2_v1, cb2_v2, float4(0,0,0,1) ); matrix matViewProj = matrix(cb1_v0, cb1_v1, cb1_v2, cb1_v3); // * Some optional fun with worldMatrix // a) Scale //matWorld._11 = matWorld._22 = matWorld._33 = 0.225f; // b) Translate // XYZ //matWorld._14 = 520.0997; //matWorld._24 = 74.4226; //matWorld._34 = 113.9; // Local space - note the scale+bias here! //float3 meshScale = float3(2.0, 2.0, 2.0); //float3 meshBias = float3(-1.0, -1.0, -0.4); float3 meshScale = cb2_v4.xyz; float3 meshBias = cb2_v5.xyz; float3 Position = IN.param0 * meshScale + meshBias; // World space float4 PositionW = mul(float4(Position, 1.0), transpose(matWorld) ); OUT.param1 = PositionW.xyz; // Clip space - original approach from The Witcher 3 matrix matWorldViewProj = mul(matViewProj, matWorld); OUT.param2 = mul( float4(Position, 1.0), transpose(matWorldViewProj) ); return OUT; }</span></span></code> </pre> <br> 我的着色器（左）和原始着色器（右）的比较： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd9/ed7/de2/fd9ed7de275ba36551e7751e1d351b8c.jpg"></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RenderDoc的</a>一个出色特性是它允许我们注入自己的着色器，而不是原始的着色器，并且这些更改将影响到帧末尾的管道。 从HLSL代码可以看到，我提供了几个用于缩放和变换最终几何图形的选项。 您可以对它们进行试验，并获得非常有趣的结果： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0a5/350/e14/0a5350e14231505c0ff1bd5cbf384e15.jpg"></div><br><h4> 顶点着色器优化 </h4><br> 您是否注意到原始顶点着色器的问题？ 矩阵的顶点乘以矩阵是完全多余的！ 我至少在一些顶点着色器中发现了这一点（例如，在着色器<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">中远处</a>有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">雨帘</a> ）。 我们可以通过立即将<i>PositionW</i>乘以<i>matViewProj</i>来优化它！ <br><br> 因此，我们可以将代码替换为HLSL： <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Clip space - original approach from The Witcher 3 matrix matWorldViewProj = mul(matViewProj, matWorld); OUT.param2 = mul( float4(Position, 1.0), transpose(matWorldViewProj) );</span></span></code> </pre> <br> 如下： <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Clip space - optimized version OUT.param2 = mul( matViewProj, PositionW );</span></span></code> </pre> <br> 优化版本为我们提供了以下汇编代码： <br><br><pre> <code class="cpp hljs"> vs_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer CB1[<span class="hljs-number"><span class="hljs-number">4</span></span>], immediateIndexed dcl_constantbuffer CB2[<span class="hljs-number"><span class="hljs-number">6</span></span>], immediateIndexed dcl_input v0.xyz dcl_input v1.xy dcl_output o0.xy dcl_output o1.xyz dcl_output_siv o2.xyzw, position dcl_temps <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: mov o0.xy, v1.xyxx <span class="hljs-number"><span class="hljs-number">1</span></span>: mad r0.xyz, v0.xyzx, cb2[<span class="hljs-number"><span class="hljs-number">4</span></span>].xyzx, cb2[<span class="hljs-number"><span class="hljs-number">5</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">2</span></span>: mov r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span>: dp4 r1.x, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">4</span></span>: dp4 r1.y, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">5</span></span>: dp4 r1.z, r0.xyzw, cb2[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw <span class="hljs-number"><span class="hljs-number">6</span></span>: mov o1.xyz, r1.xyzx <span class="hljs-number"><span class="hljs-number">7</span></span>: mov r1.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">8</span></span>: dp4 o2.x, cb1[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">9</span></span>: dp4 o2.y, cb1[<span class="hljs-number"><span class="hljs-number">1</span></span>].xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">10</span></span>: dp4 o2.z, cb1[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">11</span></span>: dp4 o2.w, cb1[<span class="hljs-number"><span class="hljs-number">3</span></span>].xyzw, r1.xyzw <span class="hljs-number"><span class="hljs-number">12</span></span>: ret</code> </pre> <br> 如您所见，我们将指令的数量从26条减少到12条-相当重要的变化。 我不知道这个问题在游戏中的普及程度，但是为了上帝的缘故，CD Projekt Red也许发布了补丁？  :) <br><br> 而且我不是在开玩笑。 您可以插入优化的着色器，而不是原始的RenderDoc，您会看到此优化在视觉上没有任何影响。 老实说，我不明白为什么CD Projekt Red决定执行矩阵与矩阵的顶点乘法... <br><br><h3> 太阳 </h3><br> 在《巫师3》（2015年）中，大气散射和太阳的计算包括两个单独的绘图调用： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/649/9df/02c/6499df02c248c9bab14a597b6b111d6d.jpg"></div><br>  <i>巫师3（2015）-直到</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fe6/4ee/77c/fe64ee77c1923920bc01de149ddb60e7.jpg"></div><br>  <i>巫师3（2015）-天空</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64d/9e5/416/64d9e541622b33d646b887db01c7c1a2.jpg"></div><br>  <i>巫师3（2015）-天空+太阳</i> <br><br> 就几何形状和混合/深度状态而言，2015年版本中太阳的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">渲染与月亮</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">渲染</a>非常相似。 <br><br> 另一方面，在<i>“血液和葡萄酒”</i>中，一次渲染有太阳<i>的</i>天空： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/184/7dd/daa/1847dddaa38e0876bc829a2d5747c9ce.jpg"></div><br>  <i>巫师3：血与酒（2016）-通往天堂</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7fa/aff/002/7faaff002cc6d328d663c582c74a3628.jpg"></div><br>  <i>《巫师3：鲜血与美酒》（2016）-《天堂与太阳》</i> <br><br> 无论您如何渲染太阳，在某个阶段您仍然需要阳光的（规范化）方向。 获得此向量的最合乎逻辑的方法是使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">球坐标</a> 。 实际上，我们只需要两个表示两个角度（以弧度表示）的值即可： <i>Phi</i>和<i>theta</i> 。 收到它们后，我们可以假定<i>r = 1</i> ，从而将其减小。 然后，对于Y轴指向上方的直角坐标，可以在HLSL中编写以下代码： <br><br><pre> <code class="cpp hljs"> float3 vSunDir; vSunDir.x = <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(fTheta)*<span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(fPhi); vSunDir.y = <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(fTheta)*<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(fPhi); vSunDir.z = <span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(fTheta); vSunDir = normalize(vSunDir);</code> </pre> <br> 通常，在应用程序中计算日光的方向，然后将其传递给常量缓冲区以备将来使用。 <br><br> 接收到阳光的方向后，我们可以更深入地研究<i>“ Blood and Wine”</i>像素着色器的汇编代码... <br><br><pre> <code class="cpp hljs"> ... <span class="hljs-number"><span class="hljs-number">100</span></span>: add r1.xyw, -r0.xyxz, cb12[<span class="hljs-number"><span class="hljs-number">0</span></span>].xyxz <span class="hljs-number"><span class="hljs-number">101</span></span>: dp3 r2.x, r1.xywx, r1.xywx <span class="hljs-number"><span class="hljs-number">102</span></span>: rsq r2.x, r2.x <span class="hljs-number"><span class="hljs-number">103</span></span>: mul r1.xyw, r1.xyxw, r2.xxxx <span class="hljs-number"><span class="hljs-number">104</span></span>: mov_sat r2.xy, cb12[<span class="hljs-number"><span class="hljs-number">205</span></span>].yxyy <span class="hljs-number"><span class="hljs-number">105</span></span>: dp3 r2.z, -r1.xywx, -r1.xywx <span class="hljs-number"><span class="hljs-number">106</span></span>: rsq r2.z, r2.z <span class="hljs-number"><span class="hljs-number">107</span></span>: mul r1.xyw, -r1.xyxw, r2.zzzz ...</code> </pre> <br> 因此，首先， <i>cb12 [0] .xyz</i>是摄像机位置，在<i>r0.xyz中，</i>我们存储顶点位置（这是顶点着色器的输出）。 因此，第100行计算向量<i>worldToCamera</i> 。 但是，请看第105-107行。 我们可以将它们写为<i>归一化（-worldToCamera）</i> ，即我们计算归一化的<i>cameraToWorld</i>向量。 <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">120</span></span>: dp3_sat r1.x, cb12[<span class="hljs-number"><span class="hljs-number">203</span></span>].yzwy, r1.xywx</code> </pre> <br> 然后，我们计算<i>cameraToWorld</i>和<i>sunDirection向量</i>的标量积！ 请记住，必须将它们标准化。 我们还使该完整表达式饱和，以将其限制为间隔[0-1]。 <br><br> 太好了！ 该标量积存储在r1.x中。 让我们看看它的下一步应用... <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">152</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r1.x, r1.x <span class="hljs-number"><span class="hljs-number">153</span></span>: mul r1.x, r1.x, cb12[<span class="hljs-number"><span class="hljs-number">203</span></span>].x <span class="hljs-number"><span class="hljs-number">154</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r1.x, r1.x <span class="hljs-number"><span class="hljs-number">155</span></span>: mul r1.x, r2.y, r1.x</code> </pre> <br> 三位一体“ log，mul，exp”是幂。 如您所见，我们将余弦（归一化向量的标量积）提高到一定程度。 您可能会问为什么。 这样，我们可以创建模仿太阳的渐变。  （并且第155行会影响此渐变的不透明度，因此，例如，我们将其重置为完全隐藏太阳）。 以下是一些示例： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/674/662/658/6746626580dbe0d943c27bcda10f8a9d.jpg"></div><br>  <i>指数= 54</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b0a/a4e/fca/b0aa4efcae350fe8423e3bc8a1463d78.jpg"></div><br>  <i>指数= 2400</i> <br><br> 有了这个渐变，我们就可以使用它在<i>skyColor</i>和<i>sunColor</i>之间进行插值！ 为避免出现伪影，您需要使第120行的值饱和。 <br><br> 值得一提的是，该技巧可用于模拟月球<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">冠</a> （在低指数值下）。 为此，我们需要<i>moonDirection</i>向量，可以使用球坐标轻松计算出该向量。 <br><br> 现成的HLSL代码可能类似于以下代码段： <br><br><pre> <code class="cpp hljs"> float3 vCamToWorld = normalize( PosW – CameraPos ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> cosTheta = saturate( dot(vSunDir, vCamToWorld) ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> sunGradient = <span class="hljs-built_in"><span class="hljs-built_in">pow</span></span>( cosTheta, sunExponent ); float3 color = lerp( skyColor, sunColor, sunGradient );</code> </pre> <br><h3> 星星运动 </h3><br> 如果您将“巫师3”晴朗的夜空延时拍摄，您会发现星星不是静止的-它们在天空中移动一些！ 我几乎偶然地注意到了这一点，并想知道它是如何实现的。 <br><br> 让我们从以下事实开始：巫师3中的恒星以大小为1024x1024x6的立方图表示。 如果您考虑一下，您将理解这是一个非常方便的解决方案，可让您轻松地为采样立方图确定方向。 <br><br> 让我们看下面的汇编代码： <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">159</span></span>: add r1.xyz, -v1.xyzx, cb1[<span class="hljs-number"><span class="hljs-number">8</span></span>].xyzx <span class="hljs-number"><span class="hljs-number">160</span></span>: dp3 r0.w, r1.xyzx, r1.xyzx <span class="hljs-number"><span class="hljs-number">161</span></span>: rsq r0.w, r0.w <span class="hljs-number"><span class="hljs-number">162</span></span>: mul r1.xyz, r0.wwww, r1.xyzx <span class="hljs-number"><span class="hljs-number">163</span></span>: mul r2.xyz, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].zwyz, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">164</span></span>: mad r2.xyz, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].yzwy, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), -r2.xyzx <span class="hljs-number"><span class="hljs-number">165</span></span>: mul r4.xyz, r2.xyzx, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].zwyz <span class="hljs-number"><span class="hljs-number">166</span></span>: mad r4.xyz, r2.zxyz, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].wyzw, -r4.xyzx <span class="hljs-number"><span class="hljs-number">167</span></span>: dp3 r4.x, r1.xyzx, r4.xyzx <span class="hljs-number"><span class="hljs-number">168</span></span>: dp2 r4.y, r1.xyxx, r2.yzyy <span class="hljs-number"><span class="hljs-number">169</span></span>: dp3 r4.z, r1.xyzx, cb12[<span class="hljs-number"><span class="hljs-number">204</span></span>].yzwy <span class="hljs-number"><span class="hljs-number">170</span></span>: dp3 r0.w, r4.xyzx, r4.xyzx <span class="hljs-number"><span class="hljs-number">171</span></span>: rsq r0.w, r0.w <span class="hljs-number"><span class="hljs-number">172</span></span>: mul r2.xyz, r0.wwww, r4.xyzx <span class="hljs-number"><span class="hljs-number">173</span></span>: sample_indexable(texturecube)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r4.xyz, r2.xyzx, t0.xyzw, s0</code> </pre> <br> 为了计算最终采样向量（第173行），我们首先计算归一化的<i>worldToCamera</i>向量（第159-162行）。 <br><br> 然后我们使用<i>moonDirection</i>计算两个向量乘积（ <i>163-164，165-166）</i> ，然后我们计算三个标量乘积以获得最终采样向量。  HLSL代码： <br><br><pre> <code class="cpp hljs"> float3 vWorldToCamera = normalize( g_CameraPos.xyz - Input.PositionW.xyz ); float3 vMoonDirection = cb12_v204.yzw; float3 vStarsSamplingDir = cross( vMoonDirection, float3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) ); float3 vStarsSamplingDir2 = cross( vStarsSamplingDir, vMoonDirection ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dirX = dot( vWorldToCamera, vStarsSamplingDir2 ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dirY = dot( vWorldToCamera, vStarsSamplingDir ); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dirZ = dot( vWorldToCamera, vMoonDirection); float3 dirXYZ = normalize( float3(dirX, dirY, dirZ) ); float3 starsColor = texNightStars.Sample( samplerAnisoWrap, dirXYZ ).rgb;</code> </pre> <br> 请注意：这是一个设计良好的代码，我应该对其进行详细研究。 <br><br> 读者注意：如果您对此操作了解更多，请告诉我！ <br><br><h3> 闪烁的星星 </h3><br> 我想更详细地探讨的另一个有趣的技巧是星星的闪烁。<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，如果您在晴朗的天气中在诺维格勒（Novigrad）周围徘徊，您会注意到星星闪烁。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我很好奇这是如何实现的。事实证明，2015版与</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“血液与葡萄酒”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之间的差异</font><font style="vertical-align: inherit;">非常大。为简单起见，我将考虑2015版。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，我们</font><font style="vertical-align: inherit;">从上一节中的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">采样之后开始</font><font style="vertical-align: inherit;">：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">174</span></span>: mul r0.w, v0.x, l(<span class="hljs-number"><span class="hljs-number">100.000000</span></span>) <span class="hljs-number"><span class="hljs-number">175</span></span>: round_ni r1.w, r0.w <span class="hljs-number"><span class="hljs-number">176</span></span>: mad r2.w, v0.y, l(<span class="hljs-number"><span class="hljs-number">50.000000</span></span>), cb0[<span class="hljs-number"><span class="hljs-number">0</span></span>].x <span class="hljs-number"><span class="hljs-number">177</span></span>: round_ni r4.w, r2.w <span class="hljs-number"><span class="hljs-number">178</span></span>: bfrev r4.w, r4.w <span class="hljs-number"><span class="hljs-number">179</span></span>: iadd r5.x, r1.w, r4.w <span class="hljs-number"><span class="hljs-number">180</span></span>: ishr r5.y, r5.x, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">181</span></span>: xor r5.x, r5.x, r5.y <span class="hljs-number"><span class="hljs-number">182</span></span>: imul null, r5.y, r5.x, r5.x <span class="hljs-number"><span class="hljs-number">183</span></span>: imad r5.y, r5.y, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">184</span></span>: imad r5.x, r5.x, r5.y, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">185</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r5.x, r5.x, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">186</span></span>: itof r5.x, r5.x <span class="hljs-number"><span class="hljs-number">187</span></span>: mad r5.y, v0.x, l(<span class="hljs-number"><span class="hljs-number">100.000000</span></span>), l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">188</span></span>: round_ni r5.y, r5.y <span class="hljs-number"><span class="hljs-number">189</span></span>: iadd r4.w, r4.w, r5.y <span class="hljs-number"><span class="hljs-number">190</span></span>: ishr r5.z, r4.w, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">191</span></span>: xor r4.w, r4.w, r5.z <span class="hljs-number"><span class="hljs-number">192</span></span>: imul null, r5.z, r4.w, r4.w <span class="hljs-number"><span class="hljs-number">193</span></span>: imad r5.z, r5.z, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">194</span></span>: imad r4.w, r4.w, r5.z, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">195</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r4.w, r4.w, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">196</span></span>: itof r4.w, r4.w <span class="hljs-number"><span class="hljs-number">197</span></span>: add r5.z, r2.w, l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">198</span></span>: round_ni r5.z, r5.z <span class="hljs-number"><span class="hljs-number">199</span></span>: bfrev r5.z, r5.z <span class="hljs-number"><span class="hljs-number">200</span></span>: iadd r1.w, r1.w, r5.z <span class="hljs-number"><span class="hljs-number">201</span></span>: ishr r5.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">202</span></span>: xor r1.w, r1.w, r5.w <span class="hljs-number"><span class="hljs-number">203</span></span>: imul null, r5.w, r1.w, r1.w <span class="hljs-number"><span class="hljs-number">204</span></span>: imad r5.w, r5.w, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">205</span></span>: imad r1.w, r1.w, r5.w, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">206</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r1.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">207</span></span>: itof r1.w, r1.w <span class="hljs-number"><span class="hljs-number">208</span></span>: mul r1.w, r1.w, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>) <span class="hljs-number"><span class="hljs-number">209</span></span>: iadd r5.y, r5.z, r5.y <span class="hljs-number"><span class="hljs-number">210</span></span>: ishr r5.z, r5.y, l(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">211</span></span>: xor r5.y, r5.y, r5.z <span class="hljs-number"><span class="hljs-number">212</span></span>: imul null, r5.z, r5.y, r5.y <span class="hljs-number"><span class="hljs-number">213</span></span>: imad r5.z, r5.z, l(<span class="hljs-number"><span class="hljs-number">0x0000ec4d</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span>) <span class="hljs-number"><span class="hljs-number">214</span></span>: imad r5.y, r5.y, r5.z, l(<span class="hljs-number"><span class="hljs-number">146956042240.000000</span></span>) <span class="hljs-number"><span class="hljs-number">215</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> r5.y, r5.y, l(<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>) <span class="hljs-number"><span class="hljs-number">216</span></span>: itof r5.y, r5.y <span class="hljs-number"><span class="hljs-number">217</span></span>: frc r0.w, r0.w <span class="hljs-number"><span class="hljs-number">218</span></span>: add r0.w, -r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">219</span></span>: mul r5.z, r0.w, r0.w <span class="hljs-number"><span class="hljs-number">220</span></span>: mul r0.w, r0.w, r5.z <span class="hljs-number"><span class="hljs-number">221</span></span>: mul r5.xz, r5.xxzx, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">3.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">222</span></span>: mad r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r5.z <span class="hljs-number"><span class="hljs-number">223</span></span>: frc r2.w, r2.w <span class="hljs-number"><span class="hljs-number">224</span></span>: add r2.w, -r2.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">225</span></span>: mul r5.z, r2.w, r2.w <span class="hljs-number"><span class="hljs-number">226</span></span>: mul r2.w, r2.w, r5.z <span class="hljs-number"><span class="hljs-number">227</span></span>: mul r5.z, r5.z, l(<span class="hljs-number"><span class="hljs-number">3.000000</span></span>) <span class="hljs-number"><span class="hljs-number">228</span></span>: mad r2.w, r2.w, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r5.z <span class="hljs-number"><span class="hljs-number">229</span></span>: mad r4.w, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r5.x <span class="hljs-number"><span class="hljs-number">230</span></span>: mad r4.w, r0.w, r4.w, r5.x <span class="hljs-number"><span class="hljs-number">231</span></span>: mad r5.x, r5.y, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r1.w <span class="hljs-number"><span class="hljs-number">232</span></span>: mad r0.w, r0.w, r5.x, r1.w <span class="hljs-number"><span class="hljs-number">233</span></span>: add r0.w, -r4.w, r0.w <span class="hljs-number"><span class="hljs-number">234</span></span>: mad r0.w, r2.w, r0.w, r4.w <span class="hljs-number"><span class="hljs-number">235</span></span>: mad r2.xyz, r0.wwww, l(<span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r2.xyzx <span class="hljs-number"><span class="hljs-number">236</span></span>: sample_indexable(texturecube)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r2.xyz, r2.xyzx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">237</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r4.xyz, r4.xyzx <span class="hljs-number"><span class="hljs-number">238</span></span>: mul r4.xyz, r4.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">239</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r4.xyz, r4.xyzx <span class="hljs-number"><span class="hljs-number">240</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r2.xyz, r2.xyzx <span class="hljs-number"><span class="hljs-number">241</span></span>: mul r2.xyz, r2.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">2.200000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">242</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r2.xyz, r2.xyzx <span class="hljs-number"><span class="hljs-number">243</span></span>: mul r2.xyz, r2.xyzx, r4.xyzx</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">嗯让我们看一下这段相当长的汇编代码的结尾。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font><font style="vertical-align: inherit;">第173行上</font><font style="vertical-align: inherit;">对</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行</font><font style="vertical-align: inherit;">采样后</font><font style="vertical-align: inherit;">，我们计算出某种</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">偏移</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">。该</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">偏移量</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于使采样的第一个方向失真（r2.xyz，第235行），然后再次对恒星的三次方图进行采样，对这两个值进行伽玛校正（237-242）并将它们相乘（243）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">简单吧？好吧，不是真的。让我们考虑一下这个</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">偏移量</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在整个穹顶中，此值应有所不同-闪烁的星星看起来非常不现实。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抵消</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果UV尽可能多样化，我们将利用UV延伸到天穹（v0.xy）并应用存储在常量缓冲区（cb [0] .x）中的经过时间这一事实。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您不熟悉这些令人恐惧的ishr / xor /，那么在有关闪电效果的部分中，请阅读有关整数噪声的内容。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，这里会产生四次整数噪声，但它不同于雷电。为了使结果更加随机，噪声的输入整数是总和（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iadd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），并且将其</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与之取</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">反（内部函数</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">reversebits</font></a><font style="vertical-align: inherit;">；</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bfrev</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指令</font><font style="vertical-align: inherit;">）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所以，现在慢下来。让我们从头开始。</font></font><br><br>    4 «»  .    ,   4   : <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> asint( <span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(x) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReverseInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> reversebits( getInt(x) ); } <span class="hljs-comment"><span class="hljs-comment">// * Inputs - UV and elapsed time in seconds float2 starsUV; starsUV.x = 100.0 * Input.TextureUV.x; starsUV.y = 50.0 * Input.TextureUV.y + g_fTime; // * Iteration 1 int iStars1_A = getReverseInt( starsUV.y ); int iStars1_B = getInt( starsUV.x ); float fStarsNoise1 = integerNoise( iStars1_A + iStars1_B ); // * Iteration 2 int iStars2_A = getReverseInt( starsUV.y ); int iStars2_B = getInt( starsUV.x - 1.0 ); float fStarsNoise2 = integerNoise( iStars2_A + iStars2_B ); // * Iteration 3 int iStars3_A = getReverseInt( starsUV.y - 1.0 ); int iStars3_B = getInt( starsUV.x ); float fStarsNoise3 = integerNoise( iStars3_A + iStars3_B ); // * Iteration 4 int iStars4_A = getReverseInt( starsUV.y - 1.0 ); int iStars4_B = getInt( starsUV.x - 1.0 ); float fStarsNoise4 = integerNoise( iStars4_A + iStars4_B );</span></span></code> </pre> <br>     4  (  ,    <i>itof</i> ): <br><br>  1 — r5.x, <br><br>  2 — r4.w, <br><br>  3 — r1.w, <br><br>  4 — r5.y <br><br>   <i>itof</i> ( 216)  : <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">217</span></span>: frc r0.w, r0.w <span class="hljs-number"><span class="hljs-number">218</span></span>: add r0.w, -r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">219</span></span>: mul r5.z, r0.w, r0.w <span class="hljs-number"><span class="hljs-number">220</span></span>: mul r0.w, r0.w, r5.z <span class="hljs-number"><span class="hljs-number">221</span></span>: mul r5.xz, r5.xxzx, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">3.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">222</span></span>: mad r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r5.z <span class="hljs-number"><span class="hljs-number">223</span></span>: frc r2.w, r2.w <span class="hljs-number"><span class="hljs-number">224</span></span>: add r2.w, -r2.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">225</span></span>: mul r5.z, r2.w, r2.w <span class="hljs-number"><span class="hljs-number">226</span></span>: mul r2.w, r2.w, r5.z <span class="hljs-number"><span class="hljs-number">227</span></span>: mul r5.z, r5.z, l(<span class="hljs-number"><span class="hljs-number">3.000000</span></span>) <span class="hljs-number"><span class="hljs-number">228</span></span>: mad r2.w, r2.w, l(<span class="hljs-number"><span class="hljs-number">-2.000000</span></span>), r5.z</code> </pre> <br>     S-        UV,      . 因此： <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s_curve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x2 = x * x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x3 = x2 * x; <span class="hljs-comment"><span class="hljs-comment">// -2x^3 + 3x^2 return -2.0*x3 + 3.0*x2; } ... // lines 217-222 float weightX = 1.0 - frac( starsUV.x ); weightX = s_curve( weightX ); // lines 223-228 float weightY = 1.0 - frac( starsUV.y ); weightY = s_curve( weightY );</span></span></code> </pre> <br>    ,              : <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">229</span></span>: mad r4.w, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r5.x <span class="hljs-number"><span class="hljs-number">230</span></span>: mad r4.w, r0.w, r4.w, r5.x <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> noise0 = lerp( fStarsNoise1, fStarsNoise2, weightX ); <span class="hljs-number"><span class="hljs-number">231</span></span>: mad r5.x, r5.y, l(<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>), -r1.w <span class="hljs-number"><span class="hljs-number">232</span></span>: mad r0.w, r0.w, r5.x, r1.w <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> noise1 = lerp( fStarsNoise3, fStarsNoise4, weightX ); <span class="hljs-number"><span class="hljs-number">233</span></span>: add r0.w, -r4.w, r0.w <span class="hljs-number"><span class="hljs-number">234</span></span>: mad r0.w, r2.w, r0.w, r4.w <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> offset = lerp( noise0, noise1, weightY ); <span class="hljs-number"><span class="hljs-number">235</span></span>: mad r2.xyz, r0.wwww, l(<span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000500</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r2.xyzx <span class="hljs-number"><span class="hljs-number">236</span></span>: sample_indexable(texturecube)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r2.xyz, r2.xyzx, t0.xyzw, s0 float3 starsPerturbedDir = dirXYZ + offset * <span class="hljs-number"><span class="hljs-number">0.0005</span></span>; float3 starsColorDisturbed = texNightStars.Sample( samplerAnisoWrap, starsPerturbedDir ).rgb;</code> </pre> <br>     <i>offset</i> : <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/SAI-cLJFpfg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在计算了</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColorDisturbed之后，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最难的部分就完成了。</font></font>万岁！ <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一步是对</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsColorDisturbed</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行伽玛校正</font><font style="vertical-align: inherit;">，然后将它们相乘：</font></font><br><br><pre> <code class="cpp hljs"> starsColor = <span class="hljs-built_in"><span class="hljs-built_in">pow</span></span>( starsColor, <span class="hljs-number"><span class="hljs-number">2.2</span></span> ); starsColorDisturbed = <span class="hljs-built_in"><span class="hljs-built_in">pow</span></span>( starsColorDisturbed, <span class="hljs-number"><span class="hljs-number">2.2</span></span> ); float3 starsFinal = starsColor * starsColorDisturbed;</code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 星星-画龙点睛 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们有</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsFinal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在r1.xyz。</font><font style="vertical-align: inherit;">在星形处理结束时，将发生以下情况：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">256</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r1.xyz, r1.xyzx <span class="hljs-number"><span class="hljs-number">257</span></span>: mul r1.xyz, r1.xyzx, l(<span class="hljs-number"><span class="hljs-number">2.500000</span></span>, <span class="hljs-number"><span class="hljs-number">2.500000</span></span>, <span class="hljs-number"><span class="hljs-number">2.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">258</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r1.xyz, r1.xyzx <span class="hljs-number"><span class="hljs-number">259</span></span>: min r1.xyz, r1.xyzx, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">260</span></span>: add r0.w, -cb0[<span class="hljs-number"><span class="hljs-number">9</span></span>].w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">261</span></span>: mul r1.xyz, r0.wwww, r1.xyzx <span class="hljs-number"><span class="hljs-number">262</span></span>: mul r1.xyz, r1.xyzx, l(<span class="hljs-number"><span class="hljs-number">10.000000</span></span>, <span class="hljs-number"><span class="hljs-number">10.000000</span></span>, <span class="hljs-number"><span class="hljs-number">10.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与闪烁和移动的恒星相比，这要容易得多。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，我们首先将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starsFinal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提高</font><font style="vertical-align: inherit;">到2.5的幂-这使我们可以控制星星的密度。</font><font style="vertical-align: inherit;">很聪明 </font><font style="vertical-align: inherit;">然后，使星星的最大颜色等于float3（1、1、1）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb0 [9] .w用于控制恒星的整体可见性。</font><font style="vertical-align: inherit;">因此，我们可以预期在白天该值为1.0（乘以零），而在晚上为0.0。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后，我们将恒星的能见度提高了10。就这样！</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第3部分。巫师天才（对象和亮度图） </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">几乎所有先前描述的效果和技术都与巫师3并没有真正的联系，诸如色调校正，渐晕或计算平均亮度之类的事情几乎出现在每个现代游戏中。</font><font style="vertical-align: inherit;">甚至中毒的影响也相当普遍。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这就是为什么我决定仔细研究“维克特本能”的渲染机制。</font><font style="vertical-align: inherit;">杰拉特（Geralt）是个巫师，因此他的感情比普通人要敏锐得多。</font><font style="vertical-align: inherit;">因此，他比其他人可以看到和听到更多的声音，这对他的调查非常有帮助。</font><font style="vertical-align: inherit;">巫师的天赋机制允许玩家可视化此类痕迹。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是效果的演示：</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/794z0wbcI6U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 还有一个，具有更好的照明： </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ReB6IrOb3ic" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，有两种类型的对象：Geralt可以与之交互的对象（黄色轮廓）和与调查相关联的痕迹（红色轮廓）。</font><font style="vertical-align: inherit;">杰拉特（Geralt）检查了红色足迹后，它可能变成黄色（第一个视频）。</font><font style="vertical-align: inherit;">请注意，整个屏幕变为灰色，并添加了鱼眼效果（第二个视频）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这种影响相当复杂，因此我决定将他的研究分为三个部分。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第一篇中，我将讨论对象的选择，第二篇中，将讨论轮廓的生成，第三篇中，将所有这些元素最终统一为一个整体。</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 选择对象 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正如我所说，有两种类型的对象，我们需要对其进行区分。</font><font style="vertical-align: inherit;">在Witcher 3中，这是使用模板缓冲区实现的。</font><font style="vertical-align: inherit;">生成应标记为“迹线”（红色）的GBuffer网格物体时，将以stencil = 8渲染它们。以黄色标记为“有趣”对象的网格物体将以stencil = 4渲染</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。例如，以下两个纹理显示了一个示例框架，其中包含可见的巫师本能和相应的模具缓冲区：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a6/7ed/667/2a67ed667870cd52dcf0da4f366975b6.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac7/a84/a9c/ac7a84a9c8aa25c1685a2a5f83f7447f.jpg"></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 模板缓冲简介 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模板缓冲区通常在游戏中用于标记网格。</font><font style="vertical-align: inherit;">某些类别的网格被分配了相同的ID。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">想法是，</font><font style="vertical-align: inherit;">如果模板测试成功，</font><font style="vertical-align: inherit;">则将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Always</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">与</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replace</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符</font><font style="vertical-align: inherit;">一起使用</font><font style="vertical-align: inherit;">，而</font><font style="vertical-align: inherit;">在所有其他情况下</font><font style="vertical-align: inherit;">，与</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符</font><font style="vertical-align: inherit;">一起使用。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是使用D3D11实施的方法：</font></font><br><br><pre> <code class="cpp hljs"> D3D11_DEPTH_STENCIL_DESC depthstencilState; <span class="hljs-comment"><span class="hljs-comment">// Set depth parameters.... // Enable stencil depthstencilState.StencilEnable = TRUE; // Read &amp; write all bits depthstencilState.StencilReadMask = 0xFF; depthstencilState.StencilWriteMask = 0xFF; // Stencil operator for front face depthstencilState.FrontFace.StencilFunc = D3D11_COMPARISON_ALWAYS; depthstencilState.FrontFace.StencilDepthFailOp = D3D11_STENCIL_OP_KEEP; depthstencilState.FrontFace.StencilFailOp = D3D11_STENCIL_OP_KEEP; depthstencilState.FrontFace.StencilPassOp = D3D11_STENCIL_OP_REPLACE; // Stencil operator for back face. depthstencilState.BackFace.StencilFunc = D3D11_COMPARISON_ALWAYS; depthstencilState.BackFace.StencilDepthFailOp = D3D11_STENCIL_OP_KEEP; depthstencilState.BackFace.StencilFailOp = D3D11_STENCIL_OP_KEEP; depthstencilState.BackFace.StencilPassOp = D3D11_STENCIL_OP_REPLACE; pDevice-&gt;CreateDepthStencilState( &amp;depthstencilState, &amp;m_pDS_AssignValue );</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要写入缓冲区的stensil值</font><font style="vertical-align: inherit;">在API调用中</font><font style="vertical-align: inherit;">作为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StencilRef</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传递</font><font style="vertical-align: inherit;">：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// from now on set stencil buffer values to 8 pDevCon-&gt;OMSetDepthStencilState( m_pDS_AssignValue, 8 ); ... pDevCon-&gt;DrawIndexed( ... );</span></span></code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 渲染亮度 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从实现的角度来看，这段代码以R11G11B10_FLOAT格式提供了一个全屏纹理，在通道R和G中存储了有趣的对象和迹线。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么在亮度方面需要这样做？</font><font style="vertical-align: inherit;">事实证明，Geralt的本能只有有限的半径，因此，只有当玩家离他们足够近时，对象才会获得轮廓。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">看看实际的这方面：</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Xbs-ZRJ7v1w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6f1/073/f03/6f1073f03172250a5b4c052ebfdfd832.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们首先清洁亮度纹理，然后用黑色填充。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后进行两个全屏绘制调用：第一个用于跟踪，第二个用于有趣的对象：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/077/c17/138/077c1713805b1f95625c05fb11643c53.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第一次进行描画调用-绿色通道： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/14f/7df/63e/14f7df63e4e1760304e4a2c6279953d1.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第二个调用是针对有趣的对象-红色通道： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6db/379/add/6db379add4ffc7f54a047f79b608d67f.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">好吧，但是我们如何确定要考虑的像素呢？</font><font style="vertical-align: inherit;">我们将不得不使用模板缓冲区！</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于这些调用中的每个调用，都将进行模板测试，并且仅接受先前标记为“ 8”（第一次绘制调用）或“ 4”的那些像素。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模板测试痕迹的可视化：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a60/227/b57/a60227b575f307ad5a251aa817a49963.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ...以及有趣的对象： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/014/6eb/5f4/0146eb5f4da50018f5d28b4453e2424c.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下如何进行测试？</font><font style="vertical-align: inherit;">您可以在一篇不错的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文章中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了解模板测试的基础知识</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">通常，模板测试公式具有以下形式：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (StencilRef &amp; StencilReadMask OP StencilValue &amp; StencilReadMask) accept pixel <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> discard pixel</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其中：</font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StencilRef</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是API调用传递的值，</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StencilReadMask</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是用于读取Stensil值的掩码（请注意，它同时出现在左右两侧），</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OP</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是通过API设置的比较运算符，</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StencilValue</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是模板缓冲区的值在当前正在处理的像素中。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要的是要理解我们使用二进制AND来计算操作数。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">熟悉基础知识之后，让我们看看如何在以下绘制调用中使用这些参数：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/164/373/d2c/164373d2c3421c708e40dc9cb26eb7c9.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迹线的模具条件</font></font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e5/3c0/ae3/1e53c0ae3680bebe785e64739c4ece43.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模具状态为有趣的物体</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">哈！</font><font style="vertical-align: inherit;">如我们所见，唯一的区别是ReadMask。</font><font style="vertical-align: inherit;">让我们看看吧！</font><font style="vertical-align: inherit;">将这些值替换为模板测试方程式：</font></font><br><br><pre> <code class="cpp hljs"> Let StencilReadMask = <span class="hljs-number"><span class="hljs-number">0x08</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> StencilRef = <span class="hljs-number"><span class="hljs-number">0</span></span>: For a pixel with stencil = <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x08</span></span> &lt; <span class="hljs-number"><span class="hljs-number">8</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x08</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; <span class="hljs-number"><span class="hljs-number">8</span></span> TRUE For a pixel with stencil = <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x08</span></span> &lt; <span class="hljs-number"><span class="hljs-number">4</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x08</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> FALSE</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聪明地 </font><font style="vertical-align: inherit;">如您所见，在这种情况下，我们不比较模板值，而是检查模板缓冲区的某个位是否已设置。</font><font style="vertical-align: inherit;">模板缓冲区的每个像素均具有uint8格式，因此值的间隔为[0-255]。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：所有</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DrawIndexed（36）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用</font><font style="vertical-align: inherit;">都与将脚印渲染为脚印有关，因此在此特定帧中，亮度贴图具有以下最终形式：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/917/f0d/d04/917f0dd0490ef8faa829ede007838906.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但是在模板测试之前，有一个像素着色器。</font><font style="vertical-align: inherit;">28738和28748都使用相同的像素着色器：</font></font><br><br><pre> <code class="cpp hljs"> ps_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>], immediateIndexed dcl_constantbuffer cb3[<span class="hljs-number"><span class="hljs-number">8</span></span>], immediateIndexed dcl_constantbuffer cb12[<span class="hljs-number"><span class="hljs-number">214</span></span>], immediateIndexed dcl_sampler s15, <span class="hljs-function"><span class="hljs-function">mode_default </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t15 dcl_input_ps_siv v0.xy, position dcl_output o0.xyzw dcl_output o1.xyzw dcl_output o2.xyzw dcl_output o3.xyzw dcl_temps 2 0: mul r0.xy, v0.xyxx, cb0[1].zwzz 1: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.x, r0.xyxx, t15.xyzw, s15 2: mul r1.xyzw, v0.yyyy, cb12[211].xyzw 3: mad r1.xyzw, cb12[210].xyzw, v0.xxxx, r1.xyzw 4: mad r0.xyzw, cb12[212].xyzw, r0.xxxx, r1.xyzw 5: add r0.xyzw, r0.xyzw, cb12[213].xyzw 6: div r0.xyz, r0.xyzx, r0.wwww 7: add r0.xyz, r0.xyzx, -cb3[7].xyzx 8: dp3 r0.x, r0.xyzx, r0.xyzx 9: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">sqrt</span></span></span><span class="hljs-function"> r0.x, r0.x 10: mul r0.y, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.120000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 11: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">log</span></span></span><span class="hljs-function"> r1.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cb3[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span><span class="hljs-function"><span class="hljs-params">].y)</span></span></span><span class="hljs-function"> 12: mul r1.xy, r1.xxxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.800000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.800000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 13: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exp</span></span></span><span class="hljs-function"> r1.xy, r1.xyxx 14: mad r0.zw, r1.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">120.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">120.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 15: lt r1.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.030000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, cb3[6].y 16: movc r0.xy, r1.xxxx, r0.yzyy, r0.xwxx 17: div r0.x, r0.x, r0.y 18: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">log</span></span></span><span class="hljs-function"> r0.x, r0.x 19: mul r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.600000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 20: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exp</span></span></span><span class="hljs-function"> r0.x, r0.x 21: add r0.x, -r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 22: max r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 23: mul o0.xyz, r0.xxxx, cb3[0].xyzx 24: mov o0.w, cb3[0].w 25: mov o1.xyzw, cb3[1].xyzw 26: mov o2.xyzw, cb3[2].xyzw 27: mov o3.xyzw, cb3[3].xyzw 28: ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此像素着色器仅写入一个渲染目标，因此第24-27行是多余的。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里发生的第一件事是深度采样（使用具有值限制的点采样器），第1行。该值用于通过乘以特殊矩阵再进行透视划分（第2-6行）来重新创建世界上的位置。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">考虑Geralt的位置（cb3 [7] .xyz-注意，这</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不是</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">相机</font><i><font style="vertical-align: inherit;">的</font></i><font style="vertical-align: inherit;">位置！），我们计算出Geralt到该特定点的距离（第7-9行）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下输入在此着色器中很重要：</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-cb3 [0] .rgb-输出颜色。它的格式可以为float3（0，1，0）（迹线）或float3（1，0，0）（有趣的对象），</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-cb3 [6] .y-距离比例因子。</font><font style="vertical-align: inherit;">直接影响最终输出的半径和亮度。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后来，我们有了相当复杂的公式来计算亮度，具体取决于Geralt和物体之间的距离。</font><font style="vertical-align: inherit;">我可以假设所有系数都是通过实验选择的。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最终输出是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">颜色</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> * </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">强度</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSL代码如下所示：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FSInput</span></span></span><span class="hljs-class"> {</span></span> float4 param0 : SV_Position; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FSOutput</span></span></span><span class="hljs-class"> {</span></span> float4 param0 : SV_Target0; float4 param1 : SV_Target1; float4 param2 : SV_Target2; float4 param3 : SV_Target3; }; <span class="hljs-function"><span class="hljs-function">float3 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWorldPos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( float2 screenPos, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> depth )</span></span></span><span class="hljs-function"> </span></span>{ float4 worldPos = float4(screenPos, depth, <span class="hljs-number"><span class="hljs-number">1.0</span></span>); worldPos = mul( worldPos, screenToWorld ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> worldPos.xyz / worldPos.w; } <span class="hljs-function"><span class="hljs-function">FSOutput </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EditedShaderPS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(in FSInput IN)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// * Inputs // Directly affects radius of the effect float distanceScaling = cb3_v6.y; // Color of output at the end float3 color = cb3_v0.rgb; // Sample depth float2 uv = IN.param0.xy * cb0_v1.zw; float depth = texture15.Sample( sampler15, uv ).x; // Reconstruct world position float3 worldPos = getWorldPos( IN.param0.xy, depth ); // Calculate distance from Geralt to world position of particular object float dist_geraltToWorld = length( worldPos - cb3_v7.xyz ); // Calculate two squeezing params float t0 = 1.0 + 120*pow( abs(distanceScaling), 2.8 ); float t1 = 1.0 + 120*pow( abs(distanceScaling), 0.8 ); // Determine nominator and denominator float2 params; params = (distanceScaling &gt; 0.03) ? float2(dist_geraltToWorld * 0.12, t0) : float2(dist_geraltToWorld, t1); // Distance Geralt &lt;-&gt; Object float nominator = params.x; // Hiding factor float denominator = params.y; // Raise to power of 1.6 float param = pow( params.x / params.y, 1.6 ); // Calculate final intensity float intensity = max(0.0, 1.0 - param ); // * Final outputs. // * // * This PS outputs only one color, the rest // * is redundant. I just added this to keep 1-1 ratio with // * original assembly. FSOutput OUT = (FSOutput)0; OUT.param0.xyz = color * intensity; // == redundant == OUT.param0.w = cb3_v0.w; OUT.param1 = cb3_v1; OUT.param2 = cb3_v2; OUT.param3 = cb3_v3; // =============== return OUT; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 原始（左）和我的（右）汇编器着色器代码的比较。 </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68c/07d/1d6/68c07d1d6fd99f81cb0b3b63c9927a53.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">巫婆天赋</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作用的第一步</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">实际上，这是最简单的。</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第4部分。巫师的天才（轮廓图） </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 再次看一下我们正在探索的场景： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a6/7ed/667/2a67ed667870cd52dcf0da4f366975b6.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在分析女巫的本能的第一部分中，我展示了如何生成“亮度图”。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们有一个R11G11B10_FLOAT格式的全屏纹理，看起来可能像这样：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/917/f0d/d04/917f0dd0490ef8faa829ede007838906.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绿色通道表示“足迹”，红色是Geralt可以与之交互的有趣对象。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收到此纹理后，我们可以进入下一个阶段-我将其称为“轮廓图”。</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1bf/428/855/1bf4288554d1cef31c2607a4ca73c2bb.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是512x512 R16G16_FLOAT格式的怪异纹理。</font><font style="vertical-align: inherit;">以“乒乓”的方式实现它很重要。</font><font style="vertical-align: inherit;">前一帧的轮廓图是输入数据（连同亮度图），以在当前帧中生成新的轮廓图。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">乒乓缓冲区可以通过多种方式实现，但我个人最喜欢以下内容（伪代码）：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Declarations Texture2D m_texOutlineMap[2]; uint m_outlineIndex = 0; // Rendering void Render() { pDevCon-&gt;SetInputTexture( m_texOutlineMap[m_outlineIndex] ); pDevCon-&gt;SetOutputTexture( m_texOutlineMap[!m_outlineIndex] ); ... pDevCon-&gt;Draw(...); // after draw m_outlineIndex = !m_outlineIndex; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这种方法的输入始终为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[m_outlineIndex]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而输出始终为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[！M_outlineIndex]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，为使用其他后期效果提供了灵活性。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一下像素着色器：</font></font><br><br><pre> <code class="cpp hljs"> ps_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb3[<span class="hljs-number"><span class="hljs-number">1</span></span>], immediateIndexed dcl_sampler s0, mode_default dcl_sampler s1, <span class="hljs-function"><span class="hljs-function">mode_default </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t1 dcl_input_ps linear v2.xy dcl_output o0.xyzw dcl_temps 4 0: add r0.xyzw, v2.xyxy, v2.xyxy 1: round_ni r1.xy, r0.zwzz 2: frc r0.xyzw, r0.xyzw 3: add r1.zw, r1.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 4: dp2 r1.z, r1.zwzz, r1.zwzz 5: add r1.z, -r1.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 6: max r2.w, r1.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 7: dp2 r1.z, r1.xyxx, r1.xyxx 8: add r3.xyzw, r1.xyxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 9: add r1.x, -r1.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 10: max r2.x, r1.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 11: dp2 r1.x, r3.xyxx, r3.xyxx 12: dp2 r1.y, r3.zwzz, r3.zwzz 13: add r1.xy, -r1.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 14: max r2.yz, r1.xxyx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 15: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.xyzw, r0.zwzz, t1.xyzw, s1 16: dp4 r1.x, r1.xyzw, r2.xyzw 17: add r2.xyzw, r0.zwzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.003906</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.003906</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 18: add r0.xyzw, r0.xyzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.003906</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.003906</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 19: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.yz, r2.xyxx, t1.zxyw, s1 20: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r2.xy, r2.zwzz, t1.xyzw, s1 21: add r1.yz, r1.yyzy, -r2.xxyx 22: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.xy, r0.xyxx, t1.xyzw, s1 23: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.zw, r0.zwzz, t1.zwxy, s1 24: add r0.xy, -r0.zwzz, r0.xyxx 25: max r0.xy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0.xyxx)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r1.yzyy)</span></span></span><span class="hljs-function"> 26: min r0.xy, r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 27: mul r0.xy, r0.xyxx, r1.xxxx 28: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.zw, v2.xyxx, t0.zwxy, s0 29: mad r0.w, r1.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.150000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.w 30: mad r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.350000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.w 31: mad r0.x, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.350000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.x 32: mul r0.yw, cb3[0].zzzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">300.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">300.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 33: mad r0.yw, v2.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">150.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">150.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.yyyw 34: ftoi r0.yw, r0.yyyw 35: bfrev r0.w, r0.w 36: iadd r0.y, r0.w, r0.y 37: ishr r0.w, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">13</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 38: xor r0.y, r0.y, r0.w 39: imul null, r0.w, r0.y, r0.y 40: imad r0.w, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0x0000ec4d</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.0000000000000000000000000000000000001</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 41: imad r0.y, r0.y, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">146956042240.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 42: </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">and</span></span></span><span class="hljs-function"> r0.y, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0x7fffffff</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 43: itof r0.y, r0.y 44: mad r0.y, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000001</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.650000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 45: add_sat r1.xyzw, v2.xyxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.001953</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.001953</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 46: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.w, r1.xyxx, t0.yzwx, s0 47: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.x, r1.zwzz, t0.xyzw, s0 48: add r0.w, r0.w, r1.x 49: add_sat r1.xyzw, v2.xyxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.001953</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.001953</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 50: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.x, r1.xyxx, t0.xyzw, s0 51: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r1.y, r1.zwzz, t0.yxzw, s0 52: add r0.w, r0.w, r1.x 53: add r0.w, r1.y, r0.w 54: mad r0.w, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.250000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, -r0.z 55: mul r0.w, r0.y, r0.w 56: mul r0.y, r0.y, r0.z 57: mad r0.x, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.900000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.x 58: mad r0.y, r0.y, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.240000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r0.x 59: add r0.x, r0.y, r0.z 60: mov_sat r0.z, cb3[0].x 61: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">log</span></span></span><span class="hljs-function"> r0.z, r0.z 62: mul r0.z, r0.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">100.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 63: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exp</span></span></span><span class="hljs-function"> r0.z, r0.z 64: mad r0.z, r0.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.160000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.700000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 65: mul o0.xy, r0.zzzz, r0.xyxx 66: mov o0.zw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 67: ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 如您所见，输出轮廓图被分为四个相等的正方形，这是我们需要研究的第一件事： </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0</span></span>: add r0.xyzw, v2.xyxy, v2.xyxy <span class="hljs-number"><span class="hljs-number">1</span></span>: round_ni r1.xy, r0.zwzz <span class="hljs-number"><span class="hljs-number">2</span></span>: frc r0.xyzw, r0.xyzw <span class="hljs-number"><span class="hljs-number">3</span></span>: add r1.zw, r1.xxxy, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span>: dp2 r1.z, r1.zwzz, r1.zwzz <span class="hljs-number"><span class="hljs-number">5</span></span>: add r1.z, -r1.z, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span>: max r2.w, r1.z, l(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: dp2 r1.z, r1.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">8</span></span>: add r3.xyzw, r1.xyxy, l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>: add r1.x, -r1.z, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">10</span></span>: max r2.x, r1.x, l(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">11</span></span>: dp2 r1.x, r3.xyxx, r3.xyxx <span class="hljs-number"><span class="hljs-number">12</span></span>: dp2 r1.y, r3.zwzz, r3.zwzz <span class="hljs-number"><span class="hljs-number">13</span></span>: add r1.xy, -r1.xyxx, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">14</span></span>: max r2.yz, r1.xxyx, l(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们首先计算地板（TextureUV * 2.0），这将为我们提供以下信息： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e25/7b3/e14/e257b3e14ac5b8a1f2b65525333924c5.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 为了确定各个正方形，使用了一个小函数： </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getParams</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(float2 uv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> d = dot(uv, uv); d = <span class="hljs-number"><span class="hljs-number">1.0</span></span> - d; d = max( d, <span class="hljs-number"><span class="hljs-number">0.0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请注意，该函数使用输入float2（0.0，0.0）返回1.0。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这种情况发生在左上角。</font><font style="vertical-align: inherit;">要在右上角得到相同的情况，请从四舍五入的texcoords中减去float2（1，0），为绿色正方形减去float2（0，1），为黄色正方形减去float2（1.0，1.0）。</font></font><br><br> 因此： <br><br><pre> <code class="cpp hljs"> float2 flooredTextureUV = <span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>( <span class="hljs-number"><span class="hljs-number">2.0</span></span> * TextureUV ); ... float2 uv1 = flooredTextureUV; float2 uv2 = flooredTextureUV + float2(<span class="hljs-number"><span class="hljs-number">-1.0</span></span>, <span class="hljs-number"><span class="hljs-number">-0.0</span></span>); float2 uv3 = flooredTextureUV + float2( <span class="hljs-number"><span class="hljs-number">-0.0</span></span>, <span class="hljs-number"><span class="hljs-number">-1.0</span></span>); float2 uv4 = flooredTextureUV + float2(<span class="hljs-number"><span class="hljs-number">-1.0</span></span>, <span class="hljs-number"><span class="hljs-number">-1.0</span></span>); float4 mask; mask.x = getParams( uv1 ); mask.y = getParams( uv2 ); mask.z = getParams( uv3 ); mask.w = getParams( uv4 );</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">蒙版</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成分</font><font style="vertical-align: inherit;">要么为零，要么为一，并负责纹理的一平方。</font><font style="vertical-align: inherit;">例如，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mask.r</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mask.w</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/559/e1c/242/559e1c242221886f5c0100fa66837c31.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遮罩</font></font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb5/108/a24/bb5108a241181f23a66c7f3803d33cea.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mask.w</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们有</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mask</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，让我们继续。</font><font style="vertical-align: inherit;">第15行采样亮度图。</font><font style="vertical-align: inherit;">请注意，尽管我们采样了所有rgba分量，但亮度纹理的格式为R11G11B10_FLOAT。</font><font style="vertical-align: inherit;">在这种情况下，假定.a为1.0f。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以将用于此操作的Texcoords计算为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frac（TextureUV * 2.0）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，此操作的结果可能例如如下所示：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/955/071/c05/955071c057420f3c4b083ed174046189.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">看到相似之处吗？</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一步非常明智-执行四分量标量积（dp4）：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">16</span></span>: dp4 r1.x, r1.xyzw, r2.xyzw</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，只有红色通道（即只有有趣的物体）保留在左上角，只有绿色通道在右上角（仅是迹线），并且所有在右下角都有（因为亮度分量.w被间接设置为1.0）。</font><font style="vertical-align: inherit;">好主意。</font><font style="vertical-align: inherit;">标量积的结果如下所示：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/37c/488/3ab/37c4883ab098cd1bc4ef2d22187f7d16.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收到此</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">masterFilter之后</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们就可以确定对象的轮廓了。</font><font style="vertical-align: inherit;">它并不像看起来那样困难。</font><font style="vertical-align: inherit;">该算法与用于获得清晰度的算法非常相似-我们需要获取值的最大绝对差。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这就是发生的情况：我们在要处理的当前纹理像素旁边采样四个纹理像素（重要的是：在这种情况下，纹理像素大小为1.0 / 256.0！），并计算红色和绿色通道的最大绝对差：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> fTexel = <span class="hljs-number"><span class="hljs-number">1.0</span></span> / <span class="hljs-number"><span class="hljs-number">256</span></span>; float2 sampling1 = TextureUV + float2( fTexel, <span class="hljs-number"><span class="hljs-number">0</span></span> ); float2 sampling2 = TextureUV + float2( -fTexel, <span class="hljs-number"><span class="hljs-number">0</span></span> ); float2 sampling3 = TextureUV + float2( <span class="hljs-number"><span class="hljs-number">0</span></span>, fTexel ); float2 sampling4 = TextureUV + float2( <span class="hljs-number"><span class="hljs-number">0</span></span>, -fTexel ); float2 intensity_x0 = texIntensityMap.Sample( sampler1, sampling1 ).xy; float2 intensity_x1 = texIntensityMap.Sample( sampler1, sampling2 ).xy; float2 intensity_diff_x = intensity_x0 - intensity_x1; float2 intensity_y0 = texIntensityMap.Sample( sampler1, sampling3 ).xy; float2 intensity_y1 = texIntensityMap.Sample( sampler1, sampling4 ).xy; float2 intensity_diff_y = intensity_y0 - intensity_y1; float2 maxAbsDifference = max( <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(intensity_diff_x), <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(intensity_diff_y) ); maxAbsDifference = saturate(maxAbsDifference);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，如果我们乘的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过滤器</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maxAbsDifference</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ...</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dcb/332/626/dcb332626d34f07ecf1bd85928b7d1dc.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常简单高效。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接收到轮廓后，我们从前一帧中采样轮廓图。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后，为了获得“幽灵般”的效果，我们采用了当前通过计算出的部分参数以及等高线图中的值。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向我们的老朋友问好-整数噪音。</font><font style="vertical-align: inherit;">他在这里。</font><font style="vertical-align: inherit;">动画参数（cb3 [0] .zw）从常量缓冲区中获取，并随时间变化。</font></font><br><br><pre> <code class="cpp hljs"> float2 outlines = masterFilter * maxAbsDifference; <span class="hljs-comment"><span class="hljs-comment">// Sample outline map float2 outlineMap = texOutlineMap.Sample( samplerLinearWrap, uv ).xy; // I guess it's related with ghosting float paramOutline = masterFilter*0.15 + outlineMap.y; paramOutline += 0.35 * outlines.r; paramOutline += 0.35 * outlines.g; // input for integer noise float2 noiseWeights = cb3_v0.zw; float2 noiseInputs = 150.0*uv + 300.0*noiseWeights; int2 iNoiseInputs = (int2) noiseInputs; float noise0 = clamp( integerNoise( iNoiseInputs.x + reversebits(iNoiseInputs.y) ), -1, 1 ) + 0.65; // r0.y</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：如果您想自己实现巫婆的本能，那么我建议将整数噪声限制为[-1; 1]区间（如其网站上所述）。</font><font style="vertical-align: inherit;">原始的TW3着色器没有任何限制，但是如果没有它，我将得到可怕的伪影，整个轮廓图不稳定。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后，我们以与之前的亮度图相同的方式对轮廓图进行采样（这次，纹理像素的大小为1.0 / 512.0），并计算.x分量的平均值：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// sampling of outline map fTexel = 1.0 / 512.0; sampling1 = saturate( uv + float2( fTexel, 0 ) ); sampling2 = saturate( uv + float2( -fTexel, 0 ) ); sampling3 = saturate( uv + float2( 0, fTexel ) ); sampling4 = saturate( uv + float2( 0, -fTexel ) ); float outline_x0 = texOutlineMap.Sample( sampler0, sampling1 ).x; float outline_x1 = texOutlineMap.Sample( sampler0, sampling2 ).x; float outline_y0 = texOutlineMap.Sample( sampler0, sampling3 ).x; float outline_y1 = texOutlineMap.Sample( sampler0, sampling4 ).x; float averageOutline = (outline_x0+outline_x1+outline_y0+outline_y1) / 4.0;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 然后，通过汇编代码判断，计算该特定像素的平均值与值之差，然后执行整数噪声引起的失真： </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// perturb with noise float frameOutlineDifference = averageOutline - outlineMap.x; frameOutlineDifference *= noise0;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一步是使用噪声使“旧”轮廓图的值失真-这是使输出纹理具有块状感觉的主线。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后还有其他计算，然后在最后计算“衰减”。</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// the main place with gives blocky look of texture float newNoise = outlineMap.x * noise0; float newOutline = frameOutlineDifference * 0.9 + paramOutline; newOutline -= 0.24*newNoise; // 59: add r0.x, r0.y, r0.z float2 finalOutline = float2( outlineMap.x + newOutline, newOutline); // * calculate damping float dampingParam = saturate( cb3_v0.x ); dampingParam = pow( dampingParam, 100 ); float damping = 0.7 + 0.16*dampingParam; // * final multiplication float2 finalColor = finalOutline * damping; return float4(finalColor, 0, 0);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 这是一个简短的视频，演示了实际的轮廓图： </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/vSscLz2RYsQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您对全像素着色器感兴趣，则可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处获得</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Shader与RenderDoc兼容。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有趣的是（老实说，有点烦人），尽管汇编代码与Witcher 3的原始着色器相同，但RenderDoc中轮廓图的最终外观仍在改变！</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：在最后一遍（请参阅下一部分）中，您将看到仅使用等高线图的.r通道。</font><font style="vertical-align: inherit;">为什么我们需要.g通道？</font><font style="vertical-align: inherit;">我认为这是一种纹理中的乒乓缓冲区-请注意.r包含.g通道+一些新值。</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第五部分：巫师的天才（鱼眼和最终结果） </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将简要列出我们已经拥有的东西：在第一部分中，专门针对女巫的直觉，将生成一个全屏亮度图，该图表明效果取决于距离的明显程度。</font><font style="vertical-align: inherit;">在第二部分中，我更详细地研究了轮廓图，该轮廓图负责完成效果的轮廓和动画。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们到了最后阶段。</font><font style="vertical-align: inherit;">所有这些都需要结合起来！</font><font style="vertical-align: inherit;">最后一遍是全屏四边形。</font><font style="vertical-align: inherit;">输入：颜色缓冲区，轮廓图和亮度图。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">至：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a6/7ed/667/2a67ed667870cd52dcf0da4f366975b6.jpg"></div><br><br> 之后： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/abf/ce7/1c4/abfce71c4469b6dcd077723d498c1685.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我将再次展示具有所应用效果的视频： </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ReB6IrOb3ic" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，除了将轮廓应用于Geralt可以看到或听到的对象之外，鱼眼效果还应用于整个屏幕，并且整个屏幕（尤其是角落）都变灰，以传达真正的怪物猎人的感觉。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全组装的像素着色器代码：</font></font><br><br><pre> <code class="cpp hljs"> ps_5_0 dcl_globalFlags refactoringAllowed dcl_constantbuffer cb0[<span class="hljs-number"><span class="hljs-number">3</span></span>], immediateIndexed dcl_constantbuffer cb3[<span class="hljs-number"><span class="hljs-number">7</span></span>], immediateIndexed dcl_sampler s0, mode_default dcl_sampler s2, <span class="hljs-function"><span class="hljs-function">mode_default </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dcl_resource_texture2d</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> t3 dcl_input_ps_siv v0.xy, position dcl_output o0.xyzw dcl_temps 7 0: div r0.xy, v0.xyxx, cb0[2].xyxx 1: mad r0.zw, r0.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 2: mov r1.yz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0.zzwz)</span></span></span><span class="hljs-function"> 3: div r0.z, cb0[2].x, cb0[2].y 4: mul r1.x, r0.z, r1.y 5: add r0.zw, r1.xxxz, -cb3[2].xxxy 6: mul_sat r0.zw, r0.zzzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.555556</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.555556</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 7: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">log</span></span></span><span class="hljs-function"> r0.zw, r0.zzzw 8: mul r0.zw, r0.zzzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 9: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exp</span></span></span><span class="hljs-function"> r0.zw, r0.zzzw 10: dp2 r0.z, r0.zwzz, r0.zwzz 11: </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">sqrt</span></span></span><span class="hljs-function"> r0.z, r0.z 12: min r0.z, r0.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 13: add r0.z, -r0.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 14: mov_sat r0.w, cb3[6].x 15: add_sat r1.xy, -r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.030000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.030000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 16: add r1.x, r1.y, r1.x 17: add_sat r0.xy, r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.970000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.970000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 18: add r0.x, r0.x, r1.x 19: add r0.x, r0.y, r0.x 20: mul r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">20.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 21: min r0.x, r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 22: add r1.xy, v0.xyxx, v0.xyxx 23: div r1.xy, r1.xyxx, cb0[2].xyxx 24: add r1.xy, r1.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 25: dp2 r0.y, r1.xyxx, r1.xyxx 26: mul r1.xy, r0.yyyy, r1.xyxx 27: mul r0.y, r0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.100000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 28: mul r1.xy, r0.yyyy, r1.xyxx 29: max r1.xy, r1.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.400000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-0.400000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 30: min r1.xy, r1.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.400000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.400000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 31: mul r1.xy, r1.xyxx, cb3[1].xxxx 32: mul r1.zw, r1.xxxy, cb0[2].zzzw 33: mad r1.zw, v0.xxxy, cb0[1].zzzw, -r1.zzzw 34: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r2.xyz, r1.zwzz, t0.xyzw, s0 35: mul r3.xy, r1.zwzz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 36: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.y, r3.xyxx, t2.yxzw, s2 37: mad r3.xy, r1.zwzz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 38: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r2.w, r3.xyxx, t2.yzwx, s2 39: mul r2.w, r2.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 40: mul r3.x, cb0[0].x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.100000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 41: add r0.x, -r0.x, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 42: mul r0.xy, r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.030000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 43: mov r3.yzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 44: mov r4.x, r0.y 45: mov r4.y, r2.w 46: mov r4.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 47: loop 48: ige r4.w, r4.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 49: breakc_nz r4.w 50: itof r4.w, r4.z 51: mad r4.w, r4.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.785375</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, -r3.x 52: sincos r5.x, r6.x, r4.w 53: mov r6.y, r5.x 54: mul r5.xy, r0.xxxx, r6.xyxx 55: mad r5.zw, r5.xxxy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r1.zzzw 56: mul r6.xy, r5.zwzz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 57: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r4.w, r6.xyxx, t2.yzwx, s2 58: mad r4.x, r4.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r4.x 59: mad r5.zw, r5.zzzw, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.500000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 60: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r4.w, r5.zwzz, t2.yzwx, s2 61: mad r4.y, r4.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r4.y 62: mad r5.xy, r5.xyxx, r1.xyxx, r1.zwzz 63: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r5.xyz, r5.xyxx, t0.xyzw, s0 64: mad r3.yzw, r5.xxyz, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.125000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r3.yyzw 65: iadd r4.z, r4.z, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 66: endloop 67: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_indexable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(texture2d)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> r0.xy, r1.zwzz, t3.xyzw, s0 68: mad_sat r0.xy, -r0.xyxx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.800000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.750000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r4.xyxx 69: dp3 r1.x, r3.yzwy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.300000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.300000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.300000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 70: add r1.yzw, -r1.xxxx, r3.yyzw 71: mad r1.xyz, r0.zzzz, r1.yzwy, r1.xxxx 72: mad r1.xyz, r1.xyzx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.600000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.600000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.600000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, -r2.xyzx 73: mad r1.xyz, r0.wwww, r1.xyzx, r2.xyzx 74: mul r0.yzw, r0.yyyy, cb3[4].xxyz 75: mul r2.xyz, r0.xxxx, cb3[5].xyzx 76: mad r0.xyz, r0.yzwy, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.200000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.200000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.200000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">, r2.xyzx 77: mov_sat r2.xyz, r0.xyzx 78: dp3_sat r0.x, r0.xyzx, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 79: add r0.yzw, -r1.xxyz, r2.xxyz 80: mad o0.xyz, r0.xxxx, r0.yzwy, r1.xyzx 81: mov o0.w, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> 82: ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">82行-所以我们要做很多工作！</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">首先，看一下输入数据：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// *** Inputs // * Zoom amount, always 1 float zoomAmount = cb3_v1.x; // Another value which affect fisheye effect // but always set to float2(1.0, 1.0). float2 amount = cb0_v2.zw; // Elapsed time in seconds float time = cb0_v0.x; // Colors of witcher senses float3 colorInteresting = cb3_v5.rgb; float3 colorTraces = cb3_v4.rgb; // Was always set to float2(0.0, 0.0). // Setting this to higher values // makes "grey corners" effect weaker. float2 offset = cb3_v2.xy; // Dimensions of fullscreen float2 texSize = cb0_v2.xy; float2 invTexSize = cb0_v1.zw; // Main value which causes fisheye effect [0-1] const float fisheyeAmount = saturate( cb3_v6.x );</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影响效果大小的主要值是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fisheyeAmount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我认为Geralt开始使用本能时，它会从0.0逐渐上升到1.0。</font><font style="vertical-align: inherit;">其余的值变化不大，但是我怀疑如果用户在选项中禁用了鱼眼效果（我没有对此进行检查），其中的一些值会有所不同。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发生的第一件事是，着色器计算造成灰度角度的蒙版：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0</span></span>: div r0.xy, v0.xyxx, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">1</span></span>: mad r0.zw, r0.xxxy, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span>: mov r1.yz, <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(r0.zzwz) <span class="hljs-number"><span class="hljs-number">3</span></span>: div r0.z, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].x, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].y <span class="hljs-number"><span class="hljs-number">4</span></span>: mul r1.x, r0.z, r1.y <span class="hljs-number"><span class="hljs-number">5</span></span>: add r0.zw, r1.xxxz, -cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xxxy <span class="hljs-number"><span class="hljs-number">6</span></span>: mul_sat r0.zw, r0.zzzw, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.555556</span></span>, <span class="hljs-number"><span class="hljs-number">0.555556</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> r0.zw, r0.zzzw <span class="hljs-number"><span class="hljs-number">8</span></span>: mul r0.zw, r0.zzzw, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.500000</span></span>, <span class="hljs-number"><span class="hljs-number">2.500000</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> r0.zw, r0.zzzw <span class="hljs-number"><span class="hljs-number">10</span></span>: dp2 r0.z, r0.zwzz, r0.zwzz <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span> r0.z, r0.z <span class="hljs-number"><span class="hljs-number">12</span></span>: min r0.z, r0.z, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">13</span></span>: add r0.z, -r0.z, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 在HLSL中，我们可以这样编写： </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Main uv float2 uv = PosH.xy / texSize; // Scale at first from [0-1] to [-1;1], then calculate abs float2 uv3 = abs( uv * 2.0 - 1.0); // Aspect ratio float aspectRatio = texSize.x / texSize.y; // * Mask used to make corners grey float mask_gray_corners; { float2 newUv = float2( uv3.x * aspectRatio, uv3.y ) - offset; newUv = saturate( newUv / 1.8 ); newUv = pow(newUv, 2.5); mask_gray_corners = 1-min(1.0, length(newUv) ); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">首先，区间[-1；</font><font style="vertical-align: inherit;">1] UV及其绝对值。</font><font style="vertical-align: inherit;">然后是一个棘手的“挤压”。</font><font style="vertical-align: inherit;">成品口罩如下：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ba9/320/0d4/ba93200d4f20e0a5bc361e96994b525b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">稍后我将返回此蒙版。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，我将有意跳过几行代码，并仔细研究负责缩放效果的代码。</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">22</span></span>: add r1.xy, v0.xyxx, v0.xyxx <span class="hljs-number"><span class="hljs-number">23</span></span>: div r1.xy, r1.xyxx, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">24</span></span>: add r1.xy, r1.xyxx, l(<span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">-1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">25</span></span>: dp2 r0.y, r1.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">26</span></span>: mul r1.xy, r0.yyyy, r1.xyxx <span class="hljs-number"><span class="hljs-number">27</span></span>: mul r0.y, r0.w, l(<span class="hljs-number"><span class="hljs-number">0.100000</span></span>) <span class="hljs-number"><span class="hljs-number">28</span></span>: mul r1.xy, r0.yyyy, r1.xyxx <span class="hljs-number"><span class="hljs-number">29</span></span>: max r1.xy, r1.xyxx, l(<span class="hljs-number"><span class="hljs-number">-0.400000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.400000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">30</span></span>: min r1.xy, r1.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.400000</span></span>, <span class="hljs-number"><span class="hljs-number">0.400000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">31</span></span>: mul r1.xy, r1.xyxx, cb3[<span class="hljs-number"><span class="hljs-number">1</span></span>].xxxx <span class="hljs-number"><span class="hljs-number">32</span></span>: mul r1.zw, r1.xxxy, cb0[<span class="hljs-number"><span class="hljs-number">2</span></span>].zzzw <span class="hljs-number"><span class="hljs-number">33</span></span>: mad r1.zw, v0.xxxy, cb0[<span class="hljs-number"><span class="hljs-number">1</span></span>].zzzw, -r1.zzzw</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 首先，计算“加倍”的纹理坐标，并执行减法float2（1、1）： </font></font><br><br><pre> <code class="cpp hljs"> float2 uv4 = <span class="hljs-number"><span class="hljs-number">2</span></span> * PosH.xy; uv4 /= cb0_v2.xy; uv4 -= float2(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 这样的texcoord可以如下显示： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/70a/0b0/dfe/70a0b0dfeb9ca86eb86f137ac96c9811.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后计算标量积</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">点（uv4，uv4）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这给了我们掩码：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f0/b6c/0a9/1f0b6c0a97ed9ad17a6bc17f3ebcf6c6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 用于乘以上面的texcoords： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e34/27e/5f2/e3427e5f2a925c8a78f77d81c5840da4.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要提示：在左上角（黑色像素），该值为负。</font><font style="vertical-align: inherit;">由于R11G11B10_FLOAT格式的准确性有限，它们以黑色（0.0）显示。</font><font style="vertical-align: inherit;">它没有符号位，因此不能在其中存储负值。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后计算衰减系数（如上所述，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fisheyeAmount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在0.0到1.0 </font><i><font style="vertical-align: inherit;">之间</font></i><font style="vertical-align: inherit;">变化）。</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> attenuation = fisheyeAmount * <span class="hljs-number"><span class="hljs-number">0.1</span></span>; uv4 *= attenuation;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后执行限制（最大/最小）和一个乘法。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，计算出偏移量。</font><font style="vertical-align: inherit;">要计算最终的uv（将用于对颜色纹理进行采样），我们只需执行减法操作即可：</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float2 colorUV = mainUv-offset; </font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过对输入的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">colorUV</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">颜色</font><i><font style="vertical-align: inherit;">纹理</font></i><font style="vertical-align: inherit;">进行采样</font><font style="vertical-align: inherit;">，我们在拐角处得到了失真的图像：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bbc/4f4/967/bbc4f4967c3bf008bf3692af3eb54d69.jpg"></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 概述 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一步是对等高线图进行采样以找到等高线。</font><font style="vertical-align: inherit;">这很简单，首先我们找到texcoords来采样有趣物体的轮廓，然后对轨道进行相同的处理：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Sample outline map // interesting objects (upper left square) float2 outlineUV = colorUV * 0.5; float outlineInteresting = texture2.Sample( sampler2, outlineUV ).x; // r0.y // traces (upper right square) outlineUV = colorUV * 0.5 + float2(0.5, 0.0); float outlineTraces = texture2.Sample( sampler2, outlineUV ).x; // r2.w outlineInteresting /= 8.0; // r4.x outlineTraces /= 8.0; // r4.y</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a08/746/0a3/a087460a37b1b88733e1fef632a566db.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">等高线图中有趣的物体</font></font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0c6/edc/995/0c6edc995e2f6cb4c6aeec6701c30ba3.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">轮廓图上的迹线</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值得注意的是，我们仅从轮廓图上采样.x通道，并且仅考虑了上方的正方形。</font></font><br><br><h4> 机芯 </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了实现轨道的运动，使用了与醉酒效果几乎相同的技巧。</font><font style="vertical-align: inherit;">添加了一个单位大小的圆圈，我们对轮廓图进行了8倍采样，以获取有趣的对象和迹线以及颜色纹理。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请注意，我们仅将找到的路径除以8.0。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于我们处于纹理坐标[0-1] </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的空间中</font><font style="vertical-align: inherit;">，因此存在一个半径为1的圆以使单个像素环绕的操作将产生不可接受的伪像：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e3/8f1/de3/3e38f1de3016256205a5aa9199bb3a0d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，在继续之前，让我们先了解一下如何计算此半径。</font><font style="vertical-align: inherit;">为此，我们需要返回到缺少的第15-21行。</font><font style="vertical-align: inherit;">计算此半径的一个小问题是其计算分散在着色器周围（可能是由于编译器优化了着色器）。</font><font style="vertical-align: inherit;">因此，这是第一部分（15-21）和第二部分（41-42）：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">15</span></span>: add_sat r1.xy, -r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.030000</span></span>, <span class="hljs-number"><span class="hljs-number">0.030000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>: add r1.x, r1.y, r1.x <span class="hljs-number"><span class="hljs-number">17</span></span>: add_sat r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">-0.970000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.970000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">18</span></span>: add r0.x, r0.x, r1.x <span class="hljs-number"><span class="hljs-number">19</span></span>: add r0.x, r0.y, r0.x <span class="hljs-number"><span class="hljs-number">20</span></span>: mul r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">20.000000</span></span>) <span class="hljs-number"><span class="hljs-number">21</span></span>: min r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) ... <span class="hljs-number"><span class="hljs-number">41</span></span>: add r0.x, -r0.x, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">42</span></span>: mul r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.030000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，我们仅考虑每个表面旁边的[0.00-0.03]中的纹素，汇总其值，乘以20并使其饱和。</font><font style="vertical-align: inherit;">这是第15-21行之后的样子：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5b2/080/809/5b20808099b641be7510714ffd45a737.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 这是第41行之后的方式： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa8/51d/853/fa851d8539027d54d2874472d5952448.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第42行，我们将其乘以0.03，该值是整个屏幕的圆的半径。</font><font style="vertical-align: inherit;">如您所见，半径越靠近屏幕边缘，半径就越小。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在我们来看一下负责该运动的汇编代码：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">40</span></span>: mul r3.x, cb0[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, l(<span class="hljs-number"><span class="hljs-number">0.100000</span></span>) <span class="hljs-number"><span class="hljs-number">41</span></span>: add r0.x, -r0.x, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">42</span></span>: mul r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.030000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">43</span></span>: mov r3.yzw, l(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">44</span></span>: mov r4.x, r0.y <span class="hljs-number"><span class="hljs-number">45</span></span>: mov r4.y, r2.w <span class="hljs-number"><span class="hljs-number">46</span></span>: mov r4.z, l(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">47</span></span>: loop <span class="hljs-number"><span class="hljs-number">48</span></span>: ige r4.w, r4.z, l(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-number"><span class="hljs-number">49</span></span>: breakc_nz r4.w <span class="hljs-number"><span class="hljs-number">50</span></span>: itof r4.w, r4.z <span class="hljs-number"><span class="hljs-number">51</span></span>: mad r4.w, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.785375</span></span>), -r3.x <span class="hljs-number"><span class="hljs-number">52</span></span>: sincos r5.x, r6.x, r4.w <span class="hljs-number"><span class="hljs-number">53</span></span>: mov r6.y, r5.x <span class="hljs-number"><span class="hljs-number">54</span></span>: mul r5.xy, r0.xxxx, r6.xyxx <span class="hljs-number"><span class="hljs-number">55</span></span>: mad r5.zw, r5.xxxy, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>), r1.zzzw <span class="hljs-number"><span class="hljs-number">56</span></span>: mul r6.xy, r5.zwzz, l(<span class="hljs-number"><span class="hljs-number">0.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">57</span></span>: sample_indexable(texture2d)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r4.w, r6.xyxx, t2.yzwx, s2 <span class="hljs-number"><span class="hljs-number">58</span></span>: mad r4.x, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.125000</span></span>), r4.x <span class="hljs-number"><span class="hljs-number">59</span></span>: mad r5.zw, r5.zzzw, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.500000</span></span>), l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">60</span></span>: sample_indexable(texture2d)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r4.w, r5.zwzz, t2.yzwx, s2 <span class="hljs-number"><span class="hljs-number">61</span></span>: mad r4.y, r4.w, l(<span class="hljs-number"><span class="hljs-number">0.125000</span></span>), r4.y <span class="hljs-number"><span class="hljs-number">62</span></span>: mad r5.xy, r5.xyxx, r1.xyxx, r1.zwzz <span class="hljs-number"><span class="hljs-number">63</span></span>: sample_indexable(texture2d)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r5.xyz, r5.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">64</span></span>: mad r3.yzw, r5.xxyz, l(<span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>, <span class="hljs-number"><span class="hljs-number">0.125000</span></span>), r3.yyzw <span class="hljs-number"><span class="hljs-number">65</span></span>: iadd r4.z, r4.z, l(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">66</span></span>: endloop</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们在这里待一分钟。在第40行上，我们获得了时间系数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-elapsedTime * 0.1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在第43行中，我们为循环内获得的颜色纹理提供了一个缓冲区。</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">众所周知，r0.x</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（第41-42行）是圆的半径。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r4.x</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（第44行）是感兴趣对象的轮廓，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r4.y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（第45行）是轨道的轮廓（以前被8！除），</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r4.z</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（第46行）是循环计数器。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所料，循环有8次迭代。我们首先以弧度</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i * PI_4</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算角度</font><font style="vertical-align: inherit;">，这</font><i><font style="vertical-align: inherit;">将使</font></i><font style="vertical-align: inherit;">我们获得2 * PI-一个完整的圆。角度会随着时间而变形。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用sincos，我们确定采样点（单位圆），并使用乘法更改半径（第54行）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在那之后，我们绕一个像素绕圈，并采样轮廓和颜色。</font><font style="vertical-align: inherit;">循环之后，我们获得轮廓和颜色的平均值（由于除以8）。</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> timeParam = time * <span class="hljs-number"><span class="hljs-number">0.1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// adjust circle radius circle_radius = 1.0 - circle_radius; circle_radius *= 0.03; float3 color_circle_main = float3(0.0, 0.0, 0.0); [loop] for (int i=0; 8 &gt; i; i++) { // full 2*PI = 360 angles cycle const float angleRadians = (float) i * PI_4 - timeParam; // unit circle float2 unitCircle; sincos(angleRadians, unitCircle.y, unitCircle.x); // unitCircle.x = cos, unitCircle.y = sin // adjust radius unitCircle *= circle_radius; // * base texcoords (circle) - note we also scale radius here by 8 // * probably because of dimensions of outline map. // line 55 float2 uv_outline_base = colorUV + unitCircle / 8.0; // * interesting objects (circle) float2 uv_outline_interesting_circle = uv_outline_base * 0.5; float outline_interesting_circle = texture2.Sample( sampler2, uv_outline_interesting_circle ).x; outlineInteresting += outline_interesting_circle / 8.0; // * traces (circle) float2 uv_outline_traces_circle = uv_outline_base * 0.5 + float2(0.5, 0.0); float outline_traces_circle = texture2.Sample( sampler2, uv_outline_traces_circle ).x; outlineTraces += outline_traces_circle / 8.0; // * sample color texture (zooming effect) with perturbation float2 uv_color_circle = colorUV + unitCircle * offsetUV; float3 color_circle = texture0.Sample( sampler0, uv_color_circle ).rgb; color_circle_main += color_circle / 8.0; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">颜色采样将以几乎相同的方式执行，但是</font><font style="vertical-align: inherit;">我们将向</font><font style="vertical-align: inherit;">基础</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">colorUV</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加偏移量乘以“单个”圆。</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 亮度调节 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 在循环之后，我们对亮度图进行采样并更改最终的亮度值（因为亮度图对轮廓一无所知）： </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">67</span></span>: sample_indexable(texture2d)(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) r0.xy, r1.zwzz, t3.xyzw, s0 <span class="hljs-number"><span class="hljs-number">68</span></span>: mad_sat r0.xy, -r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">0.800000</span></span>, <span class="hljs-number"><span class="hljs-number">0.750000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r4.xyxx</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> HLSL代码： </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Sample intensity map float2 intensityMap = texture3.Sample( sampler0, colorUV ).xy; float intensityInteresting = intensityMap.r; float intensityTraces = intensityMap.g; // * Adjust outlines float mainOutlineInteresting = saturate( outlineInteresting - 0.8*intensityInteresting ); float mainOutlineTraces = saturate( outlineTraces - 0.75*intensityTraces );</span></span></code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 灰色的角落和一切的最终统一 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 使用标量乘积（汇编器行69）计算更靠近拐角的灰色： </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Greyish color float3 color_greyish = dot( color_circle_main, float3(0.3, 0.3, 0.3) ).xxx;</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b55/9a1/e0f/b559a1e0f3ae66041cdf3f9f48ba4b06.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后进行两个插值。</font><font style="vertical-align: inherit;">第一个使用我描述的第一个蒙版将灰色与“圆圈中的颜色”结合在一起，因此拐角变为灰色。</font><font style="vertical-align: inherit;">此外，系数为0.6，可降低最终图像的饱和度：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6a/389/202/c6a38920286de2fe269224a6b26ebd77.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二种使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fisheyeAmount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将第一种颜色与上述颜色结合在一起</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这意味着屏幕逐渐变暗（由于乘以0.6），角落处逐渐变灰！</font><font style="vertical-align: inherit;">精巧。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSL：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Determine main color. // (1) At first, combine "circled" color with gray one. // Now we have have greyish corners here. float3 mainColor = lerp( color_greyish, color_circle_main, mask_gray_corners ) * 0.6; // (2) Then mix "regular" color with the above. // Please note this operation makes corners gradually gray (because fisheyeAmount rises from 0 to 1) // and gradually darker (because of 0.6 multiplier). mainColor = lerp( color, mainColor, fisheyeAmount );</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在我们可以继续添加对象的轮廓。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">颜色（红色和黄色）来自常量缓冲区。</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// * Determine color of witcher senses float3 senses_traces = mainOutlineTraces * colorTraces; float3 senses_interesting = mainOutlineInteresting * colorInteresting; float3 senses_total = 1.2 * senses_traces + senses_interesting;</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9ca/4ea/52d/9ca4ea52df8a22889828414ee2bfde05.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font><font style="vertical-align: inherit;">我们快到终点了！</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们有最终的颜色，有女巫本能的颜色……它仍然需要以某种方式结合起来！</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为此，简单的添加是不合适的。</font><font style="vertical-align: inherit;">首先，我们计算标量积：</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">78</span></span>: dp3_sat r0.x, r0.xyzx, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dot_senses_total = saturate( dot(senses_total, float3(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>) ) );</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 看起来像这样： </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ae/357/099/2ae357099e5bfe5185d16103f87a6b69.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 最后，这些值用于在颜色和（饱和的）女巫的天赋之间进行插值： </font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">76</span></span>: mad r0.xyz, r0.yzwy, l(<span class="hljs-number"><span class="hljs-number">1.200000</span></span>, <span class="hljs-number"><span class="hljs-number">1.200000</span></span>, <span class="hljs-number"><span class="hljs-number">1.200000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r2.xyzx <span class="hljs-number"><span class="hljs-number">77</span></span>: mov_sat r2.xyz, r0.xyzx <span class="hljs-number"><span class="hljs-number">78</span></span>: dp3_sat r0.x, r0.xyzx, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">1.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>) <span class="hljs-number"><span class="hljs-number">79</span></span>: add r0.yzw, -r1.xxyz, r2.xxyz <span class="hljs-number"><span class="hljs-number">80</span></span>: mad o0.xyz, r0.xxxx, r0.yzwy, r1.xyzx <span class="hljs-number"><span class="hljs-number">81</span></span>: mov o0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">82</span></span>: ret float3 senses_total = <span class="hljs-number"><span class="hljs-number">1.2</span></span> * senses_traces + senses_interesting; <span class="hljs-comment"><span class="hljs-comment">// * Final combining float3 senses_total_sat = saturate(senses_total); float dot_senses_total = saturate( dot(senses_total, float3(1.0, 1.0, 1.0) ) ); float3 finalColor = lerp( mainColor, senses_total_sat, dot_senses_total ); return float4( finalColor, 1.0 );</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/abf/ce7/1c4/abfce71c4469b6dcd077723d498c1685.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅此而已。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完整的着色器可</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处获得</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我的（左）着色器和原始（右）着色器的比较：</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/433/5be/2e4/4335be2e49bd901916567734cc0485a5.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">希望您喜欢这篇文章！</font><font style="vertical-align: inherit;">“维克本能”的机制中有许多绝妙的主意，而且最终的结果很合理。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[分析的先前部分：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。]</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN450332/">https://habr.com/ru/post/zh-CN450332/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN450318/index.html">现代JavaScript开发中的设计模式</a></li>
<li><a href="../zh-CN450320/index.html">简单的量子游戏揭示了宇宙的终极复杂性</a></li>
<li><a href="../zh-CN450322/index.html">为什么我们需要这么多的使者？</a></li>
<li><a href="../zh-CN450324/index.html">生产力跟踪系统如何自动解雇亚马逊员工</a></li>
<li><a href="../zh-CN450330/index.html">前往美国时选择一所学校</a></li>
<li><a href="../zh-CN450334/index.html">IaaS和托管IT：技术摘要</a></li>
<li><a href="../zh-CN450340/index.html">如何免费分析竞争对手的网站。 分步说明</a></li>
<li><a href="../zh-CN450342/index.html">关于简单的事情，复杂的。 我们在家中归还女孩家禽或RTFM来定义塑料</a></li>
<li><a href="../zh-CN450344/index.html">白标帖子，或“我如何保存您的视频课程，使其不出现在跟踪器上”</a></li>
<li><a href="../zh-CN450346/index.html">牛顿的小屋摇篮</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>