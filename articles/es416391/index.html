<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游둟游 游꼯 游뱧 Optimizaci칩n de la colocaci칩n de m치quinas virtuales en servidores. 游녤 游녝游 游깻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace alg칰n tiempo, uno de mis colegas dijo que el lugar en el DC se est치 agotando, que no hay ning칰n lugar para colocar el servidor, y que la carga es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Optimizaci칩n de la colocaci칩n de m치quinas virtuales en servidores.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416391/">  Hace alg칰n tiempo, uno de mis colegas dijo que el lugar en el DC se est치 agotando, que no hay ning칰n lugar para colocar el servidor, y que la carga est치 creciendo y no est치 claro qu칠 hacer, y probablemente tendr치 que cambiar todos los servidores disponibles por otros m치s potentes. <br><br>  En ese momento estaba involucrado en la tarea de compilar horarios 칩ptimos, y pens칠, pero 쯤u칠 pasa si aplicamos algoritmos de optimizaci칩n para aumentar la utilizaci칩n del servidor en DC?  De aqu칤 naci칩 el proyecto sobre el que quiero escribir. <br><br>  Para los usuarios avanzados, dir칠 de inmediato que en este art칤culo hablaremos sobre el embalaje de contenedores, y para el resto que quieran saber c칩mo ahorrar hasta un 30% de los recursos del servidor utilizando c치lculos relativamente simples, bienvenidos a cat. <br><a name="habracut"></a><br>  Entonces, tenemos un DC con aproximadamente 100 servidores, que alojan aproximadamente 7,000 m치quinas virtuales.  Qu칠 hay dentro de las m치quinas virtuales: no lo sabemos y no debemos saberlo.  Es necesario colocar m치quinas virtuales en los servidores para realizar el SLA y al mismo tiempo usar el n칰mero m칤nimo de servidores. <br><br>  Nosotros sabemos: <br><br><ul><li>  lista de servidores </li><li>  cantidad de recursos en cada servidor (tiempo de CPU, n칰cleos de CPU, RAM, disco, disco io, red io). </li><li>  lista de m치quinas virtuales (VM) </li><li>  La cantidad de recursos consumidos por cada m치quina virtual (tiempo de CPU, n칰cleos de CPU, RAM, disco, disco io, red io). </li><li>  consumo de recursos por el sistema host en los servidores. </li></ul><br>  Necesitamos distribuir m치quinas virtuales entre los servidores para que cada uno de los recursos en cada servidor no exceda la cantidad disponible del recurso, y al mismo tiempo use la cantidad m칤nima de servidores. <br><br>  Esta tarea en la literatura cient칤fica se llama problema de embalaje bin (쯖칩mo ser치 en ruso?).  En t칠rminos simples, esta es una tarea sobre c칩mo insertar cajas peque침as de tama침os arbitrarios en cajas grandes y, al mismo tiempo, usar el n칰mero m칤nimo de cajas grandes.  El conocido problema en matem치ticas, NP-complete, se resuelve con precisi칩n solo mediante una b칰squeda exhaustiva, cuyo costo est치 creciendo combinatoriamente. <br><br>  La siguiente imagen ilustra la esencia del algoritmo de empaquetado del contenedor para el caso unidimensional: <br><br><img src="https://habrastorage.org/webt/ft/wo/fx/ftwofxgaz8qtbx56plkh2c1txqi.png"><br>  <i>Fig.</i>  <i>1. Ilustraci칩n del problema del embalaje del contenedor, ubicaci칩n no 칩ptima</i> <br><br>  En la primera figura, los art칤culos se distribuyen de alguna manera entre las canastas y se usan 3 canastas para colocarlos. <br><br><img src="https://habrastorage.org/webt/53/-x/cb/53-xcbdj3zvqgnlx4yov1xybnrw.png"><br>  <i>Fig.</i>  <i>2. Ilustraci칩n del problema del embalaje del contenedor, ubicaci칩n 칩ptima</i> <br><br>  La segunda imagen muestra la distribuci칩n 칩ptima, para la que solo necesita 2 cestas. <br><br>  La formulaci칩n est치ndar del algoritmo de empaque de contenedores tambi칠n supone que todas las cestas son iguales.  Nuestros servidores no son iguales, ya que se compraron en diferentes momentos y su configuraci칩n es diferente: diferente n칰mero de n칰cleos de procesador, memoria, disco, diferente potencia del procesador. <br><br>  Se puede obtener una soluci칩n sub칩ptima utilizando heur칤stica, algoritmos gen칠ticos, b칰squeda de 치rboles monte-carlo y redes neuronales profundas.  Nos decidimos por el algoritmo heur칤stico BestFit, que converge en una soluci칩n no m치s de 1,7 veces peor que la 칩ptima, as칤 como en alguna variaci칩n del algoritmo gen칠tico.  A continuaci칩n dar칠 los resultados de su aplicaci칩n. <br><br>  Pero primero, analicemos qu칠 hacer con las m칠tricas que var칤an en el tiempo, como el uso de la CPU, el disco io, la red io.  La forma m치s f치cil es reemplazar la m칠trica variable con una constante.  Pero, 쯖칩mo elegir el valor de esta constante?  Tomamos el valor m치ximo de la m칠trica durante alg칰n per칤odo caracter칤stico (previamente suavizando los valores at칤picos de los valores).  La semana result칩 ser un per칤odo caracter칤stico en nuestro caso, ya que la principal estacionalidad en la carga se asoci칩 con d칤as h치biles y d칤as libres. <br><br>  En este modelo, a cada m치quina virtual se le asigna una tira de recursos del tama침o del valor de recurso m치ximo consumido, y cada VM se describe por las constantes de uso m치ximo de CPU, RAM, disco, disco m치ximo io, red m치xima io. <br><br>  A continuaci칩n, utilizamos el algoritmo para calcular el empaquetamiento 칩ptimo y obtener un mapa de la ubicaci칩n de VM en servidores f칤sicos. <br><br>  La pr치ctica muestra que si no deja un cierto margen para cada uno de los recursos en el servidor, cuando la VM est치 densamente asignada, el servidor se sobrecarga.  Por lo tanto, para el uso de la CPU, dejamos un margen del 30%, para la RAM del 20%, para el disco io - 20%, para la red io - 20%, estos l칤mites se seleccionan emp칤ricamente. <br><br>  Tambi칠n tenemos varios tipos de discos (SSD r치pidos y HDD lentos y baratos), para cada tipo de disco tomamos las m칠tricas de disco y disco io por separado, por lo que el modelo final se vuelve algo m치s complicado y tiene m치s dimensiones. <br><br>  El resultado de optimizar la colocaci칩n de VM se muestra en el diagrama: <br><br><img src="https://habrastorage.org/webt/-9/vj/wy/-9vjwyj2x4a__iiszz7l9clhopq.png"><br>  <i>Fig.</i>  <i>3. El resultado de optimizar la colocaci칩n de m치quinas virtuales en servidores</i> <br><br>  Horizontal: el n칰mero de servidores que se han optimizado, vertical: el n칰mero de servidores liberados para la heur칤stica BestFit y para el algoritmo gen칠tico. <br><br>  쯈u칠 conclusiones se pueden sacar del diagrama? <br><br><ol><li>  Para las tareas actuales, puede usar 20-30% menos servidores. </li><li>  Cuantos m치s servidores optimice a la vez, m치s ganar치 en%, con el n칰mero de servidores de 40 o m치s, se produce la saturaci칩n. </li><li>  El algoritmo gen칠tico es ligeramente superior al heur칤stico BestFit.  Si queremos mejorar a칰n m치s nuestros resultados, profundizaremos en esta direcci칩n. </li></ol><br>  쯈u칠 otros problemas han surgido en la pr치ctica? <br><br><ol><li>  Si desea sacudir unos 100 servidores con 7,000 m치quinas virtuales, entonces el volumen de las migraciones ser치 muy significativo, de modo que toda la idea ser치 irrealizable.  Pero si trabaja con grupos de 20-40 servidores en secuencia, el efecto que obtendr치 ser치 casi el mismo, pero la cantidad de migraciones ser치 muchas veces menor.  Y puede optimizar su DC en partes. </li><li>  Si debe realizar migraciones en vivo, puede encontrarse con una situaci칩n en la que la migraci칩n no puede finalizar.  Esto significa que dentro de la VM hay una escritura intensiva en el disco y / o el estado de los cambios de memoria, y los estados de la VM entre las r칠plicas antiguas y nuevas no tienen tiempo para sincronizarse hasta que cambie el estado de la r칠plica anterior.  En este caso, debe predefinir tales m치quinas VM y marcarlas como no m칩viles.  A su vez, esto requiere la modificaci칩n de los algoritmos de optimizaci칩n.  Lo que agrada es que la ganancia total es pr치cticamente independiente del n칰mero de tales m치quinas, si no hay m치s del 10-15% del n칰mero total de m치quinas virtuales. </li></ol><br><h2>  쮺칩mo cambia la carga del servidor despu칠s de optimizar la colocaci칩n de VM? </h2><br>  Ok, hemos optimizado la colocaci칩n de VM.  쯈uiz치s el nuevo estado resultante es muy fr치gil en relaci칩n con el aumento de la carga?  쯈uiz치s los servidores est치n funcionando al l칤mite y cualquier aumento en la carga los matar치? <br><br>  Comparamos la utilizaci칩n de los recursos del servidor antes de la optimizaci칩n y despu칠s durante un per칤odo de 1 semana.  Lo que sucedi칩 se muestra en la Figura 2: <br><br><img src="https://habrastorage.org/webt/aj/ab/bw/ajabbwgggnspsugwgwwooscwgta.png"><br>  <i>Fig.</i>  <i>4. Cambio en la carga de la CPU despu칠s de optimizar la asignaci칩n de VM</i> <br><br>  Seg칰n el uso de la CPU: el uso promedio de la CPU ha crecido del 10% a solo el 18%.  Es decir  tenemos un triple margen de rendimiento de la CPU, mientras que los servidores permanecer치n en la llamada zona "verde". <br><br><h3>  쮺칩mo se hizo esto en el software? </h3><br>  Recopilamos las m칠tricas que necesitamos en Yandex.ClickHouse (probamos InfluxDB, pero en nuestros vol칰menes de datos las consultas con agregaci칩n se realizan demasiado lentamente) con una frecuencia de 30 segundos.  A partir de ah칤, la tarea de calcular el estado 칩ptimo lee las m칠tricas, calcula el consumo m치ximo a partir de ellas y genera una tarea de c치lculo que se coloca en la cola.  Tan pronto como se completa la tarea de c치lculo, se ejecutan pruebas para verificar que el resultado no exceda los l칤mites especificados. <br><br><h3>  쮸lguien ya ha hecho esto? </h3><br>  Seg칰n lo que conocemos, hay algoritmos similares dentro de VMware vSphere y Nutanix y aparecen dentro de OpenStack (proyecto OpenStack Watcher). <br><br><h3>  쮼s posible hacerlo a칰n mejor? </h3><br>  Si puedes.  En el pr칩ximo art칤culo, le dir칠 c칩mo empacar m치quinas virtuales a칰n m치s densas sin violar el SLA, y por qu칠 se necesitan neuronas para esto. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es416391/">https://habr.com/ru/post/es416391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es416377/index.html">Nos convertimos en magos en la programaci칩n. Parte 1</a></li>
<li><a href="../es416379/index.html">Neurobugurt C칩mo ense침amos a la red neuronal a inventar memes un a침o antes que Stanford</a></li>
<li><a href="../es416381/index.html">Informe del Club de Roma 2018, Cap칤tulo 3.13: Filantrop칤a, Inversi칩n, Crowdsourcing y Blockchain</a></li>
<li><a href="../es416385/index.html">Si la correlaci칩n sale al 100%, en alg칰n lugar se ha introducido un error: la experiencia de pasant칤a en Rambler Group</a></li>
<li><a href="../es416387/index.html">Camarones: escale y comparta im치genes HTTP en C ++ moderno con ImageMagic ++, SObjectizer y RESTinio</a></li>
<li><a href="../es416393/index.html">Conferencia IIDF: las corporaciones no son vs startups</a></li>
<li><a href="../es416397/index.html">Automatizamos las pruebas de IU de las aplicaciones de Android utilizando el patr칩n de Objeto de p치gina</a></li>
<li><a href="../es416399/index.html">C칩mo analizamos las revisiones de aplicaciones m칩viles usando el aprendizaje autom치tico</a></li>
<li><a href="../es416401/index.html">Blender: modelo 3D de un chip para conectarse a la biblioteca KiCad</a></li>
<li><a href="../es416403/index.html">Fintech digest: ataque al banco PIR, Servicio de Impuestos Federales e impuestos de la transferencia de tarjeta a tarjeta, as칤 como a algunas cadenas de bloques y criptomonedas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>