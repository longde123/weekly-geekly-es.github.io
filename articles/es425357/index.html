<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìá üïö üõÖ C√≥mo armamos una pila tecnol√≥gica de 12 pisos y no nos volvimos locos üîô üßùüèº üö£üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Appodeal es una compa√±√≠a de ~ 100 personas que trabajan en Mosc√∫, San Francisco, Barnaul, Lutsk, Kirov, Barcelona y, desde junio de 2018, tambi√©n en M...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo armamos una pila tecnol√≥gica de 12 pisos y no nos volvimos locos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/appodeal/blog/425357/">  Appodeal es una compa√±√≠a de ~ 100 personas que trabajan en Mosc√∫, San Francisco, Barnaul, Lutsk, Kirov, Barcelona y, desde junio de 2018, tambi√©n en Minsk. <br><br>  Monetizamos las aplicaciones m√≥viles mostrando anuncios a los usuarios.  Comenzamos con la mediaci√≥n publicitaria, pero la pila de tecnolog√≠a est√° en constante crecimiento, por lo que otros productos de la industria de Ad Tech tambi√©n se han agregado a la mediaci√≥n. <br><br><img src="https://habrastorage.org/webt/9x/iw/99/9xiw995blvp1eqlv6tc-hnfona0.jpeg" alt="imagen"><br><br>  Para aquellos que no est√°n familiarizados con Ad Tech, esta es el √°rea de trabajo de las empresas de tecnolog√≠a que trabajan en el campo de la publicidad.  Cuando le dices a alguien que trabajas en el campo de la publicidad m√≥vil, la gente a menudo reacciona con escepticismo; aparentemente, el molesto anuncio "Azino Three Axes" viene a la mente.  De hecho, esto es solo la punta del iceberg, y toda esta publicidad "salvaje" no tiene nada que ver con el negocio publicitario real. <a name="habracut"></a>  Y el segmento m√≥vil en el que estamos involucrados ha superado durante mucho tiempo el segmento de publicidad en la web: <br><br><img src="https://habrastorage.org/webt/3-/h8/ep/3-h8epbkxfz3_k8zk_foglrsnym.png" alt="imagen"><br><br><h4>  ¬øPor qu√© integrar anuncios en aplicaciones? </h4><br>  Por supuesto, se gastan muchos recursos en la creaci√≥n de aplicaciones, y los creadores / propietarios quieren que el tiempo y el esfuerzo gastados valgan la pena.  Los propietarios de aplicaciones m√≥viles que publican su aplicaci√≥n en la tienda de aplicaciones / Google Play se denominan editores o editores.  Los editores aplican diferentes modelos de monetizaci√≥n, desde compras en la aplicaci√≥n hasta monetizaci√≥n publicitaria.  Pero de todos estos m√©todos, solo el √∫ltimo permite al usuario no pagar por usar la aplicaci√≥n, y esto brinda la mayor cobertura de audiencia. <br><br>  S√≠, si hay demasiada publicidad, molestar√° a todos y afectar√° negativamente la retenci√≥n de usuarios.  Que, por supuesto, nadie necesita.  Por lo tanto, siempre intentan integrar la publicidad sabiamente para ganar el m√°ximo dinero en su aplicaci√≥n y, al mismo tiempo, no tomar un centavo de los usuarios. <br><br><h4>  Como funciona </h4><br>  Tan pronto como el editor decide monetizar a trav√©s de la publicidad, acude a la compa√±√≠a que puede hacer que esta tarea sea lo m√°s f√°cil posible para √©l.  ¬øC√≥mo sucede esto con Appodeal?  Despu√©s de registrarse en el sitio, integramos su aplicaci√≥n con nuestro servicio.  Esto se realiza a trav√©s del SDK del cliente, que conecta la aplicaci√≥n a la parte del servidor y se comunica con la parte del servidor a trav√©s de la API. <br><br>  Si minimiza los detalles, el objetivo de la interacci√≥n se reduce a dos etapas: <br><br>  a.  Determine qu√© anuncio mostrar en este momento; <br>  b.  Env√≠e informaci√≥n sobre qu√© anuncio se mostr√≥ y cu√°l no, y mu√©strelo en las estad√≠sticas. <br><br>  Actualmente, Appodeal atiende a varios miles de aplicaciones activas que proporcionan aproximadamente 400-450 millones de impresiones de anuncios por d√≠a, recibidas en respuesta a cerca de mil millones de solicitudes a redes publicitarias (que son los proveedores de publicidad).  Para que esto funcione, nuestros servidores atienden alrededor de 125 mil solicitudes por segundo, es decir  aproximadamente 10.8 mil millones de consultas por d√≠a. <br><br><img src="https://habrastorage.org/webt/-j/ci/bq/-jcibqnsphakjli4w0tnq5h7mre.png" alt="imagen"><br><br><h4>  ¬øEn qu√© se basa todo esto? </h4><br>  Utilizamos varias tecnolog√≠as para proporcionar velocidad, confiabilidad y al mismo tiempo flexibilidad de desarrollo y soporte.  Por el momento, estamos escribiendo c√≥digo en los siguientes idiomas: <br><br><ul><li>  / Ruby / Ruby on Rails + React.JS (front-end) /: Todav√≠a hay una gran parte de la API y todo el elemento web que los usuarios y nuestros empleados ven </li><li>  / GoLang /: Procesando grandes cantidades de datos estad√≠sticos y no solo </li><li>  / Scala /: solicitudes de procesamiento en tiempo real para trabajar con intercambios de intercambio de tr√°fico utilizando el protocolo RTB (lea m√°s al respecto al final del art√≠culo) </li><li>  / Elixir / Phoenix /: M√°s bien, la parte experimental.  Creaci√≥n de algunos microservicios para manejar algunas estad√≠sticas y API. </li></ul><br><img src="https://habrastorage.org/webt/js/dj/qg/jsdjqgdn5x6skyabw52jkl7rokg.png" alt="imagen"><br><br><h4>  ¬øPor qu√© es originalmente Ruby y Ruby on Rails? </h4><br>  Appodeal compite en su segmento con jugadores muy grandes, por lo que debe adaptarse r√°pidamente a los cambios del mercado.  A menudo esto se siente como un cambio en las ruedas de un autom√≥vil a una velocidad de 100 km / h.  Ruby on Rails nos permiti√≥ resistir la carrera y ganar un punto de apoyo en el mercado lo suficiente como para ser un l√≠der en su segmento.  Las principales ventajas de Rails en nuestra opini√≥n: <br><br><ul><li>  Un gran n√∫mero de desarrolladores calificados. </li><li>  Gran comunidad  Una gran cantidad de soluciones y bibliotecas listas para usar </li><li>  La velocidad de introducir nuevas funciones y cambiar / eliminar las antiguas </li></ul><br><img src="https://habrastorage.org/webt/31/me/zl/31mezlqllshlsqmm0ultc0z7a7i.png" alt="imagen"><br><br>  De los inconvenientes obvios: <br><br><ul><li>  El rendimiento general es pobre.  Tambi√©n afecta la falta de JIT (en este momento), la falta de la capacidad de paralelizar el c√≥digo (si no tiene en cuenta JRuby).  Hasta cierto punto, esto sigue siendo soportable porque el cuello de botella suele ser la base de datos y el cach√©.  Lo que vemos en la imagen de NewRelic: </li></ul><br><img src="https://habrastorage.org/webt/vz/uk/gh/vzukgh2_2ehcbmbf3mhikl-xsdc.png" alt="imagen"><br><br><ul><li>  Los monolitos ferroviarios no se cortan muy bien en microservicios: se ven afectados por un alto grado de conectividad entre la l√≥gica empresarial y la l√≥gica de acceso a datos (ActiveRecord). </li></ul><br><h4>  ¬øC√≥mo se almacenan los datos? </h4><br>  Tenemos muchos datos.  Muy  Estamos hablando de miles de millones / decenas / cientos de miles de millones de registros.  Dado que los datos son completamente diferentes, los almacenamos de diferentes maneras.  Nunca debe limitarse en arquitectura a ninguna soluci√≥n, que supuestamente es universal.  La pr√°ctica muestra que, en primer lugar, en Highload pr√°cticamente no hay soluciones universales.  Universalidad significa indicadores promedio (o significativamente m√°s bajos que el promedio) para el acceso / velocidad de lectura / tama√±o de almacenamiento de datos como una tarifa por esta versatilidad.  En segundo lugar, debe probar algo nuevo todo el tiempo, experimentar y buscar soluciones no triviales para las tareas.  Total: <br><br><ul><li>  / PostgreSQL /: Nos encanta Postgre.  Lo consideramos la mejor soluci√≥n de almacenamiento OLTP en este momento.  All√≠ se almacenan datos sobre usuarios, aplicaciones, campa√±as publicitarias, etc.  Usamos replicaci√≥n de r√©plica primaria.  Hacemos copias de seguridad solo en las vacaciones de Navidad, porque esto es para los d√©biles (una broma). </li><li>  / VerticaDB /: base de datos orientada a columnas.  Utilizamos para almacenar miles de millones de registros estad√≠sticos.  En resumen, Vertika fue considerada por alg√∫n tiempo la mejor soluci√≥n OLAP para almacenar an√°lisis.  La principal desventaja es el enorme precio (individual) de la licencia. </li><li>  / ClickHouse /: tambi√©n una base de datos orientada a columnas.  Cambie gradualmente a √©l con VerticaDB.  Consideramos la mejor soluci√≥n OLAP en este momento.  No vale un centavo.  Funciona de manera muy r√°pida y confiable.  El principal inconveniente es que los datos no se pueden eliminar y actualizar (hablaremos de esto en un art√≠culo separado, si alguien est√° interesado). </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/14e/0af/ee0/14e0afee039b7303db9d70c2f2f3892a.gif" alt="imagen"></div><br><blockquote>  Nada!  ¬øC√≥mo es imposible eliminar y modificar datos? </blockquote><br><ul><li>  / Aerospike /: El almacenamiento de valor-clave NoSQL m√°s r√°pido en nuestra opini√≥n.  Hay una serie de inconvenientes, pero en general estamos satisfechos.  Incluso hay una tabla de comparaci√≥n para Aerospike en su sitio de rendimiento con otras soluciones: [Cu√°ndo usar la base de datos Aerospike NoSQL vs.  Redis] (https://www.aerospike.com/when-to-use-aerospike-vs-redis/) </li><li>  / Redis /: Sobre "R√°bano", creo, no tiene sentido contar por separado.  Parad√≥jicamente, su principal ventaja es la facilidad de uso y el enhebrado √∫nico, lo que evita las condiciones de carrera, por ejemplo, cuando se trabaja con contadores comunes. </li><li>  / Druid /: Usamos para grandes conjuntos de datos en el trabajo con intercambios RTB.  De hecho, en su mayor parte, juega en el mismo campo con ClickHouse, pero hist√≥ricamente, todav√≠a no hemos podido cambiar a ning√∫n instrumento. </li></ul><br><img src="https://habrastorage.org/webt/o0/6j/un/o06junbll0drckljvb8sten_hei.png" alt="imagen"><br><br>  Tal conjunto puede parecer sobrecargado, pero en primer lugar, Appodeal es un gran conglomerado de varios equipos de desarrollo y varios proyectos dentro de uno.  Y en segundo lugar, estas son las duras realidades de la tecnolog√≠a publicitaria: no somos los √∫nicos que usamos una pila de varios pisos dentro de una empresa. <br><br><h4>  ¬øC√≥mo sigues esto? </h4><br><br>  Debido a que los flujos de datos son grandes, deben estar en cola para procesarlos.  Como cola usamos Kafka.  Esta es una gran soluci√≥n confiable escrita en Scala que nunca nos ha fallado todav√≠a. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-s/ph/sy/-sphsyrohftcyefndm9nuz5hluo.png" alt="imagen"></div><br><br>  El √∫nico requisito para el usuario en este caso es que tenga tiempo de rastrear la cola cada vez m√°s r√°pida de lo que crece.  Una regla simple y obvia.  Por lo tanto, para estos fines, utilizamos principalmente GoLang.  Sin embargo, esto no niega el hecho de que la RAM en este servidor deber√≠a ser abundante. <br><br>  Para monitorear toda esta econom√≠a, debe monitorear y delegar literalmente todo en una fila.  Para esto usamos: <br><br><ul><li>  / NewRelic /: una soluci√≥n probada en el tiempo que se integra perfectamente con Ruby on Rails y los micro servicios GoLang.  El √∫nico inconveniente de NewRelic es su precio.  Por lo tanto, NewRelic no est√° en todas partes con nosotros.  En su mayor parte, intentamos reemplazarlo con nuestras propias m√©tricas recopiladas a mano: las colocamos en Grafana. </li><li>  / Statsd + Grafana /: algo bueno para recopilar sus m√©tricas.  Con el √∫nico inconveniente de que tiene que configurar todo usted mismo y "repetir" la funcionalidad NewRelic de f√°brica. </li><li>  / ElasticSearch + Fluentd + Kibana /: En los registros colocamos todo en una fila.  Desde consultas lentas de PostgreSQL hasta algunos mensajes del sistema Rails.  En realidad, una soluci√≥n como Kibana basada en ElasticSearch le permite recopilar convenientemente todos los registros en un solo lugar y luego buscar los mensajes necesarios en ellos. </li><li>  / Airbrake /: obligatorio en este proceso de recopilaci√≥n de errores junto con el mensaje stacktrace'ami.  Actualmente nos estamos mudando con Airbrake a una de las soluciones gratuitas.  Por una raz√≥n, de nuevo, los precios. </li></ul><br><img src="https://habrastorage.org/webt/0f/tx/e7/0ftxe7kzizutxsovtqcack5-bzs.png" alt="imagen"><br><br>  Debe comprender que el monitoreo adecuadamente construido es sus ojos y o√≠dos.  Ciegamente imposible de trabajar.  Debe ver lo que sucede en sus servidores en un momento determinado, por lo que la estabilidad y la confiabilidad de su producto depender√°n en gran medida de qu√© tan competente sea para construir un sistema para recopilar y mostrar m√©tricas. <br><br>  Por cierto, hablando de confiabilidad, contamos con varios servidores de preparaci√≥n para el despliegue previo y la verificaci√≥n de versiones, que mantenemos estables bajo carga, duplicando parte del tr√°fico real all√≠.  Cada semana sincronizamos bases de datos entre producci√≥n y puesta en escena.  Esto nos da una especie de "espejo" que nos permite probar aquellas cosas que no se pueden verificar localmente, as√≠ como identificar problemas a nivel de pruebas de carga. <br><br><h4>  ¬øEs realmente tan complicado? </h4><br>  Resulta de esa manera.  Como escribi√≥ Elon Musk en su libro: "Las mejores mentes de mi generaci√≥n est√°n ocupadas haciendo que la gente haga clic en los anuncios", me dijo Jeff Hammerbacher, un ingeniero de Facebook.  "Horror ..."  Una breve lista de lo que hace Appodeal: <br><br><ul><li>  Estamos integrados con dos docenas de redes y agencias de publicidad.  En modo autom√°tico, registramos aplicaciones en estas redes, as√≠ como configuramos varios par√°metros para que estas redes funcionen al m√°ximo rendimiento.  No todas las redes tienen API correspondientes, en alg√∫n lugar hay que hacerlo con robots. </li><li>  Cada red paga a los usuarios ingresos por impresiones, que deben recibirse, desglosarse por varios par√°metros y procesarse.  Esto se hace sin parar.  En alg√∫n lugar, de nuevo, por robots. </li><li>  Para proporcionar al usuario un ingreso m√°ximo, "hacemos" que las cuadr√≠culas compitan entre s√≠, construyendo la llamada "cascada" a partir de ofertas publicitarias.  La cascada se basa en varios indicadores, por ejemplo, eCPM (precio promedio por 1000 impresiones), que predecimos de varias maneras.  Cuanto mayor sea la oferta publicitaria en la cascada, mayor ser√° la predicci√≥n del precio.  Esta cascada se ofrece en el dispositivo tantas veces como sea necesario.  Como habr√°s adivinado, un anuncio en el que nadie hace clic y que solo molestar√° a todos no interesa a nadie.  La excepci√≥n es solo la llamada.  Anuncios publicitarios "de marca" de Coca-Cola, Pepsi y otros gigantes corporativos que est√°n acostumbrados a hablar de s√≠ mismos siempre y en todas partes. </li><li>  Parte de esta interacci√≥n se basa en el llamado protocolo RTB (Real-Time Bidding): </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dq/ma/fj/dqmafjo0twbm85ocp0p4vnnfkse.png" alt="imagen"></div><br><br>  En este caso, los llamados oferentes se intercambian entre s√≠ en l√≠nea en una subasta por el derecho a mostrar sus anuncios en el dispositivo seleccionado.  Un punto muy interesante digno de un art√≠culo separado.  Muchos intercambios, como Google AdExchange, establecen un marco estricto para el tiempo de respuesta del servidor (por ejemplo, 50 ms), lo que plantea un problema de rendimiento de punta.  En caso de desobediencia, una multa de miles de d√≥lares.  Esto es exactamente lo que hace el n√∫cleo escrito en Scala junto con Druid. <br><br>  Cada cazador quiere saber d√≥nde se encuentra el fais√°n, y nuestros clientes (como nosotros) quieren saber a qui√©n se le mostr√≥ el anuncio, cu√°ndo y por qu√©.  Por lo tanto, tenemos que poner en cola (Kafka) todo el mont√≥n de datos que tenemos, procesar y agregar gradualmente a la base de datos OLAP (ClickHouse).  Muchas personas piensan que PostgreSQL har√° frente a esta tarea no peor que cualquier soluci√≥n "hipster", pero esto no es as√≠.  PostgreSQL es bueno, pero la soluci√≥n cl√°sica para construir √≠ndices para la velocidad de acceso a los datos deja de funcionar cuando el n√∫mero de campos para filtrar y ordenar supera los 10, y la cantidad de datos almacenados se acerca a mil millones de registros.  Simplemente no tiene suficiente memoria para almacenar todos estos √≠ndices o tendr√° problemas para actualizar estos √≠ndices.  En cualquier caso, no podr√° lograr el mismo rendimiento que las soluciones orientadas a columnas para consultas anal√≠ticas. <br><br><h4>  Conclusi√≥n </h4><br>  En este art√≠culo, trat√© de describir al menos brevemente lo que hacemos, c√≥mo almacenamos y procesamos los datos.  D√≠ganos en los comentarios qu√© pila usa, haga preguntas y solicite nuevos art√≠culos; estaremos encantados de compartir nuestra experiencia. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es425357/">https://habr.com/ru/post/es425357/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es425347/index.html">Dumping Mask: mito o realidad</a></li>
<li><a href="../es425349/index.html">El foro de Positive Hack Days 9 se llevar√° a cabo los d√≠as 21 y 22 de mayo en Crocus Expo</a></li>
<li><a href="../es425351/index.html">Los programadores de bricolaje pierden sus trabajos</a></li>
<li><a href="../es425353/index.html">Toda la verdad sobre RTOS. Art√≠culo 13. Estructuras de datos de tareas y llamadas de API no compatibles</a></li>
<li><a href="../es425355/index.html">Calificaci√≥n de seguridad del proyecto ICO</a></li>
<li><a href="../es425359/index.html">Los chinos usaron un microchip para controlar las computadoras estadounidenses</a></li>
<li><a href="../es425361/index.html">Bloqueo de contenido, extensi√≥n para navegadores de cromo</a></li>
<li><a href="../es425363/index.html">Consejos para estudiantes programadores.</a></li>
<li><a href="../es425367/index.html">El juego Arduino m√°s simple con una pantalla 1602 - Parte # 2</a></li>
<li><a href="../es425369/index.html">KTRU (Cat√°logo de bienes, obras, servicios) o la muerte de la contrataci√≥n p√∫blica de TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>