<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈸 🧘🏼 🛶 Programme d'installation de Python à faire soi-même pour les versions Android de TeamCity 🚵 🏄 🕙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le public 


 Ingénieurs QA, testeurs d'applications mobiles, automatisation. 
 Le problème 


 Lors du test des applications pour Android (non seulem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Programme d'installation de Python à faire soi-même pour les versions Android de TeamCity</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/426149/"><p><img src="https://habrastorage.org/webt/qm/bs/gf/qmbsgfgzsgr25hphoc3tva3ccru.png"></p><br><h4 id="auditoriya">  Le public </h4><br><p>  Ingénieurs QA, testeurs d'applications mobiles, automatisation. </p><br><h4 id="problema">  Le problème </h4><br><p>  Lors du test des applications pour Android (non seulement, mais nous ne parlerons que de cette plate-forme), vous devez installer de nombreux assemblages du ou des produits testés.  Ce processus prend du temps et des efforts, ce qui est plus efficace à consacrer à la recherche de bogues. </p><br><p>  Dans cet article, nous allons examiner une solution existante, écrire la nôtre en Python et les comparer. </p><a name="habracut"></a><br><h4 id="gotovoe-reshenie">  Solution clé en main </h4><br><p>  La solution la plus populaire à ce problème est peut-être actuellement fournie par le service Crashlytics, qui comprend le programme d'installation Beta. </p><br><p>  Envisagez un processus d'installation d'application typique à l'aide de Crashlytics Beta: </p><br><ul><li>  Nous trouvons l'icône Bêta (1) → appuyez sur (2) = l'application démarre. </li><li>  Nous trouvons le projet souhaité (3) → tapotez (4) = un écran avec une liste d'assemblages s'ouvre. </li><li>  Trouvez l'assemblage souhaité (5) → appuyez sur «Télécharger» (6) = le fichier d'installation est téléchargé sur l'appareil. </li><li>  Un écran s'affiche avec une proposition d'installation de l'application → appuyez sur «Installer» (7) = l'écran d'installation s'affiche. </li><li>  Trouvez l'application installée (8) → appuyez sur (9) = l'application démarre;  prêt pour les tests. </li></ul><br><p>  Ainsi, pour installer et exécuter une version d'application à l'aide de Crashlytics Beta, vous devez effectuer un total d'au moins neuf actions.  Nous allons nous concentrer sur ces indicateurs et essayer de créer un programme d'installation qui nécessite moins d'actions pour résoudre des problèmes similaires. </p><br><h4 id="kastomnoe-reshenie">  Solution personnalisée </h4><br><p>  Nous choisissons Python comme langage de programmation, car il convient à notre tâche et est très populaire, y compris parmi les ingénieurs QA. <br>  Pour interagir avec Android, nous utiliserons adb, qui fait partie du SDK Android standard. <br>  Pour télécharger des fichiers - Wget. <br>  Dans notre cas, les assemblages sont effectués dans TeamCity. </p><br><p>  Passons maintenant à l'écriture de code. </p><br><p>  Tout d'abord, nous importons le module de <em>sous</em> - <em>processus</em> dans le projet, il est nécessaire d'exécuter les commandes <em>wget</em> et <em>adb</em> . </p><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess</code> </pre> <br><p>  Ajoutez les paramètres nécessaires pour Wget. </p><br><pre> <code class="python hljs">settings = {<span class="hljs-string"><span class="hljs-string">'user'</span></span>: <span class="hljs-string"><span class="hljs-string">'—user=__teamcity'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: <span class="hljs-string"><span class="hljs-string">'—password=__teamcity'</span></span>, <span class="hljs-string"><span class="hljs-string">'way'</span></span>: <span class="hljs-string"><span class="hljs-string">'____'</span></span>}</code> </pre> <br><p>  Nous allons installer les applications par numéro de build, nous allons donc apprendre au script à demander ce paramètre. </p><br><pre> <code class="python hljs">number = input(<span class="hljs-string"><span class="hljs-string">' № : '</span></span>)</code> </pre> <br><p>  Disons que nous devons installer deux assemblys à la fois: test et combat.  Nous les téléchargerons de TeamCity.  Pour ce faire, nous découvrons le chemin d'accès complet aux fichiers en ouvrant la page de service et en trouvant l'assembly dans les artefacts.  L'URL de pré-assemblage ressemblera à ceci: </p><br><pre> <code class="python hljs">https://teamcity.mysite.com/repository/app/_/_/myapp-_-_.apk</code> </pre> <br><p>  Dans l'adresse, au lieu du numéro d'assemblage, vous pouvez voir id, par exemple, / 1234: id /.  Ici, nous n'indiquerons pas l'identifiant, mais le numéro d'assemblage. </p><br><p>  Nous allons écrire une fonction pour télécharger les assemblys donnés. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">download</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type_b)</span></span></span><span class="hljs-function">:</span></span> url = <span class="hljs-string"><span class="hljs-string">'http://teamcity.mysite.com/repository/app/{0}/{1}/myapp-{0}-{1}.apk'</span></span>.format(number, type_b) <span class="hljs-comment"><span class="hljs-comment">#    — ,  ,    —   , #     —  subprocess.check_output(['wget', '-N', '--cache=off', '--progress=bar', settings['user'], settings['password'], '-P', settings['way'], url])</span></span></code> </pre> <br><p>  Nous allons écrire une fonction pour installer et exécuter des applications.  Tout d'abord, supprimez les assemblages précédemment installés.  N'oubliez pas que si au moins une application n'est pas sur l'appareil, le script se terminera par une erreur.  Pour éviter cela, nous ignorerons les erreurs. </p><br><p>  Dans cet exemple imaginaire, deux packages: </p><br><ul><li>  com.myapp.prod </li><li>  com.myapp.test </li></ul><br><p>  Activités de départ: </p><br><ul><li>  com.myapp.prod/com.myapp.StartActivity </li><li>  com.myapp.test / com.myapp.StartActivity </li></ul><br><p>  Les noms de votre package et de votre activité seront différents. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">install</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type_b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-comment"><span class="hljs-comment">#   ,  package name subprocess.check_output(['adb', 'uninstall', 'com.myapp.{0}'.format(type_b)]) except: #     —  . pass finally: #    subprocess.check_output(['adb', 'install', '{0}/myapp-{1}-{2}.apk'.format(settings['way'], number, type_b)]) #   ,  activity name subprocess.check_output(['adb', 'shell', 'am', 'start', 'com.myapp.{0}/com.myapp.StartActivity'.format(type_b)]) print('(^_^)  ({0}-{1})   .'.format(number, type_b))</span></span></code> </pre> <br><p>  Toutes les fonctions nécessaires sont écrites.  Maintenant, ils peuvent être appliqués. <br>  De plus, nous ajoutons un gestionnaire pour le cas où l'assembly spécifié n'est pas dans TeamCity. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  ,     download('prod') #  ,     download('test') except Exception: #    —     number = input('¯\_(ツ)_/¯   .\n  №: ') else: print(' …') #      install('prod') #      install('test') #    —       print('! (_8(|)\n') break</span></span></code> </pre> <br><p>  Le script est prêt.  Nous l'enregistrons, par exemple, sous le nom installer.py <br>  Ajouter un alias, par exemple <em>alias inst = 'python ~ / scripts / installer.py'</em> </p><br><h4 id="proverka">  Vérifier </h4><br><p>  Donc, pour installer un assemblage à l'aide de Crashlytics Beta, vous devez effectuer 9 actions.  À titre de comparaison, nous mesurons cet indicateur dans le script. </p><br><ul><li>  Nous commençons le script avec la commande inst (1) = une proposition est affichée pour définir le numéro de build. </li><li>  Définissez le numéro d'assemblage (2) = les anciens assemblages sont supprimés;  Téléchargez, installez et lancez-en de nouveaux.  L'application est prête à être testée. </li></ul><br><h4 id="rezultat">  Résultat </h4><br><p>  Bêta (1 build) - 9 actions (hors suppression des anciennes builds). <br>  Votre propre script (autant d'assemblages que vous le souhaitez) - 2 actions. </p><br><p>  Un avantage supplémentaire de la solution personnalisée est qu'elle évolue (en ajoutant l'installation de plusieurs produits à un certain nombre d'appareils, etc.), et s'adapte également facilement aux tâches de test automatique. </p><br><h4 id="istochniki">  Les sources </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="sous-processus">Sous-processus</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="wget">Wget</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="adb">Pont de débogage Android (adb)</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426149/">https://habr.com/ru/post/fr426149/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426135/index.html">Cloud privé pour l'Internet des objets</a></li>
<li><a href="../fr426137/index.html">Âge d'honnêteté</a></li>
<li><a href="../fr426141/index.html">Red Hat remplace Docker par Podman</a></li>
<li><a href="../fr426143/index.html">Animation 3D - vidéo ou interactive?</a></li>
<li><a href="../fr426145/index.html">Atelier d'acceptation indépendant, 23 octobre, Moscou</a></li>
<li><a href="../fr426151/index.html">Vendredi du programmeur, ou comme j'ai écrit la bibliothèque pour le code lexical et d'analyse</a></li>
<li><a href="../fr426155/index.html">Nous optimisons le web avec Vitaliy Fridman: vitesse de téléchargement, mémoire, CPU</a></li>
<li><a href="../fr426157/index.html">PUE: savoir abaisser</a></li>
<li><a href="../fr426159/index.html">Est-il possible de refermer le code open source?</a></li>
<li><a href="../fr426161/index.html">La livraison de drones commerciaux est-elle justifiée? L'Islande va découvrir</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>