<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëï üç£ üëáüèª A arquitetura do servi√ßo de fila de mensagens distribu√≠das no Yandex.Cloud ‚úçüèº üíáüèΩ üîé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, meu nome √© Vasily Bogonatov. Sou um daqueles que colocam minha m√£o e cabe√ßa e colocam minha alma a servi√ßo das filas de mensagens persistentes di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>A arquitetura do servi√ßo de fila de mensagens distribu√≠das no Yandex.Cloud</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/455642/"> Ol√°, meu nome √© Vasily Bogonatov.  Sou um daqueles que colocam minha m√£o e cabe√ßa e colocam minha alma a servi√ßo das filas de mensagens persistentes distribu√≠das da Fila de Mensagens Yandex.  O servi√ßo tornou-se p√∫blico no final de maio, mas no Yandex h√° muito tempo √© usado ativamente em v√°rios produtos. <br><br>  Hoje, quero contar aos leitores da Habr sobre filas de mensagens em geral e sobre a Fila de Mensagens Yandex em particular.  Primeiro, quero explicar o que √© uma "fila de mensagens persistentes distribu√≠das" e por que √© necess√°ria.  Mostre seu valor pr√°tico, a mec√¢nica de trabalhar com mensagens, fale sobre a API e a usabilidade.  Na segunda metade do artigo, veremos o lado t√©cnico: como o Yandex Database √© usado em nossas filas (essa √© uma base confi√°vel do nosso servi√ßo), como √© uma abordagem ing√™nua e aprimorada para a constru√ß√£o de uma arquitetura, quais problemas s√£o causados ‚Äã‚Äãpela distribui√ß√£o e como eles podem ser resolvidos. <br><br><img src="https://habrastorage.org/webt/xy/ht/eb/xyhtebqslkofciotlmohtwlopb4.png"><br><a name="habracut"></a><br><h3>  O que √© uma fila de mensagens persistentes distribu√≠da? </h3><br>  A Wikipedia define a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fila de mensagens</a> como "um componente de engenharia de software usado para intera√ß√£o entre processos ou entre processos dentro de um processo".  De fato, esse conceito √© um pouco mais amplo: os processos que interagem usando uma fila podem estar localizados em diferentes servidores e at√© em diferentes datacenters. <br><br>  Vamos esclarecer um pouco os termos. <br><br>  <b>Uma fila de mensagens</b> √© um reposit√≥rio que fornece a localiza√ß√£o e a leitura de dados em uma ordem espec√≠fica. <br><br>  Dois tipos de entidades geralmente interagem com uma fila: <br><br><ul><li>  <b>escritores (produtores)</b> - envia mensagens para a fila; </li><li>  <b>leitores (consumidores)</b> - recebe (l√™) mensagens da fila. </li></ul><br>  Ao usar a fila, leitores e escritores s√£o independentes um do outro.  Eles podem trabalhar com desempenho, confiabilidade, disponibilidade diferentes e podem at√© ser escritos em diferentes linguagens de programa√ß√£o. <br><br>  O cen√°rio principal da fila: transmita de forma confi√°vel e r√°pida as mensagens do gravador para o leitor.  Diferentemente do banco de dados, a fila n√£o se destina ao armazenamento de mensagens a longo prazo.  Em muitas implementa√ß√µes populares, existe um par√¢metro correspondente - "Per√≠odo de reten√ß√£o de mensagens".  Determina quanto tempo a mensagem √© armazenada at√© ser exclu√≠da permanentemente. <br><br>  N√≥s descobrimos o conceito de fila, v√° para "distribui√ß√£o" e "persist√™ncia". <br><br><ul><li>  <b>A distribui√ß√£o</b> no nosso caso significa a presen√ßa de um cluster que armazena e processa dados e metadados da fila, combinando todos os seus n√≥s em um √∫nico todo usando uma rede de computadores. </li><li>  <b>A persist√™ncia</b> implica que todas as mensagens na fila s√£o gravadas no disco e o gravador recebe a confirma√ß√£o do envio somente ap√≥s a grava√ß√£o bem-sucedida. </li></ul><br>  A distribui√ß√£o e a persist√™ncia n√£o afetam a funcionalidade principal da fila, elas fornecem toler√¢ncia a falhas e confiabilidade no armazenamento de dados.  Que tipos de falhas podem ocorrer em nosso sistema, consideraremos um pouco mais tarde.  No entanto, n√£o posso negar a mim mesmo o prazer e abrir um pouco os cart√µes: em toda a hist√≥ria da exist√™ncia do servi√ßo, n√£o perdemos uma √∫nica mensagem salva do cliente. <br><br><h3>  Para que serve a fila de mensagens? </h3><br>  A fila permite separar as partes de servi√ßos logicamente independentes umas das outras, ou seja, fornece <b>dissocia√ß√£o</b> , o que √© t√£o procurado nos microsservi√ßos agora populares.  Isso aumenta a escalabilidade e a confiabilidade: voc√™ sempre pode aumentar o fluxo de grava√ß√µes na fila e adicionar mais leitores - manipuladores de mensagens, enquanto a falha dos leitores n√£o afeta o trabalho dos escritores. <br><br>  As filas suavizam as cargas de pico: elas atuam como buffers para os leitores.  Se as capacidades atuais do leitor n√£o forem suficientes para o processamento instant√¢neo de todas as mensagens recebidas, as mensagens na fila ser√£o processadas posteriormente quando a carga diminuir.  O buffer √© √∫til para servi√ßos com carga inst√°vel, em que eventos instant√¢neos n√£o s√£o necess√°rios. <br><br>  Vamos ver como funciona, usando o exemplo de um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rob√¥ de pesquisa</a> (afinal, o Yandex come√ßou com uma pesquisa!), Que baixa, processa e coloca p√°ginas da Web em um banco de dados.  Vamos pegar essa arquitetura. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zo/oe/dh/zooedh0t0qs4uu1lhpdc0psa2qi.png" width="600" height="778"></div><br><br>  A fila de mensagens resolve os seguintes problemas aqui: <br><br><ol><li>  O rob√¥ trabalha muito mais r√°pido do que os trabalhadores respons√°veis ‚Äã‚Äãpor analisar e carregar p√°ginas no banco de dados.  Fora de linha, os links acumulariam e encheriam a mem√≥ria ou o disco dispon√≠vel.  O mesmo aconteceria se os trabalhadores estivessem temporariamente indispon√≠veis. </li><li>  Sem uma fila, o rob√¥ precisa "conhecer" a interface de trabalho dos trabalhadores para atribuir tarefas a eles.  A interface pode mudar √† medida que o produto se desenvolve. </li><li>  Um trabalhador individual tem uma confiabilidade bastante baixa, portanto, n√£o h√° garantia de que o link transmitido seja processado por ele completamente. </li></ol><br>  A fila fornece armazenamento de dados confi√°vel com escala, permite atrasar o processamento de links.  Se um trabalhador falhar, o link bruto ap√≥s um certo per√≠odo de tempo ser√° retornado √† fila para processamento por outro trabalhador.  A fila possui sua pr√≥pria interface, que √© testada e descrita na documenta√ß√£o, para que os sistemas de rob√¥ e trabalhador de pesquisa possam desenvolver equipes diferentes em diferentes linguagens de programa√ß√£o.  Isso n√£o afetar√° o desempenho geral. <br><br><h3>  Como a fila de mensagens Yandex funciona com mensagens </h3><br>  Tr√™s est√°gios principais podem ser distinguidos aqui: <br><br><ul><li>  <b>escrevendo uma</b> mensagem na fila; </li><li>  <b>lendo uma</b> mensagem da fila; </li><li>  <b>Removendo uma</b> mensagem da fila. </li></ul><br>  Um registro √© considerado bem-sucedido se a mensagem tiver sido armazenada com seguran√ßa e em breve estar√° dispon√≠vel para os leitores.  A grava√ß√£o de redu√ß√£o de redund√¢ncia √© poss√≠vel: quando uma tentativa repetida de gravar uma mensagem enviada √© ignorada. <br><br>  No momento da leitura, a mensagem fica oculta da fila por um per√≠odo chamado Tempo Limite de Visibilidade e fica inacess√≠vel para outros leitores.  Se o tempo limite da visibilidade expirar, a mensagem retornar√° √† fila e ficar√° dispon√≠vel para processamento novamente.  A ordem na qual as mensagens s√£o lidas √© determinada pela fila, n√£o pelo leitor. <br><br>  O pr√≥prio leitor e a conex√£o de rede com ele s√£o potencialmente n√£o confi√°veis.  √â necess√°rio um tempo limite de visibilidade para poder retornar uma mensagem para a fila quando o leitor trava ou a conex√£o √© desconectada.  Caso contr√°rio, √© prov√°vel que uma √∫nica mensagem nunca seja processada corretamente. <br><br>  Ap√≥s a leitura bem-sucedida, a mensagem √© transmitida ao cliente com o identificador ReceiptHandle.  Um identificador indica dados espec√≠ficos que devem ser removidos da fila de mensagens. <br><br><h3>  Tipos de fila na fila de mensagens Yandex </h3><br>  O primeiro e o tipo mais comumente usado √© a fila padr√£o.  √â caracterizada por alta taxa de transfer√™ncia (milhares de mensagens por segundo), excelente desempenho e curto tempo de execu√ß√£o das opera√ß√µes b√°sicas.  As filas padr√£o consistem em fragmentos l√≥gicos e suportam o dimensionamento quase linear da largura de banda. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wy/p0/jp/wyp0jpi_pmhorpq2mikwm_mgl-u.png"></div><br>  As filas padr√£o n√£o oferecem suporte √† deduplica√ß√£o de mensagens ao gravar em uma fila e n√£o garantem a ordem de leitura.  Devido ao uso de sharding, uma solicita√ß√£o de leitura pode n√£o retornar uma √∫nica mensagem, mesmo se elas estiverem na fila.  Na maioria das vezes, isso acontece no modo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pesquisa curta</a> , quando a leitura vem de um fragmento selecionado aleatoriamente. <br><br>  O segundo tipo - <abbr title="Primeiro a entrar, primeiro a sair">FIFO</abbr> - √© o oposto da fila padr√£o.  Ele fornece uma ordem de leitura rigorosa, suporta desduplica√ß√£o ao escrever e tentativas repetidas de ler mensagens.  O desempenho e a escalabilidade s√£o inferiores ao padr√£o.  O desempenho da fila FIFO √© limitado a 30 solicita√ß√µes por segundo.  Recomenda-se que o FIFO seja usado quando voc√™ precisar garantir a sem√¢ntica de entrega "exatamente uma vez".  Normalmente, a palavra "fila" significa FIFO. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yr/jy/l5/yrjyl5kbyfzqzkruqhaoqdrsxzs.png" width="421" height="801"></div><br><h3>  API da fila de mensagens Yandex </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API</a> √© um componente extremamente importante de qualquer produto.  Uma boa interface de software deve ser simples e direta, exigindo familiariza√ß√£o m√≠nima com a documenta√ß√£o para uso efetivo.  N√£o deve permitir a√ß√µes estranhas ou desnecess√°rias e se proteger contra erros est√∫pidos, informando oportunamente a viola√ß√£o do ‚Äúcontrato‚Äù. <br><br>  Se o sistema tiver uma API, ele recebe rapidamente usu√°rios fi√©is e √© cercado por "wrappers" convenientes para diferentes plataformas e linguagens de programa√ß√£o. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A API do Amazon Simple Queue Service (API do AWS SQS)</a> √© um exemplo dessa interface, testada pelo tempo e por um grande n√∫mero de clientes.  Portanto, decidimos n√£o inventar uma interface exclusiva para a fila de mensagens Yandex, mas implementamos o suporte para a API do AWS SQS e com muito cuidado. <br><br>  Na maioria dos casos, √© suficiente para o usu√°rio do SQS alterar o terminal (endere√ßo de servi√ßo), a regi√£o (no momento em que usamos apenas "ru-central1") e obter novas credenciais no Yandex.Cloud.  Tudo o resto, por exemplo, um script usando a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">linha de comando</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AWS</a> , c√≥digo usando o AWS SDK ou um servi√ßo pronto no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Celery</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">boto</a> , provavelmente n√£o ser√° tocado.  A l√≥gica e a funcionalidade do servi√ßo de fila permanecer√£o as mesmas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_r/td/kn/_rtdknyixiytyqo63khne5gz4uq.png"></div><br>  Uma descri√ß√£o detalhada dos m√©todos da API da Fila de mensagens Yandex est√° na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servi√ßo</a> . <br><br><h3>  Um pouco sobre conveni√™ncia </h3><br>  A fila de mensagens Yandex √© um servi√ßo gerenciado, ou seja, Yandex, que √© respons√°vel pela opera√ß√£o de servidores e software.  A equipe de servi√ßo monitora a integridade das filas, substitui rapidamente os discos com falha, elimina quebras de rede e lan√ßa atualiza√ß√µes.  A atualiza√ß√£o n√£o interrompe o servi√ßo: enquanto instalamos a nova vers√£o do YMQ em um grupo de servidores, o balanceador de carga redireciona cuidadosamente o tr√°fego para outros.  Portanto, os usu√°rios n√£o percebem nada. <br><br>  Para tornar mais conveniente o controle da opera√ß√£o das filas, adicionamos um grande n√∫mero de gr√°ficos visuais ao YMQ, apenas uma pequena parte deles √© mostrada aqui.  Os gr√°ficos est√£o localizados no console do Yandex.Cloud, na se√ß√£o "Estat√≠sticas". <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bi/cp/nn/bicpnn5tjwzqustzy9ye5abnrho.png"></div><br>  Falaremos sobre os quatro gr√°ficos mais √∫teis em nossa opini√£o: <br><br><ul><li>  O gr√°fico <b>"Mensagens em fila"</b> ajuda a monitorar o ac√∫mulo de dados na fila.  Um crescimento no gr√°fico pode significar que os manipuladores n√£o est√£o gerenciando a carga ou o processamento foi interrompido. </li><li>  Gr√°fico <b>"Idade da mensagem mais antiga da fila"</b> : valores grandes indicam problemas no processamento da mensagem.  Se tudo funcionar corretamente, as mensagens n√£o devem ficar na fila por muito tempo. </li><li>  O gr√°fico <b>‚ÄúN√∫mero de tentativas para ler uma mensagem‚Äù</b> mostra quando as mensagens come√ßam a ser lidas v√°rias vezes.  Isso pode significar que os manipuladores falham quando recebem algumas mensagens. </li><li>  O gr√°fico <b>"Tempo de enfileiramento"</b> indica quanto tempo decorre desde o momento em que a mensagem √© enviada para a fila at√© que o manipulador a receba. </li></ul><br>  Os gr√°ficos ajudam a avaliar instantaneamente a din√¢mica da fila e a presen√ßa de falhas sem a necessidade de visualizar logs. <br><br>  Discutimos pontos mais ou menos gerais, agora vamos aos detalhes. <br><br><h3>  Como a fila do banco de dados Yandex usa o banco de dados Yandex </h3><br>  O servi√ßo Yandex Message Queue √© constru√≠do sobre o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">banco de dados Yandex Database (YDB)</a> tolerante a falhas e distribu√≠do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">geograficamente</a> , que fornece consist√™ncia e suporte rigorosos para transa√ß√µes ACID.  N√£o desmontaremos agora seu dispositivo e suas caracter√≠sticas, nos limitaremos ao esquema geral. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uq/5m/o3/uq5mo3fm83hovqxkgt7no-yjevg.png" width="742" height="860"></div><br>  Uma fila no YMQ consiste em shards l√≥gicos, representados por algum conjunto fixo de tabelas YDB.  Cada tabela armazena sua pr√≥pria informa√ß√£o.  Por exemplo, h√° uma tabela de estado geral chamada State, que armazena offs e o n√∫mero real de mensagens.  H√° uma tabela com metadados de dados e mensagens.  H√° uma tabela com atributos relacionados. <br><br>  Todas as opera√ß√µes principais com a fila - trabalhando com mensagens, alterando atributos, criando e excluindo - est√£o funcionando com a hierarquia de tabelas e diret√≥rios YDB ou com consultas transacionais para uma ou mais tabelas da fila.  Os dados dentro das tabelas da fila s√£o a fonte da verdade absoluta.  Portanto, al√©m da opera√ß√£o correta e est√°vel do banco de dados, √© necess√°rio garantir armazenamento confi√°vel e alta disponibilidade de dados. <br><br>  Nossas informa√ß√µes s√£o armazenadas em v√°rias r√©plicas: uma c√≥pia em cada um dos tr√™s datacenters Yandex.  Se um dos data centers n√£o estiver dispon√≠vel, o n√∫mero de r√©plicas nos demais duplicar√°.  Assim, o n√≠vel de confiabilidade necess√°rio √© restaurado.  Mesmo que um data center inteiro e uma central de atendimento em outra falhem, os dados estar√£o totalmente acess√≠veis. <br><br><h3>  A primeira vers√£o da arquitetura da fila de mensagens Yandex </h3><br>  A primeira vers√£o da arquitetura YMQ, que n√≥s mesmos chamamos de ing√™nua, era assim. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/qc/eu/ajqceuaoisynocw4u3ffek3epjo.png"></div><br>  O diagrama mostra o caminho da solicita√ß√£o HTTPS do cliente YMQ para o reposit√≥rio YDB.  Vejamos os principais componentes: <br><br><ol><li>  O balanceador L3 envia uma solicita√ß√£o ao data center Yandex mais pr√≥ximo do usu√°rio.  Isso reduz a lat√™ncia da rede, embora a carga seja distribu√≠da de maneira desigual. </li><li>  O Nginx na m√°quina virtual Yandex.Cloud encerra as conex√µes HTTPS, fornece prote√ß√£o contra ataques √† rede e envia a solicita√ß√£o por proxy ao servidor YMQ, j√° em HTTP. </li><li>  O servidor HTTP YMQ implementa a l√≥gica da API HTTP do SQS, valida e converte a solicita√ß√£o em um formato de protobuf fortemente tipado. </li><li>  Sistema YMQ Actor - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sistema ator</a> .  Ao mesmo tempo, lan√ßou milhares de diferentes atores trocando informa√ß√µes.  O sistema de ator de cada host faz parte de um cluster.  Todos os atores do cluster vivem e agem como um todo.  A l√≥gica de neg√≥cios do YMQ √© implementada em v√°rios atores envolvidos nas solicita√ß√µes de transa√ß√£o para o YDB. </li><li>  Tablets YDB ("tablets") - parte do YDB principal, respons√°vel por trabalhar com tabelas em consultas e transa√ß√µes.  Os pr√≥prios tablets n√£o armazenam dados.  Essas s√£o estruturas de controle na mem√≥ria que podem restaurar o estado no caso de uma falha de hardware. </li><li>  O armazenamento √© um armazenamento confi√°vel, distribu√≠do e tolerante a falhas. </li></ol><br>  Essa arquitetura tem uma desvantagem: todos os servidores no cluster trabalham independentemente com tabelas da mesma fila.  Isso afeta negativamente o desempenho e impede a organiza√ß√£o de caches confi√°veis ‚Äã‚Äãde mensagens ocultas e leg√≠veis.  √â dif√≠cil limitar o fluxo de solicita√ß√µes, e isso √© muito importante para qualquer servi√ßo altamente carregado. <br><br><h3>  Arquitetura da fila de mensagens Yandex com mestres de filas </h3><br>  O disparo de carga mostrou que a primeira vers√£o da arquitetura suporta cerca de 450 mensagens por segundo por fila com um shard.  Era muito pequeno. <br>  O principal problema foram as consultas de conten√ß√£o.  Um grande n√∫mero de transa√ß√µes logicamente conflitantes levou rapidamente os caches de mensagens ocultas a um estado inconsistente.  Para resolver o problema, introduzimos uma entidade especial - o mestre da fila. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gc/b4/om/gcb4omkmhk28uhwe2hrlewhzsig.png"></div><br>  <b>O mestre da fila</b> √© um ator que, em condi√ß√µes normais, existe em um cluster em uma √∫nica inst√¢ncia e passa por si todas as solicita√ß√µes associadas a uma fila espec√≠fica.  Se uma solicita√ß√£o para a fila chegar em um servidor em que o mestre desejado est√° ausente, um agente proxy especial redireciona a solicita√ß√£o e converte a resposta recebida de volta do mestre. <br><br>  Ao usar o Assistente de fila, o cache correto de mensagens desbloqueadas reduz a conten√ß√£o ao trabalhar com tabelas.  A implementa√ß√£o da restri√ß√£o do fluxo de solicita√ß√µes √© simplificada, por exemplo, atrav√©s do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bucket Leaky</a> .  M√©tricas de fila r√°pidas e precisas est√£o dispon√≠veis: n√∫mero de mensagens, tr√°fego total e similares.  Voc√™ pode agrupar solicita√ß√µes semelhantes. <br><br>  Em teoria, essa arquitetura tem certas desvantagens associadas √† centraliza√ß√£o: <br><br><ol><li>  Reduzindo a toler√¢ncia a falhas: se uma m√°quina virtual com um mestre falhar, todas as filas com mestres estar√£o indispon√≠veis.  No entanto, os mecanismos especiais do YDB permitem que voc√™ crie novos mestres no cluster em apenas alguns segundos.  Isso resolve em grande parte o problema. </li><li>  Escalabilidade limitada: todas as solicita√ß√µes passam por um host.  A desvantagem s√£o os comprimidos YDB nivelados.  Eles fazem todo o trabalho duro com os dados.  E o mestre envia assincronamente solicita√ß√µes e processa os resultados recebidos.  Isso a torna uma entidade "leve" que n√£o cria um efeito de "gargalo" durante o teste de estresse. </li></ol><br><h3>  Enfileiramento do Assistente de Consulta </h3><br>  As transa√ß√µes distribu√≠das com tabelas de banco de dados levam a certos custos adicionais; portanto, a id√©ia de reduzir o n√∫mero de consultas nos parecia l√≥gica.  Cem transa√ß√µes para gravar mensagens uma de cada vez √© melhor se transformar em uma transa√ß√£o para gravar cem mensagens de uma vez.  Com mestres de filas, implementar esse processamento em lote (lote) √© muito mais f√°cil. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yc/rn/0j/ycrn0j7obrbg0_cimvkyzj5izr4.png"></div><br>  O lote aumenta ligeiramente a lat√™ncia durante as opera√ß√µes.  Em vez disso, a largura de banda √© significativamente aumentada.  Com o lote, uma fila de shard √∫nico pode processar at√© 30.000 solicita√ß√µes por segundo. <br><br>  Em geral, o carregamento da fila pode ser muito diferente: milhares de mensagens por segundo e v√°rias mensagens por dia.  Precis√°vamos otimizar o trabalho com filas usando um algoritmo flex√≠vel.  As op√ß√µes frontais com o ac√∫mulo de mensagens no buffer para o n√∫mero limite ou uma redefini√ß√£o do timer n√£o nos convinham.  Portanto, desenvolvemos um algoritmo de lote adapt√°vel para o YMQ que funciona bem nos dois casos.  Seu trabalho √© mostrado em formato de gr√°fico de tempo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qm/g2/rx/qmg2rx2e8pllaxuajav0gyxe2kg.png"></div><br>  Aqui, quando uma nova mensagem chega, um dos tr√™s cen√°rios √© poss√≠vel: <br><br><ol><li>  Uma transa√ß√£o inicia instantaneamente se n√£o houver outras transa√ß√µes desse tipo em execu√ß√£o. </li><li>  Se j√° houver transa√ß√µes em execu√ß√£o, a mensagem ser√° adicionada ao buffer e aguardar√° a conclus√£o das transa√ß√µes. </li><li>  Se o tamanho do buffer exceder o valor limite, outra transa√ß√£o paralela ser√° iniciada.  O n√∫mero de transa√ß√µes simult√¢neas √© limitado. </li></ol><br>  A id√©ia de lote adapt√°vel se assemelha <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ao algoritmo Nagle</a> para TCP / IP.    :      ,      latency .    ,        .               . <br><br><h3>        </h3><br>  Yandex Message Queue,      ,    .  ,  ,      -. <br><br>    YDB               .   YMQ     . <br><br>           ,   ,     ,      . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ol/yb/ay/olybayeljh8jcdbcmod9dpylopw.png" width="808" height="712"></div><br>  YMQ   .                    .   ¬´¬ª        . <br><br><h3>        </h3><br>  YDB           .    ,  ,     ,   ¬´¬ª.             ,       .          . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eg/em/eg/egemegamvnhmv-c5t8pw4im73u0.png" width="661" height="685"></div><br>   :              .    ,    ¬´¬ª      .  -,   ¬´¬ª  ,   ¬´¬ª,    . <br><br>     ¬´  ¬ª               .    ,  ,     . <br><br><h3>   Yandex Message Queue     </h3><br> Yandex Message Queue ‚Äì  - .      .       ,  .     . <br><br><ul><li> <b>-</b>    ,  ,   .      . </li><li> <b> </b>       API   ,    .  ,        . </li><li> <b> </b>  ,     :    ,           . ,       .          .     boto,    24/7,     -    . </li><li> <b> </b>    ,   ,         .        . </li></ul><br>        .       -         .   .       . <br><br>     : <br><br><ul><li>     5,       ; </li><li>    YDB; </li><li>  , , ,   ; </li><li>      ,    ; </li><li>    .       . </li></ul><br>                  . <br><br><h3>  Em conclus√£o </h3><br>      ‚Äì    ,    ,          ,    .              ., ., ., .   . <br><br>      .            .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> Yandex Message Queue  . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455642/">https://habr.com/ru/post/pt455642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455632/index.html">Aten√ß√£o! Bug perigoso na implementa√ß√£o do C ++ std :: map :: merge e std :: set :: merge no Visual Studio 2017</a></li>
<li><a href="../pt455634/index.html">Matem√°tica e o jogo "Set"</a></li>
<li><a href="../pt455636/index.html">A primeira onda afetada pela vulnerabilidade do Exim. O script para o tratamento</a></li>
<li><a href="../pt455638/index.html">Alan Kay n√£o inventou objetos</a></li>
<li><a href="../pt455640/index.html">Marvin Minsky, ‚ÄúA M√°quina da Emo√ß√£o‚Äù: Cap√≠tulo 4. ‚ÄúComo Reconhecemos a Consci√™ncia‚Äù</a></li>
<li><a href="../pt455644/index.html">Usamos dados na pr√°tica</a></li>
<li><a href="../pt455646/index.html">Semana de Seguran√ßa 24: backdoors de f√°brica em smartphones Android</a></li>
<li><a href="../pt455648/index.html">Ciclo de vida ML</a></li>
<li><a href="../pt455650/index.html">Como treinamos uma rede neural para classificar parafusos</a></li>
<li><a href="../pt455652/index.html">Deep Learning vs senso comum: desenvolvendo um bot de bate-papo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>