<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£üèΩ ‚òØÔ∏è üîó Testes puros em PHP e PHPUnit üëº üç© üëéüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Existem muitas ferramentas no ecossistema PHP que fornecem testes convenientes de PHP. Um dos mais famosos √© o PHPUnit , que √© quase um sin√¥nimo de te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testes puros em PHP e PHPUnit</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/485124/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/jx/3y/zg/jx3yzg2jnznn0kwnk6oe6ikvlzw.jpeg" width="400"></div><br>  Existem muitas ferramentas no ecossistema PHP que fornecem testes convenientes de PHP.  Um dos mais famosos √© o <a href="https://github.com/sebastianbergmann/phpunit">PHPUnit</a> , que √© quase um sin√¥nimo de teste nessa linguagem.  No entanto, n√£o se escreve muito sobre bons m√©todos de teste.  Existem muitas op√ß√µes para por que e quando escrever testes, que tipo de testes e assim por diante.  Mas, para ser sincero, <b>n√£o faz sentido escrever um teste se voc√™ n√£o conseguir l√™-lo mais tarde</b> . <br><br>  Os testes s√£o um tipo especial de documenta√ß√£o.  Como <a href="https://thephp.website/en/issue/real-life-tdd-php/">escrevi anteriormente sobre TDD em PHP</a> , o teste sempre (ou pelo menos deveria) claramente fala sobre qual √© a tarefa de um peda√ßo de c√≥digo espec√≠fico. <br><br>  Se um teste n√£o puder expressar essa ideia, o teste ser√° ruim. <br><br>  Eu preparei um conjunto de t√©cnicas que ajudar√£o os desenvolvedores de PHP a escrever testes bons, leg√≠veis e √∫teis. <br><a name="habracut"></a><br><h2>  Vamos come√ßar com o b√°sico </h2><br>  H√° um conjunto de t√©cnicas padr√£o que muitos seguem sem nenhuma pergunta.  Vou mencionar muitos deles e tentar explicar por que eles s√£o necess√°rios. <br><br><h3>  1. Os testes n√£o devem conter opera√ß√µes de entrada e sa√≠da </h3><br>  <b>O principal motivo</b> : as opera√ß√µes de E / S s√£o lentas e n√£o confi√°veis. <br><br>  <b>Lento</b> : mesmo se voc√™ tiver o melhor hardware do mundo, a E / S ainda ser√° mais lenta do que a mem√≥ria acessa.  Os testes devem sempre funcionar r√°pido, caso contr√°rio, as pessoas os executam muito raramente. <br><br>  <b>N√£o confi√°vel</b> : alguns arquivos, bin√°rios, soquetes, pastas e registros DNS podem n√£o estar dispon√≠veis em algumas m√°quinas nas quais voc√™ est√° testando.  Quanto mais voc√™ confia nos testes de E / S, mais os seus testes est√£o vinculados √† infraestrutura. <br><br>  Quais opera√ß√µes est√£o relacionadas √† E / S: <br><br><ul><li>  Lendo e gravando arquivos. <br></li><li>  Chamadas de rede. <br></li><li> Chamadas para processos externos (usando <code>exec</code> , <code>proc_open</code> , etc.). <br></li></ul><br>  H√° situa√ß√µes em que a presen√ßa de opera√ß√µes de entrada e sa√≠da permite que voc√™ escreva testes mais rapidamente.  Mas tenha cuidado: verifique se essas opera√ß√µes funcionam da mesma maneira em suas m√°quinas para desenvolvimento, montagem e implanta√ß√£o; caso contr√°rio, voc√™ poder√° ter s√©rios problemas. <br><br>  Isole os testes para que eles n√£o precisem de opera√ß√µes de E / S: Forneci uma solu√ß√£o de arquitetura abaixo que impede que os testes executem opera√ß√µes de E / S compartilhando responsabilidade entre interfaces. <br><br>  Um exemplo: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPeople</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ $rawPeople = file_get_contents( <span class="hljs-string"><span class="hljs-string">'people.json'</span></span> ) ?? <span class="hljs-string"><span class="hljs-string">'[]'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json_decode( $rawPeople, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ); }</code> </pre><br>  Quando voc√™ inicia o teste usando esse m√©todo, um arquivo local ser√° criado e, de tempos em tempos, instant√¢neos ser√£o criados: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGetPeopleReturnsPeopleList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $people = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;peopleService -&gt;getPeople(); <span class="hljs-comment"><span class="hljs-comment">// assert it contains people }</span></span></code> </pre> <br>  Para fazer isso, precisamos configurar os pr√©-requisitos para executar os testes.  √Ä primeira vista, tudo parece razo√°vel, mas na verdade √© terr√≠vel. <br><br>  Ignorar um teste devido ao fato de que os pr√©-requisitos n√£o s√£o atendidos n√£o garante a qualidade do nosso software.  Isso apenas oculta bugs! <br><br>  <b>Corrigimos a situa√ß√£o</b> : isolamos as opera√ß√µes de E / S transferindo a responsabilidade para a interface. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// extract the fetching // logic to a specialized // interface interface PeopleProvider { public function getPeople(): array; } // create a concrete implementation class JsonFilePeopleProvider implements PeopleProvider { private const PEOPLE_JSON = 'people.json'; public function getPeople(): array { $rawPeople = file_get_contents( self::PEOPLE_JSON ) ?? '[]'; return json_decode( $rawPeople, true ); } } class PeopleService { // inject via __construct() private PeopleProvider $peopleProvider; public function getPeople(): array { return $this-&gt;peopleProvider -&gt;getPeople(); } }</span></span></code> </pre> <br>  Agora eu sei que o <code>JsonFilePeopleProvider</code> usar√° a E / S em qualquer caso. <br><br>  Em vez de <code>file_get_contents()</code> voc√™ pode usar uma camada de abstra√ß√£o como <a href="https://flysystem.thephpleague.com/docs/adapter/local/">o sistema de arquivos Flysystem</a> , para o qual √© f√°cil criar stubs. <br><br>  E ent√£o por que precisamos do <code>PeopleService</code> ?  Boa pergunta  Para isso, s√£o necess√°rios testes: desafiar a arquitetura e remover c√≥digo in√∫til. <br><br><h3>  2. Os testes devem ser conscientes e significativos. </h3><br>  <b>O principal motivo</b> : os testes s√£o uma forma de documenta√ß√£o.  Mantenha-os claros, concisos e leg√≠veis. <br><br>  <b>Clareza e brevidade</b> : sem bagun√ßa, sem milhares de linhas de stubs, sem seq√º√™ncias de declara√ß√µes. <br><br>  <b>Legibilidade</b> : Os testes devem contar uma hist√≥ria.  A estrutura ‚Äúdado, quando, ent√£o‚Äù √© excelente para isso. <br><br>  Caracter√≠sticas de um teste bom e leg√≠vel: <br><br><ul><li>  Cont√©m apenas as chamadas necess√°rias para o m√©todo <code>assert</code> (de prefer√™ncia um). <br></li><li>  Ele explica claramente o que deve acontecer sob determinadas condi√ß√µes. <br></li><li>  Ele testa apenas um ramo da execu√ß√£o do m√©todo. <br></li><li>  Ele n√£o faz um esbo√ßo para o universo inteiro por causa de qualquer afirma√ß√£o. <br></li></ul><br>  √â importante observar que, se sua implementa√ß√£o contiver express√µes condicionais, operadores de transi√ß√£o ou loops, todos eles dever√£o ser explicitamente cobertos por testes.  Por exemplo, para que as respostas iniciais sempre contenham um teste. <br><br>  Repito: n√£o √© uma quest√£o de cobertura, mas de documenta√ß√£o. <br><br>  Aqui est√° um exemplo de um teste confuso: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCanFly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $noWings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals( <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, $noWings-&gt;canFly() ); $singleWing = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertTrue( !$singleWing-&gt;canFly() ); $twoWings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertTrue( $twoWings-&gt;canFly() ); }</code> </pre> <br>  Vamos adaptar o formato "dado quando, ent√£o" e ver o que acontece: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCanFly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Given $person = $this-&gt;givenAPersonHasNoWings(); // Then $this-&gt;assertEquals( false, $person-&gt;canFly() ); // Further cases... } private function givenAPersonHasNoWings(): Person { return new Person(0); }</span></span></code> </pre> <br>  Como a se√ß√£o "Dados", "quando" e "ent√£o" podem ser transferidos para m√©todos privados.  Isso tornar√° seu teste mais leg√≠vel. <br><br>  <code>assertEquals</code> bagun√ßa in√∫til.  A pessoa que est√° lendo isso deve rastrear a declara√ß√£o para entender o que isso significa. <br><br>  O uso de instru√ß√µes espec√≠ficas tornar√° seu teste muito mais leg√≠vel.  <code>assertTrue()</code> deve receber uma vari√°vel booleana, n√£o uma express√£o como <code>canFly() !== true</code> . <br><br>  No exemplo anterior, substitu√≠mos <code>assertEquals</code> entre <code>false</code> e <code>$person-&gt;canFly()</code> por um <code>assertFalse</code> simples: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ... $person = $this-&gt;givenAPersonHasNoWings(); $this-&gt;assertFalse( $person-&gt;canFly() ); // Further cases...</span></span></code> </pre> <br>  Agora est√° tudo muito claro!  Se uma pessoa n√£o tem asas, ela n√£o deve poder voar!  Leia como um poema <br><br>  Agora, a se√ß√£o "Outros casos", que aparece duas vezes em nosso texto, √© uma indica√ß√£o clara de que o teste faz muitas declara√ß√µes.  O m√©todo <code>testCanFly()</code> √© completamente in√∫til. <br><br>  Vamos melhorar o teste novamente: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCanFlyIsFalsyWhenPersonHasNoWings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $person = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;givenAPersonHasNoWings(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertFalse( $person-&gt;canFly() ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCanFlyIsTruthyWhenPersonHasTwoWings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $person = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;givenAPersonHasTwoWings(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertTrue( $person-&gt;canFly() ); } <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br>  Podemos at√© renomear o m√©todo de teste para que ele corresponda ao cen√°rio real, por exemplo, em <code>testPersonCantFlyWithoutWings</code> , mas tudo me conv√©m de <code>testPersonCantFlyWithoutWings</code> . <br><br><h3>  3. O teste n√£o deve depender de outros testes </h3><br>  <b>O principal motivo</b> : os testes devem ser executados e executados com √™xito em qualquer ordem. <br><br>  N√£o vejo raz√µes suficientes para criar interconex√µes entre testes.  Recentemente me pediram para fazer um teste de fun√ß√£o de login, vou dar aqui como um bom exemplo. <br><br>  O teste deve: <br><br><ul><li>  Gere um token JWT para efetuar login. <br></li><li>  Execute a fun√ß√£o de login. <br></li><li>  Aprovar a mudan√ßa de status. <br></li></ul><br>  Foi assim: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGenerateJWTToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... $token $this-&gt;token = $token; } // @depends testGenerateJWTToken public function testExecuteAnAmazingFeature(): void { // Execute using $this-&gt;token } // @depends testExecuteAnAmazingFeature public function testStateIsBlah(): void { // Poll for state changes on // Logged-in interface }</span></span></code> </pre> <br>  Isso √© ruim por v√°rios motivos: <br><br><ul><li>  O PHPUnit n√£o pode garantir essa ordem de execu√ß√£o. <br></li><li>  Os testes devem poder executar independentemente. <br></li><li>  Testes paralelos podem falhar aleatoriamente. <br></li></ul><br>  A maneira mais f√°cil de contornar isso √© usar o esquema dado, quando e depois.  Portanto, os testes ser√£o mais ponderados, eles contar√£o uma hist√≥ria, demonstrando claramente suas depend√™ncias, explicando a fun√ß√£o que est√° sendo testada. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testAmazingFeatureChangesState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Given $token = $this-&gt;givenImAuthenticated(); // When $this-&gt;whenIExecuteMyAmazingFeature( $token ); $newState = $this-&gt;pollStateFromInterface( $token ); // Then $this-&gt;assertEquals( 'my-state', $newState ); }</span></span></code> </pre> <br>  Tamb√©m precisamos adicionar testes para autentica√ß√£o, etc. Essa estrutura √© t√£o boa que o <a href="https://behat.org/en/latest/quick_start.html">Behat √© usado por padr√£o</a> . <br><br><h3>  4. Sempre implemente depend√™ncias </h3><br>  <b>A principal raz√£o</b> : um tom muito ruim - para criar um esbo√ßo para o estado global.  A incapacidade de criar stubs para depend√™ncias n√£o permite testar a fun√ß√£o. <br><br>  Dica √∫til: <b>esque√ßa as classes est√°ticas e inst√¢ncias est√°ticas</b> .  Se sua classe depende de algo, fa√ßa-o para que possa ser implementado. <br><br>  Aqui est√° um exemplo triste: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FeatureToggle</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isActive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Id $feature )</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function"> </span></span>{ $cookieName = $feature-&gt;getCookieName(); <span class="hljs-comment"><span class="hljs-comment">// Early return if cookie // override is present if (Cookies::exists( $cookieName )) { return Cookies::get( $cookieName ); } // Evaluate feature toggle... } }</span></span></code> </pre> <br>  Como posso testar esta resposta inicial? <br><br>  Isso mesmo.  De jeito nenhum. <br><br>  Para test√°-lo, precisamos entender o comportamento da classe <code>Cookies</code> e garantir que possamos reproduzir todo o ambiente associado a ela, resultando em certas respostas. <br><br>  N√£o fa√ßa isso. <br><br>  A situa√ß√£o pode ser corrigida se voc√™ implementar uma inst√¢ncia de <code>Cookies</code> como uma depend√™ncia.  O teste ter√° a seguinte apar√™ncia: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// Test class... private Cookies $cookieMock; private FeatureToggle $service; // Preparing our service and dependencies public function setUp(): void { $this-&gt;cookieMock = $this-&gt;prophesize( Cookies::class ); $this-&gt;service = new FeatureToggle( $this-&gt;cookieMock-&gt;reveal() ); } public function testIsActiveIsOverriddenByCookies(): void { // Given $feature = $this-&gt;givenFeatureXExists(); // When $this-&gt;whenCookieOverridesFeatureWithTrue( $feature ); // Then $this-&gt;assertTrue( $this-&gt;service-&gt;isActive($feature) ); // additionally we can assert // no other methods were called } private function givenFeatureXExists(): Id { // ... return $feature; } private function whenCookieOverridesFeatureWithTrue( Id $feature ): void { $cookieName = $feature-&gt;getCookieName(); $this-&gt;cookieMock-&gt;exists($cookieName) -&gt;shouldBeCalledOnce() -&gt;willReturn(true); $this-&gt;cookieMock-&gt;get($cookieName) -&gt;shouldBeCalledOnce() -&gt;willReturn(true); }</span></span></code> </pre> <br>  O mesmo vale para singletones.  Portanto, se voc√™ deseja tornar um objeto √∫nico, configure corretamente seu injetor de depend√™ncia, em vez de usar o padr√£o (anti) singleton.  Caso contr√°rio, voc√™ escrever√° m√©todos que s√£o √∫teis apenas para casos como <code>reset()</code> ou <code>setInstance()</code> .  Na minha opini√£o, isso √© loucura. <br><br>  √â completamente normal alterar a arquitetura para facilitar o teste!  E criar m√©todos para facilitar o teste n√£o √© normal. <br><br><h3>  5. Nunca teste m√©todos protegidos / privados </h3><br>  <b>O principal motivo</b> : eles afetam a maneira como testamos as fun√ß√µes determinando a assinatura do comportamento: sob essa condi√ß√£o, quando digito A, espero obter B. <b>M√©todos particulares / protegidos n√£o fazem parte das assinaturas da fun√ß√£o</b> . <br><br>  Eu nem quero mostrar uma maneira de "testar" m√©todos privados, mas darei uma dica: voc√™ s√≥ pode fazer isso usando a API de <a href="https://www.php.net/manual/en/book.reflection.php">reflex√£o</a> . <br><br>  Sempre se castigue de alguma forma quando voc√™ pensa em usar a reflex√£o para testar m√©todos privados!  Desenvolvedor ruim, ruim! <br><br>  Por defini√ß√£o, m√©todos privados s√£o chamados apenas internamente.  Ou seja, eles n√£o est√£o dispon√≠veis ao p√∫blico.  Isso significa que apenas m√©todos p√∫blicos da mesma classe podem chamar esses m√©todos. <br><br>  <b>Se voc√™ testou todos os seus m√©todos p√∫blicos, tamb√©m testou todos os m√©todos privados / protegidos</b> .  Se n√£o for esse o caso, remova livremente m√©todos privados / protegidos; ningu√©m os usa de qualquer maneira. <br><br><h2>  Dicas avan√ßadas </h2><br>  Espero que voc√™ n√£o esteja entediado ainda.  Ainda assim, eu tive que falar sobre o b√°sico.  Agora vou compartilhar minha opini√£o sobre como escrever testes e decis√µes limpas que afetam meu processo de desenvolvimento. <br><br>  A coisa mais importante que n√£o esque√ßo ao escrever testes: <br><br><ul><li>  Estudo. <br></li><li>  Feedback r√°pido. <br></li><li>  Documenta√ß√£o <br></li><li>  Refatora√ß√£o <br></li><li>  Design durante o teste. <br></li></ul><br><h3>  1. Testes no come√ßo, n√£o no fim </h3><br>  <b>Valores</b> : estudo, feedback r√°pido, documenta√ß√£o, refatora√ß√£o, design durante o teste. <br><br>  Esta √© a base de tudo.  O aspecto mais importante, que inclui todos os valores listados.  Quando voc√™ escreve testes com anteced√™ncia, isso ajuda a entender primeiro como o esquema "dado, quando, ent√£o" deve ser estruturado.  Ao fazer isso, voc√™ primeiro documenta e, mais importante, lembra e define seus requisitos como os aspectos mais importantes. <br><br>  √â estranho ouvir sobre a grava√ß√£o de testes antes da implementa√ß√£o?  E imagine como √© estranho implementar algo e, ao testar para descobrir, todas as suas express√µes "dadas quando, ent√£o" n√£o fazem sentido. <br><br>  Al√©m disso, essa abordagem verificar√° suas expectativas a cada dois segundos.  Voc√™ recebe feedback o mais r√°pido poss√≠vel.  N√£o importa o tamanho ou a apar√™ncia do recurso. <br><br>  Testes verdes s√£o uma √°rea ideal para refatora√ß√£o.  A id√©ia principal: sem testes - sem refatora√ß√£o.  A refatora√ß√£o sem testes √© simplesmente perigosa. <br><br>  Finalmente, definindo a estrutura ‚Äúdada quando, ent√£o‚Äù, ficar√° √≥bvio para voc√™ quais interfaces seus m√©todos devem ter e como devem se comportar.  Manter o teste limpo tamb√©m for√ßar√° voc√™ a tomar constantemente diferentes decis√µes de arquitetura.  Isso for√ßar√° voc√™ a criar f√°bricas, interfaces, interromper a heran√ßa etc. E sim, os testes se tornar√£o mais f√°ceis! <br><br>  Se seus testes s√£o documentos ativos que explicam como o aplicativo funciona, √© imperativo que eles deixem claro. <br><br><h3>  2. Melhor sem testes do que com testes ruins </h3><br>  <b>Valores</b> : estudo, documenta√ß√£o, refatora√ß√£o. <br><br>  Muitos desenvolvedores pensam nos testes da seguinte maneira: escreverei um recurso, dirigirei a estrutura de teste at√© que os testes abranjam um certo n√∫mero de novas linhas e os coloque em opera√ß√£o. <br><br>  Parece-me que voc√™ precisa prestar mais aten√ß√£o √† situa√ß√£o em que um novo desenvolvedor come√ßa a trabalhar com esse recurso.  <b>O que os testes dir√£o a essa pessoa?</b> <br><br>  Os testes geralmente s√£o confusos se os nomes n√£o forem detalhados o suficiente.  O que √© mais claro: <code>testCanFly</code> ou <code>testCanFlyReturnsFalseWhenPersonHasNoWings</code> ? <br><br>  Se seus testes s√£o apenas um c√≥digo confuso que faz com que a estrutura cubra mais linhas, com exemplos que n√£o fazem sentido, √© hora de parar e pensar em escrever esses testes. <br><br>  Mesmo bobagens como atribuir <code>$a</code> e <code>$b</code> vari√°veis ‚Äã‚Äãou atribuir nomes que n√£o est√£o relacionados a um uso espec√≠fico. <br><br>  <b>Lembre</b> - <b>se</b> : seus testes s√£o documentos ativos, tentando explicar como seu aplicativo deve se comportar.  <code>assertFalse($a-&gt;canFly())</code> n√£o documenta muito.  E <code>assertFalse($personWithNoWings-&gt;canFly())</code> j√° √© bastante. <br><br><h3>  3. Execute testes de forma intrusiva </h3><br>  <b>Valores</b> : estudo, feedback r√°pido, refatora√ß√£o. <br><br>  Antes de come√ßar a trabalhar nos recursos, execute os testes.  Se eles falharem antes que voc√™ comece a trabalhar, voc√™ saber√° disso <i>antes de</i> escrever o c√≥digo e n√£o precisar√° gastar minutos preciosos na depura√ß√£o de testes quebrados com os quais nem se importava. <br><br>  Depois de salvar o arquivo, execute os testes.  Quanto mais cedo voc√™ descobrir que algo est√° quebrado, mais r√°pido voc√™ o corrige e segue em frente.  Se a interrup√ß√£o do fluxo de trabalho para resolver um problema parecer improdutiva para voc√™, imagine que mais tarde voc√™ precisar√° voltar v√°rias etapas se n√£o souber sobre o problema. <br><br>  Ap√≥s conversar por cinco minutos com os colegas ou verificar as notifica√ß√µes do Github, execute os testes.  Se eles coraram, ent√£o voc√™ sabe de onde parou.  Se os testes estiverem verdes, voc√™ poder√° continuar trabalhando. <br>  Ap√≥s qualquer refatora√ß√£o, mesmo nomes de vari√°veis, execute os testes. <br><br>  S√©rio, execute os malditos testes.  Sempre que voc√™ pressionar o bot√£o Salvar. <br>  <a href="https://github.com/spatie/phpunit-watcher">O PHPUnit Watcher</a> pode fazer isso por voc√™ e at√© enviar notifica√ß√µes! <br><br><h3>  4. Grandes testes - grande responsabilidade </h3><br>  <b>Valores</b> : estudo, refatora√ß√£o, design durante o teste. <br><br>  Idealmente, cada classe deve ter um teste.  Este teste deve abranger todos os m√©todos p√∫blicos desta classe, bem como todas as express√µes condicionais ou operadores de transi√ß√£o ... <br><br>  Voc√™ pode pegar algo assim: <br><br><ul><li>  Uma classe = um caso de teste. <br></li><li>  Um m√©todo = um ou mais testes. <br></li><li>  Uma ramifica√ß√£o alternativa (se / switch / try-catch / exception) = um teste. <br></li></ul><br>  Portanto, para esse c√≥digo simples, voc√™ precisar√° de quatro testes: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// class Person public function eatSlice(Pizza $pizza): void { // test exception if ([] === $pizza-&gt;slices()) { throw new LogicException('...'); } // test exception if (true === $this-&gt;isFull()) { throw new LogicException('...'); } // test default path (slices = 1) $slices = 1; // test alternative path (slices = 2) if (true === $this-&gt;isVeryHungry()) { $slices = 2; } $pizza-&gt;removeSlices($slices); }</span></span></code> </pre> <br>  Quanto mais m√©todos p√∫blicos voc√™ tiver, mais testes ser√£o necess√°rios. <br><br>  Ningu√©m gosta de ler documenta√ß√£o longa.  Como seus testes tamb√©m s√£o documentos, o tamanho pequeno e a signific√¢ncia apenas aumentar√£o sua qualidade e utilidade. <br><br>  Tamb√©m √© um sinal importante de que sua classe est√° acumulando responsabilidades e √© hora de refator√°-la transferindo v√°rias fun√ß√µes para outras classes ou redesenhando o sistema. <br><br><h3>  5. Apoie um conjunto de testes para resolver problemas de regress√£o </h3><br>  <b>Valores</b> : estudo, documenta√ß√£o, feedback r√°pido. <br><br>  Considere a fun√ß√£o: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">object</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fromDb((int) $id); }</code> </pre> <br>  Voc√™ acha que algu√©m est√° transmitindo "10", mas na verdade "10 bananas" est√° sendo transmitida.  Ou seja, dois valores v√™m, mas um √© sup√©rfluo.  Voc√™ tem um bug. <br><br>  O que voc√™ far√° primeiro?  Escreva um teste que marque esse comportamento err√¥neo !!! <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFindByIdAcceptsOnlyNumericIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;expectException(InvalidArgumentException::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;expectExceptionMessage( <span class="hljs-string"><span class="hljs-string">'Only numeric IDs are allowed.'</span></span> ); findById(<span class="hljs-string"><span class="hljs-string">"10 bananas"</span></span>); }</code> </pre> <br>  Obviamente, os testes n√£o transmitem nada.  Mas agora voc√™ sabe o que precisa ser feito para que eles transmitam.  Corrija o erro, torne os testes verdes, implante o aplicativo e seja feliz. <br><br>  Mantenha este teste com voc√™.  Sempre que poss√≠vel, em um conjunto de testes projetados para resolver problemas com regress√£o. <br><br>  Isso √© tudo!  Feedback r√°pido, corre√ß√µes de erros, documenta√ß√£o, c√≥digo resistente √† regress√£o e felicidade. <br><br><h2>  Palavra final </h2><br>  Muito do exposto √© apenas minha opini√£o pessoal, desenvolvida durante minha carreira.  Isso n√£o significa que o conselho seja verdadeiro ou falso, √© apenas uma opini√£o. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485124/">https://habr.com/ru/post/pt485124/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485108/index.html">Estat√≠sticas de especialistas certificados em PMI na R√∫ssia em 10/01/2020</a></li>
<li><a href="../pt485110/index.html">Minha experi√™ncia de trabalho remoto eficaz</a></li>
<li><a href="../pt485118/index.html">C√≥digo Limpo de Robert Martin. Resumo. Como escrever um c√≥digo claro e bonito?</a></li>
<li><a href="../pt485120/index.html">Adicione uma API JSON muito r√°pida ao nosso aplicativo.</a></li>
<li><a href="../pt485122/index.html">O cabe√ßalho "Leia artigos para voc√™". Outubro - dezembro de 2019</a></li>
<li><a href="../pt485126/index.html">Mu-mu, woof-woof, quack-quack: evolu√ß√£o da comunica√ß√£o ac√∫stica</a></li>
<li><a href="../pt485128/index.html">Economize nas licen√ßas Mikrotik CHR</a></li>
<li><a href="../pt485132/index.html">Participe do Festival de jogos independentes do Google Play</a></li>
<li><a href="../pt485136/index.html">Rastreamento e monitoramento Istio: microsservi√ßos e o princ√≠pio da incerteza</a></li>
<li><a href="../pt485138/index.html">Localiza√ß√£o de aplicativos: como fizemos amigos tradu√ß√£o e desenvolvimento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>