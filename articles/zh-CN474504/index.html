<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌨️ 🕵🏼 🍌 正统后端 🐑 🥑 🤼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="现代的后端是多种多样的，但是仍然遵守一些潜规则。 我们中许多开发服务器应用程序的人都面临着公认的方法，例如Clean Architecture，SOLID，Persistence Ignorance，Dependency Injection等。 服务器开发的许多属性是如此刻板，以至于它们不会引起任何...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>正统后端</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474504/"><img src="https://habrastorage.org/webt/dj/q5/y-/djq5y-xjov_bqvrrnb08bfyqn4i.jpeg"><br><br> 现代的后端是多种多样的，但是仍然遵守一些潜规则。 我们中许多开发服务器应用程序的人都面临着公认的方法，例如Clean Architecture，SOLID，Persistence Ignorance，Dependency Injection等。 服务器开发的许多属性是如此刻板，以至于它们不会引起任何问题，而且会被不加思索地使用。 他们谈论很多，但从未使用过。 其余的含义被错误地解释或扭曲。 本文讨论了如何构建一个简单，完全典型的后端体系结构，该体系结构不仅可以遵循著名编程理论家的戒律，而且不会造成任何损害，还可以在一定程度上对其进行改进。 <br><a name="habracut"></a><br>  <i>献给所有不认为编程没有美感并且在荒谬之中不接受美感的人。</i> <br><br><h2> 领域模型 </h2><br> 建模是理想世界中软件开发的起点。 但是我们都不是十全十美的，我们谈论了很多，但是我们像往常一样做所有事情。 通常的原因是现有工具的不完善。 老实说，我们的懒惰和害怕承担责任以摆脱“最佳做法”。 在一个不完美的世界中，软件开发充其量只是从脚手架开始，而最糟糕的是，性能优化无法完成任何工作。 尽管如此，我还是想抛弃“杰出”建筑师的辛勤事例，而去猜测更平凡的事情。 <br><br> 因此，我们有一项技术任务，甚至还有一个用户界面设计（如果没有提供UI，则没有）。 下一步是在域模型中反映需求。 首先，为了清晰起见，您可以绘制模型对象图： <br><br><img src="https://habrastorage.org/webt/4n/hp/m5/4nhpm5kbhwvomryj9xhyww1eep0.png"><br><br> 然后，通常，我们开始根据模型的实现方式（即编程语言，对象关系转换器（Object-Relational Mapper，ORM））或某种复杂的框架（例如ASP.NET MVC或Ruby on Rails）来投影模型-开始编写代码。 在这种情况下，我们遵循框架的路径，我认为这在基于模型的开发框架中是不正确的，无论最初看起来多么方便。 在这里，您做出了一个巨大的假设，该假设随后否定了基于域的开发的好处。 作为一种较自由的选择，不受任何工具范围的限制，我建议仅使用编程语言的语法工具来构建主题区域的对象模型。 在我的工作中，我使用几种编程语言-C＃，JavaScript，Ruby。 命运已下令，Java和C＃生态系统是我的灵感来源，JS是我的主要收入，而Ruby是我喜欢的语言。 因此，我将继续在Ruby中展示一些简单的示例：我相信这不会给其他语言的开发人员带来麻烦。 因此，将模型移植到Ruby中的Invoice类： <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Invoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">price</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">charge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br> 即 我们有一个其构造函数接受属性的哈希值，对象依赖项并初始化其字段的类，以及一个可以更改对象状态的pay方法。 一切都非常简单。 现在，我们不再考虑如何以及在何处显示和存储该对象。 它只是存在，我们可以创建它，更改其状态，与其他对象进行交互。 请注意，该代码不包含任何外来工件，例如BaseEntity和与该模型无关的其他垃圾。 这很重要。 顺便说一句，在这个阶段，我们已经可以使用存根对象而不是诸如payment_service之类的依赖项通过测试（TDD）开始开发了： <br><br><pre> <code class="ruby hljs">RSpec.describe Invoice <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> before <span class="hljs-symbol"><span class="hljs-symbol">:each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @payment_service = double(<span class="hljs-symbol"><span class="hljs-symbol">:payment_service</span></span>) allow(@payment_service).to receive(<span class="hljs-symbol"><span class="hljs-symbol">:charge</span></span>) @amount = <span class="hljs-number"><span class="hljs-number">100</span></span> @credit_card = CreditCard.new({...}) @customer = Customer.new({<span class="hljs-symbol"><span class="hljs-symbol">credit_card:</span></span> @credit_card, ...}) @subscription = Subscription.new({<span class="hljs-symbol"><span class="hljs-symbol">customer:</span></span> customer, ...}) @invoice = Invoice.new({<span class="hljs-symbol"><span class="hljs-symbol">amount:</span></span> @amount, <span class="hljs-symbol"><span class="hljs-symbol">date:</span></span> DateTime.now, @subscription: subscription}, payment_service) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> describe <span class="hljs-string"><span class="hljs-string">'pay'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"charges customer's credit card"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(@payment_service).to receive(<span class="hljs-symbol"><span class="hljs-symbol">:charge</span></span>).with(@credit_card, @amount) @invoice.pay <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> it <span class="hljs-string"><span class="hljs-string">'makes the invoice paid'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(@invoice.paid_at).not_to be_nil @invoice.pay <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br> 甚至使用解释器中的模型（Ruby的Irb），尽管不是很友好，但它可能是用户界面： <br><br><pre> <code class="bash hljs">irb &gt; invoice = Invoice.new({amount: @amount, date: DateTime.now, @subscription: subscription}, payment_service) irb &gt; invoice.pay</code> </pre><br> 为什么在此阶段避免“外来人工制品”如此重要？ 事实是，模型完全不知道如何保存或是否保存。 最后，对于某些系统，将对象直接存储在内存中可能是非常合适的。 在建模时，我们必须完全从这个细节中抽象出来。 这种方法称为持久性无知。 应该强调的是，无论是关系数据库还是任何其他数据库，我们都不会忽略使用存储库的问题，我们只会在建模阶段忽略与存储库交互的细节。 持久性无知意味着从模型本身中有意消除使用模型状态的机制以及与此过程相关的所有元数据。 范例： <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  class User &lt; Entity #     table :users #     # mapping  field :name, type: 'String' #   def save ... end end user = User.load(id) #     user.save #    </span></span></code> </pre><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  class User #   ,      attr_accessor :name, :lastname end user = repo.load(id) #     repo.save(user) #    </span></span></code> </pre><br> 这种方法也是由于根本原因-遵守唯一责任原则（单一责任原则，在SOLID中为S）。 如果该模型除了其功能组件之外还描述了状态保存参数并处理其保存和加载，那么显然它承担了太多的责任。 持久性无知所带来的并非最后的优势是能够在开发过程中替换存储工具，甚至替换存储本身的类型。 <br><br><h2> 模型视图控制器 </h2><br>  MVC概念在不同语言和平台的各种（不仅是服务器）应用程序的开发环境中非常流行，以至于我们不再考虑它是什么以及为什么需要它。 这个缩写词给我带来的最多疑问是“控制器”。 从组织代码结构的角度来看，对模型进行操作分组是一件好事。 但是控制器根本不应该是一个类，而应该是一个包含用于访问模型的方法的模块。 不仅如此，它是否应该有位置？ 作为遵循.NET-&gt; Ruby-&gt; Node.js路径的开发人员，我对在express.js框架内实现的JS（ES5）控制器很感兴趣。 有能力以更实用的方式解决分配给控制器的任务，开发人员如痴如醉，一次又一次地写出了神奇的“控制器”。 为什么典型的控制器不好？ <br><br> 典型的控制器是一组彼此之间不密切相关的方法，仅由一个方法（模型的某种本质）结合在一起。 有时不仅如此，更糟。 每个单独的方法可能需要不同的依赖性。 展望未来，我注意到我是依赖反转实践（Dependency Inversion，SOLID中的D）的支持者。 因此，我需要在外部的某个地方初始化这些依赖项，并将它们传递给控制器​​构造函数。 例如，在创建新帐户时，我必须将通知发送给需要通知服务的会计，而在其他方法中，则不需要： <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceController</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_by_id</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify_accountant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br> 在这里，这个想法可分为用于处理模型的方法分成单独的类，为什么不呢？ <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListInvoices</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateInvoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify_accountant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br> 好吧，现在有了代替控制器的一组用于访问模型的“功能”，顺便说一句，这些功能也可以使用例如文件系统目录来构造。 现在您需要将这些方法“开放”到外部，即 整理路由器之类的东西。 作为一个对各种DSL（特定于域的语言）感兴趣的人，我更希望对Web应用程序的指令进行更直观的描述，而不是Ruby或其他用于指定路由的通用语言中的技巧： <br><br><pre> <code class="plaintext hljs">`HTTP GET /invoices -&gt; return all invoices` `HTTP POST /invoices -&gt; create new invoice`</code> </pre><br> 或至少 <br><br><pre> <code class="plaintext hljs">`HTTP GET /invoices -&gt; ./invoices/list_invoices` `HTTP POST /invoices -&gt; ./invoices/create`</code> </pre><br> 这与典型的路由器非常相似，唯一的区别是它不与控制器交互，而直接与模型上的动作交互。 显然，如果要发送和接收JSON，则必须注意对象的序列化和反序列化以及更多其他工作。 一种或另一种方式，我们可以摆脱控制器，将其部分责任转移到目录结构和更高级的路由器上。 <br><br><h2> 依赖注入 </h2><br> 我故意写了“更高级的路由器”。 为了使路由器能够真正在声明级别使用依赖注入机制允许模型上的动作流，它在内部可能应该非常复杂。 他的工作总体方案应如下所示： <br><br><img src="https://habrastorage.org/webt/62/v1/ts/62v1tsjynvq067lnqxmpqefw0lg.png"><br><br> 如您所见，我的整个路由器都使用IoC容器进行了依赖注入。 为什么还要这样做？  “依赖关系注入”的概念可以追溯到依赖关系反转技术，该技术旨在通过将依赖关系初始化移出对象的使用范围来减少对象的连接性。 一个例子： <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repository</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">#  (   ) class A def initialize </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@repo</span></span></span><span class="hljs-comment"> = Repository.new end end #  (   ) class A def initialize(repo) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@repo</span></span></span><span class="hljs-comment"> = repo end end</span></span></code> </pre><br> 这种方法极大地帮助了那些使用测试驱动开发的人。 在上面的示例中，我们可以轻松地在构造函数中放置一个存根，而不是与其接口相对应的实际存储库对象，而无需“破解”对象模型。 这不是唯一的DI奖励：正确应用此方法将为您的应用程序带来很多令人愉悦的魔力，但是首先要考虑的是。 依赖注入是一种允许您将依赖倒置技术集成到完整体系结构解决方案中的方法。 实施工具通常是IoC-（控制反转）容器。 在Java和.NET世界中，有很多非常酷的IoC容器，其中有数十个。 不幸的是，在JS和Ruby中，没有适合我的选项。 我特别看了干容器（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">dry-container</a> ）。 这就是我的班级使用它的样子： <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Invoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Import</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">price</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">charge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br> 我们不用笨拙地使用构造函数，而是通过引入我们自己的依赖关系来加重类的负担，这在初始阶段使我们脱离了干净且独立的模型。 好吧，有些事情，该模型完全不应该了解IoC！ 对于诸如CreateInvoice之类的操作，这是正确的。 对于给定的情况，在我的测试中，我已经不得不使用IoC作为不可剥夺的东西。 这是完全错误的。 大多数情况下，应用程序对象不应该知道IoC的存在。 经过大量的搜索和思考， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">我画出了自己的IoC</a> ，这并不那么令人讨厌。 <br><br><h2> 保存和加载模型 </h2><br> 持久性无知需要一个不引人注目的对象转换器。 在本文中，我的意思是使用关系数据库，要点对于其他类型的存储来说都是正确的。 对象关系转换器-ORM（对象关系映射器）用作关系数据库的类似转换器。 在.NET和Java的世界中，有大量真正强大的ORM工具。 它们都有一些或其他小的缺陷，您可以闭上眼睛。  JS和Ruby中没有好的解决方案。 所有这些都以一种或另一种方式将模型严格地绑定到框架上，并强制声明外来元素，更不用说持久性无知的不适用性了。 与IoC一样，我考虑过自己实现ORM，这就是Ruby中的事务状态。 我并没有从头开始做所有事情，而是以一个简单的ORM Sequel为基础，它提供了用于处理不同关系DBMS的简单工具。 首先，我对以常规SQL形式执行查询的能力感兴趣，能够在输出处接收字符串数组（哈希对象）。 只剩下实现您的Mapper和提供持久性无知。 如前所述，我不想将映射字段混入域模型中，因此我实现了Mapper，以便它使用类型格式的单独配置文件： <br><br><pre> <code class="ruby hljs">entity Invoice <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:amount</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:start_date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:end_date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:created_at</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:updated_at</span></span> reference <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> User reference <span class="hljs-symbol"><span class="hljs-symbol">:subscription</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> Subscription <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br> 使用Repository类型的外部对象，实现Persistence Ignorance非常简单： <br><br><pre> <code class="ruby hljs">repository.save(user)</code> </pre> <br> 但是我们将更进一步，实现工作单元模式。 为此，您需要强调会议的概念。 会话是一个随时间而存在的对象，在此期间，对模型执行一组操作，这是一个逻辑操作。 在会话过程中，可能会发生加载和更改模型对象的情况。 在会话结束时，将保存模型的事务状态。 <br> 工作单元示例： <br><br><pre> <code class="ruby hljs">user = session.load(User, <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) plan = session.load(Plan, <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) subscription = Subscription.new(user, plan) session.attach(subscription) invoice = Invoice.new(subscription) session.attach(invoice) <span class="hljs-comment"><span class="hljs-comment"># ... # -       if Date.today.yday == 1 subscription.comment = 'New year offer' invoice.amount /= 2 end session.flush</span></span></code> </pre><br> 结果，将在数据库中执行2条指令，而不是4条指令，并且两条指令都将在同一事务中执行。 <br><br> 然后突然想起存储库！ 就像控制器一样，这里有种似曾相识的感觉：存储库不是同一基本实体吗？ 展望未来，我会回答-是的。 存储库的主要目的是保存业务逻辑层免于与实际存储进行交互。 例如，在关系数据库的上下文中，这意味着直接在业务逻辑代码中编写SQL查询。 无疑，这是一个非常合理的决定。 但是回到我们摆脱控制器的那一刻。 从OOP的角度来看，存储库实质上是相同的控制器-相同的方法集，不仅用于处理请求，而且用于处理存储库。 存储库也可以分为动作。 所有迹象表明，这些动作与我们提出的代替控制器的建议没有任何不同。 也就是说，我们可以拒绝存储库和控制器，而只支持一个统一的Action！ <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadPlan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class"> = &lt;&lt;~</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELECT</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AS</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENTITY</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FROM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plans</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WHERE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fetch</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br> 您可能已经注意到，我使用SQL而不是某种对象语法。 这是一个品味问题。 我更喜欢SQL，因为它是一种查询语言，是一种用于处理数据的DSL。 显然，编写Plan.load（id）总是比相应的SQL容易，但这是很普通的情况。 当涉及到稍微复杂的事情时，SQL成为非常受欢迎的工具。 有时，您会诅咒另一个ORM，以使它像纯SQL一样运行，“我会在几分钟内完成”。 对于那些有疑问的人，我建议查看<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">MongoDB文档</a> ，其中的解释是以类似于SQL的形式给出的，看起来很有趣！ 因此，我为我的目的而编写的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">ORM JetSet中</a>用于查询的接口是具有最少浸渍的SQL，例如“ AS ENTITY”。 顺便说一句，在大多数情况下，我不使用模型对象，各种DTO等来显示表格数据-我只是编写一个SQL查询，获取一个哈希对象数组并将其显示在视图中。 通过某种方式，很少有人通过将相关表投影到模型上来设法“滚动”大数据。 实际上，更可能使用平面投影（视图），并且当开始使用更复杂的解决方案（例如CQRS（命令和查询责任隔离））时，非常成熟的产品进入优化阶段。 <br><br><h2> 全部放在一起 </h2><br> 所以我们有： <br><br><ul><li> 我们找到了如何加载和保存模型的方法，还设计了模型的网络交付工具（即特定的路由器）的粗略体系结构； </li><li> 我们得出的结论是，不属于主题领域的所有逻辑都可以被带入Actions（动作），而不是控制器和存储库。 </li><li> 动作必须支持依赖注入 </li><li> 实施了体面的工具依赖注入； </li><li> 实现了必要的ORM。 </li></ul><br> 剩下的唯一事情就是实现相同的“路由器”。 由于我们摆脱了存储库和控制者的青睐，而倾向于使用操作，因此很明显，对于一个请求，我们将需要执行多个操作。 行动是自主的，我们不能相互投资。 因此，作为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">Dandy框架的</a>一部分<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">，</a>我实现了一个路由器，该路由器使您可以创建动作链。 配置示例（注意/计划）： <br><br><pre> <code class="plaintext hljs">:receive .-&gt; :before -&gt; common/open_db_session GET -&gt; welcome -&gt; :respond &lt;- show_welcome /auth -&gt; :before -&gt; current_user@users/load_current_user /profile -&gt; GET -&gt; plan@plans/load_plan \ -&gt; :respond &lt;- users/show_user_profile PATCH -&gt; users/update_profile /plans -&gt; GET -&gt; current_plan@plans/load_current_plan \ -&gt; plans@plans/load_plans \ -&gt; :respond &lt;- plans/list :catch -&gt; common/handle_errors</code> </pre><br>  “获取/授权/计划”显示所有可用的订阅计划，并“突出显示”当前的订阅计划。 发生以下情况： <br><br><ol><li>  “：之前-&gt; common / open_db_session”-打开JetSet会话 </li><li>  / auth“：之前-&gt; current_user @用户/ load_current_user”-加载当前用户（通过令牌）。 结果以current_user（current_user @指令）的形式记录在IoC容器中。 </li><li>  / auth / plans“ current_plan @ plans / load_current_plan”-加载当前计划。 为此，从容器中获取值@current_user。 结果记录为IoC容器中的current_plan（current_plan @指令）： <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadCurrentPlan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class"> = &lt;&lt;~</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELECT</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AS</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENTITY</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FROM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plans</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INNER</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JOIN</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriptions</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ON</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AND</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current</span></span></span><span class="hljs-class"> = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WHERE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LIMIT</span></span></span><span class="hljs-class"> 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">execute</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class">: @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">map</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">') </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></li><li>  “计划@计划/ load_plans”-加载所有可用计划的列表。 结果作为计划（“ @计划”指令）注册在IoC容器中。 </li><li>  “：响应&lt;-计划/列表”-已注册的ViewBuilder，例如JBuilder，绘制类型为“ <br><br><pre> <code class="ruby hljs">json.plans @plans <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|plan|</span></span> json.id plan.id json.name plan.name json.price plan.price json.active plan.id == @current_plan.id <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></li></ol><br> 与@plans和@current_plan一样，从容器中检索在先前步骤中注册的值。 通常，在Action构造函数中，您可以“排序”所需的所有内容，或者更确切地说，可以对容器中注册的所有内容进行“排序”。 细心的读者很可能会提出问题，但是在“多用户”模式下是否可以隔离此类变量？ 是的，确实如此。 事实是Hypo IoC容器可以设置对象的生存期，并且可以将其绑定到其他对象的生存期。 在Dandy中，@ plans，@ current_plan，@ current_user之类的变量绑定到请求对象，并在请求完成时被销毁。 顺便说一下，JetSet会话也与请求相关联-当Dandy请求完成时，还将重置其状态。 即 每个请求都有其自己的隔离上下文。  Hypo统治着Dandy的整个生命周期，无论这种双关语在名字的字面意义上带来多么有趣。 <br><br><h2> 结论 </h2><br> 在给定体系结构的框架内，我使用对象模型来描述主题区域。 我使用诸如依赖注入之类的适当方法； 我什至可以使用继承。 但是，与此同时，所有这些动作本质上都是普通的功能，可以在声明级别上链接在一起。 当您在抽象和测试代码方面没有遇到问题时，我们以功能样式获得了所需的后端，但是具有对象方法的所有优点。 以DSL路由器Dandy为例，我们可以自由创建描述路由等所需的语言。 <br><br><h2> 结论 </h2><br> 作为本文的一部分，我对创建后端的基本方面进行了一次游览。 我再说一遍，本文是肤浅的，没有涉及许多重要的主题，例如性能优化。 我只尝试着眼于那些对社区真正有用的事情，而不是从空到空，SOLID，TDD，MVC方案的外观等等。 好奇的读者对这些术语和其他术语的严格定义可以在庞大的网络中轻松找到，更不用说商店的同事了，这些缩写是他们日常讲话的一部分。 最后，我强调，请不要将精力集中在解决问题所需要的工具上。<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这仅是思想有效性的证明，而不是思想本质的证明。</font><font style="vertical-align: inherit;">如果您对本文感兴趣，我将编写有关这些库的单独材料。</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN474504/">https://habr.com/ru/post/zh-CN474504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN474494/index.html">2019年Zabbix峰会怎么样</a></li>
<li><a href="../zh-CN474496/index.html">HighLoad ++ 2019上的数据库</a></li>
<li><a href="../zh-CN474498/index.html">JavaFX教程：Hello World</a></li>
<li><a href="../zh-CN474500/index.html">Grafana的插件开发：全锥的故事</a></li>
<li><a href="../zh-CN474502/index.html">Odnoklassniki在Joker 2019上的解析</a></li>
<li><a href="../zh-CN474508/index.html">植皮3D生物打印的成就</a></li>
<li><a href="../zh-CN474514/index.html">中国比特币采矿大亨如何生存</a></li>
<li><a href="../zh-CN474516/index.html">语音应用：俄罗斯没有注意到的十亿个市场</a></li>
<li><a href="../zh-CN474518/index.html">FP与OOP</a></li>
<li><a href="../zh-CN474522/index.html">杂种故事</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>