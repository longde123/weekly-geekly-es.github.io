<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ โป๏ธ ๐ Parsim 25TB ูุน AWK ู R ๐ฉ๐ผโ๐ ๐๐พ ๐๐ผ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ููู ุฃูุฑุฃ ูุฐุง ุงูููุงู : ุฃุนุชุฐุฑ ุนู ุญูููุฉ ุฃู ุงููุต ุงูุชูู ููุชุฑุฉ ุทูููุฉ ูููุถูู. ูุชูููุฑ ุงูููุช ุ ุฃุจุฏุฃ ูู ูุตู ุจููุฏูุฉ "ูุง ุชุนููุชู" ุ ูุงูุฐู ุฃุดุฑุญ ููู ุฌููุฑ ุงููุตู ูู ุฌู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Parsim 25TB ูุน AWK ู R</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/456392/" style=";text-align:right;direction:rtl"><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/9d/3y/lc/9d3ylcjuqiv6r7vrv6p52apvmne.jpeg"></div><br>  <i><b>ููู ุฃูุฑุฃ ูุฐุง ุงูููุงู</b> : ุฃุนุชุฐุฑ ุนู ุญูููุฉ ุฃู ุงููุต ุงูุชูู ููุชุฑุฉ ุทูููุฉ ูููุถูู.</i>  <i>ูุชูููุฑ ุงูููุช ุ ุฃุจุฏุฃ ูู ูุตู ุจููุฏูุฉ "ูุง ุชุนููุชู" ุ ูุงูุฐู ุฃุดุฑุญ ููู ุฌููุฑ ุงููุตู ูู ุฌููุฉ ุฃู ุฌููุชูู.</i> <i><br><br></i>  <i><b>"ููุท ุฃุธูุฑ ุงูุญู!"</b></i>  <i>ุฅุฐุง ููุช ุชุฑุบุจ ููุท ูู ุฑุคูุฉ ูุง ุฌุฆุช ุฅููู ุ ูุงูุชูู ุฅูู ุงููุตู "ูู ุฃูุซุฑ ุฅุจุฏุงุนูุง" ุ ููููู ุฃุนุชูุฏ ุฃูู ูู ุงูููุชุน ูุงููููุฏ ูุฑุงุกุฉ ุงููุฒูุฏ ุนู ุญุงูุงุช ุงููุดู.</i> <br><br>  ูู ุงูุขููุฉ ุงูุฃุฎูุฑุฉ ุ ุชูููุช ุชุนูููุงุช ุจุฅุนุฏุงุฏ ุนูููุฉ ููุนุงูุฌุฉ ุญุฌู ูุจูุฑ ูู ุชุณูุณู ุงูุญูุถ ุงููููู ุงูุฃุตูู (ูู ุงููุงุญูุฉ ุงููููุฉ ุ ูุฐู ุนุจุงุฑุฉ ุนู ุดุฑูุญุฉ SNP).  ูุงู ูู ุงูุถุฑูุฑู ุงูุญุตูู ุจุณุฑุนุฉ ุนูู ุงูุจูุงูุงุช ุญูู ูููุน ูุฑุงุซู ูุนูู (ูุณูู SNP) ููููุฐุฌุฉ ุงููุงุญูุฉ ูุบูุฑูุง ูู ุงูููุงู.  ุจูุณุงุนุฏุฉ R ู AWK ุ ุชูููุช ูู ุชูุธูู ุงูุจูุงูุงุช ูุชูุธูููุง ุจุทุฑููุฉ ุทุจูุนูุฉ ุ ููุง ุฃุฏู ุฅูู ุฒูุงุฏุฉ ูุจูุฑุฉ ูู ูุนุงูุฌุฉ ุงูุทูุจุงุช.  ูุฐุง ูู ููู ุณููุง ุจุงููุณุจุฉ ูู ูุชุทูุจ ุงูุนุฏูุฏ ูู ุงูุชูุฑุงุฑ.  ูุฐู ุงูููุงูุฉ ุณูู ุชุณุงุนุฏู ุนูู ุชุฌูุจ ุจุนุถ ุฃุฎุทุงุฆู ูุฅุธูุงุฑ ูุง ูุนูุช ูู ุงูููุงูุฉ. <br><a name="habracut"></a><br>  ุฃููุงู ุ ุจุนุถ ุงูุชูุณูุฑุงุช ุงูุชูููุฏูุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  ูุนุทูุงุช </h2><br>  ุฒูุฏูุง ูุฑูุฒ ูุนุงูุฌุฉ ุงููุนูููุงุช ุงููุฑุงุซูุฉ ุจุงูุฌุงูุนุฉ ูุฏููุง ุจุจูุงูุงุช ุชุจูุบ 25 ุชูุฑุงุจุงูุช ูู TSV.  ุญุตูุช ุนูููุง ููุณูุฉ ุฅูู 5 ุญุฒู ูุถุบูุทุฉ ุจูุงุณุทุฉ Gzip ุ ูู ูููุง ูุญุชูู ุนูู ุญูุงูู 240 ููู ุจุฃุฑุจุนุฉ ุบูุบุงุจุงูุช.  ูู ุตู ูุญุชูู ุนูู ุจูุงูุงุช ุนู SNP ูุงุญุฏ ูุดุฎุต ูุงุญุฏ.  ูู ุงููุฌููุน ุ ุชู ููู ุงูุจูุงูุงุช ุญูู ~ 2.5 ููููู SNPs ู ~ 60 ุฃูู ุดุฎุต.  ุจุงูุฅุถุงูุฉ ุฅูู ูุนูููุงุช SNP ุ ูุงู ููุงู ุงูุนุฏูุฏ ูู ุงูุฃุนูุฏุฉ ูู ุงููููุงุช ูุน ุฃุฑูุงู ุชุนูุณ ุงูุฎุตุงุฆุต ุงููุฎุชููุฉ ุ ูุซู ุดุฏุฉ ุงููุฑุงุกุฉ ุ ูุชูุงุชุฑ ุงูุฃูููุงุช ุงููุฎุชููุฉ ุ ุฅูุฎ.  ูุงู ููุงู ุญูุงูู 30 ุนููุฏูุง ุจููู ูุฑูุฏุฉ. <br><br><h4 style=";text-align:right;direction:rtl">  ูุฏู </h4><br>  ููุง ูู ุงูุญุงู ูุน ุฃู ูุดุฑูุน ูุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ุ ูุงู ุงูุดูุก ุงูุฃูุซุฑ ุฃูููุฉ ูู ุชุญุฏูุฏ ููููุฉ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช.  ูู ูุฐู ุงูุญุงูุฉ ุ <b>ุจุงููุณุจุฉ ููุฌุฒุก ุงูุฃูุจุฑ ุ ุณูุฎุชุงุฑ ุงูููุงุฐุฌ ูุณูุฑ ุงูุนูู ู SNP ุนูู ุฃุณุงุณ SNP</b> .  ููุฐุง ูู ุ ูู ุงูููุช ููุณู ุณูุญุชุงุฌ ุฅูู ุจูุงูุงุช SNP ูุงุญุฏ ููุท.  ูุงู ุนููู ุฃู ุฃุชุนูู ููู ุงุณุชุฎุฑุฌ ูู ุงูุณุฌูุงุช ุงููุชุนููุฉ ุจุฃุญุฏ 2.5 ููููู ูู SNPs ุจูู ุจุณุงุทุฉ ูุฏุฑ ุงูุฅููุงู ูุฃุณุฑุน ูุฃุฑุฎุต. <br><br><h1 style=";text-align:right;direction:rtl">  ููู ูุง ุชูุนู ุฐูู </h1><br>  ุณูู ุฃูุชุจุณ ูููุดูู ููุงุณุจุฉ: <br><br><blockquote style=";text-align:right;direction:rtl">  ูู ุฃูุดู ุฃูู ูุฑุฉ ุ ููุฏ ุงูุชุดูุช ุฃูู ุทุฑููุฉ ูุนุฏู ุชุญููู ูุฌููุนุฉ ูู ุงูุจูุงูุงุช ุจุชูุณูู ููุงุณุจ ููุงุณุชุนูุงูุงุช. </blockquote><br><h2 style=";text-align:right;direction:rtl">  ุงููุญุงููุฉ ุงูุฃููู </h2><br>  <b>ูุง ุชุนููุชู</b> : ูุง ุชูุฌุฏ ูุณููุฉ ุฑุฎูุตุฉ ูุชุญููู 25 ุชูุฑุงุจุงูุช ูู ููุช ูุงุญุฏ. <br><br>  ุจุนุฏ ุงูุงุณุชูุงุน ุฅูู ููุถูุน "ุฃุณุงููุจ ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุงูุถุฎูุฉ ุงููุชูุฏูุฉ" ูู ุฌุงูุนุฉ ูุงูุฏุฑุจููุช ุ ููุช ูุชุฃูุฏูุง ูู ุฃููุง ูุงูุช ูุจุนุฉ.  ุฑุจูุง ูุชุทูุจ ุงูุฃูุฑ ุณุงุนุฉ ุฃู ุณุงุนุชูู ูุชูููู ุฎุงุฏู Hive ูุชุดุบูู ุฌููุน ุงูุจูุงูุงุช ูุงูุฅุจูุงุบ ุนู ุงููุชูุฌุฉ.  ูุธุฑูุง ูุฃูู ูุชู ุชุฎุฒูู ุจูุงูุงุชูุง ูู AWS S3 ุ ููุฏ ุงุณุชุฎุฏูุช ุฎุฏูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Athena</a> ุ ุงูุชู ุชุชูุญ ูู ุชุทุจูู ุงุณุชุนูุงูุงุช Hive SQL ุนูู ุจูุงูุงุช S3.  ูุง ุญุงุฌุฉ ูุชูููู / ุฑูุน Hive-cluster ุ ูุญุชู ุฏูุน ููุท ููุจูุงูุงุช ุงูุชู ุชุจุญุซ ุนููุง. <br><br>  ุจุนุฏ ุฃู ุนุฑุถุช ุฃุซููุง ุนูู ุจูุงูุงุชู ูุชูุณููู ุ ุฃุฌุฑูุช ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุน ุงุณุชูุณุงุฑุงุช ููุงุซูุฉ: <br><br><pre style=";text-align:right;direction:rtl"><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> intensityData <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br>  ูุญุตูุช ุจุณุฑุนุฉ ุนูู ูุชุงุฆุฌ ุฌูุฏุฉ ุงูุชูุธูู.  ุงูููุงู ุจู. <br><br>  ุญุชู ุญุงูููุง ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ูู ุงูุนูู ... <br><br>  ููุฏ ุทููุจ ููู ุณุญุจ ุฌููุน ูุนูููุงุช SNP ูู ุฃุฌู ุงุฎุชุจุงุฑ ุงููููุฐุฌ ุงูููุฌูุฏ ุนูููุง.  ููุช ุจุชุดุบูู ุงุณุชุนูุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> intensityData <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> snp = <span class="hljs-string"><span class="hljs-string">'rs123456'</span></span>;</code> </pre> <br>  ... ูุงูุชุธุฑ.  ุจุนุฏ ุซูุงูู ุฏูุงุฆู ูุฃูุซุฑ ูู 4 ุชูุฑุงุจุงูุช ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ ุ ุญุตูุช ุนูู ุงููุชูุฌุฉ.  ุชูุฑุถ Athena ุฑุณูููุง ุนูู ูููุฉ ุงูุจูุงูุงุช ุงูุชู ูุชู ุงูุนุซูุฑ ุนูููุง ุ ุจูุจูุบ 5 ุฏููุงุฑุงุช ููู ุชูุฑุงุจุงูุช.  ุฅุฐู ููู ูุฐุง ุงูุทูุจ ุงููุงุญุฏ 20 ุฏููุงุฑูุง ูุซูุงูู ุฏูุงุฆู ูู ุงูุงูุชุธุงุฑ.  ูุชุดุบูู ุงููููุฐุฌ ููููุง ูุฌููุน ุงูุจูุงูุงุช ุ ูุงู ูู ุงูุถุฑูุฑู ุงูุงูุชุธุงุฑ ููุฏุฉ 38 ุนุงููุง ูุฏูุน 50 ููููู ุฏููุงุฑ ุ ููู ุงููุงุถุญ ุฃู ูุฐุง ูู ููุงุณุจูุง. <br><br><h2 style=";text-align:right;direction:rtl">  ูุงู ูู ุงูุถุฑูุฑู ุงุณุชุฎุฏุงู ุงูุจุงุฑููู ... </h2><br>  <b>ูุง ุชุนููุชู</b> : ูู ุญุฐุฑูุง ูู ุญุฌู ูููุงุช ุงูุจุงุฑููู ูุชูุธูููุง. <br><br>  ูู ุงูุจุฏุงูุฉ ุญุงููุช ุชุตุญูุญ ุงููููู ุนู ุทุฑูู ุชุญููู ุฌููุน ูููุงุช TSV ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูููุงุช ุงูุจุงุฑููู</a> .  ุฅููุง ููุงุฆูุฉ ููุนูู ูุน ูุฌููุนุงุช ุงูุจูุงูุงุช ุงููุจูุฑุฉ ุ ูุฃู ุงููุนูููุงุช ุงูููุฌูุฏุฉ ุจูุง ูุชู ุชุฎุฒูููุง ูู ูููุฐุฌ ุนููุฏู: ูููู ูู ุนููุฏ ูู ููุทุน ุงูุฐุงูุฑุฉ / ุงููุฑุต ุงูุฎุงุต ุจู ุ ุนูู ุนูุณ ุงููููุงุช ุงููุตูุฉ ุงูุชู ุชุญุชูู ุงูุฃุณุทุฑ ุนูู ุนูุงุตุฑ ูู ูู ุนููุฏ.  ูุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุงูุนุซูุฑ ุนูู ุดูุก ูุง ุ ููุง ุนููู ุณูู ูุฑุงุกุฉ ุงูุนููุฏ ุงูุถุฑูุฑู.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุชู ุชุฎุฒูู ูุฌููุนุฉ ูู ุงูููู ูู ูู ููู ูู ุนููุฏ ุ ูุฐูู ุฅุฐุง ูู ุชูู ุงููููุฉ ุงููุทููุจุฉ ูู ูุทุงู ุงูุนููุฏ ุ ููู ูุถูุน Spark ุงูููุช ูู ูุญุต ุงูููู ุจุฃูููู. <br><br>  ููุช ุจุชุดุบูู ูููุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">AWS Glue</a> ุจุณูุทุฉ ูุชุญููู ูููุงุช TSV ุงูุฎุงุตุฉ ุจูุง ุฅูู Parquet ูุฃุณูุทุช ูููุงุช ุฌุฏูุฏุฉ ูู Athena.  ุงุณุชุบุฑู ุงูุฃูุฑ ุญูุงูู 5 ุณุงุนุงุช.  ูููู ุนูุฏูุง ุฃุทููุช ุงูุทูุจ ุ ุงุณุชุบุฑู ุงูุฃูุฑ ุญูุงูู ุงูููุช ููุณู ูุฃูู ููููุงู ูู ุงููุงู ูุฅููุงูู.  ูุงูุญูููุฉ ูู ุฃู ุณุจุงุฑู ุ ูู ูุญุงููุฉ ูุชุญุณูู ุงููููุฉ ุ ุจุจุณุงุทุฉ ูู ูุทุนุฉ ูุงุญุฏุฉ ูู TSV ููุถุนูุง ูู ูุทุนุฉ ุงูุจุงุฑููู ุงูุฎุงุตุฉ ุจูุง.  ููุธุฑูุง ูุฃู ูู ุฌุฒุก ูุจูุฑ ุจูุง ููู ุงูููุงูุฉ ููุญุชูู ุนูู ุงูุณุฌูุงุช ุงููุงููุฉ ููุนุฏูุฏ ูู ุงูุฃุดุฎุงุต ุ ุชู ุชุฎุฒูู ุฌููุน SNPs ูู ูู ููู ุ ูุฐูู ูุงู ุนูู Spark ูุชุญ ุฌููุน ุงููููุงุช ูุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ุงููุงุฒูุฉ. <br><br>  ุงูุบุฑูุจ ุฃู ููุน ุงูุถุบุท ุงูุงูุชุฑุงุถู (ูุงูููุตู ุจู) ูู ุงูุจุงุฑููู - snappy - ููุณ ูุงุจูุงู ููุงููุณุงู.  ูุฐูู ุ ุชูุณู ูู ููููุฐ ุจูููุฉ ุชูุฑูุบ ูุชูุฒูู ูุฌููุนุฉ ุงูุจูุงูุงุช ุงููุงููุฉ 3.5 ุฌูุฌุงุจุงูุช. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f42/584/fb3/f42584fb3e65319eef46f117c11525f3.png"><br><h2 style=";text-align:right;direction:rtl">  ูุญู ูููู ุงููุดููุฉ </h2><br>  <b>ูุง ุชุนููุชู</b> : ุงููุฑุฒ ุฃูุฑ ุตุนุจ ุ ุฎุงุตุฉ ุฅุฐุง ุชู ุชูุฒูุน ุงูุจูุงูุงุช. <br><br>  ุจุฏุง ูู ุงูุขู ุฃููู ูููุช ุฌููุฑ ุงููุดููุฉ.  ูู ูุง ูุงู ุนูู ูุนูู ูู ูุฑุฒ ุงูุจูุงูุงุช ุญุณุจ ุนููุฏ SNP ุ ูููุณ ุญุณุจ ุงูุฃุดุฎุงุต.  ุจุนุฏ ุฐูู ุ ุณูุชู ุชุฎุฒูู ุนุฏุฉ SNPs ูู ููุทุน ูููุตู ููุจูุงูุงุช ุ ููู ุซู ุณุชุธูุฑ ูุธููุฉ Parquet ุงูุฐููุฉ "ููุชูุญุฉ ููุท ุฅุฐุง ูุงูุช ุงููููุฉ ูู ุงููุทุงู" ูู ูู ูุฌุฏูุง.  ูุณูุก ุงูุญุธ ุ ูุฅู ูุฑุฒ ูููุงุฑุงุช ุงูุตููู ุงููุชูุงุซุฑุฉ ุนุจุฑ ูุฌููุนุฉ ูุฏ ุฃุซุจุช ุฃูู ูููุฉ ุดุงูุฉ. <br><br><div class="oembed" style=";text-align:right;direction:rtl"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); max-width: 100%; width: 500px; min-width: 220px; margin-top: 10px; margin-bottom: 10px;" data-tweet-id="1105127759318319105"></twitter-widget><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><br>  ุจุงูุชุฃููุฏ ูุง ุชุฑุบุจ AWS ูู ุฅุนุงุฏุฉ ุงูุฃููุงู ุจุณุจุจ "ุฃูุง ุทุงูุจ ุบุงุฆุจ ุนู ุงูุชูููุฑ".  ุจุนุฏ ุฃู ุจุฏุฃุช ุงููุฑุฒ ุนูู Amazon Glue ุ ุนููุช ููุฏุฉ ููููู ูุชุญุทูุช. <br><br><h2 style=";text-align:right;direction:rtl">  ูุงุฐุง ุนู ุงูุชูุณููุ </h2><br>  <b>ูุง ุชุนููุชู</b> : ูุฌุจ ุฃู ุชููู ุงูุฃูุณุงู ูู Spark ูุชูุงุฒูุฉ. <br><br>  ุซู ุฌุงุกุช ุงูููุฑุฉ ูุชูุณูู ุงูุจูุงูุงุช ุนูู ุงููุฑูููุณููุงุช.  ููุงู 23 ูููู (ูุนุฏุฏ ูููู ุขุฎุฑ ุ ุจุงููุธุฑ ุฅูู ุงูุญูุถ ุงููููู ููููุชููููุฏุฑูุง ูุงูููุงุทู ุบูุฑ ุงููุนููุฉ). <br>  ุณูุชูุญ ูู ุฐูู ุชูุณูู ุงูุจูุงูุงุช ุฅูู ุฃุฌุฒุงุก ุฃุตุบุฑ.  ุฅุฐุง ููุช ุจุฅุถุงูุฉ ุณุทุฑ <code>partition_by = "chr"</code> ูุงุญุฏ ููุท ุฅูู ูุธููุฉ ุชุตุฏูุฑ Spark ูู ูุต ุงูุบุฑุงุก ุ ููุฌุจ ุญููุฆุฐู ุชุตููู ุงูุจูุงูุงุช ูู ูุฌููุนุงุช. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/652/f42/3dc/652f423dc8806401b6638a3cf8c1480b.png"><br>  <i>ูุชููู ุงูุฌูููู ูู ุดุธุงูุง ุนุฏูุฏุฉ ุชุณูู ุงููุฑูููุณููุงุช.</i> <br><br>  ูุณูุก ุงูุญุธ ุ ูุฐุง ูู ููุฌุญ.  ุงููุฑูููุณููุงุช ููุง ุฃุญุฌุงู ูุฎุชููุฉ ุ ูุจุงูุชุงูู ูููุฉ ูุฎุชููุฉ ูู ุงููุนูููุงุช.  ูุฐุง ูุนูู ุฃู ุงูููุงู ุงูุชู ุฃุฑุณููุง ุณุจุงุฑู ููุนูุงู ูู ุชูู ูุชูุงุฒูุฉ ูุฃุฏุงุก ุจุจุทุก ุ ูุฃู ุจุนุถ ุงูุนูุฏ ุงูุชูุช ูู ููุช ูุจูุฑ ููุงูุช ุฎุงููุฉ.  ููุน ุฐูู ุ ุชู ุงูุงูุชูุงุก ูู ุงูููุงู.  ูููู ุนูุฏ ุทูุจ SNP ูุงุญุฏ ุ ุชุณุจุจ ุงูุฎูู ูุฑุฉ ุฃุฎุฑู ูู ูุดุงูู.  ุงูุฎูุถุช ุชูููุฉ ูุนุงูุฌุฉ SNPs ุนูู ุงููุฑูููุณููุงุช ุงูุฃูุจุฑ (ุฃู ุญูุซ ูุฑูุฏ ุงูุญุตูู ุนูู ุงูุจูุงูุงุช) ุจูุญู 10 ูุฑุงุช ููุท.  ุงููุซูุฑ ุ ูููู ููุณ ุจูุง ููู ุงูููุงูุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  ูุฅุฐุง ููุช ุชููุณู ุฅูู ุฃูุณุงู ุฃุตุบุฑุ </h2><br>  <b>ูุง ุชุนููุชู</b> : ูุง ุชุญุงูู ุฃุจุฏูุง ุนูู 2.5 ููููู ูุณู ุนูู ุงูุฅุทูุงู. <br><br>  ูุฑุฑุช ุฃู ุฃูุดู ูููุณู ูู SNP.  ูุฐุง ูุถูู ููุณ ุญุฌู ุงูุฃูุณุงู.  <b>ูุงู ุณูุฆุง ููุฑุฉ</b> .  ููุฏ ุงุณุชูุฏุช ูู ุงูุบุฑุงุก ูุฃุถูุช <code>partition_by = 'snp'</code> .  ุจุฏุฃุช ุงููููุฉ ูุจุฏุฃุช ูู ุงูุฌุฑู.  ุจุนุฏ ููู ูุงุญุฏ ุ ุฑุงุฌุนุช ูุฑุฃูุช ุฃูู ูู ูุชู ูุชุงุจุฉ ุฃู ุดูุก ูู S3 ุญุชู ุงูุขู ุ ูุฐุง ููุฏ ูุชูุช ุงููููุฉ.  ูุจุฏู ุฃู ุงูุบุฑุงุก ูุงู ููุชุจ ูููุงุช ูุณูุทุฉ ุฅูู ููุงู ูุฎูู ูู S3 ุ ููุซูุฑ ูู ุงููููุงุช ุ ุฑุจูุง ุจุถุนุฉ ููุงููู.  ููุชูุฌุฉ ูุฐูู ุ ุชููู ุฎุทุฃู ุฃูุซุฑ ูู ุฃูู ุฏููุงุฑ ููู ูุฑุถู ูุฑุดุฏู. <br><br><h2 style=";text-align:right;direction:rtl">  ุงูุชูุณูู + ุงููุฑุฒ </h2><br>  <b>ูุง ุชุนููุชู</b> : ุงููุฑุฒ ูุง ูุฒุงู ุตุนุจูุง ุ ููุฐูู ุฅุนุฏุงุฏ Spark. <br><br>  ูุงูุช ุขุฎุฑ ูุญุงููุฉ ููุชูุณูู ูู ุฃููู ูุณูุช ุงููุฑูููุณููุงุช ุซู ููุช ุจุชุฑุชูุจ ูู ูุณู.  ูู ุงููุงุญูุฉ ุงููุธุฑูุฉ ุ ูุฅู ูุฐุง ูู ุดุฃูู ุชุณุฑูุน ูู ุทูุจ ุ ูุฃู ุจูุงูุงุช SNP ุงููุทููุจุฉ ูุฌุจ ุฃู ุชููู ุถูู ุงูุนุฏูุฏ ูู ูุทุน ุงูุจุงุฑููู ุถูู ูุทุงู ูุนูู.  ููุฃุณู ุ ุฃุซุจุช ูุฑุฒ ุงูุจูุงูุงุช ุญุชู ุงูููุณูุฉ ุฃูู ูููุฉ ุตุนุจุฉ.  ููุชูุฌุฉ ูุฐูู ุ ุงูุชููุช ุฅูู EMR ููุญุตูู ุนูู ูุฌููุนุฉ ูุฎุตุตุฉ ูุงุณุชุฎุฏูุช ุซูุงูู ุญุงูุงุช ูููุฉ (C5.4xl) ู Sparklyr ูุฅูุดุงุก ุณูุฑ ุนูู ุฃูุซุฑ ูุฑููุฉ ... <br><br><pre style=";text-align:right;direction:rtl"> <code class="scala hljs"># <span class="hljs-type"><span class="hljs-type">Sparklyr</span></span> snippet to partition by chr and sort w/in partition # <span class="hljs-type"><span class="hljs-type">Join</span></span> the raw data <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the snp bins raw_data group_by(chr) %&gt;% arrange(<span class="hljs-type"><span class="hljs-type">Position</span></span>) %&gt;% <span class="hljs-type"><span class="hljs-type">Spark_write_Parquet</span></span>( path = <span class="hljs-type"><span class="hljs-type">DUMP_LOC</span></span>, mode = <span class="hljs-symbol"><span class="hljs-symbol">'overwrit</span></span>e', partition_by = c(<span class="hljs-symbol"><span class="hljs-symbol">'ch</span></span>r') )</code> </pre> <br>  ... ููุน ุฐูู ุ ูุฅู ุงููููุฉ ูู ุชูุชูู ุจุนุฏ.  ููุช ุจุถุจุทูุง ุจูู ุทุฑููุฉ: ููุช ุจุฒูุงุฏุฉ ุชุฎุตูุต ุงูุฐุงูุฑุฉ ููู ูู ูููุฐ ุงูุงุณุชุนูุงู ุ ูุงุณุชุฎุฏูุช ุงูุนูุฏ ุจูููุฉ ูุจูุฑุฉ ูู ุงูุฐุงูุฑุฉ ุ ูุงุณุชุฎุฏูุช ูุชุบูุฑุงุช ุงูุจุซ ุ ูููู ูู ูู ูุฑุฉ ุงุชุถุญ ุฃููุง ูุตู ุงูุชุฏุงุจูุฑ ุ ูุจุฏุฃ ููุงูู ุงูุฃุฏุงุก ุจุงูุชุฏุฑูุฌ ุ ุญุชู ุชููู ูู ุดูุก. <br><br><div class="oembed" style=";text-align:right;direction:rtl"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-1" style="position: static; visibility: visible; display: block; transform: rotate(0deg); max-width: 100%; width: 500px; min-width: 220px; margin-top: 10px; margin-bottom: 10px;" data-tweet-id="1128703858610450434"></twitter-widget><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><br><h1 style=";text-align:right;direction:rtl">  ุฃูุง ุฃุชููู ุงููุฒูุฏ ูู ุงูุฅุจุฏุงุน </h1><br>  <b>ูุง ุชุนููุชู</b> : ูู ุจุนุถ ุงูุฃุญูุงู ุชุชุทูุจ ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุญููููุง ุฎุงุตุฉ. <br><br>  ูู SNP ููุง ูููุฉ ูุฑูุฒูุฉ.  ูุฐุง ูู ุงูุฑูู ุงูููุงุจู ูุนุฏุฏ ุงูููุงุนุฏ ุงูููุฌูุฏุฉ ุนูู ูุฑูููุณูููุง.  ูุฐู ุทุฑููุฉ ุฌูุฏุฉ ูุทุจูุนูุฉ ูุชูุธูู ุจูุงูุงุชูุง.  ูู ุงูุจุฏุงูุฉ ููุช ุฃุฑุบุจ ูู ุงูุชูุณูู ุญุณุจ ููุทูุฉ ูู ูุฑูููุณูู.  ุนูู ุณุจูู ุงููุซุงู ุ ุงูููุงูู 1 - 2000 ุ 2001 - 4000 ุ ุฅูุฎ.  ูููู ุงููุดููุฉ ูู ุฃู ุชุนุฏุฏ ุงูุฃุดูุงู ูุง ูุชู ุชูุฒูุนู ุจุดูู ูุชุณุงูู ุนุจุฑ ุงููุฑูููุณููุงุช ุ ููุฐุง ูู ุงูุณุจุจ ูู ุฃู ุญุฌู ุงููุฌููุนุงุช ุณูู ูุชุบูุฑ ุจุดูู ูุจูุฑ. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f46/a8e/17b/f46a8e17b9af8d2ae9777c47017764c6.png"><br><br>  ูุชูุฌุฉ ูุฐูู ุ ุฃุตุจุญุช ููุณูุฉ ุฅูู ูุธุงุฆู (ุฑุชุจุฉ).  ููููุง ููุจูุงูุงุช ุงูุชู ุชู ุชูุฒูููุง ุจุงููุนู ุ ููุช ุจุชุดุบูู ุทูุจ ููุญุตูู ุนูู ูุงุฆูุฉ SNP ูุฑูุฏุฉ ูููุงูุนูุง ููุฑูููุณููุงุชูุง.  ุซู ูุงู ุจูุฑุฒ ุงูุจูุงูุงุช ุฏุงุฎู ูู ูุฑูููุณูู ูุฌูุน SNP ูู ูุฌููุนุงุช (ุจู) ุจุญุฌู ูุนูู.  ูู 1000 SNP ููู ููููุง.  ูุฐุง ุฃุนุทุงูู ุนูุงูุฉ SNP ูุน ูุฌููุนุฉ ูู ูุฑูููุณูู. <br><br>  ูู ุงูููุงูุฉ ุ ููุช ุจุฅูุดุงุก ูุฌููุนุงุช (ุจู) ุนูู 75 SNP ุ ูุณุฃุดุฑุญ ุงูุณุจุจ ุฃุฏูุงู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">snp_to_bin &lt;- unique_snps %&gt;% group_by(chr) %&gt;% arrange(position) %&gt;% mutate( rank = 1:n() bin = floor(rank/snps_per_bin) ) %&gt;% ungroup()</code> </pre> <br><h2 style=";text-align:right;direction:rtl">  ุงููุญุงููุฉ ุงูุฃููู ูุน ุณุจุงุฑู </h2><br>  <b>ูุง ุชุนููุชู</b> : ุชูุงูู Spark ุณุฑูุน ุ ููู ุงูุชูุณูู ูุง ูุฒุงู ูููููุง. <br><br>  ููุช ุฃุฑุบุจ ูู ูุฑุงุกุฉ ุฅุทุงุฑ ุงูุจูุงูุงุช ุงูุตุบูุฑ (2.5 ููููู ุฎุท) ูู Spark ุ ูุงูุฌูุน ุจููู ูุจูู ุงูุจูุงูุงุช ุงูุฎุงู ุ ุซู ุงูุชูุณูู ุญุณุจ ุนููุฏ ุงูุตูุฏูู ุงูููุถุงู ุญุฏูุซูุง. <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># Join the raw data with the snp bins data_w_bin &lt;- raw_data %&gt;% left_join(sdf_broadcast(snp_to_bin), by ='snp_name') %&gt;% group_by(chr_bin) %&gt;% arrange(Position) %&gt;% Spark_write_Parquet( path = DUMP_LOC, mode = 'overwrite', partition_by = c('chr_bin') )</span></span></code> </pre> <br>  ููุฏ ุงุณุชุฎุฏูุช <code>sdf_broadcast()</code> ุ ูุฐูู ุงูุชุดู Spark ุฃูู ูุฌุจ ุฅุฑุณุงู ุฅุทุงุฑ ุจูุงูุงุช ุฅูู ุฌููุน ุงูุนูุฏ.  ูุฐุง ูููุฏ ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ุตุบูุฑุฉ ููุทููุจุฉ ูุฌููุน ุงูููุงู.  ุฎูุงู ุฐูู ุ ูุญุงูู Spark ุฃู ูููู ุฐูููุง ููููู ุจุชูุฒูุน ุงูุจูุงูุงุช ุญุณุจ ุงูุญุงุฌุฉ ุ ููุง ูุฏ ูุณุจุจ ุงููุฑุงูู. <br><br>  ููุฑุฉ ุฃุฎุฑู ุ ูู ุชูุฌุญ ููุฑุชู: ุงูููุงู ุงูุชู ุนููุช ููุชุฑุฉ ูู ุงูููุช ุ ุฃูููุช ุงูุฏูุฌ ุ ูุจุนุฏ ุฐูู ุ ูุซู ุงูุชูููุฐููู ุงูุฐูู ุจุฏุฃูุง ุจุงูุชูุณูู ุ ุจุฏุฃูุง ูู ุงููุดู. <br><br><h2 style=";text-align:right;direction:rtl">  ุฃุถู AWK </h2><br>  <b>ูุง ุชุนููุชู</b> : ูุง ุชูุงู ุนูุฏูุง ุชุนููู ุงูุฃุณุงุณูุงุช.  ุจุงูุชุฃููุฏ ุดุฎุต ูุง ุญู ูุดููุชู ุจุงููุนู ูู ุงูุซูุงูููุงุช. <br><br>  ุญุชู ูุฐู ุงูููุทุฉ ุ ูุงู ุณุจุจ ูู ุฅุฎูุงูุงุชู ูุน Spark ูู ุชุดููุด ุงูุจูุงูุงุช ูู ุงููุฌููุนุฉ.  ุฑุจูุง ูููู ุชุญุณูู ุงููุถุน ุนู ุทุฑูู ุงููุนุงูุฌุฉ ุงููุณุจูุฉ.  ูุฑุฑุช ูุญุงููุฉ ุชูุณูู ุจูุงูุงุช ุงููุต ุงูุฎุงู ุฅูู ุฃุนูุฏุฉ ูุฑูููุณูู ุ ูุฐูู ููุช ุขูู ูู ุชุฒููุฏ Spark ุจุจูุงูุงุช "ูููุณูุฉ ูุณุจููุง". <br><br>  ููุฏ ุจุญุซุช ูู StackOverflow ุนู ููููุฉ ุชุญููู ููู ุงูุฃุนูุฏุฉ ููุฌุฏุช <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฅุฌุงุจุฉ ุฑุงุฆุนุฉ.</a>  ุจุงุณุชุฎุฏุงู AWK ุ ููููู ุชูุณูู ููู ูุตู ุฅูู ููู ุฃุนูุฏุฉ ุจุงููุชุงุจุฉ ุฅูู ุงูุจุฑูุงูุฌ ุงููุตู ุ ุจุฏูุงู ูู ุฅุฑุณุงู ุงููุชุงุฆุฌ ุฅูู <code>stdout</code> . <br><br>  ููุงุฎุชุจุงุฑ ุ ูุชุจุช ุณููุงุฑูู Bash.  ููุฏ ููุช ุจุชูุฒูู ุฃุญุฏ TSVs ุงููุญุฒูู ุ ุซู ูููุช ุงูุญุฒูุฉ ุจูุงุณุทุฉ <code>gzip</code> ูุฃุฑุณูุชูุง ุฅูู <code>awk</code> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">gzip -dc path/to/chunk/file.gz | awk -F <span class="hljs-string"><span class="hljs-string">'\t'</span></span> \ <span class="hljs-string"><span class="hljs-string">'{print $1",..."$30"&gt;"chunked/"$chr"_chr"$15".csv"}'</span></span></code> </pre> <br>  ููุฏ ูุฌุญุช! <br><br><h2 style=";text-align:right;direction:rtl">  ููุก ุงูุฃุณุงุณูุฉ </h2><br>  <b>ูุง ุชุนููุชู</b> : <code>gnu parallel</code> ูู ุดูุก ุณุญุฑู ุ ูุฌุจ ุนูู ุงูุฌููุน ุงุณุชุฎุฏุงูู. <br><br>  ูุงู ุงููุตู ุจุทูุฆูุง ุฅูู ุญุฏ ูุง ุ ูุนูุฏูุง ุจุฏุฃุช ูู <code>htop</code> ูุงุฎุชุจุงุฑ ุงุณุชุฎุฏุงู ูุซูู EC2 ููู (ูุจุงูุธ ุงูุซูู) ุ ุงุชุถุญ ุฃููู ููุช ุฃุณุชุฎุฏู ููุท ููุงุฉ ูุงุญุฏุฉ ูุญูุงูู 200 ููุฌุงุจุงูุช ูู ุงูุฐุงูุฑุฉ.  ูู ุฃุฌู ุญู ุงููุดููุฉ ูุนุฏู ุฎุณุงุฑุฉ ุงููุซูุฑ ูู ุงููุงู ุ ูุงู ูู ุงูุถุฑูุฑู ูุนุฑูุฉ ููููุฉ ููุงุฒุงุฉ ุงูุนูู.  ูุญุณู ุงูุญุธ ุ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุนูู ุงูุจูุงูุงุช</a> ุงููุฐูู ูุฌูุฑูู ูุงูุณูุฒ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูู</a> ูุชุงุจ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Command Line</a> ุ ูุฌุฏุช ูุตูุงู ุนู ุงูุชูุงุฒู.  ูู ุฐูู ุ ุชุนููุช ุนู <code>gnu parallel</code> ุ ููู ุทุฑููุฉ ูุฑูุฉ ุฌุฏูุง ูุชูููุฐ multithreading ุนูู Unix. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/835/7c0/e45/8357c0e45f4162d53ca1c3da0c78444a.png" width="300"></div><br>  ุนูุฏูุง ุจุฏุฃุช ุงููุณู ุจุงุณุชุฎุฏุงู ุนูููุฉ ุฌุฏูุฏุฉ ุ ูุงู ูู ุดูุก ุนูู ูุง ูุฑุงู ุ ูููู ูุงู ููุงู ุนูู ุงูุฒุฌุงุฌุฉ - ูู ููู ุชูุฒูู ูุงุฆูุงุช S3 ุฅูู ุงููุฑุต ุณุฑูุนูุง ุฌุฏูุง ููู ููู ูุชูุงุฒูุงู ุชูุงููุง.  ูุฅุตูุงุญ ูุฐุง ุ ููุช ุจูุฐุง: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุชุดูุช ุฃูู ูู ุงููููู ุชูููุฐ ุฎุทูุฉ ุงูุชูุฒูู S3 ูุจุงุดุฑุฉ ูู ุฎุท ุงูุฃูุงุจูุจ ุ ููุง ูุคุฏู ุฅูู ุงูุชุฎูุต ุงูุชุงู ูู ุงูุชุฎุฒูู ุงููุณูุท ุนูู ุงููุฑุต.  ูุฐุง ูุนูู ุฃูู ูููููู ุชุฌูุจ ูุชุงุจุฉ ุงูุจูุงูุงุช ุงูุฎุงู ุนูู ุงููุฑุต ูุงุณุชุฎุฏุงู ุชุฎุฒูู ุฃุตุบุฑ ุ ูุจุงูุชุงูู ุฃุฑุฎุต ุนูู AWS. <br></li><li style=";text-align:right;direction:rtl">  <code>aws configure set default.s3.max_concurrent_requests 50</code> ุฃูุงูุฑ <code>aws configure set default.s3.max_concurrent_requests 50</code> ุฒุงุฏุช ุจุดูู ูุจูุฑ ุนุฏุฏ ูุคุดุฑุงุช ุงูุชุฑุงุจุท ุงูุชู ูุณุชุฎุฏููุง AWS CLI (ููุงู 10 ุจุดูู ุงูุชุฑุงุถู). <br></li><li style=";text-align:right;direction:rtl">  ููุฏ ุชุญููุช ุฅูู ูุซูู EC2 ุงูุฃูุซู ูุณุฑุนุฉ ุงูุดุจูุฉ ุ ูุน ุญุฑู ู ูู ุงูุงุณู.  ููุฏ ูุฌุฏุช ุฃู ููุฏ ุทุงูุฉ ุงูุญูุณุจุฉ ุนูุฏ ุงุณุชุฎุฏุงู ูุซููุงุช n ุฃูุซุฑ ูู ุชุนููุถ ุจุฒูุงุฏุฉ ูู ุณุฑุนุฉ ุงูุชูุฒูู.  ุจุงููุณุจุฉ ููุนุธู ุงูููุงู ุ ููุช c5n.4xl. <br></li><li style=";text-align:right;direction:rtl">  ููุฏ ุบูุฑุช <code>gzip</code> ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>pigz</code></a> ุ ููุฐู ุฃุฏุงุฉ gzip ูููููุง ุงูููุงู ุจุฃุดูุงุก ุฑุงุฆุนุฉ ูููุงุฒูุฉ ุงููููุฉ ุงูุชู ูู ูุณุจู ููุง ูุซูู ุงููุชูุซูุฉ ูู ุชูุฑูุบ ุงููููุงุช (ุณุงุนุฏ ูุฐุง ุนูู ุงูุฃูู). <br></li></ol><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Let S3 use as many threads as it wants aws configure set default.s3.max_concurrent_requests 50 for chunk_file in $(aws s3 ls $DATA_LOC | awk '{print $4}' | grep 'chr'$DESIRED_CHR'.csv') ; do aws s3 cp s3://$batch_loc$chunk_file - | pigz -dc | parallel --block 100M --pipe \ "awk -F '\t' '{print \$1\",...\"$30\"&gt;\"chunked/{#}_chr\"\$15\".csv\"}'" # Combine all the parallel process chunks to single files ls chunked/ | cut -d '_' -f 2 | sort -u | parallel 'cat chunked/*_{} | sort -k5 -n -S 80% -t, | aws s3 cp - '$s3_dest'/batch_'$batch_num'_{}' # Clean up intermediate data rm chunked/* done</span></span></code> </pre> <br>  ูุชู ุฏูุฌ ูุฐู ุงูุฎุทูุงุช ูุน ุจุนุถูุง ุงูุจุนุถ ุจุญูุซ ูุนูู ูู ุดูุก ุจุณุฑุนุฉ ูุจูุฑุฉ.  ุจูุถู ุณุฑุนุฉ ุงูุชูุฒูู ุงููุชุฒุงูุฏุฉ ูุฑูุถ ุงููุชุงุจุฉ ุนูู ุงููุฑุต ุ ูููููู ุงูุขู ูุนุงูุฌุฉ ุญุฒูุฉ ุณุนุฉ 5 ุชูุฑุงุจุงูุช ูู ุบุถูู ุณุงุนุงุช ููููุฉ. <br><br><div class="oembed" style=";text-align:right;direction:rtl"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-2" style="position: static; visibility: visible; display: block; transform: rotate(0deg); max-width: 100%; width: 500px; min-width: 220px; margin-top: 10px; margin-bottom: 10px;" data-tweet-id="1129416944233226240"></twitter-widget><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><br>  ูุงู ูู ุงูููุชุฑุถ ุฃู ุชุฐูุฑ ูุฐู ุงูุชุบุฑูุฏุฉ "TSV".  ููุฃุณู. <br><br><h2 style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช </h2><br>  <b>ูุง ุชุนููุชู</b> : ูุญุจ Spark ุงูุจูุงูุงุช ุบูุฑ ุงููุถุบูุทุฉ ููุง ูุญุจ ุงูุฌูุน ุจูู ุงูุฃูุณุงู. <br><br>  ุงูุขู ูุงูุช ุงูุจูุงูุงุช ูู S3 ุจุชูุณูู (ุชู ูุฑุงุกุชูุง ููุดุงุฑูุชูุง) ูุดุจู ูุฑุชุจุฉ ุ ููููููู ุงูุนูุฏุฉ ุฅูู Spark ูุฑุฉ ุฃุฎุฑู.  ููุฏ ุงูุชุธุฑุชูู ููุงุฌุฃุฉ: ูุดูุช ูุฑุฉ ุฃุฎุฑู ูู ุชุญููู ุงููุทููุจ!  ูุงู ูู ุงูุตุนุจ ููุบุงูุฉ ูุนุฑูุฉ ุณุจุงุฑู ุจุงูุถุจุท ููู ุชู ุชูุณูู ุงูุจูุงูุงุช.  ูุญุชู ุนูุฏูุง ูุนูุช ูุฐุง ุ ุงุชุถุญ ุฃู ููุงู ุงููุซูุฑ ูู ุงูุฃูุณุงู (95 ุฃูู) ุ ูุนูุฏูุง ููุช ุจุชูููู ุนุฏุฏูู ุฅูู ุญุฏูุฏ ูุชูุงุณูุฉ ูุน ุงูุชูุงุณู ุ ููุฏ ุฃุฏู ุฐูู ุฅูู ุชุฏููุฑ ุงูุชูุณูู.  ุฃูุง ูุชุฃูุฏ ูู ุฃูู ูููู ุฅุตูุงุญ ุฐูู ุ ููู ูู ุบุถูู ููููู ูู ุงูุจุญุซ ุ ูู ุฃุชููู ูู ุฅูุฌุงุฏ ุญู.  ูู ุงูููุงูุฉ ุ ุฃูููุช ุฌููุน ุงูููุงู ูู Spark ุ ุนูู ุงูุฑุบู ูู ุฃู ุงูุฃูุฑ ุงุณุชุบุฑู ุจุนุถ ุงูููุช ุ ููู ุชูู ูููุงุช ุงูุจุงุฑููู ุงููููุณูุฉ ุตุบูุฑุฉ ุฌุฏูุง (~ 200 ููููุจุงูุช).  ููุน ุฐูู ุ ูุงูุช ุงูุจูุงูุงุช ุญูุซ ูุงูุช ููุงู ุญุงุฌุฉ ุฅูููุง. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae5/43b/236/ae543b236b8d37d4a6794aa63d9ada94.png"><br>  <i>ุตุบูุฑุฉ ููุฎุชููุฉ ุ ุฑุงุฆุนุฉ!</i> <br><br><h2 style=";text-align:right;direction:rtl">  ุงุฎุชุจุงุฑ ุทูุจุงุช ุณุจุงุฑู ุงููุญููุฉ </h2><br>  <b>ูุง ุชุนููุชู</b> : ููุฏ ุณุจุงุฑู ุงููุซูุฑ ูู ุงููููุงุช ุงูุนุงูุฉ ูู ุญู ุงููุดุงูู ุงูุจุณูุทุฉ. <br><br>  ุนู ุทุฑูู ุชูุฒูู ุงูุจูุงูุงุช ุจุชูุณูู ุฐูู ุ ุชูููุช ูู ุงุฎุชุจุงุฑ ุงูุณุฑุนุฉ.  ููุช ุจุฅุนุฏุงุฏ ุจุฑูุงูุฌ ูุตู ุนูู R ูุจุฏุก ุชุดุบูู ุฎุงุฏู Spark ุงููุญูู ุ ุซู ููุช ุจุชุญููู ุฅุทุงุฑ ุจูุงูุงุช Spark ูู ูุณุชูุฏุน ูุฌููุนุงุช Parquet ุงููุญุฏุฏ (ุญุงููุฉ).  ุญุงููุช ุชุญููู ุฌููุน ุงูุจูุงูุงุช ุ ููู ูู ุฃุณุชุทุน ุฏูุน Sparklyr ุฅูู ุงูุชุนุฑู ุนูู ุงูุชูุณูู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="scala hljs">sc &lt;- <span class="hljs-type"><span class="hljs-type">Spark_connect</span></span>(master = <span class="hljs-string"><span class="hljs-string">"local"</span></span>) desired_snp &lt;- <span class="hljs-symbol"><span class="hljs-symbol">'rs3477173</span></span>9' # <span class="hljs-type"><span class="hljs-type">Start</span></span> a timer start_time &lt;- <span class="hljs-type"><span class="hljs-type">Sys</span></span>.time() # <span class="hljs-type"><span class="hljs-type">Load</span></span> the desired bin into <span class="hljs-type"><span class="hljs-type">Spark</span></span> intensity_data &lt;- sc %&gt;% <span class="hljs-type"><span class="hljs-type">Spark_read_Parquet</span></span>( name = <span class="hljs-symbol"><span class="hljs-symbol">'intensity_dat</span></span>a', path = get_snp_location(desired_snp), memory = <span class="hljs-type"><span class="hljs-type">FALSE</span></span> ) # <span class="hljs-type"><span class="hljs-type">Subset</span></span> bin to snp and then collect to local test_subset &lt;- intensity_data %&gt;% filter(<span class="hljs-type"><span class="hljs-type">SNP_Name</span></span> == desired_snp) %&gt;% collect() print(<span class="hljs-type"><span class="hljs-type">Sys</span></span>.time() - start_time)</code> </pre> <br>  ุงุณุชุบุฑู ุงูุชูููุฐ 29.415 ุซุงููุฉ.  ุฃูุถู ุจูุซูุฑ ุ ููู ููุณ ุฌูุฏูุง ุฌุฏูุง ูุงุฌุฑุงุก ุงุฎุชุจุงุฑุงุช ุนูู ุฃู ุดูุก.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูู ุฃุณุชุทุน ุชุณุฑูุน ุงูุนูู ุจุงุณุชุฎุฏุงู ุงูุชุฎุฒูู ุงููุคูุช ุ ูุฃูู ุนูุฏูุง ุญุงููุช ูุคูุชูุง ุชุฎุฒูู ุฅุทุงุฑ ุจูุงูุงุช ูู ุงูุฐุงูุฑุฉ ุ ุชุนุทู Spark ุฏุงุฆููุง ุ ุญุชู ุนูุฏูุง ููุช ุจุชุฎุตูุต ุฃูุซุฑ ูู 50 ุฌูุฌุงุจุงูุช ูู ุงูุฐุงูุฑุฉ ููุฌููุนุฉ ุจูุงูุงุช ูุฒููุง ุฃูู ูู 15. <br><br><h2 style=";text-align:right;direction:rtl">  ุงูุนูุฏุฉ ุฅูู AWK </h2><br>  <b>ูุง ุชุนููุชู</b> : ุงููุตูููุงุช ุงูุชุฑุงุจุทูุฉ AWK ูุนุงูุฉ ููุบุงูุฉ. <br><br>  ูููุช ุฃูู ูููููู ุชุญููู ุณุฑุนุฉ ุฃุนูู.  ุชุฐูุฑุช ุฃูู ูู ุฏููู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุจุฑูุณ ุจุงุฑููุช</a> ุงูููุชุงุฒ AWK ุ ูุฑุฃุช ุนู ููุฒุฉ ุฑุงุฆุนุฉ ุชุณูู " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุตูููุงุช ุงูุชุฑุงุจุทูุฉ</a> ".  ูู ุงููุงูุน ุ ูุฐู ุฃุฒูุงุฌ ุฐุงุช ูููุฉ ุฑุฆูุณูุฉ ุ ูุงูุชู ูุงูุช ุชุณูู ูุณุจุจ ูุฎุชูู ูู AWK ุ ูุจุงูุชุงูู ุฃูุง ุจุทุฑููุฉ ูุง ูู ุฃุฐูุฑูุง ุจุดูู ุฎุงุต.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฐูุฑ ุฑููุงู ุชุดูุจูููุง</a> ุฃู ูุตุทูุญ "ุงููุตูููุงุช ุงูุชุฑุงุจุทูุฉ" ุฃูุฏู ุจูุซูุฑ ูู ูุตุทูุญ "ุฒูุฌ ุงููููุฉ ุงูุฑุฆูุณูุฉ".  ุญุชู ุฅุฐุง ููุช <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุจุญุซ ุนู ููุชุงุญ ุงููููุฉ ูู Google Ngram</a> ุ ููู ุชุฑู ูุฐุง ุงููุตุทูุญ ููุงู ุ ููููู ุณุชุฌุฏ ูุตูููุงุช ุชุฑุงุจุทูุฉ!  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ุบุงูุจูุง ูุง ูุฑุชุจุท ุงูุฒูุฌ ุฐู ุงููููุฉ ุงูุฑุฆูุณูุฉ ุจููุงุนุฏ ุงูุจูุงูุงุช ุ ูุฐูู ููู ุงูููุทูู ููุงุฑูุฉ ูุฐู ุงูููุงุฑูุฉ ุจุงููุงุดูุงุจ.  ุฃุฏุฑูุช ุฃูู ูููููู ุงุณุชุฎุฏุงู ูุฐู ุงููุตูููุงุช ุงูุชุฑุงุจุทูุฉ ูุชูุตูู SNPs ุงูุฎุงุตุฉ ุจู ุจุฌุฏูู ุงูุตูุงุฏูู ูุงูุจูุงูุงุช ุงูุฃูููุฉ ุฏูู ุงุณุชุฎุฏุงู Spark. <br><br>  ููุฐุง ุ ูู ุงูุจุฑูุงูุฌ ุงููุตู AWK ุ ุงุณุชุฎุฏูุช ูุชูุฉ <code>BEGIN</code> .  ูุฐุง ุฌุฒุก ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุชู ูุชู ุชูููุฐูุง ูุจู ููู ุงูุณุทุฑ ุงูุฃูู ูู ุงูุจูุงูุงุช ุฅูู ุงููุต ุงูุฑุฆูุณู ููุจุฑูุงูุฌ ุงููุตู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">join_data.awk BEGIN { FS=<span class="hljs-string"><span class="hljs-string">","</span></span>; batch_num=substr(chunk,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); chunk_id=substr(chunk,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(getline &lt; <span class="hljs-string"><span class="hljs-string">"snp_to_bin.csv"</span></span>) {bin[$<span class="hljs-number"><span class="hljs-number">1</span></span>] = $<span class="hljs-number"><span class="hljs-number">2</span></span>} } { print $<span class="hljs-number"><span class="hljs-number">0</span></span> &gt; <span class="hljs-string"><span class="hljs-string">"chunked/chr_"</span></span>chr<span class="hljs-string"><span class="hljs-string">"_bin_"</span></span>bin[$<span class="hljs-number"><span class="hljs-number">1</span></span>]<span class="hljs-string"><span class="hljs-string">"_"</span></span>batch_num<span class="hljs-string"><span class="hljs-string">"_"</span></span>chunk_id<span class="hljs-string"><span class="hljs-string">".csv"</span></span> }</code> </pre> <br>  ูุงู ุงูุฃูุฑ <code>while(getline...)</code> ุจุชุญููู ุฌููุน ุงูุฃุณุทุฑ ูู ูุฌููุนุฉ CSV (bin) ุ ูุงุถุจุท ุงูุนููุฏ ุงูุฃูู (SNP name) ูููุชุงุญ ูุตููู <code>bin</code> ูุงููููุฉ ุงูุซุงููุฉ (group) ููููุฉ.  ุจุนุฏ ุฐูู ุ ูู ุงููุชูุฉ <code>{</code> <code>}</code> ุ ุงูุชู ูุชู ุชุทุจูููุง ุนูู ุฌููุน ุฃุณุทุฑ ุงูููู ุงูุฑุฆูุณู ุ ูุชู ุฅุฑุณุงู ูู ุณุทุฑ ุฅูู ููู ุงูุฅุฎุฑุงุฌ ุ ูุงูุฐู ูุญุตู ุนูู ุงุณู ูุฑูุฏ ุงุนุชูุงุฏูุง ุนูู ูุฌููุนุชู (bin): <code>..._bin_"bin[$1]"_...</code> <br><br>  ุชุชูุงูู <code>chunk_id</code> ู <code>chunk_id</code> ูุน ุงูุจูุงูุงุช ุงูููุฏูุฉ ุจูุงุณุทุฉ ุฎุท ุงูุฃูุงุจูุจ ุ ูุงูุชู ุชุฌูุจุช ุญุงูุฉ ุงูุณุจุงู ุ ููุชุจ ูู ูุคุดุฑ ุชุฑุงุจุท ุชูููุฐ ุชู ุชุดุบููู <code>parallel</code> ูุน ูููู ุงููุฑูุฏ ุงูุฎุงุต ุจู. <br><br>  ูุธุฑูุง ูุฃููู ููุช ุจุชูุฒูุน ุฌููุน ุงูุจูุงูุงุช ุงูุฃูููุฉ ูู ูุฌูุฏุงุช ุนูู ุงููุฑูููุณููุงุช ุงูุชู ุชุฑูุช ุจุนุฏ ุชุฌุฑุจุชู ุงูุณุงุจูุฉ ูุน AWK ุ ูููููู ุงูุขู ูุชุงุจุฉ ูุต ุจุฑูุฌู ุขุฎุฑ ูููุนุงูุฌุฉ ุนูู ุงููุฑูููุณูู ูู ููุช ูุงุญุฏ ูุฅุนุทุงุก ุจูุงูุงุช ููุณูุฉ ุฃุนูู ุฅูู S3. <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">DESIRED_CHR=<span class="hljs-string"><span class="hljs-string">'13'</span></span> <span class="hljs-comment"><span class="hljs-comment"># Download chromosome data from s3 and split into bins aws s3 ls $DATA_LOC | awk '{print $4}' | grep 'chr'$DESIRED_CHR'.csv' | parallel "echo 'reading {}'; aws s3 cp "$DATA_LOC"{} - | awk -v chr=\""$DESIRED_CHR"\" -v chunk=\"{}\" -f split_on_chr_bin.awk" # Combine all the parallel process chunks to single files and upload to rds using R ls chunked/ | cut -d '_' -f 4 | sort -u | parallel "echo 'zipping bin {}'; cat chunked/*_bin_{}_*.csv | ./upload_as_rds.R '$S3_DEST'/chr_'$DESIRED_CHR'_bin_{}.rds" rm chunked/*</span></span></code> </pre> <br>  ูุญุชูู ุงูุจุฑูุงูุฌ ุนูู ูุณููู <code>parallel</code> . <br><br>  ููุฑุฃ ุงููุณู ุงูุฃูู ุงูุจูุงูุงุช ูู ุฌููุน ุงููููุงุช ุงูุชู ุชุญุชูู ุนูู ูุนูููุงุช ุนู ุงููุฑูููุณูู ุงููุฑุบูุจ ููู ุ ุซู ูุชู ุชูุฒูุน ูุฐู ุงูุจูุงูุงุช ุนุจุฑ ุงูุชุฏููุงุช ุงูุชู ุชุจุนุซุฑ ุงููููุงุช ูู ุงููุฌููุนุงุช ุงูููุงุจูุฉ (ุญุงููุฉ).  ูููุน ุญุฏูุซ ุญุงูุงุช ุงูุณุจุงู ุนูุฏ ูุชุงุจุฉ ุชุฏููุงุช ูุชุนุฏุฏุฉ ูู ููู ูุงุญุฏ ุ ุชููู AWK ุจููู ุฃุณูุงุก ุงููููุงุช ููุชุงุจุฉ ุงูุจูุงูุงุช ุฅูู ุฃูุงูู ูุฎุชููุฉ ุ ุนูู ุณุจูู ุงููุซุงู ุ <code>chr_10_bin_52_batch_2_aa.csv</code> .  ูุชูุฌุฉ ูุฐูู ุ ูุชู ุฅูุดุงุก ุงูุนุฏูุฏ ูู ุงููููุงุช ุงูุตุบูุฑุฉ ุนูู ุงููุฑุต (ููุฐุง ููุฏ ุงุณุชุฎุฏูุช ูุญุฏุงุช ุชุฎุฒูู ุชูุฑุงุจุงูุช EBS). <br><br>  ููุฑ ุฎุท ุงูุฃูุงุจูุจ ูู ุงููุณู <code>parallel</code> ุงูุซุงูู ุนุจุฑ ุงููุฌููุนุงุช (ุญุงููุฉ) ููุฌูุน ูููุงุชูู ุงููุฑุฏูุฉ ูู ูููุงุช CSV ูุดุชุฑูุฉ ูุน <code>cat</code> ุ ุซู ูุฑุณููุง ููุชุตุฏูุฑ. <br><br><h2 style=";text-align:right;direction:rtl">  ุงูุจุซ ุฅูู Rุ </h2><br>  <b>ูุง ุชุนููุชู</b> : ููููู ุงููุตูู ุฅูู <code>stdin</code> ู <code>stdout</code> ูู ุจุฑูุงูุฌ ูุตู R ุ ูุจุงูุชุงูู ุงุณุชุฎุฏุงูู ูู ุฎุท ุงูุฃูุงุจูุจ. <br><br>  ูู ุงูุจุฑูุงูุฌ ุงููุตู Bash ุ ูุฏ ุชูุงุญุธ ูุฐุง ุงูุณุทุฑ: <code>...cat chunked/*_bin_{}_*.csv | ./upload_as_rds.R...</code>  <code>...cat chunked/*_bin_{}_*.csv | ./upload_as_rds.R...</code>  ุฅูู ูุชุฑุฌู ูู ูููุงุช ุงููุฌููุนุฉ ุงููุชุณูุณูุฉ (bin) ุฅูู ุงูุจุฑูุงูุฌ ุงููุตู R ุฃุฏูุงู.  <code>{}</code> ูู ุชูููุฉ <code>parallel</code> ุฎุงุตุฉ ุชููู ุจุฅุฏุฑุงุฌ ุฃู ุจูุงูุงุช ูุชู ุฅุฑุณุงููุง ุฅูููุง ูู ุงูุฏูู ุงููุญุฏุฏ ูุจุงุดุฑุฉ ูู ุงูุฃูุฑ ููุณู.  ูููุฑ ุฎูุงุฑ <code>{#}</code> ูุนุฑู ูุคุดุฑ ุชุฑุงุจุท ูุฑูุฏูุง ุ ูููุซู <code>{%}</code> ุฑูู ูุชุญุฉ ุงููููุฉ (ููุฑุฑ ุ ูููู ููุณ ุฃุจุฏูุง ูู ููุณ ุงูููุช).  ูููู ุงูุงุทูุงุน ุนูู ูุงุฆูุฉ ุจุฌููุน ุงูุฎูุงุฑุงุช ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุซุงุฆู.</a> <br><br><pre style=";text-align:right;direction:rtl"> <code class="lisp hljs"><span class="hljs-meta"><span class="hljs-meta">#!/usr/bin/env Rscript library(readr) library(aws.s3) # Read first command line argument data_destination &lt;- commandArgs(trailingOnly = TRUE)[1] data_cols &lt;- list(SNP_Name = 'c', ...) s3saveRDS( read_csv( file("stdin"), col_names = names(data_cols), col_types = data_cols ), object = data_destination )</span></span></code> </pre> <br>  ุนูุฏ ุชูุฑูุฑ ูุชุบูุฑ <code>file("stdin")</code> ุฅูู <code>readr::read_csv</code> ุ ูุชู ุชุญููู ุงูุจูุงูุงุช ุงููุชุฑุฌูุฉ ุฅูู ุงูุจุฑูุงูุฌ ุงููุตู R ูู ุงูุฅุทุงุฑ ุ ูุงูุฐู ูุชู ูุชุงุจุชู ูุจุงุดุฑุฉู ุจุนุฏ ุฐูู ุฅูู S3 ูููู <code>.rds</code> ุจุงุณุชุฎุฏุงู <code>aws.s3</code> . <br><br>  RDS ูุดุจู ุฅูู ุญุฏ ูุง ุฅุตุฏุงุฑ ุฃุตุบุฑ ูู ุงูููุงุจุฉ ุงูุนุงูุฉ ุ ุฏูู ุฒุฎุฑูุฉ ุฒุฎุฑูุฉ ุงูุนููุฏ. <br><br>  ุจุนุฏ ุฅููุงู ุงูุจุฑูุงูุฌ ุงููุตู Bash ุ ุชูููุช <code>.rds</code> ูููุงุช <code>.rds</code> ุงูููุฌูุฏุฉ ูู S3 ุ ููุง ุณูุญ ูู ุจุงุณุชุฎุฏุงู ุฃููุงุน ุงูุถุบุท ุงููุถููุฉ ุงููุนุงูุฉ. <br><br>  ุนูู ุงูุฑุบู ูู ุงุณุชุฎุฏุงู ุงููุฑุงูู R ุ ูู ุดูุก ูุนูู ุจุณุฑุนุฉ ูุจูุฑุฉ.  ููุณ ูู ุงููุณุชุบุฑุจ ุฃู ูุชู ุชุญุณูู ุงูุดุธุงูุง ูู R ุงููุณุคููุฉ ุนู ูุฑุงุกุฉ ุงูุจูุงูุงุช ููุชุงุจุชูุง.  ุจุนุฏ ุงูุงุฎุชุจุงุฑ ุนูู ูุฑูููุณูู ูุงุญุฏ ูุชูุณุท โโุงูุญุฌู ุ ุชู ุงูุงูุชูุงุก ูู ุงููููุฉ ุนูู ูุซูู C5n.4xl ุฎูุงู ุณุงุนุชูู ุชูุฑูุจูุง. <br><br><h2 style=";text-align:right;direction:rtl">  ูููุฏ S3 </h2><br>  <b>ูุง ุชุนููุชู</b> : ุจูุถู ุงูุชุทุจูู ุงูุฐูู ูููุณุงุฑุงุช ุ ูููู ูู S3 ูุนุงูุฌุฉ ุงูุนุฏูุฏ ูู ุงููููุงุช. <br><br>  ููุช ููููุง ุฅุฐุง ูุงู ุจุฅููุงู S3 ุงูุชุนุงูู ูุน ุงููุซูุฑ ูู ุงููููุงุช ุงููููููุฉ ุฅูููุง.  ูููููู ุฌุนู ุฃุณูุงุก ุงููููุงุช ุฐุงุช ูุนูู ุ ูููู ููู ุณูุจุญุซ S3 ุนููุงุ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/841/0dc/c34/8410dcc34a563c683dd7602dc66d884a.png"><br> <i>  S3    ,        <code>/</code> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="> FAQ- S3.</a></i> <br><br> , S3            -      .  (bucket)   ,   โ    . <br><br>          Amazon, ,    ยซ-----ยป  .    :       get-,       . ,      20 . bin-. ,   ,      (,      ,      ).          . <br><br><h2 style=";text-align:right;direction:rtl">    ? </h2><br>   :     โ     . <br><br>       : ยซ    ?ยป      ( gzip CSV-   7  )      .     ,  R     Parquet ( Arrow)     Spark.       R,         ,         ,       . <br><br><h2 style=";text-align:right;direction:rtl">   </h2><br> <b>  </b> :     ,    . <br><br>       ,      . <br>     EC2  ,                 ( ,  Spark    ).  ,          ,    AWS-      10 . <br><br>      R      . <br><br>   S3 ,       . <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">library(aws.s3) library(tidyverse) chr_sizes &lt;- get_bucket_df( bucket = <span class="hljs-string"><span class="hljs-string">'...'</span></span>, prefix = <span class="hljs-string"><span class="hljs-string">'...'</span></span>, max = Inf ) %&gt;% mutate(Size = as.numeric(Size)) %&gt;% filter(Size != 0) %&gt;% mutate( <span class="hljs-comment"><span class="hljs-comment"># Extract chromosome from the file name chr = str_extract(Key, 'chr.{1,4}\\.csv') %&gt;% str_remove_all('chr|\\.csv') ) %&gt;% group_by(chr) %&gt;% summarise(total_size = sum(Size)/1e+9) # Divide to get value in GB # A tibble: 27 x 2 chr total_size &lt;chr&gt; &lt;dbl&gt; 1 0 163. 2 1 967. 3 10 541. 4 11 611. 5 12 542. 6 13 364. 7 14 375. 8 15 372. 9 16 434. 10 17 443. # โฆ with 17 more rows</span></span></code> </pre> <br>    ,    ,   ,     <code>num_jobs</code>  ,       . <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">num_jobs &lt;- 7 <span class="hljs-comment"><span class="hljs-comment"># How big would each job be if perfectly split? job_size &lt;- sum(chr_sizes$total_size)/7 shuffle_job &lt;- function(i){ chr_sizes %&gt;% sample_frac() %&gt;% mutate( cum_size = cumsum(total_size), job_num = ceiling(cum_size/job_size) ) %&gt;% group_by(job_num) %&gt;% summarise( job_chrs = paste(chr, collapse = ','), total_job_size = sum(total_size) ) %&gt;% mutate(sd = sd(total_job_size)) %&gt;% nest(-sd) } shuffle_job(1) # A tibble: 1 x 2 sd data &lt;dbl&gt; &lt;list&gt; 1 153. &lt;tibble [7 ร 3]&gt;</span></span></code> </pre> <br>      purrr     . <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">1:1000 %&gt;% map_df(shuffle_job) %&gt;% filter(sd == min(sd)) %&gt;% pull(data) %&gt;% pluck(1)</code> </pre> <br>     ,    .       Bash-    <code>for</code> .       10 .    ,             .  ,        . <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> DESIRED_CHR <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"16"</span></span> <span class="hljs-string"><span class="hljs-string">"9"</span></span> <span class="hljs-string"><span class="hljs-string">"7"</span></span> <span class="hljs-string"><span class="hljs-string">"21"</span></span> <span class="hljs-string"><span class="hljs-string">"MT"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment"># Code for processing a single chromosome fi</span></span></code> </pre> <br>     : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">sudo shutdown -h now</code> </pre> <br> โฆ   !   AWS CLI       <code>user_data</code>   Bash-    .     ,         . <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">aws ec2 run-instances ...\ --tag-specifications <span class="hljs-string"><span class="hljs-string">"ResourceType=instance,Tags=[{Key=Name,Value=&lt;&lt;job_name&gt;&gt;}]"</span></span> \ --user-data file://&lt;&lt;job_script_loc&gt;&gt;</code> </pre> <br><h1 style=";text-align:right;direction:rtl"> ! </h1><br> <b>  </b> : API        . <br><br> -        .      ,     .     API   .        <code>.rds</code>  Parquet-,       ,    .       R-. <br><br>      ,        ,    <code>get_snp</code> .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">pkgdown</a> ,        . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a75/afb/f3a/a75afbf3a2c7c8ef5fa2a873f8ba50b9.png"><br><br><h2 style=";text-align:right;direction:rtl">   </h2><br> <b>  </b> :     ,   ! <br><br>          SNP      ,     (binning)   .     SNP,          (bin).      ( )    . <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Part of get_snp() ... # Test if our current snp data has the desired snp. already_have_snp &lt;- desired_snp %in% prev_snp_results$snps_in_bin if(!already_have_snp){ # Grab info on the bin of the desired snp snp_results &lt;- get_snp_bin(desired_snp) # Download the snp's bin data snp_results$bin_data &lt;- aws.s3::s3readRDS(object = snp_results$data_loc) } else { # The previous snp data contained the right bin so just use it snp_results &lt;- prev_snp_results } ...</span></span></code> </pre> <br>       ,       .    ,      . , <code>dplyr::filter</code>           ,           ,    . <br><br>  ,   <code>prev_snp_results</code>   <code>snps_in_bin</code> .     SNP   (bin),   ,       .        SNP   (bin)    : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Get bin-mates snps_in_bin &lt;- my_snp_results$snps_in_bin for(current_snp in snps_in_bin){ my_snp_results &lt;- get_snp(current_snp, my_snp_results) # Do something with results }</span></span></code> </pre> <br><h1 style=";text-align:right;direction:rtl">  ุงููุชุงุฆุฌ </h1><br>    (  )    ,   .  ,           .      . <br><br>       ,       ,     ,     โฆ <br><br>   .       .       (  ),  ,   (bin)   ,    SNP     0,1 ,     ,     S3 . <br><br><div class="oembed" style=";text-align:right;direction:rtl"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-3" style="position: static; visibility: visible; display: block; transform: rotate(0deg); max-width: 100%; width: 500px; min-width: 220px; margin-top: 10px; margin-bottom: 10px;" data-tweet-id="1134151057385369600"></twitter-widget><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><br><h2 style=";text-align:right;direction:rtl">  ุงุณุชูุชุงุฌ </h2><br>   โ   .   ,     . ,    . ,   ,         ,     .  ,       ,  ,        ,    .  ,       ,    ,        ,      -     . <br><br>     .     ,        ,  ยซยป  ,    .          . <br><br><h3 style=";text-align:right;direction:rtl">   : </h3><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">      25   ; <br></li><li style=";text-align:right;direction:rtl">      Parquet-   ; <br></li><li style=";text-align:right;direction:rtl">   Spark   ; <br></li><li style=";text-align:right;direction:rtl">      2,5  ; <br></li><li style=";text-align:right;direction:rtl">    ,    Spark; <br></li><li style=";text-align:right;direction:rtl">      ; <br></li><li style=";text-align:right;direction:rtl">   Spark  ,      ; <br></li><li style=";text-align:right;direction:rtl">  ,    ,  -       1980-; <br></li><li style=";text-align:right;direction:rtl"> <code>gnu parallel</code> โ   ,    ; <br></li><li style=";text-align:right;direction:rtl"> Spark        ; <br></li><li style=";text-align:right;direction:rtl">  Spark        ; <br></li><li style=";text-align:right;direction:rtl">    AWK  ; <br></li><li style=";text-align:right;direction:rtl">    <code>stdin</code>  <code>stdout</code>  R-,       ; <br></li><li style=";text-align:right;direction:rtl">     S3    ; <br></li><li style=";text-align:right;direction:rtl">     โ     ; <br></li><li style=";text-align:right;direction:rtl">     ,    ; <br></li><li style=";text-align:right;direction:rtl"> API        ; <br></li><li style=";text-align:right;direction:rtl">     ,   ! <br></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar456392/">https://habr.com/ru/post/ar456392/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar456380/index.html">ุงูููู ุงูููุชูุญ ููููุฉ ุงูุจุฑูุฌุฉ ูู ุนูู Netology</a></li>
<li><a href="../ar456382/index.html">ุงูุชุนุงูู ูุงูุฃุชูุชุฉ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ. ูุง ุชุนูููุงู ูู 13 ูุฏุฑุณุฉ</a></li>
<li><a href="../ar456384/index.html">PVS- ุณุชูุฏูู ุงูุฑุณู ุงูุจูุงูู ูุชุทููุฑ ุงููุฏุฑุงุช ุงูุชุดุฎูุตูุฉ</a></li>
<li><a href="../ar456386/index.html">ูุชุญ ููุชุจุงุช ูุชุตูุฑ ูุญุชูู ุงูุตูุช</a></li>
<li><a href="../ar456388/index.html">ูุฎุทุท ุชุทููุฑ ุงูุชุดุฎูุต ูู PVS-Studio</a></li>
<li><a href="../ar456394/index.html">ุฌุนู ุดุงุดุฉ ุงูุจุฏุงูุฉ ูู ูู ููุงู ุนูู ุฏุงุฆุฑุฉ ุงูุฑูุงุจุฉ ุงูุฏุงุฎููุฉ</a></li>
<li><a href="../ar456398/index.html">ููุญูุงุช Vue-cli ุ ุงูุนูู ูุน ุงูุจูุงูุงุช ุงููุนูุฏุฉ ูุงูุงุฎุชุจุงุฑุงุช ุงููุงุฆูุฉ ุนูู ุงูููููุฉ - ุฅุนูุงู Panda-Meetup Frontend</a></li>
<li><a href="../ar456402/index.html">ุฃุณูุงู ุงูุญููุฉ: ุณุญุจ</a></li>
<li><a href="../ar456404/index.html">ูุจูุฑ - ุงูุจุฑูุงูุฌ ุงููุณุงุนุฏ ููุฑุณู</a></li>
<li><a href="../ar456406/index.html">ูู ุจุชุฑุญูู ุตูุงุฏูู ุงูุจุฑูุฏ ุจูู ุฎุฒุงุฆู ูู Zimbra Collaboration Suite</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>