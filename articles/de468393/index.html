<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æüèæ ‚úçüèæ üïù Mit einem guten Mikrocontroller vergeht die Zeit schnell oder mit einem Wochenendoszilloskop üßúüèø üíª üçÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einiger Zeit hat sich der Autor dieser Zeilen verpflichtet, einen kompakten Rekorder f√ºr ein einpoliges analoges Signal innerhalb von 3 Volt mit d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mit einem guten Mikrocontroller vergeht die Zeit schnell oder mit einem Wochenendoszilloskop</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468393/"><p>  Vor einiger Zeit hat sich der Autor dieser Zeilen verpflichtet, einen kompakten Rekorder f√ºr ein einpoliges analoges Signal innerhalb von 3 Volt mit der h√∂chstm√∂glichen Lesegeschwindigkeit und den niedrigstm√∂glichen Kosten und Gr√∂√üen zu entwickeln.  In der Liste der niedrigstm√∂glichen Kosten habe ich auch meine Kopfschmerzen eingetragen und den mir bekannten STM32F303 gew√§hlt.  Ich erinnere mich, dass dies Cortex-M4 72 Megahertz von einem bekannten Unternehmen ist, mit eingebauten 12-Bit-Analog-Digital-Wandlern (ADC oder ADC, wie Sie m√∂chten) und einer integrierten CAN-Schnittstelle. </p><br><p>  Solche kleinen Registrare ben√∂tigten mehrere Dutzend.  Und das Vorhandensein eines Mikrocontroller-Geh√§uses mit 48 Beinen weckte die Hoffnung, dass es m√∂glich sein w√ºrde, diesen Leser als kompakt zu bezeichnen.  Die CAN-Schnittstelle, mit der ich bereits eine gute Beziehung hatte, gab mir die M√∂glichkeit, all diesen Jazz auf ziemlich bequeme Weise zu kombinieren. </p><br><p>  Die Geschwindigkeit, mit der am Ende alles funktionierte, erwies sich als durchaus geeignet, um die Funktionsf√§higkeit des gew√§hlten Ansatzes zu erkl√§ren.  Es war m√∂glich, einen Abtastschritt von einer halben Mikrosekunde zu erreichen.  Kopfschmerzen und Assembler konnten nicht vermieden werden, aber wer erinnert sich jetzt daran? </p><br><p>  Es blieb jedoch etwas Sediment zur√ºck.  Der Gedanke blieb, dass in Bezug auf die Geschwindigkeit nicht alles herausgedr√ºckt wurde. </p><br><p>  Und jetzt ist die STM32G4-Serie k√ºrzlich mit einer Taktfrequenz von bis zu 170 Megahertz mit einer Option in einem kleinen Paket und mit fast denselben schnellen ADCs an Bord in H√∂he von f√ºnf St√ºck erschienen.  Es war notwendig, etwas zu tun. </p><a name="habracut"></a><br><p>  Jetzt stand niemand mehr √ºber der Seele und es bestand kein Grund, sich um Termine und Pl√§ne zu k√ºmmern. </p><br><p>  Wenn Sie nicht dar√ºber nachdenken, k√∂nnen Sie sogar die Arbeit genie√üen.  Aber ehrlich gesagt musste ich √ºber die Zeit nachdenken.  Lange √ºber kleine Zeit nachdenken (und was, poetisch). </p><br><p>  Der Gedanke schlug sich vor, dass wir ein wenig am anderen Ende beginnen sollten.  Das hei√üt, wir m√ºssen von der k√ºrzestm√∂glichen Zeit f√ºr die ADC-Abtastung ausgehen, die basierend auf der Beschreibung 2,5 Taktzyklen dauert und 62,5 Nanosekunden bei 40 MHz (160 MHz / 4) betr√§gt.  Dann bietet sich der Abtastschritt von 100 Nanosekunden an.  Die Zahl ist rund und vor allem recht klein und sch√∂n. Warum nicht mal probieren? </p><br><p>  Dar√ºber hinaus wurde die f√ºr Experimente geeignete NUCLEO-G474RE-Platine zum Verkauf angeboten und gekauft. Es war sinnvoll, ein zus√§tzliches Steckbrett mit zwei zweireihigen Steckverbindern hinzuzuf√ºgen, um alle Arten von Dr√§hten und Teilen auf das Steckbrett zu l√∂ten und das Hauptbrett nicht zu verderben.  So sieht es fertig aus. </p><br><p><img src="https://habrastorage.org/webt/kv/sx/k1/kvsxk19p26urrkufbil_6jmnm10.jpeg"></p><br><p>  Dort unten gibt es mehrere Dr√§hte und einen Widerstand mit einem Kondensator, nehmen Sie mein Wort daf√ºr. </p><br><p>  Jetzt m√ºssen Sie ein geeignetes elektrisches Signal an alle vier ADCs gleichzeitig anlegen und sie dann mit einem konstanten Schritt nacheinander ausf√ºhren (zun√§chst beim Debuggen nicht sehr kurz).  Warum vier?  Gem√§√ü der Beschreibung verbringt jeder ADC 15 Taktzyklen pro Umwandlung oder 0,025 √ó 15 = 375 Nanosekunden (fast 400).  Daher ist in Schritt 100 ein F√∂rderer von vier ADCs erforderlich. </p><br><p>  Als Eingangssignal wurde eine RC-Schaltung verwendet, die einfach vom Reglerfu√ü mit Spannung versorgt wurde.  Ich habe dieses Bein zugewiesen, um den TIM5-Timer im Einzelimpulsmodus zu steuern. </p><br><p>  Der minimale Schaltplan sah wie in der Abbildung unten aus. </p><br><p><img src="https://habrastorage.org/webt/i1/xn/_u/i1xn_uykljjux10i1f3iv9fbcum.jpeg"></p><br><p>  ADC1-ADC4 waren beteiligt.  Die Bittiefe konnte f√ºr eine gewisse Geschwindigkeitssteigerung verringert werden, aber 12 Bits √ºberwogen, da ich die Genauigkeit der Messungen nicht verlieren wollte.  Um jeden ADC in der erforderlichen Reihenfolge und mit dem erforderlichen Schritt zu starten, werden drei Timer (TIM2, TIM3, TIM4) und ein anderer Timer (TIM1) verwendet, um die obigen drei zu synchronisieren.  Abbildung 2 zeigt die Signale, um die herum alles aufgebaut ist. </p><br><p><img src="https://habrastorage.org/webt/rm/j8/xj/rmj8xjehhvbc2gk5e-xt_jy8oi4.jpeg"></p><br><p>  Die gr√ºnen Pfeile geben die Flanke der Impulse an, entlang derer die jeweiligen ADC1-ADC4-Wandler ausgel√∂st werden. </p><br><p>  Um die geplanten 100 Nanosekunden zu erhalten, mussten wir die Taktfrequenz auf 160 Megahertz senken, damit alles vollst√§ndig aufgeteilt wurde, wie es sollte.  Zun√§chst wurde der Schritt mit 4 Mikrosekunden viel langsamer eingestellt, um den Betrieb von Timern mithilfe von Interrupts, Ausgangsanschl√ºssen und einem Oszilloskop ruhig zu √ºberpr√ºfen.  Dann wurde es durch Unterbrechung debuggt und erhielt direkten Zugriff auf den Speicher.  Letztendlich wird nur ein Interrupt verarbeitet - dies ist die Unterbrechung des Arbeitsende vom vierten (letzten) Kanal des direkten Zugriffs auf den Speicher.  Die folgende Abbildung zeigt die Verbindungen der am Prozess beteiligten Hardwareeinheiten sowie vier Ausgangsspeicherpuffer. </p><br><p><img src="https://habrastorage.org/webt/q-/y4/6k/q-y46k_9tzn2zrt4wnyycsssrtw.jpeg"></p><br><p>  Von den vier Speicherpuffern (in der Abbildung rechts) werden die Samples programmgesteuert in einem Ergebnispuffer gesammelt. </p><br><p>  In diesem Controller gibt es im Gegensatz zum STM32F303 eine Anforderungsumschalteinheit (DMAMUX), mit der Sie eine gro√üe Anzahl von Anforderungen von Peripherieger√§ten auf nur 16 DMA1-Kan√§le und 16 DMA2-Kan√§le umleiten k√∂nnen.  Im Referenzhandbuch werden die DMAMUX-Ausgabeanforderungen von 0 und die Eing√§nge der DMA-Kanalkan√§le von 1 gez√§hlt. Ich habe sie nicht ge√§ndert, sondern wie in der Originalquelle belassen. </p><br><p>  Ein TIM5-Timer wird als Einzelimpulsgenerator verwendet.  Es bietet einen praktischen Einzelpulsmodus.  Bequemlichkeit liegt in der M√∂glichkeit, die Zeit vor dem Start des Impulses einzustellen und die Dauer des Impulses selbst einzustellen.  Dieser Impuls kam wie unten im Bild gezeigt heraus und wurde freundlicherweise von einem gemieteten Oszilloskop zur Verf√ºgung gestellt. </p><br><p><img src="https://habrastorage.org/webt/ru/1-/c2/ru1-c2zutulhogxtlmnh92iriu4.jpeg"></p><br><p>  Das Oszillogramm zeigt, dass der Anstieg des Impulses 10 Mikrosekunden dauert, was bedeutet, dass er ungef√§hr 100 Abtastwerte aufnehmen sollte. </p><br><p>  Das Projekt wurde in IAR 8.4 manuell durchgef√ºhrt (dh ohne Kuba und den Ball), aber ich hoffe, es wird von einer Vielzahl von Glaubensrichtungen verstanden.  Sie k√∂nnen es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier sehen</a> . </p><br><p>  Hier ist ein Bild des Inhalts eines separaten ADC1-Puffers und des Ergebnisses, das aus vier Quellen des Puffers im Bereich des Beginns des Eingangsimpulses gesammelt wurde. </p><br><p><img src="https://habrastorage.org/webt/pz/fh/f-/pzfhf-eknlnmmpdq5gzhg9ii5lo.jpeg"></p><br><p>  Der Inhalt dieser Puffer liegt jedoch im Bereich der Impulsspitze (wo der Wert 2508 erreicht). </p><br><p><img src="https://habrastorage.org/webt/a6/_1/_f/a6_1_fbgckavkbfmj6xaz9pff9m.jpeg"></p><br><p>  Wie Sie sehen k√∂nnen, wurden 196-95 = 101 Z√§hlungen f√ºr den Abschnitt vom Beginn des Impulses bis zu seiner Spitze ausgegeben. </p><br><p>  Die Abtastrate betr√§gt also 10 Megahertz.  Bei dieser Geschwindigkeit funktionierte es nicht sofort. </p><br><p>  Um dies zu erreichen, musste ich den Prozessor stoppen, bevor ich den direkten Speicherzugriff (DMA1) startete.  Es ist gut, dass der Cortex-M4 √ºber eine spezielle Assembler-Anweisung <strong>WFI verf√ºgt</strong> (Warten auf Unterbrechungen).  Wenn dies nicht getan wird, st√∂rt der Prozessor den F√º√üen des DMA und belegt den Bus mit Speicherzugriffen, die m√∂glicherweise warten. </p><br><p>  Wenn Sie den Z√§hlschritt auf 200 Nanosekunden erh√∂hen, h√∂ren sie auf zu schieben und heilen friedlich und gl√ºcklich. </p><br><p>  Wenn wir den COMP4-Komparator in seine Arbeit einbeziehen und seinen positiven Eingang (Port PB0) mit dem Eingangssignal verbinden, dann den DAC (DAC1) verwenden und seinen Ausgang (CH1) mit dem negativen Eingang des Komparators (innerhalb der Steuerung) verbinden, erhalten wir ein Schwellenwertger√§t mit einem einstellbaren Schwellenwert.  Durch Betriebsunterbrechungen des Komparators k√∂nnen Sie den allgemeinen Taktgeber TIM1 starten und einen Standby-Modus wie bei einem Oszilloskop erhalten. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de468393/">https://habr.com/ru/post/de468393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de468381/index.html">Zur√ºck in die Zukunft? Ausstehendes Radiergummi-Quantum</a></li>
<li><a href="../de468383/index.html">Ruby Meme Generator, um Interesse an der Sprache zu wecken</a></li>
<li><a href="../de468385/index.html">Der Desktop ist tot, es lebe der Desktop! Ich sammle habrastatistiki</a></li>
<li><a href="../de468387/index.html">Die Zusammenfassung interessanter Materialien f√ºr den mobilen Entwickler # 316 (vom 16. bis 22. September)</a></li>
<li><a href="../de468389/index.html">Artyom Galonsky, STO-B√ºro des B√ºros: ‚ÄûIch bin gegen so etwas wie einen DevOps-Ingenieur.‚Äú</a></li>
<li><a href="../de468395/index.html">Cloud-Sicherheits√ºberwachung. Teil 2</a></li>
<li><a href="../de468397/index.html">Nachrichten aus der Welt von OpenStreetMap Nr. 477 (09/03/2019 - 09.09.2019)</a></li>
<li><a href="../de468399/index.html">C / C ++. Verwendung eingebetteter Anwendungsressourcen bei der Arbeit in GCC unter Linux</a></li>
<li><a href="../de468401/index.html">Sichere M√∂glichkeit zum Austausch von JWT in ASP.NET Core + SPA</a></li>
<li><a href="../de468403/index.html">Integrierte Laufzeitsteuerung f√ºr Softwareanwendungen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>