<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêö ‚òÉÔ∏è ‚öõÔ∏è Kami berusaha semaksimal mungkin: dari ORM ke analisis bytecode üë©‚Äçüë©‚Äçüëß üîì ‚èπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Seperti yang Anda ketahui, seorang programmer sejati harus melakukan 3 hal dalam hidupnya: membuat bahasa pemrogramannya sendiri, menulis sistem opera...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kami berusaha semaksimal mungkin: dari ORM ke analisis bytecode</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409043/"><p>  Seperti yang Anda ketahui, seorang programmer sejati harus melakukan 3 hal dalam hidupnya: membuat bahasa pemrogramannya sendiri, menulis sistem operasinya sendiri dan membuat ORM-nya sendiri.  Dan jika saya menulis bahasa itu sejak lama (mungkin saya akan memberi tahu Anda lain waktu), dan OS masih di depan, maka saya ingin memberi tahu Anda tentang ORM sekarang.  Untuk lebih tepatnya, ini bukan tentang ORM itu sendiri, tetapi tentang implementasi satu fitur kecil, lokal dan, sepertinya, fitur yang sangat sederhana. </p><br><p> Bersama-sama kita akan melangkah jauh dari kegembiraan menemukan solusi sederhana untuk kepahitan kesadaran akan kerapuhan dan kesalahannya.  Dari menggunakan API khusus publik hingga peretasan kotor.  Dari "hampir tanpa refleksi" hingga "setinggi lutut di dalam byte-code interpreter." </p><br><p>  Siapa yang peduli bagaimana menganalisis bytecode, kesulitan apa yang ditimpanya, dan betapa luar biasanya hasil yang bisa Anda dapatkan pada akhirnya, selamat datang di kucing. </p><a name="habracut"></a><br><h3 id="soderzhanie">  Isi </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">1</a> - Bagaimana semuanya dimulai. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">2-4</a> - Dalam perjalanan menuju bytecode. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">5</a> - Siapa bytecode. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">6</a> - Analisis itu sendiri.  Demi bab ini segala sesuatu dikandung dan di dalamnya ada nyali. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">7</a> - Apa lagi yang bisa selesai.  Mimpi, Mimpi ... <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kata Penutup</a> - Kata Penutup. </p><br><p>  <em>UPD: Segera setelah publikasi, bagian 6-8 hilang (demi semuanya dimulai).</em>  <em>Diperbaiki</em> </p><br><a name="1"></a><br><h3 id="chast-pervaya-problema">  Bagian Satu  Masalah </h3><br><p>  Bayangkan kita memiliki skema sederhana.  Ada klien, dia punya beberapa akun.  Salah satunya default.  Selain itu, klien dapat memiliki beberapa kartu SIM dan masing-masing kartu SIM dapat diatur secara eksplisit, atau klien default dapat digunakan. </p><br><p><img src="https://habrastorage.org/webt/dh/io/ag/dhioagv6hwl7cmpls9cuh2a_dyq.png"></p><br><p>  Berikut adalah bagaimana model ini dijelaskan dalam kode kami (menghilangkan getter / setter / konstruktor / ...). </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"DEFAULTACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account defaultAccount; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long balance; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CARD"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String msisdn; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; }</code> </pre> <br><p>  Dalam ORM sendiri, kami memiliki persyaratan untuk tidak adanya proxy (kami harus membuat turunan dari kelas khusus ini) dan satu permintaan.  Dengan demikian, inilah sql yang dikirim ke database ketika mencoba untuk mendapatkan peta. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.id <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, CARD.msisdn msisdn, ACCOUNT_2.id ACCOUNT_2_id, ACCOUNT_2.balance ACCOUNT_2_balance, CLIENT_3.id CLIENT_3_id, CLIENT_3.name CLIENT_3_name, CLIENT_1.id CLIENT_1_id, CLIENT_1.name CLIENT_1_name, ACCOUNT_4.id ACCOUNT_4_id, ACCOUNT_4.balance ACCOUNT_4_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = CLIENT_1.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = ACCOUNT_2.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ACCOUNT_2.CLIENT = CLIENT_3.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_4 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CLIENT_1.DEFAULTACCOUNT = ACCOUNT_4.id;</code> </pre> <br><p>  Ups.  Klien dan tagihan digandakan.  Benar, jika Anda berpikir tentang hal ini, ini dapat dimengerti - bagaimanapun juga, kerangka kerjanya tidak tahu bahwa klien kartu dan klien akun kartu adalah klien yang sama.  Dan permintaan harus dihasilkan secara statis dan hanya satu (ingat pembatasan pada keunikan permintaan?). </p><br><p>  Ngomong-ngomong, untuk alasan yang persis sama, tidak ada bidang <code>Card.client.defaultAccount.client</code> dan <code>Card.client.defaultAccount.client</code> di sini sama sekali.  Hanya kami yang tahu bahwa <code>client</code> dan <code>client.defaultAccount.client</code> selalu cocok.  Dan kerangka itu tidak tahu, baginya ini adalah tautan arbitrer.  Dan apa yang harus dilakukan dalam kasus seperti itu tidak terlalu jelas.  Saya tahu 3 opsi: </p><br><ol><li>  Jelaskan invarian secara eksplisit dalam anotasi. </li><li>  Membuat pertanyaan rekursif ( <code>with recursive</code> / <code>connect by</code> ). </li><li>  Untuk mencetak gol. </li></ol><br><p>  Tebak opsi mana yang kami pilih?  Benar  Akibatnya, semua bidang rekursif tidak diisi sama sekali sekarang dan selalu ada nol. </p><br><p>  Tetapi jika Anda melihat lebih dekat, Anda dapat melihat masalah kedua di belakang duplikasi, dan itu jauh lebih buruk.  Apa yang kita inginkan?  Nomor kartu dan saldo.  Apa yang kamu dapatkan  4 bergabung dan 10 kolom.  Dan hal ini tumbuh secara eksponensial!  Baik i.e.  kami benar-benar memiliki situasi di mana, pertama, demi keindahan dan integritas, kami sepenuhnya menggambarkan model pada anotasi, dan kemudian, <strong>demi 5 bidang</strong> , permintaan untuk <strong>15 bergabung dan 150 kolom</strong> diminta.  Dan pada saat ini menjadi sangat menakutkan. </p><br><a name="2"></a><br><h3 id="chast-vtoraya-rabochee-no-neudobnoe-reshenie">  Bagian Dua  Solusi yang berfungsi tetapi tidak nyaman </h3><br><p>  Sebuah solusi sederhana segera memohon.  Hanya pengeras suara yang akan digunakan yang harus diseret!  Mudah dikatakan.  Pilihan yang paling jelas (untuk menulis pilihan dengan tangan Anda) kami akan segera menjatuhkannya.  Nah, belum, kami jelaskan modelnya agar tidak menggunakannya.  Dahulu kala metode khusus dibuat - <code>partialGet</code> .  Ini, tidak seperti <code>get</code> sederhana, menerima <code>List&lt;String&gt;</code> - nama bidang yang harus diisi.  Untuk melakukan ini, Anda harus terlebih dahulu mendaftarkan alias di tabel </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"a"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"c"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>  Dan kemudian nikmati hasilnya. </p><br><pre> <code class="java hljs">List&lt;String&gt; requiredColumns = asList(<span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); String query = cardMapper.getSelectSQL(requiredColumns, DatabaseType.ORACLE); System.out.println(query);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.msisdn msisdn, c_a.balance c_a_balance, a.balance a_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = a.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = c.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> c_a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.DEFAULTACCOUNT = c_a.id;</code> </pre> <br><p>  Dan semuanya tampak baik-baik saja, tetapi, pada kenyataannya, tidak.  Begini cara itu akan digunakan dalam kode nyata. </p><br><pre> <code class="java hljs">Card card = cardDAO.partialGet(cardId, <span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); ... ... ...    ... ... ... <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> clientId = card.getClient().getId();<span class="hljs-comment"><span class="hljs-comment">//, NPE.  , id    ?!</span></span></code> </pre> <br><p>  Dan ternyata sekarang Anda bisa menggunakan partialGet hanya jika jarak antara itu dan hasilnya hanya beberapa baris.  Tetapi jika hasilnya jauh atau, Tuhan melarang, dilewatkan dalam beberapa metode, maka sudah sangat sulit untuk memahami bidang mana yang diisi dan mana yang tidak.  Selain itu, jika NPE terjadi di suatu tempat, maka Anda masih perlu memahami apakah itu benar-benar kembali dari database nol, atau apakah kami tidak mengisi bidang ini.  Semua dalam semua, sangat tidak bisa diandalkan. </p><br><p>  Anda dapat, tentu saja, hanya menulis objek lain dengan pemetaan Anda secara khusus untuk permintaan tersebut, atau bahkan sepenuhnya memilih semuanya dengan tangan Anda dan merakitnya menjadi beberapa <code>Tuple</code> .  Sebenarnya, pada kenyataannya sekarang di sebagian besar tempat kita melakukan hal itu.  Tapi tetap saja saya ingin tidak menulis pilihan dengan tangan saya, dan tidak menduplikasi pemetaan. </p><br><a name="3"></a><br><h3 id="chast-tretya-udobnoe-no-nerabochee-reshenie">  Bagian tiga.  Solusi yang mudah namun tidak bisa digunakan. </h3><br><p>  Jika Anda berpikir lebih banyak, maka dengan cepat jawabannya muncul di benak saya - Anda perlu menggunakan antarmuka.  Maka deklarasikan saja </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MsisdnAndBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMsisdn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  Dan gunakan </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, ...);</code> </pre> <br><p>  Dan itu saja.  Jangan menelepon sesuatu yang ekstra.  Apalagi dengan transisi ke Kotlin / sepuluh / lomb, bahkan tipe mengerikan ini bisa dihilangkan.  Tapi di sini poin paling penting masih dihilangkan.  Argumen apa yang harus diteruskan ke <code>partialGet</code> ?  Tali, seperti sebelumnya, tidak terasa seperti lagi, karena risikonya terlalu besar untuk membuat kesalahan dan menulis bidang yang salah.  Dan saya ingin Anda bisa melakukannya </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, MsisdnAndBalance.class);</code> </pre> <br><p>  Atau bahkan lebih baik di Kotlin melalui generik reified </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> card = cardDAO.paritalGet&lt;MsisdnAndBalance&gt;(cardId)</code> </pre> <br><p>  Ehh, kesalahan besar.  Sebenarnya, keseluruhan cerita selanjutnya adalah implementasi dari opsi ini. </p><br><a name="4"></a><br><h3 id="chast-chetvertaya-na-puti-k-baytkodu">  Bagian Empat  Dalam perjalanan ke bytecode </h3><br><p>  Masalah utamanya adalah metode berasal dari antarmuka, dan anotasi ada di atas bidang.  Dan kita perlu menemukan bidang yang sama ini dengan metode.  Pikiran pertama dan yang paling jelas adalah menggunakan konvensi Java Bean standar.  Dan untuk properti sepele, ini bahkan berfungsi.  Namun ternyata sangat tidak stabil.  Sebagai contoh, ada baiknya mengganti nama metode dalam antarmuka (melalui refactoring ideologis), karena semuanya langsung berantakan.  Idenya cukup pintar untuk mengubah nama metode di kelas implementasi, tetapi tidak cukup untuk memahami bahwa itu adalah pengambil dan Anda perlu mengganti nama bidang itu sendiri.  Dan solusi serupa mengarah pada duplikasi bidang.  Sebagai contoh, jika saya memerlukan metode <code>getClientId()</code> di antarmuka saya, maka saya tidak dapat mengimplementasikannya dengan satu-satunya cara yang benar </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p>  Dan saya harus menduplikasi bidang.  Dan di <code>Client</code> seret <code>id</code> dan <code>clientId</code> , dan di peta di sebelah klien secara eksplisit <code>clientId</code> .  Dan pastikan semua ini tidak pergi.  Selain itu, saya juga ingin getter dengan logika non-sepele bekerja, misalnya </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> account.getBalance(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getDefaultAccount().getBalance(); } }</code> </pre> <br><p>  Jadi opsi dengan pencarian berdasarkan nama tidak lagi diperlukan, Anda perlu sesuatu yang lebih rumit. </p><br><p>  Pilihan selanjutnya benar-benar gila dan tidak hidup lama di kepalaku, tetapi demi kelengkapan cerita saya juga akan menggambarkannya.  Pada tahap penguraian, kita dapat membuat entitas kosong dan cukup bergiliran menulis beberapa nilai di bidang, dan setelah itu kita mendapatkan getter dan melihatnya mengubah apa yang mereka kembalikan atau tidak.  Jadi kita akan melihat bahwa dari catatan di bidang <code>name</code> , nilai <code>getClientId</code> tidak berubah, tetapi dari catatan <code>id</code> - itu berubah.  Selain itu, situasi ketika getter dan bidang dari berbagai jenis (seperti <code>isActive() = i_active != 0</code> ) secara otomatis didukung di sini.  Tetapi setidaknya ada tiga masalah serius (mungkin lebih, tetapi saya tidak berpikir lebih jauh). </p><br><ol><li>  Persyaratan yang jelas untuk esensi dengan algoritma ini adalah untuk mengembalikan nilai "sama" dari pengambil jika bidang "sesuai" tidak berubah.  "Satu dan sama" - dari sudut pandang operator perbandingan yang telah kami pilih.  <code>==</code> itu jelas tidak bisa (jika beberapa <code>getAsInt() = Integer.parseInt(strField))</code> akan berhenti bekerja <code>getAsInt() = Integer.parseInt(strField))</code> .  Tetap sama.  Jadi, jika pengambil mengembalikan semacam entitas pengguna yang dihasilkan oleh bidang pada setiap panggilan, maka ia harus memiliki penggantian yang <code>equals</code> . </li><li>  Pemetaan kompresi.  Seperti pada contoh dengan <code>int -&gt; boolean</code> atas.  Jika kita memeriksa nilai 0 dan 1, maka kita akan melihat perubahan.  Tetapi jika pada usia 40 dan 42, maka kedua kali kita menjadi kenyataan. </li><li>  Mungkin ada konverter kompleks di getter yang mengandalkan invarian tertentu di bidang (misalnya, format string khusus).  Dan pada data yang kami hasilkan, mereka akan memberikan pengecualian. </li></ol><br><p>  Jadi secara umum, opsi ini juga tidak berfungsi. </p><br><p>  Dalam proses membahas semuanya, pada awalnya saya bercanda mengucapkan ungkapan "baiklah, nafig, lebih mudah untuk melihat bytecode, semuanya ditulis di sana."  Pada saat itu, saya bahkan tidak menyadari bahwa ide ini akan menelan saya, dan seberapa jauh segalanya akan berjalan. </p><br><a name="5"></a><br><h3 id="chast-pyataya-chto-takoe-baytkod-i-kak-on-rabotaet">  Bagian Lima  Apa itu bytecode dan bagaimana cara kerjanya </h3><br><p> <code>new #4, dup, invokespecial #5, areturn</code> <br>  Jika Anda mengerti apa yang ditulis di sini dan apa kode ini, maka Anda dapat langsung beralih ke bagian <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">selanjutnya</a> . </p><br><p>  <em>Penafian 1.</em> Sayangnya, untuk memahami cerita selanjutnya, Anda memerlukan setidaknya pemahaman dasar tentang seperti apa Java bytecode, jadi saya akan menulis beberapa paragraf tentang hal itu.  Sama sekali tidak berpura-pura menjadi lengkap. </p><br><p>  <em>Penafian 2.</em> Ini akan secara eksklusif tentang tubuh metode.  Baik tentang kumpulan konstan, atau tentang struktur kelas secara keseluruhan, atau bahkan tentang metode deklarasi sendiri, saya akan mengatakan sepatah kata pun. </p><br><p>  Hal utama yang perlu Anda pahami tentang bytecode adalah assembler ke mesin virtual Java stack.  Ini berarti bahwa argumen untuk instruksi diambil dari stack dan nilai balik dari instruksi didorong kembali ke stack.  Dari sudut pandang ini, kita dapat mengatakan bahwa bytecode ditulis dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">notasi Polandia terbalik</a> .  Selain tumpukan, metode ini juga memiliki berbagai variabel lokal.  Setelah memasukkan metode, <code>this</code> dan semua argumen dari metode ini ditulis ke dalamnya, dan variabel lokal disimpan di sana selama eksekusi.  Ini adalah contoh sederhana. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateAndReturn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> baz, String str)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) baz; result += str.length(); bar = result; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br><p>  Saya akan menulis komentar dalam format </p><br><pre> <code class="plaintext hljs"># [(&lt;local_variable_index&gt;:&lt;actual_value&gt;)*], [(&lt;value_on_stack&gt;)*]</code> </pre> <br><p>  Atas tumpukan di sebelah kiri. </p><br><pre> <code class="plaintext hljs">public int updateAndReturn(long, java.lang.String); Code: # [0:this, 1:long baz, 3:str], () 0: lload_1 # [0:this, 1:long baz, 3:str], (long baz) 1: l2i # [0:this, 1:long baz, 3:str], (int baz) 2: istore 4 # [0:this, 1:long baz, 3:str, 4:int baz], () 4: iload 4 # [0:this, 1:long baz, 3:str, 4:int baz], (int baz) 6: aload_3 # [0:this, 1:long baz, 3:str, 4:int baz], (str, int baz) 7: invokevirtual #2 // Method java/lang/String.length:()I # [0:this, 1:long baz, 3:str, 4:int baz], (length(str), int baz) 10: iadd # [0:this, 1:long baz, 3:str, 4:int baz], (length(str) + int baz) 11: istore 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], () 13: aload_0 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (this) 14: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz, this) 16: putfield #3 // Field bar:I # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (),     bar 19: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz) 21: ireturn #  int   ,      </code> </pre> <br><p>  Ada banyak instruksi.  Daftar lengkap perlu dilihat di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">bab keenam JVMS</a> , di Wikipedia ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">pengulangan</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">singkat</a> .  Sejumlah besar instruksi saling menduplikasi untuk tipe yang berbeda (misalnya, <code>iload</code> untuk int dan <code>lload</code> lama).  Juga, untuk bekerja dengan 4 variabel lokal pertama, instruksi mereka disoroti (misalnya, misalnya, ada <code>lload_1</code> dan tidak menerima argumen sama sekali, tetapi hanya <code>lload</code> , itu akan mengambil jumlah variabel lokal sebagai argumen. Dalam contoh di atas, ada <code>iload</code> sama). </p><br><p>  Secara global, kami akan tertarik pada kelompok instruksi berikut: </p><br><ol><li>  <code>*load*</code> , <code>*store*</code> - baca / tulis variabel lokal </li><li>  <code>*aload</code> , <code>*astore</code> - baca / tulis elemen array dengan indeks </li><li>  <code>getfield</code> , <code>putfield</code> - bidang baca / tulis </li><li>  <code>getstatic</code> , <code>putstatic</code> - baca / tulis bidang statis </li><li>  <code>checkcast</code> - dilemparkan di antara tipe objek.  Perlu karena  nilai yang diketik terletak pada stack dan dalam variabel lokal.  Misalnya, di atas adalah l2i untuk para pemain yang panjang -&gt; int. </li><li>  <code>invoke*</code> - pemanggilan metode </li><li>  <code>*return</code> - mengembalikan nilai dan keluar dari metode </li></ol><br><a name="6"></a><br><h3 id="chast-shestaya-glavnaya">  Bagian Enam  Rumah </h3><br><p>  Bagi mereka yang melewatkan pengantar yang begitu panjang, serta untuk mengalihkan perhatian dari masalah dan alasan asli dalam hal perpustakaan, kami merumuskan masalah lebih tepat. </p><br><blockquote>  Perlu, memiliki contoh <code>java.lang.reflect.Method</code> di tangan, untuk mendapatkan daftar semua bidang non-statis (baik objek saat ini dan semua objek bersarang) yang bacaannya (langsung atau secara transitif) akan berada di dalam metode ini. </blockquote><p>  Misalnya, untuk metode seperti itu </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>  Anda perlu mendapatkan daftar dua bidang: <code>client.defaultAccount.balance</code> dan <code>client.defaultAccount.balance</code> . </p><br><p>  Saya akan menulis, jika mungkin, solusi umum.  Tetapi di beberapa tempat Anda harus menggunakan pengetahuan tentang masalah asli untuk menyelesaikan masalah yang tidak terselesaikan, dalam kasus umum, masalah. </p><br><p>  Pertama, Anda perlu mendapatkan bytecode dari body metode itu sendiri, tetapi Anda tidak bisa melakukan ini secara langsung melalui Java.  Tapi sejak itu  Karena metode ini awalnya ada di dalam beberapa kelas, lebih mudah untuk mendapatkan kelas itu sendiri.  Secara global, saya tahu dua opsi: masuk dalam proses pemuatan kelas dan mencegat <code>byte[]</code> sudah dibaca <code>byte[]</code> sana, atau cukup menemukan file <code>ClassName.class</code> pada disk dan membacanya.  Intersepsi memuat di tingkat perpustakaan biasa tidak dapat dilakukan.  Anda harus menghubungkan javaagent atau menggunakan ClassLoader kustom.  Bagaimanapun, langkah-langkah tambahan diperlukan untuk mengkonfigurasi jvm / aplikasi, dan ini tidak nyaman.  Anda bisa melakukannya dengan lebih mudah.  Semua kelas "biasa" selalu dalam file yang sama dengan ekstensi ".class", path yang merupakan paket kelas.  Ya, itu tidak akan bekerja untuk menemukan kelas yang ditambahkan secara dinamis atau kelas yang dimuat oleh beberapa classloader kustom, tetapi kita membutuhkan ini untuk model jdbc, jadi kita dapat mengatakan dengan keyakinan bahwa semua kelas akan dikemas dalam "cara default" dalam toples.  Total: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); }</code> </pre> <br><p>  Hore, baca array byte.  Apa yang akan kita lakukan selanjutnya?  Pada prinsipnya, ada beberapa perpustakaan di Jawa untuk membaca / menulis bytecode, tetapi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">ASM</a> biasanya digunakan untuk pekerjaan tingkat paling rendah.  Karena  itu diasah untuk kinerja tinggi dan operasi on-the-fly, API pengunjung adalah yang utama di sana - asm secara berurutan membaca kelas dan menarik metode yang sesuai </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FieldVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, Object value)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{...} ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> MethodVisitor mv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> api, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodVisitor mv)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mv = mv; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, Label label)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mv != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mv.visitJumpInsn(opcode, label); } } ... }</code> </pre> <br><p>  Pengguna diundang untuk mendefinisikan kembali metode yang menarik baginya dan menulis analisis / transformasi logika sendiri di sana.  Secara terpisah, pada contoh <code>MethodVisitor</code> , saya ingin menarik perhatian pada kenyataan bahwa semua pengunjung memiliki implementasi standar melalui delegasi. </p><br><p>  Selain api utama, ada juga API Pohon di luar kotak.  Jika Core API adalah analog dari parser SAX, maka Tree API adalah analog dari DOM.  Kami mendapatkan objek di dalamnya tempat semua informasi tentang kelas / metode disimpan dan kami bisa menganalisanya sesuai keinginan dengan lompatan ke tempat mana pun.  Bahkan, api ini adalah implementasi <code>*Visitor</code> yang di dalam metode <code>visit*</code> hanya menyimpan informasi.  Hampir semua metode di sana terlihat seperti ini: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Label label)</span></span></span><span class="hljs-function"> </span></span>{ instructions.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JumpInsnNode(opcode, getLabelNode(label))); } ... }</code> </pre> <br><p>  Sekarang kita akhirnya dapat memuat metode untuk analisis. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      if (!name.equals(getterName) || !desc.equals(getterDesc)) return null; return new AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } private class AnalyzerMethodVisitor extends MethodVisitor { public AnalyzerMethodVisitor(int access, String name, String desc, String signature, String[] exceptions) { super(ASM6, new MethodNode(ASM6, access, name, desc, signature, exceptions)); } @Override public void visitEnd() { //     ,     MethodVisitor    if (methodNode != null) throw new IllegalStateException(); methodNode = (MethodNode) mv; } } }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Metode membaca kode lengkap.</b> <div class="spoiler_text"><p>  <code>MethodNode</code> tidak dikembalikan secara langsung, tetapi pembungkus dengan sepasang ext.  bidang karena  kita akan membutuhkannya nanti juga.  Titik masuk (dan satu-satunya metode publik) adalah <code>readMethod(Method): MethodInfo</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodReader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalDeclaringClassName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> classAccess, MethodNode methodNode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internalDeclaringClassName = internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.classAccess = classAccess; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.methodNode = methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInternalDeclaringClassName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> internalDeclaringClassName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> classAccess; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MethodInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method)</span></span></span><span class="hljs-function"> </span></span>{ Class&lt;?&gt; clazz = method.getDeclaringClass(); String internalClassName = getInternalName(clazz); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream is = getClassFile(clazz)) { ClassReader cr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassReader(is); AnalyzerClassVisitor cv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerClassVisitor(internalClassName, method); cr.accept(cv, SKIP_DEBUG | SKIP_FRAMES); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodInfo(internalClassName, cv.getAccess(), cv.getMethodNode()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String className; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> access; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalClassName, Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.className = internalClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(className)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.access = access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(getterName) || !desc.equals(getterDesc)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodNode(ASM6, access, name, desc, signature, exceptions)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); methodNode = (MethodNode) mv; } } } }</code> </pre> </div></div><br><p>  Saatnya melakukan analisis secara langsung.  Bagaimana cara membuatnya?  Pikiran pertama adalah untuk melihat semua instruksi <code>getfield</code> .  Setiap <code>getfield</code> secara statis mengatakan bidang mana itu dan kelas mana.  Ini dapat dianggap seperlunya semua bidang kelas kami yang ada aksesnya.  Tetapi, sayangnya, ini tidak berhasil.  Masalah pertama di sini adalah kelebihannya ditangkap. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> baz; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bar + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Foo().baz; } }</code> </pre> <br><p>  Dengan algoritma ini, kami menganggap bahwa bidang baz diperlukan, walaupun, pada kenyataannya, tidak.  Namun masalah ini masih bisa dicetak.  Tetapi apa yang harus dilakukan dengan metode? </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HasClientId obj = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.getClientId(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><p>  Jika kita mencari panggilan metode dengan cara yang sama seperti kita mencari bidang bacaan, maka kita tidak akan menemukan <code>getClientId</code> .  Karena tidak ada panggilan ke <code>Client.getClientId</code> , tetapi hanya panggilan ke <code>HasClientId.getClientId</code> .  Tentu saja, Anda dapat mempertimbangkan semua metode pada kelas saat ini, semua kacamata super dan semua antarmuka untuk digunakan, tetapi ini sudah terlalu banyak.  Jadi, Anda dapat secara tidak sengaja menangkap <code>toString</code> , dan di dalamnya ada daftar semua bidang secara umum. </p><br><p>  Selain itu, kami ingin panggilan getter pada objek bersarang berfungsi juga </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p>  Dan di sini panggilan ke metode <code>Client.getId</code> sekali tidak berlaku untuk kelas <code>Account</code> . </p><br><p>  Dengan keinginan yang kuat, Anda masih bisa memikirkan peretasan untuk kasus-kasus khusus untuk beberapa waktu, tetapi cukup cepat sampai pada pemahaman bahwa "hal-hal tidak dilakukan seperti itu" dan Anda perlu memonitor sepenuhnya alur eksekusi dan pergerakan data.        <code>getfield</code> ,      <code>this</code> ,   -   <code>this</code> .  Berikut ini sebuah contoh: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.id + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Account().id; } }</code> </pre> <br><pre> <code class="plaintext hljs">class Account { public Client client; public long test(); Code: 0: aload_0 1: getfield #2 // Field client:LClient; 4: getfield #3 // Field Client.id:J 7: new #4 // class Account 10: dup 11: invokespecial #5 // Method "&lt;init&gt;":()V 14: getfield #6 // Field id:J 17: ladd 18: lreturn }</code> </pre> <br><ul><li> <code>1: getfield</code>              <code>this</code> ,    <code>aload_0</code> . </li><li> <code>4: getfield</code> ‚Äî       ,    <code>1: getfield</code> , , ,  <code>this</code> . </li><li> <code>14: getfield</code>   .  Karena    ,       ( <code>Account</code> ),     <code>this</code> ,    ,       <code>7: new</code> . </li></ul><br><p> ,        <code>Account.client.id</code> ,  <code>Account.id</code> ‚Äî .     ,    ,       . </p><br><p>      ‚Äî    ,    ,   <code>aload_0</code>  <code>getfield</code>         <code>this</code>  , ,        . , .   .     ‚Äî    !   -,    .     <code>MethodNode</code> ,    (  ).     , ..    (//)        . </p><br><p>     : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Interpreter&lt;V&gt; interpreter)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Frame&lt;V&gt;[] analyze(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String owner, <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode m) {...} }</code> </pre> <br><p> <code>Analyzer</code>      (  <code>Frame</code> ,    )   .      ,    ,   ,  ,       //etc. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Interpreter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2, V value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends V&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value, V expected)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(V v, V w)</span></span></span></span>; }</code> </pre> <br><p>  <code>V</code> ‚Äî   ,      ,    . <code>Analyzer</code>          ,    ,           ,      . , <code>getfield</code>      ‚Äî ,    ,     . ,   <code>unaryOperation(AbstractInsnNode insn, V value): V</code> ,                 .     <code>1: getfield</code>   <code>Value</code> ,     "  <code>client</code> ,  <code>Client</code>        ",   <code>14: getfield</code>  " ‚Äî  -  ,         ". </p><br><p>       <code>merge(V v, V w): V</code> .      ,        ,    .  Sebagai contoh: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>    <code>Account.getBalance()</code>     .  - .       .   ?         <code>merge</code> . </p><br><p>        ‚Äî  <code>SuperInterpreter extends Interpreter&lt;SuperValue&gt;</code> ?  Benar    <code>SuperValue</code> .     ‚Äî       ,        .                ,           . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } }</code> </pre> <br><p>     <code>composite</code> .   ,     . ,  <code>String</code>   .         <code>String.length()</code> ,   ,       <code>name</code> ,   <code>name.value.length</code> . , <code>length</code> ‚Äî    ,   ,    <code>arraylength</code> .     ?  Tidak!          ‚Äî         . ,       ,     ,      . ,  <code>Date</code> , <code>String</code> , <code>Long</code> ,          . ,     ,      .     </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persion</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span>(converter = CustomJsonConverter.class) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PassportInfo passportInfo; }</code> </pre> <br><p>     <code>PassportInfo</code>    .     ,  .  ,  <code>composite</code>    .       . </p><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Field&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> path; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> composite; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Ref ref = (Ref) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(path, ref.path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;[this]&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + path.stream().map(Field::getName).collect(joining(<span class="hljs-string"><span class="hljs-string">"."</span></span>)) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Ref </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thisRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ref(emptyList(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ref parent, Field field, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!parent.isComposite()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field))<span class="hljs-comment"><span class="hljs-comment">//    ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.add(field); return of(new Ref(path, configuration.isCompositeField(field))); } public static Optional&lt;Ref&gt; childRef(Ref parent, Ref child) { if (!parent.isComposite()) return empty(); if (child.path.stream().anyMatch(parent.path::contains))// ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.addAll(child.path); return of(new Ref(path, child.composite)); } }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Set&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRefs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> refs; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.equals(o)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Value value = (Value) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(refs, value.refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.hashCode(), refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"("</span></span> + refs.stream().map(Object::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">","</span></span>)) + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typedValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Ref ref)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, singleton(ref)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, Value child)</span></span></span><span class="hljs-function"> </span></span>{ Type type = child.getType(); Set&lt;Ref&gt; fields = parent.refs.stream() .flatMap(p -&gt; child.refs.stream().map(c -&gt; childRef(p, c))) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, FieldInsnNode childInsn, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ Type type = Type.getType(childInsn.desc); Field child = resolveField(childInsn); Set&lt;Ref&gt; fields = parent.refs.stream() .map(p -&gt; childRef(p, child, configuration)) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mergeValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;Value&gt; values)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Type&gt; types = values.stream().map(BasicValue::getType).distinct().collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (types.size() != <span class="hljs-number"><span class="hljs-number">1</span></span>) { String typesAsString = types.stream().map(Type::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">", "</span></span>, <span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + typesAsString); } Set&lt;Ref&gt; fields = values.stream().flatMap(v -&gt; v.refs.stream()).distinct().collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(types.get(<span class="hljs-number"><span class="hljs-number">0</span></span>), fields); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value &amp;&amp; value.getType().getSort() == Type.OBJECT &amp;&amp; ((Value) value).refs.stream().anyMatch(Ref::isComposite); } }</code> </pre> </div></div><br><p>   ,    .  Ayo pergi! </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldsInterpreter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicInterpreter</span></span></span><span class="hljs-class"> </span></span>{</code> </pre> <br><p>       ,    <code>BasicInterpreter</code> .    <code>BasicValue</code> (    ,   <code>Value</code>  <code>extends BasicValue</code> )      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue UNINITIALIZED_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue INT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.INT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue FLOAT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.FLOAT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue LONG_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.LONG_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue DOUBLE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.DOUBLE_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue REFERENCE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.getObjectType(<span class="hljs-string"><span class="hljs-string">"java/lang/Object"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue RETURNADDRESS_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.VOID_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Type type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.type = type; } }</code> </pre> <br><p>         ( <code>(Value)basicValue</code> )  ,          ,     ( " <code>iconst</code>  ")  . </p><br><p>   <code>newValue</code> .       ,       ,  " ".   , <code>this</code>     <code>catch</code> .  ,     ,     .    <code>BasicInterpreter</code>  <code>BasicValue(actualType)</code>   <code>BasicValue.REFERENCE_VALUE</code> .       . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; type.getSort() == OBJECT) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.newValue(type); }</code> </pre> <br><p>  entry point.      <code>this</code> . ,  - ,  ,   <code>this</code> ,     <code>BasicValue(actualType)</code> ,  <code>Value.typedValue(actualType, Ref.thisRef())</code> . ,     ,   <code>this</code>    <code>newValue</code> ,     .       , ..         ,   <code>this</code> .     <code>this</code>    . ,  . ,     <code>this</code>       0.       ,      .   ,            ,  .             . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wasUpdated || insn.getType() != VAR_INSN || ((VarInsnNode) insn).<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ALOAD: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typedValue(value.getType(), thisRef()); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ISTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ASTORE: wasUpdated = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); }</code> </pre> <br><p>  .    .    ,   ,    ,   ‚Äî ,   .   ,    . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue v, BasicValue w)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v.equals(w)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value || w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Objects.equals(v.getType(), w.getType())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v == UNINITIALIZED_VALUE || w == UNINITIALIZED_VALUE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UNINITIALIZED_VALUE; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + v + <span class="hljs-string"><span class="hljs-string">" and "</span></span> + w); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value != w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> w; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(asList((Value) v, (Value) w)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.merge(v, w); }</code> </pre> <br><p>    .      ""?         ?  Tidak juga.          .        , ..       . ,      3 (       ): <code>putfield</code> , <code>putstatic</code> , <code>aastore</code> .    .     <code>putstatic</code> (   )    .     ,          .    <code>putfield</code>  <code>aastore</code> .   ,           ,      .   (  )              .            ,             . ,    ‚Äî      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>    ,        ( <code>ofNullable</code>    <code>Optional</code>  <code>client</code>      <code>value</code> ),         . .     . ,         - <code>ofNullable(client)</code> ,    - <code>map(Client::getId)</code> ,    . </p><br><p>        <code>putfield</code> , <code>putstatic</code>  <code>aastore</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == PUTFIELD &amp;&amp; Value.isComposite(value2)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value2 + <span class="hljs-string"><span class="hljs-string">" over putfield"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.binaryOperation(insn, value1, value2); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2, BasicValue value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == AASTORE &amp;&amp; Value.isComposite(value3)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value3 + <span class="hljs-string"><span class="hljs-string">" over aastore"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.ternaryOperation(insn, value1, value2, value3); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PUTSTATIC: { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value + <span class="hljs-string"><span class="hljs-string">" over putstatic"</span></span>); } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>   .       <code>checkcast</code> .          :      .  ‚Äî    </p><br><pre> <code class="java hljs">Client client1 = ...; Object objClient = client1; Client client2 = (Client) objClient;</code> </pre> <br><p>         ,        .         ,   ,       <code>client1</code>  <code>objClient</code> ,   . ,   <code>checkcast</code>          . </p><br><p>     . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;?&gt; list; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trimToSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ((ArrayList&lt;?&gt;) list).trimToSize(); } }</code> </pre> <br><p>      .       ,      ,  ,     .  ,   ,         ,        ,    ,     .          ?  , !       .   ,          ,  ,              null/0/false.    .   ‚Äî   </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>    ,       , ORM      ,    .       <code>checkcast</code> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CHECKCAST: { Class&lt;?&gt; original = reflectClass(value.getType()); Type targetType = getObjectType(((TypeInsnNode) insn).desc); Class&lt;?&gt; afterCast = reflectClass(targetType); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (afterCast.isAssignableFrom(original)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"type specification not supported"</span></span>); } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>     ‚Äî <code>getfield</code> .      ‚Äî   ? </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Foo child; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Foo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Foo loopedRef = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ThreadLocalRandom.current().nextBoolean()) { loopedRef = loopedRef.child; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> loopedRef; } }</code> </pre> <br><p> ,        .     ? <code>child</code> , <code>child.child</code> , <code>child.child.child</code> ?  ? ,       .  ,        .       , </p><br><blockquote>           null. </blockquote><p>        child,       null, , ,     .        <code>Ref.childRef</code>  </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty();</code> </pre> <br><p>    .       ,    . </p><br><p>       "  ".          .   ,           . ,   ,       ( <code>@JdbcJoinedObject</code> ,  <code>@JdbcColumn</code> ),      ,    . ORM        . </p><br><p> ,   <code>getfield</code>           ,     .     ,   ,     ,      .  ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> GETFIELD: { Optional&lt;Value&gt; optionalFieldValue = childValue((Value) value, (FieldInsnNode) insn, configuration); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!optionalFieldValue.isPresent()) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; Value fieldValue = optionalFieldValue.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configuration.isInterestingField(resolveField((FieldInsnNode) insn))) { context.addUsedField(fieldValue); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(fieldValue)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldValue; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>    .  ,    , .   ,    <code>invoke*</code> .         , ,   ,        .  , : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getClient().getId(); }</code> </pre> <br><p>  ,      ,     .           ,   .    .      ,          .    ?          .    .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Client </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } }</code> </pre> <br><p>  <code>Account.client</code>          .   ,      .        .    ‚Äî        ,     . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Result</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Value&gt; usedFields; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Value returnedCompositeValue; }</code> </pre> <br><p>    ?  ,   .          .  , ..      (  ,   ‚Äî  ),   ,       <code>areturn</code> , ,   ,    <code>*return</code> .  <code>MethodNode</code> ( ,     Tree API)       .     .  ‚Äî          . ,             ?      .         . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReturnedCompositeValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Frame&lt;BasicValue&gt;[] frames, AbstractInsnNode[] insns)</span></span></span><span class="hljs-function"> </span></span>{ Set&lt;Value&gt; resultValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; insns.length; i++) { AbstractInsnNode insn = insns[i]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ARETURN: BasicValue value = frames[i].getStack(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { resultValues.add((Value) value); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resultValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(resultValues); }</code> </pre> <br><p>    <code>analyzeField</code>   </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyzeField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Modifier.isNative(method.getModifiers())) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not analyze native method "</span></span> + method); MethodInfo methodInfo = readMethod(method); MethodNode mn = methodInfo.getMethodNode(); String internalClassName = methodInfo.getInternalDeclaringClassName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess = methodInfo.getClassAccess(); Context context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(method, classAccess); FieldsInterpreter interpreter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldsInterpreter(context, configuration); Analyzer&lt;BasicValue&gt; analyzer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Analyzer&lt;&gt;(interpreter); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { analyzer.analyze(internalClassName, mn); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (AnalyzerException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } Frame&lt;BasicValue&gt;[] frames = analyzer.getFrames(); AbstractInsnNode[] insns = mn.instructions.toArray(); Value returnedCompositeValue = getReturnedCompositeValue(frames, insns); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Result(context.getUsedFields(), returnedCompositeValue); }</code> </pre> <br><p>   , -,     . <code>invoke*</code> .      5 : </p><br><ol><li> <code>invokespecial</code> ‚Äî      .    ,  ,   (     <code>super.call()</code> ). </li><li> <code>invokevirtual</code> ‚Äî     .          . ,        . </li><li> <code>invokeinterface</code> ‚Äî   ,   <code>invokevirtual</code> ,    ‚Äî      . </li><li> <code>invokestatic</code> ‚Äî    </li><li> <code>invokedynamic</code> ‚Äî  ,   7    JSR 292.          JVM,   <code>invokedynamic</code>       (     dynamic).   ,          (+  ),        .  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">Invokedynamic:   ?</a>  . </li></ol><br><p>  ,      ,       ,      .  <code>invokedynamic</code>   ,   .  ,      ,       ,     (,       ),   <code>invokedynamic</code>  .   ,   ""  .  ,         <code>invokedynamic</code> ,      . </p><br><p>  . ,         .  ,        . ,      <code>this</code> ,     0? ,    - ,         <code>FieldsInterpreter</code>   <code>copyOperation</code>     .  ,    <code>MethodAnalyzer.analyzeFields</code>    "     <code>this</code> "  "      " ( <code>this</code> ‚Äî  ).     ,   .   ,   ,  .          ,               - .    ,         (- <code>Optional.ofNullable(client)</code> ).             . </p><br><p> , <code>invokestatic</code>   (..   ,  <code>this</code>   ).  <code>invokespecial</code> , <code>invokevirtual</code>  <code>invokeinterface</code> .  ,         .  ,      ,     jvm.  <code>invokespecial</code>  ,               ,     .    <code>invokevirtual</code>  <code>invokeinterface</code> .   ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objectToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.toString(); }</code> </pre> <br><pre> <code class="plaintext hljs">public static java.lang.String objectToString(java.lang.Object); Code: 0: aload_0 1: invokevirtual #104 // Method java/lang/Object.toString:()Ljava/lang/String; 4: areturn</code> </pre> <br><p> , ,    ( )  . ,       ,    .            ?        <em>  ORM</em> .  ORM   ,            ,     .      <code>invokevirtual</code>  <code>invokeinterface</code>   . </p><br><p>  Hore!   .  Apa selanjutnya      ,        (         ,     <code>this</code>  ),     ( ,    )       .  ! </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends BasicValue&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ Method method = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Value methodThis = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESPECIAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEVIRTUAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEINTERFACE: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>))) { MethodInsnNode methodNode = (MethodInsnNode) insn; Class&lt;?&gt; objectClass = reflectClass(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getType()); Method interfaceMethod = resolveInterfaceMethod(reflectClass(methodNode.owner), methodNode.name, getMethodType(methodNode.desc)); method = lookupInterfaceMethod(objectClass, interfaceMethod); methodThis = (Value) values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); } List&lt;?&gt; badValues = values.stream().skip(<span class="hljs-number"><span class="hljs-number">1</span></span>).filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESTATIC: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEDYNAMIC: { List&lt;?&gt; badValues = values.stream().filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { MethodAnalyzer.Result methodResult = analyzeFields(method, configuration); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Value usedField : methodResult.getUsedFields()) { childValue(methodThis, usedField).ifPresent(context::addUsedField); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodResult.getReturnedCompositeValue() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Optional&lt;Value&gt; returnedValue = childValue(methodThis, methodResult.getReturnedCompositeValue()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (returnedValue.isPresent()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnedValue.get(); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.naryOperation(insn, values); }</code> </pre> <br><p>         .    ,      .  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">  JVMS</a>      1  1.            .   ‚Äî    .  ,   ,        .   ,     ..     ,   -    ,       2  ‚Äî   .         ,   ,       .   ,   ‚Äî .    ,   <a href="" rel="nofollow">ResolutionUtil</a>  <a href="" rel="nofollow">LookupUtil</a> . </p><br><p> ! </p><br><a name="7"></a><br><h3 id="chast-sedmaya-chto-esche-mozhno-dodelat">  .     </h3><br><p>  ,   80%   20%     20%   80% . ,     ,    ,   ? </p><br><ul><li><p>        .          . </p><br></li><li><p>       .    (..        ),        . ,    .        ,      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>     <code>Optional</code> ,   <code>ofNullable</code>     <code>getClientId</code>  ,  ,      <code>value</code>    .  ,        <code>returnedCompositeValue</code> ‚Äî  ,   ,     . , ,        (  )               ,  .        -.          ,    ,    ,  "  <code>value</code>  <code>Optional@1234</code>  <code>Client@5678</code> "   . </p><br></li><li><p>  <code>invokedynamic</code> ,     .    indy      ,      .    ,          . ,     .  ,         invokedynamic.     .    . ,           <code>java.lang.invoke.LambdaMetafactory.metafactory</code> .    ,  ,   ,      .    <code>java.lang.invoke.StringConcatFactory.makeConcat/makeConcatWithConstants</code> .     .          <code>toString()</code> . , ,  ,  ,  .    ,     ,   ,  /-     .            jvm,      .    ,  ,  .             .    .   ,  ,               .          indy .    ?     indy    ,     ‚Äî <code>CallSite</code> .           . , ,    <code>LambdaMetafactory.metafactory</code>       <code>getValue</code> ,         .       <code>getValue</code> .     (  )  .  , , ,   stateless. ,    !    -    ,      .  <code>CallSite</code>   <code>ConstantCallSite</code> , <code>MutableCallSite</code>  <code>VolatileCallSite</code> .    mutable  volatile   ,       ,   <code>ConstantCallSite</code>  .         "-   ". ,  ,    .    ,         VM,       . </p><br></li></ul><br><a name="8"></a><br><h3 id="posleslovie">  Kata penutup </h3><br><p> - ,   .   -  <code>partialGet</code>     . ,    .   ,   ,       ,         ,   " "   . </p><br><p>  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id409043/">https://habr.com/ru/post/id409043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id409033/index.html">Superkluster tersembunyi dapat memecahkan misteri Bima Sakti</a></li>
<li><a href="../id409035/index.html">Akhirnya, kita berurusan dengan derajat: penyebab kecelakaan Frigate</a></li>
<li><a href="../id409037/index.html">Pemindai 3D Generasi Baru EinScan-SE</a></li>
<li><a href="../id409039/index.html">PocketBook-2017: ingat tahun lalu dan rangkum</a></li>
<li><a href="../id409041/index.html">Eksekusi tidak dapat diampuni: kami menangani tanda baca dalam bahasa Inggris</a></li>
<li><a href="../id409045/index.html">Koneksi rahasia matematika dan fisika murni terungkap</a></li>
<li><a href="../id409047/index.html">Peluncuran kembali kapsul tahap pertama dan kargo bekas ke ISS. NASA tidak keberatan</a></li>
<li><a href="../id409049/index.html">FDA Menyetujui Terapi Gen Pertama Penyakit Genetik Langsung</a></li>
<li><a href="../id409051/index.html">Dmitry Muromtsev (ITMO) - tentang pemodelan ontologis dan pembentukan kecerdasan percakapan</a></li>
<li><a href="../id409053/index.html">Meluncurkan copter - mendapat denda</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>