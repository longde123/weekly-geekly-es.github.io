<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✨ ♐️ 🛍️ Bagaimana kami menerjemahkan proyek lawas ke GraphQL 🛀🏿 🏏 👩🏾‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hai, Habr. Nama saya Anton Potapov, saya adalah pengembang iOS di FINCH . Hari ini saya ingin berbicara secara rinci tentang bagaimana menerjemahkan p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana kami menerjemahkan proyek lawas ke GraphQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470529/">  Hai, Habr.  Nama saya Anton Potapov, saya adalah pengembang iOS di <b>FINCH</b> .  Hari ini saya ingin berbicara secara rinci tentang bagaimana menerjemahkan proyek seluler ke GraphQL, menjelaskan pro dan kontra dari pendekatan ini.  Mari kita mulai. <br><br><a name="habracut"></a><h2>  Pengantar singkat </h2><br>  "Warisan."  Saya pikir semua orang mendengar kata mengerikan ini, dan sebagian besar bertemu muka dengannya.  Karenanya, Anda tidak perlu memberi tahu betapa sulitnya mengintegrasikan fitur baru dan hebat ke dalam proyek Anda. <br><br><img src="https://habrastorage.org/webt/6h/yg/iv/6hygivxon0dryjghitf1fu3zhh0.jpeg" alt="gambar"><br><br>  Salah satu proyek kami adalah aplikasi untuk perusahaan lotre besar (saya tidak bisa memberi nama sejak NDA).  Baru-baru ini, saya perlu menerjemahkannya ke GraphQL tanpa kehilangan akal. <br><br>  Proyek ini sangat besar - pada pandangan pertama, perlu menghabiskan setidaknya 200-300 jam, tetapi ini melampaui semua kemungkinan sprint dua minggu.  Kami juga tidak dapat mengalokasikan seluruh sprint hanya untuk satu tugas, karena ada juga fitur samping, yang tidak kalah pentingnya dari GraphQL. <br>  Kami sudah lama berpikir apa yang harus dilakukan dan memutuskan untuk menerjemahkan proyek langkah demi langkah, model demi model.  Dengan pendekatan ini, transisi akan mulus, dan 200-300 jam akan didistribusikan dalam beberapa sprint. <br><br><h2>  Poin teknis </h2><br>  Untuk mengerjakan proyek, saya menggunakan perpustakaan Apollo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sudah ada artikel tentang Habré</a> yang menjelaskan semua seluk-beluk bekerja dengannya, jadi saya tidak akan mengulanginya lagi.  Saya memperingatkan Anda sebelumnya - bekerja dengan model yang dihasilkan kode tidak terlalu nyaman dan lebih baik menyimpannya sebagai "jaringan".  Setiap entitas berisi __typename: bidang String, yang, anehnya, mengembalikan nama jenis. <br><br><h2>  Dekomposisi tugas </h2><br>  Hal pertama yang harus dilakukan adalah menentukan model Legacy mana yang akan kami terjemahkan ke dalam GraphQL.  Dalam kasus saya, logis untuk menerjemahkan salah satu model GameInfo besar, dan DrawInfo tertanam di dalamnya. <br><br><ul><li>  GameInfo - berisi informasi tentang permainan lotere dan undian. </li><li>  DrawInfo - berisi data tentang sirkulasi </li></ul><br>  Setelah menyelesaikan pilihan, saya memutuskan untuk menginisialisasi model lama dengan yang baru diperoleh dengan GraphQL.  Dengan pendekatan ini, tidak perlu mengganti bagian-bagian aplikasi di mana model lama digunakan.  Menyelesaikan model sebelumnya sepenuhnya berisiko - bukan fakta bahwa proyek akan bekerja seperti sebelumnya, dan itu akan memakan waktu terlalu banyak. <br><br>  Secara total, ada tiga tahap implementasi GraphQL: <br><br><ul><li>  Ciptaan pelanggan; </li><li>  Membuat penginisialisasi untuk model Legacy; </li><li>  Mengganti permintaan API dengan GraphQL. </li></ul><br><h2>  GraphQLClient </h2><br>  Seperti halnya klien mana pun, GraphQLClient harus memiliki metode pengambilan, setelah itu akan memuat data yang kami butuhkan. <br><br>  Menurut pendapat saya, metode mengambil untuk GraphQLClient harus mengambil enum, berdasarkan permintaan yang sesuai akan dieksekusi.  Pendekatan ini akan memungkinkan kita untuk dengan mudah menerima data untuk entitas yang diinginkan atau bahkan layar.  Jika permintaan menerima parameter, maka mereka akan diteruskan sebagai nilai terkait.  Dengan pendekatan ini, lebih mudah menggunakan GraphQL dan membuat kueri yang fleksibel. <br><br><pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraphQLRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> image(<span class="hljs-type"><span class="hljs-type">ImageId?</span></span>) }</code> </pre> <br>  Klien GraphQL kami yang disesuaikan harus mengandung ApolloClient yang dikustomisasi untuk fitur yang ada, serta metode pengambilan pemuatan yang disebutkan di atas. <br><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-function">&lt;Response&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(requestType: GraphQLRequest, completion: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(QLRequestResult&lt;Response&gt;)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)</code> </pre> <br>  Apa itu QLRequestResult?  Itu biasa <br><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">QLRequestResult</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Response</span></span>&gt; = <span class="hljs-type"><span class="hljs-type">Result</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Response</span></span>, <span class="hljs-type"><span class="hljs-type">APIError</span></span>&gt;</code> </pre> <br>  Metode pengambilan memungkinkan Anda untuk mengakses klien melalui protokol dan melakukan pergantian pada requestType.  Bergantung pada requestType, Anda dapat menggunakan metode pemuatan pribadi terkait, tempat Anda dapat mengonversi model yang dihasilkan ke yang lama.  Sebagai contoh: <br><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchGameInfo</span></span></span><span class="hljs-function">&lt;Response&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gameId: String? = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, completion: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(QLRequestResult&lt;Response&gt;)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   Apollo  let query = GetLotteriesQuery(input: gameId) //       apolloClient.fetch(query: query, cachePolicy: .returnCacheDataAndFetch, queue: .global()) { result in switch result { case .success(let response): guard let gamesQL = response.data?.games, let info = gamesQL.info else { completion(.failure(.decodingError)) return } //    let infos: [Games.Info] = info.compactMap({ gameInfo -&gt; Games.Info? in guard let gameIdRaw = gameInfo?.gameId, let gameId = GameId(rawValue: gameIdRaw), let bonusMultiplier = gameInfo?.bonusMultiplier, let maxTicketCost = gameInfo?.maxTicketCost, let currentDraws = gameInfo?.currentDraws else { return nil } let currentDrawsInfo = Games.Info.CurrentDrawsInfo(currntDraw: currentDraws) let gameInfo = Games.Info(gameId: gameId, bonusMultiplier: bonusMultiplier, maxTicketCost: maxTicketCost, currentDraws: currentDrawsInfo) return gameInfo }) //    let games = Games(info: infos) guard let response = games as? Response else { completion(.failure(.decodingError)) return } completion(.success(response)) case .failure(let error): … } } }</span></span></code> </pre> <br>  Hasilnya, kami mendapatkan model lama yang sudah jadi yang diperoleh dari GraphQL. <br><br><h2>  Jenis skalar </h2><br>  Dalam dokumentasi GraphQL, tipe skalar dijelaskan sebagai berikut: "Tipe skalar adalah pengidentifikasi unik yang sering digunakan untuk memilih ulang objek atau sebagai kunci untuk cache."  Untuk cepat, tipe skalar dapat dengan mudah dikaitkan dengan typealias. <br><br>  Saat menulis klien, saya mengalami masalah bahwa dalam skema saya ada jenis skalar Long, yang pada dasarnya <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Long</span></span> = <span class="hljs-type"><span class="hljs-type">Int64</span></span></code> </pre> <br>  Semuanya akan baik-baik saja, tetapi Apollo secara otomatis melemparkan semua skalar pengguna ke String, yang menyebabkan crash.  Saya memecahkan masalah seperti ini: <br><br><ul><li>  Saya menambahkan skrip codegen –passthroughCustomScalars </li><li>  Membuat file terpisah untuk typealias </li><li>  Ditambahkan ke file <br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Long</span></span> = <span class="hljs-type"><span class="hljs-type">Int64</span></span></code> </pre> </li></ul><br>  Di masa depan, untuk setiap jenis skalar, Anda perlu menambahkan typealias baru.  Dengan Apollo versi 14.0, mereka menambahkan "dukungan untuk skal khusus Int."  Jika Anda ingin menghindari menggunakan pendekatan ini dan bendera di codegen, maka periksa solusi untuk masalah ini di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apollo git</a> . <br><br><h2>  Pro dan kontra </h2><br>  Mengapa pendekatan ini bagus?  Transisi yang cukup cepat untuk menggunakan GraphQL, mengenai pendekatan dengan menghapus semua model lama. <br><br>  Di masa depan, ketika kita perlu mendapatkan data untuk layar / model apa pun, kita dapat beralih ke GraphQLClient dan mendapatkan data yang diperlukan. <br><br>  Dari minus: <br><br><ul><li>  Mengkonversi jenis model di klien, seseorang dapat mentransfer ke entitas lain sejak itu  bekerja dengan data bukan tanggung jawab klien. </li><li>  Grafik LuasQLClient.  Setelah menambahkan kueri baru, kelas kami akan tumbuh semakin besar.  Salah satu solusinya adalah ekstensi di mana metode pemuatan akan dijelaskan, yang saya bicarakan di bab GraphQLClient. </li></ul><br><h2>  Kesimpulan </h2><br>  Secara umum, beralih ke GraphQL bisa cepat dan tidak menyakitkan dengan klien yang ditulis dengan baik.  Butuh waktu sekitar tiga hari = 24 jam kerja.  Selama waktu ini, saya berhasil membuat klien, menerjemahkan model dan membuat kembali model GameInfo.  Pendekatan yang diuraikan bukanlah obat mujarab, tetapi murni keputusan saya, dilaksanakan dalam waktu singkat. <br><br>  Jika Anda memiliki guru GraphQL di antara Anda, saya sarankan berbagi pengalaman Anda dan mengatakan betapa nyamannya menggunakan GraphQL + Apollo dalam proyek-proyek besar.  Atau apakah gamenya tidak bernilai lilin? <br><br>  Terima kasih atas perhatian anda! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id470529/">https://habr.com/ru/post/id470529/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id470515/index.html">Satu langkah kecil untuk penguji: 10 laporan teratas dari Heisenbug 2019 Piter</a></li>
<li><a href="../id470517/index.html">EP Rusia untuk yang terkecil</a></li>
<li><a href="../id470519/index.html">Pengalaman membangun rakitan Linux untuk pembaruan papan tunggal dengan dukungan</a></li>
<li><a href="../id470521/index.html">Dirilis 3CX V16 Pembaruan 3 dan aplikasi seluler 3CX baru untuk Android</a></li>
<li><a href="../id470525/index.html">Windows di browser tanpa registrasi dan SMS - ikhtisar klien HTML5 RDP</a></li>
<li><a href="../id470531/index.html">Neurofisiologis membahas proyek Neuralink dan berbicara tentang kerja otak “dengan jari”</a></li>
<li><a href="../id470535/index.html">Cara Membuat Grafik Batang Menggunakan Python</a></li>
<li><a href="../id470537/index.html">Paket validasi baru untuk Bereaksi pada Mobx @ quantumart / mobx-form-validation-kit</a></li>
<li><a href="../id470541/index.html">Dasar-dasar bekerja dengan Neo4j di browser</a></li>
<li><a href="../id470543/index.html">Bagaimana kami menempatkan manajemen infrastruktur di Terraform - dan mulai hidup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>