<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛀🏽 🌼 👲🏿 我的物联网：Guest Castle（第2部分） ↕️ ✉️ 👨‍👩‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="嗨，GT！一切与过去和过去！
 我继续讲述如何将门锁连接到互联网的故事。从这里开始。
 非常感谢大家的评论。确实有现成的解决方案，但是也有许多细微之处使我无法使用它们。公寓仍然不是酒店，因此我们立即撤消了专门的酒店城堡。钥匙锁，NFC天线，以免吓到邻居，我们也不考虑。不能使用卡，令牌或其他物理介质，...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我的物联网：Guest Castle（第2部分）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/382677/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">嗨，GT！一切与过去和过去！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我继续讲述如何将门锁连接到互联网的故事。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从这里开始</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非常感谢大家的评论。确实有现成的解决方案，但是也有许多细微之处使我无法使用它们。公寓仍然不是酒店，因此我们立即撤消了专门的酒店城堡。钥匙锁，NFC天线，以免吓到邻居，我们也不考虑。不能使用卡，令牌或其他物理介质，可以理解的是，在客人打开门之前，无法将其转移给客人。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
无法使用Kevo，August或Lockitron，因为它们基于美式锁（死锁），这种锁不能很好地安装在65-70毫米厚的钢门上。我们的选择是用于装甲门的机电式CISA，价格约为500欧元（尚未购买，因为价格昂贵）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最重要的是，我想用自己的双手做些事情，而不是为了爱好而自私。</font></font><br>
<img src="https://habrastorage.org/files/12f/2b5/6a3/12f2b56a3cae496d9f3717839e37cea1.JPG"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我提醒您，锁控制器位于本地家庭网络中NAT的深处，因此在Arduin上建立Web服务器是没有意义的；无法从Internet到达它。该服务器使用Twisted框架以Python编写，在另一个具有真实IP地址的地方在Linux上运行，控制器连接到该服务器并等待命令。</font></font><br>
<img src="https://habrastorage.org/files/c3a/803/92b/c3a80392b83f4a0382e764ad8afa142e.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我想谈谈工作和加密的逻辑。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我没有找到对Arduina的流量进行加密的内容，因为城堡和服务器之间的通信将通过未加密流量的开放通道进行。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在第一个原型中，我使用了MD5，现在将其更改为SHA-1，在此</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cryptosuite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库中</font><font style="vertical-align: inherit;">。它消耗更少的内存，并且已经有现成的HMAC功能。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
密钥是最多30个ASCII字符的密码，存储在控制器的EEPROM存储器中。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在第一个原型中，相同的密码已明确存储在服务器上，这当然不是安全的。第二个原型需要两个密码。第一种是在连接到服务器时对锁进行身份验证，您无法使用此密码打开锁，这是必需的，以便只有正确的锁才能连接到服务器。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
锁连接到服务器，并首先告诉它其标识符。服务器在数据库中检查是否存在这样的锁，如果存在，它会发送一个随机生成的ASCII序列作为响应。锁使用密码“签名”它，然后将哈希发送回去。服务器将接收到的哈希值与其自己计算出的哈希值进行比较，如果它们匹配，它将授权连接的控制器为“锁”。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
否则，将重置连接。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二个密码已经是一个数字密钥；它没有存储在服务器上。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它的工作方式如下：用户应用程序通过服务器上的SOAP函数进行调用，指示锁的ID和他要发送给他的命令。结果，该函数返回请求ID。服务器将此命令转发给控制器，控制器发送随机生成的ASCII序列作为响应，并等待“正确”响应几秒钟。接下来，用户应用程序需要通过相同的SOAP（通过请求ID）从服务器获取它，并使用数字密钥对其进行签名并发回。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
控制器将接收到的哈希与自己计算的哈希进行比较，如果匹配，它将执行先前接收的命令，并报告给服务器。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
确认命令的时间限制为2秒，如果在此期间未收到任何响应，则控制器将忽略先前收到的命令。如果哈希值不匹配，该命令也将被忽略。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我试图保护自己免受“中间人”攻击，这很容易安排在提供者的网络上。那里的连接很简单，没有密码和证书，足以在屏蔽层中剪断双绞线，将其挤压在两侧，使用命令服务器的IP地址从公寓一侧将其插入网络，在另一端模拟锁（我还在python上编写了用于仿真的脚本以进行调试），通过窃听方式安排了这种“防火墙”。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就此而言，我认为城堡受到了相当大的保护。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
即使入侵命令服务器并使用密码进行锁授权来窃取其数据库也不会造成太大麻烦，因为它们无法打开锁。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它仍然只与客人打交道。这些是第一篇文章中的6-8号要求。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
键盘，代理，RFID和NFC都不是一种选择，上面写道了原因。但是几乎每个人都拥有智能手机，并且所有智能手机都具有蓝牙，因此选择显而易见！</font></font><br>
<img src="https://habrastorage.org/files/d2a/1bd/1b0/d2a1bd1b0a2a4f81a906fba3e2640b5e.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在第一个原型中，访客与一个访问代码相关联。在此代码的服务器数据库中，存储了锁的ID，访客访问开始和结束的日期和时间，以及访客可读的名称的文本字段。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
访客接近锁，在其智能手机上启动移动应用程序，它通过蓝牙将访问代码发送到控制器，一条消息从控制器到达服务器，表明访客已使用某个访问代码来联系他。服务器根据数据库检查它，如果正确的访客在正确的时间在正确的位置到达，则发送命令以打开锁。实际上，访客将发送一个带有“临时标记”（Unix时间的字符串表示形式，除以30，除掉小数部分）签名的HMAC哈希，而不是明确的访问代码。验证服务器向数据库发出请求，并选择给定锁的所有当前有效访问代码，然后对其进行遍历并为它们计算相似的HMAC，如果找到匹配项，则发送打开命令，如果对访问码的搜索在找到匹配项之前结束，则将尝试打开锁的否定响应发送给锁。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
问题在于，用于这种授权的数字密钥必须存储在服务器上。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我不得不使第二个原型的“来宾”授权复杂化。访客访问代码现在由两个键组成，我们称它们为“服务器”和“私有”。服务器需要在服务器上建立来宾帐户，而私有则需要自己打开锁。服务器机房将被明确地存储在服务器上，而从私有机房仅将有一个哈希，而不是简单的哈希，而是一个具有数字锁的HMAC。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，来宾授权会话如下所示：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.来宾应用程序将“服务器”密钥传递给控制器​​（如第一个原型中的其哈希），并且</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.服务器以相同方式进行检查，但不是打开命令发送私钥的哈希</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.控制器将从服务器接收到的私钥的哈希值与独立计算的哈希值进行比较，如果匹配，则打开锁。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，服务器不存储任何可能打开锁的内容。如果不知道数字密钥，将无法生成所需的哈希。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
相同的蓝牙也可用于没有Internet的“主”访问。控制器通过它接收命令，并以一次性代码响应，该代码必须用正确的数字键签名2秒钟。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过它，我想进行控制器的基本设置。</font><font style="vertical-align: inherit;">所有者按下控制器上的特殊按钮，然后开始接受扩展的命令集，例如设置锁定ID，秘密密钥，服务器端口地址，网络设置等。</font><font style="vertical-align: inherit;">但是在Adruin中，内存用完了，草图不适合。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，简短演示了这项工作。</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://www.youtube.com/embed/dfSnXt631KQ%3Ffeature%3Doembed&amp;usg=ALkJrhil194PbVI-VMjx5M4mix2neIsD8g" frameborder="0" allowfullscreen=""></iframe></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN382677/">https://habr.com/ru/post/zh-CN382677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN382665/index.html">电子邮件营销的策略和策略。第1部分</a></li>
<li><a href="../zh-CN382667/index.html">英特尔宣布首款至强笔记本处理器</a></li>
<li><a href="../zh-CN382669/index.html">清洁工。打击不洁软件</a></li>
<li><a href="../zh-CN382673/index.html">爱宝机器狗死亡率</a></li>
<li><a href="../zh-CN382675/index.html">过去的巨大树懒可能会铺设地铁线路</a></li>
<li><a href="../zh-CN382679/index.html">天文学家能够获得木星卫星艾奥表面上的熔岩湖的照片</a></li>
<li><a href="../zh-CN382681/index.html">Soyuz接触ISS的5个小时-YouTube上半分钟的视频</a></li>
<li><a href="../zh-CN382685/index.html">超越视野</a></li>
<li><a href="../zh-CN382687/index.html">欧洲核子研究中心的科学家正在准备“力场”以保护宇航员免受辐射</a></li>
<li><a href="../zh-CN382689/index.html">我们控制公寓的照明（NooLite，Raspberry Pi和WebIOPi）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>