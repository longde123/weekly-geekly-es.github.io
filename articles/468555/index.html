<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏱️ 👙 👩🏼‍🚒 Introducción a los ensambles deterministas en C / C ++. Parte 2 🚁 🙏🏿 🚂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La traducción del artículo fue preparada especialmente para estudiantes del curso "Desarrollador C ++" . 



 → Leer la primera parte 


 La informaci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Introducción a los ensambles deterministas en C / C ++. Parte 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/468555/">  <i>La traducción del artículo fue preparada especialmente para estudiantes del curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Desarrollador C ++"</a> .</i> <br><br><img src="https://habrastorage.org/webt/it/uw/84/ituw84r955lsxlndkmfl5ggbahi.png"><br><br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Leer la primera parte</a> <br><br><hr><a name="habracut"></a><br><h3>  La información de la carpeta de ensamblaje se distribuye en archivos binarios. </h3><br>  Si los mismos archivos fuente se compilan en diferentes carpetas, a veces la información de la carpeta se transfiere a archivos binarios.  Esto puede suceder principalmente por dos razones: <br><br><ul><li> Usar macros que contienen información sobre el archivo actual, como la macro <code>__FILE__</code> . </li><li>  Cree binarios de depuración que almacenen información sobre dónde están las fuentes. </li></ul><br>  Continuando con nuestro ejemplo de hello world en MacOS, dividamos la fuente para que podamos mostrar el efecto de la ubicación en los binarios finales.  La estructura del proyecto será similar a la siguiente. <br><br><pre> <code class="cpp hljs">. ├── run_build.sh ├── srcA │ ├── CMakeLists.txt │ ├── hello_world.cpp │ ├── hello_world.hpp │ └── main.cpp └── srcB ├── CMakeLists.txt ├── hello_world.cpp ├── hello_world.hpp └── main.cpp</code> </pre> <br>  Recopilemos nuestros archivos binarios en modo de depuración. <br><br><pre> <code class="cpp hljs">cd srcA/build cmake -DCMAKE_BUILD_TYPE=Debug .. make cd .. &amp;&amp; cd .. cd srcB/build cmake -DCMAKE_BUILD_TYPE=Debug .. make cd .. &amp;&amp; cd .. md5sum srcA/build/hello md5sum srcB/build/hello md5sum srcA/build/CMakeFiles/HelloLib.dir/hello_world.cpp.o md5sum srcB/build/CMakeFiles/HelloLib.dir/hello_world.cpp.o md5sum srcA/build/libHelloLib.a md5sum srcB/build/libHelloLib.a     : <span class="hljs-number"><span class="hljs-number">3572</span></span>a95a8699f71803f3e967f92a5040 srcA/build/hello <span class="hljs-number"><span class="hljs-number">7</span></span>ca693295e62de03a1bba14853efa28c srcB/build/hello <span class="hljs-number"><span class="hljs-number">76e0</span></span>ae7c4ef79ec3be821ccf5752730f srcA/build/CMakeFiles/HelloLib.dir/hello_world.cpp.o <span class="hljs-number"><span class="hljs-number">5</span></span>ef044e6dcb73359f46d48f29f566ae5 srcB/build/CMakeFiles/HelloLib.dir/hello_world.cpp.o dc941156608b578c91e38f8ecebfef6d srcA/build/libHelloLib.a <span class="hljs-number"><span class="hljs-number">1f</span></span>9697ef23bf70b41b39ef3469845f76 srcB/build/libHelloLib.a</code> </pre> <br>  La información sobre la carpeta se transfiere de los archivos de objeto a los archivos ejecutables finales, lo que hace que nuestros ensamblajes sean irreproducibles.  Podemos ver las diferencias entre los binarios usando un difoscopio para ver dónde está incrustada la información de la carpeta. <br><br><pre> <code class="cpp hljs">&gt; diffoscope helloA helloB --- srcA/build/hello +++ srcB/build/hello @@ <span class="hljs-number"><span class="hljs-number">-1282</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span> +<span class="hljs-number"><span class="hljs-number">1282</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span> @@ ... <span class="hljs-number"><span class="hljs-number">00005070</span></span>: <span class="hljs-number"><span class="hljs-number">5f</span></span>77 <span class="hljs-number"><span class="hljs-number">6f</span></span>72 <span class="hljs-number"><span class="hljs-number">6</span></span>c64 <span class="hljs-number"><span class="hljs-number">5f</span></span>64 <span class="hljs-number"><span class="hljs-number">6562</span></span> <span class="hljs-number"><span class="hljs-number">7567</span></span> <span class="hljs-number"><span class="hljs-number">2f</span></span>73 <span class="hljs-number"><span class="hljs-number">7263</span></span> _world_debug/src <span class="hljs-number"><span class="hljs-number">-00005080</span></span>: <span class="hljs-number"><span class="hljs-number">412f</span></span> <span class="hljs-number"><span class="hljs-number">006</span></span>d <span class="hljs-number"><span class="hljs-number">6169</span></span> <span class="hljs-number"><span class="hljs-number">6e2</span></span>e <span class="hljs-number"><span class="hljs-number">6370</span></span> <span class="hljs-number"><span class="hljs-number">7000</span></span> <span class="hljs-number"><span class="hljs-number">2f</span></span>55 <span class="hljs-number"><span class="hljs-number">7365</span></span> A/.main.cpp./Use +<span class="hljs-number"><span class="hljs-number">00005080</span></span>: <span class="hljs-number"><span class="hljs-number">422f</span></span> <span class="hljs-number"><span class="hljs-number">006</span></span>d <span class="hljs-number"><span class="hljs-number">6169</span></span> <span class="hljs-number"><span class="hljs-number">6e2</span></span>e <span class="hljs-number"><span class="hljs-number">6370</span></span> <span class="hljs-number"><span class="hljs-number">7000</span></span> <span class="hljs-number"><span class="hljs-number">2f</span></span>55 <span class="hljs-number"><span class="hljs-number">7365</span></span> B/.main.cpp./Use <span class="hljs-number"><span class="hljs-number">00005090</span></span>: <span class="hljs-number"><span class="hljs-number">7273</span></span> <span class="hljs-number"><span class="hljs-number">2f</span></span>63 <span class="hljs-number"><span class="hljs-number">6172</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c6f <span class="hljs-number"><span class="hljs-number">732f</span></span> <span class="hljs-number"><span class="hljs-number">446f</span></span> <span class="hljs-number"><span class="hljs-number">6375</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>d65 rs/carlos/Docume <span class="hljs-number"><span class="hljs-number">000050</span></span>a0: <span class="hljs-number"><span class="hljs-number">6e74</span></span> <span class="hljs-number"><span class="hljs-number">732f</span></span> <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">7665</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c6f <span class="hljs-number"><span class="hljs-number">7065</span></span> <span class="hljs-number"><span class="hljs-number">722f</span></span> <span class="hljs-number"><span class="hljs-number">7265</span></span> nts/developer/re <span class="hljs-number"><span class="hljs-number">000050b</span></span>0: <span class="hljs-number"><span class="hljs-number">7072</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span>64 <span class="hljs-number"><span class="hljs-number">7563</span></span> <span class="hljs-number"><span class="hljs-number">6962</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c65 <span class="hljs-number"><span class="hljs-number">2</span></span>d62 <span class="hljs-number"><span class="hljs-number">7569</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c64 producible-build <span class="hljs-number"><span class="hljs-number">000050</span></span>c0: <span class="hljs-number"><span class="hljs-number">732f</span></span> <span class="hljs-number"><span class="hljs-number">7361</span></span> <span class="hljs-number"><span class="hljs-number">6e64</span></span> <span class="hljs-number"><span class="hljs-number">626f</span></span> <span class="hljs-number"><span class="hljs-number">782f</span></span> <span class="hljs-number"><span class="hljs-number">6865</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c6c <span class="hljs-number"><span class="hljs-number">6f</span></span>5f s/sandbox/hello_ <span class="hljs-number"><span class="hljs-number">-000050</span></span>d0: <span class="hljs-number"><span class="hljs-number">776f</span></span> <span class="hljs-number"><span class="hljs-number">726</span></span>c <span class="hljs-number"><span class="hljs-number">645f</span></span> <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6275</span></span> <span class="hljs-number"><span class="hljs-number">672f</span></span> <span class="hljs-number"><span class="hljs-number">7372</span></span> <span class="hljs-number"><span class="hljs-number">6341</span></span> world_debug/srcA +<span class="hljs-number"><span class="hljs-number">000050</span></span>d0: <span class="hljs-number"><span class="hljs-number">776f</span></span> <span class="hljs-number"><span class="hljs-number">726</span></span>c <span class="hljs-number"><span class="hljs-number">645f</span></span> <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6275</span></span> <span class="hljs-number"><span class="hljs-number">672f</span></span> <span class="hljs-number"><span class="hljs-number">7372</span></span> <span class="hljs-number"><span class="hljs-number">6342</span></span> world_debug/srcB <span class="hljs-number"><span class="hljs-number">000050e0</span></span>: <span class="hljs-number"><span class="hljs-number">2f</span></span>62 <span class="hljs-number"><span class="hljs-number">7569</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c64 <span class="hljs-number"><span class="hljs-number">2f</span></span>43 <span class="hljs-number"><span class="hljs-number">4</span></span>d61 <span class="hljs-number"><span class="hljs-number">6b</span></span>65 <span class="hljs-number"><span class="hljs-number">4669</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c65 /build/CMakeFile <span class="hljs-number"><span class="hljs-number">000050f</span></span>0: <span class="hljs-number"><span class="hljs-number">732f</span></span> <span class="hljs-number"><span class="hljs-number">6865</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c6c <span class="hljs-number"><span class="hljs-number">6f</span></span>2e <span class="hljs-number"><span class="hljs-number">6469</span></span> <span class="hljs-number"><span class="hljs-number">722f</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>d61 <span class="hljs-number"><span class="hljs-number">696</span></span>e s/hello.dir/main <span class="hljs-number"><span class="hljs-number">00005100</span></span>: <span class="hljs-number"><span class="hljs-number">2e63</span></span> <span class="hljs-number"><span class="hljs-number">7070</span></span> <span class="hljs-number"><span class="hljs-number">2e6</span></span>f <span class="hljs-number"><span class="hljs-number">005f</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>d61 <span class="hljs-number"><span class="hljs-number">696</span></span>e <span class="hljs-number"><span class="hljs-number">005f</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>5a .cpp.o._main.__Z ... @@ <span class="hljs-number"><span class="hljs-number">-1336</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span> +<span class="hljs-number"><span class="hljs-number">1336</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span> @@ ... <span class="hljs-number"><span class="hljs-number">000053</span></span>c0: <span class="hljs-number"><span class="hljs-number">6962</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c65 <span class="hljs-number"><span class="hljs-number">2</span></span>d62 <span class="hljs-number"><span class="hljs-number">7569</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c64 <span class="hljs-number"><span class="hljs-number">732f</span></span> <span class="hljs-number"><span class="hljs-number">7361</span></span> <span class="hljs-number"><span class="hljs-number">6e64</span></span> ible-builds/sand <span class="hljs-number"><span class="hljs-number">000053</span></span>d0: <span class="hljs-number"><span class="hljs-number">626f</span></span> <span class="hljs-number"><span class="hljs-number">782f</span></span> <span class="hljs-number"><span class="hljs-number">6865</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c6c <span class="hljs-number"><span class="hljs-number">6f</span></span>5f <span class="hljs-number"><span class="hljs-number">776f</span></span> <span class="hljs-number"><span class="hljs-number">726</span></span>c <span class="hljs-number"><span class="hljs-number">645f</span></span> box/hello_world_ <span class="hljs-number"><span class="hljs-number">-000053e0</span></span>: <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6275</span></span> <span class="hljs-number"><span class="hljs-number">672f</span></span> <span class="hljs-number"><span class="hljs-number">7372</span></span> <span class="hljs-number"><span class="hljs-number">6341</span></span> <span class="hljs-number"><span class="hljs-number">2f</span></span>62 <span class="hljs-number"><span class="hljs-number">7569</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c64 debug/srcA/build +<span class="hljs-number"><span class="hljs-number">000053e0</span></span>: <span class="hljs-number"><span class="hljs-number">6465</span></span> <span class="hljs-number"><span class="hljs-number">6275</span></span> <span class="hljs-number"><span class="hljs-number">672f</span></span> <span class="hljs-number"><span class="hljs-number">7372</span></span> <span class="hljs-number"><span class="hljs-number">6342</span></span> <span class="hljs-number"><span class="hljs-number">2f</span></span>62 <span class="hljs-number"><span class="hljs-number">7569</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c64 debug/srcB/build <span class="hljs-number"><span class="hljs-number">000053f</span></span>0: <span class="hljs-number"><span class="hljs-number">2f</span></span>6c <span class="hljs-number"><span class="hljs-number">6962</span></span> <span class="hljs-number"><span class="hljs-number">4865</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c6c <span class="hljs-number"><span class="hljs-number">6f</span></span>4c <span class="hljs-number"><span class="hljs-number">6962</span></span> <span class="hljs-number"><span class="hljs-number">2e61</span></span> <span class="hljs-number"><span class="hljs-number">2868</span></span> /libHelloLib.a(h <span class="hljs-number"><span class="hljs-number">00005400</span></span>: <span class="hljs-number"><span class="hljs-number">656</span></span>c <span class="hljs-number"><span class="hljs-number">6</span></span>c6f <span class="hljs-number"><span class="hljs-number">5f</span></span>77 <span class="hljs-number"><span class="hljs-number">6f</span></span>72 <span class="hljs-number"><span class="hljs-number">6</span></span>c64 <span class="hljs-number"><span class="hljs-number">2e63</span></span> <span class="hljs-number"><span class="hljs-number">7070</span></span> <span class="hljs-number"><span class="hljs-number">2e6</span></span>f ello_world.cpp.o <span class="hljs-number"><span class="hljs-number">00005410</span></span>: <span class="hljs-number"><span class="hljs-number">2900</span></span> <span class="hljs-number"><span class="hljs-number">5f</span></span>5f <span class="hljs-number"><span class="hljs-number">5</span></span>a4e <span class="hljs-number"><span class="hljs-number">3130</span></span> <span class="hljs-number"><span class="hljs-number">4865</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c6c <span class="hljs-number"><span class="hljs-number">6f</span></span>57 <span class="hljs-number"><span class="hljs-number">6f</span></span>72 ).__ZN10HelloWor ...</code> </pre> <br><h3>  Posibles soluciones </h3><br>  Nuevamente, la decisión dependerá del compilador utilizado: <br><br><ul><li>  msvc no puede establecer parámetros para evitar agregar esta información a archivos binarios.  La única forma de obtener archivos binarios reproducibles es usar la herramienta de reparación nuevamente para eliminar esta información durante la fase de compilación.  Tenga en cuenta que, dado que arreglamos binarios para producir binarios reproducibles, las carpetas utilizadas para diferentes ensamblajes deben tener la misma longitud en caracteres. </li><li>  <code>gcc</code> tiene tres indicadores de compilación para solucionar este problema: <br><ul><li>  <code>-fdebug-prefix-map=OLD=NEW</code> puede eliminar los prefijos de directorio de la información de depuración. </li><li>  <code>-fmacro-prefix-map=OLD=NEW</code> disponible desde gcc 8 y resuelve el problema de irreproducibilidad utilizando la macro __FILE__. </li><li>  <code>-ffile-prefix-map=OLD=NEW</code> está disponible desde gcc 8 y es una unión de -fdebug-prefix-map y -fmacro-prefix-map </li></ul></li><li>  <code>clang</code> admitido <code>-fdebug-prefix-map=OLD=NEW</code> desde la versión 3.8 y está trabajando para admitir otros dos indicadores para futuras versiones. </li></ul><br>  La mejor manera de resolver este problema es agregar banderas a las opciones del compilador.  Cuando use CMake: <br><br><pre> <code class="cpp hljs">target_compile_options(target PUBLIC <span class="hljs-string"><span class="hljs-string">"-ffile-prefix-map=${CMAKE_SOURCE_DIR}=."</span></span>)</code> </pre><br><h3>  El orden de los archivos en el sistema de compilación </h3><br>  El orden de los archivos puede ser un problema si los directorios se leen para hacer una lista de sus archivos.  Por ejemplo, Unix no tiene un orden determinista en el que readdir () y listdir () deben devolver el contenido de un directorio, por lo que confiar en estas funciones para alimentar el sistema de ensamblaje puede conducir a ensamblajes no deterministas. <br><br>  El mismo problema ocurre, por ejemplo, si su sistema de compilación almacena archivos para el enlazador en un contenedor (por ejemplo, en un diccionario de Python normal), que puede devolver elementos en un orden no determinista.  Esto hará que los archivos se vinculen en un orden diferente cada vez, y se crearán diferentes archivos binarios. <br><br>  Podemos simular este problema reorganizando los archivos en CMake.  Si modificamos el ejemplo anterior para tener más de un archivo fuente para la biblioteca: <br><br><pre> <code class="cpp hljs">. ├── CMakeLists.txt ├── CMakeListsA.txt ├── CMakeListsB.txt ├── hello_world.cpp ├── hello_world.hpp ├── main.cpp ├── sources0.cpp ├── sources0.hpp ├── sources1.cpp ├── sources1.hpp ├── sources2.cpp └── sources2.hpp</code> </pre> <br>  Podemos ver que los resultados de la compilación son diferentes si cambiamos el orden de los archivos en <code>CMakeLists.txt</code> : <br><br><pre> <code class="cpp hljs">cmake_minimum_required(VERSION <span class="hljs-number"><span class="hljs-number">3.0</span></span>) project(HelloWorld) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(CMAKE_CXX_STANDARD <span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(CMAKE_CXX_STANDARD_REQUIRED ON) add_library(HelloLib hello_world.cpp sources0.cpp sources1.cpp sources2.cpp) add_executable(hello main.cpp) target_link_libraries(hello HelloLib)</code> </pre> <br>  Si hacemos dos ensamblajes consecutivos con los nombres A y B, intercambiando <code>sources0.cpp</code> y <code>sources0.cpp</code> en la lista de archivos, obtenemos las siguientes sumas de verificación: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">30</span></span>ab264d6f8e1784282cd1a415c067f2 helloA cdf3c9dd968f7363dc9e8b40918d83af helloB <span class="hljs-number"><span class="hljs-number">707</span></span>c71bc2a8def6885b96fb67b84d79c hello_worldA.cpp.o <span class="hljs-number"><span class="hljs-number">707</span></span>c71bc2a8def6885b96fb67b84d79c hello_worldB.cpp.o <span class="hljs-number"><span class="hljs-number">694f</span></span>f3765b688e6faeebf283052629a3 sources0A.cpp.o <span class="hljs-number"><span class="hljs-number">694f</span></span>f3765b688e6faeebf283052629a3 sources0B.cpp.o <span class="hljs-number"><span class="hljs-number">0</span></span>db24dc6a94da1d167c68b96ff319e56 sources1A.cpp.o <span class="hljs-number"><span class="hljs-number">0</span></span>db24dc6a94da1d167c68b96ff319e56 sources1B.cpp.o fd0754d9a4a44b0fcc4e4f3c66ad187c sources2A.cpp.o fd0754d9a4a44b0fcc4e4f3c66ad187c sources2B.cpp.o baba9709d69c9e5fd51ad985ee328172 libHelloLibA.a <span class="hljs-number"><span class="hljs-number">72641</span></span>dc6fc4f4db04166255f62803353 libHelloLibB.a</code> </pre> <br>  Los archivos <code>.o</code> objeto son idénticos, pero las bibliotecas y ejecutables .a no lo son.  Esto se debe a que el orden de inserción en la biblioteca depende del orden en que se enumeran los archivos. <br><br><h3>  Compilador creado aleatoriedad </h3><br>  Este problema ocurre, por ejemplo, en gcc cuando se <code>-flto</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Optimizaciones de tiempo de enlace</a> (indicador <code>-flto</code> ).  Esta opción introduce nombres generados aleatoriamente en archivos binarios.  La única forma de evitar este problema es usar la bandera - <code>frandom-seed</code> .  Esta opción proporciona una semilla que usa gcc en lugar de números aleatorios.  Se utiliza para generar nombres de símbolos específicos, que deben ser diferentes en cada archivo compilado.  También se usa para colocar sellos únicos en archivos de cobertura de datos y archivos de objetos que los producen.  Este parámetro debe ser diferente para cada archivo fuente.  Una opción es establecer la suma de verificación del archivo para que la probabilidad de colisión sea muy baja.  Por ejemplo, en CMake, esto se puede hacer usando esta función: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(LIB_SOURCES ./src/source1.cpp ./src/source2.cpp ./src/source3.cpp) foreach(_file ${LIB_SOURCES}) file(SHA1 ${_file} checksum) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(SUBSTRING ${checksum} <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> checksum) set_property(SOURCE ${_file} APPEND_STRING PROPERTY COMPILE_FLAGS <span class="hljs-string"><span class="hljs-string">"-frandom-seed=0x${checksum}"</span></span>) endforeach()</code> </pre> <br><h3>  Algunos consejos para usar Conan </h3><br>  Conan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hooks</a> puede ayudarnos a hacer que nuestras compilaciones sean reproducibles.  Esta característica le permite personalizar el comportamiento del cliente en ciertos puntos. <br><br>  Una forma de usar ganchos puede ser establecer variables de entorno en la etapa <code>pre_build</code> .  En el ejemplo a continuación, se <code>set_environment</code> función <code>set_environment</code> y luego se restaura el entorno en el paso <code>reset_environment</code> usando <code>reset_environment</code> . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_environment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">: </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> self._os </span></span>== <span class="hljs-string"><span class="hljs-string">"Linux"</span></span>: self._old_source_date_epoch = os.environ.get(<span class="hljs-string"><span class="hljs-string">"SOURCE_DATE_EPOCH"</span></span>) timestamp = <span class="hljs-string"><span class="hljs-string">"1564483496"</span></span> os.environ[<span class="hljs-string"><span class="hljs-string">"SOURCE_DATE_EPOCH"</span></span>] = timestamp self._output.info( <span class="hljs-string"><span class="hljs-string">"set SOURCE_DATE_EPOCH: {}"</span></span>.format(timestamp)) elif self._os == <span class="hljs-string"><span class="hljs-string">"Macos"</span></span>: os.environ[<span class="hljs-string"><span class="hljs-string">"ZERO_AR_DATE"</span></span>] = <span class="hljs-string"><span class="hljs-string">"1"</span></span> self._output.info( <span class="hljs-string"><span class="hljs-string">"set ZERO_AR_DATE: {}"</span></span>.format(timestamp)) def reset_environment(self): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self._os == <span class="hljs-string"><span class="hljs-string">"Linux"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self._old_source_date_epoch is None: del os.environ[<span class="hljs-string"><span class="hljs-string">"SOURCE_DATE_EPOCH"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: os.environ[<span class="hljs-string"><span class="hljs-string">"SOURCE_DATE_EPOCH"</span></span>] = self._old_source_date_epoch elif self._os == <span class="hljs-string"><span class="hljs-string">"Macos"</span></span>: del os.environ[<span class="hljs-string"><span class="hljs-string">"ZERO_AR_DATE"</span></span>]</code> </pre> <br>  Los ganchos también pueden ser útiles para arreglar binarios en la etapa <code>post_build</code> .  Existen varias herramientas para analizar y corregir archivos binarios, como <code>ducible</code> , <code>pefile</code> , <code>pe-parse</code> o <code>strip-nondeterminism</code> .  Un gancho de ejemplo para arreglar un binario de PE usando <code>ducible</code> podría ser: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Patcher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object)</span></span></span><span class="hljs-function">: ... def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">patch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">: </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> self._os </span></span>== <span class="hljs-string"><span class="hljs-string">"Windows"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self._compiler == <span class="hljs-string"><span class="hljs-string">"Visual Studio"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> root, _, filenames in os.walk(self._conanfile.build_folder): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> filename in filenames: filename = os.path.join(root, filename) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">".exe"</span></span> in filename <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">".dll"</span></span> in filename: self._patch_pe(filename) def _patch_pe(self, filename): patch_tool_location = <span class="hljs-string"><span class="hljs-string">"C:/ducible/ducible.exe"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.path.isfile(patch_tool_location): self._output.info(<span class="hljs-string"><span class="hljs-string">"Patching {} with md5sum: {}"</span></span>.format(filename,md5sum(filename))) self._conanfile.run(<span class="hljs-string"><span class="hljs-string">"{} {}"</span></span>.format(patch_tool_location, filename)) self._output.info(<span class="hljs-string"><span class="hljs-string">"Patched file: {} with md5sum: {}"</span></span>.format(filename,md5sum(filename))) ... def pre_build(output, conanfile, **kwargs): lib_patcher.init(output, conanfile) lib_patcher.set_environment() def post_build(output, conanfile, **kwargs): lib_patcher.patch() lib_patcher.reset_environment()</code> </pre> <br><h3>  Conclusiones </h3><br>  Los ensamblajes deterministas son una tarea compleja, estrechamente relacionada con el sistema operativo y el kit de herramientas utilizado.  Se suponía que esta introducción ayudaría a comprender las causas más comunes de falta de determinismo y cómo abordarlas. <br><br><h3>  Referencias </h3><br><h4>  Información general </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.chromium.org/developers/testing/isolated-testing/deterministic-builds</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">reproducible-builds.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">wiki.yoctoproject.org/wiki/Reproducible_Builds</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">stackoverflow.com/questions/1180852/deterministic-builds-under-windows</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">docs.microsoft.com/en-us/windows/win32/debug/pe-format#archive-library-file-format</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">devblogs.microsoft.com/oldnewthing/20180103-00/?p=97705</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.geoffchappell.com/studies/msvc/link/link/options/brepro.htm?tx=37&amp;ts=0</a> , 267 </li></ul><br><h4>  Las herramientas </h4><br>  <b>Herramientas de comparación binaria</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">diffoscope.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">docs.microsoft.com/en-us/windows-server/administration/windows-commands/fc</a> </li></ul><br>  <b>Herramientas de reparación de archivos</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">salsa.debian.org/reproducible-builds/strip-nondeterminism</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/erocarrera/pefile</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/trailofbits/pe-parse</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/smarttechnologies/peparser</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/google/syzygy</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/nh2/ar-timestamp-wiper</a> </li></ul><br>  <b>Herramientas de análisis de archivos</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">docs.microsoft.com/en-us/cpp/build/reference/dumpbin-reference?view=vs-2019</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sourceware.org/binutils/docs/binutils/readelf.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/llvm-mirror/llvm/tree/master/tools</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/lief-project/LIEF</a> </li></ul><br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Leer la primera parte</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468555/">https://habr.com/ru/post/468555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468541/index.html">¿Arrastrar y soltar componentes para usuarios ciegos? Estas bromeando</a></li>
<li><a href="../468543/index.html">Entre semana Comité del Programa FrontendConf. Entrevista con Sergey Popov</a></li>
<li><a href="../468547/index.html">Habla inglés, CSS, Grid y accesibilidad en FrontendConf</a></li>
<li><a href="../468549/index.html">GPU enlazado. Cómo transferir todo a la tarjeta de video y un poco más. Animaciones</a></li>
<li><a href="../468553/index.html">Gestión de parámetros en aplicaciones empresariales similares a un sistema de control de versiones.</a></li>
<li><a href="../468557/index.html">WEB 3.0: el segundo enfoque del proyectil</a></li>
<li><a href="../468559/index.html">Copia de seguridad de la nube, amigos</a></li>
<li><a href="../468561/index.html">Semana de la seguridad 39: errores de seguridad y comunes</a></li>
<li><a href="../468563/index.html">Watchmen Watch: el estado actual de las instalaciones de seguimiento espacial</a></li>
<li><a href="../468565/index.html">Contador Geiger hecho en casa en ESP8266 con pantalla táctil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>