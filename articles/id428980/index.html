<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💂🏼 ✌🏿 🌍 Broker JavaScript Offline 🎖️ ♍️ ⛷️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam proyek saya, saya membutuhkan fungsionalitas yang memungkinkan saya untuk tidak kehilangan data yang dimasukkan jika terjadi gangguan koneksi In...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Broker JavaScript Offline</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428980/">  Dalam proyek saya, saya membutuhkan fungsionalitas yang memungkinkan saya untuk tidak kehilangan data yang dimasukkan jika terjadi gangguan koneksi Internet dan saya menghasilkan "Pialang" yang sangat sederhana yang memungkinkan saya untuk tidak kehilangan data saat koneksi terputus, tetapi mengirimkannya saat koneksi dipulihkan kembali.  Mungkin "Pialang" bukan nama yang baik baginya, tetapi jangan menilai dengan ketat.  Saya ingin berbagi, mungkin seseorang akan berguna. <br><a name="habracut"></a><br><h2>  Tentang proyek </h2><br>  Proyek saya dirancang untuk memperhitungkan pengeluaran dan pendapatan atau sebagai versi sederhana dari akuntansi rumah.  Itu dibuat sebagai aplikasi web progresif, sehingga nyaman untuk menggunakannya pada perangkat seluler, serta untuk membuka kemampuan pemberitahuan Push, akses ke kamera untuk membaca barcode, dan sejenisnya.  Ada aplikasi seluler serupa yang disebut ZenMoney, tetapi saya menginginkan sesuatu dengan cara saya sendiri. <br><br><h2>  Munculnya ide </h2><br>  Saya mencoba untuk mencatat dengan jelas pengeluaran dan pendapatan, tetapi karena sering lupa menambahkan posisi yang diperlukan, terutama yang berhubungan dengan uang tunai, saya harus segera melakukan ini ketika "transaksi" terjadi.  Kadang-kadang saya memasukkan data dalam transportasi umum, seperti kereta bawah tanah, di mana kehilangan koneksi sering terjadi, bahkan meskipun jaringan Wi-Fi tersebar luas.  Sayang sekali semuanya membeku dan tidak ada yang terjadi, dan kemudian data hilang begitu saja. <br><br>  Idenya datang dari menggunakan broker antrian seperti RabbitMQ.  Tentu saja, saya punya solusi yang lebih sederhana dan tidak terlalu fungsional, tetapi ada sesuatu yang mirip dengan prinsip-prinsipnya.  Saya pikir Anda dapat menyimpan semuanya, misalnya, di Cache atau LocalStorage sebagai objek dengan antrian permintaan "tidak puas", dan ketika koneksi muncul, Anda dapat menjalankannya dengan aman.  Tentu saja, mereka tidak dieksekusi dalam urutan prioritas, yang, berkat pemrosesan permintaan yang tidak sinkron dalam bahasa JS, bahkan lebih baik, mengingat Anda hanya memiliki satu "pelanggan".  Saya mengalami beberapa kesulitan, mungkin bahkan implementasi ini semua akan tampak sedikit bengkok, tetapi ini adalah solusi yang berhasil.  Tentu saja, ini dapat ditingkatkan, tetapi untuk saat ini saya akan menjelaskan opsi "mentah" yang ada tetapi berfungsi. <br><br><h2>  Memulai </h2><br>  Hal pertama yang saya pikirkan adalah di mana menyimpan data tanpa adanya koneksi ?!  Layanan yang dikenakan pada saya oleh PWA berfungsi baik dengan cache, tetapi apakah bijaksana untuk menggunakan cache ?!  Pertanyaan yang sulit, saya tidak akan membahasnya.  Secara umum, saya memutuskan bahwa LocalStorage lebih baik bagi saya.  Karena LocalStorage menyimpan nilai key type: value, objek harus ditambahkan sebagai string Json.  Dalam proyek saya untuk pengembangan eksternal, saya menambahkan direktori yang disebut QueueBroker ke folder kelas <br><br><div class="spoiler">  <b class="spoiler_title">Struktur file</b> <div class="spoiler_text"><code>/**----**/ <br> ├── app.js <br> ├── bootstrap.js <br> ├── classes <br> │  └── QueueBroker <br> │  ├── index.js <br> │  └── Library <br> │  ├── Broker.js <br> │  └── Storage.js <br> ├── components <br> /**----**/ <br></code> <br></div></div><br>  Proyek saya dibuat di tumpukan Laravel + VueJs, jadi diperlukan ketergantungan tertentu dari struktur file.  Saya tidak tahu bagaimana dalam kasus seperti itu adalah benar untuk memanggil direktori Anda sendiri untuk kelas, jadi saya melakukannya. <br><br>  File indeks dibuat untuk cukup menyambungkan modul dari Perpustakaan bersarang.  Ini mungkin bukan solusi yang sangat elegan, tetapi saya ingin membuatnya sehingga jika saya tiba-tiba berubah pikiran tentang penggunaan LocalStorage, saya akan menulis kelas lain untuk Penyimpanan dengan metode yang sama, meneruskannya ke konstruktor pialang, dan menggunakan penyimpanan lain tanpa mengubah apa pun. <br><br><div class="spoiler">  <b class="spoiler_title">index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Broker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./Library/Broker'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Storage = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./Library/Storage'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.Broker = Broker; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.Storage = Storage;</code> </pre><br></div></div><br>  Metode ini memungkinkan Anda untuk menghubungkan hanya perpustakaan yang saya butuhkan di skrip saya, misalnya, jika saya membutuhkan keduanya: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Storage, Broker} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../../classes/QueueBroker/index'</span></span>;</code> </pre><br>  Untuk membuatnya mudah bagi saya untuk mengubah kelas penyimpanan, saya membuat semacam konstruktor untuk kelas Broker, di mana objek Penyimpanan dapat diteruskan sebagai argumen, hal utama adalah bahwa ia memiliki fungsi yang diperlukan.  Saya tahu bahwa pada ES6 saya bisa menulis kelas dan konstruktor, tetapi memutuskan untuk melakukannya dengan cara lama - prototipe.  Saya akan menulis komentar langsung dengan kode: <br><br><div class="spoiler">  <b class="spoiler_title">Broker.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> axios = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'axios'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  axios /*     .    ,            front-end  */ function Broker(storage, prefix='storageKey') { this.storage = storage; this.prefix = prefix; /*     ,      .   storage   add     json */ if(this.storage.get('broker') === null) { this.broker = {}; this.storage.add('broker', this.broker) } else { //  , Storage    Json            this.broker = this.storage.getObject('broker'); } }; // ,           Broker.prototype.queueCount = function () { return Object.keys(this.broker).length; }; //  ""    Storage,    Broker.prototype.saveToStorage = function (method, url, data) { let key = this.prefix + '_' + (Object.keys(this.broker).length + 1); this.broker[key] = {method, url, data}; //            broker,        this.storage.add('broker', this.broker); }; // ,    ,    Broker.prototype.run = function () { for (let key in this.broker) { this.sendToServer(this.broker[key], key) } } /*    .        ,     method, url  data,        ,    ,    */ Broker.prototype.sendToServer = function (object, brokerKey) { axios({ method: object.method, url: object.url, data: object.data, }) .then(response =&gt; { if(response.data.status == 200) { //   ,    delete this.broker[brokerKey]; //  this.storage.add('broker', this.broker); } else { //   ;-) console.log(response.data) } }) .catch(error =&gt; { /*           ,       */ }); }; //   export module.exports = Broker;</span></span></code> </pre><br></div></div><br>  Selanjutnya, Anda memerlukan objek Storage itu sendiri, yang akan berhasil menyimpan dan mengambil semuanya dari penyimpanan <br><br><div class="spoiler">  <b class="spoiler_title">Storage.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  debug-   function Storage(debug) { if(debug === true) { this.debugMode = true; } this.storage = window.localStorage; }; // ,     Json      Storage.prototype.addObjectToStorage = function (key, object) { this.storage.setItem(key, JSON.stringify(object)); }; //    (,   ) Storage.prototype.addStringToStorage = function (key, value) { this.storage.setItem(key, value); }; //    Storage.prototype.get = function (key) { return this.storage.getItem(key); }; //    Json ,       Storage.prototype.getObject = function (key) { try { return JSON.parse(this.storage.getItem(key)); } catch (e) { this._debug(e); this._debug(key + ' = ' + this.storage.getItem(key)); return false; } }; /* ,     ,  ,        ,   Json      */ Storage.prototype.add = function (key, value) { try { if(typeof value === 'object') { this.addObjectToStorage(key, value); } else if (typeof value === 'string' || typeof value === 'number') { this.addStringToStorage(key, value); } else { //    this._debug('2 parameter does not belong to a known type') } return this.storage; } catch (e) { //    ,    ,    if (e === QUOTA_EXCEEDED_ERR) { this._debug('LocalStorage is exceeded the free space limit') } else { this._debug(e) } } }; //  Storage.prototype.clear = function () { try { this.storage.clear(); return true; } catch (e) { this._debug(e) return false; } }; //    Storage.prototype.delete = function(key) { try { this.storage.removeItem(key); return true; } catch (e) { this._debug(e) return false; } }; // ,      Storage.prototype._debug = function(error) { if(this.debugMode) { console.error(error); } return null; }; //   module.exports = Storage;</span></span></code> </pre><br></div></div><br>  Ketika semua hal di atas akan siap, ini dapat digunakan atas kebijaksanaan Anda, saya menggunakannya seperti ini: <br><br><div class="spoiler">  <b class="spoiler_title">Gunakan di Simpan</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Vue (methods) /*----*/ //      Storage   sendBroker(method, url, data) { let storage = new Storage(true); let broker = new Broker(storage, 'fundsControl'); broker.saveToStorage(method, url, data); }, //     fundsSave() { let url = '/pa/funds'; let method = ''; if(this.fundsFormType === 'create') { method = 'post'; } else if(this.fundsFormType === 'update') { method = 'put'; } else if(this.fundsFormType === 'delete') { method = 'delete'; } this.$store.commit('setPreloader', true); axios({ method: method, url: url, data: this.fundsFormData, }) .then(response=&gt; { if(response.data.status == 200) { this.fundsFormShow = false; this.getFunds(); this.$store.commit('setPreloader', false); } else { this.$store.commit('AlertError', '    '); } }) //        .catch(error =&gt; { this.$store.commit('setAlert', { type: 'warning', status: true, message: '   . ,        ,   ' } ); this.fundsFormShow = false; this.$store.commit('setPreloader', false); //   ""  this.sendBroker(method, url, this.fundsFormData); console.error(error); }); },</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Gunakan saat menghubungkan kembali</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Vue /*--*/ methods: { /*----*/ /*   ,    ,   ,      ,      */ brokerSendRun() { let storage = new Storage(true); let broker = new Broker(storage, 'fundsControl'); //,   -   if(broker.queueCount() &gt; 0) { // ,    broker.run(); //   ,   this.$store.commit('setAlert', {type: 'info', status: true, message: '      -  , ,      '}); } } } /*---*/ /*     , ,   ,          ,     ,        */ mounted() { this.brokerSendRun(); } /*---*/</span></span></code> </pre><br></div></div><br><h3>  PS </h3><br>  Sulit bagi saya untuk berbicara tentang kode, jadi saya mencoba memberikan kode dalam contoh sedetail mungkin dengan komentar terperinci.  Jika Anda memiliki ide untuk meningkatkan solusi ini atau memperbaiki artikel ini, saya akan senang melihatnya di komentar.  Saya mengambil contoh dari proyek saya sendiri di Vue, saya menjelaskan ini untuk memperjelas mengapa metode saya disebut dan mengapa saya mengaksesnya melalui <b>ini</b> .  Saya tidak melakukannya dalam artikel ini khusus pada Vue, jadi saya tidak memberikan kode komponen lain, saya meninggalkannya untuk memahami. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id428980/">https://habr.com/ru/post/id428980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id428962/index.html">Relokasi di Luxoft: bagaimana kehidupan tersisa</a></li>
<li><a href="../id428964/index.html">Kerentanan SSD Terenkripsi Perangkat Keras Memungkinkan Penyerang dengan Mudah Memotong Tindakan Pelindung</a></li>
<li><a href="../id428972/index.html">Integrasi berkelanjutan di Yandex</a></li>
<li><a href="../id428974/index.html">Menarik di Interlight 2018</a></li>
<li><a href="../id428976/index.html">Bukit atau benteng semut? Saya sedang membangun rumah untuk harga sebuah apartemen. Bagian 2: Pemanasan</a></li>
<li><a href="../id428982/index.html">Cara menulis D pada ARM</a></li>
<li><a href="../id428984/index.html">Julia dan potret fase sistem dinamis</a></li>
<li><a href="../id428986/index.html">ThinkJava Conference # 8 di Kharkov</a></li>
<li><a href="../id428988/index.html">Tips Alam - Cloudy Night Light</a></li>
<li><a href="../id428990/index.html">Contoh Konfigurasi UIViewControllers Menggunakan RouteComposer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>