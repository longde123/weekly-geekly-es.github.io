<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âš›ï¸ ğŸ™† ğŸ’†ğŸ» ClusterJ-ä»Javaä½¿ç”¨MySQL NDB Cluster ğŸ”¸ ğŸ› ğŸšï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å“ˆHaï¼ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³è€ƒè™‘ä¸€ä¸ªJavaåº“ï¼Œä¾‹å¦‚ClusterJ ï¼Œå®ƒä½¿ä½¿ç”¨Javaä»£ç çš„MySQL NDBCLUSTERå¼•æ“å˜å¾—éå¸¸å®¹æ˜“ï¼Œè¯¥å¼•æ“çš„æ¦‚å¿µç±»ä¼¼äºJPAå’ŒHibernate ï¼Œæ˜¯é«˜çº§APIã€‚ 


 åœ¨æœ¬æ–‡çš„æ¡†æ¶ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨SpringBootä¸Šåˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä½¿ç”¨Cluste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ClusterJ-ä»Javaä½¿ç”¨MySQL NDB Cluster</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472468/"><p>å“ˆHaï¼ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³è€ƒè™‘ä¸€ä¸ªJavaåº“ï¼Œä¾‹å¦‚<code>ClusterJ</code> ï¼Œå®ƒä½¿ä½¿ç”¨<code>Java</code>ä»£ç çš„<code>MySQL NDBCLUSTER</code>å¼•æ“å˜å¾—éå¸¸å®¹æ˜“ï¼Œè¯¥å¼•æ“çš„æ¦‚å¿µç±»ä¼¼äº<code>JPA</code>å’Œ<code>Hibernate</code> ï¼Œæ˜¯é«˜çº§APIã€‚ </p><br><p> åœ¨æœ¬æ–‡çš„æ¡†æ¶ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨<code>SpringBoot</code>ä¸Šåˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä½¿ç”¨<code>ClusterJ</code>åˆ›å»ºä¸€ä¸ªå…¥é—¨<code>ClusterJ</code> ï¼Œä»¥ä¾¿åœ¨ä½¿ç”¨è‡ªåŠ¨é…ç½®çš„åº”ç”¨ç¨‹åºä¸­æ–¹ä¾¿ä½¿ç”¨ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨<code>JUnit5</code>å’Œ<code>TestContainers</code>ç¼–å†™ç®€å•çš„æµ‹è¯•ï¼Œè¿™äº›æµ‹è¯•å°†æ˜¾ç¤ºAPIçš„åŸºæœ¬ç”¨æ³•ã€‚ <br> æˆ‘è¿˜å°†è®¨è®ºåœ¨ä¸å¥¹åˆä½œçš„è¿‡ç¨‹ä¸­æˆ‘å¿…é¡»é¢å¯¹çš„å‡ ä¸ªç¼ºç‚¹ã€‚ </p><br><p> è°åœ¨ä¹ï¼Œæ¬¢è¿æ¥çŒ«ã€‚ </p><a name="habracut"></a><br><h2 id="vvedenie"> å¼•è¨€ </h2><br><p> ä¸ºäº†æé«˜é€Ÿåº¦ï¼Œ <code>MySQL NDB Cluster</code>åœ¨å·¥ä½œä¸­å’Œä¸€ä¸ªé¡¹ç›®ä¸­<code>MySQL NDB Cluster</code>ç§¯æä½¿ç”¨ï¼Œå…¶ä»»åŠ¡æ˜¯ä½¿ç”¨<code>ClusterJ</code>åº“è€Œä¸æ˜¯é€šå¸¸çš„<code>JDBC</code> ï¼Œåè€…çš„APIä¸<code>JPA</code>éå¸¸ç›¸ä¼¼ï¼Œå¹¶ä¸”å®é™…ä¸Šæ˜¯<code>libndbclient.so</code>åº“çš„åŒ…è£…å™¨ï¼Œå®ƒæ˜¯é€šè¿‡<code>JNI</code>ä½¿ç”¨çš„ã€‚ </p><br><blockquote> å¯¹äºé‚£äº›ä¸äº†è§£çš„äººï¼ŒMySQL NDB Clusteræ˜¯ä¸€ä¸ªé«˜åº¦å¯è®¿é—®ä¸”å†—ä½™çš„MySQLç‰ˆæœ¬ï¼Œé€‚ç”¨äºä½¿ç”¨<code>NDB</code>å­˜å‚¨<code>NDB</code> ï¼ˆ <code>NDBCLUSTER</code> ï¼‰åœ¨ç¾¤é›†ä¸­è¿è¡Œçš„åˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒã€‚ æˆ‘ä¸æƒ³åœ¨è¿™é‡Œè¯¦ç»†ä»‹ç»ï¼Œæ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œ</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a>é˜…è¯»æ›´å¤šå†…å®¹ </blockquote><p>  <strong>ä½¿ç”¨è¯¥æ•°æ®åº“çš„Javaä»£ç æœ‰ä¸¤ç§æ–¹æ³•ï¼š</strong> </p><br><ul><li> æ ‡å‡†ï¼Œé€šè¿‡<code>JDBC</code>å’Œ<code>SQL</code>æŸ¥è¯¢ </li><li> é€šè¿‡<code>ClusterJ</code> ï¼Œç”¨äº<code>MySQL Cluster</code>ä¸­çš„é«˜æ€§èƒ½æ•°æ®è®¿é—®ã€‚ </li></ul><br><p><img src="https://habrastorage.org/webt/lk/cw/-e/lkcw-emutbnjzldw2eqvgzqs-dg.png" alt="å›¾ç‰‡"></p><br><p>  <strong>ClusterJåŸºäº4ä¸ªå…³é”®æ¦‚å¿µæ„å»ºï¼š</strong> </p><br><ul><li>  <code>SessionFactory</code>è¿æ¥æ± çš„ç±»ä¼¼ç‰©ï¼Œç”¨äºè·å–ä¼šè¯ã€‚ ç¾¤é›†çš„æ¯ä¸ªå®ä¾‹éƒ½å¿…é¡»å…·æœ‰è‡ªå·±çš„SessionFactoryã€‚ </li><li>  <code>Session</code> -æ˜¯ä¸<code>MySQL</code>ç¾¤é›†çš„ç›´æ¥è¿æ¥ã€‚ </li><li>  <code>Domain Object</code> -å¸¦æ³¨é‡Šçš„æ¥å£ï¼Œè¡¨ç¤ºè¡¨åˆ°<code>Java</code>ä»£ç çš„æ˜ å°„ï¼Œç±»ä¼¼äº<code>JPA</code> ã€‚ </li><li>  <code>Transaction</code> -æ˜¯å·¥ä½œçš„åŸå­å•å…ƒã€‚ åœ¨ä»»ä½•ç»™å®šæ—¶é—´ï¼Œåœ¨ä¸€ä¸ªä¼šè¯ä¸­ï¼Œå°†æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ã€‚ ä»»ä½•æ“ä½œï¼ˆæ¥æ”¶ï¼Œæ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤ï¼‰éƒ½åœ¨æ–°äº‹åŠ¡ä¸­æ‰§è¡Œã€‚ </li></ul><br><p>  <strong>ClusterJçš„å±€é™æ€§ï¼š</strong> </p><br><ul><li> ç¼ºä¹åŠ ç›Ÿ </li><li> æ— æ³•åˆ›å»ºè¡¨å’Œç´¢å¼•ã€‚ ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨<code>JDBC</code> ã€‚ </li><li> æ²¡æœ‰å»¶è¿ŸåŠ è½½ï¼ˆ <code>Lazy</code> ï¼‰ã€‚ æ•´ä¸ªè®°å½•ä¸€æ¬¡ä¸‹è½½ã€‚ </li><li> åœ¨åŸŸå¯¹è±¡ä¸­ï¼Œæ— æ³•å®šä¹‰è¡¨ä¹‹é—´çš„å…³ç³»ã€‚ å®Œå…¨æ²¡æœ‰<code>OneToMany</code> ï¼Œ <code>ManyToOne</code> ï¼Œ <code>ManyToMany</code>çš„ç›¸ä¼¼æ€§ã€‚ </li></ul><br><h2 id="praktika-talk-is-cheap-show-me-the-code"> ç»ƒä¹  è°ˆè¯å¾ˆä¾¿å®œã€‚ ç»™æˆ‘çœ‹ä»£ç ã€‚ </h2><br><p> å¥½äº†ï¼Œç†è®ºè¶³å¤Ÿå¤šï¼Œè®©æˆ‘ä»¬ç»§ç»­ç»ƒä¹ ã€‚ </p><br><p> é¢ä¸´çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ä¸­å¤®Mavenå­˜å‚¨åº“ä¸­ç¼ºå°‘<code>ClusterJ</code> ã€‚ ç”¨ç¬”å°†åº“å®‰è£…åœ¨æœ¬åœ°å­˜å‚¨åº“ä¸­ã€‚ å¾ˆæ˜æ˜¾ï¼Œå®ƒåº”è¯¥ä½äº<code>Nexus</code>æˆ–æŸäº›<code>Artifactory</code> ï¼Œä½†å¯¹äºæˆ‘ä»¬çš„ç¤ºä¾‹è€Œè¨€ï¼Œè¿™æ˜¯ä¸å¿…è¦çš„ã€‚ </p><br><p> å› æ­¤ï¼Œè¯·è½¬åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>å¹¶é€‰æ‹©æ‚¨çš„æ“ä½œç³»ç»Ÿã€‚ å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ç±»ä¼¼<code>Linux</code>æ“ä½œç³»ç»Ÿï¼Œè¯·ä¸‹è½½åä¸º<code>mysql-cluster-community-java</code>è½¯ä»¶åŒ…å¹¶å®‰è£…æ­¤rpm / debè½¯ä»¶åŒ…ã€‚ å¦‚æœæ‚¨ä½¿ç”¨<code>Windows</code> ï¼Œè¯·ä¸‹è½½å®Œæ•´çš„<code>mysql-cluster-gp</code>å­˜æ¡£ã€‚ </p><br><p> ä¸€ç§æˆ–å¦ä¸€ç§æ–¹å¼ï¼Œæˆ‘ä»¬å°†å…·æœ‰ä»¥ä¸‹å½¢å¼çš„jaræ–‡ä»¶ï¼š <code>clusterj-{version}.jar</code> ã€‚ æˆ‘ä»¬æŠŠå®ƒé€šè¿‡äº†<code>maven</code> ï¼š </p><br><pre> <code class="bash hljs">mvn install:install-file -DgroupId=com.mysql.ndb -DartifactId=clusterj -Dversion={version} -Dpackaging=jar -Dfile=clusterj-{version}.jar -DgeneratePom=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p> æˆ‘ä»¬è¿˜éœ€è¦<code>libndbclient</code>åº“ï¼Œå®ƒæ˜¯ä¸€ç»„<code>C++</code>å‡½æ•°ï¼Œç”¨äºå¤„ç†<code>ClusterJ</code>é€šè¿‡<code>JNI</code>è°ƒç”¨çš„<code>NDB API</code> ã€‚ å¯¹äº<code>Windows</code>æ­¤åº“ï¼ˆ.dllï¼‰ä½äº<code>mysql-cluster-gp</code>å½’æ¡£æ–‡ä»¶ä¸­ï¼Œå¯¹äº<code>Linux</code>æ‚¨éœ€è¦ä¸‹è½½<code>ndbclient_{version}</code>è½¯ä»¶åŒ…ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ªé¡¹ç›®ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨<code>SpringBoot</code> ï¼Œ <code>JUnit5</code> + <code>TestContainers</code>è¿›è¡Œæµ‹è¯•ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">é¡¹ç›®çš„æœ€ç»ˆç»“æ„</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/v7/6o/hq/v76ohq-aq6lgzhgckpmzhfup0ee.png"></p></div></div><br><p>  <strong>è¯¥é¡¹ç›®åŒ…å«ä¸¤ä¸ªæ¨¡å—ï¼š</strong> </p><br><ul><li>  <code>clusterj-spring-boot-starter</code>æ˜¯ä¸€ä¸ªåŒ…å«<code>ClusterJ</code>ä»¥åŠatoconfigurationçš„å¯åŠ¨å™¨ã€‚ æ„Ÿè°¢è¿™ä¸ªå…¥é—¨è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>appliation.yml</code>æ–‡ä»¶ä¸­æè¿°ä¸<code>MySQL NDB</code>çš„è¿æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </li></ul><br><pre> <code class="plaintext hljs">clusterj: connectString: localhost:1186 dataBaseName: NDB_DB</code> </pre> <br><p> ä¹‹åï¼Œ <code>SpringBoot</code>å°†ä¸ºæˆ‘ä»¬åˆ›å»ºè¿æ¥æ‰€éœ€çš„<code>SessionFactory</code>å·¥å‚ã€‚ </p><br><ul><li>  <code>clusterj-app</code>æ˜¯åº”ç”¨ç¨‹åºæœ¬èº«ï¼Œæˆ‘ä»¬çš„å…¥é—¨äººå‘˜å°†ä½¿ç”¨å®ƒã€‚ è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°è®¨è®ºå®ƒã€‚ </li></ul><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåŸŸæ¨¡å‹ï¼Œä¾‹å¦‚<code>JPA</code> ã€‚ ä»…åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä»¥æ¥å£çš„å½¢å¼æ‰§è¡Œæ­¤æ“ä½œï¼Œåœ¨<code>clusterj</code>å°†ç”±<code>clusterj</code> ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mysql.clusterj.annotation.Column; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mysql.clusterj.annotation.PersistenceCapable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mysql.clusterj.annotation.PrimaryKey; <span class="hljs-meta"><span class="hljs-meta">@PersistenceCapable</span></span>(table = <span class="hljs-string"><span class="hljs-string">"user"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"firstName"</span></span>) <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFirstName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFirstName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String firstName)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"lastName"</span></span>) <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLastName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String lastName)</span></span></span></span>; }</code> </pre> <br><p> é©¬ä¸Šæœ‰é—®é¢˜ã€‚  <code>PersistenceCapable</code>æ‰¹æ³¨å¯ä»¥æŒ‡å®šè¡¨æ‰€åœ¨çš„æ¨¡å¼æˆ–æ•°æ®åº“çš„åç§°ï¼Œä½†è¿™ä¸èµ·ä½œç”¨ã€‚ ç»å¯¹æ˜¯ åœ¨<code>ClusterJ</code>è¿™æ²¡æœ‰å®ç°ã€‚ å› æ­¤ï¼Œæ‰€æœ‰é€šè¿‡<code>ClusterJ</code>å·¥ä½œçš„è¡¨éƒ½åº”åœ¨åŒä¸€æ¨¡å¼ä¸­ï¼Œè¿™å°†å¯¼è‡´è¡¨è½¬å‚¨ï¼Œä»é€»è¾‘<code>ClusterJ</code> ï¼Œè¡¨åº”åœ¨ä¸åŒçš„æ¨¡å¼ä¸­ã€‚ </p><br><p> ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•ä½¿ç”¨æ­¤ç•Œé¢ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•ã€‚ </p><br><p> ä¸ºäº†ä¸éº»çƒ¦å®‰è£…<code>MySQL Cluster</code> ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å‡ºè‰²çš„åº“å¯¹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TestContainers</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Docker</a>è¿›è¡Œé›†æˆæµ‹è¯•ã€‚ ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JUnit5ï¼Œ</a>æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªç®€å•çš„<code>Extension</code> ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ‰©å±•æºä»£ç </b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.github.dockerjava.api.model.Network; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.extern.slf4j.Slf4j; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.extension.Extension; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.BindMode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.GenericContainer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.wait.strategy.Wait; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.shaded.com.google.common.collect.ImmutableMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.time.Duration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Stream; <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MySQLClusterTcExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String MYSQL_USER = <span class="hljs-string"><span class="hljs-string">"sys"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String MYSQL_PASSWORD = <span class="hljs-string"><span class="hljs-string">"qwerty"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String CLUSTERJ_DATABASE = <span class="hljs-string"><span class="hljs-string">"NDB_DB"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Network.<span class="hljs-function"><span class="hljs-function">Ipam </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIpam</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Network.Ipam ipam = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Network.Ipam(); ipam.withDriver(<span class="hljs-string"><span class="hljs-string">"default"</span></span>); Network.Ipam.Config config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Network.Ipam.Config(); config.withSubnet(<span class="hljs-string"><span class="hljs-string">"192.168.0.0/16"</span></span>); ipam.withConfig(config); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ipam; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.testcontainers.containers.Network network = org.testcontainers.containers.Network.builder() .createNetworkCmdModifier(createNetworkCmd -&gt; createNetworkCmd.withIpam(getIpam())) .build(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> GenericContainer ndbMgmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericContainer&lt;&gt;(<span class="hljs-string"><span class="hljs-string">"mysql/mysql-cluster"</span></span>) .withNetwork(network) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"mysql-cluster.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/mysql-cluster.cnf"</span></span>, BindMode.READ_ONLY) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"my.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/my.cnf"</span></span>, BindMode.READ_ONLY) .withCreateContainerCmdModifier(createContainerCmd -&gt; createContainerCmd.withIpv4Address(<span class="hljs-string"><span class="hljs-string">"192.168.0.2"</span></span>)) .withCommand(<span class="hljs-string"><span class="hljs-string">"ndb_mgmd"</span></span>) .withExposedPorts(<span class="hljs-number"><span class="hljs-number">1186</span></span>) .waitingFor(Wait.forListeningPort().withStartupTimeout(Duration.ofSeconds(<span class="hljs-number"><span class="hljs-number">150</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> GenericContainer ndbd1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericContainer&lt;&gt;(<span class="hljs-string"><span class="hljs-string">"mysql/mysql-cluster"</span></span>) .withNetwork(network) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"mysql-cluster.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/mysql-cluster.cnf"</span></span>, BindMode.READ_ONLY) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"my.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/my.cnf"</span></span>, BindMode.READ_ONLY) .withCreateContainerCmdModifier(createContainerCmd -&gt; createContainerCmd.withIpv4Address(<span class="hljs-string"><span class="hljs-string">"192.168.0.3"</span></span>)) .withCommand(<span class="hljs-string"><span class="hljs-string">"ndbd"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> GenericContainer ndbMysqld = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericContainer&lt;&gt;(<span class="hljs-string"><span class="hljs-string">"mysql/mysql-cluster"</span></span>) .withNetwork(network) .withCommand(<span class="hljs-string"><span class="hljs-string">"mysqld"</span></span>) .withCreateContainerCmdModifier(createContainerCmd -&gt; createContainerCmd.withIpv4Address(<span class="hljs-string"><span class="hljs-string">"192.168.0.10"</span></span>)) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"mysql-cluster.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/mysql-cluster.cnf"</span></span>, BindMode.READ_ONLY) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"my.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/my.cnf"</span></span>, BindMode.READ_ONLY) .waitingFor(Wait.forListeningPort()) .withEnv(ImmutableMap.of(<span class="hljs-string"><span class="hljs-string">"MYSQL_DATABASE"</span></span>, CLUSTERJ_DATABASE, <span class="hljs-string"><span class="hljs-string">"MYSQL_USER"</span></span>, MYSQL_USER, <span class="hljs-string"><span class="hljs-string">"MYSQL_PASSWORD"</span></span>, MYSQL_PASSWORD)) .withExposedPorts(<span class="hljs-number"><span class="hljs-number">3306</span></span>) .waitingFor(Wait.forListeningPort()); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { log.info(<span class="hljs-string"><span class="hljs-string">"Start MySQL Cluster testcontainers extension...\n"</span></span>); Stream.of(ndbMgmd, ndbd1, ndbMysqld).forEach(GenericContainer::start); String ndbUrl = ndbMgmd.getContainerIpAddress() + <span class="hljs-string"><span class="hljs-string">":"</span></span> + ndbMgmd.getMappedPort(<span class="hljs-number"><span class="hljs-number">1186</span></span>); String mysqlUrl = ndbMysqld.getContainerIpAddress() + <span class="hljs-string"><span class="hljs-string">":"</span></span> + ndbMysqld.getMappedPort(<span class="hljs-number"><span class="hljs-number">3306</span></span>); String mysqlConnectionString = <span class="hljs-string"><span class="hljs-string">"jdbc:mysql://"</span></span> + mysqlUrl + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + CLUSTERJ_DATABASE + <span class="hljs-string"><span class="hljs-string">"?useUnicode=true"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false"</span></span>; System.setProperty(<span class="hljs-string"><span class="hljs-string">"clusterj.connectString"</span></span>, ndbUrl); System.setProperty(<span class="hljs-string"><span class="hljs-string">"clusterj.dataBaseName"</span></span>, CLUSTERJ_DATABASE); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.username"</span></span>, MYSQL_USER); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.password"</span></span>, MYSQL_PASSWORD); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.url"</span></span>, mysqlConnectionString); } }</code> </pre> </div></div><br><p> åœ¨æ­¤æ‰©å±•ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ç¾¤é›†çš„æ§åˆ¶èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹çš„ä¸€ä¸ªæ—¥æœŸä»¥åŠ<code>MySQL</code>èŠ‚ç‚¹ã€‚ ä¹‹åï¼Œæˆ‘ä»¬è®¾ç½®é€‚å½“çš„è¿æ¥è®¾ç½®ä»¥ä¾›SpringBootä½¿ç”¨ï¼Œå°±åƒæˆ‘ä»¬åœ¨å¯åŠ¨ç¨‹åºè‡ªåŠ¨é…ç½®ä¸­æè¿°çš„é‚£æ ·ï¼š </p><br><pre> <code class="java hljs">System.setProperty(<span class="hljs-string"><span class="hljs-string">"clusterj.connectString"</span></span>, ndbUrl); System.setProperty(<span class="hljs-string"><span class="hljs-string">"clusterj.dataBaseName"</span></span>, CLUSTERJ_DATABASE); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.username"</span></span>, MYSQL_USER); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.password"</span></span>, MYSQL_PASSWORD); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.url"</span></span>, mysqlConnectionString);</code> </pre> <br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæ³¨é‡Šï¼Œä½¿æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ä¸­å£°æ˜æ€§åœ°å¼•å‘å®¹å™¨ã€‚ è¿™é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨æ‰©å±•ç¨‹åºï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@ExtendWith</span></span>(MySQLClusterTcExtension.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> EnableMySQLClusterContainer { }</code> </pre> <br><p> æœ€åï¼Œæˆ‘ä»¬ç¼–å†™æµ‹è¯•ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shouldGetUserViaClusterJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User newUser = session.newInstance(User.class); newUser.setId(<span class="hljs-number"><span class="hljs-number">1</span></span>); newUser.setFirstName(<span class="hljs-string"><span class="hljs-string">"John"</span></span>); newUser.setLastName(<span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>); session.persist(newUser); User userFromDb = session.find(User.class, <span class="hljs-number"><span class="hljs-number">1</span></span>); assertAll( () -&gt; assertEquals(userFromDb.getId(), <span class="hljs-number"><span class="hljs-number">1</span></span>), () -&gt; assertEquals(userFromDb.getFirstName(), <span class="hljs-string"><span class="hljs-string">"John"</span></span>), () -&gt; assertEquals(userFromDb.getLastName(), <span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>)); }</code> </pre> <br><p> æ­¤æµ‹è¯•æ˜¾ç¤ºäº†å¦‚ä½•é€šè¿‡ä¸»é”®è·å–è®°å½•ã€‚ æ­¤æŸ¥è¯¢ç­‰æ•ˆäº<code>SQL</code>æŸ¥è¯¢ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p> è®©æˆ‘ä»¬ç”¨æ›´å¤æ‚çš„é€»è¾‘åšå¦ä¸€ä¸ªæµ‹è¯•ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queryBuilderTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ QueryBuilder builder = session.getQueryBuilder(); QueryDomainType&lt;User&gt; userQueryDomainType = builder.createQueryDefinition(User.class); <span class="hljs-comment"><span class="hljs-comment">// parameter PredicateOperand propertyIdParam = userQueryDomainType.param("lastName"); // property PredicateOperand propertyEntityId = userQueryDomainType.get("lastName"); userQueryDomainType.where(propertyEntityId.equal(propertyIdParam)); Query&lt;User&gt; query = session.createQuery(userQueryDomainType); query.setParameter("lastName", "Jonson"); List&lt;User&gt; foundEntities = query.getResultList(); Optional&lt;User&gt; firstUser = foundEntities.stream().filter(u -&gt; u.getId() == 1).findFirst(); Optional&lt;User&gt; secondUser = foundEntities.stream().filter(u -&gt; u.getId() == 2).findFirst(); assertAll( () -&gt; assertEquals(foundEntities.size(), 2), () -&gt; assertTrue(firstUser.isPresent()), () -&gt; assertTrue(secondUser.isPresent()), () -&gt; assertThat(firstUser.get(), allOf( hasProperty("firstName", equalTo("John")), hasProperty("lastName", equalTo("Jonson")) ) ), () -&gt; assertThat(secondUser.get(), allOf( hasProperty("firstName", equalTo("Alex")), hasProperty("lastName", equalTo("Jonson")) ) ) ); }</span></span></code> </pre> <br><p>  <code>QueryBuilder</code>ç”¨äºä»¥<code>in</code> ï¼Œ <code>where</code> ï¼Œ <code>equal</code> <code>QueryBuilder</code> ï¼ˆ <code>like</code> <code>QueryBuilder</code>æ„å»ºå¤æ‚çš„æŸ¥è¯¢ã€‚ åœ¨æ­¤æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æå–äº†å§“æ°= Jonsonçš„æ‰€æœ‰ç”¨æˆ·ã€‚ æ­¤æŸ¥è¯¢ç­‰æ•ˆäºä»¥ä¸‹<code>SQL</code> ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> lastName = <span class="hljs-string"><span class="hljs-string">'Jonson'</span></span>;</code> </pre> <br><p> è¿™é‡Œä¹Ÿé‡åˆ°äº†é—®é¢˜ã€‚ æ— æ³•ç»„æˆä»¥ä¸‹å½¢å¼çš„æŸ¥è¯¢ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (lastName = <span class="hljs-string"><span class="hljs-string">'Jonson'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> firstName = <span class="hljs-string"><span class="hljs-string">'John'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br><p> å½“å‰æœªå®ç°æ­¤åŠŸèƒ½ã€‚ æ‚¨å¯ä»¥çœ‹åˆ°æµ‹è¯•ï¼š <code>andOrNotImplemented</code> ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å®Œæ•´çš„æµ‹è¯•ç¤ºä¾‹</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ExtendWith</span></span>(SpringExtension.class) <span class="hljs-meta"><span class="hljs-meta">@EnableAutoConfiguration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableMySQLClusterContainer</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NdbClusterJTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> JdbcTemplate jdbcTemplate; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SessionFactory sessionFactory; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Session session; <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ jdbcTemplate.execute(<span class="hljs-string"><span class="hljs-string">"CREATE TABLE IF NOT EXISTS `user` (id INT NOT NULL PRIMARY KEY,"</span></span> + <span class="hljs-string"><span class="hljs-string">" firstName VARCHAR(64) DEFAULT NULL,"</span></span> + <span class="hljs-string"><span class="hljs-string">" lastName VARCHAR(64) DEFAULT NULL) ENGINE=NDBCLUSTER;"</span></span>); session = sessionFactory.getSession(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shouldGetUserViaClusterJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User newUser = session.newInstance(User.class); newUser.setId(<span class="hljs-number"><span class="hljs-number">1</span></span>); newUser.setFirstName(<span class="hljs-string"><span class="hljs-string">"John"</span></span>); newUser.setLastName(<span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>); session.persist(newUser); User userFromDb = session.find(User.class, <span class="hljs-number"><span class="hljs-number">1</span></span>); assertAll( () -&gt; assertEquals(userFromDb.getId(), <span class="hljs-number"><span class="hljs-number">1</span></span>), () -&gt; assertEquals(userFromDb.getFirstName(), <span class="hljs-string"><span class="hljs-string">"John"</span></span>), () -&gt; assertEquals(userFromDb.getLastName(), <span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queryBuilderTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User newUser1 = session.newInstance(User.class); newUser1.setId(<span class="hljs-number"><span class="hljs-number">1</span></span>); newUser1.setFirstName(<span class="hljs-string"><span class="hljs-string">"John"</span></span>); newUser1.setLastName(<span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>); User newUser2 = session.newInstance(User.class); newUser2.setId(<span class="hljs-number"><span class="hljs-number">2</span></span>); newUser2.setFirstName(<span class="hljs-string"><span class="hljs-string">"Alex"</span></span>); newUser2.setLastName(<span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>); session.persist(newUser1); session.persist(newUser2); QueryBuilder builder = session.getQueryBuilder(); QueryDomainType&lt;User&gt; userQueryDomainType = builder.createQueryDefinition(User.class); <span class="hljs-comment"><span class="hljs-comment">// parameter PredicateOperand propertyIdParam = userQueryDomainType.param("lastName"); // property PredicateOperand propertyEntityId = userQueryDomainType.get("lastName"); userQueryDomainType.where(propertyEntityId.equal(propertyIdParam)); Query&lt;User&gt; query = session.createQuery(userQueryDomainType); query.setParameter("lastName", "Jonson"); List&lt;User&gt; foundEntities = query.getResultList(); Optional&lt;User&gt; firstUser = foundEntities.stream().filter(u -&gt; u.getId() == 1).findFirst(); Optional&lt;User&gt; secondUser = foundEntities.stream().filter(u -&gt; u.getId() == 2).findFirst(); assertAll( () -&gt; assertEquals(foundEntities.size(), 2), () -&gt; assertTrue(firstUser.isPresent()), () -&gt; assertTrue(secondUser.isPresent()), () -&gt; assertThat(firstUser.get(), allOf( hasProperty("firstName", equalTo("John")), hasProperty("lastName", equalTo("Jonson")) ) ), () -&gt; assertThat(secondUser.get(), allOf( hasProperty("firstName", equalTo("Alex")), hasProperty("lastName", equalTo("Jonson")) ) ) ); } @Test void andOrNotImplemented() { QueryBuilder builder = session.getQueryBuilder(); QueryDomainType&lt;User&gt; userQueryDomainType = builder.createQueryDefinition(User.class); // parameter PredicateOperand firstNameParam = userQueryDomainType.param("firstName"); // property PredicateOperand firstName = userQueryDomainType.get("firstName"); // parameter PredicateOperand lastNameParam = userQueryDomainType.param("lastName"); // property PredicateOperand lastName = userQueryDomainType.get("lastName"); // parameter PredicateOperand idParam = userQueryDomainType.param("id"); // property PredicateOperand id = userQueryDomainType.get("id"); Executable executable = () -&gt; userQueryDomainType.where(firstNameParam.equal(firstName) .and(lastNameParam.equal(lastName)) .or(idParam.equal(id))); UnsupportedOperationException exception = assertThrows(UnsupportedOperationException.class, executable); assertEquals("Not implemented.", exception.getMessage()); } @AfterEach void tearDown() { session.deletePersistentAll(User.class); session.close(); } }</span></span></code> </pre> </div></div><br><p> æ„Ÿè°¢æˆ‘ä»¬çš„æ³¨é‡Š<code>@EnableMySQLClusterContainer</code> ï¼Œæˆ‘ä»¬éšè—äº†å‡†å¤‡æµ‹è¯•ç¯å¢ƒçš„è¯¦ç»†ä¿¡æ¯ã€‚ åŒæ ·ï¼Œç”±äºæˆ‘ä»¬çš„å…¥é—¨è€…ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†SessionFactoryæ³¨å…¥æˆ‘ä»¬çš„æµ‹è¯•ä¸­ï¼Œå¹¶å°†å…¶ç”¨äºæˆ‘ä»¬çš„éœ€æ±‚ï¼Œè€Œä¸å¿…æ‹…å¿ƒéœ€è¦æ‰‹åŠ¨åˆ›å»ºå®ƒçš„äº‹å®ã€‚ <br> æ‰€æœ‰è¿™äº›ä½¿æˆ‘ä»¬ä¸“æ³¨äºç¼–å†™æµ‹è¯•çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯æœåŠ¡åŸºç¡€ç»“æ„ã€‚ </p><br><p> æˆ‘è¿˜æƒ³æ³¨æ„ä¸€ä¸ªäº‹å®ï¼Œæ‚¨éœ€è¦è¿è¡Œä¸€ä¸ªå°†<code>ClusterJ</code>ä¸å‚æ•°ä¸€èµ·ä½¿ç”¨çš„åº”ç”¨ç¨‹åºï¼š </p><br><pre> <code class="bash hljs">-Djava.library.path=/usr/lib/x86_64-linux-gnu/</code> </pre> <br><p> å…¶ä¸­æ˜¾ç¤ºäº†<code>libndbclient.so</code>çš„è·¯å¾„ã€‚ æ²¡æœ‰å®ƒï¼Œä»€ä¹ˆéƒ½ä¸ä¼šèµ·ä½œç”¨ã€‚ </p><br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p> å¯¹äºæˆ‘æ¥è¯´ï¼Œåœ¨é‚£äº›å¯¹æ•°æ®è®¿é—®é€Ÿåº¦è‡³å…³é‡è¦çš„ç³»ç»Ÿä¸­ï¼Œ <code>ClusterJ</code>ä¸€ä»¶å¥½äº‹ï¼Œä½†ç»†å¾®çš„ç¼ºé™·å’Œé™åˆ¶ç ´åäº†æ•´ä½“å°è±¡ã€‚ å¦‚æœæ‚¨æœ‰æœºä¼šé€‰æ‹©å¹¶ä¸”ä¸å…³å¿ƒè®¿é—®é€Ÿåº¦ï¼Œé‚£ä¹ˆæˆ‘è®¤ä¸ºä½¿ç”¨<code>JDBC</code>æ›´å¥½ã€‚ </p><br><p> æœ¬æ–‡æ²¡æœ‰è€ƒè™‘ä½¿ç”¨äº‹åŠ¡å’Œé”ï¼Œå› æ­¤ç»“æœå¾ˆå¤šã€‚ </p><br><p> å°±æ˜¯è¿™æ ·ï¼Œå¿«ä¹ç¼–ç ï¼ </p><br><h2 id="poleznye-ssylki"> æœ‰ç”¨çš„é“¾æ¥ï¼š </h2><br><p> è¯¥é¡¹ç›®çš„æ‰€æœ‰ä»£ç éƒ½ä½äº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸‹è½½</a>é¡µé¢ <br> æœ‰å…³<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ClusterJçš„</a>ä¿¡æ¯ <br> ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Javaå’ŒNDBé›†ç¾¤</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Pro MySQL NDB</a>ä¸›ä¹¦ <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>äº†è§£æœ‰å…³MySQL NDBç¾¤é›†çš„æ›´å¤šä¿¡æ¯ </p><br><p>  <code>MySQL</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å­˜å‚¨åº“</a>æœ¬èº«ä¸­è¿˜æœ‰æ›´å¤šæµ‹è¯•ç”¨ä¾‹ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN472468/">https://habr.com/ru/post/zh-CN472468/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN472452/index.html">å¦‚ä½•åœ¨iOSåº”ç”¨ç¨‹åºä¸­æ·»åŠ å¯¹å®½é™æœŸï¼ˆè®¡è´¹å®½é™æœŸï¼‰çš„æ”¯æŒï¼Ÿ</a></li>
<li><a href="../zh-CN472454/index.html">å»‰ä»·VPSæœåŠ¡å™¨æ¦‚è¿°</a></li>
<li><a href="../zh-CN472462/index.html">ä¸‹è¯ºå¤«å“¥ç½—å¾·çš„iFestï¼šITä»¤äººå°è±¡æ·±åˆ»</a></li>
<li><a href="../zh-CN472464/index.html">åœ¨Raspberry Piä¸Šåˆ¶ä½œPythonæœåŠ¡å™¨çš„5ç§æ–¹æ³• ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN472466/index.html">æŒ‰åˆ†å¸ƒæ’åº</a></li>
<li><a href="../zh-CN472470/index.html">è½¬åŸºå› å°é¼ å’ŒæŠ—è¡°è€</a></li>
<li><a href="../zh-CN472472/index.html">å†¬å¤©çš„å°å±‹ï¼šæ˜¯è¿˜æ˜¯ä¸æ˜¯ï¼Ÿ</a></li>
<li><a href="../zh-CN472474/index.html">Google Chromeä¸­æœ‰è¶£çš„å¤–è§‚é”™è¯¯</a></li>
<li><a href="../zh-CN472482/index.html">æ”¾å°„æ€§äº‹æ•…ï¼šå‘ç°açš„å›ºä½“ç¨³å®šç›¸</a></li>
<li><a href="../zh-CN472484/index.html">å°é—­Kubernetesé›†ç¾¤ä¸­çš„æ¼æ´ã€‚ ä½¿ç”¨DevOpsConfæŠ¥å‘Šå’Œæˆç»©å•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>