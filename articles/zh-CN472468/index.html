<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⚛️ 🙆 💆🏻 ClusterJ-从Java使用MySQL NDB Cluster 🔸 🐛 🎚️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="哈Ha！ 在本文中，我想考虑一个Java库，例如ClusterJ ，它使使用Java代码的MySQL NDBCLUSTER引擎变得非常容易，该引擎的概念类似于JPA和Hibernate ，是高级API。 


 在本文的框架中，我们将在SpringBoot上创建一个简单的应用程序，并使用Cluste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ClusterJ-从Java使用MySQL NDB Cluster</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472468/"><p>哈Ha！ 在本文中，我想考虑一个Java库，例如<code>ClusterJ</code> ，它使使用<code>Java</code>代码的<code>MySQL NDBCLUSTER</code>引擎变得非常容易，该引擎的概念类似于<code>JPA</code>和<code>Hibernate</code> ，是高级API。 </p><br><p> 在本文的框架中，我们将在<code>SpringBoot</code>上创建一个简单的应用程序，并使用<code>ClusterJ</code>创建一个入门<code>ClusterJ</code> ，以便在使用自动配置的应用程序中方便使用。 我们将使用<code>JUnit5</code>和<code>TestContainers</code>编写简单的测试，这些测试将显示API的基本用法。 <br> 我还将讨论在与她合作的过程中我必须面对的几个缺点。 </p><br><p> 谁在乎，欢迎来猫。 </p><a name="habracut"></a><br><h2 id="vvedenie"> 引言 </h2><br><p> 为了提高速度， <code>MySQL NDB Cluster</code>在工作中和一个项目中<code>MySQL NDB Cluster</code>积极使用，其任务是使用<code>ClusterJ</code>库而不是通常的<code>JDBC</code> ，后者的API与<code>JPA</code>非常相似，并且实际上是<code>libndbclient.so</code>库的包装器，它是通过<code>JNI</code>使用的。 </p><br><blockquote> 对于那些不了解的人，MySQL NDB Cluster是一个高度可访问且冗余的MySQL版本，适用于使用<code>NDB</code>存储<code>NDB</code> （ <code>NDBCLUSTER</code> ）在群集中运行的分布式计算环境。 我不想在这里详细介绍，您可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>阅读更多内容 </blockquote><p>  <strong>使用该数据库的Java代码有两种方法：</strong> </p><br><ul><li> 标准，通过<code>JDBC</code>和<code>SQL</code>查询 </li><li> 通过<code>ClusterJ</code> ，用于<code>MySQL Cluster</code>中的高性能数据访问。 </li></ul><br><p><img src="https://habrastorage.org/webt/lk/cw/-e/lkcw-emutbnjzldw2eqvgzqs-dg.png" alt="图片"></p><br><p>  <strong>ClusterJ基于4个关键概念构建：</strong> </p><br><ul><li>  <code>SessionFactory</code>连接池的类似物，用于获取会话。 群集的每个实例都必须具有自己的SessionFactory。 </li><li>  <code>Session</code> -是与<code>MySQL</code>群集的直接连接。 </li><li>  <code>Domain Object</code> -带注释的接口，表示表到<code>Java</code>代码的映射，类似于<code>JPA</code> 。 </li><li>  <code>Transaction</code> -是工作的原子单元。 在任何给定时间，在一个会话中，将执行一个事务。 任何操作（接收，插入，更新，删除）都在新事务中执行。 </li></ul><br><p>  <strong>ClusterJ的局限性：</strong> </p><br><ul><li> 缺乏加盟 </li><li> 无法创建表和索引。 为此，请使用<code>JDBC</code> 。 </li><li> 没有延迟加载（ <code>Lazy</code> ）。 整个记录一次下载。 </li><li> 在域对象中，无法定义表之间的关系。 完全没有<code>OneToMany</code> ， <code>ManyToOne</code> ， <code>ManyToMany</code>的相似性。 </li></ul><br><h2 id="praktika-talk-is-cheap-show-me-the-code"> 练习 谈话很便宜。 给我看代码。 </h2><br><p> 好了，理论足够多，让我们继续练习。 </p><br><p> 面临的第一个问题是中央Maven存储库中缺少<code>ClusterJ</code> 。 用笔将库安装在本地存储库中。 很明显，它应该位于<code>Nexus</code>或某些<code>Artifactory</code> ，但对于我们的示例而言，这是不必要的。 </p><br><p> 因此，请转到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>并选择您的操作系统。 如果您使用的是类似<code>Linux</code>操作系统，请下载名为<code>mysql-cluster-community-java</code>软件包并安装此rpm / deb软件包。 如果您使用<code>Windows</code> ，请下载完整的<code>mysql-cluster-gp</code>存档。 </p><br><p> 一种或另一种方式，我们将具有以下形式的jar文件： <code>clusterj-{version}.jar</code> 。 我们把它通过了<code>maven</code> ： </p><br><pre> <code class="bash hljs">mvn install:install-file -DgroupId=com.mysql.ndb -DartifactId=clusterj -Dversion={version} -Dpackaging=jar -Dfile=clusterj-{version}.jar -DgeneratePom=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p> 我们还需要<code>libndbclient</code>库，它是一组<code>C++</code>函数，用于处理<code>ClusterJ</code>通过<code>JNI</code>调用的<code>NDB API</code> 。 对于<code>Windows</code>此库（.dll）位于<code>mysql-cluster-gp</code>归档文件中，对于<code>Linux</code>您需要下载<code>ndbclient_{version}</code>软件包。 </p><br><p> 接下来，创建一个项目。 我们将使用<code>SpringBoot</code> ， <code>JUnit5</code> + <code>TestContainers</code>进行测试。 </p><br><div class="spoiler">  <b class="spoiler_title">项目的最终结构</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/v7/6o/hq/v76ohq-aq6lgzhgckpmzhfup0ee.png"></p></div></div><br><p>  <strong>该项目包含两个模块：</strong> </p><br><ul><li>  <code>clusterj-spring-boot-starter</code>是一个包含<code>ClusterJ</code>以及atoconfiguration的启动器。 感谢这个入门者，我们可以在<code>appliation.yml</code>文件中描述与<code>MySQL NDB</code>的连接，如下所示： </li></ul><br><pre> <code class="plaintext hljs">clusterj: connectString: localhost:1186 dataBaseName: NDB_DB</code> </pre> <br><p> 之后， <code>SpringBoot</code>将为我们创建连接所需的<code>SessionFactory</code>工厂。 </p><br><ul><li>  <code>clusterj-app</code>是应用程序本身，我们的入门人员将使用它。 让我们更详细地讨论它。 </li></ul><br><p> 首先，我们需要创建一个域模型，例如<code>JPA</code> 。 仅在这种情况下，我们需要以接口的形式执行此操作，在<code>clusterj</code>将由<code>clusterj</code> ： </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mysql.clusterj.annotation.Column; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mysql.clusterj.annotation.PersistenceCapable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mysql.clusterj.annotation.PrimaryKey; <span class="hljs-meta"><span class="hljs-meta">@PersistenceCapable</span></span>(table = <span class="hljs-string"><span class="hljs-string">"user"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"firstName"</span></span>) <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFirstName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFirstName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String firstName)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"lastName"</span></span>) <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLastName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String lastName)</span></span></span></span>; }</code> </pre> <br><p> 马上有问题。  <code>PersistenceCapable</code>批注可以指定表所在的模式或数据库的名称，但这不起作用。 绝对是 在<code>ClusterJ</code>这没有实现。 因此，所有通过<code>ClusterJ</code>工作的表都应在同一模式中，这将导致表转储，从逻辑<code>ClusterJ</code> ，表应在不同的模式中。 </p><br><p> 现在，让我们尝试使用此界面。 为此，我们编写了一个简单的测试。 </p><br><p> 为了不麻烦安装<code>MySQL Cluster</code> ，我们将使用出色的库对<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TestContainers</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Docker</a>进行集成测试。 由于我们使用的是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JUnit5，</a>我们将编写一个简单的<code>Extension</code> ： </p><br><div class="spoiler">  <b class="spoiler_title">扩展源代码</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.github.dockerjava.api.model.Network; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.extern.slf4j.Slf4j; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.extension.Extension; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.BindMode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.GenericContainer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.wait.strategy.Wait; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.shaded.com.google.common.collect.ImmutableMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.time.Duration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Stream; <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MySQLClusterTcExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String MYSQL_USER = <span class="hljs-string"><span class="hljs-string">"sys"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String MYSQL_PASSWORD = <span class="hljs-string"><span class="hljs-string">"qwerty"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String CLUSTERJ_DATABASE = <span class="hljs-string"><span class="hljs-string">"NDB_DB"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Network.<span class="hljs-function"><span class="hljs-function">Ipam </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIpam</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Network.Ipam ipam = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Network.Ipam(); ipam.withDriver(<span class="hljs-string"><span class="hljs-string">"default"</span></span>); Network.Ipam.Config config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Network.Ipam.Config(); config.withSubnet(<span class="hljs-string"><span class="hljs-string">"192.168.0.0/16"</span></span>); ipam.withConfig(config); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ipam; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.testcontainers.containers.Network network = org.testcontainers.containers.Network.builder() .createNetworkCmdModifier(createNetworkCmd -&gt; createNetworkCmd.withIpam(getIpam())) .build(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> GenericContainer ndbMgmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericContainer&lt;&gt;(<span class="hljs-string"><span class="hljs-string">"mysql/mysql-cluster"</span></span>) .withNetwork(network) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"mysql-cluster.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/mysql-cluster.cnf"</span></span>, BindMode.READ_ONLY) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"my.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/my.cnf"</span></span>, BindMode.READ_ONLY) .withCreateContainerCmdModifier(createContainerCmd -&gt; createContainerCmd.withIpv4Address(<span class="hljs-string"><span class="hljs-string">"192.168.0.2"</span></span>)) .withCommand(<span class="hljs-string"><span class="hljs-string">"ndb_mgmd"</span></span>) .withExposedPorts(<span class="hljs-number"><span class="hljs-number">1186</span></span>) .waitingFor(Wait.forListeningPort().withStartupTimeout(Duration.ofSeconds(<span class="hljs-number"><span class="hljs-number">150</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> GenericContainer ndbd1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericContainer&lt;&gt;(<span class="hljs-string"><span class="hljs-string">"mysql/mysql-cluster"</span></span>) .withNetwork(network) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"mysql-cluster.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/mysql-cluster.cnf"</span></span>, BindMode.READ_ONLY) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"my.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/my.cnf"</span></span>, BindMode.READ_ONLY) .withCreateContainerCmdModifier(createContainerCmd -&gt; createContainerCmd.withIpv4Address(<span class="hljs-string"><span class="hljs-string">"192.168.0.3"</span></span>)) .withCommand(<span class="hljs-string"><span class="hljs-string">"ndbd"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> GenericContainer ndbMysqld = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericContainer&lt;&gt;(<span class="hljs-string"><span class="hljs-string">"mysql/mysql-cluster"</span></span>) .withNetwork(network) .withCommand(<span class="hljs-string"><span class="hljs-string">"mysqld"</span></span>) .withCreateContainerCmdModifier(createContainerCmd -&gt; createContainerCmd.withIpv4Address(<span class="hljs-string"><span class="hljs-string">"192.168.0.10"</span></span>)) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"mysql-cluster.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/mysql-cluster.cnf"</span></span>, BindMode.READ_ONLY) .withClasspathResourceMapping(<span class="hljs-string"><span class="hljs-string">"my.cnf"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/my.cnf"</span></span>, BindMode.READ_ONLY) .waitingFor(Wait.forListeningPort()) .withEnv(ImmutableMap.of(<span class="hljs-string"><span class="hljs-string">"MYSQL_DATABASE"</span></span>, CLUSTERJ_DATABASE, <span class="hljs-string"><span class="hljs-string">"MYSQL_USER"</span></span>, MYSQL_USER, <span class="hljs-string"><span class="hljs-string">"MYSQL_PASSWORD"</span></span>, MYSQL_PASSWORD)) .withExposedPorts(<span class="hljs-number"><span class="hljs-number">3306</span></span>) .waitingFor(Wait.forListeningPort()); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { log.info(<span class="hljs-string"><span class="hljs-string">"Start MySQL Cluster testcontainers extension...\n"</span></span>); Stream.of(ndbMgmd, ndbd1, ndbMysqld).forEach(GenericContainer::start); String ndbUrl = ndbMgmd.getContainerIpAddress() + <span class="hljs-string"><span class="hljs-string">":"</span></span> + ndbMgmd.getMappedPort(<span class="hljs-number"><span class="hljs-number">1186</span></span>); String mysqlUrl = ndbMysqld.getContainerIpAddress() + <span class="hljs-string"><span class="hljs-string">":"</span></span> + ndbMysqld.getMappedPort(<span class="hljs-number"><span class="hljs-number">3306</span></span>); String mysqlConnectionString = <span class="hljs-string"><span class="hljs-string">"jdbc:mysql://"</span></span> + mysqlUrl + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + CLUSTERJ_DATABASE + <span class="hljs-string"><span class="hljs-string">"?useUnicode=true"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false"</span></span>; System.setProperty(<span class="hljs-string"><span class="hljs-string">"clusterj.connectString"</span></span>, ndbUrl); System.setProperty(<span class="hljs-string"><span class="hljs-string">"clusterj.dataBaseName"</span></span>, CLUSTERJ_DATABASE); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.username"</span></span>, MYSQL_USER); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.password"</span></span>, MYSQL_PASSWORD); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.url"</span></span>, mysqlConnectionString); } }</code> </pre> </div></div><br><p> 在此扩展中，我们提出了群集的控制节点，该节点的一个日期以及<code>MySQL</code>节点。 之后，我们设置适当的连接设置以供SpringBoot使用，就像我们在启动程序自动配置中描述的那样： </p><br><pre> <code class="java hljs">System.setProperty(<span class="hljs-string"><span class="hljs-string">"clusterj.connectString"</span></span>, ndbUrl); System.setProperty(<span class="hljs-string"><span class="hljs-string">"clusterj.dataBaseName"</span></span>, CLUSTERJ_DATABASE); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.username"</span></span>, MYSQL_USER); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.password"</span></span>, MYSQL_PASSWORD); System.setProperty(<span class="hljs-string"><span class="hljs-string">"spring.datasource.url"</span></span>, mysqlConnectionString);</code> </pre> <br><p> 接下来，我们编写一个注释，使我们可以在测试中声明性地引发容器。 这里的一切都很简单，我们使用扩展程序： </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@ExtendWith</span></span>(MySQLClusterTcExtension.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> EnableMySQLClusterContainer { }</code> </pre> <br><p> 最后，我们编写测试： </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shouldGetUserViaClusterJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User newUser = session.newInstance(User.class); newUser.setId(<span class="hljs-number"><span class="hljs-number">1</span></span>); newUser.setFirstName(<span class="hljs-string"><span class="hljs-string">"John"</span></span>); newUser.setLastName(<span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>); session.persist(newUser); User userFromDb = session.find(User.class, <span class="hljs-number"><span class="hljs-number">1</span></span>); assertAll( () -&gt; assertEquals(userFromDb.getId(), <span class="hljs-number"><span class="hljs-number">1</span></span>), () -&gt; assertEquals(userFromDb.getFirstName(), <span class="hljs-string"><span class="hljs-string">"John"</span></span>), () -&gt; assertEquals(userFromDb.getLastName(), <span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>)); }</code> </pre> <br><p> 此测试显示了如何通过主键获取记录。 此查询等效于<code>SQL</code>查询： </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p> 让我们用更复杂的逻辑做另一个测试： </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queryBuilderTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ QueryBuilder builder = session.getQueryBuilder(); QueryDomainType&lt;User&gt; userQueryDomainType = builder.createQueryDefinition(User.class); <span class="hljs-comment"><span class="hljs-comment">// parameter PredicateOperand propertyIdParam = userQueryDomainType.param("lastName"); // property PredicateOperand propertyEntityId = userQueryDomainType.get("lastName"); userQueryDomainType.where(propertyEntityId.equal(propertyIdParam)); Query&lt;User&gt; query = session.createQuery(userQueryDomainType); query.setParameter("lastName", "Jonson"); List&lt;User&gt; foundEntities = query.getResultList(); Optional&lt;User&gt; firstUser = foundEntities.stream().filter(u -&gt; u.getId() == 1).findFirst(); Optional&lt;User&gt; secondUser = foundEntities.stream().filter(u -&gt; u.getId() == 2).findFirst(); assertAll( () -&gt; assertEquals(foundEntities.size(), 2), () -&gt; assertTrue(firstUser.isPresent()), () -&gt; assertTrue(secondUser.isPresent()), () -&gt; assertThat(firstUser.get(), allOf( hasProperty("firstName", equalTo("John")), hasProperty("lastName", equalTo("Jonson")) ) ), () -&gt; assertThat(secondUser.get(), allOf( hasProperty("firstName", equalTo("Alex")), hasProperty("lastName", equalTo("Jonson")) ) ) ); }</span></span></code> </pre> <br><p>  <code>QueryBuilder</code>用于以<code>in</code> ， <code>where</code> ， <code>equal</code> <code>QueryBuilder</code> （ <code>like</code> <code>QueryBuilder</code>构建复杂的查询。 在此测试中，我们提取了姓氏= Jonson的所有用户。 此查询等效于以下<code>SQL</code> ： </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> lastName = <span class="hljs-string"><span class="hljs-string">'Jonson'</span></span>;</code> </pre> <br><p> 这里也遇到了问题。 无法组成以下形式的查询： </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (lastName = <span class="hljs-string"><span class="hljs-string">'Jonson'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> firstName = <span class="hljs-string"><span class="hljs-string">'John'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br><p> 当前未实现此功能。 您可以看到测试： <code>andOrNotImplemented</code> 。 </p><br><div class="spoiler">  <b class="spoiler_title">完整的测试示例</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ExtendWith</span></span>(SpringExtension.class) <span class="hljs-meta"><span class="hljs-meta">@EnableAutoConfiguration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableMySQLClusterContainer</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NdbClusterJTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> JdbcTemplate jdbcTemplate; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SessionFactory sessionFactory; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Session session; <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ jdbcTemplate.execute(<span class="hljs-string"><span class="hljs-string">"CREATE TABLE IF NOT EXISTS `user` (id INT NOT NULL PRIMARY KEY,"</span></span> + <span class="hljs-string"><span class="hljs-string">" firstName VARCHAR(64) DEFAULT NULL,"</span></span> + <span class="hljs-string"><span class="hljs-string">" lastName VARCHAR(64) DEFAULT NULL) ENGINE=NDBCLUSTER;"</span></span>); session = sessionFactory.getSession(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shouldGetUserViaClusterJ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User newUser = session.newInstance(User.class); newUser.setId(<span class="hljs-number"><span class="hljs-number">1</span></span>); newUser.setFirstName(<span class="hljs-string"><span class="hljs-string">"John"</span></span>); newUser.setLastName(<span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>); session.persist(newUser); User userFromDb = session.find(User.class, <span class="hljs-number"><span class="hljs-number">1</span></span>); assertAll( () -&gt; assertEquals(userFromDb.getId(), <span class="hljs-number"><span class="hljs-number">1</span></span>), () -&gt; assertEquals(userFromDb.getFirstName(), <span class="hljs-string"><span class="hljs-string">"John"</span></span>), () -&gt; assertEquals(userFromDb.getLastName(), <span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queryBuilderTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ User newUser1 = session.newInstance(User.class); newUser1.setId(<span class="hljs-number"><span class="hljs-number">1</span></span>); newUser1.setFirstName(<span class="hljs-string"><span class="hljs-string">"John"</span></span>); newUser1.setLastName(<span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>); User newUser2 = session.newInstance(User.class); newUser2.setId(<span class="hljs-number"><span class="hljs-number">2</span></span>); newUser2.setFirstName(<span class="hljs-string"><span class="hljs-string">"Alex"</span></span>); newUser2.setLastName(<span class="hljs-string"><span class="hljs-string">"Jonson"</span></span>); session.persist(newUser1); session.persist(newUser2); QueryBuilder builder = session.getQueryBuilder(); QueryDomainType&lt;User&gt; userQueryDomainType = builder.createQueryDefinition(User.class); <span class="hljs-comment"><span class="hljs-comment">// parameter PredicateOperand propertyIdParam = userQueryDomainType.param("lastName"); // property PredicateOperand propertyEntityId = userQueryDomainType.get("lastName"); userQueryDomainType.where(propertyEntityId.equal(propertyIdParam)); Query&lt;User&gt; query = session.createQuery(userQueryDomainType); query.setParameter("lastName", "Jonson"); List&lt;User&gt; foundEntities = query.getResultList(); Optional&lt;User&gt; firstUser = foundEntities.stream().filter(u -&gt; u.getId() == 1).findFirst(); Optional&lt;User&gt; secondUser = foundEntities.stream().filter(u -&gt; u.getId() == 2).findFirst(); assertAll( () -&gt; assertEquals(foundEntities.size(), 2), () -&gt; assertTrue(firstUser.isPresent()), () -&gt; assertTrue(secondUser.isPresent()), () -&gt; assertThat(firstUser.get(), allOf( hasProperty("firstName", equalTo("John")), hasProperty("lastName", equalTo("Jonson")) ) ), () -&gt; assertThat(secondUser.get(), allOf( hasProperty("firstName", equalTo("Alex")), hasProperty("lastName", equalTo("Jonson")) ) ) ); } @Test void andOrNotImplemented() { QueryBuilder builder = session.getQueryBuilder(); QueryDomainType&lt;User&gt; userQueryDomainType = builder.createQueryDefinition(User.class); // parameter PredicateOperand firstNameParam = userQueryDomainType.param("firstName"); // property PredicateOperand firstName = userQueryDomainType.get("firstName"); // parameter PredicateOperand lastNameParam = userQueryDomainType.param("lastName"); // property PredicateOperand lastName = userQueryDomainType.get("lastName"); // parameter PredicateOperand idParam = userQueryDomainType.param("id"); // property PredicateOperand id = userQueryDomainType.get("id"); Executable executable = () -&gt; userQueryDomainType.where(firstNameParam.equal(firstName) .and(lastNameParam.equal(lastName)) .or(idParam.equal(id))); UnsupportedOperationException exception = assertThrows(UnsupportedOperationException.class, executable); assertEquals("Not implemented.", exception.getMessage()); } @AfterEach void tearDown() { session.deletePersistentAll(User.class); session.close(); } }</span></span></code> </pre> </div></div><br><p> 感谢我们的注释<code>@EnableMySQLClusterContainer</code> ，我们隐藏了准备测试环境的详细信息。 同样，由于我们的入门者，我们可以简单地将SessionFactory注入我们的测试中，并将其用于我们的需求，而不必担心需要手动创建它的事实。 <br> 所有这些使我们专注于编写测试的业务逻辑，而不是服务基础结构。 </p><br><p> 我还想注意一个事实，您需要运行一个将<code>ClusterJ</code>与参数一起使用的应用程序： </p><br><pre> <code class="bash hljs">-Djava.library.path=/usr/lib/x86_64-linux-gnu/</code> </pre> <br><p> 其中显示了<code>libndbclient.so</code>的路径。 没有它，什么都不会起作用。 </p><br><h2 id="zaklyuchenie"> 结论 </h2><br><p> 对于我来说，在那些对数据访问速度至关重要的系统中， <code>ClusterJ</code>一件好事，但细微的缺陷和限制破坏了整体印象。 如果您有机会选择并且不关心访问速度，那么我认为使用<code>JDBC</code>更好。 </p><br><p> 本文没有考虑使用事务和锁，因此结果很多。 </p><br><p> 就是这样，快乐编码！ </p><br><h2 id="poleznye-ssylki"> 有用的链接： </h2><br><p> 该项目的所有代码都位于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">下载</a>页面 <br> 有关<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ClusterJ的</a>信息 <br> 使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Java和NDB集群</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Pro MySQL NDB</a>丛书 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此处</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>了解有关MySQL NDB群集的更多信息 </p><br><p>  <code>MySQL</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">存储库</a>本身中还有更多测试用例。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN472468/">https://habr.com/ru/post/zh-CN472468/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN472452/index.html">如何在iOS应用程序中添加对宽限期（计费宽限期）的支持？</a></li>
<li><a href="../zh-CN472454/index.html">廉价VPS服务器概述</a></li>
<li><a href="../zh-CN472462/index.html">下诺夫哥罗德的iFest：IT令人印象深刻</a></li>
<li><a href="../zh-CN472464/index.html">在Raspberry Pi上制作Python服务器的5种方法 第二部分</a></li>
<li><a href="../zh-CN472466/index.html">按分布排序</a></li>
<li><a href="../zh-CN472470/index.html">转基因小鼠和抗衰老</a></li>
<li><a href="../zh-CN472472/index.html">冬天的小屋：是还是不是？</a></li>
<li><a href="../zh-CN472474/index.html">Google Chrome中有趣的外观错误</a></li>
<li><a href="../zh-CN472482/index.html">放射性事故：发现a的固体稳定相</a></li>
<li><a href="../zh-CN472484/index.html">封闭Kubernetes集群中的漏洞。 使用DevOpsConf报告和成绩单</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>