<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôáüèª üò• üóÇÔ∏è Exp√©rience dans l'int√©gration de la caisse Atol avec son propre trading CRM üñºÔ∏è üë©üèΩ‚Äçüè≠ üëµüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Autour du box-office en ligne r√©cemment, excitation folle, le 1er juillet 2019, le dernier report se termine, j'ai donc d√ª faire face √† ce probl√®me. C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exp√©rience dans l'int√©gration de la caisse Atol avec son propre trading CRM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457684/">  Autour du box-office en ligne r√©cemment, excitation folle, le 1er juillet 2019, le dernier report se termine, j'ai donc d√ª faire face √† ce probl√®me.  Ceux qui ont 1C ou un autre syst√®me en particulier ne peuvent pas forcer, mais si vous avez votre propre syst√®me auto-√©crit, l'int√©gration avec les caisses en ligne tombe √©galement sur vos √©paules. <br><br>  Mon exp√©rience est utile pour l'int√©gration avec les caisses Atol en mode d'√©change de donn√©es r√©seau, votre programme peut envoyer des donn√©es au serveur Web Atol √† la fois sur l'h√¥te local et sur le r√©seau local, vous pouvez les envoyer m√™me depuis le navigateur AJAX, m√™me depuis le serveur via CURL, donc, quelle que soit la langue dans laquelle votre logiciel d'entreprise est √©crit, tout est multiplateforme. <br><a name="habracut"></a><br>  Je suis tomb√© sur la billetterie Atol 30f - c'est une machine √† √©crire si simple avec une bo√Æte noire (FN), c'est juste quand toute la logique de commande est sur un logiciel externe, et non sur le logiciel int√©gr√© √† la caisse.  En outre, les appareils de ce type sont relativement peu co√ªteux par rapport √† leurs homologues Android. <br><br>  Je voudrais √©galement noter que les ¬´sp√©cialistes¬ª de certaines entreprises impliqu√©es dans le support ne savent pas du tout qu'Atoll avec la version 10 a un serveur web int√©gr√© dans le pilote qui accepte les jobs JSON, de plus, ce pilote peut √©galement √™tre install√© sur linux, √† en juger par le nombre de solutions toutes faites sur les framboises, je peux supposer qu'il peut aussi y √™tre install√©, dans la distribution de la 10√®me version du driver, l'installateur pour arm est pr√©sent. <br><br>  Le sch√©ma pr√©vu est quelque chose comme √ßa - il y a CRM qui fonctionne sur le serveur sur le r√©seau local, il est ouvert √† partir des navigateurs, du c√¥t√© serveur, les ch√®ques seront envoy√©s √† PHP via curl et imprim√©s √† la caisse enregistreuse.  Et la caisse elle-m√™me est connect√©e √† n'importe quel ordinateur sous Windows sur le m√™me r√©seau. <br><br>  Ils disent que si vous n'activez pas la caisse, cela peut fonctionner en mode imprimante et imprimer que le ch√®que n'est pas valide, mais je n'ai pas pu le v√©rifier, j'ai d√ª faire des ventes et des retours de penny. <br><br>  Le pilote de la dixi√®me version est t√©l√©charg√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Avant l'installation, vous devez installer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Java de</a> la m√™me profondeur de bits que le pilote, sinon le serveur Web de case √† cocher ne sera pas disponible, si vous installez le pilote KKT 64 bits, puis Java x64. <br><br>  Il semble que, logiquement, vous devez installer un pilote 64 bits sur un syst√®me 64 bits, mais certains logiciels 32 bits ne pourront pas fonctionner avec (comme cela s'applique √† 1C s'il est 32 bits). <br><br><img src="https://habrastorage.org/webt/nf/fn/uk/nffnukvhkzk3za8vpcrn567wygi.png"><br><br>  √Ä la fin de l'installation, il y a une coche - pour configurer le serveur Web, s'il n'a pas √©t√© install√©, alors vous devez aller dans le navigateur √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">127.0.0.1</a> : 16732 / settings, cochez la case "Activer le serveur" et enregistrez. <br><br><img src="https://habrastorage.org/webt/gv/fm/9l/gvfm9lfbrzxyntshlyhn7fmx-pc.png"><br><br><img src="https://habrastorage.org/webt/dy/so/pq/dysopqgomkepetfvn-de5vgdj3q.png"><br><br>  Apr√®s cela, vous devez red√©marrer le serveur via START-&gt; ATOL-&gt; restart ... <br><br>  Je tiens √©galement √† vous avertir tout de suite que si vous d√©marrez le serveur Web, les applications locales ne pourront pas acc√©der au CCP, je travaillerai longtemps, installer le pilote, ex√©cuter le test du pilote Cct, et il me dit que le port est occup√© et c'est tout, j'ai appel√© le support technique du vendeur local, l√† ils ont dit que nous ne savions pas quoi faire, puis j'ai surcharg√© l'ordinateur dix fois, r√©install√© le pilote, rien n'y fait. <br><br>  En g√©n√©ral, apr√®s avoir activ√© et red√©marr√© le serveur, et avant cela, vous avez √©teint le serveur et v√©rifi√© l'impression du texte brut via l'utilitaire fourni ou simplement v√©rifi√© la connexion - vous pouvez continuer. <br><br>  Ce service Web ne dispose d'aucune protection par mot de passe, vous devez donc configurer imm√©diatement le pare-feu Windows ou d'autres logiciels afin que seuls les ordinateurs n√©cessaires puissent acc√©der au port 16732, dans ma situation, c'est le serveur sur lequel CRM s'ex√©cute. <br><br>  <b>La communication avec le service Web est g√©n√©ralement un sujet distinct, tr√®s int√©ressant ...</b> <br><br><ol><li>  G√©n√©rer un uuid unique pour le travail </li><li>  Nous envoyons la t√¢che en utilisant la m√©thode POST </li><li>  Nous plantons sur le service Web, en attendant le r√©sultat de la t√¢che avec notre UUID, il se peut que pendant quelques secondes notre t√¢che ait un √©tat d'attente, ou une erreur peut se produire si quelque chose ne va pas dans la demande ... </li></ol><br>  Et puis je vais donner une version de travail, elle convient aux situations o√π le paiement n'est qu'une seule m√©thode, et pas tellement en esp√®ces et en partie non en esp√®ces, il utilise √©galement le syst√®me fiscal par d√©faut, la TVA n'est pas encore calcul√©e, je voulais ajouter le code, puis l'√©taler, mais Je pense qu'il y a encore des gens qui ont besoin de ces informations avant le 1er juillet apr√®s.  Je dois dire tout de suite que la classe a besoin de raffinement, beaucoup de raw, pas de gestion d'erreur, tout a √©t√© fait en quelques heures sans prendre en compte la lecture de la documentation, ce code est plus √† titre d'exemple et je vous conseille d'√©tudier la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> en d√©tail et de l'adapter √† vos processus sp√©cifiques. <br><br><div class="spoiler">  <b class="spoiler_title">code php pour un exemple de travail avec api (utilis√© √† des fins √©ducatives uniquement)</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AtolWebDriver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $addr=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>,$port=<span class="hljs-string"><span class="hljs-string">"16732"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $timeout = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  public $operator; function __construct($addr=false,$port=false) { if ($addr!==false) $this-&gt;addr=$addr; if ($port!==false) $this-&gt;port=$port; } public function CallAPI($method, $data,$_url="/requests") { $url = "http://".$this-&gt;addr.":".$this-&gt;port.$_url; $curl = curl_init($url); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl,CURLOPT_TIMEOUT, $this-&gt;timeout); $headers = ['Content-Type: application/json']; curl_setopt($curl,CURLOPT_HTTPHEADER, $headers); curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($data)); $resp = curl_exec($curl); $data = json_decode($resp,1); $code = curl_getinfo($curl, CURLINFO_HTTP_CODE); curl_close($curl); $res= [$data,$code,$resp]; print_r($res); return $res; } //   public function get_res($uuid) { $ready = false; $cnt=0; $res_url = '/requests/'.$uuid; while (!$ready &amp;&amp; ++$cnt&lt;60) { usleep(500000); // ,     list($res,$code,$resp) = $this-&gt;CallAPI('GET',[],$res_url); $ready = ($res['results'][0]['status'] == 'ready'); if ($ready) return $res; } return false; //    } //  public function add_req($uuid,$req) { return $this-&gt;CallAPI('POST', ['uuid'=&gt;$uuid,'request'=&gt;$req]); } //  id   public function gen_uuid() { return exec('uuidgen -r'); } //      public function atol_task($type,$req=[]) { $req['type'] = $type; $uuid = $this-&gt;gen_uuid(); $req = $this-&gt;add_req($uuid,$req); if ($req[1]!='201') return false; //  $res = $this-&gt;get_res($uuid); //  if ($res===false || !isset($res['results'][0])) return false; return $res['results'][0]; } /*    */ //  public function get_shift_status() { $res = $this-&gt;atol_task('getShiftStatus'); if ($res===false) return false; //closed / opened / expired return $res['result']['shiftStatus']['state']; } //  public function open_shift() { $status = $this-&gt;get_shift_status(); //e ,    if ($status=="expired") $this-&gt;close_shift(); if ($status=="opened") return "    "; $res = $this-&gt;atol_task('openShift',['operator'=&gt;$this-&gt;operator]); } //  public function close_shift() { $status = $this-&gt;get_shift_status(); if ($status=="closed") return "    "; $res = $this-&gt;atol_task('closeShift',['operator'=&gt;$this-&gt;operator]); } public function items_prepare($items) { $res_items = []; $summ = 0; while ($item = array_shift($items)) { $res_item = $item; if (!isset($item['type'])) $res_item['type']="position"; if (isset($item['price']) &amp;&amp; isset($item['quantity'])) { $res_item['amount'] = $item['price']*$item['quantity']; $res_item['tax'] = ['type'=&gt;'none']; $summ+=$res_item['amount']; } $res_items[] = $res_item; } return [$res_items,$summ]; } // sell,  sellReturn public function fiskal($type_op="sell",$items,$pay_type="cash") { $data = []; $data['operator'] = $this-&gt;operator; $data['payments'] = []; list($data['items'],$summ) = $this-&gt;items_prepare($items); //+++       $data['payments'][] = ['type'=&gt;$pay_type,'sum'=&gt;$summ]; $res = $this-&gt;atol_task($type_op,$data); } } //  ip   web-  ,      $atol = new AtolWebDriver('192.168.100.10'); //    $atol-&gt;operator = ['name'=&gt;'.']; //       $items = []; $items[] = ['name'=&gt;' ','price'=&gt;0.7,'quantity'=&gt;1]; $items[] = ['name'=&gt;' ','price'=&gt;0.4,'quantity'=&gt;1]; //  $atol-&gt;open_shift(); //  $atol-&gt;fiskal("sell",$items); sleep(10); // ,     //     , ..    $atol-&gt;fiskal("sellReturn",$items); //     sleep(20); // ,   $atol-&gt;close_shift();</span></span></code> </pre> <br></div></div><br>  Il y a ici quelques d√©fauts que je vais corriger <br><br><ol><li>  Arrondir les fractions lors du calcul des montants, vous devez arrondir en cents, sinon vous pouvez obtenir 1,000000001 ou 0,999999999 </li><li>  Avec l'orthographe correcte du reste de la logique du programme, cela ne se produit g√©n√©ralement pas, mais pendant les tests, je me suis rendu compte que la t√¢che a renvoy√© un r√©sultat d'erreur et j'attendais d'√™tre pr√™t </li></ol><br>  Eh bien, dans le processus de mise en ≈ìuvre, j'ai peur de rattraper beaucoup d'erreurs, par exemple, si la t√¢che se bloque pendant longtemps dans l'√©tat d'attente, alors il vaut mieux la supprimer de la file d'attente, sinon les t√¢ches suivantes se bloqueront pendant plusieurs minutes, j'ai attrap√© un tel probl√®me une fois, je n'esp√©rais pas qu'elle s'imprimerait et ici je suis assis, mais il saute et imprime imm√©diatement deux ch√®ques de suite envoy√©s plus t√¥t ... <br><br>  En g√©n√©ral, il est possible de collecter les acquisitions du site √† l'avenir, si elles ne disposent pas de contr√¥les en ligne, jusqu'√† ce que vous ayez d√©cid√© quelle acquisition visser.  Mais la solution est, plus probablement une id√©e de solution, le temps nous dira comment ce box-office va prendre racine. <br><br>  <b>Attention</b> , pour ceux qui lisent l'article de mani√®re inattentive et ne sont pas tr√®s comp√©tents en mati√®re de s√©curit√© - <b>ce service web n'a pas de cryptage (https), n'a pas d'autorisation</b> , m√™me s'il n'est utilis√© que sur le r√©seau local - configurez la protection pour l'acc√®s au port. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr457684/">https://habr.com/ru/post/fr457684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr457652/index.html">Comment organiser 120 000 photos et qu'il n'y ait pas de tryndets, avec diff√©rents niveaux d'acc√®s, pour l'√©quipe</a></li>
<li><a href="../fr457658/index.html">Union MS-11: un accident qui n'existait pas?</a></li>
<li><a href="../fr457660/index.html">Comment √©conomiser 58 $ en 5 minutes: utilisons des prix diff√©rents dans chaque pays contre les sp√©cialistes du marketing</a></li>
<li><a href="../fr457666/index.html">Alternatives au Raspberry Pi</a></li>
<li><a href="../fr457680/index.html">Installation minimale de CentOS / Fedora / RedHat</a></li>
<li><a href="../fr457686/index.html">Comment Sberbank recueille le consentement pour le traitement de la biom√©trie</a></li>
<li><a href="../fr457690/index.html">Vid√©o parano√Øaque de Yandex.Money metap</a></li>
<li><a href="../fr457692/index.html">R√©flexions sur la norme nationale NB-Fi et les syst√®mes de facturation</a></li>
<li><a href="../fr457694/index.html">Les dangers de l'utilisation de constantes multi-caract√®res</a></li>
<li><a href="../fr457696/index.html">Les dangers de l'utilisation de constantes multi-caract√®res</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>