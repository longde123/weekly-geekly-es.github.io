<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëéüèø ‚ò∏Ô∏è üë®‚Äçüé® Thermom√®tre √† deux chiffres üë©üèø‚ÄçüöÄ ü§∞üèº üë®üèª‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'auteur a fait de ce thermom√®tre √† LED √† deux chiffres un cadeau d'anniversaire au fils de son ami. Il n'a que deux ans et il lit d√©j√† les chiffres, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Thermom√®tre √† deux chiffres</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454220/"><img src="https://habrastorage.org/webt/i0/jr/au/i0jrauutpm6rrsutydyvv7hxb_c.jpeg"><br><br>  L'auteur a fait de ce thermom√®tre √† LED √† deux chiffres un cadeau d'anniversaire au fils de son ami.  Il n'a que deux ans et il lit d√©j√† les chiffres, mais pas les lettres.  Maintenant, il peut apprendre seul la temp√©rature √† l'ext√©rieur de la fen√™tre.  Le capteur du thermom√®tre est une puce DS18B20 fonctionnant selon le protocole 1-Wire, et le microcontr√¥leur est du type ATtiny84.  La planche est carr√©e avec un c√¥t√© de 25 mm, de taille comparable √† une pi√®ce de 50 pence.  L'auteur pr√©voit de placer la planche dans un bo√Ætier √©tanche et de la placer √† l'ext√©rieur de la fen√™tre.  L'indication s'allume bri√®vement toutes les 24 secondes et les piles CR2032 durent environ un an. <a name="habracut"></a><br>  Le thermom√®tre fonctionne dans la plage de -19 √† +99 ¬∞ C.  Si n√©cessaire, les signes moins et un s'affichent simultan√©ment dans l'ordre sup√©rieur.  Hors de port√©e, les lettres Lo ou Hi s'affichent.  Vous pouvez ¬´apprendre¬ª √† l'appareil √† afficher des temp√©ratures inf√©rieures √† -19 ¬∞ C en utilisant un segment avec un point comme moins. <br><br>  Selon ce sch√©ma, l'appareil √©tait pr√©alablement assembl√© sur une planche √† pain: <br><br><img src="https://habrastorage.org/webt/1u/e7/aj/1ue7aju6otdv_qjhwdjabjxejf8.gif"><br><br>  Toutes les sorties du microcontr√¥leur sont impliqu√©es, le g√©n√©rateur d'horloge int√©gr√© de 8 MHz est utilis√©.  Le prototype √©tait le suivant: <br><br><img src="https://habrastorage.org/webt/qf/91/nd/qf91ndinrn_16xfcxellk_lxzuq.jpeg"><br><br>  Le prototype utilisait DS18B20 dans le bo√Ætier TO-92, ATtiny84 dans le bo√Ætier PDIP et un indicateur 3621AS de 3,6 pouces.  Ensuite, l'auteur a d√©velopp√© la carte √† Eagle et l'a command√©e √† PCBway.  Ici, le microcontr√¥leur est d√©j√† dans le bo√Ætier SOIC, le capteur est dans le bo√Ætier ¬µSOP, et les r√©sistances, condensateurs et √©cran sont de taille 0805. Tout sauf l'√©cran est soud√© par un s√®che-cheveux Youyue 858D + √† une temp√©rature de 250 ¬∞ C. <br><br>  Le prototype et la carte de circuit imprim√© ont tous deux des indicateurs avec une anode commune.  L'appareil est fabriqu√© en deux versions, avec des indicateurs de couleurs rouge et jaune.  Rouge - sur KDPV, jaune - ici: <br><br><img src="https://habrastorage.org/webt/qc/i9/wv/qci9wvs7mdqulra36wldskfg6sc.jpeg"><br><br>  Un support pour une pile au lithium de 20 mm (celui dont la d√©signation commence par 20, c'est-√†-dire 2016, 2025 ou 2032) est soud√© √† l'arri√®re: <br><br><img src="https://habrastorage.org/webt/3i/ic/kx/3iickx0nahv0rh325lvawiebzdq.jpeg"><br><br>  Le micrologiciel est √©crit de sorte que le microcontr√¥leur est en mode veille la plupart du temps et se r√©veille en cas d'interruption de la minuterie du chien de garde.  Dans la mise en ≈ìuvre de l'interface 1-Wire, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce temps de fonctionnement</a> du m√™me auteur est impliqu√©.  Le compteur temporis√© 16 bits du microcontr√¥leur fonctionnant √† une fr√©quence de 1 MHz prend du temps: <br><br><pre><code class="plaintext hljs">void OneWireSetup () { TCCR1A = 0&lt;&lt;WGM10; // Normal mode TCCR1B = 0&lt;&lt;WGM12 | 2&lt;&lt;CS10; // Normal mode, divide clock by 8 }</code> </pre> <br>  Le sous-programme DelayMicros () fournit un retard d'un nombre sp√©cifi√© de microsecondes, bas√© sur le registre de comparaison de sortie OCR0A: <br><br><pre> <code class="plaintext hljs">void DelayMicros (unsigned int micro) { TCNT1 = 0; TIFR1 = 1&lt;&lt;OCF1A; OCR1A = micro; while ((TIFR1 &amp; 1&lt;&lt;OCF1A) == 0); }</code> </pre> <br>  La routine DisplayTemperature () lit la valeur de temp√©rature du capteur et l'affiche.  Puisqu'il n'y a qu'un seul capteur sur le bus, vous pouvez ignorer le num√©ro de s√©rie et simplement donner la commande Skip ROM, apr√®s quoi toutes les commandes suivantes sont envoy√©es √† n'importe quel p√©riph√©rique: <br><br><pre> <code class="plaintext hljs">void DisplayTemperature () { cli(); // No interrupts if (OneWireReset() != 0) { sei(); DisplayError(0); // Device not found } else { OneWireWrite(SkipROM); OneWireWrite(ConvertT); while (OneWireRead() != 0xFF); OneWireReset(); OneWireWrite(SkipROM); OneWireWrite(ReadScratchpad); OneWireReadBytes(9); sei(); // Interrupts if (OneWireCRC(9) == 0) { int temp = DataWords[0]; Display((temp+8)&gt;&gt;4); // Round to nearest degree } else DisplayError(1); // CRC error } }</code> </pre> <br>  En r√©ponse √† la demande, le capteur renvoie la valeur de temp√©rature sous la forme d'un entier sign√© 16 bits en unit√©s de 1/16 degr√©.  Le nombre est arrondi au degr√© entier le plus proche et affich√© en appelant la routine Display (). <br><br>  Le sous-programme DisplayError () affiche les erreurs dans l'interaction du microcontr√¥leur avec le capteur sur le bus 1-Wire: <br><br><pre> <code class="plaintext hljs">void DisplayError (int no) { Buffer[0] = Error; Buffer[1] = no; }</code> </pre> <br>  E0 - capteur non d√©tect√©, E1 - erreur CRC. <br><br>  Les donn√©es d'indication dynamique sont extraites du tableau Buffer [].  Par exemple, pour afficher le nombre 20, vous devez faire: <br><br><pre> <code class="plaintext hljs">Buffer[0]=2; Buffer[1]=0;</code> </pre> <br>  Le compteur de minuterie 0 g√©n√®re des interruptions √† une fr√©quence de 125 Hz, ce qui est suffisant pour √©liminer le scintillement.  Tout d'abord, le minuteur est configur√© dans setup () " <br><br><pre> <code class="plaintext hljs">TCCR0A = 2&lt;&lt;WGM00; // CTC mode; count up to OCR0A TCCR0B = 0&lt;&lt;WGM02 | 4&lt;&lt;CS00; // Divide by 256 OCR0A = 250-1; // Compare match at 125Hz TIMSK0 = 0; // Interrupts initially off</code> </pre> <br>  La routine de gestion des interruptions correspondante pendant la comparaison appelle la routine DisplayNextDigit () et compte ensuite dans la direction oppos√©e: <br><br><pre> <code class="plaintext hljs">ISR(TIM0_COMPA_vect) { DisplayNextDigit(); Ticks--; }</code> </pre> <br>  Le sous-programme DisplayNextDigit () lit les donn√©es de la cellule correspondante dans le tableau Buffer [] et inclut les segments souhait√©s dans le bit d'affichage correspondant.  Le programme utilise #define pour choisir entre un indicateur avec une cathode ou une anode commune.  Si tous les segments sont allum√©s imm√©diatement lors de la mise sous tension, le type d'affichage ne correspond pas √† celui sp√©cifi√© dans le micrologiciel.  Pour une cathode commune, le sous-programme doit √™tre remplac√© par ce qui suit: <br><br><pre> <code class="plaintext hljs">void DisplayNextDigit () { PORTB = PORTB | 1&lt;&lt;digit; // Turn old digit off digit = digit ^ 1; // Toggle between 0 and 1 char segs = charArray[Buffer[digit]]; PORTA = segs; // Lit segments high PORTB = PORTB &amp; ~(1&lt;&lt;digit); // Turn new digit on }</code> </pre> <br>  Enfin, la routine Display () produit un nombre √† deux chiffres pour √©crire dans le tableau Buffer []: <br><br><pre> <code class="plaintext hljs">void Display (int n) { int units = n % 10; int tens = n / 10; int temp0 = tens; int temp1 = abs(units); if (tens &lt; -1) {temp0 = Lo; temp1 = Lo+1; } else if (tens &gt; 9) {temp0 = Hi; temp1 = Hi+1; } else if (tens == -1) temp0 = Minus1; else if ((tens == 0) &amp;&amp; (units &gt;= 0)) temp0 = Blank; else if ((tens == 0) &amp;&amp; (units &lt; 0)) temp0 = Minus; Buffer[0] = temp0; Buffer[1] = temp1; }</code> </pre> <br>  Il prend √©galement en compte les cas d'affichage du moins avec l'unit√© dans l'ordre √©lev√©, ainsi que les messages sur la temp√©rature en dehors de la plage. <br><br>  Pour une √©conomie d'√©nergie maximale possible, les g√©n√©rateurs d'horloge ADC, USI et ADC sont d√©sactiv√©s et le mode veille PWR_DOWN est activ√©: <br><br><pre> <code class="plaintext hljs"> ADCSRA &amp;= ~(1&lt;&lt;ADEN); // Disable ADC to save power PRR = 1&lt;&lt;PRUSI | 1&lt;&lt;PRADC; // Turn off clocks to USI &amp; ADC to save power set_sleep_mode(SLEEP_MODE_PWR_DOWN);</code> </pre> <br>  Le programme principal affiche la temp√©rature pendant des dixi√®mes de seconde, puis active le mode veille.  Il s'est av√©r√© qu'il s'agit du temps d'indication minimum, pratique pour la lecture.  Deux secondes avant l'affichage de la temp√©rature, le point clignote bri√®vement: <br><br><pre> <code class="plaintext hljs">void loop () { Buffer[0] = DP; Buffer[1] = Blank; DisplayOn(12); WDDelay(6); // Sleep for 1 second Buffer[0] = Blank; Buffer[1] = DP; DisplayOn(12); WDDelay(6); // Sleep for 1 second DisplayTemperature(); DisplayOn(12); WDDelay(9); // Sleep for 8 seconds WDDelay(9); // Sleep for 16 seconds WDDelay(9); // Sleep for 24 seconds }</code> </pre> <br>  L'√©cran reste √©teint pendant 24 secondes en raison de trois appels de la minuterie de surveillance pendant 8 secondes chacun.  Avec l'indicateur allum√©, la consommation de courant est de 6,6 mA, en mode veille - 4,7 ŒºA, la consommation de courant moyenne est de 1/240 * 6,6 mA.  La capacit√© typique de la cellule CR2032 est de 225 mAh, donc c'est suffisant pour (225 / 6,6) x 240/24 = 340 jours - un peu moins d'un an. <br><br>  Les plages de temp√©rature des composants sont les suivantes: microcontr√¥leur et indicateur - de -40 √† + 85 ¬∞ C, r√©sistances et condensateur - de -55 √† +125 ¬∞ C, batteries - de -20 √† +70 ¬∞ C.  Un √©l√©ment avec une plage de temp√©rature √©tendue BR2032 fonctionnera dans la plage de -30 √† +85 ¬∞ C. <br><br>  Le microcontr√¥leur est rendu compatible Arduino avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce</a> d√©veloppement Spence Konde.  Dans l'EDI, s√©lectionnez ATtiny24 / 44/84 dans la section ATTinyCore du menu Board.  Ensuite, vous devez d√©finir les options suivantes, sans pr√™ter attention au reste: <br><br><pre> <code class="plaintext hljs">Chip: "ATtiny84" Clock: "8 MHz (internal)" BOD: "BOD Disabled" Pin Mapping: "Clockwise (like damellis core)"</code> </pre> <br>  Le programme est t√©l√©charg√© √† l'aide du clip de test Pomona, plac√© au-dessus du microcontr√¥leur et connect√© au programmateur SparkFun Tiny AVR.  Vous devez d'abord s√©lectionner Burn Bootloader, puis Upload. <br><br>  Liens: le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">texte int√©gral du programme</a> , le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">forum et le programme sur GitHub</a> , le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">forum sur OSHpark</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr454220/">https://habr.com/ru/post/fr454220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454206/index.html">PHDays 9: Analyse AI CTF</a></li>
<li><a href="../fr454208/index.html">RISC-V √† partir de z√©ro</a></li>
<li><a href="../fr454210/index.html">Enchantjs oubli√©s + nouveau 1C-Bitrix = Jeu pour la motivation du client</a></li>
<li><a href="../fr454214/index.html">Je d√©teste presque tous les logiciels</a></li>
<li><a href="../fr454216/index.html">Preuve trouv√©e que tous les changements sont un m√©lange d'ordre et de chance</a></li>
<li><a href="../fr454222/index.html">Mettez √† niveau le sous-syst√®me de disque de l'ancien serveur avec le bus PCIe 1.0 - 2.0</a></li>
<li><a href="../fr454224/index.html">Recommandations √† Okko: comment gagner des centaines de millions en multipliant quelques matrices</a></li>
<li><a href="../fr454226/index.html">M√©moire sur domaines magn√©tiques cylindriques. Partie 1. Principe de travail</a></li>
<li><a href="../fr454232/index.html">POO dans les langages de programmation graphique. Partie 2 MOS et OOP</a></li>
<li><a href="../fr454236/index.html">Deux histoires sur la fa√ßon dont ANKI peut vous aider √† apprendre une langue √©trang√®re et √† vous pr√©parer √† un entretien</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>