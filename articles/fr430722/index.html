<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì• ‚òîÔ∏è üë©üèΩ‚Äçü§ù‚Äçüë©üèº Performances PHP: planification, profilage, optimisation ü§≥üèø üöó ü§ûüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Il y a deux ans, nous avons √©crit comment nous sommes pass√©s √† PHP 7.0 et avons √©conomis√© un million de dollars. Sur notre profil de ch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Performances PHP: planification, profilage, optimisation</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/430722/"><img src="https://habrastorage.org/webt/k_/fe/vv/k_fevvrhhn2aruuz19gpne_jypy.jpeg"><br><br>  Bonjour, Habr!  Il y a deux ans, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crit</a> comment nous sommes pass√©s √† PHP 7.0 et avons √©conomis√© un million de dollars.  Sur notre profil de charge, la nouvelle version s'est av√©r√©e deux fois plus efficace dans l'utilisation du processeur: la charge que nous utilisions pour desservir ~ 600 serveurs, apr√®s que la transition a commenc√© √† servir ~ 300.  En cons√©quence, pendant deux ans, nous avions une r√©serve de capacit√©s. <br><br>  Mais Badoo grandit.  Le nombre d'utilisateurs actifs est en constante augmentation.  Nous am√©liorons et d√©veloppons nos fonctionnalit√©s, gr√¢ce auxquelles les utilisateurs passent de plus en plus de temps dans l'application.  Et cela, √† son tour, se refl√®te dans le nombre de demandes qui, au cours des deux derni√®res ann√©es, ont augment√© de 2 √† 2,5 fois. <br><br>  Nous nous sommes retrouv√©s dans une situation o√π un gain de performance double a √©t√© compens√© par plus d'une double augmentation des demandes, et nous avons recommenc√© √† approcher les limites de notre cluster.  Au c≈ìur de PHP, des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">optimisations</a> utiles (JIT, pr√©chargement) sont √† nouveau attendues, mais elles ne sont pr√©vues que pour PHP 7.4, et cette version sera publi√©e au plus t√¥t dans un an.  Par cons√©quent, l'astuce de transition ne peut pas √™tre r√©p√©t√©e maintenant - vous devez optimiser le code d'application lui-m√™me. <br><br>  Sous la coupe, je vais vous dire comment nous abordons ces t√¢ches, quels outils nous utilisons, et donner des exemples d'optimisations, d'id√©es et d'approches que nous appliquons et qui nous ont aid√©s √† notre √©poque. <br><a name="habracut"></a><br><h1>  Pourquoi optimiser </h1><br>  Le moyen le plus simple et le plus √©vident de r√©soudre le probl√®me de performances est d'ajouter du fer.  Si votre code s'ex√©cute sur le m√™me serveur, l'ajout d'un autre doublera les performances de votre cluster.  En transf√©rant ces co√ªts sur le temps de travail du d√©veloppeur, nous nous demandons: sera-t-il en mesure d‚Äôobtenir une double augmentation de la productivit√© pendant cette p√©riode gr√¢ce aux optimisations?  Peut-√™tre oui, mais peut-√™tre pas: cela d√©pend de la fa√ßon optimale dont le syst√®me fonctionne d√©j√† et de la qualit√© du d√©veloppeur.  En revanche, le serveur achet√© restera la propri√©t√© de l'entreprise et le temps pass√© ne sera pas restitu√©. <br><br>  Il s'av√®re que sur de petits volumes, la bonne solution sera souvent l'ajout de fer. <br><br>  Mais prenez notre situation.  Maintenant, apr√®s que le gain du passage √† PHP 7.0 a √©t√© compens√© par la croissance de l'activit√© et du nombre d'utilisateurs, nous avons √† nouveau 600 serveurs servant les requ√™tes √† l'application PHP.  Afin d'augmenter la capacit√© d'une fois et demie, nous devons ajouter 300 serveurs. <br><br>  Prenez pour calcul le co√ªt moyen d'un serveur - 4 000 $.  300 * 4000 = 1 200 000 $ - le co√ªt d'une augmentation de la capacit√© d'une fois et demie. <br><br>  Autrement dit, dans nos conditions, nous pouvons investir une quantit√© importante de temps de travail dans l'optimisation du syst√®me, et il sera toujours plus rentable que l'achat de fer. <br><br><h1>  Planification des capacit√©s </h1><br>  Avant d'entreprendre quoi que ce soit, il est important de comprendre s'il y a un probl√®me.  Si elle n'est pas l√†, alors il vaut la peine d'essayer de pr√©dire quand elle peut appara√Ætre.  Ce processus est appel√© planification des capacit√©s. <br><br>  Un indicateur concret de la pr√©sence de probl√®mes de performances est le temps de r√©ponse.  En effet, peu importe si le CPU (ou d'autres ressources) est charg√© √† 6% ou 146%: si un client re√ßoit un service de la qualit√© requise dans un d√©lai satisfaisant, alors tout fonctionne bien. <br><br>  L'inconv√©nient de se concentrer sur le temps de r√©ponse est qu'il ne commence g√©n√©ralement √† augmenter que lorsque le probl√®me est d√©j√† apparu.  Si ce n'est pas encore fait, il est difficile de pr√©dire son apparition.  De plus, le temps de r√©ponse refl√®te les r√©sultats de l'influence de tous les facteurs (services de freinage, r√©seau, variateurs, etc.) et ne permet pas de comprendre les causes des probl√®mes. <br><br>  Dans notre cas, le CPU est g√©n√©ralement le goulot d'√©tranglement, donc lors de la planification de la taille et des performances des clusters, nous pr√™tons principalement attention aux m√©triques associ√©es √† son utilisation.  Nous collectons l'utilisation du processeur de toutes nos machines et cr√©ons des graphiques avec la valeur moyenne, la m√©diane, le 75e et le 95e centile: <br><br><img src="https://habrastorage.org/webt/pt/xs/dr/ptxsdr6jybv45cznqjykeqd11_g.png"><br>  <i>Utilisation CPU des machines du cluster en pourcentage: moyenne, m√©diane, centiles</i> <br><br>  Il y a des centaines de machines dans nos clusters qui y ont √©t√© ajout√©es depuis de nombreuses ann√©es.  Ils sont diff√©rents dans la configuration et les performances (le cluster n'est pas homog√®ne).  Notre √©quilibreur en tient compte ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o</a> ) et charge les machines en fonction de leurs capacit√©s.  Afin de contr√¥ler ce processus, nous avons √©galement un programme de machines charg√©es maximum et minimum. <br><br><img src="https://habrastorage.org/webt/nf/we/f7/nfwef7cixau-uxenwsglrnvfzho.png"><br>  <i>Les machines de cluster les plus et les moins charg√©es</i> <br><br>  Si vous regardez ces graphiques (ou simplement √† la sortie de la commande sup√©rieure) et voyez la charge CPU de 50%, vous pourriez penser que nous avons encore une marge pour une augmentation de charge double.  Mais en r√©alit√©, ce n'est g√©n√©ralement pas le cas.  Et voici pourquoi. <br><br><h1>  Hyper threading </h1><br>  Imaginez un seul c≈ìur sans hypertreading.  Nous le chargeons avec un thread li√© au CPU.  Nous verrons 100% de chargement en haut. <br><br>  Maintenant, activez l'hyper-lecture sur ce noyau et chargez-le exactement de la m√™me mani√®re.  En haut, nous verrons d√©j√† deux c≈ìurs logiques, et la charge totale sera de 50% (g√©n√©ralement sur un 0%, et sur l'autre - 100%). <br><br><img src="https://habrastorage.org/webt/gr/zi/hw/grzihwfkj986zatrfrsrgg4-ykk.png"><br>  <i>Utilisation du processeur: les meilleures donn√©es et ce qui se passe r√©ellement</i> <br><br>  Comme si le processeur n'√©tait charg√© qu'√† 50%.  Mais physiquement, aucun noyau gratuit suppl√©mentaire n'est apparu.  L'hypertreading permet <i>dans certains cas</i> d'ex√©cuter sur un c≈ìur physique plusieurs processus √† la fois.  Mais cela est loin de doubler les performances dans des situations typiques, bien que sur le graphique d'utilisation du CPU cela ressemble √† la moiti√© des ressources: de 50% √† 100%. <br><br>  Cela signifie qu'apr√®s 50% de l'utilisation du processeur lorsque l'hypertreading est activ√©, il n'augmentera pas de la m√™me mani√®re qu'auparavant. <br><br>  J'ai √©crit ce code pour le d√©montrer (il s'agit d'une sorte de bo√Ætier synth√©tique, en r√©alit√© les r√©sultats diff√©reront): <br><br><div class="spoiler">  <b class="spoiler_title">Code de script</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $concurrency = $_SERVER[<span class="hljs-string"><span class="hljs-string">'argv'</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] ?? <span class="hljs-number"><span class="hljs-number">1</span></span>; $hashes = <span class="hljs-number"><span class="hljs-number">100000000</span></span>; $chunkSize = intval($hashes / $concurrency); $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $children = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $concurrency; $i++) {    $pid = pcntl_fork();    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> === $pid) {        $first = $i * $chunkSize;        $last = ($i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * $chunkSize - <span class="hljs-number"><span class="hljs-number">1</span></span>;        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($j = $first; $j &lt; $last; $j++) {            $dummy = md5($j);        }        printf(<span class="hljs-string"><span class="hljs-string">"[%d]: %d hashes in %0.4f sec\n"</span></span>, $i, $last - $first, microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) - $t1);        <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>;    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {        $children[$pid] = <span class="hljs-number"><span class="hljs-number">1</span></span>;    } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count($children) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {    $pid = pcntl_waitpid(<span class="hljs-number"><span class="hljs-number">-1</span></span>, $status);    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($pid &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {        <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($children[$pid]);    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {        <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-string"><span class="hljs-string">"Got a error pid=$pid"</span></span>);    } }</code> </pre> <br><br></div></div><br>  J'ai deux c≈ìurs physiques sur mon ordinateur portable.  Ex√©cutez ce code avec diff√©rentes donn√©es d'entr√©e afin de mesurer ses performances avec un nombre diff√©rent de processus C parall√®les. <br><br><div class="spoiler">  <b class="spoiler_title">R√©sultats de mesure</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/n5/3z/ev/n53zevyyvda4w4u-2xkjryqlj9m.png"><br></div></div><br>  Nous tra√ßons les r√©sultats des lancements: <br><img src="https://habrastorage.org/webt/xg/iv/rn/xgivrnyyynb418fnr5muqfn0qba.png"><br>  <i>Performances du script en fonction du nombre de processus parall√®les</i> <br><br>  √Ä quoi vous pouvez faire attention: <br><br><ul><li>  C = 1 et C = 2 sont les m√™mes pour HT = on et HT = off, les performances doublent lorsqu'un noyau physique est ajout√©; <br></li></ul><br><ul><li>  sur C = 3, les avantages de HT deviennent perceptibles: pour HT = on, nous avons pu obtenir des performances suppl√©mentaires, tandis que pour HT = off avec C = 3, il commence √† diminuer lentement et de mani√®re pr√©visible; <br></li></ul><br><ul><li>  √† C = 4, nous voyons tous les avantages de HT;  nous avons pu extraire 30% de productivit√© suppl√©mentaires, mais en comparaison avec C = 2 √† ce moment, l'utilisation du processeur est pass√©e de 50% √† 100%. <br></li></ul><br>  Au total, en voyant dans les 50% sup√©rieurs de la charge CPU, lors de l'ex√©cution de ce script, nous obtenons 8 065 Mhash / sec, et √† 100% - 10 511 Mhash / sec.  Cela signifie qu'√† environ 50% du sommet, nous obtenons 8,065 / 10,511 ~ 77% des performances maximales du syst√®me et en fait, il nous reste environ 100% dans la r√©serve - 77% = 23%, et non 50%, comme cela peut sembler. <br><br>  Ce fait doit √™tre pris en compte lors de la planification. <br><br><img src="https://habrastorage.org/webt/ru/6g/00/ru6g002t0ziv1pkppgqfjber80o.png"><br>  <i>Utilisation du processeur pour la d√©monstration: les meilleures donn√©es et ce qui se passe r√©ellement</i> <br><br><h1>  Incoh√©rence du trafic </h1><br>  En plus de l'hypertreading, la planification complique √©galement l'in√©galit√© du trafic en fonction de l'heure de la journ√©e, du jour de la semaine, de la saison et d'autres fr√©quences.  Pour nous, par exemple, le pic est le dimanche soir. <br><br><img src="https://habrastorage.org/webt/eh/ks/58/ehks58pfn7sjva3c869i7cwj7fy.png"><br>  <i>Nombre de demandes par seconde, pic dimanche soir</i> <br><br>  Le nombre de demandes ne change pas toujours de mani√®re √©vidente.  Par exemple, les utilisateurs peuvent en quelque sorte interagir avec d'autres utilisateurs: l'activit√© de certains peut g√©n√©rer des push / e-mails √† d'autres et donc les impliquer dans le processus.  √Ä cela s'ajoutent des campagnes promotionnelles qui augmentent le trafic et auxquelles vous devez √©galement vous pr√©parer. <br><br>  Tout cela est √©galement important √† prendre en compte lors de la planification: par exemple, pour construire une tendance par jours de pointe et garder √† l'esprit l'√©ventuelle non-lin√©arit√© de la croissance de pointe. <br><br><h1>  Outils de profilage et de mesure </h1><br>  Supposons que nous d√©couvrions qu'il y a des probl√®mes de performances, comprenons que ce n'est pas la base de donn√©es / services / trucs, et pourtant nous avons d√©cid√© d'optimiser le code.  Pour ce faire, tout d'abord, nous avons besoin d'un profileur ou de quelques outils pour trouver les goulots d'√©tranglement et voir ensuite les r√©sultats de nos optimisations. <br><br>  Malheureusement, pour PHP aujourd'hui, il n'y a pas de bon outil universel. <br><br><h2>  perf </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">perf</a> est un outil de profilage int√©gr√© au noyau Linux.  Il s'agit d'un profileur d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©chantillonnage</a> qui est lanc√© par un processus distinct, il n'ajoute donc pas directement de surcharge au programme profil√©.  Les frais g√©n√©raux ajout√©s indirectement sont uniform√©ment ¬´tach√©s¬ª, de sorte qu'ils ne faussent pas les mesures. <br><br>  Pour tous ses avantages, perf est capable de fonctionner uniquement avec du code compil√© et avec JIT et n'est pas capable de travailler avec du code fonctionnant "sous une machine virtuelle".  Par cons√©quent, le code PHP lui-m√™me ne peut pas √™tre profil√©, mais vous pouvez clairement voir comment PHP fonctionne √† l'int√©rieur, y compris diverses extensions PHP, et combien de ressources y sont d√©pens√©es. <br><br>  Par exemple, avec perf, nous avons trouv√© plusieurs goulots d'√©tranglement, dont un lieu de compression, dont je parlerai ci-dessous. <br><br>  Un exemple: <br><br> <code>perf record --call-graph dwarf,65528 -F 99 -p $(pgrep php-cgi | paste -sd "," -) -- sleep 20 <br> perf report</code> <br> <br>  (si le processus et perf sont ex√©cut√©s sous diff√©rents utilisateurs, alors perf doit √™tre ex√©cut√© sous sudo). <br><br><img src="https://habrastorage.org/webt/k9/vu/k6/k9vuk6sf37xhshipgvx2byw3xps.png"><br>  <i>Exemple de sortie de rapport Perf pour PHP-FPM</i> <br><br><h2>  Agr√©gateur XHProf et XHProf </h2><br>  XHProf est une extension pour PHP qui place des temporisateurs autour de tous les appels aux fonctions / m√©thodes, et contient √©galement des outils pour visualiser les r√©sultats ainsi obtenus.  Contrairement √† perf, il vous permet de fonctionner avec des termes de code PHP (en m√™me temps, ce qui se passe dans les extensions n'est pas visible). <br><br>  Les inconv√©nients comprennent deux choses: <br><br><ul><li>  toutes les mesures sont collect√©es dans le cadre d'une seule demande, elles ne fournissent donc pas d'informations sur l'image dans son ensemble <br></li><li>  la surcharge, bien qu'elle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne</a> soit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pas aussi importante</a> que, par exemple, lors de l'utilisation de Xdebug, mais elle l'est, et dans certains cas, les r√©sultats sont fortement d√©form√©s (plus une fonction est appel√©e et plus elle est simple, plus la distorsion est importante). <br></li></ul><br>  Voici un exemple illustrant le dernier point: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">child1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">child2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parent1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ child1(); child2(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>; $i++) { parent1(); }</code> </pre> <br><img src="https://habrastorage.org/webt/iw/7m/y6/iw7my6irzq5xg7_soy7sfkqpj7m.png"><br>  <i>Sortie XHProf pour les d√©mos: parent1 est un ordre de grandeur sup√©rieur √† la somme de child1 et child2</i> <br><br>  On peut voir que parent1 () a √©t√© ex√©cut√© ~ 500 fois plus longtemps que child1 () + child2 (), bien qu'en r√©alit√© ces nombres devraient √™tre approximativement √©gaux, comme sont √©gaux √† main () et parent1 (). <br><br>  Si le dernier inconv√©nient est difficile √† combattre, alors pour combattre le premier, nous avons cr√©√© un module compl√©mentaire sur XHProf, qui agr√®ge les profils des diff√©rentes demandes et visualise les donn√©es agr√©g√©es. <br><br>  En plus de XHProf, il existe de nombreux autres profileurs moins connus fonctionnant sur un principe similaire.  Ils ont des avantages et des inconv√©nients similaires. <br><br><h2>  Pinba </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pinba</a> vous permet de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">surveiller les performances par des</a> scripts (actions) et par des minuteries pr√©d√©finies.  Toutes les mesures dans le contexte des scripts sont faites hors de la bo√Æte; pour cela, aucune √©tape suppl√©mentaire n'est requise.  Pour chaque script et temporisateur, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">getrusage</a> est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ex√©cut√©</a> , nous savons donc exactement combien de temps processeur a √©t√© consacr√© √† un morceau de code particulier (contrairement aux profileurs d'√©chantillonnage, o√π ce temps peut se r√©v√©ler √™tre r√©seau, disque, etc.).  Pinba est id√©al pour enregistrer des donn√©es historiques et obtenir une image √† la fois en g√©n√©ral et dans des types sp√©cifiques de requ√™tes. <br><br><img src="https://habrastorage.org/webt/od/x5/qr/odx5qryl0ufhceiuyjkytjhtm0c.png"><br>  <i>La ruse g√©n√©rale de tous les scripts obtenus de Pinba</i> <br><br>  Les inconv√©nients incluent le fait que les temporisateurs qui profilent des sections sp√©cifiques du code, et non les scripts entiers, doivent √™tre organis√©s √† l'avance dans le code, ainsi que la pr√©sence d'une surcharge qui (comme dans XHProf) peut d√©former les donn√©es. <br><br><h2>  phpspy </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">phpspy</a> est un projet relativement nouveau (le premier commit sur GitHub √©tait il y a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">six</a> mois), qui semble prometteur, nous le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">suivons</a> donc de pr√®s. <br><br>  Du point de vue de l'utilisateur, phpspy est similaire √† perf: un processus parall√®le est lanc√©, qui copie p√©riodiquement les parties m√©moire du processus PHP, les analyse et en re√ßoit des traces de pile et d'autres donn√©es.  Cela se fait d'une mani√®re assez sp√©cifique.  Afin de minimiser les frais g√©n√©raux, phpspy n'arr√™te pas le processus PHP et copie la m√©moire directement pendant son ex√©cution.  Cela conduit au fait que le profileur peut obtenir un √©tat incoh√©rent, les traces de pile peuvent √™tre rompues.  Mais phpspy peut d√©tecter cela et √©limine ces donn√©es. <br><br>  √Ä l'avenir, en utilisant cet outil, il sera possible de collecter √† la fois des donn√©es sur l'image dans son ensemble et des profils de types sp√©cifiques de requ√™tes. <br><br><h2>  Tableau de comparaison </h2><br>  Pour structurer les diff√©rences entre les outils, cr√©ons un tableau crois√© dynamique: <br><br><img src="https://habrastorage.org/webt/bg/1a/bt/bg1abtxk-f8i5q83qm5teok3lbs.png"><br>  <i>Comparaison des principales caract√©ristiques des profileurs</i> <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Graphes de flamme</a></i> <br><br><h1>  Optimisation et approches </h1><br>  Avec ces outils, nous surveillons en permanence les performances et l'utilisation de nos ressources.  Lorsqu'ils sont utilis√©s de mani√®re injustifi√©e ou que nous approchons du seuil (pour le CPU, nous avons choisi empiriquement une valeur de 55% afin d'avoir une marge de temps en cas de croissance), comme je l'ai √©crit plus haut, l'une des solutions au probl√®me est l'optimisation. <br><br>  Eh bien, si l'optimisation a d√©j√† √©t√© effectu√©e par quelqu'un d'autre, comme ce fut le cas avec PHP 7.0, lorsque cette version s'est av√©r√©e beaucoup plus productive que les pr√©c√©dentes.  Nous essayons g√©n√©ralement d'utiliser des technologies et des outils modernes, y compris des mises √† jour opportunes des derni√®res versions de PHP.  Selon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">benchmarks</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">publics</a> , PHP 7.2 est 5-12% plus rapide que PHP 7.1.  Mais cette transition, h√©las, nous a donn√© beaucoup moins. <br><br>  Pour tout le temps, nous avons mis en ≈ìuvre un grand nombre d'optimisations.  Malheureusement, la plupart d'entre eux sont fortement li√©s √† notre logique m√©tier.  Je vais parler de celles qui peuvent √™tre pertinentes non seulement pour nous, ou des id√©es et des approches qui peuvent √™tre utilis√©es en dehors de notre code. <br><br><h2>  Compression Zlib =&gt; zstd </h2><br>  Nous utilisons la compression pour les grandes cl√©s memkey.  Cela nous permet de d√©penser trois √† quatre fois moins de m√©moire pour le stockage en raison des co√ªts suppl√©mentaires du processeur pour la compression / d√©compression.  Nous avons utilis√© zlib pour cela (notre extension pour travailler avec les memekes est diff√©rente de celles qui viennent avec PHP, mais les officielles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilisent</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©galement</a> zlib). <br><br>  En perf, la production √©tait quelque chose comme √ßa: <br><br> <code>+    4.03%     0.22% php-cgi  libz.so.1.2.11      [.] inflate <br> +    3.38%     0.00% php-cgi  libz.so.1.2.11      [.] deflate</code> <br> <br>  7 √† 8% du temps a √©t√© consacr√© √† la compression / d√©compression. <br><br>  Nous avons d√©cid√© de tester diff√©rents niveaux et algorithmes de compression.  Il s'est av√©r√© que zstd s'ex√©cute sur nos donn√©es presque dix fois plus vite, perdant en place ~ 1,1 fois.  Un changement assez simple dans l'algorithme nous a permis d'√©conomiser environ 7,5% de CPU (cela, je le rappelle, sur nos volumes √©quivaut √† environ 45 serveurs). <br><br>  Il est important de comprendre que le rapport des performances des diff√©rents algorithmes de compression peut varier consid√©rablement en fonction des donn√©es d'entr√©e.  Il existe diverses <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comparaisons</a> , mais plus pr√©cis√©ment, cela ne peut √™tre estim√© qu'en utilisant des exemples r√©els. <br><br><h2>  IS_ARRAY_IMMUTABLE en tant que r√©f√©rentiel de donn√©es rarement modifi√©es </h2><br>  Lorsque vous travaillez avec des t√¢ches r√©elles, vous devez traiter de telles donn√©es dont vous avez besoin souvent et en m√™me temps rarement changer et avoir une taille limit√©e.  Nous avons beaucoup de donn√©es similaires, un bon exemple est la configuration des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tests fractionn√©s</a> .  Nous v√©rifions si l'utilisateur tombe dans les conditions d'un test particulier, et en fonction de cela nous lui montrons des fonctionnalit√©s exp√©rimentales ou normales (cela se produit presque √† chaque demande).  Dans d'autres projets, les configurations et divers r√©pertoires peuvent √™tre un tel exemple: pays, villes, langues, cat√©gories, marques, etc. <br><br>  √âtant donn√© que ces donn√©es sont souvent demand√©es, leur r√©ception peut cr√©er une charge suppl√©mentaire notable √† la fois sur l'application elle-m√™me et sur le service dans lequel ces donn√©es sont stock√©es.  Ce dernier probl√®me peut √™tre r√©solu, par exemple, en utilisant APCu, qui utilise la m√©moire de la m√™me machine ex√©cutant PHP-FPM comme stockage.  Mais m√™me alors: <br><br><ul><li>  il y aura des co√ªts de s√©rialisation / d√©s√©rialisation; <br></li><li>  vous devez en quelque sorte invalider les donn√©es lors de la modification; <br></li><li>  Il y a une surcharge par rapport √† l'acc√®s √† une variable en PHP. <br></li></ul><br>  PHP 7.0 introduit l'optimisation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">IS_ARRAY_IMMUTABLE</a> .  Si vous d√©clarez un tableau, dont tous les √©l√©ments sont connus au moment de la compilation, alors il sera trait√© et plac√© une fois dans la m√©moire OPCache, les travailleurs PHP-FPM se r√©f√©reront √† cette m√©moire partag√©e sans passer leur temps avant d'essayer de changer.  Il s'ensuit √©galement que l'inclusion d'un tel r√©seau prendra un temps constant quelle que soit sa taille (g√©n√©ralement ~ 1 microseconde). <br><br>  √Ä titre de comparaison: un exemple du temps n√©cessaire pour obtenir un tableau de 10 000 √©l√©ments via include et apcu_fetch: <br><br><pre> <code class="php hljs">$t0 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $a = <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'test-incl-1.php'</span></span>; $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); printf(<span class="hljs-string"><span class="hljs-string">"include (%d): %d microsec\n"</span></span>, count($a), ($t1-$t0) * <span class="hljs-number"><span class="hljs-number">1e6</span></span>); $t0 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $a = apcu_fetch(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); printf(<span class="hljs-string"><span class="hljs-string">"apcu_fetch (%d): %d microsec\n"</span></span>, count($a), ($t1-$t0) * <span class="hljs-number"><span class="hljs-number">1e6</span></span>); <span class="hljs-comment"><span class="hljs-comment">//include (10000): 1 microsec //apcu_fetch (10000): 792 microsec</span></span></code> </pre><br>  V√©rifier si cette optimisation a √©t√© appliqu√©e peut √™tre tr√®s simple si vous regardez les opcodes g√©n√©r√©s: <br><br><pre> <code class="php hljs">$ cat immutable.php <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'key1'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val1'</span></span>, <span class="hljs-string"><span class="hljs-string">'key2'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val2'</span></span>, <span class="hljs-string"><span class="hljs-string">'key3'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val3'</span></span>, ]; $ cat mutable.php <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'key1'</span></span> =&gt; \SomeClass::CONST_1, <span class="hljs-string"><span class="hljs-string">'key2'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val2'</span></span>, <span class="hljs-string"><span class="hljs-string">'key3'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val3'</span></span>, ]; $ php -d opcache.enable=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.enable_cli=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.opt_debug_level=<span class="hljs-number"><span class="hljs-number">0x20000</span></span> immutable.php $_main: ; (lines=<span class="hljs-number"><span class="hljs-number">1</span></span>, args=<span class="hljs-number"><span class="hljs-number">0</span></span>, vars=<span class="hljs-number"><span class="hljs-number">0</span></span>, tmps=<span class="hljs-number"><span class="hljs-number">0</span></span>) ; (after optimizer) ; /home/ubuntu/immutable.php:<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> L0 (<span class="hljs-number"><span class="hljs-number">4</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(...) $ php -d opcache.enable_cli=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.opt_debug_level=<span class="hljs-number"><span class="hljs-number">0x20000</span></span> mutable.php $_main: ; (lines=<span class="hljs-number"><span class="hljs-number">5</span></span>, args=<span class="hljs-number"><span class="hljs-number">0</span></span>, vars=<span class="hljs-number"><span class="hljs-number">0</span></span>, tmps=<span class="hljs-number"><span class="hljs-number">2</span></span>) ; (after optimizer) ; /home/ubuntu/mutable.php:<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> L0 (<span class="hljs-number"><span class="hljs-number">4</span></span>): T1 = FETCH_CLASS_CONSTANT string(<span class="hljs-string"><span class="hljs-string">"SomeClass"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"CONST_1"</span></span>) L1 (<span class="hljs-number"><span class="hljs-number">4</span></span>): T0 = INIT_ARRAY <span class="hljs-number"><span class="hljs-number">3</span></span> T1 string(<span class="hljs-string"><span class="hljs-string">"key1"</span></span>) L2 (<span class="hljs-number"><span class="hljs-number">5</span></span>): T0 = ADD_ARRAY_ELEMENT string(<span class="hljs-string"><span class="hljs-string">"val2"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"key2"</span></span>) L3 (<span class="hljs-number"><span class="hljs-number">6</span></span>): T0 = ADD_ARRAY_ELEMENT string(<span class="hljs-string"><span class="hljs-string">"val3"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"key3"</span></span>) L4 (<span class="hljs-number"><span class="hljs-number">6</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> T0</code> </pre><br>  Dans le premier cas, on peut voir qu'il n'y a qu'un seul opcode dans le fichier - le retour du tableau fini.  Dans le second cas, sa formation √©l√©ment par √©l√©ment se produit √† chaque ex√©cution de ce fichier. <br><br>  Ainsi, il est possible de g√©n√©rer des structures sous une forme qui ne n√©cessite pas de transformation suppl√©mentaire lors de l'ex√©cution.  Par exemple, au lieu de d√©sassembler les noms de classe par les signes ¬´_¬ª et ¬´\¬ª √† chaque fois pour le chargement automatique, vous pouvez pr√©-g√©n√©rer la carte de correspondance ¬´Class =&gt; Path¬ª.  Dans ce cas, la fonction de conversion sera r√©duite √† un seul appel de table de hachage.  Composer effectue ce type d'optimisation si vous activez l' <a href="">option Optimize-autoloader</a> . <br><br>  Pour invalider de telles donn√©es, vous n'avez rien √† faire de particulier - PHP lui-m√™me recompilera le fichier lors de la modification, comme il le ferait avec un d√©ploiement de code normal.  Le seul inconv√©nient que vous ne devez pas oublier: si le fichier est tr√®s volumineux, la premi√®re demande apr√®s l'avoir modifi√© entra√Ænera une recompilation, ce qui peut prendre un temps tangible. <br><br><h2>  Les performances incluent / n√©cessitent </h2><br>  Contrairement √† l'exemple de tableau statique, joindre des fichiers avec des d√©clarations de classe et de fonction n'est pas si rapide.  Malgr√© la pr√©sence d'OPCache, le moteur PHP doit les copier dans la m√©moire du processus, en connectant les d√©pendances de mani√®re r√©cursive, ce qui peut finalement prendre des centaines de microsecondes voire des millisecondes par fichier. <br><br>  Si vous cr√©ez un nouveau projet vide sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Symfony 4.1</a> et mettez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">get_included_files () comme</a> premi√®re ligne de l'action, vous pouvez voir que 310 fichiers sont d√©j√† connect√©s.  Dans un projet r√©el, ce nombre peut atteindre des milliers par demande.  Il convient de pr√™ter attention aux √©l√©ments suivants. <br><br>  <b>Manque de fonctionnalit√©s de chargement automatique</b> <br><br>  Il existe une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonction de chargement automatique RFC</a> , mais aucun d√©veloppement n'a √©t√© observ√© depuis plusieurs ann√©es.  Par cons√©quent, si une d√©pendance dans Composer d√©finit des fonctions en dehors de la classe et que ces fonctions doivent √™tre accessibles √† l'utilisateur, cela se fait en <a href="">connectant obligatoirement un</a> fichier avec ces fonctions √† chaque initialisation de l'autochargeur. <br><br>  Par exemple, en supprimant l'une des d√©pendances de composer.json, qui d√©clare de nombreuses fonctions et est facilement remplac√©e par une centaine de lignes de code, nous avons gagn√© quelques pour cent du processeur. <br><br>  <b>Le chargeur automatique est appel√© plus souvent qu'il n'y para√Æt.</b> <br><br>  Pour illustrer l'id√©e, cr√©ez un tel fichier avec une classe: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">C</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">D</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AC1 = \E::E1;   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AC2 = \F::F1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $as3 = \G::G1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $as4 = \H::H1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a5 = \I::I1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a6 = \J::J1;   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\K $k = null)</span></span></span><span class="hljs-function"> </span></span>{}   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asf1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\L $l = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asf2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\M $m = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">af3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\N $n = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">af4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\P $p = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br>  <b>Enregistrer le chargeur automatique:</b> <br><br><pre> <code class="php hljs">spl_autoload_register(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Including $name...\n"</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">"$name.php"</span></span>; });</code> </pre> <br>  <b>Et nous allons faire plusieurs cas d'utilisation pour cette classe:</b> <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'A.php'</span></span> Including B... Including D... Including C... \A::AC1 Including A... Including B... Including D... Including C... Including E... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A() Including A... Including B... Including D... Including C... Including E... Including F... Including G... Including H... Including I... Including J...</code> </pre><br>  Vous remarquerez peut-√™tre que lorsque nous connectons simplement la classe, mais ne cr√©ons pas son instance, le parent, les interfaces et les traits seront connect√©s.  Cela se fait r√©cursivement pour tous les fichiers connect√©s en tant que r√©solution. <br><br>  Lors de la cr√©ation d'une instance, la r√©solution de toutes les constantes et champs est ajout√©e √† cela, ce qui conduit √† la connexion de tous les fichiers n√©cessaires √† cela, ce qui, √† son tour, provoquera √©galement la connexion r√©cursive des traits, parents et interfaces des classes nouvellement connect√©es. <br><br><img src="https://habrastorage.org/webt/8a/qq/2t/8aqq2tf_8j-mixi8p_ydoypo-yo.png"><br>  <i>Connexion de classes connexes pour le processus de cr√©ation d'instance et d'autres cas</i> <br><br>  Il n'y a pas de solution universelle √† ce probl√®me, il vous suffit de le garder √† l'esprit et de surveiller les connexions entre les classes: une ligne peut tirer la connexion de centaines de fichiers. <br><br>  <b>Param√®tres OPCache</b> <br><br>  Si vous utilisez la m√©thode de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©ploiement atomique en modifiant le lien symbolique</a> propos√© par Rasmus Lerdorf, le cr√©ateur de PHP, alors pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©soudre le</a> probl√®me de ¬´coller¬ª le lien symbolique sur l'ancienne version, vous devez inclure opcache.revalidate_path, comme recommand√©, par exemple, dans cet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> sur OPCache traduit par Mail .Ru Group. <br><br>  Le probl√®me est que cette option augmente consid√©rablement (en moyenne, une fois et demie √† deux fois) le temps d'inclusion de chaque fichier.  Au total, cela peut consommer une quantit√© importante de ressources (dans notre cas, la d√©sactivation de cette option a donn√© un gain de 7 √† 9%). <br><br>  Pour le d√©sactiver, vous devez faire deux choses: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">faire en sorte que le</a> serveur Web r√©solve les liens symboliques; <br></li><li>  arr√™tez de connecter des fichiers √† l'int√©rieur du script PHP le long des chemins contenant des liens symboliques, ou forcez-les √† travers readlink () ou realpath (). <br></li></ul><br>  Si tous les fichiers sont connect√©s avec l'autochargeur Composer, le deuxi√®me √©l√©ment sera ex√©cut√© automatiquement une fois le premier termin√©: omposer utilise la constante __DIR__, qui sera r√©solue correctement. <br><br>  OPCache propose quelques options suppl√©mentaires qui peuvent am√©liorer les performances en √©change de flexibilit√©.  Vous pouvez en savoir plus √† ce sujet dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> que j'ai mentionn√© ci-dessus. <br><br>  Malgr√© toutes ces optimisations, include ne sera toujours pas gratuit.  Pour lutter contre cela, PHP 7.4 pr√©voit d'ajouter une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©charge</a> . <br><br><h2>  Verrou APCu </h2><br>  Bien que nous ne parlions pas ici de bases de donn√©es et de services, divers types de verrous peuvent √©galement se produire dans le code, ce qui augmente le temps d'ex√©cution du script. <br><br>  Au fur et √† mesure de l'augmentation des demandes, nous avons constat√© un net ralentissement de la r√©ponse aux heures de pointe.  Apr√®s avoir d√©couvert les raisons, il s'est av√©r√© que m√™me si APCu est le moyen le plus rapide d'obtenir des donn√©es (par rapport √† Memcache, Redis et √† d'autres types de stockage externe), il peut √©galement fonctionner lentement en rempla√ßant fr√©quemment les m√™mes cl√©s. <br><br><img src="https://habrastorage.org/webt/hs/05/gc/hs05gcwvqozrqews1ewwtsskdyo.png"><br>  <i>Nombre de requ√™tes par seconde et temps d'ex√©cution: pics les 16 et 17 octobre</i> <br><br>  Lorsque vous utilisez APCu comme cache, ce probl√®me n'est pas si pertinent, car la mise en cache implique g√©n√©ralement une √©criture rare et une lecture fr√©quente.  Mais certaines t√¢ches et certains algorithmes (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Circuit Breaker</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">impl√©mentation en PHP</a> )) impliquent √©galement des enregistrements fr√©quents, ce qui provoque des verrous. <br><br>  Il n'y a pas de solution universelle √† ce probl√®me, mais dans le cas du disjoncteur, il peut √™tre r√©solu, par exemple, en le mettant dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">service s√©par√©</a> install√© sur des machines avec PHP. <br><br><h2>  Traitement par lots </h2><br>  M√™me si vous ne tenez pas compte de l'inclusion, g√©n√©ralement une partie importante du temps d'ex√©cution de la requ√™te est consacr√©e √† l'initialisation: un framework (par exemple, la construction d'un conteneur DI et l'initialisation de toutes ses d√©pendances, le routage, l'ex√©cution de tous les √©couteurs), l'augmentation de la session, l'utilisateur, etc. plus loin. <br><br>  Si votre backend est une API interne pour quelque chose, certaines requ√™tes sur les clients peuvent √™tre regroup√©es et envoy√©es en tant que requ√™te unique.  Dans ce cas, l'initialisation sera effectu√©e une seule fois pour plusieurs requ√™tes. <br><br>      ,   ,    .    -  ,          .       . <br><br><h2>    </h2><br>    Badoo   ,     .    PHP-FPM,      CPU,   ,            ,    :        IO, CPU  . <br><br>      PHP-FPM    ‚Äî  ,          PHP. <br><br>         (CPU, IO),    . , ,       ,  ,    -     ,        .        ,     .   ,  ,      . <br><br><h1>  Conclusion </h1><br>        .                    PHP     . <br><br>  : <br><br><ul><li>       ; <br></li><li>     ; <br></li><li>  -  ,  :  ,    ; <br></li><li>   :       (, ,  ); <br></li><li>    :     ; <br></li><li>   , OPCache    PHP,  , ,   ; <br></li><li>    :       (, ,   PHP 7.2   ,   ); <br></li><li>    : ,        . <br></li></ul><br>       ? <br><br>  Merci de votre attention! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr430722/">https://habr.com/ru/post/fr430722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr430710/index.html">Que faire si le Black Friday est demain et que vos serveurs ne sont pas pr√™ts</a></li>
<li><a href="../fr430712/index.html">NeurIPS: Comment conqu√©rir la meilleure conf√©rence ML</a></li>
<li><a href="../fr430714/index.html">VMware ach√®te Heptio - qu'est-ce que cela signifie pour Kubernetes</a></li>
<li><a href="../fr430718/index.html">Pour quels objets vaut-il la peine d'utiliser la vid√©osurveillance dans le cloud?</a></li>
<li><a href="../fr430720/index.html">Intel RealSense D435i: petite mise √† jour et courte digression historique</a></li>
<li><a href="../fr430724/index.html">DEFCON 21. La conf√©rence DNS peut √™tre dangereuse pour votre sant√©. Partie 1</a></li>
<li><a href="../fr430728/index.html">Apprenez-moi √† donner mon avis</a></li>
<li><a href="../fr430730/index.html">Que fait R&D ABBYY: NLP Advanced Research Group</a></li>
<li><a href="../fr430732/index.html">√Ä la question de la division et de TI</a></li>
<li><a href="../fr430734/index.html">Mises √† jour intelligentes vs contrats intelligents</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>