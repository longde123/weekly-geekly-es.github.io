<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñêüèæ üöæ üë©üèæ‚Äçü§ù‚Äçüë©üèª C√≥mo descubr√≠ un huevo de pascua en la seguridad de Android y no consegu√≠ un trabajo en Google ‚òùüèΩ üïü üìÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Google ama los huevos de pascua. Los ama tanto, de hecho, que podr√≠a encontrarlos en pr√°cticamente todos sus productos. La tradici√≥n de los huevos de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo descubr√≠ un huevo de pascua en la seguridad de Android y no consegu√≠ un trabajo en Google</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446790/"><img src="https://habrastorage.org/webt/cx/0o/3t/cx0o3tqoavfz_opnsomw9-65h_i.jpeg" align="left">  Google ama los huevos de pascua.  Los ama tanto, de hecho, que podr√≠a encontrarlos en pr√°cticamente todos sus productos.  La tradici√≥n de los huevos de pascua de Android comenz√≥ en las primeras versiones del sistema operativo (creo que todos saben lo que sucede cuando ingresas a la configuraci√≥n general y tocas el n√∫mero de versi√≥n varias veces). <br><br>  Pero a veces puedes encontrar un huevo de pascua en el lugar m√°s improbable.  Incluso hay una leyenda urbana que un d√≠a, un programador busc√≥ en Google "bloqueo de mutex", pero en lugar de los resultados de b√∫squeda aterriz√≥ en foo.bar, resolvi√≥ todas las tareas y consigui√≥ un trabajo en Google. <br><br><div class="spoiler">  <b class="spoiler_title">Reconstrucci√≥n</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/157/242/ffc/157242ffcbf299f7a67641f9df1e551e.jpg" alt="imagen"><br></div></div><br>  Me pas√≥ lo mismo (excepto sin el final feliz).  Mensajes ocultos donde definitivamente no podr√≠a haber ninguno, invirtiendo el c√≥digo Java y sus bibliotecas nativas, una m√°quina virtual secreta, una entrevista de Google, todo eso est√° a continuaci√≥n. <br><a name="habracut"></a><br><h3>  Droidguard </h3><br>  Una noche aburrida restablec√≠ mi tel√©fono de f√°brica y pude configurarlo de nuevo.  Lo primero es lo primero, una nueva instalaci√≥n de Android me pidi√≥ que inicie sesi√≥n en la cuenta de Google.  Y me preguntaba: ¬øc√≥mo funciona el proceso de inicio de sesi√≥n en Android?  Y la noche de repente se volvi√≥ menos aburrida. <br><br>  Utilizo Burps Suite de PortSwigger para interceptar y analizar el tr√°fico de red.  La versi√≥n comunitaria gratuita es suficiente para nuestros prop√≥sitos.  Para ver las solicitudes https, primero debemos instalar el certificado de PortSwigger en el dispositivo.  Como dispositivo de prueba, eleg√≠ un Samsung Galaxy S de 8 a√±os con Android 4.4.  Algo m√°s nuevo que eso y es posible que tenga problemas con la fijaci√≥n de certificados y otras cosas. <br><br>  Honestamente, no hay nada particularmente especial con las solicitudes de API de Google.  El dispositivo env√≠a informaci√≥n sobre s√≠ mismo y recibe tokens en respuesta ... El √∫nico paso curioso es una solicitud POST al servicio contra el abuso. <br><br><img src="https://habrastorage.org/webt/nv/4c/7n/nv4c7njt_zecyvp0vquekhnoxbm.png"><br><br>  Despu√©s de que se realiza la solicitud, entre numerosos par√°metros muy normales aparece uno interesante, llamado <b>droidguard_result</b> .  Es una cadena Base64 muy larga: <br><br><img src="https://habrastorage.org/webt/kp/h3/i-/kph3i-1n7tw9dv-ckitddw4rxdm.png"><br><br>  DroidGuard es el mecanismo de Google para detectar bots y emuladores entre dispositivos reales.  SafetyNet, por ejemplo, tambi√©n usa los datos de DroidGuard.  Google tambi√©n tiene algo similar para los navegadores: Botguard. <br><br>  Pero, ¬øqu√© son esos datos?  Averig√ºemos <br><br><h3>  Tampones de protocolo </h3><br>  ¬øQu√© genera ese enlace ( <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.googleapis.com/androidantiabuse/v1/x/create?alt=PROTO&amp;key=AIzaSyBofcZsgLSS7BOnBjZPEkk4rYwzOIz-lTI</a></i> ) y qu√© dentro de Android hace esta solicitud?  Despu√©s de una breve investigaci√≥n, result√≥ que el enlace, en esta forma exacta, se encuentra dentro de una de las clases ofuscadas de Google Play Services: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context var1, bdh var2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(var1, <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/androidantiabuse/v1/x/create?alt=PROTO&amp;key=AIzaSyBofcZsgLSS7BOnBjZPEkk4rYwzOIz-lTI"</span></span>, var2); }</code> </pre> <br>  Como ya hemos visto en Burp, las solicitudes POST en este enlace tienen <b>Content-Type</b> - <b>application / x-protobuf</b> (Google Protocol Buffers, el protocolo de Google para la serializaci√≥n binaria).  Sin embargo, no es json: es dif√≠cil descubrir qu√© se env√≠a exactamente. <br><br>  Los b√∫feres de protocolo funcionan as√≠: <br><br><ul><li>  Primero describimos la estructura del mensaje en un formato especial y lo guardamos en un archivo .proto; </li><li>  Luego compilamos archivos .proto, y el compilador de protocolos genera el c√≥digo fuente en un idioma elegido (en el caso de Android es Java); </li><li>  Finalmente, usamos las clases generadas en nuestro proyecto. </li></ul><br>  Tenemos dos formas de decodificar mensajes protobuf.  El primero es usar un analizador de protobuf e intentar recrear la descripci√≥n original de los archivos .proto.  El segundo es eliminar las clases generadas por el protocolo de los Servicios de Google Play, que es lo que decid√≠ hacer. <br><br>  Tomamos el archivo .apk de Google Play Services de la misma versi√≥n que est√° instalada en el dispositivo (o, si el dispositivo est√° rooteado, simplemente tome el archivo directamente desde all√≠).  Usando dex2jar, convertimos el archivo .dex nuevamente en .jar y lo abrimos en un descompilador de elecci√≥n.  Personalmente me gusta el Fernflower de JetBrains.  Funciona como un complemento para IntelliJ IDEA (o Android Studio), por lo que simplemente iniciamos Android Studio y abrimos el archivo con el enlace que estamos tratando de analizar.  Si proguard no lo intentaba demasiado, el c√≥digo Java descompilado para crear mensajes protobuf podr√≠a simplemente copiarse en su proyecto. <br><br>  Mirando el c√≥digo descompilado, vemos que Build. * Constantes se env√≠an dentro del mensaje protobuf.  (Est√° bien, eso no fue demasiado dif√≠cil de adivinar). <br><br><pre> <code class="java hljs">... var3.a(<span class="hljs-string"><span class="hljs-string">"4.0.33 (910055-30)"</span></span>); a(var3, <span class="hljs-string"><span class="hljs-string">"BOARD"</span></span>, Build.BOARD); a(var3, <span class="hljs-string"><span class="hljs-string">"BOOTLOADER"</span></span>, Build.BOOTLOADER); a(var3, <span class="hljs-string"><span class="hljs-string">"BRAND"</span></span>, Build.BRAND); a(var3, <span class="hljs-string"><span class="hljs-string">"CPU_ABI"</span></span>, Build.CPU_ABI); a(var3, <span class="hljs-string"><span class="hljs-string">"CPU_ABI2"</span></span>, Build.CPU_ABI2); a(var3, <span class="hljs-string"><span class="hljs-string">"DEVICE"</span></span>, Build.DEVICE); ...</code> </pre><br>  Pero desafortunadamente, en la respuesta del servidor, todos los campos de protobuf se convirtieron en sopa de letras despu√©s de la ofuscaci√≥n.  Pero podemos descubrir qu√© hay all√≠ usando un controlador de errores.  As√≠ se verifican los datos que provienen del servidor: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.d()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"byteCode"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.f()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"vmUrl"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.h()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"vmChecksum"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.j()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"expiryTimeSecs"</span></span>); }</code> </pre><br>  Aparentemente, as√≠ se llamaban los campos antes de la ofuscaci√≥n: <b>byteCode</b> , <b>vmUrl</b> , <b>vmChecksum</b> y <b>expiryTimeSecs</b> .  Este esquema de nombres ya nos da algunas ideas. <br><br>  Combinamos todas las clases descompiladas de los Servicios de Google Play en un proyecto de prueba, les cambiamos el nombre, generamos Build Test *. Comandos y lanzamos (imitando cualquier dispositivo que queramos).  Si alguien quiere hacerlo √©l mismo, aqu√≠ est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el enlace a mi GitHub</a> . <br><br>  Si la solicitud es correcta, el servidor devuelve esto: <br><blockquote>  00: 06: 26.761 [main] INFO daresponse.AntiabuseResponse - byteCode size: 34446 <br>  00: 06: 26.761 [main] INFO daresponse.AntiabuseResponse - vmChecksum: C15E93CCFD9EF178293A2334A1C9F9B08F115993 <br>  00: 06: 26.761 [main] INFO daresponse.AntiabuseResponse - vmUrl: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.gstatic.com/droidguard/C15E93CCFD9EF178293A2334A1C9F9B08F115993</a> <br>  00: 06: 26.761 [main] INFO daresponse.AntiabuseResponse - expiryTimeSecs: 10 </blockquote><br>  Paso 1 completo.  Ahora veamos qu√© hay detr√°s del enlace <b>vmUrl</b> . <br><br><h3>  APK secreto </h3><br>  El enlace nos lleva directamente a un archivo .apk, llamado as√≠ por su propio hash SHA-1.  Es bastante peque√±o, solo 150 KB.  Y est√° bastante justificado: si es descargado por cada uno de los 2 mil millones de dispositivos Android, eso es 270 TB de tr√°fico en los servicios de Google. <br><br><img src="https://habrastorage.org/webt/-s/di/nj/-sdinjinilpprsvgslvs3e6gsdk.png"><br><br>  <code>DroidGuardService</code> clase <code>DroidGuardService</code> , que forma parte de los servicios de Google Play, descarga el archivo en el dispositivo, lo descomprime, extrae .dex y utiliza la clase <code>com.google.ccc.abuse.droidguard.DroidGuard</code> trav√©s de la reflexi√≥n.  Si hay un error, <code>DroidGuardService</code> cambia de DroidGuard a Droidguasso.  Pero esa es otra historia completamente. <br><br>  Esencialmente, la clase <code>DroidGuard</code> es un simple contenedor JNI alrededor de la biblioteca nativa .so.  El ABI de la biblioteca nativa coincide con lo que enviamos en el campo <code>CPU_ABI</code> en la solicitud de protobuf: podemos pedir armeabi, x86 o incluso MIPS. <br><br>  El servicio <code>DroidGuardService</code> s√≠ no contiene ninguna l√≥gica interesante para trabajar con la clase <code>DroidGuard</code> .  Simplemente crea una nueva instancia de <code>DroidGuard</code> , le env√≠a el <b>byteCode</b> desde el mensaje protobuf, llama a un m√©todo p√∫blico, que devuelve una matriz de bytes.  Esta matriz se env√≠a al servidor dentro del par√°metro <b>droidguard_result</b> . <br><br>  Para tener una idea aproximada de lo que ocurre dentro de <code>DroidGuard</code> , podemos repetir la l√≥gica de <code>DroidGuardService</code> (pero sin descargar el .apk, ya que ya tenemos la biblioteca nativa).  Podemos tomar un archivo .dex del APK secreto, convertirlo a .jar y luego usarlo en nuestro proyecto.  El √∫nico problema es c√≥mo la clase <code>DroidGuard</code> carga la biblioteca nativa.  El bloque de inicializaci√≥n est√°tica llama al m√©todo <code>loadDroidGuardLibrary()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { loadDroidGuardLibrary(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(ex); } }</code> </pre><br>  Luego, el m√©todo <code>loadDroidGuardLibrary()</code> lee library.txt (ubicado en la ra√≠z del archivo .apk) y carga la biblioteca con ese nombre a trav√©s de la llamada <code>System.load(String filename)</code> .  No es muy conveniente para nosotros, ya que necesitar√≠amos construir el .apk de una manera muy espec√≠fica para poner library.txt y el archivo .so en su ra√≠z.  Ser√≠a mucho m√°s conveniente mantener el archivo .so en la carpeta lib y cargarlo a trav√©s de <code>System.loadLibrary(String libname)</code> . <br><br>  No es dif√≠cil de hacer.  Usaremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">smali / baksmali</a> - ensamblador / desensamblador para archivos .dex.  Despu√©s de usarlo, classes.dex se convierte en un mont√≥n de archivos .smali.  La clase <code>com.google.ccc.abuse.droidguard.DroidGuard</code> debe modificarse, de modo que el bloque de inicializaci√≥n est√°tica llame al m√©todo <code>System.loadLibrary("droidguard")</code> lugar de <code>loadDroidGuardLibrary()</code> .  La sintaxis de Smali es bastante simple, el nuevo bloque de inicializaci√≥n se ve as√≠: <br><br><pre> <code class="plaintext hljs">.method static constructor &lt;clinit&gt;()V .locals 1 const-string v0, "droidguard" invoke-static {v0}, Ljava/lang/System;-&gt;loadLibrary(Ljava/lang/String;)V return-void .end method</code> </pre><br>  Luego usamos backsmali para construirlo todo en .dex, y luego lo convertimos en .jar.  Al final obtenemos un archivo .jar que podemos usar en nuestro proyecto, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠ est√°</a> , por cierto. <br><br>  Toda la secci√≥n relacionada con DroidGuard tiene un par de cadenas de largo.  La parte m√°s importante es descargar la matriz de bytes que obtuvimos en el paso anterior despu√©s de abordar el servicio anti-abuso y entregarlo al constructor <code>DroidGuard</code> : <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runDroidguard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteCode: ByteArray? = loadBytecode(<span class="hljs-string"><span class="hljs-string">"bytecode.base64"</span></span>); byteCode?.let { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> droidguard = DroidGuard(applicationContext, <span class="hljs-string"><span class="hljs-string">"addAccount"</span></span>, it) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> params = mapOf(<span class="hljs-string"><span class="hljs-string">"dg_email"</span></span> to <span class="hljs-string"><span class="hljs-string">"test@gmail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_gmsCoreVersion"</span></span> to <span class="hljs-string"><span class="hljs-string">"910055-30"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_package"</span></span> to <span class="hljs-string"><span class="hljs-string">"com.google.android.gms"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_androidId"</span></span> to UUID.randomUUID().toString()) droidguard.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = droidguard.ss(params) droidguard.close() } }</code> </pre><br>  Ahora podemos usar el perfilador de Android Studio y ver qu√© sucede durante el trabajo de DroidGuard: <br><br><img src="https://habrastorage.org/webt/c-/9w/pz/c-9wpzbrrpibjyflhyrunq3azu0.png"><br><br>  El m√©todo nativo initNative () recopila datos sobre el dispositivo y llama a los m√©todos Java <code>hasSystemFeature(), getMemoryInfo(), getPackageInfo()</code> ... eso es algo, pero todav√≠a no veo ninguna l√≥gica s√≥lida.  Bueno, todo lo que queda es desmontar el archivo .so. <br><br><h3>  libdroidguard.so </h3><br>  Afortunadamente, analizar la biblioteca nativa no es m√°s dif√≠cil que hacerlo con archivos .dex y .jar.  Necesitar√≠amos una aplicaci√≥n similar a la IDA de Hex-Rays y algunos conocimientos de c√≥digo de ensamblador x86 o ARM.  Eleg√≠ ARM, ya que ten√≠a un dispositivo rooteado para depurar.  Si no tiene una, puede tomar una biblioteca x86 y depurarla utilizando un emulador. <br><br>  Una aplicaci√≥n similar a Hex-Rays IDA descompila el binario en algo parecido al c√≥digo C.  Si abrimos el m√©todo <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_ssNative</code> , veremos algo como esto: <br><br><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a3, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a4, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a5, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a6, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a7, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a8, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a9)</span></span></span><span class="hljs-function"> ... v14 </span></span>= (*(_DWORD *)v9 + <span class="hljs-number"><span class="hljs-number">684</span></span>))(v9, a5); v15 = (*(_DWORD *)v9 + <span class="hljs-number"><span class="hljs-number">736</span></span>))(v9, a5, <span class="hljs-number"><span class="hljs-number">0</span></span>); ...</code> </pre><br>  No parece demasiado prometedor.  Primero necesitamos hacer un par de pasos preliminares para transformar eso en algo m√°s √∫til.  El descompilador no sabe nada sobre JNI, por lo que instalamos Android NDK e importamos el archivo jni.h.  Como sabemos, los dos primeros par√°metros de un m√©todo JNI son <code>JNIEnv*</code> y <code>jobject (this)</code> .  Podemos encontrar los tipos de otros par√°metros del c√≥digo Java de DroidGuard.  Despu√©s de asignar los tipos correctos, las compensaciones sin sentido se convierten en llamadas al m√©todo JNI: <br><br><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_JNIEnv *env, jobject thiz, jobject context, jstring flow, jbyteArray byteCode, jobject runtimeApi, jobject extras, jint loggingFd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> runningInAppSide)</span></span></span><span class="hljs-function"> </span></span>{ ... programLength = _env-&gt;functions-&gt;GetArrayLength)(_env, byteCode); programBytes = (jbyte *)_env-&gt;functions-&gt;GetByteArrayElements)(_env, byteCode, <span class="hljs-number"><span class="hljs-number">0</span></span>); ...</code> </pre><br>  Si tenemos suficiente paciencia para rastrear la matriz de bytes recibida del servidor anti-abuso, estaremos ... decepcionados.  Desafortunadamente, no hay una respuesta simple a "¬øqu√© est√° pasando aqu√≠?".  Es c√≥digo de bytes puro y destilado, y la biblioteca nativa es una m√°quina virtual.  Parte del cifrado AES espolvoreado en la parte superior y luego la VM lee el c√≥digo de bytes, byte por byte, y ejecuta comandos.  Cada byte es un comando seguido de operandos.  No hay muchos comandos, solo alrededor de 70: leer int, leer byte, leer cadena, llamar al m√©todo Java, multiplicar dos n√∫meros, if-goto, etc. <br><br><h3>  Despierta neo </h3><br>  Decid√≠ ir a√∫n m√°s lejos y descubrir la estructura del c√≥digo de bytes para esta VM.  Hay otro problema con las llamadas: a veces (una vez cada dos semanas) hay una nueva versi√≥n de la biblioteca nativa donde se mezclan los pares de bytes y comandos.  No me detuvo y decid√≠ recrear la VM usando Java. <br><br>  Lo que hace el c√≥digo de bytes es hacer todo el trabajo de rutina para recopilar informaci√≥n sobre el dispositivo.  Por ejemplo, carga una cadena con el nombre de un m√©todo, obtiene su direcci√≥n a trav√©s de dlsym y se ejecuta.  En mi versi√≥n Java de la VM, recre√© solo unos 5 m√©todos y aprend√≠ a interpretar los primeros 25 comandos del c√≥digo de bytes del servicio contra el abuso.  En el comando 26 la VM ley√≥ otra cadena encriptada del c√≥digo de bytes.  De repente result√≥ que no es un nombre de otro m√©todo.  Lejos de eso. <br><blockquote>  Comando de m√°quina virtual # 26 <br>  Invocaci√≥n de m√©todo vm-&gt; vm_method_table [2 * 0x77] <br>  M√©todo vmMethod_readString <br>  el √≠ndice es 0x9d <br>  la longitud de la cadena es 0x0066 <br>  (se genera una nueva clave) <br>  los bytes de cadena codificados son EB 4E E6 DC 34 13 35 4A DD 55 B3 91 33 05 61 04 C0 54 FD 95 2F 18 72 04 C1 55 E1 92 28 11 66 04 DD 4F B3 94 33 04 35 0A C1 4E B2 DB 12 17 79 4F 92 55 FC DB 33 05 35 45 C6 01 F7 89 29 1F 71 43 C7 40 E1 9F 6B 1E 70 48 DE 4E B8 CD 75 44 23 14 85 14 A7 C2 7F 40 26 42 84 17 A2 BB 21 19 7A 43 DE 44 BD 98 29 1B <br>  los bytes de cadena decodificados son 59 6F 75 27 72 65 20 6E 6F 74 20 6A 75 73 74 20 72 75 6E 6E 69 6E 67 20 73 74 72 69 6E 67 73 20 6F 6E 20 6F 75 72 20 2E 73 6F 21 20 54 61 6C 6B 20 74 6F 20 75 73 20 61 74 20 64 72 6F 69 64 67 75 61 72 64 2D 68 65 6C 6C 6F 2B 36 33 32 36 30 37 35 34 39 39 36 33 66 36 36 31 40 67 6F 6F 67 6C 65 2E 63 6F 6D <br>  el valor de cadena decodificada es ( <b>¬°No solo est√° ejecutando cadenas en nuestro .so! Hable con nosotros en droidguard@google.com</b> ) </blockquote>  Eso es extra√±o  Una m√°quina virtual nunca me ha hablado antes.  Pens√© que si comienzas a ver mensajes secretos dirigidos a ti, te est√°s volviendo loco.  Solo para asegurarme de que a√∫n estaba cuerdo, ejecut√© un par de cientos de respuestas diferentes del servicio contra el abuso a trav√©s de mi VM.  Literalmente, cada 25-30 comandos hab√≠a un mensaje oculto dentro del c√≥digo de bytes.  A menudo se repiten, pero a continuaci√≥n hay algunos √∫nicos.  Sin embargo, edit√© las direcciones de correo electr√≥nico: cada mensaje ten√≠a una direcci√≥n diferente, algo as√≠ como "droidguard+tag@google.com", y la etiqueta era √∫nica para cada uno. <br><blockquote>  droidguard@google.com: ¬°No seas un extra√±o! <br>  ¬°Entraste!  Hable con nosotros en droidguard@google.com <br>  ¬°Saludos del viajero intr√©pido droidguard@google.com!  Di hola! <br>  ¬øFue f√°cil encontrar esto?  droidguard@google.com quisiera saber <br>  ¬°La gente de droidguard@google.com agradecer√≠a saber de usted! <br>  ¬øQu√© es todo este gobbledygook?  Pregunte a droidguard@google.com ... ¬°lo sabr√≠an! <br>  Hey  Me alegro de verte aqu√≠.  ¬øYa has hablado con droidguard@google.com? <br>  No solo est√°s ejecutando cadenas en nuestro .so!  Hable con nosotros en droidguard@google.com <br></blockquote>  ¬øSoy el elegido?  Pens√© que era hora de dejar de jugar con DroidGuard y hablar con Google, ya que me lo pidieron. <br><br><h3>  Tu llamada es muy importante para nosotros </h3><br>  Dije mis hallazgos en el correo electr√≥nico que encontr√©.  Para que los resultados sean un poco m√°s impresionantes, automatic√© un poco el proceso de an√°lisis.  La cuesti√≥n es que las cadenas y las matrices de bytes se almacenan en el c√≥digo de bytes cifrado.  La VM los decodifica usando constantes alineadas por el compilador.  Usando una aplicaci√≥n similar a Hex-Rays IDA puede extraerlos con bastante facilidad.  Pero con cada nueva versi√≥n, las constantes cambian y es bastante inconveniente extraerlas siempre manualmente. <br><br>  Pero analizar Java la biblioteca nativa result√≥ sorprendentemente simple.  Usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">jelf</a> (una biblioteca para analizar archivos ELF) encontramos el desplazamiento del m√©todo <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</code> en el binario, y luego usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Capstone</a> (un marco de desensamblaje con enlaces para varios idiomas, incluido Java) obtenemos el c√≥digo del ensamblador y buscamos constantes de carga en registros <br><br>  Al final, obtuve una aplicaci√≥n que emulaba todo el proceso de DroidGuard: realiza una solicitud al servicio contra el abuso, descarga el .apk, lo desempaqueta, analiza la biblioteca nativa, extrae las constantes necesarias, selecciona la asignaci√≥n de los comandos de VM y interpreta el c√≥digo de byte.  Lo compil√© todo y lo envi√© a Google.  Mientras lo hac√≠a, comenc√© a prepararme para una mudanza y busqu√© Glassdoor para obtener un salario promedio en Google.  Decid√≠ no aceptar nada menos de seis cifras. <br><br>  La respuesta no tard√≥ mucho.  Un correo electr√≥nico de un miembro del equipo de DroidGuard simplemente dec√≠a: "¬øPor qu√© est√°s haciendo esto?" <br><br><img src="https://habrastorage.org/webt/go/ql/kf/goqlkffwq02w6daa9-e22xxgdiq.jpeg"><br><br>  "Porque puedo" - respond√≠.  Un empleado de Google me explic√≥ que se supone que DroidGuard protege a Android de los piratas inform√°ticos (¬°no lo dices!) Y ser√≠a prudente mantener el c√≥digo fuente de mi DroidGuard VM para m√≠.  Nuestra conversaci√≥n termin√≥ all√≠. <br><br><h3>  Entrevista </h3><br>  Un mes despu√©s recib√≠ otro correo electr√≥nico.  El equipo DroidGuard en Zurich necesitaba un nuevo empleado.  ¬øEstaba interesado en unirme?  Por supuesto! <br><br>  No hay atajos para ingresar a Google.  Todo lo que pude hacer fue enviar mi CV al departamento de recursos humanos.  Despu√©s de eso, tuve que pasar por el habitual rigmarole burocr√°tico y una serie de entrevistas. <br><br>  Hay muchas historias sobre entrevistas de Google.  Los algoritmos, las tareas de Olimpiadas y la programaci√≥n de Google Docs no son lo m√≠o, as√≠ que comenc√© mis preparativos.  Le√≠ docenas de veces el curso de "Algoritmos" de Coursera, resolv√≠ cientos de tareas en Hackerrank y aprend√≠ a sortear un gr√°fico en ambas dimensiones con los ojos cerrados. <br><br>  Pasaron dos meses.  Decir que me sent√≠ preparado ser√≠a quedarse corto.  Google Docs se convirti√≥ en mi IDE favorito.  Sent√≠ que sab√≠a todo lo que hay que saber sobre algoritmos.  Por supuesto, conoc√≠a mis debilidades y me di cuenta de que probablemente no pasar√≠a la serie de 5 entrevistas en Zurich, pero ir al Disneyland del programador gratis era una recompensa en s√≠ misma.  El primer paso fue una entrevista telef√≥nica para eliminar a los candidatos m√°s d√©biles y no perder el tiempo de los desarrolladores de Zurich en reuniones en persona.  El d√≠a estaba listo, son√≥ el tel√©fono ... <br><br><img src="https://habrastorage.org/webt/5c/nk/uh/5cnkuh5btyvoaz0pyz-zma3flzs.png"><br><br>  ... e inmediatamente fall√© mi primera prueba.  Tuve suerte: hicieron una pregunta que he visto en Internet antes y que ya resolv√≠.  Se trataba de serializar un conjunto de cadenas.  Ofrec√≠ codificar cadenas en Base64 y guardarlas a trav√©s de un divisor.  El entrevistador me pidi√≥ que desarrollara un algoritmo Base64.  Despu√©s de eso, la entrevista se convirti√≥ en una especie de mon√≥logo, donde los entrevistados me explicaron c√≥mo funciona Base64 y trat√© de recordar las operaciones de bit en Java. <br><br><div class="spoiler">  <b class="spoiler_title">Si alguien en Google est√° leyendo esto</b> <div class="spoiler_text">  ¬°Chicos, ustedes son genios sangrientos si llegaron all√≠!  En serio  No puedo imaginar c√≥mo uno puede eliminar todos los obst√°culos que ponen delante de usted. <br></div></div><br>  3 d√≠as despu√©s de la llamada recib√≠ un correo electr√≥nico que dec√≠a que no quer√≠an entrevistarme m√°s.  Y as√≠ termin√≥ mi comunicaci√≥n con Google. <br><br>  Por qu√© hay mensajes en DroidGuard que piden chatear, todav√≠a no tengo idea.  Probablemente solo por estad√≠sticas.  El tipo con el que escrib√≠ en primer lugar me dijo que la gente realmente escribe all√≠, pero la frecuencia var√≠a: a veces reciben 3 respuestas en una semana, a veces 1 al a√±o. <br><br>  Creo que hay formas m√°s f√°ciles de obtener una entrevista en Google.  Despu√©s de todo, podr√≠as preguntarle a cualquiera de los 100,000 empleados (aunque no todos son desarrolladores, sin duda).  Pero fue una experiencia divertida, no obstante. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/446790/">https://habr.com/ru/post/446790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446776/index.html">Prueba de trabajo efectiva</a></li>
<li><a href="../446780/index.html">C√≥mo crear un tema oscuro y no da√±ar. Yandex.Mail Team Experience</a></li>
<li><a href="../446782/index.html">Yo-ho-ho y una botella de ron</a></li>
<li><a href="../446786/index.html">¬øPor qu√© rechac√© Disqus y t√∫ tambi√©n deber√≠as ir?</a></li>
<li><a href="../446788/index.html">Consejos y trucos de Kubernetes: sobre desarrollo local y telepresencia</a></li>
<li><a href="../446794/index.html">Trabajamos con Wordstat correctamente. Gu√≠a completa</a></li>
<li><a href="../446796/index.html">Circuitos no est√°ndar: indicador de siete segmentos en ATtiny13</a></li>
<li><a href="../446798/index.html">La partida de un ingeniero electr√≥nico de Apple caus√≥ revuelo entre los especuladores burs√°tiles. ¬øC√≥mo llegar a ser como √©l?</a></li>
<li><a href="../446802/index.html">Recarga de cartuchos de puntos: es interesante</a></li>
<li><a href="../446806/index.html">Antecedentes: "Runet aut√≥nomo": qu√© es y qui√©n lo necesita</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>