<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ß üî£ üêΩ CDN din√¢mico para transmiss√£o WebRTC de baixa lat√™ncia üò¥ üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë© ‚è±Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antes, analisando as possibilidades de configura√ß√µes de servidor padr√£o no Digital Ocean do ponto de vista do streaming WebRTC, observamos que um serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>CDN din√¢mico para transmiss√£o WebRTC de baixa lat√™ncia</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flashphoner/blog/477310/"><p><img src="https://habrastorage.org/webt/qp/yd/gy/qpydgy2jfifixw87t9seev0eb7o.jpeg"></p><br><p>  Antes, analisando as possibilidades de configura√ß√µes de <a href="https://habr.com/en/company/flashphoner/blog/476546/">servidor</a> padr√£o <a href="https://habr.com/en/company/flashphoner/blog/476546/">no Digital Ocean</a> do ponto de vista do streaming WebRTC, observamos que um servidor pode atender at√© 2.000 espectadores.  Na vida real, geralmente h√° casos em que um servidor n√£o √© suficiente. </p><br><p>  Digamos que os f√£s de emo√ß√£o na Alemanha assistam a corridas de cavalos em tempo real na Austr√°lia.  Como as corridas de cavalos n√£o s√£o apenas esportes equestres, mas tamb√©m grandes vit√≥rias, com apostas pontuais, o v√≠deo deve ser entregue com o menor atraso poss√≠vel. </p><a name="habracut"></a><br><p>  Outro exemplo  Uma corpora√ß√£o global, uma das l√≠deres no mercado FCMG com subsidi√°rias na Europa, R√∫ssia e Sudeste Asi√°tico, est√° organizando semin√°rios on-line para treinar gerentes de vendas transmitidos a partir da sede no Mediterr√¢neo.  Os espectadores devem ver e ouvir o apresentador em tempo real. </p><br><p>  Esses exemplos combinam os requisitos: forne√ßa fluxos de m√≠dia para um grande n√∫mero de espectadores com baixa lat√™ncia.  Para fazer isso, voc√™ precisa implantar uma rede de entrega de conte√∫do - CDN. </p><br><p>  Observe que a tecnologia cl√°ssica de entrega de fluxo usando HLS n√£o √© adequada, pois pode causar atrasos de at√© 30 segundos, e isso √© cr√≠tico para shows em tempo real.  Imagine que os cavalos j√° chegaram √† linha de chegada, os resultados s√£o publicados no site e os f√£s ainda est√£o inspecionando a corrida.  Essa desvantagem √© privada da tecnologia WebRTC, que pode fornecer atrasos em 1 segundo. Com os canais de comunica√ß√£o modernos, isso √© poss√≠vel mesmo entre continentes. </p><br><p>  Primeiro, vamos ver como implantar a CDN mais simples para fornecer fluxos WebRTC e depois escal√°-la. </p><br><h2 id="struktura-cdn">  Estrutura CDN </h2><br><p>  Um servidor em uma CDN pode executar uma das seguintes fun√ß√µes: </p><br><ul><li>  Origin √© um servidor para publicar fluxos de m√≠dia.  Distribui fluxos para outros servidores, mas tamb√©m pode distribuir para assinantes. </li><li>  Transcoder - um servidor dedicado √† transcodifica√ß√£o de fluxos.  Recolhe fluxos dos servidores Origin e distribui fluxos transcodificados para o Edge.  Lidaremos com esse papel na pr√≥xima parte. </li><li>  Edge - um servidor projetado para distribuir fluxos para assinantes.  Leva fluxos de servidores Origin ou Transcoder, n√£o distribui fluxos para outros servidores CDN. </li></ul><br><p> Voc√™ pode publicar fluxos WebRTC e RTMP no servidor Origin ou capturar fluxos de outras fontes via RTMP, RTSP e outros m√©todos poss√≠veis. </p><br><p>  Os assinantes podem reproduzir fluxos de servidores de borda via WebRTC, RTMP, RTSP, HLS </p><br><p>  Entre os servidores CDN, √© desej√°vel transmitir por WebRTC para reduzir a lat√™ncia. </p><br><p>  Uma CDN est√°tica √© totalmente descrita no est√°gio de configura√ß√£o.  De fato, a configura√ß√£o de uma CDN est√°tica √© semelhante √† configura√ß√£o de um balanceador de carga: todos os receptores s√£o listados nas configura√ß√µes do servidor de origem do fluxo. </p><br><p>  Por exemplo, temos um servidor Origin em Frankfurt, um Edge em Nova York e outro em Cingapura </p><br><p><img src="https://habrastorage.org/webt/so/gg/1w/sogg1wq1m_67p9waxgdyjbtix4y.png"></p><br><p>  Nesse caso, o Origin est√° configurado da seguinte forma: </p><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loadbalancer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"roundrobin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stream_distribution</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"webrtc"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>edge1.thestaticcdn.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span>443<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>edge2.thestaticcdn.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span>443<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loadbalancer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Aqui est√° o primeiro problema com uma CDN est√°tica: para adicionar um novo servidor de Borda a uma CDN ou remover o servidor da CDN, √© necess√°rio alterar as configura√ß√µes e reiniciar todos os servidores Origin. </p><br><p>  Os fluxos publicados no Origin s√£o transmitidos para todos os servidores listados nas configura√ß√µes do Edge.  A decis√£o sobre a qual servidor de borda o assinante se conectar√° tamb√©m √© tomada no servidor Origin.  Aqui est√° o segundo problema: se n√£o h√° espectadores ou pouqu√≠ssimos, por exemplo, em Cingapura no in√≠cio da noite e em Nova York no meio da noite, os fluxos ainda s√£o transmitidos para o Edge 1. O tr√°fego √© gasto ocioso, e nem de gra√ßa. </p><br><p>  CDN din√¢mico pode resolver esses dois problemas. </p><br><p>  Portanto, queremos configurar a CDN sem reiniciar todos os servidores Origin e n√£o queremos transferir fluxos para os servidores Edge em que n√£o h√° assinantes.  Nesse caso, voc√™ n√£o precisa manter a lista inteira de servidores CDN em algum lugar nas configura√ß√µes.  Cada servidor em si deve criar essa lista e, para isso, deve saber o status atual dos outros servidores a qualquer momento. </p><br><p>  Idealmente, nas configura√ß√µes, deve ser suficiente especificar o ponto de entrada, o servidor a partir do qual a CDN √© iniciada.  Nesse ponto de entrada, cada servidor na inicializa√ß√£o deve enviar uma solicita√ß√£o e receber uma lista de n√≥s CDN e uma lista de fluxos publicados em resposta.  Se o ponto de entrada n√£o estiver dispon√≠vel, o servidor dever√° esperar mensagens de outros servidores. </p><br><p>  O servidor deve enviar quaisquer altera√ß√µes ao seu status para outros servidores na CDN. </p><br><h2 id="prosteyshaya-cdn-v-centre-evropy">  A CDN mais simples: no centro da Europa </h2><br><p>  Ent√£o, vamos tentar configurar e executar uma CDN din√¢mica.  Suponhamos que, para come√ßar, precisamos distribuir fluxos de v√≠deo para os espectadores europeus, enquanto at√© 5.000 usu√°rios devem ser suportados.  Suponha que a fonte dos fluxos tamb√©m esteja na Europa. </p><br><p><img src="https://habrastorage.org/webt/xo/oi/rx/xooirxhid75yiqsfuff8sdu5xge.png"></p><br><p>  Implementamos tr√™s servidores no data center europeu.  Usaremos o Flashphoner WebCallServer (servidor de streaming de v√≠deo WebRTC) como elementos para a constru√ß√£o de uma CDN. </p><br><p><img src="https://habrastorage.org/webt/ts/de/4x/tsde4xzznh96b-15pb7pephsqlc.png"></p><br><p>  Configura√ß√£o: </p><br><ul><li>  Origem UE </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=origin</code> </pre> <br><ul><li>  Edge 1 EU </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-eu1.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><ul><li>  Edge 2 EU </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-eu2.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><p>  As mensagens entre n√≥s CDN din√¢micos ocorrem atrav√©s do Websocket e, √© claro, o Secure Websocket tamb√©m √© suportado. </p><br><p>  Dentro da CDN, os fluxos s√£o transmitidos via WebRTC.  Como regra, o UDP √© usado como transporte, mas voc√™ pode mudar para o TCP se precisar garantir a qualidade da transmiss√£o com um canal n√£o muito bom entre os servidores.  Infelizmente, neste caso, os atrasos aumentam. </p><br><p>  Reiniciamos os servidores, abrimos o exemplo de transmiss√£o bidirecional no <code>o-eu1</code> , publicamos um v√≠deo c√≠clico com uma contagem regressiva de 10 minutos a 0 </p><br><p><img src="https://habrastorage.org/webt/96/l1/ir/96l1irnyaa3owncv9nlj7acek74.png"></p><br><p>  Abra o exemplo do Player no <code>e-eu1</code> , reproduza o fluxo </p><br><p><img src="https://habrastorage.org/webt/fc/3p/st/fc3pst40kkeh0gh0dunrcktlksg.png"></p><br><p>  E fa√ßa o mesmo no <code>e-eu2</code> </p><br><p><img src="https://habrastorage.org/webt/el/j5/ew/elj5ew8cqvaxpvmbmr14wwl1dvu.png"></p><br><p>  CDN funciona!  Como voc√™ pode ver nas capturas de tela, o tempo no v√≠deo coincide no lado da publica√ß√£o e nos espectadores por um segundo, gra√ßas ao WebRTC e a bons canais. </p><br><h2 id="dalee-vezde-podklyuchaem-ameriku">  Em todos os lugares: conectando a Am√©rica </h2><br><p>  Agora, enviaremos transmiss√µes para os telespectadores no continente americano e n√£o esqueceremos a publica√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/y6/8r/ig/y68rigg5xu5uq32qmvrb2_6yexq.png"></p><br><p>  Sem desativar a parte europ√©ia da CDN, implantamos tr√™s servidores no data center americano </p><br><p><img src="https://habrastorage.org/webt/t5/q8/vh/t5q8vh5mlwgvixiq_l-zdin6bje.png"></p><br><p>  Configura√ß√£o: </p><br><ul><li>  Origem EUA </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=o-us1.flashponer.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=origin</code> </pre> <br><ul><li>  Edge 1 US </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-us1.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><ul><li>  Edge 2 US </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-us2.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><p>  Reiniciamos os servidores americanos, verificamos a publica√ß√£o </p><br><p><img src="https://habrastorage.org/webt/6s/s1/uq/6ss1uquwqf-a0nctys-rsc6p4xo.png"><br>  e reprodu√ß√£o </p><br><p><img src="https://habrastorage.org/webt/4i/ur/_s/4iur_sn57za5_ypd9pssupfg8rm.png"></p><br><p>  Ao mesmo tempo, o segmento europeu continua trabalhando.  Verifique se os assinantes americanos ver√£o o fluxo publicado na Europa.  Publicamos o fluxo <code>test_eu</code> no <code>o-eu1</code> </p><br><p><img src="https://habrastorage.org/webt/yp/dk/0o/ypdk0o9fnrje0kbmtx7-duhrkuo.png"></p><br><p>  e jogue no <code>e-us1</code> </p><br><p><img src="https://habrastorage.org/webt/ld/6n/u3/ld6nu3rzicqjotfzz88goggo1lk.png"></p><br><p>  E isso tamb√©m funciona!  Quanto ao atraso, nas capturas de tela, observamos novamente a coincid√™ncia do cron√¥metro no v√≠deo no lado da publica√ß√£o e nos espectadores por um segundo. </p><br><p>  Observe que os fluxos publicados em outro servidor Origin n√£o podem ser reproduzidos diretamente do servidor Origin por padr√£o, mas se voc√™ precisar, poder√° configur√°-lo desta maneira </p><br><pre> <code class="plaintext hljs">cdn_origin_to_origin_route_propagation=true</code> </pre> <br><h2 id="prodolzhenie-sleduet">  Para ser continuado </h2><br><p>  Ent√£o, implantamos uma CDN simples e a escalamos com sucesso para dois continentes, publicando e reproduzindo fluxos WebRTC de baixa lat√™ncia.  Ao mesmo tempo, n√£o alteramos os par√¢metros dos fluxos durante a reprodu√ß√£o, o que na vida real √© necess√°rio com bastante frequ√™ncia: todos os espectadores t√™m canais diferentes e, para manter a qualidade da transmiss√£o, √© necess√°rio, por exemplo, diminuir a resolu√ß√£o ou taxa de bits.  Isso faremos na pr√≥xima parte ... </p><br><h2 id="ssylki">  Refer√™ncias </h2><br><p>  <a href="https://flashphoner.com/cdn-dlya-striminga-webrtc-s-nizkoj-zaderzhkoj/%3Flang%3Dru">A CDN de streaming WebRTC de baixa lat√™ncia √© uma</a> rede de entrega de conte√∫do baseada em servidor de chamadas da Web. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt477310/">https://habr.com/ru/post/pt477310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt477298/index.html">O que h√° dentro do aeroporto: centros de controle</a></li>
<li><a href="../pt477300/index.html">O que h√° dentro do melhor aeroporto regional do pa√≠s: servi√ßos de terminal</a></li>
<li><a href="../pt477304/index.html">CDN din√¢mico para transmiss√£o WebRTC de baixa lat√™ncia</a></li>
<li><a href="../pt477306/index.html">Da produ√ß√£o ao sal√°rio e √† produ√ß√£o sob pedido. A sequ√™ncia de etapas e um exemplo de implementa√ß√£o pr√°tica</a></li>
<li><a href="../pt477308/index.html">Clone Numpy</a></li>
<li><a href="../pt477312/index.html">Desenvolvimento de jogos em redes sociais</a></li>
<li><a href="../pt477314/index.html">Enviando eventos do ViewModel para Atividade / Fragmento no MVVM</a></li>
<li><a href="../pt477318/index.html">PHP Digest No. 168 (5 a 25 de novembro de 2019)</a></li>
<li><a href="../pt477320/index.html">Frente Ambiental: Como a Internet das Coisas Ajudar√° a Proteger o Meio Ambiente</a></li>
<li><a href="../pt477324/index.html">Por que voc√™ deve escolher o est√°tico analisador PVS-Studio para integrar no seu processo de desenvolvimento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>