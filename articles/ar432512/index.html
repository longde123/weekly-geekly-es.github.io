<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ค๏ธ ๐ด๏ธ ๐๐ผ PostgreSQL: PipelineDB - ุงุณุชุนูุงูุงุช ูุฌูุนุฉ ูู ุงูููุช ุงููุนูู ๐ ๐ฅ โ๐ฟ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูู ุทููุจ ููู ููููุง ุญุณุงุจ ููุฏุงุฑ ุดูุก ูุง ุงุณุชูุงุฏูุง ุฅูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจุงูุดูุฑ ุงููุงุถู ุ ูุชุฌููุน ุงููุชูุฌุฉ ุญุณุจ ุจุนุถ ุงูููู ูุชูุณูููุง ูู ู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL: PipelineDB - ุงุณุชุนูุงูุงุช ูุฌูุนุฉ ูู ุงูููุช ุงููุนูู</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432512/" style=";text-align:right;direction:rtl">  ูู ุทููุจ ููู ููููุง ุญุณุงุจ ููุฏุงุฑ ุดูุก ูุง ุงุณุชูุงุฏูุง ุฅูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจุงูุดูุฑ ุงููุงุถู ุ ูุชุฌููุน ุงููุชูุฌุฉ ุญุณุจ ุจุนุถ ุงูููู ูุชูุณูููุง ูู ููู / ุณุงุนุฉุ <br>  ุฅุฐุง ูุงูุช ุงูุฅุฌุงุจุฉ ุจูุนู - ูุฃูุช ุชุชุฎูู ุจุงููุนู ุฃูู ูุชุนูู ุนููู ูุชุงุจุฉ ุดูุก ูุซู ูุฐุง ุ ุจู ุงูุฃุณูุฃ ูู ุฐูู <br><br><pre style=";text-align:right;direction:rtl"><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hour</span></span>(datetime), somename, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(somemetric) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; :monthAgo <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  ูู ููุช ูุขุฎุฑ ุ ุชุจุฏุฃ ูุฌููุนุฉ ูุจูุฑุฉ ููุชููุนุฉ ูู ูุฐู ุงูุทูุจุงุช ูู ุงูุธููุฑ ุ ูุฅุฐุง ููุช ุชุญููุช ุงููุณุงุนุฏุฉ ูุฑุฉ ูุงุญุฏุฉ ุ ููุฃุณู ุ ุณุชุฃุชู ุงูุทุนูู ูู ุงููุณุชูุจู. <br><br>  ูููู ูุซู ูุฐู ุงูุทูุจุงุช ุณูุฆุฉ ูู ุญูุซ ุฃููุง ุชุณุชููู ููุงุฑุฏ ุงููุธุงู ุจุดูู ุฌูุฏ ูู ููุช ุงูุชุดุบูู ุ ููููู ุฃู ูููู ููุงู ุงููุซูุฑ ูู ุงูุจูุงูุงุช ุญุชู ุฃู ูุณุฎุฉ ูุชูุงุซูุฉ ููุฐู ุงูุทูุจุงุช ุณุชููู ูุคููุฉ (ูููุชูุง). <br><br>  ูููู ูุงุฐุง ูู ููุช ุฃูู ูุจุงุดุฑุฉ ูู PostgreSQL ุ ููููู ุฅูุดุงุก ุทุฑููุฉ ุนุฑุถ ููุงุฏูุง ุฃูู ูู ุงูุญุงู ุณุชูุธุฑ ููุท ูู ุงูุจูุงูุงุช ุงููุงุฑุฏุฉ ุงูุฌุฏูุฏุฉ ูู ุงุณุชุนูุงู ููุงุซู ูุจุงุดุฑุฉู ุ ููุง ูู ูุฐููุฑ ุฃุนูุงูุ <br><br>  ูุฐูู - ูููู ุฃู ุชูุนู ุชูุฏูุฏ PipelineDB <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุนุฑุถ ูู ูููุนูู ููู ูุนูู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/kz/5x/mb/kz5xmbjf4yjqv_ogkuhnirwu-ve.gif"><br></div></div><br><a name="habracut"></a>  ูุงู PipelineDB ูู ุงูุณุงุจู ูุดุฑูุนูุง ูููุตูุงู ุ ููููู ูุชููุฑ ุงูุขู ูููุญู ูู PG 10.1 ูุงูุฅุตุฏุงุฑุงุช ุงูุฃุญุฏุซ. <br><br>  ุนูู ุงูุฑุบู ูู ุฃู ุงููุฑุต ุงููุชุงุญุฉ ูุงูุช ููุฌูุฏุฉ ููุฐ ุฒูู ุทููู ูู ููุชุฌุงุช ุฃุฎุฑู ูุตููุฉ ุฎุตูุตูุง ูุฌูุน ููุงููุณ ุงูููุช ุงููุนูู ุ ุฅูุง ุฃู PipelineDB ููุง ููุฒุฉ ูููุฉ: ุญุฏ ุฏุฎูู ุฃุฏูู ูููุทูุฑูู ุงูุฐูู ูุนุฑููู SQL ุจุงููุนู. <br><br>  ุฑุจูุง ุจุงููุณุจุฉ ููุจุนุถ ููุณ ูู ุงูุถุฑูุฑู.  ุฃูุง ุดุฎุตูุงู ูุณุช ูุณูููุง ุฌุฏูุง ูุฃู ุฃุฌุฑุจ ูู ูุง ูุจุฏู ููุงุณุจูุง ูุญู ูุดููุฉ ูุนููุฉ ุ ููููู ูู ุฃุชุญุฑู ููุฑูุง ูุงุณุชุฎุฏุงู ุญู ุฌุฏูุฏ ูุฌููุน ุงูุญุงูุงุช.  ูุฐูู ุ ูู ูุฐู ุงูููุงูุฉ ูุง ุฃุญุซ ุนูู ุฅุณูุงุท ูู ุดูุก ูุชุซุจูุช PipelineDB ุนูู ุงูููุฑ ุ ูุฐู ูุฌุฑุฏ ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธููุฉ ุงูุฑุฆูุณูุฉ ุ ููุง  ุจุฏุง ุงูุดูุก ูุถููู ุจุงููุณุจุฉ ูู. <br><br>  ูููุฐุง ุ ุจุดูู ุนุงู ุ ูุฏููู ูุซุงุฆู ุฌูุฏุฉ ุ ููููู ุฃุฑุบุจ ูู ูุดุงุฑูุฉ ุชุฌุฑุจุชู ุญูู ููููุฉ ุชุฌุฑุจุฉ ูุฐุง ุงูุนูู ูู ุงูููุงุฑุณุฉ ูุชูุฏูู ุงููุชุงุฆุฌ ุฅูู Grafana. <br><br>  ุญุชู ูุง ุชุชูุงุซุฑ ูู ุงูุฌูุงุฒ ุงููุญูู ุ ุฃููู ุจูุดุฑ ูู ุดูุก ูู ุงูุฌูุงุฒ. <br>  ุงูุตูุฑ ุงููุณุชุฎุฏูุฉ: <code>postgres:latest</code> ุ <code>grafana/grafana</code> <br><br><h3 style=";text-align:right;direction:rtl">  ุชุซุจูุช PipelineDB ุนูู ุจูุณุชุฌุฑุณ </h3><br>  ุนูู ุฌูุงุฒ ูุน postgres ุ ููุฐ ุจุงูุชุชุงุจุน: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <code>apt update</code> </li> <li style=";text-align:right;direction:rtl"> <code>apt install curl</code> </li> <li style=";text-align:right;direction:rtl"> <code>curl -s http://download.pipelinedb.com/apt.sh | bash</code> </li> <li style=";text-align:right;direction:rtl"> <code>apt install pipelinedb-postgresql-11</code> </li> <li style=";text-align:right;direction:rtl"> <code>cd /var/lib/postgresql/data</code> </li> <li style=";text-align:right;direction:rtl">  ุงูุชุญ ููู <code>postgresql.conf</code> ูู ุฃู ูุญุฑุฑ </li><li style=";text-align:right;direction:rtl">  ุงุจุญุซ ุนู ููุชุงุญ <code>shared_preload_libraries</code> ุ ููู ุจุฅูุบุงุก ุงูุถุจุท ููู ุจุชุนููู ูููุฉ <code>pipelinedb</code> </li><li style=";text-align:right;direction:rtl">  ุชุนููู <code>max_worker_processes</code> ุงูููุชุงุญ ุฅูู 128 (ุฃุฑุตูุฉ ุงูุชูุตูุฉ) </li><li style=";text-align:right;direction:rtl">  ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู </li></ol><br><h3 style=";text-align:right;direction:rtl">  ุฅูุดุงุก ุฏูู ูุนุฑุถ ูู PipelineDB </h3><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุจุนุฏ ุฅุนุงุฏุฉ ุชุดุบูู pg - ูุดุงูุฏุฉ ุงูุณุฌูุงุช ุจุญูุซ ูููู ููุงู ุดูุก ูู ูุฐุง ุงููุจูู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/xc/6i/dz/xc6idzmydyyu2qgvpu7emd7aj2i.png"><br></div></div><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุชู ุณูุนูู ูููุง: <code>CREATE DATABASE testpipe;</code> </li><li style=";text-align:right;direction:rtl">  ุฅูุดุงุก ููุญู: <code>CREATE EXTENSION pipelinedb;</code> </li><li style=";text-align:right;direction:rtl">  ุงูุขู ุงูุดูุก ุงูุฃูุซุฑ ุฅุซุงุฑุฉ ููุงูุชูุงู ูู ุฅูุดุงุก ุชูุงุฑ.  ุชุญุชุงุฌ ููู ุฅูู ุฅุถุงูุฉ ุจูุงูุงุช ูููุนุงูุฌุฉ ุงูุฅุถุงููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> flow_stream ( dtmsk <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span> pipelinedb;</code> </pre> <br>  ูู ุงููุงูุน ุ ุฅูู ูุดุจู ุฅูู ุญุฏ ุจุนูุฏ ุฅูุดุงุก ุฌุฏูู ุนุงุฏู ุ ูุง ููููู ููุท ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ูู ูุฐุง ุงูุฏูู ูุน <code>select</code> ุจุณูุท - ุชุญุชุงุฌ ุฅูู ุนุฑุถ </li><li style=";text-align:right;direction:rtl">  ูู ุงููุงูุน ููููุฉ ุฅูุดุงุฆู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> viewflow <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (ttl = <span class="hljs-string"><span class="hljs-string">'3 month'</span></span>, ttl_column = <span class="hljs-string"><span class="hljs-string">'m'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span>(dtmsk) m, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*), <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br>  ูุทูู ุนูููุง " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุดุงูุฏุงุช ุงููุณุชูุฑุฉ"</a> ูุชุนุซุฑุช ูู ุงููุงูุน ุ ุฃู  ูุน ุงูุญูุงุธ ุนูู ุงูุฏููุฉ. <br><br>  <code>WITH</code> ุจุชูุฑูุฑ ูุนููุงุช ุฅุถุงููุฉ. <br><br>  ูู ุญุงูุชู ุ ูุนูู <code>ttl = '3 month'</code> ุฃูู ุชุญุชุงุฌ ุฅูู ุชุฎุฒูู ุงูุจูุงูุงุช ููุท ููุฏุฉ 3 ุฃุดูุฑ ุงููุงุถูุฉ ุ ูุฃู ุชุฃุฎุฐ ุงูุชุงุฑูุฎ / ุงูููุช ูู ุงูุนููุฏ <code>M</code>  <code>reaper</code> ุนูููุฉ <code>reaper</code> ุงูุฎูููุฉ ุนู ุงูุจูุงูุงุช ุงููุฏููุฉ ูุชุญุฐููุง. <br><br>  ุจุงููุณุจุฉ ูุฃููุฆู ุงูุฐูู ููุณูุง ูู ูุนุฑูุฉ ุ ุชุฑุฌุน ุงูุฏุงูุฉ <code>minute</code> ุชุงุฑูุฎ / ููุช ุฏูู ุซูุงูู.  ูุจุงูุชุงูู ุ ูุฅู ุฌููุน ุงูุฃุญุฏุงุซ ุงูุชู ููุนุช ูู ุฏูููุฉ ูุงุญุฏุฉ ุณูููู ููุง ููุณ ุงูููุช ููุชูุฌุฉ ููุชุฌููุน. </li><li style=";text-align:right;direction:rtl">  ูุซู ูุฐุง ุงูุนุฑุถ ูู ุฌุฏูู ุชูุฑูุจูุง ุ ูุฃู ุงูููุฑุณ ุญุณุจ ุชุงุฑูุฎ ุฃุฎุฐ ุงูุนููุงุช ุณูููู ูููุฏูุง ูู ุญุงูุฉ ุชุฎุฒูู ุงููุซูุฑ ูู ุงูุจูุงูุงุช <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> viewflow (m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>);</code> </pre> </li></ol><br><h3 style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู PipelineDB </h3><br>  ุชุฐูุฑ: ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ูู ุงูุฏูู ุ ููุฑุงุกุฉ ูู ุงูุนุฑุถ ุงูุงุดุชุฑุงู ููู <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), <span class="hljs-string"><span class="hljs-string">'act1'</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>(), <span class="hljs-string"><span class="hljs-string">'act2'</span></span>, <span class="hljs-number"><span class="hljs-number">33</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> viewflow <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>()</code> </pre> <br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฃููู ุจุชูููุฐ ุงูุทูุจ ูุฏูููุง</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/3j/rb/fy/3jrbfyanqdnf8uhrmwytpmippxa.gif"><br></div></div>  ุฃููุงู ุ ุฃุดุงูุฏ ููู ุชุชุบูุฑ ุงูุจูุงูุงุช ูู ุงูุฏูููุฉ 46 <br>  ุจูุฌุฑุฏ ุฃู ูุฃุชู 47 ุ ุชููู ุงูุณุงุจูุฉ ุงูุณุงุจูุฉ ุงูุชุญุฏูุซ ูุชุจุฏุฃ ุงูุฏูููุฉ ุงูุญุงููุฉ ุชุฏู. <br><br>  ุฅุฐุง ููุช ุชูุชู ุจุฎุทุฉ ุงูุงุณุชุนูุงู ุ ููููู ุฑุคูุฉ ุงูุฌุฏูู ุงูุฃุตูู ูุน ุงูุจูุงูุงุช <br><br><img src="https://habrastorage.org/webt/z8/pm/fd/z8pmfdnqxflibrane_hjpmyxupa.png"><br><br>  ุฃูุตู ุจุงูุฐูุงุจ ุฅููู ููุนุฑูุฉ ููููุฉ ุชุฎุฒูู ุจูุงูุงุชู ุจุงููุนู <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูููุฏ ุงูุญุฏุซ C #</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Npgsql; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">PipelineDbLogGenerator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Random _rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] _actions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"foo"</span></span>, <span class="hljs-string"><span class="hljs-string">"bar"</span></span>, <span class="hljs-string"><span class="hljs-string">"yep"</span></span>, <span class="hljs-string"><span class="hljs-string">"goal"</span></span>, <span class="hljs-string"><span class="hljs-string">"ano"</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connString = <span class="hljs-string"><span class="hljs-string">"Host=localhost;port=5432;Username=postgres;Database=testpipe"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlConnection(connString)) { conn.Open(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt = DateTime.UtcNow; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlCommand()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> act = GetAction(); cmd.Connection = conn; cmd.CommandText = <span class="hljs-string"><span class="hljs-string">"INSERT INTO flow_stream VALUES (@dtmsk, @action, @duration)"</span></span>; cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"dtmsk"</span></span>, dt); cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, act); cmd.Parameters.AddWithValue(<span class="hljs-string"><span class="hljs-string">"duration"</span></span>, GetDuration(act)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = cmd.ExecuteNonQuery(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{res}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{dt}</span></span></span><span class="hljs-string">"</span></span>); } Thread.Sleep(_rnd.Next(<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">230</span></span>)); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> act</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; act.Length; i++) { c += act[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _rnd.Next(c); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _actions[_rnd.Next(_actions.Length)]; } } }</code> </pre> <br></div></div><br><h3 style=";text-align:right;direction:rtl">  ุงูุงุณุชูุชุงุฌ ูู ุบุฑุงูุงูุง </h3><br>  ููุญุตูู ุนูู ุงูุจูุงูุงุช ูู postgres ุ ุชุญุชุงุฌ ุฅูู ุฅุถุงูุฉ ูุตุฏุฑ ุงูุจูุงูุงุช ุงูููุงุณุจ: <br><br><img src="https://habrastorage.org/webt/_6/5s/lo/_65slonsdesxobympei4ty266es.png"><br><br>  ูู ุจุฅูุดุงุก ููุญุฉ ูุนูููุงุช ุฌุฏูุฏุฉ ูุฅุถุงูุฉ ููุญุฉ ูู ุงูููุน Graph ุฅูููุง ุ ูุจุนุฏ ุฐูู ุชุญุชุงุฌ ุฅูู ุงูุฏุฎูู ูู ุชุญุฑูุฑ ุงูููุญุฉ: <br><br><img src="https://habrastorage.org/webt/sm/va/ca/smvacalablhaoaohk0hamjcdrv0.png"><br><br>  ุงูุชุงูู - ุญุฏุฏ ูุตุฏุฑ ุจูุงูุงุช ุ ูุงูุชูู ุฅูู ูุถุน ูุชุงุจุฉ sql- ุงูุงุณุชุนูุงู ูุฃุฏุฎู ูุฐุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- Grafana   time count, action from viewflow where $__timeFilter(m) --  ,     ,   col between :startdate and :enddate order by m desc, action;</span></span></code> </pre> <br>  ุซู ุชุญุตู ุนูู ุฌุฏูู ุฒููู ุทุจูุนู ุ ุจุทุจูุนุฉ ุงูุญุงู ุ ุฅุฐุง ููุช ูุฏ ุจุฏุฃุช ูููุฏ ุงูุญุฏุซ <br><br><img src="https://habrastorage.org/webt/y-/3j/3k/y-3j3k8kzkwu_p6ipmzovycuqe0.png"><br><br>  ููุนูููุงุชู: ูุฌูุฏ ูุคุดุฑ ูููู ุฃู ูููู ููููุง ุฌุฏูุง.  ุนูู ุงูุฑุบู ูู ุฃู ุงุณุชุฎุฏุงูู ูุนุชูุฏ ุนูู ุญุฌู ุงูุฌุฏูู ุงููุงุชุฌ.  ุฅุฐุง ููุช ุชุฎุทุท ูุชุฎุฒูู ุนุฏุฏ ุตุบูุฑ ูู ุงูุตููู ูู ูุชุฑุฉ ุตุบูุฑุฉ ูู ุงูููุช ุ ููููู ุฃู ูุชุญูู ุจุณูููุฉ ุฅูู ุฃู ูุญุต seq ุณูููู ุฃุฑุฎุต ุ ูุณูุถูู ุงูููุฑุณ ุฅุถุงูููุง ููุท.  ุชุญููู ุนูุฏ ุชุญุฏูุซ ุงูููู <br><br>  ูููู ุงูุงุดุชุฑุงู ูุฌูุงุช ูุธุฑ ูุชุนุฏุฏุฉ ูู ุชูุงุฑ ูุงุญุฏ. <br><br>  ุงูุชุฑุถ ุฃููู ุฃุฑูุฏ ุฃู ุฃุฑู ุนุฏุฏ ุทุฑู api ุงูุชู ูุชู ุชูููุฐูุง ุจูุงุณุทุฉ ุงููุณุจ ุงููุฆููุฉ <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> viewflow_per <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (ttl = <span class="hljs-string"><span class="hljs-string">'3 d'</span></span>, ttl_column = <span class="hljs-string"><span class="hljs-string">'m'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span>(dtmsk) m, <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p50, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.95</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p95, <span class="hljs-keyword"><span class="hljs-keyword">percentile_cont</span></span>(<span class="hljs-number"><span class="hljs-number">0.99</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span> p99 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flow_stream <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> viewflow_per (m <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>);</code> </pre> <br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฃูุนู ููุณ ุงูุฎุฏุนุฉ ูุน grafana ูุฃุญุตู ุนูู:</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/rx/zx/kj/rxzxkjagevdpf_v82yx-81b3-7a.png"><br></div></div><br><h3 style=";text-align:right;direction:rtl">  ุงููุฌููุน </h3><br>  ุจุดูู ุนุงู ุ ุงูุดูุก ูุนูู ุ ููุฏ ุชุตุฑู ุจุดูู ุฌูุฏ ุ ุฏูู ุดูุงูู.  ุนูู ุงูุฑุบู ูู ุฃูู ุชุญุช ุนุงูู ุงูููู ุ ููุฏ ุชุจูู ุฃู ุชูุฒูู ูุงุนุฏุฉ ุจูุงูุงุช ุงูุนุฑุถ ุงูุชูุถูุญู ูู ุงูุฃุฑุดูู (2.3 ุฌูุฌุงุจุงูุช) ุทููู ุฌุฏูุง. <br><br>  ุฃุฑูุฏ ุฃู ุฃุดูุฑ - ูู ุฃูู ุจุฅุฌุฑุงุก ุงุฎุชุจุงุฑุงุช ุงูุฅุฌูุงุฏ. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุซุงุฆู ุงูุฑุณููุฉ</a> <br><br><h4 style=";text-align:right;direction:rtl">  ูุฏ ูููู ูุซูุฑุง ููุงูุชูุงู </h4><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฏุนู ูุชูุฒูู ุงูุจูุงูุงุช <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูู Apache Kafka ุฅูู ุงูุชุฏููุงุช</a> </li><li style=";text-align:right;direction:rtl">  ุนูู ุบุฑุงุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฃูุงุฒูู ููููุณูุณ</a> </li><li style=";text-align:right;direction:rtl">  ููููู ุฅูุดุงุก ุทุฑู ุนุฑุถ ููุท <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุชุญููู ุงูุจูุงูุงุช</a> (ุจุฏูู ุชุฎุฒูู) </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">PipelineDB Cluster</a> - ููุงู ูุณุฎุฉ ุชุฌุงุฑูุฉ.  ูู ุฐูู ุ ููููู ุชูุฒูุน ูุฌูุงุช ุงููุธุฑ ูููุง ูุฃุดูุงู.  ูุฒูุฏ ูู ุงูุชูุงุตูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูู ููุต ุงูุงุชูุงู ูุฑุงุฑ ุงููุชูุฉ</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar432512/">https://habr.com/ru/post/ar432512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar432500/index.html">ุดูุงุฏุฉ PMP: ูุฑุงุฌุนุฉ ุงูุชุทุจููุงุช</a></li>
<li><a href="../ar432502/index.html">ูุฏ ุชูุงุฌู ุงูุฅูุชุฑูุช ูุดููุงุช ุฎุทูุฑุฉ ุจุณุจุจ ูุบุงุช ูุซู C ู C ++ ุงูุชู ุชุณุงูู ูู ุญุฏูุซ ุซุบุฑุงุช ุฃูููุฉ</a></li>
<li><a href="../ar432506/index.html">Microsoft Connect () ุ 2018: ุฌููุน ุฅุนูุงูุงุช ุงููุคุชูุฑุงุช ุงูุณุญุงุจูุฉ</a></li>
<li><a href="../ar432508/index.html">ุนูู ุงูุญูุงุฌุฒ ุงูุชู ุชุญูู ุฏูู ุงุณุชุฎุฏุงู ุฃูุธูุฉ ุงูุฅุดุงุฑุฉ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู</a></li>
<li><a href="../ar432510/index.html">ุชุจูุบ ุญุตุฉ ุงููุฑููุฌ ูู ุณูู ุงูุณูุงุฑุงุช ุงูููุฑุจุงุฆูุฉ ุงูุฅุถุงููุฉ ูุณุชููู ูุฑุชูุนูุง ุชูุฑูุจูุง</a></li>
<li><a href="../ar432514/index.html">ุงูุชุนุฑู ุนูู ุงููุตูุต ุงููุชุนููุฉ ุจุฃุดูุงุก Android ุจุงุณุชุฎุฏุงู ABBYY RTR SDK ู django</a></li>
<li><a href="../ar432516/index.html">ุชูุณูุน ุขูุงูู ุ ููููุฒ! ุฃู ููุงุฐุง ูุญุชุงุฌ ุงูููุฒูุงุฆููู ุฅูู ููุงุฑุงุช ุงูููุงู ูุงูุทูู</a></li>
<li><a href="../ar432518/index.html">ุงูุฅููุชุฑูู ูุชุฑุงุฌุน ุงูุชุทุจููุงุช ุงููุญููุฉ</a></li>
<li><a href="../ar432520/index.html">ููููุฉ ุชุบููุฑ ูููุฉ ูุฑูุฑ ุงููุณุคูู ูู Atlassian Jira ู Confluence ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุถููุฉ (H2)</a></li>
<li><a href="../ar432524/index.html">ููุงุฐุง ูุฌุจ ุฃู ูุง ุชุณุชุฎุฏู Quora ูุฑุฉ ุฃุฎุฑู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>