<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¼ğŸ» ğŸ•— ğŸ”™ å®‰å…¨å©´å„¿åºŠï¼šJWT ğŸ•ºğŸ¿ ğŸŒï¸ ğŸ”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è®¸å¤šåº”ç”¨ç¨‹åºä½¿ç”¨JSON Webä»¤ç‰Œï¼ˆJWTï¼‰æ¥å…è®¸å®¢æˆ·ç«¯æ ‡è¯†è‡ªå·±ï¼Œä»¥ä¾¿åœ¨èº«ä»½éªŒè¯åè¿›è¡Œè¿›ä¸€æ­¥çš„ä¿¡æ¯äº¤æ¢ã€‚ 

 JSON Webä»¤ç‰Œæ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘è€Œç‹¬ç«‹çš„æ–¹å¼æ¥å®‰å…¨åœ°åœ¨å„æ–¹ä¹‹é—´ä½œä¸ºJSONå¯¹è±¡ä¼ è¾“ä¿¡æ¯ã€‚ 


 è¯¥ä¿¡æ¯ç»è¿‡äº†æ•°å­—ç­¾åï¼Œå› æ­¤ç»è¿‡éªŒè¯å’Œå¯é ã€‚ 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å®‰å…¨å©´å„¿åºŠï¼šJWT</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/457090/"><img src="https://habrastorage.org/webt/db/hk/3r/dbhk3r8z4e24imgvw6mjwyuat4m.png"><br><br> è®¸å¤šåº”ç”¨ç¨‹åºä½¿ç”¨JSON Webä»¤ç‰Œï¼ˆJWTï¼‰æ¥å…è®¸å®¢æˆ·ç«¯æ ‡è¯†è‡ªå·±ï¼Œä»¥ä¾¿åœ¨èº«ä»½éªŒè¯åè¿›è¡Œè¿›ä¸€æ­¥çš„ä¿¡æ¯äº¤æ¢ã€‚ <br><br>  JSON Webä»¤ç‰Œæ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘è€Œç‹¬ç«‹çš„æ–¹å¼æ¥å®‰å…¨åœ°åœ¨å„æ–¹ä¹‹é—´ä½œä¸ºJSONå¯¹è±¡ä¼ è¾“ä¿¡æ¯ã€‚ <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/oq/x9/6o/oqx96ozecxiq4qbsrzrk-dw7n5u.png"><br> è¯¥ä¿¡æ¯ç»è¿‡äº†æ•°å­—ç­¾åï¼Œå› æ­¤ç»è¿‡éªŒè¯å’Œå¯é ã€‚ <br> å¯ä»¥ä½¿ç”¨ç§˜å¯†ï¼ˆä½¿ç”¨HMACç®—æ³•ï¼‰æˆ–ä½¿ç”¨RSAæˆ–ECDSAçš„å…¬é’¥/ç§é’¥å¯¹å¯¹JWTè¿›è¡Œç­¾åã€‚ <br><br>  JSON Webä»¤ç‰Œç”¨äºä¼ è¾“æœ‰å…³å®¢æˆ·ç«¯èº«ä»½å’Œç‰¹å¾çš„ä¿¡æ¯ã€‚ æ­¤â€œå®¹å™¨â€ç”±æœåŠ¡å™¨ç­¾åï¼Œå› æ­¤å®¢æˆ·ç«¯ä¸ä¼šå¯¹å…¶è¿›è¡Œå¹²æ‰°ï¼Œä¹Ÿæ— æ³•æ›´æ”¹ä¾‹å¦‚æ ‡è¯†æ•°æ®æˆ–ä»»ä½•ç‰¹å¾ï¼ˆä¾‹å¦‚ï¼Œä»ç®€å•ç”¨æˆ·åˆ°ç®¡ç†å‘˜çš„è§’è‰²æˆ–æ›´æ”¹å®¢æˆ·ç«¯çš„ç™»å½•åï¼‰ã€‚ <br><br> åœ¨æˆåŠŸè®¤è¯çš„æƒ…å†µä¸‹åˆ›å»ºæ­¤ä»¤ç‰Œï¼Œå¹¶åœ¨å¼€å§‹æ‰§è¡Œæ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ä¹‹å‰ç”±æœåŠ¡å™¨æ£€æŸ¥è¯¥ä»¤ç‰Œã€‚ è¯¥ä»¤ç‰Œç”±åº”ç”¨ç¨‹åºç”¨ä½œå®¢æˆ·ç«¯çš„â€œèº«ä»½è¯â€ï¼ˆåŒ…å«æœ‰å…³ä»–çš„æ‰€æœ‰ä¿¡æ¯çš„å®¹å™¨ï¼‰ã€‚ æœåŠ¡å™¨å…·æœ‰ä»¥å®‰å…¨æ–¹å¼éªŒè¯ä»¤ç‰Œçš„æœ‰æ•ˆæ€§å’Œå®Œæ•´æ€§çš„èƒ½åŠ›ã€‚ è¿™ä½¿åº”ç”¨ç¨‹åºå¯ä»¥æ˜¯æ— çŠ¶æ€çš„ï¼ˆæ— çŠ¶æ€åº”ç”¨ç¨‹åºä¸ä¼šä¿å­˜åœ¨ä¸€ä¸ªä¼šè¯ä¸­ç”Ÿæˆçš„å®¢æˆ·ç«¯æ•°æ®ä¾›ä¸è¯¥å®¢æˆ·ç«¯è¿›è¡Œä¸‹ä¸€ä¼šè¯ä½¿ç”¨ï¼ˆæ¯ä¸ªä¼šè¯æ˜¯ç‹¬ç«‹çš„ï¼‰ï¼‰ï¼Œå¹¶ä¸”èº«ä»½éªŒè¯è¿‡ç¨‹ä¸æ‰€ä½¿ç”¨çš„æœåŠ¡æ— å…³ï¼ˆå°±å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æŠ€æœ¯è€Œè¨€ï¼‰å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œç”šè‡³åŒ…æ‹¬ä¼ è¾“é€šé“ï¼Œå°½ç®¡HTTPæ˜¯æœ€å¸¸ç”¨çš„ï¼‰ã€‚ <br><br><h2> ä½¿ç”¨JWTçš„æ³¨æ„äº‹é¡¹ </h2><br> å³ä½¿JWTä»¤ç‰Œæ˜“äºä½¿ç”¨ï¼Œå¹¶å…è®¸æ‚¨åœ¨æ²¡æœ‰çŠ¶æ€ï¼ˆæ— çŠ¶æ€ï¼‰çš„æƒ…å†µä¸‹æä¾›æœåŠ¡ï¼ˆä¸»è¦æ˜¯RESTï¼‰ï¼Œè¯¥è§£å†³æ–¹æ¡ˆä¹Ÿä¸é€‚ç”¨äºæ‰€æœ‰åº”ç”¨ç¨‹åºï¼Œå› ä¸ºå®ƒå¸¦æœ‰ä¸€äº›è­¦å‘Šï¼Œä¾‹å¦‚å­˜å‚¨ä»¤ç‰Œçš„é—®é¢˜ã€‚ <br><br> å¦‚æœåº”ç”¨ç¨‹åºä¸å¿…æ˜¯å®Œå…¨æ— çŠ¶æ€çš„ï¼Œåˆ™å¯ä»¥è€ƒè™‘ä½¿ç”¨æ‰€æœ‰Webå¹³å°æä¾›çš„ä¼ ç»Ÿä¼šè¯ç³»ç»Ÿã€‚ ä½†æ˜¯ï¼Œå¯¹äºæ— çŠ¶æ€åº”ç”¨ç¨‹åºï¼Œå¦‚æœæ­£ç¡®å®ç°ï¼Œåˆ™JWTæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ <br><br>
<h2>  JWTçš„é—®é¢˜å’Œæ”»å‡» </h2><br><h4> ä½¿ç”¨NONEå“ˆå¸Œç®—æ³• </h4><br> å½“æ”»å‡»è€…æ›´æ”¹ä»¤ç‰Œå¹¶æ›´æ”¹å“ˆå¸Œç®—æ³•ï¼ˆâ€œ algâ€å­—æ®µï¼‰ä»¥é€šè¿‡noneå…³é”®å­—æŒ‡ç¤ºä»¤ç‰Œå®Œæ•´æ€§å·²å¾—åˆ°éªŒè¯æ—¶ï¼Œä¼šå‘ç”Ÿç±»ä¼¼çš„æ”»å‡»ã€‚ ä¸€äº›åº“å°†ä½¿ç”¨noneç®—æ³•ç­¾åçš„ä»¤ç‰Œè§†ä¸ºå…·æœ‰ç»è¿‡éªŒè¯çš„ç­¾åçš„æœ‰æ•ˆä»¤ç‰Œï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥æ›´æ”¹ä»¤ç‰Œçš„æœ‰æ•ˆè½½è·ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºå°†ä¿¡ä»»è¯¥ä»¤ç‰Œã€‚ <br><br> ä¸ºäº†é˜²æ­¢æ”»å‡»ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨ä¸å—æ­¤æ¼æ´å½±å“çš„JWTåº“ã€‚ å¦å¤–ï¼Œåœ¨ä»¤ç‰ŒéªŒè¯æœŸé—´ï¼Œæ‚¨å¿…é¡»æ˜ç¡®è¯·æ±‚ä½¿ç”¨æœŸæœ›çš„ç®—æ³•ã€‚ <br><br>  <b><u>å®æ–½ç¤ºä¾‹ï¼š</u></b> <br><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  HMAC   String   JVM private transient byte[] keyHMAC = ...; ... //        //    HMAC-256 - JWTVerifier verifier = JWT.require(Algorithm.HMAC256(keyHMAC)).build(); //   DecodedJWT decodedToken = verifier.verify(token);</span></span></code> </pre> <br><h4> ä»¤ç‰Œæ‹¦æˆª </h4><br> å½“ä»¤ç‰Œå·²è¢«æ”»å‡»è€…æ‹¦æˆªæˆ–çªƒå–ï¼Œå¹¶ä¸”æ”»å‡»è€…ä½¿ç”¨ä»¤ç‰Œä½¿ç”¨ç‰¹å®šç”¨æˆ·çš„å‡­æ®æ¥è®¿é—®ç³»ç»Ÿæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ”»å‡»ã€‚ <br><br> ä¿æŠ¤åŒ…æ‹¬åœ¨ä»¤ç‰Œä¸­æ·»åŠ â€œç”¨æˆ·ä¸Šä¸‹æ–‡â€ã€‚ ç”¨æˆ·ä¸Šä¸‹æ–‡å°†åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š <br><br><ol><li> åœ¨è®¤è¯é˜¶æ®µç”Ÿæˆå¹¶åŒ…å«åœ¨ä»¤ç‰Œä¸­çš„éšæœºå­—ç¬¦ä¸²ï¼Œå¹¶ä½œä¸ºæ›´å®‰å…¨çš„cookieå‘é€åˆ°å®¢æˆ·ç«¯ï¼ˆæ ‡å¿—ï¼šHttpOnly + Secure + SameSite + cookieå‰ç¼€ï¼‰ã€‚ </li><li> æ¥è‡ªéšæœºå­—ç¬¦ä¸²çš„SHA256å“ˆå¸Œå°†å­˜å‚¨åœ¨ä»¤ç‰Œä¸­ï¼Œä»¥ä¾¿ä»»ä½•XSSé—®é¢˜éƒ½ä¸ä¼šå…è®¸æ”»å‡»è€…è¯»å–éšæœºå­—ç¬¦ä¸²çš„å€¼å¹¶è®¾ç½®æœŸæœ›çš„cookieã€‚ </li></ol><br>  IPåœ°å€ä¸ä¼šåœ¨ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ï¼Œå› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹IPåœ°å€å¯èƒ½ä¼šåœ¨ä¸€ä¸ªä¼šè¯ä¸­æ›´æ”¹ï¼Œä¾‹å¦‚ï¼Œå½“ç”¨æˆ·é€šè¿‡å…¶æ‰‹æœºè®¿é—®åº”ç”¨ç¨‹åºæ—¶ã€‚ ç„¶åï¼ŒIPåœ°å€ä¸æ–­åˆæ³•åœ°æ›´æ”¹ã€‚ æ­¤å¤–ï¼Œä½¿ç”¨IPåœ°å€å¯èƒ½ä¼šåœ¨ç¬¦åˆæ¬§æ´²GDPRçš„æ°´å¹³ä¸Šå¼•èµ·é—®é¢˜ã€‚ <br><br> å¦‚æœåœ¨ä»¤ç‰ŒéªŒè¯æœŸé—´æ¥æ”¶åˆ°çš„ä»¤ç‰Œä¸åŒ…å«æ­£ç¡®çš„ä¸Šä¸‹æ–‡ï¼Œåˆ™å¿…é¡»å°†å…¶æ‹’ç»ã€‚ <br>  <b><u>å®æ–½ç¤ºä¾‹ï¼š</u></b> <br><br>  <i>æˆåŠŸè®¤è¯ååˆ›å»ºä»¤ç‰Œçš„ä»£ç ï¼š</i> <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  HMAC   String   JVM private transient byte[] keyHMAC = ...; //    private SecureRandom secureRandom = new SecureRandom(); ... //   ,     byte[] randomFgp = new byte[50]; secureRandom.nextBytes(randomFgp); String userFingerprint = DatatypeConverter.printHexBinary(randomFgp); //    cookie String fingerprintCookie = "__Secure-Fgp=" + userFingerprint + "; SameSite=Strict; HttpOnly; Secure"; response.addHeader("Set-Cookie", fingerprintCookie); // SHA256          // (  )  XSS      //     cookie MessageDigest digest = MessageDigest.getInstance("SHA-256"); byte[] userFingerprintDigest = digest.digest(userFingerprint.getBytes("utf-8")); String userFingerprintHash = DatatypeConverter.printHexBinary(userFingerprintDigest); //      15     Calendar c = Calendar.getInstance(); Date now = c.getTime(); c.add(Calendar.MINUTE, 15); Date expirationDate = c.getTime(); Map&lt;String, Object&gt; headerClaims = new HashMap&lt;&gt;(); headerClaims.put("typ", "JWT"); String token = JWT.create().withSubject(login) .withExpiresAt(expirationDate) .withIssuer(this.issuerID) .withIssuedAt(now) .withNotBefore(now) .withClaim("userFingerprint", userFingerprintHash) .withHeader(headerClaims) .sign(Algorithm.HMAC256(this.keyHMAC));</span></span></code> </pre> <br><br>  <i>éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§çš„ä»£ç ï¼š</i> <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  HMAC   String   JVM private transient byte[] keyHMAC = ...; ... //     cookie String userFingerprint = null; if (request.getCookies() != null &amp;&amp; request.getCookies().length &gt; 0) { List&lt;Cookie&gt; cookies = Arrays.stream(request.getCookies()).collect(Collectors.toList()); Optional&lt;Cookie&gt; cookie = cookies.stream().filter(c -&gt; "__Secure-Fgp" .equals(c.getName())).findFirst(); if (cookie.isPresent()) { userFingerprint = cookie.get().getValue(); } } //  SHA256      cookie  //       MessageDigest digest = MessageDigest.getInstance("SHA-256"); byte[] userFingerprintDigest = digest.digest(userFingerprint.getBytes("utf-8")); String userFingerprintHash = DatatypeConverter.printHexBinary(userFingerprintDigest); //      JWTVerifier verifier = JWT.require(Algorithm.HMAC256(keyHMAC)) .withIssuer(issuerID) .withClaim("userFingerprint", userFingerprintHash) .build(); //   DecodedJWT decodedToken = verifier.verify(token);</span></span></code> </pre> <br><h4> ç”¨æˆ·æ˜ç¡®æ’¤é”€ä»¤ç‰Œ </h4><br> ç”±äºä»¤ç‰Œä»…åœ¨ä»¤ç‰Œåˆ°æœŸåæ‰å˜å¾—æ— æ•ˆï¼Œå› æ­¤ç”¨æˆ·æ²¡æœ‰å†…ç½®åŠŸèƒ½å¯è®©æ‚¨æ˜¾å¼å–æ¶ˆä»¤ç‰Œã€‚ å› æ­¤ï¼Œåœ¨ç›—çªƒçš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ— æ³•è‡ªå·±æ’¤å›ä»¤ç‰Œï¼Œç„¶åé˜»æ­¢æ”»å‡»è€…ã€‚ <br><br> ä¿æŠ¤æ–¹æ³•ä¹‹ä¸€æ˜¯å¼•å…¥ä»¤ç‰Œé»‘åå•ï¼Œè¯¥é»‘åå•å°†é€‚åˆäºæ¨¡æ‹Ÿä¼ ç»Ÿä¼šè¯ç³»ç»Ÿä¸­å­˜åœ¨çš„â€œæ³¨é”€â€åŠŸèƒ½ã€‚ <br><br> å…·æœ‰å–æ¶ˆæ—¥æœŸçš„ä»¤ç‰Œçš„é›†åˆï¼ˆä»¥HEXçš„SHA-256ç¼–ç ï¼‰åº”è¶…è¿‡å·²å‘è¡Œä»¤ç‰Œçš„æœ‰æ•ˆæœŸï¼Œå°†è¢«å­˜å‚¨åœ¨é»‘åå•ä¸­ã€‚ <br><br> å½“ç”¨æˆ·æƒ³è¦â€œæ³¨é”€â€æ—¶ï¼Œä»–è°ƒç”¨ä¸€é¡¹ç‰¹æ®ŠæœåŠ¡ï¼Œè¯¥æœåŠ¡å°†æä¾›çš„ç”¨æˆ·ä»¤ç‰Œæ·»åŠ åˆ°é»‘åå•ä¸­ï¼Œè¿™ä¼šå¯¼è‡´è¯¥ä»¤ç‰Œç«‹å³è¢«å–æ¶ˆï¼Œä»¥åœ¨åº”ç”¨ç¨‹åºä¸­è¿›ä¸€æ­¥ä½¿ç”¨ã€‚ <br><br>  <u><b>å®æ–½ç¤ºä¾‹ï¼š</b></u> <br><br>  <i>é»‘åå•å­˜å‚¨åº“ï¼š</i> <br> ä¸ºäº†é›†ä¸­å­˜å‚¨é»‘åå•ï¼Œå°†ä½¿ç”¨å…·æœ‰ä»¥ä¸‹ç»“æ„çš„æ•°æ®åº“ï¼š <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">create table </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> not exists </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">revoked_token</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(jwt_token_digest varchar(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">255</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> primary key, revokation_date timestamp </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">now</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br>  <i>ä»¤ç‰Œæ’¤é”€ç®¡ç†ï¼š</i> <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//    (logout). //  ,      //         . public class TokenRevoker { //    @Resource("jdbc/storeDS") private DataSource storeDS; //      public boolean isTokenRevoked(String jwtInHex) throws Exception { boolean tokenIsPresent = false; if (jwtInHex != null &amp;&amp; !jwtInHex.trim().isEmpty()) { //   byte[] cipheredToken = DatatypeConverter.parseHexBinary(jwtInHex); //  SHA256   MessageDigest digest = MessageDigest.getInstance("SHA-256"); byte[] cipheredTokenDigest = digest.digest(cipheredToken); String jwtTokenDigestInHex = DatatypeConverter.printHexBinary(cipheredTokenDigest); //     try (Connection con = this.storeDS.getConnection()) { String query = "select jwt_token_digest from revoked_token where jwt_token_digest = ?"; try (PreparedStatement pStatement = con.prepareStatement(query)) { pStatement.setString(1, jwtTokenDigestInHex); try (ResultSet rSet = pStatement.executeQuery()) { tokenIsPresent = rSet.next(); } } } } return tokenIsPresent; } //    HEX      public void revokeToken(String jwtInHex) throws Exception { if (jwtInHex != null &amp;&amp; !jwtInHex.trim().isEmpty()) { //   byte[] cipheredToken = DatatypeConverter.parseHexBinary(jwtInHex); //  SHA256   MessageDigest digest = MessageDigest.getInstance("SHA-256"); byte[] cipheredTokenDigest = digest.digest(cipheredToken); String jwtTokenDigestInHex = DatatypeConverter.printHexBinary(cipheredTokenDigest); //             //   if (!this.isTokenRevoked(jwtInHex)) { try (Connection con = this.storeDS.getConnection()) { String query = "insert into revoked_token(jwt_token_digest) values(?)"; int insertedRecordCount; try (PreparedStatement pStatement = con.prepareStatement(query)) { pStatement.setString(1, jwtTokenDigestInHex); insertedRecordCount = pStatement.executeUpdate(); } if (insertedRecordCount != 1) { throw new IllegalStateException("Number of inserted record is invalid," + " 1 expected but is " + insertedRecordCount); } } } } }</span></span></code> </pre><br><h4> ä»£å¸æŠ«éœ² </h4><br> å½“æ”»å‡»è€…è·å¾—å¯¹ä»¤ç‰Œï¼ˆæˆ–ä¸€ç»„ä»¤ç‰Œï¼‰çš„è®¿é—®æƒå¹¶æå–å­˜å‚¨åœ¨å…¶ä¸­çš„ä¿¡æ¯ï¼ˆæœ‰å…³JWTä»¤ç‰Œçš„ä¿¡æ¯ä½¿ç”¨base64ç¼–ç ï¼‰ä»¥è·å–æœ‰å…³ç³»ç»Ÿçš„ä¿¡æ¯æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­¤æ”»å‡»ã€‚ ä¿¡æ¯å¯ä»¥æ˜¯ä¾‹å¦‚å®‰å…¨è§’è‰²ï¼Œç™»å½•æ ¼å¼ç­‰ã€‚ <br><br> ä¿æŠ¤æ–¹æ³•éå¸¸æ˜æ˜¾ï¼ŒåŒ…æ‹¬åŠ å¯†ä»¤ç‰Œã€‚ ä½¿ç”¨åŠ å¯†åˆ†æä¿æŠ¤åŠ å¯†æ•°æ®å…å—æ”»å‡»ä¹Ÿå¾ˆé‡è¦ã€‚ ä¸ºäº†å®ç°æ‰€æœ‰è¿™äº›ç›®æ ‡ï¼Œä½¿ç”¨äº†AES-GCMç®—æ³•ï¼Œè¯¥ç®—æ³•æä¾›äº†å…·æœ‰å…³è”æ•°æ®çš„èº«ä»½éªŒè¯åŠ å¯†ï¼ˆAEADï¼‰ã€‚  AEADåŸè¯­æä¾›å¯¹ç§°çš„èº«ä»½éªŒè¯åŠ å¯†åŠŸèƒ½ã€‚ ä¿æŠ¤æ­¤åŸè¯­çš„å®ç°ï¼Œä½¿å…¶å…å—åŸºäºé€‰å®šå¯†æ–‡çš„è‡ªé€‚åº”æ”»å‡»ã€‚ åŠ å¯†çº¯æ–‡æœ¬æ—¶ï¼Œå¯ä»¥é€‰æ‹©æŒ‡å®šå¿…é¡»ç»è¿‡èº«ä»½éªŒè¯ä½†æœªåŠ å¯†çš„ç›¸å…³æ•°æ®ã€‚ <br><br> ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨ç›¸å…³æ•°æ®åŠ å¯†å¯ä»¥ç¡®ä¿æ•°æ®çš„çœŸå®æ€§å’Œå®Œæ•´æ€§ï¼Œä½†ä¸èƒ½ä¿è¯å…¶ä¿å¯†æ€§ã€‚ <br><br> ä½†æ˜¯ï¼Œåº”è¯¥æ³¨æ„ï¼ŒåŠ å¯†ä¸»è¦æ˜¯ä¸ºäº†éšè—å†…éƒ¨ä¿¡æ¯è€Œæ·»åŠ çš„ï¼Œä½†æ˜¯éå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯è¦è®°ä½ï¼Œé˜²æ­¢ä¼ªé€ JWTä»¤ç‰Œçš„æœ€åˆä¿æŠ¤æ˜¯ç­¾åï¼Œå› æ­¤ï¼Œåº”å§‹ç»ˆä½¿ç”¨ä»¤ç‰Œçš„ç­¾ååŠå…¶éªŒè¯ã€‚ <br><br><h4> å®¢æˆ·ç«¯ä»¤ç‰Œå­˜å‚¨ </h4><br> å¦‚æœåº”ç”¨ç¨‹åºå­˜å‚¨ä»¤ç‰Œï¼Œä»è€Œå‘ç”Ÿä»¥ä¸‹ä¸€ç§æˆ–å¤šç§æƒ…å†µï¼š <br><br><ul><li> ä»¤ç‰Œç”±æµè§ˆå™¨è‡ªåŠ¨å‘é€ï¼ˆcookieå­˜å‚¨ï¼‰ï¼› </li><li> å³ä½¿é‡æ–°å¯åŠ¨æµè§ˆå™¨ï¼ˆä½¿ç”¨æµè§ˆå™¨localStorageå®¹å™¨ï¼‰ï¼Œä¹Ÿä¼šè·å¾—ä»¤ç‰Œï¼› </li><li> åœ¨XSSæ”»å‡»çš„æƒ…å†µä¸‹è·å¾—ä»¤ç‰Œï¼ˆcookieå¯ç”¨äºJavaScriptä»£ç æˆ–ä»¤ç‰Œå­˜å‚¨åœ¨localStorageæˆ–sessionStorageä¸­ï¼‰ã€‚ </li></ul><br> ä¸ºäº†é˜²æ­¢æ”»å‡»ï¼š <br><br><ol><li> ä½¿ç”¨sessionStorageå®¹å™¨å°†ä»¤ç‰Œå­˜å‚¨åœ¨æµè§ˆå™¨ä¸­ã€‚ </li><li> ä½¿ç”¨Beareræ–¹æ¡ˆå°†å…¶æ·»åŠ åˆ°Authorizationæ ‡å¤´ä¸­ã€‚ æ ‡é¢˜åº”å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="xml hljs">Authorization: Bearer <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">token</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </li><li> å°†æŒ‡çº¹ä¿¡æ¯æ·»åŠ åˆ°ä»¤ç‰Œã€‚ </li></ol><br> é€šè¿‡å°†ä»¤ç‰Œå­˜å‚¨åœ¨sessionStorageå®¹å™¨ä¸­ï¼Œåœ¨XSSçš„æƒ…å†µä¸‹ï¼Œå®ƒä¸ºç›—çªƒæä¾›äº†ä»¤ç‰Œã€‚ ä½†æ˜¯ï¼Œæ·»åŠ åˆ°ä»¤ç‰Œçš„æŒ‡çº¹å¯ä»¥é˜²æ­¢æ”»å‡»è€…åœ¨å…¶è®¡ç®—æœºä¸Šé‡ç”¨è¢«ç›—çš„ä»¤ç‰Œã€‚ è¦å…³é—­æ”»å‡»è€…çš„æœ€å¤§ä½¿ç”¨èŒƒå›´ï¼Œè¯·æ·»åŠ å†…å®¹å®‰å…¨ç­–ç•¥ä»¥é™åˆ¶æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚ <br><br> åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…ä¼šå°†ç”¨æˆ·çš„æµè§ˆä¸Šä¸‹æ–‡ç”¨ä½œä»£ç†æœåŠ¡å™¨ï¼Œä»¥é€šè¿‡åˆæ³•ç”¨æˆ·ä½¿ç”¨ç›®æ ‡åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯å†…å®¹å®‰å…¨ç­–ç•¥å¯ä»¥é˜»æ­¢ä¸æ„å¤–åŸŸçš„é€šä¿¡ã€‚ <br><br> ä¹Ÿå¯ä»¥å®æ–½èº«ä»½éªŒè¯æœåŠ¡ï¼Œä»¥ä¾¿åœ¨å®‰å…¨cookieå†…å‘å¸ƒä»¤ç‰Œï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”å®æ–½é’ˆå¯¹CSRFçš„ä¿æŠ¤ã€‚ <br><br><h4> ä½¿ç”¨å¼±é”®åˆ›å»ºä»¤ç‰Œ </h4><br> å¦‚æœåœ¨HMAC-SHA256ç®—æ³•ä¸­ä½¿ç”¨çš„ç”¨äºç­¾åä»¤ç‰Œæ‰€å¿…éœ€çš„ç§˜å¯†å¾ˆå¼±ï¼Œåˆ™å¯ä»¥å¯¹å…¶è¿›è¡Œé»‘å®¢æ”»å‡»ï¼ˆä½¿ç”¨è›®åŠ›æ”»å‡»è¿›è¡ŒæŒ‘é€‰ï¼‰ã€‚ ç»“æœï¼Œæ”»å‡»è€…å¯ä»¥æ ¹æ®ç­¾åä¼ªé€ ä»»æ„æœ‰æ•ˆçš„ä»¤ç‰Œã€‚ <br><br> ä¸ºé¿å…æ­¤é—®é¢˜ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨å¤æ‚çš„å¯†é’¥ï¼šå­—æ¯æ•°å­—ï¼ˆå¤§å°å†™æ··åˆï¼‰+ç‰¹æ®Šå­—ç¬¦ã€‚ <br><br> ç”±äºåªæœ‰è®¡ç®—æœºè®¡ç®—æ‰éœ€è¦å¯†é’¥ï¼Œå› æ­¤å¯†é’¥çš„å¤§å°å¯ä»¥è¶…è¿‡50ä¸ªä½ç½®ã€‚ <br><br> ä¾‹å¦‚ï¼š <br><br><pre> <code class="plaintext hljs">A&amp;'/}Z57M(2hNg=;LE?~]YtRMS5(yZ&lt;vcZTA3N-($&gt;2j:ZeX-BGftaVk`)jKP~q?,jk)EMbgt*kW'</code> </pre> <br> è¦è¯„ä¼°ç”¨äºä»¤ç‰Œç­¾åçš„ç§˜å¯†å¯†é’¥çš„å¤æ‚æ€§ï¼Œå¯ä»¥ç»“åˆJWT APIå¯¹ä»¤ç‰Œåº”ç”¨å¯†ç å­—å…¸æ”»å‡»ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN457090/">https://habr.com/ru/post/zh-CN457090/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN457072/index.html">å¦‚ä½•åœ¨Pythonå’Œ.Netä¸­ä½¿ç”¨MLè§£å†³æ—§é—®é¢˜</a></li>
<li><a href="../zh-CN457074/index.html">å¼€å‘è€…çš„æ¼”å˜ï¼šæœªæ¥æˆ‘ä»¬åº”è¯¥æœŸå¾…ä»€ä¹ˆæ¸¸æˆ</a></li>
<li><a href="../zh-CN457078/index.html">å¦‚ä½•å°†ç”µæŠ¥å¤´åƒå˜æˆæ‰‹è¡¨</a></li>
<li><a href="../zh-CN457082/index.html">æ½œç§»é»˜åŒ–åœ°æˆäºˆç®¡ç†å‘˜æƒé™</a></li>
<li><a href="../zh-CN457086/index.html">â€œ Swiftâ€å’Œâ€œ iOSâ€ /â€œ macOSâ€é¢†åŸŸä¸­çš„å»ºç­‘æ¨¡å¼â€œ Builderâ€</a></li>
<li><a href="../zh-CN457092/index.html">æˆ‘ä»¬ç ”ç©¶MITRE ATTï¼†CKã€‚ ç§»åŠ¨çŸ©é˜µï¼šè®¾å¤‡è®¿é—®æƒé™ã€‚ ç¬¬5éƒ¨åˆ†</a></li>
<li><a href="../zh-CN457094/index.html">ExcelåŠ è½½é¡¹ï¼Œä½¿ç”¨å¤šç»´æ•°æ®é›†ï¼ˆVBAï¼‰æ—¶å¯ä»¥è½»æ¾è®¾ç½®è¿‡æ»¤å™¨</a></li>
<li><a href="../zh-CN457096/index.html">æˆ‘ä»¬å°†ç²¾åŠ›åˆ†é…ç»™äº†å‡ ä½åˆ†æå¸ˆï¼šAPI Livyï¼Œç”¨äºå®ç°å…¸å‹é“¶è¡Œä¸šåŠ¡çš„è‡ªåŠ¨åŒ–</a></li>
<li><a href="../zh-CN457098/index.html">ä½¿ç”¨Either monadè¿›è¡Œä¼˜é›…çš„JavaScripté”™è¯¯å¤„ç†</a></li>
<li><a href="../zh-CN457100/index.html">AWS Lambda-ç†è®ºï¼Œç›¸è¯†</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>