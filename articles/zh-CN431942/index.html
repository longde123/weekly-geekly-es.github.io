<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš’ ğŸ¤°ğŸ½ ğŸ‘²ğŸ¼ Reactå’ŒMobXçŠ¶æ€æ ‘ä¸­çš„åˆ†å±‚ä¾èµ–æ³¨å…¥ä½œä¸ºåŸŸæ¨¡å‹ ğŸ‘ ğŸ‘ ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨Reactä¸Šè¿›è¡Œäº†ä¸€äº›é¡¹ç›®ä¹‹åï¼Œæˆ‘æœ‰æœºä¼šåœ¨Angular 2ä¸‹å¼€å‘äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚å¦ç‡åœ°è¯´ï¼Œæˆ‘æ²¡æœ‰ç•™ä¸‹æ·±åˆ»çš„å°è±¡ã€‚ ä½†æ˜¯è®°ä½äº†ä¸€ä»¶äº‹-ä½¿ç”¨ä¾èµ–æ³¨å…¥ç®¡ç†åº”ç”¨ç¨‹åºçš„é€»è¾‘å’ŒçŠ¶æ€ã€‚ æˆ‘æƒ³çŸ¥é“ä½¿ç”¨DDDï¼Œåˆ†å±‚æ¶æ„å’Œä¾èµ–æ³¨å…¥åœ¨Reactä¸­ç®¡ç†çŠ¶æ€æ˜¯å¦æ–¹ä¾¿ï¼Ÿ 


 å¦‚æœæ‚¨å¯¹å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œæ„Ÿå…´è¶£ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œä¸º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reactå’ŒMobXçŠ¶æ€æ ‘ä¸­çš„åˆ†å±‚ä¾èµ–æ³¨å…¥ä½œä¸ºåŸŸæ¨¡å‹</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431942/"><p><img src="https://habrastorage.org/webt/78/ou/57/78ou57kbv7kdv7llnfl-_cwmxpw.png" align="left"> åœ¨Reactä¸Šè¿›è¡Œäº†ä¸€äº›é¡¹ç›®ä¹‹åï¼Œæˆ‘æœ‰æœºä¼šåœ¨Angular 2ä¸‹å¼€å‘äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚å¦ç‡åœ°è¯´ï¼Œæˆ‘æ²¡æœ‰ç•™ä¸‹æ·±åˆ»çš„å°è±¡ã€‚ ä½†æ˜¯è®°ä½äº†ä¸€ä»¶äº‹-ä½¿ç”¨ä¾èµ–æ³¨å…¥ç®¡ç†åº”ç”¨ç¨‹åºçš„é€»è¾‘å’ŒçŠ¶æ€ã€‚ æˆ‘æƒ³çŸ¥é“ä½¿ç”¨DDDï¼Œåˆ†å±‚æ¶æ„å’Œä¾èµ–æ³¨å…¥åœ¨Reactä¸­ç®¡ç†çŠ¶æ€æ˜¯å¦æ–¹ä¾¿ï¼Ÿ </p><br><p> å¦‚æœæ‚¨å¯¹å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œæ„Ÿå…´è¶£ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œä¸ºä»€ä¹ˆ-æ¬¢è¿åŠ å…¥å‰ªåˆ‡ï¼ </p><a name="habracut"></a><br><p>è€å®è¯´ï¼Œå³ä½¿åœ¨åç«¯ï¼ŒDIä¹Ÿå¾ˆå°‘è¢«å……åˆ†åˆ©ç”¨ã€‚ é™¤éåœ¨çœŸæ­£çš„å¤§å‹åº”ç”¨ä¸­ä½¿ç”¨ã€‚ åœ¨ä¸­å°ä¼ä¸šä¸­ï¼Œå³ä½¿ä½¿ç”¨DIï¼Œæ¯ä¸ªæ¥å£é€šå¸¸ä¹Ÿåªæœ‰ä¸€ä¸ªå®ç°ã€‚ ä½†æ˜¯ä¾èµ–æ³¨å…¥ä»ç„¶æœ‰å…¶ä¼˜ç‚¹ï¼š </p><br><ul><li> ä»£ç ç»“æ„æ›´å¥½ï¼Œæ¥å£å……å½“æ˜¾å¼å¥‘çº¦ã€‚ </li><li> ç®€åŒ–äº†å•å…ƒæµ‹è¯•ä¸­å­˜æ ¹çš„åˆ›å»ºã€‚ </li></ul><br><p> ä½†æ˜¯ï¼Œç°ä»£çš„JSæµ‹è¯•åº“ï¼ˆä¾‹å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Jest</a> ï¼‰å…è®¸æ‚¨ä»…åŸºäºæ¨¡å—åŒ–ES6ç³»ç»Ÿç¼–å†™mokiã€‚ å› æ­¤ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸ä¼šä»DIä¸­è·å¾—å¤ªå¤šåˆ©æ¶¦ã€‚ </p><br><p> ç¬¬äºŒç‚¹ä»ç„¶æ˜¯-å¯¹è±¡èŒƒå›´å’Œç”Ÿå­˜æœŸçš„ç®¡ç†ã€‚ åœ¨æœåŠ¡å™¨ä¸Šï¼Œç”Ÿå­˜æœŸé€šå¸¸ç»‘å®šåˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºï¼ˆSingletonï¼‰æˆ–è¯·æ±‚ã€‚ åœ¨å®¢æˆ·ç«¯ä¸Šï¼Œä»£ç çš„ä¸»è¦å•å…ƒæ˜¯ç»„ä»¶ã€‚ æˆ‘ä»¬å°†ä¾é™„äºæ­¤ã€‚ </p><br><p>å¦‚æœéœ€è¦åœ¨åº”ç”¨ç¨‹åºçº§åˆ«ä½¿ç”¨çŠ¶æ€ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨ES6æ¨¡å—çº§åˆ«è®¾ç½®å˜é‡ï¼Œå¹¶åœ¨å¿…è¦æ—¶å°†å…¶å¯¼å…¥ã€‚ å¦‚æœä»…åœ¨ç»„ä»¶å†…éƒ¨éœ€è¦çŠ¶æ€ï¼Œ <strong><code>this.state</code></strong>å…¶æ”¾åœ¨<strong><code>this.state</code></strong> ã€‚ å¯¹äºå…¶ä»–æ‰€æœ‰å†…å®¹ï¼Œéƒ½æœ‰<strong><code>Context</code></strong> ã€‚ ä½†æ˜¯<strong><code>Context</code></strong>å¤ªåº•å±‚äº†ï¼š </p><br><ul><li> æˆ‘ä»¬ä¸èƒ½åœ¨Reactç»„ä»¶æ ‘ä¹‹å¤–ä½¿ç”¨ä¸Šä¸‹æ–‡ã€‚ ä¾‹å¦‚ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘å±‚ä¸­ã€‚ </li><li> æˆ‘ä»¬ä¸èƒ½åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code><strong>Class.contextType</strong></code></a>ä½¿ç”¨å¤šä¸ªä¸Šä¸‹æ–‡ã€‚ ä¸ºäº†ç¡®å®šå¯¹å‡ ç§ä¸åŒæœåŠ¡çš„ä¾èµ–æ€§ï¼Œæˆ‘ä»¬å°†å¿…é¡»ä»¥æ–°çš„æ–¹å¼æ„å»ºâ€œææ€–é‡‘å­—å¡”â€ï¼š </li></ul><br><img src="https://habrastorage.org/webt/as/4r/2n/as4r2ncj0zh_2dmpoxbuahkio74.png"><br><br><p> æ–°çš„Hook <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code><strong>useContext()</strong></code></a>ç¨å¾®çº æ­£äº†åŠŸèƒ½ç»„ä»¶çš„æƒ…å†µã€‚ ä½†æ˜¯æˆ‘ä»¬ä¸ä¼šæ‘†è„±è®¸å¤š<strong><code>&lt;Context.Provider&gt;</code></strong> ã€‚ ç›´åˆ°æˆ‘ä»¬å°†ä¸Šä¸‹æ–‡è½¬æ¢ä¸ºæœåŠ¡å®šä½å™¨ï¼Œå¹¶å°†å…¶çˆ¶ç»„ä»¶è½¬æ¢ä¸ºåˆæˆæ ¹ã€‚ ä½†æ˜¯è¿™é‡Œç¦»DIä¸è¿œï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å§ï¼ </p><br><blockquote> æ‚¨å¯ä»¥è·³è¿‡è¿™ä¸€éƒ¨åˆ†ï¼Œç›´æ¥è½¬åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½“ç³»ç»“æ„</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æè¿°ã€‚</a> </blockquote><br><h2 id="realizaciya-mehanizma-di">  DIæœºåˆ¶çš„å®ç° </h2><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªReact Contextï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> InjectorContext= React.createContext(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br><p> ç”±äºReactä½¿ç”¨ç»„ä»¶æ„é€ å‡½æ•°æ¥æ»¡è¶³å…¶éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨å±æ€§æ³¨å…¥ã€‚ ä¸ºæ­¤ï¼Œå®šä¹‰<strong><code>@inject</code></strong>è£…é¥°å™¨ï¼Œè¯¥è£…é¥°å™¨ï¼š </p><br><ul><li> è®¾ç½®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code><strong>Class.contextType</strong></code></a>å±æ€§ï¼Œ </li><li> è·å–ä¾èµ–ç±»å‹ </li><li> æŸ¥æ‰¾ä¸€ä¸ª<strong><code>Injector</code></strong>å¯¹è±¡å¹¶è§£å†³ä¾èµ–å…³ç³»ã€‚ </li></ul><br><div class="spoiler">  <b class="spoiler_title">inject.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"reflect-metadata"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target, key</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  static cotextType target.constructor.contextType = InjectorContext; //    const type = Reflect.getMetadata("design:type", target, key); //  property Object.defineProperty(target, key, { configurable: true, enumerable: true, get() { //  Injector       const instance = getInstance(getInjector(this), type); Object.defineProperty(this, key, { enumerable: true, writable: true, value: instance }); return instance; }, // settet     Dependency Injection set(instance) { Object.defineProperty(this, key, { enumerable: true, writable: true, value: instance }); } }); }</span></span></code> </pre> </div></div><br><p> ç°åœ¨æˆ‘ä»¬å¯ä»¥å®šä¹‰ä»»æ„ç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { inject } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooService</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BarService</span></span></span><span class="hljs-class"> </span></span>{ @inject foo: FooService; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ @inject foo: FooService; @inject bar: BarService; }</code> </pre> <br><p> å¯¹äºé‚£äº›ä¸æ¥å—è£…é¥°å™¨çš„äººï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ç­¾åå®šä¹‰<strong><code>inject()</code></strong>å‡½æ•°ï¼š </p><br><pre> <code class="javascript hljs">type Constructor&lt;T&gt; = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (...args: any[]) =&gt; T; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">&gt;(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target: Object, type: Constructor&lt;T&gt; | Function</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">inject.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target, keyOrType</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isFunction(keyOrType)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getInstance(getInjector(target), keyOrType); } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> </div></div><br><p> è¿™å°†å…è®¸æ‚¨æ˜¾å¼å®šä¹‰ä¾èµ–é¡¹ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooService</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BarService</span></span></span><span class="hljs-class"> </span></span>{ foo = inject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, FooService); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ foo = inject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, FooService); bar = inject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, BarService); <span class="hljs-comment"><span class="hljs-comment">//   static contextType = InjectorContext; }</span></span></code> </pre> <br><p> åŠŸèƒ½ç»„ä»¶å‘¢ï¼Ÿ å¯¹äºä»–ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°Hook <strong><code>useInstance()</code></strong> </p><br><div class="spoiler">  <b class="spoiler_title">hooks.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useRef, useContext } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">useInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ref = useRef(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> injector = useContext(InjectorContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ref.current || (ref.current = getInstance(injector, type)); }</code> </pre> </div></div><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useInstance } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MyComponent = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> foo = useInstance(FooService); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bar = useInstance(BarService); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">; }</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å°†ç¡®å®š<strong><code>Injector</code></strong>å¤–è§‚ï¼Œå¦‚ä½•æ‰¾åˆ°å®ƒä»¥åŠå¦‚ä½•è§£å†³ä¾èµ–å…³ç³»ã€‚ æ³¨å…¥ç¨‹åºå¿…é¡»åŒ…å«å¯¹çˆ¶é¡¹çš„å¼•ç”¨ï¼Œç”¨äºå·²è§£å†³ä¾èµ–å…³ç³»çš„å¯¹è±¡ç¼“å­˜ä»¥åŠç”¨äºæœªè§£å†³ä¾èµ–å…³ç³»çš„è§„åˆ™å­—å…¸ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å–·å°„å™¨</b> <div class="spoiler_text"><pre> <code class="javascript hljs">type Binding = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">injector: Injector</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> abstract <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Injector</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    Injector _parent?: Injector; //    _bindingMap: Map&lt;Function, Binding&gt;; //      _instanceMap: Map&lt;Function, Object&gt;; }</span></span></code> </pre> </div></div><br><p> å¯¹äºReactç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡<strong><code>this.context</code></strong>å­—æ®µä½¿ç”¨<strong><code>Injector</code></strong> ï¼Œå¯¹äºä¾èµ–é¡¹ç±»ï¼Œæˆ‘ä»¬å¯ä»¥å°†<strong><code>Injector</code></strong>ä¸´æ—¶æ”¾åœ¨å…¨å±€å˜é‡ä¸­ã€‚ ä¸ºäº†åŠ å¿«æ¯ä¸ªç±»åˆ«çš„æ³¨å°„å™¨çš„æœç´¢é€Ÿåº¦ï¼Œæˆ‘ä»¬å°†åœ¨éšè—å­—æ®µä¸­ç¼“å­˜æŒ‡å‘<strong><code>Injector</code></strong>çš„é“¾æ¥ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å–·å°„å™¨</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INJECTOR = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span> === <span class="hljs-string"><span class="hljs-string">"function"</span></span> ? <span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span>() : <span class="hljs-string"><span class="hljs-string">"__injector__"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> currentInjector = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInjector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> injector = target[INJECTOR]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (injector) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> injector; } injector = currentInjector || target.context; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (injector <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Injector) { target[INJECTOR] = injector; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> injector; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> </div></div><br><p> ä¸ºäº†æ‰¾åˆ°ç‰¹å®šçš„ç»‘å®šè§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<strong><code>getInstance()</code></strong>å‡½æ•°æ¥ä½¿æ³¨å…¥å™¨æ ‘ä¸Šå‡ </p><br><div class="spoiler">  <b class="spoiler_title">å–·å°„å™¨</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">injector, type</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (injector) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> instance = injector._instanceMap.get(type); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (instance !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> binding = injector._bindingMap.get(type); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (binding) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> prevInjector = currentInjector; currentInjector = injector; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { instance = binding(injector); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { currentInjector = prevInjector; } injector._instanceMap.set(type, instance); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } injector = injector._parent; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; }</code> </pre> </div></div><br><p> æœ€åï¼Œè®©æˆ‘ä»¬ç»§ç»­æ³¨å†Œä¾èµ–é¡¹ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦HOC <strong><code>provider()</code></strong> ï¼Œå®ƒå°†å¯¹å®ƒä»¬çš„å®ç°è¿›è¡Œä¸€ç³»åˆ—ä¾èµ–é¡¹ç»‘å®šï¼Œå¹¶é€šè¿‡<strong><code>InjectorContext.Provider</code></strong>æ³¨å†Œä¸€ä¸ªæ–°çš„<strong><code>Injector</code></strong> ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">provider.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> provider = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...definitions</span></span></span><span class="hljs-function">) =&gt;</span></span> Wrapped =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bindingMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>(); addBindings(bindingMap, definitions); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Provider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Injector</span></span></span><span class="hljs-class"> </span></span>{ _parent = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.context; _bindingMap = bindingMap; _instanceMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>(); render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( &lt;InjectorContext.Provider value={this}&gt; &lt;Wrapped {...this.props} /&gt; &lt;/InjectorContext.Provider&gt; ); } static contextType = InjectorContext; static register(...definitions) { addBindings(bindingMap, definitions); } }; };</code> </pre> </div></div><br><p> å¦å¤–ï¼Œè¿˜æœ‰ä¸€ç»„ç»‘å®šå‡½æ•°ï¼Œå®ƒä»¬å®ç°ç”¨äºåˆ›å»ºä¾èµ–é¡¹å®ä¾‹çš„å„ç§ç­–ç•¥ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">bindings.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> toClass = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">constructor</span></span></span><span class="hljs-function"> =&gt;</span></span> asBinding(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">injector</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(); if (!instance[INJECTOR]) { instance[INJECTOR] = injector; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> toFactory = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">depsOrFactory, factory</span></span></span><span class="hljs-function">) =&gt;</span></span> asBinding( factory ? <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">injector</span></span></span><span class="hljs-function"> =&gt;</span></span> factory(...depsOrFactory.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> getInstance(injector, type))) : depsOrFactory ); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> toExisting = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> asBinding(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">injector</span></span></span><span class="hljs-function"> =&gt;</span></span> getInstance(injector, type)); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> toValue = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> =&gt;</span></span> asBinding(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> value); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IS_BINDING = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span> === <span class="hljs-string"><span class="hljs-string">"function"</span></span> ? <span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span>() : <span class="hljs-string"><span class="hljs-string">"__binding__"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asBinding</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">binding</span></span></span><span class="hljs-function">) </span></span>{ binding[IS_BINDING] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> binding; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addBindings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bindingMap, definitions</span></span></span><span class="hljs-function">) </span></span>{ definitions.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">definition</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> token, binding; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.isArray(definition)) { [token, binding = token] = definition; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { token = binding = definition; } bindingMap.set(token, binding[IS_BINDING] ? binding : toClass(binding)); }); }</code> </pre> </div></div><br><p> ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»¥æˆå¯¹<strong><code>[&lt;&gt;, &lt;&gt;]</code></strong>å¯¹çš„å½¢å¼åœ¨ä»»æ„ç»„ä»¶çº§åˆ«æ³¨å†Œä¾èµ–é¡¹ç»‘å®šã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { provider, toClass, toValue, toFactory, toExisting } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; @provider( <span class="hljs-comment"><span class="hljs-comment">//    [FirstService, toClass(FirstServiceImpl)], //     [SecondService, toValue(new SecondServiceImpl())], //    [ThirdService, toFactory( [FirstService, SecondService], (first, second) =&gt; ThirdServiceFactory.create(first, second) )], //      [FourthService, toExisting(FirstService)] ) class MyComponent extends React.Component { // ... }</span></span></code> </pre> <br><p> æˆ–ç±»çš„ç¼©å†™å½¢å¼ï¼š </p><br><pre> <code class="javascript hljs">@provider( <span class="hljs-comment"><span class="hljs-comment">// [FirstService, toClass(FirstService)] FirstService, // [SecondService, toClass(SecondServiceImpl)] [SecondService, SecondServiceImpl] ) class MyComponent extends React.Component { // ... }</span></span></code> </pre> <br><p> ç”±äºæœåŠ¡çš„ç”Ÿå­˜æœŸç”±æ³¨å†Œè¯¥æœåŠ¡çš„æä¾›ç¨‹åºç»„ä»¶å†³å®šï¼Œå› æ­¤ï¼Œå¯¹äºæ¯ä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å®šä¹‰<strong><code>.dispose()</code></strong>æ¸…æ´æ–¹æ³•ã€‚ åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å–æ¶ˆè®¢é˜…æŸäº›äº‹ä»¶ï¼Œå…³é—­å¥—æ¥å­—ç­‰ã€‚ å½“æ‚¨ä»DOMä¸­åˆ é™¤æä¾›ç¨‹åºæ—¶ï¼Œå®ƒå°†åœ¨å…¶åˆ›å»ºçš„æ‰€æœ‰æœåŠ¡ä¸Šè°ƒç”¨<strong><code>.dispose()</code></strong> ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">provider.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> provider = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...definitions</span></span></span><span class="hljs-function">) =&gt;</span></span> Wrapped =&gt; { <span class="hljs-comment"><span class="hljs-comment">// ... return class Provider extends Injector { // ... componentWillUnmount() { this._instanceMap.forEach(instance =&gt; { if (isObject(instance) &amp;&amp; isFunction(instance.dispose)) { instance.dispose(); } }); } // ... }; };</span></span></code> </pre> </div></div><br><p> ä¸ºäº†åˆ†ç¦»ä»£ç å’Œå»¶è¿ŸåŠ è½½ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åè½¬å‘æä¾›è€…æ³¨å†ŒæœåŠ¡çš„æ–¹æ³•ã€‚ è£…é¥°å™¨<strong><code>@registerIn()</code></strong>å°†å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">provider.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> registrationQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> registerIn = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getProvider, binding</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span> =&gt; { registrationQueue.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { getProvider().register(binding ? [<span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>, binding] : <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>); }); return <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>; };</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">å–·å°„å™¨</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">injector, type</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (registrationQueue.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { registrationQueue.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">registration</span></span></span><span class="hljs-function"> =&gt;</span></span> { registration(); }); registrationQueue.length = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (injector) { <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> </div></div><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { registerIn } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HomePage } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"../components/HomePage"</span></span>; @registerIn(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> HomePage) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyLazyLoadedService</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><img src="https://habrastorage.org/webt/gu/w5/d-/guw5d-sj0h53wnapsftgqeqnvvg.png"><br><p> å› æ­¤ï¼Œå¯¹äº150è¡Œå’Œ1 KBçš„ä»£ç ï¼Œæ‚¨å¯ä»¥å®ç°å‡ ä¹å®Œæ•´çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆ†å±‚DIå®¹å™¨</a> ã€‚ </p><br><h2 id="arhitektura-prilozheniya"> åº”ç”¨æ¶æ„ </h2><br><p> æœ€åï¼Œè®©æˆ‘ä»¬ç»§ç»­è®¨è®ºä¸»è¦å†…å®¹-å¦‚ä½•ç»„ç»‡åº”ç”¨ç¨‹åºä½“ç³»ç»“æ„ã€‚ æ ¹æ®åº”ç”¨ç¨‹åºçš„å¤§å°ï¼Œä¸»é¢˜åŒºåŸŸçš„å¤æ‚æ€§å’Œæˆ‘ä»¬çš„æ‡’æƒ°ï¼Œè¿™é‡Œå¯ä»¥æä¾›ä¸‰ä¸ªé€‰é¡¹ã€‚ </p><br><h3 id="1-the-ugly">  1.ä¸‘é™‹ </h3><br><p> æˆ‘ä»¬æœ‰ä¸€ä¸ªè™šæ‹ŸDOMï¼Œè¿™æ„å‘³ç€å®ƒåº”è¯¥å¾ˆå¿«ã€‚ è‡³å°‘ç”¨è¿™ç§è°ƒå‘³æ–™ï¼ŒReactåœ¨èŒä¸šç”Ÿæ¶¯çš„é»æ˜å°±è¢«é€è¾¾äº†ã€‚ å› æ­¤ï¼Œåªéœ€è®°ä½åˆ°æ ¹ç»„ä»¶çš„é“¾æ¥å³å¯ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨<strong><code>@observer</code></strong>è£…é¥°å™¨ï¼‰ã€‚ åœ¨å½±å“å…±äº«æœåŠ¡çš„æ¯ä¸ªæ“ä½œä¹‹åï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸Šè°ƒç”¨<strong><code>.forceUpdate()</code></strong> ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨<strong><code>@action</code></strong>è£…é¥°å™¨ï¼‰ </p><br><div class="spoiler">  <b class="spoiler_title">Observer.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">observer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Wrapped</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Observer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ componentDidMount() { observerRef = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } componentWillUnmount() { observerRef = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Wrapped</span></span></span></span><span class="xml"><span class="hljs-tag"> {</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...this.props</span></span></span></span><span class="xml"><span class="hljs-tag">} /&gt;</span></span></span><span class="xml">; } } } let observerRef = null;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">action.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">action</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_target, _key, descriptor</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> method = descriptor.value; descriptor.value = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result; runningCount++; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { result = method.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { runningCount--; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (runningCount === <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; observerRef) { observerRef.forceUpdate(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> runningCount = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> </div></div><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserService</span></span></span><span class="hljs-class"> </span></span>{ @action doSomething() {} } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ @inject userService: UserService; } @provider(UserService) @observer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><p> å®ƒç”šè‡³å¯ä»¥å·¥ä½œã€‚ ä½†æ˜¯...ä½ è‡ªå·±æ˜ç™½:-) </p><br><h3 id="2-the-bad">  2.å </h3><br><p> æˆ‘ä»¬ä¸æ»¡æ„æ¯æ¬¡æ‰“å–·åšæ—¶éƒ½è¦æ¸²æŸ“æ‰€æœ‰å†…å®¹ã€‚ ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æƒ³ç”¨ <del> å·®ä¸å¤š </del> ç”¨äºå­˜å‚¨çŠ¶æ€çš„å¸¸è§„å¯¹è±¡å’Œæ•°ç»„ã€‚ è®©æˆ‘ä»¬ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MobXä¸ºä¾‹</a> ï¼ </p><br><p> æˆ‘ä»¬ä»¥æ ‡å‡†åŠ¨ä½œå¼€å§‹å‡ ä¸ªæ•°æ®å­˜å‚¨ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observable, action } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserStore</span></span></span><span class="hljs-class"> </span></span>{ byId = observable.map&lt;number, User&gt;(); @action add(user: User) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.byId.set(user.id, user); } <span class="hljs-comment"><span class="hljs-comment">// ... } export class PostStore { // ... }</span></span></code> </pre> <br><p> æˆ‘ä»¬å°†ä¸šåŠ¡é€»è¾‘ï¼ŒI / Oç­‰å¸¦åˆ°æœåŠ¡å±‚ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { action } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { inject } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AccountService</span></span></span><span class="hljs-class"> </span></span>{ @inject userStore userStore; @action updateUserInfo(userInfo: Partial&lt;User&gt;) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userStore.byId.get(userInfo.id); <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign(user, userInfo); } }</code> </pre> <br><p> æˆ‘ä»¬å°†å®ƒä»¬åˆ†å‘åˆ°ç»„ä»¶ä¸­ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx-react"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { provider, inject } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; @provider(UserStore, PostStore) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{} @provider(AccountService) @observer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AccountPage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span></span>{} @observer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserForm</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ @inject accountService: AccountService; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">æ²¡æœ‰è£…é¥°å™¨çš„åŠŸèƒ½ç»„ä»¶ä¹Ÿæ˜¯å¦‚æ­¤</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { action } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { inject } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AccountService</span></span></span><span class="hljs-class"> </span></span>{ userStore = inject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, UserStore); updateUserInfo = action(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">userInfo: Partial&lt;User&gt;</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userStore.byId.get(userInfo.id); <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign(user, userInfo); }); }</code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx-react-lite"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { provider, useInstance } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = provider(UserStore, PostStore)(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... }); const AccountPage = provider(AccountService)(observer(props =&gt; { // ... })); const UserFrom = observer(props =&gt; { const accountService = useInstance(AccountService); // ... });</span></span></code> </pre> </div></div><br><p> ç»“æœå°±æ˜¯ç»å…¸çš„ä¸‰å±‚ä½“ç³»ç»“æ„ã€‚ </p><br><h3 id="3-the-good">  3.å–„è‰¯ </h3><br><p> æœ‰æ—¶ï¼Œä¸»é¢˜åŒºåŸŸå˜å¾—å¦‚æ­¤å¤æ‚ï¼Œä»¥è‡³äºä½¿ç”¨ç®€å•çš„å¯¹è±¡ï¼ˆæˆ–DDDä¸­çš„è´«è¡€æ¨¡å‹ï¼‰æ¥ä½¿ç”¨å®ƒå·²ç»ä¸æ–¹ä¾¿äº†ã€‚ å½“æ•°æ®å…·æœ‰å…·æœ‰è®¸å¤šå…³ç³»çš„å…³ç³»ç»“æ„æ—¶ï¼Œè¿™ä¸€ç‚¹å°¤å…¶æ˜æ˜¾ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MobXçŠ¶æ€æ ‘</a>åº“<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å°†ä¸º</a>æˆ‘ä»¬æä¾›å¸®åŠ©ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†åŸŸé©±åŠ¨è®¾è®¡çš„åŸç†åº”ç”¨äºå‰ç«¯åº”ç”¨ç¨‹åºçš„ä½“ç³»ç»“æ„ä¸­ã€‚ </p><br><p> è®¾è®¡æ¨¡å‹å§‹äºå¯¹ç±»å‹çš„æè¿°ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// models/Post.ts import { types as t, Instance } from "mobx-state-tree"; export const Post = t .model("Post", { id: t.identifier, title: t.string, body: t.string, date: t.Date, rating: t.number, author: t.reference(User), comments: t.array(t.reference(Comment)) }) .actions(self =&gt; ({ voteUp() { self.rating++; }, voteDown() { self.rating--; }, addComment(comment: Comment) { self.comments.push(comment); } })); export type Post = Instance&lt;typeof Post&gt;;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">å‹å·/User.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { types <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t, Instance } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx-state-tree"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> User = t.model(<span class="hljs-string"><span class="hljs-string">"User"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: t.identifier, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: t.string }); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> type User = Instance&lt;<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> User&gt;;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">å‹å·/Comment.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { types <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t, Instance } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx-state-tree"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { User } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"./User"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Comment = t .model(<span class="hljs-string"><span class="hljs-string">"Comment"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: t.identifier, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: t.string, <span class="hljs-attr"><span class="hljs-attr">date</span></span>: t.Date, <span class="hljs-attr"><span class="hljs-attr">rating</span></span>: t.number, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: t.reference(User) }) .actions(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">self</span></span></span><span class="hljs-function"> =&gt;</span></span> ({ voteUp() { self.rating++; }, voteDown() { self.rating--; } })); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> type Comment = Instance&lt;<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> Comment&gt;;</code> </pre> </div></div><br><p> ä»¥åŠæ•°æ®å­˜å‚¨çš„ç±»å‹ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// models/index.ts import { types as t } from "mobx-state-tree"; export { User, Post, Comment }; export default t.model({ users: t.map(User), posts: t.map(Post), comments: t.map(Comment) });</span></span></code> </pre> <br><p> å®ä½“ç±»å‹åŒ…å«åŸŸæ¨¡å‹çš„çŠ¶æ€åŠå…¶åŸºæœ¬æ“ä½œã€‚ åœ¨æœåŠ¡å±‚ä¸­å®ç°äº†æ›´å¤æ‚çš„æ–¹æ¡ˆï¼ŒåŒ…æ‹¬I / Oã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">æœåŠ¡/ DataContext.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Instance, unprotect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx-state-tree"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Models <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"../models"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> create() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> models = Models.create(); unprotect(models); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> models; } } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface DataContext extends Instance&lt;<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> Models&gt; {}</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">æœåŠ¡/ AuthService.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { User } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"../models"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthService</span></span></span><span class="hljs-class"> </span></span>{ @observable currentUser: User; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">æœåŠ¡/ PostService.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { inject } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { action } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Post } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"../models"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostService</span></span></span><span class="hljs-class"> </span></span>{ @inject dataContext: DataContext; @inject authService: AuthService; <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> publishPost(postInfo: Partial&lt;Post&gt;) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(<span class="hljs-string"><span class="hljs-string">"/posts"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(postInfo) }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { id } = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.savePost(id, postInfo); } @action savePost(id: string, <span class="hljs-attr"><span class="hljs-attr">postInfo</span></span>: Partial&lt;Post&gt;) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> post = Post.create({ id, <span class="hljs-attr"><span class="hljs-attr">rating</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">date</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(), <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.authService.currentUser.id, <span class="hljs-attr"><span class="hljs-attr">comments</span></span>: [], ...postInfo }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataContext.posts.put(post); } }</code> </pre> </div></div><br><p>  MobXçŠ¶æ€æ ‘çš„ä¸»è¦åŠŸèƒ½æ˜¯é«˜æ•ˆå¤„ç†æ•°æ®å¿«ç…§ã€‚ åœ¨ä»»ä½•æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code><strong>getSnapshot()</strong></code></a>å‡½æ•°è·å–ä»»ä½•å®ä½“ï¼Œé›†åˆç”šè‡³åº”ç”¨ç¨‹åºçš„æ•´ä¸ªçŠ¶æ€çš„åºåˆ—åŒ–çŠ¶æ€ã€‚ åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code><strong>applySnapshot()</strong></code></a>å°†å¿«ç…§åº”ç”¨äºæ¨¡å‹çš„ä»»ä½•éƒ¨åˆ†ã€‚ è¿™ä½¿æˆ‘ä»¬å¯ä»¥ç”¨å‡ è¡Œä»£ç åˆå§‹åŒ–æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œä»LocalStorageåŠ è½½ï¼Œç”šè‡³é€šè¿‡Redux DevToolsä¸ä¹‹äº¤äº’ã€‚ </p><br><p> ç”±äºæˆ‘ä»¬ä½¿ç”¨è§„èŒƒåŒ–çš„å…³ç³»æ¨¡å‹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">normalizr</a>åº“æ¥åŠ è½½æ•°æ®ã€‚ å®ƒå…è®¸æ‚¨æ ¹æ®æ•°æ®æ–¹æ¡ˆå°†æ ‘JSONè½¬æ¢ä¸ºæŒ‰<strong><code>id</code></strong>åˆ†ç»„çš„å¯¹è±¡çš„å¹³é¢è¡¨ã€‚ åªæ˜¯é‡‡ç”¨MobXçŠ¶æ€æ ‘ä½œä¸ºå¿«ç…§çš„æ ¼å¼ã€‚ </p><br><p> ä¸ºæ­¤ï¼Œè¯·å®šä¹‰ä»æœåŠ¡å™¨ä¸‹è½½çš„å¯¹è±¡æ–¹æ¡ˆï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { schema } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"normalizr"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UserSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> schema.Entity(<span class="hljs-string"><span class="hljs-string">"users"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CommentSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> schema.Entity(<span class="hljs-string"><span class="hljs-string">"comments"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">author</span></span>: UserSchema }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PostSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> schema.Entity(<span class="hljs-string"><span class="hljs-string">"posts"</span></span>, { <span class="hljs-comment"><span class="hljs-comment">//   - //      author: UserSchema, comments: [CommentSchema] }); export { UserSchema, PostSchema, CommentSchema };</span></span></code> </pre> <br><p> å¹¶å°†æ•°æ®åŠ è½½åˆ°å­˜å‚¨ä¸­ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { inject } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { normalize } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"normalizr"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { applySnapshot } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx-state-tree"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostService</span></span></span><span class="hljs-class"> </span></span>{ @inject dataContext: DataContext; <span class="hljs-comment"><span class="hljs-comment">// ... async loadPosts() { const response = await fetch("/posts.json"); const posts = await response.json(); const { entities } = normalize(posts, [PostSchema]); applySnapshot(this.dataContext, entities); } // ... }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">posts.json</b> <div class="spoiler_text"><pre> <code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"    React"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>: <span class="hljs-string"><span class="hljs-string">"  -     React..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-12-10T18:18:58.512Z"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rating"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"John Doe"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"comments"</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1234</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Hmmm..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-12-10T18:18:58.512Z"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rating"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"John Doe"</span></span> } }] }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">234</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Lorem ipsum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>: <span class="hljs-string"><span class="hljs-string">"Lorem ipsum dolor sit amet..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-12-10T18:18:58.512Z"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rating"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Marcus Tullius Cicero"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"comments"</span></span>: [] } ]</code> </pre> </div></div><br><p> æœ€åï¼Œåœ¨ç›¸åº”çš„ç»„ä»¶ä¸­æ³¨å†ŒæœåŠ¡ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"mobx-react"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { provider, inject } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react-ioc"</span></span>; @provider(AuthService, PostService, [ DataContext, toFactory(DataContext.create) ]) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ @inject postService: PostService; componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.postService.loadPosts(); } }</code> </pre> <br><p> äº‹å®è¯æ˜ï¼Œæ‰€æœ‰ç›¸åŒçš„ä¸‰å±‚ä½“ç³»ç»“æ„éƒ½å…·æœ‰ç»´æŠ¤æ•°æ®ç±»å‹çš„çŠ¶æ€å’Œè¿è¡Œæ—¶éªŒè¯çš„èƒ½åŠ›ï¼ˆåœ¨DEVæ¨¡å¼ä¸‹ï¼‰ã€‚ åè€…ä½¿æ‚¨å¯ä»¥ç¡®ä¿å¦‚æœæ²¡æœ‰å¼‚å¸¸å‘ç”Ÿï¼Œé‚£ä¹ˆæ•°æ®ä»“åº“çš„çŠ¶æ€ä¸è§„èŒƒç›¸å¯¹åº”ã€‚ </p><br><img src="https://habrastorage.org/webt/po/3u/vi/po3uvia2jujcg9q7w1ptr8kvwzk.png"><br><p><br></p><br><hr><br><p> å¯¹äºé‚£äº›æ„Ÿå…´è¶£çš„äººï¼Œè¯·æŒ‡å‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github</a>çš„é“¾æ¥å’Œä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">demo</a> ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN431942/">https://habr.com/ru/post/zh-CN431942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN431932/index.html">å­—èŠ‚å ¡å ¡ï¼ˆåŠæ›´å¤šï¼‰ç¾å›½åŸä½æ°‘</a></li>
<li><a href="../zh-CN431934/index.html">äººå·¥æ™ºèƒ½å¦‚ä½•å¸®åŠ©å¤„ç†æ³•å¾‹æ–‡ä»¶ï¼Ÿ æ¥è‡ªABBYYçš„Egor Budnikovçš„æ¼”è®²</a></li>
<li><a href="../zh-CN431936/index.html">TechnoTextç«èµ›çš„ç»“æœ</a></li>
<li><a href="../zh-CN431938/index.html">Verilogä¸­çš„æ•´æ•°ç«‹æ–¹æ ¹</a></li>
<li><a href="../zh-CN431940/index.html">å¦‚æœäººä»¬ä¸è§‰å¾—è‡ªå·±çš„ä»·å€¼ï¼Œå°±ä¼šç­‹ç–²åŠ›å°½ã€‚ æ€ä¹ˆåŠå‘¢ï¼Ÿ</a></li>
<li><a href="../zh-CN431944/index.html">Yealink Meeting Server 2.0-æ–°çš„è§†é¢‘ä¼šè®®åŠŸèƒ½</a></li>
<li><a href="../zh-CN431946/index.html">å®‰å…¨å‘¨49ï¼šå…¥ä¾µæˆ´å°”å’Œä¸‡è±ªé…’åº—</a></li>
<li><a href="../zh-CN431948/index.html">Deep Mindæ•™æˆå…¶AIå¯é¢„æµ‹è›‹ç™½è´¨ç»“æ„</a></li>
<li><a href="../zh-CN431950/index.html">å¦‚ä½•ä½¿ç”¨æœºå™¨å­¦ä¹ é¢„æµ‹éœ€æ±‚å¹¶è‡ªåŠ¨è¿›è¡Œè´­ä¹°ï¼šOzonæ¡ˆä¾‹</a></li>
<li><a href="../zh-CN431954/index.html">Sunå’ŒDECçš„å‰å‰¯æ€»è£æˆä¸ºMIPS / Waveçš„æ€»è£ï¼Œè°ˆè®ºä¿„ç½—æ–¯å’ŒRISC / V</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>