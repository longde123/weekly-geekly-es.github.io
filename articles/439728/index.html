<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüíº üÜï üë©üèæ‚Äçüöí Configure la copia de seguridad y recuperaci√≥n completas y separadas de Zimbra OSE sin usar Zextras üï∫üèæ üë®‚Äçüë®‚Äçüëß ‚úçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Por d√≥nde empezar 
 ¬øD√≥nde comienza la copia de seguridad? Planificaci√≥n Al hacer una copia de seguridad de cualquier sistema, debe hacer un plan d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configure la copia de seguridad y recuperaci√≥n completas y separadas de Zimbra OSE sin usar Zextras</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439728/"><img src="https://habrastorage.org/webt/tl/fg/oj/tlfgoj8_4wwdpcdcj5n8ndx2pu0.png" alt="imagen"><br><br><h3>  1. Por d√≥nde empezar </h3><br>  ¬øD√≥nde comienza la copia de seguridad?  Planificaci√≥n  Al hacer una copia de seguridad de cualquier sistema, debe hacer un plan de copia de seguridad: ¬øqu√© es exactamente, con qu√© frecuencia, durante cu√°nto tiempo se almacenar√°, habr√° suficiente espacio libre?  De las respuestas a estas preguntas, sigue la respuesta a la pregunta principal: ¬øc√≥mo hacer una copia de seguridad? <br><br>  Si hay mucho espacio libre, puede almacenar toda la m√°quina virtual.  Realice copias de seguridad con el mismo Veeam en un horario, y no piense en las dificultades.  Pero en cuanto a m√≠, es un desperdicio, estoy acostumbrado a hacer todo de la manera m√°s concisa y econ√≥mica posible.  Por supuesto, he implementado Veeam, pero solo hago copias de seguridad de esos sistemas que son imposibles o problem√°ticos de implementar desde copias de seguridad durante mucho tiempo. <br><br>  Acerca de los scripts de las herramientas de administraci√≥n del entorno virtual, simplemente guardar√© silencio de manera significativa. <br><br>  Zimbra tiene una herramienta zmmailbox.  Y, al examinar m√°s de cerca su funcionalidad, me di cuenta de que ser√≠a m√°s que suficiente para m√≠.  Puede hacer copias de seguridad y restaurar buzones incluso en un sistema en vivo.  Y me gust√≥ la capacidad de hacer una copia de seguridad de los buzones cr√≠ticos por separado de la copia de seguridad de todo el sistema.  Por lo tanto, el espacio ocupado por las copias de seguridad estar√° limitado por el tama√±o de los buzones archivados multiplicado por el n√∫mero de d√≠as de "profundidad de copia de seguridad", y no por el volumen de todo el sistema multiplicado por el mismo n√∫mero de d√≠as.  Adem√°s, es extremadamente dif√≠cil recuperarse de una copia de seguridad de todo el sistema, en el caso de Zimbra.  Es mucho m√°s f√°cil copiar una m√°quina virtual usando Veeam o herramientas de administraci√≥n del entorno virtual (Hyper-V, ESXI, ingrese lo que necesita) justo despu√©s de configurar el sistema, y ‚Äã‚Äãponerlo "en el estante" para que en un momento cr√≠tico pueda implementar r√°pidamente una m√°quina virtual casi sin peso y cargar en ella copias de seguridad de cajas.  En mi opini√≥n, este es el escenario menos costoso en todos los aspectos. <br><a name="habracut"></a><br><h3>  2. Los datos de origen: </h3><br>  <i>SO del servidor</i> : CentOS 7 <br><br><div class="spoiler">  <b class="spoiler_title">Sobre el sistema operativo</b> <div class="spoiler_text">  De hecho, la diferencia entre CentOS7 y cualquier otro sistema radicar√° √∫nicamente en los comandos al servidor para instalar paquetes y, posiblemente, en la ubicaci√≥n de algunos archivos.  El trabajo se lleva a cabo principalmente con cmdlets Zimbra, por lo que las diferencias de configuraci√≥n ser√°n m√≠nimas. </div></div><br>  <i>Dominio Zimbra</i> : zimbramail.home.local <br>  <i>Nombre de usuario y contrase√±a para acceder a la carpeta compartida</i> : ZimbraBackUp / 123123 <br>  <i>La ruta a la carpeta compartida</i> : \\ BackUpServer1 \ ZM \ <br>  <i>El camino para montar las bolas en el host Zimbra</i> : / mnt / ZM / <br><br><h3>  3. Configuraci√≥n </h3><br>  ¬°Entonces comencemos! <br><br>  Escribiremos copias de seguridad en un servidor que ejecute Windows en una carpeta compartida.  Si lo desea, puede combinar las copias de seguridad en cualquier lugar, pero todo est√° configurado para que la mayor√≠a de las copias de seguridad se escriban en BackUpServer1.home.local.  Entonces eso: <br><br>  1) Creamos en el dominio del usuario para acceder a la carpeta compartida en este servidor para que pueda montarse en el servidor Zimbramail.home.local.  Nombre de usuario ZimbraBackUp, contrase√±a, condicionalmente, 123123. <br><br>  2) En el servidor BackUpServer1, cree el directorio \ ZM \ en el repositorio y comp√°rtalo, otorgando derechos de cambio para el usuario ZimbraBackUp.  El camino hacia la pelota ser√°: \\ BackUpServer1 \ ZM \ <br><br>  3) Monte la pelota en el servidor Zimbramail.home.local.  Para que la carpeta se monte autom√°ticamente, debe corregir el archivo / etc / fstab agregando la l√≠nea: <br><br><pre><code class="bash hljs">//BackUpServer/ZM /mnt/ZM cifs user,uid=500,rw,suid,username=ZimbraBackUp,password=123123 0 0</code> </pre> <br>  Pero primero debe verificar si el montaje funciona: <br><br><pre> <code class="bash hljs">$ mount -t cifs //BackUpServer/ZM /mnt/ZM -o user=ZimbraBackUp,password=123123</code> </pre> <br>  A menudo aparece un error como este: <br><br><pre> <code class="bash hljs">mount: wrong fs <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, bad option, bad superblock on //BackUpServer1/ZM/, missing codepage or helper program, or other error (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> several filesystems (eg nfs, cifs) you might need a /sbin/mount.&lt;<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>&gt; helper program) In some cases useful info is found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> syslog - try dmesg | tail or so.</code> </pre> <br>  Puede solucionarlo instalando cifs-utils: <br><br><pre> <code class="bash hljs">$ yum install cifs-utils</code> </pre> <br>  Despu√©s de configurar, recomiendo reiniciar el servidor. <br><br>  4) Crear 3 archivos de script: FullBackUp.sh HandBackUp.sh Restore.sh <br><br>  El primer archivo se usar√° para crear autom√°ticamente copias de seguridad programadas, el segundo para la capacidad de hacer copias de seguridad de buzones individuales, o simplemente iniciar manualmente "qu√© pasar√≠a si".  Y el tercer gui√≥n es la restauraci√≥n de uno o todos los cuadros a la vez.  Intent√© lo m√°s posible comentar sobre el trabajo de los scripts y el registro prescrito. <br><br><div class="spoiler">  <b class="spoiler_title">El contenido del archivo FullBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #    MPath="/mnt/ZM/Mounthly" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   MDay=$(date +%d) #   log="/mnt/ZM/BackUpLog.txt" echo -en "BackUp ALL MailBoxes started in $(date +%T)\n" &gt;&gt; $log #       if [ ! -d $Path ]; then #     echo "    ..." mkdir -p $Path if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "    ,      ..." fi #       if [ ! -d $Path/$CDate ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo #        echo "       ..." mkdir -p $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp CDate dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp CDate dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "    ,     ..." fi #     /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes #    if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi #       for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then #        echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "File $MBoxes clear\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "File $MBoxes can NOT be cleared\n" &gt;&gt; $log fi #      #      if [ ! -d $ArchPath ]; then #    echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log #         if [ "$MDay" = 1 ]; then #      if [ ! -d $MPath ]; then #     echo "    ..." mkdir -p $MPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Long saving dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Long saving dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else #  echo "    ,     ..." fi cp $ArchPath/$CDate.tgz $MPath/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive is copied in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT copied in $(date +%T)\n" &gt;&gt; $log fi echo "    ( 1 )..." # ,   ,   find $Path -atime +7 | xargs rm -d if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps files was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps files is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi #    ( 2 ) echo "     ( 2 )..." find $ArchPath -atime +61 | xargs rm -f if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps archives was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps archives is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi echo "BackUp job finished in $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Contenido del archivo HandBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   log="/mnt/ZM/BackUpLog.txt" read -p "    (  ),  ALL      : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "BackUp started in $(date +%T)\n" &gt;&gt; $log #     echo "    ..." /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #       echo "      " for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done else MailBox="$A@$ZDomain" #    echo "   ..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then #   echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "  $MailBox ,  ..." echo -en "Required Mail Box $MailBox exist $(date +%T)\n" &gt;&gt; $log #      if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #    $MailBox /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi else #    -  echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo "  $MailBox  .   " echo -en "Required Mail Box $MailBox is not exist\n" &gt;&gt; $log exit fi fi read -p "      $MailBox? [N]: " F if [[ "$F" = "Y" || "$F" = "y" ]]; then #      if [ ! -d $ArchPath ]; then #     echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi #    echo "  ..." if [[ "$A" = "ALL" || "$A" = "all" ]]; then tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi else tar -czf $ArchPath/$MailBox.tar $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi fi else echo "   " echo -en "User decline archive creating\n" &gt;&gt; $log fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">El contenido del archivo Restore.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #   log="/mnt/ZM/RestoreLog.txt" read -p "  ,      02-09-2001: " Date if ! [ -d $Path/$Date ]; then echo "     ." echo -en "No BackUp file at $Date $(date +%T)\n" &gt; $log exit fi read -p "    (  ),  ALL        : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "Restore started in $(date +%T)\n" &gt;&gt; $log #     ls "$Path/$Date" &gt; $MBoxes for MailBox in $( cat $MBoxes); do #   echo "   $MailBox" Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist, creating Mail Box $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox  .   $MailBox..." #   Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   ." fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi done else #     MailBox="$A@$ZDomain" if [ -a $Path/$Date/$MailBox ]; then #   echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist $(date +%T)\n" &gt;&gt; $log echo " $MailBox  ." read -p "            ? [N]: " B if [[ "$B" = "Y" || "$B" = "y" ]]; then echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") #   if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   .   ..." exit fi else #   ,  .  echo "   .   " exit fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi else #     echo "    .   " echo -en "Required BackUp file is not exist\n" &gt;&gt; $log exit fi fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "Restore job complete in $(date +%T)\n" &gt;&gt; $log echo -en "____________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br>  Hay una sutileza.  Si crea y edita archivos de script para bash en Windows, cuando intente ejecutar el script, aparecer√° un error: <b>/ bin / sh ^ M: mal int√©rprete: No</b> existe <b>tal archivo o directorio</b> , que es el que los editores que se ejecutan en Windows agregan a El final de la l√≠nea es el car√°cter de retorno de carro "CR \ LF", que los editores en Linux no muestran.  Pero este s√≠mbolo est√° ah√≠ y no ha desaparecido.  Para deshacernos del error y eliminar los caracteres adicionales, hacemos lo siguiente: <br><br><pre> <code class="bash hljs">$ cat your-script.sh | tr -d <span class="hljs-string"><span class="hljs-string">'\r'</span></span> &gt; corrected-your-script.sh</code> </pre> <br>  Bueno, o puede usar la utilidad dos2unix, pero a√∫n necesita instalarla: <br><br><pre> <code class="bash hljs">$ yum install dos2unix $ dos2unix your-script.sh</code> </pre> <br>  5) Hacemos que los scripts sean ejecutables: <br><br><pre> <code class="bash hljs">$ chmod 0740 /opt/zimbra/BkUpRestScripts/FullBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/HandBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/Restore.sh</code> </pre> <br>  6) Le recomiendo que ejecute scripts con sus manos y verifique si funcionan y c√≥mo funcionan. <br><br>  7) Cree una tarea en CRON para la copia de seguridad diaria de los buzones: <br><br><pre> <code class="bash hljs">10 0 * * * root /opt/zimbra/ BkUpRestScripts/FullBackUp.sh</code> </pre> <br>  8) Disfruta <br><br><h3>  4. Scripting </h3><br>  En caso de que los comentarios en los propios guiones no sirvieran de nada. <br><br><div class="spoiler">  <b class="spoiler_title">1) Script FullBaclUp.sh:</b> <div class="spoiler_text">  Al principio, se determinan las variables, cu√°l es responsable de qu√©, todo se comenta. <br><br>  La siguiente es una comprobaci√≥n de la ausencia de un directorio para la copia de seguridad; si no existe, se crea.  Se llega a la conclusi√≥n del archivo de registro y de la pantalla (si se inicia manualmente) sobre el √©xito o el fracaso de la creaci√≥n de un directorio. <br><br>  Verifique si falta el cat√°logo con la fecha de hoy.  Si no est√° all√≠, se crea, tambi√©n se genera la salida a la pantalla y el registro del resultado de la creaci√≥n del directorio. <br><br>  Escribir en un archivo todos los buzones existentes de Zimbra.  Es necesario para la reserva secuencial de cada caja.  Muestra el resultado del comando. <br><br>  Crear una copia de seguridad para cada buz√≥n de la lista recibida.  Con la salida de la ejecuci√≥n a la pantalla y al archivo de registro. <br><br>  Borrar un archivo con una lista de cuadros.  Dado que los 3 scripts funcionan con este archivo, es recomendable limpiarlo despu√©s de cada ejecuci√≥n para que no haya sorpresas.  Puede limpiarlo antes del inicio del gui√≥n, pero de alguna manera me resulta m√°s familiar no almacenar datos innecesarios despu√©s de que se realiza el trabajo, pero hacer lo mismo antes y despu√©s de que el gui√≥n funcione es un leve grado de esquizofrenia. <br><br>  El siguiente es un bloque para crear un archivo comprimido. <br><br>  Comprobar la ausencia del directorio de almacenamiento de archivos, crearlo en ausencia y mostrar el resultado de la creaci√≥n en la pantalla y en el registro. <br><br>  Archivado <br><br>  Marque "¬øno es el primer d√≠a de hoy?"  Prefiero almacenar copias de seguridad para el primer d√≠a de todos los meses durante mucho tiempo, esto es suficiente para que yo trabaje.  Se puede almacenar durante semanas, pero a menudo esto es redundante.  Pero la condici√≥n para almacenar copias de seguridad durante todo el per√≠odo de funcionamiento del servidor de correo se establece en la parte superior, por lo que estar√°n all√≠ para siempre.  Si el n√∫mero es el primero, el archivo resultante se copia en un directorio separado "Mounthly".  Y para copiarlo all√≠, debe verificar si existe dicho directorio y, de no ser as√≠, crearlo, lo que se debe informar a la pantalla y al archivo de registro. <br><br>  A continuaci√≥n, se limpia el almacenamiento: se eliminan todas las copias de seguridad de m√°s de 2 semanas, as√≠ como los archivos de m√°s de 61 d√≠as.  El resultado de la eliminaci√≥n se muestra en la pantalla y en el archivo de registro. <br><br>  Despu√©s de lo cual el script escribe el tiempo de finalizaci√≥n en el archivo de registro y en la pantalla, y finaliza su trabajo. </div></div><br><div class="spoiler">  <b class="spoiler_title">2) Script HandBackUp.sh:</b> <div class="spoiler_text">  Al principio, las variables tambi√©n se definen, tambi√©n se comentan por qu√© son necesarias. <br><br>  A continuaci√≥n, se le solicita al usuario que ingrese el nombre del buz√≥n a respaldar, sin especificar el dominio Zimbra.  (est√° escrito en la invitaci√≥n para ingresar), o seleccione una copia de seguridad de todos los buzones escribiendo TODOS o todos. <br><br>  Si elige hacer una copia de seguridad de todos los buzones, el script funciona casi de la misma manera que el primero mencionado anteriormente, excepto que despu√©s de crear copias de seguridad de cada buz√≥n, preguntar√°: ¬ønecesito archivarlos? <br><br>  Si se escribi√≥ un buz√≥n espec√≠fico, entonces se verifica su existencia en Zimbra.  Si existe un cuadro con el nombre especificado, se inicia el proceso de copia de seguridad de este cuadro, con la informaci√≥n correspondiente que se muestra en la pantalla y en el archivo de registro.  Si el cuadro especificado no existe, se informar√° al usuario sobre esto y el script completar√° su trabajo. <br><br>  Una vez completada la copia de seguridad del cuadro, se le solicitar√° que archive la copia.  Si el usuario est√° de acuerdo, se verifica la ausencia de un directorio para almacenar el archivo y m√°s abajo en la lista, como en el primer script. <br><br>  Despu√©s de completar el archivado, se borra el archivo con la lista de buzones.  Por si acaso. <br><br>  Al final, la informaci√≥n sobre el tiempo de finalizaci√≥n del script se muestra en la pantalla y en el archivo de registro. </div></div><br><div class="spoiler">  <b class="spoiler_title">3) Script Restore.sh:</b> <div class="spoiler_text">  Como en los archivos anteriores, primero: la definici√≥n de variables con comentarios. <br><br>  Se le solicita al usuario que seleccione la fecha de la copia de seguridad que se va a restaurar.  Si la fecha especificada no est√° en las copias de seguridad, la secuencia de comandos finaliza al informar esto. <br><br>  Si existen copias de seguridad para la fecha especificada, solicite al usuario que ingrese el nombre del cuadro que debe restaurarse.  Para restaurar todos los cuadros, necesita escribir TODOS o todos. <br><br>  Si se selecciona la opci√≥n TODO, el script crea una lista de archivos en la carpeta de respaldo en el archivo, notifica sobre el resultado de la creaci√≥n. <br><br>  Lo siguiente es una recuperaci√≥n paso a paso de cada cuadro.  Primero, verifique la existencia de una casilla en el sistema; si no, se crea y luego se restaura.  La informaci√≥n sobre cada operaci√≥n se muestra en el archivo de registro y en la pantalla. <br><br>  Si se selecciona un cuadro espec√≠fico, es casi lo mismo.  Verifique la existencia de un archivo con el nombre solicitado.  Salida a la pantalla y el archivo de registro de resultados. <br><br>  Comprobando la existencia de una casilla en el sistema.  Salida a la pantalla y el archivo de registro de resultados. <br>  La invitaci√≥n al usuario a aceptar la creaci√≥n de la caja en ausencia de tal en el sistema.  Salida a la pantalla y el archivo de registro de resultados. <br><br>  Cree un cuadro si est√° de acuerdo.  Salida a la pantalla y el archivo de registro de resultados. <br>  Recuperaci√≥n de buzones.  Salida a la pantalla y el archivo de registro de resultados. <br><br>  Borrar un archivo con una lista de cuadros de recuperaci√≥n. <br><br>  Al final, la informaci√≥n sobre el tiempo de finalizaci√≥n del script se muestra en la pantalla y en el archivo de registro. </div></div><br><h3>  5. En cuanto a la recuperaci√≥n </h3><br>  Si modifica levemente estos scripts, entonces son bastante adecuados para mover el correo de un servidor a otro, simplemente creando buzones con todo el contenido en un lugar nuevo.  Tambi√©n puede restaurar el sistema desde cero, cuando por alguna raz√≥n es m√°s f√°cil volver a subir el servidor Zimbra que intentar revivir el antiguo.  Como se describi√≥ anteriormente, puede guardar la imagen de la m√°quina virtual configurada expandi√©ndola si es necesario y llen√°ndola con todos los datos.  El mismo algoritmo para pasar de un servidor Zimbra a otro.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y no se necesitan utilidades pagas como Zextras. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. Conclusi√≥n </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En general, no hay nada complicado en los guiones que escrib√≠. </font><font style="vertical-align: inherit;">S√≠, hay muchas condiciones en ellos, porque trat√© de predecir tantos problemas y errores como sea posible en su trabajo, pero tambi√©n trat√© de comentar el gui√≥n lo m√°s claramente posible. </font><font style="vertical-align: inherit;">Lo m√°s probable es que no funcionen para todos. </font><font style="vertical-align: inherit;">Quiz√°s alguien no tenga este m√©todo de respaldo en absoluto. </font><font style="vertical-align: inherit;">Pero espero que muchos lo encuentren √∫til.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. PD: </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es el segundo art√≠culo de la serie "C√≥mo implement√© Zimbra". </font><font style="vertical-align: inherit;">El primero trata sobre la implementaci√≥n, la autorizaci√≥n LDAP y la creaci√≥n autom√°tica de buzones para usuarios de AD, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠ mismo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El tercer art√≠culo sobre la generaci√≥n y actualizaci√≥n autom√°ticas de listas de correo basadas en AD en Zimbra OSE </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√° aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y tambi√©n quiero se√±alar que esta es mi primera experiencia de secuencias de comandos en una fiesta, debido a esto, las secuencias de comandos resultaron ser muy voluminosas y "especialmente inteligentes", como dicen.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/439728/">https://habr.com/ru/post/439728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../439718/index.html">Desarrollo de aplicaciones en Elixir / Phoenix con Docker</a></li>
<li><a href="../439720/index.html">Introducci√≥n a la programaci√≥n: un simple tirador 3D desde cero durante el fin de semana, parte 2</a></li>
<li><a href="../439722/index.html">Efectos de los filtros SVG. Parte 2. Esquema de texto con feMorfolog√≠a</a></li>
<li><a href="../439724/index.html">Descripci√≥n general de las soluciones de AI y ML en 2018 y pron√≥sticos para 2019: Parte 2 - Herramientas y bibliotecas, AutoML, RL, √©tica en IA</a></li>
<li><a href="../439726/index.html">Lock-in: ¬øverdad o ficci√≥n?</a></li>
<li><a href="../439730/index.html">Organizaci√≥n del reductor a trav√©s de una clase est√°ndar.</a></li>
<li><a href="../439732/index.html">Lazarus - animaci√≥n simple usando el componente TImageFragment</a></li>
<li><a href="../439734/index.html">Implementar Kubernetes en el escritorio en minutos con MicroK8s</a></li>
<li><a href="../439736/index.html">Conexi√≥n IPSec VPN entre MikroTik y Kerio Control</a></li>
<li><a href="../439738/index.html">En busca del bot√≥n "Hacer bien". Zyxel en la red de peque√±as y medianas empresas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>