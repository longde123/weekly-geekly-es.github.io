<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÇ ‚ûï üçÆ Por que preciso de suporte instrumental para pagina√ß√£o de chaves üêÜ üí™üèø üë®üèΩ‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Sou desenvolvedor de back-end, escrevendo microsservi√ßos em Java + Spring. Trabalho em uma das equipes internas de desenvolvimento de pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Por que preciso de suporte instrumental para pagina√ß√£o de chaves</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/485036/"><p>  Ol√° pessoal!  Sou desenvolvedor de back-end, escrevendo microsservi√ßos em Java + Spring.  Trabalho em uma das equipes internas de desenvolvimento de produtos da Tinkoff. </p><br><p><img src="https://habrastorage.org/webt/u8/by/ai/u8byai9btfgtbvmupsjvgizvyra.png"></p><br><p>  Nossa equipe geralmente levanta a quest√£o da otimiza√ß√£o de consulta no DBMS.  Voc√™ sempre quer um pouco mais r√°pido, mas nem sempre pode se dar bem com √≠ndices bem projetados - √© necess√°rio procurar algumas solu√ß√µes alternativas.  Durante uma dessas andan√ßas pela rede em busca de otimiza√ß√µes razo√°veis ‚Äã‚Äãao trabalhar com o banco de dados, encontrei o <a href="https://use-the-index-luke.com/">blog infinitamente √∫til de Marcus Vinand</a> , autor do SQL Performance Explained.  Este √© o tipo muito raro de blog em que voc√™ pode ler todos os artigos em uma linha. </p><br><p>  Quero traduzir para voc√™ um pequeno artigo de Marcus.  Pode ser chamado, at√© certo ponto, de um manifesto que procura chamar a aten√ß√£o para a quest√£o antiga, mas ainda relevante, do desempenho da opera√ß√£o de compensa√ß√£o de acordo com o padr√£o SQL. </p><a name="habracut"></a><br><p>  Em alguns lugares, complementarei o autor com explica√ß√µes e observa√ß√µes.  Vou designar todos esses lugares como "aprox." Para maior clareza. </p><br><h3 id="nebolshoe-vvedenie">  Pequena introdu√ß√£o </h3><br><p>  Acho que muitas pessoas sabem o qu√£o problem√°tico e inibit√≥rio √© trabalhar com seletores paginais por meio de deslocamento.  Mas voc√™ sabia que ele pode ser simplesmente substitu√≠do por um design mais produtivo? </p><br><p>  Portanto, a palavra-chave offset informa ao banco de dados para ignorar as primeiras n entradas na solicita√ß√£o.  No entanto, o banco de dados ainda precisa ler esses primeiros n registros do disco e na ordem especificada (nota: aplique a classifica√ß√£o se um for especificado) e somente depois disso ser√° poss√≠vel retornar registros a partir de n + 1 em diante.  O mais interessante √© que o problema n√£o est√° na implementa√ß√£o concreta no DBMS, mas na defini√ß√£o inicial de acordo com o padr√£o: </p><br><blockquote>  ... as linhas s√£o classificadas primeiro de acordo com a &lt;ordem pela cl√°usula&gt; e, em seguida, limitadas, descartando o n√∫mero de linhas especificadas na &lt;cl√°usula de deslocamento do resultado&gt; desde o in√≠cio ... <br>  -SQL: 2016, Parte 2, 4.15.3 Tabelas derivadas (nota: agora o padr√£o mais utilizado) </blockquote><p>  O ponto principal aqui √© que o deslocamento requer um √∫nico par√¢metro - o n√∫mero de registros a serem ignorados, e √© isso.  Seguindo essa defini√ß√£o, um DBMS pode obter apenas todos os registros e descartar os desnecess√°rios.  Obviamente, essa defini√ß√£o de deslocamento obriga a fazer um trabalho extra.  E nem importa se √© SQL ou NoSQL. </p><br><h3 id="esche-nemnogo-boli">  Um pouco mais de dor </h3><br><p>  Problemas de deslocamento n√£o param por a√≠, e aqui est√° o porqu√™.  Se outra opera√ß√£o inserir um novo registro entre a leitura de duas p√°ginas de dados do disco, o que acontecer√° neste caso? </p><br><p><img src="https://habrastorage.org/webt/lt/4y/qu/lt4yquxrhnlnnkrtgqdnuxlgfqc.png"></p><br><p>  Quando deslocamento √© usado para pular registros de p√°ginas anteriores, na situa√ß√£o de adicionar um novo registro entre as opera√ß√µes de leitura de p√°ginas diferentes, provavelmente voc√™ receber√° duplicatas (nota: isso √© poss√≠vel quando lemos p√°gina por p√°gina usando a ordem por constru√ß√£o, ent√£o no meio de nossa sa√≠da pode obter um novo registro). </p><br><p>  A figura mostra claramente essa situa√ß√£o.  A base l√™ os 10 primeiros registros, ap√≥s o qual um novo registro √© inserido, que muda todos os registros lidos por 1. Em seguida, a base pega uma nova p√°gina dos 10 registros seguintes e come√ßa n√£o a partir do dia 11 como deveria, mas do dia 10, duplicando esse registro.  Existem outras anomalias associadas ao uso dessa express√£o, mas essa √© a mais comum. </p><br><p>  Como j√° descobrimos, esses n√£o s√£o problemas de um DBMS espec√≠fico ou de sua implementa√ß√£o.  O problema √© a defini√ß√£o de pagina√ß√£o de acordo com o padr√£o SQL.  Dizemos ao DBMS qual p√°gina obter ou quantos registros devem ser ignorados.  A base simplesmente n√£o √© capaz de otimizar essa solicita√ß√£o, pois h√° muito pouca informa√ß√£o para isso. </p><br><p> Tamb√©m √© importante esclarecer que esse n√£o √© um problema espec√≠fico de palavra-chave, mas a sem√¢ntica da consulta.  Existem v√°rias sintaxes id√™nticas em termos de problematicidade: </p><br><ul><li>  A palavra-chave offset, conforme mencionado anteriormente. </li><li>  A constru√ß√£o das duas palavras-chave limit [offset] (embora o pr√≥prio limite n√£o seja t√£o ruim). </li><li>  Filtrar por limites inferiores com base na numera√ß√£o de linhas (por exemplo, n√∫mero_da_filme (), rownum etc.). </li></ul><br><p>  Todas essas express√µes dizem simplesmente quantas linhas a serem ignoradas, nenhuma informa√ß√£o ou contexto adicional. </p><br><p>  Posteriormente neste artigo, a palavra-chave offset √© usada como uma generaliza√ß√£o de todas essas op√ß√µes. </p><br><h3 id="zhizn-bez-offset">  Vida sem uma compensa√ß√£o </h3><br><p>  Agora imagine como seria o nosso mundo sem todos esses problemas.  Acontece que a vida sem deslocamento n√£o √© t√£o complicada: voc√™ pode selecionar apenas as linhas que n√£o vimos (nota: ou seja, aquelas que n√£o estavam na √∫ltima p√°gina) usando a condi√ß√£o em que. </p><br><p>  Nesse caso, constru√≠mos o fato de que as sele√ß√µes s√£o executadas em um conjunto ordenado (boa ordem antiga por).  Como temos um conjunto ordenado, podemos usar um filtro bastante simples para obter apenas os dados que est√£o por tr√°s do √∫ltimo registro da p√°gina anterior: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> &lt; ?last_seen_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FIRST</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROWS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ONLY</span></span></code> </pre> <br><p>  Esse √© todo o princ√≠pio dessa abordagem.  Obviamente, ao classificar por v√°rias colunas, tudo se torna mais divertido, mas a ideia √© a mesma.  √â importante observar que essa constru√ß√£o √© aplic√°vel a muitas solu√ß√µes <a href="https://docs.mongodb.com/manual/reference/method/cursor.skip/">N</a> <a href="https://developer.couchbase.com/documentation/server/5.0/n1ql/n1ql-language-reference/offset.html">o</a> <a href="http://orientdb.com/docs/last/Pagination.html">S</a> <a href="https://redis.io/commands/SORT">Q</a> <a href="https://lucene.apache.org/solr/guide/6_6/pagination-of-results.html">L.</a> </p><br><p>  Essa abordagem √© chamada de m√©todo de busca ou pagina√ß√£o do conjunto de chaves.  Ele resolve o problema com um resultado flutuante (nota: a situa√ß√£o com a escrita entre as leituras da p√°gina, descrita anteriormente) e, √© claro, que todos gostamos, trabalha mais r√°pido e mais est√°vel que o deslocamento cl√°ssico.  A estabilidade est√° no fato de que o tempo de processamento da consulta n√£o aumenta proporcionalmente ao n√∫mero da tabela solicitada (nota: se voc√™ quiser aprender mais sobre o trabalho de diferentes abordagens de pagina√ß√£o, pode <a href="https://use-the-index-luke.com/no-offset">ver a apresenta√ß√£o do autor</a> . Tamb√©m √© poss√≠vel encontrar refer√™ncias comparativas usando m√©todos diferentes). </p><br><p>  Um dos slides <a href="https://www.slideshare.net/MarkusWinand/p2d2-pagination-done-the-postgresql-way/43">informa</a> que a pagina√ß√£o de chave, √© claro, n√£o √© onipotente - ela tem suas pr√≥prias limita√ß√µes.  Mais significativo - ela n√£o tem a capacidade de ler p√°ginas aleat√≥rias (nota: inconsistentemente).  No entanto, na era da rolagem sem fim (nota: no front-end), isso n√£o √© um problema.  A especifica√ß√£o do n√∫mero da p√°gina para um clique √©, em qualquer caso, uma m√° decis√£o ao desenvolver uma interface do usu√°rio (nota: opini√£o do autor do artigo). </p><br><h3 id="a-chto-s-instrumentami">  E as ferramentas? </h3><br><p>  A pagina√ß√£o de chaves geralmente n√£o √© adequada devido √† falta de suporte instrumental para esse m√©todo.  A maioria das ferramentas de desenvolvimento, incluindo v√°rias estruturas, n√£o permite escolher de que maneira a pagina√ß√£o ser√° executada. </p><br><p>  A situa√ß√£o √© agravada pelo fato de que o m√©todo descrito requer suporte de ponta a ponta nas tecnologias usadas - do DBMS √† execu√ß√£o da solicita√ß√£o AJAX no navegador com rolagem sem fim.  Em vez de especificar apenas o n√∫mero da p√°gina, agora voc√™ precisa especificar um conjunto de chaves para todas as p√°ginas de uma s√≥ vez. </p><br><p>  No entanto, o n√∫mero de estruturas que suportam a pagina√ß√£o de chaves est√° aumentando gradualmente.  Aqui est√° o que est√° no momento: </p><br><ul><li>  <a href="https://www.jooq.org/">jOOQ</a> para Java; </li><li>  <a href="https://github.com/glebm/order_query">order_query</a> para Ruby; </li><li>  <a href="https://github.com/peopledoc/django-chunkator">chunkator</a> e <a href="https://pypi.org/project/django-infinite-scroll-pagination/">pagina√ß√£o de rolagem infinita do</a> Django para Django; </li><li>  <a href="https://github.com/djrobstep/sqlakeyset">SQL Alchemy sqlakeyset</a> para Python; </li><li>  <a href="https://github.com/Blazebit/blaze-persistence">persist√™ncia de chama</a> - API de crit√©rios para implementa√ß√µes de JPA; </li><li>  <a href="https://metacpan.org/pod/DBIx::Class::Wrapper::Factory">DBIx :: Class :: Wrapper</a> para Perl; </li><li>  <a href="https://massivejs.org/">Massive.js</a> , um mapeador para a <a href="https://massivejs.org/docs/options-objects">documenta√ß√£o do conjunto de chaves do</a> <a href="https://massivejs.org/">Node.js.</a> </li></ul><br><p>  (Observa√ß√£o: alguns links foram removidos devido ao fato de que, no momento da tradu√ß√£o, algumas bibliotecas n√£o foram atualizadas de 2017 a 2018. Se estiver interessado, voc√™ pode consultar a fonte.) </p><br><p>  √â neste momento que sua ajuda √© necess√°ria.  Se voc√™ est√° desenvolvendo ou suportando uma estrutura que de alguma forma usa pagina√ß√£o, pe√ßo, pe√ßo, que ore para que voc√™ fa√ßa suporte nativo √† pagina√ß√£o de chaves.  Se voc√™ tiver alguma d√∫vida ou precisar de ajuda, terei prazer em ajudar ( <a href="https://ask.use-the-index-luke.com/">f√≥rum</a> , <a href="https://twitter.com/MarkusWinand">Twitter</a> , <a href="https://use-the-index-luke.com/contact">formul√°rio de contato</a> ) (observa√ß√£o: na minha experi√™ncia com Markus, posso dizer que ele est√° realmente entusiasmado com a divulga√ß√£o deste t√≥pico). </p><br><p>  Se voc√™ usar solu√ß√µes prontas que voc√™ acha que merecem suporte para pagina√ß√£o de chaves, crie uma solicita√ß√£o ou ofere√ßa uma solu√ß√£o pronta, se poss√≠vel.  Voc√™ tamb√©m pode especificar este artigo no link. </p><br><h3 id="zaklyuchenie">  Conclus√£o </h3><br><p>  A raz√£o pela qual uma abordagem t√£o simples e √∫til como a pagina√ß√£o de chaves n√£o √© generalizada n√£o √© que seja dif√≠cil na implementa√ß√£o t√©cnica ou exija algum esfor√ßo.  A principal raz√£o √© que muitos est√£o acostumados a ver e trabalhar com deslocamento - essa abordagem √© ditada pelo pr√≥prio padr√£o. </p><br><p>  Como resultado, poucas pessoas pensam em mudar a abordagem da pagina√ß√£o e, por causa disso, o suporte instrumental de estruturas e bibliotecas est√° se desenvolvendo mal.  Portanto, se voc√™ estiver pr√≥ximo da id√©ia e objetivo da pagina√ß√£o sem complica√ß√µes, ajude a espalh√°-la! </p><br><p>  Fonte: <a href="https://use-the-index-luke.com/no-offset">https://use-the-index-luke.com/no-offset</a> <br>  Publicado por: Markus Winand </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485036/">https://habr.com/ru/post/pt485036/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485026/index.html">Oportunidades da Ge√≥rgia para profissionais de TI</a></li>
<li><a href="../pt485028/index.html">CRM 2020</a></li>
<li><a href="../pt485030/index.html">As 8 principais taxas de IEO e sua capitaliza√ß√£o agora</a></li>
<li><a href="../pt485032/index.html">Como tornar um aplicativo React mais r√°pido com a co-hospedagem do estado</a></li>
<li><a href="../pt485034/index.html">Automatizando a compila√ß√£o de um projeto Qt no Windows no Travis CI</a></li>
<li><a href="../pt485042/index.html">Devido ao suporte obrigat√≥rio a 5G, smartphones com Snapdragon 865 ser√£o piores em 2020</a></li>
<li><a href="../pt485044/index.html">Desmontamos o rel√≥gio digital da sonda Soyuz</a></li>
<li><a href="../pt485046/index.html">Como planejar uma estrat√©gia de produto vencedora</a></li>
<li><a href="../pt485050/index.html">Hypercube. Como fornecemos aos desenvolvedores dispositivos de teste e n√£o os perdemos</a></li>
<li><a href="../pt485052/index.html">Quem √© um bom QA?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>