<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì´ üë©üèæ‚Äçüíº ü§õ Ce que nous savons des microservices üë™ üõ©Ô∏è üë≥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Je m'appelle Vadim Madison, je dirige le d√©veloppement de la plateforme syst√®me Avito. √Ä propos de la fa√ßon dont nous, dans l'entreprise, passon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ce que nous savons des microservices</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/454780/"><p>  Salut  Je m'appelle Vadim Madison, je dirige le d√©veloppement de la plateforme syst√®me Avito.  √Ä propos de la fa√ßon dont nous, dans l'entreprise, passons d'une architecture monolithique √† une architecture de microservices, cela a √©t√© dit plus d'une fois.  Il est temps de partager comment nous avons transform√© notre infrastructure afin de tirer le meilleur parti des microservices et de ne pas nous y perdre.  Comment PaaS nous aide ici, comment nous avons simplifi√© le d√©ploiement et r√©duit la cr√©ation d'un microservice √† un seul clic - lisez la suite.  Tout ce que j'√©cris ci-dessous n'est pas enti√®rement impl√©ment√© dans Avito, en partie comment nous d√©veloppons notre plateforme. </p><br><p>  (Et √† la fin de cet article, je parlerai de l'opportunit√© de participer √† un s√©minaire de trois jours d'un expert en architecture de microservices Chris Richardson). </p><br><p><img src="https://habrastorage.org/webt/9e/m3/xm/9em3xmzspjfadie85f_elruwij4.png"></p><a name="habracut"></a><br><h1 id="kak-my-prishli-k-mikroservisam">  Comment nous sommes arriv√©s aux microservices </h1><br><p>  Avito est l'une des plus grandes petites annonces au monde, elle publie plus de 15 millions de nouvelles annonces par jour.  Notre backend accepte plus de 20 000 requ√™tes par seconde.  Nous avons maintenant plusieurs centaines de microservices. </p><br><p>  Nous construisons une architecture de microservices depuis plusieurs ann√©es.  Comment exactement - nos coll√®gues ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parl√©</a> en d√©tail dans notre section sur RIT ++ 2017. Au CodeFest 2017 (voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o</a> ), Sergey Orlov et Mikhail Prokopchuk ont ‚Äã‚Äãexpliqu√© en d√©tail pourquoi nous avions besoin de la transition vers les microservices et quel r√¥le Kubernetes a jou√© ici.  Eh bien, maintenant nous faisons tout pour minimiser les co√ªts de mise √† l'√©chelle inh√©rents √† une telle architecture. </p><br><p>  Au d√©part, nous n'avions pas cr√©√© un √©cosyst√®me qui nous aiderait de mani√®re globale dans le d√©veloppement et le lancement de microservices.  Ils ont simplement collect√© des solutions open source sens√©es, les ont lanc√©es √† la maison et ont sugg√©r√© au d√©veloppeur de les g√©rer.  En cons√©quence, il s'est rendu dans une douzaine d'endroits (tableaux de bord, services internes), apr√®s quoi il est devenu plus fort dans le d√©sir de couper le code √† l'ancienne, dans un monolithe.  La couleur verte sur les diagrammes ci-dessous indique ce que le d√©veloppeur fait d'une mani√®re ou d'une autre de ses propres mains, la couleur jaune indique l'automatisation. </p><br><p><img src="https://habrastorage.org/webt/2a/h8/br/2ah8breno6ypqrbgo7uwi4g_ymw.png"></p><br><p>  D√©sormais, dans l'utilitaire CLI PaaS, une √©quipe cr√©e un nouveau service et deux autres ajoutent une nouvelle base de donn√©es et se d√©ploient sur Stage. </p><br><p><img src="https://habrastorage.org/webt/ku/wf/ek/kuwfekxz9r75rl_hobbjp-rd82i.png"></p><br><h1 id="kak-preodolet-epohu-mikroservisnoy-razdroblennosti">  Comment surmonter l'√®re de la "fragmentation des microservices" </h1><br><p> Avec une architecture monolithique, pour des raisons de coh√©rence des changements dans le produit, les d√©veloppeurs ont √©t√© contraints de comprendre ce qui se passait avec leurs voisins.  Lorsque vous travaillez sur la nouvelle architecture, les contextes de service ne d√©pendent plus les uns des autres. </p><br><p>  De plus, pour que l'architecture de microservice soit efficace, de nombreux processus doivent √™tre mis en place, √† savoir: </p><br><p>  ‚Ä¢ l'exploitation foresti√®re; <br>  ‚Ä¢ tra√ßage des requ√™tes (Jaeger); <br>  ‚Ä¢ agr√©gation d'erreurs (Sentry); <br>  ‚Ä¢ statuts, messages, √©v√©nements de Kubernetes (Event Stream Processing); <br>  ‚Ä¢ limite de course / disjoncteur (vous pouvez utiliser Hystrix); <br>  ‚Ä¢ contr√¥le de la connectivit√© des services (nous utilisons Netramesh); <br>  ‚Ä¢ surveillance (Grafana); <br>  ‚Ä¢ assemblage (TeamCity); <br>  ‚Ä¢ communication et notification (Slack, email); <br>  ‚Ä¢ suivi des t√¢ches;  (Jira) <br>  ‚Ä¢ compilation de la documentation. </p><br><p>  Pour que le syst√®me √©volue, il ne perd pas son int√©grit√© et reste efficace, nous avons repens√© l'organisation du travail des microservices dans Avito. </p><br><h1 id="kak-my-upravlyaemsya-s-mikroservisami">  Comment nous g√©rons les microservices </h1><br><p>  La conduite d'une ¬´politique de parti¬ª unifi√©e parmi les nombreux micro-services qu'Avito aide √†: </p><br><ul><li>  division de l'infrastructure en couches; </li><li>  Concept de plate-forme en tant que service (PaaS); </li><li>  surveillance de tout ce qui se passe avec les microservices. </li></ul><br><p>  Les couches d'abstraction d'infrastructure comprennent trois couches.  Allons du haut vers le bas. </p><br><p>  <strong>A. Maillage sup√©rieur.</strong>  Au d√©but, nous avons essay√© Istio, mais il s'est av√©r√© qu'il utilise trop de ressources, ce qui est trop cher sur nos volumes.  Par cons√©quent, l'ing√©nieur senior de l'√©quipe d'architecture Alexander Lukyanchenko a d√©velopp√© sa propre solution - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Netramesh</a> (disponible en Open Source), que nous utilisons maintenant en production et qui consomme plusieurs fois moins de ressources qu'Istio (mais ne fait pas tout ce dont Istio se vante). <br>  <strong>B. Moyen - Kubernetes.</strong>  Nous y d√©ployons et exploitons des microservices. <br>  <strong>C. Inf√©rieur - m√©tal nu.</strong>  Nous n'utilisons pas de nuages ‚Äã‚Äãet des choses comme OpenStack, mais nous nous asseyons enti√®rement sur du m√©tal nu. </p><br><p>  Toutes les couches sont combin√©es par PaaS.  Et cette plate-forme, √† son tour, se compose de trois parties. </p><br><p>  <strong>G√©n√©rateurs</strong> contr√¥l√©s via l'utilitaire CLI.  C'est elle qui aide le d√©veloppeur √† cr√©er un microservice de la bonne mani√®re et avec un minimum d'effort. </p><br><p>  <strong>II.</strong>  <strong>Collecteur combin√©</strong> avec contr√¥le de tous les outils via un tableau de bord commun. </p><br><p>  <strong>III.</strong>  <strong>D√©p√¥t</strong> .  Il interf√®re avec les planificateurs qui d√©finissent automatiquement des d√©clencheurs pour les actions importantes.  Gr√¢ce √† un tel syst√®me, aucune t√¢che n'est manqu√©e simplement parce que quelqu'un a oubli√© de mettre une t√¢che dans Jira.  Pour cela, nous utilisons un outil interne appel√© Atlas. </p><br><p><img src="https://habrastorage.org/webt/xq/if/9g/xqif9gz-91gsn2qzo6up78dgqts.png"></p><br><p>  La mise en ≈ìuvre des microservices dans Avito est √©galement r√©alis√©e selon un sch√©ma unique, ce qui simplifie leur contr√¥le √† chaque √©tape de d√©veloppement et de sortie. </p><br><h1 id="kak-ustroen-standartnyy-konveyer-razrabotki-mikroservisa">  Fonctionnement du pipeline de d√©veloppement de microservices standard </h1><br><p>  De mani√®re g√©n√©rale, la cha√Æne de cr√©ation de microservices est la suivante: </p><br><p>  <em>CLI-push ‚Üí Int√©gration continue ‚Üí Bake ‚Üí D√©ployer ‚Üí Tests artificiels ‚Üí Tests Canary ‚Üí Squeeze Testing ‚Üí Production ‚Üí Service.</em> </p><br><p>  Nous le parcourons exactement dans cette s√©quence. </p><br><h2 id="cli-push">  CLI-push </h2><br><p>  <strong>‚Ä¢ Cr√©ation d'un microservice</strong> . <br>  Nous avons longtemps lutt√© pour apprendre √† chaque d√©veloppeur comment cr√©er des microservices.  Y compris √©crit dans Confluence des instructions d√©taill√©es.  Mais les sch√©mas ont chang√© et compl√©t√©.  Conclusion - un goulot d'√©tranglement s'est form√© au d√©but du voyage: il a fallu beaucoup plus de temps pour d√©marrer les microservices que ce qui √©tait autoris√©, et malgr√© tout, lors de leur cr√©ation, des probl√®mes se sont souvent pos√©s. </p><br><p>  Au final, nous avons construit un simple utilitaire CLI qui automatise les √©tapes de base lors de la cr√©ation d'un microservice.  En fait, il remplace le premier push git.  Voil√† ce qu'elle fait. </p><br><p>  - Cr√©e un service selon le mod√®le - pas √† pas, en mode "assistant".  Nous avons des mod√®les pour les principaux langages de programmation dans le backend Avito: PHP, Golang et Python. </p><br><p>  - Sur une commande, il d√©ploie l'environnement pour le d√©veloppement local sur une machine sp√©cifique - Le Minikube monte, les graphiques Helm sont automatiquement g√©n√©r√©s et ex√©cut√©s dans les kubernetes locaux. </p><br><p>  - Connecte la base de donn√©es souhait√©e.  Le d√©veloppeur n'a pas besoin de conna√Ætre l'IP, le login et le mot de passe pour acc√©der √† la base de donn√©es dont il a besoin - au moins localement, au moins en phase, au moins en production.  De plus, la base de donn√©es est d√©ploy√©e imm√©diatement dans une configuration √† tol√©rance de pannes et avec √©quilibrage. </p><br><p>  - Il effectue lui-m√™me un montage en direct.  Disons qu'un d√©veloppeur a corrig√© quelque chose dans un microservice via son IDE.  L'utilitaire voit les changements dans le syst√®me de fichiers et, en fonction d'eux, r√©assemble l'application (pour Golang) et red√©marre.  Pour PHP, nous transmettons simplement le r√©pertoire √† l'int√©rieur du cube et le live-reload est obtenu ¬´automatiquement¬ª. </p><br><p>  - G√©n√®re des autotests.  Sous forme de disques, mais tout √† fait adapt√© √† l'utilisation. </p><br><p>  <strong>‚Ä¢ D√©ployer le microservice</strong> . </p><br><p>  C'√©tait un peu morne de d√©ployer un microservice auparavant.  Obligatoire requis: </p><br><p>  Dockerfile. </p><br><p>  II.  Config. <br>  III.  Un graphique Helm, qui est lui-m√™me volumineux et comprend: </p><br><p>  - les cartes elles-m√™mes; <br>  - mod√®les; <br>  - des valeurs sp√©cifiques prenant en compte diff√©rents environnements. </p><br><p>  Nous nous sommes d√©barrass√©s de la douleur de refaire les manifestes Kubernetes, et maintenant ils sont g√©n√©r√©s automatiquement.  Mais surtout, ils ont simplifi√© le d√©ploiement √† la limite.  √Ä partir de maintenant, nous avons un Dockerfile, et le d√©veloppeur √©crit toute la configuration dans un seul fichier app.toml court. </p><br><p><img src="https://habrastorage.org/webt/o6/fd/g-/o6fdg-lpen5l_8evpr1j0rsltbe.png"></p><br><p>  Oui, et dans l'app.toml lui-m√™me, c'est maintenant les affaires pendant une minute.  Nous √©crivons o√π √† combien de copies du service √©lever (sur le serveur de d√©veloppement, sur la mise en sc√®ne, sur la production), indiquent ses d√©pendances.  Notez la taille de la ligne = "petite" dans le bloc [moteur].  Il s'agit de la limite qui sera allou√©e au service via Kubernetes. </p><br><p>  De plus, sur la base de la configuration, tous les graphiques Helm n√©cessaires sont g√©n√©r√©s automatiquement et des connexions aux bases de donn√©es sont cr√©√©es. </p><br><p>  <strong>‚Ä¢ Validation de base.</strong>  Ces contr√¥les sont √©galement automatis√©s. <br>  <strong>Besoin de suivre:</strong> <br>  - existe-t-il un Dockerfile; <br>  - existe-t-il app.toml; <br>  - s'il existe une documentation; <br>  - si la d√©pendance est en r√®gle; <br>  - sont les r√®gles des alertes d√©finies. <br>  Dernier point: le propri√©taire du service lui-m√™me indique les m√©triques de produit √† surveiller. </p><br><p>  <strong>‚Ä¢ Pr√©paration de la documentation.</strong> <br>  Encore un probl√®me.  Il semble √™tre le plus √©vident, mais en m√™me temps un record ¬´souvent oubli√©¬ª, et donc un maillon vuln√©rable de la cha√Æne. <br>  Il est n√©cessaire que la documentation se trouve sous chaque microservice.  Les blocs suivants y sont inclus. </p><br><p>  <strong>I. Br√®ve description du service</strong> .  Juste quelques phrases sur ce qu'il fait et ce dont il a besoin. </p><br><p>  <strong>II.</strong>  <strong>Lien vers le diagramme d'architecture</strong> .  Il est important de le consulter rapidement pour comprendre, par exemple, si vous utilisez Redis pour la mise en cache ou comme magasin de donn√©es principal en mode persistant.  √Ä Avito, jusqu'√† pr√©sent, c'est un lien vers Confluence. </p><br><p>  <strong>III.</strong>  <strong>Runbook</strong> .  Un petit guide pour lancer le service et les subtilit√©s de sa gestion. </p><br><p>  <strong>IV.</strong>  <strong>FAQ</strong> , o√π il serait bon d'anticiper les probl√®mes que vos coll√®gues peuvent rencontrer lorsqu'ils travaillent avec le service. </p><br><p>  <strong>V. Description des points finaux pour l'API</strong> .  Si vous n‚Äôavez soudainement pas indiqu√© votre destination, vous serez certainement pay√© par des coll√®gues dont les microservices sont li√©s aux v√¥tres.  Maintenant, nous utilisons Swagger pour cela et notre solution appel√©e brief. </p><br><p>  <strong>VI.</strong>  <strong>Les √©tiquettes</strong>  Ou des marqueurs qui indiquent √† quel produit, fonctionnalit√©, unit√© structurelle de l'entreprise appartient le service.  Ils aident √† comprendre rapidement, par exemple, si vous ne voyez pas la fonctionnalit√© que vos coll√®gues ont d√©ploy√©e il y a une semaine pour la m√™me unit√© commerciale. </p><br><p>  <strong>VII.</strong>  <strong>Le ou les propri√©taires du service</strong> .  Dans la plupart des cas, il - ou eux - peut √™tre d√©termin√© automatiquement √† l'aide de PaaS, mais pour l'assurance, nous demandons au d√©veloppeur de les sp√©cifier manuellement. </p><br><p>  Enfin, il est recommand√© de consulter la documentation, comme pour la r√©vision de code. </p><br><h2 id="continuous-integration">  Int√©gration continue </h2><br><ul><li>  <strong>Pr√©paration des r√©f√©rentiels.</strong> </li><li>  <strong>Cr√©ation d'un pipeline dans TeamCity.</strong> </li><li>  <strong>D√©finition des droits.</strong> </li><li>  <strong>Recherchez les propri√©taires de services.</strong>  Il existe un sch√©ma hybride - marquage manuel et automatisation minimale de PaaS.  Un sch√©ma enti√®rement automatique ne parvient pas √† transf√©rer des services en soutien √† une autre √©quipe de d√©veloppement, ou, par exemple, si un d√©veloppeur de services quitte. </li><li>  <strong>Enregistrement du service dans Atlas</strong> (voir ci-dessus).  Avec tous ses propri√©taires et d√©pendances. </li><li>  <strong>V√©rifiez les migrations.</strong>  Nous v√©rifions s'il y en a parmi eux potentiellement dangereux.  Par exemple, dans l'un d'eux, une table alterne appara√Æt ou quelque chose d'autre qui peut perturber la compatibilit√© du sch√©ma de donn√©es entre les diff√©rentes versions du service.  Ensuite, la migration n'est pas effectu√©e, mais mise dans un abonnement - PaaS devrait signaler au propri√©taire du service quand il devient s√ªr de l'utiliser. </li></ul><br><h2 id="bake">  Cuire </h2><br><p>  La prochaine √©tape est le conditionnement des services avant le d√©ploiement. </p><br><ul><li>  <strong>G√©n√©rez l'application.</strong>  Selon les classiques - dans l'image Docker. </li><li>  <strong>G√©n√©ration de graphiques Helm pour le service lui-m√™me et les ressources associ√©es.</strong>  Y compris pour les bases de donn√©es et le cache.  Ils sont cr√©√©s automatiquement conform√©ment √† la configuration app.toml qui a √©t√© g√©n√©r√©e √† l'√©tape CLI-push. </li><li>  <strong>Cr√©ation de tickets pour que les administrateurs ouvrent les ports</strong> (si n√©cessaire). </li><li>  <strong>Test unitaire et calcul de la couverture du code</strong> .  Si la couverture du code est inf√©rieure √† une valeur de seuil donn√©e, alors, tr√®s probablement, le service √©chouera davantage - √† d√©ployer.  S'il est sur le point d'√™tre autoris√©, un coefficient de ¬´pessimisation¬ª sera attribu√© au service: alors, en l'absence d'am√©lioration de l'indicateur dans le temps, le d√©veloppeur recevra une notification indiquant qu'il n'y a pas de progr√®s de la part des tests (et il faut faire quelque chose avec cela). </li><li>  <strong>Prise en compte des limitations de m√©moire et de CPU</strong> .  Nous √©crivons principalement des microservices √† Golang et les ex√©cutons dans Kubernetes.  De l√†, il y a une subtilit√© associ√©e √† la particularit√© du langage Golang: par d√©faut, tous les noyaux de la machine sont utilis√©s au d√©marrage, si vous ne d√©finissez pas explicitement la variable GOMAXPROCS et lorsque plusieurs de ces services sont lanc√©s sur la m√™me machine, ils commencent √† se disputer les ressources, interf√©rant les uns avec les autres.  Les graphiques ci-dessous montrent comment le temps d'ex√©cution change si vous ex√©cutez l'application sans concurrence et dans la course aux ressources.  (La source des graphiques est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ). </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/dl/1g/df/dl1gdfpfvj_me2wgpj28p0ucg90.png"></a> </p><br><p>  <em>D√©lai d'ex√©cution, moins c'est mieux.</em>  <em>Maximum: 643 ms; Minimum: 42 ms.</em>  <em>La photo est cliquable.</em> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/nb/zj/fv/nbzjfv9lx89orqn9r8ngnn84zr4.png"></a> </p><br><p>  <em>Temps pour la chirurgie, moins c'est mieux.</em>  <em>Maximum: 14091 ns, Minimum: 151 ns.</em>  <em>La photo est cliquable.</em> </p><br><p>  Au stade de la pr√©paration de l'assemblage, vous pouvez d√©finir cette variable explicitement ou vous pouvez utiliser la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">automaxprocs</a> des gars d'Uber. </p><br><h2 id="deploy">  D√©ployer </h2><br><p>  <strong>‚Ä¢ V√©rification des conventions.</strong>  Avant de commencer √† fournir des assemblys de service aux environnements pr√©vus, vous devez v√©rifier les √©l√©ments suivants: <br>  - Points de terminaison API. <br>  - Conformit√© du sch√©ma des points de terminaison des r√©ponses API. <br>  - Format de journal. <br>  - D√©finition d'en-t√™tes pour les demandes de service (Netramesh le fait maintenant) <br>  - D√©finition du jeton propri√©taire lors de l'envoi de messages vers le bus (bus d'√©v√©nements).  Cela est n√©cessaire pour suivre la connectivit√© des services via le bus.  Vous pouvez envoyer des donn√©es idempotentes au bus qui n'augmente pas la connectivit√© des services (ce qui est bien), ainsi que des donn√©es commerciales qui am√©liorent la connectivit√© des services (ce qui est tr√®s mauvais!).  Et au moment o√π cette connectivit√© devient un probl√®me, comprendre qui √©crit et lit le bus permet de bien r√©partir les services. </p><br><p>  Bien qu'il n'y ait pas beaucoup de conventions √† Avito, mais leur bassin s'√©largit.  Plus ces accords se pr√©sentent sous la forme d'une commande compr√©hensible et pratique, plus il est facile de maintenir la coh√©rence entre les microservices. </p><br><h2 id="sinteticheskie-testy">  Tests synth√©tiques </h2><br><p>  <strong>‚Ä¢ Test en boucle ferm√©e.</strong>  Pour lui, nous utilisons maintenant l'open source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hoverfly.io</a> .  Tout d'abord, il enregistre la charge r√©elle sur le service, puis - juste en boucle ferm√©e - il √©mule. </p><br><p>  <strong>‚Ä¢ Test de charge.</strong>  Nous essayons d'amener tous les services √† des performances optimales.  Et toutes les versions de chaque service doivent √™tre soumises √† des tests de r√©sistance - afin que nous puissions comprendre les performances actuelles du service et la diff√©rence avec les versions pr√©c√©dentes du m√™me service.  Si apr√®s une mise √† jour de service, ses performances ont diminu√© d'une fois et demie, c'est un signal clair pour ses propri√©taires: vous devez creuser dans le code et corriger la situation. <br>  Nous nous appuyons sur les donn√©es collect√©es, par exemple, afin d'impl√©menter correctement la mise √† l'√©chelle automatique et, en fin de compte, nous comprenons g√©n√©ralement √† quel point le service est √©volutif. </p><br><p>  Lors des tests de r√©sistance, nous v√©rifions si la consommation des ressources respecte les limites fix√©es.  Et nous nous concentrons principalement sur les extr√™mes. </p><br><p>  <strong>a) Nous regardons la charge totale.</strong> <br>  - Trop petit - tr√®s probablement quelque chose ne fonctionne pas du tout si la charge tombe soudainement plusieurs fois. <br>  - Trop grand - une optimisation est requise. </p><br><p> <strong>b) Nous examinons la coupure par RPS.</strong> <br>  Nous examinons ici la diff√©rence entre la version actuelle et la pr√©c√©dente et le nombre total.  Par exemple, si un service produit 100 rps, alors il est mal √©crit ou c'est sa sp√©cificit√©, mais en tout cas, c'est l'occasion de regarder de tr√®s pr√®s le service. <br>  Si RPS, au contraire, est trop, alors peut-√™tre une sorte de bogue et certains points de terminaison ont cess√© d'ex√©cuter la charge utile, mais une sorte de <code>return true;</code> d√©clench√© <code>return true;</code> </p><br><h2 id="canary-testy">  Tests canaris </h2><br><p>  Une fois les tests synth√©tiques r√©ussis, nous ex√©cutons le microservice sur un petit nombre d'utilisateurs.  Nous commen√ßons prudemment, avec une infime fraction de l'audience estim√©e du service - moins de 0,1%.  √Ä ce stade, il est tr√®s important que les mesures techniques et de produit correctes soient √©tablies dans la surveillance afin qu'elles montrent le probl√®me dans le service le plus rapidement possible.  Le temps minimum pour un test canari est de 5 minutes, le principal est de 2 heures.  Pour les services complexes, nous r√©glons l'heure en mode manuel. <br>  Nous analysons: <br>  - m√©triques sp√©cifiques au langage, en particulier les travailleurs php-fpm; <br>  - erreurs dans Sentry; <br>  - statuts des r√©ponses; <br>  - temps de r√©ponse (temps de r√©ponse), pr√©cis et moyen; <br>  - latence; <br>  - exceptions, trait√©es et non transform√©es; <br>  - m√©triques alimentaires. </p><br><h2 id="squeeze-testing">  Test de compression </h2><br><p>  Le test de compression est √©galement appel√© test d'extrusion.  Le nom de la technique a √©t√© introduit dans Netflix.  Son essence est qu'au d√©but, nous remplissons une instance de trafic r√©el √† l'√©tat de d√©faillance et d√©finissons ainsi sa limite.  Ensuite, ajoutez une autre instance et chargez ce couple - √† nouveau au maximum;  on voit leur plafond et leur delta avec le premier "squeeze".  Et donc nous connectons une instance par √©tape et calculons le mod√®le des changements. <br>  Les donn√©es de test par ¬´extrusion¬ª affluent √©galement vers la base m√©trique g√©n√©rale, o√π nous les enrichissons avec des r√©sultats de charge artificielle, ou m√™me les rempla√ßons par des ¬´synth√©tiques¬ª. </p><br><h2 id="prodakshen">  La production </h2><br><p>  <strong>‚Ä¢ Mise √† l'√©chelle.</strong>  En d√©ployant le service √† la production, nous suivons son √©volution.  Dans ce cas, la surveillance uniquement des indicateurs CPU, selon notre exp√©rience, est inefficace.  La mise √† l'√©chelle automatique avec l'analyse comparative RPS dans sa forme pure fonctionne, mais uniquement pour certains services, par exemple le streaming en ligne.  Nous examinons donc principalement les mesures de produit sp√©cifiques √† l'application. </p><br><p>  <strong>Par cons√©quent, lors de la mise √† l'√©chelle, nous analysons:</strong> <br>  - Indicateurs CPU et RAM, <br>  - le nombre de demandes dans la file d'attente, <br>  - temps de r√©ponse <br>  - pr√©visions bas√©es sur des donn√©es historiques. </p><br><p>  Lors de la mise √† l'√©chelle d'un service, il est √©galement important de surveiller ses d√©pendances afin qu'il ne se produise pas que nous soyons le premier service de la cha√Æne de mise √† l'√©chelle et que ceux auxquels il se r√©f√®re tombent sous la charge.  Pour √©tablir une charge acceptable pour l'ensemble du pool de services, nous examinons les donn√©es historiques du service d√©pendant ¬´le plus proche¬ª (bas√© sur une combinaison de CPU et de RAM et de mesures sp√©cifiques √† l'application) et les comparons avec les donn√©es historiques du service d'initialisation, et ainsi de suite tout au long de la ¬´cha√Æne de d√©pendance¬ª ", De haut en bas. </p><br><h2 id="obsluzhivanie">  Le service </h2><br><p>  Une fois le microservice mis en service, nous pouvons y suspendre des d√©clencheurs. </p><br><p>  <strong>Voici des situations typiques dans lesquelles des d√©clencheurs se d√©clenchent.</strong> <br>  - Migrations potentiellement dangereuses d√©tect√©es. <br>  - Des mises √† jour de s√©curit√© ont √©t√© publi√©es. <br>  - Le service lui-m√™me n'a pas √©t√© mis √† jour depuis longtemps. <br>  - La charge sur le service a consid√©rablement diminu√© ou l'une de ses mesures de produit est au-del√† de la plage normale. <br>  - Le service a cess√© de r√©pondre aux nouvelles exigences de la plate-forme. </p><br><p>  Certains d√©clencheurs sont responsables de la stabilit√© du travail, certains en fonction de la maintenance du syst√®me - par exemple, certains services n'ont pas √©t√© d√©ploy√©s depuis longtemps et son image de base a cess√© de passer les contr√¥les de s√©curit√©. </p><br><h1 id="dashbord">  Tableau de bord </h1><br><p>  En bref, le tableau de bord est le panneau de contr√¥le de l'ensemble de notre PaaS. </p><br><ul><li>  Un seul point d'information sur un service, avec des donn√©es sur sa couverture par les tests, le nombre de ses images, le nombre de copies de production, les versions, etc. </li><li>  Un outil de filtrage des donn√©es par services et labels (marqueurs d'appartenance aux business units, fonctionnalit√© produit, etc.) </li><li>  Moyens d'int√©gration avec des outils d'infrastructure pour le tra√ßage, la journalisation, la surveillance. </li><li>  Une documentation de point de service unique. </li><li>  Un point de vue unique sur tous les √©v√©nements de service. </li></ul><br><p><img src="https://habrastorage.org/webt/gi/lx/to/gilxtozg66qrpsxbrnjccubhiw0.png"><br><img src="https://habrastorage.org/webt/hq/wl/lc/hqwllckcrjfwl48sv_2qrjfefp4.png"><br><img src="https://habrastorage.org/webt/hu/ey/bj/hueybjd31isqaeav3w8iwx_oruq.png"><br><img src="https://habrastorage.org/webt/8z/ir/xk/8zirxkio-65hh2rqrj-impyozmc.png"></p><br><h1 id="itogo">  Total </h1><br><p>  Avant l'introduction de la PaaS, un nouveau d√©veloppeur pourrait passer plusieurs semaines √† trier tous les outils n√©cessaires pour lancer un microservice en production: Kubernetes, Helm, nos fonctionnalit√©s internes TeamCity, √©tablir une connexion aux bases de donn√©es et aux caches sous une forme tol√©rante aux pannes, etc. Il faut maintenant quelques heures pour lire le d√©marrage rapide et effectuer le service lui-m√™me. </p><br><hr><br><p>  J'ai fait un rapport sur ce sujet pour HighLoad ++ 2018, vous pouvez regarder la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o</a> et la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©sentation</a> . </p><br><h1 id="bonus-trek-dlya-teh-kto-dochital-do-konca">  Piste bonus pour ceux qui ont lu jusqu'au bout </h1><br><p>  √Ä Avito, nous organiserons une formation interne de trois jours pour les d√©veloppeurs de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chris Richardson</a> , un expert en architecture de microservices.  Nous voulons donner l'opportunit√© d'y participer √† l'un des lecteurs de cet article.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Voici</a> un programme de formation. </p><br><p>  La formation se tiendra du 5 au 7 ao√ªt √† Moscou.  Ce sont des jours ouvrables qui seront enti√®rement occup√©s.  Le d√©jeuner et la formation auront lieu dans nos bureaux, et le participant choisi paiera lui-m√™me le voyage et l'h√©bergement. </p><br><p>  Vous pouvez demander √† participer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√† ce formulaire Google</a> .  De vous - la r√©ponse √† la question de savoir pourquoi exactement vous devez assister √† la formation et des informations sur la fa√ßon de vous contacter.  R√©pondez en anglais, car Chris choisira le participant qui se rendra √† la formation. <br>  Nous annoncerons le nom du participant √† la formation en tant que mise √† jour de cet article sur les r√©seaux sociaux d'Avito pour les d√©veloppeurs (AvitoTech sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Facebook</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vkontakte</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Twitter</a> ) au plus tard le 19 juillet. </p><br><p>  <em>UPD, 19/07:</em> Nous avons re√ßu des dizaines de candidatures.  Chris les a examin√©s et a choisi un participant: avec nos coll√®gues, Andrei Igumnov ira √©tudier.  F√©licitations! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr454780/">https://habr.com/ru/post/fr454780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454766/index.html">HBO, merci de me rappeler ... "Trousse de premiers soins √† Tchernobyl" d'un pharmacien bi√©lorusse</a></li>
<li><a href="../fr454770/index.html">Samsung Startup Membership - un nouveau programme pour les startups en Russie</a></li>
<li><a href="../fr454774/index.html">Nous avons √©crit le code le plus utile de notre vie, mais nous l'avons jet√© √† la poubelle. Avec nous</a></li>
<li><a href="../fr454776/index.html">Freelance ou bureau? R√©ponse du pigiste</a></li>
<li><a href="../fr454778/index.html">Le livre "Machine Learning: Algorithms for Business"</a></li>
<li><a href="../fr454788/index.html">Arme d'un investisseur prudent: on consid√®re la juste valeur des obligations d'investissement</a></li>
<li><a href="../fr454790/index.html">Image native Java: v√©rification de l'utilisabilit√©</a></li>
<li><a href="../fr454792/index.html">Comparaison des algorithmes de tri des √©changes</a></li>
<li><a href="../fr454804/index.html">Cr√©ez votre composant avec des micro-mod√®les</a></li>
<li><a href="../fr454806/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 9. Le monde physique des interrupteurs. Partie 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>