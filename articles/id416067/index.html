<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∞üèº ‚úñÔ∏è ü•í Gambaran Umum Kerentanan Mikrotik Winbox. Atau file besar üë®‚Äçüé§ üí™üèΩ üë¶üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang, mungkin banyak yang telah mendengar tentang kerentanan terkini di router Mikrotik, yang memungkinkan Anda untuk mengekstrak kata sandi ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gambaran Umum Kerentanan Mikrotik Winbox. Atau file besar</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416067/"> Selamat siang, mungkin banyak yang telah mendengar tentang kerentanan terkini di router Mikrotik, yang memungkinkan Anda untuk mengekstrak kata sandi semua pengguna.  Dalam artikel ini, saya ingin menunjukkan dan menganalisis secara rinci esensi dari kerentanan ini. <a name="habracut"></a><br><blockquote>  Semua materi disediakan hanya untuk tujuan informasi, sehingga kode yang mengeksploitasi kerentanan tidak akan ada di sini.  Jika Anda tidak tertarik mempelajari penyebab dan struktur internal kerentanan tertentu, Anda dapat membaca. </blockquote><h3>  Mari kita mulai </h3><br>  Hal pertama yang harus dimulai adalah analisis lalu lintas antara klien Winbox dan perangkat <br><blockquote>  Winbox adalah aplikasi untuk OS WIndows, yang persis mengulangi antarmuka web dan dirancang untuk mengelola dan mengkonfigurasi perangkat dengan OS Router on board.  2 mode operasi yang didukung, TCP dan UDP </blockquote>  Sebelum Anda mulai, Anda harus menonaktifkan enkripsi lalu lintas di Winbox.  Ini dilakukan sebagai berikut: Anda perlu mengaktifkan kotak centang <i>Tools</i> -&gt; <i>Advanced Mode</i> .  Setelah itu, antarmuka akan berubah sebagai berikut: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bw/8c/3n/bw8c3ntuyktl2j8u8aoulc1pdbq.png"></div><br>  Hapus centang pada <i>Mode Aman</i> .  Luncurkan Wireshark dan coba masuk ke perangkat: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mq/2w/hs/mq2whsxb2vdhjddbedi9etvpb7c.png"></div><br>  Seperti yang dapat Anda lihat di bawah, setelah otorisasi, file <i>daftar</i> diminta dan kemudian isinya ditransfer sepenuhnya kepada kami, sepertinya semuanya baik-baik saja, tetapi mari kita lihat di awal sesi ini: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/il/ms/fo/ilmsfoqh_24blolrg0fuhdxhfhy.png"></div><br>  Pada awalnya, Winbox mengirimkan paket yang sama persis meminta file <i>daftar</i> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ar/uk/qu/arukqunodb50p3a0f6xawc19cuo.png"></div><br>  Pertimbangkan strukturnya: <br><br><ol><li>  37010035 - ukuran paket </li><li>  M2 adalah konstanta yang mengindikasikan awal suatu paket </li><li>  0500ff01 - variabel 0xff0005 pada nilai True </li><li>  0600ff09 01 - variabel 0xff0006 pada nilai 1 (Jumlah paket yang dikirimkan) </li><li>  0700ff09 07 - variabel 0xff0007 pada nilai 7 (Buka file dalam mode baca) </li><li>  01000021 04 6967374 - daftar string variabel 0x01000001 4 byte (Biasanya variabel ini bertanggung jawab untuk nama file) </li><li>  0200ff88 02 ... 00 - array 0xff0002 dengan ukuran 2 elemen </li><li>  0100ff88 02 ... 00 - array 0xff0001 dengan ukuran 2 elemen </li></ol><br>  Sebagai hasil dari protokol terbalik, dan file-file biner yang sesuai pada sisi klien dan server, dimungkinkan untuk memulihkan dan memahami struktur protokol di mana Winbox berkomunikasi dengan perangkat. <br><br><div class="spoiler">  <b class="spoiler_title">Uraian Protokol NvMessage</b> <div class="spoiler_text"><h3>  Jenis Bidang (Nama: Penunjukan Digital) </h3><br><ul><li>  u32: 0x08000000 </li><li>  u32_array: 0x88000000 </li><li>  string: 0x20000000 </li><li>  string_array: 0xA0000000 </li><li>  addr6: 0x18000000 </li><li>  addr6_array: 0x98000000 </li><li>  u64: 0x10000000 </li><li>  u64_array: 0x90000000 </li><li>  true: 0x0000000000 </li><li>  false: 0x01000000 </li><li>  bool_array: 0x80000000 </li><li>  pesan: 0x28000000 </li><li>  message_array: 0xA8000000 </li><li>  mentah: 0x30000000 </li><li>  raw_array: 0xB0000000 </li><li>  u8: 0x09000000 </li><li>  be32_array: 0x88000000 </li></ul><br><h3>  Jenis kesalahan (Nama: Penunjukan digital) </h3><br><ul><li>  SYS_TO: 0xFF0001 </li><li>  STD_UNDOID: 0xFE0006 </li><li>  STD_DESCR: 0xFE0009 </li><li>  STD_FINISHED: 0xFE000B </li><li>  STD_DYNAMIC: 0xFE0007 </li><li>  STD_INACTIVE: 0xFE0008 </li><li>  STD_GETALLID: 0xFE0003 </li><li>  STD_GETALLNO: 0xFE0004 </li><li>  STD_NEXTID: 0xFE0005 </li><li>  STD_ID: 0xFE0001 </li><li>  STD_OBJS: 0xFE0002 </li><li>  SYS_ERRNO: 0xFF0008 </li><li>  SYS_POLICY: 0xFF000B </li><li>  SYS_CTRL_ARG: 0xFF000F </li><li>  SYS_RADDR6: 0xFF0013 </li><li>  SYS_CTRL: 0xFF000D </li><li>  SYS_ERRSTR: 0xFF0009 </li><li>  SYS_USER: 0xFF000A </li><li>  SYS_STATUS: 0xFF0004 </li><li>  SYS_FROM: 0xFF0002 </li><li>  SYS_TYPE: 0xFF0003 </li><li>  SYS_REQID: 0xFF0006 </li></ul><br><h3>  Nilai Kesalahan (Nama: Penunjukan Digital) </h3><br><ul><li>  ERROR_FAILED: 0xFE0006 </li><li>  ERROR_TOOBIG: 0xFE000A </li><li>  ERROR_EXISTS: 0xFE0007 </li><li>  ERROR_NOTALLOWED: 0xFE0009 </li><li>  ERROR_BUSY: 0xFE000C </li><li>  ERROR_UNKNOWN: 0xFE0001 </li><li>  ERROR_BRKPATH: 0xFE0002 </li><li>  ERROR_UNKNOWNID: 0xFE0004 </li><li>  ERROR_UNKNOWNNEXTID: 0xFE000B </li><li>  ERROR_TIMEOUT: 0xFE000D </li><li>  ERROR_TOOMUCH: 0xFE000E </li><li>  ERROR_NOTIMP: 0xFE0003 </li><li>  ERROR_MISSING: 0xFE0005 </li><li>  STATUS_OK: 0x01 </li><li>  STATUS_ERROR: 0x02 </li></ul><br><h3>  Struktur bidang dalam suatu paket </h3><br>  Pada awal bidang apa pun adalah jenisnya - 4 byte (3 byte - tujuan variabel, lebih lanjut tentang itu nanti, 1 byte - langsung tipe variabel ini) maka panjangnya 1-2 byte dan nilainya sendiri. <br><br><h4>  Array </h4><br>  Secara kiasan, array dapat dijelaskan oleh struktur berikut: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Array</span></span></span><span class="hljs-class"> {</span></span> uint32 type; uint8 count; uint32 item1; uint32 item2; ... uint8 zero; }</code> </pre> <br>  Ketik (4 byte) / Jumlah elemen (1 byte) / Elemen (4 byte) / Di akhir byte \ x00 <br><br><h4>  Garis </h4><br>  String tidak diakhiri null, tetapi memiliki panjang yang jelas: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class"> {</span></span> uint32 type; uint8 length; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> text[length]; }</code> </pre> <br><h4>  Angka-angka </h4><br>  Jenis paling sederhana dalam paket, dapat direpresentasikan sebagai tipe nilai: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">u</span></span></span><span class="hljs-class">* {</span></span> uint32 type; uint8/<span class="hljs-number"><span class="hljs-number">32</span></span>/<span class="hljs-number"><span class="hljs-number">64</span></span> value; }</code> </pre> <br>  Bergantung pada jenisnya, nilainya memiliki dimensi bit yang sesuai. <br><br><h4>  Tipe Boolean </h4><br>  Ukuran bidang adalah 4 byte, byte tinggi bertanggung jawab atas nilai (True \ False), 3 byte lebih rendah untuk menetapkan variabel <br><br>  Selain itu, setiap paket berisi: <br><br><ol><li>  spidol khusus untuk menunjukkan awal paket </li><li>  ukuran paket </li><li>  pasar kontrol paket besar </li></ol><br><br><h3>  Konstanta yang ditemukan </h3><br><ul><li>  0xfe0001 - Berisi pengidentifikasi sesi (1 byte) </li><li>  0xff0006 - Jumlah paket yang dikirim (1 byte) </li><li>  0xff0007 - Mode Akses File (1 byte) </li></ul><br>  Mode Akses File <br><br><ul><li>  7 - terbuka untuk membaca </li><li>  1 - terbuka untuk perekaman </li><li>  6 - buat direktori </li><li>  4 - baca </li><li>  5 - hapus </li></ul><br></div></div><br>  Sekarang, mengetahui cara kerja protokol, kita dapat secara acak menghasilkan paket yang kita butuhkan dan melihat bagaimana perangkat meresponsnya. <br><br>  Di sisi perangkat, executable <i>/ nova / bin / mproxy</i> bertanggung jawab untuk memproses paket.  Karena nama-nama fungsi tidak disimpan, saya memanggil fungsi yang memproses paket dan membuat keputusan tentang apa yang harus dilakukan dengan file <i>file_handler ()</i> .  Lihatlah fungsi itu sendiri: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/si/wn/bt/siwnbthrbta88hokr1qjmcsllvu.png"></div><br><blockquote>  PS Kode yang akan menarik bagi kita ditandai dengan panah. </blockquote><br><h4>  Langkah 1 </h4><br>  Saat menerima paket untuk membuka file untuk dibaca, itu mulai diproses dari blok ini: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7a/iz/x4/7aizx48ztgn_s15p0kmtkv1avdu.png"></div><br>  Pada awalnya, nama file diekstraksi dari paket menggunakan fungsi <i>nv :: message :: get &lt;nv :: string_id&gt; ()</i> . <br><br>  Selanjutnya, fungsi <i>tokenize ()</i> membagi string yang dihasilkan menjadi bagian yang terpisah, menggunakan karakter " <b>/</b> " sebagai pembatas. <br><br>  Array string yang dihasilkan dilewatkan ke fungsi <i>path_filter ()</i> , yang memeriksa array string yang diterima untuk keberadaan " <b>..</b> ", dan jika ada kesalahan mengembalikan kesalahan <b>ERROR_NOTALLOWED (0xFE0009)</b> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nv/6a/ex/nv6aex2ifzlg9o2pqhjcevvw_3g.png"></div><br><blockquote>  PS <b>ERROR_NOTALLOWED</b> juga akan diterima dalam respons jika tidak ada izin file </blockquote><br>  Jika semuanya baik-baik saja, maka path ke direktori <i>webfig</i> atau <i>pckg disatukan</i> dengan awal nama file <br><br><h4>  Langkah 2 </h4><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/08/tj/xv/08tjxvub-j4ymwlkx8vbyvibu48.png"></div><br>  Jika semuanya berjalan dengan baik, file terbuka dan pegangannya disimpan ke objek global. <br><br>  Jika file tidak dapat dibuka, maka dalam respons kami mendapatkan kesalahan: <b>tidak dapat membuka file sumber</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eb/gz/bq/ebgzbqqw37zawbh6-1rad67ql4g.png"></div><br>  Jadi, untuk menerima konten file, 3 syarat harus dipenuhi: <br><br><ol><li>  Jalur file tidak mengandung " <b>..</b> "; </li><li>  Ada hak untuk mengakses file; </li><li>  File ada dan dapat dibuka dengan sukses. </li></ol><br>  Sekarang mari kita coba mengirim beberapa paket untuk menguji fungsionalitas fungsi ini: <br><br><pre> <code class="bash hljs">$ ./untitled.py -t 192.168.88.1 -f /etc/passwd Error: SYS_ERRNO =&gt; ERROR_FAILED Error: SYS_ERRSTR =&gt; cannot open <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> file $ ./untitled.py -t 192.168.88.1 -f /../../../etc/passwd Error: SYS_ERRNO =&gt; ERROR_NOTALLOWED $ ./untitled.py -t 192.168.88.1 -f //./././././../etc/passwd Error: SYS_ERRNO =&gt; ERROR_FAILED Error: SYS_ERRSTR =&gt; cannot open <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> file</code> </pre><br>  Jadi!  Tapi ini sudah aneh ... Kita ingat bahwa <b>ERROR_NOTALLOWED</b> muncul jika check in <i>path_filter ()</i> tidak lulus, kalau tidak kita masih akan menerima pesan tentang kurangnya hak akses, tetapi dalam kasus terakhir, ternyata file tersebut dicari di direktori tingkat atas? <br><br>  Mari kita coba cara ini: <br><br><pre> <code class="bash hljs">$ ./untitled.py -t 192.168.88.1 -f //./.././.././../etc/passwd xvM2        1Enobody:*:99:99:nobody:/tmp:/bin/sh root::0:0:root:/home/root:/bin/sh</code> </pre><br>  Dan itu berhasil.  Tapi mengapa?  Mari kita lihat kode fungsi <i>path_filter ():</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0r/qj/oe/0rqjoeg644_tcta0gave71d1n-e.png"></div><br>  Kode dengan jelas menunjukkan bahwa pencarian untuk terjadinya " <b>..</b> " di array string yang dihasilkan benar-benar terjadi.  Tetapi bagian yang paling menarik, saya menyoroti bagian ini dengan warna merah. <br>  Inti dari kode ini adalah: <b>Jika item sebelumnya juga " <b>..</b> ", maka cek dianggap gagal.</b>  Kalau tidak, pertimbangkan bahwa semuanya baik-baik saja. <br><br>  Yaitu  Agar semuanya berfungsi, Anda hanya perlu mengganti " <b>/./</b> " dan " <b>/../</b> " untuk berhasil menavigasi direktori mana pun dan turun ke tingkat FS apa pun. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w8/v4/2s/w8v42ssnrykzph96vl6ngf1_muq.jpeg"></div><br>  Mari kita lihat bagaimana pengembang Mikrotik memperbaikinya: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/un/05/tm/un05tmw-tylgkiewgfutcshjssw.png"></div><br><div class="spoiler">  <b class="spoiler_title">Perbandingan kode pseudo-C</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/t9/fl/jb/t9fljb3v3tdf0ikho7mrspaoy08.png"></div><br></div></div><br>  Sekarang jalan keluar dari siklus verifikasi terjadi pada deteksi pertama " <b>..</b> ".  Benar, tidak sepenuhnya jelas bagi saya mengapa mereka menambahkan cek untuk terjadinya satu poin.  Dan karena perubahan dalam mekanisme aktivasi pengguna <i>devel</i> , sayangnya, tidak ada cara untuk melihat ini dalam dinamika. <br><br><h3>  Untuk meringkas </h3><br><ol><li>  Router OS memproses paket yang masuk tanpa masalah bahkan sebelum otorisasi pengguna </li><li>  Karena filter yang salah, kami mendapatkan akses ke file apa pun </li></ol><br>  Dengan paragraf sebelumnya, kita dapat dengan mudah: membuat, menghapus, membaca, dan menulis file, serta membuat direktori arbitrer <br><br>  Jadi tidak mengherankan bahwa memiliki akses untuk membaca file tanpa otorisasi, hal pertama yang dilakukan adalah membaca file dengan kata sandi pengguna.  Untungnya, jaringan memiliki banyak informasi tentang di mana ia berada dan bagaimana cara mengekstrak data darinya. <br><br>  Selain itu, kerentanan ini dapat menjadi pengganti yang sangat baik untuk kemungkinan yang sebelumnya diketahui mengaktifkan mode pengembang, karena Anda tidak perlu me-restart perangkat, lakukan <i>backup</i> \ <i>restore</i> file konfigurasi sekarang. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id416067/">https://habr.com/ru/post/id416067/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id416053/index.html">Modulasi amplitudo dari sinyal arbitrer</a></li>
<li><a href="../id416055/index.html">Penugasan dan dukungan FQDN server 3QX</a></li>
<li><a href="../id416059/index.html">Mobio Talks dengan Daniil Shuleiko (Yandex.Taxi) tentang merger dengan Uber, pasar taksi, dan persaingan</a></li>
<li><a href="../id416061/index.html">Begitu-begitu-begitu, saya melihat semuanya</a></li>
<li><a href="../id416063/index.html">Negosiasi Rusia tidak punya catatan</a></li>
<li><a href="../id416069/index.html">Migrasi data ElasticSearch Lossless</a></li>
<li><a href="../id416071/index.html">Jaringan saraf, prinsip dasar operasi, keanekaragaman dan topologi</a></li>
<li><a href="../id416073/index.html">Bot perdagangan cryptocurrency sederhana</a></li>
<li><a href="../id416075/index.html">FSB ingin memperkenalkan tanggung jawab atas penggunaan tersembunyi perekam suara dan kamera di telepon pintar [dan tidak hanya]</a></li>
<li><a href="../id416077/index.html">PlantUML - Semuanya Analis Bisnis Perlu Membuat Grafik dalam Dokumentasi Perangkat Lunak</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>