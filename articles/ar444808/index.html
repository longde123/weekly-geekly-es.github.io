<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ฃ ๐ ๐ก ุนูููุงุช ุงููุดุฑ ุงูุชููุงุฆูุฉ ููููุงุฑู ุจุงุณุชุฎุฏุงู Flagger ู Istio ๐ค ๐จ๐พโ๐จ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุชู ุงูุชุนุฑู ุนูู ุงููุฑุต ุงููุถุบูุท ูููุงุฑุณุฉ ูุชุทููุฑ ุจุฑูุฌูุงุช ุงููุคุณุณุงุช ุ ุฅูู ูุชูุฌุฉ ููุชุทูุฑ ุงูุทุจูุนู ููุจุงุฏุฆ CI ุงูุซุงุจุชุฉ. ููุน ุฐูู ุ ูุง ูุฒุงู ุงููุฑุต ุงููุถุบูุท ุฃูุฑูุง ูุงุฏุฑ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุนูููุงุช ุงููุดุฑ ุงูุชููุงุฆูุฉ ููููุงุฑู ุจุงุณุชุฎุฏุงู Flagger ู Istio</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/444808/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ol/eo/lt/oleoltogrvhcuhjuil5zmvmbpxi.png"></p><br><p style=";text-align:right;direction:rtl">  ูุชู ุงูุชุนุฑู ุนูู ุงููุฑุต ุงููุถุบูุท ูููุงุฑุณุฉ ูุชุทููุฑ ุจุฑูุฌูุงุช ุงููุคุณุณุงุช ุ ุฅูู ูุชูุฌุฉ ููุชุทูุฑ ุงูุทุจูุนู ููุจุงุฏุฆ CI ุงูุซุงุจุชุฉ.  ููุน ุฐูู ุ ูุง ูุฒุงู ุงููุฑุต ุงููุถุบูุท ุฃูุฑูุง ูุงุฏุฑ ุงูุญุฏูุซ ุ ุฑุจูุง ุจุณุจุจ ุชุนููุฏ ุงูุฅุฏุงุฑุฉ ูุงูุฎูู ูู ุนูููุงุช ุงููุดุฑ ุบูุฑ ุงููุงุฌุญุฉ ุงูุชู ุชุคุซุฑ ุนูู ุชููุฑ ุงููุธุงู. </p><br><p style=";text-align:right;direction:rtl">  Flagger ูู ูุดุบู Kubernetes ููุชูุญ ุงููุตุฏุฑ ููุฏู ุฅูู ุงููุถุงุก ุนูู ุงูุนูุงูุงุช ุงููุฑุจูุฉ.  ูุนูู ุนูู ุฃุชูุชุฉ ุงูุชุฑููุฌ ููุดุฑ ุงูููุงุฑู ุจุงุณุชุฎุฏุงู ุฅุฒุงุญุฉ ุญุฑูุฉ ูุฑูุฑ Istio ูููุงููุณ Prometheus ูุชุญููู ุณููู ุงูุชุทุจูู ุฃุซูุงุก ุงูุชุดุบูู ุงููุฏุงุฑ. </p><br><p style=";text-align:right;direction:rtl">  ููุฌุฏ ุฃุฏูุงู ุฏููู ุชูุตููู ุญูู ููููุฉ ุชูููู ูุงุณุชุฎุฏุงู ุฃุฏุงุฉ Flagger ูู Google Kubernetes Engine (GKE). </p><a name="habracut"></a><br><h3 id="nastroyka-klastera-kubernetes" style=";text-align:right;direction:rtl">  ุชูููู Kubernetes ุงููุชูุฉ </h3><br><p style=";text-align:right;direction:rtl">  ููููู ุงูุจุฏุก ุจุฅูุดุงุก ูุฌููุนุฉ GKE ุจุงุณุชุฎุฏุงู ูุธููุฉ Istio ุงูุฅุถุงููุฉ (ุฅุฐุง ูู ููู ูุฏูู ุญุณุงุจ GCP ุ ูููููู ุงูุชุณุฌูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> ูุชููู ุฃุฑุตุฏุฉ ูุฌุงููุฉ). </p><br><p style=";text-align:right;direction:rtl"> ูู ุจุชุณุฌูู ุงูุฏุฎูู ุฅูู Google Cloud ูุฅูุดุงุก ูุดุฑูุน ูุชูููู ุงูููุชุฑุฉ ูู.  ุชุซุจูุช <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฃุฏุงุฉ ุงููุณุงุนุฏุฉ</a> ูุณุทุฑ ุงูุฃูุงูุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">gcloud</a> ูุชุฎุตูุต ูุดุฑูุนู ูุน <code>gcloud init</code> . </p><br><p style=";text-align:right;direction:rtl">  <code>PROJECT_ID</code> ุงููุดุฑูุน ุงูุงูุชุฑุงุถู ูููุทูุฉ ุงูุญุณุงุจ ูุงูููุทูุฉ ( <code>PROJECT_ID</code> ): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">gcloud config set project PROJECT_ID gcloud config set compute/region us-central1 gcloud config set compute/zone us-central1-a</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชูููู ุฎุฏูุฉ GKE ูุฅูุดุงุก ูุชูุฉ ูุน HPA ู Istio ุงููุธุงุฆู ุงูุฅุถุงููุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">gcloud services enable container.googleapis.com K8S_VERSION=$(gcloud beta container get-server-config --format=json | jq -r '.validMasterVersions[0]') gcloud beta container clusters create istio \ --cluster-version=${K8S_VERSION} \ --zone=us-central1-a \ --num-nodes=2 \ --machine-type=n1-standard-2 \ --disk-size=30 \ --enable-autorepair \ --no-enable-cloud-logging \ --no-enable-cloud-monitoring \ --addons=HorizontalPodAutoscaling,Istio \ --istio-config=auth=MTLS_PERMISSIVE</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุณูููู ุงูุฃูุฑ ุฃุนูุงู ุจุฅูุดุงุก ุชุฌูุน ุนูุฏุฉ ุงูุชุฑุงุถู ูุดุชูู ุนูู ุฌูุงุฒู VMs <code>n1-standard-2</code> (vCPU: 2ุ RAM 7.5 GBุ disk: 30 GB).  ูู ุงููุงุญูุฉ ุงููุซุงููุฉ ุ ูุฌุฏุฑ ุนุฒู ููููุงุช Istio ุนู ุฃุนุจุงุก ุงูุนูู ุงูุฎุงุตุฉ ุจูุง ุ ูููู ูุง ุชูุฌุฏ ุทุฑููุฉ ุณููุฉ ูุชุดุบูู ุญุงูุธุงุช Istio ูู ุชุฌูุน ูุฎุตุต ููุนูุฏุฉ.  ุชูุนุชุจุฑ ููุงุฆู Istio ูููุฑุงุกุฉ ููุท ุ ูุณุชููู GKE ุจุงูุชุฑุงุฌุน ุนู ุฃู ุชุบููุฑุงุช ุ ูุซู ุงูุฑุจุท ุจุงูุนูุฏุฉ ุฃู ูุทุน ุงูุงุชุตุงู ุนู ุงููููุฏ. </p><br><p style=";text-align:right;direction:rtl">  ุชูููู ุจูุงูุงุช ุงูุงุนุชูุงุฏ ูู <code>kubectl</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">gcloud container clusters get-credentials istio</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅูุดุงุก ุฑุจุท ุฏูุฑ ูุณุคูู ุงููุชูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl create clusterrolebinding "cluster-admin-$(whoami)" \ --clusterrole=cluster-admin \ --user="$(gcloud config get-value core/account)"</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุซุจูุช ุฃุฏุงุฉ ุณุทุฑ ุงูุฃูุงูุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Helm</a> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">brew install kubernetes-helm</code> </pre> <br><p style=";text-align:right;direction:rtl">  Homebrew 2.0 ูุชููุฑ ุงูุขู ููุธุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุชุดุบูู Linux</a> . </p><br><p style=";text-align:right;direction:rtl">  ุฅูุดุงุก ุญุณุงุจ ุฎุฏูุฉ ูุฑุจุท ุฏูุฑ ูุธุงู ุงููุฌููุนุฉ ูู Tiller: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl -n kube-system create sa tiller &amp;&amp; \ kubectl create clusterrolebinding tiller-cluster-rule \ --clusterrole=cluster-admin \ --serviceaccount=kube-system:tiller</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุจุชูุณูุน Tiller ูู <code>kube-system</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">helm init --service-account tiller</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ุชููุฑ ูู ุงุณุชุฎุฏุงู SSL ุจูู Helm ู Tiller.  ููุฒูุฏ ูู ุงููุนูููุงุช ุญูู ุชุฃููู ุชุซุจูุช Helm ุ ุฑุงุฌุน <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">docs.helm.sh</a> </p><br><p style=";text-align:right;direction:rtl">  ุชุฃููุฏ ุงูุฅุนุฏุงุฏุงุช: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl -n istio-system get svc</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ุจุถุน ุซูุงูู ุ ูุฌุจ ุนูู GCP ุชุนููู ุนููุงู IP ุฎุงุฑุฌู ูุฎุฏูุฉ <code>istio-ingressgateway</code> . </p><br><h3 id="nastroyka-vhodnogo-shlyuza-istio" style=";text-align:right;direction:rtl">  ุฅุนุฏุงุฏ ูุฏุฎู ูุฏุฎู Istio </h3><br><p style=";text-align:right;direction:rtl">  ูู ุจุฅูุดุงุก ุนููุงู IP ุซุงุจุช ูุณูู <code>istio-gateway</code> ุจุงุณุชุฎุฏุงู ุนููุงู IP ุงูุฎุงุต ุจุจูุงุจุฉ Istio: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">export GATEWAY_IP=$(kubectl -n istio-system get svc/istio-ingressgateway -ojson | jq -r .status.loadBalancer.ingress[0].ip) gcloud compute addresses create istio-gateway --addresses ${GATEWAY_IP} --region us-central1</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃูุช ุงูุขู ุจุญุงุฌุฉ ุฅูู ูุฌุงู ุฅูุชุฑูุช ูุงููุตูู ุฅูู ูุณุฌู DNS ุงูุฎุงุต ุจู.  ุฃุถู ูุฏุฎููู A ( <code>example.com</code> ุจูุทุงูู): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">istio.example.com A ${GATEWAY_IP} *.istio.example.com A ${GATEWAY_IP}</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุญูู ูู ุฃู ุญุฑู ุงูุจุฏู DNS ูุนูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">watch host test.istio.example.com</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุจุฅูุดุงุก ุจูุงุจุฉ Istio ูุดุชุฑูุฉ ูุชูุฏูู ุฎุฏูุงุช ุฎุงุฑุฌ ุดุจูุฉ ุงูุฎุฏูุฉ ุนุจุฑ HTTP: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: public-gateway namespace: istio-system spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - "*"</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงุญูุธ ุงูููุฑุฏ ุฃุนูุงู ูู public-gateway.yaml ุซู ูู ุจุชุทุจููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl apply -f ./public-gateway.yaml</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุง ููุจุบู ุฃู ูููุฑ ุฃู ูุธุงู ุฅูุชุงุฌ ุฎุฏูุงุช ุนูู ุงูุฅูุชุฑูุช ุจุฏูู ุทุจูุฉ ุงูููุงุจุณ ุงูุขููุฉ.  ูุญูุงูุฉ ุจูุงุจุฉ Istio ูุน ูุฏูุฑ ุงูุดูุงุฏุงุช ุ CloudDNS ุ ู Let's Encrypt ุ ูุฑุฌู ูุฑุงุกุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุซุงุฆู</a> Flagger GKE. </p><br><h3 id="ustanovka-flagger" style=";text-align:right;direction:rtl">  ุชุฑููุจ ุงูุฑุงูุฉ </h3><br><p style=";text-align:right;direction:rtl">  ูุง ุชุชุถูู ุงููุธููุฉ ุงูุฅุถุงููุฉ ูู GKE Istio ูุซูู ุจุฑูููุซููุณ ุงูุฐู ููุธู ุฎุฏูุฉ ุงูููุงุณ ุนู ุจูุนุฏ Istio.  ูุธุฑูุง ูุฃู Flagger ูุณุชุฎุฏู ููุงููุณ Istio HTTP ูุฅุฌุฑุงุก ุชุญููู ุงูููุงุฑู ุ ูุฃูุช ุจุญุงุฌุฉ ุฅูู ูุดุฑ ุชูููู Prometheus ุงูุชุงูู ูุดุงุจู ููุชูููู ุงูููุฏู ูุน ูุฎุทุท Istio Helm ุงูุฑุณูู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">REPO=https://raw.githubusercontent.com/stefanprodan/flagger/master kubectl apply -f ${REPO}/artifacts/gke/istio-prometheus.yaml</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃุถู ูุณุชูุฏุน Flag Flag Helm: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">helm repo add flagger https://flagger.app</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุจุชูุณูุน <code>istio-system</code> ุชูููู ุฅุนูุงูุงุช Slack: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">helm upgrade -i flagger flagger/flagger \ --namespace=istio-system \ --set metricsServer=http://prometheus.istio-system:9090 \ --set slack.url=https://hooks.slack.com/services/YOUR-WEBHOOK-ID \ --set slack.channel=general \ --set slack.user=flagger</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููููู ุชุซุจูุช Flagger ูู ุฃู ูุณุงุญุฉ ุงุณููุฉ ุฅุฐุง ูุงู ูููููุง ุงูุงุชุตุงู ุจุฎุฏูุฉ Istio Prometheus ูู ุฎูุงู ุงููููุฐ 9090. </p><br><p style=";text-align:right;direction:rtl">  Flagger ูุฏูู ููุญุฉ ุงูููุงุฏุฉ ุบุฑุงูุงูุง ูุชุญููู ุงูููุงุฑู.  ูู ุจุชุซุจูุช Grafana ูู <code>istio-system</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">helm upgrade -i flagger-grafana flagger/grafana \ --namespace=istio-system \ --set url=http://prometheus.istio-system:9090 \ --set user=admin \ --set password=change-me</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุจุชูุณูุน Grafana ูู ุฎูุงู ุจูุงุจุฉ ููุชูุญุฉ ุนู ุทุฑูู ุฅูุดุงุก ุฎุฏูุฉ ุงูุชุฑุงุถูุฉ (ุงุณุชุจุฏู <code>example.com</code> ุจูุทุงูู): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: grafana namespace: istio-system spec: hosts: - "grafana.istio.example.com" gateways: - public-gateway.istio-system.svc.cluster.local http: - route: - destination: host: flagger-grafana</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงุญูุธ ุงูููุฑุฏ ุฃุนูุงู ูู grafana-virtual-service.yaml ุซู ูู ุจุชุทุจููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl apply -f ./grafana-virtual-service.yaml</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูุฏูุง ุชุฐูุจ ุฅูู <code>http://grafana.istio.example.com</code> ูู ูุชุตูุญ ุ ูุฌุจ ุชูุฌููู ุฅูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู Grafana. </p><br><h3 id="deploy-veb-prilozheniy-s-flagger" style=";text-align:right;direction:rtl">  ูุดุฑ ุชุทุจูู ุงูููุจ ูุน Flagger </h3><br><p style=";text-align:right;direction:rtl">  ููุดุฑ Flagger Kubernetes ุ ูุฅุฐุง ูุฒู ุงูุฃูุฑ ุ ุงูุชุญุฌูู ุงูุชููุงุฆู ุงูุฃููู (HPA) ุ ุซู ูุฎูู ุณูุณูุฉ ูู ุงููุงุฆูุงุช (ูุดุฑ Kubernetes ุ ุฎุฏูุงุช ClusterIP ูุงูุฎุฏูุงุช ุงูุงูุชุฑุงุถูุฉ Istio).  ุชูุชุญ ูุฐู ุงููุงุฆูุงุช ุงูุชุทุจูู ูู ุดุจูุฉ ุงูุฎุฏูุฉ ูุฅุฏุงุฑุฉ ุชุญููู ุงูููุงุฑู ูุงูุชุฑููุฌ ูู. </p><br><p style=";text-align:right;direction:rtl"> <a href=""><img src="https://habrastorage.org/webt/la/cg/h5/lacgh59saaxevwtpgoiby77xe7u.png"></a> </p><br><p style=";text-align:right;direction:rtl">  ุฅูุดุงุก ูุณุงุญุฉ ุงุณู ุงุฎุชุจุงุฑ ูุน ุชูููู ุชุทุจูู Istio Sidecar: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">REPO=https://raw.githubusercontent.com/stefanprodan/flagger/master kubectl apply -f ${REPO}/artifacts/namespaces/test.yaml</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุจุฅูุดุงุก ุฃุฏุงุฉ ูุดุฑ ุฃูููุฉ ุชููุงุฆูุฉ ููุดุฑ ููุดุฑูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl apply -f ${REPO}/artifacts/canaries/deployment.yaml kubectl apply -f ${REPO}/artifacts/canaries/hpa.yaml</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุดุฑ ุฎุฏูุฉ ุชุญููู ุงุฎุชุจุงุฑ ูุฅูุดุงุก ุญุฑูุฉ ุงููุฑูุฑ ุฃุซูุงุก ุชุญููู ุงูููุงุฑู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">helm upgrade -i flagger-loadtester flagger/loadtester \ --namepace=test</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุจุฅูุดุงุก ููุฑุฏ ููุงุฑู ูุฎุตุต ( <code>example.com</code> ุจูุทุงูู): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">apiVersion: flagger.app/v1alpha3 kind: Canary metadata: name: podinfo namespace: test spec: targetRef: apiVersion: apps/v1 kind: Deployment name: podinfo progressDeadlineSeconds: 60 autoscalerRef: apiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler name: podinfo service: port: 9898 gateways: - public-gateway.istio-system.svc.cluster.local hosts: - app.istio.example.com canaryAnalysis: interval: 30s threshold: 10 maxWeight: 50 stepWeight: 5 metrics: - name: istio_requests_total threshold: 99 interval: 30s - name: istio_request_duration_seconds_bucket threshold: 500 interval: 30s webhooks: - name: load-test url: http://flagger-loadtester.test/ timeout: 5s metadata: cmd: "hey -z 1m -q 10 -c 2 http://podinfo.test:9898/"</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงุญูุธ ุงูููุฑุฏ ุฃุนูุงู ูู podinfo-canary.yaml ุซู ูู ุจุชุทุจููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl apply -f ./podinfo-canary.yaml</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุณูุชู ุชูููุฐ ุงูุชุญููู ุฃุนูุงู ุ ุฅุฐุง ูุฌุญ ุ ูู ุบุถูู ุฎูุณ ุฏูุงุฆู ุ ูุน ูุญุต ููุงุณุงุช HTTP ูู ูุตู ุฏูููุฉ.  ููููู ุชุญุฏูุฏ ุงูุญุฏ ุงูุฃุฏูู ูู ุงูููุช ุงููุงุฒู ููุชุญูู ูู ูุดุฑ ุงูููุงุฑู ูุงูุชุฑููุฌ ูู ุจุงุณุชุฎุฏุงู ุงูุตูุบุฉ ุงูุชุงููุฉ: <code>interval * (maxWeight / stepWeight)</code> .  ุชู ุชูุซูู ุญููู ุงูููุงุฑู CRD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> . </p><br><p style=";text-align:right;direction:rtl">  ูู ุจุถุน ุซูุงูู ุ ุณููุดุฆ Flagger ูุงุฆูุงุช ุงูููุงุฑู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># applied deployment.apps/podinfo horizontalpodautoscaler.autoscaling/podinfo canary.flagger.app/podinfo # generated deployment.apps/podinfo-primary horizontalpodautoscaler.autoscaling/podinfo-primary service/podinfo service/podinfo-canary service/podinfo-primary virtualservice.networking.istio.io/podinfo</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุชุญ ูุชุตูุญูุง <code>app.istio.example.com</code> ุฅูู <code>app.istio.example.com</code> ุ ุณุชุฑู ุฑูู ุฅุตุฏุงุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุชุทุจูู ุงูุชุฌุฑูุจู</a> . </p><br><h3 id="avtomaticheskiy-canary-analiz-i-prodvizhenie" style=";text-align:right;direction:rtl">  ุชุญููู ุงูููุงุฑู ุงูุชููุงุฆู ูุงูุชุฑููุฌ </h3><br><p style=";text-align:right;direction:rtl">  ูููุฐ Flagger ุญููุฉ ุชุญูู ุชููู ุญุฑูุฉ ุงููุฑูุฑ ุชุฏุฑูุฌูุงู ุฅูู ุงูููุงุฑู ุ ูุน ููุงุณ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ ุ ุนูู ุณุจูู ุงููุซุงู ุ ูุนุฏู ูุฌุงุญ ุทูุจุงุช HTTP ููุชูุณุท โโูุฏุฉ ุงูุทูุจ ูุฃุฏุงุก ูุจุถุงุช ุงูููุจ.  ุจูุงุกู ุนูู ุงูุชุญููู ุ ุชูุฏู KPI canary ุฃู ุชูุช ููุงุทุนุชู ุ ููุชู ูุดุฑ ูุชุงุฆุฌ ุงูุชุญููู ูู Slack. </p><br><p style=";text-align:right;direction:rtl"> <a href=""><img src="https://habrastorage.org/webt/bw/85/ua/bw85uavib13od3yhfyv7yaqbdmo.png"></a> </p><br><p style=";text-align:right;direction:rtl">  ูุจุฏุฃ ูุดุฑ ุงูููุงุฑู ุนูุฏูุง ูุชุบูุฑ ุฃุญุฏ ุงููุงุฆูุงุช ุงูุชุงููุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุดุฑ PodSpec (ุตูุฑุฉ ุงูุญุงููุฉ ุ ุงูุฃูุฑ ุ ุงูููุงูุฐ ุ env ุ ุฅูุฎ.) </li><li style=";text-align:right;direction:rtl">  ูุชู ุชูููู ConfigMaps ููุญุฏุงุช ุชุฎุฒูู ุฃู ุชุญููููุง ุฅูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ </li><li style=";text-align:right;direction:rtl">  ูุชู ุชุซุจูุช ุงูุฃุณุฑุงุฑ ููุญุฏุงุช ุชุฎุฒูู ุฃู ุชุญููููุง ุฅูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ </li></ul><br><p style=";text-align:right;direction:rtl">  ุจุฏุก ูุดุฑ ุงูููุงุฑู ุนูุฏ ุชุญุฏูุซ ุตูุฑุฉ ุงูุญุงููุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl -n test set image deployment/podinfo \ podinfod=quay.io/stefanprodan/podinfo:1.4.1</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุชุดู Flagger ุฃู ุฅุตุฏุงุฑ ุงููุดุฑ ูุฏ ุชุบูุฑ ุ ููุจุฏุฃ ูู ุชุญูููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl -n test describe canary/podinfo Events: New revision detected podinfo.test Scaling up podinfo.test Waiting for podinfo.test rollout to finish: 0 of 1 updated replicas are available Advance podinfo.test canary weight 5 Advance podinfo.test canary weight 10 Advance podinfo.test canary weight 15 Advance podinfo.test canary weight 20 Advance podinfo.test canary weight 25 Advance podinfo.test canary weight 30 Advance podinfo.test canary weight 35 Advance podinfo.test canary weight 40 Advance podinfo.test canary weight 45 Advance podinfo.test canary weight 50 Copying podinfo.test template spec to podinfo-primary.test Waiting for podinfo-primary.test rollout to finish: 1 of 2 updated replicas are available Promotion completed! Scaling down podinfo.test</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃุซูุงุก ุงูุชุญููู ุ ูููู ุชุชุจุน ูุชุงุฆุฌ ุงูููุงุฑู ุจุงุณุชุฎุฏุงู Grafana: </p><br><p style=";text-align:right;direction:rtl"> <a href=""><img src="https://habrastorage.org/webt/so/xr/cr/soxrcrt3wvsgtnbwpukfwbzityy.png"></a> </p><br><p style=";text-align:right;direction:rtl">  ูุฑุฌู ููุงุญุธุฉ: ุฅุฐุง ุชู ุชุทุจูู ุชุบููุฑุงุช ุฌุฏูุฏุฉ ุนูู ุงููุดุฑ ุฃุซูุงุก ุชุญููู ุงูููุงุฑู ุ ูุณุชุนูุฏ Flagger ูุฑุญูุฉ ุงูุชุญููู. </p><br><p style=";text-align:right;direction:rtl">  ูู ุจุนูู ูุงุฆูุฉ ุจุฌููุน "ุงูููุงุฑู" ูู ูุฌููุนุชู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">watch kubectl get canaries --all-namespaces NAMESPACE NAME STATUS WEIGHT LASTTRANSITIONTIME test podinfo Progressing 15 2019-01-16T14:05:07Z prod frontend Succeeded 0 2019-01-15T16:15:07Z prod backend Failed 0 2019-01-14T17:05:07Z</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ููุช ุจุชูููู ุฅุนูุงูุงุช Slack ุ ูุณุชุชููู ุงูุฑุณุงุฆู ุงูุชุงููุฉ: </p><br><p style=";text-align:right;direction:rtl"> <a href=""><img src="https://habrastorage.org/webt/xx/0v/cn/xx0vcnpcarb8nb3xivkmfz_6pfw.png"></a> </p><br><h3 id="avtomaticheskiy-otkat" style=";text-align:right;direction:rtl">  ุงูุชุฑุงุฌุน ุงูุชููุงุฆู </h3><br><p style=";text-align:right;direction:rtl">  ุฃุซูุงุก ุชุญููู ุงูููุงุฑู ุ ููููู ุฅูุดุงุก ุฃุฎุทุงุก HTTP 500 ุงุตุทูุงุนูุฉ ูุชุฃุฎูุฑ ุงุณุชุฌุงุจุฉ ุนุงููุฉ ููุชุญูู ููุง ุฅุฐุง ูุงู ุจุฑูุงูุฌ Flagger ุณูููู ุงููุดุฑ ุฃู ูุง. </p><br><p style=";text-align:right;direction:rtl">  ูู ุจุฅูุดุงุก ุงุฎุชุจุงุฑ ูุฑุนู ููู ุจูุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl -n test run tester \ --image=quay.io/stefanprodan/podinfo:1.2.1 \ -- ./podinfo --port=9898 kubectl -n test exec -it tester-xx-xx sh</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฎุทุฃ HTTP 500 ุงูุฌูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">watch curl http://podinfo-canary:9898/status/500</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุฃุฎูุฑ ุงูุฌูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">watch curl http://podinfo-canary:9898/delay/1</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูุฏูุง ูุตู ุนุฏุฏ ุนูููุงุช ุงูุชุญูู ุบูุฑ ุงููุงุฌุญุฉ ุฅูู ูููุฉ ุงูุนุชุจุฉ ุ ูุชู ุชูุฌูู ุญุฑูุฉ ุงููุฑูุฑ ูุฑุฉ ุฃุฎุฑู ุฅูู ุงูููุงุฉ ุงูุฃุณุงุณูุฉ ุ ููุชู ุชุบููุฑ ุญุฌู ุงูููุงุฑู ุฅูู ุตูุฑ ุ ููุชู ูุถุน ุนูุงูุฉ ุนูู ุงููุดุฑ ุบูุฑ ุงููุงุฌุญ. </p><br><p style=";text-align:right;direction:rtl">  ูุชู ุชุณุฌูู ุฃุฎุทุงุก ุงูููุงุฑู ูููู ุงูุชุฃุฎูุฑ ูุฃุญุฏุงุซ Kubernetes ูุชุณุฌูููุง ุจูุงุณุทุฉ Flagger ุจุชูุณูู JSON: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">kubectl -n istio-system logs deployment/flagger -f | jq .msg Starting canary deployment for podinfo.test Advance podinfo.test canary weight 5 Advance podinfo.test canary weight 10 Advance podinfo.test canary weight 15 Halt podinfo.test advancement success rate 69.17% &lt; 99% Halt podinfo.test advancement success rate 61.39% &lt; 99% Halt podinfo.test advancement success rate 55.06% &lt; 99% Halt podinfo.test advancement success rate 47.00% &lt; 99% Halt podinfo.test advancement success rate 37.00% &lt; 99% Halt podinfo.test advancement request duration 1.515s &gt; 500ms Halt podinfo.test advancement request duration 1.600s &gt; 500ms Halt podinfo.test advancement request duration 1.915s &gt; 500ms Halt podinfo.test advancement request duration 2.050s &gt; 500ms Halt podinfo.test advancement request duration 2.515s &gt; 500ms Rolling back podinfo.test failed checks threshold reached 10 Canary failed! Scaling down podinfo.test</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ููุช ุจุชูููู ุฅุนูุงูุงุช Slack ุ ูุณุชุชููู ุฑุณุงูุฉ ุนูุฏ ุงููุตูู ุฅูู ุงูููุนุฏ ุงูููุงุฆู ุฃู ุนูุฏ ุงููุตูู ุฅูู ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุนูููุงุช ุงูุชุญูู ุงููุงุดูุฉ ุฃุซูุงุก ุงูุชุญููู: </p><br><p style=";text-align:right;direction:rtl"> <a href=""><img src="https://habrastorage.org/webt/wo/te/dq/wotedqdhoxxyhjug_lcuy57wno0.png"></a> </p><br><h3 id="v-zaklyuchenie" style=";text-align:right;direction:rtl">  ูู ุงูุฎุชุงู </h3><br><p style=";text-align:right;direction:rtl">  ุณูุคุฏู ุชุดุบูู ุดุจูุฉ ุฎุฏูุฉ ุ ูุซู Istio ุ ุจุงูุฅุถุงูุฉ ุฅูู Kubernetes ุ ุฅูู ุชูููุฑ ููุงููุณ ูุณุฌูุงุช ูุจุฑูุชููููุงุช ุชููุงุฆูุฉ ุ ูููู ูุดุฑ ุฃุญูุงู ุงูุนูู ูุง ูุฒุงู ูุนุชูุฏ ุนูู ุงูุฃุฏูุงุช ุงูุฎุงุฑุฌูุฉ.  ุชุณุนู ุดุฑูุฉ Flagger ุฅูู ุชุบููุฑ ูุฐุง ูู ุฎูุงู ุฅุถุงูุฉ ุฅููุงูุงุช <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุชุณููู ุงูุชุฏุฑูุฌู</a> ูู Istio. </p><br><p style=";text-align:right;direction:rtl">  ูุชูุงูู ุจุฑูุงูุฌ Flagger ูุน ุฃู ุญู Kubernetes CI / CD ุ ููููู ุชูุฏูุฏ ุชุญููู ุงูููุงุฑู ุจุณูููุฉ ุจุงุณุชุฎุฏุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุตูุญุงุช ุงูููุจ</a> ูุฅุฌุฑุงุก ุงุฎุชุจุงุฑุงุช ุชูุงูู / ูุจูู ุงููุธุงู ุฃู ุงุฎุชุจุงุฑุงุช ุงูุฅุฌูุงุฏ ุฃู ุฃู ุงุฎุชุจุงุฑุงุช ูุณุชุฎุฏู ุฃุฎุฑู.  ูุธุฑูุง ูุฃู Flagger ูู ุฅุนูุงู ูุณุฑูุน ุงูุงุณุชุฌุงุจุฉ ูุฃุญุฏุงุซ Kubernetes ุ ูููู ุงุณุชุฎุฏุงูู ุนูู ุฎุทูุท ุฃูุงุจูุจ GitOps ูุน <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Weave Flux</a> ุฃู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">JenkinsX</a> .  ุฅุฐุง ููุช ุชุณุชุฎุฏู JenkinsX ุ ูููููู ุชุซุจูุช Flagger ูุน ุงููุธุงุฆู ุงูุฅุถุงููุฉ jx. </p><br><p style=";text-align:right;direction:rtl">  ูุชู ุฏุนู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Flagger</a> ุจูุงุณุทุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Weaveworks</a> ููููุฑ ูุดุฑุงุช ุงูููุงุฑู ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Weave Cloud</a> .  ูุชู ุงุฎุชุจุงุฑ ุงููุดุฑูุน ุนูู GKE ุ EX ูุงููุนุงุฏู ุงูุนุงุฑูุฉ ูุน kubeadm. </p><br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูุงู ูุฏูู ุฃู ุงูุชุฑุงุญุงุช ูุชุญุณูู Flagger ุ ููุฑุฌู ุฅุฑุณุงู ุณุคุงู ุฃู PR ุฅูู GitHub ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">stefanprodan / flagger</a> .  ุงููุณุงููุงุช ุฃูุซุฑ ูู ููุถุน ุชุฑุญูุจ! </p><br><p style=";text-align:right;direction:rtl">  ุดูุฑุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฑุงู ุชุณุงูุบ</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar444808/">https://habr.com/ru/post/ar444808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar444796/index.html">ุงูููุฏุณุฉ ุงูุนูุณูุฉ ููุฌุฑุงุฑ: ููููุฉ ุชุณุฑูุน ุนูููุฉ ุงูููุงุณ ุจููุฏุงุฑ ุงููุตู</a></li>
<li><a href="../ar444798/index.html">ูุธุฑุฉ ุนุงูุฉ ุนูู ูุณู Frontend ูู ูุคุชูุฑ DUMP: ุชุทููุฑ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุจุงููุงูู</a></li>
<li><a href="../ar444800/index.html">ุงููุตุฏุฑ ุงูููุชูุญ ูุง ููุณุจ ุงููุงู ุ ูุฃูู ูู ูุชู ุฅูุดุงุคู ููุฐุง ุงูุบุฑุถ</a></li>
<li><a href="../ar444804/index.html">ุดุฑูุฉ ุชุจุงุฏู BTC-e ุชุทูุจ ุชุณููููุง ุฅูู ุฑูุณูุง</a></li>
<li><a href="../ar444806/index.html">ูุดุงุฑู Moira ูู Google Summer of Code 2019</a></li>
<li><a href="../ar444810/index.html">ุงููุนุงูุฌุงุช ูุงูุชุณููู ูู ุชูููููุฌูุง ุงูููุจููุชุฑ</a></li>
<li><a href="../ar444814/index.html">ุงูุชุดููุฑ ูู ุฌุงูุง. ุงูุทุจูุฉ ุงูุดูุฑุงุช</a></li>
<li><a href="../ar444816/index.html">DIY ุงููุฌุงุฑุฉ: ุงูุชููุนุงุช ูุงููุงูุน</a></li>
<li><a href="../ar444818/index.html">Citymobil - ุฏููู ููุดุฑูุงุช ุงููุงุดุฆุฉ ูุฒูุงุฏุฉ ุงูุงุณุชูุฑุงุฑ ูุณุท ุงูููู. ุงูุฌุฒุก 1</a></li>
<li><a href="../ar444820/index.html">Mockdown: ุฃุณุฑุน ุทุฑููุฉ ูุฅูุดุงุก ุฅุทุงุฑุงุช ุณูููุฉ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>