<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéñÔ∏è üëì üÄÑÔ∏è Interacteur, mod√®le d'op√©ration üíã üê• üßìüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ce texte est une adaptation d'une partie du manuel du framework Hanami pour le framework Laravel. Qu'est-ce qui a suscit√© l'int√©r√™t pour ce mat√©riau p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Interacteur, mod√®le d'op√©ration</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438052/"><p>  Ce texte est une adaptation d'une partie du manuel du framework Hanami pour le framework Laravel.  Qu'est-ce qui a suscit√© l'int√©r√™t pour ce mat√©riau particulier?  Il fournit une description √©tape par √©tape avec une d√©monstration de choses courantes pour les langages de programmation et les frameworks tels que: </p><br><ul><li>  Utilisation du mod√®le Interactors. </li><li>  D√©monstration de TDD \ BDD. </li></ul><br><p>  Il convient de noter tout de suite qu'il ne s'agit pas seulement de cadres diff√©rents avec des id√©ologies diff√©rentes (en particulier, en ce qui concerne l'ORM), mais √©galement de langages de programmation diff√©rents, chacun ayant sa propre culture sp√©cifique et des "meilleures pratiques" √©tablies pour des raisons historiques.  Diff√©rents langages et frameworks de programmation ont tendance √† emprunter les solutions les plus efficaces les uns aux autres, par cons√©quent, malgr√© les diff√©rences de d√©tails, les choses fondamentales ne diff√®rent pas, √† moins bien s√ªr que nous prenions PL avec un paradigme initialement diff√©rent.  Il est assez int√©ressant de comparer comment un m√™me probl√®me est r√©solu dans diff√©rents √©cosyst√®mes. </p><br><p>  Donc, au d√©part, nous avons le framework Hanami (ruby) - un framework assez nouveau qui gravite id√©ologiquement davantage vers Symfony, avec ORM "sur les r√©f√©rentiels".  Et le framework Laravel \ Lumen (php) cible avec Active Record. </p><a name="habracut"></a><br><p>  En cours d'adaptation, les angles les plus aigus ont √©t√© coup√©s: </p><br><ul><li>  La premi√®re partie du guide a √©t√© omise avec l'initialisation du projet, une description des caract√©ristiques du cadre et des choses sp√©cifiques similaires. </li><li>  ORM Eloquent est tir√© sur le globe et sert √©galement de r√©f√©rentiel. </li><li>  √âtapes pour g√©n√©rer du code et des mod√®les pour l'envoi d'e-mails. </li></ul><br><p>  Enregistr√© et soulign√© sur: </p><br><ul><li>  Interacteurs - une impl√©mentation minimale appropri√©e a √©t√© effectu√©e sur l'interface. </li><li>  Tests, d√©veloppement pas √† pas via TDD. </li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La premi√®re partie du tutoriel Hanami original auquel le texte sera li√©</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Texte original du didacticiel interactif</a> <br>  Lien vers le r√©f√©rentiel avec du code php adapt√© √† la fin du texte. </p><br><h3 id="interaktory">  Interacteurs </h3><br><h4 id="novaya-ficha-uvedomleniya-po-elektronnoy-pochte">  Nouvelle fonctionnalit√©: Notifications par e-mail </h4><br><p>  Sc√©nario de fonctionnalit√©: En tant qu'administrateur, lorsque j'ajoute un livre, je souhaite recevoir des notifications par e-mail. </p><br><p>  √âtant donn√© que l'application n'a pas d'authentification, tout le monde peut ajouter un nouveau livre.  Nous sp√©cifierons l'adresse e-mail de l'administrateur via des variables d'environnement. </p><br><p>  Ceci est juste un exemple montrant quand utiliser des interacteurs, et en particulier comment utiliser l'interacteur Hanami. </p><br><p>  <em>Cet exemple peut servir de base √† d'autres fonctions, telles que la confirmation par l'administrateur de nouveaux livres avant leur publication.</em>  <em>Ou en donnant aux utilisateurs la possibilit√© de sp√©cifier une adresse e-mail pour modifier le livre via un lien sp√©cial.</em> </p><br><p>  En pratique, vous pouvez utiliser des interacteurs pour impl√©menter toute logique m√©tier abstraite de la couche r√©seau.  Ceci est particuli√®rement utile lorsque vous souhaitez combiner plusieurs √©l√©ments afin de contr√¥ler la complexit√© de la base de code. </p><br><p>  Ils sont utilis√©s pour isoler une logique m√©tier non triviale selon le principe de responsabilit√© unique. </p><br><p>  Dans les applications Web, ils sont g√©n√©ralement utilis√©s √† partir des actions du contr√¥leur.  De cette fa√ßon, vous s√©parez les t√¢ches, les objets de logique m√©tier et les interacteurs; ils ne savent rien de la couche r√©seau de l'application. </p><br><h4 id="kolbeki-oni-nam-ne-nuzhny">  Rappels?  Nous n'en avons pas besoin! </h4><br><p>  La fa√ßon la plus simple de mettre en ≈ìuvre une notification par e-mail consiste √† ajouter un rappel. </p><br><p>  Autrement dit, apr√®s avoir cr√©√© une nouvelle entr√©e de livre dans la base de donn√©es, un e-mail est envoy√©. </p><br><p>  Sur le plan architectural, Hanami ne propose pas un tel m√©canisme.  En effet, nous consid√©rons les rappels de mod√®le comme un anti-mod√®le.  Ils violent le principe de la responsabilit√© exclusive.  Dans notre cas, ils m√©langent incorrectement la couche de persistance avec les notifications par e-mail. </p><br><p>  Pendant les tests (et tr√®s probablement dans certains autres cas), vous souhaiterez ignorer le rappel.  Cela est rapidement d√©routant, car plusieurs rappels pour un m√™me √©v√©nement peuvent √™tre d√©clench√©s dans un ordre sp√©cifique.  De plus, vous pouvez ignorer certains rappels.  Les rappels rendent le code fragile et difficile √† comprendre. </p><br><p>  Au lieu de cela, nous recommandons explicite, au lieu d'implicite. </p><br><p>  Un interacteur est un objet qui repr√©sente un cas d'utilisation sp√©cifique. </p><br><p>  Ils permettent √† chaque classe d'avoir une seule responsabilit√©.  La seule responsabilit√© de l'interacteur est de combiner les objets et les appels de m√©thode pour obtenir un r√©sultat sp√©cifique. </p><br><h4 id="ideya">  Id√©e </h4><br><p>  L'id√©e principale des interacteurs est d'extraire les parties isol√©es de la fonctionnalit√© dans une nouvelle classe. </p><br><p> Vous ne devez √©crire que deux m√©thodes publiques: <code>__construct</code> et <code>call</code> . <br>  <em>Dans l'impl√©mentation php de l'interacteur, la m√©thode call a le modificateur protected et est appel√©e via <code>__invoke</code> .</em> </p><br><p>  Cela signifie que ces objets sont faciles √† interpr√©ter, car il n'y a qu'une seule m√©thode disponible pour les utiliser. </p><br><p>  Le comportement d'encapsulation dans un objet facilite le test.  Il facilite √©galement la compr√©hension de votre base de code, et ne laisse pas simplement la complexit√© cach√©e implicitement. </p><br><h4 id="podgotovka">  La pr√©paration </h4><br><p>  Supposons que nous ayons notre application Bookshelf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Getting Started</a> ¬ª et que nous voulons ajouter la fonction ¬´notification par e-mail pour le livre ajout√©¬ª. </p><br><h4 id="pishem-interaktor">  √âcrire un interacteur </h4><br><p>  Cr√©ons un dossier pour nos interacteurs et un dossier pour leurs tests: </p><br><pre> <code class="plaintext hljs">$ mkdir lib/bookshelf/interactors $ mkdir tests/bookshelf/interactors</code> </pre> <br><p>  Nous les mettons dans <code>lib/bookshelf</code> car ils ne sont pas li√©s √† l'application web.  Vous pouvez ajouter des livres ult√©rieurement via le portail d'administration, l'API ou m√™me un utilitaire de ligne de commande. </p><br><p>  Ajoutez l'interacteur <code>AddBook</code> et √©crivez un nouveau test <code>tests/bookshelf/interactors/AddBookTest.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># tests/bookshelf/interactors/AddBookTest.php &lt;?php use Lib\Bookshelf\Interactors\AddBook; class AddBookTest extends TestCase { private function interactor() { return $this-&gt;app-&gt;make(AddBook::class); } private function bookAttributes() { return [ "author" =&gt; "James Baldwin", 'title' =&gt; "The Fire Next Time", ]; } private function subjectCall() { return $this-&gt;interactor()($this-&gt;bookAttributes()); } public function testSucceeds() { $result = $this-&gt;subjectCall(); $this-&gt;assertTrue($result-&gt;successful()); } }</span></span></code> </pre><br><p>  L'ex√©cution d'une suite de tests <code>AddBook</code> erreur de <code>Class does not exist</code> car il n'y a pas de classe <code>AddBook</code> .  Cr√©ons cette classe dans le fichier <code>lib/bookshelf/interactors/AddBook.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddBook</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Il n'y a que deux m√©thodes que cette classe doit contenir: <code>__construct</code> pour d√©finir les donn√©es et <code>call</code> pour impl√©menter le script. </p><br><p>  Ces m√©thodes, en particulier <code>call</code> , doivent appeler des m√©thodes priv√©es que vous √©crivez. </p><br><p>  Par d√©faut, le r√©sultat est consid√©r√© comme r√©ussi, car nous n'avons pas indiqu√© explicitement que l'op√©ration a √©chou√©. </p><br><p>  Lan√ßons le test: </p><br><pre> <code class="plaintext hljs">$ phpunit</code> </pre> <br><p>  Tous les tests doivent r√©ussir! </p><br><p>  Maintenant, faisons que notre interacteur <code>AddBook</code> fasse vraiment quelque chose! </p><br><h3 id="sozdanie-knigi">  Cr√©ation de livre </h3><br><p>  Modifier les <code>tests/bookshelf/interactors/AddBookTest.php</code> : </p><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCreateBook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;subjectCall(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"The Fire Next Time"</span></span>, $result-&gt;book-&gt;title); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"James Baldwin"</span></span>, $result-&gt;book-&gt;author); }</code> </pre> <br><p>  Si vous ex√©cutez des tests <code>phpunit</code> , vous verrez une erreur: </p><br><pre> <code class="plaintext hljs">Exception: Undefined property Lib\Interactor\InteractorResult::$book</code> </pre> <br><p>  Remplissons notre interacteur, puis expliquons ce que nous avons fait: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Book</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddBook</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $expose = [<span class="hljs-string"><span class="hljs-string">"book"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $book = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book($bookAttributes); } }</code> </pre> <br><p>  Deux choses importantes √† noter ici: </p><br><p>  Cha√Æne <code>protected static $expose = ["book"];</code>  Ajoute la propri√©t√© <code>book</code> √† l'objet de r√©sultat qui sera renvoy√© lors de l'appel de l'interacteur. </p><br><p>  La m√©thode d' <code>call</code> affecte le mod√®le <code>Book</code> √† la propri√©t√© <code>book</code> , qui sera disponible en cons√©quence. </p><br><p>  Maintenant, les tests devraient r√©ussir. </p><br><p>  Nous avons initialis√© le mod√®le <code>Book</code> , mais il n'est pas stock√© dans la base de donn√©es. </p><br><h4 id="sohranenie-knigi">  Livre de sauvegarde </h4><br><p>  Nous avons un nouveau livre, obtenu √† partir du titre et de l'auteur, mais il n'est pas encore dans la base de donn√©es. </p><br><p>  Nous devons utiliser notre <code>BookRepository</code> pour le sauvegarder. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/bookshelf/interactors/AddBookTest.php public function testPersistsBook() { $result = $this-&gt;subjectCall(); $this-&gt;assertNotNull($result-&gt;book-&gt;id); }</span></span></code> </pre> <br><p>  Si vous ex√©cutez les tests, vous verrez une nouvelle erreur avec le message <code>Failed asserting that null is not null</code> . </p><br><p>  C'est parce que le livre que nous avons cr√©√© n'a pas d'identifiant, car il ne le recevra que lorsqu'il sera enregistr√©. </p><br><p>  Pour que le test r√©ussisse, nous devons cr√©er un livre enregistr√©.  Une autre fa√ßon, non moins correcte, est de sauvegarder le livre que nous avons d√©j√†. </p><br><p>  Modifiez la m√©thode d' <code>call</code> dans le <code>lib/bookshelf/interactors/AddBook.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = Book::create($bookAttributes); }</code> </pre> <br><p>  Au lieu d'appeler <code>new Book</code> , nous faisons <code>Book::create</code> avec les attributs du livre. </p><br><p>  La m√©thode renvoie toujours le livre et enregistre √©galement cet enregistrement dans la base de donn√©es. </p><br><p>  Si vous ex√©cutez les tests maintenant, vous verrez que tous les tests r√©ussissent. </p><br><h4 id="vnedrenie-zavisimostey-dependency-injection">  Injection de d√©pendance </h4><br><p>  Refactorisons l'utilisation de l'injection de d√©pendance. </p><br><p>  Les tests fonctionnent toujours, mais ils d√©pendent des caract√©ristiques de l'enregistrement dans la base de donn√©es (la propri√©t√© id est d√©termin√©e apr√®s un enregistrement r√©ussi).  Il s'agit d'un d√©tail de mise en ≈ìuvre du fonctionnement de la conservation.  Par exemple, si vous souhaitez cr√©er un UUID avant de l'enregistrer et indiquer que l'enregistrement a r√©ussi d'une autre mani√®re que de remplir la colonne id, vous devrez modifier ce test. </p><br><p>  Nous pouvons modifier notre test et l'interacteur pour le rendre plus fiable: il sera moins sujet aux ruptures en raison de modifications ext√©rieures √† son fichier. </p><br><p>  Voici comment nous pouvons utiliser l'injection de d√©pendance dans l'interacteur: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// lib/bookshelf/interactors/AddBook.php public function __construct(Book $repository) { $this-&gt;repository = $repository; } protected function call($bookAttributes) { $this-&gt;book = $this-&gt;repository-&gt;create($bookAttributes); }</span></span></code> </pre> <br><p>  Essentiellement, c'est la m√™me chose, avec un peu plus de code, pour cr√©er une propri√©t√© de <code>repository</code> . </p><br><p>  √Ä l'heure actuelle, le test v√©rifie le comportement de la m√©thode <code>create</code> pour s'assurer que son identifiant est rempli avec <code>$this-&gt;assertNotNull($result-&gt;book-&gt;id)</code> . </p><br><p>  Il s'agit d'un d√©tail d'impl√©mentation. </p><br><p>  Au lieu de cela, nous pouvons modifier le test pour nous assurer simplement que la m√©thode <code>create</code> √©t√© appel√©e sur le r√©f√©rentiel et pour avoir confiance que le r√©f√©rentiel enregistrera l'objet (puisque c'est sa responsabilit√©). </p><br><p>  <code>testPersistsBook</code> test <code>testPersistsBook</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/bookshelf/interactors/AddBookTest.php public function testPersistsBook() { $repository = Mockery::mock(Book::class); $this-&gt;app-&gt;instance(Book::class, $repository); $attributes = [ "author" =&gt; "James Baldwin", 'title' =&gt; "The Fire Next Time", ]; $repository-&gt;expects()-&gt;create($attributes); $this-&gt;subjectCall($attributes); }</span></span></code> </pre> <br><p>  Maintenant, notre test ne viole pas les limites de sa zone. </p><br><p>  Tout ce que nous avons fait a √©t√© d'ajouter la d√©pendance de l'interacteur sur le r√©f√©rentiel. </p><br><h4 id="uvedomlenie-na-elektronnuyu-pochtu">  Notification par e-mail </h4><br><p>  Ajoutons une notification par e-mail! </p><br><p>  <em>Vous pouvez √©galement faire n'importe quoi ici, par exemple, envoyer un SMS, envoyer un message de discussion ou activer un raccordement Web.</em> </p><br><p>  Nous laisserons le corps du message vide, mais dans le champ sujet, nous indiquerons ¬´Livre ajout√©!¬ª. </p><br><p>  Cr√©ez un test de notification <code>tests/bookshelf/mail/BookAddedNotificationTest.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>\<span class="hljs-title"><span class="hljs-title">BookAddedNotification</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Support</span></span>\<span class="hljs-title"><span class="hljs-title">Facades</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BookAddedNotificationTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::setUp(); Mail::fake(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAddedNotification(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCorrectAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;build(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'no-reply@example.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;from[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'admin@example.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;to[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'Book added!'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;subject); } }</code> </pre> <br><p>  Ajoutez la classe de notification <code>lib/Bookshelf/Mail/BookAddedNotification.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>\<span class="hljs-title"><span class="hljs-title">Mailable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BookAddedNotification</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mailable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;from(<span class="hljs-string"><span class="hljs-string">'no-reply@example.com'</span></span>) -&gt;to(<span class="hljs-string"><span class="hljs-string">'admin@example.com'</span></span>) -&gt;subject(<span class="hljs-string"><span class="hljs-string">'Book added!'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view(<span class="hljs-string"><span class="hljs-string">'emails.book_added_notification'</span></span>); } }</code> </pre> <br><p>  Maintenant, tous nos tests r√©ussissent! </p><br><p>  Mais la notification n'est pas encore envoy√©e.  Nous devons appeler l'envoi depuis notre interacteur <code>AddBook</code> . </p><br><p>  <code>AddBook</code> test <code>AddBook</code> pour nous assurer que le mailer sera appel√©: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSendMail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Mail::fake(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;subjectCall(); Mail::assertSent(BookAddedNotification::class, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p>  Si nous ex√©cutons les tests, nous obtenons l'erreur: <code>The expected [Lib\Bookshelf\Mail\BookAddedNotification] mailable was sent 0 times instead of 1 times.</code>  . </p><br><p>  Maintenant, nous int√©grons l'envoi de notification dans l'interacteur. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Book $repository, BookAddedNotification $mail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;repository = $repository; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail = $mail; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;repository-&gt;create($bookAttributes); Mail::send(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail); }</code> </pre> <br><p>  En cons√©quence, l'interacteur enverra une notification concernant l'ajout du livre √† l'e-mail. </p><br><h4 id="integraciya-s-kontrollerom">  Int√©gration du contr√¥leur </h4><br><p>  Enfin, nous devons appeler l'interaction de l'action. </p><br><p>  Modifiez le fichier d'action <code>app/Http/Controllers/BooksCreateController.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>\<span class="hljs-title"><span class="hljs-title">AddBook</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BooksCreateController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Create a new controller instance. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AddBook $addBook)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBook = $addBook; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ $input = $request-&gt;all(); (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBook)($input); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-number"><span class="hljs-number">201</span></span>)); } }</code> </pre> <br><p>  Nos tests r√©ussissent, mais il y a un petit probl√®me. </p><br><p>  Nous testons le code de cr√©ation de livre deux fois. </p><br><p>  Il s'agit g√©n√©ralement d'une mauvaise pratique, et nous pouvons y rem√©dier en illustrant un autre avantage des interacteurs. </p><br><p>  Nous allons supprimer la mention sur <code>BookRepository</code> dans les tests et utiliser la maquette pour notre interacteur <code>AddBook</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>\<span class="hljs-title"><span class="hljs-title">AddBook</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BooksCreateControllerTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCallsInteractor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $attributes = [<span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1984'</span></span>, <span class="hljs-string"><span class="hljs-string">'author'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'George Orwell'</span></span>]; $addBook = Mockery::mock(AddBook::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;instance(AddBook::class, $addBook); $addBook-&gt;expects()-&gt;__invoke($attributes); $response = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;call(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/books'</span></span>, $attributes); } }</code> </pre> <br><p>  Maintenant, nos tests r√©ussissent et ils sont beaucoup plus fiables! </p><br><p>  L'action prend une entr√©e (√† partir des param√®tres de la requ√™te http) et appelle l'interacteur pour faire son travail.  La seule responsabilit√© de l'action est de travailler avec le r√©seau.  Et l'interaction fonctionne avec notre vraie logique m√©tier. </p><br><p>  Cela simplifie consid√©rablement les actions et leurs tests. </p><br><p>  Les actions sont pratiquement exempt√©es de la logique m√©tier. </p><br><p>  Lorsque nous modifions l'interacteur, nous n'avons plus besoin de changer l'action ou son test. </p><br><p>  <em>Notez que dans une application r√©elle, vous souhaiterez probablement faire plus que la logique ci-dessus, par exemple pour vous assurer que le r√©sultat est r√©ussi.</em>  <em>Et si une panne se produit, vous souhaiterez renvoyer des erreurs de l'interacteur.</em> </p><br><p>  <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">R√©f√©rentiel avec code</a></strong> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438052/">https://habr.com/ru/post/fr438052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438034/index.html">Android, Rx et Kotlin, ou comment faire r√©tr√©cir une griffe Lego. Partie 1</a></li>
<li><a href="../fr438036/index.html">3blue1brown et MIT en russe</a></li>
<li><a href="../fr438038/index.html">St√©ro√Ødes de carri√®re. Histoires vraies</a></li>
<li><a href="../fr438044/index.html">Analyse Hello World</a></li>
<li><a href="../fr438050/index.html">Filtre de Kalman pour minimiser la valeur d'entropie d'une erreur al√©atoire avec une distribution non gaussienne</a></li>
<li><a href="../fr438058/index.html">"Analyse des donn√©es en Python" en deux parties</a></li>
<li><a href="../fr438060/index.html">Estimation de l'orientation spatiale, ou Comment ne pas avoir peur des filtres Mahoney et Majwik</a></li>
<li><a href="../fr438062/index.html">Mon adresse n'est pas une maison ou une rue, mon adresse est l'Union sovi√©tique?</a></li>
<li><a href="../fr438064/index.html">Liste de contr√¥le: ce qui devait √™tre fait avant de d√©marrer les microservices dans prod</a></li>
<li><a href="../fr438066/index.html">10 cha√Ænes YouTube √©ducatives en anglais dont vous n'avez jamais entendu parler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>