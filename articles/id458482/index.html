<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐤 🐞 💃🏽 Bagian 3: Hampir memuat Linux dari kartu SD ke RocketChip 👉🏿 💗 🤙🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada bagian sebelumnya , pengendali memori yang bekerja kurang lebih diimplementasikan, atau lebih tepatnya, pembungkus IP Core dari Quartus, yang mer...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagian 3: Hampir memuat Linux dari kartu SD ke RocketChip</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458482/"><p><img src="https://habrastorage.org/webt/4j/fu/lu/4jfulumeapi32exqv7d6vnseaho.png" width="45%" align="left">  Pada bagian <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sebelumnya</a> , pengendali memori yang bekerja kurang lebih diimplementasikan, atau lebih tepatnya, pembungkus IP Core dari Quartus, yang merupakan adaptor untuk TileLink.  Hari ini, di bawah judul "Kami port RocketChip ke motherboard Cina yang sedikit dikenal dengan Cyclone", Anda akan melihat konsol yang berfungsi.  Proses berjalan sedikit: Saya sudah berpikir bahwa saya akan segera meluncurkan Linux, dan melanjutkan, tetapi tidak ada di sana.  Pada bagian ini, saya mengusulkan untuk melihat proses memulai U-Boot, BBL, dan upaya Linux yang malu-malu untuk menginisialisasi.  Tetapi ada konsol - U-Boot-ovsky, dan cukup canggih, memiliki banyak dari apa yang Anda harapkan dari konsol penuh. </p><br><p> Dalam perangkat keras, kartu SD yang terhubung melalui SPI, serta UART, akan ditambahkan.  Pada bagian perangkat lunak, BootROM akan diganti dari <code>xip</code> ke <code>sdboot</code> dan, pada kenyataannya, tahapan boot berikut (pada kartu SD) akan ditambahkan. </p><a name="habracut"></a><br><h2 id="dopilivanie-apparatnoy-chasti">  Doping perangkat keras </h2><br><p>  Jadi, tugasnya: Anda perlu beralih ke inti "besar" dan menghubungkan UART (dari Raspberry) dan adaptor SD (semacam papan Catalex dengan enam pin digunakan: GND, VCC, MISO, MOSI, SCK, CS). </p><br><p>  Pada prinsipnya, semuanya cukup sederhana.  Tetapi sebelum menyadari ini, saya dilemparkan sedikit dari sisi ke sisi: setelah waktu sebelumnya, saya memutuskan bahwa Anda hanya perlu mencampur sesuatu seperti <code>HasPeripheryUART</code> ke dalam <code>System</code> (dan implementasinya, masing-masing), sama untuk kartu SD - dan hanya itu akan siap.  Kemudian saya memutuskan untuk melihat bagaimana itu diterapkan dalam desain "serius".  Jadi apa yang kita dapatkan dengan serius?  Arty, tampaknya, tidak cocok - monster itu tetap tidak <code>unleahshed.DevKitConfigs</code> . <code>unleahshed.DevKitConfigs</code> .  Dan tiba-tiba ternyata di mana-mana ada semacam overlay yang ditambahkan melalui parameter dengan kunci.  Saya kira ini mungkin sangat fleksibel dan dapat dikonfigurasi, tetapi saya ingin memulai sesuatu untuk permulaan ... <em>Tetapi Anda tidak memiliki kruk yang sama, lebih mudah? ..</em> Lalu saya menemukan <code>vera.iofpga.FPGAChip</code> untuk FPGA Microsemi dan <del>  segera menarik tanda kutip </del>  Saya mencoba membuat implementasi saya dengan analogi, manfaatnya di sini adalah kurang lebih seluruh "layout motherboard" dalam satu file. </p><br><p>  Ternyata, sungguh, Anda hanya perlu menambahkan baris ke <code>System.scala</code> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">System</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RocketSubsystem</span></span></span><span class="hljs-class"> ... </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripherySPI</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryUART</span></span></span><span class="hljs-class"> ... </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> tlclock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">FixedClockResource</span></span>(<span class="hljs-string"><span class="hljs-string">"tlclk"</span></span>, p(<span class="hljs-type"><span class="hljs-type">DevKitFPGAFrequencyKey</span></span>)) ... } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemModule</span></span></span><span class="hljs-class">[+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">L</span></span></span><span class="hljs-class"> &lt;: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">System</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">_outer: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">L</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RocketSubsystemModuleImp</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">_outer</span></span></span><span class="hljs-class">) ... </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryUARTModuleImp</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryGPIOModuleImp</span></span></span><span class="hljs-class"> ...</span></span></code> </pre> <br><p>  Baris di badan kelas <code>System</code> menambahkan informasi tentang frekuensi di mana bagian dari SoC kami ini bekerja pada file dts.  Sejauh yang saya mengerti, DTS / DTB adalah analog statis teknologi plug-and-play untuk perangkat yang disematkan: pohon dts-description dikompilasi menjadi file dtb biner dan ditransmisikan oleh loader ke kernel sehingga dapat dengan benar mengkonfigurasi perangkat keras.  Menariknya, tanpa garis dengan <code>tlclock</code> semuanya disintesis dengan sempurna, tetapi tidak akan berfungsi untuk mengkompilasi BootROM (saya akan mengingatkan Anda sekarang akan <code>sdboot</code> ) - selama kompilasi ia mem-parsing file dts dan membuat header dengan makro <code>TL_CLK</code> , berkat yang dapat dengan benar mengkonfigurasi pembagi frekuensi untuk antarmuka eksternal. </p><br><p>  Anda juga perlu sedikit memperbaiki "kabel": </p><br><p>  <strong>Platform.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlatformIO</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bundle</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">// UART io.uart_tx := sys.uart(0).txd sys.uart(0).rxd := RegNext(RegNext(io.uart_rx)) // SD card io.sd_cs := sys.spi(0).cs(0) io.sd_sck := sys.spi(0).sck io.sd_mosi := sys.spi(0).dq(0).o sys.spi(0).dq(0).i := false.B sys.spi(0).dq(1).i := RegNext(RegNext(io.sd_miso)) sys.spi(0).dq(2).i := false.B sys.spi(0).dq(3).i := false.B }</span></span></code> </pre> <br><p>  Rantai daftar, terus terang, ditambahkan hanya dengan analogi dengan beberapa tempat lain dalam kode sumber.  Kemungkinan besar, mereka harus melindungi terhadap <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">metastabilitas</a> .  Mungkin <em>beberapa</em> blok sudah memiliki perlindungan sendiri, tetapi pertama-tama saya ingin menjalankan setidaknya "pada level tinggi."  Pertanyaan yang lebih menarik bagi saya adalah mengapa MISO dan MOSI bertahan pada <code>dq</code> berbeda?  Saya masih belum menemukan jawabannya, tetapi tampaknya sisa kode hanya mengandalkan koneksi semacam itu. </p><br><p>  Secara fisik, saya baru saja menetapkan kesimpulan desain untuk kontak longgar di blok dan mengatur ulang jumper pemilihan tegangan ke 3.3V. </p><br><div class="spoiler">  <b class="spoiler_title">Adaptor SD</b> <div class="spoiler_text"><p>  Tampilan atas: </p><br><img src="https://habrastorage.org/webt/su/zf/q4/suzfq4lwejcelmwt3rpk5w_min0.jpeg"><br><p>  Tampak bawah: </p><br><img src="https://habrastorage.org/webt/y0/__/qq/y0__qqavfhkikpsorvmzqhbamlw.jpeg"></div></div><br><h2 id="otladka-programmnoy-chasti-instrumenty">  Debugging bagian perangkat lunak: alat </h2><br><p>  Pertama, mari kita bicara tentang alat debugging yang tersedia dan batasannya. </p><br><h3 id="minicom">  Minicom </h3><br><p>  Pertama, kita perlu membaca entah apa bootloader dan output kernel.  Untuk melakukan ini, di Linux (dalam hal ini, yang ada di RaspberryPi), kita memerlukan program Minicom.  Secara umum, setiap program untuk bekerja dengan port serial cocok. </p><br><p>  Perhatikan bahwa pada saat startup, nama perangkat port harus ditentukan sebagai <code>-D /dev/ttyS0</code> - setelah opsi <code>-D</code> .  Nah, informasi utama: untuk keluar, gunakan <code>Ctrl-A, X</code>  Saya benar-benar memiliki kasus di mana kombinasi ini tidak berfungsi - maka Anda dapat mengatakan <code>killall -KILL minicom</code> dari sesi SSH yang berdekatan. </p><br><p>  Ada fitur lain.  Secara khusus, ada dua UART pada RaspberryPi, dan kedua port sudah dapat diadaptasi untuk sesuatu: satu untuk Bluetooth, melalui yang lain, konsol kernel ditampilkan secara default.  Untungnya, perilaku ini dapat dikonfigurasi ulang <a href="">sesuai dengan manual ini</a> . </p><br><h3 id="perepisyvanie-pamyati">  Memori penulisan ulang </h3><br><p>  Saat debugging, untuk menguji hipotesis, saya terkadang harus <em>memuat bootloader</em> (maaf) ke dalam RAM langsung dari host.  Mungkin ini bisa dilakukan langsung dari GDB, tetapi pada akhirnya saya pergi dengan cara sederhana: Saya menyalin file yang diperlukan ke Raspberry, juga mengirim port 4444 (telnet dari OpenOCD) melalui SSH dan menggunakan perintah <code>load_image</code> .  Ketika Anda mengeksekusinya, tampaknya semuanya membeku, tetapi sebenarnya <em>"tidak tidur, hanya berkedip perlahan"</em> : ia memuat file, ia hanya melakukannya dengan kecepatan beberapa kilobyte per detik. </p><br><h3 id="osobennosti-ustanovki-breakpoint-ov">  Fitur menginstal breakpoints </h3><br><p>  Mungkin, banyak yang tidak perlu memikirkan hal ini ketika men-debug program reguler, tetapi breakpoint tidak selalu diatur dalam perangkat keras.  Kadang-kadang pengaturan breakpoint melibatkan sementara menulis instruksi khusus ke tempat yang tepat <strong>secara langsung dalam kode mesin</strong> .  Sebagai contoh, ini adalah cara kerja perintah standar saya di GDB.  Inilah yang berikut dari ini: </p><br><ul><li>  Anda tidak dapat memasukkan titik di dalam BootROM, karena ROM </li><li>  Anda dapat mengatur breakpoint pada kode yang dimuat ke dalam RAM dari kartu SD, tetapi Anda harus menunggu sampai itu dimuat.  Kalau tidak, kami tidak akan menulis ulang sepotong kode, tetapi loader akan menulis ulang breakpoint kami </li></ul><br><p>  Saya yakin Anda dapat secara eksplisit meminta untuk menggunakan breakpoint perangkat keras, tetapi ada beberapa yang terbatas. </p><br><h3 id="bystraya-podmena-bootrom">  Swap BootROM cepat </h3><br><p>  Pada tahap awal debugging, sering kali ada keinginan untuk memperbaiki BootROM dan coba lagi.  Tetapi ada masalah: BootROM adalah bagian dari desain yang dimuat ke dalam FPGA, dan sintesisnya adalah masalah beberapa menit (dan ini setelah hampir secara instan mengkompilasi gambar BootROM itu sendiri dari C dan Assembler ...).  Untungnya, pada kenyataannya, semuanya <strong>jauh lebih cepat</strong> : urutan tindakan adalah sebagai berikut: </p><br><ul><li>  meregenerasi bootrom.mif (saya beralih ke MIF alih-alih HEX, karena dengan HEX saya selalu memiliki beberapa masalah, dan MIF adalah format asli Alter) </li><li>  di Quartus say <code>Processing -&gt; Update Memory Initialization File</code> </li><li>  pada Assembler (di kolom sebelah kiri Tugas), perintah Mulai lagi </li></ul><br><p>  Untuk semuanya tentang segalanya - beberapa puluh detik. </p><br><h2 id="podgotovka-sd-karty">  Persiapan kartu SD </h2><br><p>  Semuanya relatif sederhana di sini, tetapi Anda harus bersabar dan memiliki sekitar 14Gb ruang disk: </p><br><pre> <code class="plaintext hljs">git clone https://github.com/sifive/freedom-u-sdk git submodule update --recursive --init make</code> </pre> <br><p>  Maka Anda perlu memasukkan bersih, atau lebih tepatnya, tidak mengandung apa pun yang Anda butuhkan, kartu SD, dan jalankan </p><br><pre> <code class="plaintext hljs">sudo make DISK=/dev/sdX format-boot-loader</code> </pre> <br><p>  ... di mana <code>sdX</code> adalah perangkat yang ditetapkan untuk kartu.  <strong>PERHATIAN: data pada kartu akan dihapus, ditimpa dan umumnya!</strong>  Hampir tidak layak melakukan seluruh perakitan dari bawah <code>sudo</code> , karena semua artefak perakitan akan dimiliki oleh <code>root</code> , dan perakitan harus dilakukan dari bawah <code>sudo</code> waktu. </p><br><p>  Hasilnya adalah kartu yang ditandai dalam GPT dengan empat bagian, di mana salah satunya adalah FAT dengan <code>uEnv.txt</code> dan gambar yang dapat diunduh dalam format FIT (berisi beberapa sub-gambar, masing-masing dengan alamat unduh sendiri), bagian lain kosong, seharusnya diformat dalam Ext4 untuk Linux.  Dua bagian lagi bersifat <em>samar</em> : U-Boot hidup dengan satu (offsetnya, seperti yang saya pahami, ditransfer dalam BootROM), di sisi lain, sepertinya variabel lingkungannya hidup, tetapi saya belum menggunakannya. </p><br><h2 id="uroven-pervyy-bootrom">  Tingkat Satu, BootROM </h2><br><p>  Kebijaksanaan rakyat mengatakan: "Jika dalam pemrograman ada tarian dengan rebana, maka dalam elektronik - juga dengan pemadam api."  Bahkan tidak begitu saya hampir membakar papan, memutuskan bahwa "Yah, GND adalah tingkat rendah yang sama" <em>(tampaknya, resistor masih tidak akan sakit ...)</em> Ini lebih lanjut tentang fakta bahwa jika tangan tidak tumbuh dari sana, maka elektronik tidak berhenti membawa kejutan: ketika saya menyolder konektor ke papan, saya masih tidak bisa membubarkan kontak secara normal - video menunjukkan bagaimana solder langsung menyebar ke seluruh koneksi, hanya memasukkan besi solder, itu sudah turun pada saya bagaimanapun juga.  Yah, mungkin soldernya tidak cocok untuk suhu besi solder, mungkin sesuatu yang lain ... Secara umum, ketika saya melihat bahwa saya sudah memiliki selusin kontak, saya meludah, dan mulai men-debug.  Dan kemudian hal yang <em>misterius</em> dimulai: Saya menghubungkan RX / TX dari UART, saya memuat firmware - ia menulis </p><br><pre> <code class="plaintext hljs">INIT CMD0 ERROR</code> </pre> <br><p>  Yah, semuanya logis - saya tidak menghubungkan modul kartu SD.  Kami memperbaiki situasi, memuat firmware ... Dan diam ... Apa yang saya tidak berubah pikiran, dan peti mati baru saja terbuka: salah satu output modul harus terhubung ke VCC.  Dalam kasus saya, modul mendukung 5V untuk daya, jadi tanpa berpikir dua kali, saya memasang kawat yang membentang dari modul ke sisi yang berlawanan dari papan.  Akibatnya, konektor yang disolder bengkok memutar, dan <strong>kontak UART hilang begitu saja.</strong>  <em>facepalm.jpg</em> Secara umum, "kepala yang buruk tidak memberi istirahat pada kaki", dan tangan yang bengkok - ke kepala ... </p><br><p>  Pada akhirnya, saya melihat yang sudah lama ditunggu-tunggu di Minicom </p><br><pre> <code class="plaintext hljs">INIT CMD0 CMD8 ACMD41 CMD58 CMD16 CMD18 LOADING /</code> </pre> <br><p>  Selain itu, <del>  itu bergerak </del>  indikator pemuatan berputar.  Saya langsung mengingat tahun-tahun sekolah dan boot santai MinuetOS dari floppy disk.  Kecuali jika drive berputar. </p><br><p>  Masalahnya adalah bahwa tidak ada yang terjadi setelah pesan BOOT.  Jadi, inilah saatnya untuk terhubung melalui OpenOCD pada Raspberry, GDB pada host untuk itu, dan lihat apa itu. </p><br><p>  Pertama, terhubung dengan GDB segera menunjukkan bahwa <code>$pc</code> (program counter, alamat dari instruksi saat ini) terbang ke <code>0x0</code> - ini mungkin terjadi setelah beberapa kesalahan.  Oleh karena itu, segera setelah pesan <code>BOOT</code> dikeluarkan, kami menambahkan loop tak terbatas.  <em>Ini akan menunda dia sebentar ...</em> </p><br><pre> <code class="diff hljs">diff --git a/bootrom/sdboot/sd.cb/bootrom/sdboot/sd.c index c6b5ede..bca1b7f 100644 --- a/bootrom/sdboot/sd.c +++ b/bootrom/sdboot/sd.c @@ -224,6 +224,8 @@ int main(void) kputs("BOOT"); + while(*(volatile char *)0x10000){} + __asm__ __volatile__ ("fence.i" : : : "memory"); return 0; }</code> </pre> <br><p>  Kode rumit semacam itu digunakan "untuk keandalan": Saya mendengar di suatu tempat bahwa, tampaknya, infinite loop adalah Perilaku Tidak Terdefinisi, dan di sini kompiler tidak mungkin menebak (saya ingat bahwa BootROM terletak di <code>0x10000</code> ). </p><br><p><img src="https://habrastorage.org/webt/wj/xw/a9/wjxwa9m9hqoghtvy79zsbysctr0.png" alt="Ada debugger, tidak ada sumber"></p><br><p>  Tampaknya, tapi apa lagi yang diharapkan - tertanam keras, sumber apa yang ada di sana.  Tapi bagaimanapun, dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel itu,</a> penulis men-debug kode ... Krex-fex-pex: </p><br><pre> <code class="plaintext hljs">(gdb) file builds/zeowaa-e115/sdboot.elf A program is being debugged already. Are you sure you want to change the file? (y or n) y Reading symbols from builds/zeowaa-e115/sdboot.elf...done.</code> </pre> <br><p><img src="https://habrastorage.org/webt/ya/08/zp/ya08zpufla55qz02j5fhwcoijy4.png" alt="Ada kode sumber!"></p><br><p>  Hanya Anda yang perlu memuat bukan file MIF dan bukan bin, tetapi versi asli dalam format ELF. </p><br><p>  Sekarang, dengan upaya ke-n untuk menebak alamat di mana eksekusi akan berlanjut (ini adalah alasan lain mengapa kompiler seharusnya tidak menebak bahwa loop tidak terbatas).  Tim </p><br><pre> <code class="plaintext hljs">set variable $pc=0xADDR</code> </pre> <br><p>  memungkinkan Anda untuk mengubah nilai register saat bepergian (dalam hal ini, alamat instruksi saat ini).  Dengan bantuannya, Anda dapat mengubah nilai yang direkam dalam memori (dan register yang dipetakan memori). </p><br><p>  Pada akhirnya, saya sampai pada kesimpulan (tidak yakin apakah itu benar) bahwa kita memiliki "gambar kartu sd dari sistem yang salah", dan kita harus pergi bukan ke awal data yang diunduh, tetapi ke <code>0x89800</code> byte lebih lanjut: </p><br><pre> <code class="diff hljs">diff --git a/bootrom/sdboot/head.S b/bootrom/sdboot/head.S index 14fa740..2a6c944 100644 --- a/bootrom/sdboot/head.S +++ b/bootrom/sdboot/head.S @@ -13,7 +13,7 @@ _prog_start: smp_resume(s1, s2) csrr a0, mhartid la a1, dtb - li s1, PAYLOAD_DEST + li s1, (PAYLOAD_DEST + 0x89800) jr s1 .section .rodata</code> </pre> <br><p>  Mungkin ini juga dipengaruhi oleh fakta bahwa saya tidak memiliki kartu 4Gb yang tidak perlu, saya membawanya ke 2Gb dan menggantinya di Makefile dengan <code>DEMO_END=11718750</code> dengan <code>DEMO_END=3078900</code> (tidak mencari arti dalam nilai tertentu - tidak ada, hanya sekarang gambar ditempatkan, hanya sekarang gambar ditempatkan ke kartu). </p><br><h2 id="uroven-vtoroy-u-boot">  Tingkat Dua, U-Boot </h2><br><p>  Sekarang kita masih "jatuh", tetapi kita sudah berada di alamat <code>0x0000000080089a84</code> .  Di sini saya harus mengakui: sebenarnya, presentasi tidak berjalan "dengan semua berhenti", tetapi sebagian ditulis "setelah", jadi di sini saya sudah berhasil menempatkan file dtb yang benar dari SoC kami, sesuaikan variabel <code>CONFIG_SYS_TEXT_BASE=0x80089800</code> dalam pengaturan <code>HiFive_U-Boot</code> (bukan <code>0x08000000</code> ) sehingga alamat unduhan cocok dengan yang sebenarnya.  Unduh sekarang <del>  peta tingkat berikutnya </del>  gambar lain: </p><br><pre> <code class="plaintext hljs">(gdb) file ../freedom-u-sdk/work/HiFive_U-Boot/u-boot (gdb) tui en</code> </pre> <br><p>  Dan kita melihat: </p><br><pre> <code class="plaintext hljs"> │304 /* │ │305 * trap entry │ │306 */ │ │307 trap_entry: │ │308 addi sp, sp, -32*REGBYTES │ &gt;│309 SREG x1, 1*REGBYTES(sp) │ │310 SREG x2, 2*REGBYTES(sp) │ │311 SREG x3, 3*REGBYTES(sp) │</code> </pre> <br><p>  Dan kami melompat di antara baris 308 dan 309. Dan tidak mengherankan, mengingat bahwa <code>$sp</code> berisi nilai <code>0xfffffffe31cdc0a0</code> .  Sayangnya, itu juga terus-menerus "lari" karena jalur 307. Oleh karena itu, kami akan mencoba untuk menetapkan breakpoint pada <code>trap_entry</code> , dan kemudian kembali beralih ke <code>0x80089800</code> (titik masuk Boot-U), dan kami berharap tidak memerlukan pengaturan register yang benar sebelum transisi. ... Tampaknya bekerja: </p><br><pre> <code class="plaintext hljs">(gdb) b trap_entry Breakpoint 1 at 0x80089a80: file /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S, line 308. (gdb) set variable $pc=0x80089800 (gdb) c Continuing. Breakpoint 1, trap_entry () at /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S:308 (gdb) p/x $sp $4 = 0x81cf950</code> </pre> <br><p>  So-so, stack pointer, katakan terus terang: umumnya menunjuk melewati RAM (kecuali, tentu saja, kami masih memiliki terjemahan alamat, tetapi mari kita berharap untuk opsi yang sederhana). </p><br><p>  Mari kita coba ganti pointer dengan <code>0x881cf950</code> .  Akibatnya, kita sampai pada fakta bahwa <code>handle_trap</code> dipanggil dan dipanggil, sambil meninggalkan <code>_exit_trap</code> dengan argumen <code>epc=2148315240</code> (dalam desimal): </p><br><pre> <code class="plaintext hljs">(gdb) x/10i 2148315240 0x800cb068 &lt;strnlen+12&gt;: lbu a4,0(a5) 0x800cb06c &lt;strnlen+16&gt;: bnez a4,0x800cb078 &lt;strnlen+28&gt; 0x800cb070 &lt;strnlen+20&gt;: sub a0,a5,a0 0x800cb074 &lt;strnlen+24&gt;: ret 0x800cb078 &lt;strnlen+28&gt;: addi a5,a5,1 0x800cb07c &lt;strnlen+32&gt;: j 0x800cb064 &lt;strnlen+8&gt; 0x800cb080 &lt;strdup&gt;: addi sp,sp,-32 0x800cb084 &lt;strdup+4&gt;: sd s0,16(sp) 0x800cb088 &lt;strdup+8&gt;: sd ra,24(sp) 0x800cb08c &lt;strdup+12&gt;: li s0,0</code> </pre> <br><p>  Kami menetapkan breakpoint pada <code>strnlen</code> , melanjutkan dan melihat: </p><br><pre> <code class="plaintext hljs">(gdb) bt #0 strnlen (s=s@entry=0x10060000 "", count=18446744073709551615) at lib/string.c:283 #1 0x00000000800cc14c in string (buf=buf@entry=0x881cbd4c "", end=end@entry=0x881cc15c "", s=0x10060000 "", field_width=&lt;optimized out&gt;, precision=&lt;optimized out&gt;, flags=&lt;optimized out&gt;) at lib/vsprintf.c:265 #2 0x00000000800cc63c in vsnprintf_internal (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=0x800d446e "s , epc %08x , ra %08lx\n", fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=0x881cc1a0, args@entry=0x881cc188) at lib/vsprintf.c:619 #3 0x00000000800cca54 in vsnprintf (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=args@entry=0x881cc188) at lib/vsprintf.c:710 #4 0x00000000800cca68 in vscnprintf (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=args@entry=0x881cc188) at lib/vsprintf.c:717 #5 0x00000000800ccb50 in printf (fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n") at lib/vsprintf.c:792 #6 0x000000008008a9f0 in _exit_trap (regs=&lt;optimized out&gt;, epc=2148315240, code=&lt;optimized out&gt;) at arch/riscv/lib/interrupts.c:92 #7 handle_trap (mcause=&lt;optimized out&gt;, epc=&lt;optimized out&gt;, regs=&lt;optimized out&gt;) at arch/riscv/lib/interrupts.c:55 #8 0x0000000080089b10 in trap_entry () at /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S:343 Backtrace stopped: frame did not save the PC</code> </pre> <br><p>  Tampaknya <code>_exit_trap</code> ingin memberikan informasi debug tentang pengecualian yang terjadi, <em>tetapi gagal</em> .  Jadi, sesuatu dengan kode sumber kami tidak ditampilkan lagi.  <code>set directories ../freedom-u-sdk/HiFive_U-Boot/</code> Oh!  Sekarang ditampilkan! </p><br><p>  Nah, jalankan lagi dan lihat pada stack trace penyebab masalah asli yang menyebabkan kesalahan pertama ( <code>mcause == 5</code> ).  Jika saya mengerti benar apa yang tertulis di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> di halaman 37, maka pengecualian ini berarti <code>Load access fault</code> .  Alasannya, rupanya, karena di sini </p><br><p>  <strong>lengkung / riscv / cpu / HiFive / start.S:</strong> </p><br><pre> <code class="plaintext hljs">call_board_init_f: li t0, -16 li t1, CONFIG_SYS_INIT_SP_ADDR and sp, t1, t0 /* force 16 byte alignment */ #ifdef CONFIG_DEBUG_UART jal debug_uart_init #endif call_board_init_f_0: mv a0, sp jal board_init_f_alloc_reserve mv sp, a0 jal board_init_f_init_reserve mv a0, zero /* a0 &lt;-- boot_flags = 0 */ la t5, board_init_f jr t5 /* jump to board_init_f() */</code> </pre><br><p>  <code>$sp</code> memiliki nilai salah yang sama, dan kesalahan terjadi di dalam <code>board_init_f_init_reserve</code> .  Tampaknya itu penyebabnya: variabel dengan nama eksplisit <code>CONFIG_SYS_INIT_SP_ADDR</code> .  Ini didefinisikan dalam file <code>HiFive_U-Boot/include/configs/HiFive-U540.h</code> .  Pada titik tertentu, saya bahkan berpikir, atau mungkin, menyelesaikan bootloader untuk prosesor - mungkin lebih mudah untuk sedikit memperbaiki prosesor?  Tapi kemudian saya melihat bahwa itu lebih seperti artefak dari pengaturan yang tidak sepenuhnya <code>#if 0</code> untuk konfigurasi memori yang berbeda, dan Anda dapat mencoba melakukan ini: </p><br><pre> <code class="diff hljs">diff --git a/include/configs/HiFive-U540.hb/include/configs/HiFive-U540.h index ca89383..245542c 100644 --- a/include/configs/HiFive-U540.h +++ b/include/configs/HiFive-U540.h @@ -65,12 +65,9 @@ #define CONFIG_SYS_SDRAM_BASE PHYS_SDRAM_0 #endif #if 1 -/*#define CONFIG_NR_DRAM_BANKS 1*/ +#define CONFIG_NR_DRAM_BANKS 1 #define PHYS_SDRAM_0 0x80000000 /* SDRAM Bank #1 */ -#define PHYS_SDRAM_1 \ - (PHYS_SDRAM_0 + PHYS_SDRAM_0_SIZE) /* SDRAM Bank #2 */ -#define PHYS_SDRAM_0_SIZE 0x80000000 /* 2 GB */ -#define PHYS_SDRAM_1_SIZE 0x10000000 /* 256 MB */ +#define PHYS_SDRAM_0_SIZE 0x40000000 /* 1 GB */ #define CONFIG_SYS_SDRAM_BASE PHYS_SDRAM_0 #endif /* @@ -81,7 +78,7 @@ #define CONSOLE_ARG "console=ttyS0,115200\0" /* Init Stack Pointer */ -#define CONFIG_SYS_INIT_SP_ADDR (0x08000000 + 0x001D0000 - \ +#define CONFIG_SYS_INIT_SP_ADDR (0x80000000 + 0x001D0000 - \ GENERATED_GBL_DATA_SIZE) #define CONFIG_SYS_LOAD_ADDR 0xa0000000 /* partway up SDRAM */</code> </pre> <br><p>  Pada titik tertentu, kuantitas <del>  kruk </del>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pengencang teknologi</a> mencapai titik kritis.  Setelah sedikit siksaan, saya sampai pada kebutuhan untuk membuat port yang benar di papan saya.  Untuk melakukan ini, Anda perlu menyalin dan memperbaiki sejumlah file untuk konfigurasi kami. </p><br><div class="spoiler">  <b class="spoiler_title">Nah, kira-kira, ini ada meja kecil</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">trosinenko@trosinenko-pc:/hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot$ git show --name-status commit 39cd67d59c16ac87b46b51ac1fb58f16f1eb1048 (HEAD -&gt; zeowaa-1gb) Author: Anatoly Trosinenko &lt;anatoly.trosinenko@gmail.com&gt; Date: Tue Jul 2 17:13:16 2019 +0300 Initial support for Zeowaa A-E115FB board M arch/riscv/Kconfig A arch/riscv/cpu/zeowaa-1gb/Makefile A arch/riscv/cpu/zeowaa-1gb/cpu.c A arch/riscv/cpu/zeowaa-1gb/start.S A arch/riscv/cpu/zeowaa-1gb/timer.c A arch/riscv/cpu/zeowaa-1gb/u-boot.lds M arch/riscv/dts/Makefile A arch/riscv/dts/zeowaa-1gb.dts A board/Zeowaa/zeowaa-1gb/Kconfig A board/Zeowaa/zeowaa-1gb/MAINTAINERS A board/Zeowaa/zeowaa-1gb/Makefile A board/Zeowaa/zeowaa-1gb/Zeowaa-A-E115FB.c A configs/zeowaa-1gb_defconfig A include/configs/zeowaa-1gb.h</code> </pre> <br><p>  Detail dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori</a> . </p></div></div><br><p>  Ternyata, pada papan SiFive ini, register dari beberapa perangkat memiliki alamat yang berbeda.  Juga ternyata U-Boot dikonfigurasikan oleh mekanisme Kconfig, yang sudah biasa dari kernel Linux - misalnya, Anda dapat memerintahkan <code>make menuconfig</code> , dan Anda akan melihat antarmuka teks yang nyaman dengan deskripsi parameter yang ditunjukkan pada <code>?</code>  dll.  Secara umum, setelah membutakan deskripsi yang ketiga dari deskripsi dua papan, membuang semua konfigurasi ulang PLL patos dari sana (tampaknya, ini entah bagaimana terhubung dengan kontrol PCIe dari komputer host, tapi ini tidak akurat), saya mendapatkan beberapa firmware, yang, jika cuacanya tepat di Mars Itu memberi saya pesan UART tentang hash komit mana itu dikumpulkan, dan berapa banyak DRAM yang saya miliki (tetapi saya juga mendaftarkan informasi ini di header). </p><br><p>  Sangat disayangkan bahwa setelah ini board biasanya berhenti merespons dengan prosesor JTAG, dan booting dari kartu SD, sayangnya, tidak cepat dalam konfigurasi saya.  Di sisi lain, kadang-kadang BootROM menampilkan pesan bahwa <code>ERROR</code> tidak dapat melakukan boot, dan U-Boot segera muncul.  Saat itulah saya sadar: rupanya, setelah me-reboot bitstream, memori tidak rusak di FPGA, tidak punya waktu untuk "dihancurkan", dll.  Singkatnya, Anda dapat dengan mudah ketika <code>LOADING /</code> pesan muncul, terhubung dengan debugger dan <code>set variable $pc=0x80089800</code> perintah <code>set variable $pc=0x80089800</code> , dengan demikian melewati unduhan panjang ini (tentu saja, dengan asumsi bahwa itu terakhir rusak cukup awal, dan tidak punya waktu di atas kode asli unduh). </p><br><p>  Ngomong-ngomong, dan umumnya normal bahwa prosesor hang sepenuhnya dan debugger JTAG dengan pesan tidak dapat terhubung dengannya </p><br><pre> <code class="plaintext hljs">Error: unable to halt hart 0 Error: dmcontrol=0x80000001 Error: dmstatus =0x00030c82</code> </pre> <br><p>  Jadi tunggu!  Saya sudah melihatnya! -     TileLink,      -   —   … ,           : </p><br><pre> <code class="plaintext hljs">INIT CMD0 CMD8 ACMD41 CMD58 CMD16 CMD18 LOADING BOOT U-Boot 2018.09-g39cd67d-dirty (Jul 03 2019 - 13:50:33 +0300) DRAM: 1 GiB MMC: BEFORE LOAD ENVBEFORE FDTCONTROLADDRBEFORE LOADADDRIn: serial Out: serial Err: serial Hit any key to stop autoboot: 3</code> </pre> <br><p>      <code>In: serial</code>    —       ,      environment.  , «    »?          !  :  U-Boot      2^24   SD-, ,    <del>   </del>  ,      ,        ,   ELF-,    .  : ,       ,     . </p><br><p> ,    ? ,    -  ... </p><br><pre> <code class="plaintext hljs">(gdb) x/x 0x0200bff8 0x200bff8: 0x00000000</code> </pre> <br><p>  ,    ? </p><br><pre> <code class="plaintext hljs">(gdb) set variable *0x0200bff8=310000000 (gdb) c</code> </pre> <br><p> : </p><br><pre> <code class="plaintext hljs">Hit any key to stop autoboot: 0 MMC_SPI: 0 at 0:1 hz 20000000 mode 0</code> </pre> <br><p> :   . , -        : </p><br><p> <strong>HiFive_U-Boot/cmd/bootmenu.c:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bootmenu_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct bootmenu_data *menu, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">enum</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bootmenu_key *key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *esc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!tstc()) { WATCHDOG_RESET(); mdelay(<span class="hljs-number"><span class="hljs-number">10</span></span>); } c = getc(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*esc) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-comment"><span class="hljs-comment">/* First char of ANSI escape sequence '\e' */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'\e'</span></span>) { *esc = <span class="hljs-number"><span class="hljs-number">1</span></span>; *key = KEY_NONE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-comment"><span class="hljs-comment">/* Second char of ANSI '[' */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'['</span></span>) { ...</code> </pre> <br><p>  <abbr title="   ,   ,    , . ">  </abbr> ,    :      : </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">DTSTimebase</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">BigInt</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><p> …   ,      «   —  0».   <code>WithNBigCores</code>      1MHz (, ,      U-Boot).   , ,   :    ,  25MHz!     .   «» ... </p><br><pre> <code class="plaintext hljs">Hit any key to stop autoboot: 0 MMC_SPI: 0 at 0:1 hz 20000000 mode 0 ## Unknown partition table type 0 libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND ** No partition table - mmc 0 ** ## Info: input data size = 34 = 0x22 Running uEnv.txt boot2... ## Error: "boot2" not defined HiFive-Unleashed #</code> </pre> <br><p>    ! ,  , , ,   <code>mmc_spi 1 10000000 0; mmc part</code> ,   SPI  20MHz  10MHz.  Mengapa ,       20MHz,      . ,   , ,    ,  :      (  —  25MHz)  ,           .   ,    115200Hz UART-   ,  ,     25000000  20000000  1, ..     25MHz. ,   ,    , ,  -  (   )…  ,      —  , , . 25MHz —    Core i9. </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">HiFive-Unleashed # env edit mmcsetup edit: mmc_spi 1 10000000 0; mmc part HiFive-Unleashed # boot MMC_SPI: 1 at 0:1 hz 10000000 mode 0 Partition Map for MMC device 0 -- Partition Type: EFI Part Start LBA End LBA Name Attributes Type GUID Partition GUID 1 0x00000800 0x0000ffde "Vfat Boot" attrs: 0x0000000000000000 type: ebd0a0a2-b9e5-4433-87c0-68b6b72699c7 type: data guid: 76bd71fd-1694-4ff3-8197-bfa81699c2fb 2 0x00040800 0x002efaf4 "root" attrs: 0x0000000000000000 type: 0fc63daf-8483-4772-8e79-3d69d8477de4 type: linux guid: 9f3adcc5-440c-4772-b7b7-283124f38bf3 3 0x0000044c 0x000007e4 "uboot" attrs: 0x0000000000000000 type: 5b193300-fc78-40cd-8002-e86c45580b47 guid: bb349257-0694-4e0f-9932-c801b4d76fa3 4 0x00000400 0x0000044b "uboot-env" attrs: 0x0000000000000000 type: a09354ac-cd63-11e8-9aff-70b3d592f0fa guid: 4db442d0-2109-435f-b858-be69629e7dbf libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND 2376 bytes read in 0 ms Running uEnv.txt boot2... 15332118 bytes read in 0 ms ## Loading kernel from FIT Image at 90000000 ... Using 'config-1' configuration Trying 'bbl' kernel subimage Description: BBL/SBI/riscv-pk Type: Kernel Image Compression: uncompressed Data Start: 0x900000d4 Data Size: 74266 Bytes = 72.5 KiB Architecture: RISC-V OS: Linux Load Address: 0x80000000 Entry Point: 0x80000000 Hash algo: sha256 Hash value: 28972571467c4ad0cf08a81d9cf92b9dffc5a7cb2e0cd12fdbb3216cf1f19cbd Verifying Hash Integrity ... sha256+ OK ## Loading fdt from FIT Image at 90000000 ... Using 'config-1' configuration Trying 'fdt' fdt subimage Description: unavailable Type: Flat Device Tree Compression: uncompressed Data Start: 0x90e9d31c Data Size: 6911 Bytes = 6.7 KiB Architecture: RISC-V Load Address: 0x81f00000 Hash algo: sha256 Hash value: 10b0244a5a9205357772ea1c4e135a4f882409262176d8c7191238cff65bb3a8 Verifying Hash Integrity ... sha256+ OK Loading fdt from 0x90e9d31c to 0x81f00000 Booting using the fdt blob at 0x81f00000 ## Loading loadables from FIT Image at 90000000 ... Trying 'kernel' loadables subimage Description: Linux kernel Type: Kernel Image Compression: uncompressed Data Start: 0x900123e8 Data Size: 10781356 Bytes = 10.3 MiB Architecture: RISC-V OS: Linux Load Address: 0x80200000 Entry Point: unavailable Hash algo: sha256 Hash value: 72a9847164f4efb2ac9bae736f86efe7e3772ab1f01ae275e427e2a5389c84f0 Verifying Hash Integrity ... sha256+ OK Loading loadables from 0x900123e8 to 0x80200000 ## Loading loadables from FIT Image at 90000000 ... Trying 'ramdisk' loadables subimage Description: buildroot initramfs Type: RAMDisk Image Compression: gzip compressed Data Start: 0x90a5a780 Data Size: 4467411 Bytes = 4.3 MiB Architecture: RISC-V OS: Linux Load Address: 0x82000000 Entry Point: unavailable Hash algo: sha256 Hash value: 883dfd33ca047e3ac10d5667ffdef7b8005cac58b95055c2c2beda44bec49bd0 Verifying Hash Integrity ... sha256+ OK Loading loadables from 0x90a5a780 to 0x82000000</code> </pre> </div></div><br><p> ,     ,     .      .  mcause ,      <code>$pc</code>   <code>si</code>   <code>trap_entry</code> .    U-Boot     mcause = 0..4,      .     ,  ,    ,  :    <code>conf/rvboot-fit.txt</code> : </p><br><pre> <code class="plaintext hljs">fitfile=image.fit # below much match what's in FIT (ugha)</code> </pre> <br><p>  ,     ,      ,   ,  <code>SIF0</code> —  <abbr title="   ,   "> -  PCIe</abbr> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-bootargs=console=ttySIF0,921600 debug +bootargs=console=ttyS0,125200 debug</span></span></code> </pre> <br><p>        SHA-256  MD5:     ( ,  ),    ,         MD5 —  .  Apa hasilnya?        (    ),   : </p><br><pre> <code class="plaintext hljs">... Verifying Hash Integrity ... md5+ OK Loading loadables from 0x90a5a758 to 0x82000000 libfdt fdt_check_header(): FDT_ERR_BADMAGIC chosen { linux,initrd-end = &lt;0x00000000 0x83000000&gt;; linux,initrd-start = &lt;0x00000000 0x82000000&gt;; riscv,kernel-end = &lt;0x00000000 0x80a00000&gt;; riscv,kernel-start = &lt;0x00000000 0x80200000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; }; libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND chosen { linux,initrd-end = &lt;0x00000000 0x83000000&gt;; linux,initrd-start = &lt;0x00000000 0x82000000&gt;; riscv,kernel-end = &lt;0x00000000 0x80a00000&gt;; riscv,kernel-start = &lt;0x00000000 0x80200000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; }; Loading Kernel Image ... OK Booting kernel in 3</code> </pre> <br><p>     ... </p><br><pre> <code class="plaintext hljs">(gdb) x/x 0x0200bff8 0x200bff8: 0x00000000</code> </pre> <br><p> , ,     ,     ,  . , ,  ,         ,  : </p><br><pre> <code class="plaintext hljs">0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=1000000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=2000000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=3000000 (gdb) c Continuing.</code> </pre> <br><p>  ... </p><br><pre> <code class="plaintext hljs"> Loading Kernel Image ... OK Booting kernel in 3 2 1 0 ## Starting application at 0x80000000 ...</code> </pre> <br><p>  ,     —  , ,     ! </p><br><p>        -  </p><br><pre> <code class="plaintext hljs">0000000080001c20 &lt;poweroff&gt;: 80001c20: 1141 addi sp,sp,-16 80001c22: e022 sd s0,0(sp) 80001c24: 842a mv s0,a0 80001c26: 00005517 auipc a0,0x5 80001c2a: 0ca50513 addi a0,a0,202 # 80006cf0 &lt;softfloat_countLeadingZeros8+0x558&gt; 80001c2e: e406 sd ra,8(sp) 80001c30: f7fff0ef jal ra,80001bae &lt;printm&gt; 80001c34: 8522 mv a0,s0 80001c36: 267000ef jal ra,8000269c &lt;finisher_exit&gt; 80001c3a: 00010797 auipc a5,0x10 80001c3e: 41e78793 addi a5,a5,1054 # 80012058 &lt;htif&gt; 80001c42: 639c ld a5,0(a5) 80001c44: c399 beqz a5,80001c4a &lt;poweroff+0x2a&gt; 80001c46: 72c000ef jal ra,80002372 &lt;htif_poweroff&gt; 80001c4a: 45a1 li a1,8 80001c4c: 4501 li a0,0 80001c4e: dc7ff0ef jal ra,80001a14 &lt;send_ipi_many&gt; 80001c52: 10500073 wfi 80001c56: bff5 j 80001c52 &lt;poweroff+0x32&gt;</code> </pre> <br><p>   Berkeley Boot Loader.       <code>htif</code> — host interface,   tethered-  (      ARM), -  standalone. ,      ,  ,     : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poweroff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> code)</span></span></span><span class="hljs-function"> </span></span>{ printm(<span class="hljs-string"><span class="hljs-string">"Power off\r\n"</span></span>); finisher_exit(code); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (htif) { htif_poweroff(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { send_ipi_many(<span class="hljs-number"><span class="hljs-number">0</span></span>, IPI_HALT); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"wfi\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; } } }</code> </pre> <br><h2 id="kvest-zapusti-chasy"> :   </h2><br><p>    CLINT    </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> io = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bundle</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rtcTick = <span class="hljs-type"><span class="hljs-type">Bool</span></span>(<span class="hljs-type"><span class="hljs-type">INPUT</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> time = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-type"><span class="hljs-type">UInt</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, width = timeWidth)) when (io.rtcTick) { time := time + <span class="hljs-type"><span class="hljs-type">UInt</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) }</code> </pre> <br><p>    RTC,    MockAON,     : «,     ? ? !»      ,       ,       <code>System.scala</code> : </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rtcDivider = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span>asUInt(<span class="hljs-number"><span class="hljs-number">16.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-comment"><span class="hljs-comment">//      16,   :) val mhzInt = p(DevKitFPGAFrequencyKey).toInt // ,      rtcDivider := Mux(rtcDivider === (mhzInt - 1).U, 0.U, rtcDivider + 1.U) outer.clintOpt.foreach { clint =&gt; clint.module.io.rtcTick := rtcDivider === 0.U }</span></span></code> </pre> <br><h2 id="probirayas-k-linux-kernel">   Linux kernel </h2><br><p>           ,    : </p><br><p> BBL   FDT   <code>0xF0000000</code> ,     !   ,  …   <strong>HiFive_U-Boot/arch/riscv/lib/boot.c</strong> ,   <code>0x81F00000</code> ,     U-Boot. </p><br><p>  BBL ,   .      <code>mem_prop</code> ,   <strong>riscv-pk/machine/fdt.c</strong> :   ,     fdt ram  <code>device_type = "memory"</code> — , ,     ,      —       . </p><br><p>     (   ,   ): </p><br><pre> <code class="plaintext hljs">This is bbl's dummy_payload. To boot a real kernel, reconfigure bbl with the flag --with-payload=PATH, then rebuild bbl. Alternatively, bbl can be used in firmware-only mode by adding device-tree nodes for an external payload and use QEMU's -bios and -kernel options.</code> </pre> <br><p> ,      <code>riscv,kernel-start</code>  <code>riscv,kernel-end</code>  DTB,   .  <code>query_chosen</code> ,  BBL   32- ,     <code>&lt;0x0 0xADDR&gt;</code> ,   , ,  .    <code>chosen</code> </p><br><pre> <code class="plaintext hljs">chosen { #address-cells = &lt;1&gt;; #size-cells = &lt;0&gt;; ... }</code> </pre> <br><p>    : <abbr title="   ">  <code>0x0</code>  </abbr> . </p><br><p>  100500       ,   : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> Verifying Hash Integrity ... md5+ OK Loading loadables from 0x90a5a758 to 0x82000000 libfdt fdt_check_header(): FDT_ERR_BADMAGIC chosen { linux,initrd-end = &lt;0x83000000&gt;; linux,initrd-start = &lt;0x82000000&gt;; riscv,kernel-end = &lt;0x80a00000&gt;; riscv,kernel-start = &lt;0x80200000&gt;; #address-cells = &lt;0x00000001&gt;; #size-cells = &lt;0x00000000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; stdout-path = "uart0:38400n8"; }; libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND chosen { linux,initrd-end = &lt;0x83000000&gt;; linux,initrd-start = &lt;0x82000000&gt;; riscv,kernel-end = &lt;0x80a00000&gt;; riscv,kernel-start = &lt;0x80200000&gt;; #address-cells = &lt;0x00000001&gt;; #size-cells = &lt;0x00000000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; stdout-path = "uart0:38400n8"; }; Loading Kernel Image ... OK Booting kernel in 3 2 1 0 ## Starting application at 0x80000000 ... bbl loader SIFIVE, INC. 5555555555555555555555555 5555 5555 5555 5555 5555 5555 5555 5555555555555555555555 5555 555555555555555555555555 5555 5555 5555 5555 5555 5555 5555555555555555555555555555 55555 55555 555555555 55555 55555 55555 55555 55555 5 55555 55555 55555 55555 55555 55555 55555 55555 55555 55555 55555 555555555 55555 5 SiFive RISC-V Core IP [ 0.000000] OF: fdt: Ignoring memory range 0x80000000 - 0x80200000 [ 0.000000] Linux version 4.19.0-sifive-1+ (trosinenko@trosinenko-pc) (gcc version 8.3.0 (Buildroot 2019.02-07449-g4eddd28f99)) #1 SMP Wed Jul 3 21:29:21 MSK 2019 [ 0.000000] bootconsole [early0] enabled [ 0.000000] Initial ramdisk at: 0x(____ptrval____) (16777216 bytes) [ 0.000000] Zone ranges: [ 0.000000] DMA32 [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] Normal [mem 0x00000000c0000000-0x00000bffffffffff] [ 0.000000] Movable zone start for each node [ 0.000000] Early memory node ranges [ 0.000000] node 0: [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] Initmem setup node 0 [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] On node 0 totalpages: 261632 [ 0.000000] DMA32 zone: 3577 pages used for memmap [ 0.000000] DMA32 zone: 0 pages reserved [ 0.000000] DMA32 zone: 261632 pages, LIFO batch:63 [ 0.000000] software IO TLB: mapped [mem 0xbb1fc000-0xbf1fc000] (64MB)</code> </pre> </div></div><br><p> (  BBL,       — ). </p><br><p>  ,  ,  ,   RocketChip     JTAG   trap-   —      . </p><br><pre> <code class="plaintext hljs">Program received signal SIGTRAP, Trace/breakpoint trap. 0xffffffe0000024ca in ?? () (gdb) bt #0 0xffffffe0000024ca in ?? () Backtrace stopped: previous frame identical to this frame (corrupt stack?) (gdb) file work/linux/vmlinux A program is being debugged already. Are you sure you want to change the file? (y or n) y Reading symbols from work/linux/vmlinux...done. (gdb) bt #0 0xffffffe0000024ca in setup_smp () at /hdd/trosinenko/fpga/freedom-u-sdk/linux/arch/riscv/kernel/smpboot.c:75 #1 0x0000000000000000 in ?? () Backtrace stopped: frame did not save the PC</code> </pre> <br><p> <strong>freedom-u-sdk/linux/arch/riscv/kernel/smpboot.c:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-function">init </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup_smp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_node</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dn</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NULL</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hart; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found_boot_cpu = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cpuid = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((dn = of_find_node_by_type(dn, <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>))) { hart = riscv_of_processor_hartid(dn); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hart == cpuid_to_hartid_map(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { BUG_ON(found_boot_cpu); found_boot_cpu = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } cpuid_to_hartid_map(cpuid) = hart; set_cpu_possible(cpuid, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); set_cpu_present(cpuid, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); cpuid++; } BUG_ON(!found_boot_cpu); <span class="hljs-comment"><span class="hljs-comment">// &lt;    }</span></span></code> </pre> <br><p>     , <em>CPU not found, running software emulation</em> .    running.     . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* The lucky hart to first increment this variable will boot the other cores */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">atomic_t</span></span> hart_lottery; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> boot_cpu_hartid;</code> </pre> <br><p>    <strong>linux/arch/riscv/kernel/setup.c</strong> —       .  ,   -  ,     ... </p><br><p>         . </p><br><p>  .       ,   ,      singlestep-. </p><br><p>    ( ): <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://asciinema.org/a/h22F5eCMXYF9n7n89CY6NJNEi.svg" alt="asciicast"></a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id458482/">https://habr.com/ru/post/id458482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id458464/index.html">Tautan 3 km gigabit pada modem laser</a></li>
<li><a href="../id458468/index.html">Bagaimana Menjalankan Rapat Kanban yang Mengesankan?</a></li>
<li><a href="../id458470/index.html">Tekstur, atau apa yang perlu Anda ketahui untuk menjadi Artis Permukaan. Bagian 2. Topeng dan tekstur</a></li>
<li><a href="../id458472/index.html">Kompilasi peringkat wilayah dengan metode potensi termal menggunakan data terbuka</a></li>
<li><a href="../id458474/index.html">Laporan terbaik dengan HighLoad ++ 2018</a></li>
<li><a href="../id458486/index.html">Rahasia bekerja dengan kain di game Alan Wake</a></li>
<li><a href="../id458488/index.html">Intisari Ilmu Data (Juli 2019)</a></li>
<li><a href="../id458490/index.html">Pegang erat-erat ke roda kemudi ... Proyek kami untuk memantau kondisi pengemudi</a></li>
<li><a href="../id458492/index.html">“Kami selalu percaya pada kompetisi dan hak untuk memilih pengguna” © Yandex</a></li>
<li><a href="../id458494/index.html">Contoh praktis menggunakan fungsi render Vue: membuat kisi tipografi untuk sistem desain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>