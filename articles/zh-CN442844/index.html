<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤔 🕺🏽 🕺🏼 Kapitan掌舵Kubernetes 💱 🌗 ⌛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="认识Kapitan 。 它可以帮助您为Kubernetes配置带来美感和秩序。 


 Kapitan从满意的用户评论中赢得声誉，因此免除了广泛的文档和昂贵的营销。 Kubernetes博客和传教士对我们有足够的评价和提及。 卡皮坦甚至成为本书整章的主角。 最重要的是，他吸引了几家有前途的公司的注意...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kapitan掌舵Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/442844/"><p><img src="https://habrastorage.org/webt/ph/zq/gy/phzqgyy4cpjrjdrbepggrga2rms.jpeg"></p><br><p> 认识<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kapitan</a> 。 它可以帮助您为<strong>Kubernetes</strong>配置带来美感和秩序。 </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kapitan</a>从满意的用户评论中赢得声誉，因此免除了广泛的文档和昂贵的营销。  Kubernetes博客和传教士对我们有足够的评价和提及。 卡皮坦甚至成为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">本书</a>整章的主角。 最重要的是，他吸引了几家有前途的公司的注意力，因为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kapitan</a>和其他公司一样，能够解开<strong>与海结</strong>有关的<strong>配置</strong> 。 </p><br><p> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubernetes.slack.com上，＃</a> kapitan设法聚集了一个小而敬业的社区（加入！），所以我们为我们的工作感到自豪：） </p><br><p> 许多人仍然认为Kapitan是jsonnet和jinja的混合体，但他们没有指出要点。 <br> 在这篇文章中，我将告诉您Kapitan如何管理Kubernetes部署，但总的来说，它还具有更多功能。 这很重要：Kapitan是通用的，并且不固定在一个Kubernetes上。  Kubernetes只是众多用途之一。 </p><br><p> 这不是指南（尽管我也承诺提供指南）。 我只想告诉您我们为什么这样做，以及它应该解决的Kubernetes配置部署有哪些问题。 </p><a name="habracut"></a><br><h3 id="chto-mne-ne-nravilos"> 我不喜欢的 </h3><br><p> 我从2015年开始尝试Kubernetes，并立即坠入爱河。 <br> 确实，我不想忍受几个缺点： </p><br><ul><li> <strong>语境</strong> 。 对我来说，这是理解<strong>Kubernetes</strong>的最困难的概念之一，也是最危险的概念之一。 上下文是指客户端，这很难理解，在运行<strong>kubectl</strong>命令时会被混淆地调用并造成混乱。 我讨厌kubectl中的上下文！ </li><li>  <strong>详细的嵌套配置（yaml！）</strong> 。 我不得不出汗以找出清单中每个Yaml配置级别。 在几个地方重复标签两到三遍的意义何在？ </li><li>  <strong>与命令性和声明性团队混为一谈</strong> 。 尽管很明显普通人不使用Kubernetes，但<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">鼓励</a>命令团队学习新手。 我认为，要使Kubernetes适应您公司的正确部署策略就更困难了。 破坏者：没有单一的“正确策略”。 </li><li>  <strong>运行时配置</strong> 。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Jesse Suen</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">建议</a>不要将配置参数传递给helm命令行（或kubectl等类似命令）时<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">是</a>正确的。 使用参数，同一命令每次可以不同地执行。 </li><li>  <strong>应用配置</strong> 我们了解了如何在Kubernetes中管理Yaml清单，我们很棒。 这就是部署和部署-这是一个空碗。 它仍然必须使用所有配置浮动应用程序。 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>开发人员希望度过一个假期</strong></a> ，而Kubernetes的工作流程仍然有些混乱。  Kubernetes的拥护者迫使所有人都去那里做。 有必要吗？ 服从Kelsey Hightower！ </li><li>  <strong>经营者</strong> 我对他们有不同的感觉，所以现在就离开这个话题:)我只能说他们经常被滥用。 </li><li>  <strong>幂等</strong> 。 而是她的缺席。 如果我们总结以上所有缺点，我们将得到幂等的工作流，这对于Kubernetes来说是可悲的。 </li></ul><br><h3 id="chto-delat"> 怎么办 </h3><br><p> 我试图解决这些问题，并建立了一个小型模板系统，该系统使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">j2cli</a>和几个bash脚本来管理Kubernetes配置。 </p><br><p> 系统将所有内容都放入environmentA.yaml文件中，并在Jinja2模板中使用了它。 使用一个简单的命令就可以从几个组件部署微服务风格的应用程序： </p><br><pre><code class="plaintext hljs">bin/apply.sh environments/environmentA.yaml</code> </pre> <br><p> 好酷！  Yaml与部署有关。 这非常方便，因为我可以将同一文件用作其他信息的来源。 说... <strong>bash脚本</strong> ！ </p><br><p> 我想出了如何将yaml中的值导入脚本以执行类似的命令： </p><br><pre> <code class="plaintext hljs">bin/create_kafka_topics.sh environments/environmentA.yaml</code> </pre> <br><p>  <em>然后，一切立即失去控制</em> ： </p><br><ul><li> 我无法对yaml文件中的结构进行任何操作。 它是相同字段，值和混乱配置的混搭。 </li><li> 尝试之前，您永远不会知道如何在环境中进行行为部署。 通常这是由于在没有定义此功能的环境中无法使用的新清单值（例如，feature_X）导致jinja2模板发生了更改。 </li><li> 脚本也有同样的麻烦：如果不尝试，就会不知道。 </li><li> 有时Kubernetes更改如此之快，以至于困扰我不断地更改不同版本的清单，尤其是弄乱了值的注释。 </li><li>  <strong>外部因素</strong> ：开发团队从配置文件切换到命令行参数。 这种微小的变化使我们感到困惑，因此我们不得不考虑一种新的解决方案。 </li><li>  <strong>最重要的是</strong> ：用Jinja（或Go模板）来模板yaml并不有趣！ 然后，我们有一个谜语：“ <em>是什么看起来像文本，读起来像文本，闻起来像文本，而不是文本？</em>  ”。 或者，正如李·布里格斯（Lee Briggs）恰当地指出的那样：“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">为什么我们要模板yaml？</a>  ” </li></ul><br><h3 id="kapitan-stanovlenie">  Kapitan：成为 </h3><br><p> 我们收集了所有痛苦的经验，并与Ricardo Amaro一起幻想着理想的配置管理系统。 那时我们仍然没有清晰的画面，但是我们知道我们爱过，我们不爱过。 </p><br><p>  <strong>爱</strong> ： </p><br><ul><li> 吉特 </li><li> 常规模式：数据/值与模式分开。 </li><li> 不同方面（应用程序，Kubernetes，运行时...）的单独值。 </li><li> 面向对象的方法。 </li><li> 简化的yaml作为隐藏Kubernetes复杂性的接口。 </li><li> 清楚了解正在发生的事情以及原因。 </li><li> 在不同组件中重复使用值。 </li><li> 并且脚本应该有权访问值。 </li></ul><br><p>  <strong>我们不喜欢</strong> ： </p><br><ul><li>  Kubectl上下文 </li><li> 用于创建Yaml的文本模板引擎。 </li><li> 缩进计数： <code>{{ toYaml .Values.resources | indent 10 }}</code>  <code>{{ toYaml .Values.resources | indent 10 }}</code> 。 </li><li> 魔术：一切都应该清晰明了。 没有技巧 </li><li> 手动管理应用程序的密码和机密。 </li><li> 分iller方式：我们想控制清单的使用。 </li><li>  Git-crypt方法：磁盘上的机密未加密。 </li><li> 模板管道直接到kubectl。 </li><li> 传递命令行选项。 </li></ul><br><p>  <strong>然后发生了两件事</strong> ： </p><br><ol><li> 我们发现了戴夫·坎宁安（Dave Cunningham）的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">jsonnet</a> ，以一种面向对象的语言来模板化yaml / json。 </li><li> 古斯塔沃·布里奥拉（Gustavo Buriola）向我们展示了重新<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>分类</strong></a> ，没有他，我们就不会走得太远。 </li></ol><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">里卡多·阿玛罗（Ricardo Amaro）</a>开始工作，很快整个团队就坐在Kapitan上-一些人从事基本功能的工作，其他人则在我们内部项目中的使用。 秘密管理，gpg \ kms支持，用户定义的功能：现在，Kapitan是功能完善的产品，其功能超出了预期。 </p><br><h3 id="kto-takoy-kapitan"> 谁是卡皮丹？ </h3><br><p>  Kapitan试图解决我所谈论的所有（或几乎所有）问题。 </p><br><p>  <strong>从技术角度来看，</strong> Kapitan非常简单： </p><br><ul><li>  <strong>库存</strong> ：描述基于yaml的部署的值的分层集合。 基于重分类。 像希拉。 </li><li>  <strong>模板引擎</strong> ：现在是Jinja2，Jsonnet，Kadet。 他们盘点并创建文件（yaml，json，文档或bash脚本）。 </li><li>  <strong>机密</strong> ：模板机密，Kapitan将对其进行处理。 </li></ul><br><p> 我们正在使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">jsonnet</a>来制作宣言模板，而Jinja来完成其余工作。 </p><br><blockquote> 有时人们会抱怨jsonnet文件与同一个Yaml完全不同，因此他们很难切换到jsonnet。 <br><br> 我们试图通过用python封装yaml来解决Kadet的问题。 以您最喜欢的yaml为基础，并向其中添加Python。 <br><br> 认为这是yaml的<strong>Python外骨骼</strong> ！ 我会以某种方式谈论这个。 </blockquote><p>  <strong>在工作流程中，</strong> Kapitan立即显示以下字符： </p><br><ul><li>  <strong>自由选择</strong> ：我们不强加任何工作流程和技术，但通常会按照以下描述的原则进行工作。 实际上，可以根据需要使用Kapitan。 您不需要使用git，也不必在其中编译文件，甚至可以不用jsonnet！ 做你想做的。 </li><li> 骨头骨髓的<strong>GitOps</strong> ：一切都在git中，一切都在<strong>主</strong>光下反映了我们的意图。 </li><li>  <strong>可声明性</strong> ：Kapitan欢迎以特定表示形式的清单模板的编译。 然后您编译脚本。 </li><li>  <strong>受控上下文</strong> ：例如，在设置上下文和配置集群时，我们使用编译脚本来简化工作。 <br>  Kubernetes配置： <code>compiled/target_A/setup/setup.sh</code> <br> 应用更改： <code>compiled/target_A/setup/apply.sh</code> </li><li>  <strong>幂等性</strong> ：Kapitan允许您更改模板和代码重构工具。 没有命令，编译的清单和代码将不会更改，因此重构时无需担心。 </li><li>  <strong>原因和结果</strong> ：我们的工作流程是在一个合并请求中包含对清单或模板的更改以及已编译文件的更改。 因此，审阅者将能够评估您的更改及其实际后果。 很高兴知道模板的更改是否会影响一个，两个或多个目标。 </li><li>  <strong>最后</strong> ：Kapitan不隶属于Kubernetes。 它只是创建文件。 部署变更涉及到<strong>kubectl</strong> 。 我们只为以一致的方式执行命令提供外壳。 </li></ul><br><h3 id="ono-mne-nado"> 我需要吗？ </h3><br><p>  <strong>让我们说清楚</strong> ：您可能还不需要Kapitan。 </p><br><p> 但这完全取决于您要执行的操作以及系统的复杂程度。 </p><br><p>  <strong>Kapitan是强大的</strong>投资<strong>工具</strong> 。 在必须在一堆群集上部署一堆应用程序的复杂场景中使用它。 </p><br><p> 如果您具有标准应用程序，那么您只是在学习Kubernetes或已经对您的工作流程感到满意，那么<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Helm</a>或它的当前替代品将起作用。 </p><br><p> 我想<strong>Helm</strong>是<strong>Kubernetes的最佳选择</strong> ，而<strong>Kapitan</strong>就像<strong>Puppet</strong>一样。 </p><br><p> 在下一篇文章中，我将给出具体示例并详细描述清单。 在这篇文章中写出您想知道的内容或您同意/不同意的内容。 </p><br><p> 感谢<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Jacek Gruzewski</a> 。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN442844/">https://habr.com/ru/post/zh-CN442844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN442830/index.html">阿努比斯创作者被捕</a></li>
<li><a href="../zh-CN442832/index.html">为什么测试不仅限于发现错误</a></li>
<li><a href="../zh-CN442834/index.html">通过Windows部署服务和Microsoft部署工具包安装Windows</a></li>
<li><a href="../zh-CN442836/index.html">Vue.js渲染函数和过渡（由Hajime Yamasaki Vukelic翻译）</a></li>
<li><a href="../zh-CN442840/index.html">后端联合3：果冻</a></li>
<li><a href="../zh-CN442846/index.html">我们的航天工业。 从普通开发商的角度看行业问题</a></li>
<li><a href="../zh-CN442852/index.html">2005年的Dell 6000或Hello</a></li>
<li><a href="../zh-CN442854/index.html">我们如何制定明斯克的地铁方案</a></li>
<li><a href="../zh-CN442856/index.html">二合一：Wi-Fi可编程空气质量监测仪和时钟</a></li>
<li><a href="../zh-CN442858/index.html">非洲大象太多了吗？ 与人类社区和平共处如何在这方面有所帮助</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>