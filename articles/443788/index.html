<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò¢Ô∏è üí™üèΩ üë®üèø‚Äç‚öïÔ∏è Los fundamentos del enrutamiento est√°tico en Mikrotik RouterOS üë©‚Äçüöí üà∫ üßïüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El enrutamiento es el proceso de encontrar la ruta √≥ptima para la transmisi√≥n de paquetes en redes TCP / IP. Cualquier dispositivo conectado a una red...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Los fundamentos del enrutamiento est√°tico en Mikrotik RouterOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443788/"><p>  El enrutamiento es el proceso de encontrar la ruta √≥ptima para la transmisi√≥n de paquetes en redes TCP / IP.  Cualquier dispositivo conectado a una red IPv4 contiene un proceso y tablas de enrutamiento. </p><br><p>  Este art√≠culo no es un C√ìMO, describe el enrutamiento est√°tico en RouterOS como un ejemplo, omit√≠ intencionalmente el resto de las configuraciones (por ejemplo, srcnat para acceder a Internet), por lo que comprender este material requiere un cierto nivel de conocimiento de redes y RouterOS. </p><a name="habracut"></a><br><h3 id="kommutaciya-i-marshrutizaciya">  Conmutaci√≥n y enrutamiento </h3><br><p><img src="https://habrastorage.org/webt/5v/h7/a2/5vh7a2relrje9g9e5kbonuogsqw.png"></p><br><p>  La conmutaci√≥n es el proceso de intercambio de paquetes dentro de un segmento de capa 2 (Ethernet, ppp, ...).  Si el dispositivo ve que el destinatario del paquete se encuentra en la misma subred de Ethernet que √©l, reconoce la direcci√≥n mac mediante el protocolo arp y env√≠a el paquete directamente, sin pasar por el enrutador.  Una conexi√≥n ppp (punto a punto) puede tener solo dos miembros y el paquete siempre se env√≠a a la misma direcci√≥n 0xff. </p><br><p>  El enrutamiento es el proceso de transmisi√≥n de paquetes entre segmentos de capa 2.  Si el dispositivo desea enviar un paquete, cuyo destinatario est√° fuera del segmento de Ethernet, mira su tabla de enrutamiento y pasa el paquete a una puerta de enlace que sabe d√≥nde enviar el paquete m√°s adelante (o tal vez no lo sabe, el remitente original del paquete no lo sabe). </p><br><p>  La forma m√°s f√°cil de considerar un enrutador es como un dispositivo conectado a dos o m√°s segmentos de Capa 2 y capaz de transferir paquetes entre ellos, determinando la ruta √≥ptima desde la tabla de enrutamiento. </p><br><p>  Si todo est√° claro para ti o si ya lo sab√≠as, sigue leyendo.  Recomiendo encarecidamente que otros lean un art√≠culo peque√±o pero muy completo. </p><br><h3 id="marshrutizaciya-v-routeros-i-packetflow">  Enrutamiento en RouterOS y PacketFlow </h3><br><p>  Casi toda la funcionalidad relacionada con el enrutamiento est√°tico est√° en el paquete del <em>sistema</em> .  El paquete de <em>enrutamiento</em> agrega soporte para algoritmos de enrutamiento din√°mico (RIP, OSPF, BGP, MME), filtros de enrutamiento y BFD. </p><br><p> El men√∫ principal para configurar el enrutamiento: <code>[IP]-&gt;[Route]</code> .  Los esquemas complejos pueden requerir el etiquetado preliminar de los paquetes con una etiqueta de enrutamiento en: <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> (cadenas <code>PREROUTING</code> y <code>OUTPUT</code> ). </p><br><p>  Hay tres lugares en PacketFlow donde se toman decisiones sobre el enrutamiento de paquetes IP: <br><img src="https://habrastorage.org/webt/pk/ie/mp/pkiempktzjkwz6tcwrnwyl1c1dc.png"></p><br><ol><li>  Enrutamiento de paquetes recibidos por el enrutador.  En esta etapa, se decide que el paquete ir√° al proceso local o se enviar√° m√°s a la red.  Los paquetes de tr√°nsito reciben una <em>interfaz de salida</em> </li><li>  Enrutamiento de paquetes salientes locales.  Los paquetes salientes reciben una <em>interfaz de salida</em> </li><li>  Un paso de enrutamiento adicional para los paquetes salientes le permite cambiar la decisi√≥n de enrutamiento en <code>[Output|Mangle]</code> </li></ol><br><ul><li>  La ruta del paquete en los bloques 1, 2 depende de las reglas en <code>[IP]-&gt;[Route]</code> </li><li>  La ruta del paquete en los pasos 1, 2 y 3 depende de las reglas en <code>[IP]-&gt;[Route]-&gt;[Rules]</code> </li><li>  La ruta del paquete en los bloques 1, 3 puede verse afectada usando <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> </li></ul><br><h3 id="rib-fib-routing-cache">  RIB, FIB, cach√© de enrutamiento </h3><br><p><img src="https://habrastorage.org/webt/fw/jc/ku/fwjckuzqzyxo4udazveb8uhotuq.png"></p><br><p>  <strong>Base de informaci√≥n de enrutamiento</strong> <br>  La base en la que se recopilan las rutas de los protocolos de enrutamiento din√°mico, rutas de ppp y dhcp, rutas est√°ticas y conectadas.  Esta base de datos contiene todas las rutas excepto las filtradas por el administrador. </p><br><p>  <em>Por convenci√≥n</em> , podemos suponer que <code>[IP]-&gt;[Route]</code> muestra RIB. </p><br><p>  <strong>Base de informaci√≥n de reenv√≠o</strong> <br><img src="https://habrastorage.org/webt/kt/jn/q1/ktjnq1ebrd0--d9afkseuixtap8.png"></p><br><p>  La base donde van las mejores rutas desde RIB.  Todas las rutas en la FIB est√°n activas y se utilizan para reenviar paquetes.  Si la ruta se vuelve inactiva (desactivada por el administrador (sistema), o la interfaz a trav√©s de la cual se debe enviar el paquete est√° inactiva), la ruta se elimina de la FIB. </p><br><p>  Para tomar una decisi√≥n sobre el enrutamiento, se utilizan los siguientes datos del paquete IP en la tabla FIB: </p><br><ul><li>  Direcci√≥n de origen </li><li>  Direcci√≥n de destino </li><li>  Interfaz fuente </li><li>  Marca de enrutamiento </li><li>  ToS (DSCP) </li></ul><br><p>  Entrar en el paquete FIB pasa por las siguientes etapas: </p><br><ul><li>  ¬øEl paquete est√° dise√±ado para el proceso del enrutador local? </li><li>  ¬øEl paquete cae bajo el sistema PBR o las reglas del usuario? <br><ul><li>  Si es as√≠, el paquete se env√≠a a la tabla de enrutamiento especificada. </li></ul></li><li>  El paquete se env√≠a a la tabla principal. </li></ul><br><p>  <em>Por convenci√≥n</em> , podemos suponer que <code>[IP]-&gt;[Route Active=yes]</code> muestra FIB. </p><br><p>  <strong>Enrutamiento de cach√©</strong> <br>  El mecanismo para el almacenamiento en cach√© de rutas.  El enrutador recuerda a d√≥nde se enviaron los paquetes, y si hay otros similares (presumiblemente de la misma conexi√≥n), los inicia a lo largo de la misma ruta, sin registrar el FIB.  La cach√© de ruta se borra peri√≥dicamente. </p><br><p>  Para los administradores, RouterOS no ten√≠a los medios para ver y administrar el cach√© de enrutamiento, pero con √©l puede deshabilitarlo en <code>[IP]-&gt;[Settings]</code> . </p><br><p>  <em>Este mecanismo se ha eliminado del n√∫cleo Linux 3.6, pero el n√∫cleo 3.3.5 todav√≠a se utiliza en RouterOS, posiblemente el enrutamiento de cach√© es una de las razones.</em> </p><br><h3 id="dialog-dobavleniya-marshruta">  Cuadro de di√°logo Agregar ruta </h3><br><p> <code>[IP]-&gt;[Route]-&gt;[+]</code> <br> <img src="https://habrastorage.org/webt/th/lb/el/thlbel_kvf2gk-s2125imh_z7cg.png"></p><br><ol><li>  La subred para la que desea crear una ruta (valor predeterminado: 0.0.0.0/0) </li><li>  Puerta de enlace IP o interfaz a la que se enviar√° el paquete (puede haber varias, consulte ECMP a continuaci√≥n) </li><li>  Comprobaci√≥n de disponibilidad de puerta de enlace </li><li>  Tipo de registro </li><li>  Distancia (m√©trica) para la ruta </li><li>  Tabla de enrutamiento </li><li>  IP para paquetes salientes locales a trav√©s de esta ruta </li><li>  El prop√≥sito de Scope y Target Scope est√° escrito al final del art√≠culo. </li></ol><br><p>  <strong>Banderas de ruta</strong> <br><img src="https://habrastorage.org/webt/ai/ro/iv/airoivo1bmk3lgbqj_hivpbjdyc.png"></p><br><ul><li>  X: el administrador <code>disabled=yes</code> ruta ( <code>disabled=yes</code> ) </li><li>  A - La ruta se usa para transmitir paquetes. </li><li>  D - Ruta agregada din√°micamente (BGP, OSPF, RIP, MME, PPP, DHCP, Conectado) </li><li>  C - La subred est√° conectada directamente al enrutador </li><li>  S - Ruta est√°tica </li><li>  r, b, o, m: la ruta se agreg√≥ mediante uno de los protocolos de enrutamiento din√°mico </li><li>  B, U, P: ruta de filtrado (descarta paquetes en lugar de transmitir) </li></ul><br><h3 id="chto-ukazyvat-v-gateway-ip-adres-ili-interfeys">  ¬øQu√© especificar en la puerta de enlace: direcci√≥n IP o interfaz? </h3><br><p>  El sistema le permite especificarlos a ambos, mientras que no jura ni da pistas si hizo algo mal. </p><br><p>  <strong>Direcci√≥n IP</strong> <br>  La direcci√≥n de la puerta de enlace debe ser accesible a trav√©s de Layer2.  Para Ethernet, esto significa que el enrutador debe tener una direcci√≥n IP de la misma subred en una de las interfaces activas, para ppp, que la direcci√≥n de la puerta de enlace aparece en una de las interfaces activas como la direcci√≥n de subred. <br>  Si no se cumple la condici√≥n de disponibilidad para Layer2, la ruta se considera inactiva y no cae en la FIB. </p><br><p>  <strong>Interfaz</strong> <br>  Todo es m√°s complicado y el comportamiento del enrutador depende del tipo de interfaz: </p><br><ul><li>  PPP (Async, PPTP, L2TP, SSTP, PPPoE, OpenVPN *) la conexi√≥n asume que solo hay dos participantes y el paquete siempre se enviar√° a la puerta de enlace para la transmisi√≥n, si la puerta de enlace detecta que es el propio destinatario, transferir√° el paquete a su proceso local. <br><img src="https://habrastorage.org/webt/90/-g/xk/90-gxkgtlplrv8sstcs4r70bxx4.png"></li><li>  Ethernet asume que hay muchos participantes y enviar√° solicitudes a la interfaz arp con la direcci√≥n del receptor de paquetes, este es el comportamiento esperado y bastante normal para las rutas conectadas. <br>  Pero cuando intenta utilizar la interfaz como una ruta para una subred remota, obtiene la siguiente situaci√≥n: la ruta est√° activa, el ping pasa a la puerta de enlace, pero no llega al destinatario desde la subred especificada.  Si observa la interfaz a trav√©s de un sniffer, ver√° solicitudes arp con direcciones de una subred remota. <br><img src="https://habrastorage.org/webt/62/si/qp/62siqpa8gbtxi-8x4eymxgv19vi.png"></li></ul><br><p><img src="https://habrastorage.org/webt/i6/-n/nb/i6-nnbyrlylq0jk6pqwefb_2qz8.png"></p><br><p>  Intente especificar la direcci√≥n IP como puerta de enlace siempre que sea posible.  Las excepciones son las rutas conectadas (creadas autom√°ticamente) y las interfaces PPP (Async, PPTP, L2TP, SSTP, PPPoE, OpenVPN *). </p><br><p>  <em>OpenVPN no contiene un encabezado PPP, pero puede usar el nombre de la interfaz OpenVPN para crear la ruta.</em> </p><br><h3 id="more-specific-route">  Ruta m√°s espec√≠fica </h3><br><p>  La regla b√°sica de enrutamiento.  Una ruta que describe una subred m√°s peque√±a (con la m√°scara de subred m√°s grande) tiene una mayor prioridad al decidir el enrutamiento de paquetes.  La posici√≥n de las entradas en la tabla de enrutamiento no est√° relacionada con la selecci√≥n: la regla b√°sica es m√°s espec√≠fica. </p><br><p><img src="https://habrastorage.org/webt/sm/cy/i9/smcyi9gkebkm8iq-yjcbev8-vs0.png"></p><br><p>  Todas las rutas del esquema especificado est√°n activas (ubicadas en la FIB), porque  apuntan a diferentes subredes y no entren en conflicto entre s√≠. </p><br><p>  Si una de las puertas de enlace no est√° disponible, la ruta asociada se considerar√° inactiva (eliminada de la FIB) y se buscar√°n paquetes de las rutas restantes. </p><br><p>  Una ruta con una subred de 0.0.0.0/0 a veces tiene un significado especial y se denomina "Ruta predeterminada" o "puerta de enlace de √∫ltimo recurso".  De hecho, no hay nada m√°gico en √©l y simplemente incluye todas las direcciones IPv4 posibles, pero estos nombres describen bien su prop√≥sito: indica una puerta de enlace donde reenviar paquetes para los que no hay otras rutas m√°s precisas. </p><br><p>  La m√°scara de subred m√°xima posible para IPv4 es / 32; esta ruta apunta a un host espec√≠fico y se puede usar en la tabla de enrutamiento. </p><br><p>  <em>Comprender la ruta m√°s espec√≠fica es fundamental para cualquier dispositivo TCP / IP.</em> </p><br><h3 id="distance">  Distancia </h3><br><p>  Las distancias (o m√©tricas) son necesarias para el filtrado administrativo de rutas a una subred accesible a trav√©s de varias puertas de enlace.  Una ruta con una m√©trica m√°s baja se considera una prioridad y estar√° en la FIB.  Si una ruta con una m√©trica m√°s baja deja de estar activa, entonces en la FIB ser√° reemplazada por una ruta con una m√©trica m√°s alta. <br><img src="https://habrastorage.org/webt/dz/yz/mh/dzyzmhb2y_fjqpbkbp2juyhfxsi.png"></p><br><p>  Si hay varias rutas a la misma subred con la misma m√©trica, el enrutador agregar√° solo una de ellas a la tabla FIB, guiado por su l√≥gica interna. </p><br><p>  La m√©trica puede tomar un valor de 0 a 255: <br><img src="https://habrastorage.org/webt/rh/fk/j1/rhfkj1shnnjhqmvwhcc7o0itq8i.png"></p><br><ul><li>  0: m√©trica para rutas conectadas.  El administrador no puede establecer la distancia 0 </li><li>  1-254: m√©tricas disponibles para el administrador para configurar rutas.  Las m√©tricas con un valor m√°s bajo tienen prioridad. </li><li>  255 - M√©trica disponible para el administrador para configurar rutas.  A diferencia de 1-254, una ruta con una m√©trica de 255 siempre permanece inactiva y no cae en la FIB </li><li>  M√©tricas especiales.  Las rutas recibidas de los protocolos de enrutamiento din√°mico tienen valores m√©tricos est√°ndar </li></ul><br><h3 id="check-gateway">  Comprobar puerta de enlace </h3><br><p>  Comprobar puerta de enlace: extensi√≥n MikroTik RoutesOS para verificar la disponibilidad de la puerta de enlace a trav√©s de icmp o arp.  Una vez cada 10 segundos (no se puede cambiar), se env√≠a una solicitud a la puerta de enlace, si la respuesta no llega dos veces, la ruta se considera no disponible y se elimina de la FIB.  Si la pasarela de verificaci√≥n ha deshabilitado la ruta de verificaci√≥n, contin√∫a y la ruta se activa nuevamente despu√©s de una verificaci√≥n exitosa. <br><img src="https://habrastorage.org/webt/a_/km/vd/a_kmvd8xeoeyrnjqz78ciry1ja4.png"></p><br><p>  Comprobar puerta de enlace deshabilita la entrada en la que est√° configurada y todas las dem√°s entradas (en todas las tablas de enrutamiento y rutas ecmp) con la puerta de enlace especificada. </p><br><p>  En general, comprobar la puerta de enlace funciona bien si no hay ning√∫n problema con la p√©rdida de paquetes en la puerta de enlace.  Check Gateway no sabe qu√© sucede con la comunicaci√≥n fuera de la puerta de enlace comprobada, para esto se necesitan herramientas adicionales: scripts, enrutamiento recursivo, protocolos de enrutamiento din√°mico. </p><br><p>  La mayor√≠a de las VPN y los protocolos de t√∫nel contienen herramientas integradas para verificar la actividad de conexi√≥n, lo que permite verificar las puertas de enlace para ellos es una carga adicional (pero muy peque√±a) en la red y el rendimiento del dispositivo. </p><br><h3 id="ecmp-marshruty">  Rutas de ECMP </h3><br><p>  Ruta m√∫ltiple de igual costo: env√≠o de paquetes al destinatario utilizando varias puertas de enlace al mismo tiempo con el algoritmo Round Robin. </p><br><p>  El administrador crea una ruta ECMP especificando m√∫ltiples puertas de enlace para una subred (o autom√°tica, si hay dos rutas equivalentes OSPF). <br><img src="https://habrastorage.org/webt/4v/gz/yh/4vgzyh240kmasdj186yz2c3ovws.png"></p><br><p>  El ECMP se usa para equilibrar la carga entre dos canales, en teor√≠a, si hay dos canales en una ruta ecmp, entonces, para cada paquete, el canal saliente debe ser diferente.  Pero el mecanismo de enrutamiento de cach√© env√≠a paquetes desde la conexi√≥n a lo largo de la ruta a la que fue el primer paquete, como resultado, obtenemos una especie de equilibrio de carga por conexi√≥n. </p><br><p>  Si deshabilita la cach√© de enrutamiento, los paquetes en la ruta ECMP se dividir√°n correctamente, pero hay un problema con NAT.  La regla NAT procesa solo el primer paquete de la conexi√≥n (el resto se procesa autom√°ticamente) y la situaci√≥n es que los paquetes con una direcci√≥n de origen van desde diferentes interfaces. <br><img src="https://habrastorage.org/webt/gj/cw/bl/gjcwblj73dmsczyhyqyuchcpdw0.png"></p><br><p>  Comprobar puerta de enlace (error RouterOS) no funciona en rutas ECMP.  Pero puede evitar esta limitaci√≥n si crea rutas adicionales para la verificaci√≥n, lo que deshabilitar√° las entradas en ECMP. </p><br><h3 id="filtraciya-sredstvami-routing">  Filtrado de enrutamiento </h3><br><p>  La opci√≥n Tipo determina qu√© hacer con el paquete: </p><br><ul><li>  unicast: enviar a la puerta de enlace especificada (interfaz) </li><li>  agujero negro - soltar el paquete </li><li>  prohibir, inalcanzable: descarte el paquete y env√≠e un mensaje icmp al remitente </li></ul><br><p>  El filtrado generalmente se usa cuando necesita asegurar el env√≠o de paquetes de manera incorrecta, por supuesto, puede filtrar esto a trav√©s de un firewall. </p><br><h3 id="para-primerov">  Un par de ejemplos </h3><br><p>  Para arreglar cosas b√°sicas sobre el enrutamiento. </p><br><p>  <strong>Enrutador casero t√≠pico</strong> <br><img src="https://habrastorage.org/webt/2a/fk/xx/2afkxxlv7lhluitqufsybt3s5pg.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1</code> </pre> <br><ol><li>  Ruta est√°tica a 0.0.0.0/0 (ruta predeterminada) </li><li>  Ruta conectada en la interfaz con el proveedor </li><li>  Ruta conectada en la interfaz LAN </li></ol><br><p>  <strong>Enrutador casero PPPoE t√≠pico</strong> <br><img src="https://habrastorage.org/webt/im/wn/8p/imwn8pafrqins6erowkhiek2dqa.png"></p><br><ol><li>  Ruta est√°tica a ruta predeterminada, agregada autom√°ticamente desde  esto se indica en las propiedades de conexi√≥n </li><li>  Ruta conectada para conexi√≥n PPP </li><li>  Ruta conectada en la interfaz LAN </li></ol><br><p>  <strong>Enrutador dom√©stico t√≠pico con dos proveedores y redundancia</strong> <br><img src="https://habrastorage.org/webt/wq/2a/v0/wq2av0eskridghrj9yroknjz76o.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 distance=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><ol><li>  Ruta est√°tica a la ruta predeterminada a trav√©s del primer proveedor con m√©trica 1 y verificar la disponibilidad de la puerta de enlace </li><li>  Ruta est√°tica a ruta predeterminada a trav√©s del segundo proveedor con m√©trica 2 </li><li>  Rutas conectadas </li></ol><br><p>  El tr√°fico a 0.0.0.0/0 pasa por 10.10.10.1, mientras esta puerta de enlace est√° disponible, de lo contrario cambia a 10.20.20.1 </p><br><p>  <em>Tal esquema puede considerarse reserva de canal, pero no est√° exento de inconvenientes.</em>  <em>Si se produce una interrupci√≥n fuera de la puerta de enlace del proveedor (por ejemplo, dentro de la red del operador), su enrutador no lo sabr√° y seguir√° considerando la ruta activa.</em> </p><br><p>  <strong>Enrutador dom√©stico t√≠pico con dos proveedores, redundancia y ECMP</strong> <br><img src="https://habrastorage.org/webt/un/fj/aw/unfjawyzmjdzo6_ekmmg93vlsk8.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1,10.20.20.1 distance=1</code> </pre> <br><ol><li>  Rutas est√°ticas para verificar chack gateway </li><li>  Ruta ECMP </li><li>  Rutas conectadas </li></ol><br><p>  Rutas para verificar el azul (el color de las rutas inactivas), pero esto no interfiere con el funcionamiento de la puerta de enlace de verificaci√≥n.  En la versi√≥n actual (6.44) RoS, se da prioridad autom√°tica a la ruta ECMP, pero es mejor agregar rutas de prueba a otras tablas de enrutamiento (opci√≥n <code>routing-mark</code> ) </p><br><p>  No habr√° aumento de velocidad en Speedtest y otros sitios similares (ECMP divide el tr√°fico por conexiones, no por paquetes), pero las aplicaciones p2p deber√≠an cargarse m√°s r√°pido. </p><br><p>  <strong>Filtrando a trav√©s del enrutamiento</strong> <br><img src="https://habrastorage.org/webt/gv/bj/nh/gvbjnhvblrebv9051hd_x8adklo.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 add dst-address=192.168.200.0/24 gateway=10.30.30.1 distance=1 add dst-address=192.168.200.0/24 gateway=10.10.10.1 distance=2 type=blackhole</code> </pre> <br><ol><li>  Ruta est√°tica a ruta predeterminada </li><li>  Ruta est√°tica a 192.168.200.0/24 a trav√©s del t√∫nel ipip </li><li>  Prohibir la ruta est√°tica a 192.168.200.0/24 a trav√©s del enrutador del proveedor </li></ol><br><p>  Una opci√≥n de filtrado en la que el tr√°fico del t√∫nel no va al enrutador del proveedor cuando la interfaz ipip est√° desactivada.  Tales esquemas rara vez se requieren, porque  Es posible implementar el bloqueo a trav√©s del firewall. </p><br><p>  <strong>Bucle de enrutamiento</strong> <br>  Un bucle de enrutamiento es una situaci√≥n en la que un paquete se ejecuta entre enrutadores antes de que ttl caduque.  Por lo general, es una consecuencia de un error de configuraci√≥n, en redes grandes se trata mediante la implementaci√≥n de protocolos de enrutamiento din√°mico, en redes peque√±as, con cuidado. </p><br><p>  Se parece a esto: <br><img src="https://habrastorage.org/webt/ii/h8/-v/iih8-vpacnim4b6flslcvy-v0eg.png"></p><br><p>  Ejemplo (m√°s simple) de c√≥mo obtener un resultado similar: <br><img src="https://habrastorage.org/webt/ky/9v/gv/ky9vgvnxvno8x79cbu79be0_buu.png"></p><br><p>  El ejemplo del bucle de enrutamiento no tiene un uso pr√°ctico, pero muestra que los enrutadores no tienen idea de la tabla de enrutamiento de sus vecinos. </p><br><h3 id="policy-base-routing-i-dopolnitelnye-tablicy-marshrutizacii">  Enrutamiento base de pol√≠ticas y tablas de enrutamiento adicionales </h3><br><p>  Al elegir una ruta, el enrutador usa solo un campo del encabezado del paquete (Direcci√≥n Dst.): Esta es la ruta b√°sica.  El enrutamiento basado en otras condiciones, como la direcci√≥n de origen, el tipo de tr√°fico (ToS), el equilibrio sin ECMP, se refiere al enrutamiento base de pol√≠ticas (PBR) y utiliza tablas de enrutamiento adicionales. </p><br><p><img src="https://habrastorage.org/webt/cf/31/fj/cf31fjsrsjd2aszbzkl_hmg9wuw.png"></p><br><p>  <em>Una ruta m√°s espec√≠fica</em> es la regla b√°sica para elegir una ruta dentro de una tabla de enrutamiento. </p><br><p>  Por defecto, todas las reglas de enrutamiento se agregan a la tabla principal.  Un administrador puede crear un n√∫mero arbitrario de tablas de enrutamiento adicionales y enrutarles paquetes.  Las reglas en diferentes tablas no entran en conflicto entre s√≠.  Si el paquete no encuentra una regla adecuada en la tabla especificada, ir√° a la tabla principal. </p><br><p>  Ejemplo de distribuci√≥n a trav√©s de Firewall: <br><img src="https://habrastorage.org/webt/uw/nd/jz/uwndjzt8mtfett8l84vg-n65p90.png"></p><br><ul><li>  192.168.100.10 -&gt; 8.8.8.8 <br><ol><li>  El tr√°fico de 192.168.100.10 recibe la <em>etiqueta via-isp1</em> en <code>[Prerouting|Mangle]</code> </li><li>  En la etapa de enrutamiento, en la tabla <em>via-isp1,</em> se busca <em>una ruta</em> hasta 8.8.8.8 </li><li>  Se encuentra la ruta, el tr√°fico se env√≠a a la puerta de enlace 10.10.10.1 </li></ol></li><li>  192.168.200.20 -&gt; 8.8.8.8 <br><ol><li>  El tr√°fico de 192.168.200.20 recibe la <em>etiqueta via-isp2</em> en <code>[Prerouting|Mangle]</code> </li><li>  En la etapa de enrutamiento, la tabla <em>via-isp2 busca</em> una ruta de hasta 8.8.8.8 </li><li>  Se encuentra la ruta, el tr√°fico se env√≠a a la puerta de enlace 10.20.20.1 </li></ol></li><li>  Si una de las puertas de enlace (10.10.10.1 o 10.20.20.1) no est√° disponible, entonces el paquete ir√° a la tabla <em>principal</em> y buscar√° una ruta adecuada all√≠ </li></ul><br><h3 id="problemy-terminologii">  Problemas terminol√≥gicos </h3><br><p>  RouterOS tiene ciertos problemas de terminolog√≠a. <br>  Al trabajar con reglas en <code>[IP]-&gt;[Routes]</code> se indica la tabla de enrutamiento, aunque dice que la etiqueta: <br><img src="https://habrastorage.org/webt/8i/kh/kh/8ikhkhsxvmlwnh9hd9g-quxnk18.png"></p><br><p>  En <code>[IP]-&gt;[Routes]-&gt;[Rule]</code> todo es correcto, en la etiqueta de condici√≥n en la acci√≥n de la tabla: <br><img src="https://habrastorage.org/webt/0m/hl/5j/0mhl5jj73m7rfm4rvtb5qwpbix4.png"></p><br><h3 id="kak-otpravit-paket-v-opredelennuyu-tablicu-marshrutizacii">  C√≥mo enviar un paquete a una tabla de enrutamiento espec√≠fica </h3><br><p>  RouterOS proporciona varias herramientas: </p><br><ul><li>  Reglas en <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> </li><li>  Etiquetas de ruta ( <code>action=mark-routing</code> ) en <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> </li><li>  VRF </li></ul><br><p>  <strong>Reglas <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br>  Las reglas se procesan secuencialmente, si el paquete coincide con las condiciones de la regla, no va m√°s all√°. </p><br><p>  Las reglas de enrutamiento le permiten ampliar las capacidades de enrutamiento, confiando no solo en la direcci√≥n del destinatario, sino tambi√©n en la direcci√≥n de origen y la interfaz a la que se recibi√≥ el paquete. </p><br><p><img src="https://habrastorage.org/webt/hg/ip/py/hgippyt0pgilh0l9zouqqqpbsoe.png"></p><br><p>  Las reglas consisten en condiciones y acciones: </p><br><ul><li>  Condiciones.  Pr√°cticamente repiten la lista de signos por los cuales se verifica el paquete en la FIB; solo falta ToS. </li><li>  Acciones <br><ul><li>  buscar: enviar un paquete a una mesa </li><li>  buscar solo en la tabla: bloquee el paquete en la tabla; si no se encuentra la ruta, el paquete no ir√° a la tabla principal </li><li>  soltar - soltar el paquete </li><li>  inalcanzable: descarte el paquete de notificaci√≥n del remitente </li></ul></li></ul><br><p>  En la FIB, el tr√°fico a los procesos locales se procesa sin pasar por las reglas <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : <br><img src="https://habrastorage.org/webt/yk/f4/gt/ykf4gt4ywwzgbklpyzlyulije8k.png"></p><br><p>  <strong>Marcado <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>  Las etiquetas de ruta le permiten configurar la puerta de enlace para el paquete utilizando casi cualquier condici√≥n de firewall: <br><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><p>  <em>Pr√°cticamente, porque no todos tienen sentido, y algunos pueden funcionar de manera inestable.</em> </p><br><p><img src="https://habrastorage.org/webt/6b/_m/om/6b_mom-f6nde0zyuy-mr62asho4.png"></p><br><p>  Hay dos formas de marcar un paquete: </p><br><ul><li>  Establecer <em>marca de enrutamiento</em> inmediatamente </li><li>  Primero establezca <em>la marca de conexi√≥n</em> , luego bas√°ndose en <em>la marca de conexi√≥n</em> establezca la <em>marca de</em> <em>enrutamiento</em> </li></ul><br><p>  En un art√≠culo sobre firewall, escrib√≠ que la segunda opci√≥n es preferible porque  reduce la carga en la CPU, en el caso de marcar rutas, esto no es del todo cierto.  Estos m√©todos de marcado no siempre son equivalentes y generalmente se usan para resolver varios problemas. </p><br><h3 id="primery-ispolzovaniya">  Ejemplos de uso </h3><br><p>  Pasamos a ejemplos de uso de enrutamiento de base de pol√≠ticas, es mucho m√°s f√°cil mostrarles por qu√© se necesita todo esto. </p><br><p>  <strong>MultiWAN y tr√°fico saliente de respuesta (salida)</strong> <br>  Un problema com√∫n con la configuraci√≥n de MultiWAN: Mikrotik es accesible desde Internet solo a trav√©s del proveedor "activo". <br><img src="https://habrastorage.org/webt/ob/1p/ph/ob1pph0eph9qvz9nqvt759mptiq.png"></p><br><p>  No importa al enrutador a qu√© IP lleg√≥ la solicitud; al generar una respuesta, buscar√° una ruta en la tabla de enrutamiento, donde la ruta a trav√©s de isp1 est√° activa.  Adem√°s, dicho paquete probablemente se filtrar√° en el camino hacia el destinatario. </p><br><p>  <em>Otro punto interesante.</em>  <em>Si la fuente "simple" nat est√° configurada en la interfaz ether1: <code>/ip fi nat add out-interface=ether1 action=masquerade</code> paquete ir√° a la red con src.</em>  <em>address = 10.10.10.100, lo que agravar√° a√∫n m√°s la situaci√≥n.</em> </p><br><p>  Hay varias formas de solucionar el problema, pero cualquiera de ellas requerir√° tablas de enrutamiento adicionales: <br><img src="https://habrastorage.org/webt/g9/65/vy/g965vychbnzbsksplywfc3npi90.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping distance=1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping distance=2 add dst-address=0.0.0.0/0 gateway=10.10.10.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 routing-mark=over-isp2</code> </pre> <br><p>  <strong>Uso de <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br>  Especifique la tabla de enrutamiento que se utilizar√° para los paquetes con la IP de origen especificada. <br><img src="https://habrastorage.org/webt/na/lm/b3/nalmb3u0yrde35z0mzdjm1xygr4.png"></p><br><pre> <code class="plaintext hljs">/ip route rule add src-address=10.10.10.100/32 action=lookup-only-in-table table=over-isp1 add src-address=10.20.20.200/32 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>  <em>Puede usar <code>action=lookup</code> , pero para el tr√°fico saliente local, esta opci√≥n excluye completamente las conexiones de la interfaz incorrecta.</em> </p><br><ul><li>  El sistema genera un paquete de respuesta con Src.  Direcci√≥n: 10.20.20.200 </li><li>  En la etapa de Decisi√≥n de enrutamiento (2), <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> se verifica y el paquete se env√≠a a la tabla de enrutamiento <em>sobre-isp2</em> </li><li>  De acuerdo con la tabla de enrutamiento, el paquete debe enviarse a la puerta de enlace 10.20.20.1 a trav√©s de la interfaz ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/k-/zf/sg/k-zfsgxxdpqbufnwoobbno8d_aq.png"></p><br><p>  Este m√©todo no requiere un Rastreador de conexiones que funcione, a diferencia del uso de la tabla Mangle. </p><br><p>  <strong>Uso de <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>  La conexi√≥n comienza con el paquete entrante, por lo que lo marcamos ( <code>action=mark-connection</code> ), para los paquetes salientes de la conexi√≥n marcada establecemos la etiqueta de ruta ( <code>action=mark-routing</code> ). <br><img src="https://habrastorage.org/webt/lg/4v/ni/lg4vni1mt8eteade7mcitz_3s3g.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle #   add chain=input in-interface=ether1 connection-state=new action=mark-connection new-connection-mark=from-isp1 add chain=input in-interface=ether2 connection-state=new action=mark-connection new-connection-mark=from-isp2 #      add chain=output connection-mark=from-isp1 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=output connection-mark=from-isp2 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p> <em>      ip,     <code>dst-address</code>  .</em> </p><br><ul><li>   ether2    .    <code>[INPUT|Mangle]</code>         <em>from-isp2</em> </li><li>      Src. Address: 10.20.20.200 </li><li>   Routing Decision(2)          10.20.20.1   ether1.        <code>[OUTPUT|Filter]</code> </li><li>   <code>[OUTPUT|Mangle]</code>       <em>from-isp2</em>      <em>over-isp2</em> </li><li>   Routing Adjusment(3)             </li><li>            10.20.20.1   ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/rd/mr/qs/rdmrqst9dam9m7r9s4jsnudwdly.png"></p><br><h3 id="multiwan-i-otvetnyy-dst-nat-trafik"> MultiWAN   dst-nat  </h3><br><p>  ,        ( web)             . </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether1 action=dst-nat to-address=192.168.100.100 add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether2 action=dst-nat to-address=192.168.100.100</code> </pre> <br><p>     ,      Firewall Mangle,     : <br><img src="https://habrastorage.org/webt/3w/9i/pq/3w9ipqogda4itpjkpvqbw7ewxrg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting connection-state=new in-interface=ether1 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp1 add chain=prerouting connection-state=new in-interface=ether2 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp2 add chain=prerouting connection-mark=web-input-isp1 in-interface=ether3 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting connection-mark=web-input-isp2 in-interface=ether3 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/fb/qf/np/fbqfnpzfpcshxwzl2ruppyjh5qw.png"><br> <em>    NAT,      .</em> </p><br><h3 id="multiwan-i-ishodyaschie-soedineniya"> MultiWAN    </h3><br><p>    PBR    vpn (  SSTP)     . </p><br><p><img src="https://habrastorage.org/webt/pt/jg/m3/ptjgm36vdijiuvygzwl8csvwg5q.png"></p><br><p>   : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=192.168.100.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 routing-mark=over-isp3 add dst-address=0.0.0.0/0 gateway=192.168.100.1 distance=1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 distance=2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 distance=3</code> </pre> <br><p>  : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output dst-address=10.10.10.100 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp1 passtrough=no add chain=output dst-address=10.10.10.101 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp2 passtrough=no add chain=output dst-address=10.10.10.102 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp3 passtrough=no</code> </pre> <br><p>   NAT,        Src. Address: </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=srcnat out-interface=ether1 action=masquerade add chain=srcnat out-interface=ether2 action=masquerade add chain=srcnat out-interface=ether3 action=masquerade</code> </pre> <br><p> : </p><br><ul><li>     SSTP </li><li>   Routing Decision (2)     ,     main.       Src. Address    ether1 </li><li>  <code>[Output|Mangle]</code>        </li><li>         Routing Adjusment        </li><li>       Src. Address  ether1,   <code>[Nat|Srcnat]</code>       </li></ul><br><p> ,        : <br><img src="https://habrastorage.org/webt/i9/gd/x0/i9gdx0o9s0iqnr4shoxdtfqnh2i.png"></p><br><p> Connection Tracker   <code>[Mangle]</code>  <code>[Srcnat]</code> ,       ,      <code>Replay Dst. Address</code>    NAT: <br><img src="https://habrastorage.org/webt/ps/op/qa/psopqak9ysxfem9lebg7woyizk4.png"></p><br><p>  VPN  (      )         : <br><img src="https://habrastorage.org/webt/s7/nc/jz/s7ncjzninvkxn_a6-p3wdd5ywnw.png"></p><br><p> <strong> </strong> <br>   ,         : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=10.10.10.100 gateway=192.168.100.1 add dst-address=10.10.10.101 gateway=192.168.200.1 add dst-address=10.10.10.102 gateway=192.168.0.1</code> </pre> <br><p>              . ,        vpn      ,     6   <code>[IP]-&gt;[Routes]</code>  <code>type=blackhole</code> .    ‚Äî 3   <code>[IP]-&gt;[Route]-&gt;[Rules]</code> . </p><br><h3 id="raspredelenie-soedineniy-polzovateley-po-kanalam-svyazi">       </h3><br><p> ,  .      : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2</code> </pre> <br><p> <strong> <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br><img src="https://habrastorage.org/webt/-m/4o/jv/-m4ojve7wspajkjoc00afbpsbru.png"></p><br><pre> <code class="plaintext hljs">/ip route rules add src-address=192.168.100.0/25 action=lookup-only-in-table table=over-isp1 add src-address=192.168.100.128/25 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>action=lookup</code> ,           main     .     ‚Äî   . </p><br><p> <strong>   <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>     ip .       . <em>  layer7,      ,      ,       .</em> <br><img src="https://habrastorage.org/webt/u8/k5/yi/u8k5yito7_iuseo5cki-nhkaz5o.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address-list=users-over-isp1 dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 add chain=prerouting src-address-list=users-over-isp2 dst-address-type=!local action=mark-routing new-routing-mark=over-isp2</code> </pre> <br><p> ""        <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : </p><br><pre> <code class="plaintext hljs">/ip route rules add routing-mark=over-isp1 action=lookup-only-in-table table=over-isp1 add routing-mark=over-isp2 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>[IP]-&gt;[Firewall]-&gt;[Filter]</code> : </p><br><pre> <code class="plaintext hljs">/ip firewall filter add chain=forward routing-mark=over-isp1 out-interface=!ether1 action=reject add chain=forward routing-mark=over-isp2 out-interface=!ether2 action=reject</code> </pre> <br><p> <strong>  <code>dst-address-type=!local</code></strong> <br>   <code>dst-address-type=!local</code>           (dns, winbox, ssh, ...).       ,          ,   <code>dst-address-table</code> . </p><br><p>     <code>[IP]-&gt;[Route]-&gt;[Rules]</code>   ,      .   ,    FIB    <code>[PREROUTING|Mangle]</code>           main,    .    Routing Rules,            User PBR      . </p><br><p> <strong> <code>[IP]-&gt;[Firewall]-&gt;[Mangle action=route]</code></strong> <br>      <code>[Prerouting|Mangle]</code>            ,    : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address=192.168.100.0/25 action=route gateway=10.10.10.1 add chain=prerouting src-address=192.168.128.0/25 action=route gateway=10.20.20.1</code> </pre> <br><p>  <code>route</code>        ( <code>[IP]-&gt;[Route]-&gt;[Rules]</code> ).          ,    <code>action=route</code>    <code>action=mark-route</code> ,     (    <code>passtrough</code> ),   . <br> <em> wiki            ,               .</em> </p><br><h3 id="dinamicheskaya-balansirovka-na-osnove-ppc">     PPC </h3><br><p> Per Connection Classificator ‚Äî     ECMP.    ECMP       (ECMP     ,     Routing Cache   ). </p><br><p> PCC  <em> </em>  ip ,    32-     <em></em> .       <em></em>    ,    . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> .  ,  . <br><img src="https://habrastorage.org/webt/md/xn/kz/mdxnkzst4p7nxatp2bnvjbrlsoe.png"></p><br><p>    : </p><br><pre> <code class="plaintext hljs">192.168.100.10: 192+168+100+10 = 470 % 3 = 2 192.168.100.11: 192+168+100+11 = 471 % 3 = 0 192.168.100.12: 192+168+100+12 = 472 % 3 = 1</code> </pre> <br><p>      src.address   : <br><img src="https://habrastorage.org/webt/sq/dn/rt/sqdnrtcsgypqle5ftv2rg23xvmg.png"></p><br><pre> <code class="plaintext hljs">#  /ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=3 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=1 routing-mark=over-isp3 #    /ip firewall mangle add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/0 action=mark-connection new-connection-mark=conn-over-isp1 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/1 action=mark-connection new-connection-mark=conn-over-isp2 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/2 action=mark-connection new-connection-mark=conn-over-isp3 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp1 action=mark-routing new-routing-mark=over-isp1 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp2 action=mark-routing new-routing-mark=over-isp2 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp3 action=mark-routing new-routing-mark=over-isp3</code> </pre> <br><p>      : <code>in-interface=br-lan</code> ,    <code>action=mark-routing</code>               . </p><br><h3 id="pereklyuchenie-kanalov-svyazi">    </h3><br><p> Check ping ‚Äî  ,        IP ,                 ,            ,   check ping          . <br>           BGP,                 . </p><br><p>   ,        ip    ,      ,  google dns: 8.8.8.8. 8.8.4.4.    Mikrotik      . </p><br><p> <strong>    </strong> <br>      Multihop BGP               MikroTik,          check gateway       . </p><br><p>         scope/target scope       : <br><img src="https://habrastorage.org/webt/_m/kz/aw/_mkzawioocf0friubndc9q2pofw.png"></p><br><ol><li>           scope      main      target scope </li><li>     ,        </li><li>   connected        </li></ol><br><p>        ,    : <br><img src="https://habrastorage.org/webt/s4/jo/tv/s4jotv0vsxcofu8pcod2uzugfo4.png"></p><br><ul><li> 1-3  connected    ,       </li><li> 4-6   connected   ""  </li></ul><br><p>        RIB,   FIB    : <code>0.0.0.0/0 via 10.10.10.1 on ether1</code> . </p><br><p> <strong>      </strong> <br><img src="https://habrastorage.org/webt/f1/gd/hj/f1gdhjwli1fqi4yk7i-cfdyf2l0.png"></p><br><p> : <br><img src="https://habrastorage.org/webt/d8/bb/ae/d8bbaepprp0wswv54ly0ryzphhc.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=8.8.8.8 check-gateway=ping distance=1 target-scope=10 add dst-address=8.8.8.8 gateway=10.10.10.1 scope=10 add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><p>  ,      10.10.10.1: <br><img src="https://habrastorage.org/webt/k6/nq/a9/k6nqa98jmecubjxx8e2zndbclcc.png"></p><br><p> Check gateway          ping'   8.8.8.8,  (   main)    10.10.10.1. </p><br><p>      10.10.10.1  8.8.8.8,    ,   (  ping)  8.8.8.8    10.10.10.1: <br><img src="https://habrastorage.org/webt/hj/v2/tg/hjv2tg5bnkaae2gyr7iunr74kt4.png"></p><br><p>      ether1,    ,    8.8.8.8    : <br><img src="https://habrastorage.org/webt/rt/_d/ad/rt_dadf8--ghn5pmgyg7q1ya258.png"></p><br><p>  ,    NetWatch      8.8.8.8.    NetWatch            .     : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=8.8.8.8 gateway=10.20.20.1 distance=100 type=blackhole</code> </pre> <br><p><img src="https://habrastorage.org/webt/ks/6e/k3/ks6ek3swyj9uyiih0bkbef1i6eu.png"></p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> ,    NetWatch   . </p><br><p>  ,      8.8.8.8       ,       dns    . </p><br><h3 id="para-slov-pro-virtual-routing-and-forwarding-vrf">    Virtual Routing and Forwarding (VRF) </h3><br><p>  VRF         ,        (    MPLS)    L3VPN     : <br><img src="https://habrastorage.org/webt/hk/0l/ep/hk0lep0gncmeajzj1pkp2wix6yk.png"></p><br><p>  VRF  Mikrotik         ,   ip      VRF,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> . </p><br><p>   vrf: <br><img src="https://habrastorage.org/webt/gl/g8/k8/glg8k8isgjjsgyjodp7-rnqq5fi.png"></p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0</code> </pre> <br><p>     ether2 ,   ping      vrf (  ),   ping    : <br><img src="https://habrastorage.org/webt/pz/a7/h_/pza7h_xts_jyk6czos89h47q45u.png"></p><br><p>            main (  vrf   route leaking): <br><img src="https://habrastorage.org/webt/on/p-/5z/onp-5z4cvah-erroi_flwnjn2ik.png"></p><br><pre> <code class="plaintext hljs">/ip route add distance=1 gateway=172.17.0.1@main routing-mark=vrf1 add distance=1 gateway=172.17.0.1%wlan1 routing-mark=vrf2</code> </pre> <br><p> <em>    route leaking:   : <code>172.17.0.1@main</code>    : <code>172.17.0.1%wlan1</code> .</em> </p><br><p>        <code>[PREROUTING|Mangle]</code> : <br><img src="https://habrastorage.org/webt/ge/w3/pa/gew3paz7vdzqkzc0-pt0mz5b6yg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting in-interface=ether1 action=mark-connection new-connection-mark=from-vrf1 passthrough=no add chain=prerouting connection-mark=from-vrf1 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting in-interface=ether2 action=mark-connection new-connection-mark=from-vrf2 passthrough=no add chain=prerouting connection-mark=from-vrf2 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/i8/dd/kx/i8ddkxzzdogtht7gvzyo-rzcr-g.png"></p><br><p> <strong>   </strong> <br>            VRF  netmap: <br><img src="https://habrastorage.org/webt/yl/vx/kb/ylvxkbg-tyalsczpx9datttwgs0.png"></p><br><p>  : </p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 add address=192.168.0.1/24 interface=ether3 network=192.168.0.0</code> </pre> <br><p>  firewall: </p><br><pre> <code class="plaintext hljs">#        /ip firewall mangle add chain=prerouting dst-address=192.168.101.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting dst-address=192.168.102.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf2 passthrough=no # netmap   ""     /ip firewall nat add chain=dstnat dst-address=192.168.101.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24 add chain=dstnat dst-address=192.168.102.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">#      route leaking,       connected  /ip route add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf1 add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf2</code> </pre> <br><p> <strong>    dhcp    </strong> <br> VRF   ,       (  dhcp client)    . </p><br><p>    vrf: </p><br><pre> <code class="plaintext hljs">/ip route vrf add interface=ether1 routing-mark=over-isp1</code> </pre> <br><p>     (  )   <em>over-isp1</em> : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output out-interface=!br-lan action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting in-interface=br-lan dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 passthrough=no</code> </pre> <br><p> ,      : </p><br><pre> <code class="plaintext hljs">/interface bridge add name=bare /ip route add dst-address=0.0.0.0/0 gateway=bare</code> </pre> <br><p>            Routing decision (2)  <code>[OUTPUT|Mangle]</code>    ,         0.0.0.0/0   main   . <br><img src="https://habrastorage.org/webt/ff/p-/qh/ffp-qhi41y5wxswp6wzrtp69bjk.png"></p><br><h3 id="cepochki-connected-in-i-dynamic-in-v-routing---filters">  <code>connected-in</code>  <code>dynamic-in</code>  <code>[Routing] -&gt; [Filters]</code> </h3><br><p>   (  ) ‚Äî           (      <em>routing</em> ),        : </p><br><ul><li> connected-in ‚Äî  connected  </li><li> dynamic-in ‚Äî     PPP  DCHP </li></ul><br><p>      ,     : distance, routing-mark, comment, scope, target scope, ... </p><br><p>         -  Routing Filters (  ),    Routing Filters,           .     Routing Filters      . </p><br><p> <strong> Routing Mark   </strong> <br>    .     VPN            .     -      : </p><br><pre> <code class="plaintext hljs">#  vpn    default route    /interface pptp-client add connect-to=XXXX add-default-route=yes default-route-distance=101 ... add connect-to=YYYY add-default-route=yes default-route-distance=100 ... #             /routing filter add chain=dynamic-in distance=100 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn1 add chain=dynamic-in distance=101 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn2</code> </pre> <br><p> <em>  ,  ,    vrf  ppp ,    0.0.0.0/0     main.      .</em> </p><br><p> <strong> Connected </strong> <br>    : </p><br><pre> <code class="plaintext hljs">/route filter add chain=connected-in prefix=192.168.100.0/24 action=reject</code> </pre> <br><h3 id="instrumenty-otladki">   </h3><br><p> RouterOS      : </p><br><ul><li> <code>[Tool]-&gt;[Torch]</code> ‚Äî      </li><li> <code>/ip route check</code> ‚Äî        ,      </li><li> <code>/ping routing-table=&lt;name&gt;</code>  <code>/tool traceroute routing-table=&lt;name&gt;</code> ‚Äî ping       </li><li> <code>action=log</code>  <code>[IP]-&gt;[Firewall]</code> ‚Äî  ,       packet flow,         </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/443788/">https://habr.com/ru/post/443788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../443774/index.html">C√≥mo la neurobiolog√≠a interfiere en las elecciones presidenciales de EE. UU.</a></li>
<li><a href="../443776/index.html">China introduce un sistema experimental de reconocimiento facial al pagar el metro</a></li>
<li><a href="../443780/index.html">Proyecto MCDM. Parte 1. Concepto</a></li>
<li><a href="../443782/index.html">Los desarrolladores ahora pueden usar la API de red de Valve para sus juegos de Steam</a></li>
<li><a href="../443786/index.html">An√°lisis del segundo concurso de cuestionarios de Android del stand de HeadHunter en Mobius 2018 Mosc√∫</a></li>
<li><a href="../443792/index.html">Errores t√≠picos al trabajar con PostgreSQL. Parte 2</a></li>
<li><a href="../443794/index.html">Las principales direcciones para las nuevas empresas de TI en el campo de las ventas de bienes ra√≠ces</a></li>
<li><a href="../443798/index.html">Hacks de Zotero: almacenamiento sincronizado ilimitado y su uso sin problemas con rmarkdown</a></li>
<li><a href="../443804/index.html">C # es un lenguaje de bajo nivel?</a></li>
<li><a href="../443808/index.html">An√°lisis de ni√±as con baja responsabilidad social (a cargo de Power BI, Qlik Sense, Tableau)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>