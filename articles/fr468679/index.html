<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶î ‚úÖ üßíüèæ L'ABC de la s√©curit√© dans Kubernetes: authentification, autorisation, audit ü¶â üëåüèΩ ü§∂üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="T√¥t ou tard, le fonctionnement de tout syst√®me pose la question de la s√©curit√©: assurer l'authentification, la s√©paration des droits, l'audit et autre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'ABC de la s√©curit√© dans Kubernetes: authentification, autorisation, audit</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/468679/"><img src="https://habrastorage.org/webt/ao/pp/ke/aoppkeeufk5-tv1rmtmtw9oce7a.png"><br><br>  T√¥t ou tard, le fonctionnement de tout syst√®me pose la question de la s√©curit√©: assurer l'authentification, la s√©paration des droits, l'audit et autres t√¢ches.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">De nombreuses solutions</a> ont d√©j√† √©t√© cr√©√©es pour Kubernetes qui peuvent atteindre la conformit√© aux normes m√™me dans des environnements tr√®s exigeants ... Le m√™me mat√©riel est consacr√© aux aspects de s√©curit√© de base mis en ≈ìuvre dans le cadre des m√©canismes int√©gr√©s de K8.  Tout d'abord, il sera utile pour ceux qui commencent √† se familiariser avec Kubernetes, comme point de d√©part pour √©tudier les probl√®mes li√©s √† la s√©curit√©. <a name="habracut"></a><br><br><h2>  Authentification </h2><br>  Kubernetes a deux types d'utilisateurs: <br><br><ul><li>  <i>Comptes de service</i> - comptes g√©r√©s par l'API Kubernetes; </li><li>  <i>Utilisateurs</i> - <i>utilisateurs</i> ¬´normaux¬ª contr√¥l√©s par des services externes ind√©pendants. </li></ul><br>  La principale diff√©rence entre ces types est que pour les comptes de service, il existe des objets sp√©ciaux dans l'API Kubernetes (ils sont appel√©s <code>ServiceAccounts</code> ) qui sont li√©s √† l'espace de noms et √† l'ensemble de donn√©es d'autorisation stock√©es dans le cluster dans des objets de type Secrets.  Ces utilisateurs (comptes de service) sont principalement destin√©s √† g√©rer les droits d'acc√®s aux processus de l'API Kubernetes ex√©cut√©s dans un cluster Kubernetes. <br><br>  Les utilisateurs ordinaires n'ont pas d'entr√©es dans l'API Kubernetes: elles doivent √™tre g√©r√©es par des m√©canismes externes.  Ils sont destin√©s aux personnes ou processus vivant en dehors du cluster. <br><br>  Chaque demande √† l'API est li√©e soit au compte de service, soit √† l'utilisateur, ou est consid√©r√©e comme anonyme. <br><br>  Les donn√©es d'authentification des utilisateurs incluent: <br><br><ul><li>  <i>Nom d'utilisateur</i> - nom d'utilisateur (sensible √† la casse!); </li><li>  <i>L'UID</i> est une cha√Æne d'identification d'utilisateur lisible par machine qui est ¬´plus coh√©rente et unique que le nom d'utilisateur¬ª; </li><li>  <i>Groupes</i> - une liste des groupes auxquels l'utilisateur appartient; </li><li>  <i>Extra</i> - champs suppl√©mentaires pouvant √™tre utilis√©s par le m√©canisme d'autorisation. </li></ul><br>  Kubernetes peut utiliser un grand nombre de m√©canismes d'authentification: certificats X509, jetons de support, procurations d'authentification, HTTP Basic Auth.  En utilisant ces m√©canismes, un grand nombre de sch√©mas d'autorisation peuvent √™tre mis en ≈ìuvre: d'un fichier statique avec des mots de passe √† OpenID OAuth2. <br><br>  De plus, plusieurs r√©gimes d'autorisation sont autoris√©s en m√™me temps.  Par d√©faut, le cluster utilise: <br><br><ul><li>  jetons de compte de service - pour les comptes de service; </li><li>  X509 - pour les utilisateurs. </li></ul><br>  La question sur la gestion des ServiceAccounts d√©passe le cadre de cet article, mais je recommande de commencer √† en savoir plus sur ce probl√®me √† partir de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">page de documentation officielle</a> .  Nous examinerons plus en d√©tail la question du travail des certificats X509. <br><br><h3>  Certificats pour les utilisateurs (X.509) </h3><br>  La mani√®re classique de travailler avec des certificats implique: <br><br><ul><li>  g√©n√©ration de cl√©s: <br><br><pre> <code class="bash hljs">mkdir -p ~/mynewuser/.certs/ openssl genrsa -out ~/.certs/mynewuser.key 2048</code> </pre> </li><li>  g√©n√©ration de demande de certificat: <br><br><pre> <code class="bash hljs">openssl req -new -key ~/.certs/mynewuser.key -out ~/.certs/mynewuser.csr -subj <span class="hljs-string"><span class="hljs-string">"/CN=mynewuser/O=company"</span></span></code> </pre> </li><li>  traitement de la demande de certificat √† l'aide des cl√©s d'autorit√© de certification du cluster Kubernetes, obtention d'un certificat utilisateur (pour obtenir un certificat, vous devez utiliser un compte qui a acc√®s √† la cl√© d'autorit√© de certification du cluster Kubernetes, qui se trouve dans <code>/etc/kubernetes/pki/ca.key</code> par d√©faut): <br><br><pre> <code class="bash hljs">openssl x509 -req -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ~/.certs/mynewuser.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out ~/.certs/mynewuser.crt -days 500</code> </pre> </li><li>  cr√©ation d'un fichier de configuration: <br><ul><li>  description du cluster (sp√©cifiez l'adresse et l'emplacement du fichier de certificat CA de l'installation de cluster particuli√®re): <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.100.200:6443</code> </pre> </li><li>  ou - si ce <b>n'est pas l'</b> option recommand√©e - vous pouvez omettre le certificat racine (alors kubectl ne v√©rifiera pas l'exactitude du cluster api-server): <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-cluster kubernetes --insecure-skip-tls-verify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --server=https://192.168.100.200:6443</code> </pre> </li><li>  ajout d'un utilisateur au fichier de configuration: <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-credentials mynewuser --client-certificate=.certs/mynewuser.crt --client-key=.certs/mynewuser.key</code> </pre> </li><li>  ajout de contexte: <br><br><pre> <code class="bash hljs">kubectl config <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-context mynewuser-context --cluster=kubernetes --namespace=target-namespace --user=mynewuser</code> </pre> </li><li>  affectation de contexte par d√©faut: <br><br><pre> <code class="bash hljs">kubectl config use-context mynewuser-context</code> </pre> </li></ul></li></ul><br>  Apr√®s les manipulations ci-dessus, une configuration du formulaire sera cr√©√©e dans le fichier <code>.kube/config</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: v1 clusters: - cluster: certificate-authority: /etc/kubernetes/pki/ca.crt server: https://192.168.100.200:6443 name: kubernetes contexts: - context: cluster: kubernetes namespace: target-namespace user: mynewuser name: mynewuser-context current-context: mynewuser-context kind: Config preferences: {} users: - name: mynewuser user: client-certificate: /home/mynewuser/.certs/mynewuser.crt client-key: /home/mynewuser/.certs/mynewuser.key</code> </pre> <br>  Pour faciliter le transfert de la configuration entre les comptes et les serveurs, il est utile de modifier les valeurs des cl√©s suivantes: <br><br><ul><li> <code>certificate-authority</code> </li> <li> <code>client-certificate</code> </li> <li> <code>client-key</code> </li> </ul><br>  Pour ce faire, vous pouvez encoder les fichiers qui y sont indiqu√©s en utilisant base64 et les enregistrer dans la configuration en ajoutant le suffixe <code>-data</code> au nom des cl√©s, c'est-√†-dire  obtenir <code>certificate-authority-data</code> , etc. <br><br><h3>  Certificats avec kubeadm </h3><br>  Avec la sortie de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kubernetes 1.15,</a> travailler avec des certificats est devenu beaucoup plus facile gr√¢ce √† la version alpha de son support dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'utilitaire kubeadm</a> .  Par exemple, voici √† quoi pourrait ressembler la g√©n√©ration d'un fichier de configuration avec des cl√©s utilisateur: <br><br><pre> <code class="bash hljs">kubeadm alpha kubeconfig user --client-name=mynewuser --apiserver-advertise-address 192.168.100.200</code> </pre> <br>  <i><b>NB</b> : L' <i>adresse de publicit√©</i> requise peut √™tre consult√©e dans la configuration d'api-server, qui se trouve par d√©faut dans <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> .</i> <br><br>  La configuration r√©sultante sera sortie sur stdout.  Il doit √™tre enregistr√© dans <code>~/.kube/config</code> compte utilisateur ou dans le fichier sp√©cifi√© dans la <code>KUBECONFIG</code> environnement <code>KUBECONFIG</code> . <br><br><h3>  Creusez plus profond√©ment </h3><br>  Pour ceux qui souhaitent bien comprendre les probl√®mes d√©crits: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article s√©par√©</a> sur l'utilisation des certificats dans la documentation officielle de Kubernetes; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un bon article de Bitnami</a> , qui aborde la question des certificats d'un point de vue pratique. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation g√©n√©rale d'</a> authentification dans Kubernetes. </li></ul><br><h2>  Se connecter </h2><br>  Un compte authentifi√© n'est pas autoris√© √† agir dans un cluster par d√©faut.  Kubernetes dispose d'un m√©canisme d'autorisation pour accorder des autorisations. <br><br>  Avant la version 1.6, Kubernetes utilisait un type d'authentification appel√© <b>ABAC</b> (contr√¥le d'acc√®s bas√© sur les attributs).  Des d√©tails √† ce sujet peuvent √™tre trouv√©s dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> .  Cette approche est actuellement consid√©r√©e comme h√©rit√©e, mais vous pouvez toujours l'utiliser en m√™me temps que d'autres types d'autorisation. <br><br>  La fa√ßon actuelle (et plus flexible) de diviser les droits d'acc√®s aux clusters est appel√©e <b>RBAC</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contr√¥le d'acc√®s bas√© sur les r√¥les</a> ).  Il a √©t√© d√©clar√© stable depuis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kubernetes 1.8</a> .  RBAC met en ≈ìuvre un mod√®le de droits qui interdit tout ce qui n'est pas explicitement autoris√©. <br>  <b>Pour activer RBAC</b> , vous devez ex√©cuter Kubernetes api-server avec l' <code>--authorization-mode=RBAC</code> .  Les param√®tres sont d√©finis dans le manifeste avec la configuration api-server, qui par d√©faut se trouve sur le chemin <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> , dans la section des <code>command</code> .  Cependant, RBAC est d√©j√† activ√© par d√©faut, vous ne devriez donc pas vous en soucier: vous pouvez le v√©rifier par la valeur du <code>authorization-mode</code> d' <code>authorization-mode</code> (dans le <code>kube-apiserver.yaml</code> d√©j√† mentionn√©).  Soit dit en passant, parmi ses valeurs, il peut y avoir d'autres types d'autorisation ( <code>node</code> , <code>webhook</code> , <code>always allow</code> ), mais nous les laisserons en dehors de la port√©e du mat√©riel. <br><br>  Soit dit en passant, nous avons d√©j√† publi√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article</a> avec une histoire assez d√©taill√©e sur les principes et les caract√©ristiques de travailler avec RBAC, donc je me limiterai √† une br√®ve liste des bases et des exemples. <br><br>  Les entit√©s API suivantes sont utilis√©es pour contr√¥ler l'acc√®s √† Kubernetes via RBAC: <br><br><ul><li>  <code>Role</code> et <code>ClusterRole</code> sont des r√¥les qui d√©crivent les privil√®ges: </li><li>  <code>Role</code> vous permet de d√©crire les droits dans un espace de noms; </li><li>  <code>ClusterRole</code> - au sein du cluster, y compris les objets sp√©cifiques au cluster tels que les n≈ìuds, les URL non li√©es aux ressources (c'est-√†-dire non li√©s aux ressources Kubernetes - par exemple, <code>/version</code> , <code>/logs</code> , <code>/api*</code> ); </li><li>  <code>RoleBinding</code> et <code>ClusterRoleBinding</code> - sert √† lier <code>Role</code> et <code>ClusterRole</code> √† un utilisateur, un groupe d'utilisateurs ou un ServiceAccount. </li></ul><br>  Le r√¥le des entit√©s et la liaison de r√¥les sont limit√©s par l'espace de noms, c'est-√†-dire  doit √™tre dans le m√™me espace de noms.  Cependant, RoleBinding peut faire r√©f√©rence √† ClusterRole, qui vous permet de cr√©er un ensemble d'autorisations standard et de contr√¥ler l'acc√®s √† l'aide de celles-ci. <br><br>  Les r√¥les d√©crivent les droits √† l'aide d'ensembles de r√®gles contenant: <br><br><ul><li>  Groupes d'API - voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> des apiGroups et la sortie des <code>kubectl api-resources</code> de <code>kubectl api-resources</code> ; </li><li>  ressources ( <i>ressources</i> : <code>pod</code> , <code>namespace</code> , <code>deployment</code> , etc.); </li><li>  verbes ( <i>verbes</i> : <code>set</code> , <code>update</code> , etc.). </li><li>  noms de ressource ( <code>resourceNames</code> ) - pour le cas o√π vous devez fournir un acc√®s √† une ressource sp√©cifique, et non √† toutes les ressources de ce type. </li></ul><br>  Une discussion plus d√©taill√©e de l'autorisation dans Kubernetes peut √™tre trouv√©e sur la page de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> officielle.  Au lieu de cela (ou plut√¥t, en plus de cela), je donnerai des exemples qui illustrent son travail. <br><br><h3>  Exemples d'entit√©s RBAC </h3><br>  Un <code>Role</code> simple qui vous permet d'obtenir la liste et l'√©tat des pods et de les surveiller dans l' <code>target-namespace</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: target-namespace name: pod-reader rules: - apiGroups: [""] resources: ["pods"] verbs: ["get", "watch", "list"]</code> </pre> <br>  Un exemple de <code>ClusterRole</code> , qui vous permet d'obtenir une liste et l'√©tat des pods et de les surveiller dans tout le cluster: <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: #  "namespace" ,   ClusterRole    name: pod-reader rules: - apiGroups: [""] resources: ["pods"] verbs: ["get", "watch", "list"]</code> </pre> <br>  Exemple <code>RoleBinding</code> , qui permet √† l'utilisateur <code>mynewuser</code> "lire" des pods dans l' <code>my-namespace</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: read-pods namespace: target-namespace subjects: - kind: User name: mynewuser #     ! apiGroup: rbac.authorization.k8s.io roleRef: kind: Role #    ‚ÄúRole‚Äù  ‚ÄúClusterRole‚Äù name: pod-reader #  Role,      namespace, #   ClusterRole,   #    apiGroup: rbac.authorization.k8s.io</code> </pre> <br><h2>  Audit d'√©v√©nement </h2><br>  Sch√©matiquement, l'architecture de Kubernetes peut √™tre repr√©sent√©e comme suit: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/617/793/499/6177934998b4bf1c5c8816c75beaef3f.png" alt="image"><br><br>  Le composant cl√© de Kubernetes, qui est responsable du traitement des demandes, est <b>api-server</b> .  Toutes les op√©rations sur le cluster le traversent.  Pour en savoir plus sur ces m√©canismes internes, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">consultez</a> l'article ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Que se passe-t-il dans Kubernetes lorsque l'ex√©cution de kubectl d√©marre?</a>  ". <br><br>  L'audit syst√®me est une fonctionnalit√© int√©ressante de Kubernetes, qui est d√©sactiv√©e par d√©faut.  Il vous permet de consigner tous les appels vers l'API Kubernetes.  Comme vous pouvez facilement le deviner, gr√¢ce √† cette API, toutes les actions li√©es √† la surveillance et √† la modification de l'√©tat du cluster sont effectu√©es.  Une bonne description de ses fonctionnalit√©s se trouve (comme d'habitude) dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle de</a> K8s.  Ensuite, je vais essayer de pr√©senter le sujet dans un langage plus simple. <br><br>  Donc, <b>pour activer l'audit</b> , nous devons passer trois param√®tres requis au conteneur dans l'api-server, plus sur ce qui est d√©crit ci-dessous: <br><br><ul><li> <code>--audit-policy-file=/etc/kubernetes/policies/audit-policy.yaml</code> </li> <li> <code>--audit-log-path=/var/log/kube-audit/audit.log</code> </li> <li> <code>--audit-log-format=json</code> </li> </ul><br>  En plus de ces trois param√®tres n√©cessaires, il existe de nombreux param√®tres suppl√©mentaires li√©s √† l'audit: de la rotation des journaux aux descriptions des webhooks.  Exemples de param√®tres de rotation des journaux: <br><br><ul><li> <code>--audit-log-maxbackup=10</code> </li> <li> <code>--audit-log-maxsize=100</code> </li> <li> <code>--audit-log-maxage=7</code> </li> </ul><br>  Mais nous ne nous attarderons pas sur eux plus en d√©tail - vous pouvez trouver tous les d√©tails dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation de kube-apiserver</a> . <br><br>  Comme d√©j√† mentionn√©, tous les param√®tres sont d√©finis dans le manifeste avec la configuration api-server (par d√©faut <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> ), dans la section des <code>command</code> .  Revenons aux 3 param√®tres requis et analysons-les: <br><br><ol><li>  <code>audit-policy-file</code> - chemin d'acc√®s au fichier YAML avec la description de la politique d'audit.  Nous reviendrons sur son contenu, mais pour l'instant je note que le fichier doit √™tre accessible √† la lecture par le processus api-server.  Par cons√©quent, il est n√©cessaire de le monter √† l'int√©rieur du conteneur, pour lequel vous pouvez ajouter le code suivant aux sections appropri√©es de la configuration: <br><br><pre> <code class="plaintext hljs"> volumeMounts: - mountPath: /etc/kubernetes/policies name: policies readOnly: true volumes: - hostPath: path: /etc/kubernetes/policies type: DirectoryOrCreate name: policies</code> </pre> </li><li>  <code>audit-log-path</code> - chemin d'acc√®s au fichier journal.  Le chemin devrait √©galement √™tre accessible au processus api-server, par cons√©quent, nous d√©crivons de la m√™me mani√®re son montage: <br><br><pre> <code class="plaintext hljs"> volumeMounts: - mountPath: /var/log/kube-audit name: logs readOnly: false volumes: - hostPath: path: /var/log/kube-audit type: DirectoryOrCreate name: logs</code> </pre> </li><li>  <code>audit-log-format</code> - format du journal d'audit.  Par d√©faut, il s'agit de <code>json</code> , mais le format de texte h√©rit√© est √©galement disponible. </li></ol><br><h3>  Politique d'audit </h3><br>  Maintenant sur le fichier mentionn√© avec la description de la politique de journalisation.  Le premier concept de politique d'audit est le <code>level</code> , le <b>niveau de journalisation</b> .  Ils sont les suivants: <br><br><ul><li>  <code>None</code> - ne vous connectez pas; </li><li>  <code>Metadata</code> - enregistrer les m√©tadonn√©es de demande: utilisateur, heure de la demande, ressource cible (pod, espace de noms, etc.), type d'action (verbe), etc. </li><li>  <code>Request</code> - enregistrer les m√©tadonn√©es et le corps de la demande; </li><li>  <code>RequestResponse</code> - <code>RequestResponse</code> m√©tadonn√©es, le corps de la demande et le corps de la r√©ponse. </li></ul><br>  Les deux derniers niveaux ( <code>Request</code> et <code>RequestResponse</code> ) <code>RequestResponse</code> pas les requ√™tes qui n'ont pas acc√©d√© aux ressources (appels √† des URL dites non-ressources). <br><br>  De plus, toutes les demandes passent par <b>plusieurs √©tapes</b> : <br><br><ul><li>  <code>RequestReceived</code> - l'√©tape √† laquelle la demande est re√ßue par le gestionnaire et n'a pas encore √©t√© transf√©r√©e le long de la cha√Æne de gestionnaires; </li><li>  <code>ResponseStarted</code> - en-t√™tes de r√©ponse envoy√©s, mais avant d'envoyer le corps de la r√©ponse.  G√©n√©r√© pour les longues requ√™tes (par exemple, <code>watch</code> ); </li><li>  <code>ResponseComplete</code> - corps de r√©ponse envoy√©, plus d'informations ne seront pas envoy√©es; </li><li>  <code>Panic</code> - des √©v√©nements sont g√©n√©r√©s lorsqu'une urgence est d√©tect√©e. </li></ul><br>  Vous pouvez utiliser <code>omitStages</code> pour ignorer toutes les √©tapes. <br><br>  Dans le fichier de strat√©gie, nous pouvons d√©crire plusieurs sections avec diff√©rents niveaux de journalisation.  La premi√®re r√®gle de correspondance trouv√©e dans la description de la politique s'applique. <br><br>  Le d√©mon kubelet surveille la modification du manifeste avec la configuration du serveur api, et s'il en d√©tecte, il red√©marre le conteneur avec le serveur api.  Mais il y a un d√©tail important: <b>ils ignoreront les modifications apport√©es au fichier de strat√©gie</b> .  Apr√®s avoir apport√© des modifications au fichier de strat√©gie, vous devrez red√©marrer manuellement api-server.  √âtant donn√© qu'api-server fonctionne comme un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pod statique</a> , la commande <code>kubectl delete</code> ne le red√©marrera pas.  Vous devrez manuellement <code>docker stop</code> Docker sur les ma√Ætres de cube o√π la strat√©gie d'audit a √©t√© modifi√©e: <br><br><pre> <code class="bash hljs">docker stop $(docker ps | grep k8s_kube-apiserver | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>)</code> </pre> <br>  Lorsque vous activez l'audit, il est important de se rappeler que <b>kube-apiserver a une charge plus √©lev√©e</b> .  En particulier, la consommation de m√©moire pour stocker le contexte des requ√™tes augmente.  La journalisation d√©marre uniquement apr√®s l'envoi de l'en-t√™te de r√©ponse.  En outre, la charge d√©pend de la configuration de la strat√©gie d'audit. <br><br><h3>  Exemples de politiques </h3><br>  Analysons la structure des fichiers de strat√©gie √† l'aide d'exemples. <br><br>  Voici un fichier de <code>policy</code> simple pour tout enregistrer au niveau des <code>Metadata</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1 kind: Policy rules: - level: Metadata</code> </pre> <br>  Vous pouvez sp√©cifier une liste d'utilisateurs ( <code>Users</code> et <code>ServiceAccounts</code> ) et de groupes d'utilisateurs dans la strat√©gie.  Par exemple, voici comment nous allons ignorer les utilisateurs du syst√®me, mais enregistrer tout le reste au niveau de la <code>Request</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1 kind: Policy rules: - level: None userGroups: - "system:serviceaccounts" - "system:nodes" users: - "system:anonymous" - "system:apiserver" - "system:kube-controller-manager" - "system:kube-scheduler" - level: Request</code> </pre> <br>  Il est √©galement possible de d√©crire la cible: <br><br><ul><li>  <code>namespaces</code> </li><li>  verbes ( <i>verbes</i> : <code>get</code> , <code>update</code> , <code>delete</code> et autres); </li><li>  ressources ( <i>ressources</i> , √† savoir: <code>pod</code> , <code>configmaps</code> , etc.) et groupes de ressources ( <code>apiGroups</code> ). </li></ul><br>  <b>Faites attention!</b>  Les ressources et groupes de ressources (groupes API, c'est-√†-dire apiGroups), ainsi que leurs versions install√©es dans le cluster, peuvent √™tre obtenus √† l'aide des commandes: <br><br><pre> <code class="bash hljs">kubectl api-resources kubectl api-versions</code> </pre> <br>  La strat√©gie d'audit suivante est fournie √† titre de d√©monstration des meilleures pratiques dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation d'Alibaba Cloud</a> : <br><br><pre> <code class="plaintext hljs">apiVersion: audit.k8s.io/v1beta1 kind: Policy #    RequestReceived omitStages: - "RequestReceived" rules: #   ,     : - level: None users: ["system:kube-proxy"] verbs: ["watch"] resources: - group: "" #  api group   ,    #   Kubernetes,  ‚Äúcore‚Äù resources: ["endpoints", "services"] - level: None users: ["system:unsecured"] namespaces: ["kube-system"] verbs: ["get"] resources: - group: "" # core resources: ["configmaps"] - level: None users: ["kubelet"] verbs: ["get"] resources: - group: "" # core resources: ["nodes"] - level: None userGroups: ["system:nodes"] verbs: ["get"] resources: - group: "" # core resources: ["nodes"] - level: None users: - system:kube-controller-manager - system:kube-scheduler - system:serviceaccount:kube-system:endpoint-controller verbs: ["get", "update"] namespaces: ["kube-system"] resources: - group: "" # core resources: ["endpoints"] - level: None users: ["system:apiserver"] verbs: ["get"] resources: - group: "" # core resources: ["namespaces"] #     read-only URLs: - level: None nonResourceURLs: - /healthz* - /version - /swagger* #   ,     ‚Äú‚Äù: - level: None resources: - group: "" # core resources: ["events"] #   Secret, ConfigMap  TokenReview    , #         - level: Metadata resources: - group: "" # core resources: ["secrets", "configmaps"] - group: authentication.k8s.io resources: ["tokenreviews"] #   get, list  watch   ;    - level: Request verbs: ["get", "list", "watch"] resources: - group: "" # core - group: "admissionregistration.k8s.io" - group: "apps" - group: "authentication.k8s.io" - group: "authorization.k8s.io" - group: "autoscaling" - group: "batch" - group: "certificates.k8s.io" - group: "extensions" - group: "networking.k8s.io" - group: "policy" - group: "rbac.authorization.k8s.io" - group: "settings.k8s.io" - group: "storage.k8s.io" #        API - level: RequestResponse resources: - group: "" # core - group: "admissionregistration.k8s.io" - group: "apps" - group: "authentication.k8s.io" - group: "authorization.k8s.io" - group: "autoscaling" - group: "batch" - group: "certificates.k8s.io" - group: "extensions" - group: "networking.k8s.io" - group: "policy" - group: "rbac.authorization.k8s.io" - group: "settings.k8s.io" - group: "storage.k8s.io" #         - level: Metadata</code> </pre> <br><br>  Un autre bon exemple de politique d'audit est le <a href="">profil utilis√© dans GCE</a> . <br><br>  Pour une r√©ponse rapide aux √©v√©nements d'audit, il est possible de <b>d√©crire un webhook</b> .  Ce probl√®me est divulgu√© dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> , je le laisserai en dehors du champ d'application de cet article. <br><br><h2>  R√©sum√© </h2><br>  L'article fournit une vue d'ensemble des m√©canismes de s√©curit√© de base dans les clusters Kubernetes qui vous permettent de cr√©er des comptes d'utilisateurs personnalis√©s, de partager leurs droits et d'enregistrer leurs actions.  J'esp√®re que cela sera utile √† ceux qui sont confront√©s √† de telles questions en th√©orie ou d√©j√† en pratique.  Je vous recommande √©galement de consulter la liste d'autres documents sur le th√®me de la s√©curit√© dans Kubernetes, qui est r√©pertori√©e dans le "PS" - peut-√™tre y trouverez-vous les d√©tails n√©cessaires sur les questions qui vous concernent. <br><br><h2>  PS </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">33+ outils de s√©curit√© Kubernetes</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Introduction aux strat√©gies de r√©seau Kubernetes pour les professionnels de la s√©curit√©</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comprendre RBAC chez Kubernetes</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">9 meilleures pratiques de s√©curit√© chez Kubernetes</a> ¬ª; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">11 fa√ßons de (pas) devenir une victime du piratage Kubernetes</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468679/">https://habr.com/ru/post/fr468679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468657/index.html">Danses avec support: types et formes de support. Syst√®mes de soutien fonctionnant au combat</a></li>
<li><a href="../fr468663/index.html">Approche End2 End dans les t√¢ches de reconnaissance automatique de la parole</a></li>
<li><a href="../fr468665/index.html">Mais est-il temps d'acheter un irrigateur?</a></li>
<li><a href="../fr468673/index.html">Atelier "Garantir la s√©curit√© des donn√©es personnelles" - 3 octobre, Saint-P√©tersbourg</a></li>
<li><a href="../fr468677/index.html">L'annonce du smartphone Xiaomi Mi Mix Alpha</a></li>
<li><a href="../fr468683/index.html">Th√©orie et pratique de la normalisation des services Docker</a></li>
<li><a href="../fr468687/index.html">Nous analysons les nouvelles initiatives de la Banque centrale pour r√©guler le march√© boursier: 3 groupes d'investisseurs, restrictions pour les d√©butants</a></li>
<li><a href="../fr468689/index.html">Enregistrer votre entreprise informatique √† Singapour: que dois-je faire?</a></li>
<li><a href="../fr468691/index.html">Pilotes tiers dangereux sur votre syst√®me ou pilotes LOLD</a></li>
<li><a href="../fr468693/index.html">Comment l'automatisation d√©truit les employ√©s de Walmart</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>