<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>  硷 C贸mo probamos arrastrar y soltar en HTML5  斤 </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De una forma u otra, todos enfrentaban situaciones en las que algo inusual suced铆a en un ambiente banal. Un caso similar nos sucedi贸 al probar una nue...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C贸mo probamos arrastrar y soltar en HTML5</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/437200/">  De una forma u otra, todos enfrentaban situaciones en las que algo inusual suced铆a en un ambiente banal.  Un caso similar nos sucedi贸 al probar una nueva aplicaci贸n en un entorno cien veces probado.  Una sorpresa para nosotros fue el uso de algunas caracter铆sticas HTML5 en el front-end, o m谩s bien, la incapacidad de automatizar las operaciones de prueba de arrastrar y soltar usando las herramientas est谩ndar de Selenium WebDriver.  Queremos hablar sobre esta experiencia. <br><br><img src="https://habrastorage.org/webt/vp/3h/0p/vp3h0pprz35p2ycsyhynk5kjp0c.png"><br><a name="habracut"></a><br>  Imagine un proyecto que es tecnol贸gicamente muy similar al anterior (en nuestra opini贸n, tuvo un peque帽o efecto negativo en t茅rminos de comprender y analizar correctamente el problema que apareci贸), pero la versi贸n de Angular entre proyectos cambi贸 de 1.xa 5.x y se agreg贸 la biblioteca Selenide para pruebas autom谩ticas de UI. . <br><br>  La aplicaci贸n web desarrollada ten铆a una p谩gina con un cierto conjunto de entidades que pod铆an moverse entre ellas.  Imagine nuestra sorpresa cuando un intento de realizar una autocomprobaci贸n de verificar las funciones de arrastrar y soltar utilizando las herramientas de Selenide no tuvo 茅xito.  Parece que lo que podr铆a haber salido mal?  En el proyecto anterior, en un entorno de prueba similar, todo funcion贸 perfectamente. <br><br>  Primero, verificamos la funci贸n de arrastrar y soltar de las funciones Selenide y Selenium en el navegador actual usando un ejemplo de otra aplicaci贸n web.  Todo funciona  Versiones actualizadas, nunca se sabe ... <br>  Decidimos comprobar si arrastramos y all铆.  Y hacer la elecci贸n incorrecta de elementos cuando se usa Angular es bastante f谩cil.  Nos sentamos con un desarrollador front-end y descubrimos que los elementos de arrastrar y soltar se seleccionaron correctamente. <br><br>  En general, el entorno de prueba funciona, los m茅todos de prueba est谩n escritos correctamente, arrastrar y soltar "a mano" funciona, pero la prueba autom谩tica no funciona.  Y no hay razones para esto a primera vista. <br><br>  Finalmente, soportamos el hecho del problema y buscamos una soluci贸n en Internet.  Cu谩l fue nuestra sorpresa cuando encontramos el problema abierto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Chrome WebDriver # 3604 del 03/04/2016</a> .  Solo piense, desde la primavera de 2016, oficialmente hay un problema con la funci贸n de arrastrar y soltar rota en Chrome WebDriver, sin mencionar otros navegadores.  No, ciertamente funciona, pero no cuando se usa HTML5.  Y como result贸 en el proceso de an谩lisis del problema, nuestra aplicaci贸n utiliz贸 la implementaci贸n de arrastrar y soltar usando HTML5. <br><br>  驴Cu谩les son las implementaciones de arrastrar y soltar para probar en HTML5?  En Internet, se encontraron dos soluciones: <br><br><ul><li>  Utilice la biblioteca de Java awt.Robot (o alg煤n clicker de terceros); </li><li>  Utiliza javascript. </li></ul><br>  <em>Probablemente ganamos un poco de dinero o nos enterramos en el problema, pero de inmediato har茅 una reserva de que la primera soluci贸n elegida no nos conven铆a :)</em> <br><br><h6>  Lo que se puede decir sobre la implementaci贸n en Robot: </h6><br><ul><li>  Interceptamos el mouse, emulando las acciones completas del usuario; </li><li>  Usamos selenio para determinar las coordenadas de los elementos; </li><li>  Como se utilizan elementos Selenium, no necesita cambiar los localizadores.  Estamos intentando en el proyecto usar xpath; </li><li>  Est谩 escrito en Java, la sintaxis es intuitiva, buena documentaci贸n. </li></ul><br><h6>  Pero algo sobre la implementaci贸n de JavaScript vino a la mente: </h6><br><ul><li>  Todo sucede en JavaScript dentro del navegador (las acciones est谩n ocultas a los ojos del probador y estas acciones interfieren con el c贸digo); </li><li>  De las bibliotecas js para probar arrastrar y soltar en Internet, se encontr贸 una, cuya fuente no era tan f谩cil de encontrar; </li><li>  La biblioteca encontrada tendr谩 que estar terminada con un archivo que se ajuste a sus necesidades, ya que implementa solo arrastrar y soltar limpio.  Y nosotros, por ejemplo, necesit谩bamos arrastrar -&gt; mover -&gt; mantener -&gt; soltar; </li><li>  La biblioteca se implementa como un complemento de jQuery y, por lo tanto, ser谩 necesario comprender la estructura de jQuery; </li><li> Tendremos que convertir los localizadores a css (jquery no funciona con xpath); </li><li>  Es imposible utilizar la b煤squeda de elementos de selenio, tendr谩 que pegar los localizadores con "bol铆grafos". </li></ul><br>  A primera vista, la primera soluci贸n fue mucho m谩s conveniente y fue probada. <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//Setup robot Robot robot = new Robot(); robot.setAutoDelay(50); //Fullscreen page so selenium coordinates work robot.keyPress(KeyEvent.VK_F11); Thread.sleep(2000); //Get size of elements Dimension fromSize = dragFrom.getSize(); Dimension toSize = dragTo.getSize(); //Get centre distance int xCentreFrom = fromSize.width / 2; int yCentreFrom = fromSize.height / 2; int xCentreTo = toSize.width / 2; int yCentreTo = toSize.height / 2; //Get x and y of WebElement to drag to Point toLocation = dragTo.getLocation(); Point fromLocation = dragFrom.getLocation(); //Make Mouse coordinate centre of element toLocation.x += xOffset + xCentreTo; toLocation.y += yCentreTo; fromLocation.x += xCentreFrom; fromLocation.y += yCentreFrom; //Move mouse to drag from location robot.mouseMove(fromLocation.x, fromLocation.y); //Click and drag robot.mousePress(InputEvent.BUTTON1_MASK); //Move to final position robot.mouseMove(toLocation.x, toLocation.y); //Drop robot.mouseRelease(InputEvent.BUTTON1_MASK);</span></span></code> </pre> <br>  En general, la soluci贸n est谩 funcionando ... Sin embargo, en el proceso de su desarrollo, sus 谩reas problem谩ticas quedaron claras. <br><br><ul><li>  El movimiento del mouse o la minimizaci贸n del navegador durante la ejecuci贸n de las pruebas conduce a la interferencia en el curso de las pruebas y su ca铆da; </li><li>  No se pueden ejecutar pruebas en paralelo con JUnit / TestNG.  A menos que sea paralelo a trav茅s de tareas separadas en CI. </li><li>  No se puede controlar el mouse en la m谩quina remota a trav茅s de Selenium Grid / Selenoid; </li><li>  En el caso de un bloqueo del navegador, Robot puede hacer clic / arrastrar f谩cilmente algo en el escritorio o en otra aplicaci贸n abierta. </li></ul><br>  <em>Al final, sin embargo, la implementaci贸n de JavaScript ...</em> <br><br>  Me gustar铆a decir de inmediato que logramos resolver el problema del uso de localizadores xpath utilizando el complemento jquery.xpath.js jQuery. <br><br>  Y la biblioteca drag_and_drop_helper.js (fuente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> ) se convirti贸 en la herramienta principal para js controlar las operaciones de arrastrar y soltar.  No tiene sentido ordenar su trabajo, sino sobre c贸mo trabajamos un poco m谩s tarde. <br><br>  Ahora directamente sobre la implementaci贸n en las pruebas.  En Selenide, todo es simple.  Antes de usar arrastrar y soltar, debe cargar las bibliotecas JS usadas: <br><br><pre> <code class="javascript hljs">StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); sb.append(readFile(<span class="hljs-string"><span class="hljs-string">"jquery-3.3.1.min.js"</span></span>)); sb.append(readFile(<span class="hljs-string"><span class="hljs-string">"jquery.xpath.min.js"</span></span>)); sb.append(readFile(<span class="hljs-string"><span class="hljs-string">"drag_and_drop_helper.js"</span></span>)); executeJavaScript(sb.toString());</code> </pre><br>  Naturalmente, jQuery debe cargarse si a煤n no est谩 en la aplicaci贸n. <br><br>  En la versi贸n original de la biblioteca, es suficiente escribir lo siguiente: <br><br><pre> <code class="javascript hljs">executeJavaScript(<span class="hljs-string"><span class="hljs-string">"$('"</span></span> + source + <span class="hljs-string"><span class="hljs-string">"') .simulateDragDrop({ dropTarget: '"</span></span> + target + <span class="hljs-string"><span class="hljs-string">"'});"</span></span>);</code> </pre><br>  source y target son localizadores css de elementos de arrastrar y soltar. <br><br>  Como se indic贸 anteriormente, a menudo usamos xpath-locators en el proyecto, por lo que despu茅s de un peque帽o refinamiento, la biblioteca comenz贸 a aceptarlos: <br><br><pre> <code class="javascript hljs">executeJavaScript(<span class="hljs-string"><span class="hljs-string">"$(document).xpath('"</span></span> + source + <span class="hljs-string"><span class="hljs-string">"').simulateDragDrop({ dropTarget: '"</span></span> + target + <span class="hljs-string"><span class="hljs-string">"'});"</span></span>);</code> </pre><br>  Ahora, en realidad, sobre la biblioteca drag_and_drop_helper.js.  Hay piezas en el bloque de c贸digo simulateEvent que son responsables de ciertos eventos del mouse.  No tiene sentido enumerar los posibles eventos de operaciones de arrastrar y soltar en HTML5; esta informaci贸n es f谩cil de encontrar. <br><br>  Para las pruebas, necesit谩bamos implementar una funci贸n que mueva el elemento y mantenga el mouse sobre el elemento de destino.  Y esto, como en la biblioteca de origen, no se proporciona. <br><br>  Por analog铆a, agregamos el evento dragenter a la biblioteca (entre dragstart y drop). <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*Simulating dragenter*/</span></span> type = <span class="hljs-string"><span class="hljs-string">'dragenter'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dragenterEvent = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.createEvent(type, {}); dragenterEvent.dataTransfer = event.dataTransfer; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatchEvent($(options.dropTarget)[<span class="hljs-number"><span class="hljs-number">0</span></span>], type, dragenterEvent);</code> </pre><br>  Sin embargo, esto no es suficiente.  Despu茅s de todo, el evento de retenci贸n se completar谩 instant谩neamente.  Poner una pausa fija entre los eventos dragEnter y soltar no parec铆a la opci贸n m谩s conveniente.  Despu茅s de todo, inicialmente no se sabe cu谩nto tiempo necesita la aplicaci贸n para procesar un evento, se desconoce el n煤mero y el tiempo de las comprobaciones en las pruebas.  El retraso entre estos eventos debe ser al menos manejable.  En cambio, decidimos dividir las pruebas de arrastrar y soltar en etapas y no emular el conjunto completo de eventos del mouse, es decir, agregar la capacidad de administrar la lista de eventos involucrados a trav茅s del par谩metro. <br><br>  Y todo parece estar bien, no aparecieron nuevos defectos, y algunos de los antiguos ya no lo son, y lo m谩s importante, las tareas asignadas se est谩n llevando a cabo.  Parece que todo es perfecto.  Sin embargo, las herramientas de desarrollo modernas establecen el procesamiento de dos eventos y utilizan varios par谩metros del elemento movido.  Supongamos que tenemos esta soluci贸n al ejecutar arrastrar y soltar que causa errores dragStartListener.  Pero como no rompe nada, nosotros no comenzamos a cambiar nada m谩s.  Sin embargo, en alguna otra aplicaci贸n, probablemente tendr谩 que terminar este momento. <br><br>  Queremos resumir lo anterior.  Sorprendentemente, un hecho!  HTML5 se lanz贸 en 2013, los navegadores lo han soportado durante varios a帽os, se han desarrollado aplicaciones para 茅l, pero webDriver, por desgracia, todav铆a no sabe c贸mo usar sus capacidades.  Y las operaciones de prueba de arrastrar y soltar deben implementarse con herramientas de terceros, complicar la arquitectura y recurrir a todo tipo de trucos.  S铆, existen tales herramientas y "bailar con una pandereta" solo nos hace m谩s fuertes, pero a煤n quiero tener una soluci贸n que funcione de inmediato. <br><br>  En nuestra experiencia, podemos decir que tales problemas no son tan comunes hoy en d铆a, aunque arrastrar y soltar se usa en todas partes.  Probablemente el asunto sea la elecci贸n de las tecnolog铆as de desarrollo de aplicaciones web.  Sin embargo, el porcentaje de aplicaciones que usan HTML5 est谩 creciendo constantemente, los frameworks se est谩n desarrollando y ser铆a genial si los desarrolladores de navegadores y controladores para ellos tampoco se quedaran atr谩s. <br><br>  <strong>PD</strong> Y finalmente, una peque帽a letra.  Me gustar铆a aconsejar a todos, si es posible, que no tengan en cuenta la banalidad de la situaci贸n o la proximidad del entorno de prueba a alg煤n tipo de patr贸n al analizar los problemas.  Esto puede llevar a conclusiones incorrectas o p茅rdida de tiempo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/437200/">https://habr.com/ru/post/437200/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../437186/index.html">Monolito a microservicios. Punto de vista de infraestructura</a></li>
<li><a href="../437190/index.html">Sobre el monitoreo</a></li>
<li><a href="../437194/index.html">Lista de verificaci贸n en la nube o c贸mo nos evalu贸 el cliente</a></li>
<li><a href="../437196/index.html">Global Game Jam 2019 (anuncio)</a></li>
<li><a href="../437198/index.html">Global Game Jam 2019 (anuncio)</a></li>
<li><a href="../437202/index.html">SAPUI5 para dummies parte 3: un ejercicio completo paso a paso</a></li>
<li><a href="../437204/index.html">Backblaze lanz贸 estad铆sticas de confiabilidad de HDD para 2018</a></li>
<li><a href="../437206/index.html">Yandex comenz贸 a vender sus propias computadoras a bordo</a></li>
<li><a href="../437208/index.html">Debian todav铆a se niega a usar HTTPS</a></li>
<li><a href="../437210/index.html">AccelStor: visi贸n propia sobre el trabajo de All Flash</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>