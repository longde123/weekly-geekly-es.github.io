<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻 🚏 👨‍🌾 مزود إلى CSV باستخدام DBMS_SQL 👨🏻‍🎨 💠 💯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="غالبًا ، عند حل مشكلات تكامل النظام ، من الضروري تقديم قدر معين من البيانات بتنسيق أو آخر. في الوقت نفسه ، يمكن لأي شخص أن يكون مستهلكًا للبيانات ، لك...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>مزود إلى CSV باستخدام DBMS_SQL</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448774/" style=";text-align:right;direction:rtl">  غالبًا ، عند حل مشكلات تكامل النظام ، من الضروري تقديم قدر معين من البيانات بتنسيق أو آخر.  في الوقت نفسه ، يمكن لأي شخص أن يكون مستهلكًا للبيانات ، لكن المصدر دائمًا ما يكون قاعدة بيانات للشركات.  على سبيل المثال ، قد يطلب الصانع من المورد الإبلاغ دوريًا عن حركة البضائع الخاصة به بتنسيق XLSX أو XML ، إلخ. <br><br>  هناك العديد من الأدوات لتحويل البيانات إلى تنسيقات مختلفة ، وتعتمد إمكانية استخدامها على المكدس التكنولوجي المعتمد في المؤسسة وهيكل البرنامج.  في الوقت نفسه ، تريد دائمًا أن تكون السلسلة التي تتكون من عدة مكتبات وأطر عمل وطبقات النظام المستخدمة لتحويل البيانات المصدر قصيرة قدر الإمكان.  هذا من شأنه أن يقلل من الوقت الذي يقضيه في تطوير الحل وزيادة كفاءته الإنتاجية. <br><br>  إذا افترضنا أن استعلام SQL يكمن في الواقع في جذر عملية اختيار البيانات ، فمن الأفضل أن تكون سلسلة التحويلات مناسبة لرؤية هذا: <br><p style=";text-align:right;direction:rtl"></p><p style=";text-align:right;direction:rtl"><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup><mo>=</mo><mi>f</mi><mo stretchy=&quot;false&quot;>(</mo><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.035ex" height="2.78ex" viewBox="0 -883.9 6903.8 1197.1" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMAIN-2032" x="741" y="583"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMAIN-3D" x="1097" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMATHI-66" x="2153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMAIN-28" x="2703" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMATHI-53" x="3093" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMATHI-51" x="3738" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMATHI-4C" x="4530" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMAIN-28" x="5211" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMATHI-64" x="5601" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMAIN-29" x="6124" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMAIN-29" x="6514" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mi>d</mi><mo>′</mo></msup><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> d '= f (SQL (d)) </script></p><br>  حيث <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x62F;</mo></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.723ex" height="2.298ex" viewBox="0 -780.1 311.2 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(51.874) matrix(1 0 0 -1 0 0)">د</text></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mo>د</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-2"> د </script>  - مصدر البيانات ، <br><math></math><img src="https://habrastorage.org/getpro/habr/formulas/5dc/6e9/e3d/5dc6e9e3dc235fa86e4c26b9566aeea7.svg" alt="SQL SQL (d) $" data-tex="inline">  - استعلام SQL لاسترداد البيانات ، <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x648;</mo></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.843ex" height="2.298ex" viewBox="0 -780.1 363.1 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(51.874) matrix(1 0 0 -1 0 0)">و</text></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mo>و</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-3"> و </script>  - وظيفة تحول الاختيار إلى التنسيق المطلوب ، <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.903ex" height="2.178ex" viewBox="0 -832 819.3 937.7" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhizKuZG8uSfRKlBnN3aA7eRQNBOdQ#MJMAIN-2032" x="741" y="513"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>d</mi><mo>′</mo></msup></math></span></span><script type="math/tex" id="MathJax-Element-4"> d '</script>  - البيانات بالتنسيق المطلوب. <br><br>  بالنسبة إلى Oracle PL / SQL ، يوجد عدد من الحزم المضمنة والجهات الخارجية التي تنفذ هذه الوظيفة.  هذه هي DBMS_XMLGEN و DBMS_XMLQUERY و AS_XLSX و PL / JSON وغيرها. <br><br>  ومع ذلك ، عند ظهور سؤال حول تحويل البيانات إلى تنسيق CSV ، لسبب ما لم تكن هناك حلول جاهزة.  كان علي أن أفعل ذلك بنفسي ، ثم سيظهر كيف. <a name="habracut"></a><br><br>  بيان المشكلة <br><br>  قم بإنشاء أداة (حزمة PL / SQL) تستقبل استعلام SELECT التعسفي كسلسلة أو كمتغير مؤشر عند الإدخال ، وتقوم بإرجاع كائن من نوع CLOB لتغليف البيانات بتنسيق CSV عند الإخراج.  في حال وجود أي خطأ ، يجب إرجاع NULL.  لا يلزم تمثيل تنسيق ملف CSV نفسه - فهذه عبارة عن سلاسل يتم فصل عناصرها بشخص ما ، وغالبًا "؛" ، ولكن في الحالة العامة ، يمكن أن تعمل الشخصية التعسفية كفاصل.  افترض أنه يتم استخدام الأحرف 0x0D + 0x0A لفصل السلاسل.  عادةً ما يكون السطر الأول في ملف CSV هو العنوان ويحدد أسماء الأعمدة. <br><br>  تحديد واجهة الحزمة <br><br><pre style=";text-align:right;direction:rtl"><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> PACKAGE pp_csv <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( stmt <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( ref_cursor <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> SYS_REFCURSOR, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  يوجد إجراءان زائدان ، والفرق بينهما هو أن أحدهما يتلقى الطلب كسلسلة ، والآخر كارتباط بالمؤشر.  المعلمة الثانية هي الإخراج ؛ هذه هي النتيجة المرغوبة في كائن CLOB.  أخيرًا ، المعلمة الثالثة هي فاصل CSV. <br><br>  في تنفيذ هذه الإجراءات ، سوف تساعدنا حزمة DBMS_SQL المدمجة ، والتي تتيح لنا العمل مع المؤشرات الديناميكية عندما يكون غير معروف مقدمًا (في مرحلة الترجمة) بالضبط عدد الأعمدة المشاركة في التحديد. <br><br>  تتيح لك ميزات DBMS_SQL تحليل الاستعلامات التعسفية وتنفيذها ديناميكيًا.  لإجراء يقبل طلب كسلسلة ، يحدث هذا مثل هذا: <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cur PLS_INTEGER := DBMS_SQL.OPEN_CURSOR; <span class="hljs-comment"><span class="hljs-comment">--     DBMS_SQL ignore INTEGER; BEGIN DBMS_SQL.PARSE(cur, stmt, DBMS_SQL.NATIVE); ignore := DBMS_SQL.EXECUTE(cur);</span></span></code> </pre> <br>  لإجراء يتطلب متغير المؤشر ، كل شيء أبسط - بدءًا من الإصدار الحادي عشر من Oracle ، أصبح تحويل "متغير المؤشر → رقم مؤشر SQL" متاحًا. <br><br>  تقوم دالة DBMS_SQL.TO_CURSOR_NUMBER بتحويل متغير REFCURSOR (مكتوب بقوة أو ضعيف) إلى رقم مؤشر SQL ، والذي يمكن بعد ذلك تمريره إلى إجراءات DBMS_SQL.  في هذه الحالة ، يجب أن يكون متغير المؤشر مفتوحًا قبل تمريره إلى الدالة DBMS_SQL.TO_CURSOR_NUMBER. <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs">cur PLS_INTEGER := DBMS_SQL.TO_CURSOR_NUMBER(ref_cursor);</code> </pre> <br>  وهكذا ، حصل كلا الإصدارين من المكالمة على <i>عدد</i> المؤشرات الديناميكية ومجموعة البيانات المرتبطة.  الخطوة التالية هي الحصول على معلومات حول أعمدة هذه المجموعة واستخراج البيانات نفسها. <br><br>  تسمح لك حزمة DMBS_SQL بوصف أعمدة المؤشر الديناميكي ، مع إرجاع المعلومات حول كل عمود في صفيف اقتران من السجلات. <br><br>  للقيام بذلك ، يجب أن تعلن مجموعة PL / SQL بناءً على نوع المجموعة DBMS_SQL.DESC_TAB (أو DESC_TAB2 إذا كان الاستعلام يمكن أن يعرض أسماء الأعمدة التي تزيد عن 30 حرفًا).  بعد ذلك ، يمكنك استخدام طرق التجميع للتكرار عبر الجدول واسترداد معلومات المؤشر. <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cols DBMS_SQL.DESC_TAB2; ncols NUMBER; <span class="hljs-comment"><span class="hljs-comment">--     col_val_chr VARCHAR2(32767); BEGIN DBMS_SQL.DESCRIBE_COLUMNS2(cur, ncols, cols);</span></span></code> </pre> <br>  بعد ذلك ، يجب إبلاغ حزمة DBMS_SQL بنوع كل عمود محدد باستخدام الاستعلام الديناميكي.  يتم ذلك عن طريق استدعاء DEFINE_COLUMN. <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .. ncols <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> DBMS_SQL.DEFINE_COLUMN(cur, i, col_val_chr, <span class="hljs-number"><span class="hljs-number">32767</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>;</code> </pre> <br>  في الوسيطة الثانية DEFINE_COLUMN ، يتم تمرير رقم - الموضع التسلسلي للعمود في القائمة.  تقوم الوسيطة الثالثة بتعيين نوع بيانات عمود المؤشر.  يمر تعبير من النوع المناسب.  بمعنى آخر ، يتم تمرير DBMS_SQL.DEFINE_COLUMN ليس سلسلة باسم اسم النوع (على سبيل المثال ، "VARCHAR2") ، ولكن متغير تم تعريفه بالنوع VARCHAR2. <br><br>  عند تحديد عمود نوع الحرف في الوسيطة الرابعة ، يجب عليك تحديد الحد الأقصى لطول القيم التي يمكن تحميلها في المؤشر. <br><br>  تم الانتهاء من العمليات التحضيرية ، يمكنك الآن إنشاء خط رأس والبدء في استخراج البيانات. <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cap CLOB; <span class="hljs-comment"><span class="hljs-comment">--    CSV- BEGIN DBMS_LOB.CREATETEMPORARY(cap, TRUE, DBMS_LOB.SESSION); FOR i IN 1 .. ncols LOOP DBMS_LOB.APPEND(cap, cols(i).col_name || delimeter); END LOOP;</span></span></code> </pre> <br>  يتم استرداد البيانات صفًا تلو الآخر باستخدام DBMS_SQL.FETCH_ROWS والمكالمات اللاحقة إلى DBMS_SQL.COLUMN_VALUE للحصول على قيم الأعمدة الفردية. <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> bod CLOB; <span class="hljs-comment"><span class="hljs-comment">--   CSV- c_line_break CONSTANT VARCHAR2(2) := chr(13) || chr(10); BEGIN DBMS_LOB.CREATETEMPORARY(bod, TRUE, DBMS_LOB.SESSION); WHILE DBMS_SQL.FETCH_ROWS(ur) &gt; 0 LOOP FOR i IN 1 .. ncols LOOP DBMS_SQL.COLUMN_VALUE(cur, i, col_val_chr); DBMS_LOB.APPEND(bod, col_val_chr || delimeter); END LOOP; DBMS_LOB.APPEND(bod, c_line_break); END LOOP;</span></span></code> </pre> <br>  ثم يبقى فقط لجمع CSV الناتجة <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs">DBMS_LOB.APPEND(sheet, cap); DBMS_LOB.APPEND(sheet, c_line_break); DBMS_LOB.APPEND(sheet, bod);</code> </pre> <br>  معالجة الأخطاء <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> OTHERS <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> sheet := <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>;</code> </pre> <br>  وأغلق المؤشر <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs">DBMS_SQL.CLOSE_CURSOR(cur);</code> </pre> <br>  حزمة استخدام الخيارات <br><br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(<span class="hljs-string"><span class="hljs-string">'SELECT empcode, fio FROM employee WHERE ROWNUM &lt; 10'</span></span>, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; cur SYS_REFCURSOR; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> empcode, fio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> employee <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ROWNUM &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(cur, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  هذا ، في الواقع ، هو كل شيء ، <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">يتم إرفاق التعليمات البرمجية المصدر</a> . <br><br>  ساعد الكتاب في التطوير <br>  Feuerstein S. ، وصل B. - Oracle PL / SQL.  للمحترفين. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar448774/">https://habr.com/ru/post/ar448774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar448762/index.html">أعمال شغب على بيكابا. المستخدمين الذهاب على نطاق واسع إلى رديت</a></li>
<li><a href="../ar448764/index.html">الساعات على ATtiny13</a></li>
<li><a href="../ar448766/index.html">إنشاء مستودع أحادي مع مساحات عمل ليرنا وغزل</a></li>
<li><a href="../ar448768/index.html">التحكم في الإضاءة متعدد المستويات: مرونة الحلول والمنتجات</a></li>
<li><a href="../ar448770/index.html">تم تحديث دعم الشفرة في Visual Studio Code. الآن مع السترة</a></li>
<li><a href="../ar448776/index.html">RxVMS - بنية عملية لتطبيقات الرفرفة</a></li>
<li><a href="../ar448780/index.html">ما يعطي برنامج للتجنيد في المال</a></li>
<li><a href="../ar448788/index.html">بيثون اختبار مع pytest. الفصل 2 ، وظائف اختبار الكتابة</a></li>
<li><a href="../ar448790/index.html">SpaceVIL هو إطار واجهة المستخدم الرسومية عبر منصة لتطوير .Net Core و .Net Standard و JVM</a></li>
<li><a href="../ar448794/index.html">بيثون اختبار مع pytest. الإضافات الفصل 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>