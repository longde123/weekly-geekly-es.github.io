<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßê üßû üì° Ce que j'ai appris en testant 200 000 lignes de code d'infrastructure üë®üèΩ‚Äçüíº üêæ ‚ò¶Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L' approche IaC (Infrastructure as Code) se compose non seulement du code stock√© dans le r√©f√©rentiel, mais √©galement des personnes et des processus qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ce que j'ai appris en testant 200 000 lignes de code d'infrastructure</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467171/"><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  L' <strong>approche IaC</strong> (Infrastructure as Code) se compose non seulement du code stock√© dans le r√©f√©rentiel, mais √©galement des personnes et des processus qui entourent ce code.  Est-il possible de r√©utiliser des approches allant du d√©veloppement logiciel √† la gestion et √† la description de l'infrastructure?  Il ne sera pas superflu de garder cette id√©e √† l'esprit lorsque vous lirez l'article. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version russe</a> </p><a name="habracut"></a><br><p>  Ceci est une transcription de ma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">performance</a> √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DevopsConf 2019-05-28</a> . </p><br><div class="spoiler">  <b class="spoiler_title">Diapositives et vid√©os</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version russe</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version russe</a> </li><li>  Essai √† sec 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU) de DINS DevOps EVENING 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Diapositives</a> </li></ul></div></div><br><h1 id="infrastructure-as-bash-history">  L'infrastructure comme histoire bash </h1><br><p><img src="https://habrastorage.org/webt/i_/yl/fm/i_ylfms8w-9pgisnujlu-iv1u3y.png"></p><br><p>  Supposons que vous arriviez √† un nouveau projet et qu'ils vous disent: "nous avons l' <em>infrastructure comme code</em> ."  En r√©alit√©, il s'av√®re, <em>Infrastructure comme histoire bash</em> ou par exemple <em>Documentation comme histoire bash</em> .  C'est une situation tr√®s r√©elle, par exemple, un cas similaire a √©t√© d√©crit par Denis Lysenko dans son discours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment remplacer toute l'infrastructure et commencer √† dormir paisiblement</a> , il a expliqu√© comment, gr√¢ce √† l'histoire bash, ils ont obtenu une infrastructure mince sur le projet. </p><br><p>  Si vous le souhaitez, vous pouvez dire que l' <em>infrastructure en tant qu'historique bash</em> est comme du code: </p><br><ol><li>  <em>reproductibilit√©</em> : vous pouvez prendre l'historique bash, ex√©cuter des commandes √† partir de l√†, peut-√™tre, en passant, vous obtiendrez une configuration de travail √† la sortie. </li><li>  <em>versionnage</em> : vous savez qui est entr√© et ce qui a fait, encore une fois, pas le fait que cela vous conduira √† une configuration de travail sur la sortie. </li><li>  <em>histoire</em> : histoire de qui a fait quoi.  vous ne pouvez l‚Äôutiliser que si vous perdez le serveur. </li></ol><br><p>  Que faire? </p><br><h1 id="infrastructure-as-code">  L'infrastructure comme code </h1><br><p><img src="https://habrastorage.org/webt/gm/3e/wf/gm3ewf7g3w72takvuffsxhcbgoy.png"></p><br><p>  M√™me un cas aussi √©trange que <em>Infrastructure en tant qu'historique bash</em> peut √™tre tir√© par les oreilles vers <em>Infrastructure en tant que code</em> , mais lorsque nous voulons faire quelque chose de plus compliqu√© que le bon vieux serveur LAMP, nous arriverons √† la conclusion que ce code doit √™tre modifi√©, modifi√©, modifi√© d'une mani√®re ou d'une autre .  De plus, nous aimerions consid√©rer les parall√®les entre l' <em>infrastructure en tant que code</em> et le d√©veloppement de logiciels. </p><br><h2 id="dry">  SEC </h2><br><p><img src="https://habrastorage.org/webt/rx/qa/vf/rxqavfjxrtmtwkjzzq4prr72oao.png"></p><br><p>  Sur le projet de d√©veloppement de syst√®mes de stockage, il y avait une sous-t√¢che pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">configurer p√©riodiquement SDS</a> : nous publions une nouvelle version - elle doit √™tre d√©ploy√©e pour des tests suppl√©mentaires.  La t√¢che est extr√™mement simple: </p><br><ul><li>  venez ici par ssh et ex√©cutez la commande. </li><li>  copiez-y le fichier. </li><li>  voici un tweak √† la config. </li><li>  d√©marrer le service l√†-bas </li><li>  ... </li><li>  PROFIT! </li></ul><br><p>  Bash est plus que suffisant pour la logique d√©crite, en particulier dans les premiers stades d'un projet lorsqu'il ne fait que commencer.  Ce n'est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pas mal que vous utilisiez bash</a> , mais au fil du temps, vous √™tes invit√© √† d√©ployer quelque chose de similaire, mais l√©g√®rement diff√©rent.  La premi√®re chose qui me vient √† l'esprit: le copier-coller.  Et maintenant, nous avons deux scripts tr√®s similaires qui font presque la m√™me chose.  Au fil du temps, le nombre de scripts a augment√©, et nous sommes confront√©s au fait qu'il existe une certaine logique m√©tier pour le d√©ploiement de l'installation, qui doit √™tre synchronis√©e entre diff√©rents scripts, c'est assez difficile. </p><br><p><img src="https://habrastorage.org/webt/-u/ep/cv/-uepcvi1kjsnruflehy0noydk1k.png"></p><br><p>  Il s'av√®re qu'il existe une telle pratique SECHE (ne vous r√©p√©tez pas).  L'id√©e est de r√©utiliser le code existant.  Cela semble simple, mais ce n'est pas venu tout de suite.  Dans notre cas, c'√©tait une id√©e courante: s√©parer les configurations des scripts.  C'est-√†-dire  logique m√©tier comment l'installation est d√©ploy√©e s√©par√©ment, configure s√©par√©ment. </p><br><h2 id="solid-for-cfm">  SOLIDE pour CFM </h2><br><p><img src="https://habrastorage.org/webt/kt/7f/ba/kt7fbazyy0arjwrnlwgoynqbvqg.png"></p><br><p>  Au fil du temps, le projet a grandi et une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">extension naturelle a</a> √©t√© l'√©mergence d'Ansible.  La raison principale de son apparition est la pr√©sence d'une expertise dans l'√©quipe et ce bash n'est pas destin√© √† une logique complexe.  Ansible a √©galement commenc√© √† contenir une logique complexe.  Pour que la logique complexe ne se transforme pas en chaos, il existe des principes d'organisation du code <em>SOLIDE</em> dans le d√©veloppement de logiciels. Par exemple, Grigory Petrov dans son rapport ¬´Pourquoi les TI ont-ils besoin d'une marque personnelle¬ª a soulev√© la question qu'une personne est tellement con√ßue qu'il est plus facile de fonctionner avec certains les entit√©s sociales, dans le d√©veloppement de logiciels ce sont des objets.  Si vous combinez ces deux id√©es et continuez √† les d√©velopper, vous remarquerez que vous pouvez √©galement utiliser <em>SOLID</em> dans la description de l'infrastructure afin qu'il soit plus facile de maintenir et de modifier cette logique √† l'avenir. </p><br><h3 id="the-single-responsibility-principle">  Le principe de responsabilit√© unique </h3><br><p><img src="https://habrastorage.org/webt/yh/h7/kg/yhh7kgr1jal27ddvpeydqxcmzog.png"></p><br><p>  <em>Chaque classe n'effectue qu'une seule t√¢che.</em> </p><br><p>  Pas besoin de m√©langer le code et de faire des monstres de p√¢tes divines monolithiques.  L'infrastructure doit √™tre constitu√©e de briques simples.  Il s'av√®re que si vous divisez le livre de jeu Ansible en petits morceaux, lisez les r√¥les Ansible, alors ils sont plus faciles √† maintenir. </p><br><h3 id="the-open-closed-principle">  Les principes ouverts ferm√©s </h3><br><p><img src="https://habrastorage.org/webt/g6/ym/qn/g6ymqn8vohwbewqx7hgixuiuuf8.png"></p><br><p>  <em>Le principe d'ouverture / de proximit√©.</em> </p><br><ul><li>  <em>Ouvert pour l'expansion: signifie que le comportement d'une entit√© peut √™tre √©tendu en cr√©ant de nouveaux types d'entit√©s.</em> </li><li>  <em>Ferm√© pour modification: suite √† l'extension du comportement d'une entit√©, aucune modification ne doit √™tre apport√©e au code qui utilise ces entit√©s.</em> </li></ul><br><p>  Au d√©part, nous avons d√©ploy√© l'infrastructure de test sur des machines virtuelles, mais en raison du fait que la logique de d√©ploiement m√©tier √©tait distincte de l'impl√©mentation, nous avons facilement ajout√© un roulement au bare-metall. </p><br><h3 id="the-liskov-substitution-principle">  Le principe de substitution de Liskov </h3><br><p><img src="https://habrastorage.org/webt/1x/-4/am/1x-4am1tjecrhxx3jm7bfur00oy.png"></p><br><p>  <em>Le principe de substitution de Barbara Liskov.</em>  <em>les objets du programme doivent √™tre rempla√ßables par des instances de leurs sous-types sans modifier l'exactitude du programme</em> </p><br><p>  Si vous regardez plus largement, ce n'est pas une caract√©ristique d'un projet particulier que vous pouvez appliquer <em>SOLID</em> , il s'agit g√©n√©ralement de CFM, par exemple, sur un autre projet, vous devez d√©ployer une application Java en bo√Æte au-dessus de divers Java, serveurs d'applications, bases de donn√©es, OS, etc.  Pour cet exemple, je consid√©rerai d'autres principes <em>SOLID</em> . </p><br><p>  Dans notre cas, en tant que membre de l'√©quipe d'infrastructure, il y a un accord que si nous avons install√© le r√¥le d'imbjava ou d'oraclejava, nous avons alors un ex√©cutable java binaire.  Ceci est n√©cessaire car  les r√¥les sup√©rieurs d√©pendent de ce comportement; ils s'attendent √† ce que java soit pr√©sent.  En m√™me temps, cela nous permet de remplacer une impl√©mentation / version de java par une autre sans changer la logique de d√©ploiement de l'application. </p><br><p>  Le probl√®me ici r√©side dans le fait que dans Ansible, il est impossible de mettre en ≈ìuvre de tels, par cons√©quent, certains accords apparaissent au sein de l'√©quipe. </p><br><h3 id="the-interface-segregation-principle">  Le principe de s√©gr√©gation des interfaces </h3><br><p><img src="https://habrastorage.org/webt/v2/9r/wa/v29rwalnqryarhrwe-_r8jvx0go.png"></p><br><p>  <em>Le principe de la s√©paration des interfaces ¬´de nombreuses interfaces sp√©cialement con√ßues pour les clients sont meilleures qu'une seule interface √† usage g√©n√©ral.</em> </p><br><p>  Initialement, nous avons essay√© de mettre toutes les variantes dans le d√©ploiement de l'application dans un playbook Ansible, mais c'√©tait difficile √† prendre en charge, et l'approche lorsque nous avons une interface en sortie (le client attend le port 443) est sp√©cifi√©e, puis pour une impl√©mentation sp√©cifique, vous pouvez construire l'infrastructure √† partir de briques distinctes. </p><br><h3 id="the-dependency-inversion-principle">  Le principe d'inversion de d√©pendance </h3><br><p><img src="https://habrastorage.org/webt/ee/ip/e8/eeipe8nr7hbjx18yxtoxsekwlfy.png"></p><br><p>  <em>Le principe de l'inversion de d√©pendance.</em>  <em>Les modules de niveau sup√©rieur ne doivent pas d√©pendre de modules de niveau inf√©rieur.</em>  <em>Les deux types de modules doivent d√©pendre d'abstractions.</em>  <em>Les abstractions ne devraient pas d√©pendre des d√©tails.</em>  <em>Les d√©tails doivent d√©pendre des abstractions.</em> </p><br><p>  Ici, l'exemple sera bas√© sur antipattern. </p><br><ol><li>  L'un des clients disposait d'un cloud priv√©. </li><li>  √Ä l'int√©rieur du cloud, nous avons command√© des machines virtuelles. </li><li>  Mais compte tenu des fonctionnalit√©s du cloud, le d√©ploiement de l'application √©tait li√© √† l'hyperviseur sur lequel se trouvait la machine virtuelle. </li></ol><br><p>  C'est-√†-dire  logique de d√©ploiement d'applications de haut niveau, les d√©pendances se sont propag√©es aux niveaux inf√©rieurs de l'hyperviseur, ce qui a entra√Æn√© des probl√®mes lors de la r√©utilisation de cette logique.  <em><strong>Ne fais pas √ßa.</strong></em> </p><br><h1 id="interaction">  L'interaction </h1><br><p><img src="https://habrastorage.org/webt/rd/7_/8r/rd7_8rtprcz4xjkuhctjppbkcuu.png"></p><br><p>  L'infrastructure en tant que code ne concerne pas seulement le code, mais aussi la relation entre le code et une personne, les interactions entre les d√©veloppeurs de l'infrastructure. </p><br><h2 id="bus-factor">  Facteur de bus </h2><br><p><img src="https://habrastorage.org/webt/p5/4-/wh/p54-whkhcglorvk_dlt0b1jpajy.png"></p><br><p>  Supposons que Vasya participe au projet.  Vasya sait tout sur votre infrastructure, que se passera-t-il si Vasya dispara√Æt soudainement?  C'est une situation tr√®s r√©elle, car elle peut √™tre heurt√©e par un bus.  Cela arrive parfois.  Si cela se produit et que les connaissances sur le code, sa structure, son fonctionnement, ses apparences et ses mots de passe ne sont pas distribu√©s dans l'√©quipe, vous pouvez rencontrer un certain nombre de situations d√©sagr√©ables.  Diff√©rentes approches peuvent √™tre utilis√©es pour minimiser ces risques et diffuser les connaissances au sein de l'√©quipe. </p><br><h2 id="pair-devopsing">  Paire devopsing </h2><br><p><img src="https://habrastorage.org/webt/6q/0l/t0/6q0lt0afzbkpivxxp4uvryxgake.png"></p><br><p>  Ce n'est pas comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une blague selon</a> laquelle les administrateurs ont bu de la bi√®re, chang√© de mot de passe, mais un analogue de la programmation par paires.  C'est-√†-dire  deux ing√©nieurs s'assoient devant un ordinateur, un clavier et commencent √† configurer ensemble votre infrastructure: configurer le serveur, √©crire le r√¥le Ansible, etc.  Cela semble bien, mais cela n'a pas fonctionn√© pour nous.  Mais les cas particuliers de cette pratique ont fonctionn√©.  Un nouvel employ√© est venu, son mentor prend une vraie t√¢che avec lui, travaille, transf√®re des connaissances. </p><br><p>  Un autre cas particulier est un appel incident.  Pendant le probl√®me, un groupe de personnes de service et des rassemblements impliqu√©s, un leader est nomm√©, qui partage son √©cran et exprime le courant de la pens√©e.  Les autres participants suivent la pens√©e du leader, espionnent les astuces depuis la console, v√©rifient qu‚Äôils n‚Äôont pas manqu√© une ligne dans le journal, apprennent de nouvelles choses sur le syst√®me.  Cette approche a fonctionn√© plut√¥t que non. </p><br><h2 id="code-review">  Examen du code </h2><br><p><img src="https://habrastorage.org/webt/wk/u6/vn/wku6vntzzsquckgu58n1_r3tg-i.png"></p><br><p>  Subjectivement, plus efficacement, la diffusion des connaissances sur l'infrastructure et la fa√ßon dont elle a √©t√© organis√©e a √©t√© r√©alis√©e √† l'aide de la r√©vision du code: </p><br><ul><li>  L'infrastructure est d√©crite par du code dans le r√©f√©rentiel. </li><li>  Les changements se produisent dans une branche distincte. </li><li>  Avec une demande de fusion, vous pouvez voir le delta des changements dans l'infrastructure. </li></ul><br><p>  Le fait saillant ici est que les examinateurs ont √©t√© s√©lectionn√©s √† tour de r√¥le, selon le calendrier, c'est-√†-dire  avec une certaine probabilit√©, vous monterez dans une nouvelle infrastructure. </p><br><h3 id="code-style">  Style de code </h3><br><p><img src="https://habrastorage.org/webt/qa/fz/ju/qafzju1vc86llmvcc1m4urpfa7c.png"></p><br><p>  Au fil du temps, des querelles ont commenc√© √† appara√Ætre au cours de l'examen,  les examinateurs avaient leur propre style et leur propre rotation, les examinateurs les ont empil√©s avec diff√©rents styles: 2 espaces ou 4, camelCase ou snake_case.  Mettre en ≈ìuvre cela n'a pas fonctionn√© tout de suite. </p><br><ul><li>  La premi√®re id√©e √©tait de recommander l'utilisation de linter, car tous les m√™mes ing√©nieurs, tous intelligents.  Mais diff√©rents √©diteurs, OS, pas pratique </li><li>  Cela a √©volu√© en un bot, qui pour chaque commit s'est engag√© dans la probl√©matique, √©crit en slack, et a appliqu√© la sortie de linter.  Mais dans la plupart des cas, des probl√®mes plus importants ont √©t√© trouv√©s et le code n'est pas rest√© fixe. </li></ul><br><h3 id="green-build-master">  Ma√Ætre de la construction √©cologique </h3><br><p><img src="https://habrastorage.org/webt/lw/ow/xi/lwowxis0izoohgthm9db7nheih4.png"></p><br><p>  Le temps passe et nous sommes arriv√©s √† la conclusion que vous ne devez pas autoriser les validations qui ne r√©ussissent pas certains tests dans le ma√Ætre.  Voila!  nous avons invent√© le Green Build Master, qui a longtemps √©t√© pratiqu√© dans le d√©veloppement de logiciels: </p><br><ul><li>  Le d√©veloppement est dans une branche distincte. </li><li>  Les tests s'ex√©cutent sur ce fil. </li><li>  Si les tests √©chouent, le code n'entrera pas dans l'assistant. </li></ul><br><p>  Prendre cette d√©cision a √©t√© tr√®s douloureux car  caus√© beaucoup de controverse, mais cela en valait la peine, car  les demandes de fusion ont commenc√© √† √™tre examin√©es sans d√©saccord sur le style et avec le temps, le nombre de probl√®mes a commenc√© √† diminuer. </p><br><h1 id="iac-testing">  Test IaC </h1><br><p><img src="https://habrastorage.org/webt/ah/dg/sa/ahdgsaecxtevlwnv9ozcoiypkq8.png"></p><br><p>  En plus de la v√©rification du style, vous pouvez utiliser d'autres √©l√©ments, par exemple, pour v√©rifier que votre infrastructure peut vraiment √™tre d√©ploy√©e.  Ou v√©rifiez que les changements d'infrastructure n'entra√Æneront pas de perte d'argent.  Pourquoi cela pourrait-il √™tre n√©cessaire?  La question est complexe et philosophique, il vaut mieux r√©pondre avec le r√©cit qu'il y avait en quelque sorte un auto-scaler sur Powershell qui n'a pas v√©rifi√© les conditions aux limites =&gt; plus de machines virtuelles ont √©t√© cr√©√©es que n√©cessaire =&gt; le client a d√©pens√© plus d'argent que pr√©vu.  Ce n'est pas assez agr√©able, mais il serait tout √† fait r√©aliste de d√©tecter cette erreur √† des stades ant√©rieurs. </p><br><p>  On peut se demander pourquoi rendre une infrastructure complexe encore plus difficile?  Les tests pour l'infrastructure, ainsi que pour le code, ne concernent pas la simplification, mais la connaissance du fonctionnement de votre infrastructure. </p><br><h2 id="iac-testing-pyramid">  Pyramide de test IaC </h2><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><h3 id="iac-testing-static-analysis">  Tests IaC: analyse statique </h3><br><p>  Si vous d√©ployez imm√©diatement l'ensemble de l'infrastructure et v√©rifiez qu'elle fonctionne, il peut s'av√©rer que cela prend beaucoup de temps et n√©cessite beaucoup de temps.  Par cons√©quent, la base devrait √™tre quelque chose qui fonctionne rapidement, c'est beaucoup et elle couvre de nombreux endroits primitifs. </p><br><h4 id="bash-is-tricky">  Bash est d√©licat </h4><br><p>  Voici un exemple trivial.  s√©lectionnez tous les fichiers du r√©pertoire actuel et copiez-les vers un autre emplacement.  La premi√®re chose qui me vient √† l'esprit: </p><br><pre><code class="plaintext hljs">for i in * ; do cp $i /some/path/$i.bak done</code> </pre> <br><p>  Mais que faire s'il y a un espace dans le nom du fichier?  Eh bien, ok, nous sommes intelligents, nous pouvons utiliser des guillemets: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp "$i" "/some/path/$i.bak" ; done</code> </pre> <br><p>  Bravo?  non!  Et s'il n'y a rien dans le r√©pertoire, c'est-√†-dire  Globbing ne fonctionnera pas. </p><br><pre> <code class="plaintext hljs">find . -type f -exec mv -v {} dst/{}.bak \;</code> </pre> <br><p>  Maintenant bien jou√©?  pas ... J'ai oubli√© que le nom du fichier peut √™tre <code>\n</code> . </p><br><pre> <code class="plaintext hljs">touch x mv x "$(printf "foo\nbar")" find . -type f -print0 | xargs -0 mv -t /path/to/target-dir</code> </pre> <br><h4 id="static-analysis-tools">  Outils d'analyse statique </h4><br><p>  Le probl√®me de l'√©tape pr√©c√©dente a pu √™tre d√©tect√© lorsque nous avons oubli√© les citations, car dans la nature, il existe de nombreux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">outils Shellcheck</a> , il y en a beaucoup, et tr√®s probablement, vous pouvez trouver une doublure pour votre pile sous votre IDE. </p><br><div class="scrollable-table"><table><thead><tr><th>  La langue </th><th>  Outil </th></tr></thead><tbody><tr><td>  bash </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Shellcheck</a> </td></tr><tr><td>  Rubis </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rubocop</a> </td></tr><tr><td>  python </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pylint</a> </td></tr><tr><td>  ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Peluche ansible</a> </td></tr></tbody></table></div><br><h3 id="iac-testing-unit-tests">  Tests IaC: tests unitaires </h3><br><p><img src="https://habrastorage.org/webt/pn/wx/av/pnwxavylqxfmvcc-oynjhjmsq-a.png"></p><br><p>  Comme nous l'avons vu dans l'exemple pr√©c√©dent, linter n'est pas omnipotent et ne peut pas pointer vers toutes les zones probl√©matiques.  De plus, par analogie avec les tests de d√©veloppement logiciel, on peut rappeler les tests unitaires.  Puis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">shunit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">junit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rspec</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pytest</a> viennent imm√©diatement √† l'esprit.  Mais que faire de l'ansible, du chef, du saltstack et d'autres comme eux? </p><br><p>  Au tout d√©but, nous avons parl√© de <em>SOLID</em> et du fait que notre infrastructure doit √™tre constitu√©e de petites briques.  Leur heure est venue. </p><br><ol><li>  L'infrastructure est √©cras√©e en petites briques, par exemple, les r√¥les Ansible. </li><li>  Une sorte d'environnement se d√©roule, que ce soit docker ou VM. </li><li>  Nous appliquons notre r√¥le Ansible √† cet environnement de test. </li><li>  Nous v√©rifions que tout a fonctionn√© comme pr√©vu (ex√©cutez les tests). </li><li>  Nous d√©cidons ok ou pas ok. </li></ol><br><h4 id="iac-testing-unit-testing-tools">  Tests IaC: outils de tests unitaires </h4><br><p>  La question est, quels sont les tests pour CFM?  vous pouvez ex√©cuter le script ringard, ou vous pouvez utiliser des solutions pr√™tes √† l'emploi pour cela: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Outil </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Testinfra</a> </td></tr><tr><td>  Chef cuisinier </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Inspec</a> </td></tr><tr><td>  Chef cuisinier </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Serverspec</a> </td></tr><tr><td>  sali√®re </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Goss</a> </td></tr></tbody></table></div><br><p>  Exemple pour testinfra, nous v√©rifions que les utilisateurs <code>test1</code> , <code>test2</code> existent et sont dans le groupe <code>sshusers</code> : </p><br><pre> <code class="plaintext hljs">def test_default_users(host): users = ['test1', 'test2' ] for login in users: assert host.user(login).exists assert 'sshusers' in host.user(login).groups</code> </pre> <br><p>  Que choisir?  La question est complexe et ambigu√´, voici un exemple de changement de projets sur github pour 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/aj/vm/0w/ajvm0wr0cno5a0kchi0z-jwyyxy.png"></p><br><h4 id="iac-testing-frameworks">  Cadres de test IaC </h4><br><p>  Il y a comment mettre tout cela ensemble et courir?  Vous pouvez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prendre et faire tout vous</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">m√™me</a> si vous avez un nombre suffisant d'ing√©nieurs.  Et vous pouvez prendre des solutions toutes faites, bien qu'il n'y en ait pas beaucoup: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Outil </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mol√©cule</a> </td></tr><tr><td>  Chef cuisinier </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cuisine d'essai</a> </td></tr><tr><td>  Terraform </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Terratest</a> </td></tr></tbody></table></div><br><p>  Un exemple de changement de projets sur github pour 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/bj/lb/02/bjlb02mi6tympyzdjjxef3_8bhq.png"></p><br><h4 id="molecule-vs-testkitchen">  Mol√©cule vs.  Testkitchen </h4><br><p><img src="https://habrastorage.org/webt/vx/2e/dt/vx2edtvvuquxyw-4yf81zmk6s9c.png"></p><br><p>  Au d√©part, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essay√© d'utiliser testkitchen</a> : </p><br><ol><li>  Cr√©ez des VM en parall√®le. </li><li>  Appliquer des r√¥les Ansible. </li><li>  √âloignez l'inspec. </li></ol><br><p>  Pour 25 √† 35 r√¥les, cela a fonctionn√© pendant 40 √† 70 minutes, ce qui √©tait long. </p><br><p><img src="https://habrastorage.org/webt/i-/9j/cl/i-9jclmr4x36ag1e8ppzk_d-_b0.png"></p><br><p>  L'√©tape suivante consistait √† passer √† jenkins / docker / ansible / mol√©cule.  Idiologiquement, tout est pareil </p><br><ol><li>  Playbooks de peluches. </li><li>  Pour renverser les r√¥les. </li><li>  Ex√©cuter le conteneur </li><li>  Appliquer des r√¥les Ansible. </li><li>  √âloignez-vous de testinfra. </li><li>  V√©rifiez l'idempotence. </li></ol><br><p><img src="https://habrastorage.org/webt/zz/je/kf/zzjekf-i8wckzdeslzlrbkmmxhg.png"></p><br><p>  Une r√®gle pour 40 r√¥les et des tests pour une douzaine ont commenc√© √† prendre environ 15 minutes. </p><br><p><img src="https://habrastorage.org/webt/pn/6p/qe/pn6pqelxwb7dbaapkefv80ccxra.png"></p><br><p>  Le choix d√©pend de nombreux facteurs, tels que la pile utilis√©e, l'expertise de l'√©quipe, etc.  ici, tout le monde d√©cide comment clore le probl√®me des tests unitaires </p><br><h3 id="iac-testing-integration-tests">  Tests IaC: tests d'int√©gration </h3><br><p><img src="https://habrastorage.org/webt/yt/jf/br/ytjfbruwxfanxl15sxcfyg_gz1g.png"></p><br><p>  √Ä l'√©tape suivante de la pyramide des tests d'infrastructure, des tests d'int√©gration appara√Ætront.  Ils sont similaires aux tests unitaires: </p><br><ol><li>  L'infrastructure est √©cras√©e en petites briques, comme les r√¥les Ansible. </li><li>  Une sorte d'environnement se d√©roule, que ce soit docker ou VM. </li><li>  Il existe de <strong>nombreux</strong> r√¥les Ansible appliqu√©s √† cet environnement de test. </li><li>  Nous v√©rifions que tout a fonctionn√© comme pr√©vu (ex√©cutez les tests). </li><li>  Nous d√©cidons ok ou pas ok. </li></ol><br><p>  En gros, nous ne v√©rifions pas l'op√©rabilit√© d'un √©l√©ment individuel du syst√®me comme dans les tests unitaires, nous v√©rifions comment le serveur est configur√© dans son ensemble. </p><br><h3 id="iac-testing-end-to-end-tests">  Tests IaC: tests de bout en bout </h3><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><p>  Au sommet de la pyramide, nous rencontrons des tests de bout en bout.  C'est-√†-dire  nous ne v√©rifions pas le fonctionnement d'un serveur distinct, d'un script distinct, d'une brique distincte de notre infrastructure.  Nous v√©rifions que de nombreux serveurs sont combin√©s ensemble, notre infrastructure fonctionne comme pr√©vu.  Malheureusement, je n'ai vu aucune solution de bo√Æte pr√™te √† l'emploi, probablement parce que  l'infrastructure est souvent unique et difficile √† mod√©liser et √† cr√©er un cadre pour la tester.  En cons√©quence, chacun cr√©e sa propre solution.  Il y a une demande, mais il n'y a pas de r√©ponse.  Par cons√©quent, je vais vous dire ce qui est l√† pour inciter les autres √† sonder les pens√©es ou √† me piquer le nez, que tout a √©t√© invent√© bien avant nous. </p><br><p><img src="https://habrastorage.org/webt/us/xz/rl/usxzrlzt8unudguhf9b89d83dfm.png"></p><br><p>  Un projet avec une histoire riche.  Utilis√© dans de grandes organisations et probablement chacun de vous s'est indirectement recoup√©.  L'application prend en charge de nombreuses bases de donn√©es, int√©grations, etc., etc.  Savoir √† quoi peut ressembler l'infrastructure repr√©sente beaucoup de fichiers de composition de docker et savoir quels tests ex√©cuter dans quel environnement est jenkins. </p><br><p><img src="https://habrastorage.org/webt/an/l2/ev/anl2ev_lxlsnegrxpulghdw9jxw.png"></p><br><p>  Ce sch√©ma a fonctionn√© pendant longtemps, jusqu'√† ce que dans le cadre de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©tude,</a> nous tentions de le transf√©rer vers Openshift.  Les conteneurs sont rest√©s les m√™mes, mais l'environnement de lancement a chang√© (bonjour DRY √† nouveau). </p><br><p><img src="https://habrastorage.org/webt/sh/sg/ud/shsgudbrhuqpazrpikcacxskzrm.png"></p><br><p>  L'id√©e de la recherche est all√©e plus loin, et dans openshift, il y avait une telle chose APB (Ansible Playbook Bundle) qui vous permet de regrouper les connaissances dans un conteneur sur la fa√ßon de d√©ployer l'infrastructure.  C'est-√†-dire  Il existe un point de connaissance reproductible et testable sur la fa√ßon de d√©ployer l'infrastructure. </p><br><p><img src="https://habrastorage.org/webt/l_/cw/ho/l_cwho8ftxhtnmuekhjlsfllctg.png"></p><br><p>  Tout cela sonnait bien, jusqu'√† ce que nous nous enfouissions dans une infrastructure h√©t√©rog√®ne: nous avions besoin de Windows pour les tests.  Par cons√©quent, la connaissance de l'emplacement de d√©ploiement et de test se trouve dans Jenkins. </p><br><h1 id="conclusion">  Conclusion </h1><br><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  Infrastructure comme le code est </p><br><ul><li>  Le code dans le r√©f√©rentiel. </li><li>  L'interaction des personnes. </li><li>  Test d'infrastructure. </li></ul><br><div class="spoiler">  <b class="spoiler_title">liens</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version anglaise</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Message crois√© d'un blog personnel</a> </li><li>  Essai √† sec 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU) de DINS DevOps EVENING 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le√ßons tir√©es de la r√©daction de plus de 300 000 lignes d'infrastructure Code</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version texte</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Int√©gration de l'infrastructure en tant que code dans un pipeline de livraison continue</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tester l'infrastructure en tant que code</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©veloppement et maintenance efficaces des r√¥les Ansible</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ansible n'est pas pour vous!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ansible idempotent</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr467171/">https://habr.com/ru/post/fr467171/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr467155/index.html">Meilleures pratiques pour les conteneurs Kubernetes: bilans de sant√©</a></li>
<li><a href="../fr467161/index.html">Application Web sur Kotlin + Spring Boot + Vue.js</a></li>
<li><a href="../fr467163/index.html">Comment migrer vers le cloud en deux heures gr√¢ce √† Kubernetes et √† l'automatisation</a></li>
<li><a href="../fr467165/index.html">Sur les traces du mouvement russe Scala. 2e partie</a></li>
<li><a href="../fr467169/index.html">Le√ßons tir√©es des tests Plus de 200 000 lignes de code d'infrastructure</a></li>
<li><a href="../fr467173/index.html">Architecte de mise en ≈ìuvre s√©curis√©e d'ERP</a></li>
<li><a href="../fr467175/index.html">R√©fl√©chissez bien avant d'utiliser les moteurs de jeu</a></li>
<li><a href="../fr467177/index.html">Conseils marketing Tarantino: quel r√¥le jouent les pieds et pourquoi faire du savon Uma Thurman</a></li>
<li><a href="../fr467179/index.html">Samsung Compiler Bootcamp: apprenez √† cr√©er des "programmes de programmation"</a></li>
<li><a href="../fr467181/index.html">Essayer de cr√©er un analogue ASH pour PostgreSQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>