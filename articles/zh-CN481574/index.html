<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤡 🐍 ㊙️ 自托管第三方资源：好，坏，恶 🕉️ 🎂 💟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="近年来，越来越多的用于优化前端项目的平台为独立托管或代理第三方资源提供了机会。 Akamai允许您为自行生成的URL设置特定的参数 。 Cloudflare具有Edge Workers技术。 Fasterzine可以重写页面上的URL，以便它们指向位于站点主域上的第三方资源。 

  

 如果您知...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>自托管第三方资源：好，坏，恶</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/481574/"> 近年来，越来越多的用于优化前端项目的平台为独立托管或代理第三方资源提供了机会。  Akamai允许您为自行生成的URL设置<a href="https://community.akamai.com/customers/s/article/5-ways-to-prevent-slow-3rd-party-front-end-services%3Flanguage%3Den_US">特定的参数</a> 。  Cloudflare具有Edge Workers技术。  Fasterzine可以<a href="https-the-impact-on-your-loading-times/">重写</a>页面上的URL，以便它们指向位于站点主域上的第三方资源。 <br><br> <a href="https://habr.com/ru/company/ruvds/blog/481574/"><img src="https://habrastorage.org/webt/ak/ui/qp/akuiqpw02td9hovfkxqtbxgocck.png"></a> <br><br> 如果您知道项目中使用的第三方服务不会经常更改，并且可以改善向客户交付第三方服务的过程，那么您可能会考虑代理此类服务。 使用这种方法，您可以将这些资源“拉近”到用户附近，并在客户端上获得对其缓存的更多控制。 此外，这还使您可以保护用户免受第三方服务“降级”或性能下降所引起的麻烦。 <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">良好：提高生产力</font> </h2><br> 他人资源的自我托管以非常明显的方式提高了性能。 浏览器不需要再次访问DNS，也不需要建立TCP连接并在第三方域上执行TLS握手。 通过比较以下两个数字，可以看出独立托管其他人的资源如何影响生产力。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/828/0d5/2dd/8280d52dd448afd4d0be39a19ef9dbdb.png"></div><br>  <i><font color="#999999">第三方资源是从外部资源下载的（ <a href="https://csswizardry.com/2019/05/self-host-your-static-assets/">从此处获取</a> ）</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8cb/fb0/da2/8cbfb0da2fc370ddd2da10630c0bc40b.png"></div><br>  <i><font color="#999999">第三方资源与其余站点材料存储在同一位置（ <a href="https://csswizardry.com/2019/05/self-host-your-static-assets/">从此处获取</a> ）</font></i> <br><br> 浏览器将使用已与主域建立的HTTP / 2连接数据的复用和优先级排序功能，从而改善了这种情况。 <br><br> 如果您不托管第三方资源，则由于将从非主要资源的域中下载它们，因此无法确定它们的优先级。 这将导致它们彼此竞争客户端的带宽。 这可能导致这样的事实，即对于形成页面至关重要的材料的加载时间将比在理想情况下可获得的时间长得多。  <a href="https://www.youtube.com/watch%3Fv%3DnOW-i6bbRdo">这是</a>关于HTTP / 2优先级的讨论，很好地解释了所有这些。 <br><br> 可以假定在到外部资源的链接中使用<code>preconnect</code>属性将有助于解决问题。 但是，如果到各个域的此类链接过多，则实际上可能会在最关键的时刻使通信线路过载。 <br><br> 如果您自己托管第三方资源，则可以控制如何将这些资源分配给客户端。 即，我们正在谈论以下内容： <br><br><ul><li> 您可以确保应用最适合每种浏览器的数据压缩算法（Brotli / gzip）。 </li><li> 您可以增加资源的缓存时间，即使对于最知名的提供程序来说，资源的缓存时间通常也不是很大（例如，GA标签的相应值设置为30分钟）。 </li></ul><br> 您甚至可以通过在缓存管理策略中包括适当的材料（URL哈希，版本控制等）来将资源的TTL延长至例如一年。 我们将在下面讨论。 <br><br><h3>  <font color="#3AC1EF">▍防止第三方服务运行中断或断开连接</font> </h3><br> 独立托管第三方资源的另一个有趣的方面是，这使您可以减轻与第三方服务运行中断相关的风险。 假设您的A / B测试第三方解决方案是作为阻止脚本加载到页面的页眉部分中的。 该脚本加载缓慢。 如果相应的脚本无法加载，则页面将为空。 如果加载时间很长，该页面将出现较长的延迟。 或者，假设项目使用从第三方CDN资源加载的库。 想象一下，该资源在某个国家/地区崩溃或被阻止。 这种情况将导致违反网站逻辑。 <br><br> 为了找出您的网站在某些外部服务无法访问的情况下的工作方式，您可以使用<a href="https://www.webpagetest.org/">webpagetest.org</a>上的SPOF部分。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bda/89e/935/bda89e935be22061d7f28f4833b00cac.png"></div><br>  <i><font color="#999999">webpagetest.org上的SPOF部分</font></i> <br><br><h3>  <font color="#3AC1EF">如何处理浏览器的缓存问题？</font>  <font color="#3AC1EF">（提示：这是一个神话）</font> </h3><br> 您可能会认为，使用公开可用的CDN会自动导致更好的资源性能，因为这些服务具有相当好的网络并且分布在世界各地。 但是实际上，所有事情都有些复杂。 <br><br> 假设我们有几个不同的站点：website1.com，website2.com，website3.com。 所有这些站点都使用jQuery库。 我们使用CDN将其连接到他们，例如googleapis.com。 您可以期望浏览器一次下载并缓存该库，然后在使用所有三个站点时使用它。 这样可以减少网络上的负载。 也许这将在某处节省金钱并有助于提高资源生产率。 从实际的角度来看，一切看起来都不同。 例如，Safari实现了一项称为“ <a href="https://webkit.org/blog/7675/intelligent-tracking-prevention/">智能跟踪预防”</a>的功能：缓存基于文档的来源和第三方资源的来源使用双键。  <a href="https://andydavies.me/blog/2018/09/06/safari-caching-and-3rd-party-resources/">这是</a>一篇关于该主题<a href="https://andydavies.me/blog/2018/09/06/safari-caching-and-3rd-party-resources/">的</a>好文章。 <br><br>  <a href="https://yuiblog.com/blog/2007/01/04/performance-research-part-2/">雅虎</a>和<a href="https://code.facebook.com/posts/964122680272229/web-performance-cache-efficiency-exercise/">Facebook的</a>旧研究，以及保罗·卡尔瓦诺<a href="httparchive.org/t/analyzing-resource-age-by-content-type/1659">（</a> Paul Calvano）的最新<a href="httparchive.org/t/analyzing-resource-age-by-content-type/1659">研究</a>表明，只要我们期望的那样，资源就不会存储在浏览器缓存中：“我们自己和第三方项目资源的缓存时间之间存在严重差距。 这是关于CSS和网络字体的。 即，他们自己的字体的95％的缓存期超过一周，而第三方字体的50％的缓存期不到一周！ 这为Web开发人员提供了自托管字体文件的充分理由！” <br><br> 因此，如果您托管其他人的资料，您将不会注意到由浏览器缓存引起的性能问题。 <br><br> 现在，我们已经研究了自托管第三方资源的优点，下面我们来讨论如何区分这种方法的良好实现与不良方法。 <br><br><h2>  <font color="#3AC1EF">坏：细节决定成败</font> </h2><br> 如果不注意正确地缓存此类资源，则无法自动执行将第三方资源移至您自己的域的操作。 <br><br> 这里的主要问题之一是缓存时间。 例如，版本信息包含在第三方脚本名称中，例如： <code>jquery-3.4.1.js</code> 。 这样的文件将来不会更改，因此不会导致其缓存出现任何问题。 <br><br> 但是，如果在处理文件时未应用某个版本控制方案，则缓存的脚本（其内容在文件名不变时会更改）会过时。 这可能会成为一个严重的问题，因为例如，它不允许将安全修复程序自动引入客户端应尽快接收的脚本中。 开发人员将不得不努力更新缓存中的此类脚本。 此外，这可能会导致应用程序崩溃，原因是缓存中客户端上使用的代码与设计项目的服务器部分的最新版本的代码不同。 <br><br> 没错，如果我们谈论的是经常更新的材料（标签管理器，A / B测试解决方案），那么使用CDN缓存它们是可以解决的任务，但它已经复杂得多。 诸如《指挥官法》，标签管理解决方案之类的服务使用Web挂钩发布新版本。 这样就可以在CDN上组织缓存刷新，甚至可以更好地调用哈希更新或URL版本。 <br><br><h3>  <font color="#3AC1EF">▍自适应地向客户交付材料</font> </h3><br> 另外，在谈论缓存时，我们还必须考虑到CDN上使用的缓存设置可能不适用于某些第三方资源这一事实。 例如，这样的资源可以使用用户代理嗅探技术，自适应服务，以便提供针对这些浏览器专门优化的材料的特定浏览器版本。 为了找出浏览器的功能，这些技术依赖于正则表达式或收集有关<code>User-Agent</code> HTTP标头信息的数据库。 在了解了他们正在使用哪个浏览器之后，他们会为其提供设计的材料。 <br><br> 在这里您可以调用两项服务。 第一个是googlefonts.com。 第二个是polyfill.io。  Google字体服务根据浏览器的功能为特定资源提供了各种CSS代码（使用<code>unicode-range</code>提供指向woff2资源的链接）。 <br><br> 以下是使用不同浏览器进行的几次Google字体查询的结果。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c7/ecc/36a/4c7ecc36ad0cd11dcc1455f3b59f1ab0.png"></div><br>  <i><font color="#999999">Chrome字体查询结果</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d57/8b2/170/d578b2170268cd61bf608b7cc87120c4.png"></div><br>  <i><font color="#999999">从IE10取得的Google字体查询结果</font></i> <br><br>  Polyfill.io仅向浏览器提供所需的那些polyfill。 这样做是出于性能原因。 <br><br> 例如，看看从不同的浏览器运行以下请求会发生什么： <a href="">https</a> : <a href="">//polyfill.io/v3/polyfill.js?features=default</a> <br><br> 响应IE10的这种请求，将出现34 Kb的数据。 由Chrome制成的答案将为空。 <br><br><h2>  <font color="#3AC1EF">生气：一些隐私注意事项</font> </h2><br> 该项目排在最后，但重要性不高。 关键是，在项目的主域或其子域上独立托管第三方资源会损害用户的隐私，并对主Web项目产生不利影响。 <br><br> 如果您的CDN系统配置不正确，则可能最终会将Cookie从您的域发送到第三方服务。 如果未在CDN级别上组织适当的过滤，则可以将在正常情况下不能在JavaScript（带有<code>httponly</code>属性）中使用的会话cookie发送到外部主机。 <br><br> 这正是Eulerian或Criteo等追踪器可能发生的情况。 第三方跟踪器可以在Cookie中设置唯一标识符。 如果它们是网站材料的一部分，则在用户使用其他Web资源进行工作时，他们可以自行决定读取标识符。 <br><br> 如今，大多数浏览器都包含针对此类跟踪器行为的保护。 结果，跟踪程序现在使用<a href="https://medium.com/nextdns/cname-cloaking-the-dangerous-disguise-of-third-party-trackers-195205dc522a">CNAME隐藏</a>技术，伪装成自己的脚本来处理各种项目。 即，跟踪器为网站所有者提供了将CNAME添加到其某个域的域设置中的功能，该域的地址通常看起来像是随机字符集。 <br><br> 尽管不建议所有子域（例如* .website.com）都可以访问该网站的cookie，但是许多网站都这样做。 在这种情况下，此类Cookie会自动发送到伪装的第三方跟踪器。 因此，您不能再谈论任何隐私。 <br><br> 此外， <a href="https://developers.google.com/web/updates/2015/09/automating-resource-selection-with-client-hints">Client-Hints</a> HTTP标头也发生了同样的事情，它们仅发送到主域，因为它们可用于创建用户的<a href="http-extensions/issues/767">数字指纹</a> 。 请确保您使用的CDN服务正确过滤了此类标头。 <br><br><h2>  <font color="#3AC1EF">总结</font> </h2><br> 如果您打算很快引入独立托管的第三方资源-让我给您一些提示： <br><br><ul><li> 托管最重要的JS库，字体和CSS文件。 由于第三方服务导致站点无法使用的重要资源这一事实，这将减少站点故障或性能降低的风险。 </li><li> 在将第三方资源缓存在CDN上之前，请确保在命名它们的文件时使用版本控制系统，或者在发布新版本的脚本时通过手动或自动刷新CDN缓存来控制这些资源的生命周期。 </li><li> 请特别注意CDN，代理服务器，缓存的设置。 这将使您能够防止将项目的Cookie或<code>Client-Hints</code>标头发送到第三方服务。 </li></ul><br>  <b>亲爱的读者们！</b> 您是否在服务器上发布了对您的项目非常重要的其他人的材料？ <br><br><div style="text-align:center;"> <a href="https://ruvds.com/ru-rub"><img src="https://habrastorage.org/webt/u9/qa/nk/u9qankiogj61jowwkrc-v8c8rgm.png"></a> </div><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481574/">https://habr.com/ru/post/zh-CN481574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481564/index.html">PHP文摘第170号（2019年12月9日至23日）</a></li>
<li><a href="../zh-CN481566/index.html">无需编程和焊接即可在新的一年使用彩色地址LED</a></li>
<li><a href="../zh-CN481568/index.html">12月23日至29日在莫斯科举行的数字活动</a></li>
<li><a href="../zh-CN481570/index.html">今天的17:00，将举行网络研讨会DevOps：工具和编号</a></li>
<li><a href="../zh-CN481572/index.html">我的2020年新的Web技术堆栈</a></li>
<li><a href="../zh-CN481576/index.html">前端2019：年度结果</a></li>
<li><a href="../zh-CN481578/index.html">造父变星-宇宙的恒星“里程碑”</a></li>
<li><a href="../zh-CN481580/index.html">新年NUC竞赛。 小计和观众投票</a></li>
<li><a href="../zh-CN481582/index.html">工作与开发乐趣（基本知识）＃2软技能很好。 只是有人误会了他们</a></li>
<li><a href="../zh-CN481584/index.html">管理团队时，请打破所有规则</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>