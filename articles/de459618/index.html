<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ∏ üà∫ ü§üüèª Einige wenig bekannte Docker-Compose-Funktionen üë©üèæ‚Äçüíª üëàüèª üßòüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Viele Anweisungen aus dem Internet beschreiben ein bestimmtes Minimum an Aktionen und damit ein Minimum an Befehlen und M√∂glichkeiten. 


 Ich beschlo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Einige wenig bekannte Docker-Compose-Funktionen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459618/"><p>  Viele Anweisungen aus dem Internet beschreiben ein bestimmtes Minimum an Aktionen und damit ein Minimum an Befehlen und M√∂glichkeiten. </p><br><p> Ich beschloss, eine Auswahl von ein wenig beleuchteten Merkmalen, Merkmalen, zu treffen.  Der Artikel behauptet nicht, einzigartig zu sein, er wird mir als Erinnerung helfen, und vielleicht wird er einigen Padawanern helfen, ihre Reise mit Docker-Compose zu beginnen. </p><a name="habracut"></a><br><h4 id="ispolzovanie-neskolkih-docker-composeyml-faylov">  Verwenden mehrerer docker-compose.yml-Dateien </h4><br><p>  Es gibt komplexe Konfigurationen, bei denen es eine bestimmte Grundschicht von Containern gibt, die beispielsweise immer ben√∂tigt wird.  Und normalerweise kommt es vor, dass wir vom benachbarten Team \ ein anderes Projekt \ Internet nehmen und es nach Ihren W√ºnschen fertigstellen.  Wenn jedoch mehrere Befehle vorhanden sind, kann der Basisteil in ein gemeinsames internes Repository verschoben werden.  Und wir erhalten f√ºr die meisten Projekte ein identisches Basisteil, das ebenfalls versioniert ist. </p><br><p>  Beschreiben wir ein Beispiel f√ºr eine grundlegende Docker-Compose-Base.yml. </p><br><p>  Angenommen, dies ist ein benutzerdefiniertes Nginx-Image mit Zertifikaten, Optimierungen und Say-Metriken.  Und Exporteur f√ºr Prometheus: </p><br><pre><code class="plaintext hljs">version: '2' services: nginx: image: nginx nginx-exporter: image: nginx/nginx-prometheus-exporter</code> </pre> <br><p>  Nun beschreiben wir ein Beispiel f√ºr unsere Anwendung docker-compose-app.yml: </p><br><pre> <code class="plaintext hljs">version: '2' services: backend: image: internal.local/super-app:0.1.2</code> </pre> <br><p>  Zu Beginn brauchen wir das √ºbliche Team mit einem Unterschied.  Wir werden 2 Docker-Compose-Dateien angeben: </p><br><pre> <code class="plaintext hljs">docker-compose up -d -f docker-compose-base.yml -f docker-compose-app.yml</code> </pre> <br><p>  Und voila, wir bekommen eine Reihe von Diensten, als ob sie in einer einzigen Docker-Compose-Datei beschrieben w√§ren! </p><br><p>  Es gibt auch eine zweite Option f√ºr die Verwendung mehrerer Dateien mithilfe der Extended-Direktive. </p><br><p>  docker-compose-base.yml: </p><br><pre> <code class="plaintext hljs">version: '2' services: nginx: image: nginx nginx-exporter: image: nginx/nginx-prometheus-exporter</code> </pre><br><p>  docker-compose-app.yml: </p><br><pre> <code class="plaintext hljs">version: '2' services: backend: image: internal.local/super-app:0.1.2 ###      web: extends: #     (   ) file: docker-compose-base.yml #       service: nginx web-exporter: extends: file: docker-compose-base.yml service: nginx-exporter</code> </pre> <br><p>  Add-on von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">iSlava</a> : <br>  Sie k√∂nnen alle Erstellungsdateien in Umgebungsvariablen beschreiben und docker-compose up -d verwenden, ohne Dateien manuell anzugeben: </p><br><pre> <code class="plaintext hljs">COMPOSE_PATH_SEPARATOR=: COMPOSE_FILE=docker-compose-base.yml:docker-compose-app.yml</code> </pre> <br><p>  Welche Option Sie w√§hlen - Sie w√§hlen.  Alles einzeln wollte ich nur Optionen zeigen =) </p><br><h4 id="nasledovanie-v-docker-compose">  Vererbung in Docker-Compose </h4><br><p>  Das folgende Beispiel erfordert die Version docker-compose <strong>&gt; = 2.4</strong> <br>  Auch ein ziemlich interessantes Feature, und tats√§chlich werden nur wenige erw√§hnt. <br>  Diese Funktionalit√§t erm√∂glicht es uns, mehrere Dienste desselben Typs in der Docker-Compose-Datei zu beschreiben, ohne ihre Beschreibung zu duplizieren, n√§mlich zu erben. <br>  Zum Beispiel haben wir eine Datei wie diese: </p><br><pre> <code class="plaintext hljs">version: '2.4' services: backend: image: internal.local/super-app:0.1.2 ports: - 8080:8080 - 9090:9090 volumes: - ./conf/some.conf:/etc/app/some.conf:ro</code> </pre> <br><p>  Es bestand die Notwendigkeit, mehrere Container anzuheben, aber mit einigen Unterschieden k√∂nnen wir nat√ºrlich "sparen" und √§ndern, aber wir k√∂nnen dies tun: </p><br><pre> <code class="plaintext hljs">version: '2.4' services: backend: &amp;base-app #          image: internal.local/super-app:0.1.2 ports: - 8080:8080 - 9090:9090 volumes: - ./conf/some.conf:/etc/app/some.conf:ro backend-2: &lt;&lt;: *base-app # ports: #    - 8081:8080</code> </pre> <br><p>  Auf diese Weise haben wir die M√∂glichkeit, an einer Stelle zu wechseln, anstatt die Beschreibung jedes Containers zu bearbeiten. <br>  Es gibt eine andere Option, um in den Stammbereich zu wechseln, zum Beispiel: </p><br><pre> <code class="plaintext hljs">version: '2.4' services: x-backend: #   "x-"  ,    . &amp;base-app image: internal.local/super-app:0.1.2 ports: - 8080:8080 - 9090:9090 volumes: - ./conf/some.conf:/etc/app/some.conf:ro backend: &lt;&lt;: *base-app # backend-2: &lt;&lt;: *base-app # ports: #    - 8081:8080</code> </pre> <br><h4 id="ogranicheniya-po-resursam">  Ressourcenlimits </h4><br><p>  Ab Version 2.2 k√∂nnen Sie Ressourcenbeschr√§nkungen f√ºr Container verwenden, tats√§chlich ab Version 2.1, aber es werden immer noch nicht alle ausgeliefert =) <br>  Es gibt eine Nuance!  <u>In Version <strong>3 werden</strong> diese Funktionen entfernt!</u>  Der Schwerpunkt liegt bereits auf dem Hafenschwarm. </p><br><p>  Das einfachste Beispiel f√ºr eine CPU-Ressourcenbeschr√§nkung, MEM: </p><br><pre> <code class="plaintext hljs">version: '2.2' services: backend: cpus: 1.5 #   . cpuset: '0,3' #     . mem_limit: 1gb #  1  memswap_limit: 2gb # SWAP   . oom_kill_disable: true #   ,    OOM Killer        ,       . image: internal.local/super-app:0.1.2 ports: - 8080:8080 - 9090:9090 volumes: - ./conf/some.conf:/etc/app/some.conf:ro</code> </pre> <br><h4 id="upakovka-obrazov-v-arhiv">  Bilder in ein Archiv packen </h4><br><p>  Leider ist es nicht immer m√∂glich, Bilder in Ihre eigene oder Cloud-Docker-Registrierung zu pushen.  Manchmal m√ºssen Bilder aus einer Docker-Compose-Datei gesammelt und beispielsweise ein Dateiarchiv gesendet werden.  H√§nde machen es manchmal lange, also habe ich ein einfaches Skript entworfen, pl√∂tzlich ist jemand n√ºtzlich: </p><br><pre> <code class="plaintext hljs">#!/bin/bash dc=${1} if [ ! -z ${dc} ] &amp;&amp; [ -f ${dc} ]; then echo "Saving docker images from file ${dc}..." images=`grep image: ${dc} | awk '{print $2}'` docker save ${images} | gzip &gt; docker-images.gz echo "Success!" else echo "ERROR! You must set path to docker-compose.yml as argument!" fi</code> </pre> <br><p>  Speichern Sie in der Datei docker-compose-images-save.sh <br>  Wir geben das Recht zur Ausf√ºhrung: <br> <code>chmod +x docker-compose-images-save.sh</code> <br>  Wir starten es und √ºbergeben den Pfad zur Docker-Compose-Datei als Argument: <br> <code>./docker-compose-images-save.sh /home/some_user/docker-compose-app.yml</code> <br>  Bei der Ausgabe gelangen wir in den Ordner, aus dem das <code>docker-images.gz</code> mit Bildern aufgerufen wurde - <code>docker-images.gz</code> <br>  Auf jede Art und Weise k√∂nnen wir an einen Remote-Server senden. <br>  Jetzt reicht es auf dem Remote-Server aus, Folgendes auszuf√ºhren: <br> <code>gzip -cd docker-images.gz | docker load</code> <br>  Alle Bilder werden in die lokale Registrierung hochgeladen, danach k√∂nnen Sie sie hier sicher ausf√ºhren <br>  <code>docker-compose up -d</code> , da sich alle Bilder in der lokalen Registrierung im Internet befinden, wird Docker nicht darauf zugreifen. </p><br><h4 id="probrasyvaem-ipv6">  IPv6 weiterleiten </h4><br><p>  Bei bestimmten Aufgaben kann IPv6 √§u√üerst n√ºtzlich sein. Nehmen Sie zumindest die Nuance, dass Roskomnadzor den gesamten Datenverkehr problemlos √ºber IPv6 leitet, und derselbe Telegrammbot funktioniert problemlos. <br>  Ich werde eine Situation betrachten, in der sich IPv6 nicht auf Ihrem Computer befindet, sei es eine virtuelle Maschine oder ein Server im Internet. <br>  Stellen Sie sicher, dass IPv6 auf Systemebene aktiviert ist: </p><br><pre> <code class="plaintext hljs"> sysctl net.ipv6.conf.all.disable_ipv6</code> </pre> <br><p>  Der Wert sollte 0 sein, wenn nicht, √§ndern Sie: </p><br><pre> <code class="plaintext hljs"> sysctl -w net.ipv6.conf.all.disable_ipv6=0</code> </pre> <br><p>  Miredo installieren (Dies ist ein Dienst mit einem integrierten VPN zum Server, der uns √∂ffentliches IPv6 gibt.) </p><br><pre> <code class="plaintext hljs"> apt-get install miredo -y</code> </pre> <br><p>  √úberpr√ºfen Sie, ob der Dienst ausgef√ºhrt wird: </p><br><pre> <code class="plaintext hljs"> systemctl status miredo</code> </pre> <br><p>  Wir √ºberpr√ºfen, ob wir die IPv6-Adresse erhalten haben: </p><br><pre> <code class="plaintext hljs"> ifconfig teredo</code> </pre> <br><p>  Wir schreiben in /etc/docker/daemon.json </p><br><pre> <code class="plaintext hljs"> { "ipv6": true, "fixed-cidr-v6": "2001:db8:1::/64" }</code> </pre> <br><p>  Starten Sie den Docker neu: </p><br><pre> <code class="plaintext hljs"> systemctl restart docker</code> </pre> <br><p>  Nun, es bleibt NAT f√ºr IPv6 zu aktivieren, damit die internen Adressen unseres Containers √ºber unsere Teredo-Schnittstelle nach au√üen gelangen k√∂nnen: </p><br><pre> <code class="plaintext hljs"> ip6tables -t nat -A POSTROUTING -o teredo -j MASQUERADE</code> </pre> <br><p>  Wir erh√∂hen den Docker-Container, den wir ben√∂tigen, und er kann √ºber die IPv6-Adresse ver√∂ffentlicht werden. </p><br><blockquote>  Das obige Beispiel mit sysctl und iptables funktioniert bis zum Neustart. Wenn Sie dies fortlaufend tun m√ºssen, sollten Sie die Anweisungen f√ºr Ihre Distribution lesen. Es gibt Unterschiede. </blockquote><p>  Ich hoffe, jemand, der die Informationen hier zur Verf√ºgung gestellt hat, wird n√ºtzlich sein. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de459618/">https://habr.com/ru/post/de459618/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de459606/index.html">Verteilte soziale Netzwerke</a></li>
<li><a href="../de459610/index.html">Diese gef√§hrlichen Router: das umfangreichste Hacken aktueller Netzwerkger√§te und Schutzmethoden</a></li>
<li><a href="../de459612/index.html">Wie Qualcomm die Mobilfunkbranche fast 20 Jahre hintereinander betrogen hat</a></li>
<li><a href="../de459614/index.html">Roboterente r√ºhrt Reisfelder auf</a></li>
<li><a href="../de459616/index.html">MIPT er√∂ffnet Russlands ersten fortgeschrittenen Masterstudiengang in Informatik und Softwaretechnik</a></li>
<li><a href="../de459620/index.html">TDDx2, BDD, DDD, FDD, MDD und PDD oder was auch immer Sie √ºber Driven Development wissen m√∂chten</a></li>
<li><a href="../de459622/index.html">Als die Spiele f√ºr Sega Saturn wurden 1995 geschrieben</a></li>
<li><a href="../de459624/index.html">Milit√§rische Drohnen</a></li>
<li><a href="../de459626/index.html">Windows Notification Facility: Die am wenigsten dokumentierte Angriffsfl√§che</a></li>
<li><a href="../de459628/index.html">Das Open Invention Network hat mehr als dreitausend Lizenznehmer - was bedeutet das f√ºr Open Source-Software?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>