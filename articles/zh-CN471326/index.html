<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥  ğŸ“± ğŸŒ å±é™©stdçš„æ•…äº‹:: enable_shared_from_thisæˆ–Zombieåæ¨¡å¼ ğŸ‘¸ğŸ¿ ğŸ‘ƒ ğŸ’…ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ¬æ–‡æä¾›äº†ä¸€ä¸ªå±é™©çš„åæ¨¡å¼â€œ Zombieâ€ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨std :: enable_shared_from_thisæ—¶è‡ªç„¶ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ è¯¥ææ–™ä½äºç°ä»£C ++æŠ€æœ¯å’Œä½“ç³»ç»“æ„çš„äº¤æ±‡å¤„ã€‚ 

 å¼•è¨€ 
 C ++ 11ä¸ºå¼€å‘äººå‘˜æä¾›äº†ä½¿ç”¨å†…å­˜çš„å‡ºè‰²å·¥å…·-æ™ºèƒ½æŒ‡é’ˆstd :: unique_p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å±é™©stdçš„æ•…äº‹:: enable_shared_from_thisæˆ–Zombieåæ¨¡å¼</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471326/"> æœ¬æ–‡æä¾›äº†ä¸€ä¸ªå±é™©çš„åæ¨¡å¼â€œ Zombieâ€ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨std :: enable_shared_from_thisæ—¶è‡ªç„¶ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ è¯¥ææ–™ä½äºç°ä»£C ++æŠ€æœ¯å’Œä½“ç³»ç»“æ„çš„äº¤æ±‡å¤„ã€‚ <br><a name="habracut"></a><br><h3> å¼•è¨€ </h3><br>  C ++ 11ä¸ºå¼€å‘äººå‘˜æä¾›äº†ä½¿ç”¨å†…å­˜çš„å‡ºè‰²å·¥å…·-æ™ºèƒ½æŒ‡é’ˆstd :: unique_ptrå’Œä¸€å †std :: shared_ptr + std :: weak_ptrã€‚ ä¸ºäº†æ–¹ä¾¿å’Œå®‰å…¨ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆè¿œè¿œè¶…è¿‡äº†åŸå§‹æŒ‡é’ˆçš„ä½¿ç”¨ã€‚ æ™ºèƒ½æŒ‡é’ˆåœ¨å®è·µä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå› ä¸º ä¸è·Ÿè¸ªåŠ¨æ€åˆ›å»ºçš„å®ä½“çš„åˆ›å»º/åˆ é™¤çš„æ­£ç¡®æ€§ç›¸æ¯”ï¼Œå…è®¸å¼€å‘äººå‘˜å°†é‡ç‚¹æ”¾åœ¨æ›´é«˜çº§åˆ«çš„é—®é¢˜ä¸Šã€‚ <br>  std :: enable_shared_from_thisç±»æ¨¡æ¿ä¹Ÿæ˜¯è¯¥æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œå½“æ‚¨åˆæ¬¡é‡åˆ°å®ƒæ—¶ï¼Œå®ƒä¼¼ä¹å¾ˆå¥‡æ€ªã€‚ <br> æœ¬æ–‡å°†è®¨è®ºå¦‚ä½•ä½¿ç”¨å®ƒã€‚ <br><br><h2> æ•™è‚²è®¡åˆ’ </h2><br><div class="spoiler">  <b class="spoiler_title">RAIIå’Œæ™ºèƒ½æŒ‡é’ˆ</b> <div class="spoiler_text">æ™ºèƒ½æŒ‡é’ˆçš„ç›´æ¥ç›®çš„æ˜¯è¦ç…§é¡¾åœ¨å †ä¸Šåˆ†é…<b>çš„RAM</b> ã€‚ æ™ºèƒ½æŒ‡é’ˆå®ç°RAIIä¹ æƒ¯ç”¨æ³•ï¼ˆèµ„æºè·å–æ˜¯åˆå§‹åŒ–ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°è¿›è¡Œè°ƒæ•´ä»¥é€‚åº”éœ€è¦åˆå§‹åŒ–å’Œéå¹³å‡¡çš„ååˆå§‹åŒ–çš„å…¶ä»–ç±»å‹çš„èµ„æºï¼Œä¾‹å¦‚ï¼š <br>  -æ–‡ä»¶ï¼› <br>  -ç£ç›˜ä¸Šçš„ä¸´æ—¶æ–‡ä»¶å¤¹ï¼› <br>  -ç½‘ç»œè¿æ¥ï¼ˆhttpï¼Œwebsocketsï¼‰ï¼› <br>  -æ‰§è¡Œçº¿ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ï¼› <br>  -äº’æ–¥é”ï¼› <br>  -å…¶ä»–ï¼ˆè¶³ä»¥å®ç°å¹»æƒ³ï¼‰ã€‚ <br> å¯¹äºè¿™æ ·çš„æ¦‚æ‹¬ï¼Œç¼–å†™ä¸€ä¸ªç±»å°±è¶³å¤Ÿäº†ï¼ˆå®é™…ä¸Šï¼Œæœ‰æ—¶æ‚¨ç”šè‡³ä¸èƒ½ç¼–å†™ä¸€ä¸ªç±»ï¼Œè€Œåªæ˜¯ä½¿ç”¨deleter-ä½†ä»Šå¤©çš„æ•…äº‹å·²ä¸æ¶‰åŠè¯¥ç±»äº†ï¼‰ï¼Œå®ƒå®ç°äº†ï¼š <br>  -åœ¨æ„é€ å‡½æ•°ä¸­æˆ–åœ¨å•ç‹¬çš„æ–¹æ³•ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼› <br>  -åœ¨ææ„å‡½æ•°ä¸­å–æ¶ˆåˆå§‹åŒ–ï¼Œ <br> ç„¶åæ ¹æ®æ‰€éœ€çš„æ‰€æœ‰æƒæ¨¡å‹-è”åˆï¼ˆstd :: shared_ptrï¼‰æˆ–å”¯ä¸€ï¼ˆstd :: unique_ptrï¼‰å°†å…¶â€œåŒ…è£…â€åˆ°é€‚å½“çš„æ™ºèƒ½æŒ‡é’ˆä¸­ã€‚ è¿™å¯¼è‡´â€œä¸¤å±‚RAIIâ€ï¼šæ™ºèƒ½æŒ‡é’ˆå…è®¸æ‚¨è½¬ç§»/å…±äº«èµ„æºæ‰€æœ‰æƒï¼Œè€Œç”¨æˆ·ç±»åˆå§‹åŒ–/å–æ¶ˆåˆå§‹åŒ–éæ ‡å‡†èµ„æºã€‚ <br>  std :: shared_pträ½¿ç”¨é“¾æ¥è®¡æ•°æœºåˆ¶ã€‚ è¯¥æ ‡å‡†å®šä¹‰äº†å¼ºé“¾æ¥çš„è®¡æ•°å™¨ï¼ˆè®¡ç®—std :: shared_ptrçš„ç°æœ‰å‰¯æœ¬æ•°ï¼‰å’Œå¼±é“¾æ¥çš„è®¡æ•°å™¨ï¼ˆè®¡ç®—ä¸ºæ­¤std :: shared_ptrå®ä¾‹åˆ›å»ºçš„std :: weak_ptrçš„ç°æœ‰å‰¯æœ¬æ•°ï¼‰ã€‚ è‡³å°‘ä¸€ä¸ªç‰¢å›ºçš„é“¾æ¥çš„å­˜åœ¨ç¡®ä¿äº†é”€æ¯å°šæœªå®Œæˆã€‚ æ­¤std :: shared_ptrå±æ€§å¹¿æ³›ç”¨äºç¡®ä¿å¯¹è±¡çš„æœ‰æ•ˆæ€§ï¼Œç›´åˆ°åœ¨ç¨‹åºçš„æ‰€æœ‰éƒ¨åˆ†ä¸­å®Œæˆå¯¹å®ƒçš„ä½¿ç”¨ä¸ºæ­¢ã€‚ å¼±é“¾æ¥çš„å­˜åœ¨å¹¶ä¸èƒ½é˜²æ­¢å¯¹è±¡çš„ç ´åï¼Œè€Œåªèƒ½åœ¨å¯¹è±¡è¢«ç ´åä¹‹å‰è·å¾—å¼ºé“¾æ¥ã€‚ <br>  RAIIä¿è¯èµ„æºé‡Šæ”¾æ¯”æ˜¾å¼è°ƒç”¨delete / delete [] / free / close / reset / unlockè¦å¯é å¾—å¤šï¼Œå› ä¸ºï¼š <br>  -æ‚¨åªéœ€å¿˜è®°æ˜¾å¼è°ƒç”¨ï¼› <br>  -ä¸€ä¸ªæ˜¾å¼çš„è°ƒç”¨å¯èƒ½ä¼šå¤šæ¬¡é”™è¯¯åœ°å‘å‡ºï¼› <br>  -åœ¨å®ç°èµ„æºçš„å…±äº«æ‰€æœ‰æƒæ—¶ï¼Œæ˜ç¡®çš„æŒ‘æˆ˜æ˜¯å›°éš¾çš„ï¼› <br>  -c ++ä¸­çš„å †æ ˆæå‡æœºåˆ¶å¯ç¡®ä¿åœ¨å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µä¸‹ä¸ºè¶…å‡ºèŒƒå›´çš„æ‰€æœ‰å¯¹è±¡è°ƒç”¨ææ„å‡½æ•°ã€‚ <br> æˆè¯­ä¸­å–æ¶ˆåˆå§‹åŒ–çš„ä¿è¯æ˜¯å¦‚æ­¤é‡è¦ï¼Œä»¥è‡³äºå®ƒåœ¨åˆå§‹åŒ–çš„åŒæ—¶ä¹Ÿåº”åœ¨æˆè¯­çš„åç§°ä¸­å æœ‰ä¸€å¸­ä¹‹åœ°ã€‚ <br> æ™ºèƒ½æŒ‡é’ˆä¹Ÿæœ‰ç¼ºç‚¹ï¼š <br>  -åœ¨æ€§èƒ½å’Œå†…å­˜æ–¹é¢å­˜åœ¨å¼€é”€ï¼ˆå¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºè€Œè¨€å¹¶ä¸é‡è¦ï¼‰ï¼› <br>  -å‘¨æœŸæ€§é“¾æ¥å¯èƒ½é˜»æ­¢èµ„æºçš„é‡Šæ”¾å¹¶å¯¼è‡´å…¶æ³„æ¼ã€‚ <br> å½“ç„¶ï¼Œæ¯ä¸ªå¼€å‘äººå‘˜éƒ½ä¸æ­¢ä¸€æ¬¡é˜…è¯»æœ‰å…³å¾ªç¯é“¾æ¥çš„å†…å®¹ï¼Œå¹¶çœ‹åˆ°äº†æœ‰é—®é¢˜çš„ä»£ç çš„ç»¼åˆç¤ºä¾‹ã€‚ <br> ç”±äºä»¥ä¸‹åŸå› ï¼Œè¯¥å±é™©ä¼¼ä¹å¾®ä¸è¶³é“ï¼š <br>  -å¦‚æœå†…å­˜æ³„æ¼é¢‘ç¹ä¸”é¢‘ç¹-åœ¨æ¶ˆè€—ä¸Šå¾ˆæ˜æ˜¾ï¼Œå¹¶ä¸”å¾ˆå°‘æˆ–å¾ˆå°‘-é‚£ä¹ˆé—®é¢˜å°±ä¸å¤ªå¯èƒ½åœ¨æœ€ç»ˆç”¨æˆ·çº§åˆ«æ˜¾ç°å‡ºæ¥ï¼› <br>  -å¯¹æ³„æ¼ä½¿ç”¨åŠ¨æ€ä»£ç åˆ†æï¼ˆValgrindï¼ŒClang LeakSanitizerç­‰ï¼‰ï¼› <br>  -â€œæˆ‘ä¸æ˜¯é‚£æ ·å†™çš„â€ï¼› <br>  -â€œæˆ‘çš„æ¶æ„æ˜¯æ­£ç¡®çš„â€ï¼› <br>  â€œæˆ‘ä»¬çš„ä»£ç æ­£åœ¨å®¡æŸ¥ä¸­ã€‚â€ <br></div></div><br><div class="spoiler">  <b class="spoiler_title">std :: enable_shared_from_this</b> <div class="spoiler_text"> åœ¨C ++ 11ä¸­ï¼Œå¼•å…¥äº†è¾…åŠ©ç±»std :: enable_shared_from_thisã€‚ å¯¹äºæˆåŠŸæ„å»ºæ²¡æœ‰std :: enable_shared_from_thisçš„ä»£ç çš„å¼€å‘äººå‘˜ï¼Œæ­¤ç±»çš„æ½œåœ¨ç”¨é€”å¯èƒ½å¹¶ä¸æ˜æ˜¾ã€‚ <br>  std :: enable_shared_from_thisæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ <br> å®ƒå…è®¸åœ¨std :: shared_pträ¸­å®ä¾‹åŒ–çš„ç±»çš„æˆå‘˜å‡½æ•°æ¥æ”¶åˆ›å»ºå®ƒçš„std :: shared_ptrçš„å…¶ä»–å¼ºæ‹·è´ï¼ˆshared_from_thisï¼ˆï¼‰ï¼‰æˆ–å¼±æ‹·è´ï¼ˆweak_from_thisï¼ˆï¼‰ï¼Œä»C ++ 17å¼€å§‹ï¼‰ã€‚ ã€‚ æ‚¨ä¸èƒ½ä»æ„é€ å‡½æ•°å’Œææ„å‡½æ•°è°ƒç”¨shared_from_thisï¼ˆï¼‰å’Œweak_from_thisï¼ˆï¼‰ã€‚ <br><br>  <b>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¾›è‹¦ï¼Ÿ</b>  <b>æ‚¨å¯ä»¥ç®€å•åœ°æ„é€ std :: shared_ptr &lt;T&gt;ï¼ˆthisï¼‰</b> <br> ä¸ï¼Œä½ ä¸èƒ½ã€‚ æ‰€æœ‰å…³å¿ƒè¯¥ç±»çš„åŒä¸€å®ä¾‹çš„std :: shared_ptrså¿…é¡»ä½¿ç”¨ä¸€ä¸ªé“¾æ¥è®¡æ•°å•å…ƒã€‚ æ²¡æœ‰ç‰¹æ®Šçš„é­”æœ¯æ˜¯æ²¡æœ‰åŠæ³•çš„ã€‚ <br><br> ä½¿ç”¨std :: enable_shared_from_thisçš„å…ˆå†³æ¡ä»¶æ˜¯é¦–å…ˆåœ¨std :: shared_pträ¸­åˆ›å»ºä¸€ä¸ªç±»å¯¹è±¡ã€‚ åœ¨å †æ ˆä¸Šåˆ›å»ºï¼Œåœ¨å †ä¸ŠåŠ¨æ€åˆ†é…ï¼Œåœ¨std :: unique_pträ¸Šåˆ›å»º-æ‰€æœ‰è¿™äº›éƒ½ä¸é€‚åˆã€‚ ä»…ä¸¥æ ¼åœ¨std :: shared_pträ¸­ã€‚ <br><br>  <b>æ˜¯å¦å¯ä»¥é€šè¿‡åˆ›å»ºç±»å®ä¾‹çš„æ–¹å¼æ¥é™åˆ¶ç”¨æˆ·ï¼Ÿ</b> <br> æ˜¯çš„ï¼Œä½ å¯ä»¥ã€‚ ä¸ºæ­¤ï¼Œåªéœ€ï¼š <br>  -æä¾›é™æ€æ–¹æ³•æ¥åˆ›å»ºæœ€åˆæ”¾ç½®åœ¨std :: shared_pträ¸­çš„å®ä¾‹ï¼› <br>  -å°†æ„é€ å‡½æ•°ç½®äºç§æœ‰æˆ–å—ä¿æŠ¤çš„çŠ¶æ€ï¼› <br>  -ç¦æ­¢å¤åˆ¶å’Œç§»åŠ¨è¯­ä¹‰ã€‚ <br> è¯¥ç±»è¿›å…¥äº†ç¬¼å­ï¼Œå°†å…¶é”å®šå¹¶åä¸‹äº†é’¥åŒ™-ä»ç°åœ¨å¼€å§‹ï¼Œå…¶æ‰€æœ‰å®ä¾‹å°†ä»…å­˜åœ¨äºstd :: shared_pträ¸­ï¼Œå¹¶ä¸”æ²¡æœ‰åˆæ³•çš„æ–¹æ³•å¯ä»¥å°†å®ƒä»¬ç§»å‡ºé‚£é‡Œã€‚ <br> è¿™æ ·çš„é™åˆ¶ä¸èƒ½ç§°ä¸ºå¥½çš„ä½“ç³»ç»“æ„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æ­¤æ–¹æ³•å®Œå…¨ç¬¦åˆæ ‡å‡†ã€‚ <br> å¦å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨PIMPLæƒ¯ç”¨è¯­ï¼šåå¤æ— å¸¸ç±»çš„å”¯ä¸€ç”¨æˆ·-Facade-å°†ä¸¥æ ¼åœ¨std :: shared_pträ¸­åˆ›å»ºå®ç°ï¼Œå¹¶ä¸”Facadeæœ¬èº«å·²ç»è¢«å–æ¶ˆäº†è¿™ç§é™åˆ¶ã€‚ <br><br>  std :: enable_shared_from_thisåœ¨ç»§æ‰¿æ–¹é¢æœ‰å¾ˆå¤šç»†å¾®å·®åˆ«ï¼Œä½†æ˜¯è®¨è®ºå®ƒä»¬ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚ <br></div></div><br><h2> åˆ‡å…¥ç‚¹ </h2><br> æœ¬æ–‡æä¾›çš„æ‰€æœ‰ä»£ç ç¤ºä¾‹å‡åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github</a>ä¸Šå‘å¸ƒã€‚ <br> è¯¥ä»£ç æ¼”ç¤ºäº†ä¼ªè£…æˆç°ä»£C ++é€šå¸¸å®‰å…¨ä½¿ç”¨çš„ä¸è‰¯æŠ€æœ¯ <br><br><h3> å•å¾ªç¯ </h3><br> ä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆé¢„ç¤ºç€é—®é¢˜ã€‚ ç±»å£°æ˜çœ‹èµ·æ¥å¾ˆç®€å•æ˜äº†ã€‚ é™¤äº†ä¸€ä¸ªâ€œå°â€ç»†èŠ‚å¤–-å‡ºäºæŸç§åŸå› ï¼Œå°†ç»§æ‰¿è‡ªstd :: enable_shared_from_thisã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">SimpleCyclic.h</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;memory&gt; #include &lt;functional&gt; namespace SimpleCyclic { class Cyclic final : public std::enable_shared_from_this&lt;Cyclic&gt; { public: static std::shared_ptr&lt;Cyclic&gt; create(); Cyclic(const Cyclic&amp;) = delete; Cyclic(Cyclic&amp;&amp;) = delete; Cyclic&amp; operator=(const Cyclic&amp;) = delete; Cyclic&amp; operator=(Cyclic&amp;&amp;) = delete; ~Cyclic(); void doSomething(); private: Cyclic(); std::function&lt;void(void)&gt; _fn; }; } // namespace SimpleCyclic</span></span></span></span></code> </pre> <br></div></div><br> å¹¶åœ¨å®æ–½ä¸­ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">SimpleCyclic.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include "SimpleCyclic.h" namespace SimpleCyclic { Cyclic::Cyclic() = default; Cyclic::~Cyclic() { std::cout &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; } std::shared_ptr&lt;Cyclic&gt; Cyclic::create() { return std::shared_ptr&lt;Cyclic&gt;(new Cyclic); } void Cyclic::doSomething() { _fn = [shis = shared_from_this()](){}; std::cout &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; } } // namespace SimpleCyclic</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">main.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SimpleCyclic/SimpleCyclic.h"</span></span></span><span class="hljs-meta"> int main() { auto simpleCyclic = SimpleCyclic::Cyclic::create(); simpleCyclic-&gt;doSomething(); return 0; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">æ§åˆ¶å°è¾“å‡º</b> <div class="spoiler_text"><blockquote>  N12SimpleCyclic6CyclicE :: doSomething <br></blockquote><br></div></div><br> åœ¨doSomethingï¼ˆï¼‰å‡½æ•°çš„ä¸»ä½“ä¸­ï¼Œç±»å®ä¾‹<b>æœ¬èº«å°†</b>åˆ›å»ºæ”¾ç½®å®ƒçš„std :: shared_ptrçš„å¦ä¸€ä¸ªå¼ºå‰¯æœ¬ã€‚ ç„¶åï¼Œä½¿ç”¨é€šç”¨æ•è·ï¼Œå°†æ­¤å‰¯æœ¬æ”¾ç½®åœ¨ä»¥æ— å®³std ::å‡½æ•°ä¸ºå¹Œå­åˆ†é…ç»™ç±»æ•°æ®å­—æ®µçš„lambdaå‡½æ•°ä¸­ã€‚ è°ƒç”¨doSomethingï¼ˆï¼‰ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨ï¼Œå¹¶ä¸”å³ä½¿åœ¨é”€æ¯æ‰€æœ‰å¤–éƒ¨å¼ºé“¾æ¥ä¹‹åï¼Œè¯¥ç±»å®ä¾‹ä¹Ÿå°†ä¸å†è¢«é”€æ¯ã€‚ <br> å†…å­˜æ³„æ¼ã€‚ ä¸è°ƒç”¨SimpleCyclic :: Cyclic ::ã€œå¾ªç¯ææ„å‡½æ•°ã€‚ <br><br>  <b>ç±»å®ä¾‹â€œä¿æŒâ€è‡ªèº«ã€‚</b> <b><br></b>  <b>ä»£ç é™·å…¥äº†å›°å¢ƒã€‚</b> <br><br><img src="https://habrastorage.org/webt/xp/jj/_a/xpjj_atj4bf0av8kar46ebxqqew.jpeg"><br>  ï¼ˆå›¾ç‰‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¥è‡ªè¿™é‡Œ</a> ï¼‰ <br><br>  <b>ä»€ä¹ˆæ˜¯â€œåƒµå°¸â€åæ¨¡å¼ï¼Ÿ</b> <br> ä¸ï¼Œè¿™åªæ˜¯ä¸€ç§é”»ç‚¼ã€‚ æ‰€æœ‰æœ€æœ‰è¶£çš„äº‹æƒ…å°šæœªåˆ°æ¥ã€‚ <br><br>  <b>å¼€å‘äººå‘˜ä¸ºä»€ä¹ˆè¦å†™è¿™ä¸ªï¼Ÿ</b> <br> ç»¼åˆç¤ºä¾‹ã€‚ æˆ‘ä¸çŸ¥é“åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½å’Œè°åœ°è·å¾—è¿™æ ·çš„ä»£ç ã€‚ <br><br>  <b>é‚£ä¹ˆï¼ŒåŠ¨æ€ä»£ç åˆ†ææ˜¯å¦ä¿æŒæ²‰é»˜ï¼Ÿ</b> <br> ä¸ï¼ŒValgrindè¯šå®åœ°æŠ¥å‘Šäº†å†…å­˜æ³„æ¼ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">åç“¦å°”æ ¼æœ—å¾·</b> <div class="spoiler_text"><blockquote>  1å—ä¸­çš„96ï¼ˆ64ä¸ªç›´æ¥ï¼Œ32ä¸ªé—´æ¥ï¼‰å­—èŠ‚<b>è‚¯å®š</b>åœ¨46çš„ä¸¢å¤±è®°å½•ä¸­ä¸¢å¤± <br> åœ¨/ç”¨æˆ·/ç”¨æˆ·/é¡¹ç›®/Zomby_antipattern_concept/SimpleCyclic/SimpleCyclic.cppä¸­çš„SimpleCyclic :: Cyclic :: createï¼ˆï¼‰ä¸­ <br>  1ï¼šåœ¨/usr/local/Cellar/valgrind/HEAD-60ab74a/lib/valgrind/vgpreload_memcheck-amd64-darwin.soä¸­çš„malloc <br>  2ï¼š/usr/lib/libc++abi.dylibä¸­çš„è¿ç®—ç¬¦newï¼ˆæ— ç¬¦å·é•¿ï¼‰ <br>  3ï¼šåœ¨/Users/User/Projects/Zomby_antipattern_concept/SimpleCyclic/SimpleCyclic.cpp:15ä¸­çš„SimpleCyclic :: Cyclic :: createï¼ˆï¼‰ <br>  4ï¼šä¸»è¦ä½äº/Users/User/Projects/Zomby_antipattern_concept/SimpleCyclic/main.cpphaps <br></blockquote><br></div></div><br><h3> åŒç¯ </h3><br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤´æ–‡ä»¶çœ‹èµ·æ¥å®Œå…¨æ­£ç¡®ä¸”ç®€æ´ã€‚ å®ƒå£°æ˜äº†ä¸€ä¸ªåœ¨std :: shared_pträ¸­å­˜å‚¨ç‰¹å®šå®ç°çš„å¤–è§‚ã€‚ ä¸å‰é¢çš„ç¤ºä¾‹ä¸åŒï¼Œç¼ºå°‘ç»§æ‰¿-åŒ…æ‹¬ä»std :: enable_shared_from_thisçš„ç»§æ‰¿ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">Pimplcyclic.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;memory&gt; namespace PimplCyclic { class Cyclic { public: Cyclic(); ~Cyclic(); private: class Impl; std::shared_ptr&lt;Impl&gt; _impl; }; } // namespace PimplCyclic</span></span></span></span></code> </pre><br></div></div><br> å¹¶åœ¨å®æ–½ä¸­ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">Pimplcyclic.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;functional&gt; #include "PimplCyclic.h" namespace PimplCyclic { class Cyclic::Impl : public std::enable_shared_from_this&lt;Cyclic::Impl&gt; { public: ~Impl() { std::cout &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; } void doSomething() { _fn = [shis = shared_from_this()](){}; std::cout &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; } private: std::function&lt;void(void)&gt; _fn; }; Cyclic::Cyclic() : _impl(std::make_shared&lt;Impl&gt;()) { if (_impl) { _impl-&gt;doSomething(); } } Cyclic::~Cyclic() { std::cout &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; } } // namespace PimplCyclic</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">main.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"PimplCyclic/PimplCyclic.h"</span></span></span><span class="hljs-meta"> int main() { auto pimplCyclic = PimplCyclic::Cyclic(); return 0; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">æ§åˆ¶å°è¾“å‡º</b> <div class="spoiler_text"><blockquote>  N11PimplCyclic6Cyclic4ImplE :: doSomething <br>  N11PimplCyclic6CyclicE ::ã€œå¾ªç¯ <br></blockquote><br></div></div><br> è°ƒç”¨Impl :: doSomethingï¼ˆï¼‰åœ¨Implç±»çš„å®ä¾‹ä¸­åˆ›å»ºä¸€ä¸ªå¾ªç¯å¼•ç”¨ã€‚ é—¨é¢å·²æ­£ç¡®é”€æ¯ï¼Œä½†å®ç°æ³„æ¼ã€‚ ææ„å‡½æ•°PimplCyclic :: Cyclic :: Impl ::ã€œä¸è¢«è°ƒç”¨ã€‚ <br> è¯¥ç¤ºä¾‹å†æ¬¡æ˜¯ç»¼åˆç¤ºä¾‹ï¼Œä½†è¿™æ¬¡æ›´åŠ å±é™©-æ‰€æœ‰ä¸è‰¯è®¾å¤‡éƒ½ä½äºå®ç°ä¸­ï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°åœ¨å¹¿å‘Šä¸­ã€‚ <br> æ­¤å¤–ï¼Œè¦åˆ›å»ºå¾ªç¯é“¾æ¥ï¼Œç”¨æˆ·ä»£ç é™¤äº†æ„é€ å¤–ä¸éœ€è¦ä»»ä½•æ“ä½œã€‚ <br> é¢å¯¹Valgrindè¿›è¡Œçš„åŠ¨æ€åˆ†æï¼Œè¿™æ¬¡å‘ç°äº†æ³„æ¼ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">åç“¦å°”æ ¼æœ—å¾·</b> <div class="spoiler_text"><blockquote>  1å—ä¸­çš„96å­—èŠ‚<b>è‚¯å®š</b>åœ¨46çš„ä¸¢å¤±è®°å½•ä¸­ä¸¢å¤±äº†29 <br> åœ¨/ç”¨æˆ·/ç”¨æˆ·/é¡¹ç›®/Zomby_antipattern_concept/PimplCyclic/PimplCyclic.cpp:28ä¸­çš„PimplCyclic :: Cyclic :: Cyclicï¼ˆï¼‰ä¸­ <br>  1ï¼šåœ¨/usr/local/Cellar/valgrind/HEAD-60ab74a/lib/valgrind/vgpreload_memcheck-amd64-darwin.soä¸­çš„malloc <br>  2ï¼š/usr/lib/libc++abi.dylibä¸­çš„è¿ç®—ç¬¦newï¼ˆæ— ç¬¦å·é•¿ï¼‰ <br>  3ï¼šåœ¨/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/include/c++/v1/new:252ä¸­çš„std :: __ 1 :: __ libcpp_allocateï¼ˆunsigned longï¼Œunsigned longï¼‰ <br>  4ï¼šstd :: __ 1 ::åˆ†é…å™¨&lt;std :: __ 1 :: __ shared_ptr_emplace &lt;PimplCyclic :: Cyclic :: Implï¼Œstd :: __ 1 ::åˆ†é…å™¨&lt;PimplCyclic :: Cyclic :: Impl &gt;&gt;&gt; allocateï¼ˆunsigned long ï¼Œvoid const *ï¼‰åœ¨/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/include/c++/v1/memory:1813ä¸­ <br>  5ï¼š/Applications/Xcode.app/Contentsä¸­çš„std :: __ 1 :: shared_ptr &lt;PimplCyclic :: Cyclic :: Impl&gt; std :: __ 1 :: shared_ptr &lt;PimplCyclic :: Cyclic :: Impl&gt; :: make_shared &lt;&gt;ï¼ˆï¼‰åœ¨/Applications/Xcode.app/Contentsä¸­/å¼€å‘äººå‘˜/å·¥å…·é“¾/XcodeDefault.xcå·¥å…·é“¾/ usr / include / c ++ / v1 /å†…å­˜ï¼š4326 <br>  6ï¼šåœ¨_ZNSt3__1L11make_sharedIN11PimplCyclic6Cyclic4ImplEJEEENS_9enable_ifIXntsr8is_arrayIT_EE5valueENS_10shared_ptrIS5_EEE4typeEDpOT0_ /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/include/c++/v1/memory:4706 <br>  7ï¼š/Users/User/Projects/Zomby_antipattern_concept/PimplCyclic/PimplCyclic.cpp:28ä¸­çš„PimplCyclic :: Cyclic :: Cyclicï¼ˆï¼‰ <br>  8ï¼š/Users/User/Projects/Zomby_antipattern_concept/PimplCyclic/PimplCyclic.cpp:29ä¸­çš„PimplCyclic :: Cyclic :: Cyclicï¼ˆï¼‰ <br>  9ï¼šä¸»è¦ä½äº/Users/User/Projects/Zomby_antipattern_concept/PimplCyclic/main.cpphaps <br></blockquote><br></div></div><br>  <b>çœ‹åˆ°Pimplæœ‰ç‚¹æ€€ç–‘ï¼Œå…¶ä¸­çš„å®ç°å­˜å‚¨åœ¨std :: shared_pträ¸­ã€‚</b> <br> åŸºäºåŸå§‹æŒ‡é’ˆçš„ç»å…¸Pâ€‹â€‹implè¿‡äºé™ˆæ—§ï¼Œstd :: unique_ptrçš„å‰¯ä½œç”¨æ˜¯åœ¨ç«‹é¢ä¸Šæ‰©å±•äº†å¯¹å¤åˆ¶è¯­ä¹‰çš„ç¦æ­¢ã€‚ è¿™æ ·çš„å¤–è§‚å°†å®ç°å”¯ä¸€æ‰€æœ‰æƒçš„ä¹ æƒ¯ç”¨æ³•ï¼Œè¿™å¯èƒ½ä¸å»ºç­‘ç†å¿µä¸ç¬¦ã€‚ é€šè¿‡ä½¿ç”¨std :: shared_ptræ¥å­˜å‚¨å®ç°ï¼Œæˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œè¯¥ç±»æ—¨åœ¨æä¾›å…±äº«æ‰€æœ‰æƒã€‚ <br><br>  <b>è¿™ä¸ç»å…¸çš„æ³„æ¼æœ‰ä½•ä¸åŒ-é€šè¿‡æ˜¾å¼è°ƒç”¨newè€Œæ— éœ€åç»­åˆ é™¤æ¥åˆ†é…å†…å­˜ï¼Ÿ</b>  <b>ä»¥åŒæ ·çš„æ–¹å¼ï¼Œç•Œé¢å’Œå®ç°ä¸­çš„ä¸€åˆ‡éƒ½ä¼šå˜å¾—å¾ˆæ¼‚äº®-ä¸€ä¸ªé”™è¯¯ã€‚</b> <br> æˆ‘ä»¬æ­£åœ¨è®¨è®ºå°„æ€è‡ªå·±çš„<b>ç°ä»£</b>æ–¹æ³•ã€‚ <br><br><h2> åæ¨¡å¼â€œåƒµå°¸â€ </h2><br> å› æ­¤ï¼Œä»ä»¥ä¸Šææ–™å¯ä»¥æ˜æ˜¾çœ‹å‡ºï¼š <br>  -æ™ºèƒ½æŒ‡é’ˆå¯ä»¥ç»‘å®šåˆ°èŠ‚ç‚¹ä¸­ï¼› <br>  -ä½¿ç”¨std :: enable_shared_from_thiså¯ä»¥å¯¹æ­¤æœ‰æ‰€å¸®åŠ©ï¼Œå› ä¸º å…è®¸ç±»çš„å®ä¾‹åœ¨å‡ ä¹æ²¡æœ‰å¤–éƒ¨å¸®åŠ©çš„æƒ…å†µä¸‹ç»‘å®šåˆ°èŠ‚ç‚¹ã€‚ <br><br>  <b>ç°åœ¨-æ³¨æ„-æœ¬æ–‡çš„å…³é”®é—®é¢˜ï¼šæ™ºèƒ½æŒ‡é’ˆä¸­åŒ…è£…çš„èµ„æºç±»å‹é‡è¦å—ï¼Ÿ</b>  <b>RAIIæ–‡ä»¶ç®¡ç†å’Œå¼‚æ­¥HTTPSè¿æ¥ä¹‹é—´æœ‰åŒºåˆ«å—ï¼Ÿ</b> <br><br><h3> ç®€å•åƒµå°¸ </h3><br> æ‰€æœ‰åç»­åƒµå°¸ç¤ºä¾‹çš„é€šç”¨ä»£ç å·²ç§»è‡³é€šç”¨åº“ã€‚ <br><br> å…·æœ‰é€‚ä¸­åç§°Managerçš„æŠ½è±¡åƒµå°¸ç•Œé¢ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">æ™®é€š/ Manager.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;memory&gt; namespace Common { class Listener; class Manager { public: Manager() = default; Manager(const Manager&amp;) = delete; Manager(Manager&amp;&amp;) = delete; Manager&amp; operator=(const Manager&amp;) = delete; Manager&amp; operator=(Manager&amp;&amp;) = delete; virtual ~Manager() = default; virtual void runOnce(std::shared_ptr&lt;Common::Listener&gt; listener) = 0; }; } // namespace Common</span></span></span></span></code> </pre><br></div></div><br> ä¾¦å¬å™¨çš„æŠ½è±¡æ¥å£ï¼Œå‡†å¤‡æ¥å—çº¿ç¨‹å®‰å…¨çš„æ–‡æœ¬ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">æ™®é€š/ Listener.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;string&gt; #include &lt;memory&gt; namespace Common { class Listener { public: virtual ~Listener() = default; using Data = std::string; // thread-safe virtual void processData(const std::shared_ptr&lt;const Data&gt; data) = 0; }; } // namespace Common</span></span></span></span></code> </pre><br></div></div><br> å‘æ§åˆ¶å°æ˜¾ç¤ºæ–‡æœ¬çš„ä¾¦å¬å™¨ã€‚ ä»æˆ‘çš„æ–‡ç« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æŠ€å·§ä¸­</a>å®ç°SingletonSharedæ¦‚å¿µï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»¥é¿å…è°ƒç”¨Singletonæ—¶å‡ºç°æœªå®šä¹‰çš„è¡Œä¸º</a> ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">é€šç”¨/Impl/WriteToConsoleListener.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;mutex&gt; #include "Common/Listener.h" namespace Common { class WriteToConsoleListener final : public Listener { public: WriteToConsoleListener(const WriteToConsoleListener&amp;) = delete; WriteToConsoleListener(WriteToConsoleListener&amp;&amp;) = delete; WriteToConsoleListener&amp; operator=(const WriteToConsoleListener&amp;) = delete; WriteToConsoleListener&amp; operator=(WriteToConsoleListener&amp;&amp;) = delete; ~WriteToConsoleListener() override; static std::shared_ptr&lt;WriteToConsoleListener&gt; instance(); // blocking void processData(const std::shared_ptr&lt;const Data&gt; data) override; private: WriteToConsoleListener(); std::mutex _mutex; }; } // namespace Common</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">é€šç”¨/Impl/WriteToConsoleListener.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include "WriteToConsoleListener.h" namespace Common { WriteToConsoleListener::WriteToConsoleListener() = default; WriteToConsoleListener::~WriteToConsoleListener() { auto lock = std::lock_guard(_mutex); std::cout &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; } std::shared_ptr&lt;WriteToConsoleListener&gt; WriteToConsoleListener::instance() { static auto inst = std::shared_ptr&lt;WriteToConsoleListener&gt;(new WriteToConsoleListener); return inst; } void WriteToConsoleListener::processData(const std::shared_ptr&lt;const Data&gt; data) { if (data) { auto lock = std::lock_guard(_mutex); std::cout &lt;&lt; *data &lt;&lt; std::flush; } } } // namespace Common</span></span></span></span></code> </pre><br></div></div><br> æœ€åï¼Œç¬¬ä¸€ä¸ªåƒµå°¸ï¼Œæœ€ç®€å•ä¹Ÿæœ€å·§å¦™ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">ç®€å•çš„åƒµå°¸</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;memory&gt; #include &lt;atomic&gt; #include &lt;thread&gt; #include "Common/Manager.h" namespace Common { class Listener; } // namespace Common namespace SimpleZomby { class Zomby final : public Common::Manager, public std::enable_shared_from_this&lt;Zomby&gt; { public: static std::shared_ptr&lt;Zomby&gt; create(); ~Zomby() override; void runOnce(std::shared_ptr&lt;Common::Listener&gt; listener) override; private: Zomby(); using Semaphore = std::atomic&lt;bool&gt;; std::shared_ptr&lt;Common::Listener&gt; _listener; Semaphore _semaphore = false; std::thread _thread; }; } // namespace SimpleZomby</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">SimpleZomby.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sstream&gt; #include "SimpleZomby.h" #include "Common/Listener.h" namespace SimpleZomby { std::shared_ptr&lt;Zomby&gt; Zomby::create() { return std::shared_ptr&lt;Zomby&gt;(new Zomby()); } Zomby::Zomby() = default; Zomby::~Zomby() { _semaphore = false; if (_thread.joinable()) { _thread.detach(); } if (_listener) { std::ostringstream buf; buf &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; _listener-&gt;processData(std::make_shared&lt;Common::Listener::Data&gt;(buf.str())); } } void Zomby::runOnce(std::shared_ptr&lt;Common::Listener&gt; listener) { if (_semaphore) { throw std::runtime_error("SimpleZomby::Zomby::runOnce() called twice"); } _listener = listener; _semaphore = true; _thread = std::thread([shis = shared_from_this()](){ while (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) { shis-&gt;_listener-&gt;processData(std::make_shared&lt;Common::Listener::Data&gt;("SimpleZomby is alive!\n")); std::this_thread::sleep_for(std::chrono::seconds(1)); } }); } } // namespace SimpleZomby</span></span></span></span></code> </pre><br></div></div><br> åƒµå°¸åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œlambdaå‡½æ•°ï¼Œå¹¶å®šæœŸå°†å­—ç¬¦ä¸²å‘é€ç»™ä¾¦å¬å™¨ã€‚ ç”¨äºå·¥ä½œçš„Lambdaå‡½æ•°éœ€è¦ä¿¡å·é‡å’Œä¾¦å¬å™¨ï¼Œå®ƒä»¬æ˜¯åƒµå°¸ç±»çš„å­—æ®µã€‚  lambdaå‡½æ•°ä¸ä¼šå°†å®ƒä»¬æ•è·ä¸ºå•ç‹¬çš„å­—æ®µï¼Œè€Œæ˜¯å°†å¯¹è±¡ç”¨ä½œèšåˆå™¨ã€‚ åœ¨lambdaå‡½æ•°å®Œæˆä¹‹å‰é”€æ¯åƒµå°¸ç±»çš„å®ä¾‹å°†å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚ ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œlambdaå‡½æ•°æ•è·äº†shared_from_thisï¼ˆï¼‰çš„å¼ºå‰¯æœ¬ã€‚ <br> åœ¨åƒµå°¸ææ„å‡½æ•°ä¸­ï¼Œå°†ä¿¡å·é‡è®¾ç½®ä¸ºfalseï¼Œç„¶åä¸ºæµè°ƒç”¨detachï¼ˆï¼‰ã€‚ è®¾ç½®ä¿¡å·é‡å‘Šè¯‰çº¿ç¨‹å…³é—­ã€‚ <br><br>  <b>åœ¨ææ„å‡½æ•°ä¸­ï¼Œæœ‰å¿…è¦ä¸è°ƒç”¨detachï¼ˆï¼‰ï¼Œè€Œæ˜¯è°ƒç”¨joinï¼ˆï¼‰ï¼</b> <br>  ...å¹¶è·å¾—ä¸€ä¸ªæ— é™æœŸé˜»æ­¢æ‰§è¡Œçš„ææ„å‡½æ•°ï¼Œè¿™å¯èƒ½æ˜¯ä¸å¯æ¥å—çš„ã€‚ <br><br>  <b>å› æ­¤ï¼Œè¿™è¿åäº†RAIIï¼</b>  <b>RAIIåº”è¯¥åªåœ¨é‡Šæ”¾èµ„æºåæ‰é€€å‡ºææ„å‡½æ•°ï¼</b> <br> å¦‚æœä¸¥æ ¼-å¦‚æœæ˜¯ï¼Œåˆ™åƒµå°¸ææ„å‡½æ•°ä¸ä¼šé‡Šæ”¾èµ„æºï¼Œè€Œä»…<b>ä¿è¯å°†è¿›è¡Œé‡Šæ”¾</b> ã€‚ æœ‰æ—¶ä¼šäº§ç”Ÿ-å¯èƒ½å¾ˆå¿«ï¼Œæˆ–è€…å¯èƒ½ä¸æ˜¯çœŸçš„ã€‚ ç”šè‡³mainå¯èƒ½æ›´æ—©å®Œæˆå·¥ä½œ-ç„¶åæ“ä½œç³»ç»Ÿå°†å¼ºåˆ¶æ¸…é™¤çº¿ç¨‹ã€‚ ä½†æ˜¯å®é™…ä¸Šï¼Œâ€œæ­£ç¡®â€å’Œâ€œé”™è¯¯â€çš„RAIIä¹‹é—´çš„ç•Œé™å¯èƒ½å¾ˆç»†ï¼šä¾‹å¦‚ï¼Œâ€œæ­£ç¡®â€çš„RAIIåœ¨ä¸´æ—¶æ–‡ä»¶çš„ææ„å‡½æ•°ä¸­è°ƒç”¨std :: filesystem :: removeï¼ˆï¼‰æ­¤æ—¶ï¼Œå†™å…¥å‘½ä»¤ä»å°†ä½äºä»»ä½•æ˜“å¤±æ€§é«˜é€Ÿç¼“å­˜ä¸­å¹¶ä¸”ä¸ä¼šè¢«è¯šå®åœ°å†™å…¥ç¡¬ç›˜çš„ç£æ¿ä¸­ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">main.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;chrono&gt; #include &lt;thread&gt; #include &lt;sstream&gt; #include "Common/Impl/WriteToConsoleListener.h" #include "SimpleZomby/SimpleZomby.h" int main() { auto writeToConsoleListener = Common::WriteToConsoleListener::instance(); { auto simpleZomby = SimpleZomby::Zomby::create(); simpleZomby-&gt;runOnce(writeToConsoleListener); std::this_thread::sleep_for(std::chrono::milliseconds(4500)); } // Zomby should be killed here { std::ostringstream buf; buf &lt;&lt; "============================================================\n" &lt;&lt; "| Zomby was killed |\n" &lt;&lt; "============================================================\n"; if (writeToConsoleListener) { writeToConsoleListener-&gt;processData(std::make_shared&lt;Common::Listener::Data&gt;(buf.str())); } } std::this_thread::sleep_for(std::chrono::milliseconds(5000)); return 0; }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">æ§åˆ¶å°è¾“å‡º</b> <div class="spoiler_text"><blockquote>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  ==================================================== =========== <br>  | åƒµå°¸è¢«æ€| <br>  ==================================================== =========== <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br>  SimpleZombyè¿˜æ´»ç€ï¼ <br></blockquote><br></div></div><br> ä»ç¨‹åºè¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°ï¼š <br>  -åƒµå°¸å³ä½¿ç¦»å¼€äº†è§†é‡ä»ç»§ç»­å·¥ä½œï¼› <br>  -æ²¡æœ‰ä¸ºåƒµå°¸æˆ–WriteToConsoleListenerè°ƒç”¨ææ„å‡½æ•°ã€‚ <br> å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚ <br> èµ„æºæ³„æ¼ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œèµ„æºå°±æ˜¯æ‰§è¡Œçº¿ç¨‹ã€‚ <br> æœ¬åº”åœæ­¢çš„ä»£ç ç»§ç»­åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­å·¥ä½œã€‚ <br> é€šè¿‡ä½¿ç”¨æˆ‘çš„æ–‡ç« ã€Š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é¿å…åœ¨è°ƒç”¨Singletonæ—¶å‘ç”Ÿä¸ç¡®å®šçš„è¡Œä¸ºã€‹ä¸­</a>çš„SingletonWeakæŠ€æœ¯ï¼Œå¯ä»¥é˜²æ­¢WriteToConsoleListeneræ³„æ¼ï¼Œä½†æˆ‘æ•…æ„æ²¡æœ‰è¿™æ ·åšã€‚ <br><br><img src="https://habrastorage.org/webt/mg/qu/e3/mgque3fstboi4ot2hvdwniafixe.jpeg"><br>  ï¼ˆå›¾ç‰‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¥è‡ªè¿™é‡Œ</a> ï¼‰ <br><br>  <b>ä¸ºä»€ä¹ˆæ˜¯åƒµå°¸ï¼Ÿ</b> <br> å› ä¸ºä»–è¢«æ€äº†ï¼Œä»–è¿˜æ´»ç€ã€‚ <br><br>  <b>è¿™ä¸å‰é¢çš„ç¤ºä¾‹ä¸­çš„å¾ªç¯å¼•ç”¨æœ‰ä½•ä¸åŒï¼Ÿ</b> <br> ä¸¢å¤±çš„èµ„æºä¸ä»…æ˜¯ä¸€å—å†…å­˜ï¼Œè€Œä¸”è¿˜å¯ä»¥ç‹¬ç«‹äºå¯åŠ¨çº¿ç¨‹çš„çº¿ç¨‹ç‹¬ç«‹åœ°æ‰§è¡Œä»£ç ã€‚ <br><br>  <b>æœ‰å¯èƒ½æ‘§æ¯â€œåƒµå°¸â€å—ï¼Ÿ</b> <br> ç¦»å¼€èŒƒå›´åï¼ˆå³é”€æ¯æ‰€æœ‰å¤–éƒ¨å¯¹åƒµå°¸çš„å¼ºå¼±å¼•ç”¨ï¼‰åï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚ åƒµå°¸åœ¨å†³å®šè‡ªæ€æ—¶ä¼šè¢«æ‘§æ¯ï¼ˆæ˜¯çš„ï¼Œè¿™æ˜¯ä¸€ç§æ´»è·ƒçš„è¡Œä¸ºï¼‰ï¼Œä¹Ÿè®¸æ°¸è¿œä¸ä¼šï¼Œå³ ç›´åˆ°åº”ç”¨ç¨‹åºç»ˆæ­¢æ—¶æ“ä½œç³»ç»Ÿæ¸…é™¤ä¸ºæ­¢ã€‚ å½“ç„¶ï¼Œç”¨æˆ·ä»£ç å¯èƒ½ä¼šå¯¹é€€å‡ºåƒµå°¸ä»£ç çš„æ¡ä»¶äº§ç”Ÿä¸€äº›å½±å“ï¼Œä½†æ˜¯è¿™ç§å½±å“å°†æ˜¯é—´æ¥çš„ï¼Œå¹¶ä¸”å–å†³äºå®ç°ã€‚ <br><br>  <b>å¹¶ä¸”åœ¨ç¦»å¼€èŒƒå›´ä¹‹å‰ï¼Ÿ</b> <br> æ‚¨å¯ä»¥æ˜¾å¼è°ƒç”¨åƒµå°¸ææ„å‡½æ•°ï¼Œä½†æ˜¯ç”±äºæ™ºèƒ½æŒ‡é’ˆææ„å‡½æ•°ä¹Ÿåå¤ç ´åå¯¹è±¡ï¼Œå› æ­¤ä¸å¤ªå¯èƒ½é¿å…æœªå®šä¹‰çš„è¡Œä¸º-è¿™æ˜¯ä¸RAIIçš„æ–—äº‰ã€‚ æˆ–è€…ï¼Œæ‚¨å¯ä»¥æ·»åŠ æ˜¾å¼å–æ¶ˆåˆå§‹åŒ–çš„åŠŸèƒ½-è¿™æ˜¯å¯¹RAIIçš„æ‹’ç»ã€‚ <br><br>  <b>è¿™ä¸ä»…åœ¨å¯åŠ¨çº¿ç¨‹åå†æ‰§è¡Œdetachï¼ˆï¼‰æœ‰ä½•ä¸åŒï¼Ÿ</b> <br> åœ¨åƒµå°¸çš„æƒ…å†µä¸‹ï¼Œä¸ç®€å•åœ°è°ƒç”¨detachï¼ˆï¼‰ç›¸æ¯”ï¼Œæœ‰ä¸€ç§æƒ³æ³•å¯ä»¥é˜»æ­¢æµé‡ã€‚ åªæœ‰å®ƒä¸èµ·ä½œç”¨ã€‚ æ‹¥æœ‰æ­£ç¡®çš„æƒ³æ³•æœ‰åŠ©äºæ©ç›–é—®é¢˜ã€‚ <br><br>  <b>è¿™ä¸ªä¾‹å­ä»ç„¶æ˜¯åˆæˆçš„å—ï¼Ÿ</b> <br> éƒ¨åˆ†ã€‚ åœ¨è¿™ä¸ªç®€å•çš„ç¤ºä¾‹ä¸­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„ç†ç”±ä½¿ç”¨shared_from_thisï¼ˆï¼‰-ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ•è·weak_from_thisï¼ˆï¼‰æˆ–æ•è·ç±»ä¸­çš„æ‰€æœ‰å¿…éœ€å­—æ®µæ¥è¿›è¡Œæ“ä½œã€‚ ä½†æ˜¯éšç€ä»»åŠ¡çš„å¤æ‚æ€§ï¼Œå¹³è¡¡å¯èƒ½ä¼šè½¬ç§»åˆ°ä¸€è¾¹ <br>  shared_from_thisï¼ˆï¼‰ã€‚ <br><br>  <b>Valgrindï¼ŒValgrindï¼</b>  <b>æˆ‘ä»¬è¿˜æœ‰é’ˆå¯¹åƒµå°¸çš„å¦ä¸€é“é˜²çº¿ï¼</b> <br>  lasï¼Œå—¯-ä½†æ˜¯Valgrindæ²¡æœ‰é€éœ²å†…å­˜æ³„æ¼ã€‚ ä¸ºä»€ä¹ˆ-æˆ‘ä¸çŸ¥é“ã€‚ åœ¨è¯Šæ–­ä¸­ï¼Œåªæœ‰<b>â€œå¯èƒ½ä¸¢å¤±â€çš„</b>æ¡ç›®è¡¨ç¤ºç³»ç»ŸåŠŸèƒ½-ä¸è®¡ç®—ç©ºçš„ä¸»ç”µæºæ—¶å¤§çº¦ç›¸åŒå’Œå¤§çº¦ç›¸åŒçš„æ•°é‡ã€‚ æ²¡æœ‰ç”¨æˆ·ä»£ç å‚è€ƒã€‚ å…¶ä»–åŠ¨æ€åˆ†æå·¥å…·å¯èƒ½ä¼šåšå¾—æ›´å¥½ï¼Œä½†æ˜¯å¦‚æœæ‚¨ä»ç„¶ä¾é å®ƒä»¬ï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚ <br><br><h3> è¸©åƒµå°¸ </h3><br> æ­¤ç¤ºä¾‹ä¸­çš„ä»£ç é€šè¿‡æ­¥éª¤resolveDnsName ---&gt; connectTcp ---&gt; EstablishmentSsl ---&gt; sendHttpRequest ---&gt; readHttpReplyï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ‰§è¡Œä¸­å®¢æˆ·ç«¯HTTPSè¿æ¥çš„æ“ä½œã€‚ æ¯ä¸ªæ­¥éª¤å¤§çº¦éœ€è¦ä¸€ç§’é’Ÿã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">æ­¥è¿›åƒµå°¸</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;memory&gt; #include &lt;atomic&gt; #include &lt;thread&gt; #include "Common/Manager.h" namespace Common { class Listener; } // namespace Common namespace SteppingZomby { class Zomby final : public Common::Manager, public std::enable_shared_from_this&lt;Zomby&gt; { public: static std::shared_ptr&lt;Zomby&gt; create(); ~Zomby() override; void runOnce(std::shared_ptr&lt;Common::Listener&gt; listener) override; private: Zomby(); using Semaphore = std::atomic&lt;bool&gt;; std::shared_ptr&lt;Common::Listener&gt; _listener; Semaphore _semaphore = false; std::thread _thread; void resolveDnsName(); void connectTcp(); void establishSsl(); void sendHttpRequest(); void readHttpReply(); }; } // namespace SteppingZomby</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">æ­¥è¿›åƒµå°¸</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sstream&gt; #include &lt;string&gt; #include "SteppingZomby.h" #include "Common/Listener.h" namespace { void doSomething(Common::Listener&amp; listener, std::string&amp;&amp; callingFunctionName) { listener.processData(std::make_shared&lt;Common::Listener::Data&gt;(callingFunctionName + " started\n")); std::this_thread::sleep_for(std::chrono::milliseconds(1000)); listener.processData(std::make_shared&lt;Common::Listener::Data&gt;(callingFunctionName + " finished\n")); } } // namespace namespace SteppingZomby { Zomby::Zomby() = default; std::shared_ptr&lt;Zomby&gt; Zomby::create() { return std::shared_ptr&lt;Zomby&gt;(new Zomby()); } Zomby::~Zomby() { _semaphore = false; if (_thread.joinable()) { _thread.detach(); } if (_listener) { std::ostringstream buf; buf &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; _listener-&gt;processData(std::make_shared&lt;Common::Listener::Data&gt;(buf.str())); } } void Zomby::runOnce(std::shared_ptr&lt;Common::Listener&gt; listener) { if (_semaphore) { throw std::runtime_error("SteppingZomby::Zomby::runOnce() called twice"); } _listener = listener; _semaphore = true; _thread = std::thread([shis = shared_from_this()](){ if (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) { shis-&gt;resolveDnsName(); } if (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) { shis-&gt;connectTcp(); } if (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) { shis-&gt;establishSsl(); } if (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) { shis-&gt;sendHttpRequest(); } if (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) { shis-&gt;readHttpReply(); } }); } void Zomby::resolveDnsName() { doSomething(*_listener, std::string(typeid(*this).name()) + "::" + __func__); } void Zomby::connectTcp() { doSomething(*_listener, std::string(typeid(*this).name()) + "::" + __func__); } void Zomby::establishSsl() { doSomething(*_listener, std::string(typeid(*this).name()) + "::" + __func__); } void Zomby::sendHttpRequest() { doSomething(*_listener, std::string(typeid(*this).name()) + "::" + __func__); } void Zomby::readHttpReply() { doSomething(*_listener, std::string(typeid(*this).name()) + "::" + __func__); } } // namespace SteppingZomby</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">main.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;chrono&gt; #include &lt;thread&gt; #include &lt;sstream&gt; #include "SteppingZomby/SteppingZomby.h" #include "Common/Impl/WriteToConsoleListener.h" int main() { auto writeToConsoleListener = Common::WriteToConsoleListener::instance(); { auto steppingZomby = SteppingZomby::Zomby::create(); steppingZomby-&gt;runOnce(writeToConsoleListener); std::this_thread::sleep_for(std::chrono::milliseconds(1500)); } // Zombies should be killed here { std::ostringstream buf; buf &lt;&lt; "============================================================\n" &lt;&lt; "| Zomby was killed |\n" &lt;&lt; "============================================================\n"; if (writeToConsoleListener) { writeToConsoleListener-&gt;processData(std::make_shared&lt;Common::Listener::Data&gt;(buf.str())); } } std::this_thread::sleep_for(std::chrono::milliseconds(5000)); return 0; }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">æ§åˆ¶å°è¾“å‡º</b> <div class="spoiler_text"><blockquote>  N13SteppingZomby5ZombyE :: resolveDnsNameå·²å¯åŠ¨ <br>  N13SteppingZomby5ZombyE :: resolveDnsNameå®Œæˆ <br>  N13SteppingZomby5ZombyE :: connectTcpå·²å¯åŠ¨ <br>  ==================================================== =========== <br>  | åƒµå°¸è¢«æ€| <br>  ==================================================== =========== <br>  N13SteppingZomby5ZombyE :: connectTcpå®Œæˆ <br>  N13SteppingZomby5ZombyE ::å»ºç«‹Sslå·²å¯åŠ¨ <br>  N13SteppingZomby5ZombyE ::å»ºç«‹SSLå·²å®Œæˆ <br>  N13SteppingZomby5ZombyE :: sendHttpRequestå·²å¯åŠ¨ <br>  N13SteppingZomby5ZombyE :: sendHttpRequestå®Œæˆ <br>  N13SteppingZomby5ZombyE :: readHttpå›å¤å¼€å§‹ <br>  N13SteppingZomby5ZombyE :: readHttpå›å¤å®Œæˆ <br>  N13SteppingZomby5ZombyE ::ã€œåƒµå°¸ <br>  N6Common22WriteToConsoleListenerE ::ã€œWriteToConsoleListener <br></blockquote><br></div></div><br> ä¸å‰é¢çš„ç¤ºä¾‹ä¸€æ ·ï¼Œå¯¹runOnceï¼ˆï¼‰çš„è°ƒç”¨å¯¼è‡´äº†å¾ªç¯å¼•ç”¨ã€‚ <br> ä½†æ˜¯è¿™ä¸€æ¬¡ï¼Œè°ƒç”¨äº†Zombyå’ŒWriteToConsoleListenerææ„å‡½æ•°ã€‚ æ­£ç¡®é‡Šæ”¾äº†æ‰€æœ‰èµ„æºï¼Œç›´åˆ°åº”ç”¨ç¨‹åºç»ˆæ­¢ã€‚ æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚ <br><br>  <b>é‚£æ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</b> <br> é—®é¢˜åœ¨äºï¼Œåƒµå°¸çš„å¯¿å‘½å¤ªé•¿äº†-åœ¨ä¸åƒµå°¸çš„æ‰€æœ‰å¤–éƒ¨å¼ºå¼±ç¯èŠ‚éƒ½è¢«æ‘§æ¯åå¤§çº¦ä¸‰åˆ†åŠç§’ã€‚ æ¯”ä»–åº”è¯¥æ´»çš„æ—¶é—´é•¿äº†ä¸‰ç§’é’Ÿã€‚ ä¸€ç›´ä»¥æ¥ï¼Œä»–ä¸€ç›´è‡´åŠ›äºä¿ƒè¿›HTTPSè¿æ¥çš„å®ç°-ç›´åˆ°ç»“æŸä¸ºæ­¢ã€‚ å°½ç®¡ä¸å†éœ€è¦ç»“æœã€‚ å°½ç®¡äº‹å®æ˜¯å“è¶Šçš„ä¸šåŠ¡é€»è¾‘è¯•å›¾é˜»æ­¢åƒµå°¸ã€‚ <br><br>  <b>å¥½å§ï¼Œè€ƒè™‘ä¸€ä¸‹ï¼Œæ‚¨ä¼šå¾—åˆ°ä¸éœ€è¦çš„ç­”æ¡ˆ...ã€‚</b> <br> åœ¨å®¢æˆ·ç«¯HTTPSè¿æ¥çš„æƒ…å†µä¸‹ï¼Œ <b>å¯¹æˆ‘ä»¬è¿™æ–¹é¢</b>çš„åæœå¯èƒ½å¦‚ä¸‹ï¼š <br>  -å†…å­˜æ¶ˆè€—ï¼› <br>  -CPUæ¶ˆè€—ï¼› <br>  -TCPç«¯å£æ¶ˆè€—ï¼› <br>  -é€šä¿¡ä¿¡é“çš„å¸¦å®½ï¼ˆè¯·æ±‚å’Œå“åº”éƒ½å¯ä»¥æ˜¯å…†å­—èŠ‚çš„å·ï¼‰ï¼› <br>  -æ„å¤–çš„æ•°æ®å¯èƒ½ä¼šä¸­æ–­é«˜å±‚ä¸šåŠ¡é€»è¾‘çš„æ“ä½œ-ç›´åˆ°è¿‡æ¸¡åˆ°é”™è¯¯çš„æ‰§è¡Œåˆ†æ”¯æˆ–æœªå®šä¹‰çš„è¡Œä¸ºï¼Œå› ä¸º å“åº”å¤„ç†æœºåˆ¶å¯èƒ½å·²ç»è¢«ç ´åã€‚ <br>  <b>åœ¨è¿œç¨‹æ–¹é¢</b> ï¼ˆè¯·ä¸è¦å¿˜è®°-HTTPSè¯·æ±‚æ˜¯é’ˆå¯¹æŸäººçš„ï¼‰-å®Œå…¨ç›¸åŒçš„èµ„æºæµªè´¹ï¼Œæ­¤å¤–è¿˜å¯èƒ½ï¼š <br>  -åœ¨å…¬å¸ç½‘ç«™ä¸Šå‘å¸ƒçŒ«çš„ç…§ç‰‡ï¼› <br>  -ç¦ç”¨å¨æˆ¿çš„åœ°æ¿é‡‡æš–ï¼› <br>  -åœ¨äº¤æ˜“æ‰€æ‰§è¡Œäº¤æ˜“æŒ‡ä»¤ï¼› <br>  -ä»æ‚¨çš„å¸æˆ·è½¬å¸ï¼› <br>  -å‘å°„æ´²é™…å¼¹é“å¯¼å¼¹ã€‚ <br> ä¸šåŠ¡é€»è¾‘è¯•å›¾é€šè¿‡åˆ é™¤æ‰€æœ‰ä¸åƒµå°¸æœ‰å…³çš„å¼ºå¼±é“¾æ¥æ¥é˜»æ­¢åƒµå°¸ã€‚ åº”è¯¥åœæ­¢HTTPSè¯·æ±‚çš„è¿›åº¦-è¿˜ä¸ç®—å¤ªæ™šï¼Œå°šæœªå‘é€åº”ç”¨ç¨‹åºçº§åˆ«çš„æ•°æ®ã€‚ <br> ä½†æ˜¯åƒµå°¸ä»¥è‡ªå·±çš„æ–¹å¼å†³å®šã€‚ <br><br> ä¸šåŠ¡é€»è¾‘å¯ä»¥åˆ›å»ºæ–°å¯¹è±¡æ¥ä»£æ›¿åƒµå°¸ï¼Œç„¶åå†æ¬¡å°è¯•é”€æ¯å®ƒä»¬ï¼Œä»è€Œå¢åŠ èµ„æºæ¶ˆè€—ã€‚ <br> åœ¨è¿ç»­è¿‡ç¨‹ï¼ˆä¾‹å¦‚Websocketè¿æ¥ï¼‰çš„æƒ…å†µä¸‹ï¼Œèµ„æºæµªè´¹å¯èƒ½ä¼šæŒç»­æ•°å°æ—¶ï¼Œå¹¶ä¸”å¦‚æœæ–­å¼€è¿æ¥æ—¶å®ç°ä¸­å­˜åœ¨è‡ªåŠ¨é‡æ–°è¿æ¥æœºåˆ¶ï¼Œé€šå¸¸å¯ä»¥å°†å…¶åœæ­¢ã€‚ <br><br>  <b>ç“¦å°”æ ¼æœ—å¾·ï¼Ÿ</b> <br> æ²¡æœºä¼š ä¸€åˆ‡éƒ½å·²æ­£ç¡®é‡Šæ”¾å¹¶æ¸…ç†ã€‚ å»¶è¿Ÿä¸æ˜¯æ¥è‡ªä¸»çº¿ç¨‹ï¼Œè€Œæ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚ <br><br><h3> å¸ƒå…¹å¾·åƒµå°¸ </h3><br> æœ¬ç¤ºä¾‹ä½¿ç”¨boozd :: azzioåº“ï¼Œå®ƒæ˜¯boost :: asioçš„æ¨¡ä»¿ã€‚ å°½ç®¡æ¨¡ä»¿æ˜¯å¾ˆç²—ç³™çš„ï¼Œä½†å®ƒä½¿æˆ‘ä»¬èƒ½å¤Ÿè¯æ˜é—®é¢˜çš„å®è´¨ã€‚     io_context::async_read (   ,     ), : <br> â€” stream,     ; <br> â€” ,    ; <br> â€” callback-,       . <br>  io_context::async_read       callback,       (, ).        io_context::run() (     ,        ). <br><br><div class="spoiler"> <b class="spoiler_title">buffer.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;vector&gt; namespace boozd::azzio { using buffer = std::vector&lt;int&gt;; } // namespace boozd::azzio</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">stream.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;optional&gt; namespace boozd::azzio { class stream { public: virtual ~stream() = default; virtual std::optional&lt;int&gt; read() = 0; }; } // namespace boozd::azzio</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">io_context.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;functional&gt; #include &lt;optional&gt; #include "buffer.h" namespace boozd::azzio { class stream; class io_context { public: ~io_context(); enum class error_code {no_error, good_error, bad_error, unknown_error, known_error, well_known_error}; using handler = std::function&lt;void(error_code)&gt;; // Start an asynchronous operation to read a certain amount of data from a stream. // This function is used to asynchronously read a certain number of bytes of data from a stream. // The function call always returns immediately. void async_read(stream&amp; s, buffer&amp; b, handler&amp;&amp; handler); // Run the io_context object's event processing loop. void run(); private: using pack = std::tuple&lt;stream&amp;, buffer&amp;&gt;; using pack_optional = std::optional&lt;pack&gt;; using handler_optional = std::optional&lt;handler&gt;; pack_optional _pack_optional; handler_optional _handler_optional; }; } // namespace boozd::azzio</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">io_context.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;thread&gt; #include &lt;chrono&gt; #include "io_context.h" #include "stream.h" namespace boozd::azzio { io_context::~io_context() { std::cout &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; } void io_context::async_read(stream&amp; s, buffer&amp; b, io_context::handler&amp;&amp; handler) { _pack_optional.emplace(s, b); _handler_optional.emplace(std::move(handler)); } void io_context::run() { if (_pack_optional &amp;&amp; _handler_optional) { auto&amp; [s, b] = *_pack_optional; using namespace std::chrono; auto start = steady_clock::now(); while (duration_cast&lt;milliseconds&gt;(steady_clock::now() - start).count() &lt; 1000) { if (auto read = s.read()) b.emplace_back(*read); std::this_thread::sleep_for(milliseconds(100)); } (*_handler_optional)(error_code::no_error); } } } // namespace boozd::azzio</span></span></span></span></code> </pre><br></div></div><br>    boozd::azzio::stream,   : <br><br><div class="spoiler"> <b class="spoiler_title">impl/random_stream.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"boozd/azzio/stream.h"</span></span></span><span class="hljs-meta"> namespace boozd::azzio { class random_stream final : public stream { public: ~random_stream() override; std::optional</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;int&gt; read() override; }; } // namespace boozd::azzio</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">impl/random_stream.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include "random_stream.h" namespace boozd::azzio { boozd::azzio::random_stream::~random_stream() { std::cout &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; } std::optional&lt;int&gt; random_stream::read() { if (!(rand() &amp; 0x1)) return rand(); return std::nullopt; } } // namespace boozd::azzio</span></span></span></span></code> </pre><br></div></div><br> BoozdedZomby     -. -      async_read(),       boozd::azzio   run().     boozd::azzio        ( )      callback-.      ,    , -  shared_from_this. <br><br><div class="spoiler"> <b class="spoiler_title">BoozdedZomby.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;memory&gt; #include &lt;atomic&gt; #include &lt;thread&gt; #include "Common/Manager.h" #include "boozd/azzio/buffer.h" #include "boozd/azzio/io_context.h" #include "boozd/azzio/impl/random_stream.h" namespace Common { class Listener; } // namespace Common namespace BoozdedZomby { class Zomby final : public Common::Manager, public std::enable_shared_from_this&lt;Zomby&gt; { public: static std::shared_ptr&lt;Zomby&gt; create(); ~Zomby() override; void runOnce(std::shared_ptr&lt;Common::Listener&gt; listener) override; private: Zomby(); using Semaphore = std::atomic&lt;bool&gt;; Semaphore _semaphore = false; std::shared_ptr&lt;Common::Listener&gt; _listener; boozd::azzio::random_stream _stream; boozd::azzio::buffer _buffer; boozd::azzio::io_context _context; std::thread _thread; }; } // namespace BoozdedZomby</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">BoozdedZomby.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;sstream&gt; #include "boozd/azzio/impl/random_stream.h" #include "BoozdedZomby.h" #include "Common/Listener.h" namespace BoozdedZomby { Zomby::Zomby() = default; std::shared_ptr&lt;Zomby&gt; Zomby::create() { return std::shared_ptr&lt;Zomby&gt;(new Zomby()); } Zomby::~Zomby() { _semaphore = false; if (_thread.joinable()) { _thread.detach(); } if (_listener) { std::ostringstream buf; buf &lt;&lt; typeid(*this).name() &lt;&lt; "::" &lt;&lt; __func__ &lt;&lt; std::endl; _listener-&gt;processData(std::make_shared&lt;Common::Listener::Data&gt;(buf.str())); } } void Zomby::runOnce(std::shared_ptr&lt;Common::Listener&gt; listener) { if (_semaphore) { throw std::runtime_error("BoozdedZomby::Zomby::runOnce() called twice"); } _listener = listener; _semaphore = true; _thread = std::thread([shis = shared_from_this()]() { while (shis &amp;&amp; shis-&gt;_semaphore &amp;&amp; shis-&gt;_listener) { auto handler = [shis](auto errorCode) { if (shis &amp;&amp; shis-&gt;_listener &amp;&amp; errorCode == boozd::azzio::io_context::error_code::no_error) { std::ostringstream buf; buf &lt;&lt; "BoozdedZomby has got a fresh data: "; for (auto const &amp;elem : shis-&gt;_buffer) buf &lt;&lt; elem &lt;&lt; ' '; buf &lt;&lt; std::endl; shis-&gt;_listener-&gt;processData(std::make_shared&lt;Common::Listener::Data&gt;(buf.str())); } }; shis-&gt;_buffer.clear(); shis-&gt;_context.async_read(shis-&gt;_stream, shis-&gt;_buffer, handler); shis-&gt;_context.run(); } }); } } // namespace BoozdedZomby</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">main.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;chrono&gt; #include &lt;thread&gt; #include &lt;sstream&gt; #include "BoozdedZomby/BoozdedZomby.h" #include "Common/Impl/WriteToConsoleListener.h" int main() { auto writeToConsoleListener = Common::WriteToConsoleListener::instance(); { auto boozdedZomby = BoozdedZomby::Zomby::create(); boozdedZomby-&gt;runOnce(writeToConsoleListener); std::this_thread::sleep_for(std::chrono::milliseconds(4500)); } // Zombies should be killed here { std::ostringstream buf; buf &lt;&lt; "============================================================\n" &lt;&lt; "| Zomby was killed |\n" &lt;&lt; "============================================================\n"; if (writeToConsoleListener) { writeToConsoleListener-&gt;processData(std::make_shared&lt;Common::Listener::Data&gt;(buf.str())); } } std::this_thread::sleep_for(std::chrono::milliseconds(5000)); return 0; }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><blockquote> BoozdedZomby has got a fresh data: 1144108930 101027544 1458777923 1115438165 74243042 <br> BoozdedZomby has got a fresh data: 143542612 1131570933 <br> BoozdedZomby has got a fresh data: 893351816 563613512 704877633 <br> BoozdedZomby has got a fresh data: 1551901393 1399125485 1899894091 937186357 590357944 357571490 <br> ============================================================ <br>  | Zomby was killed | <br> ============================================================ <br> BoozdedZomby has got a fresh data: 1927702196 130060903 1083454666 2118797801 2035308228 824938981 <br> BoozdedZomby has got a fresh data: 2020739063 1635339425 34075629 <br> BoozdedZomby has got a fresh data: 2146319451 500782188 1269406752 884936716 892053144 <br> BoozdedZomby has got a fresh data: 330111137 1723153177 1070477904 <br> BoozdedZomby has got a fresh data: 343098142 280090412 589673557 889688008 2014119113 388471006 <br></blockquote><br></div></div><br>    run_once()   .         .       ,     : <br> â€” boozdedZomby; <br> â€” writeToConsoleListener; <br> â€”   . <br>   . <br>   . <br><br> <b>     ?</b> <br>      .      .          boost::asio.  ,              â€”        ( ). <br><br> <b>Valgrind?</b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿‡å» </font><font style="vertical-align: inherit;">å°½ç®¡ä¼¼ä¹ä¸€ç›´åœ¨æ£€æµ‹æ³„æ¼ã€‚</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é‡å¤–çš„åƒµå°¸ </font></font></h2><br> <b> !    !</b> <br>   . <br> <a href="https://www.boost.org/doc/libs/master/libs/beast/example/http/client/async/"> HTTP-</a> <br> <a href=""> Websocket-</a> <br>    boost ,    BoozdedZomby + SteppingZomby.   ,     .         ,      production â€”       ,      . <br><br> <b>  ,   boost::asio::io_context!</b> <br> â€¦    n  (, -),    . <br><br>  : <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">     </a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">    stackoverflow ,        </a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   ,      </a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">         </a> <br><br><h2> ç»“è®º </h2><br> ,        Â«Â». <br><br>         ,       . <br><br>        std::thread    â€”          . <br><br>      ,   . <br><br>     event-driven,        (polling-based). <br><br>     . <br><br> ,  <b></b>           .       std::enable_shared_from_this,       (       â€”       ). ,        :            -    . <br><br>           ,    SteppingZomby.       â€”          shared_from_this (  ,   ,       â€”   1  6  ). <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è‡ªåŠ¨æµ‹è¯•å¯ä»¥å¸®åŠ©æ‚¨è¯†åˆ«å¹¶æ£€æŸ¥æ¶ˆé™¤æ–¹æ³•çš„æ­£ç¡®æ€§-ä½†æ˜¯ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦çŸ¥é“è¦æŸ¥æ‰¾çš„å†…å®¹ã€‚</font><font style="vertical-align: inherit;">ç»å¯¹çŸ¥é“ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ— è®ºä½•æ—¶ä½•åœ°ï¼Œéƒ½å¿…é¡»æ‰‹åŠ¨æœç´¢åæ¨¡å¼ã€‚</font><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦é‡æ–°è€ƒè™‘std :: enable_shared_from_thisçš„æ‰€æœ‰åº”ç”¨ç¨‹åº-å®ƒä»¬</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éå¸¸</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å±é™©ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PSï¼šæ ¹æ®æŠ•ç¥¨ç»“æœ-æˆ‘å°†å‡†å¤‡å¦ä¸€ç¯‡æ–‡ç« ï¼Œè®¨è®ºæ¶ˆé™¤åæ¨¡å¼çš„é€‰é¡¹ã€‚</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN471326/">https://habr.com/ru/post/zh-CN471326/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN471310/index.html">æˆ‘å¯¹ä¸“ä¸šçš„çœ‹æ³•éå¸¸ä¸»è§‚ï¼Œè€Œä¸ä»…ä»…æ˜¯ITæ•™è‚²</a></li>
<li><a href="../zh-CN471312/index.html">å‡†å¤‡æ˜¥å­£ä¸“ä¸šè®¤è¯ã€‚ æ˜¥å­£é´</a></li>
<li><a href="../zh-CN471318/index.html">ä¹æœˆæœºå™¨å­¦ä¹ å’Œäººå·¥æ™ºèƒ½æ–°é—»æ‘˜è¦</a></li>
<li><a href="../zh-CN471320/index.html">é€‚ç”¨äºè½¯ä»¶å¼€å‘äººå‘˜çš„å·¥å…·ï¼šå¼€æ”¾æ¡†æ¶å’Œæœºå™¨å­¦ä¹ åº“</a></li>
<li><a href="../zh-CN471324/index.html">ç¥ç»ç½‘ç»œæ˜¯å¦æ¢¦æƒ³ç€è’™å¨œä¸½èï¼Ÿ</a></li>
<li><a href="../zh-CN471330/index.html">æœˆçƒè®¡ç®—æœºçš„æ•…äº‹ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN471332/index.html">æœˆçƒè®¡ç®—æœºçš„æ•…äº‹ã€‚ ç¬¬ä¸‰éƒ¨åˆ†</a></li>
<li><a href="../zh-CN471334/index.html">è®°ä½è€Œä¸æ˜¯è¡¥ä¹ -é€šè¿‡å¡ç‰‡å­¦ä¹ </a></li>
<li><a href="../zh-CN471336/index.html">éœåˆ©ç“¦å°” å•å†…ç‰¹çš„å†å²ã€‚ ç¬¬6éƒ¨åˆ†ã€‚é”ï¼šæ½œä¼ï¼Œç£å¸¦ï¼Œ282ndå’Œä¸­æ–‡è·¯å¾„</a></li>
<li><a href="../zh-CN471340/index.html">Drimsim vs Mate 20ä¸“ä¸šèµ›ï¼ ä½†æ˜¯å¯¹äºè°å‘¢ï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>