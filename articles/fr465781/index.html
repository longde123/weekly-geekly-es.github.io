<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕦 🎻 👩🏻‍🤝‍👨🏿 Comment j'ai fait un disjoncteur Okhttp personnalisé à travers les coroutines de Kotlin ❇️ 👇🏻 👨🏿‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Commençons par l'énoncé du problème. 



1. Il est nécessaire d'envoyer le jeton et l'ID utilisateur dans chaque demande dans l'en-tête 
2. Il est néc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai fait un disjoncteur Okhttp personnalisé à travers les coroutines de Kotlin</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465781/">  Commençons par l'énoncé du problème. <br><br><ol><li>  Il est nécessaire d'envoyer le jeton et l'ID utilisateur dans chaque demande dans l'en-tête </li><li>  Il est nécessaire de tirer de chaque réponse un nouveau jeton et un nouvel identifiant d'utilisateur à partir des en-têtes </li><li>  Les données reçues doivent être enregistrées. </li></ol><br>  La bibliothèque pour l'interaction avec le serveur est Retrofit.  Les coroutines sont responsables du multithreading. <br>  La tâche n'est pas difficile, il vous suffit d'ajouter le disjoncteur client Okhttp à chaque requête.  Une demi-heure et tout est prêt, tout fonctionne, tout le monde est content.  Mais je me demandais, est-il possible de faire un disjoncteur sans client Okhttp? <br><a name="habracut"></a><br>  Commençons par résoudre les problèmes dans l'ordre.  S'il n'y a pas de problème avec l'ajout d'en-tête (il vous suffit d'ajouter @HeaderMap dans la demande), alors comment obtenir les en-têtes qui viennent dans la réponse?  Très simple, nous devons encapsuler notre réponse dans la classe Response, qui a une méthode headers (). <br><br>  Voici l'interface de requête: <br><br><pre><code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"someurl/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Field(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"idLast"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idLastFeed: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Field(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"autoview"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> autoView: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@HeaderMap</span></span></span></span><span class="hljs-function"><span class="hljs-params"> headers: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String?&gt;)</span></span></span></span>: Answer1 <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"someurl/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Field(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"ransom"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ransom: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@HeaderMap</span></span></span></span><span class="hljs-function"><span class="hljs-params"> headers: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String?&gt;)</span></span></span></span>: Answer2</code> </pre> <br>  Mais cela est devenu: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"someurl"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Field(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"idLast"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idLastFeed: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Field(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"autoview"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> autoView: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@HeaderMap</span></span></span></span><span class="hljs-function"><span class="hljs-params"> headers: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String?&gt;?)</span></span></span></span>: Response&lt;Answer1&gt; <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"someurl"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Field(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"ransom"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ransom: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@HeaderMap</span></span></span></span><span class="hljs-function"><span class="hljs-params"> headers: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String?&gt;?)</span></span></span></span>: Response&lt;Answer2&gt;</code> </pre><br>  Maintenant, pour chaque demande, vous devez ajouter le paramètre headersMap.  Créons une classe RestClient distincte pour le shell de requête afin que le jeton et l'ID ne soient pas extraits constamment de sharedPreferences dans le présentateur.  Voici comment cela se révèle: <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RestClient</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> api: Api, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> prefs: SharedPreferences) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(last: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, autoView: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Answer1 { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.request1(last, autoView, headers()) } <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Answer2 { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.request2(id, headers()) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> TOKEN_KEY = <span class="hljs-string"><span class="hljs-string">"Token"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> ID_KEY = <span class="hljs-string"><span class="hljs-string">"ID"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">headers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Map&lt;String, String&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapOf( TOKEN_KEY to prefs.getString(Constants.Preferences.SP_TOKEN_KEY, <span class="hljs-string"><span class="hljs-string">""</span></span>), ID_KEY to prefs.getLong(Constants.Preferences.SP_ID, -<span class="hljs-number"><span class="hljs-number">1</span></span>).toString() ) } }</code> </pre> <br>  On voit que nous faisons la même chose: <br><br><ol><li>  Nous obtenons quelques paramètres pour la demande. </li><li>  Ajoutez des en-têtes à la demande. </li><li>  Appelez la méthode. </li><li>  Nous obtenons de nouvelles valeurs des en-têtes. </li><li>  Nous retournons le résultat. </li></ol><br>  Pourquoi ne faisons-nous pas une seule fonction pour toutes les demandes?  Pour ce faire, modifiez les requêtes.  Au lieu de variables individuelles de type @Field, nous allons maintenant utiliser @FieldMap.  Ce sera le premier paramètre de notre fonction - le percher.  Le deuxième paramètre que nous aurons est la requête elle-même.  Ici, j'ai utilisé Kotlin DSL (je voulais vraiment).  J'ai créé la classe Request dans laquelle j'ai créé la fonction send pour appeler la requête. <br><br>  Voici à quoi ressemble l'interface de requête: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"someurl/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">feedListMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@FieldMap</span></span></span></span><span class="hljs-function"><span class="hljs-params"> map: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HashMap</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Any&gt;?, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@HeaderMap</span></span></span></span><span class="hljs-function"><span class="hljs-params"> headers: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String?&gt;?)</span></span></span></span>: Response&lt;Answer1&gt; <span class="hljs-meta"><span class="hljs-meta">@FormUrlEncoded</span></span> <span class="hljs-meta"><span class="hljs-meta">@POST(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"someurl/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">feedListMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@FieldMap</span></span></span></span><span class="hljs-function"><span class="hljs-params"> map: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HashMap</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Any&gt;?, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@HeaderMap</span></span></span></span><span class="hljs-function"><span class="hljs-params"> headers: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String?&gt;?)</span></span></span></span>: Response&lt;Answer2&gt;</code> </pre><br>  Et voici la classe Request: <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Request</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldHashMap: java.util.HashMap&lt;String, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Any&gt; = hashMapOf(), <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> headersHashMap: Map&lt;String, String?&gt;? = mapOf(), <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> req: <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> (HashMap&lt;String, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Any&gt;?, Map&lt;String, String?&gt;?) -&gt; Response&lt;T&gt;? = { _,_ -&gt; <span class="hljs-literal"><span class="hljs-literal">null</span></span>} ){ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Response&lt;T&gt;? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> runBlocking { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { req.invoke(fieldHashMap, headersHashMap) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Exception(e.message ?: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (t: Throwable) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Exception(t.message ?: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } } } }</code> </pre> <br>  Maintenant, la classe RestClient ressemble à ceci: <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RestClient</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> api: Api, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> prefs: SharedPreferences) { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> TOKEN_KEY = <span class="hljs-string"><span class="hljs-string">"Token"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> ID_KEY = <span class="hljs-string"><span class="hljs-string">"ID"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">headers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Map&lt;String, String&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapOf( TOKEN_KEY to prefs.getString(Constants.Preferences.SP_TOKEN_KEY, <span class="hljs-string"><span class="hljs-string">""</span></span>), ID_KEY to prefs.getLong(Constants.Preferences.SP_ID, -<span class="hljs-number"><span class="hljs-number">1</span></span>).toString() ) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Request</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;.()</span></span></span></span> -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span>): T? { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> req = Request&lt;T&gt;() request(req) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = req.send() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newToken = res?.headers()?.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(TOKEN_KEY) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newID = res?.headers()?.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(ID_KEY)?.toLong() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newToken.notNull() &amp;&amp; newID.notNull()) { prefs.edit() .putString(TOKEN_KEY, newToken) .putLong(ID_KEY, newID) .apply() } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res?.body() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fiedsMapForRequest1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(last: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, autoView: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = hashMapOf(<span class="hljs-string"><span class="hljs-string">"idLast"</span></span> to last, <span class="hljs-string"><span class="hljs-string">"autoview"</span></span> to autoView) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fiedsMapForRequest2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ransom: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, autoView: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = hashMapOf(<span class="hljs-string"><span class="hljs-string">"ransom"</span></span> to ransom) }</code> </pre> <br>  Et enfin, voici comment nous appelons nos demandes dans le présentateur: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> answer1 = restClient.buildRequest&lt;Answer1&gt; { fieldHashMap = restClient.fiedsMapForRequest1(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) headersHashMap = restClient.headers() req = api::request1 } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> answer2 = restClient.buildRequest&lt;Answer2&gt; { fieldHashMap = restClient.fiedsMapForRequest2(<span class="hljs-number"><span class="hljs-number">1234</span></span>) headersHashMap = restClient.headers() req = api::request2 } <span class="hljs-comment"><span class="hljs-comment">// do something with answer } catch (e: Exception) { viewState.showError(e.message.toString()) } finally { viewState.hideProgress() }</span></span></code> </pre><br>  Ici, j'ai fait un disjoncteur personnalisé avec l'aide de Kotlin. <br><br>  PS La solution à ce problème était très excitante, mais, malheureusement, le projet utilise un disjoncteur Okhttp. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465781/">https://habr.com/ru/post/fr465781/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465765/index.html">Le condensé de matériaux intéressants pour le développeur mobile # 313 (26 août - 1er septembre)</a></li>
<li><a href="../fr465767/index.html">Expérience personnelle et conclusions après avoir changé de profession de concepteur à programmeur</a></li>
<li><a href="../fr465773/index.html">Mise à jour d'un ordinateur portable avec Windows 10 1903 - de la brique à la perte de toutes les données. Pourquoi une mise à jour peut-elle être plus qu'un utilisateur?</a></li>
<li><a href="../fr465775/index.html">Serveur LTSP basé sur CentOS7</a></li>
<li><a href="../fr465779/index.html">Provisionnement automatique Yealink T19 + Carnet d'adresses dynamique</a></li>
<li><a href="../fr465783/index.html">Jeu russe dev, vide de sens et impitoyable</a></li>
<li><a href="../fr465787/index.html">Aime la chèvre</a></li>
<li><a href="../fr465789/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 29. PAT et NAT</a></li>
<li><a href="../fr465791/index.html">Vulnérabilités des détaillants - trois cas où OTP a pu être obtenu dans la demande</a></li>
<li><a href="../fr465793/index.html">Frontend Weekly Digest (26 août - 1er septembre 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>