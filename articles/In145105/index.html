<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯСЛЁЯП╝ ЁЯТЕЁЯП╜ ЁЯзСЁЯП╜ рдирд┐рд╡реЗрджрди рд╕реАрдорд╛ - рд░реЗрдЯрд▓рд╛рдорд┐рдЯрд░ ЁЯУЛ тЩВя╕П ЁЯд│ЁЯП╛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдпрджрд┐ рдЖрдк рдбрд░рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА рд╡реЗрдм рд╕реЗрд╡рд╛ рдХреЛ рд▓рд╛рдкрд░рд╡рд╛рд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рд░реЛрдХрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдмрд╕ рдПрдХ рдХрдордЬреЛрд░ рд╕рд░реНрд╡рд░ рд╣реИ, рддреЛ рдЖрдкрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдкреНрд░рддреНрдпреЗрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдирд┐рд╡реЗрджрди рд╕реАрдорд╛ - рд░реЗрдЯрд▓рд╛рдорд┐рдЯрд░</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body" data-io-article-url="https://habr.com/ru/post/145105/">  рдпрджрд┐ рдЖрдк рдбрд░рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА рд╡реЗрдм рд╕реЗрд╡рд╛ рдХреЛ рд▓рд╛рдкрд░рд╡рд╛рд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рд░реЛрдХрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдмрд╕ рдПрдХ рдХрдордЬреЛрд░ рд╕рд░реНрд╡рд░ рд╣реИ, рддреЛ рдЖрдкрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдкреНрд░рддреНрдпреЗрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реЛрдЪрд╛ рд╣реИред  рдПрдХ рдЕрдЪреНрдЫреЗ рддрд░реАрдХреЗ рд╕реЗ - рдпрд╣ рдХреЗрд╡рд▓ рдПрдХ рдЖрд╡рд╢реНрдпрдХ рд░рдХреНрд╖рд╛ рдХреНрд╖реЗрддреНрд░ рд╣реИред  рдмреЗрд╢рдХ, рдЗрд╕ рддрд░рд╣ рдХреА рд╕реАрдорд╛ рдЧрдВрднреАрд░ рд╣рдорд▓реЗ рд╕реЗ рдирд╣реАрдВ рдмрдЪрд╛рдПрдЧреА, рд▓реЗрдХрд┐рди рдХреАрдордд / рдЧреБрдгрд╡рддреНрддрд╛ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ рдпрд╣ рдХрд╛рдлреА рдЙрдкрдпреБрдХреНрдд рд╣реИ <br><br>  рд╣рд╛рд▓ рд╣реА рдореЗрдВ, рдореИрдВрдиреЗ рдПрд░реНрд▓рд╛рдВрдЧ рдореЗрдВ рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рдЬреБрдбрд╝рдирд╛ рд╢реБрд░реВ рдХрд┐рдпрд╛ред  рдЦреИрд░, рд╣рдореЗрд╢рд╛ рдХреА рддрд░рд╣, рд╕рд╛рдордЧреНрд░реА рдХреЛ рдордЬрдмреВрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ <a href="https://github.com/mochi/mochiweb">рдореЛрдЪреАрд╡реЗрдм</a> рдкрд░ рдПрдХ рд╕рд╛рдзрд╛рд░рдг рд╡реЗрдм рд╕реЗрд╡рд╛ рд▓рд╛рдЧреВ рдХреАред  рдореЛрдЪреАрд╡реЗрдм рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╣реБрдд рд╣реА рд╕рднреНрдп рдврд╛рдВрдЪрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдореБрдЭреЗ рдПрдХ рдЧреНрд░рд╛рд╣рдХ рд╕реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдирд╣реАрдВ рдорд┐рд▓реАред  рддреЛ рдореИрдВрдиреЗ рдЦреБрдж рдХрд┐рдпрд╛ред <br><br>  рдХреНрдпреЛрдВрдХрд┐  рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рдХреНрд╡реЗрд░реА рдХреА рдЧрддрд┐ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрд▓рдЧ рд╣реИ рдФрд░ рдХрд┐рд╕реА рднреА рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдп рд╕реЗ рдмрдВрдзреА рдирд╣реАрдВ рд╣реИ, рдореИрдВрдиреЗ рдПрдХ рд╕реНрд╡рддрдВрддреНрд░ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдореЗрдВ рдмрдирд╛рдП рдЧрдП рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЪрдпрди рдХрд┐рдпрд╛ рдФрд░ рдЗрд╕рдХреЗ рд╕реНрд░реЛрдд рдХреЛрдб рдХреЛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ред <br><br><h5>  рдХрд╛рд░реНрдп </h5><br>  рддреЛ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ <a href="http://www.erlang.org/">Erlang / OTP</a> , Mochiweb, <a href="https://github.com/basho/rebar">rebar рд╣реИ</a> ред  рдореИрдВ рдХрд┐рд╕реА рд╡рд┐рд╢реЗрд╖ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдкрдврд╝рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ рдФрд░ рдпрджрд┐ рдЕрдиреБрд░реЛрдз рдмрд╣реБрдд рдмрд╛рд░ рдЬрд╛рддреЗ рд╣реИрдВ рддреЛ рдЙрд╕реЗ 413 рддреНрд░реБрдЯрд┐ рдХреЛрдб рджреЗрддреЗ рд╣реИрдВред  рдЧреНрд░рд╛рд╣рдХ рдХреА рдкрд╣рдЪрд╛рди рдЙрд╕рдХреЗ рдЖрдИрдкреА рдкрддреЗ рд╕реЗ рдХреА рдЬрд╛рддреА рд╣реИред  рд╡рд╣ рдЬреЛ <code><b>mochiweb_request:get(peer).</b></code> рджреЗрддрд╛ рд╣реИ <code><b>mochiweb_request:get(peer).</b></code> <br><br>  рдХрд╛рд░реНрдп рдЗрддрдирд╛ рдореБрд╢реНрдХрд┐рд▓ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рд╢рд╛рдпрдж рдПрдХ рдЯрд░реНрдирдХреА рд╕рдорд╛рдзрд╛рди рдХрд┐рд╕реА рдХреЗ рд╕рдордп рдХреЛ рдмрдЪрд╛рдПрдЧрд╛ред <br><a name="habracut"></a><br><h5>  рджреГрд╖реНрдЯрд┐рдХреЛрдг </h5><br>  рдореИрдВрдиреЗ <a href="http://en.wikipedia.org/wiki/Token_bucket">рдЯреЛрдХрди рдмрд╛рд▓реНрдЯреА</a> рдПрд▓реНрдЧреЛрд░рд┐рдереНрдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ред <br>  рдпрджрд┐ рд╣рдо рдЗрд╕рдХрд╛ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рд╡рд░реНрдгрди рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдкреНрд░рддреНрдпреЗрдХ рдЧреНрд░рд╛рд╣рдХ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рдордп рдЕрдВрддрд░рд╛рд▓реЛрдВ рдХреЛ рдЯреЛрдХрд░рд┐рдпрд╛рдБ рдорд╛рдирддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рд╣рдо рдЗрд╕ рд╕рдордп рдЕрдВрддрд░рд╛рд▓ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрд░реЛрдз рдЬреЛрдбрд╝реЗрдВрдЧреЗред  рдЯреЛрдХрд░реА рдореЗрдВ рдПрдХ рд╕реАрдорд┐рдд рдорд╛рддреНрд░рд╛ рд╣реЛрддреА рд╣реИред  рдЬреИрд╕реЗ рд╣реА рдЯреЛрдХрд░реА рдХреЛ рд╕реАрдорд╛ рддрдХ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд╕рд╛рде рднрд░рд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╣рдо рдЧреНрд░рд╛рд╣рдХ рдХреЛ рд╕реЗрд╡рд╛ рджреЗрдирд╛ рдмрдВрдж рдХрд░ рджреЗрддреЗ рд╣реИрдВред  рдХреНрдпреЛрдВрдХрд┐  рд╕рдордп рдЖрдЧреЗ рдмрдврд╝рддрд╛ рд╣реИ, рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд▓рд┐рдП рдмрд╛рд╕реНрдХреЗрдЯ рд▓рдЧрд╛рддрд╛рд░ рдмрджрд▓ рд░рд╣реЗ рд╣реИрдВ, рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рдкрд╛рд╕ рдирдП рд╕рдордп рдЕрдВрддрд░рд╛рд▓ рдкрд░ рд╕реЗрд╡рд╛ рдХрд░рдиреЗ рдХрд╛ рдореМрдХрд╛ рд╣реИред <br><br><img src="https://habrastorage.org/storage2/ddb/356/519/ddb356519393b8a96f9352ad4a2d4c32.png"><br>  рдКрдкрд░ рдХреА рддрд╕реНрд╡реАрд░ рдореЗрдВ, рд▓рд╛рд▓ рдЙрд╕ рд╕рдордп рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрдм рдкреНрд░рддреНрдпреЗрдХ рдЧреНрд░рд╛рд╣рдХ рд╕реЗрд╡рд┐рдд рдирд╣реАрдВ рдерд╛ред <br>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдЪрд┐рддреНрд░ рд╕реЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдХреНрд▓рд╛рдЗрдВрдЯ рдП рдХреЛ рдХреБрдЫ рд╕рдордп рдкрд╣рд▓реЗ рдПрдХ рдЕрдиреБрд░реЛрдз рдкреНрд░рддрд┐рдмрдВрдз рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдЕрдм рдФрд░ рдирд╣реАрдВ рднреЗрдЬрд╛ рдЧрдпрд╛, рдХреНрд▓рд╛рдЗрдВрдЯ рдмреА рдЪреБрдкрдЪрд╛рдк рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕реАрдорд╛ рд╕реЗ рдЕрдзрд┐рдХ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдмреА рдиреЗ рдлрд┐рд▓рд╣рд╛рд▓ рдЕрдиреБрд░реЛрдз рд╕реАрдорд╛ рдХрд╛ рдЪрдпрди рдХрд┐рдпрд╛ рд╣реИ рдФрд░ рд░рд┐рдлреНрдпреВрдЬрд╝рд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рд╣реИред <br><br>  рд╣рдо рдЧреНрд░рд╛рд╣рдХ рд╕реЗ рдЕрдиреБрд░реЛрдз рдХреЗ рд░реВрдк рдореЗрдВ рдЯреЛрдХрд░рд┐рдпрд╛рдБ рдмрдирд╛рдПрдВрдЧреЗ, рдФрд░ рд╕рдордп рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦреЗрдВрдЧреЗред  рдкреНрд░рддреНрдпреЗрдХ рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдЕрдкрдирд╛ рд╕рдордп рдкреИрдорд╛рдирд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЯреЛрдХрд░реА рдХреЛ рдЬреАрд╡рди рднрд░ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред  рдЯреЛрдХрд░реА рдХреА рдорд╛рддреНрд░рд╛, рдЕрд░реНрдерд╛рддреН рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕реАрдорд╛, рдкреНрд░рддреНрдпреЗрдХ рдЧреНрд░рд╛рд╣рдХ рдХреЗ рд▓рд┐рдП рдЕрд▓рдЧ рд╕реЗ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред <br><br>  рд╣рдо рдбрд┐рдХреНрд╢рдирд░реА рдореЗрдВ рдЧреНрд░рд╛рд╣рдХ рдмрд╛рд╕реНрдХреЗрдЯ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд╕реНрдЯреЛрд░ рдХрд░реЗрдВрдЧреЗ: <br>  рдХреБрдВрдЬреА рдХреЗ рд░реВрдк рдореЗрдВ <code><b>IP + тДЦ </b></code> <br>  <code><b>counter</b></code> - рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдЕрдиреБрд░реЛрдз рдХрд╛рдЙрдВрдЯрд░ <br><br>  рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд▓рд┐рдП API рдореЗрдВ рдПрдХ рдлрд╝рдВрдХреНрд╢рди <code>check_rate(IP, TimeScale, Limit)</code> ред <br>  рдЬрд╣рд╛рдБ <br>  <code><b>IP</b></code> рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдЖрдИрдкреА рдкрддрд╛ рд╣реИ (рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдХрд┐рд╕реА рднреА рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдХрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ) <br>  <code><b>TimeScale</b></code> - рдЯреЛрдХрд░реА рдЬреАрд╡рдирдХрд╛рд▓ рдПрдордПрд╕ рдореЗрдВред <br>  <code><b>Limit</b></code> - рдЯреЛрдХрд░реА рдореЗрдВ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдЕрдзрд┐рдХрддрдо рд╕рдВрдЦреНрдпрд╛ <br><br>  рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рд╕реЗ рдХрд╛рдЙрдВрдЯрд░ рдмрдврд╝ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рд╡рд╛рдкрд╕ рдЖрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдЕрдиреБрд░реЛрдз рд╕реЗрд╡рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред <br><br><h5>  рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди </h5><br>  рдбреЗрдЯрд╛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВ <code>ordered_set</code> рдХрд╛ ETS рдЯреЗрдмрд▓ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░рддрд╛ <code>ordered_set</code> ред  рдпрд╣ рдХреБрдВрдЬреА рджреНрд╡рд╛рд░рд╛ рд╕реЙрд░реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдХреБрдВрдЬреА рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИред  рддрд╛рд▓рд┐рдХрд╛ рдПрдХ рд░рд┐рдХреЙрд░реНрдб рд╣реИ <br><pre> <code class="erlang hljs">[BucketID, Counter, CreatedAt, ModifiedAt]</code> </pre><br>  рдЬрд╣рд╛рдБ <br>  <code><b>BucketID</b></code> - {IP, BucketNum}, рдСрд░реНрдбрд░_рд╕реЗрдЯ рдХреА рдХреБрдВрдЬреА рднреА рд╣реИ <br>  <code><b>Counter</b></code> - рдЧреНрд░рд╛рд╣рдХ рд╕реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ <br>  <code><b>CreatedAt</b></code> - рдЯреЛрдХрд░реА рдмрдирд╛рдиреЗ рдХрд╛ рд╕рдордп (ms рдореЗрдВ) <br>  <code><b>ModifiedAt</b></code> - рдЧрд╛рдбрд╝реА рдмрджрд▓рдиреЗ рдХрд╛ рд╕рдордп (рдПрдордПрд╕ рдореЗрдВ) <br>  рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрдорд╛рдг рдХрд╛ рд╕рдордп рдЕрдзрд┐рдХ рд╣реИ, рдЖрдк рдЗрд╕реЗ рдордирд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ <br><br>  рдореБрдЦреНрдп рд╕рдорд╛рд░реЛрд╣: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-spec</span></span> count_hit<span class="hljs-params"><span class="hljs-params">(Id::binary(), Scale::integer(), Limit::integer())</span></span> -&gt; {ok, continue} | {fail, Count::integer<span class="hljs-params"><span class="hljs-params">()</span></span>}. <span class="hljs-comment"><span class="hljs-comment">%% Counts request by ID and blocks it if rate limiter fires %% ID of the client %% Scale of time (1000 = new bucket every second, 60000 = bucket every minute) %% Limit - max size of bucket count_hit(Id, Scale, Limit) -&gt; Stamp = timestamp(), %% milliseconds since 00:00 GMT, January 1, 1970 BucketNumber = trunc(Stamp / Scale), %% with scale=1 bucket changes every millisecond Key = {BucketNumber, Id}, case ets:member(?RATERLIMITER_TABLE, Key) of false -&gt; ets:insert(?RATERLIMITER_TABLE, {Key, 1, Stamp, Stamp }), {ok, continue}; true -&gt; % increment counter by 1, created_time by 0, and changed_time by current one Counters = ets:update_counter(?RATERLIMITER_TABLE, Key, [{2,1},{3,0},{4,1,0, Stamp}]), % Counter, created at, changed at [BucketSize, _, _] = Counters, if (BucketSize &gt; Limit) -&gt; {fail, Limit}; true -&gt; {ok, continue} end end.</span></span></code> </pre><br><br>  рдкрд╣рд▓реЗ, рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЯреЛрдХрд░реА {рдЖрдИрдкреА, рдмрдХреЗрдЯрдирдВрдмрд░} рд╣реИред <br>  рдПрдХ рдирдИ рдЯреЛрдХрд░реА рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╕рдм рдХреБрдЫ рдмрд╣реБрдд рд╕реБрдВрджрд░ рд╣реИ - рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдорд╛рдиреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдирдИ рдЯреЛрдХрд░реА рдмрдирд╛рдПрдВ рдФрд░ рдареАрдХ рдХрд╣реЗрдВред <br><br>  рдореМрдЬреВрджрд╛ рдЯреЛрдХрд░реА рдореЗрдВ рдПрдХ рдХрд╛рдЙрдВрдЯрд░ рдЬреЛрдбрд╝рдирд╛ рдереЛрдбрд╝рд╛ рдЕрдзрд┐рдХ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИред  <a href="http://www.erlang.org/doc/man/ets.html">рдИрдЯреАрдПрд╕</a> рдореЙрдбреНрдпреВрд▓ <a href="http://www.erlang.org/doc/man/ets.html">рдЖрдкрдХреЛ</a> рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд┐рдпрдореЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ <a href="http://www.erlang.org/doc/man/ets.html">рдХрд╛рдЙрдВрдЯрд░реЛрдВ</a> рдХреЛ <a href="http://www.erlang.org/doc/man/ets.html">рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА</a> рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рдореБрдЭреЗ рдпрд╣ рдкрд╕рдВрдж рдЖрдпрд╛ рдХрд┐ рдЕрдВрддрд┐рдо рдХреЙрд▓ рдХреА рддрд╛рд░реАрдЦ рдореЗрдВ рдмрджрд▓рд╛рд╡ рдХреЗ рд╕рд╛рде рдЖрдк рдХрд╛рдЙрдВрдЯрд░ рдХреЗ рд╡реЗрддрди рд╡реГрджреНрдзрд┐ рдХреЛ рдХреИрд╕реЗ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред <br><br>  рддреЛ рдХреЛрдб: <br><pre> <code class="erlang hljs"> Counters = ets:update_counter(?RATERLIMITER_TABLE, Key, [{<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>},{<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>},{<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, Stamp}])</code> </pre><br><br>  рдЗрдВрдХреНрд░реАрдореЗрдВрдЯ рдХрд╛рдЙрдВрдЯрд░ рдирдВрдмрд░ 2 рдмрд╛рдп 1 (рдпрд╣ рд╕рд┐рд░реНрдл рд╣рд┐рдЯ рдХрд╛рдЙрдВрдЯрд░ рд╣реИ), рд╕реГрдЬрди рдХреЗ рд╕рдордп рдореЗрдВ 0 рдЬреЛрдбрд╝реЗрдВ, рдЕрдзрд┐рдХрддрдо рдореВрд▓реНрдп рдХреА рдЬрд╛рдВрдЪ рдХреЗ рд╕рд╛рде 1 рд╕реЗ рдХрд╛рдЙрдВрдЯрд░ рдирдВрдмрд░ 4 рдореЗрдВ рдЬреЛрдбрд╝реЗрдВред  рдХреНрдпреЛрдВрдХрд┐  рдЕрдзрд┐рдХрддрдо рдорд╛рди 0 рд╣реИ, рдЪреМрдерд╛ рдХрд╛рдЙрдВрдЯрд░ рд╣рдореЗрд╢рд╛ рд╕реНрдЯреИрдореНрдк (рд╡рд░реНрддрдорд╛рди рд╕рдордп) рдкрд░ рд╕реЗрдЯ рд╣реИред  рдЖрдЙрдЯрдкреБрдЯ рдкрд░, рд╣рдореЗрдВ рдХреНрд░рдо рдореЗрдВ рд╕рднреА рдкрд░рд┐рд╡рд░реНрддрдиреАрдп рдХрд╛рдЙрдВрдЯрд░реЛрдВ рдХреА рдПрдХ рд╕реВрдЪреА рдорд┐рд▓рддреА рд╣реИ, рдЕрд░реНрдерд╛рддред <br><br> <code>[Counter, CreatedTime, ChangedTime]</code> <br> <br>  рдирддреАрдЬрддрди, рдЯреЗрдмрд▓ рдкрд░ рджреЛ рдХреЙрд▓ рдХреЗ рд▓рд┐рдП, рд╣рдордиреЗ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдпрд╛ рдПрдХ рдЯреЛрдХрд░реА рдмрдирд╛рдИ рдФрд░ рдЖрдЙрдЯрдкреБрдЯ рдкрд░ рдХреЙрд▓ рдХреА рд╕рдВрдЦреНрдпрд╛ рдкреНрд░рд╛рдкреНрдд рдХреАред  рд╡рд░реНрддрдорд╛рди <i>raterlimiter</i> рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ <i>,</i> рдмрджрд▓рддреЗ рддрд╛рд▓рд┐рдХрд╛рдУрдВ рдХреА <i>рдкрд░рдорд╛рдгреБрддрд╛</i> рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд╣реАрдВ рд╣реИ, рдпрд╣ рдХреЗрд╡рд▓ рд╕рд┐рдВрдХреНрд░реЛрдирд╕ (рдХреЙрд▓рд┐рдВрдЧ <a href="http://www.erlang.org/doc/man/gen_server.html">gen_server: call / 2</a> рд╕рд┐рдВрдХреНрд░реЛрдирд╕ рд╣реИ)ред <br><br><h6>  рдкреБрд░рд╛рдиреЗ рдХреВрдбрд╝реЗрджрд╛рди рдХреЛ рд╣рдЯрд╛рдирд╛ </h6><br>  рд╕рдордп рдХреЗ рд╕рд╛рде, рдЧреНрд░рд╛рд╣рдХ рд╕рднреА рдвреЗрд░ рдХреЛ рдвреЗрд░ рдХрд░ рджреЗрддреЗ рд╣реИрдВ рдФрд░ рдвреЗрд░ рдХрд░ рджреЗрддреЗ рд╣реИрдВред  рдЗрдиреНрд╣реЗрдВ рд╣рдЯрд╛рдирд╛ рдЬрд░реВрд░реА рд╣реИред <br><br>  рдирд┐рдХрд╛рд▓рдирд╛ рд╕рдордп-рд╕рдордп рдкрд░ рд╣реЛрддрд╛ рд╣реИред  рдмрд╕, рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕реАрдорд╛ рд╕реЗ рдЕрдзрд┐рдХ рдкреБрд░рд╛рдиреЗ рд╕рднреА рдмрд╛рд╕реНрдХреЗрдЯ рд╣рдЯрд╛ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред <br><br>  рдореБрдЭреЗ рдХрд╣рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдПрд░реНрд▓реИрдВрдЧ рдкрд░ рд╕рдм рдХреБрдЫ рд╕реБрдВрджрд░ рдФрд░ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд▓рдЧрддрд╛ рд╣реИ - <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove_old_limiters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Timeout)</span></span></span><span class="hljs-function"> -&gt;</span></span> NowStamp = timestamp(), Matcher = ets:fun2ms(<span class="hljs-keyword"><span class="hljs-keyword">fun</span></span> ({_,_,_,Accessed}) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> Accessed &lt; (NowStamp - Timeout) -&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>), ets:select_delete(?RATERLIMITER_TABLE, Matcher).</code> </pre><br><br>  <a href="http://www.erlang.org/doc/man/ets.html">ets: select_delete</a> рдореИрдЪ рдлрд╝рдВрдХреНрд╢рди ( <b>MatchSpec</b> ) рд╕реЗ рдореЗрд▓ рдЦрд╛рддреЗ рд╕рднреА рд░рд┐рдХреЙрд░реНрдб <a href="http://www.erlang.org/doc/man/ets.html">рдорд┐рдЯрд╛</a> рджреЗрддрд╛ рд╣реИред  рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдЗрди match_spec рдХреЛ рд▓рд┐рдЦрдирд╛ рдирд░рдХ рд╣реИред  <i>рдИрдЯреНрд╕</i> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдмрд╣реБрдд рдЖрд╕рд╛рди рд╣реИ <i>: fun2ms рдлрд╝рдВрдХреНрд╢рди</i> , рдЬреЛ рдирд┐рдпрдорд┐рдд <i>рдПрд░реНрд▓реИрдВрдЧ</i> рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдкрддреНрд░рд╛рдЪрд╛рд░ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рддрд╛ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЙрдкрд░реЛрдХреНрдд рдлрд╝рдВрдХреНрд╢рди <br><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({_,_,_,Accessed})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">when</span></span></span><span class="hljs-function"> A</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ccessed</span></span></span><span class="hljs-function"> &lt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NowStamp - Timeout)</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  рдореИрдЪрд╕реНрдЯреЗрдХ рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдЕрдВрддрд┐рдо рд░реВрдк рдореЗрдВ, NowStamp = 1000 рдХреЗ рд▓рд┐рдП, рдЯрд╛рдЗрдордЖрдЙрдЯ = 0 рджрд┐рдЦрддрд╛ рд╣реИ <br><br><pre> <code class="erlang hljs">[{{'_','_','_','$<span class="hljs-number"><span class="hljs-number">1</span></span>'},[{'&lt;','$<span class="hljs-number"><span class="hljs-number">1</span></span>',{'-',<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>}}],[true]}]</code> </pre><br><br>  <i>рдИрдЯ рдХрд╛</i> рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдореБрдЦреНрдп <i>рдмрд╛рдд: fun2ms</i> рд╕реНрд░реЛрдд рдореЗрдВ рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдирд╛ рдирд╣реАрдВ рднреВрд▓рдирд╛ рд╣реИ - <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-include_lib</span></span><span class="hljs-params"><span class="hljs-params">(</span><span class="hljs-string"><span class="hljs-params"><span class="hljs-string">"stdlib/include/ms_transform.hrl"</span></span></span><span class="hljs-params">)</span></span>.</code> </pre><br><br><h5>  рдХреЗ рдЙрдкрдпреЛрдЧ </h5><br>  рдЪреЗрдХ_рдЯреНрд░реЗрдб рдкрд░ рдПрдХ рдХреЙрд▓ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрдо рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рдЧрд┐рдирддреА рдирд╣реАрдВ, рдЬрд╝рд╛рд╣рд┐рд░ рд╣реИ, рдХреЛрдб рдФрд░ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рд░реИрдЯреНрд▓рд┐рдорд┐рдЯрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред  рдпрд╣рд╛рдБ рдореЗрд░реЗ Mochiweb рдЖрдзрд╛рд░рд┐рдд рдЕрдиреБрдкреНрд░рдпреЛрдЧ рд╕реЗ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ: <br><br><pre> <code class="erlang hljs"> {Status, _Reason} = raterlimiter:check_rate(Req:get(peer), <span class="hljs-number"><span class="hljs-number">30000</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>), <span class="hljs-comment"><span class="hljs-comment">% 500 requests per 30 seconds allowed case Status of ok -&gt; serve_request(Req, DocRoot, Path); _ -&gt; % client wants too much information Req:respond({413,[{"Content-Type", "text/html"}, {"Retry-After", "900 (Too many requests)"}], "  IP   ,  15 ."}) end</span></span></code> </pre><br><br>  рдкреВрд░рд╛ рдХреЛрдб <a href="https://github.com/Gromina/raterlimiter">рдЬреАрдердм</a> рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИред  рд╡рд╣рд╛рдВ рдЖрдк рддреНрд░реБрдЯрд┐рдпрд╛рдВ рд░рд┐рдкреЛрд░реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╛ рдкреБрд▓ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/In145105/">https://habr.com/ru/post/In145105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../In145099/index.html">рд╣рдо рджрд╛рдВрдд рдкрд░ рд╕реНрдорд╛рд░реНрдЯ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ</a></li>
<li><a href="../In145100/index.html">рдУрдкрдирд╕реНрдЯреИрдХ рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╛рд╡рдирд╛рдПрдБ: рд░реЗрдб рд╣реИрдЯ рдмрдирд╛рдо рд╡реАрдПрдорд╡реЗрдпрд░</a></li>
<li><a href="../In145101/index.html">WebGL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рд╣рдЬрд╛рд░реЛрдВ 3D рдореЙрдбрд▓ рдХреА рдХреИрдЯрд▓реЙрдЧ</a></li>
<li><a href="../In145102/index.html">рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреЗ рд▓рд┐рдП рдЙрдкрдХрд░рдг рдмрджрд▓рддреЗ рд╣реИрдВ рдпрд╛ рдкрд╕рдВрдж рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреНрдпрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ?</a></li>
<li><a href="../In145103/index.html">рдирдП OS рдХрд╛ рд╡рд┐рдореЛрдЪрди - рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдФрд░ рдкрд░реАрдХреНрд╖рд╛рдУрдВ рдХрд╛ рд╡рд┐рдореЛрдЪрди</a></li>
<li><a href="../In145108/index.html">рдЙрджреНрджреЗрд╢реНрдп-рд╕реА рдкрд░ рдПрдХ рдФрд░ ActiveRecord рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди</a></li>
<li><a href="../In145109/index.html">рдЕрдЧрд▓реА рдкреАрдврд╝реА рдХреЗ Xbox рдФрд░ PS рдЕрднреА рднреА рдСрдкреНрдЯрд┐рдХрд▓ рдбреНрд░рд╛рдЗрд╡ рд╕реЗ рд▓реИрд╕ рд╣реЛрдВрдЧреЗ</a></li>
<li><a href="../In145111/index.html">ASUS рдиреЗ рдХреНрд░реЛрдореЛрдмреВрдХ рдХреЗ рд╕рд╛рде рдкрдХрдбрд╝ рдмрдирд╛рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛</a></li>
<li><a href="../In145112/index.html">рдлрд┐рд░ рд╕реЗрд▓реЗрдХреНрдЯ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рджреБрд░реНрдШрдЯрдирд╛ ... рдХрдм рддрдХ?</a></li>
<li><a href="../In145113/index.html">Hexy - Arduino- рдЖрдзрд╛рд░рд┐рдд рд╡рд┐рдзрд╛рдирд╕рднрд╛ рд░реЛрдмреЛрдЯ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>