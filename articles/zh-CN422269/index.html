<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💐 👎 ♏️ 该书“内部设备Windows。 第七版 🏯 ❄️ 👨🏾‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="自从本书的上一版本发布以来，Windows操作系统在升级和概念更改方面已经走了很长一段路要走，这导致了Windows 10内核的新稳定体系结构。 

 《 Windows Internal Device》一书是为希望了解Windows 10主要组件的内部生命的专业人员而创建的。基于此信息，开发人员可...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>该书“内部设备Windows。 第七版</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/422269/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/ix/go/ll/ixgoll7aod0uukzjw8m6z-twzia.jpeg" align="left" alt="图片"></a> 自从本书的上一版本发布以来，Windows操作系统在升级和概念更改方面已经走了很长一段路要走，这导致了Windows 10内核的新稳定体系结构。 <br><br>  《 Windows Internal Device》一书是为希望了解Windows 10主要组件的内部生命的专业人员而创建的。基于此信息，开发人员可以通过为Windows平台创建应用程序并解决与其操作相关的复杂问题，更容易找到正确的设计解决方案。 系统管理员只要知道操作系统底层的内容，便能够了解系统的行为，并迅速解决提高生产率和诊断故障的问题。 安全专业人员将需要有关处理操作系统漏洞的信息。 <br><a name="habracut"></a><br><h3> 页面列表动态 </h3><br> 在图。 图5.37显示了页块转换的状态图。 为简单起见，它不提供已修改但不可记录的页面的列表。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kw/bm/e1/kwbme1fxcts748rfmjivumfbfqs.png" alt="图片"></div><br> 页面块以下列方式在页面列表之间移动。 <br><br>  1.当内存管理器需要用零填充的页面来处理与重置页面的要求有关的页面错误（访问定义为完全用零填充的页面，或者访问尚未确认的已关闭的确认用户模式页面）时，首先尝试从此类页面列表中获取此页面。 如果列表为空，则该页面将从可用页面列表中获取并填充零。 如果空闲页面列表为空，则访问等待页面列表，并且该列表中的页面用零填充。 <br><br>  2.要求填充零的页面的原因之一是要满足各种安全要求，例如，通用标准（Common Criteria）。 一般标准的大多数规定表明，用户模式进程应接收置零的页块，以便它们无法读取以前进程的内存内容。 因此，除非已从备份存储中读取页面，否则内存管理器为用户模式进程提供无效的页面块。 在这种情况下，内存管理器将使用非重置页块，并使用磁盘或远程存储中的数据对其进行初始化。 填充零的页面列表将从空闲页面列表中补充一个称为零页面线程的系统程序线程-这是系统进程中的线程0。 页面清零流正在等待网关对象发出的信号。 当空闲列表中有八个或更多页面时，网关将发出蜂鸣声。 但是只有在至少一个处理器没有其他可执行线程的情况下才启动页面清零线程，因为页面清零线程以优先级0开始，并且可以为用户流设置的最低优先级为1。 <br><blockquote> 注意当由于调用MmAllocatePagesForMdl或MmAllocatePagesForMdlEx函数的驱动程序分配物理页面而导致的内存必须由Windows应用程序调用AllocateUserPhysicalPages或AllocateUserPhysicalPagesNuma函数填充零时，或者当应用程序分配使用内存管理器来使用内存功能的大页面时，内存为空与页面清零流相比，显示的区域更大，一次仅重置一页。 此外，在多处理器系统上，内存管理器会创建一个额外的系统线程，以在并行模式下进行调零（在NUMA平台上，这是针对NUMA技术优化的样式来完成的）。 </blockquote><br>  3.当内存管理器不需要用零填充的页面时，他首先访问空闲页面列表。 如果该列表为空，则转到归零页面列表。 如果清零页面列表为空，则转到待处理页面列表。 在内存管理器可以使用等待页面列表中的页面块之前，他必须首先返回并从仍然指向该页面块的无效PTE记录（或原型PTE记录）中删除该链接。 由于PFN编号数据库条目包含指向用户页面表的上一页（或指向共享页面的原型PTE条目池页面）的后向指针，因此内存管理器可以快速找到PTE条目并进行相应的更改。 <br><br>  4.当某个进程必须从其工作集中放弃某个页面时（要么是因为它引用了一个新页面并且其工作集已满，要么是因为内存管理器削减了它的工作集），如果该页面保持不变，则会进入等待列表（未更改），或者如果已在物理内存中更改了页面，则转到已更改页面的列表。 <br><br>  5.该过程完成后，所有关闭的页面都将进入空闲页面列表。 此外，如果在关闭指向页面文件支持的部分的最后一个链接时，该部分没有任何显示的视图，则该部分的页面也将落入空闲页面列表中。 <br><br><h3> 实验：查看免费页面和零页面 </h3><br> 可以在Process Explorer的System Information窗口中查看流程结束时关闭页面的释放。 首先，您需要创建一个在其工作集中包含许多关闭页面的流程。 我们已经在前面的一个实验中使用TestLimit实用程序进行了此操作： <br><br><pre><code class="hljs vbscript">C:\Tools\Sysinternals&gt;Testlimit.exe -d <span class="hljs-number"><span class="hljs-number">1</span></span> -c <span class="hljs-number"><span class="hljs-number">1500</span></span> Testlimit v5<span class="hljs-number"><span class="hljs-number">.24</span></span> - test Windows limits Copyright (C) <span class="hljs-number"><span class="hljs-number">2012</span></span><span class="hljs-number"><span class="hljs-number">-2015</span></span> Mark Russinovich Sysinternals - www.sysinternals.com Process ID: <span class="hljs-number"><span class="hljs-number">13928</span></span> Leaking <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> touch <span class="hljs-number"><span class="hljs-number">1</span></span> MB at a <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>... Leaked <span class="hljs-number"><span class="hljs-number">1500</span></span> MB of <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> memory (<span class="hljs-number"><span class="hljs-number">1500</span></span> MB total leaked). Lasterror: <span class="hljs-number"><span class="hljs-number">0</span></span> The operation completed successfully.</code> </pre> <br>  –d开关使TestLimit不仅选择已关闭并确认的内存，还“触摸”它，即访问该内存。 这将导致分配物理内存并将其分配给进程，以释放已关闭的已确认虚拟内存的区域。 如果系统有足够的可用RAM，那么将为RAM中的进程分配最多1,500 MB。 现在，此过程将一直等到您强迫它完成或中断工作（可能使用其命令窗口中的组合键Ctrl + C）。 请按照下列步骤。 <br><br>  1.打开进程资源管理器。 <br><br>  2.选择查看系统信息命令，然后选择内存选项卡。 <br><br>  3.观察免费（零）和免费（零）页面列表的大小。 <br><br>  4.终止或中止TestLimit进程。 <br><br> 您也许可以看到空闲页面列表的大小已短暂增加。 我们之所以说“可能”是因为页面清零流将在被清零页面列表中只有8个条目时立即“唤醒”，并且将非常快速地工作。  Process Explorer每秒仅刷新一次此窗口，似乎其他页面已经有时间重置到重置页面列表，而我们设法“捕获”了此状态。 如果您设法注意到空闲页面列表中的临时增加，那么在此之后，您会发现其大小将减小为零，并且在清零页面列表中也会发生相应的增加。 如果错过了片刻，您只会看到归零页面列表中的数字有所增加。 <br><br><h3> 实验：查看已更改和预期页面的列表 </h3><br> 使用Sysinternals软件包或内核调试器中的VMMap和RAMMap程序，可以观察到将页面从进程的工作集移动到已修改页面的列表，然后再移动到等待页面的列表。 请按照下列步骤。 <br><br>  1.运行RAMMap程序并观察系统的稳定状态。 在这种情况下，它是具有3 GB RAM的x86系统。 窗口中的列反映了页面的不同状态（见图5.37）。 为了方便起见，一些与该实验无关的列已经缩小。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e0/rs/eq/e0rseqvvqzesaijou_34heqwuma.png" alt="图片"></div><br>  2.系统具有约420 MB的可用RAM（由可用页面和清零页面组成）。 等待页面列表中将显示大约580 MB（因此，其中一些“可用”，但最有可能包含以前由进程丢失或用于超取的数据）。 大约有830 MB处于活动状态，并通过有效的页表项直接映射到虚拟地址。 <br><br>  3.根据页面的使用或来源（封闭的过程页面，显示的文件等）的状态，进一步细分每一行。 例如，在活动的830 MB时，由于该进程的关闭页面的分配，大约有400 MB。 <br><br>  4.现在，与前面的实验一样，使用TestLimit实用程序创建一个工作集中包含大量页面的流程。 再一次，我们使用–d开关强制TestLimit写入每个页面，但是这次（但不限于此）创建尽可能多的关闭的修改页面： <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Tools</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Sysinternals</span></span>&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Testlimit</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Testlimit</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.24</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Windows</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">limits</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Copyright</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>) 2012<span class="hljs-selector-tag"><span class="hljs-selector-tag">-2015</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mark</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Russinovich</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Sysinternals</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.sysinternals</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Process</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ID</span></span>: 7548 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Leaking</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">private</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bytes</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">with</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">touch</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">MB</span></span>)... <span class="hljs-selector-tag"><span class="hljs-selector-tag">Leaked</span></span> 1975 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MB</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">of</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">private</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">memory</span></span> (1975 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MB</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">total</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">leaked</span></span>). <span class="hljs-selector-tag"><span class="hljs-selector-tag">Lasterror</span></span>: 8</code> </pre> <br>  5.现在，TestLimit已创建1975个分配区域，每个分配区域1 MB。 要更新RAMMap中的屏幕，您需要使用FileRefresh命令来更新屏幕，因为RAMMap不会自行执行此操作（由于此操作的成本很高）。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tr/fq/ks/trfqksr48lxu2wyr7vqqrrah-p4.png" alt="图片"></div><br>  6.如您所见，活动的2.8 GB以上，其中2.4 GB处于关闭的进程页面行（“进程专用”行）中。 这是分配内存并从TestLimit进程访问它的结果。 还请注意，“待机”，“清零”和“空闲”页面的列表现在要小得多。 分配给TestLimit的大部分内存来自这些列表中列出的页面。 <br><br>  7.接下来，使用RAMMap，您需要评估进程物理页的分配。 转到“物理页面”选项卡，然后在“处理”列的底部设置过滤器，将其设置为Testlimit.exe。 下一个窗口显示了该流程工作集中的所有物理页面。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uw/q1/iw/uwq1iwnrbzt1uuyrlbyzjltph9m.png" alt="图片"></div><br>  8.我们需要确定物理地址空间分配中涉及的物理页面，这是在启动TestLimit程序时使用-d开关执行的。 由于来自RAMMap函数VirtualAlloc的调用，RAMMap没有给出任何分配虚拟区域的指示。 但是我们可以使用VMMap程序获得有关此主题的宝贵提示。 通过调用VMMap <br> 通过相同的过程，我们得到以下结果（请参见上面第535页的图）。 <br><br>  9.在显示的信息的底部，有数百个已分配区域用于关闭的过程数据，每个区域的大小为1 MB，其中已确认的内存为1 MB。 这对应于TestLimit分配的内存大小。 上一个截屏突出显示了这些分发选项中的第一个。 请注意，其起始虚拟地址为0x310000。 <br><br>  10.现在返回到RAMMap程序在屏幕上显示的有关物理内存的信息。 重新排列各列，以使“虚拟地址”列清晰可见。 单击它以该值对行进行排序，然后您可以找到所需的虚拟地址（请参见下面的第535页的图）。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dx/yh/jb/dxyhjbr6mw-ifggsltilg7pqago.png" alt="图片"></div><br>  11.这里显示了从地址0x310000开始的虚拟页面当前已映射到物理地址0x212D1000。 使用-d开关，TestLimit会将其名称写入每个所选区域的前几个字节。 这可以使用本地内核调试器的！Dc命令来演示（dc代表“显示字符”，即，将字符输出到物理地址）： <br><br><pre> <code class="hljs go">lkd&gt; !dc <span class="hljs-number"><span class="hljs-number">0x212d</span></span>1000 #<span class="hljs-number"><span class="hljs-number">212d</span></span>1000 <span class="hljs-number"><span class="hljs-number">74736554</span></span> <span class="hljs-number"><span class="hljs-number">696d</span></span>694c <span class="hljs-number"><span class="hljs-number">00000074</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> TestLimit....... #<span class="hljs-number"><span class="hljs-number">212d</span></span>1010 <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> ................ ...</code> </pre> <br>  12.如果您延迟，则尝试可能会失败-该页面可能已从工作集中删除。 在实验的最后阶段，我们将显示在减少流程的工作集之后，数据保持不变（至少一段时间），并且页面首先移至已更改列表，然后移至等待页面。 <br><br>  13.在VMMap程序中选择TestLimit进程后，打开“查看”菜单，然后选择“清空工作集”命令以最小化该进程的工作集。 现在，在VMMap窗口中，应显示以下信息： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6p/qc/t3/6pqct3pcxcvk_t4klwbufbwyddg.png" alt="图片"></div><br>  14.请注意，工作集行几乎为空。 该过程的中间部分显示工作集的总大小仅为4 KB，几乎所有空间都由页表占用。 现在回到RAMMap。 在“使用计数”选项卡上，您可以看到活动页面的数量已大大减少，更改列表中有大量页面，而等待列表中有大量页面。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pt/ht/zw/pthtzwdh58uewarhkbmkooolt00.png" alt="图片"></div><br>  15. RAMMap的“进程”选项卡上的数据确认由于TestLimit进程，这些页面中的大多数出现在这些列表中。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nx/k8/ib/nxk8ibkfis_m0bmnfw1nsiean2w.png" alt="图片"></div><br><br>  »这本书的更多信息可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在出版商的网站上找到</a> <br>  » <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">目录</a> <br>  » <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">摘录</a> <br><br>  <b>Windows</b>优惠券20％的折扣<b>-Windows</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN422269/">https://habr.com/ru/post/zh-CN422269/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN422257/index.html">PocketBook 627阅读器评论：具有背光，Wi-Fi和云服务的中产阶级</a></li>
<li><a href="../zh-CN422259/index.html">基本数据结构。 物资。 基础知识</a></li>
<li><a href="../zh-CN422261/index.html">Zextras储能和分层系统</a></li>
<li><a href="../zh-CN422263/index.html">“ Dormammu，我同意”：一种与人互利合作的算法</a></li>
<li><a href="../zh-CN422265/index.html">PICASO 3D Designer X PRO 3D打印机概述</a></li>
<li><a href="../zh-CN422273/index.html">智慧城市中没有愚蠢的道路。 什么是RWIS，它将如何降低道路工程成本</a></li>
<li><a href="../zh-CN422275/index.html">由于软件漏洞，一名Google员工能够控制公司办公室的开门系统</a></li>
<li><a href="../zh-CN422277/index.html">架构和编程RCA Studio II</a></li>
<li><a href="../zh-CN422281/index.html">A7数据服务器：在线数据管理</a></li>
<li><a href="../zh-CN422283/index.html">白盒测试</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>