<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€âš–ï¸ ğŸš¾ ğŸ§“ğŸ» PDA (Pocket Travel Computer): Circuitry GPS logger ğŸ‹ ğŸ‘©ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ¼ ğŸ‘©ğŸ¿â€ğŸ¤â€ğŸ‘¨ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Proyek hobi saya adalah pencatat GPS . Komentar itu bahkan menyarankan menyebutnya "Trip Computer", sebagai Logging hanya sebagian kecil dari semua ke...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PDA (Pocket Travel Computer): Circuitry GPS logger</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454434/">  Proyek hobi saya adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pencatat GPS</a> .  Komentar itu bahkan menyarankan menyebutnya "Trip Computer", sebagai  Logging hanya sebagian kecil dari semua kemampuan perangkat.  Banyak yang sudah dilaksanakan, tetapi sebagian besar belum dilakukan. <br><br>  Pada artikel sebelumnya, saya menggambarkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">transisi dari</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">arduino</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ke STM32</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">STMCube / HAL</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">berbicara sedikit tentang sistem build</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bootloader</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">membangun perangkat USB komposit</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">memompa kecepatannya</a> .  Semua ini dilakukan pada papan tempat memotong roti berdasarkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">papan STM32F103CB pil biru</a> dan landak dari kabel.  Sudah waktunya bagi perangkat untuk mengambil bentuk, baik elektronik (sirkuit) dan fisik (tubuh). <br><br><img src="https://habrastorage.org/webt/0g/et/tj/0gettjt59u77r2mjpz73hyfn7sc.jpeg"><br><br>  Masalah yang harus saya selesaikan pada tahap ini sangat saling terkait.  Saat memilih komponen untuk suatu proyek, Anda perlu membayangkan perumahan mana yang bisa mereka tempati.  Dan sebaliknya, kasing harus dibuat untuk komponen yang tersedia dan papan, yang, sekali lagi, harus dilakukan dengan memperhatikan kasing.  Secara umum, kusut masalah yang saling berhubungan.  Anda dapat, tentu saja, mengambil kotak yang lebih besar dan mendorong apa pun di sana, tetapi Anda menginginkan sesuatu yang ringkas dan ringan. <br><br>  Sebelum memulai segera saya ingin mencatat bahwa ini bukan versi terakhir perangkat.  Kemungkinan besar akan ada kesalahan dalam skema, sesuatu tidak akan berfungsi sebagaimana dimaksud, dalam komentar mereka akan menunjukkan solusi yang lebih benar, beberapa pendekatan akan dipikirkan kembali.  Saya berpikir bahwa versi kedua atau bahkan ketiga perangkat tidak dapat dihindari.  Karena itu, saya akan senang dengan komentar konstruktif Anda. <br><br>  Di bawah potongan, ia multi-manik-manik, tetapi itu akan menjadi rekayasa. <br><a name="habracut"></a><br><h2>  Apa dan mengapa </h2><br>  Pencatat GPS Holux M241 adalah teman setia saya di semua perjalanan.  Dia telah bersama saya selama ribuan kilometer.  Track yang ditulis logger terutama digunakan untuk membuat geotag pada foto, tetapi rute itu sendiri juga menarik.  Sangat menyenangkan mengetahui seberapa cepat Anda bermain ski, rute apa yang diterbangkan pesawat Anda, pemandangan apa yang baru saja muncul di luar jendela bus.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Di sini</a> saya melakukan review kecil dari perangkat ini. <br><br>  Sayangnya, kemampuan perangkat ini sudah lama tidak cocok untuk saya: Saya lelah bermain-main dengan baterai yang selalu duduk di saat yang paling tidak tepat.  Ada juga kecepatan USB yang sangat rendah, sejumlah kecil flash internal, mekanisme yang tidak nyaman untuk menggabungkan trek, sedikit informasi yang tersedia di layar, akurasi rendah, odometer yang sangat primitif, tidak ada informasi tentang satelit, dan banyak lagi. <br><br>  Ya, orang dapat mencari apa yang ditawarkan pelacak modern - pasti sudah ada perangkat yang dijual yang memenuhi persyaratan saya.  Tapi ini adalah hobi, saya ingin mencoba melakukan sesuatu yang kompleks, menarik, bermanfaat dan perlu sendiri.  Biarlah, bahkan jika hanya saya yang akan menggunakannya. <br><br>  Tujuan dari proyek ini secara keseluruhan adalah untuk membuat perangkat serupa dalam sesuatu, hanya diisi dengan Wishlist saya.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pada artikel pertama</a> dalam seri ini, saya merinci persyaratan untuk perangkat ini.  Singkatnya, saya ingin melakukan hal berikut: <br><br><ul><li>  Daur ulang sistem daya, transfer ke baterai lithium </li><li>  memasang tampilan yang lebih informatif </li><li>  GPS lebih akurat </li><li>  perluas flash dengan kartu SD </li><li>  tambahkan kompas dan akselerometer </li><li>  Saya juga ingin mendesain ulang sistem logging untuk memuntahkan trek dalam format yang saya butuhkan. </li></ul><br>  Selain persyaratan teknis dan Wishlist, ada juga yang non-teknis (non-fungsional).  Jadi saya ingin memompa dalam menciptakan perangkat yang kompleks dari awal, untuk mencari tahu bagaimana berbagai komponen elektronik bekerja, cara memprogramnya, cara membuat papan dan mendesain kasing. <br><br>  Mengapa Anda memerlukan perangkat terpisah jika semua ponsel modern memiliki GPS, layar besar dan banyak memori?  Yah, pertama-tama, saya tidak yakin bahwa ponsel dengan GPS aktif dalam mode perekaman trek dapat bertahan sepanjang hari.  Saya tidak ingin tinggal di negara asing tanpa telepon.  Juga, saya pribadi menggunakan perangkat terpisah hanya lebih nyaman. <br><br>  Mungkin seiring waktu, konsep perangkat akan berubah.  Jadi, misalnya, sekarang menjadi semakin dan semakin logis untuk meninggalkan layar dan terhubung ke ponsel melalui bluetooth, dan melakukan semua trik logika pada ponsel.  Gagasan ini sangat kuat dan menggoda.  Tetapi pada tahap ini, saya masih ingin memiliki tampilan - saya selalu punya waktu untuk meninggalkannya. <br><br>  Untuk satu setengah tahun pertama, saya mengembangkan perangkat pada berbagai jenis papan debug (arduino nano pertama, kemudian STM32F103 pil biru, kemudian STM32F407VE).  Saya harus menghubungkan periferal pada kabel dan membeli modul.  Akibatnya, landak yang terbuat dari kabel muncul di atas meja, yang tidak berhasil menguji penerimaan GPS di jalan - kadang-kadang Anda bahkan tidak bisa memindahkan kabel tanpa memutus koneksi di suatu tempat.  Dan kemudian senang debugging. <br><br>  Setiap kali, duduk untuk menulis fungsionalitas yang berguna, saya menghadapi kenyataan bahwa beberapa bagian lain dari sistem berhenti bekerja secara normal dan harus menghabiskan berjam-jam men-debug sesuatu yang sama sekali tidak terkait.  Jadi, misalnya, komponen terpenting dari sistem - penerima GPS - pada akhirnya menjadi yang paling tidak berkembang, karena  Saya harus pergi ke USB debug, kartu SD, mengatur perpustakaan, dan sebagainya. <br><br>  Akhirnya, saya bosan dan memutuskan untuk membuat papan debugging - ini akan menjadi topik artikel hari ini.  Tujuan yang saya tetapkan untuk diri saya sendiri di bagian proyek ini adalah sebagai berikut: <br><br><ul><li>  Buat papan debug yang tidak akan memiliki masalah dengan komponen non-kontak </li><li>  Tentukan solusi teknis dan skematis utama </li><li>  Secara kasar tentukan komponen yang akan saya gunakan selanjutnya </li><li>  Secara kasar tentukan tata letak dan bodinya </li><li>  Rangkaian harus cukup umum untuk dapat bereksperimen dengan berbagai komponen dan modenya </li></ul><br>  Dan meskipun tujuan utamanya adalah perangkat baterai yang ringkas, hari ini saya tidak akan melakukan hal-hal seperti itu <br><br><ul><li>  mode daya fine tuning </li><li>  pengaturan konsumsi </li><li>  mode tidur </li></ul><br><br>  Saya akan berurusan dengan pengaturan konsumsi ketika papan dan kode utama siap.  Ngomong-ngomong, tentang kode hari ini juga tidak akan, tapi saya pasti akan kembali ke pertanyaan ini karena akan ada bahan yang cukup menarik. <br><br><h2>  Komponen </h2><br>  Mari kita mulai dengan komponen dan periferal.  Sepanjang jalan, kami akan memperkirakan jumlah kaki mikrokontroler yang akan diperlukan untuk menghubungkan kebun binatang ini, serta parameter daya.  Karena  itu adalah proyek hobi yang saya pilih komponen dari apa yang benar-benar dapat saya beli di toko / ebay / ali, dan juga dari apa yang bisa disolder di rumah (well, juga dari apa yang sudah ada dalam stok pribadi saya).  Mungkin beberapa sirkuit mikro spesifik dapat memecahkan masalah dengan lebih baik, tetapi masalah keterjangkauan dan harga penting bagi saya. <br><br><ul><li>  Komponen utama pencatat GPS, tentu saja, adalah <b>penerima GPS</b> .  Dalam kasus saya, ini adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Beitian BN-880</a> yang ditipu berdasarkan chip UBlox M8N.  Kompas pada chip HMC5883L juga terintegrasi dalam modul. <br><br>  Koneksi: 2 pin UART untuk GPS dan 2 pin I2C untuk kompas <br>  Catu Daya: Dari 2.7V <br>  Konsumsi: 50mA <br><br><ul><li>  Juga memesan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">modul Beitial BN-220</a> .  Tidak memiliki kompas, tetapi antena lebih kompak (20x20mm dibandingkan 30x30).  Yang benar masih belum jelas bagaimana ini akan mempengaruhi kualitas penerimaan.  Perlu diuji.  Tetapi, dilihat dari datasheet, modul ini dapat bekerja dari 1.4V, yang seharusnya memiliki efek positif pada waktu pengoperasian perangkat. </li><li>  Di sini, pada kenyataannya, semuanya entah bagaimana berlumpur.  Tampaknya bahwa BN-880 didasarkan pada UBlox M8N, sedangkan BN-220 didasarkan pada U-blox M8030-KT.  Tetapi dalam beberapa sumber tergelincir bahwa itu tampaknya menjadi hal yang sama.  Lebih tepatnya, M8N adalah modul, dan M8030-KT adalah chipset di dalamnya.  Saya prihatin dengan masalah daya dalam kebingungan ini - M8N diumumkan dari 2.7V, sedangkan M8030-KT berasal dari 1.4V. </li><li>  Sebagai alternatif, saya juga memiliki modul <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://www.aliexpress.com/item/1PC-SIM868-GSM-GPRS-Bluetooth-GNSS-SMS-GSM-Module-Instead-of-SIM808-SIM908/32821272639.html%3Fspm%3Da2g0s.9042311.0.0.27424c4dTkhPkq)%2520(%25D0%25BE%25D1%2582%25D0%25BB%25D0%25B0%25D0%25B4%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F%2520%25D0%25BF%25D0%25BB%25D0%25B0%25D1%2582%25D0%25B0%2520">SIM868</a> .  di mana selain GPS ada juga modul GSM / GPRS dan Bluetooth.  Sementara itu menakutkan dengan trickiness dan kompleksitas koneksi.  Anda harus bermain dengan papan debug terlebih dahulu. </li></ul></li><li>  Perbedaan utama antara perangkat dan "hanya kotak hitam" adalah kehadiran <b>layar</b> .  Pada prototipe pertama, saya menghubungkan layar melalui I2C, tetapi beban bus sekitar 25%.  Tetapi intinya tidak bahkan dalam rasio persentase, tetapi pada kenyataan bahwa transfer buffer layar memakan waktu sekitar 25 ms, di mana tidak mungkin untuk berkomunikasi dengan perangkat lain di bus.  Ini bisa menjadi masalah, jadi Anda harus meletakkan monitor di bus I2C yang terpisah, atau mempertimbangkan untuk terhubung melalui SPI <br><br>  Koneksi: 2 kabel I2C atau 3 kabel SPI (tampilan tulis saja, oleh karena itu garis MISO tidak digunakan, tetapi sinyal Data / Perintah terpisah digunakan) <br>  Catu Daya: 3V <br>  Konsumsi: 25mA <br></li><li>  Untuk mengontrol perangkat, saya akan menggunakan <b>2 tombol</b> yang masing-masing menempati 2 kaki prosesor <br></li><li>  Di perangkat asli (Holux M241, dari mana saya awalnya menyalin fungsionalitas), tidak mungkin untuk menonton trek pada titik waktu yang sewenang-wenang.  Itu perlu untuk menghubungkan perangkat ke komputer dan menggabungkan data dengan program khusus.  Menurut saya, kemampuan menonton trek di ponsel atau tablet kapan saja akan sangat populer.  Untuk ini, saya membeli modul <b>Bluetooth</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">HM-13</a> .  Modul ini dipilih karena memiliki SPP selain BLE. <br><br>  Koneksi: 2 kabel UART, 1 kawat status (terhubung / tidak terhubung) <br>  Catu Daya: 2.5V - 3.9V <br>  Konsumsi: 50mA (meskipun angka 13mA tepat di sebelah lembar data. Mungkin ini adalah nilai puncak dan rata-rata) <br></li><li>  Seperti yang saya katakan, tidak masuk akal untuk menghidupkan receiver jika Anda hanya duduk untuk beristirahat atau makan di kafe.  Oleh karena itu, saya memutuskan untuk menambahkan <b>accelerometer</b> MMA8452 dan menggunakannya untuk menentukan apakah perangkat sedang diam atau kami bergerak ke suatu tempat. <br><br>  Koneksi: 2 kabel I2C, 1 kabel untuk gangguan <br>  Catu daya dari 2V ke 3.6V dengan beberapa konsumsi mikroskopis <br></li><li>  Trek GPS akan direkam pada <b>kartu SD</b> .  Saya sudah mencoba menggunakan kartu dalam mode SPI dan ini, dengan kata lain, lambat.  Terutama pada catatan.  Mode yang benar untuk kartu SD - SDIO <br><br>  Koneksi: 6 kabel <br>  Catu Daya: Dari 1.8V <br>  Konsumsi tidak diketahui, tetapi saya pikir tidak lebih dari 20mA <br></li><li>  Untuk menghemat energi, masuk akal untuk mematikan daya perangkat yang saat ini tidak digunakan.  Jadi dekat setiap konsumen saya akan memakai <b>transistor</b> , yang saya akan mengontrol sinyal terpisah dari mikrokontroler <br><br>  Koneksi: 5 sinyal, satu kaki per konsumen (GPS, Bluetooth, akselerometer, kartu SD, layar) <br><br>  UPD berdasarkan komentar.  Menonaktifkan accelerometer tidak masuk akal - sudah memiliki konsumsi satu sen.  Beberapa perangkat kemungkinan besar akan selalu berfungsi (misalnya, kartu SD) - di masa depan saya akan dapat menghapus transistor ini.  Beberapa perangkat (seperti GPS) dapat memutuskan koneksi sendiri berdasarkan perintah dari antarmuka.  Jika menurut hasil tes bagian ini akan berfungsi dengan baik - Saya juga akan menolak transistor eksternal.  Sementara itu, saya membuat total biaya maksimum yang mungkin, biarkan semua transistor ini.  Apalagi saya belum memutuskan pinggiran. </li><li>  <b>LED dua warna</b> untuk tampilan status (bagaimana tanpa LED yang berkedip?).  Itu mungkin untuk menempatkan tri-warna, tapi sejauh ini saya tidak melihat kebutuhan. <br><br>  Koneksi: 2 pin <br>  Konsumsi: 10mA <br></li><li>  Selain Bluetooth, mekanisme yang lebih klasik untuk menggabungkan lagu akan diimplementasikan - melalui <b>USB</b> .  Untuk ini, 4 baris akan terlibat - pasangan diferensial untuk data, 1 pin untuk mendeteksi bahwa perangkat dicolokkan ke USB, dan pin lain untuk koneksi logis (mengapa saya membutuhkan 2 pin ini akan saya jelaskan di bawah) <br></li><li>  Nafsu makan datang dengan makan.  Karena saya mulai mendorong semua yang ada di perangkat impian saya, mengapa tidak menambahkan <b>tweeter</b> ?  Nah, atau <b>motor getaran</b> .  Saya belum menemukan case pengguna. <br><br>  Koneksi: 1 kawat <br></li><li>  Perangkat masih perlu dihidupkan.  Sementara chip PT1502 melihat saya sebagai pengisi daya baterai lithium dan <b>pengontrol daya</b> .  Untuk berkomunikasi dengan sirkuit mikro, Anda harus menggunakan 2 kabel: satu untuk manajemen daya, yang lain untuk sinyal tentang baterai mati.  Untuk kepentingan, dimungkinkan untuk mengukur tegangan baterai menggunakan saluran lain. <br></li><li>  Tentu saja, muatan baterai lithium tidak tepat untuk diukur berdasarkan tegangan.  Oleh karena itu, saya menambahkan <b>chip meteran daya INA219</b> khusus <br><br>  Tegangan suplai: 3-5V, rekomendasikan 3.3V <br>  Koneksi: 2 kabel I2C <br><br>  Seperti yang akan dilihat di bawah, tegangan suplai 3V menciptakan beberapa ketidaknyamanan dalam koneksi.  Saya lebih suka chip counter untuk didukung dari 2.7V atau lebih rendah.  Tetapi setelah melalui beberapa opsi berdasarkan harga / kasus / ketersediaan, saya masih tidak menemukan apa pun di 2.7V.  Saya akan berterima kasih atas bantuannya. <br></li><li>  Tetap hanya untuk menyediakan antarmuka debugging <b>SWD</b> (3 kabel) dan <b>UART debugging</b> (2 kabel lebih) <br></li></ul><br>  Saya selalu tertarik pada pertanyaan mengapa pengontrol dengan sejumlah besar port diperlukan, dan saya dengan mudah menghitung 39 cakram yang diperlukan untuk fungsionalitas saya.  Dan itu tidak termasuk kuarsa, reset, dan daya.  Dan ada ide untuk apa yang harus dilakukan dengan selusin lebih (misalnya, layar dapat dihubungkan melalui antarmuka paralel Intel 8080 atau Motorola 6800). <br><br>  Anda tentu saja dapat mengacaukan port eksternal I2C untuk mengurangi jumlah kaki yang digunakan.  Tapi pertama, ini adalah komponen tambahan di papan, kedua, bagian perangkat lunak menjadi jauh lebih rumit, dan ketiga, mikrokontroler kecil masih memiliki sedikit memori, dan di mana ada cukup memori, ada juga cukup banyak port.  Jadi saya tidak melihat alasan untuk menyulitkan semuanya - biarkan ada 39 baris. <br><br><h2>  Nutrisi </h2><br>  Dengan catu daya, tidak semuanya jelas.  Anda mungkin dapat menyalakan semua perangkat dari 3.3V dan tenang.  Tapi kami, bagaimanapun, akan membuat perangkat mobile, yang berarti kita perlu memikirkan penghematan energi.  Jadi, Anda perlu mencoba untuk memilih tegangan suplai yang lebih kecil.  Di bawah ini saya akan memperkirakan penghematan jenis apa yang dapat Anda coba capai. <br><br>  Berikut adalah data untuk semua perangkat di piring - dalam formulir ini lebih mudah untuk memilih domain daya yang akan dihubungkan ke perangkat ini atau itu. <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>Perangkat</b> </td><td>  <b>Rentang daya</b> </td><td>  <b>Domain kekuatan</b> </td><td>  <b>komunikasi</b> </td></tr><tr><td>  CPU </td><td>  2 - 3.6V </td><td>  2V </td></tr><tr><td>  Akselerometer </td><td>  2 - 3.6V </td><td>  2V </td><td>  I2C </td></tr><tr><td>  Kartu sd </td><td>  1.8V atau 3.6V </td><td>  2V </td><td>  SDIO </td></tr><tr><td>  Tampilan </td><td>  1.65 - 3.3V <br>  atau 3 - 5V </td><td>  2V </td><td>  I2C atau SPI </td></tr><tr><td>  GPS </td><td>  2.7 - 5.5V <br>  atau dari 1.4V </td><td>  2.7V </td><td>  UART </td></tr><tr><td>  Bluetooth </td><td>  2,5 - 3,9V </td><td>  2.7V </td><td>  UART </td></tr><tr><td>  Pengukur Daya (INA219) </td><td>  3 - 5.5V </td><td>  3v </td><td>  I2C </td></tr><tr><td>  Bel </td><td>  3V - 5V </td><td>  Vbat </td></tr></tbody></table></div><br>  Dari pelat mudah untuk melihat bahwa beberapa perangkat dapat beroperasi dari tegangan yang cukup rendah (dari 1.8V).  Yang lain dapat bekerja dengan nyaman dari 2.7V.  Akhirnya, perangkat yang tersisa di bawah 3V tidak dapat berfungsi.  Squeaker, untuk selamanya, umumnya membutuhkan 5V, tetapi bagi saya itu akan didukung oleh tegangan tertinggi - dari baterai, tidak peduli berapa banyak itu. <br><br>  Dengan kekuatan tampilan belum sepenuhnya dipahami.  Dalam deskripsi modul tampilan dengan ali, kisarannya adalah 3 - 5V, sedangkan dalam lembar data pada pengontrol matriks SSD1309 kisarannya adalah 1,65 - 3,3V.  Saya berasumsi bahwa 3V diperlukan untuk mengayunkan boost converter pada papan modul display, sementara 1.65V cukup untuk logika.  Seperti yang akan dilihat dari diskusi tentang tata letak, masuk akal untuk meninggalkan modul tampilan dan menghubungkan layar secara langsung, yang akan memberi daya pada tampilan dari domain 2B. <br><br>  Saya memiliki alasan yang sama tentang GPS - sumber yang berbeda menunjukkan voltase pasokan yang berbeda.  Sejauh ini, saya tidak memiliki pemahaman tentang modul mana yang akan saya gunakan pada akhirnya, jadi biarkan penerima nongkrong di domain 2.7V. <br><br>  Dengan kartu SD sama sekali tidak jelas.  Spesifikasinya secara tidak jelas mengatakan bahwa secara umum kartu harus ditenagai dari 3.3V, tetapi kartu modern cukup pintar dan dapat memahami bahwa mereka terjebak dalam perangkat bertegangan rendah dan dapat beralih ke daya dari 1.8V.  Tetapi mekanisme untuk memilih makanan tidak begitu jelas.  Saya akan memberi makan kartu dari 2B dan melihat apa yang terjadi.  Itu tidak akan bekerja - itu akan bekerja dari 3V. <br><br>  Jadi, 4 bus daya tenun - 2V, 2.7V, 3V dan baterai.  Saya ingin menempatkan semua konsumen yang makan dan terus-menerus bekerja (dan ini adalah pengontrol dan GPS) pada bus tegangan terendah, tetapi saat ini saya belum memutuskan modul GPS (dan karena itu catu daya - 2 atau 2.7V), yang berarti akan diperlukan semacam solusi universal.  Saya akan mencoba memisahkan papan sehingga mudah untuk menerapkan tegangan satu atau yang lainnya. <br><br>  Dari mana Anda mendapatkan begitu banyak tekanan yang berbeda?  Bahkan pada tahap awal proyek, saya melihat sirkuit mikro PT1502 dan bahkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">berhasil mencobanya di proyek lain</a> .  Selain pengisi daya untuk baterai lithium, rangkaian mikro ini memiliki sebanyak 3 sumber daya - satu pulsa dan 2 sakelar down-linear.  Di sini, bagaimanapun, tegangan tidak diatur pada salah satunya dan 3V - Saya akan mencoba untuk memberi daya INA219 dari itu.  2 sumber daya yang tersisa tidak menjadi masalah, karena  di sana Anda dapat memilih tegangan. <br><br>  Memperkirakan konsumsi tidak terlalu berhasil.  Konsumsi puncak ditunjukkan dalam lembar data - ini cukup untuk menghitung kekuatan transistor utama, tetapi tidak cukup untuk memperkirakan kapasitas baterai yang diperlukan.  Jadi untuk saat ini, saya akan memilih baterai berdasarkan ruang yang tersedia dalam case, dan di sana saya sudah akan mengukur konsumsi sebenarnya. <br><br>  Mungkin timbul pertanyaan, tetapi bagaimana cara mencocokkan perangkat dengan voltase operasi yang berbeda?  Mari kita perbaiki. <br><br><ul><li>  Semua kaki komunikasi dari mikrokontroler ditandai sebagai Toleransi Lima Volt (kecuali untuk UART2 pada kaki PA2 / PA3), yang berarti bahwa jika tampak 3.3V dari perangkat tegangan tertinggi, tidak ada hal buruk yang akan terjadi </li><li>  Accelerometer, meskipun ditenagai oleh 2V, berpotensi dapat dihubungkan secara paralel dengan perangkat tegangan tinggi di bus.  Masalah ini mudah diselesaikan - dengan sirkuit mikro MMA8452Q, Anda dapat secara terpisah memberi daya pada kabel komunikasi dari catu daya lain (melalui perangkat â€œtegangan tinggiâ€ di bus itu sendiri) </li><li>  Saya akan mencoba memberi daya kartu SD dari tegangan yang sama dengan mikrokontroler, yang berarti saya tidak perlu mengoordinasikan apa pun. </li><li>  GPS dan Bluetooth harus memakan tegangan "rendah" dari mikrokontroler tanpa masalah.  Hal yang sama berlaku untuk perangkat â€œtegangan tinggiâ€ lainnya </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akhirnya, beberapa kata tentang mengapa saya begitu berjuang untuk menurunkan tegangan suplai. </font><font style="vertical-align: inherit;">Sebuah chip dalam konverter DC-DC berdenyut, yang dapat menukar voltase dengan ampere (tentu saja, jika Anda tidak memperhitungkan kerugian konverter itu sendiri). </font><font style="vertical-align: inherit;">Untuk lebih tepatnya, tukar tegangan yang lebih tinggi dengan arus yang lebih rendah untuk tegangan yang lebih rendah dan arus yang lebih tinggi. </font><font style="vertical-align: inherit;">Dalam hal ini, kami lebih tertarik pada alasan terbalik - jika Anda memberi makan beban tegangan rendah melalui DC-DC, maka konsumsi saat ini dari seluruh struktur ini bersama dengan konverter akan lebih rendah daripada konsumsi saat ini dari beban itu sendiri. </font><font style="vertical-align: inherit;">Nah, karena kapasitas baterai diukur dalam mAh, maka mengurangi konsumsi saat ini akan meningkatkan masa pakai baterai.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hitung?</font></font></b> <div class="spoiler_text">   ,        90%,        DC-DC        .  .      ,      DC-DC   . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">  </a> .   900    4.1  3.5 (      ).  DC-DC    90% (   ).    100.            . <br><br> ,      900  100  9 .          â€” 9.3     3.3, 11.4   2.7,   15    2. ,    ,    ,        . <br></div></div><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mikrokontroler </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya mendekati pertanyaan memilih mikrokontroler dengan serius - saya bermain dengan konfigurator untuk waktu yang lama, menimbang pro dan kontra dari setiap opsi. Saya benar-benar menyukai mikrokontroler STM32, jadi saya tidak melihat titik melihat ke arah pengontrol lain tanpa kebutuhan khusus. Selain itu, di jalur STM32 ada pengontrol untuk setiap selera dan untuk setiap perangkat. Pengalaman yang diperoleh pada tahap sebelumnya dari proyek saya memungkinkan kami untuk mempersempit pilihan controller berdasarkan daftar peripheral, binding perangkat lunak yang sudah ditulis, serta fitur yang ingin saya terapkan di masa depan.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jadi, cukup jelas bahwa memori 20kb dari STM32F103CB saya benar-benar kecil - tidak ada buffer ukuran yang cukup layak untuk berkomunikasi dengan kartu SD dan USB. </font><font style="vertical-align: inherit;">Saya bahkan belum mulai menerapkan banyak fungsi yang direncanakan, tetapi sudah memakan waktu lebih dari 19kb. </font><font style="vertical-align: inherit;">Tetapi dengan kekuatan untuk memproses, ternyata, ini tidak terlalu diperlukan. </font><font style="vertical-align: inherit;">Jika semua komunikasi dengan periferal didorong ke DMA, maka hanya beberapa persen yang tersisa pada bagian prosesor pusat. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setelah memperkirakan daftar apa yang saya butuhkan dari controller, saya menghitung yang berikut ini:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 128kb flash (saat ini sekitar 50k digunakan) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40 kb memori (sekarang 19k diambil) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40 kaki GPIO (lihat alasan di atas) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 40MHz (Anda tidak perlu banyak, yang utama adalah konsumsi lebih sedikit) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DMA (Saya sangat menyukainya) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = 2x I2C,&gt; = 3x UART,&gt; = 1 SPI </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SDIO (flash drive melalui SPI sangat lambat) </font></font></li><li>  USB Full Speed,  High Speed </li><li>  (      ) </li><li>       LCD  (         FSMC) </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STMicroelectornics mikrokontroler hanya selusin sepeser pun - untuk setiap selera, warna dan dompet. Pada awalnya saya mencoba memilih pengontrol untuk melanjutkan dari seri. Penguasa L0 dan F0 terlalu lemah dan tidak cukup memori, S7 dan H7, sebaliknya, terlalu kaya fitur, tidak ada SDIO di L4 (UPD: SDIO adalah, mereka hanya tidak menyebutkannya di halaman judul seri). Di antara seri lainnya, Anda dapat memilih sesuatu berdasarkan kebutuhan saya, karena saya tidak memiliki persyaratan khusus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seri STM32WB mengesankan dengan kehadiran Bluetooth, tetapi case VFQFPN68 agak mendinginkan keinginan untuk menggunakannya dalam proyek hobi. Dan saya tidak menemukan pengontrol seperti itu di ritel.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya bertujuan pada kasus LQFP64 - cukup dalam jumlah kaki, tetapi tidak terlalu besar pada saat yang sama dan dapat disolder di rumah. Ada baiknya bahwa ada konfigurator CubeMX di mana Anda dapat memilih apa yang Anda butuhkan dengan filter. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya memilih pengontrol STM32F103RB karena tiga alasan. Pertama, saya sudah mempelajari seri F103 dengan baik dengan papan Blue Pill. Secara umum, pengontrol STM32F103CB benar-benar cocok untuk saya, hanya memori tidak cukup. Kedua, saya sudah memiliki bootloader dan kode tingkat rendah untuk pengontrol ini, sementara yang lain harus diulang. Dan ketiga, sekitar setahun yang lalu, saya sudah senang membeli 3pcs STM32F103RB. Kemudian saya tidak melakukan studi rinci tentang pengendali yang tersedia, tetapi hanya mengambil pengontrol yang lebih tebal dari garis F103. Jangan dibuang sekarang :)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seperti yang telah saya catat, saya tidak memiliki persyaratan kinerja atau periferal yang khusus. </font><font style="vertical-align: inherit;">Tetapi jika saya mengalami sesuatu, maka dalam pikiran saya sudah memiliki pengontrol dari garis F4 (jika sesuatu yang lebih kuat diperlukan), atau L152RD, jika Anda perlu memutuskan sesuatu dengan konsumsi (UPD: Saya juga melihat L433RC). </font><font style="vertical-align: inherit;">Apa yang menyenangkan, dengan STM32, hampir semua pengontrol pin-to-pin kompatibel, dan F4 dan L1 / L4 dapat disolder hampir tanpa mengubah papan. </font><font style="vertical-align: inherit;">Anda bahkan dapat mengumpulkan dan membandingkan konsumsi dengan berbagai MK.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Beberapa kata tentang body dan tata letak </font></font></h2><br>  Kami memutuskan detailnya.  Sudah waktunya untuk menggambar diagram, kemudian menelusuri papan, dan kemudian mencoba memasukkannya ke dalam case.  Atau tidak?  Untuk mengakui, pada awalnya saya hanya pergi dengan cara ini, tetapi kemudian saya sampai pada kesimpulan bahwa semuanya perlu dilakukan dalam urutan terbalik.  Ya, atau setidaknya pada saat yang sama. <br><br>  Saya ingin mendapatkan perangkat yang ringkas.  Dan untuk ini, Anda perlu memahami secara akurat ukuran ruang yang tersedia, pada gilirannya, untuk memahami di mana harus meletakkan papan dan ukurannya, ukuran baterai apa yang cocok, di mana menempatkan tombol, layar, konektor USB dan komponen eksternal lainnya, serta mencari tahu cara memasang komponen dan Anda dapat apakah nyaman untuk meletakkan kabel di antara mereka.  Tidak ada gunanya mulai mengangkat papan tanpa memahami semua hal ini.  Jadi ternyata Anda harus terlebih dahulu berurusan dengan bodi dan tata letak, lalu beralih ke sirkuit. <br><br>  Juga, dalam proses menggambar kasing, saya harus merevisi pemilihan komponen beberapa kali.  Jadi awalnya saya berpikir untuk menggunakan layar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">murah 128x64 0,96 â€</a> (wilayah kerja 21,7 x 11,2mm), tetapi layar ini tampak sepenuhnya mikroskopis dengan latar belakang kasing yang jauh lebih besar.  Kemudian diperintahkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">layar 1,3 "</a> (area kerja 29,4 x 14,7 mm), tetapi tidak jauh lebih baik.  Lalu saya mendapat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">layar 1,54 â€</a> (35 x 17,5 mm) - tampilannya kurang lebih normal.  Ini saat ini merupakan opsi kerja utama. <br><br>  Menurut perkiraan, tampilan 1,8 "-2" akan terlihat lebih baik, tetapi ini sudah datang dalam warna dan resolusi yang lebih tinggi, dan karenanya buffer layar akan cukup besar untuk pengontrol saya (35kb bukan 1kb).  Yah, mendorong layar besar ke dalam case juga bisa menjadi masalah, karena  braket pendaratan untuk modul semacam itu secara signifikan lebih besar dari area aktif layar. <br><br>  Ketika saya menulis artikel ini di ali, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">layar monokrom 2,42 â€</a> muncul dengan resolusi yang sama (128x64) dan persis sama dengan 1,54â€.  Saya memesan satu untuk pengujian saya - ada kemungkinan untuk memasukkannya ke dalam case saya tanpa peningkatan signifikan pada perangkat. <br><br>  Poin penting lainnya pada tahap kerja kasus ini adalah pemahaman bahwa modul tampilan yang dibeli memakan terlalu banyak ruang dan secara signifikan mengurangi ruang untuk papan utama.  Karena itu, saya memutuskan untuk meninggalkan modul display yang sudah jadi, dan sebagai gantinya menempatkan display dan mengikatnya ke board saya.  Jumlah bagian dalam rangkaian sedikit meningkat, tetapi desain secara keseluruhan disederhanakan dan menjadi lebih kompak. <br><br>  Saya memiliki pemikiran serupa tentang topik modul GPS.  Ini tidak sebesar itu, tetapi tidak peduli bagaimana cara ia meletakkannya atau itu mengganggu, atau antena ditutup oleh baterai.  Mungkin ide yang baik untuk meletakkan isian modul di papan Anda, dan menempatkan antena di tempat lain. <br><br>  Mengerjakan case juga memungkinkan untuk menentukan ukuran dan kapasitas baterai.  Dalam volume yang tersedia, baterai 900mAh baru saja ditemukan - kami akan fokus padanya.  Saya ingin perangkat saya bekerja dengan baterai 15-20 jam, yang artinya konsumsi harus di level 45-60mA. <br><br>  Saat ini, saya tidak dapat menyelesaikan pekerjaan di lambung.  Pertama, pertanyaan pilihan untuk beberapa komponen (layar, GPS) masih terbuka.  Kedua, tidak jelas apakah rangkaian saya akan mulai pada prinsipnya atau apakah akan perlu untuk mengubah apa pun secara radikal.  Dan ketiga, papan tersebut ternyata terlalu ringkas - saya tidak yakin bisa membubarkan, menyolder, dan men-debugnya.  Oleh karena itu, dalam artikel ini saya masih akan fokus pada masalah sirkuit, saya akan bergerak dalam langkah-langkah yang lebih sederhana dan lebih mudah dipahami, dan saya akan berbicara tentang kasus ini di lain waktu.  Di sini Anda memiliki beberapa rendering dan foto untuk seed. <br><br><img src="https://habrastorage.org/webt/4j/ff/l-/4jffl-arvuselp1d93s5muqazqy.png"><br><br><img src="https://habrastorage.org/webt/o2/a9/ve/o2a9vejujirpcxe634dzikwqc0e.png"><br><br><img src="https://habrastorage.org/webt/a9/hu/ka/a9huka9xfxi-g0wegdzhb8ezonm.jpeg"><br><br><img src="https://habrastorage.org/webt/az/nl/b2/aznlb21azpqtsfgoaim0occrvgc.jpeg"><br><br><h2>  Skema </h2><br>  Sekarang Anda bisa melakukan elektronik.  Saya akan menjelaskan solusi sirkuit dengan detail yang cukup.  Pertama-tama, untuk pendatang baru yang sama dalam elektronik seperti saya, serta sinopsis untuk diri saya sendiri.  Insinyur elektronik yang berpengalaman dapat menelusuri sirkuit dan mundur ke bagian selanjutnya. <br><br>  Mari kita mulai dengan nutrisi. <br><br>  Perangkat ini akan ditenagai oleh baterai lithium, yang berarti Anda memerlukan pengontrol biaya.  Juga, beberapa komponen memiliki batas tegangan atas sekitar 3.6V, sementara baterai dapat dengan mudah berakhir dengan lebih dari 4V.  Jadi Anda membutuhkan sumber daya step-down.  Seperti yang telah kita ketahui, kita akan memerlukan beberapa tekanan berbeda. <br><br>  Saya sudah menyebutkan bahwa saya akan menggunakan chip PT1502.  Sangat cocok, karena  mengimplementasikan pengontrol muatan, 3 sumber daya, serta rangkaian perangkat pengalih tombol.  Microcircuit berisi beberapa blok fungsional, yang telah saya bagi dalam diagram untuk kejelasan.  Rangkaian itu sendiri adalah rangkaian lembar data yang sedikit direvisi.  Berikut adalah pengontrol pengisian daya baterai lithium <br><br><img src="https://habrastorage.org/webt/7y/p7/sk/7yp7skuez7vcdpdzr33f6rhtfk4.png"><br><br>  Resistor R3 mengatur arus muatan.  Secara default, ini sesuai dengan 470mA.  Mungkin menurut hasil pengujian, saya akan mengurangi nilai resistor ini menjadi 510 Ohm, yang akan memberikan arus muatan sekitar 900mA (1C). <br><br>  Pengontrol dapat melaporkan mode pengisian saat ini dengan kaki CHG_STAT.  Selain itu, ia tahu cara memberi sinyal sebanyak 3 - pengisian daya, tidak pengisian daya, dan sudah diisi daya, tetapi masih terhubung ke outlet.  Pada versi pertama, transistor internal menekan kaki ke tanah dan ini dapat dengan mudah dikenali oleh pengontrol.  Dalam perwujudan kedua, transistor benar-benar tertutup dan kaki masuk ke keadaan impedansi tinggi.  Menggunakan power-up, sinyal seperti itu juga mudah dibaca oleh pengontrol. <br><br>  Tetapi dengan negara ketiga tidak begitu sederhana.  Di sana, transistor terbuka dan arus 20 Î¼A mengalir melaluinya.  Untuk mempertimbangkan kondisi seperti itu, saya diminta untuk memilih tumpangan sehingga sekitar setengah dari nutrisi ada di kaki saya.  Maka akan mungkin untuk dengan mudah mendeteksi keadaan seperti itu menggunakan ADC.  Menggunakan hukum Ohm kita mendapatkan R5 = 1V / 20mkA = 50k. <br><br>  Seperti yang saya katakan, chip PT1502 bukan hanya pengisi daya, tetapi juga pengontrol rumit untuk semua daya.  Microcircuit memonitor tegangan di sirkuit dan, menggunakan sinyal RESET, dapat mengontrol prosesor utama (mereka mengatakan bahwa Anda masih harus memulai dari awal, daya belum stabil). <br><br><img src="https://habrastorage.org/webt/21/z3/f1/21z3f1tkkpvqsph462qukz0_anu.png"><br><br>  Selain itu, rangkaian mikro dapat memulai perangkat dengan satu sentuhan tombol (BTN1), dan juga, atas sinyal dari mikrokontroler (PWR_HOLD), selesaikan operasi dan matikan daya.  Nah, untuk memberi sinyal prosesor bahwa baterai kehabisan sinyal BAT_LOW. <br><br>  Dan ini adalah sumber daya utama. <br><br><img src="https://habrastorage.org/webt/nb/5x/tc/nb5xtc2txxl98wz1pfwgmzsr49u.png"><br><br>  Tegangan output diatur oleh tegangan di terminal BUCKFB dan diatur ke 2V dengan daya baterai.  Tetapi dengan daya dua volt, satu masalah ditemukan - USB tidak akan berfungsi.  Yaitu  baterai akan diisi, tetapi tidak dapat mengirimkan data - mikrokontroler tidak dapat mengirimkan sinyal ke bus USB dengan amplitudo yang cukup.  Datashit merekomendasikan tegangan setidaknya 2.7V, lebih baik dari 3.3V. <br><br>  Agar tidak memblokir sumber daya lain dan berpikir bagaimana beralih di antara mereka, saya memutuskan untuk hanya menyesuaikan rasio pembagi R1 / R4 + R7.  Dengan inklusi ini, impuls beroperasi terus menerus.  Begitu perangkat dicolokkan ke USB, transistor terbuka dan shunts R7.  Rasio resistor penggerak berubah dan kami mendapatkan output 3,16V (kami masih bisa bermain dengan peringkat dan menahannya hingga 3,3V). <br><br>  PT1502 juga memiliki 2 kontrol linier. <br><br><img src="https://habrastorage.org/webt/1c/s0/tj/1cs0tjf8eerkuske4_dyqithygm.png"><br><br>  Baik komponen yang mengonsumsi rendah (INA219) atau berumur pendek (bluetooth) akan terhubung ke pengontrol ini, sehingga efisiensi sumber-sumber ini tidak akan menjadi masalah.  Tegangan pasokan LDO2 dapat disesuaikan menggunakan sinyal LDO2_SETx. <br><br>  Karena saya masih memiliki pertanyaan terbuka mengenai tegangan suplai, saya memutuskan untuk memisahkan jumper untuk memilih mode LDO2_SETx.  Juga, untuk dapat mengukur konsumsi riil pada bus yang sesuai, saya juga akan menghubungkan jumper JP1 / JP2 / JP3 ke sisir. <br><br>  Menyelesaikan topik pasokan daya, kita perlu menyebutkan kekuatan tampilan.  Saya menulis sedikit lebih tinggi bahwa, atas nama kekompakan, saya harus meninggalkan modul display yang dibeli dan mengambil display dengan pengikat ke papan saya.  Layar ini memerlukan konverter boost 7-16V khusus.  Dengan mudah, sumber ini dapat dinyalakan dan dimatikan menggunakan sinyal EN.  Rangkaian itu sendiri disalin dari lembar data booster, persis sama digunakan dalam modul tampilan dengan ali. <br><br><img src="https://habrastorage.org/webt/oi/bd/zm/oibdzmvkie49fxcjamxcvszh9gw.png"><br><br><div class="spoiler">  <b class="spoiler_title">PT1505</b> <div class="spoiler_text">  Berselancar di Internet untuk mencari alternatif chip PT1502, saya bertemu kakak perempuannya - chip PT1505.  Ini hampir pengendali daya yang sama, tetapi dengan peningkatan tambahan.  Dengan pengontrol seperti itu, akan mungkin untuk mengurangi jumlah elemen di papan tulis.  Sayangnya, saya tidak menemukan chip PT1505 yang dijual. <br><br>  Ngomong-ngomong, saya akan berterima kasih jika Anda tahu pengendali daya yang sama dari produsen lain. <br></div></div><br>  Sekarang sedikit tentang kekuatan mikrokontroler.  Microcircuit berukuran besar dan memiliki 6 saluran listrik - 4 untuk bagian digital, 1 catu daya analog dan satu untuk jam.  Menurut datasheet pada STM32F103, pada semua saluran listrik (mungkin, kecuali jam), harus ada kapasitor 100nF di sepanjang kapasitor, dan satu lagi yang umum di 4.7uF. <br><br>  Tetapi dalam datasheet pada STM32F4 dikatakan bahwa meskipun mikrokontroler secara praktis kompatibel dalam hal output, mereka masih memiliki skema daya yang agak berbeda.  Jadi pada dua terminal harus ada kapasitor 2.2mkF antara terminal dan ground (dan bukan antara ground dan power, seperti pada F1).  Oleh karena itu, saya harus mempertimbangkan kedua opsi dan untuk mikrokontroler tertentu untuk menyolder hanya sebagian dari kapasitor. <br><br><img src="https://habrastorage.org/webt/vv/ai/a4/vvaia45dk-cjpdj9jrypfecczug.png"><br><br>  Melanjutkan topik nutrisi, Anda perlu memikirkan cara mengukurnya.  Anda dapat mengandalkan sinyal BAT_LOW dan meminta pengguna untuk segera meringkuk jika baterai lemah.  Tapi ini persis apa yang saya tidak suka di Holux M-241 yang asli, karena  sinyal ini muncul terlambat dan mudah dilewatkan.  Saya perlu semacam indikator daya baterai yang lebih informatif. <br><br><img src="https://habrastorage.org/webt/2r/6l/0g/2r6l0gd1bdyewq--m8zij_nugxs.png"><br><br>  Untuk jaga-jaga, saya meletakkan pembagi paling umum untuk mengukur tegangan baterai.  Tetapi dalam kasus baterai lithium, ini hanya indikator informatif dan tidak boleh diandalkan.  Untuk pembacaan baterai yang lebih jujur â€‹â€‹di Internet, mereka menyarankan menggunakan "liontin". <br><br><img src="https://habrastorage.org/webt/an/3u/nc/an3uncm2tjzd-pu3n6ns8vqnhz0.png"><br><br>  Microchip kecil ini menghitung jumlah energi yang telah melewatinya ke atau dari baterai.  Pengukuran dilakukan pada shunt R10.  Pembacaan dari rangkaian mikro dapat dibaca melalui I2C.  Microcircuit mampu mengukur tegangan pada baterai, arus yang melewati resistor, dan juga mengalikan satu dengan yang lainnya.  Sayangnya, dia tidak tahu bagaimana mengakumulasi nilai dari jam yang telah dilewati oleh Watt *, oleh karena itu dia harus melakukan survei yang konstan. <br><br>  Mari kita beralih ke bagian digital.  Jantung dari seluruh sistem adalah mikrokontroler STM32F103RB. <br><br><img src="https://habrastorage.org/webt/hm/ws/ma/hmwsma-hii28gwjrskmvmfsytl4.png"><br><br>  Pengikat dalam bentuk dua kuarsa diambil dari skema lain yang ditemukan di Internet (diperiksa ulang dalam datasheet).  Saya tidak perlu boot dari RAM, tetapi karena sinyal BOOT1 ditarik ke tanah.  BOOT0 dapat dipilih dengan jumper untuk boot dari memori flash utama atau bootloader UART bawaan (misalnya, untuk firmware utama perangkat) <br><br>  Berikutnya adalah LED. <br><br><img src="https://habrastorage.org/webt/ja/bg/ah/jabgahdeoppmxzipfiqu5mpd9dq.png"><br><br>  Karena tegangan suplai utama akan bervariasi dari 2 hingga 3.3V, LED seharusnya tidak terhubung - kecerahan dan konsumsi saat ini akan sangat bervariasi.  Oleh karena itu, LED I akan dihubungkan ke bus 2.7V, resistor pembatas arus dihitung sesuai.  Karena mikrokontroler tidak akan dapat memberikan lebih dari 2V saat berjalan dengan baterai, mode push-pull GPIO tidak dapat digunakan.  Hanya saluran pembuangan terbuka. <br><br>  Tidak ada yang istimewa untuk dikatakan tentang tombol reset. <br><br><img src="https://habrastorage.org/webt/6x/eq/is/6xeqise0ghoatscub44uzcykfoq.png"><br><br>  Karena perangkat tiga volt (INA219) akan berada di bus I2C, Anda juga perlu melakukan kurung hingga tiga volt <br><br><img src="https://habrastorage.org/webt/xj/yi/n7/xjyin76yz6g_sg7vo9t2s4eqrms.png"><br><br>  Konektor SWD juga standar.  Diperlukan dioda untuk mengalihkan daya antara baterai dan daya eksternal dari programmer. <br><br><img src="https://habrastorage.org/webt/vl/s7/pw/vls7pw9grlfznf3gfo1_yglclqw.png"><br><br>  Mengantisipasi seruan bahwa mereka tidak melakukan ini dan bahwa koneksi seperti itu tidak benar-benar melepaskan baterai.  Ya, itu tidak dimatikan, tetapi dioda bukan untuk ini.  Hal ini diperlukan untuk dapat memberi daya perangkat dari programmer jika baterai tidak terhubung.  Dan jika terhubung, maka biarkan bekerja darinya.  Nah, jika baterai terhubung, maka Anda perlu melindungi programmer itu sendiri dari 4.2V pada baterai. <br><br>  Tetapi tombol-tombolnya harus lebih detail. <br><br><img src="https://habrastorage.org/webt/gg/du/gi/ggdugivqqx7iqjimaqwkbsiehru.png"><br><br>  Faktanya adalah bahwa tombol pertama tidak hanya akan menjadi tombol, tetapi juga akan berfungsi sebagai saklar perangkat - sinyal BTN1 terhubung ke chip pengontrol daya PT1502.  Ketika perangkat dimatikan, daya tidak dipasok ke mikrokontroler dan konsumen lain.  Itulah sebabnya tombol terhubung bukan ke daya (VCC) tetapi ke baterai (BAT).  Dengan menekan tombol ini, PT1502 akan menyalakan semua sumber daya dan memulai mikrokontroler.  Setelah itu, tombolnya bisa berfungsi seperti tombol biasa.  Agar tidak membakar mikrokontroler dengan tegangan baterai yang tinggi, saya membuat pembagi tegangan kecil yang menggerakkan sinyal BTN1 ke dalam kerangka yang diperlukan (namun, dimungkinkan tanpa ini - mikrokontroler memiliki input yang toleran terhadap 5V) <br><br>  Tombol kedua tidak biasa.  Di dalam prosesor, tarikan ke tanah akan disertakan, dan tombol akan memberi makan unit ke garis ... <br><br>  Pindah mulus ke pinggiran yang berat.  USB <br><br><img src="https://habrastorage.org/webt/hj/vn/tg/hjvntgq_-3sjzwjv03t0dqd--gg.png"><br><br>  Konektor USB akan keluar dari perangkat, dan listrik statis dapat berjalan di sana.  Ternyata ada sirkuit mikro khusus (seperti STF202-22) yang melindungi mikrokontroler dari pengaruh eksternal. <br><br>  Tapi ada hal lain yang menarik di sini.  Sebuah resistor 1,5k tersembunyi di dalam chip STF202, yang terhubung antara kaki VBUS dan garis D +.  Resistor ini diperlukan sesuai dengan spesifikasi USB - ia memberi tahu host bahwa ia terjebak dalam sesuatu.  Di banyak sirkuit, resistor ini selalu terhubung antara daya dan garis D +.  Segera setelah tuan rumah melihat resistor seperti itu pada garis D +, ia segera mulai berkomunikasi dengan perangkat.  Ini tidak selalu tepat, karena  Beberapa perangkat mungkin tidak segera siap untuk komunikasi. <br><br>  Ini hanya kasus saya.  Ada trik sederhana untuk ini (memata-matai di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> ).  Anda dapat menghidupkan dan mematikan resistor ini dengan menggunakan transistor: kami ingin komunikasi - kami menghidupkan resistor, kami hanya ingin diberi daya oleh USB - matikan.  Ketika Anda memasukkan ponsel Anda ke USB, ia biasanya bertanya, â€œApa yang akan kami lakukan?  Penggabungan data atau sekadar pengisian daya? "  - Dalam hal elektronik, ini hanya tentang menghubungkan resistor pull-up. <br><br>  Tapi bagaimana Anda tahu jika perangkat macet di USB?  Untuk melakukan ini, saya memberikan sinyal USB_PLUGGED, yang dihapus dari pembagi paling sederhana. <br><br><img src="https://habrastorage.org/webt/hx/lr/u5/hxlru5qf7wv13uxeseybbyhhpdi.png"><br><br>  5V dari USB juga dapat diumpankan langsung ke kaki mikrokontroler - mereka masih toleran terhadap 5V.  Tapi biarlah sudah melalui pembagi. <br><br>  Akselerometer sekarang <br><br><img src="https://habrastorage.org/webt/-g/t1/5j/-gt15jf_cub3nubnrpsbr5hiusa.png"><br><br>  Skema ini diambil dari lembar data.  Modul terhubung melalui I2C, tetapi untuk memberi sinyal ke mikrokontroler bahwa ada berita, garis interupsi juga digunakan.  Juga, karena INA219 tiga volt masih tergantung pada bus I2C yang sama, kaki komunikasi accelerometer juga ditenagai dari bus 3B untuk mengoordinasikan level. <br><br>  Saya sudah menyebutkan bahwa saya ingin menghemat energi dan mematikan peralatan yang tidak digunakan.  Jadi daya accelerometer dihidupkan oleh transistor. <br><br>  Ngomong-ngomong, aku sangat menyukai apa yang disebut  transistor digital - transistor lengkap dengan dua resistor.  Ini menghemat sedikit ruang di papan tulis.  Sayang sekali bahwa dengan daya dua volt, saya tidak dapat mengambil transistor digital dengan setidaknya beberapa arus yang layak - maksimum 20-30 mA.  Jadi konsumen yang lebih rakus harus terhubung dengan MOSFET. <br><br>  Silakan GPS <br><br><img src="https://habrastorage.org/webt/vr/l-/hm/vrl-hm0a27os6lit3ont256xd1g.png"><br><br>  GPS terletak di papan terpisah dan terhubung melalui loopback.  Karena saya belum memutuskan modul GPS, saya menyediakan 2 catu daya berbeda.  Selain transistor daya di sisi papan prosesor, tidak ada yang lebih menarik. <br><br>  Saya hanya akan mengatakan beberapa kata tentang UART.  Awalnya, saya berencana untuk menggunakan semua 3 - satu untuk mengunggah firmware dan debug, yang kedua untuk GPS dan yang ketiga untuk Bluetooth.  Tetapi ternyata UART3 berada pada pin yang sama dengan I2C No. 2, yang awalnya saya rencanakan akan digunakan untuk tampilan.  Saya harus memilih.  Akibatnya, saya sampai pada kesimpulan bahwa saya dapat mengunggah firmware dan men-debug melalui UART yang sama yang disediakan untuk GPS (tentu saja, GPS harus dinonaktifkan).  Nah, jika Anda perlu melakukan debut GPS itu sendiri, yaitu, USB CDC (di mana Anda dapat mengunggah log) dan SWD.  Beberapa saat kemudian, saya meninggalkan ide untuk menggunakan I2C No. 2, jadi UART3 dibebaskan, tetapi atas nama penghematan baterai, saya memutuskan untuk fokus pada dua UART. <br><br>  Bluetooth <br><br><img src="https://habrastorage.org/webt/r2/m6/zt/r2m6ztztpabt1_2yprjrdava5nq.png"><br><br>  Bluetooth terhubung sesuai dengan skema dari lembar data.  Pin PIO1 dapat beroperasi dalam dua mode.  Pada yang pertama, LED terhubung dan modul berkedip dengan LED ini.  Kedipan mata yang berbeda berarti status yang berbeda.  Dalam mode lain, pin ini berfungsi sebagai digital - satu ketika komunikasi dibuat, dan 0 jika tidak.  Mode diaktifkan oleh perintah AT selama inisialisasi modul. <br><br>  Kartu SD <br><br>  Meskipun skema koneksi kartu SD adalah standar, untuk beberapa alasan itu sangat sulit bagi saya.  Ada terlalu banyak opsi koneksi yang berbeda di Internet dan tidak mudah untuk menentukan yang mana yang benar. <br><br><img src="https://habrastorage.org/webt/9g/mi/xh/9gmixhnhcfhlo0s98wcmfz1dubk.png"><br><br>  Sebagian besar, saya punya pertanyaan di bushing.  Kadang-kadang ada skema di mana mereka meletakkan resistor dalam 1k.  Beberapa sirkuit menempatkan 22 Ohm resistor, yang tampaknya sebagai perlindungan terhadap statis.  Namun demikian, sebagian besar sirkuit tidak menawarkan resistor pass-through, dan saya mungkin akan pergi dengan cara yang sama.  Saya juga tidak akan memiliki statika sejak itu  Flash drive akan hidup di dalam case. <br><br>  Transistor daya, menurut saya, tidak akan diminati juga, saya pikir kartu akan selalu berfungsi - itu adalah pencatat.  Tapi karena ini adalah papan tes, biarlah.  Hal yang sama tentang koil - rupanya penyertaan ini dalam aslinya dibuat paranoid, atau kartu itu digunakan di lingkungan dengan daya atau gangguan yang buruk.  Saya pikir untuk menyolder ada resistor nol dan mencoba tanpa koil. <br><br>  Tampilan <br><br>  Saya berkesempatan untuk menghubungkan salah satu modul tampilan dengan ali via SPI dan membandingkannya dengan koneksi via I2C.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak ada kesulitan khusus dan kode hanya perlu sedikit terbuang. Pada saat yang sama, kecepatan SPI adalah urutan besarnya lebih tinggi dari I2C. Setelah menambahkan data dari lembar data tentang konsumsi (4 mA untuk SPI versus 10 mA untuk I2C), kebutuhan untuk resistor pull-up untuk I2C, saya memutuskan untuk menghubungkan layar melalui SPI. </font></font><br><br><img src="https://habrastorage.org/webt/zn/zx/yh/znzxyhs4tcmv4fyyhb-hfxzihns.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sayangnya, sinyal BS0 tidak di-output ke loop tampilan, dan karena itu Anda tidak dapat memilih mode 3-kawat SPI, Anda hanya dapat 4-kawat SPI. Perbedaan dalam garis D / C tambahan (data / perintah), yang dalam kasus mode 3-kawat ditransmisikan oleh bit kesembilan dari data SPI. Namun, mungkin mode 4-Wire lebih baik, karena SPI di STM32 hanya dapat mengirimkan 8 bit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skema lainnya sesuai dengan lembar data. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan akhirnya, pembuat squeaker. Tidak ada yang istimewa - cukup hidupkan melalui transistor.</font></font><br><br><img src="https://habrastorage.org/webt/b9/nk/9u/b9nk9uzbod6oeswokssk4nhfvsq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kalau-kalau akan ada vibromotor bukan tweeter, saya memberikan dioda pelindung. </font><font style="vertical-align: inherit;">Namun, saya mendengar pendapat bahwa dioda pelindung juga tidak melukai tweeter.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dalam besi </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di atas, saya menggambarkan pikiran saya tentang masalah korps. Bahkan, saya bahkan mencoba membuat papan untuk kasus ini. Sayangnya, papan itu terlalu sempit. Saya harus menggunakan instalasi dua sisi, beralih dari komponen 1206 ke 0805, tetapi semua sama, komponen di papan sangat ketat. Selain itu, setiap perubahan dalam skema itu menyusahkan, karena Saya harus mengembangbiakkan kembali hampir setengah papan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jadi saya mengutak-atiknya selama beberapa minggu, tetapi dewan mengalahkan saya dan saya meninggalkan proyek selama hampir setahun. Tendangan menjadi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini artikel ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tapi sungguh, ini hanya prototipe, dan yang pertama dari beberapa. Mengapa repot-repot dengan papan yang sangat ringkas, di mana Anda tidak bisa merangkak dengan solder atau osiloskop, jika Anda bisa men-debug semuanya di papan besar?</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nah, Anda tidak perlu membuat papan besar seperti iPhone, tetapi sangat mungkin untuk masuk ke JLCPCB 2 layer 100x100mm promosi. </font><font style="vertical-align: inherit;">Anda bisa membatasi diri sendiri. </font><font style="vertical-align: inherit;">Jadi di papan adalah layar 2,42 "besar, jumper untuk mengukur konsumsi di semua saluran listrik, kapasitor daya di mana Anda perlu dan tidak perlu, dan secara umum banyak bagian yang tidak dapat dipasang. </font><font style="vertical-align: inherit;">Masih ada tempat tersisa.</font></font><br><br><img src="https://habrastorage.org/webt/nm/ig/vr/nmigvrrichuyvfy4vddfogpnquu.png"><br><br><img src="https://habrastorage.org/webt/sr/cy/ed/srcyeditmbixylghywsn15j-qas.png"><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada di Photo View</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/d-/co/ru/d-coru_uwsrkpvz44tirfmisedg.png"><br><br><img src="https://habrastorage.org/webt/5w/pq/xk/5wpqxktdsgqt1auvgeh4wnhbaz4.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak ada banyak yang bisa diceritakan tentang pemasangan kabel. Saya memisah sebagian besar sinyal dan garis medan di sepanjang lapisan atas, sedangkan yang lebih rendah hampir sepenuhnya terkubur di bawah tanah. Sayangnya, tata letaknya masih cukup padat dan beberapa garis sinyal harus diseret sepanjang lapisan bawah melalui setengah papan. Karena itu, tanah itu "robek" di beberapa tempat menjadi beberapa pulau yang terhubung secara longgar. Saya harap ini bukan masalah. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya tidak melakukan pembumian di bawah antena bluetooth, tetapi saya masih harus menyeret salah satu jalur sinyal melalui zona ini. Namun, ini adalah garis BT_ON, di mana sinyal sering tidak berjalan (baik dinyalakan atau dimatikan di sana), yang berarti bahwa itu seharusnya tidak mempengaruhi sinyal secara khusus.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Musim panas akan datang dan aku berencana untuk mengambil sewa bersamaku untuk berlibur. Agar pelayan di hotel tidak takut papan debugging telanjang dengan kipas kabel, alangkah baiknya menyembunyikannya di kasing. Saya tidak bisa menyangkal kesenangan diri dan mengembangkan kasing dan papan pada saat yang sama. Jadi ada papan pemasangan dalam kasing, yang memasang dudukan layar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modul GPS adalah sandwich dari beberapa papan dan antena setebal 12 mm. Saya memutuskan untuk tidak mengaitkannya di atas papan, tetapi menempatkannya di tingkat yang sama. Ini mengurangi ketebalan kasing, tetapi menggigit salah satu sudut papan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa foto papan dan perangkat final (pada tahap proyek ini). </font></font><br><br><img src="https://habrastorage.org/webt/sr/yk/-g/sryk-gs6dpsw3cjk4mx7fhj4khw.jpeg"><br><br><img src="https://habrastorage.org/webt/i7/hm/im/i7hmimruqywcfpkw9q5qudxkyog.jpeg"><br><br><img src="https://habrastorage.org/webt/r_/wo/bj/r_wobjeewfmg8fohrp_nmehi1c4.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baterai cocok di bawah layar, tetapi saya harus membuat kotak kecil untuk menaikkan layar lebih dekat ke penutup atas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa kata di papan perakitan. Saya menyolder semuanya dalam waktu sekitar 3 malam, dan sekitar satu minggu di malam hari saya perlu santai untuk debug dan memeriksa dari sisi perangkat lunak. Yang mengejutkan saya, tidak ada kesulitan mendasar dengan memasang papan dan hampir semuanya dimulai sebagaimana mestinya. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ternyata menyolder 0805 tidak lebih sulit untuk disolder daripada 1206, cukup bisa dimakan di rumah dengan kaca pembesar. Anda bahkan dapat mengayun di 0603. Tetapi dengan menyolder mikrokontroler dan konektor display (mereka memiliki pitch 0,5 mm), saya harus mengotak-atik. Di YouTube, entah bagaimana itu hanya terlihat seperti orang - saya hanya menghabiskannya dengan besi solder dan hanya itu, tetapi semua kesimpulan saya macet seketika.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bukan tanpa masalah kecil. Di beberapa tempat tidak ada minum, di suatu tempat ada "ingus". Jejak untuk konektor USB ternyata salah - ia memiliki langkah kesimpulan yang kurang dari yang diperlukan (jadi percaya setelah itu jejak kaki dari Internet!). Saya harus sedikit membengkokkan kesimpulan sehingga mereka menjadi di jalur. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konektor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> display </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">FPC yang</font></a><font style="vertical-align: inherit;"> dibeli pada Ali ternyata dengan kontak di bawah ini, sedangkan saya perlu dengan kontak di atas (saya tidak menduga perbedaan seperti sebelumnya). Saya harus "mematikan" konektor dari papan display standar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setelah memasukkan papan ke dalam kasing, ternyata tidak memungkinkan untuk melepas baterai hanya dengan menarik konektor, tetapi saya tidak ingin membiarkan papan yang sudah diberi energi menyala. Saya harus menyodok saklar.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saat memasang papan, ternyata tidak ada kontak ground di mana pun Anda bisa menempelkan probe ke osiloskop. Saya harus berpegang teguh pada konektor USB dengan buaya. Penting untuk menyediakan situs uji dalam versi papan berikutnya. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sirkuit juga mengungkapkan masalah. Jadi itu adalah fakta yang sama sekali tidak terduga bahwa chip PT1502 pada pin RESET menghasilkan tegangan 3V (saya benar-benar yakin bahwa ada sesuatu seperti kolektor terbuka). Akibatnya, 3V ini bocor ke saluran listrik, meskipun saya berencana untuk hanya 2V di sana. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berikut adalah diagram yang disederhanakan dari apa yang terjadi. </font></font><br><img src="https://habrastorage.org/webt/ag/rw/tg/agrwtgjika-hvgzl_die2gokf4c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berkat pemikiran hebat dan orang-orang dengan easyelectronics.ru, gabungan ini diputuskan dengan menambahkan satu dioda. Setelah sedikit operasi, bagian ini berfungsi sebagaimana mestinya.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selanjutnya, modul bluetooth (ditenagai 2.5V) saya tidak sengaja terhubung ke daya utama (2V), bukannya 3V yang diperbaiki. Sekarang bluetooth hanya dapat bekerja untuk saya ketika USB terhubung, ketika tegangan daya utama naik ke 3.3V. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada prinsipnya, akan mungkin untuk melambaikan pisau bedah dan solder bluetooth ke kekuatan yang benar, tetapi UART2 yang terhubung bluetooth tidak toleran terhadap 5V (dia sendiri membacanya di lembar data pada tahap analisis, dia sendiri mencatat ini dalam teks di atas, dan akhirnya lupa ketika memasang papan di papan tulis ) Oleh karena itu, menghubungkan bluetooth ke daya lebih tinggi daripada kekuatan mikrokontroler penuh ... Di versi papan berikutnya, saya hanya menghubungkan bluetooth ke beberapa UART lainnya.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konverter DC-DC dengan tegangan variabel juga berfungsi seperti yang direncanakan - ketika ditenagai oleh baterai, ia mengeluarkan 2V, dan ketika Anda menghubungkan USB naik menjadi 3.16V (Anda perlu bermain-main dengan peringkat dan mencapai 3,3V). Tapi di sini satu lagi cacat dari sirkuit keluar: Anda juga harus dapat menaikkan tegangan saat ditenagai oleh programmer. Saya pikir ini sedang dirawat dengan menambahkan dioda lain. Saya akan mencoba bermain sedikit nanti.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akhirnya, selama bekerja di papan tulis, saya masih tidak mengerti bagaimana cara memberi daya dengan benar kartu SD dari undervoltage. Googling singkat tidak menghasilkan apa-apa. Rupanya, Anda perlu membenamkan diri dalam membaca spesifikasi halaman ketat (yang, selain itu, sebagian ditutup). Sementara itu, saya hubung singkat R7 dan papan sekarang didukung oleh 3.16V tetap (3.3V). Saya akan membiarkannya seperti ini selama beberapa bulan ke depan, sementara saya akan mengerjakan bagian perangkat lunak. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berbicara tentang perangkat lunak. Anehnya (walaupun cukup diharapkan), tetapi secara umum semuanya dimulai tanpa masalah. Karena saya beralih di antara mikrokontroler dari seri yang sama (dari F103CB ke F103RC), saya tidak perlu mengubah bagian perangkat lunak. Hanya mengoreksi nomor pin, tetapi menambahkan penyertaan transistor. Namun demikian, ada 2 momen non-sepele yang harus saya pikirkan.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yang pertama adalah daya baterai. </font><font style="vertical-align: inherit;">Saya men-debug papan menggunakan daya USB dan semuanya bekerja dengan baik pada umumnya. </font><font style="vertical-align: inherit;">Tetapi papan terus-menerus tidak mau menyalakan baterai.</font></font> Yaitu<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini bisa bekerja (jika Anda menyalakannya ketika USB terhubung, dan kemudian mencabut kabelnya), tetapi itu tidak bekerja untuk memulai yang dingin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menurut desain chip PT1502, papan harus mulai seperti ini. </font><font style="vertical-align: inherit;">Pengguna menekan tombol BTN1 dan setelah sepertiga detik, chip akan menyalakan semua sumber daya. </font><font style="vertical-align: inherit;">Ketika semuanya baik-baik saja dengan daya, PT1502 "melepaskan" sinyal RESET, dengan demikian memulai mikrokontroler. </font><font style="vertical-align: inherit;">Prosesor, pada gilirannya, mengatur sinyal PWR_HOLD menjadi satu, menandakan bahwa ia sudah dimulai. </font><font style="vertical-align: inherit;">Setelah itu, PT1502 secara teratur memasok listrik ke sirkuit hingga mikrokontroler menurunkan sinyal PWR_HOLD ke nol.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tapi ini dalam teori. Bahkan, begitu prosesor mengatur sinyal PWR_HOLD, papan mati secara instan. Saya menyekop seluruh rangkaian daya, melihat bentuk gelombang dari sinyal utama, mengocok kode dalam bootloader bolak-balik, tetapi saya tidak dapat memahami masalahnya. Saya juga berdosa karena tidak adanya resistor pull-down pada garis PWR_HOLD, yang saya lupa instal, tetapi direkomendasikan oleh datasheet (dan kemungkinan besar masih diperlukan). Namun menambahkannya dengan kanopi tidak menyelesaikan masalah. Dan hanya ketika saya meminjamkan osiloskop empat saluran, segalanya menjadi jelas.</font></font><br><br><img src="https://habrastorage.org/webt/ix/ie/xf/ixiexf-lau1vggfbwu9ta4ys_hq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ketika pengguna menekan tombol (garis oranye), chip PT1502 menyalakan daya (garis ungu). Semua ini terjadi lama (300 ms) sebelum peristiwa pada gelombang ini. Dan kemudian sesuatu yang menarik terjadi. PT1502 melepaskan RESET (garis biru), prosesor dimulai dan karena alasan tertentu menurunkan garis tombol ke nol. Meskipun mikrokontroler masih mencoba untuk meningkatkan garis POWER_HOLD (garis hijau) - sudah terlambat, PT1502 telah mematikan semua sumber daya. Lalu ada beberapa kejang lagi, tetapi sirkuit masih mati dengan tenang. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pertanyaannya adalah, dari mana asal nol tombol itu? Intinya adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kesalahan yang tidak mencolok pada bootloader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , karena kaki BTN1 diatur ke mode keluaran (mungkin keajaiban juga terjadi pada kaki lain pada saat itu) dan sinyal rendah muncul di sana.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa lagi yang harus digeluti adalah kartu SD. Tidak ada modul SDIO di mikrokontroler lama, jadi saya harus mempelajari bagian ini dari awal. Saya menghabiskan hampir sepanjang hari mencoba untuk mendapatkan peta, menyalin potongan kode dari contoh-contoh di Internet, dan apa yang dihasilkan CubeMX. Meskipun kartu itu dapat dibaca dengan sempurna di komputer, kartu itu tidak mau memulai di sirkuit saya. Saya berdosa karena penyolderan yang buruk, resistor pull-up yang tidak dipilih dengan benar, sirkuit yang canggung dan lembar data yang diinterpretasikan secara tidak benar. Tapi yang mengejutkan saya, kartu lain dengan kode yang sama dan di papan yang sama dimulai tanpa masalah. Penting untuk mempelajari masalah ini secara lebih rinci.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada masalah lain dengan kartu itu. Menyodok dalam garis yang berbeda dengan osiloskop, saya melihat aktivitas hanya pada garis D0, sedangkan pada D1-D3 ada keheningan - kartu bekerja dalam mode single-bit. Di HAL, bahkan fungsi HAL_SD_ConfigWideBusOperation () ditemukan, yang dapat mengaktifkan mode transfer 4-bit. Sayangnya, ketika kartu dialihkan ke mode 4-bit, perangkat SDIO masuk ke RX FIFO Overrun yang dalam dan berhenti bekerja.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalahnya ternyata sangat menarik. </font><font style="vertical-align: inherit;">Ternyata di dalam fungsi HAL_SD_ReadBlocks () ada loop tertentu yang menyurvei bendera SDIO. </font><font style="vertical-align: inherit;">Ketika data baru datang dari kartu, kode ini mentransfer byte dari buffer FIFO internal ke memori pengguna. </font><font style="vertical-align: inherit;">Jadi kartu mengirimkan byte begitu cepat sehingga kode di HAL_SD_ReadBlocks () tidak punya waktu untuk mentransfer data. </font><font style="vertical-align: inherit;">Saya harus menurunkan sementara frekuensi clock kartu. </font><font style="vertical-align: inherit;">Nah, di masa depan saya akan menggunakan DMA dan masalah seperti itu seharusnya tidak muncul secara prinsip.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kesimpulan dan langkah selanjutnya </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mereka yang di tempat ini berharap melihat perangkat yang sudah selesai saya harus mengecewakan - hanya papan tes selesai, dan bahkan itu, hanya potongan besi. Sekarang Anda perlu menghirup kehidupan, lakukan pemrograman, sesuaikan mode dan konsumsi. Sebenarnya, tulislah kode logging - itu sebabnya seluruh proyek dimulai. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Namun demikian, bagi saya pribadi tahap ini adalah pencapaian yang sangat besar dan penting. Elektronik bukan spesialisasi saya dan saya sangat senang bahwa perangkat bahkan mulai hidup. Saya berhasil memompa cukup banyak dalam merancang sirkuit, mencocokkan beberapa perangkat, memasang kabel papan, memilih komponen dan banyak lagi.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya akan berbicara tentang bagian perangkat lunak di lain waktu. </font><font style="vertical-align: inherit;">Serta tentang nuansa pengaturan. </font><font style="vertical-align: inherit;">Faktanya adalah seluruh isi ini harus dihidupkan kembali dan diuji terlebih dahulu. </font><font style="vertical-align: inherit;">Saat ini, kami berhasil memulai semua perangkat di papan tulis (yah, kecuali untuk tweeter), tetapi hanya dalam jumlah "itu mulai dan entah bagaimana merespons". </font><font style="vertical-align: inherit;">Belum ada logika pemrosesan yang ditulis. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paket untuk waktu dekat:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kendarai elektronik dalam mode berbeda, periksa apakah sirkuit masih berfungsi. </font><font style="vertical-align: inherit;">Memperbaiki kusen di versi kedua papan</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ukur konsumsi seluruh pinggiran dan temukan cara untuk mengoptimalkan konsumsi. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pasang beberapa opsi papan pada mikrokontroler yang berbeda (mis. L152 atau L433) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Baca dengan seksama spesifikasi SD dan cari tahu cara menghubungkan kartu dengan benar dalam mode pensinyalan Tegangan Rendah (1.8V) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Coba berbagai modul GPS dan akhirnya putuskan mana yang akan saya ikuti selanjutnya </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pesanlah kompas chip yang terpisah (misalnya, HMC5883L atau HSCDTD008A) dan cobalah untuk menggunakannya entah bagaimana </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Buat refactoring kode internal, perbarui semua perpustakaan utama, dimulai dengan HAL </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akhirnya, mulailah menulis fitur. </font><font style="vertical-align: inherit;">Sebenarnya mengimplementasikan untuk apa perangkat itu dimaksudkan</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengenai hal ini, izinkan saya untuk pergi. </font><font style="vertical-align: inherit;">Saya akan berterima kasih atas komentar, ide, dan saran yang membangun tentang desain sirkuit dan tata letak papan sirkuit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sumber: </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kode bootloader </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plata </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perumahan</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id454434/">https://habr.com/ru/post/id454434/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id454424/index.html">5 kesalahan umum saat menggunakan komponen arsitektur Android</a></li>
<li><a href="../id454426/index.html">Artifisial: pada awal kecerdasan buatan</a></li>
<li><a href="../id454428/index.html">Apa yang Diperkenalkan Apple di WWDC dan Apa yang Dipikirkan Pengembang iOS tentangnya</a></li>
<li><a href="../id454430/index.html">Kehidupan Partikel 3D</a></li>
<li><a href="../id454432/index.html">Menghibur Arkeologi: Panduan Gaya R Di Bawah Kaca Pembesar</a></li>
<li><a href="../id454436/index.html">Petty Petty Joy # 1: loguru</a></li>
<li><a href="../id454440/index.html">Petty Little Fun # 2: Starlette</a></li>
<li><a href="../id454442/index.html">Cara memilih jaringan proxy untuk bisnis Anda: 3 tips praktis</a></li>
<li><a href="../id454444/index.html">Kami memuat profil Habr atau bagaimana 189 permintaan pada halaman memberikan pengaruh</a></li>
<li><a href="../id454446/index.html">Apa yang baru di C # 8?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>