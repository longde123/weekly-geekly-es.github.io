<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¶ üî© üë©üèª‚Äç‚úàÔ∏è Hist√≥ria de natal üèì üì∑ üë©‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Queremos compartilhar a hist√≥ria que aconteceu em um de nossos projetos para o Ano Novo. A ess√™ncia do projeto √© que ele automatize o trabalho dos m√©d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hist√≥ria de natal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/432998/">  Queremos compartilhar a hist√≥ria que aconteceu em um de nossos projetos para o Ano Novo.  A ess√™ncia do projeto √© que ele automatize o trabalho dos m√©dicos em institui√ß√µes m√©dicas.  Durante a visita do paciente, o m√©dico grava informa√ß√µes no gravador e o √°udio √© transcrito.  Ap√≥s o processo de transcri√ß√£o - ou seja,  transformando a grava√ß√£o de √°udio em texto - um documento m√©dico √© formado de acordo com os padr√µes relevantes e enviado de volta √† cl√≠nica, de onde veio a grava√ß√£o de √°udio, de onde o m√©dico que a envia recebe, verifica e aprova.  Ap√≥s passar nas verifica√ß√µes obrigat√≥rias, o documento √© enviado aos pacientes finais. <br><a name="habracut"></a><br>  Todas as institui√ß√µes m√©dicas que usam o produto podem ser divididas condicionalmente em dois grandes grupos: <br><br><ul><li>  Hospedagem no data center de nosso cliente, que √© totalmente respons√°vel pela funcionalidade do aplicativo, tanto por software quanto por hardware.  Por exemplo, se o espa√ßo em disco acabar ou se n√£o houver desempenho suficiente do servidor na CPU; </li><li>  Auto-hospedado: eles colocam todos os equipamentos diretamente em casa e s√£o respons√°veis ‚Äã‚Äãpor seu desempenho.  Nosso cliente fornece o aplicativo e seu suporte. </li></ul><br>  √â assim que nossa equipe interage com servidores finais hospedados diretamente na nuvem de nossos clientes. <br><br><img src="https://habrastorage.org/webt/fu/dh/qb/fudhqbrny8p_r3wcs4swokhglqw.png"><br><br>  Temos acesso a esses servidores para realizar todo o trabalho e manuten√ß√£o programados necess√°rios. <br><br>  O segundo grupo - clientes auto-hospedados - para eles, a nuvem do cliente atua como um gateway atrav√©s do qual nos conectamos a esses servidores.  Nesse caso, temos direitos limitados, geralmente n√£o podemos executar nenhuma opera√ß√£o devido a configura√ß√µes de seguran√ßa.  N√≥s nos conectamos aos servidores atrav√©s do RDP, o Remote Desktop Protocol no Windows OS.  Naturalmente, tudo isso funciona atrav√©s de uma VPN. <br><br>  Deve-se ter em mente que cada servidor representado no diagrama √© realmente uma combina√ß√£o de um servidor de aplicativos e um servidor de banco de dados.  O DBMS MS SQL Server e o servi√ßo de relat√≥rio SSRS s√£o instalados no servidor de banco de dados, respectivamente.  Al√©m disso, a vers√£o do MSSQL Server √© diferente em todas as cl√≠nicas: 2008, 2012, 2014. Al√©m das pr√≥prias vers√µes, diferentes Service Packs e patches est√£o instalados em todos os lugares.  Em geral, um zool√≥gico completo. <br><br>  No servidor de aplicativos, instalamos o servidor Web IIS e ElasticSearch.  O ElasticSearch √© um mecanismo de pesquisa que tamb√©m implementa a pesquisa de texto completo. <br>  A principal ess√™ncia em termos de nosso produto √© "trabalho".  O trabalho √© uma entidade abstrata que vincula todas as informa√ß√µes relacionadas √† recep√ß√£o de um paciente em particular.  Esta informa√ß√£o inclui: <br><br><ul><li>  dados sobre o m√©dico; </li><li>  dados do paciente; </li><li>  dados sobre a visita; </li><li>  arquivo de √°udio (discurso do m√©dico); </li><li>  documentos (v√°rias vers√µes); </li><li>  hist√≥rico de processamento do trabalho; </li><li>  informa√ß√µes da filial etc. </li></ul><br>  Este diagrama mostra um esquema de banco de dados simplificado a partir do qual voc√™ pode ver os relacionamentos entre as tabelas principais.  Esta √© apenas a parte b√°sica; de fato, o banco de dados possui mais de 200 tabelas. <br><br><img src="https://habrastorage.org/webt/sc/ke/hl/sckehlss-czi3bz2kagmfecrroy.png"><br><br>  Um pouco sobre a cl√≠nica onde o incidente aconteceu: <br><br><ul><li>  1500-2000 obras por dia; </li><li>  1000 usu√°rios ativos (m√©dicos + secret√°rias); </li><li>  Auto-hospedado. </li></ul><br>  DB: <br><br><ul><li>  Tamanho: 800+ Gb (750K + trabalhos, 2M + documentos); </li><li>  DBMS: MS SQL Server 2008 R2; </li><li>  Modelo de recupera√ß√£o: simples. </li></ul><br>  Aqui eu quero fazer uma pequena explica√ß√£o.  Existem tr√™s modelos de recupera√ß√£o no SQL Server: simples, com logon em massa e completos.  N√£o vou falar sobre o terceiro agora, vou explicar sobre o primeiro e o segundo.  A principal diferen√ßa √© que, no modelo simples, n√£o armazenamos o hist√≥rico de transa√ß√µes no log - assim que a transa√ß√£o for confirmada, o registro do log de transa√ß√µes ser√° exclu√≠do.  Ao usar o modo de recupera√ß√£o total, todo o hist√≥rico de altera√ß√µes de dados √© armazenado em um log de transa√ß√µes.  O que isso nos d√°?  No caso de alguma situa√ß√£o imprevista, quando precisamos reverter o banco de dados a partir de backups, podemos retornar n√£o apenas a um backup espec√≠fico, mas tamb√©m a qualquer momento, at√© uma transa√ß√£o espec√≠fica, ou seja, armazenamos em backups, n√£o apenas um determinado estado do banco de dados no momento do backup, mas tamb√©m h√° todo um hist√≥rico de altera√ß√µes de dados. <br><br>  Acho que n√£o vale a pena explicar que o modo simples √© usado apenas no desenvolvimento, nos servidores de teste e seu uso na produ√ß√£o √© inaceit√°vel.  De jeito nenhum. <br><br>  Mas a cl√≠nica, aparentemente, tinha seus pr√≥prios pensamentos sobre esse assunto;) <br><br><h3>  Iniciar </h3><br>  Alguns dias depois do Ano Novo, todos est√£o se preparando para o feriado, comprando presentes, decorando √°rvores de Natal, passando festas corporativas e aguardando um longo fim de semana. <br><br><h6>  22 de dezembro (sexta-feira) 1 dia </h6><br>  <strong>14:31</strong> O cliente disse que n√£o recebeu o pr√≥ximo relat√≥rio di√°rio.  O relat√≥rio chega pelo correio duas vezes por dia em uma programa√ß√£o; √© necess√°rio controlar o envio de dados para um sistema de integra√ß√£o externo, o que n√£o √© muito cr√≠tico. <br><br>  Pode haver v√°rios motivos: <br><br><ol><li>  Problemas com SMTP, as cartas n√£o foram entregues (elas mudaram a senha, por exemplo, e n√£o disseram a ningu√©m); </li><li>  Problemas no lado do servidor dos relat√≥rios; </li><li>  Algo aconteceu com o banco de dados. </li></ol><br>  <strong>16:03</strong> √Äs vezes, a cl√≠nica altera a senha para SMTP, sem avisar ningu√©m, portanto, ap√≥s concluir as tarefas atuais, verificamos o relat√≥rio com calma manualmente, iniciando pela interface da web - recebemos um erro que indica problemas no banco de dados. <br><br>  Um exemplo do erro que recebemos ao iniciar o relat√≥rio. <br><br><pre><code class="plaintext hljs">SQL Server detected a logical consistency-based I/O error: incorrect checksum (expected: 0x9876641f; actual: 0xa3255fbf). It occurred during a read of page (1:876) in database ID 7 at offset 0x000000006d8000 in file 'D:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA\ServerLive.mdf'.</code> </pre> <br>  Isso indica que o banco de dados possui p√°ginas corrompidas.  Tivemos uma leve sensa√ß√£o de ansiedade. <br><br>  <strong>20:53</strong> Para avaliar a extens√£o do dano, executamos uma verifica√ß√£o do banco de dados usando o comando <strong><em>DBCC CHECKDB</em></strong> especial.  Dependendo do tamanho do dano, o comando test pode demorar um pouco, ent√£o executamos o comando √† noite.  Aqui temos a sorte de ter acontecido na tarde de sexta-feira, ou seja, tivemos pelo menos todos os dias de folga para resolver esse problema. <br><br>  Nesse momento, a situa√ß√£o era a seguinte: <br><br><img src="https://habrastorage.org/webt/dp/nq/jm/dpnqjm7rvkmtjtxoc534js439zq.png"><br><br><h6>  23 de dezembro (s√°bado) 2¬∫ dia </h6><br>  <strong>10:02</strong> De manh√£, descobrimos que a verifica√ß√£o do banco de dados com o CHECKDB √© flex√≠vel - isso ocorreu devido √† falta de espa√ßo livre em disco, porque  durante o processo de verifica√ß√£o, o banco de dados tempor√°rio do tempdb √© usado ativamente e, em algum momento, o espa√ßo livre em disco acabou. <br><br>  Portanto, decidimos, em vez de verificar o banco de dados inteiro, iniciar imediatamente uma varredura de tabela.  Para fazer isso, use o <strong><em>comando DBCC CHECKTABLE</em></strong> . <br><br>  <strong>10:46</strong> Decidimos come√ßar com a tabela JobHistory, que provavelmente est√° corrompida, pois foi usada para gerar o relat√≥rio.  Esta tabela, como o nome indica, preserva o hist√≥rico de todas as obras, ou seja, transi√ß√µes de trabalho entre etapas. <br><br>  Execute <strong><em>DBCC CHECKTABLE ('dbo.JobHistory')</em></strong> . <br><br>  A verifica√ß√£o dessa tabela revela tabelas danificadas no banco de dados, o que era esperado em princ√≠pio. <br><br>  <strong>12:00</strong> No momento, se o banco de dados usasse o modelo de recupera√ß√£o completo, poder√≠amos restaurar as p√°ginas danificadas do backup, e isso terminaria, mas nosso banco de dados estava no modo simples.  Portanto, a √∫nica op√ß√£o para reparar danos continua sendo o lan√ßamento do mesmo comando com o par√¢metro especial <strong><em>REPAIR_ALLOW_DATA_LOSS</em></strong> .  Isso pode resultar em perda de dados. <br><br>  Come√ßamos.  A verifica√ß√£o termina novamente com um erro - obtemos um erro de que a restaura√ß√£o desta tabela √© imposs√≠vel at√© que as tabelas relacionadas sejam restauradas.  A tabela de hist√≥rico refere-se √† tabela de trabalho (Jobs) pela chave estrangeira, portanto, conclu√≠mos que tamb√©m h√° danos na tabela de trabalho principal (Jobs). <br><br>  <strong>13:30</strong> O pr√≥ximo passo √© verificar a tabela Jobs, ao mesmo tempo - esperamos que o dano esteja no √≠ndice e n√£o nos dados.  Nesse caso, ser√° suficiente reconstruir o √≠ndice para recupera√ß√£o de dados. <br><br>  <strong>17:33</strong> Depois de um tempo, descobrimos que nosso servidor n√£o est√° dispon√≠vel via RDP.  Provavelmente foi desativado, a verifica√ß√£o n√£o foi conclu√≠da, o trabalho foi suspenso.  Informamos √† cl√≠nica que o servidor n√£o est√° dispon√≠vel, por favor, aumente. <br><br>  A ansiedade leve assume formas muito espec√≠ficas. <br><br><h6>  24 de dezembro (domingo) 3¬∫ dia </h6><br>  <strong>14:31</strong> Mais perto do jantar, o servidor √© criado, reexecutamos a verifica√ß√£o da tabela Jobs. <br>  <strong><em>DBCC CHECKTABLE ('dbo.Jobs')</em></strong> <br><br>  <strong>16:05 A</strong> verifica√ß√£o n√£o foi conclu√≠da, o servidor n√£o est√° dispon√≠vel.  Novamente. <br><br>  Depois de algum tempo, o servidor n√£o est√° dispon√≠vel novamente, antes de concluirmos a verifica√ß√£o da tabela.  Nesse ponto, o servi√ßo de TI da cl√≠nica realiza uma s√©rie de verifica√ß√µes no servidor.  Estamos aguardando a conclus√£o do trabalho. <br><br>  Devido aos feriados, a comunica√ß√£o entre n√≥s e o cliente era lenta - esper√°vamos respostas √†s perguntas por v√°rias horas. <br><br><h6>  25 de dezembro (segunda-feira - Natal) 4¬∫ dia </h6><br>  <strong>16:00</strong> No dia seguinte, o servidor foi criado, o cliente tem Natal e novamente come√ßamos a verificar a tabela, mas desta vez exclu√≠mos os √≠ndices da verifica√ß√£o e deixamos apenas a verifica√ß√£o de dados.  E depois de algum tempo, o servidor n√£o est√° dispon√≠vel novamente. <br><br>  O que est√° havendo? <br><br>  Nesse momento, come√ßam a surgir pensamentos de que isso n√£o √© apenas uma coincid√™ncia, e h√° uma suspeita de que possa haver danos no n√≠vel do ferro (um disco r√≠gido caiu).  Assumimos que existem setores defeituosos no disco e, quando a verifica√ß√£o tenta ler dados desses setores, o sistema trava.  Informamos nosso cliente sobre nossa suposi√ß√£o. <br><br>  O cliente executa uma verifica√ß√£o de disco na m√°quina host. <br><br>  <strong>17:19</strong> O servi√ßo de TI da cl√≠nica informou que o arquivo da m√°quina virtual est√° danificado - isso √© ruim! <br>  Ainda n√£o podemos trabalhar e aguardamos um sinal quando eles resolverem o problema e podemos continuar nosso trabalho. <br><br><h6>  26 de dezembro (ter√ßa-feira) Dia 5 </h6><br>  <strong>14:05</strong> O servi√ßo de cl√≠nica de TI inicia outro processo de recupera√ß√£o de disco.  Fomos informados de que podemos executar CHECKTABLE em paralelo para verificar a tabela.  Iniciamos o teste novamente - a m√°quina virtual trava novamente, informamos ao cliente que o arquivo da m√°quina virtual ainda est√° corrompido. <br><br>  Hoje em dia, todas as comunica√ß√µes com o cliente s√£o muito lentas, com um grande atraso devido aos feriados. <br><br><h6>  27 de dezembro (quarta-feira) Dia 6 </h6><br>  <strong>14:00</strong> Iniciamos a verifica√ß√£o do disco usando o Windows - disco de verifica√ß√£o dentro da m√°quina virtual - nenhum problema foi detectado. <br>  O banco de dados est√° no modo Simples, portanto, as chances de corrigir o banco de dados atual com as ferramentas DBMS tendem a zero, porque  n√£o podemos recuperar p√°ginas danificadas individuais. <br>  Estamos come√ßando a considerar a op√ß√£o de reverter e restaurar o banco de dados a partir do backup. <br>  Verificamos os backups do banco de dados e descobrimos que os backups n√£o foram feitos usando o DBMS, o √∫ltimo backup foi em 2014, ou seja,  N√£o h√° backups do banco de dados.  Por que eles n√£o fizeram isso, √© uma quest√£o separada, √© responsabilidade da cl√≠nica garantir a efici√™ncia e a seguran√ßa do banco de dados. <br><br>  H√° uma alta probabilidade de que n√£o funcione para restaurar o banco de dados atual. Come√ßamos a considerar outras op√ß√µes de revers√£o. <br><br>  Vamos discutir mais detalhadamente a situa√ß√£o com backups na cl√≠nica. <br><br>  A situa√ß√£o com backups: <br><br><ul><li>  N√£o h√° backups de banco de dados (!!!) </li><li>  N√£o h√° instant√¢neos da m√°quina virtual (!?) </li><li>  Mas h√° backups de disco (completo + inc) </li></ul><br>  O banco de dados est√° no disco D, respectivamente, eles fizeram backups completos semanais e backups incrementais di√°rios. <br><br><ul><li>  toda sexta-feira √†s 20:00 backup completo </li><li>  backup incremental di√°rio </li><li>  existe um backup completo dos dias 15 e 22 </li><li>  existem backups di√°rios at√© o dia 21 </li></ul><br>  I.e.  em princ√≠pio, podemos reverter para o estado antes que o problema ocorra. <br>  Estamos aguardando uma atualiza√ß√£o da cl√≠nica para iniciar a revers√£o do banco de dados a partir do backup. <br><br>  Ao mesmo tempo, a cl√≠nica enviou uma solicita√ß√£o ao fornecedor de ferro (HP) marcado como "urgente". <br><br><h6>  28 de dezembro (quinta-feira) Dia 7 </h6><br>  <strong>13:13</strong> O servi√ßo de TI da cl√≠nica come√ßa a configurar uma nova m√°quina virtual, como  N√£o √© poss√≠vel corrigir o dano no arquivo da m√°quina virtual antiga. <br><br>  <strong>19:09</strong> Uma nova <strong>m√°quina</strong> virtual <strong>est√°</strong> dispon√≠vel com o SQL Server instalado. <br>  A pr√≥xima etapa √© restaurar o banco de dados a partir do backup em disco.  Para come√ßar, decidimos reverter para o 22¬∫ dia, se o problema ainda estiver presente, reverter para os dias 21, 20 e assim por diante, at√© chegarmos ao estado de funcionamento. <br><br>  Era o 28¬∫ dia no quintal, est√°vamos na festa corporativa e aqui eles nos dizem que a cl√≠nica tem problemas com a restaura√ß√£o de backups, porque os backups est√£o vazios! <br><br>  Aqui est√£o as novidades! <br><br>  Ao restaurar um backup da unidade D a partir do dia 21, acontece que ele est√° vazio, como todos os outros.  Os backups diretos do shredder s√£o obtidos - eles parecem estar l√°, mas ao mesmo tempo n√£o est√£o.  N√£o est√° completamente claro como isso aconteceu, mas, at√© onde pudemos entender, o ponto √© o espa√ßo insuficiente em disco para armazenar backups em disco.  Eles alocaram 500 Gb de backups para armazenamento, mas no momento do incidente, o banco de dados j√° pesava 800 Gb, portanto, em princ√≠pio, o backup n√£o podia ser bem-sucedido.  I.e.  os backups eram feitos regularmente de acordo com o cronograma, mas devido √† falta de espa√ßo, eles acabaram com um erro e, portanto, estavam vazios, e o servi√ßo de TI da cl√≠nica nem teve a ideia de verificar se estava tudo bem com eles.  N√£o fa√ßa isso. <br><br><h6>  29 de dezembro (sexta-feira) Dia 8 </h6><br>  <strong>13:11</strong> Discuss√£o de outras a√ß√µes.  Poss√≠veis op√ß√µes: <br><br><ul><li>  Tentativa de copiar arquivos de banco de dados (arquivos .ldf + .two) - as chances de sucesso s√£o muito baixas; </li><li>  Tentar fazer backup do banco de dados √© novamente muito pouca chance; </li><li>  Configurar replica√ß√£o - pode funcionar. </li></ul><br>  Uma unidade de 1 TB foi alocada no novo servidor, o que obviamente n√£o √© suficiente se tentarmos fazer backup e restaurar a partir dele, porque  no pior dos casos, sem compacta√ß√£o, os backups ocupam tanto espa√ßo quanto o banco de dados original, ou seja,  800 Gb. <br>  Por favor, adicione lugares no novo servidor e continue copiando os arquivos do banco de dados. <br>  Um banco de dados foi criado no novo servidor e o esquema do banco de dados foi restaurado - isso permitir√° pelo menos processar novo trabalho.  A cl√≠nica poder√° pelo menos aceitar novos pacientes usando esse sistema. <br><br>  <strong>14:36</strong> Portanto, seguimos para a op√ß√£o n√∫mero um, embora n√£o esperemos muito sucesso. <br>  Pare o SQL Server, comece a copiar o arquivo de dados (mdf) e o log (ldf). <br><br>  <strong>16:13</strong> Depois de metade do arquivo de log, ele foi copiado com √™xito (48 Gb) e 50 GB do arquivo de dados j√° foram copiados (795 de 846 GB restantes).  A essa velocidade, levar√° cerca de 12 horas para concluir a c√≥pia. <br><br>  <strong>16:30 O</strong> servidor de banco de dados antigo foi desligado ao copiar o arquivo, o que √© bastante esperado. <br><br>  <strong>17:09</strong> Portanto, passamos para a pr√≥xima op√ß√£o - configurar a replica√ß√£o, enquanto podemos especificar quais dados ser√£o replicados, ou seja, podemos primeiro excluir tabelas danificadas deliberadamente e primeiro copiar os dados n√£o danificados e depois transferir as tabelas problem√°ticas em partes.  Mas essa op√ß√£o, infelizmente, tamb√©m n√£o funciona, porque n√£o podemos nem criar uma publica√ß√£o com determinadas tabelas devido √† corrup√ß√£o do banco de dados. <br>  Tamb√©m estamos considerando op√ß√µes de transfer√™ncia de dados. <br><br>  <strong>20:01</strong> Como resultado, come√ßamos a simplesmente transferir dados do antigo para o novo servidor importando e exportando em ordem de prioridade. <br><br>  <strong>21:35</strong> Primeiro, os dados mais cr√≠ticos, depois arquivados e menos cr√≠ticos (~ 300 GB).  Na primeira onda de exporta√ß√£o, restavam menos de 300 GB de dados.  A tabela Documentos (300 GB) tamb√©m √© exclu√≠da.  Iniciamos o processo de c√≥pia √† noite. <br><br><h6>  30 de dezembro (s√°bado) Dia 9 </h6><br>  <strong>15:00</strong> Continuamos a transferir dados.  A tabela Trabalhos n√£o est√° dispon√≠vel.  A maioria das tabelas foi copiada nesse momento. <br>  Mas sem <strong>Jobs,</strong> tudo √© in√∫til, porque √© o principal elo entre todos os dados e lhes d√° significado e valor do ponto de vista comercial.  Sem ele, temos apenas um conjunto de dados d√≠spares que simplesmente n√£o podemos usar. <br><br>  Al√©m disso, neste ponto, a recupera√ß√£o do esquema do banco de dados foi conclu√≠da. <br><br>  <strong>As consequ√™ncias do incidente:</strong> <br><br>  Neste ponto, temos uma enorme perda de dados ao vivo. <br>  I.e.  formalmente, temos alguns dados no banco de dados, mas, de fato, n√£o h√° como us√°-los ou conect√°-los, para que possamos falar sobre a perda completa de dados. <br>  Dados perdidos em mais de 750.000 interna√ß√µes de pacientes. <br><br>  Isso √© realmente triste! <br><br><ul><li>  Esse √© um grande golpe para a reputa√ß√£o de nosso cliente, que pode se tornar um grande problema para eles nos neg√≥cios ao concluir novos contratos e encontrar novos clientes. </li><li>  Perder tantos dados para a cl√≠nica pode levar a s√©rios problemas e multas, porque  S√£o dados confidenciais que cont√™m sigilo m√©dico e, no sentido literal, dependem da vida das pessoas. </li></ul><br>  Come√ßamos a pensar no que podemos fazer nessa situa√ß√£o.  Eles come√ßaram a vasculhar o sistema por ossos para encontrar pistas. <br><br>  <strong>15:16</strong> Analisando todos os aspectos do sistema, entendemos que podemos tentar extrair os dados ausentes do √≠ndice ElasticSearch.  O fato √© que, devido √† configura√ß√£o incorreta dos √≠ndices ElasticSearch, ele armazena n√£o apenas os campos pelos quais a pesquisa de texto completo √© realizada, mas, em geral, tudo, isto √©, na verdade, h√° uma c√≥pia completa dos dados e, teoricamente, podemos extrair dados de l√°. sobre trabalhos e devolva-os ao nosso banco de dados.  Espera-se que os dados ainda possam se recuperar. <br><br>  Um bug ao qual voc√™ pode colocar um monumento! <br><br><img src="https://habrastorage.org/webt/oy/62/nt/oy62ntr-iiercftfvwmd_gzoide.png"><br><br>  <strong>18:00</strong> Um utilit√°rio foi escrito rapidamente para extrair os dados e, ap√≥s algumas horas, garantimos que a abordagem funcione e que os dados possam ser restaurados. <br><br>  <strong>20:00 A</strong> restaura√ß√£o do trabalho do ElasticSearch com a ajuda de um utilit√°rio escrito foi iniciada.  A abordagem funcionou, podemos restaurar os dados no trabalho.  Paralelamente, come√ßamos a extrair as vers√µes mais recentes do documento para cada trabalho. <br><br><h6>  31 de dezembro (domingo - ano novo) Dia 10 </h6><br>  <strong>14:09</strong> Durante a noite, 188 811 obras foram restauradas. <br><br>  <strong>20:13</strong> Vendo nosso sucesso, a cl√≠nica decide adiar a transfer√™ncia do servidor para o servi√ßo HP, a fim de nos dar tempo para extrair o m√°ximo de dados do servidor antigo. <br>  Com essas novidades, comemoramos o Ano Novo)) <br><br><h6>  01 de janeiro (segunda-feira) 11¬∫ dia </h6><br>  <strong>11:23</strong> Preparando-se para iniciar o sistema ap√≥s o incidente: <br><br><ul><li>  reconfigurou o IIS no servidor de aplicativos; </li><li>  reconfigurou todos os servi√ßos necess√°rios para trabalhar com o novo servidor de banco de dados; </li><li>  gatilhos, procedimentos armazenados, fun√ß√µes restauradas. </li></ul><br>  <strong>14:28</strong> Ent√£o eles come√ßaram a copiar a tabela de documentos, que foi ignorada devido ao grande tamanho durante a transfer√™ncia inicial. <br>  - O servidor de banco de dados antigo √© encerrado novamente.  Obviamente, a tabela Documentos tamb√©m est√° corrompida; √© com ela que todas as informa√ß√µes do paciente s√£o armazenadas.  Felizmente, n√£o est√° completamente danificado, podemos fazer solicita√ß√µes e, quando uma solicita√ß√£o para n√≥s retorna um registro danificado, nesse momento o servidor trava e √© encerrado.  Podemos extrair alguns dos dados. <br><br>  Nesse sentido, sinalizamos para o cliente, eles elevam o servidor e, paralelamente, continuamos a preparar o novo banco de dados para o lan√ßamento do sistema. <br><br>  <strong>18:01</strong> Recupera√ß√£o de todas as restri√ß√µes de integridade ap√≥s a transfer√™ncia da parte principal dos dados. <br><br>  <strong>22:02</strong> Restaura√ß√£o de restri√ß√µes conclu√≠da.  Simplesmente transferimos os dados brutos ao m√°ximo.  A presen√ßa de restri√ß√µes de integridade complicaria bastante nossa tarefa. <br><br><h6>  02 de janeiro (ter√ßa-feira) Dia 12 </h6><br>  <strong>05:52 O</strong> antigo servidor de banco de dados foi desligado novamente ao copiar o documento.  Ele √© prontamente criado para que possamos continuar trabalhando. <br><br>  <strong>09:00</strong> Foi poss√≠vel recuperar em lote cerca de 200.000 documentos (aproximadamente 20%) <br>  Come√ßamos a usar m√©todos de recupera√ß√£o diferentes: classificando por colunas diferentes para obter dados do final ou do in√≠cio da tabela, at√© encontrarmos alguma parte danificada da tabela. <br><br>  <strong>13:42</strong> Come√ßou a copiar trabalhos de arquivo na tabela - felizmente, n√£o est√° danificado. <br><br>  <strong>17:08</strong> Restaurado todo o trabalho de arquivo (491 380 pe√ßas). <br><br>  O sistema est√° pronto para o lan√ßamento: os usu√°rios podem criar e processar novos trabalhos. <br><br>  Infelizmente, devido a danos parciais na tabela de documentos, voc√™ n√£o pode simplesmente transferir todos os dados dela, como em outras tabelas, porque  a mesa est√° parcialmente danificada.  Portanto, ao tentar recuperar todos os dados, a solicita√ß√£o falha ao tentar ler p√°ginas corrompidas.  Portanto, extra√≠mos os dados no sentido do ponto, usando diferentes tipos e tamanhos de amostra: <br><br><ul><li>  Classificando por diferentes campos (ID, DateTime); </li><li>  Classifique ascendente, descendente; </li><li>  Trabalhe com pequenos grupos de linhas (1000, 100); </li><li>  Buscando trabalhos por ID. </li></ul><br><br><h6>  03 de janeiro (quarta-feira) Dia 13 </h6><br>  <strong>08:58</strong> Continuou o processo de restaura√ß√£o de documentos.  Os documentos foram restaurados apenas para trabalho ativo e incompleto.  Neste ponto, 1000 trabalhos (ativos) sem documentos. <br><br>  <strong>11:38</strong> Migrou todos os trabalhos SQL <br><br>  <strong>13:17</strong> 5 funciona sem documentos, 231 n√£o funciona, mas h√° um arquivo de √°udio, √© necess√°rio sincronizar novamente. <br><br><h6>  04 de janeiro (quinta-feira) Dia 14 </h6><br>  A recupera√ß√£o manual e a verifica√ß√£o do trabalho restante foram iniciadas. <br>  O sistema funciona, monitorando e corrigindo erros online. <br><br><h6>  05 de janeiro (sexta-feira) Dia 15 </h6><br>  Relatar a migra√ß√£o para o SSRS planejada. <br>  A transfer√™ncia para um novo servidor n√£o √© poss√≠vel, porque  a cl√≠nica instalou uma vers√£o mais antiga do SQL Server e n√£o funcionar√° para transferir o banco de dados do servidor antigo. <br><br>  Op√ß√µes: <br><br><ul><li>  Atualize o SQL Server de 2008 para 2008 R2; </li><li>  Configure tudo do zero. </li></ul><br>  Decidiu-se aguardar a atualiza√ß√£o do SQL Server. <br><br>  <strong>09:21 A</strong> restaura√ß√£o em segundo plano dos documentos para o trabalho conclu√≠do foi iniciada - o processo √© longo e levar√° v√°rios dias. <br><br>  <strong>13:28</strong> Altera√ß√£o de prioridade da restaura√ß√£o de documentos por departamentos. <br><br>  <strong>18:18 A</strong> cl√≠nica deu acesso ao SMTP, configura√ß√£o de correio <br><br><h3>  Resultado: </h3><br><ul><li>  Quase todos os dados foram restaurados (apenas 5 trabalhos foram perdidos); </li><li>  Recomenda√ß√µes sobre manuten√ß√£o de banco de dados foram emitidas para evitar tais situa√ß√µes; </li><li>  Os backups do banco de dados s√£o configurados usando o SQL Server; </li><li>  Monitoramento adicional de backups de nossa parte, alertas em caso de falha. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt432998/">https://habr.com/ru/post/pt432998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt432988/index.html">Oitavo Webmaster. Ao vivo em Habr√©</a></li>
<li><a href="../pt432990/index.html">Edison L√¢mpada de madeira ativada por voz. Pre√ßo de emiss√£o $ 5</a></li>
<li><a href="../pt432992/index.html">Ele colocou os fones de ouvido e morreu: lidamos com a estranha morte de um estudante em Rimbau</a></li>
<li><a href="../pt432994/index.html">Vivaldi 2.2 - Quantidade convertida em qualidade</a></li>
<li><a href="../pt432996/index.html">Um pouco de dicion√°rios internos no CPython (e PyPy)</a></li>
<li><a href="../pt433000/index.html">Compilando o Kotlin: JetBrains x ANTLR x JavaCC</a></li>
<li><a href="../pt433002/index.html">Venha voc√™ mesmo ... ou as regras de comunica√ß√£o em uma equipe</a></li>
<li><a href="../pt433004/index.html">Uma estrat√©gia robusta de migra√ß√£o da nuvem para 2019: 7 dicas</a></li>
<li><a href="../pt433008/index.html">Os dispositivos USB s√£o uma amea√ßa "repentina"</a></li>
<li><a href="../pt433010/index.html">Tem uma id√©ia: sistema de permiss√£o para pacotes npm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>