<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õëÔ∏è üßöüèº üßëüèΩ‚Äçü§ù‚Äçüßëüèº ESP32 + Arduino Core + FreeRTOS + Blynk = casa con los inicios de la mente üßò üçê üêå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Objetivos del proyecto 


 De alguna manera result√≥ que constru√≠ mi casa, un esqueleto. En mi aul de lujo no hay gas y no se espera en un futuro cerca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ESP32 + Arduino Core + FreeRTOS + Blynk = casa con los inicios de la mente</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479156/"><h2 id="celi-proekta">  Objetivos del proyecto </h2><br><p> De alguna manera result√≥ que constru√≠ mi casa, un esqueleto.  En mi aul de lujo no hay gas y no se espera en un futuro cercano, por eso eleg√≠ un esqueleto; todo lo dem√°s, para m√≠, ser√≠a muy costoso calentar con electricidad.  Bueno, tambi√©n porque es una de las tecnolog√≠as m√°s baratas. <br>  Ok, tir√© tuber√≠as alrededor de la casa, colgu√© bater√≠as, una caldera, parec√≠a caliente, pero algo estaba mal. </p><br><p>  Despu√©s de escucharme, me di cuenta de que este es un sapo que no me gusta, que mientras no estoy en casa (12-16 horas al d√≠a), la calefacci√≥n funciona.  Y puede que no funcione, enci√©ndalo solo antes de llegar, ya que el esqueleto tiene una ligera inercia y le permite elevar r√°pidamente la temperatura.  La misma situaci√≥n cuando en alg√∫n lugar durante mucho tiempo para salir de casa.  Bueno, en general, correr, girar la manija de la caldera con cambios de temperatura en la calle de alguna manera no es kosher. </p><a name="habracut"></a><br><p>  Qued√≥ claro que sin automatizaci√≥n, en ninguna parte, la caldera es la m√°s simple, pero tiene contactos para conectar un rel√© de control externo.  Por supuesto, podr√≠a comprar inmediatamente una caldera con todas las funciones necesarias, pero para m√≠, esas calderas son de alguna manera inhumanas.  Adem√°s, quer√≠a hacer sentadillas con cerebro, orinar algo para el alma, aprender un poco de C, aunque en la versi√≥n arduino. </p><br><p>  En realidad sobre los requisitos: </p><br><ul><li>  control de temperatura de consigna </li><li>  control de temperatura del refrigerante dependiendo de la temperatura exterior o manual </li><li>  zonas horarias con diferentes configuraciones, m√°s fr√≠o durante el d√≠a, m√°s caliente durante la noche </li><li>  modo autom√°tico, con transici√≥n autom√°tica d√≠a-noche </li><li>  modo manual, sin transiciones autom√°ticas, para el fin de semana </li><li>  modo no autom√°tico, donde puede configurar manualmente cualquier temperatura del refrigerante y encender / apagar la caldera </li><li>  control de calefacci√≥n local, desde botones y pantalla y a trav√©s del sitio web / aplicaci√≥n m√≥vil </li></ul><br><p>  Fue al principio, y luego sufr√≠ y agregu√©: </p><br><ul><li>  control de farola (foco LED) </li><li>  sistema de alarma basado en sensor de movimiento, sirena y farola </li><li>  medir la energ√≠a consumida por la caldera por d√≠a / mes / a√±o + para cada mes del a√±o </li><li>  modo de alarma solo por parpadeo lento de una l√°mpara </li><li>  modo de se√±alizaci√≥n mediante un parpadeo r√°pido de una l√°mpara y pitidos cortos de una sirena </li><li>  modo de se√±alizaci√≥n mediante el parpadeo r√°pido de una l√°mpara y el aullido constante de una sirena </li></ul><br><p>  El prop√≥sito de este art√≠culo es compartir experiencias, describir algo en ruso que no pude encontrar en Internet.  Creo que este art√≠culo ser√° √∫til para principiantes Arduino h√°galo usted mismo que ya est√°n un poco familiarizados con la programaci√≥n, como  cosas absolutamente b√°sicas que no describ√≠.  Trat√© de escribir el c√≥digo lo m√°s claro posible, espero haber tenido √©xito. </p><br><h2 id="chto-bylo-v-nachale">  Lo que estaba al principio </h2><br><p>  Inicialmente, el proyecto se implement√≥ en un grupo salvaje de Arduino Nano + ESP8266, pero ESP no es como un escudo, sino como un dispositivo separado.  Por qu√©  S√≠, porque ya ten√≠a todo esto, pero no hab√≠a dinero de la palabra en absoluto, por lo que, en principio, no quer√≠a comprar hierro nuevo.  ¬øPor qu√© ESP no es como un escudo?  Ahora ni lo recuerdo. </p><br><p>  Arduino manej√≥ todos los procesos porque ten√≠a la cantidad requerida de GPIO, y ESP envi√≥ todos los datos al servidor Blynk, porque conoc√≠a Internet y no ten√≠a suficiente GPIO.  Se conectaron a trav√©s de UART y enviaron JSON con datos entre s√≠.  El esquema es inusual, pero funcion√≥ durante un a√±o casi sin quejas.  <a href="https://github.com/abashind/HomeHeater">Cualquier persona</a> interesada puede ver el <a href="https://github.com/abashind/HomeHeater">c√≥dec</a> . </p><br><p>  Har√© una reserva de inmediato, no sab√≠a mucho c√≥mo programar (e incluso ahora me gustar√≠a m√°s), as√≠ que es mejor que las mujeres embarazadas y los ni√±os no lo vean.  Adem√°s, todo fue escrito en el IDE de Arduino, no ser√° recordado por la noche, lo que es muy limitado en t√©rminos de refactorizaci√≥n, todo es muy primitivo all√≠. </p><br><h2 id="zhelezo">  Hierro </h2><br><p>  Entonces, ha pasado un a√±o, las finanzas permitidas para comprar ESP32 devkit v1, que tiene suficiente GPIO, pueden acceder a Internet y, en general, a un s√∫per controlador.  Adem√°s de los chistes, me gust√≥ mucho al final del trabajo. </p><br><p>  Lista de hierro: </p><br><ul><li>  ESP32 devkit v1 noname China </li><li>  3 sensores de temperatura DS18B20, temperatura dentro de la casa, exterior y temperatura del refrigerante en las tuber√≠as </li><li>  bloque de 4 rel√©s </li><li>  sensor pir HC-SR501 </li></ul><br><p>  No dibujar√© un esquema, creo que todo quedar√° claro a partir de las macros con los nombres de los pines. </p><br><h2 id="pochemu-freertos-i-arduino-core">  Por qu√© FreeRTOS y Arduino Core </h2><br><p>  Hay un mont√≥n de bibliotecas escritas en Arduino, en particular el mismo Blynk, por lo que no se alejar√° de Arduino Core. </p><br><p>  FreeRTOS porque le permite organizar el trabajo de una peque√±a pieza de hierro similar al trabajo de un controlador industrial completo.  Cada tarea puede moverse a su propia tarea, detenerse, iniciarse, crearse cuando sea necesario, eliminarse; todo esto es mucho m√°s flexible que escribir una larga mara√±a de c√≥digo Arduino, cuando al final todo se hace a su vez en la funci√≥n de bucle. </p><br><p>  Al usar FreeRTOS, cada tarea se ejecutar√° en un momento estrictamente especificado, si solo la potencia del procesador es suficiente.  Por el contrario, en Arduino todo el c√≥digo se ejecuta en una funci√≥n, en un hilo, si algo se ralentiza, el resto de las tareas se retrasar√°n.  Esto es especialmente notable cuando se gestionan procesos r√°pidos, en este proyecto este parpadeo de una linterna y un pitido de sirena se discutir√°n a continuaci√≥n. </p><br><h2 id="pro-logiku">  Acerca de la l√≥gica </h2><br><h3 id="pro-freertos-taski">  Acerca de las tareas de FreeRTOS </h3><br><p>  ‚Üí Enlace a <a href="https://github.com/abashind/home_auto_2019">todo el c√≥dec del proyecto</a> </p><br><p>  Entonces, cuando se usa FreeRTOS, la funci√≥n de configuraci√≥n desempe√±a el papel de la funci√≥n principal, el punto de entrada a la aplicaci√≥n, las tareas de FreeRTOS (en adelante tareas) se crean en ella, la funci√≥n de bucle no se puede usar en absoluto. </p><br><p>  Considere una peque√±a tarea para calcular la temperatura del refrigerante: </p><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate_water_temp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pvParameters)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (heating_mode == <span class="hljs-number"><span class="hljs-number">3</span></span>) {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-20</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-20</span></span> &amp;&amp; temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-25</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-25</span></span> &amp;&amp; temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-30</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">70</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-30</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">85</span></span>; } vTaskDelay(<span class="hljs-number"><span class="hljs-number">1000</span></span> / portTICK_RATE_MS); } }</code> </pre> <br><p>  Se declara como una funci√≥n que debe tomar _void <code>pvParameters</code> , se organiza un bucle sin fin dentro de la funci√≥n, utilic√© <code>while (true)</code> . </p><br><p>  Se realiza un c√°lculo de temperatura simple (si el modo operativo lo permite) y luego <code>vTaskDelay(1000 / portTICK_RATE_MS)</code> durante 1 segundo.  En este modo, no consume tiempo del procesador, las variables con las que trabaj√≥ la tarea, en otras palabras, el contexto, se guardan en la pila para sacarlas de all√≠ cuando llegue el momento. </p><br><p>  La siguiente tarea debe crearse en la configuraci√≥n.  Esto se hace llamando al m√©todo <code>xTaskCreate</code> : </p><br><p> <code>xTaskCreate(calculate_water_temp, "calculate_water_temp", 2048, NULL, 1, NULL);</code> </p> <br><p>  Hay muchos argumentos, pero para nosotros, <em>Calculate_water_temp</em> es significativo: el nombre de la funci√≥n que contiene el c√≥digo de la tarea y 2048 es el tama√±o de la pila en bytes. </p><br><p>  El tama√±o de la pila inicialmente configur√≥ a todos en 1024 bytes, luego calcul√© el m√©todo deseado escribiendo, si el controlador comenz√≥ a caer con un desbordamiento de la pila (como se puede ver en la salida en uart), solo aument√© el tama√±o de la pila 2 veces, si no ayudaba, 2 veces, etc. hasta que funcione  Por supuesto, esto no ahorra demasiado memoria, pero ESP32 tiene suficiente, en mi caso no podr√≠a molestarse con esto. </p><br><p>  Tambi√©n puede especificar un identificador para la tarea, un identificador con el que puede controlar la tarea despu√©s de la creaci√≥n, por ejemplo, eliminar.  Este es el √∫ltimo NULL en el ejemplo.  Un identificador se crea as√≠: </p><br><p> <code>TaskHandle_t slow_blink_handle;</code> </p> <br><p>  A continuaci√≥n, al crear una tarea, <code>xTaskCreate</code> pasa un puntero al <code>xTaskCreate</code> al par√°metro xTaskCreate: </p><br><p> <code>xTaskCreate(outside_lamp_blinks, "outside_lamp_blynk", 10000, (void *)1000, 1, &amp;slow_blink_handle);</code> </p> <br><p>  Y si queremos eliminar la tarea, hacemos esto: </p><br><p> <code>vTaskDelete(slow_blink_handle);</code> </p> <br><p>  Se puede ver c√≥mo se usa esto en el c√≥digo de <code>panic_control</code> panic_control. </p><br><h3 id="pro-freertos-myuteksy">  FreeRTOS Mutex Pros </h3><br><p>  Mutex se utiliza para eliminar conflictos entre tareas al acceder a recursos como uart, wifi, etc.  En mi caso, necesitaba mutexes para wifi y acceso a memoria flash. </p><br><p>  Cree un enlace al mutex: </p><br><p> <code>SemaphoreHandle_t wifi_mutex;</code> </p> <br><p>  En la <code>setup</code> cree un mutex: </p><br><p> <code>wifi_mutex = xSemaphoreCreateMutex();</code> </p> <br><p>  Adem√°s, cuando necesitamos acceso al recurso de la tarea, se necesita el mutex, lo que permite que el resto de las tareas sepan que el recurso est√° ocupado y no debemos intentar trabajar con √©l: </p><br><p> <code>xSemaphoreTake(wifi_mutex, portMAX_DELAY);</code> </p> <br><p>  <code>portMAX_DELAY</code> : espere indefinidamente hasta que el recurso y el mutex sean liberados por otras tareas, todo este tiempo la tarea se suspender√°. </p><br><p>  Despu√©s de trabajar con el recurso, le damos el mutex para que otros puedan usarlo: </p><br><p> <code>xSemaphoreGive(wifi_mutex);</code> </p> <br><p>  Puede ver el c√≥digo con m√°s <code>send_data_to_blynk</code> en la <code>send_data_to_blynk</code> send_data_to_blynk. </p><br><p>  En la pr√°ctica, no se usaban mutexes cuando el controlador funcionaba, pero durante la depuraci√≥n JTAG, los errores desaparec√≠an constantemente y desaparec√≠an despu√©s de usar mutexes. </p><br><h3 id="kratkoe-opisanie-tasok">  Breve descripci√≥n de tasok </h3><br><p>  <code>get_temps</code> : recibe la temperatura de los sensores, cada 30 segundos, m√°s a menudo no es necesario. <br>  <code>get_time_task</code> : obtiene el tiempo de los servidores NTP.  Anteriormente, lleg√≥ el momento del m√≥dulo RTC DS3231, pero comenz√≥ a fallar despu√©s de un a√±o de trabajo, as√≠ que decid√≠ deshacerme de √©l.  Decid√≠ que para m√≠ esto no tiene ninguna consecuencia especial, principalmente el tiempo afecta el cambio de la zona horaria de calefacci√≥n, de d√≠a o de noche.  Si Internet desaparece durante el funcionamiento del controlador, la hora simplemente se congelar√°, la zona horaria simplemente permanecer√° igual.  Si el controlador se apaga y despu√©s de encenderlo no hay Internet, entonces la hora siempre ser√° 0:00:00 - modo de calefacci√≥n por la noche. <br>  <code>calculate_water_temp</code> : considerado anteriormente. <br>  <code>detect_pir_move</code> : recibe una se√±al de movimiento del sensor HC-SR501.  El sensor forma una unidad l√≥gica + 3.3V cuando se detecta movimiento, que se detecta usando <code>digitalRead</code> , por cierto, el pin para la detecci√≥n de este sensor debe estar levantado a GND - <code>pinMode(pir_pin, INPUT_PULLDOWN);</code> <br>  <code>heating_control</code> - cambio de modos de calentamiento. <br>  <code>out_lamp_control</code> - control de una farola. <br>  <code>panic_control</code> : controla la sirena y el foco cuando se detecta movimiento.  Para crear el efecto de sirenas y luces intermitentes, se utilizan tareas separadas, <code>outside_lamp_blinks</code> y <code>siren_beeps</code> .  Cuando se usa FreeRTOS, el parpadeo y los pitidos funcionan perfectamente, exactamente en los intervalos establecidos, otras tareas no afectan su trabajo, porque  ellos viven en corrientes separadas.  FreeRTOS garantiza que el c√≥digo en la tarea se ejecutar√° a la hora especificada.  Al implementar estas funciones en el <code>loop</code> todo funcion√≥ no tan bien, porque  influenciado por la ejecuci√≥n de otro c√≥digo. <br>  <code>guard_control</code> : control de los modos de guardia. <br>  <code>send_data_to_blynk</code> : env√≠a datos a la aplicaci√≥n Blynk. <br>  <code>run_blynk</code> : tarea para iniciar <code>Blynk.run()</code> como lo requiere el manual para usar Blynk.  Seg√∫n tengo entendido, esto es necesario para obtener datos de la aplicaci√≥n al controlador.  En general, <code>Blynk.run()</code> deber√≠a estar en un <code>loop</code> , pero b√°sicamente no quer√≠a poner nada all√≠ y lo convert√≠ en una tarea separada. <br>  <code>write_setting_to_pref</code> : graba la configuraci√≥n y los modos de funcionamiento para capturarlos despu√©s de un reinicio.  Sobre pref se describir√° a continuaci√≥n. <br>  <code>count_heated_hours</code> - contando el tiempo de operaci√≥n de la caldera.  Lo hice simplemente, si la caldera se enciende en el momento del inicio de la tarea (una vez cada 30 segundos), en la memoria flash, el valor de la clave deseada se incrementa en uno. <br>  <code>send_heated_hours_to_app</code> : en esta tarea, los valores se extraen y multiplican por 0.00833 (1/120 horas), las horas de funcionamiento recibidas de la caldera se env√≠an a la aplicaci√≥n Blynk. <br>  <code>feed_watchdog</code> - alimenta a Watchdog.  Tuve que escribir watchdog, porque  una vez cada pocos d√≠as, el controlador podr√≠a congelarse.  Lo que est√° conectado no est√° claro, puede haber alg√∫n tipo de interferencia con la fuente de alimentaci√≥n, pero el uso de watchdog resuelve este problema.  Watchdog timer 10 segundos, est√° bien si el controlador no est√° disponible durante 10 segundos. <br>  <code>heart_beat</code> : tarea con pulso.  Cuando paso el controlador, quiero saber que funciona bien.  Porque  en mi placa no hay LED incorporado, tuve que usar el LED UART: instalar <code>Serial.begin(9600);</code>  y escribe una cadena larga en UART.  Funciona bastante bien </p><br><h3 id="esp32-nvs-wear-leveling">  Nivelaci√≥n de desgaste ESP32 NVS </h3><br><p>  <em>Las siguientes descripciones son bastante crudas, literalmente en los dedos, solo para transmitir la esencia del problema.</em>  <em><a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html">M√°s detalles</a></em> </p><br><p>  Arduino usa memoria EEPROM para almacenar datos en memoria no vol√°til.  Esta es una peque√±a memoria en la que cada byte se puede escribir y borrar por separado, mientras que la memoria flash se borra solo por sectores. </p><br><p>  No hay EEPROM en ESP32, pero generalmente hay una memoria flash de 4 Mb en la que puede crear particiones para el firmware del controlador o para almacenar datos del usuario.  Las secciones para los datos del usuario son de varios tipos: NVS, FATFS, SPIFFS.  Debe seleccionarse en funci√≥n del tipo de datos destinados a la grabaci√≥n. </p><br><p>  Porque  Todos los datos que se escriben en este proyecto son del tipo Int. Eleg√≠ NVS - Almacenamiento no vol√°til.  Este tipo de partici√≥n es muy adecuada para almacenar datos peque√±os, a menudo sobrescribibles.  Para entender por qu√©, debe profundizar un poco m√°s en la organizaci√≥n de NVS. </p><br><p>  Al igual que EEPROM y FLASH, existen restricciones para sobrescribir datos, los bytes en EEPROM se pueden sobrescribir de 100,000 a 1,000,000 de veces, y el sector FLASH es el mismo.  Si escribimos datos una vez por segundo, obtenemos 60 segundos x 60 minutos x 24 horas = 86,400 veces / d√≠a.  Es decir, en este modo, el byte durar√° 11 d√≠as, lo cual es un poco.  Despu√©s de lo cual el byte no estar√° disponible para escribir y leer. </p><br><p>  Para solucionar este problema, las funciones <code>update()</code> <code>put()</code> de la biblioteca Arduino EEPROM solo escriben datos cuando cambian.  Es decir, puede escribir cada segundo algunas configuraciones y c√≥digos de modo que cambian muy raramente. </p><br><p>  NVS utiliza un m√©todo diferente para controlar la nivelaci√≥n del desgaste.  Como se mencion√≥ anteriormente, los datos en el sector flash se pueden escribir en partes, pero solo se puede borrar todo el sector.  Por lo tanto, el registro de datos en NVS se lleva a cabo en una especie de diario, este diario se divide en p√°ginas, que se colocan en un sector de la memoria flash.  Los datos se escriben en pares de clave: valor.  De hecho, es incluso m√°s f√°cil que con EEPROM, porque  trabajar con un nombre significativo es m√°s f√°cil que con una direcci√≥n en la memoria.  <strong>Upd: ¬°</strong> la longitud de la clave no tiene m√°s de 15 caracteres! </p><br><p>  Si primero escribe el valor <code>1</code> en la tecla <code>somekey</code> tecla, y luego escribe el valor <code>2</code> en la misma tecla, el primer valor no se eliminar√°, solo se marcar√° como eliminado (Borrado) y se agregar√° una nueva entrada al registro: </p><br><p><img src="https://habrastorage.org/webt/pw/ri/of/pwriofnineuwy7bmctgzcngiqrk.jpeg"></p><br><p>  Si intenta leer datos con <code>somekey</code> √∫ltimo valor de esta clave.  Porque  Como el registro es com√∫n, los valores de las diferentes claves se almacenan uno al lado del otro a medida que se escriben. </p><br><p>  La p√°gina tiene un estado, Vac√≠o: vac√≠o, sin entradas, Activo: los datos se est√°n escribiendo actualmente, Completo: est√° lleno, no puede escribir en √©l.  Tan pronto como la p√°gina se quede sin espacio, ella es de <br>  Activo va a Completo, y la siguiente p√°gina Vac√≠a se vuelve Activa. </p><br><p><img src="https://habrastorage.org/webt/6q/lz/ym/6qlzymofwdhy9ah2x-ekgpd23tq.jpeg"></p><br><p>  Seg√∫n tengo entendido de la documentaci√≥n en el sitio web de Espressif y en varios foros, la limpieza de p√°ginas comienza cuando las p√°ginas gratuitas llegan a su fin.  Para ser m√°s precisos, de acuerdo <a href="">con esto</a> , el borrado ocurrir√° cuando solo quede 1 p√°gina libre. </p><br><p>  Si es necesario borrar la p√°gina, los registros actuales (no borrados) se mueven a otra p√°gina y se sobrescribe la p√°gina. </p><br><p>  Por lo tanto, la operaci√≥n de borrado de escritura para cada p√°gina en particular es bastante rara, cuantas m√°s p√°ginas, con menos frecuencia.  En base a esto, aument√© el tama√±o de la partici√≥n NVS a 1 MB, a mi velocidad de grabaci√≥n es suficiente durante 170 a√±os, que en general es suficiente.  Acerca de cambiar el tama√±o de la secci√≥n NVS ser√° el siguiente. </p><br><p>  Para un trabajo conveniente con NVS, ESP32 para Arduino Core tiene una pr√°ctica biblioteca de Preferencias escritas, aqu√≠ se escribe c√≥mo trabajar con ellas. </p><br><h3 id="nemnogo-o-visualgdb">  Un poco sobre VisualGDB </h3><br><p>  Tan pronto como comenc√© a trabajar con Arduino IDE, me sorprendi√≥ de inmediato la miserable funcionalidad en comparaci√≥n con Visual Studio.  Dicen que VS tampoco es una fuente, aunque me conviene, pero escribir algo m√°s de 50 l√≠neas en el IDE de Arduino es dolorosamente doloroso y dolorosamente largo.  Por lo tanto, surgi√≥ la cuesti√≥n de elegir un IDE para el desarrollo.  Porque  Estoy familiarizado con VS, me <a href="https://visualgdb.com/tutorials/arduino/esp32/">decid√≠</a> por <a href="https://visualgdb.com/tutorials/arduino/esp32/">VisualGDB</a> . </p><br><p>  Despu√©s del Arduino IDE, el desarrollo del ESP32 es simplemente un para√≠so.  ¬øCu√°l es la transici√≥n a la definici√≥n, la b√∫squeda de llamadas en el proyecto y la capacidad de cambiar el nombre de la variable? </p><br><h3 id="izmenenie-tablicy-razdelov-esp32-pri-rabote-s-visualgdb">  Cambiar la tabla de particiones ESP32 con VisualGDB </h3><br><p>  Como se mencion√≥ anteriormente, la tabla se puede cambiar con la partici√≥n ESP32; consideraremos c√≥mo se puede hacer esto. <br>  La tabla se edita como un archivo csv, de forma predeterminada VisualGDB escribe la siguiente tabla: </p><br><pre> <code class="plaintext hljs">Name, Type, SubType, Offset, Size, Flags nvs, data, nvs, 0x9000, 0x5000, otadata, data, ota, 0xe000, 0x2000, app0, app, ota_0, 0x10000, 0x140000, app1, app, ota_1, 0x150000,0x140000, spiffs, data, spiffs, 0x290000,0x170000,</code> </pre> <br><p>  Aqu√≠ vemos una secci√≥n en NVS, dos secciones para aplicaciones y algunas secciones m√°s.  De los matices, se puede notar que app0 (su aplicaci√≥n) siempre debe escribirse en el desplazamiento 0x10000, comenzando desde la direcci√≥n cero, de lo contrario, el gestor de arranque no lo detectar√°.  Adem√°s, las compensaciones deben seleccionarse para que las secciones no se "superpongan" entre s√≠.  La tabla de particiones se escribe en el desplazamiento 0x8000.  Como puede ver, el tama√±o del NVS en este caso es 0x5000 - 20KB, que no es mucho. </p><br><p>  Modifiqu√© la tabla de particiones de la siguiente manera: </p><br><pre> <code class="plaintext hljs">Name, Type, SubType, Offset, Size, Flags app0, app, ota_0, 0x10000, 0x140000, nvs, data, nvs, , 1M, otadata, data, ota, , 0x2000, spiffs, data, spiffs, , 0x170000,</code> </pre><br><p>  No olvide agregar una cuadr√≠cula antes de Nombre, si usa esta tabla, necesita que esta l√≠nea se considere un comentario. </p><br><p>  Como puede ver, el tama√±o del NVS se incrementa a 1 MB.  Si no especifica desplazamientos, la secci√≥n comenzar√° inmediatamente despu√©s del anterior, por lo que es suficiente para indicar el desplazamiento solo para app0.  Los archivos CSV se pueden editar en el bloc de notas como txt y luego cambiar el permiso a csv para el archivo guardado. </p><br><p>  A continuaci√≥n, la tabla de particiones debe convertirse a un binario, porque  entra al controlador de esta forma.  Para hacer esto, ejecute el convertidor: <br>  <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\tools\gen_esp32part.exe part_table_name.csv part_table_name.bin</code> .  El primer par√°metro es su CSV, el segundo par√°metro es el binario de salida. </p><br><p>  El binario resultante debe colocarse en <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\tools\partitions\part_table_name.csv</code> , despu√©s de lo cual es necesario especificar que fue √©l quien fue tomado para construir la soluci√≥n, y sin tabla de partici√≥n predeterminada.  Puede hacerlo escribiendo el nombre de su tabla en el archivo <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\boards.txt</code> .  En mi caso, esto es <code>esp32doit-devkit-v1.build.partitions=part_table_name</code> <br>  Despu√©s de estas manipulaciones, VisualGDB al compilar la aplicaci√≥n tomar√° exactamente su tabla de particiones y la colocar√° en <br>  <code>~project_folder_path\Output\board_name\Debug\project_name.ino.partitions.bin</code> , desde donde ya se habr√° vertido en el tablero. </p><br><h3 id="jtag-otladchik-cjmc-ft232h">  Depurador JTAG CJMC-FT232H </h3><br><p>  Hasta donde s√©, este es el depurador m√°s barato que puede funcionar con ESP32, me cost√≥ alrededor de 600 rublos, hay muchos de ellos en Aliexpress. </p><br><p><img src="https://habrastorage.org/webt/gn/cu/gm/gncugmqpjnb1hbmj630nnegxjgq.jpeg"></p><br><p>  Cuando conecta el depurador, Windows instala en √©l controladores inadecuados que deben cambiarse utilizando el programa Zadig, todo es simple all√≠, no lo describir√©. </p><br><p>  Se conecta a ESP32 devkit-v1 de la siguiente manera: <br>  FT232H - ESP32 <br>  AD0 - GPIO13 <br>  AD1 - GPIO12 <br>  AD2 - GPIO15 <br>  AD3 - GPIO14 <br>  Luego, en <code>Project -&gt; VisualGDB Project Properties</code> debe realizar la siguiente configuraci√≥n: </p><br><p><img src="https://habrastorage.org/webt/eg/oi/7b/egoi7bhrpkjaprfvyz-jd9puccw.jpeg"></p><br><p>  Luego haga clic en Prueba.  A veces sucede que la conexi√≥n no se establece la primera vez, el proceso parece congelarse, luego debe interrumpir y repetir la Prueba.  Si todo est√° en orden, el proceso de prueba de la conexi√≥n dura unos 5 segundos. </p><br><p>  Por lo general, ensambl√© el proyecto y lo cargu√© a trav√©s de USB al ESP32 en s√≠ (no a trav√©s del depurador), despu√©s de lo cual comenc√© a depurar usando <code>Debug -&gt; Attach to Running Embedded Firmware</code> .  En el c√≥digo, puede establecer puntos de interrupci√≥n, ver los valores de las variables en el momento del desglose y en la ventana <code>Debug -&gt; Windows -&gt; Threads</code> puede ver en qu√© tarea de FreeRTOS se detuvo el c√≥digo, lo que es √∫til si se produce un error durante la depuraci√≥n.  Estas funciones del depurador fueron suficientes para que yo trabajara c√≥modamente. <br>  Cuando comenc√© a trabajar con NVS, la depuraci√≥n se interrump√≠a constantemente por errores oscuros.  Seg√∫n tengo entendido, esto se debe a que el depurador debe crear algo as√≠ como un volcado en la secci√≥n NVS predeterminada, pero en este momento el controlador ya est√° utilizando el NVS.  Por supuesto, esto podr√≠a evitarse creando 2 particiones NVS, una con el nombre predeterminado para la depuraci√≥n y la otra para sus propias necesidades.  Pero no hab√≠a nada complicado all√≠, en el c√≥digo agregado, funcion√≥ la primera vez, as√≠ que no lo revis√©. </p><br><h3 id="glyuki-esp32">  Glitches ESP32 </h3><br><p>  Al igual que cualquier dispositivo con Aliexpress, mi placa ESP32 ten√≠a su propia falla, que no se describe en ninguna parte.  Cuando lleg√≥, le di de comer a la periferia algunos perif√©ricos que funcionaban en I2C, pero despu√©s de un tiempo, la placa comenz√≥ a reiniciarse si alg√∫n equipo que consum√≠a o incluso un condensador estaba conectado a la pata de + 5V.  Por qu√© es tan completamente incomprensible. </p><br><p>  Ahora enciendo la placa desde la carga china 0.7A, los sensores ds18b20 desde el pie de la placa de 3.3V, y el rel√© y el sensor de movimiento desde otra carga de 2A.  El pie GND de la placa est√°, por supuesto, conectado a los pines GND del resto de la plancha.  Barato y alegre es nuestra opci√≥n. </p><br><h3 id="o-rezultatah-proekta">  Sobre los resultados del proyecto </h3><br><p>  Tuve la oportunidad de controlar de manera flexible la calefacci√≥n de la casa, ahorrando dinero y el sudor ganado.  Por el momento, si la calefacci√≥n se mantiene 23 grados durante todo el d√≠a a -5 - -7 afuera, es alrededor de 11 horas de funcionamiento de la caldera.  Si durante el d√≠a se mantiene a 20 grados y se calienta a 23 solo por la noche, entonces ya son 9 horas de funcionamiento de la caldera.  La capacidad de la caldera es de 6 kW, con un precio actual de kilovatios de 2.2 rublos, esto es aproximadamente 26.4 rublos por d√≠a.  La duraci√≥n de la temporada de calefacci√≥n en nuestra √°rea es de 200 d√≠as, la temperatura promedio en la temporada de calefacci√≥n es de aproximadamente -5 grados.  Por lo tanto, obtenemos aproximadamente 5000r de ahorro para la temporada de calefacci√≥n. </p><br><p>  El costo del equipo no excede 2000r, es decir, los costos se rechazar√°n en unos meses, sin mencionar el hecho de que un sistema listo para usar de tal automatizaci√≥n costar√≠a al menos 20,000r.  Otra cosa es que pas√© aproximadamente una semana de tiempo de trabajo puro escribiendo firmware y depuraci√≥n, pero en el curso del trabajo, por ejemplo, finalmente me di cuenta de qu√© punteros hay en C ++ y obtuve mucha otra experiencia (por ejemplo, la experiencia de muchas horas de depuraci√≥n de fallas incomprensibles).  Y la experiencia, como saben, es dif√≠cil de sobreestimar. </p><br><p>  Capturas de pantalla de la aplicaci√≥n m√≥vil Blynk: </p><br><p><img src="https://habrastorage.org/webt/f8/a-/57/f8a-57tioype-tcgmjmodpagpwa.jpeg"></p><br><p><img src="https://habrastorage.org/webt/ez/3a/o3/ez3ao3_ht2lgjsbf9jvv_xcoksc.jpeg"></p><br><p><img src="https://habrastorage.org/webt/xi/xv/f-/xixvf-6pvrnw-2trm_toszimwrm.jpeg"></p><br><p>  Por supuesto, el c√≥digo en el proyecto no es una obra maestra, pero lo escrib√≠ en condiciones de falta de tiempo y me enfoqu√© principalmente en la legibilidad.  Simplemente no hay tiempo para refactorizar.  En general, tengo muchas excusas por las que mi c√≥digo da tanto miedo, pero este es mi favorito, as√≠ que me detendr√© en ello, no desarrollar√© el tema m√°s. </p><br><p>  Si mi garabato ayuda a alguien, me alegrar√© sinceramente.  Estar√© encantado de cualquier comentario y sugerencia. </p><br><div class="spoiler">  <b class="spoiler_title">Lista de referencias</b> <div class="spoiler_text"><ol><li>  <a href="http://microsin.net/programming/ARM/freertos-part1.html">http://microsin.net/programming/ARM/freertos-part1.html</a> </li><li>  <a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html">https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html</a> </li><li>  <a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-guides/partition-tables.html">https://docs.espressif.com/projects/esp-idf/en/latest/api-guides/partition-tables.html</a> </li><li>  <a href="https://docs.blynk.cc/">https://docs.blynk.cc/</a> </li></ol><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/479156/">https://habr.com/ru/post/479156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479144/index.html">¬øNecesito registrar mi marca?</a></li>
<li><a href="../479146/index.html">Comparaci√≥n de herramientas de bypass \ VPN</a></li>
<li><a href="../479150/index.html">Los robots agr√≠colas avanzan</a></li>
<li><a href="../479152/index.html">Reaccionar y Vue sin npm y compilaciones</a></li>
<li><a href="../479154/index.html">¬øTodav√≠a una pelea o suficiente?</a></li>
<li><a href="../479158/index.html">7 principios fundamentales de ITIL</a></li>
<li><a href="../479162/index.html">Auroras en los planetas del sistema solar.</a></li>
<li><a href="../479164/index.html">¬øQu√© es el EEG y por qu√© es necesario?</a></li>
<li><a href="../479166/index.html">Escribir su m√≥dulo caducado con l√≠mite para tarantool</a></li>
<li><a href="../479168/index.html">C√≥mo crear una API RESTful en la plataforma Symfony 5 + API para un proyecto MODX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>