<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§òüèΩ ü§µüèª üë®üèº‚Äç‚öñÔ∏è O reverso do Neuromancer. Parte 3: Renderiza√ß√£o finalizada, fa√ßa o jogo üßòüèæ ‚öñÔ∏è üëäüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, esta √© a terceira parte de uma s√©rie de minhas publica√ß√µes dedicadas ao desenvolvimento reverso do Neuromancer - uma incorpora√ß√£o de videogame do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O reverso do Neuromancer. Parte 3: Renderiza√ß√£o finalizada, fa√ßa o jogo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415555/"><img src="https://habrastorage.org/webt/wn/4k/jm/wn4kjm-p2fyta0emos5ufhkop_0.png"><br><p>  Ol√°, esta √© a terceira parte de uma s√©rie de minhas publica√ß√µes dedicadas ao desenvolvimento reverso do Neuromancer - uma incorpora√ß√£o de videogame do romance de mesmo nome de William Gibson. </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O reverso do Neuromancer.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 1: Sprites</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O reverso do Neuromancer.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 2: Renderizar fonte</a> </blockquote><p>  Esta parte pode parecer um pouco ca√≥tica.  O fato √© que a maior parte do que √© descrito aqui estava pronta no momento da escrita do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anterior</a> .  Como j√° se passaram dois meses desde ent√£o e, infelizmente, n√£o tenho o h√°bito de manter anota√ß√µes de trabalho, simplesmente esqueci alguns detalhes.  Mas como √©, vamos l√°. </p><a name="habracut"></a><br><hr><br><p> <em>[Depois que aprendi a imprimir linhas, seria l√≥gico continuar a reverter a constru√ß√£o das caixas de di√°logo.</em>  <em>Mas, por algum motivo que me escapou, em vez disso, entrei completamente na an√°lise do sistema de renderiza√ß√£o.]</em> Mais uma vez, percorrendo a <code>main</code> , consegui localizar a chamada, que primeiro exibe algo na tela: <code>seg000:0159: call sub_1D0B2</code> .  "Qualquer coisa", neste caso, √© o cursor e a imagem de fundo do menu principal: </p><br><p><img src="https://habrastorage.org/webt/9l/9h/yq/9l9hyqeu9n7m8vyt8iizlz5wnze.png"><br></p><br><p>  Vale ressaltar que a fun√ß√£o <code>sub_1D0B2</code> <em>[doravante - <code>render</code> ]</em> n√£o possui argumentos, no entanto, sua primeira chamada √© precedida por duas se√ß√µes de c√≥digo quase id√™nticas: </p><br><pre> <code class="hljs perl">loc_100E5: loc_10123: mov ax, <span class="hljs-number"><span class="hljs-number">2</span></span> mov ax, <span class="hljs-number"><span class="hljs-number">2</span></span> mov dx, seg seg009 mov dx, seg seg01<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> dx <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> dx <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax mov ax, <span class="hljs-number"><span class="hljs-number">506</span></span>Ah mov ax, <span class="hljs-number"><span class="hljs-number">5076</span></span>h ; <span class="hljs-string"><span class="hljs-string">"cursors.imh"</span></span>, <span class="hljs-string"><span class="hljs-string">"title.imh"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax call load_imh call load_imh ; load_imh(res, offt, seg) add sp, <span class="hljs-number"><span class="hljs-number">6</span></span> add sp, <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ah</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_123F8</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_123F8</span></span></span><span class="hljs-function"> </span></span>; sub_123F8(<span class="hljs-number"><span class="hljs-number">0</span></span>), sub_123F8(<span class="hljs-number"><span class="hljs-number">10</span></span>) add sp, <span class="hljs-number"><span class="hljs-number">2</span></span> add sp, <span class="hljs-number"><span class="hljs-number">2</span></span> cmp word_5AA92, <span class="hljs-number"><span class="hljs-number">0</span></span> mov ax, <span class="hljs-number"><span class="hljs-number">1</span></span> jz short loc_10123 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dx</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seg</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seg010</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dx</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seg</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seg009</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 64</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ah</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">A0h</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_1CF5B</span></span></span><span class="hljs-function"> </span></span>; sub_1CF5B(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, seg01<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ch</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_1CF5B</span></span></span><span class="hljs-function"> </span></span>; sub_1CF5B(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, seg009, <span class="hljs-number"><span class="hljs-number">0</span></span>) add sp, 0Ch</code> </pre> <br><p>  Antes de chamar <code>render</code> , os cursores ( <code>cursors.imh</code> ) e o plano de fundo ( <code>title.imh</code> ) s√£o descompactados na mem√≥ria ( <code>load_imh</code> √© o <code>sub_126CB</code> renomeado da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira parte</a> ), no nono e no d√©cimo segmentos, respectivamente.  Um estudo superficial da fun√ß√£o <code>sub_123F8</code> n√£o me trouxe nenhuma informa√ß√£o nova, mas, apenas analisando os argumentos de <code>sub_1CF5B</code> , tirei as seguintes conclus√µes: </p><br><ul><li>  os argumentos 4 e 5, juntos, representam o endere√ßo do sprite descomprimido ( <code>segment:offset</code> ); </li><li>  os argumentos 2 e 3 provavelmente s√£o coordenadas, pois esses n√∫meros se correlacionam com a imagem exibida ap√≥s a chamada <code>render</code> ; </li><li>  o √∫ltimo argumento pode ser a bandeira da opacidade do plano de fundo do sprite, porque os sprites descompactados t√™m um plano de fundo preto e vemos o cursor na tela sem ele. </li></ul><br><p>  Com o primeiro argumento <em>[e ao mesmo tempo com a renderiza√ß√£o em geral],</em> tudo ficou claro ap√≥s o rastreamento de <code>sub_1CF5B</code> .  O fato √© que, no segmento de dados, come√ßando com o endere√ßo <code>0x3BD4</code> , est√° localizada uma matriz de 11 estruturas do seguinte tipo: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sprite_layer_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> flags; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> update; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> left; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> top; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> dleft; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> dtop; <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span> sprite_hdr; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sprite_segment; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sprite_pixels; <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span> _sprite_hdr; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> _sprite_segment; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> _sprite_pixels; } <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>;</code> </pre> <br><p>  Eu chamo esse conceito de cadeia de sprites.  De fato, a fun√ß√£o <code>sub_1CF5B</code> (a seguir <code>add_sprite_to_chain</code> ) adiciona o sprite selecionado √† cadeia.  Em uma m√°quina de 16 bits, ela teria aproximadamente a seguinte assinatura: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span> g_sprite_chain[<span class="hljs-number"><span class="hljs-number">11</span></span>]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_sprite_to_chain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> top, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> segment, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opaque)</span></span></span></span>;</code> </pre> <br><p>  Funciona assim: </p><br><ul><li>  o primeiro argumento √© o √≠ndice na matriz <code>g_sprite_chain</code> ; </li><li>  os argumentos <code>left</code> e <code>top</code> s√£o gravados nos <code>g_sprite_chain[index].left</code> <code>g_sprite_chain[index].top</code> e <code>g_sprite_chain[index].top</code> respectivamente; </li><li>  o cabe√ßalho do sprite (os primeiros 8 bytes localizados no <code>segment:offset</code> ) √© copiado para o campo <code>g_sprite_chain[index].sprite_hdr</code> , digite <code>imh_hdr_t</code> (renomeado <code>rle_hdr_t</code> da primeira parte): </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imh_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> unknown; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> width; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> height; } <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>;</code> </pre> <br><ul><li>  o campo <code>g_sprite_chain[index].sprite_segment</code> registra o valor do <code>segment</code> ; </li><li>  no campo <code>g_sprite_chain[index].sprite_pixels</code> , um valor igual ao <code>offset + 8</code> gravado, ent√£o <code>sprite_segment:sprite_pixels</code> √© o endere√ßo do bitmap do sprite adicionado; </li><li>  os <code>sprite_hdr</code> , <code>sprite_segment</code> e <code>sprite_pixels</code> duplicados em <code>_sprite_hdr</code> , <code>_sprite_segment</code> e <code>_sprite_pixels</code> respectivamente <em>[por qu√™?</em>  <em>- N√£o fa√ßo ideia, e este n√£o √© o √∫nico caso dessa duplica√ß√£o de campos]</em> ; </li><li>  no campo <code>g_sprite_chain[index].flags</code> valor igual a <code>1 + (opaque &lt;&lt; 4)</code> gravado <code>1 + (opaque &lt;&lt; 4)</code> .  Esse registro significa que o primeiro bit do valor dos <code>flags</code> indica a "atividade" da camada "atual" e o quinto bit indica a <strong>opacidade do</strong> plano <strong>de</strong> fundo.  <em>[Minhas d√∫vidas sobre a bandeira de transpar√™ncia foram dissipadas depois que eu testei experimentalmente seu efeito na imagem exibida.</em>  <em>Alterando o valor do quinto bit em tempo de execu√ß√£o, podemos observar esses artefatos]:</em> <br><img src="https://habrastorage.org/webt/9z/i8/ui/9zi8uizaa3s9fwsqke4rwa_3jqa.png"><br></li></ul><br><p>  Como j√° mencionei, a fun√ß√£o <code>render</code> n√£o tem argumentos, mas n√£o precisa - ela trabalha diretamente com o array <code>g_sprite_chain</code> , transferindo alternadamente as "camadas" para a mem√≥ria <em>VGA</em> , do √∫ltimo ( <code>g_sprite_chain[10]</code> - background) ao primeiro ( <code>g_sprite_chain[0]</code> - primeiro plano).  A estrutura <code>sprite_layer_t</code> tem todo o necess√°rio para isso e ainda mais.  Estou falando dos campos n√£o revisados <code>update</code> , <code>dleft</code> e <code>dtop</code> . </p><br><p>  De fato, a fun√ß√£o de <code>render</code> redesenha <strong>N√ÉO TODOS os</strong> sprites em cada quadro.  Um valor diferente de zero do campo <code>g_sprite_chain.update</code> indica que o sprite atual precisa ser redesenhado.  Suponha que movamos o cursor ( <code>g_sprite_chain[0]</code> ), algo assim acontecer√° no manipulador de movimento do mouse: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouse_move_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].update = <span class="hljs-number"><span class="hljs-number">1</span></span>; g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dleft = mouse_x - g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].left; g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dtop = mouse_y - g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].top; }</code> </pre> <br><p>  Quando o controle passa para a fun√ß√£o <code>render</code> , a √∫ltima, tendo atingido a camada <code>g_sprite_chain[0]</code> , v√™ que precisa ser atualizada.  Ent√£o: </p><br><ul><li>  a interse√ß√£o da √°rea ocupada pelo sprite do cursor antes da atualiza√ß√£o com todas as camadas anteriores ser√° calculada e desenhada; </li><li>  As coordenadas do sprite ser√£o atualizadas: </li></ul><br><pre> <code class="hljs powershell">g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].update = <span class="hljs-number"><span class="hljs-number">0</span></span>; g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].left += g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dleft g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dleft = <span class="hljs-number"><span class="hljs-number">0</span></span>; g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].top += g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dtop g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dtop = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br><ul><li>  o sprite ser√° desenhado nas coordenadas atualizadas. </li></ul><br><p>  Isso minimiza o n√∫mero de opera√ß√µes executadas pela fun√ß√£o de <code>render</code> . </p><br><hr><br><p>  N√£o foi dif√≠cil implementar essa l√≥gica, embora eu a tenha simplificado bastante.  Considerando o poder computacional dos computadores modernos, podemos redesenhar todos os 11 sprites de cadeia em cada quadro, devido a isso os <code>g_sprite_chain.update</code> , <code>.dleft</code> , <code>.dtop</code> e todo o processamento associado a eles s√£o <code>.dtop</code> .  Outra simplifica√ß√£o diz respeito ao manuseio da bandeira de opacidade.  No c√≥digo original, para cada pixel transparente no sprite, √© pesquisada a interse√ß√£o com o primeiro pixel opaco nas camadas inferiores.  Mas eu uso o modo de v√≠deo de 32 bits e, portanto, posso apenas alterar o valor do byte de transpar√™ncia no esquema <em>RGBA</em> .  Como resultado, eu tenho essas fun√ß√µes de adicionar (excluir) um sprite a (de) uma (s) cadeia (s): </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sprite_layer_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> flags; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> left; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> top; <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span> sprite_hdr; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *sprite_pixels; <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span> _sprite_hdr; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *_sprite_pixels; } <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span> g_sprite_chain[<span class="hljs-number"><span class="hljs-number">11</span></span>]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_sprite_to_chain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> top, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *sprite, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opaque)</span></span></span><span class="hljs-function"> </span></span>{ assert(n &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span> *layer = &amp;g_sprite_chain[n]; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(layer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>)); layer-&gt;left = left; layer-&gt;top = top; memmove(&amp;layer-&gt;sprite_hdr, sprite, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>)); layer-&gt;sprite_pixels = sprite + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>); memmove(&amp;layer-&gt;_sprite_hdr, &amp;layer-&gt;sprite_hdr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)); layer-&gt;flags = ((opaque &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">16</span></span>) | <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove_sprite_from_chain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ assert(n &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span> *layer = &amp;g_sprite_chain[n]; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(layer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>)); }</code> </pre> </div></div><br><p>  A fun√ß√£o de transferir uma camada para um buffer <em>VGA</em> √© a seguinte: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw_to_vga</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> top, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pixels, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bg_transparency)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw_sprite_to_vga</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">sprite_layer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *sprite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> top = sprite-&gt;top; <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> left = sprite-&gt;left; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> w = sprite-&gt;sprite_hdr.width * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> h = sprite-&gt;sprite_hdr.height; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> bg_transparency = ((sprite-&gt;flags &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *pixels = sprite-&gt;sprite_pixels; draw_to_vga(left, top, w, h, pixels, bg_transparency); }</code> </pre> <br><p>  A fun√ß√£o <code>draw_to_vga</code> √© a fun√ß√£o com o mesmo nome descrito na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">segunda parte</a> , mas com um argumento adicional indicando a transpar√™ncia do plano de fundo da imagem.  Adicione a chamada <code>draw_sprite_to_vga</code> ao in√≠cio da fun√ß√£o de <code>render</code> (o restante de seu conte√∫do migrou da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">segunda parte</a> ): </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(g_sprite_chain[i].flags &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } draw_sprite_to_vga(&amp;g_sprite_chain[i]); } ... }</code> </pre> <br><p>  Tamb√©m escrevi uma fun√ß√£o que atualiza a posi√ß√£o do sprite do cursor, dependendo da posi√ß√£o atual do ponteiro do mouse ( <code>update_cursor</code> ) e de um gerenciador de recursos simples.  Fazemos todo esse trabalho juntos: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">spite_chain_index_t</span></span> { SCI_CURSOR = <span class="hljs-number"><span class="hljs-number">0</span></span>, SCI_BACKGRND = <span class="hljs-number"><span class="hljs-number">10</span></span>, SCI_TOTAL = <span class="hljs-number"><span class="hljs-number">11</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">spite_chain_index_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> g_cursors[<span class="hljs-number"><span class="hljs-number">399</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* seg009 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> g_background[<span class="hljs-number"><span class="hljs-number">32063</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* seg010 */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[])</span></span></span><span class="hljs-function"> </span></span>{ ... assert(resource_manager_load(<span class="hljs-string"><span class="hljs-string">"CURSORS.IMH"</span></span>, g_cursors)); add_sprite_to_chain(SCI_CURSOR, <span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, g_cursors, <span class="hljs-number"><span class="hljs-number">0</span></span>); assert(resource_manager_load(<span class="hljs-string"><span class="hljs-string">"TITLE.IMH"</span></span>, g_background)); add_sprite_to_chain(SCI_BACKGRND, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, g_background, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sfRenderWindow_isOpen(g_window)) { ... update_cursor(); render(); } ... }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Cursor.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lw/ji/sm/lwjismkxi7ewlzw9m9zahx3imjy.gif"></div></div><br><hr><br><p>  Ok, para um menu principal completo, o menu em si n√£o √© suficiente.  √â hora de voltar √† revers√£o das caixas de di√°logo.  <em>[Da √∫ltima vez, <code>draw_frame</code> fun√ß√£o <code>draw_frame</code> , que forma a caixa de di√°logo e, em parte, a fun√ß√£o <code>draw_string</code> , usando apenas a l√≥gica de renderiza√ß√£o de texto.]</em> Olhando para o novo <code>draw_frame</code> , vi que a fun√ß√£o <code>add_sprite_to_chain</code> era usada l√° - nada surpreendente, basta adicionar uma caixa de di√°logo em cadeia de sprite.  Era necess√°rio lidar com o posicionamento do texto dentro da caixa de di√°logo.  Deixe-me lembr√°-lo de como √© a chamada para <code>draw_string</code> : </p><br><pre> <code class="hljs perl"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 5098</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-string"><span class="hljs-string">"New/Load"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax call draw_string ; draw_string(<span class="hljs-string"><span class="hljs-string">"New/Load"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><p>  e a estrutura preenchendo <code>draw_frame</code> <em>[aqui est√° um pouco √† frente, pois</em> <code>draw_frame</code> <em>maioria dos elementos depois de descobrir completamente a <code>draw_string</code> .</em>  <em>A prop√≥sito, aqui, como no caso de <code>sprite_layer_t</code> , h√° uma duplica√ß√£o de campos]</em> : </p><br><pre> <code class="hljs powershell">typedef struct neuro_dialog_t { uint16_t left; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x65FA</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x20 uint16_t top; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x65FC</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x98 uint16_t right; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x65FE</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x7F uint16_t bottom; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6600</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xAF uint16_t inner_left; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6602</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x28 uint16_t inner_top; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6604</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA0 uint16_t inner_right; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6604</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA0 uint16_t inner_bottom; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6608</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA7 uint16_t _inner_left; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x660A</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x28 uint16_t _inner_top; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x660C</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA0 uint16_t _inner_right; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x660E</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x77 uint16_t _inner_bottom; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6610</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA7 uint16_t flags; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6612</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x06 uint16_t unknown; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6614</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x00 uint8_t padding[<span class="hljs-number"><span class="hljs-number">192</span></span>] // ... uint16_t width; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x66D6</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x30 uint16_t pixels_offset; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x66D8</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x02 uint16_t pixels_segment; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x66DA</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x22FB } neuro_dialog_t;</code> </pre> <br><p>  Em vez de explicar o que est√° aqui, como e por que, apenas deixo esta imagem: </p><br><img src="https://habrastorage.org/webt/db/tf/nw/dbtfnw8fn1qx9aktubuvwojuw7y.png"><br><p>  As vari√°veis <code>x_offt</code> e <code>y_offt</code> s√£o o segundo e o terceiro argumentos para a fun√ß√£o <code>draw_string</code> respectivamente.  Com base nessas informa√ß√µes, foi f√°cil criar suas pr√≥prias vers√µes de <code>draw_frame</code> e <code>draw_text</code> , depois de renome√°-las para <code>build_dialog_frame</code> e <code>build_dialog_text</code> : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_dialog_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">neuro_dialog_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dialog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> top, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pixels)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_dialog_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">neuro_dialog_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dialog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *text, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x_offt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y_offt)</span></span></span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">spite_chain_index_t</span></span> { SCI_CURSOR = <span class="hljs-number"><span class="hljs-number">0</span></span>, SCI_DIALOG = <span class="hljs-number"><span class="hljs-number">2</span></span>, ... } <span class="hljs-keyword"><span class="hljs-keyword">spite_chain_index_t</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *g_dialog = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">neuro_dialog_t</span></span> g_menu_dialog; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[])</span></span></span><span class="hljs-function"> </span></span>{ ... assert(g_dialog = <span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(<span class="hljs-number"><span class="hljs-number">8192</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); build_dialog_frame(&amp;g_menu_dialog, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, g_dialog); build_dialog_text(&amp;g_menu_dialog, <span class="hljs-string"><span class="hljs-string">"New/Load"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); add_sprite_to_chain(SCI_DIALOG, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, g_dialog, <span class="hljs-number"><span class="hljs-number">1</span></span>); ... }</code> </pre> <br><img src="https://habrastorage.org/webt/ms/xt/bg/msxtbgydwxelkcfgng8vdud10ee.png"><br><p>  A principal diferen√ßa entre minhas vers√µes e as originais √© que eu uso valores absolutos de tamanhos de pixel - √© mais f√°cil. </p><br><hr><br><p>  Mesmo assim, eu tinha certeza de que a se√ß√£o de c√≥digo imediatamente ap√≥s a chamada para <code>build_dialog_text</code> respons√°vel pela cria√ß√£o dos bot√µes: </p><br><pre> <code class="hljs perl"> ... mov ax, <span class="hljs-number"><span class="hljs-number">5098</span></span>h ; <span class="hljs-string"><span class="hljs-string">"New/Load"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax call build_dialog_text ; build_dialog_text(<span class="hljs-string"><span class="hljs-string">"New/Load"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) add sp, <span class="hljs-number"><span class="hljs-number">6</span></span> mov ax, <span class="hljs-number"><span class="hljs-number">6</span></span>Eh ; <span class="hljs-string"><span class="hljs-string">'n'</span></span> -  <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 3 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_181A3</span></span></span><span class="hljs-function"> </span></span>; sub_181A3(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'n'</span></span>) add sp, 0Ah mov ax, <span class="hljs-number"><span class="hljs-number">6</span></span>Ch ; <span class="hljs-string"><span class="hljs-string">'l'</span></span> -      <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax mov ax, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax mov ax, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 5 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_181A3</span></span></span><span class="hljs-function"> </span></span>; sub_181A3(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'l'</span></span>)</code> </pre> <br><p>  √â tudo sobre esses coment√°rios gerados - <code>'n'</code> e <code>'l'</code> , que s√£o obviamente as primeiras letras das palavras <code>"New"</code> e <code>"load"</code> .  Al√©m disso, se argumentarmos por analogia com o <code>build_dialog_text</code> , os quatro primeiros argumentos do <code>sub_181A3</code> (doravante - <code>build_dialog_item</code> ) podem ser fatores de coordenadas e tamanhos <em>[de fato, os tr√™s primeiros argumentos, o quarto, como se viu, sobre o outro]</em> .  Tudo converge se voc√™ sobrepuser esses valores na imagem da seguinte maneira: </p><br><img src="https://habrastorage.org/webt/xy/gw/hj/xygwhjq2ykcj7wf9z0dbtzhzr7q.png"><br><p>  As vari√°veis <code>x_offt</code> , <code>y_offt</code> e <code>width</code> na imagem s√£o, respectivamente, os tr√™s primeiros argumentos da fun√ß√£o <code>build_dialog_item</code> .  A altura deste ret√¢ngulo √© sempre igual √† altura do s√≠mbolo - oito.  Ap√≥s uma an√°lise <code>build_dialog_item</code> do <code>build_dialog_item</code> , descobri que o que <code>neuro_dialog_t</code> estrutura <code>neuro_dialog_t</code> como <code>padding</code> (agora <code>items</code> ) √© uma matriz de 16 estruturas da seguinte forma: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dialog_item_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> left; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> top; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> right; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> bottom; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> unknown; <span class="hljs-comment"><span class="hljs-comment">/* index? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> letter; } <span class="hljs-keyword"><span class="hljs-keyword">dialog_item_t</span></span>;</code> </pre> <br><p>  E o campo <code>neuro_dialog_t.unknown</code> (agora - <code>neuro_dialog_t.items_count</code> ) √© o contador do n√∫mero de itens no menu: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">neuro_dialog_t</span></span></span><span class="hljs-class"> {</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> flags; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> items_count; <span class="hljs-keyword"><span class="hljs-keyword">dialog_item_t</span></span> items[<span class="hljs-number"><span class="hljs-number">16</span></span>]; ... } <span class="hljs-keyword"><span class="hljs-keyword">neuro_dialog_t</span></span>;</code> </pre> <br><p>  O campo <code>dialog_item_t.unknown</code> inicializado com o quarto argumento da fun√ß√£o <code>build_dialog_item</code> .  Talvez este seja o √≠ndice do elemento na matriz, mas parece que esse nem sempre √© o caso e, portanto, <code>unknown</code> .  O campo <code>dialog_item_t.letter</code> inicializado com o quinto argumento da fun√ß√£o <code>build_dialog_item</code> .  Novamente, √© poss√≠vel que, no manipulador do bot√£o esquerdo, o jogo verifique as coordenadas do ponteiro do mouse na √°rea de um dos itens (apenas classificando-os em ordem, por exemplo), e se houver um acerto, o manipulador desejado para clicar em um bot√£o espec√≠fico √© selecionado nesse campo.  <em>[N√£o sei como isso √© realmente feito, mas implementei exatamente essa l√≥gica.]</em> </p><br><p>  Isso √© suficiente para criar um menu principal completo, n√£o olhando para o c√≥digo original, mas simplesmente repetindo o comportamento observado no jogo. </p><br><div class="spoiler">  <b class="spoiler_title">Main_Menu.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/we/q8/ni/weq8ni9fy9vuusoaitjgazjt6e4.gif"></div></div><br><hr><br><p>  Se voc√™ assistiu o gif anterior at√© o final, provavelmente notou a tela do jogo inicial nos √∫ltimos quadros.  Na verdade, eu j√° tenho tudo para desenhar.  Basta pegar e baixar os sprites necess√°rios e adicion√°-los √† cadeia de sprites.  No entanto, ao colocar o sprite do personagem principal no palco, fiz uma importante descoberta relacionada √† estrutura <code>imh_hdr_t</code> . </p><br><p>  No c√≥digo original, a fun√ß√£o <code>add_sprite_to_chain</code> , que adiciona a imagem do protagonista √† cadeia, √© chamada com as coordenadas 156 e 110. Aqui est√° o que eu vi, repetindo isso sozinho: </p><br><img src="https://habrastorage.org/webt/i1/5s/yf/i15syfep7bdhuhxgsbkhr-bxev4.png" align="left"><br><p>  Tendo descoberto o que √© o qu√™, obtive o seguinte tipo de estrutura <code>imh_hdr_t</code> : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imh_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> dx; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> dy; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> width; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> height; } <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>;</code> </pre> <br><p>  O que costumava ser um campo <code>unknown</code> acabou sendo valores de deslocamento que s√£o subtra√≠dos das coordenadas correspondentes (durante a renderiza√ß√£o) armazenadas na cadeia de sprites. </p><br><p><br clear="left"></p><br><p>  Assim, a coordenada real do canto superior esquerdo do sprite desenhado √© calculada aproximadamente da seguinte maneira: </p><br><pre> <code class="hljs cpp">left = <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>.left - <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>.sprite_hdr.dx top = <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>.top - <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>.sprite_hdr.dy</code> </pre> <br><p>  Aplicando isso no meu c√≥digo, obtive a imagem correta e, depois disso, comecei a reviver o personagem principal.  De fato, escrevi todo o c√≥digo relacionado ao controle do personagem (mouse e teclado), sua anima√ß√£o e movimento por conta pr√≥pria, sem olhar para o original. </p><br><div class="spoiler">  <b class="spoiler_title">Moonwalk.gif</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tw/ei/m2/tweim2zx4hrsefql82ny-elnimc.gif"></div></div><br><hr><br><p>  Obteve uma introdu√ß√£o de texto para o primeiro n√≠vel.  Deixe-me lembr√°-lo de que os recursos de string s√£o armazenados em arquivos <code>.BIH</code> .  Arquivos <code>.BIH</code> consistem em um cabe√ßalho de tamanho vari√°vel e uma sequ√™ncia de seq√º√™ncias terminadas em nulo.  Examinando o c√≥digo original que reproduz a introdu√ß√£o, descobri que o deslocamento do in√≠cio da parte do texto no arquivo <code>.BIH</code> est√° contido na quarta palavra do cabe√ßalho.  A primeira linha √© a introdu√ß√£o: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bih_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> unknown[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> text_offset; } <span class="hljs-keyword"><span class="hljs-keyword">bih_hdr_t</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> r1_bih[<span class="hljs-number"><span class="hljs-number">12288</span></span>]; assert(resource_manager_load(<span class="hljs-string"><span class="hljs-string">"R1.BIH"</span></span>, r1_bih)); <span class="hljs-keyword"><span class="hljs-keyword">bih_hdr_t</span></span> *hdr = (<span class="hljs-keyword"><span class="hljs-keyword">bih_hdr_t</span></span>*)r1_bih; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *intro = r1_bih + hdr-&gt;text_offset;</code> </pre> <br><p>  Al√©m disso, confiando no original, implementei a divis√£o da sequ√™ncia original em substrings para que eles se ajustassem √† √°rea de sa√≠da de texto, percorrendo essas linhas e aguardando a entrada antes da emiss√£o do pr√≥ximo lote. </p><br><div class="spoiler">  <b class="spoiler_title">Intro.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/uk/oa/ag/ukoaagah17k7eegsy4unobeskbg.gif"></div></div><br><hr><br><p>  No momento da publica√ß√£o, al√©m do que j√° foi descrito em tr√™s partes, descobri a reprodu√ß√£o do som.  At√© agora, isso est√° apenas na minha cabe√ßa e levar√° algum tempo para perceber isso no meu projeto.  Portanto, a quarta parte provavelmente ser√° inteiramente sobre o som.  Tamb√©m pretendo contar um pouco sobre a arquitetura do projeto, mas vamos ver como ele vai. </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O reverso do Neuromancer.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 4: Som, Anima√ß√£o, Huffman, Github</a> </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt415555/">https://habr.com/ru/post/pt415555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt415545/index.html">Instale o Veeam Backup & Replication usando um script do PowerShell</a></li>
<li><a href="../pt415547/index.html">Um pouco sobre OSDAY ou O que voc√™ precisa para ensinar os alunos a come√ßar a trabalhar nas empresas de TI russas e a ficar l√°</a></li>
<li><a href="../pt415549/index.html">Como as scooters el√©tricas capturaram o Vale do Sil√≠cio e por que as odeiam</a></li>
<li><a href="../pt415551/index.html">As chamadas VoLTE / ViLTE + Wi-Fi s√£o praticamente complicadas</a></li>
<li><a href="../pt415553/index.html">Resumo de materiais frescos do mundo das tecnologias AR</a></li>
<li><a href="../pt415557/index.html">Rede neural do codec 2 + = podcast inteiro em um disquete</a></li>
<li><a href="../pt415559/index.html">A hist√≥ria do desenvolvimento de call centers ou como as tecnologias mudaram o trabalho dos operadores com os clientes</a></li>
<li><a href="../pt415561/index.html">Como enviar eventos do Veeam Backup & Replication para mensageiros instant√¢neos</a></li>
<li><a href="../pt415563/index.html">O tratamento do Scrum "mec√¢nico". Parte 2. Equipe</a></li>
<li><a href="../pt415565/index.html">Por que (hoje) o retorno 444 nem sempre √© √∫til</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>