<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒ• ğŸ‘¨ğŸ¾â€ğŸš’ ğŸ¤¦ğŸ¿ Indexation de milliards de vecteurs de texte ğŸ’œ ğŸ†’ â˜ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lors de l'extraction d'informations, la tÃ¢che se pose souvent de trouver de tels fragments de texte. Dans le cadre d'une recherche, une requÃªte peut Ãª...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Indexation de milliards de vecteurs de texte</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/479692/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/id/dd/fg/idddfg6zku7xq-zv9f0m8xemyiy.jpeg"></div><br>  Lors de l'extraction d'informations, la tÃ¢che se pose souvent de trouver de <i>tels</i> fragments de texte.  Dans le cadre d'une recherche, une requÃªte peut Ãªtre gÃ©nÃ©rÃ©e par l'utilisateur (par exemple, le texte que l'utilisateur saisit dans le moteur de recherche) ou par le systÃ¨me lui-mÃªme.  Souvent, nous devons faire correspondre une requÃªte entrante avec des requÃªtes dÃ©jÃ  indexÃ©es.  Dans cet article, nous verrons comment vous pouvez crÃ©er un systÃ¨me qui rÃ©sout ce problÃ¨me par rapport Ã  des milliards de demandes sans dÃ©penser une fortune sur l'infrastructure du serveur. <br><a name="habracut"></a><br>  Tout d'abord, nous dÃ©finissons formellement le problÃ¨me: <br><br><blockquote>  Ã‰tant donnÃ© un ensemble fixe de requÃªtes <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-1"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-2">Q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-1"> Q </script>  demande entrante <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-3"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-4">q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-2"> q </script>  et entier <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-5"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-6">k</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-3"> k </script>  .  Besoin de trouver un tel sous-ensemble de requÃªtes <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-7"><span class="noError" id="MJXp-Span-8" style="display: inline-block;">R&nbsp;=&nbsp;\&nbsp;left&nbsp;\&nbsp;{q0,&nbsp;q1,&nbsp;...,&nbsp;qk&nbsp;\&nbsp;right&nbsp;\}&nbsp;\&nbsp;sous-ensemble&nbsp;Q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-4"> R = \ left \ {q0, q1, ..., qk \ right \} \ sous-ensemble Q </script>  Ã  chaque demande <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-9"><span class="MJXp-msubsup" id="MJXp-Span-10"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-11" style="margin-right: 0.05em;">q</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-12" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-13">i</span></span></span><span class="MJXp-mtext" id="MJXp-Span-14">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-15">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-16">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-17">R</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-5"> q_ {i} \ en R </script>  Ã©tait plus comme <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-18"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-19">q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-6"> q </script>  que toute autre demande <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-20"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-21">Q</span><span class="MJXp-mo" id="MJXp-Span-22" style="margin-left: 0.267em; margin-right: 0.267em;">âˆ–</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-23">R</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-7"> Q âˆ– R </script>  . </blockquote><br>  Par exemple, avec cet ensemble de requÃªtes <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-24"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-25">Q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-8"> Q </script>  : <br><br><pre><code class="plaintext hljs">{tesla cybertruck, beginner bicycle gear, eggplant dishes, tesla new car, how expensive is cybertruck, vegetarian food, shimano 105 vs ultegra, building a carbon bike, zucchini recipes}</code> </pre> <br>  et <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-26"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-27">k</span><span class="MJXp-mo" id="MJXp-Span-28" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-29">3</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-9"> k = 3 </script>  Vous pouvez vous attendre Ã  ce rÃ©sultat: <br><br><div class="scrollable-table"><table><tbody><tr><th>  Demande d'entrÃ©e <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-30"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-31">q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-10"> q </script><br></th><th>  RequÃªtes similaires <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-32"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-33">R</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-11"> R </script><br></th></tr><tr><td>  ramassage tesla <br></td><td>  {tesla cybertruck, tesla new car, combien coÃ»te le cybertruck} <br></td></tr><tr><td>  meilleur vÃ©lo 2019 <br></td><td>  {shimano 105 vs ultegra, les vÃ©los en carbone sont-ils meilleurs, l'Ã©quipement de vÃ©lo} <br></td></tr><tr><td>  cuisiner avec des lÃ©gumes <br></td><td>  {plats d'aubergines, recettes de courgettes, plats vÃ©gÃ©tariens} <br></td></tr></tbody></table></div><br>  Veuillez noter que nous n'avons pas encore dÃ©fini de critÃ¨re de <i>similitude</i> .  Dans ce contexte, cela peut signifier presque n'importe quoi, mais cela se rÃ©sume gÃ©nÃ©ralement Ã  une certaine forme de similitude basÃ©e sur des mots clÃ©s ou des vecteurs.  En utilisant la similitude basÃ©e sur les mots clÃ©s, nous pouvons trouver deux requÃªtes similaires si elles contiennent suffisamment de mots communs.  Par exemple, les requÃªtes Â«ouverture d'un restaurant Ã  munichÂ» et Â«meilleur restaurant de munichÂ» sont similaires car elles contiennent les mots Â«restaurantÂ» et Â«munichÂ».  Et les requÃªtes Â«meilleur restaurant de munichÂ» et Â«oÃ¹ manger Ã  munichÂ» sont dÃ©jÃ  moins similaires, car elles n'ont qu'un seul mot commun.  Cependant, quelqu'un qui cherche un restaurant Ã  Munich serait mieux si la deuxiÃ¨me paire de demandes s'avÃ©rait similaire.  Et en cela, nous allons aider la comparaison basÃ©e sur des vecteurs. <br><br><h1>  ReprÃ©sentation vectorielle des mots </h1><br>  La reprÃ©sentation vectorielle des mots est une technique d'apprentissage automatique utilisÃ©e dans le traitement du langage naturel pour convertir du texte ou des mots en vecteurs.  DÃ©placer la tÃ¢che dans l'espace vectoriel, nous pouvons utiliser des opÃ©rations mathÃ©matiques avec des vecteurs - additionner et calculer les distances.  Pour Ã©tablir des liens entre des mots similaires, vous pouvez utiliser des mÃ©thodes traditionnelles de regroupement vectoriel.  <i>La signification de</i> ces opÃ©rations dans l'espace de mots d'origine n'est peut-Ãªtre pas Ã©vidente, mais l'avantage est que nous avons maintenant accÃ¨s Ã  un large Ã©ventail d'outils mathÃ©matiques.  Si vous Ãªtes intÃ©ressÃ© par des dÃ©tails sur les vecteurs de mots et leur application, lisez Ã  propos de <a href="https://arxiv.org/pdf/1301.3781.pdf">word2vec</a> et <a href="https://nlp.stanford.edu/pubs/glove.pdf">GloVe</a> . <br><br>  Nous avons un moyen de gÃ©nÃ©rer des vecteurs Ã  partir de mots, nous allons maintenant les collecter en vecteurs de texte (vecteurs de documents ou d'expressions).  La faÃ§on la plus simple de le faire est d'ajouter (ou de faire la moyenne) les vecteurs de tous les mots du texte. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/692/bc5/b0c/692bc5b0ccbbe7a89392528365645708.png"><br>  <i><sup>Figure 1: vecteurs de requÃªte.</sup></i> <br><br>  Vous pouvez maintenant dÃ©terminer la similitude de deux morceaux de texte (ou requÃªtes) en les reprÃ©sentant dans l'espace vectoriel et en calculant la distance entre les vecteurs.  En rÃ¨gle gÃ©nÃ©rale, une distance angulaire est utilisÃ©e pour cela. <br><br>  Par consÃ©quent, la reprÃ©sentation vectorielle des mots permet une correspondance textuelle d'un type diffÃ©rent, qui complÃ¨te la correspondance basÃ©e sur des mots clÃ©s.  Vous pouvez explorer la similitude sÃ©mantique des demandes (par exemple, "meilleur restaurant de munich" et "oÃ¹ manger Ã  munich"), comme nous ne pouvions pas le faire auparavant. <br><br><h1>  Recherche approximative du voisin le plus proche </h1><br>  Maintenant, nous pouvons affiner notre problÃ¨me de correspondance de requÃªte d'origine: <br><br><blockquote>  Ã‰tant donnÃ© un ensemble fixe de vecteurs de requÃªte <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-34"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-35">Q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-12-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-12"> Q </script>  vecteur entrant <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-36"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-37">q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-13-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-13"> q </script>  et entier <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-38"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-39">k</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-14-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-14"> k </script>  .  Vous devez trouver un tel sous-ensemble de vecteurs <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-40"><span class="noError" id="MJXp-Span-41" style="display: inline-block;">R&nbsp;=&nbsp;\&nbsp;left&nbsp;\&nbsp;{q0,&nbsp;q1,&nbsp;...,&nbsp;qk&nbsp;\&nbsp;right&nbsp;\}&nbsp;\&nbsp;sous-ensemble&nbsp;Q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-15-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-15"> R = \ left \ {q0, q1, ..., qk \ right \} \ sous-ensemble Q </script>  de sorte que la distance angulaire de <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-42"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-43">q</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-16-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-16"> q </script>  Ã  chaque vecteur <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-44"><span class="MJXp-msubsup" id="MJXp-Span-45"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-46" style="margin-right: 0.05em;">q</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-47" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-48">i</span></span></span><span class="MJXp-mtext" id="MJXp-Span-49">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-50">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-51">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-52">R</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-17-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-17"> q_ {i} \ en R </script>  Ã©tait plus courte que la distance Ã  tout autre vecteur <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-53"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-54">Q</span><span class="MJXp-mo" id="MJXp-Span-55" style="margin-left: 0.267em; margin-right: 0.267em;">âˆ–</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-56">R</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-18-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-18"> Q âˆ– R </script>  . </blockquote><br>  C'est ce qu'on appelle la tÃ¢che de trouver le plus proche voisin.  Il existe un <a href="https://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25B4%25D0%25B0%25D1%2587%25D0%25B0_%25D0%25BF%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA%25D0%25B0_%25D0%25B1%25D0%25BB%25D0%25B8%25D0%25B6%25D0%25B0%25D0%25B9%25D1%2588%25D0%25B5%25D0%25B3%25D0%25BE_%25D1%2581%25D0%25BE%25D1%2581%25D0%25B5%25D0%25B4%25D0%25B0">certain nombre d'algorithmes</a> pour sa solution rapide dans les espaces de faible dimension.  Mais lorsque nous travaillons avec des reprÃ©sentations vectorielles de mots, nous opÃ©rons gÃ©nÃ©ralement avec des vecteurs de haute dimension (100-1000 dimensions).  Et ici, les mÃ©thodes mentionnÃ©es ne fonctionnent plus. <br><br>  Il n'existe aucun moyen appropriÃ© de dÃ©terminer rapidement les voisins les plus proches dans des espaces de grande dimension.  Par consÃ©quent, nous simplifions le problÃ¨me en permettant l'utilisation de rÃ©sultats approximatifs: au lieu de toujours renvoyer <i>les</i> vecteurs <i>les</i> plus proches, nous nous contenterons seulement de certains des voisins les plus proches ou <i>dans une certaine mesure</i> proches.  C'est ce qu'on appelle la recherche approximative de la tÃ¢che des voisins les plus proches et c'est un domaine de recherche active. <br><br><h3>  Petit monde hiÃ©rarchique </h3><br>  Le graphique hiÃ©rarchique du petit monde navigable ( <a href="https://arxiv.org/abs/1603.09320">HNSW</a> ) est l'un des algorithmes les plus rapides pour la recherche approximative des voisins les plus proches.  L'index de recherche dans HNSW est une structure Ã  plusieurs niveaux dans laquelle chaque niveau est un graphe de proximitÃ©.  Chaque nÅ“ud de graphe correspond Ã  l'un des vecteurs de requÃªte. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/42e/55e/4b7/42e55e4b72cd088b45e5aff56159f7fb.png"><br>  <sup><i>Figure 2: Graphique de proximitÃ© Ã  plusieurs niveaux.</i></sup> <br>  La recherche de voisins les plus proches dans HNSW utilise la mÃ©thode de zoom avant.  Il commence dans le nÅ“ud d'entrÃ©e du plus haut niveau et effectue rÃ©cursivement une traversÃ©e de graphe gourmande Ã  chaque niveau jusqu'Ã  ce qu'il atteigne un minimum local en bas. <br><br>  Les dÃ©tails sur l'algorithme et la technique de recherche sont bien dÃ©crits dans les travaux scientifiques.  Il est important de se rappeler que chaque cycle de recherche des voisins les plus proches consiste Ã  parcourir les nÅ“uds des graphes avec calcul des distances entre les vecteurs.  Nous examinerons ces Ã©tapes ci-dessous pour utiliser cette mÃ©thode pour crÃ©er un index Ã  grande Ã©chelle. <br><br><h1>  La difficultÃ© d'indexer des milliards de requÃªtes </h1><br>  Supposons que nous devons indexer 4 milliards de vecteurs de requÃªte Ã  200 dimensions, chaque dimension Ã©tant reprÃ©sentÃ©e par un nombre Ã  virgule flottante de quatre octets (4 milliards suffisent pour rendre la tÃ¢che intÃ©ressante, mais vous pouvez toujours stocker les ID de nÅ“ud dans des nombres normaux Ã  quatre octets) .  Un calcul approximatif nous indique que la taille des vecteurs seuls sera d'environ 3 To.  Comme la plupart des bibliothÃ¨ques existantes utilisent une capacitÃ© RAM pour une recherche approximative des voisins les plus proches, nous aurons besoin d'un trÃ¨s grand serveur pour pousser au moins des vecteurs dans la RAM.  Veuillez noter que cela ne prend pas en compte l'index de recherche supplÃ©mentaire, qui est nÃ©cessaire pour la plupart des mÃ©thodes. <br><br>  Dans toute l'histoire du dÃ©veloppement de notre moteur de recherche, nous avons utilisÃ© plusieurs approches diffÃ©rentes pour rÃ©soudre ce problÃ¨me.  Examinons certains d'entre eux. <br><br><h3>  Sous-ensemble de donnÃ©es </h3><br>  La premiÃ¨re et la plus simple approche, qui ne nous a pas permis de rÃ©soudre complÃ¨tement le problÃ¨me, a Ã©tÃ© de limiter le nombre de vecteurs dans l'indice.  En prenant un dixiÃ¨me des donnÃ©es, nous avons crÃ©Ã© un index qui nÃ©cessite - surprise - 10% de mÃ©moire.  Cependant, la qualitÃ© de la recherche s'est dÃ©tÃ©riorÃ©e, car nous avons maintenant opÃ©rÃ© avec moins de requÃªtes. <br><br><h3>  Quantification </h3><br>  Ici, nous avons utilisÃ© toutes les donnÃ©es, mais nous les avons rÃ©duites en utilisant la <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B2%25D0%25B0%25D0%25BD%25D1%2582%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">quantification</a> (nous avons utilisÃ© diffÃ©rentes techniques de quantification, par exemple, la quantification des produits, mais nous n'avons pas pu atteindre la qualitÃ© de travail souhaitÃ©e avec cette quantitÃ© de donnÃ©es).  En arrondissant certaines erreurs, nous avons pu remplacer tous les nombres Ã  quatre octets dans les vecteurs d'origine par des versions quantifiÃ©es Ã  un octet.  La quantitÃ© de RAM pour les vecteurs a diminuÃ© de 75%.  Cependant, nous avions encore besoin de 750 Go de mÃ©moire (sans compter la taille de l'index lui-mÃªme), et c'est toujours un trÃ¨s grand serveur. <br><br><h1>  RÃ©solution des problÃ¨mes de mÃ©moire avec Granne </h1><br>  Les approches dÃ©crites avaient leurs avantages, mais elles nÃ©cessitaient beaucoup de ressources et donnaient une mauvaise qualitÃ© de recherche.  Bien <a href="http://ann-benchmarks.com/">qu'il existe des bibliothÃ¨ques</a> qui rÃ©pondent en moins de 1 ms, nous pourrions sacrifier la vitesse en Ã©change d'exigences matÃ©rielles plus faibles. <br><br>  <a href="https://github.com/granne/granne">Granne</a> (graphique-based voisins les plus proches) est une bibliothÃ¨que HNSW dÃ©veloppÃ©e et utilisÃ©e par Cliqz pour rechercher de telles requÃªtes.  Il a du code open source, mais la bibliothÃ¨que est toujours en dÃ©veloppement actif.  Une version amÃ©liorÃ©e sera publiÃ©e sur <a href="https://crates.io/">crates.io</a> en 2020.  Il est Ã©crit en rouille avec des inserts en Python, conÃ§u pour gÃ©rer des milliards de vecteurs en utilisant la compÃ©titivitÃ©.  Du point de vue des vecteurs de requÃªte, il est intÃ©ressant de noter que Granne dispose d'un mode spÃ©cial qui nÃ©cessite beaucoup moins de mÃ©moire par rapport aux autres bibliothÃ¨ques. <br><br><h3>  ReprÃ©sentation compacte des vecteurs de requÃªte </h3><br>  RÃ©duire la taille des vecteurs de requÃªte nous apportera de nombreux avantages.  Pour ce faire, revenons en arriÃ¨re et envisageons de crÃ©er des vecteurs.  Ã‰tant donnÃ© que les requÃªtes sont composÃ©es de mots et que les vecteurs de requÃªte sont des sommes de vecteurs de mots, nous pouvons explicitement refuser de stocker des vecteurs de requÃªte et les calculer si nÃ©cessaire. <br><br>  Vous pouvez stocker des requÃªtes sous forme d'ensembles de mots et utiliser la table de recherche pour trouver les vecteurs correspondants.  Cependant, nous Ã©vitons la redirection en stockant chaque requÃªte sous la forme d'une liste d'ID entiers correspondant aux vecteurs de mots dans la requÃªte.  Par exemple, enregistrez la requÃªte Â«meilleur restaurant de munichÂ» sous <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-57"><span class="MJXp-mo" id="MJXp-Span-58" style="margin-left: 0em; margin-right: 0em;">[</span><span class="MJXp-mrow" id="MJXp-Span-59"><span class="MJXp-msubsup" id="MJXp-Span-60"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-61" style="margin-right: 0.05em;">i</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-62" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-63">b</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-64">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-65">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-66">t</span></span></span></span><span class="MJXp-mo" id="MJXp-Span-67" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mrow" id="MJXp-Span-68"><span class="MJXp-msubsup" id="MJXp-Span-69"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-70" style="margin-right: 0.05em;">i</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-71" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-72">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-73">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-74">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-75">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-76">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-77">u</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-78">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-79">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-80">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-81">t</span></span></span></span><span class="MJXp-mo" id="MJXp-Span-82" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mrow" id="MJXp-Span-83"><span class="MJXp-msubsup" id="MJXp-Span-84"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-85" style="margin-right: 0.05em;">i</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-86" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-87">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-88">f</span></span></span></span><span class="MJXp-mo" id="MJXp-Span-89" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mrow" id="MJXp-Span-90"><span class="MJXp-msubsup" id="MJXp-Span-91"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-92" style="margin-right: 0.05em;">i</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-93" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-94">m</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-95">u</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-96">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-97">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-98">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-99">h</span></span></span></span><span class="MJXp-mo" id="MJXp-Span-100" style="margin-left: 0em; margin-right: 0em;">]</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-19-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-19"> [{i_ {best}}, {i_ {restaurant}}, {i_ {of}}, {i_ {munich}}] </script>  oÃ¹ <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-101"><span class="MJXp-mrow" id="MJXp-Span-102"><span class="MJXp-msubsup" id="MJXp-Span-103"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-104" style="margin-right: 0.05em;">i</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-105" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-106">b</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-107">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-108">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-109">t</span></span></span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-20-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-20"> {i_ {best}} </script>  - c'est l'ID de vecteur du mot Â«meilleurÂ», etc. Supposons que nous ayons moins de 16 millions de vecteurs de mots (plus que ce montant coÃ»tera 1 octet par mot), alors vous pouvez utiliser 3 octets pour reprÃ©senter tous les ID de mot.  Autrement dit, au lieu de stocker 800 octets (ou 200 octets dans le cas de vecteurs quantifiÃ©s), nous ne stockerons que 12 octets pour cette demande (ce n'est pas tout Ã  fait vrai. Comme les demandes se composent d'un nombre diffÃ©rent de mots, nous devons Ã©galement stocker l'offset de la liste dans l'index des mots. Pour cela nÃ©cessitera 5 octets par demande). <br><br>  Quant aux vecteurs de mots, nous en avons tous besoin.  Cependant, le nombre de mots est beaucoup plus petit que le nombre de requÃªtes pouvant Ãªtre crÃ©Ã©es en combinant ces mots.  Et cela signifie que la taille des mots n'est pas si importante.  Si vous stockez des vecteurs de mots sous forme de versions Ã  virgule flottante de quatre octets dans un tableau simple <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-110"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-111">v</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-21-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-21"> v </script>  , nous avons besoin de moins de 1 Go pour chaque million de mots.  Ce volume peut facilement tenir dans la RAM.  Maintenant, le vecteur de requÃªte ressemble Ã  ceci: <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-112"><span class="noError" id="MJXp-Span-113" style="display: inline-block;">{v&nbsp;_&nbsp;{{i_&nbsp;{best}}}}&nbsp;+&nbsp;{v&nbsp;_&nbsp;{{i_&nbsp;{restaurant}}}&nbsp;+&nbsp;{v&nbsp;_&nbsp;{{i_&nbsp;{of}}}&nbsp;+&nbsp;{v&nbsp;_&nbsp;{{i_&nbsp;{munich}}}}}</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-22-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-22"> {v _ {{i_ {best}}}} + {v _ {{i_ {restaurant}}} + {v _ {{i_ {of}}} + {v _ {{i_ {munich}}}}} </script>  . <br><br>  La taille finale de la soumission de la requÃªte dÃ©pend du nombre total de mots dans la requÃªte.  Pour 4 milliards de requÃªtes, cela reprÃ©sente environ 80 Go (y compris les vecteurs de mots).  En d'autres termes, par rapport aux vecteurs de mots d'origine, la taille a diminuÃ© de 97% et par rapport aux vecteurs quantifiÃ©s - de 90%. <br><br>  Et encore une chose.  Pour une recherche, nous devons visiter environ 200-300 nÅ“uds du graphique.  Chaque nÅ“ud a 20 Ã  30 voisins.  Donc, nous devons calculer la distance entre le vecteur de requÃªte d'entrÃ©e et les vecteurs 4000-9000 dans l'index.  Et de plus, nous devons gÃ©nÃ©rer des vecteurs.  Combien de temps faut-il pour crÃ©er des vecteurs de requÃªte Ã  la volÃ©e? <br><br>  Il s'avÃ¨re qu'avec un processeur assez rÃ©cent, ce problÃ¨me peut Ãªtre rÃ©solu en quelques millisecondes.  Une requÃªte qui s'exÃ©cutait en 1 ms s'exÃ©cute maintenant en 5 ms environ.  Mais ensuite, nous avons rÃ©duit la quantitÃ© de mÃ©moire pour les vecteurs de 90%.  Nous avons acceptÃ© avec plaisir un tel compromis. <br><br><h3>  Affichage en mÃ©moire des vecteurs et index </h3><br>  Ci-dessus, nous avons rÃ©solu le problÃ¨me de la rÃ©duction de la quantitÃ© de mÃ©moire pour les vecteurs.  Mais aprÃ¨s avoir rÃ©solu ce problÃ¨me, la structure de l'indice elle-mÃªme est devenue un facteur limitant.  Vous devez maintenant rÃ©duire sa taille. <br><br>  Ã€ Granne, la structure du graphe est stockÃ©e de maniÃ¨re compacte sous la forme d'une liste d'adjacence avec un nombre variable de voisins pour chaque nÅ“ud.  Autrement dit, la mÃ©moire n'est guÃ¨re gaspillÃ©e en mÃ©tadonnÃ©es.  La taille de la structure d'index dÃ©pend en grande partie des paramÃ¨tres de conception et des propriÃ©tÃ©s du graphique.  NÃ©anmoins, pour avoir une idÃ©e de la taille de l'index, il suffit de dire que nous pouvons construire un index pour 4 milliards de vecteurs avec une taille totale d'environ 240 Go.  Cela peut Ãªtre acceptable pour une utilisation en mÃ©moire sur un grand serveur, mais cela peut Ãªtre mieux fait. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e73/daa/0de/e73daa0dea90e3e84afe9aaec7bd6a8e.jpg"><br>  <sup><i>Figure 3: Deux dispositions diffÃ©rentes en RAM et SSD.</i></sup> <br><br>  Une propriÃ©tÃ© importante de Granne est la possibilitÃ© d' <a href="https://ru.wikipedia.org/wiki/Mmap">afficher les</a> vecteurs d'index et de requÃªte <a href="https://ru.wikipedia.org/wiki/Mmap">en mÃ©moire</a> .  Cela nous permet de charger l'index paresseusement et de partager la mÃ©moire avec plusieurs processus.  Les fichiers d'index et de requÃªte sont divisÃ©s en fichiers d'affichage distincts en mÃ©moire et peuvent Ãªtre utilisÃ©s dans diffÃ©rentes dispositions en RAM et sur SSD.  Si les exigences pour le dÃ©lai sont lÃ©gÃ¨rement plus faibles, alors en plaÃ§ant l'index sur le SSD, les requÃªtes en RAM, nous maintenons une vitesse acceptable sans consommation excessive de mÃ©moire.  Ã€ la fin de l'article, nous verrons Ã  quoi ressemble ce compromis. <br><br><h3>  AmÃ©lioration de la localisation des donnÃ©es </h3><br>  Dans notre configuration actuelle, lorsque l'index est sur un SSD, chaque demande nÃ©cessite jusqu'Ã  200-300 lectures Ã  partir du disque.  Vous pouvez essayer d'augmenter la localitÃ© des donnÃ©es en disposant les Ã©lÃ©ments dont les vecteurs sont si proches que leurs nÅ“uds HNSW sont situÃ©s dans l'index Ã©galement non loin les uns des autres.  La localisation des donnÃ©es amÃ©liore les performances, car une seule opÃ©ration de lecture (gÃ©nÃ©ralement extraite de 4 Ko) est plus susceptible de contenir d'autres nÅ“uds nÃ©cessaires pour parcourir le graphique.  Et cela, Ã  son tour, rÃ©duit le nombre de rÃ©cupÃ©rations de donnÃ©es par recherche. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f8/1d2/2f4/1f81d22f418256c704bb12b7514e68a1.jpg"><br>  <sup><i>Figure 4: La localisation des donnÃ©es rÃ©duit la rÃ©cupÃ©ration d'informations.</i></sup> <br><br>  Il convient de noter que la rÃ©organisation des Ã©lÃ©ments n'affecte pas les rÃ©sultats de la recherche, c'est une faÃ§on de l'accÃ©lÃ©rer.  Autrement dit, l'ordre peut Ãªtre quelconque, mais toutes les options n'accÃ©lÃ¨rent pas la recherche.  Il est trÃ¨s difficile de trouver l'ordre optimal.  Cependant, l'heuristique que nous avons utilisÃ©e avec succÃ¨s est de trier les requÃªtes par le mot le plus <i>important</i> dans chaque requÃªte. <br><br><h1>  Conclusion </h1><br>  Nous utilisons Granne pour crÃ©er et maintenir des index de plusieurs milliards de dollars avec des vecteurs de requÃªte afin de rechercher des requÃªtes similaires avec une consommation de mÃ©moire relativement faible.  Le tableau ci-dessous montre les exigences pour diffÃ©rentes mÃ©thodes.  Soyez sceptique quant aux valeurs absolues des retards pendant la recherche, car ils dÃ©pendent fortement de ce qui est considÃ©rÃ© comme une rÃ©ponse acceptable.  Cependant, ces informations dÃ©crivent les performances relatives des mÃ©thodes. <br><br><div class="scrollable-table"><table><tbody><tr><th></th><th>  Valeur initiale <br></th><th>  Quantification <br></th><th>  Granne (RAM uniquement) <br></th><th>  Granne (RAM + SSD) <br></th></tr><tr><td>  <b>La mÃ©moire</b> <br></td><td>  3000 + 240 Go <br></td><td>  750 + 240 Go <br></td><td>  80 + 240 Go <br></td><td>  80-150 Go * <br></td></tr><tr><td>  <b>SSD</b> <br></td><td>  - </td><td>  - </td><td>  - </td><td>  240 Go <br></td></tr><tr><td>  <b>Retard</b> <br></td><td>  1 ms <br></td><td>  1 ms <br></td><td>  5 ms <br></td><td>  10-50 ms <br></td></tr></tbody></table></div><br>  <i>* L'allocation d'un index mÃ©moire supÃ©rieur Ã  la quantitÃ© requise a conduit Ã  la mise en cache de certains nÅ“uds (frÃ©quemment visitÃ©s), ce qui a rÃ©duit le retard dans la recherche.</i>  <i>Aucun cache interne n'a Ã©tÃ© utilisÃ© pour cela, uniquement des outils de systÃ¨me d'exploitation internes (noyau Linux).</i> <br><br>  Il convient de noter que certaines des optimisations mentionnÃ©es dans l'article ne sont pas applicables pour rÃ©soudre le problÃ¨me gÃ©nÃ©ral de trouver des voisins les plus proches avec des vecteurs indÃ©composables.  Cependant, ils sont applicables dans toutes les situations oÃ¹ des Ã©lÃ©ments peuvent Ãªtre gÃ©nÃ©rÃ©s Ã  partir de moins de piÃ¨ces (comme c'est le cas avec les mots et les requÃªtes).  Sinon, vous pouvez toujours utiliser Granne avec les vecteurs sources, cela prend juste plus de mÃ©moire, comme avec les autres bibliothÃ¨ques. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479692/">https://habr.com/ru/post/fr479692/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479682/index.html">Rapport d'utilisation des conteneurs Sysdig 2019: nouveaux Kubernetes et dÃ©tails de sÃ©curitÃ©</a></li>
<li><a href="../fr479684/index.html">Comment collecter des clÃ©s basse frÃ©quence pour le rÃ©fÃ©rencement: 4 faÃ§ons non triviales</a></li>
<li><a href="../fr479686/index.html">Tendances clÃ©s de l'externalisation informatique aprÃ¨s 2020</a></li>
<li><a href="../fr479688/index.html">Dans quels pays et villes les dÃ©veloppeurs gagnent-ils plus si l'on considÃ¨re les taxes et le coÃ»t de la vie?</a></li>
<li><a href="../fr479690/index.html">Zork et Z-Machine: comment les dÃ©veloppeurs ont transfÃ©rÃ© le jeu des mainframes aux ordinateurs personnels 8 bits</a></li>
<li><a href="../fr479696/index.html">Quelques mots sur Alter Table, ou comment ne pas le faire</a></li>
<li><a href="../fr479700/index.html">CIMON-2: (un) Doomsday, ou comment IBM Watson a grimpÃ© au-dessus des nuages</a></li>
<li><a href="../fr479702/index.html">Toaster, My Circle et Freelansim font partie de Habr</a></li>
<li><a href="../fr479704/index.html">Escalade de privilÃ¨ges dans le client EA Origin Windows (CVE-2019-19247 et CVE-2019-19248)</a></li>
<li><a href="../fr479708/index.html">Article non officiel sur le changement de marque de Habr + Competition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>