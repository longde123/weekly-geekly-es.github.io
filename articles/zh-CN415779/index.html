<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ–Šï¸ ğŸ‘‚ğŸ½ ğŸˆ´ å®æ–½å®‰å…¨çš„NASè½¯ä»¶å¹³å° ğŸ¤¶ğŸ¾ ğŸ‘¨â€âš–ï¸ ğŸ‘ŒğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ ï¼Œä»‹ç»äº†NASè½¯ä»¶å¹³å°çš„è®¾è®¡ã€‚ 
 ç°åœ¨æ˜¯å®ç°å®ƒçš„æ—¶å€™äº†ã€‚ 
 æ£€æŸ¥ä¸€ä¸‹ 


 åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ£€æŸ¥æ± çš„è¿è¡ŒçŠ¶å†µï¼š 


zpool status -v  


 æ± åŠå…¶ä¸­çš„æ‰€æœ‰ç£ç›˜å¿…é¡»å¤„äºè”æœºçŠ¶æ€ã€‚ 


 æ­¤å¤–ï¼Œæˆ‘å‡è®¾åœ¨ä¸Šä¸€ä¸ªé˜¶æ®µï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ ¹æ®è¯´æ˜è¿›è¡Œçš„ ï¼Œå¹¶ä¸”å¯ä»¥æ­£å¸¸å·¥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å®æ–½å®‰å…¨çš„NASè½¯ä»¶å¹³å°</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415779/"><p><img src="https://habrastorage.org/getpro/habr/post_images/b93/ed1/af9/b93ed1af987a1fda471d1080d6b804e5.jpg"></p><br><p> åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸Šä¸€ç¯‡æ–‡ç« ä¸­</a> ï¼Œä»‹ç»äº†NASè½¯ä»¶å¹³å°çš„è®¾è®¡ã€‚ <br> ç°åœ¨æ˜¯å®ç°å®ƒçš„æ—¶å€™äº†ã€‚ </p><a name="habracut"></a><br><h2 id="proverka"> æ£€æŸ¥ä¸€ä¸‹ </h2><br><p> åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ£€æŸ¥æ± çš„è¿è¡ŒçŠ¶å†µï¼š </p><br><pre><code class="hljs lua">zpool <span class="hljs-built_in"><span class="hljs-built_in">status</span></span> -v</code> </pre> <br><p> æ± åŠå…¶ä¸­çš„æ‰€æœ‰ç£ç›˜å¿…é¡»å¤„äºè”æœºçŠ¶æ€ã€‚ </p><br><p> æ­¤å¤–ï¼Œæˆ‘å‡è®¾åœ¨ä¸Šä¸€ä¸ªé˜¶æ®µï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯´æ˜è¿›è¡Œçš„</a> ï¼Œå¹¶ä¸”å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œæˆ–è€…æ‚¨è‡ªå·±å¾ˆäº†è§£è‡ªå·±åœ¨åšä»€ä¹ˆã€‚ </p><br><h2 id="udobstva"> ä¾¿åˆ©è®¾æ–½ </h2><br><p> é¦–å…ˆï¼Œå¦‚æœæ‚¨ä»ä¸€å¼€å§‹å°±æ²¡æœ‰è¿™æ ·åšï¼Œé‚£ä¹ˆå€¼å¾—è¿›è¡Œä¾¿åˆ©çš„ç®¡ç†ã€‚ <br> è¦æ±‚ï¼š </p><br><ul><li>  SSHæœåŠ¡å™¨ï¼š <code>apt-get install openssh-server</code> ã€‚ å¦‚æœæ‚¨ä¸çŸ¥é“å¦‚ä½•é…ç½®SSHï¼Œ <del> åœ¨Linuxä¸ŠåšNASè¿˜ä¸ºæ—¶è¿‡æ—© </del> æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ¬æ–‡ä¸­</a>é˜…è¯»å…¶ä½¿ç”¨åŠŸèƒ½ï¼Œç„¶åä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…¶ä¸­ä¸€æœ¬æ‰‹å†Œ</a> ã€‚ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">tmux</a>æˆ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å±å¹•</a> ï¼š <code>apt-get install tmux</code> ã€‚ åœ¨é€šè¿‡SSHç™»å½•å¹¶ä½¿ç”¨å¤šä¸ªçª—å£æ—¶ä¿å­˜ä¼šè¯ã€‚ </li></ul><br><p> å®‰è£…SSHä¹‹åï¼Œæ‚¨éœ€è¦æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œä»¥ä¾¿ä¸ä»¥rootèº«ä»½é€šè¿‡SSHç™»å½•ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œè¾“å…¥å·²ç¦ç”¨ï¼Œæ‚¨æ— éœ€å¯ç”¨å®ƒï¼‰ï¼š </p><br><pre> <code class="bash hljs">zfs create rpool/home/user adduser user cp -a /etc/skel/.[!.]* /home/user chown -R user:user /home/user</code> </pre> <br><p> å¯¹äºè¿œç¨‹ç®¡ç†ï¼Œè¿™æ˜¯è¶³å¤Ÿçš„æœ€ä½è¦æ±‚ã€‚ </p><br><p> ä¸è¿‡ï¼Œå°½ç®¡æ‚¨éœ€è¦ä¿æŒé”®ç›˜å’Œæ˜¾ç¤ºå™¨çš„è¿æ¥ï¼Œ æ‚¨è¿˜éœ€è¦åœ¨æ›´æ–°å†…æ ¸æ—¶é‡æ–°å¯åŠ¨ï¼Œä»¥ç¡®ä¿åŠ è½½åä¸€åˆ‡éƒ½èƒ½æ­£å¸¸è¿è¡Œã€‚ </p><br><p> ä¸€ç§æ›¿ä»£æ–¹æ³•æ˜¯ä½¿ç”¨æä¾›<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IMEçš„</a> Virtual KVMã€‚ é‚£é‡Œæœ‰ä¸€ä¸ªæ§åˆ¶å°ï¼Œå°½ç®¡å°±æˆ‘è€Œè¨€ï¼Œå®ƒæ˜¯ä½œä¸ºJava appletå®ç°çš„ï¼Œä½†ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚ </p><br><h2 id="nastroyka"> å®¢åˆ¶åŒ– </h2><br><h3 id="podgotovka-kesha"> ç¼“å­˜å‡†å¤‡ </h3><br><p> æ®æ‚¨æ‰€è®°å¾—ï¼Œåœ¨æˆ‘æè¿°çš„é…ç½®ä¸­ï¼ŒL2ARCä¸‹æœ‰ä¸€ä¸ªå•ç‹¬çš„SSDï¼Œå°šæœªä½¿ç”¨ï¼Œä½†ç”¨äºâ€œå¢é•¿â€ã€‚ </p><br><p> å¯é€‰ï¼Œä½†æ˜¯å»ºè®®ç”¨éšæœºæ•°æ®å¡«å……æ­¤SSDï¼ˆå¯¹äºSamsung EVOï¼Œåœ¨blkdiscardä¹‹åå°†ç”¨é›¶å¡«å……ï¼Œä½†æ— è®ºå¦‚ä½•ä¸æ˜¯åœ¨æ‰€æœ‰SSDä¸Šå¡«å……ï¼‰ï¼š </p><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/urandom of=/dev/disk/by-id/ata-Samsung_SSD_850_EVO bs=4M &amp;&amp; blkdiscard /dev/disk/by-id/ata-Samsung_SSD_850_EVO</code> </pre> <br><h3 id="otklyuchenie-szhatiya-logov"> ç¦ç”¨æ—¥å¿—å‹ç¼© </h3><br><p> åœ¨ZFSä¸Šï¼Œå·²ç»ä½¿ç”¨äº†å‹ç¼©ï¼Œå› ä¸ºé€šè¿‡gzipè¿›è¡Œæ—¥å¿—å‹ç¼©æ˜¾ç„¶æ˜¯å¤šä½™çš„ã€‚ <br> å…³é—­ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/logrotate.d/* ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> grep -Eq <span class="hljs-string"><span class="hljs-string">"(^|[^#y])compress"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> sed -i -r <span class="hljs-string"><span class="hljs-string">"s/(^|[^#y])(compress)/\1#\2/"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><h3 id="obnovlenie-sistemy"> ç³»ç»Ÿæ›´æ–° </h3><br><p> è¿™é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼š </p><br><pre> <code class="bash hljs">apt-get dist-upgrade --yes reboot</code> </pre> <br><h3 id="sozdanie-snepshota-dlya-novogo-sostoyaniya"> ä¸ºæ–°çŠ¶æ€åˆ›å»ºå¿«ç…§ </h3><br><p> é‡æ–°å¯åŠ¨åï¼Œä¸ºäº†ä¿®å¤æ–°çš„å·¥ä½œçŠ¶æ€ï¼Œæ‚¨éœ€è¦é‡å†™ç¬¬ä¸€ä¸ªå¿«ç…§ï¼š </p><br><pre> <code class="bash hljs">zfs destroy rpool/ROOT/debian@install zfs snapshot rpool/ROOT/debian@install</code> </pre> <br><h2> æ–‡ä»¶ç³»ç»Ÿç»„ç»‡ </h2><br><h3 id="podgotovka-razdelov-dlya-slog"> ä¸ºSLOGåˆ†åŒº </h3><br><p> ä¸ºäº†è·å¾—æ­£å¸¸çš„ZFSæ€§èƒ½ï¼Œè¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å°†SLOGæ”¾åœ¨SSDä¸Šã€‚ <br> è®©æˆ‘æé†’æ‚¨ï¼Œä½¿ç”¨çš„é…ç½®ä¸­çš„SLOGåœ¨ä¸¤ä¸ªSSDä¸Šé‡å¤ï¼šä¸ºæ­¤ï¼Œå°†åœ¨æ¯ä¸ªSSDçš„ç¬¬4éƒ¨åˆ†çš„é¡¶éƒ¨åˆ›å»ºLUKS-XTSä¸Šçš„è®¾å¤‡ï¼š </p><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/urandom of=/etc/keys/slog.key bs=1 count=4096 cryptsetup --verbose --cipher <span class="hljs-string"><span class="hljs-string">"aes-xts-plain64:sha512"</span></span> --key-size 512 --key-file /etc/keys/slog.key luksFormat /dev/disk/by-id/ata-Samsung_SSD_850_PRO-part4 cryptsetup --verbose --cipher <span class="hljs-string"><span class="hljs-string">"aes-xts-plain64:sha512"</span></span> --key-size 512 --key-file /etc/keys/slog.key luksFormat /dev/disk/by-id/ata-Micron_1100-part4 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"slog0_crypt1 /dev/disk/by-id/ata-Samsung_SSD_850_PRO-part4 /etc/keys/slog.key luks,discard"</span></span> &gt;&gt; /etc/crypttab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"slog0_crypt2 /dev/disk/by-id/ata-Micron_1100-part4 /etc/keys/slog.key luks,discard"</span></span> &gt;&gt; /etc/crypttab</code> </pre> <br><h3 id="podgotovka-razdelov-dlya-l2arc-i-podkachki"> ä¸ºL2ARCå’Œäº¤æ¢åˆ†åŒº </h3><br><p> é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨swapå’Œl2arcä¸‹åˆ›å»ºåˆ†åŒºï¼š </p><br><pre> <code class="bash hljs">sgdisk -n1:0:48G -t1:8200 -c1:part_swap -n2::196G -t2:8200 -c2:part_l2arc /dev/disk/by-id/ata-Samsung_SSD_850_EVO</code> </pre> <br><p> äº¤æ¢åˆ†åŒºå’ŒL2ARCå°†ä½¿ç”¨éšæœºå¯†é’¥åŠ å¯†ï¼Œå¦‚ä¸‹æ‰€ç¤º é‡æ–°å¯åŠ¨åï¼Œä¸éœ€è¦å®ƒä»¬ï¼Œå¹¶ä¸”å§‹ç»ˆå¯ä»¥é‡æ–°åˆ›å»ºå®ƒä»¬ã€‚ <br> å› æ­¤ï¼Œåœ¨crypttabä¸­ï¼Œç¼–å†™äº†ä¸€è¡Œä»¥çº¯æ¨¡å¼åŠ å¯†/è§£å¯†åˆ†åŒºï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> swap_crypt /dev/disk/by-id/ata-Samsung_SSD_850_EVO-part1 /dev/urandom swap,cipher=aes-xts-plain64:sha512,size=512 &gt;&gt; /etc/crypttab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> l2arc_crypt /dev/disk/by-id/ata-Samsung_SSD_850_EVO-part2 /dev/urandom cipher=aes-xts-plain64:sha512,size=512 &gt;&gt; /etc/crypttab</code> </pre> <br><p> ç„¶åï¼Œæ‚¨éœ€è¦é‡æ–°å¯åŠ¨å®ˆæŠ¤ç¨‹åºå¹¶å¯ç”¨äº¤æ¢ï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'vm.swappiness = 10'</span></span> &gt;&gt; /etc/sysctl.conf sysctl vm.swappiness=10 systemctl daemon-reload systemctl start systemd-cryptsetup@swap_crypt.service <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /dev/mapper/swap_crypt none swap sw,discard 0 0 &gt;&gt; /etc/fstab swapon -av</code> </pre> <br><p> å› ä¸º  <code>swapiness</code>ä¸Šæœªç§¯æä½¿ç”¨<code>swapiness</code> ï¼› <code>swapiness</code>å‚æ•°ï¼ˆé»˜è®¤å€¼ä¸º60ï¼‰å¿…é¡»è®¾ç½®ä¸º10ã€‚ </p><br><p>  L2ARCåœ¨æ­¤é˜¶æ®µå°šæœªä½¿ç”¨ï¼Œä½†æ˜¯å®ƒçš„éƒ¨åˆ†å·²ç»å‡†å¤‡å°±ç»ªï¼š </p><br><pre> <code class="bash hljs">$ ls /dev/mapper/ control l2arc_crypt root_crypt1 root_crypt2 slog0_crypt1 slog0_crypt2 swap_crypt tank0_crypt0 tank0_crypt1 tank0_crypt2 tank0_crypt3</code> </pre> <br><h3 id="puly-tankn"> æ°´æ± æ§½N </h3><br><p> å°†æè¿°<code>tank0</code>æ± çš„åˆ›å»ºï¼Œç±»æ¨åœ°åˆ›å»º<code>tank0</code> ã€‚ </p><br><p> ä¸ºäº†ä¸æ‰‹åŠ¨åˆ›å»ºç›¸åŒçš„åˆ†åŒºå¹¶é¿å…é”™è¯¯ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ª<a href="">è„šæœ¬</a>æ¥åˆ›å»ºæ± çš„åŠ å¯†åˆ†åŒºï¼š </p><br><div class="spoiler">  <b class="spoiler_title">create_crypt_pool.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash KEY_SIZE=512 POOL_NAME="$1" KEY_FILE="/etc/keys/${POOL_NAME}.key" LUKS_PARAMS="--verbose --cipher aes-xts-plain64:sha${KEY_SIZE} --key-size $KEY_SIZE" [ -z "$1" ] &amp;&amp; { echo "Error: pool name empty!" ; exit 1; } shift [ -z "$*" ] &amp;&amp; { echo "Error: devices list empty!" ; exit 1; } echo "Devices: $*" read -p "Is it ok? " a [ "$a" != "y" ] &amp;&amp; { echo "Bye"; exit 1; } dd if=/dev/urandom of=$KEY_FILE bs=1 count=4096 phrase="?" read -s -p "Password: " phrase echo read -s -p "Repeat password: " phrase1 echo [ "$phrase" != "$phrase1" ] &amp;&amp; { echo "Error: passwords is not equal!" ; exit 1; } echo "### $POOL_NAME" &gt;&gt; /etc/crypttab index=0 for i in $*; do echo "$phrase"|cryptsetup $LUKS_PARAMS luksFormat "$i" || exit 1 echo "$phrase"|cryptsetup luksAddKey "$i" $KEY_FILE || exit 1 dev_name="${POOL_NAME}_crypt${index}" echo "${dev_name} $i $KEY_FILE luks" &gt;&gt; /etc/crypttab cryptsetup luksOpen --key-file $KEY_FILE "$i" "$dev_name" || exit 1 index=$((index + 1)) done echo "###" &gt;&gt; /etc/crypttab phrase="=====================================================" phrase1="=================================================" unset phrase unset phrase1</span></span></code> </pre> </div></div><br><p> ç°åœ¨ï¼Œä½¿ç”¨æ­¤è„šæœ¬ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨äºå­˜å‚¨æ•°æ®çš„æ± ï¼š </p><br><pre> <code class="bash hljs">./create_crypt_pool.sh zpool create -o ashift=12 -O atime=off -O compression=lz4 -O normalization=formD tank0 raidz1 /dev/disk/by-id/dm-name-tank0_crypt*</code> </pre> <br><p> æœ‰å…³<code>ashift=12</code>å‚æ•°çš„æ³¨é‡Šï¼Œè¯·å‚é˜…æˆ‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»¥å‰çš„</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a>å’Œæœ‰å…³å®ƒä»¬çš„è¯„è®ºã€‚ </p><br><p> åˆ›å»ºæ± åï¼Œæˆ‘å°†å…¶æ—¥å¿—æ”¾åˆ°SSDä¸Šï¼š </p><br><pre> <code class="bash hljs">zpool add tank0 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> mirror /dev/disk/by-id/dm-name-slog0_crypt1 /dev/disk/by-id/dm-name-slog0_crypt2</code> </pre> <br><p> å°†æ¥ï¼Œåœ¨å®‰è£…å’Œé…ç½®OMVçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡GUIåˆ›å»ºæ± ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bu/bc/qj/bubcqjn_frfc3plifb9ehgzxco0.png" alt="åœ¨OMV WEB GUIä¸­åˆ›å»ºZFS"></a> </p><br><h3 id="vklyuchenie-importa-pulov-i-avtomontirovaniya-tomov-pri-zagruzke"> åœ¨å¯åŠ¨æ—¶å¯ç”¨æ± å¯¼å…¥å’Œè‡ªåŠ¨æŒ‚è½½å· </h3><br><p> ä¸ºäº†ä¿è¯å¯ç”¨è‡ªåŠ¨æŒ‚æ¥æ± ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š </p><br><pre> <code class="bash hljs">rm /etc/zfs/zpool.cache systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-import-scan.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-mount.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-import-cache.service</code> </pre> <br><p> åœ¨æ­¤é˜¶æ®µï¼Œç£ç›˜å­ç³»ç»Ÿçš„é…ç½®å®Œæˆã€‚ </p><br><h2> ä½œä¸šç³»ç»Ÿ </h2><br><p> ç¬¬ä¸€æ­¥æ˜¯å®‰è£…å’Œé…ç½®OMVï¼Œä»¥ä¾¿æœ€ç»ˆä¸ºNASå¥ å®šæŸç§åŸºç¡€ã€‚ </p><br><h3 id="ustanovka-omv"> å®‰è£…OMV </h3><br><p>  OMVå°†ä½œä¸ºdebè½¯ä»¶åŒ…å®‰è£…ã€‚ ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®˜æ–¹è¯´æ˜</a> ã€‚ </p><br><p>  <code>add_repo.sh</code>è„šæœ¬å°†OMV Arrakiså­˜å‚¨åº“æ·»åŠ åˆ°<code>add_repo.sh</code>ä»¥ä¾¿æ‰¹å¤„ç†ç³»ç»Ÿå¯ä»¥çœ‹åˆ°è¯¥å­˜å‚¨åº“ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">add_repo.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">cat &lt;&lt;EOF &gt;&gt; /etc/apt/sources.list.d/openmediavault.list deb http://packages.openmediavault.org/public arrakis main <span class="hljs-comment"><span class="hljs-comment"># deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis main ## Uncomment the following line to add software from the proposed repository. # deb http://packages.openmediavault.org/public arrakis-proposed main # deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis-proposed main ## This software is not part of OpenMediaVault, but is offered by third-party ## developers as a service to OpenMediaVault users. deb http://packages.openmediavault.org/public arrakis partner # deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis partner EOF</span></span></code> </pre> </div></div><br><p> è¯·æ³¨æ„ï¼Œä¸åŸå§‹ç‰ˆæœ¬ç›¸æ¯”ï¼ŒåŒ…å«äº†åˆä½œä¼™ä¼´å­˜å‚¨åº“ã€‚ </p><br><p> è¦å®‰è£…å’Œåˆå§‹åŒ–ï¼Œæ‚¨å¿…é¡»è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç”¨äºå®‰è£…OMVçš„å‘½ä»¤ã€‚</b> <div class="spoiler_text"><pre> <code class="bash hljs">./add_repo.sh <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LANG=C <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> DEBIAN_FRONTEND=noninteractive <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> APT_LISTCHANGES_FRONTEND=none apt-get update apt-get --allow-unauthenticated install openmediavault-keyring apt-get update apt-get --yes --auto-remove --show-upgraded \ --allow-downgrades --allow-change-held-packages \ --no-install-recommends \ --option Dpkg::Options::=<span class="hljs-string"><span class="hljs-string">"--force-confdef"</span></span> \ --option DPkg::Options::=<span class="hljs-string"><span class="hljs-string">"--force-confold"</span></span> \ install postfix openmediavault <span class="hljs-comment"><span class="hljs-comment"># Initialize the system and database. omv-initsystem</span></span></code> </pre> </div></div><br><p> å·²å®‰è£…OMVã€‚ å®ƒä½¿ç”¨è‡ªå·±çš„å†…æ ¸ï¼Œå®‰è£…åå¯èƒ½éœ€è¦é‡æ–°å¯åŠ¨ã€‚ </p><br><p> é‡æ–°å¯åŠ¨åï¼ŒOpenMediaVaultç•Œé¢å°†åœ¨ç«¯å£80ä¸Šå¯ç”¨ï¼ˆé€šè¿‡IPåœ°å€è½¬åˆ°NASä¸Šçš„æµè§ˆå™¨ï¼‰ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/eo/sf/ra/eosfraeilpg2dn770ef5bvr-ple.png"></a> </p><br><p> é»˜è®¤çš„ç”¨æˆ·å/å¯†ç ä¸º<code>admin/openmediavault</code> ã€‚ </p><br><h3 id="nastroyka-omv"> é…ç½®OMV </h3><br><p> æ­¤å¤–ï¼Œå¤§å¤šæ•°é…ç½®å°†é€šè¿‡WEB-GUIã€‚ </p><br><h4 id="ustanovka-bezopasnogo-soedineniya"> å»ºç«‹å®‰å…¨è¿æ¥ </h4><br><p> ç°åœ¨ï¼Œæ‚¨éœ€è¦æ›´æ”¹WEBç®¡ç†å‘˜çš„å¯†ç å¹¶ä¸ºNASç”Ÿæˆè¯ä¹¦ï¼Œä»¥ä¾¿å°†æ¥ä½¿ç”¨HTTPSã€‚ </p><br><p> åœ¨<em>â€œç³»ç»Ÿ-&gt;å¸¸è§„è®¾ç½®-&gt; Webç®¡ç†å‘˜å¯†ç â€</em>é€‰é¡¹å¡ä¸Šæ›´æ”¹<em>å¯†ç </em> ã€‚ <br> è¦åœ¨<em>â€œç³»ç»Ÿ-&gt;è¯ä¹¦-&gt; SSLâ€</em>é€‰é¡¹å¡ä¸Šç”Ÿæˆè¯ä¹¦<em>ï¼Œè¯·</em>é€‰æ‹©<em>â€œæ·»åŠ -&gt;åˆ›å»ºâ€</em> ã€‚ </p><br><p> åˆ›å»ºçš„è¯ä¹¦å°†åœ¨åŒä¸€é€‰é¡¹å¡ä¸Šå¯è§ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ld/6j/_m/ld6j_mgp4tx6auirzlkfnwium2c.png" alt="è¯æ˜ä¹¦"></a> </p><br><p> åˆ›å»ºè¯ä¹¦åï¼Œåœ¨<em>â€œç³»ç»Ÿ-&gt;å¸¸è§„è®¾ç½®â€é€‰é¡¹å¡ä¸Šï¼Œ</em>å¯ç”¨<em>â€œå¯ç”¨SSL / TLSâ€</em>å¤é€‰æ¡†ã€‚ </p><br><p> é…ç½®å®Œæˆä¹‹å‰ï¼Œå°†éœ€è¦è¯ä¹¦ã€‚ æœ€ç»ˆç‰ˆæœ¬å°†ä½¿ç”¨ç­¾åè¯ä¹¦æ¥è”ç³»OMVã€‚ </p><br><p> ç°åœ¨ï¼Œæ‚¨éœ€è¦ç™»å½•åˆ°OMVï¼Œç«¯å£443ï¼Œæˆ–åœ¨æµè§ˆå™¨ä¸­ç®€å•åœ°å°†<code>https://</code>å‰ç¼€åˆ†é…ç»™IPã€‚ </p><br><p> å¦‚æœæ‚¨æˆåŠŸç™»å½•ï¼Œåˆ™åœ¨<em>â€œç³»ç»Ÿ-&gt;å¸¸è§„è®¾ç½®â€</em>é€‰é¡¹å¡ä¸Šï¼Œéœ€è¦å¯ç”¨â€œå¼ºåˆ¶SSL / TLSâ€å¤é€‰æ¡†ã€‚ </p><br><p>  <strong>å°†ç«¯å£80å’Œ443æ›´æ”¹ä¸º10080å’Œ10443</strong> ã€‚ <br> å¹¶å°è¯•ç™»å½•åˆ°ä»¥ä¸‹åœ°å€ï¼š <code>https://IP_NAS:10443</code> ã€‚ <br> æ›´æ”¹ç«¯å£å¾ˆé‡è¦ï¼Œå› ä¸ºç«¯å£80å’Œ443å°†ä½¿ç”¨å¸¦æœ‰nginx-reverse-proxyçš„dockerå®¹å™¨ã€‚ </p><br><h3 id="pervichnye-nastroyki"> ä¸»è¦è®¾å®š </h3><br><p> å¿…é¡»é¦–å…ˆå®Œæˆçš„æœ€ä½è®¾ç½®ï¼š </p><br><ul><li> åœ¨<em>â€œç³»ç»Ÿ-&gt;æ—¥æœŸå’Œæ—¶é—´â€</em>é€‰é¡¹å¡ä¸Š<em>ï¼Œ</em>æ£€æŸ¥æ—¶åŒºå€¼å¹¶è®¾ç½®NTPæœåŠ¡å™¨ã€‚ </li><li> åœ¨é€‰é¡¹å¡<em>â€œç³»ç»Ÿ-&gt;ç›‘è§†â€ä¸Šï¼Œ</em>å¯ç”¨æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ã€‚ </li><li> åœ¨<em>â€œç³»ç»Ÿ-&gt;èƒ½æºç®¡ç†â€</em>é€‰é¡¹å¡<em>ä¸Šï¼Œ</em>å¯èƒ½æœ‰å¿…è¦å…³é—­â€œç›‘è§†â€ï¼Œè¿™æ ·OMVä¸ä¼šå°è¯•æ§åˆ¶é£æ‰‡ã€‚ </li></ul><br><h3 id="set"> è”æ’­ç½‘ </h3><br><p> å¦‚æœå°šæœªè¿æ¥ç¬¬äºŒä¸ªNASç½‘ç»œæ¥å£ï¼Œåˆ™å°†å…¶è¿æ¥åˆ°è·¯ç”±å™¨ã€‚ </p><br><p> ç„¶åï¼š </p><br><ul><li> åœ¨<em>â€œç³»ç»Ÿ-&gt;ç½‘ç»œâ€é€‰é¡¹å¡ä¸Šï¼Œ</em>å°†ä¸»æœºåè®¾ç½®ä¸ºâ€œ nasâ€ï¼ˆæˆ–æ‚¨å–œæ¬¢çš„ä»»ä½•åç§°ï¼‰ã€‚ </li><li> è®¾ç½®æ¥å£çš„ç»‘å®šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <em>â€œ System-&gt; Network-&gt; Interfaces-&gt; Add-&gt; Bondâ€</em> ã€‚ </li><li> åœ¨é€‰é¡¹å¡<em>â€œç³»ç»Ÿ-&gt;ç½‘ç»œ-&gt;é˜²ç«å¢™â€</em>ä¸Šæ·»åŠ å¿…è¦çš„é˜²ç«å¢™è§„åˆ™ã€‚ é¦–å…ˆï¼Œè®¿é—®ç«¯å£10443ã€10080ã€443ã€80ã€22çš„SSHä»¥åŠæ¥æ”¶/å‘é€ICMPçš„æƒé™å°±è¶³å¤Ÿäº†ã€‚ </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/rb/fi/ab/rbfiabiimceoohildwosfu_egju.png" alt="ç»‘å®šè®¾ç½®"></a> </p><br><p> ç»“æœï¼Œåº”è¯¥å‡ºç°ç»‘å®šä¸­çš„æ¥å£ï¼Œè·¯ç”±å™¨ä¼šå°†å…¶è§†ä¸ºä¸€ä¸ªæ¥å£å¹¶ä¸ºå…¶åˆ†é…ä¸€ä¸ªIPåœ°å€ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ag/wr/y8/agwry8ynozq7dhgov16pzzwmrs0.png" alt="ç»‘å®šç•Œé¢"></a> </p><br><p> å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»WEB GUIé¢å¤–é…ç½®SSHï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yk/oa/i4/ykoai4l9risd46whpuutbnyi1um.png" alt="SSHè®¾ç½®"></a> </p><br><h3 id="repozitorii-i-moduli"> å‚¨å­˜åº“å’Œæ¨¡å— </h3><br><p> åœ¨<em>â€œç³»ç»Ÿ-&gt;æ›´æ–°ç®¡ç†-&gt;è®¾ç½®â€</em>é€‰é¡¹å¡ä¸Šï¼Œæ‰“å¼€<em>â€œç¤¾åŒºæ”¯æŒçš„æ›´æ–°</em> ã€‚ <em>â€</em> </p><br><p> é¦–å…ˆï¼Œæ·»åŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">OMV Extraså­˜å‚¨åº“</a> ã€‚ <br> åªéœ€å®‰è£…æ’ä»¶æˆ–è½¯ä»¶åŒ…å³å¯å®Œæˆæ­¤æ“ä½œï¼Œå¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è®ºå›æ‰€ç¤º</a> ã€‚ </p><br><p> åœ¨<em>â€œç³»ç»Ÿ-&gt;æ’ä»¶â€</em>é¡µé¢ä¸Šï¼Œæ‚¨éœ€è¦æ‰¾åˆ°æ’ä»¶â€œ openmediavault-omvextrasorgâ€å¹¶è¿›è¡Œå®‰è£…ã€‚ </p><br><p> ç»“æœï¼Œâ€œ OMV-Extrasâ€å›¾æ ‡å°†å‡ºç°åœ¨ç³»ç»Ÿèœå•ä¸­ï¼ˆå¯ä»¥åœ¨å±å¹•æˆªå›¾ä¸­çœ‹åˆ°ï¼‰ã€‚ </p><br><p> è½¬åˆ°é‚£é‡Œå¹¶å¯ç”¨ä»¥ä¸‹å­˜å‚¨åº“ï¼š </p><br><ul><li>  OMV-Extras.orgã€‚ ä¸€ä¸ªç¨³å®šçš„å­˜å‚¨åº“ï¼Œå…¶ä¸­åŒ…å«è®¸å¤šæ’ä»¶ã€‚ </li><li>  OMV-Extras.orgæµ‹è¯•ã€‚ è¯¥å­˜å‚¨åº“ä¸­çš„æŸäº›æ’ä»¶ä¸åœ¨ç¨³å®šçš„å­˜å‚¨åº“ä¸­ã€‚ </li><li>  Docker CEã€‚ å®é™…ä¸Šï¼ŒDockerã€‚ </li></ul><br><p> åœ¨<em>â€œç³»ç»Ÿ-&gt; OMV Extras-&gt;å†…æ ¸â€</em>é€‰é¡¹å¡ä¸Šï¼Œå¯ä»¥é€‰æ‹©æ‰€éœ€çš„å†…æ ¸ï¼ŒåŒ…æ‹¬Proxmoxçš„å†…æ ¸ï¼ˆæˆ‘è‡ªå·±æ²¡æœ‰å®‰è£…å®ƒï¼Œå› ä¸ºæˆ‘è¿˜ä¸éœ€è¦å®‰è£…ï¼Œå› æ­¤ä¸æ¨èä½¿ç”¨ï¼‰ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dq/se/jq/dqsejqlsyn0x6wdbyfeb2kvlwmc.png"></a> </p><br><p> å®‰è£…å¿…è¦çš„æ’ä»¶ï¼ˆ <em>ç”¨æ–œä½“</em> <strong>æ˜¾ç¤ºçš„</strong>ç»å¯¹å¿…è¦çš„<strong>ç²—ä½“</strong> -å¯é€‰ï¼Œæˆ‘æ²¡æœ‰å®‰è£…ï¼‰ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">æ’ä»¶åˆ—è¡¨ã€‚</b> <div class="spoiler_text"><ul><li>  openmediavault-apttoolã€‚ ç”¨äºæ‰¹å¤„ç†ç³»ç»Ÿçš„æœ€ä½GUIã€‚ æ·»åŠ <em>â€œæœåŠ¡-&gt; Apttoolâ€</em> ã€‚ </li><li>  openmediavault-anacronã€‚ æ·»åŠ äº†ä½¿ç”¨å¼‚æ­¥è°ƒåº¦ç¨‹åºä»GUIå·¥ä½œçš„åŠŸèƒ½ã€‚ æ·»åŠ <em>â€œç³»ç»Ÿ-&gt; Anacronâ€</em> ã€‚ </li><li>  openmediavaultå¤‡ä»½ã€‚ åœ¨å­˜å‚¨ä¸­æä¾›å¤‡ä»½ç³»ç»Ÿã€‚ æ·»åŠ é¡µé¢<em>â€œç³»ç»Ÿ-&gt;å¤‡ä»½â€</em> ã€‚ </li><li>  openmediavault-diskstatsã€‚ éœ€è¦æ”¶é›†æœ‰å…³ç£ç›˜æ€§èƒ½çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ </li><li>  <em>openmediavault-dnsmasq</em> ã€‚ å…è®¸æ‚¨åœ¨NASä¸Šå¢åŠ DNSæœåŠ¡å™¨å’ŒDHCPã€‚ å› ä¸ºæˆ‘æ˜¯åœ¨è·¯ç”±å™¨ä¸Šè¿›è¡Œçš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å®ƒã€‚ </li><li>  <strong>openmediavault-docker-gui</strong> ã€‚  Dockerå®¹å™¨ç®¡ç†ç•Œé¢ã€‚ æ·»åŠ <em>â€œæœåŠ¡-&gt; Dockerâ€</em> ã€‚ </li><li>  <strong>openmediavault-ldap</strong> ã€‚ æ”¯æŒé€šè¿‡LDAPè¿›è¡Œèº«ä»½éªŒè¯ã€‚ æ·»åŠ <em>â€œæƒé™ç®¡ç†-&gt;ç›®å½•æœåŠ¡â€</em> ã€‚ </li><li>  <em>openmediavault-letsencrypt</em> ã€‚ ä»GUIæ”¯æŒâ€œè®©æˆ‘ä»¬åŠ å¯†â€ã€‚ ä¸éœ€è¦å®ƒï¼Œå› ä¸ºå®ƒä½¿ç”¨åµŒå…¥åœ¨nginx-reverse-proxyå®¹å™¨ä¸­ã€‚ </li><li>  <strong>openmediavault-luksencryption</strong> ã€‚  LUKSåŠ å¯†æ”¯æŒã€‚ å¿…é¡»åœ¨OMVç•Œé¢ä¸­æ˜¾ç¤ºåŠ å¯†çš„ç£ç›˜ã€‚ æ·»åŠ <em>â€œå­˜å‚¨-&gt;åŠ å¯†â€</em> ã€‚ </li><li>  <strong>openmediavault-nut</strong> ã€‚  UPSæ”¯æŒã€‚ æ·»åŠ <em>â€œæœåŠ¡-&gt; UPSâ€</em> ã€‚ </li><li>  <strong>openmediavault-omvextrasorg</strong> ã€‚  OMV Extrasåº”è¯¥å·²ç»å®‰è£…ã€‚ </li><li>  openmediavault-resetpermsã€‚ å…è®¸æ‚¨é‡ç½®æƒé™å’Œé‡ç½®å…±äº«ç›®å½•ä¸Šçš„è®¿é—®æ§åˆ¶åˆ—è¡¨ã€‚ æ·»åŠ <em>â€œè®¿é—®æ§åˆ¶-&gt;å¸¸è§„ç›®å½•-&gt;é‡ç½®æƒé™â€</em> ã€‚ </li><li>  openmediavault-routeã€‚ è·¯ç”±ç®¡ç†çš„æœ‰ç”¨æ’ä»¶ã€‚ æ·»åŠ <em>â€œç³»ç»Ÿ-&gt;ç½‘ç»œ-&gt;é™æ€è·¯ç”±â€</em> ã€‚ </li><li>  openmediavaultç¬¦å·é“¾æ¥ã€‚ æä¾›åˆ›å»ºç¬¦å·é“¾æ¥çš„åŠŸèƒ½ã€‚ æ·»åŠ é¡µé¢<em>â€œæœåŠ¡-&gt;ç¬¦å·é“¾æ¥â€</em> ã€‚ </li><li>  openmediavault-unionæ–‡ä»¶ç³»ç»Ÿã€‚  UnionFSæ”¯æŒã€‚ å°½ç®¡Dockerä½¿ç”¨ZFSä½œä¸ºåç«¯ï¼Œä½†å°†æ¥å¯èƒ½ä¼šæ´¾ä¸Šç”¨åœºã€‚ æ·»åŠ <em>â€œå­˜å‚¨-&gt;è”åˆæ–‡ä»¶ç³»ç»Ÿâ€</em> ã€‚ </li><li>  <em>openmediavault-virtualbox</em> ã€‚ å®ƒå¯ç”¨äºåœ¨GUIä¸­åµŒå…¥è™šæ‹Ÿæœºç®¡ç†åŠŸèƒ½ã€‚ </li><li>  <strong>openmediavault-zfs</strong> ã€‚ è¯¥æ’ä»¶å°†ZFSæ”¯æŒæ·»åŠ åˆ°OpenMediaVaultã€‚ å®‰è£…åï¼Œå°†å‡ºç°<em>â€œå­˜å‚¨-&gt; ZFSâ€</em>é¡µé¢ã€‚ </li></ul></div></div><br><h3 id="diski"> ç£ç¢Ÿ </h3><br><p> ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç£ç›˜éƒ½å¿…é¡»æ˜¯å¯è§çš„OMVã€‚ é€šè¿‡æŸ¥çœ‹<em>â€œå­˜å‚¨-&gt;ç£ç›˜â€æ ‡ç­¾æ¥</em>ç¡®ä¿è¿™ä¸€ç‚¹ã€‚ å¦‚æœä¸æ˜¯æ‰€æœ‰å…‰ç›˜éƒ½å¯è§ï¼Œè¯·è¿è¡Œæ‰«æã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ju/i3/rs/jui3rsmgmatghluwuk0rknsqfrq.png" alt="ç³»ç»Ÿä¸­çš„ç£ç›˜"></a> </p><br><p> åœ¨é‚£é‡Œï¼Œå¿…é¡»åœ¨æ‰€æœ‰HDDä¸Šå¯ç”¨å†™ç¼“å­˜ï¼ˆé€šè¿‡å•å‡»åˆ—è¡¨ä¸­çš„ç£ç›˜å¹¶å•å‡»â€œç¼–è¾‘â€æŒ‰é’®ï¼‰ã€‚ </p><br><p> ç¡®ä¿åœ¨<em>â€œå­˜å‚¨-&gt;åŠ å¯†â€é€‰é¡¹å¡</em>ä¸Šå¯è§æ‰€æœ‰åŠ å¯†éƒ¨åˆ†ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dy/nw/kv/dynwkvuhbnglzeqe3sin_vqda7i.png" alt="åŠ å¯†åˆ†åŒº"></a> </p><br><p> ç°åœ¨æ˜¯æ—¶å€™é…ç½®SMARTäº†ï¼Œè¿™è¡¨ç¤ºå¢åŠ å¯é æ€§çš„ä¸€ç§æ–¹å¼ï¼š </p><br><ul><li> è½¬åˆ°<em>â€œå­˜å‚¨-&gt; SMART-&gt;è®¾ç½®â€é€‰é¡¹å¡</em> ã€‚ æ‰“å¼€SMARTã€‚ </li><li> åœ¨åŒä¸€ä½ç½®ï¼Œé€‰æ‹©ç£ç›˜çš„æ¸©åº¦æ°´å¹³å€¼ï¼ˆä¸´ç•Œï¼Œé€šå¸¸ä¸º60 Cï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç£ç›˜</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ€ä½³æ¸©åº¦èŒƒå›´ä¸º</a> 15-45 Cï¼‰ã€‚ </li><li> è½¬åˆ°<em>â€œå­˜å‚¨-&gt; SMART-&gt;è®¾å¤‡â€æ ‡ç­¾</em> ã€‚ æ‰“å¼€æ¯ä¸ªé©±åŠ¨å™¨çš„ç›‘è§†ã€‚ <br> <a href=""><img src="https://habrastorage.org/webt/83/r-/dc/83r-dcwtrhth5icaketuw1zlis8.png"></a> </li><li> è½¬åˆ°<em>â€œå­˜å‚¨-&gt; SMART-&gt;è®¡åˆ’çš„æµ‹è¯•â€é€‰é¡¹å¡</em> ã€‚ æ¯å¤©ä¸ºæ¯ä¸ªç£ç›˜æ·»åŠ ä¸€æ¬¡ç®€çŸ­çš„è‡ªæµ‹ï¼Œå¹¶æ¯æœˆæ·»åŠ ä¸€æ¬¡é•¿æ—¶é—´çš„è‡ªæµ‹ã€‚ è€Œä¸”ï¼Œè‡ªæ£€æ—¶é—´ä¸ä¼šé‡å ã€‚ <br> <a href=""><img src="https://habrastorage.org/webt/lh/u8/qf/lhu8qffcenb8utgcekfoy_j0oee.png"></a> </li></ul><br><p> è¿™æ ·ï¼Œå°±å¯ä»¥è®¤ä¸ºç£ç›˜é…ç½®å·²å®Œæˆã€‚ </p><br><h3 id="faylovye-sistemy-i-obschie-katalogi"> æ–‡ä»¶ç³»ç»Ÿå’Œå…±äº«ç›®å½• </h3><br><p> æ‚¨å¿…é¡»ä¸ºé¢„å®šä¹‰ç›®å½•åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿã€‚ <br> è¿™å¯ä»¥ä»æ§åˆ¶å°æˆ–ä»OMV WEBç•Œé¢ï¼ˆå­˜å‚¨- <em>&gt; ZFS-&gt;é€‰æ‹©æ± tank0-&gt;æ·»åŠ æŒ‰é’®-&gt;æ–‡ä»¶ç³»ç»Ÿ</em> ï¼‰å®Œæˆã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç”¨äºåˆ›å»ºFSçš„å‘½ä»¤ã€‚</b> <div class="spoiler_text"><pre> <code class="hljs sql">zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/books zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/music zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/pictures zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/downloads zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o compression=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/videos</code> </pre> </div></div><br><p> ç»“æœåº”ä¸ºä»¥ä¸‹ç›®å½•ç»“æ„ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ua/uy/yk/uauyykwki2nmmmpj6pe3-lqxrie.png"></a> </p><br><p> ä¹‹åï¼Œåœ¨<em>â€œç®¡ç†è®¿é—®æƒé™-&gt;å¸¸è§„ç›®å½•-&gt;æ·»åŠ â€</em>é¡µé¢<em>ä¸Šå°†</em>åˆ›å»ºçš„FSæ·»åŠ ä¸ºå…±äº«ç›®å½•ã€‚ <br> è¯·æ³¨æ„ï¼Œ <em>â€œè®¾å¤‡â€</em>å‚æ•°ç­‰äºåœ¨ZFSä¸­åˆ›å»ºçš„æ–‡ä»¶ç³»ç»Ÿçš„<em>è·¯å¾„</em> ï¼Œæ‰€æœ‰ç›®å½•çš„<em>â€œè·¯å¾„â€</em>å‚æ•°å‡ä¸ºâ€œ /â€ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/xc/9v/da/xc9vdaubqewzyhqfm80k_751fo8.png"></a> </p><br><h3 id="rezervnoe-kopirovanie"> åå¤‡ </h3><br><p> å¤‡ä»½ç”±ä¸¤ä¸ªå·¥å…·å®Œæˆï¼š </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">OMVå¤‡ä»½æ’ä»¶</a> ã€‚ ç”¨äºç³»ç»Ÿå¤‡ä»½çš„OMVæ’ä»¶ã€‚ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">zfs-auto-snapshot</a> ã€‚ ç”¨äºæŒ‰è®¡åˆ’è‡ªåŠ¨åˆ›å»ºZFSå¿«ç…§å¹¶åˆ é™¤æ—§å¿«ç…§çš„è„šæœ¬ã€‚ </li></ul><br><p> å¦‚æœæ‚¨ä½¿ç”¨æ’ä»¶ï¼Œåˆ™å¾ˆå¯èƒ½ä¼šæ”¶åˆ°é”™è¯¯æ¶ˆæ¯ï¼š </p><br><pre> <code class="hljs vhdl">lsblk: /dev/<span class="hljs-keyword"><span class="hljs-keyword">block</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> device</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¦‚OMVå¼€å‘äººå‘˜</a>åœ¨æ­¤â€œéå¸¸éæ ‡å‡†é…ç½®â€ä¸­<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æŒ‡å‡ºçš„é‚£æ ·ï¼Œ</a>ä¸ºäº†å¯¹å…¶è¿›è¡Œä¿®å¤ï¼Œå¯ä»¥æ‹’ç»æ’ä»¶å¹¶ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>zfs send/receive</code></a>çš„å½¢å¼ä½¿ç”¨ZFSå·¥å…·ã€‚ <br> æˆ–è€…ï¼Œä»¥ä»ä¸­è¿›è¡Œä¸‹è½½çš„ç‰©ç†è®¾å¤‡çš„å½¢å¼æ˜¾å¼æŒ‡å®šå‚æ•°â€œ Root deviceâ€ã€‚ <br> å¯¹äºæˆ‘æ¥è¯´ï¼Œä½¿ç”¨è¯¥æ’ä»¶å¹¶ä»è¯¥ç•Œé¢å¤‡ä»½æ“ä½œç³»ç»Ÿæ›´ä¸ºæ–¹ä¾¿ï¼Œè€Œä¸æ˜¯ä½¿ç”¨zfs sendæ¥æ„å»ºè‡ªå·±çš„ä¸œè¥¿ï¼Œå› æ­¤æˆ‘æ›´å–œæ¬¢ç¬¬äºŒç§é€‰æ‹©ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/q8/hm/k9/q8hmk9guerk2it7d1xe4tuzvtak.png" alt="å¤‡ä»½è®¾å®š"></a> </p><br><p> è¦è¿›è¡Œå¤‡ä»½ï¼Œè¯·é¦–å…ˆé€šè¿‡ZFSåˆ›å»º<code>tank0/apps/backup</code>æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååœ¨<em>â€œç³»ç»Ÿ-&gt;å¤‡ä»½â€èœå•</em>ä¸­ï¼Œåœ¨<em>â€œå…¬å…±æ–‡ä»¶å¤¹â€</em>å‚æ•°å­—æ®µä¸­å•å‡»â€œ +â€ï¼Œç„¶åå°†åˆ›å»ºçš„è®¾å¤‡æ·»åŠ ä¸ºç›®æ ‡è®¾å¤‡ï¼Œç„¶åå°†<em>â€œè·¯å¾„â€</em>å­—æ®µæ·»åŠ è®¾ç½®ä¸ºâ€œ /â€ã€‚ </p><br><p>  zfs-auto-snapshotä¹Ÿå­˜åœ¨é—®é¢˜ã€‚ å¦‚æœæœªé…ç½®ï¼Œå¥¹å°†åœ¨ä¸€å¹´ä¸­çš„æ¯ä¸ªå°æ—¶ï¼Œæ¯å¤©ï¼Œæ¯å‘¨ï¼Œæ¯æœˆæ‹æ‘„ç…§ç‰‡ã€‚ <br> ç»“æœæ˜¯å±å¹•æˆªå›¾ä¸­çš„å†…å®¹ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/af/_j/gw/af_jgw_evodbuhm07iqwpjh-he8.png" alt="æ¥è‡ªzfs-auto-snapshotçš„å¤§é‡åƒåœ¾é‚®ä»¶"></a> </p><br><p> å¦‚æœæ‚¨å·²ç»é‡åˆ°è¿‡è¿™ç§æƒ…å†µï¼Œè¯·è¿è¡Œä»¥ä¸‹ä»£ç æ¥åˆ é™¤è‡ªåŠ¨å¿«ç…§ï¼š </p><br><pre> <code class="hljs powershell">zfs list <span class="hljs-literal"><span class="hljs-literal">-t</span></span> snapshot <span class="hljs-literal"><span class="hljs-literal">-o</span></span> name <span class="hljs-literal"><span class="hljs-literal">-S</span></span> creation | grep <span class="hljs-string"><span class="hljs-string">"@zfs-auto-snap"</span></span> | tail <span class="hljs-literal"><span class="hljs-literal">-n</span></span> +<span class="hljs-number"><span class="hljs-number">1500</span></span> | xargs <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> zfs destroy <span class="hljs-literal"><span class="hljs-literal">-vr</span></span></code> </pre> <br><p> ç„¶åå°†zfs-auto-snapshoté…ç½®ä¸ºåœ¨cronä¸­è¿è¡Œã€‚ <br> é¦–å…ˆï¼Œå¦‚æœä¸éœ€è¦æ¯å°æ—¶æ‹ç…§ï¼Œåªéœ€åˆ é™¤<code>/etc/cron.hourly/zfs-auto-snapshot</code> ã€‚ </p><br><h3 id="e-mail-uvedomleniya"> ç”µé‚®é€šçŸ¥ </h3><br><p> ç”µå­é‚®ä»¶é€šçŸ¥å·²è¢«æŒ‡ç¤ºä¸ºå®ç°å¯é æ€§çš„æ‰‹æ®µä¹‹ä¸€ã€‚ <br> å› æ­¤ï¼Œç°åœ¨æ‚¨éœ€è¦é…ç½®ç”µå­é‚®ä»¶é€šçŸ¥ã€‚ <br> ä¸ºæ­¤ï¼Œè¯·åœ¨å…¶ä¸­ä¸€å°å…¬ç”¨æœåŠ¡å™¨ä¸Šæ³¨å†Œä¸€ä¸ªæ¡†ï¼ˆæˆ–è€…ï¼Œå¦‚æœç¡®å®æœ‰ç†ç”±ï¼Œè¯·è‡ªè¡Œé…ç½®SMTPæœåŠ¡å™¨ï¼‰ã€‚ </p><br><p> ç„¶åï¼Œæ‚¨éœ€è¦è½¬åˆ°<em>â€œç³»ç»Ÿ-&gt;é€šçŸ¥â€</em>é¡µé¢å¹¶è¾“å…¥ï¼š </p><br><ul><li>  SMTPæœåŠ¡å™¨åœ°å€ã€‚ </li><li>  SMTPæœåŠ¡å™¨ç«¯å£ã€‚ </li><li> ç”¨æˆ·å </li><li> å‘ä»¶äººåœ°å€ï¼ˆé€šå¸¸åœ°å€çš„ç¬¬ä¸€éƒ¨åˆ†ä¸åç§°åŒ¹é…ï¼‰ã€‚ </li><li> ç”¨æˆ·å¯†ç  </li><li> åœ¨â€œæ”¶ä»¶äººâ€å­—æ®µä¸­ï¼ŒNASå°†å‘å…¶å‘é€é€šçŸ¥çš„é€šå¸¸åœ°å€ã€‚ </li></ul><br><p> å¼ºçƒˆå»ºè®®å¯ç”¨SSL / TLSã€‚ </p><br><p> å±å¹•å¿«ç…§æ˜¾ç¤ºäº†Yandexçš„ç¤ºä¾‹è®¾ç½®ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/4j/pb/2m/4jpb2mwgystnu_3yc9vf9l16soo.png" alt="ç”µå­é‚®ä»¶é€šçŸ¥"></a> </p><br><h2 id="nastroyka-seti-vne-nas">  NASå¤–éƒ¨çš„ç½‘ç»œè®¾ç½® </h2><br><h3 id="ip-adres">  IPåœ°å€ </h3><br><p> æˆ‘ä½¿ç”¨ç™½è‰²çš„é™æ€IPåœ°å€ï¼Œæ¯æœˆè´¹ç”¨åŠ ä¸Š100å¢å¸ƒã€‚ å¦‚æœæ‚¨ä¸æƒ³ä»˜æ¬¾ï¼Œå¹¶ä¸”æ‚¨çš„åœ°å€æ˜¯åŠ¨æ€çš„ï¼Œä½†æ˜¯å¯¹äºNATåˆ™ä¸æ˜¯ï¼Œåˆ™å¯ä»¥é€šè¿‡æ‰€é€‰æœåŠ¡çš„APIè°ƒæ•´å¤–éƒ¨DNSè®°å½•ã€‚ <br> ä½†æ˜¯ï¼Œåº”è¯¥è®°ä½ï¼ŒéNATåœ°å€å¯èƒ½çªç„¶å˜æˆNATåœ°å€ï¼šé€šå¸¸ï¼Œæä¾›ç¨‹åºä¸æä¾›ä»»ä½•ä¿è¯ã€‚ </p><br><h3 id="router"> è·¯ç”±å™¨ </h3><br><p> ä½œä¸ºè·¯ç”±å™¨ï¼Œæˆ‘æœ‰ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mikrotik RouterBoard</a> ï¼Œç±»ä¼¼äºä¸‹é¢çš„å›¾ç‰‡ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ni/mv/a8/nimva8ju1vg2doqcnwd7s0_xcmw.jpeg" alt="Mikrotikè·¯ç”±å™¨"></a> </p><br><p> è·¯ç”±å™¨éœ€è¦ä¸‰ä»¶äº‹ï¼š </p><br><ul><li> é…ç½®NASçš„é™æ€åœ°å€ã€‚ å¯¹äºæˆ‘æ¥è¯´ï¼Œåœ°å€æ˜¯é€šè¿‡DHCPå‘å‡ºçš„ï¼Œæˆ‘éœ€è¦ç¡®ä¿å…·æœ‰ç‰¹å®šMACåœ°å€çš„é€‚é…å™¨å§‹ç»ˆè·å¾—ç›¸åŒçš„IPåœ°å€ã€‚ åœ¨RouterOSä¸­ï¼Œè¿™æ˜¯é€šè¿‡<em>â€œ IP-&gt; DHCPæœåŠ¡å™¨â€é€‰é¡¹å¡</em>ä¸Šçš„<em>â€œä½¿é™æ€â€</em>æŒ‰é’®å®Œæˆçš„ã€‚ </li><li> é…ç½®DNSæœåŠ¡å™¨ï¼Œä»¥ä¾¿ä¸ºåç§°â€œ nasâ€ä»¥åŠä»¥â€œ .nasâ€å’Œâ€œ .NAS.cloudns.ccâ€ç»“å°¾çš„åç§°ï¼ˆå…¶ä¸­â€œ NASâ€æ˜¯ClouDNSæˆ–ç±»ä¼¼æœåŠ¡ä¸Šçš„åŒºåŸŸï¼‰æä¾›IPç³»ç»Ÿã€‚ ä¸‹é¢çš„å±å¹•å¿«ç…§æ˜¾ç¤ºäº†åœ¨RouterOSä¸­æ‰§è¡Œæ­¤æ“ä½œçš„ä½ç½®ã€‚ å°±æˆ‘è€Œè¨€ï¼Œè¿™æ˜¯é€šè¿‡å°†åç§°ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ¥å®ç°çš„ï¼šâ€œ <code>^.*\.nas$|^nas$|^.*\.NAS.cloudns.cc$</code> â€ </li><li> é…ç½®ç«¯å£è½¬å‘ã€‚ åœ¨RouterOSä¸­ï¼Œè¿™æ˜¯åœ¨<em>â€œ IP-&gt;é˜²ç«å¢™â€é€‰é¡¹å¡ä¸Šå®Œæˆçš„</em> ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚ </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/wu/2d/3n/wu2d3ng2xlqaleslb__9a72vtpo.png" alt="åœ¨RouterOSä¸­é…ç½®DNS"></a> </p><br><h3 id="cloudns"> åŸŸåè§£æ </h3><br><p>  CLouDNSå¾ˆç®€å•ã€‚ åˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼Œç¡®è®¤ã€‚  NSè®°å½•å°†å·²ç»å‘æ‚¨æ³¨å†Œã€‚ æ¥ä¸‹æ¥ï¼Œéœ€è¦æœ€å°‘çš„è®¾ç½®ã€‚ </p><br><p> é¦–å…ˆï¼Œæ‚¨éœ€è¦åˆ›å»ºå¿…è¦çš„åŒºåŸŸï¼ˆå½“ç„¶ï¼Œåœ¨å±å¹•å¿«ç…§ä¸­ä»¥çº¢è‰²çªå‡ºæ˜¾ç¤ºçš„åç§°ä¸ºNASçš„åŒºåŸŸå°±æ˜¯æ‚¨åº”è¯¥ä½¿ç”¨å…¶ä»–åç§°åˆ›å»ºçš„åŒºåŸŸï¼‰ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wj/3k/0u/wj3k0ueaouj9tdslhubqtdz49os.png" alt="åœ¨ClouDNSä¸­åˆ›å»ºåŒºåŸŸ"></a> </p><br><p> å…¶æ¬¡ï¼Œåœ¨æ­¤åŒºåŸŸä¸­ï¼Œæ‚¨åº”è¯¥æ³¨å†Œä»¥ä¸‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Aè®°å½•</a> ï¼š </p><br><ul><li>  <strong>nas</strong> ï¼Œ <strong>www</strong> ï¼Œ <strong>omv</strong> ï¼Œ <strong>control</strong>å’Œä¸€ä¸ª<strong>ç©ºåç§°</strong> ã€‚ è®¿é—®OMVç•Œé¢ã€‚ </li><li>  <strong>ldap</strong> ã€‚  PhpLdapAdminç•Œé¢ </li><li>  <strong>ssp</strong> ã€‚ ä¿®æ”¹ç”¨æˆ·å¯†ç çš„ç•Œé¢ã€‚ </li><li>  <strong>æµ‹è¯•</strong> ã€‚ æµ‹è¯•æœåŠ¡å™¨ã€‚ </li></ul><br><p> å…¶ä½™åŸŸåå°†åœ¨æ·»åŠ æœåŠ¡æ—¶æ·»åŠ ã€‚ <br> å•å‡»åŒºåŸŸï¼Œç„¶åå•å‡»<em>â€œæ·»åŠ æ–°è®°å½•â€</em> ï¼Œé€‰æ‹©Aå‹ï¼Œç„¶åè¾“å…¥NASæ‰€åœ¨çš„è·¯ç”±å™¨çš„åŒºåŸŸåç§°å’ŒIPåœ°å€ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ym/9o/s2/ym9os2upazemboftovtmasp3h1u.png" alt="æ·»åŠ äº†ä¸€æ¡è®°å½•"></a> </p><br><p> å…¶æ¬¡ï¼Œæ‚¨éœ€è¦è®¿é—®APIã€‚ åœ¨ClouDNSä¸­ï¼Œå®ƒæ˜¯ä»˜è´¹çš„ï¼Œå› æ­¤æ‚¨å¿…é¡»å…ˆä»˜è´¹ã€‚ åœ¨å…¶ä»–æœåŠ¡ä¸­ï¼Œå®ƒæ˜¯å…è´¹çš„ã€‚ å¦‚æœæ‚¨çŸ¥é“å“ªä¸ªæ›´å¥½ï¼Œå¹¶ä¸”<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Lexicon</a>æ”¯æŒï¼Œé‚£ä¹ˆè¯·åœ¨è¯„è®ºä¸­å†™ã€‚ </p><br><p> è·å¾—å¯¹APIçš„è®¿é—®æƒé™åï¼Œæ‚¨éœ€è¦åœ¨æ­¤å¤„æ·»åŠ æ–°çš„APIç”¨æˆ·ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ah/tc/rp/ahtcrpidjt3gvlnuc-udwjj0no8.png" alt="æ·»åŠ ClouDNS APIç”¨æˆ·"></a> </p><br><p>   <em>"IP address"</em>   IP :  ,     API.  ,    ,    API,   <strong>auth-id</strong>  <strong>auth-password</strong> .      Lexicon,  . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/z_/6k/yv/z_6kyvkyj9gqlbi_s-dudfoirzs.png"></a> </p><br><p>    ClouDNS . </p><br><h2>   </h2><br><h3 id="nastroyka-docker">  Docker </h3><br><p>     openmediavault-docker-gui,  docker-ce      . </p><br><p> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker-compose</a> ,         : </p><br><pre> <code class="bash hljs">apt-get install docker-compose</code> </pre> <br><p>       : </p><br><pre> <code class="bash hljs">zfs create -p /tank0/docker/services</code> </pre> <br><p>  ,       <code>/var/lib/docker</code> .     ( ,   SSD),  ,  ,         . </p><br><p> ..,              <br>   .   . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wn/by/ec/wnbyecyxrlrsf0cssx78zqmoxdu.png"></a> </p><br><p>   ,         . <br>       ,      GUI ,    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">    </a> , ..       ,     . </p><br><p>        <code>/var/lib</code>   : </p><br><pre> <code class="bash hljs">service docker stop zfs create -o com.sun:auto-snapshot=<span class="hljs-literal"><span class="hljs-literal">false</span></span> -p /tank0/docker/lib rm -rf /var/lib/docker ln -s /tank0/docker/lib /var/lib/docker service docker start</code> </pre> <br><p>  : </p><br><pre> <code class="bash hljs">$ ls -l /var/lib/docker lrwxrwxrwx 1 root root 17 Apr 7 12:35 /var/lib/docker -&gt; /tank0/docker/lib</code> </pre> <br><p>     : </p><br><pre> <code class="bash hljs">docker network create docker0</code> </pre> <br><p>     Docker       . </p><br><h3 id="nastroyka-konteynera-s-nginx-reverse-proxy">    nginx-reverse-proxy </h3><br><p>    Docker ,     . </p><br><p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ,   . </p><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">nginx-proxy</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">letsencrypt-dns</a> . </p><br><p> ,    OMV    10080  10443,        80  443. </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs javascript">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: external: name: docker0 services: nginx-proxy: networks: - docker0 restart: always image: jwilder/nginx-proxy ports: - <span class="hljs-string"><span class="hljs-string">"80:80"</span></span> - <span class="hljs-string"><span class="hljs-string">"443:443"</span></span> volumes: - ./certs:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/certs:ro - ./vhost.d:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/vhost.d - ./html:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>share/nginx/html - <span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>run/docker.sock:<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>docker.sock:ro - ./local-config:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/conf.d - ./nginx.tmpl:<span class="hljs-regexp"><span class="hljs-regexp">/app/</span></span>nginx.tmpl labels: - <span class="hljs-string"><span class="hljs-string">"com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"</span></span> letsencrypt-dns: image: adferrand/letsencrypt-dns volumes: - ./certs/letsencrypt:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>letsencrypt environment: - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_PROVIDER=cloudns"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_OPTIONS=--delegated NAS.cloudns.cc"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD"</span></span></code> </pre> </div></div><br><p>      : </p><br><ul><li> nginx-reverse-proxy â€” c  . </li><li> letsencrypt-dns â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ACME </a> Let's Encrypt. </li></ul><br><p>       nginx-reverse-proxy   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">jwilder/nginx-proxy</a> . </p><br><p> <code>docker0</code> â€”  ,    ,    docker-compose. <br> <code>nginx-proxy</code> â€”   ,  .     docker0.  ,  80  443   ports      (,       ,           docker0,   ). <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>restart: always</code></a> ,       . </p><br><p> : </p><br><ul><li>   <strong><code>certs</code></strong>   <strong><code>/etc/nginx/certs</code></strong> â€”   ,  ,   Let's Encrypt.           ACME . </li><li> <code>./vhost.d:/etc/nginx/vhost.d</code> â€”    .   . </li><li> <code>./html:/usr/share/nginx/html</code> â€”  .     . </li><li> <strong><code>/var/run/docker.sock</code></strong> ,   <strong><code>/tmp/docker.sock</code></strong> â€”      Docker  .    docker-gen   . </li><li> <strong><code>./local-config</code></strong> ,   <strong><code>/etc/nginx/conf.d</code></strong> â€”    nginx.    ,   . </li><li> <strong><code>./nginx.tmpl</code></strong> ,   <strong><code>/app/nginx.tmpl</code></strong> â€”     nginx,   docker-gen  . </li></ul><br><p>  letsencrypt-dns    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">adferrand/letsencrypt-dns</a> .     ACME   Lexicon,     DNS . </p><br><p>   <code>certs/letsencrypt</code>   <code>/etc/letsencrypt</code>  . </p><br><p>   ,        : </p><br><ul><li> <strong><code>LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM</code></strong> â€”   Let's Encrypt.     ,      . </li><li> <strong><code>LEXICON_PROVIDER=cloudns</code></strong> â€”   Lexicon.    â€” <code>cloudns</code> . </li><li> <strong><code>LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD --delegated=NAS.cloudns.cc</code></strong> â€” CLOUDNS_ID        ClouDNS  . CLOUDNS_PASSWORD â€”  ,      API. NAS.cloudns.cc,  NAS â€”   DNS .  cloudns  ,          (cloudns.cc),  ClouDNS API     . </li></ul><br><p>        :      . <br>  ,      ,   ,     ,    Let's encrypt: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ls ./certs/letsencrypt/ accounts archive csr domains.conf keys live renewal renewal<span class="hljs-literal"><span class="hljs-literal">-hooks</span></span></code> </pre> <br><p>  ,      ,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/nginx.tmpl</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">{{ <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentContainer := where <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-comment"><span class="hljs-comment">"ID"</span></span> .<span class="hljs-type"><span class="hljs-type">Docker</span></span>.<span class="hljs-type"><span class="hljs-type">CurrentContainerID</span></span> | first }} {{ define <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> }} {{ if .<span class="hljs-type"><span class="hljs-type">Address</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> we got the containers from swarm and this container<span class="hljs-string"><span class="hljs-string">'s port is published to host, use host IP:PORT */}} {{ if and .Container.Node.ID .Address.HostPort }} # {{ .Container.Node.Name }}/{{ .Container.Name }} server {{ .Container.Node.Address.IP }}:{{ .Address.HostPort }}; {{/* If there is no swarm node or the port is not published on host, use container'</span></span>s <span class="hljs-type"><span class="hljs-type">IP</span></span>:<span class="hljs-type"><span class="hljs-type">PORT</span></span> */}} {{ else if .<span class="hljs-type"><span class="hljs-type">Network</span></span> }} # {{ .<span class="hljs-type"><span class="hljs-type">Container</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> }} server {{ .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }}:{{ .<span class="hljs-type"><span class="hljs-type">Address</span></span>.<span class="hljs-type"><span class="hljs-type">Port</span></span> }}; {{ end }} {{ else if .<span class="hljs-type"><span class="hljs-type">Network</span></span> }} # {{ .<span class="hljs-type"><span class="hljs-type">Container</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> }} {{ if .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }} server {{ .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }} down; {{ else }} server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> down; {{ end }} {{ end }} {{ end }} # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Proto</span></span>, pass it through; otherwise, pass along the # scheme used to connect to this server map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_proto <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_proto { default <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_proto; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>cheme; } # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Port</span></span>, pass it through; otherwise, pass along the # server port the client connected to map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_port <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_port { default <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_port; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>erver_port; } # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">Upgrade</span></span>, set <span class="hljs-type"><span class="hljs-type">Connection</span></span> to <span class="hljs-comment"><span class="hljs-comment">"upgrade"</span></span>; otherwise, delete any # <span class="hljs-type"><span class="hljs-type">Connection</span></span> header that may have been passed to this server map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_upgrade <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_connection { default upgrade; <span class="hljs-string"><span class="hljs-string">''</span></span> close; } # <span class="hljs-type"><span class="hljs-type">Apply</span></span> fix for very long server names server_names_hash_bucket_size <span class="hljs-number"><span class="hljs-number">128</span></span>; # <span class="hljs-type"><span class="hljs-type">Default</span></span> dhparam {{ if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/dhparam/dhparam.pem"</span></span>) }} ssl_dhparam /etc/nginx/dhparam/dhparam.pem; {{ end }} # <span class="hljs-type"><span class="hljs-type">Set</span></span> appropriate <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Ssl</span></span> header map <span class="hljs-string"><span class="hljs-string">$s</span></span>cheme <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_ssl { default off; https on; } gzip_types text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript; log_format vhost <span class="hljs-string"><span class="hljs-string">'$host $remote_addr - $remote_user [$time_local] '</span></span> <span class="hljs-string"><span class="hljs-string">'"$request" $status $body_bytes_sent '</span></span> <span class="hljs-string"><span class="hljs-string">'"$http_referer" "$http_user_agent"'</span></span>; access_log off; {{ if <span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">RESOLVERS</span></span> }} resolver {{ <span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">RESOLVERS</span></span> }}; {{ end }} {{ if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/proxy.conf"</span></span>) }} include /etc/nginx/proxy.conf; {{ else }} # <span class="hljs-type"><span class="hljs-type">HTTP</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> support proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_buffering off; proxy_set_header <span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_host; proxy_set_header <span class="hljs-type"><span class="hljs-type">Upgrade</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_upgrade; proxy_set_header <span class="hljs-type"><span class="hljs-type">Connection</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_connection; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Real</span></span>-<span class="hljs-type"><span class="hljs-type">IP</span></span> <span class="hljs-string"><span class="hljs-string">$r</span></span>emote_addr; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">For</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_add_x_forwarded_for; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Proto</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_proto; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Ssl</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_ssl; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Port</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_port; # <span class="hljs-type"><span class="hljs-type">Mitigate</span></span> httpoxy attack (see <span class="hljs-type"><span class="hljs-type">README</span></span> for details) proxy_set_header <span class="hljs-type"><span class="hljs-type">Proxy</span></span> <span class="hljs-comment"><span class="hljs-comment">""</span></span>; {{ end }} {{ <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 := eq (or (<span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">ENABLE_IPV6</span></span>) <span class="hljs-comment"><span class="hljs-comment">""</span></span>) <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> }} server { server_name _; # <span class="hljs-type"><span class="hljs-type">This</span></span> is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">80</span></span>; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span>; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">503</span></span>; } {{ if (and (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.crt"</span></span>) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.key"</span></span>)) }} server { server_name _; # <span class="hljs-type"><span class="hljs-type">This</span></span> is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">503</span></span>; ssl_session_tickets off; ssl_certificate /etc/nginx/certs/default.crt; ssl_certificate_key /etc/nginx/certs/default.key; } {{ end }} {{ range <span class="hljs-string"><span class="hljs-string">$h</span></span>ost, <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers := groupByMulti <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_HOST"</span></span> <span class="hljs-comment"><span class="hljs-comment">","</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost := trim <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{ <span class="hljs-string"><span class="hljs-string">$i</span></span>s_regexp := hasPrefix <span class="hljs-comment"><span class="hljs-comment">"~"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{ <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name := when <span class="hljs-string"><span class="hljs-string">$i</span></span>s_regexp (sha1 <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} # {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} upstream {{ <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }} { {{ range <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer := <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddrLen := len <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> }} {{ range <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork := <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentContainer.<span class="hljs-type"><span class="hljs-type">Networks</span></span> }} {{ range <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork := <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Networks</span></span> }} {{ if (and (ne <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-comment"><span class="hljs-comment">"ingress"</span></span>) (or (eq <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span>) (eq <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-comment"><span class="hljs-comment">"host"</span></span>))) }} ## <span class="hljs-type"><span class="hljs-type">Can</span></span> be connected with <span class="hljs-comment"><span class="hljs-comment">"{{ $containerNetwork.Name }}"</span></span> network {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> only <span class="hljs-number"><span class="hljs-number">1</span></span> port exposed, use that */}} {{ if eq <span class="hljs-string"><span class="hljs-string">$a</span></span>ddrLen <span class="hljs-number"><span class="hljs-number">1</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress := index <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> }} {{ template <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> (dict <span class="hljs-comment"><span class="hljs-comment">"Container"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer <span class="hljs-comment"><span class="hljs-comment">"Address"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress <span class="hljs-comment"><span class="hljs-comment">"Network"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork) }} {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> more than one port exposed, use the one matching <span class="hljs-type"><span class="hljs-type">VIRTUAL_PORT</span></span> env var, falling back to standard web port <span class="hljs-number"><span class="hljs-number">80</span></span> */}} {{ else }} {{ <span class="hljs-string"><span class="hljs-string">$p</span></span>ort := coalesce <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">VIRTUAL_PORT</span></span> <span class="hljs-comment"><span class="hljs-comment">"80"</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress := where <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> <span class="hljs-comment"><span class="hljs-comment">"Port"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>ort | first }} {{ template <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> (dict <span class="hljs-comment"><span class="hljs-comment">"Container"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer <span class="hljs-comment"><span class="hljs-comment">"Address"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress <span class="hljs-comment"><span class="hljs-comment">"Network"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork) }} {{ end }} {{ else }} # <span class="hljs-type"><span class="hljs-type">Cannot</span></span> connect to network of this container server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> down; {{ end }} {{ end }} {{ end }} {{ end }} } {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_host := or (<span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">DEFAULT_HOST</span></span>) <span class="hljs-comment"><span class="hljs-comment">""</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server := index (dict <span class="hljs-string"><span class="hljs-string">$h</span></span>ost <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_host <span class="hljs-comment"><span class="hljs-comment">"default_server"</span></span>) <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">VIRTUAL_PROTO</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"http"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$p</span></span>roto := trim (or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_PROTO"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"http"</span></span>) }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">NETWORK_ACCESS</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"external"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.NETWORK_ACCESS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"external"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">HTTPS_METHOD</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.HTTPS_METHOD"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">SSL_POLICY</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.SSL_POLICY"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">HSTS</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"max-age=31536000"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>sts := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.HSTS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"max-age=31536000"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">VIRTUAL_ROOT</span></span> <span class="hljs-type"><span class="hljs-type">By</span></span> containers w/ use fastcgi root */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_ROOT"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"/var/www/public"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the first cert name defined by containers w/ the same vhost */}} {{ <span class="hljs-string"><span class="hljs-string">$c</span></span>ertName := (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.CERT_NAME"</span></span>)) }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the best matching cert by name for the vhost. */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := (closest (dir <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs"</span></span>) (printf <span class="hljs-comment"><span class="hljs-comment">"%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost))}} {{/* vhostCert is actually a filename so remove any suffixes since they are added later */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := trimSuffix <span class="hljs-comment"><span class="hljs-comment">".crt"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert }} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := trimSuffix <span class="hljs-comment"><span class="hljs-comment">".key"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert }} {{/* <span class="hljs-type"><span class="hljs-type">Use</span></span> the cert specified on the container or fallback to the best vhost match */}} {{ <span class="hljs-string"><span class="hljs-string">$c</span></span>ert := (coalesce <span class="hljs-string"><span class="hljs-string">$c</span></span>ertName <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert) }} {{ <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https := (and (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"nohttps"</span></span>) (ne <span class="hljs-string"><span class="hljs-string">$c</span></span>ert <span class="hljs-comment"><span class="hljs-comment">""</span></span>) (or (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)))) ) }} {{ if <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https }} {{ if eq <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">301</span></span> https://<span class="hljs-string"><span class="hljs-string">$h</span></span>ost<span class="hljs-string"><span class="hljs-string">$r</span></span>equest_uri; } {{ end }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; {{ if eq <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag <span class="hljs-comment"><span class="hljs-comment">"internal"</span></span> }} # <span class="hljs-type"><span class="hljs-type">Only</span></span> allow traffic from internal clients include /etc/nginx/network_internal.conf; {{ end }} {{ if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Modern"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Old"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">SSLv3</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:DES-CBC3-SHA:HIGH:SEED:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!RSAPSK:!aDH:!aECDH:!EDH-DSS-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!SRP'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-TLS-1-2-2017-01"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:AES128-GCM-SHA256:AES128-SHA256:AES256-GCM-SHA384:AES256-SHA256'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-TLS-1-1-2017-01"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2016-08"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-05"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DES-CBC3-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-03"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA:DES-CBC3-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-02"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA'</span></span>; {{ end }} ssl_prefer_server_ciphers on; ssl_session_timeout <span class="hljs-number"><span class="hljs-number">5</span></span>m; ssl_session_cache shared:<span class="hljs-type"><span class="hljs-type">SSL</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>m; ssl_session_tickets off; {{ if (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) }} ssl_certificate /etc/nginx/certs/letsencrypt/live/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; ssl_certificate_key /etc/nginx/certs/letsencrypt/live/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; {{ else if (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) }} ssl_certificate /etc/nginx/certs/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; ssl_certificate_key /etc/nginx/certs/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.dhparam.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) }} ssl_dhparam {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.dhparam.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.chain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) }} ssl_stapling on; ssl_stapling_verify on; ssl_trusted_certificate {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.chain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert }}; {{ end }} {{ if (and (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"noredirect"</span></span>) (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>sts <span class="hljs-comment"><span class="hljs-comment">"off"</span></span>)) }} add_header <span class="hljs-type"><span class="hljs-type">Strict</span></span>-<span class="hljs-type"><span class="hljs-type">Transport</span></span>-<span class="hljs-type"><span class="hljs-type">Security</span></span> <span class="hljs-comment"><span class="hljs-comment">"{{ trim $hsts }}"</span></span> always; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default"</span></span>) }} include /etc/nginx/vhost.d/default; {{ end }} location / { {{ if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"uwsgi"</span></span> }} include uwsgi_params; uwsgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"fastcgi"</span></span> }} root {{ trim <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root }}; include fastcgi.conf; fastcgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else }} proxy_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} auth_basic <span class="hljs-comment"><span class="hljs-comment">"Restricted {{ $host }}"</span></span>; auth_basic_user_file {{ (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost}}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default_location"</span></span>) }} include /etc/nginx/vhost.d/default_location; {{ end }} } } {{ end }} {{ if or (not <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https) (eq <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"noredirect"</span></span>) }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; {{ if eq <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag <span class="hljs-comment"><span class="hljs-comment">"internal"</span></span> }} # <span class="hljs-type"><span class="hljs-type">Only</span></span> allow traffic from internal clients include /etc/nginx/network_internal.conf; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default"</span></span>) }} include /etc/nginx/vhost.d/default; {{ end }} location / { {{ if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"uwsgi"</span></span> }} include uwsgi_params; uwsgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"fastcgi"</span></span> }} root {{ trim <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root }}; include fastcgi.conf; fastcgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else }} proxy_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} auth_basic <span class="hljs-comment"><span class="hljs-comment">"Restricted {{ $host }}"</span></span>; auth_basic_user_file {{ (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost}}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default_location"</span></span>) }} include /etc/nginx/vhost.d/default_location; {{ end }} } } {{ if (and (not <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.crt"</span></span>) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.key"</span></span>)) }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">500</span></span>; ssl_certificate /etc/nginx/certs/default.crt; ssl_certificate_key /etc/nginx/certs/default.key; } {{ end }} {{ end }} {{ end }}</code> </pre> </div></div><br><p> ,    nginx     <code>/etc/nginx/certs/%s.crt</code>  <code>/etc/nginx/certs/%s.pem</code> ,  %s â€”   (  â€”  ,      ). </p><br><p>        <code>/etc/nginx/certs/letsencrypt/live/%s/{fullchain.pem, privkey.pem}</code> ,            : </p><br><pre> <code class="hljs perl">{{ $is_https := (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $https_method <span class="hljs-string"><span class="hljs-string">"nohttps"</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $cert <span class="hljs-string"><span class="hljs-string">""</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> $cert)) (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> $cert)) ) (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/%s.crt"</span></span> $cert)) (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/%s.key"</span></span> $cert)) ) ) ) }}</code> </pre> <br><p>    ,        <code>domains.conf</code> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/certs/letsencrypt/domains.conf</b> <div class="spoiler_text"><pre> <code class="hljs css">*<span class="hljs-selector-class"><span class="hljs-selector-class">.NAS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cloudns</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NAS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cloudns</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cc</span></span></code> </pre> </div></div><br><p>     .  ,           ,     ,     <code>client_max_body_size</code>     20,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/local-config/max_upload_size.conf</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">client_max_body_size</span></span> <span class="hljs-number"><span class="hljs-number">20G</span></span>;</code> </pre> </div></div><br><p>  ,   : </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up</code> </pre> <br><p>   (   ),  Ctrl+C        : </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up <span class="hljs-literal"><span class="hljs-literal">-d</span></span></code> </pre> <br><h3 id="nastroyka-konteynera-s-testovym-serverom">      </h3><br><p>   â€”   nginx,     . ,       ,     . <br>       ,      NAS. </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><p>   docker-compose : </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/test_nginx/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: docker0 services: nginx-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> image: nginx:alpine expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> - <span class="hljs-number"><span class="hljs-number">443</span></span> environment: - "VIRTUAL_HOST=test.NAS.cloudns.cc" - "VIRTUAL_PROTO=http" - "VIRTUAL_PORT=80" - CERT_NAME=NAS.cloudns.cc networks: - docker0</code> </pre> </div></div><br><p>        : </p><br><ul><li> <code>docker0</code> â€”  .    . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>expose</code></a> â€”    ,   .  ,  80   HTTP  443   HTTPS. </li><li> <code>VIRTUAL_HOST=test.NAS.cloudns.cc</code> â€”      ,   nginx-reverse-proxy      . </li><li> <code>VIRTUAL_PROTO=http</code> â€”    nginx-reverse-proxy     .   ,  HTTP. </li><li> <code>VIRTUAL_PORT=80</code> â€”      nginx-reverse-proxy. </li><li> <code>CERT_NAME=NAS.cloudns.cc</code> â€”   .   ,     ,    . NAS â€”  DNS . </li><li> <code>networks</code> â€”      ,    nginx-reverse-proxy     <code>docker0</code> . </li></ul><br><p>  ,    .  <code>docker-compose up</code> ,    <code>test.NAS.cloudns.cc</code> . </p><br><p>       : </p><br><pre> <code class="bash hljs">$ docker-compose up Creating testnginx_nginx-local_1 Attaching to testnginx_nginx-local_1 nginx-local_1 | 172.22.0.5 - - [29/Jul/2018:15:32:02 +0000] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 612 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537 (KHTML, like Gecko) Chrome/67.0 Safari/537"</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.2.3"</span></span> nginx-local_1 | 2018/07/29 15:32:02 [error] 8<span class="hljs-comment"><span class="hljs-comment">#8: *2 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.22.0.5, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "test.NAS.cloudns.cc", referrer: "https://test.NAS.cloudns.cc/" nginx-local_1 | 172.22.0.5 - - [29/Jul/2018:15:32:02 +0000] "GET /favicon.ico HTTP/1.1" 404 572 "https://test.NAS.cloudns.cc/" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537 (KHTML, like Gecko) Chrome/67.0 Safari/537" "192.168.2.3"</span></span></code> </pre> <br><p>     : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wj/-v/q3/wj-vq3xwns34rsn_tr8zvycwiei.png" alt="æ¨å‡ºNginx"></a> </p><br><p> ,  ,    ,    ,   :     . </p><br><p>      ,   Ctrl+C,   <code>docker-compose down</code> . </p><br><h3 id="nastroyka-konteynera-s-local-rpoxy">    local-rpoxy </h3><br><p>   ,      nginx-default  ,     nas, omv        10080  10443   . </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-local/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="bash hljs">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: external: name: docker0 services: nginx-local: restart: always image: nginx:alpine expose: - 80 - 443 environment: - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_HOST=NAS.cloudns.cc,nas,nas.*,www.*,omv.*,nas-controller.nas"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PROTO=http"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PORT=80"</span></span> - CERT_NAME=NAS.cloudns.cc volumes: - ./<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-config:/etc/nginx/conf.d networks: - docker0</code> </pre> </div></div><br><p>   docker-compose    ,        . <br> ,   ,  ,     <code>NAS.cloudns.cc</code> .    ,     NAS    DNS ,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-local/local-config/default.conf</b> <div class="spoiler_text"><pre> <code class="hljs mel"># If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the # scheme used to connect to this server map $http_x_forwarded_proto $proxy_x_forwarded_proto { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> $http_x_forwarded_proto; <span class="hljs-string"><span class="hljs-string">''</span></span> $scheme; } # If we receive X-Forwarded-Port, pass it through; otherwise, pass along the # server port the client connected to map $http_x_forwarded_port $proxy_x_forwarded_port { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> $http_x_forwarded_port; <span class="hljs-string"><span class="hljs-string">''</span></span> $server_port; } # Set appropriate X-Forwarded-Ssl header map $scheme $proxy_x_forwarded_ssl { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> off; https on; } access_log on; error_log on; # HTTP <span class="hljs-number"><span class="hljs-number">1.1</span></span> support proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_buffering off; proxy_set_header Host $http_host; proxy_set_header Upgrade $http_upgrade; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto; proxy_set_header X-Forwarded-Ssl $proxy_x_forwarded_ssl; proxy_set_header X-Forwarded-Port $proxy_x_forwarded_port; # Mitigate httpoxy attack (see README <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details) proxy_set_header Proxy <span class="hljs-string"><span class="hljs-string">""</span></span>; server { server_name _; # This is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">503</span></span>; } server { server_name www.* nas.* omv.* <span class="hljs-string"><span class="hljs-string">""</span></span>; listen <span class="hljs-number"><span class="hljs-number">80</span></span>; location / { proxy_pass https:<span class="hljs-comment"><span class="hljs-comment">//172.21.0.1:10443/; } } # nas-controller server { server_name nas-controller.nas; listen 80 ; location / { proxy_pass https://nas-controller/; } }</span></span></code> </pre> </div></div><br><ul><li> <code>172.21.0.1</code> â€”  .       443,        OMV   HTTPS.        . </li><li> <code>https://nas-controller/</code> â€” -,      IPMI,     nas,   nas-controller.nas,       nas-controller.   . </li></ul><br><h2>    LDAP </h2><br><h3 id="nastroyka-ldap-servera">  LDAP- </h3><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">LDAP-</a> â€”      . <br>     Docker .  ,  ,       . </p><br><p>    LDIF-  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/ldap/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: "2" networks: ldap: docker0: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: docker0 services: <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap: image: "osixia/openldap:1.2.0" hostname: "open-ldap" <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> environment: - "LDAP_ORGANISATION=NAS" - "LDAP_DOMAIN=nas.nas" - "LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD" - "LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD" - "LDAP_TLS=true" - "LDAP_TLS_ENFORCE=false" - "LDAP_TLS_CRT_FILENAME=ldap_server.crt" - "LDAP_TLS_KEY_FILENAME=ldap_server.key" - "LDAP_TLS_CA_CRT_FILENAME=ldap_server.crt" volumes: - ./certs:/container/service/slapd/assets/certs - ./ldap_data/var/lib:/var/lib/ldap - ./ldap_data/etc/ldap/slapd.d:/etc/ldap/slapd.d networks: - ldap ports: - <span class="hljs-number"><span class="hljs-number">172.21</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span> - <span class="hljs-number"><span class="hljs-number">172.21</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>::<span class="hljs-number"><span class="hljs-number">636</span></span>:<span class="hljs-number"><span class="hljs-number">636</span></span> phpldapadmin: image: "osixia/phpldapadmin:0.7.1" hostname: "nas.nas" <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> networks: - ldap - docker0 expose: - <span class="hljs-number"><span class="hljs-number">443</span></span> links: - <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap:<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> volumes: - ./certs:/container/service/phpldapadmin/assets/apache2/certs environment: - VIRTUAL_HOST=ldap.* - VIRTUAL_PORT=<span class="hljs-number"><span class="hljs-number">443</span></span> - VIRTUAL_PROTO=https - CERT_NAME=NAS.cloudns.cc - "PHPLDAPADMIN_LDAP_HOSTS=open-ldap-server" #- "PHPLDAPADMIN_HTTPS=false" - "PHPLDAPADMIN_HTTPS_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_HTTPS_KEY_FILENAME=private/ldap_server.key" - "PHPLDAPADMIN_HTTPS_CA_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT=allow" ldap-ssp: image: openfrontier/ldap-ssp:https volumes: #- ./ssp/mods-enabled/ssl.conf:/etc/apache2/mods-enabled/ssl.conf - /etc/ssl/certs/ssl-cert-snakeoil.pem:/etc/ssl/certs/ssl-cert-snakeoil.pem - /etc/ssl/private/ssl-cert-snakeoil.key:/etc/ssl/private/ssl-cert-snakeoil.key <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> networks: - ldap - docker0 expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> links: - <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap:<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> environment: - VIRTUAL_HOST=ssp.* - VIRTUAL_PORT=<span class="hljs-number"><span class="hljs-number">80</span></span> - VIRTUAL_PROTO=http - CERT_NAME=NAS.cloudns.cc - "LDAP_URL=ldap://open-ldap-server:389" - "LDAP_BINDDN=cn=admin,dc=nas,dc=nas" - "LDAP_BINDPW=ADMIN_PASSWORD" - "LDAP_BASE=ou=users,dc=nas,dc=nas" - "MAIL_FROM=admin@nas.nas" - "PWD_MIN_LENGTH=8" - "PWD_MIN_LOWER=3" - "PWD_MIN_DIGIT=2" - "SMTP_HOST=" - "SMTP_USER=" - "SMTP_PASS="</code> </pre> </div></div><br><p>     : </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>open-ldap</code></a> â€” LDAP-. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>phpldapadmin</code></a> â€” WEB-   .       ,   ... </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>ldap-ssp</code></a> â€” WEB-    . </li></ul><br><p> LDAP-    ,     : </p><br><ul><li> <code>LDAP_ORGANISATION=NAS</code> â€”  .   . </li><li> <code>LDAP_DOMAIN=nas.nas</code> â€” .  .    ,    . </li><li> <code>LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD</code> â€”  . </li><li> <code>LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD</code> â€”   . </li></ul><br><p> -,       "  ",  . </p><br><p> : </p><br><ul><li> <code>/container/service/slapd/assets/certs</code>     <code>certs</code> â€” .   . </li><li> <code>./ldap_data/</code> â€”  ,        .  LDAP   . </li></ul><br><p>      <code>ldap</code> ,    389 ( LDAP)  636 (LDAP  SSL,   )    . </p><br><p> PhpLdapAdmin    :     LDAP   <code>ldap</code>    443   <code>docker0</code> ,  ,      nginx-reverse-proxy. </p><br><p> : </p><br><ul><li> <code>VIRTUAL_HOST=ldap.*</code> â€” ,  nginx-reverse-proxy   . </li><li> <code>VIRTUAL_PORT=443</code> â€”   nginx-reverse-proxy. </li><li> <code>VIRTUAL_PROTO=https</code> â€”   nginx-reverse-proxy. </li><li> <code>CERT_NAME=NAS.cloudns.cc</code> â€”  ,   . </li></ul><br><p>        SSL    . </p><br><p> SSP   HTTP      . <br> ,     ,       . </p><br><p>    â€”             LDAP. </p><br><ul><li> <code>LDAP_URL=ldap://open-ldap-server:389</code> â€”    LDAP  (.  <code>links</code> ). </li><li> <code>LDAP_BINDDN=cn=admin,dc=nas,dc=nas</code> â€”      . </li><li> <code>LDAP_BINDPW=ADMIN_PASSWORD</code> â€”  ,     ,    open-ldap. </li><li> <code>LDAP_BASE=ou=users,dc=nas,dc=nas</code> â€”   ,      . </li></ul><br><p>         LDAP   LDAP : </p><br><pre> <code class="bash hljs">apt-get install ldap-utils ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W -f ldifs/inititialize_ldap.ldif ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W -f ldifs/base.ldif ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,cn=config"</span></span> -W -f ldifs/gitlab_attr.ldif</code> </pre> <br><p>  <code>gitlab_attr.ldif</code>  ,   Gitlab (  )   . <br>         . </p><br><div class="spoiler"> <b class="spoiler_title">  LDAP </b> <div class="spoiler_text"><pre> <code class="bash hljs">$ ldapsearch -x -H ldap://172.21.0.1 -b dc=nas,dc=nas -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W Enter LDAP Password: <span class="hljs-comment"><span class="hljs-comment"># extended LDIF # # LDAPv3 # base &lt;dc=nas,dc=nas&gt; with scope subtree # filter: (objectclass=*) # requesting: ALL # # nas.nas dn: dc=nas,dc=nas objectClass: top objectClass: dcObject objectClass: organization o: NAS dc: nas # admin, nas.nas dn: cn=admin,dc=nas,dc=nas objectClass: simpleSecurityObject objectClass: organizationalRole cn: admin description: LDAP administrator ... # ldap_users, groups, nas.nas dn: cn=ldap_users,ou=groups,dc=nas,dc=nas cn: ldap_users gidNumber: 500 objectClass: posixGroup objectClass: top # search result search: 2 result: 0 Success # numResponses: 12 # numEntries: 11</span></span></code> </pre> </div></div><br><p>    LDAP  .      WEB-. </p><br><h3 id="nastroyka-omv-dlya-vhoda-po-ldap">  OMV    LDAP </h3><br><p>  LDAP    , OMV       :  , ,   ,          ,    â€”  . </p><br><p> LDAP      . </p><br><p>    : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/0e/fq/yp/0efqypb4eevkfvm1dx5hccpxcae.png" alt="é…ç½®OMVä»¥ä½¿ç”¨LDAP"></a> </p><br><h2>     </h2><br><p>     ,     ,     NAS  USB. <br>          . <br>     NUT  GUI OMV. <br>    <em>"-&gt;"</em> ,  ,      ,  ,  "eaton". </p><br><p>   <em>"  "</em>  : </p><br><pre> <code class="hljs pgsql">driver = usbhid-ups port = auto <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> = "Eaton 9130 700 VA" vendorid = <span class="hljs-number"><span class="hljs-number">0463</span></span> pollinterval = <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br><ul><li> <code>driver = usbhid-ups</code> â€”    USB,    USB HID. </li><li> <code>vendorid</code> â€”    ,      <code>lsusb</code> . </li><li> <code>pollinterval</code> â€”     c. </li></ul><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><p>  <code>lsusb</code> ,     : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># lsusb Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub --&gt; Bus 001 Device 003: ID 0463:ffff MGE UPS Systems UPS Bus 001 Device 004: ID 046b:ff10 American Megatrends, Inc. Virtual Keyboard and Mouse Bus 001 Device 002: ID 046b:ff01 American Megatrends, Inc. Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span></span></code> </pre> <br><p> <em>" "</em>    "  ". <br>    ,    : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/0v/1e/5c/0v1e5ceg5axff7qac7gnqqlv5dc.png" alt="UPSè®¾ç½®"></a> </p><br><p>     .    ,        . <br>     . </p><br><h2> ç»“è®º </h2><br><p>       .   ,       ,     ,   ,   . <br>      â€”  . </p><br><p>    -, OMV   . </p><br><p>     WEB-,       ,   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/tb/p3/ja/tbp3jabundd-ifinj76eimw-me0.png"></a> </p><br><p>  Docker     WEB-: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ol/1o/h_/ol1oh_koe2adncdkhh9qozsufkm.png"></a> </p><br><p>  , OMV    . </p><br><p>   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fq/n7/v2/fqn7v20f3vq1ekj7ygcg1jbv2cu.png" alt="ç½‘ç»œä½¿ç”¨æ—¶é—´è¡¨"></a> </p><br><p>   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/52/k4/3e/52k43eckcekf7bxfxqmsbnv4hlm.png" alt="å†…å­˜ä½¿ç”¨æƒ…å†µå›¾"></a> </p><br><p>   CPU: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/qn/e8/ir/qne8ir6ndfbl17zyvzzl5vyexs0.png" alt="CPUä½¿ç”¨ç‡å›¾"></a> </p><br><h2 id="nerealizovannoe">  </h2><br><ul><li>    â€”   . ,     -  .   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>docker-compose exec</code></a> ,       . </li><li> LDAP      ,     ( SSL ,      ..). </li><li>          ,    ,    . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">ValdikSS</a>      DropbearSSH,   initramfs     .     . </li></ul><br><p>   . <br>  ! </p><br><p><img src="https://habrastorage.org/webt/n0/dy/xy/n0dyxyaz2tzyp5q1vvdskj1fr9c.jpeg"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN415779/">https://habr.com/ru/post/zh-CN415779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN415769/index.html">é€šè¿‡TeamCityè®¾ç½®è‡ªåŠ¨å¯åŠ¨Androidåº”ç”¨ç¨‹åºçš„UIæµ‹è¯•</a></li>
<li><a href="../zh-CN415771/index.html">Goç¼–è¯‘å™¨ï¼šSSAä¼˜åŒ–è§„åˆ™æè¿°è¯­è¨€</a></li>
<li><a href="../zh-CN415773/index.html">éåŠŸèƒ½éœ€æ±‚ï¼šå¯æ‰©å±•æ€§</a></li>
<li><a href="../zh-CN415775/index.html">ä¸ºé…·ä¼šè®®å‡†å¤‡æŠ¥å‘Šçš„ç®€å•ä½†ä¸æ˜æ˜¾çš„æŠ€å·§</a></li>
<li><a href="../zh-CN415777/index.html">ç¬¬ä¸€ä¸ªå¼€å‘ä¸­çš„æœºå™¨å­¦ä¹ å† å†›</a></li>
<li><a href="../zh-CN415781/index.html">ç‰©ç†å­¦å®¶ä¸ºä»€ä¹ˆè®¤ä¸ºå¼¦è®ºå¯èƒ½å˜æˆâ€œä¸‡ç‰©è®ºâ€</a></li>
<li><a href="../zh-CN415783/index.html">æ˜Ÿç›˜å‘æˆ‘ä»¬æ­ç¤ºäº†è¡Œæ˜Ÿå¤–è§‚çš„ç§˜å¯†</a></li>
<li><a href="../zh-CN415785/index.html">SpaceXå°†äººå·¥æ™ºèƒ½æœºå™¨äººå‘é€ç»™ISS</a></li>
<li><a href="../zh-CN415789/index.html">è®¡ç®—æœºç¨‹åºçš„ä¸“åˆ©ç®—æ³•</a></li>
<li><a href="../zh-CN415791/index.html">ä¼˜åŒ–æ™ºèƒ½åˆçº¦ã€‚ å®ä½“ç±»å‹å¦‚ä½•å½±å“äº¤æ˜“æˆæœ¬</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>