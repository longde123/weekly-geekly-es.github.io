<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛵️ 🍭 🙈 Surveillance environnementale dans la salle des serveurs (Bolid + Zabbix) 🍡 🙏🏿 🙋🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le moyen le plus simple pour un professionnel de l'informatique de résoudre le problème de surveillance environnementale dans la salle des serveurs es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Surveillance environnementale dans la salle des serveurs (Bolid + Zabbix)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438788/">  Le moyen le plus simple pour un professionnel de l'informatique de résoudre le problème de surveillance environnementale dans la salle des serveurs est probablement d'utiliser des contrôleurs spécialisés avec sortie SNMP (par exemple, NetBotz ou NetPing).  Mais pour ceux qui n'ont pas peur des difficultés et veulent obtenir une solution peu coûteuse au niveau industriel (avec production en série d'équipements) - il existe une option intéressante avec le protocole Modbus. <br><br><img src="https://habrastorage.org/webt/wu/uc/mi/wuucmi1fiyi7sglvrsekrvey0pk.png"><br><a name="habracut"></a><br>  Ci-dessous, je décrirai un système de surveillance basé sur des composants fabriqués en Russie - NVP Bolid, et nous «fusionnerons» les données dans Zabbix 4.0.  NVP "Bolid" est largement connu dans les milieux des équipements d'automatisation de lutte contre l'incendie et la solution envisagée portera cette "empreinte".  Leurs appareils, pour le moins, ne diffèrent pas par la conception et la finesse des boîtiers, mais ... le prix compense largement toutes ces lacunes.  Il convient de noter une très bonne documentation et un support technique gratuit plus ou moins normal. <br><br><h2>  Protocoles et interfaces </h2><br>  Avant de passer au matériel, nous examinerons brièvement les protocoles et interfaces utilisés: <br><br>  <b>Modbus</b> : un protocole industriel construit sur le principe «Maître» - «Esclave».  Il ne peut y avoir qu'un seul maître sur un réseau Modbus qui interroge les esclaves et «dit» quoi faire.  En tant que support de transmission, il peut utiliser l'interface RS-485 (Modbus RTU) ou Ethernet (Modbus TCP).  Théoriquement, le nombre maximum d'appareils est de 247. <br><br>  <b>Orion</b> : protocole propriétaire de la société NVP "Bolid", construit sur le principe de "Master" (Master) - "Slave" (Slave).  Apparemment, l'interface RS-485 modifiée est utilisée comme support de transmission de données, grâce à laquelle la longueur de ligne maximale peut atteindre 3 km (!).  Le nombre maximum d'appareils est 127. <br><br>  <b>DLS</b> (ligne de communication bifilaire): protocole propriétaire de la société NVP "Bolid", construit sur le principe "Master" - "Slave" (Master).  Il utilise un câble à paire de cuivre comme support de transmission de données (un câble à paire torsadée est recommandé).  Le nombre maximum d'appareils est de 127 + 1.  Topologie - un bus (ou anneau) avec des branches, la longueur de ligne maximale peut atteindre 1,5 km (selon le type de câble, la section des conducteurs de câble et le nombre d'appareils connectés). <br><br>  <b>RS-485</b> : interface de couche physique, utilise des «paires torsadées» (une paire «2 fils» ou deux paires «4 fils» pour la transmission de données, la seconde est moins courante).  La longueur de ligne maximale déclarée est de 1,2 km.  La topologie est un bus. <br><br>  Comme vous pouvez le voir, des lignes de communication assez «longue portée» sont utilisées.  Dans tous les protocoles, l'adressage des périphériques est défini par des «poignées» (préconfiguration). <br><br><h2>  Capteurs </h2><br>  Le système implique la connexion de capteurs d'adresse «spéciaux» (propriétaires) (pour le dire plus strictement «détecteurs», c'est-à-dire des appareils avec un capteur intégré), mais vous pouvez également connecter des adresses «ordinaires» sans adresse à l'aide d'extensions d'adresse (de 1 à 8 entrées).  L'utilisation de détecteurs adressables présente deux avantages: presque tous les appareils adressables sont alimentés via la ligne de signal (c'est-à-dire qu'il n'est pas nécessaire de fournir une ligne d'alimentation 12V séparée) et qu'il n'est pas nécessaire de placer l'expanseur d'adresse n'importe où.  Les capteurs sont connectés au <abbr title="ligne de communication à deux fils">DPS</abbr> . <br>  La gamme d'équipements "terminaux" est assez large, mais je vais vous donner celui qui peut être nécessaire pour résoudre notre problème: <br><br><ul><li>  S2000-VT - capteur combiné de température et d'humidité pour une utilisation en intérieur (IP41).  Possède un certificat d'instrument de mesure, l'erreur n'est que de 0,5 ° C et le prix de vente recommandé de seulement 1200 roubles! </li><li>  S2000-SMK (et ses variantes) - Capteur «porte ouverte» (détecteur de contact magnétique, interrupteur reed).  Prix ​​de vente recommandé - 300 roubles.; </li><li>  S2000-DZ - capteur d'inondation ponctuelle (fait en collaboration avec Realty, le boîtier est donc "non formaté").  Prix ​​de vente conseillé - 800 roubles.; </li><li>  2000-1, 2000-2, 2000-8 - extenseurs d'adresse pour 1, 2 et 8 connexions, peuvent être utilisés comme «récepteurs» de signaux de type «contact sec» (marche / arrêt) à partir d'autres équipements (par exemple, à partir d'un dispositif d'extinction d'incendie ou pompes de climatisation); </li><li>  S2000-SP2 - bloc de relais (pour 2 sorties), avec lequel vous pouvez contrôler des appareils (par exemple, une lampe d'alarme - un indicateur lumineux).  Prix ​​de vente conseillé - 1200 roubles. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Apparence des capteurs</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/wy/ff/2k/wyff2kk8bfwz0bcq5feyh-kvja4.png"><br><br></div></div><br>  Pour une liste complète des équipements, consultez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site officiel du fabricant</a> . <br><br><h2>  Contrôleur </h2><br>  La "ligne" de contrôleurs, si je puis dire, se compose de trois modèles: <br><br><ul><li>  S2000-KDL - modèle de base (la désignation signifie "Système 2000 - Contrôleur d'une ligne de communication à deux fils"); </li><li>  S2000-KDL-2I - isolation galvanique supplémentaire pour RS-485 et DPS; </li><li>  S2000-KDL-Modbus - un convertisseur de protocole Modbus S2000-PP a été ajouté à la conception S2000-KDL-2I. </li></ul><br><div class="spoiler">  <b class="spoiler_title">L'apparence des contrôleurs</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/gw/wu/nb/gwwunbbgi8jsdrp4lirdesxxoyi.png"><br></div></div><br>  Il est plus optimal d'utiliser S2000-KDL-Modbus, mais il est également possible d'utiliser S2000-KDL / C2000-KDL-2I avec le convertisseur de protocole S2000-PP installé à proximité, qui a une conception de boîtier montée sur panneau. <br><br>  Le contrôleur joue le rôle de «leader» dans la ligne <abbr title="ligne de communication à deux fils">DLS</abbr> (une seule ligne DPS peut être connectée à un contrôleur), et sur la ligne RS-485 Orion, il agit déjà comme «esclave» et il ne sera pas possible de collecter des données directement.  Pour collecter des données dans la ligne RS-485 Orion, la console dite 2000 ou 2000- (y compris la version intégrée) est utilisée, qui ont déjà des interfaces de transfert de données standardisées. <br><br>  Les contrôleurs suivants peuvent également distinguer les caractéristiques suivantes: <br><br><ul><li>  se référer à un type configurable, pas programmable (c'est-à-dire qu'il vous suffit de configurer les paramètres et non de développer un programme) </li><li>  prise en charge dans les <abbr title="ligne de communication à deux fils">DPS</abbr> jusqu'à 127 appareils adressables (S2000-VT a deux adresses), et de nombreux commissaires ne recommandent pas d'utiliser plus de 100-110; </li><li>  double entrée pour alimentation DC 12-24V; </li><li>  conception pas trop pratique (tous les fils connectés ne peuvent pas être cachés dans le boîtier de l'appareil et vous devez les retirer de l'arrière de l'appareil). </li></ul><br>  Pour la tolérance aux pannes du système, vous pouvez utiliser les mesures suivantes (facultatives): <br><br><ul><li>  boucle en anneau - une rupture de boucle à un endroit n'affecte pas la présence de signaux provenant de capteurs adressables; </li><li>  l'utilisation de blocs d'isolation de branche (BRIZ) - vous permet de faire des branches radiales, ainsi que d'isoler le segment de boucle, dans lequel il y avait un court-circuit "DPS +" et "DPS-". </li></ul><br>  IMPORTANT: de nouveaux micrologiciels arrivent constamment sur les contrôleurs qui éliminent les erreurs et ajoutent des fonctionnalités, et les micrologiciels C2000-KDL et C2000-KDL-2I sont incompatibles. <br><br><h2>  Connexion Modbus </h2><br>  Comme décrit précédemment, un contrôleur C2000-Modbus ou un convertisseur C2000-PP peut être utilisé.  Les deux schémas prévoient l'émission de signaux en utilisant le protocole Modbus RTU à 2 fils en utilisant RS-485 comme périphérique esclave (notre hôte est Zabbix ou un système SCADA).  Deux méthodes peuvent être utilisées pour se connecter au serveur: <br><br><ul><li>  Préféré - Convertisseur Modbus RTU / Modbus TCP avec connexion au même réseau local où se trouve notre serveur avec logiciel; </li><li>  Pas cher - Convertisseur RS-485 / USB avec connexion directe au serveur.  Je note qu'il y a beaucoup de plaintes concernant la fiabilité de ces clés USB (vous pouvez en prendre presque toutes, j'ai commandé de la Chine pour 100 roubles, utilisé un tas de convertisseur RS-232 / RS-485 et un adaptateur USB / RS-232 et tout a continué à fonctionner!). </li></ul><br>  Deux schémas de transmission d'événements au protocole Modbus sont possibles: <br><br><ul><li>  directement à partir de 2000- / C2000--Modbus, lorsque ces appareils fonctionnent en mode "Orion-Master" (sélectionnés par un cavalier sur la carte) et agissent comme interrogateur du système "Orion"; </li><li>  à l'aide de la télécommande «S2000M», lorsqu'elle collecte des informations des contrôleurs et les envoie ensuite à Modbus via C2000- / C2000--Modbus (mode «Orion-Slave»).  Ce schéma est bon dans la mesure où la télécommande peut être utilisée comme un «terminal local» (voir les événements sur l'écran LCD intégré), et continue également d'enregistrer les événements en cas de défaillance du serveur avec le logiciel de surveillance.  Moins: la configuration est un peu plus compliquée et la télécommande a une apparence très spécifique. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Exemples de circuits système</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/u6/se/lr/u6selr6hievry0qlrqy77naclpm.png"><br><br><img src="https://habrastorage.org/webt/lr/mr/ny/lrmrnydyc3k7okcrwtfinacdvj8.png"><br><br><img src="https://habrastorage.org/webt/fz/hb/gf/fzhbgfqp5l5crnlkazfbvabmemg.png"><br></div></div><br><h2>  Puissance et installation </h2><br>  Pour l'alimentation, une alimentation 12V DC est requise, de préférence stabilisée et montée sur un rail DIN.  Sa puissance (généralement indiquée en mA ou A) peut être grossièrement sélectionnée à partir du calcul de 1 contrôleur - 500 mA.  Je recommanderais d'utiliser une alimentation redondante (avec batterie intégrée, RIP) uniquement si la télécommande S2000M est utilisée.  Et assurez-vous de connecter la source d'alimentation à la même alimentation sans coupure (UPS) que le serveur du système de surveillance. <br><br>  Bien sûr, vous pouvez monter tout cela sur le mur, mais laissez-le aux installateurs d'alarme incendie et de sécurité, et nous utiliserons un rail DIN 3U pour une installation dans une armoire 19 "(par exemple, le PSM-3U ou Cabeus CMO avec le même article, vous devrez jeter le panneau avant Dans le cas de l'utilisation de la télécommande S2000-M, vous pouvez utiliser une prise 19 "4U (de préférence perforée), qui servira de panneau de montage et sur laquelle un rail DIN pour les bornes et le contrôleur est déjà fixé.  Moins de la décision - l'équipement représente le plan de montage 19 ". <br><br>  Assembler et monter un système de composants ne devrait pas poser de questions, mais j'attire l'attention sur les points suivants: <br><br><ul><li>  la plupart des capteurs ont un petit morceau de câble en saillie.  Pour augmenter le câble, vous pouvez utiliser soit une soudure avec thermorétractable, soit un boîtier oscillant à deux paires KS-2 (compact, mais la fabrication est "boiteuse"), ou la connexion RJ11 (RJ45); </li><li>  Avant le montage dans les capteurs, leurs adresses doivent être enregistrées (comme décrit ci-dessous) et marquées; </li><li>  lors de la connexion des capteurs, il est nécessaire d'observer la polarité de «DLS +» et «DPS-» (voir la documentation - quelle couleur a DPS +, généralement coloré) - si vous le mélangez, le capteur ne sera pas détecté dans le système. </li></ul><br>  Pour ceux qui ne veulent pas souder, mais aiment serrer les «puces», vous pouvez utiliser l'option décrite ci-dessous (probablement, c'est encore mieux que RJ11 - afin de ne pas connecter accidentellement la ligne DPS au serveur). <br><br>  Il faudra: <br><br><ul><li>  câble à paire torsadée 2 paires, non blindé; </li><li>  "Sac" de connecteurs RJ11 (6P4C ou 6P6C); </li><li>  Répartiteurs RJ11 avec entrées de type socket (il existe une grande variété d'options à des prix très raisonnables). </li></ul><br>  Sur une paire, nous démarrons le DPS, sur l'autre, par exemple, 12V DC.  Connexion des capteurs via des répartiteurs. <br><br><div class="spoiler">  <b class="spoiler_title">Image explicative</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xf/v-/93/xfv-93ihmj39n_uhdyhhlqidgjg.png"><br></div></div><br><h2>  Support de montage </h2><br>  Pour la partie «pratique», un stand a été assemblé composé de: <br><br><ul><li>  convertisseur de protocole C2000-PP fabriqué par NVP Bolid; </li><li>  contrôleur S2000-KDL produit par NVP "Bolid"; </li><li>  thermohygromètre (capteur combiné de température et d'humidité) C2000-VT fabriqué par NVP Bolid; </li><li>  détecteur de contact magnétique S2000-SMK fabriqué par NVP "Bolid"; </li><li>  capteur de fuite ponctuelle S2000-DZ fabriqué par Rielta; </li><li>  extenseur d'adresse S2000-AP1 isp.  02 production de NVP "Bolid"; </li><li>  détecteur volumétrique Photon-10M fabriqué par "Rielta" (un tel "tas"); </li><li>  Bloc d'alimentation 12V-AT / 12 / 1.5 DIN fabriqué par AccordTec; </li><li>  Adaptateur RS-485 / USB acheté sur <a rel="noreferrer noopener" href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aliexpress</a> (sur la puce CH340G commune, linux le définit comme «adaptateur série USB QinHeng Electronics HL-340»).  Il est devenu intéressant de voir comment le système fonctionnera dans la configuration la moins chère; </li><li>  Client léger TONK 1811 de TONK Group of Companies (acheté sur avito pour 500 roubles) sur un processeur Intel Atom N270 avec carte graphique GMA950 intégrée. </li></ul><br><img src="https://habrastorage.org/webt/6b/kr/ed/6bkred606ln2axp3wlcrztumlly.png"><br><br><div class="spoiler">  <b class="spoiler_title">Affiner le client léger et l'apparence du stand</b> <div class="spoiler_text">  Le client léger était un peu "fini": <br><br><ul><li>  Un module DOM de 2 Go avec Windows XP intégré installé a été remplacé par des disques durs 2,5 ATA 60 Go provenant d'un ancien ordinateur portable (j'ai dû acheter un câble, pour une raison quelconque, le disque dur SATA-HDD n'a pas pris - il comprenait le port SATA dans le BIOS); </li><li>  augmentation de la RAM DDR2 SO-DIMM de 1 Go à 2 Go; </li><li>  Linux Mint 19.1 «Tessa» Xfce Edition installé et bureau à distance configuré à l'aide de TightVNC; </li><li>  Le système de refroidissement a été «affiné» - il a réduit le dissipateur thermique de sorte que le disque dur s'adapte presque «au ras» du boîtier, a retiré le couvercle supérieur et en plus «a ajouté» un ventilateur de 120 mm connecté via une résistance.  Immédiatement tous les «freins» ont disparu, il est devenu tout à fait raisonnable de fonctionner. </li></ul><br><br><img src="https://habrastorage.org/webt/ct/ri/5v/ctri5vgqehkummqppp22cd3k2uw.jpeg"><br></div></div><br><h2>  Configurer l'équipement Bolid </h2><br>  Tous les paramètres sont définis dans l'environnement Windows, donc avant de commencer à travailler, vous devez installer le pilote sur l'adaptateur RS-485 / USB, ainsi que deux «super» programmes du NVP «Bolid», qui sont fournis gratuitement: <strong>Orion-prog</strong> et <strong>Uprog</strong> .  De plus, les appareils sont connectés séparément à l'adaptateur RS-485 / USB aux ports Orion AB RS-485 (une disposition directe est utilisée, et pas comme sur les ports COM). <br><br>  IMPORTANT: avec toutes les étapes suivantes sur le S2000-PP, le cavalier XP1 sur la carte doit être retiré. <br><br>  Étape 1. Insérez l'adaptateur RS-485 / USB dans le connecteur USB et recherchez dans le gestionnaire de périphériques le numéro de port COM attribué à l'adaptateur.  Les pilotes de l'adaptateur doivent être installés sans points d'exclamation dans le «Gestionnaire de périphériques». <br><br>  Étape 2. Au nom de l'administrateur, exécutez Orion-prog, sélectionnez le port COM souhaité et effectuez une recherche et voyez la version du micrologiciel de l'appareil.  Accédez au site Web officiel du fabricant et vérifiez s'il existe un micrologiciel plus récent et, si nécessaire (très probablement, il sera requis), effectuez une mise à jour (au moment de la rédaction: 1,32 pour C2000-PP, 2,22 pour C2000-KDL). <br><br><div class="spoiler">  <b class="spoiler_title">Micrologiciel de l'instrument en images</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/6i/lm/py/6ilmpyshwlwgygxsep6myrt-yzm.gif"><br></div></div><br>  * Firmware 1.32 en fait, j'ai été installé "de travers" - dans Uprog, la configuration n'a pas été lue depuis l'appareil.  Par conséquent, il a «reculé» à 1,31. <br><br>  Étape 3. Réglage de l'adresse des appareils (d'abord avec S2000-PP, par exemple, 2 puis avec S2000-KDL - 3).  Pour ce faire, exécutez Uprog - tous les appareils ont une adresse par défaut de 127, vous devez donc configurer les appareils au début un par un.  Pour une vidéo plus détaillée du fabricant, voir <a rel="noreferrer noopener" href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">YouTube</a> . <br><br>  Étape 4. Après avoir défini l'adresse sur S2000-KDL, il est nécessaire de définir les adresses des capteurs dans la ligne de communication à deux fils (DLS).  Ils ont également l'adresse par défaut 127 (et le cercle avec le capteur dans Uprog n'est pas mis en surbrillance).  Nous lisons la configuration de l'appareil (Ctrl + F3) et connectons séquentiellement les capteurs aux sorties du DLS, en définissant les adresses.  Lorsque vous pointez le capteur dans le menu contextuel «Demande de type AU», vous pouvez spécifier le type de capteur ou «Demande d'ADC AU» - savoir si le capteur fonctionne (par exemple, pour un détecteur à contact magnétique de l'ADC lors de la fermeture: 100 et à l'ouverture: 50).  En fait, j'ai la configuration d'adresse suivante: 1 - interrupteur reed C2000-SMK, 2 - température C2000-VT, 3 - humidité C2000-VT, 4 - fuite C2000-DZ, 5 - isp expander d'adresse C2000-AP1.  02 (avec le détecteur volumétrique Photon-10M connecté). <br><br><div class="spoiler">  <b class="spoiler_title">Adressage des capteurs en images</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/j9/vo/dk/j9vodkzjmmydzvrsk377m3zinok.gif"><br></div></div><br>  Ensuite, accédez à l'onglet «Entrées» et procédez comme suit: <br><br><ul><li>  indiquer les types de capteurs: pour la température - 10, pour mesurer l'humidité - 15, pour tous les autres - 6 (technologique); </li><li>  pour les entrées technologiques, nous définissons «Recovery time, s» - c'est le temps après lequel la boucle reviendra à l'état «Normal» après avoir reçu l'état «Violation».  Il est nécessaire d'indiquer le nombre d'au moins l'intervalle d'interrogation dans Zabbix (j'ai pris 10 secondes); </li><li>  désactiver "Contrôle de l'indication AU" (0), "Surveillance des circuits ouverts et courts-circuits" et "Surveillance de l'état de la batterie de secours" afin de simplifier la configuration. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Configuration des entrées vers S2000-KDL en images</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/90/cn/68/90cn68wqswa16_nt7pqxzy830de.gif"><br></div></div><br>  Après toutes les «manipulations» avec C2000-KDL, nous réalisons le «Record de configuration dans l'instrument». <br><br>  Étape 5. Configurez S2000-PP. <br>  Sur l'onglet «Appareil», les paramètres sont affichés dans l'image (ce sont les plus «en cours d'exécution» et ils vont par défaut pour la plupart des appareils).  Le port COM de l'adaptateur RS-485 / USB et de tout autre appareil connecté au réseau Modbus doit avoir des paramètres similaires.  J'ai sélectionné l'adresse 11 pour le périphérique S2000-PP sur le réseau Modbus (l'adresse dans le système Orion est 2!). <br><br><img src="https://habrastorage.org/webt/ej/6y/31/ej6y31hxzfnze6nzx29rjcnsfwk.png"><br><br>  Ensuite, nous allons dans l'onglet "Périphériques" et commençons à remplir le "Tableau des zones": <br><br><ul><li>  dans la première colonne, j'ai indiqué «3» - il s'agit de l'adresse de l'appareil S2000-KDL dans le système Orion; </li><li>  numéro de boucle d'alarme ("boucle d'alarme") - ce sont les adresses des capteurs (en fait la boucle d'alarme = adresse, nous pouvons sauter plusieurs adresses si nous ne voulons pas leur prendre d'informations); </li><li>  Section Modbus No. - vous pouvez regrouper nos capteurs en groupes.  Afin de simplifier - je n'ai pas fait cela et attribué à tout le monde 1 section; </li><li>  le type de zone est un paramètre très important.  Nous le sélectionnons en fonction du type de capteur. </li></ul><br><img src="https://habrastorage.org/webt/8g/bo/ea/8gboea_ibzpk6nr04myidkbgtru.png"><br><br>  Après avoir réglé S2000-PP, nous effectuons la «Configuration d'enregistrement dans l'appareil». <br><br>  Étape 6. Combinez C2000-PP et C2000-KDL dans un réseau via RS-485 Orion, connectez les capteurs à C2000-KDL (vous pouvez utiliser un tas de deux terminaux) et connectez l'adaptateur RS-485 / USB à la sortie Modbus C2000-PP.  Nous mettons le cavalier XP1 en position fermée (important: après avoir installé le cavalier, vous devez redémarrer l'appareil en réinitialisant la tension d'alimentation).  Tout - le système est «prêt pour la bataille». <br><br>  Nous vérifions «l'opérabilité» dans le programme de console gratuit <a rel="noreferrer noopener" href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Modpoll Modbus Master Simulator</a> (ci-après dénommé «Modpoll»), par exemple, à l'adresse du firmware «S2000-PP» ou en envoyant des informations de S2000-KDL à «40000» - il s'agit du premier capteur: <br><br><img src="https://habrastorage.org/webt/ij/hv/go/ijhvgoynxeyxwua5abdcgvapi3u.png"><br><br>  Le firmware "pour familiarisation" peut être téléchargé <a href="">ici</a> . <br><br><h2>  Configuration de Zabbix </h2><br>  <font color="red">Attention: Zabbix configuré pour la première fois, comme Linux Mint (puisqu'il n'y a pas de Zabbix sur Windows) :)</font> <br><br>  Après avoir installé Zabbix, vous devez installer les packages <i>autoconf</i> , <i>automake</i> , <i>libtool</i> , <i>pkg-config</i> puis le module d'extension - <i>libzbxmodbus</i> .  Il y a un article séparé à son sujet sur <a rel="noreferrer noopener" href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Habré</a> (j'y reviendrai constamment) et il a récemment été mis à jour, juste pour travailler avec Zabbix 4.0.  L'article contient également des informations plus détaillées sur le protocole Modbus.  Le module lui-même et des instructions plus ou moins détaillées sont sur <a rel="noreferrer noopener" href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . <br><br>  Petites différences d'installation par rapport à celle spécifiée sur GitHub: <br><br><pre><code class="plaintext hljs">... ./configure --prefix=/etc/zabbix --enable-zabbix-3.2 ... sudo make install</code> </pre> <br>  En étudiant le fonctionnement du module <i>libzbxmodbus</i> , <i>il</i> est devenu clair qu'il ne serait pas possible d'appliquer le circuit avec la télécommande S2000M, car dans ce cas, les données des thermohygromètres ressemblent à ceci: écrire le numéro de la zone souhaitée pour enregistrer 46179 puis collecter les données du registre 46328 - c.-à-d.  très simple (dans les "grands" systèmes SCADA, cela peut être implémenté, par exemple, dans MasterSCADA). <br><br>  Dans le fichier de configuration <i>etc / zabbix / zabbix_server.conf, nous écrivons les</i> liens d' <i>extension</i> et connectons le matériel au serveur avec Zabbix.  Je n'ai pas eu à installer de pilotes pour l'adaptateur RS-485 / USB, mais je ne comprenais toujours pas comment déterminer le numéro USB à utiliser, il est bon que la connexion à <i>/ dev / ttyUSB0</i> fonctionne (vous pouvez voir que le périphérique a été trouvé dans le système à l'aide de la commande <i>lsusb</i> ). <br><br>  Comme avec Windows, nous vérifions à l'aide de l'utilitaire Modpoll (j'ai exécuté linux i386) que le matériel est connecté et que des informations sont disponibles: <br><br><img src="https://habrastorage.org/webt/wn/8_/zz/wn8_zz98bldyf7hzc5zdkc90v80.png"><br><br>  Étant donné que l'article décrit le processus de configuration en utilisant l'exemple de Zabbix 2.2 - l'interface est un peu différente là-bas, je vais fournir des explications et des photos des paramètres. <br><br><p>  Étape 1. Nous créons un nœud de réseau et un groupe dans lequel nos nœuds seront inclus (par exemple, un nœud - "Surveillance environnementale" et un groupe - "Infrastructure d'ingénierie"): <br>  Paramètres&gt; Hôtes&gt; Créer un hôte&gt; Entrez nos noms&gt; Ajouter <br><br><img src="https://habrastorage.org/webt/vj/cd/fi/vjcdfibmwzvcm7vudrfubf4nuaa.png"><br><br>  Étape 2. Créez les éléments de données.  L'article recommande de créer des modèles, mais comme notre système ne contient pas d'éléments en double, je vais donc ignorer cette étape.  Par exemple, si nous avions plusieurs climatiseurs connectés via Modbus, nous pourrions utiliser la fonctionnalité du système. <br><br>  Paramètres&gt; Nœuds de réseau&gt; Dans la ligne contenant le nom de notre nœud «Surveillance environnementale», cliquez sur «Éléments de données»&gt; dans la fenêtre qui apparaît, cliquez sur «Créer un élément de données». <br><br>  Nous commençons à "marteler" nos capteurs: <br><br><img src="https://habrastorage.org/webt/j_/ei/9n/j_ei9nphfowd7sgjp6r8u3r9xyk.png"><br><br>  Nuances mineures: <br><br></p><ul><li>  l'article utilise la syntaxe de la fonction <em>"modbus_read_registers"</em> , et selon la description de GitHub <em>"modbus_read"</em> - la deuxième option est plus courte et fonctionne; </li><li>  au lieu des macros <em>{$ MODBUS_PORT}</em> et <em>{$ MODBUS_SLAVE},</em> vous pouvez spécifier le port sous la forme <em>/ dev / ttyUSB0</em> et " <em>11</em> ", mais cela ne sera pas pratique si vous devez ultérieurement modifier le port USB ou l'adresse du S2000-PP; </li><li>  la documentation indique que pour demander l'état de la zone (colonne "N ° de zone Modbus") sur S2000-PP, vous devez contacter: "enregistrer l'adresse 40000 + M, où M = (zone n ° -1)" - c'est la progression: "zone n ° <strong>moins</strong> 1 " </li><li>  ne pas effectuer de relevé de temps très fréquent: S2000-PP commence à renvoyer une erreur "exception error 15" - l'appareil n'a pas le temps de préparer les données (cela s'exprime par la lueur constante de l'indicateur sur l'appareil); </li><li>  pour les données de température et d'humidité avec les registres 3000 -... est prise </li><li>  dans la fenêtre «Éléments de données» se trouve également l'onglet «Pré-traitement» souhaité.  Ici, vous pouvez modifier ce qui sera affiché "à la fin".  La température et l'humidité sont obtenues à partir des valeurs de lecture, qui doivent être divisées par 256: «Facteur utilisateur» - 0,0039 (soit 1/256); </li><li>  Pour interrupteurs à lames discrètes, capteurs de fuite, etc.  vous devez également utiliser le "Value Display", cela est dû à la façon dont les informations sont fournies. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Définition de la conversion des données dans les images</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/pj/g1/yr/pjg1yrlg-hfu83bgzuch6rke-xg.png"><br><br><img src="https://habrastorage.org/webt/k4/7o/hu/k47ohudcuf9ycomoxbdebii6kvu.png"><br></div></div><br>  Un peu sur la façon dont les données sont fournies lors des sondages. <br>  Supposons que vous ayez reçu une réponse au format décimal 9148 (D).  Nous le traduirons au format hexadécimal (HEX): obtenez 23BC - selon les instructions de l'appareil S2000-PP, ce sont deux événements avec les codes 23 (HEX) / 35 (D) et BC (HEX) / 188 (D).  Ensuite, allez voir le tableau 5. «Liste des événements (états AL) du système Orion».  On y trouve, 35 "Restauration de l'entrée technologique" et 188 "Restauration de la communication avec l'entrée".  Il n'est pas nécessaire de traduire D-HEX-D, le premier événement est la partie entière de la division de la valeur reçue par 256 et le reste est le deuxième événement ( <strong>9148</strong> = <strong>35</strong> * 256 + <strong>188</strong> ).  Lors des entretiens avec les intrants technologiques, nous ne retiendrons que le premier événement (prioritaire), qui «devrait» prendre les états 35 et 36 («Restaurer les intrants technologiques» et «Violer les intrants technologiques»).  Nous éliminerons la partie fractionnaire (deuxième événement) en utilisant le paramètre d'élément de données «Type d'information: numérique (entier positif)». <br><br>  Étape 3. Remplissez les macros de port et les numéros de périphérique: <br>  Paramètres&gt; Nœuds de réseau&gt; "Surveillance environnementale"&gt; sélectionnez "Macros" <br><br><img src="https://habrastorage.org/webt/h1/r-/qg/h1r-qgd4rrdym-txvbmnhsqwgre.png"><br><br>  Étape 4. Affichage des lectures sur le panneau de commande: <br>  Écran de démarrage&gt; Tous les panneaux, sélectionnez «Créer un panneau»&gt; dans la fenêtre qui apparaît, définissez «Nom du panneau» et l'utilisateur auquel ce panneau sera disponible&gt; Cliquez sur «Créer un nouveau widget»&gt; Tapez «Présentation des données», Intervalle de mise à jour «10 secondes», Groupes nœuds du réseau Infrastructure d'Ingénierie&gt; Ajouter&gt; Ajuster la taille du panneau et cliquez sur "Enregistrer les modifications": <br><br><img src="https://habrastorage.org/webt/wl/ge/la/wlgelajwrwuuta5phssi2b5rx38.gif"><br><br><h2>  Conclusion </h2><br>  Le système qui en résulte, grâce à l'utilisation de protocoles "à longue portée", peut être une excellente solution, à la fois pour surveiller le serveur et une paire de zones de bureaux croisées (en termes de surveillance des conditions de température et d'humidité) ou même un petit centre de données.  Quelqu'un peut dire «fu fu fu, la voiture est toujours dégoûtante, vous devez utiliser XXX (remplacer quelque chose de l'automatisation industrielle)» est également une option, mais à mon avis, ce sera très redondant et aussi plus cher .  Et une petite nuance: comme vous pouvez le voir, le système sur le Bolid est assez simple (bien qu'il y ait une logique un peu étrange), mais «finissez» la décision sur le bal.  contrôleurs - parfois, il est toujours un "smut". <br><br>  PS Cet article est une adaptation de deux articles sur mon blog: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Surveillance peu coûteuse pour la salle des serveurs (partie 1 - introduction)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Surveillance peu coûteuse pour la salle des serveurs (partie 2 - pratique)</a> <br><br>  UPD  Après avoir travaillé pendant 3 jours, l'adaptateur RS485-USB est tombé.  Il est reconnu comme instable, mais adapté à la mise en service.  Il a été remplacé par un convertisseur à port unique MGate MB3170 fabriqué par MOXA (tiré de ce qui était disponible) - tout est devenu stable. <br>  Vous devez comprendre que cet article n'est qu'un exemple de la façon de «se faire des amis» avec Zabbix et Bolid.  Pour une implémentation réelle, vous pouvez ajouter davantage d'états DPS surveillés, ainsi que, par exemple, des températures négatives (elles sont traitées un peu différemment). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438788/">https://habr.com/ru/post/fr438788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438774/index.html">Tout le meilleur à la fois. Les articles les plus vifs du blog LANIT sur Habré - 2018</a></li>
<li><a href="../fr438776/index.html">Trucs et astuces de ma chaîne Telegram @pythonetc, janvier 2019</a></li>
<li><a href="../fr438778/index.html">@Pythonetc janvier 2019</a></li>
<li><a href="../fr438782/index.html">Le FSB a proposé la sortie de cartes SIM russes et l'utilisation de la cryptographie domestique pour la 5G</a></li>
<li><a href="../fr438784/index.html">Problèmes d'utilisation du service Yandex.Metrica</a></li>
<li><a href="../fr438790/index.html">L'échange de crypto-monnaie QuadrigaCX ne donnera pas 137 millions de dollars. Seul le directeur connaissait le mot de passe du magasin et il est décédé</a></li>
<li><a href="../fr438792/index.html">Utilisation d'AccelStor Tous les tableaux Flash dans les projets VDI</a></li>
<li><a href="../fr438794/index.html">Détails des objets JavaScript</a></li>
<li><a href="../fr438796/index.html">Apprendre Docker Partie 1: Les bases</a></li>
<li><a href="../fr438798/index.html">Comment travailler avec des données de cyber-intelligence: nous apprenons à collecter et à identifier les indicateurs de compromis du système</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>