<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßúüèª üçµ üïµüèª Comment infuser du th√© en utilisant MQTT ou une prise intelligente abordable avec contr√¥le de la temp√©rature et du courant ü§õüèª üåü üîÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pourquoi? 
 M√™me dans ce hub, il y a une augmentation de l'int√©r√™t pour l'IoT, √† mon avis subjectif, c'est une tendance mondiale qui va bien au-del√† d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment infuser du th√© en utilisant MQTT ou une prise intelligente abordable avec contr√¥le de la temp√©rature et du courant</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/407541/"><blockquote><h2>  Pourquoi? </h2></blockquote><br>  M√™me dans ce hub, il y a une augmentation de l'int√©r√™t pour l'IoT, √† mon avis subjectif, c'est une tendance mondiale qui va bien au-del√† de la port√©e de ce site.  Il vaut donc la peine d'ins√©rer vos 5 kopecks dans le d√©veloppement de la direction, d'autant plus que l'id√©e tourne depuis longtemps pour une maison intelligente, qui pourrait contr√¥ler la consommation de tout appareil aliment√© par un r√©seau 220V et a permis de programmer la logique de contr√¥le en fonction des param√®tres de consommation, temp√©rature, phase la lune etc.  Il existe des solutions pr√™tes √† l'emploi, mais souvent quelque chose ne leur convient pas, et le pr√™t √† l'emploi n'est pas notre m√©thode si vous pouvez essayer de construire votre propre v√©lo unique. <br><br><img src="https://habrastorage.org/webt/59/ed/ea/59edeab0efb41513240944.jpeg"><br><br>  <b>Param√®tres du futur v√©lo:</b> <br><br>  - Appareil bon march√© √† partir de composants disponibles publiquement. <br>  - Contr√¥le du courant dans le circuit consommateur. <br>  - Gestion des appareils via le protocole MQTT. <br>  - Dispositif de contr√¥le de la temp√©rature. <br>  - Deux capteurs √† distance pour surveiller la temp√©rature du consommateur. <br>  - Indication d'√©tat sur l'√©cran de l'appareil. <br>  - Arr√™t d'urgence du consommateur si la temp√©rature ou le courant d√©passe les valeurs d√©finies. <br><a name="habracut"></a><br>  <b>Cas d'application:</b> <br><br><ul><li>  Suivi de la consommation d'√©lectricit√©. </li><li>  La possibilit√© de d√©connecter √† distance l'appareil en cas d'accident ou tout simplement comme √ßa. </li><li>  Un appareil simple pour surveiller la temp√©rature dans les garde-manger semi-professionnels o√π les situations d'urgence se produisent souvent, car rien ne surveille la temp√©rature dans la pi√®ce. </li><li>  R√©gulation thermostatique (maintien de la temp√©rature, dans mon cas j'ai besoin de pr√©voir le d√©gel et d'allumer √† l'avance le chauffage des eaux pluviales avec un ¬´c√¢ble chauffant¬ª). </li><li>  Le n≈ìud du syst√®me de maison intelligente pour impl√©menter les fonctions ci-dessus. </li><li>  <s>Et bien s√ªr la bouilloire Wifi!</s>  <s>Le reste est pour la quantit√©.</s> </li></ul><br>  <b>Et je voudrais montrer √† quel point il est simple et bon march√© d'impl√©menter le bundle: [Appareil] &lt;-&gt; [Wifi] &lt;-&gt; [MQTT] &lt;-&gt; [Surveillance centralis√©e de l'√©tat et de la gestion de l'appareil final].</b> <br><br><blockquote><h2>  S√©lection des composants </h2></blockquote><br><img src="https://habrastorage.org/webt/59/ed/e8/59ede8b648464293203023.jpeg"><br><br><h4>  Comment mesurer le courant? </h4><br>  Contrairement aux mesures de tension, les capteurs de courant ne sont pas si courants dans l'√©lectronique amateur.  Mais plusieurs types de capteurs de courant sont disponibles - shunts de courant, type de transformateur et capteurs √† effet Hall.  Il est clair que la classification est amateur, mais si vous regardez la boutique en ligne, les noms ressembleront √† ceci. <br><br>  Je ne voulais pas utiliser le shunt √† cause de la n√©cessit√© de trouver une isolation galvanique (c'est pour que le 220V ne se pr√©cipite pas avec tous ses amplis dans notre microcontr√¥leur et toute la fum√©e magique sur laquelle ils sont connus pour fonctionner n'en sort pas).  Les capteurs de transformateur ont √©galement leurs propres caract√©ristiques.  Mais ce dernier type √©tait non seulement tr√®s abordable, mais √©galement pratique √† utiliser.  Je le pensais quand je l'ai command√©. <br><br>  Si vous avez un circuit basse tension, il est plus raisonnable d'utiliser une r√©sistance d'une petite valeur connue au lieu d'un shunt.  Pour plus de d√©tails sur comment et comment mesurer le courant, lisez le bon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">radiolok</a> . <br><br>  Les capteurs ACS712 sont le plus souvent vendus d√©j√† soud√©s sur une petite carte avec le c√¢blage minimum requis.  Je peux vous conseiller de prot√©ger la puce elle-m√™me avec un √©cran m√©tallique contre l'influence des champs magn√©tiques √©trangers avant utilisation.  Le capteur pour eux est tr√®s sensible et en stock est plus adapt√© √† la recherche de c√¢blage cach√© qu'√† la mesure de courant.  Avec une protection impromptue, l'immunit√© au bruit augmente consid√©rablement. <br><br><img src="https://habrastorage.org/webt/59/e7/92/59e7927d42459385719247.jpeg"><br><br>  On colle dans le gros connecteur vert deux fils obtenus en coupant l'un des deux fils du circuit 220V (connexion s√©rie au circuit).  Nous envoyons + 5V au connecteur de l'autre c√¥t√© du capteur, retirons le signal analogique de la broche restante, qui oscille par rapport au milieu (2,5V) en fonction de la force et de la direction du courant.  C'est tellement simple ... sur papier. <br><br><img src="https://habrastorage.org/webt/59/e7/95/59e795072a53a139870657.png"><br><br>  <s>Autour de cet endroit, l'√©crasement des os commence.</s>  Ces capteurs sont disponibles en versions 5.20.30 amp√®res.  Si avec les deux derniers, cela devient plus ou moins clair, la version 5 amp√®res s'est av√©r√©e sp√©ciale, cette caract√©ristique √©tait que le signal (selon la documentation) ne change que de + -1V par rapport au milieu (2,5V).  Qui se soucie de leurs d√©tails <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Par r√©f√©rence, l'auteur fait l'hypoth√®se qu'il s'agit en fait de capteurs de 10 amp√®res qui n'ont pas fonctionn√©.  Si l'on ajoute √† cela le fort bruit du capteur lui-m√™me et sa tendance √† r√©agir aux champs magn√©tiques tout autour, la t√¢che d'en retirer un signal plus ou moins intelligible cesse d'√™tre ennuyeuse.  Mais comme les capteurs √©taient d√©j√† achet√©s, j'ai d√©cid√© d'essayer d'en fabriquer un. <br><br><h4>  Module principal de l'appareil </h4><br>  Ce module est n√©cessaire pour maintenir la communication de pr√©f√©rence via Wifi et tordre le rapport cyclique principal avec des capteurs d'interrogation, v√©rifier les conditions, r√©pondre aux boutons, etc.  Que choisir parmi une option?  Et du coup, on choisit l'ESP8266.  Dans mon cas, c'est ESP-12F.  Oh oui!  Il existe √©galement un ESP-32. <br><br><img src="https://habrastorage.org/webt/59/e7/99/59e79966e0ed6050062855.jpeg"><br><br>  Mieux encore, apportez-le imm√©diatement soud√© √† une carte avec un faisceau et un adaptateur USB √† UART.  Mais vous pouvez √©galement le connecter vous-m√™me car l'achat de ready-made n'est pas conforme aux pr√©ceptes de la construction de v√©los.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mat√©riel sur ce sujet</a> . <br><br>  J'ai perdu du temps √† essayer de flasher un ESP-shku auto-connect√©.  USBtoUART utilis√© sur la puce CH340.  La carte ne voulait obstin√©ment pas clignoter jusqu'√† ce que je passe la logique CH340 en 5V au risque de br√ªler les conclusions ESP.  Mais jusqu'√† pr√©sent sans perte. <br><br><img src="https://habrastorage.org/webt/59/e7/9a/59e79ae603d33354441422.jpeg"><br><br>  De plus, tout se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">connecte √† l'Arduino IDE</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">HWman</a> et n'est pas tr√®s diff√©rent dans la programmation de l'Arduino habituel.  Mais il est tr√®s diff√©rent en termes de capacit√©s et de ressources informatiques: <br><br><ul><li>  Processeur Tensilica 80 MHz 32 bits  Xtensa L106.  Un overclocking non garanti jusqu'√† 160 MHz est possible. </li><li>  Wi-Fi IEEE 802.11 b / g / n.  Pris en charge par WEP et WPA / WPA2. </li><li>  14 ports d'E / S (dont 11 peuvent √™tre utilis√©s), SPI, I¬≤C, I¬≤S, UART, ADC 10 bits. </li><li>  Alimentation 2,2 ... 3,6 V. Consommation jusqu'√† 200 mA en mode √©mission, 60 mA en mode r√©ception, 40 mA en mode veille.  Mode basse consommation tout en maintenant la connexion avec le point d'acc√®s ~ 1 mA, mode veille profonde 0,1 ŒºA. </li></ul><br><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>en.wikipedia.org/wiki/ESP8266</i></a> <br><br>  <b>Pourquoi Arduino IDE?</b>  Je suis conscient qu'il existe au moins deux autres fa√ßons d'impl√©menter la m√™me chose, c'est d'utiliser le firmware avec des scripts sur LUA et le d√©veloppement natif en C en utilisant le SDK du fabricant.  La premi√®re m√©thode m'a sembl√© tr√®s superficielle, je pense que je n'aurais pas pu r√©aliser certaines des nuances en allant de cette fa√ßon.  La deuxi√®me m√©thode est la plus prometteuse, mais elle prend beaucoup de temps √† ma√Ætriser, mais c'est la seule option si elle est cens√©e impl√©menter un appareil plus s√©rieux. <br><br>  En utilisant l'IDE Arduino, la partie la plus importante √©tait la moins g√™nante en termes d'inclusion dans le projet.  Cependant, le d√©bogage normal fait cruellement d√©faut.  Initialement, il y avait des doutes que toutes les fonctions pr√©vues ensemble (1-Wire, i2c, ADC, MQTT, EEPROM, wifi) coexisteront sur l'ESP-12F dans un seul croquis, mais c'est ce qui s'est produit. <br><br><h4>  Stm8s103f3p6 </h4><br>  Il semblerait, pourquoi y a-t-il un autre microcontr√¥leur?  Aujourd'hui encore, un appareil monoc≈ìur n'est plus pris au s√©rieux, je plaisante.  La raison est diff√©rente - le capteur actuel est si ¬´sp√©cial¬ª qu'il est plus facile et moins cher de suspendre tout le traitement de ses lectures sur un microcontr√¥leur s√©par√© et de le laisser le garder.  En fait, nous avons un capteur de courant num√©rique qui se connecte via le bus i2c.  Th√©oriquement, vous pouvez utiliser le microcontr√¥leur le moins cher, mais comme ces cartes sont tr√®s abordables et assez d√©centes en termes de param√®tres, je l'ai appliqu√©.  √Ä l'avenir, je l'ai mesur√© √† nouveau et je vais les utiliser - en remplacement du PIC12 que j'ai utilis√© pour ajouter des ¬´cerveaux¬ª √† des m√©tiers compl√®tement diff√©rents.  Au d√©but, cette id√©e me semblait redondante, mais maintenant je vois que je n'avais m√™me pas besoin de passer du temps sur une autre option. <br><br><img src="https://habrastorage.org/webt/59/e7/9f/59e79ff42e5a1052654373.jpeg"><br><br>  Ces microcontr√¥leurs sont programm√©s dans l'environnement IAR Embedded Workbench, il est gratuit pour du code jusqu'√† 8 Ko, notre microcontr√¥leur a tellement de m√©moire.  Un √©norme avantage est la possibilit√© de d√©bogage humain.  Certes, vous devez vous sevrer pour utiliser les fonctions C-standard habituelles comme printf et travailler avec des nombres √† virgule flottante, car cela effacera rapidement toute la m√©moire.  Je vais vous en dire plus sur le firmware ci-dessous. <br><br><h4>  √âcran </h4><br>  Il n'y a presque aucune option ici - nous utilisons OLED SSD1306, un bel √©cran avec une tr√®s belle lueur et une connexion simple.  Les biblioth√®ques pour lui sont m√™me sous le spectre.  Il existe des √©crans de diff√©rentes couleurs.  Il existe √©galement des cartes sur lesquelles ESP et un √©cran similaire sont imm√©diatement soud√©s.  La couleur bleue semble la plus avantageuse.  Il y a deux tons lorsque la partie sup√©rieure est d'une couleur diff√©rente. <br><br>  L'√©cran est connect√© via le bus i2c, ce ne sont que 4 fils en tenant compte de l'alimentation.  Le capteur de courant sera √©galement connect√© via le m√™me bus.  L'√©cran n'a pos√© aucun probl√®me.  Certainement un must have! <br><br><img src="https://habrastorage.org/webt/59/ed/00/59ed00ca082ba631487484.png"><br><br>  Il convient de noter que l'√©cran est susceptible de briller 24h / 24 et 7j / 7, et la technologie d'√©cran est telle que les pixels LED individuels s'estompent avec le temps, vous devez donc essayer de les utiliser de mani√®re uniforme.  Je suis venu avec juste pour d√©placer l'image dans des directions diff√©rentes √† intervalles r√©guliers.  En g√©n√©ral, je pense que si du coup l'image devient compl√®tement illisible, le remplacement de l'√©cran n'est pas un probl√®me.  Voyons combien de temps il vit. <br><br>  Une vid√©o d√©taill√©e sur un tel √©cran et la cha√Æne youtube. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/-IFwwWj11Kw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h4>  Capteurs de temp√©rature </h4><br>  J'ai utilis√© le c√©l√®bre DS18B20.  En mode d'alimentation parasite, trois capteurs fonctionnent silencieusement sur une paire de fils torsad√©s √† une distance d√©passant ce qui est raisonnable pour un tel projet (assez avec une marge n'importe o√π dans l'appartement). <br><br><img src="https://habrastorage.org/webt/59/ec/a8/59eca82c15777409271533.jpeg"><br><br>  La seule diff√©rence avec la figure est l'utilisation d'une r√©sistance 1K, sinon la puissance est insuffisante.  Lorsque cela se produit, le capteur donne une temp√©rature √©gale √† 85 degr√©s.  La demande de conversion et de lecture ult√©rieure de la valeur se fait s√©quentiellement pour chaque capteur afin qu'ils n'interf√®rent pas entre eux. <br><br>  J'ai compt√© √† l'avance les adresses des capteurs et les ai cod√©es en dur dans un croquis.  Il y a eu une tentative de faire l'auto-d√©tection de capteurs sur le bus, mais je n'ai pas aim√© la stabilit√© de cet algorithme, et comme la temp√©rature est un param√®tre important, le jeu n'en vaut pas la chandelle. <br><br><h4>  √âl√©ments structurels et "frisottis" </h4><br>  Tout ce fer √† repasser a √©t√© plac√© dans une petite bo√Æte √† √©charpe qui peut √™tre r√©cup√©r√©e sur n'importe quel march√© radio au go√ªt.  Habituellement, un relais de contact pour 220V √©tait utilis√©.  Plusieurs kilom√®tres de fil de l'ancienne boucle FDD, un demi-kilo de r√©sistances par 10K, quelques boutons, une paire de sortie sous les "tulipes" pour connecter la ligne 1-Wire et ADC ESP-shki.  Beaucoup de colle chaude.  Une unit√© d'alimentation de haute qualit√© √† 5 volts, enti√®rement plac√©e dans l'appareil.  Et h√©las, il n'y a presque pas de ruban √©lectrique bleu. <br><br>  Si vous assemblez un prototype, essayez de ne rien placer du tout sur l'un des couvercles, il sera alors pratique de le retirer et de le cueillir dans l'appareil.  Pensez √† l'endroit o√π les c√¢bles de connexion externes entreront et quels connecteurs ils ont pour qu'il ne s'av√®re pas que la prise doit √™tre coinc√©e √† des angles sauvages, etc. <br><br><h4>  Co√ªts des composants: </h4><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Capteur de courant</a> - 2,1 $ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ESP-12F</a> - 3,2 $ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Carte Stm8</a> - 0,75 $ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Convertisseur logique</a> - 0,5 $ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Capteur de temp√©rature</a> - 0,6 $ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√âcran</a> - 4,2 $ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Relais</a> - 0,75 $ </li><li>  Bo√Æte et autres mussiness ~ xs, que ce soit 3 $ </li></ol><br>  <b>Total: 15 $</b> <br><br><blockquote><h2>  Arm√© du bon dossier ... </h2></blockquote><br><img src="https://habrastorage.org/webt/59/e8/9a/59e89a3739490406680171.jpeg"><br><br><h4>  Capteur de courant </h4><br>  Comme je l'ai √©crit ci-dessus, le capteur actuel √©tait tr√®s morose.  De plus, la mesure de la valeur efficace du courant alternatif est un peu plus compliqu√©e que la mesure de la valeur du courant continu.  Je pense qu'il vaut mieux s'expliquer par une personne qui conna√Æt bien le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">radiolok</a> : <br><br><div class="spoiler">  <b class="spoiler_title">Vid√©o</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/TOaW9xvr8NE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  Et aussi: <br><br><ul><li>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Article</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">grekeh</a> </li><li>  2. Message de l'utilisateur <b>rezident</b> sur ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">forum:</a> </li></ul>  <i>¬´Au lieu de I (courant), substitut dans la formule U (tension).</i>  <i>L'int√©grale est la zone de la figure sous l'enveloppe.</i>  <i>Vous pouvez calculer l'int√©grale approximative en utilisant la m√©thode des rectangles du milieu, approximant le chiffre avec des rectangles d'une hauteur √©gale √† un √©chantillon discret de la tension et d'une largeur √©gale √† l'intervalle de temps entre les √©chantillons. ¬ª</i> <br><br><img src="https://habrastorage.org/webt/59/e8/64/59e864a11540f816221584.jpeg"><br><br>  Ainsi, il s'av√®re que nous devons mesurer l'aire "sous le graphique" du courant alternatif pendant une p√©riode.  La fr√©quence de notre tension √©tant de <b>50 Hz,</b> nous obtenons une p√©riode de <b>20 ms</b> .  Quand commencer √† mesurer n'a pas d'importance, l'essentiel est de le faire pour un multiple de 20 <b>ms</b> .  Presque tout se r√©sume √† additionner le module des lectures ADC sur une p√©riode avec le calcul ult√©rieur de la moyenne.  Ce sera notre courant.  Pour la p√©riode entre deux mesures, le temps de r√©ponse de l'ADC est pris, il est assez stable. <br><br>  En prime, cette m√©thode vous permet de mesurer le courant alternatif et continu.  En dehors des crochets, nous laissons la probabilit√© de fr√©quence de marche et de tension √† la sortie. <br><br>  Vous pouvez essayer de faire des mesures sur l'ADC ESP8266, et j'ai essay√©, mais la pr√©cision s'est av√©r√©e tr√®s m√©diocre, et l'ESP a √©galement d√ª faire face au traitement du signal de l'ADC la plupart du temps.  De plus, l'ADC int√©gr√© a une plage de tension d'environ 1 volt.  Il est n√©cessaire d'utiliser un diviseur de tension.  L'ESP est aliment√© √† 3,3 V et le capteur de courant √† 5 V, ce qui signifie que les donn√©es de l'ADC peuvent √™tre d√©form√©es si l'alimentation ne change pas sa valeur proportionnellement.  Tout cela n'ajoute pas de pr√©cision aux mesures.  Le plan initial √©tait le suivant - si vous ne pouvez pas utiliser l'ADC ESP correctement, alors nous utiliserons un microcontr√¥leur s√©par√©, et c'est arriv√©. <br><br>  En utilisant Stm8s103f3p6, la situation est grandement am√©lior√©e.  Premi√®rement, le capteur et le microcontr√¥leur sont aliment√©s par 5 V, ce qui emp√™che les r√©sultats de mesure de ¬´flotter¬ª pendant les surtensions.  Deuxi√®mement, le microcontr√¥leur peut consacrer toutes ses ressources informatiques au traitement, au filtrage et au raffinement des signaux.  En fait, bien s√ªr, tout n'est pas simple, vous pouvez y accrocher autre chose. <br><br>  Il a √©t√© d√©termin√© exp√©rimentalement qu'en 20 ms, stm8 parvient √† obtenir environ 600 valeurs de l'ADC sans compromettre la pr√©cision.  Si n√©cessaire, vous pouvez synchroniser l'ADC plus rapidement, mais le graphique devient plus √©videmment de fausses valeurs.  J'ai surveill√© les mesures en utilisant un logiciel de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">traitement</a> , c'est un produit pour visualiser quelque chose, dans mon cas, c'√©tait un tas de valeurs prises par l'ADC.  Des lectures assez stables ont √©t√© obtenues apr√®s une mesure de 100 ms, soit environ 3000 mesures.  Ensuite, nous le multiplions par un coefficient s√©lectionn√© empiriquement (je n'ai aucune id√©e de ce qu'est ce nombre et comment le calculer car d'autres nombres ont √©t√© obtenus par toutes les formules appropri√©es, je l'ai juste ajust√© et tout) Ensuite, la valeur est ex√©cut√©e √† travers le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">filtre</a> .  Tout ce qui reste √† faire est de mettre la valeur suivante √† l'endroit o√π ESP la r√©cup√©rera. <br><br>  En cons√©quence, nous avons obtenu une telle stabilit√© si vous allumez l'ampoule 100W. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/DZJQnvXJUmo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Pendant le d√©bogage, il s'est av√©r√© que le capteur peut se bloquer lorsque le relais est d√©clench√©, apparemment √† partir de forts champs magn√©tiques au moment o√π le relais s'ouvre, avec la formation d'un arc.  J'ai d√ª ajouter une cha√Æne de "jonglage" avec le capteur de nutrition.  Bien qu'au d√©but, je pensais que le gel stm8 ou un bloc de celui-ci parce qu'il n'y avait rien √† accrocher dans le capteur, mais il pouvait. <br><br>  En raison du bruit du capteur, il est pratiquement impossible de mesurer un courant jusqu'√† 100mA.  Quelque part sur les forums, j'ai vu une mention que c'est normal.  J'ai essay√© d'organiser la d√©tection du bruit et l'√©mission, dans ce cas, de lectures de courant nul afin que le courant ne saute pas m√™me avec un circuit ouvert. <br><br>  <i>L'algorithme de ce d√©tecteur est que le bruit a une distribution √©gale des valeurs au-dessus et au-dessous de "z√©ro", tandis que le signal r√©el dans une section particuli√®re de la p√©riode a toujours une valeur moyenne autre que z√©ro, √† moins bien s√ªr que nous ayons commenc√© √† mesurer au moment de la transition z√©ro par une sinuso√Øde.</i>  <i>Par cons√©quent, j'√©coute le signal √† trois intervalles al√©atoires de la m√™me p√©riode, qui sont situ√©s les uns par rapport aux autres de mani√®re √† ce qu'au moins l'un soit garanti de ne pas tomber au moment o√π la sinuso√Øde franchit z√©ro et donne une valeur totale autre que z√©ro.</i>  <i>Il existe peut-√™tre un moyen plus simple, mais la construction de v√©los, vous savez, ne tol√®re pas une longue √©tude de la question.</i> <br><br>  Il se trouve que Stm8 se bloque, mais uniquement lors de l'√©change sur le bus i2c avec ESP, peut-√™tre √† cause de ma connaissance peu approfondie de la programmation de ce microcontr√¥leur, mais peut-√™tre parce qu'il le peut.  L'utilisation d'un chien d'observation a aid√© √† r√©soudre ce probl√®me. <br><br>  Il est plus facile d'obtenir une tension alternative s√ªre pour le d√©bogage en d√©montant une alimentation du transformateur (abaissant naturellement, de pr√©f√©rence un volt √† 12) et en d√©connectant le pont de diodes et le condensateur de lissage du transformateur, g√©n√©ralement il n'y a rien de plus. <br><br>  Il se trouve que je n'avais pas d'appareil capable de mesurer la valeur efficace du courant alternatif.  Dans ce cas, vous pouvez obtenir en mesurant la tension effective sur la r√©sistance d'une valeur connue, et le courant peut d√©j√† √™tre calcul√© en divisant la tension par la valeur de la r√©sistance.  La valeur efficace de la tension alternative peut afficher n'importe quel multim√®tre.  Et la deuxi√®me fa√ßon consiste √† mesurer la chute de tension aux bornes de la m√™me r√©sistance, mais en la connectant apr√®s le pont de diodes et le condensateur de lissage.  Naturellement, dans ce cas, la valeur actuelle sera l√©g√®rement inf√©rieure car le convertisseur AC-DC a sa propre efficacit√©. <br><br>  Naturellement, je veux dire que les op√©rations ci-dessus sont effectu√©es avec une tension alternative r√©duite, et non en r√©seau. <br><br><img src="https://habrastorage.org/webt/59/ef/30/59ef3019b0a63862486681.jpeg"><br><br>  Dans le cadre de cet article, je n'analyserai pas le processus de programmation de stm8.  Mais ce n'est pas difficile, il existe des biblioth√®ques standard pour les p√©riph√©riques et Google r√©sout la part du lion des probl√®mes.  Ceux qui ne veulent pas entrer dans les d√©tails sont invit√©s √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">remplir le</a> firmware ( <a href="">CurrentMeter (IAR) \ STM8S103 \ Exe \ Project.hex</a> ) dans le microcontr√¥leur et √† l'oublier.  Si vous voulez aller plus loin, commencez l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> et la vid√©o: <br><br><div class="spoiler">  <b class="spoiler_title">Vid√©o</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/LvcW-vhc6rU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  Il y a des tentatives pour adapter Arduino √† ce microcontr√¥leur, mais pour le moment je ne l'ai pas trouv√© plus ou moins pr√™t pour une utilisation r√©elle. <br><br>  Nous avons donc un capteur de courant avec interface i2c.  √âtant donn√© que l'ESP a une logique 3,3 V et une tension stm8 5 V, un convertisseur de niveau logique est n√©cessaire, et dans les deux sens, il n'y a aucun moyen d'obtenir un diviseur de tension ici.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toutes sortes d'astuces avec l'installation de r√©sistances en s√©rie vous permettent en quelque sorte d'√©tablir une connexion, mais la stabilit√© de cette solution n'est pas satisfaisante. </font><font style="vertical-align: inherit;">Il est beaucoup plus facile d'utiliser un convertisseur bidirectionnel pr√™t √† l'emploi, qui co√ªte un sou. </font></font><br><img src="https://habrastorage.org/webt/59/e8/8d/59e88d999bd82323948398.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Son travail est bas√© sur l'utilisation de transistors √† effet de champ, plus d'informations sur la conversion de niveau peuvent √™tre trouv√©es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici. </font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware et source pour stm8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Assemblage et disposition de l'appareil </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le prototype de l'appareil, il a √©t√© d√©cid√© de collecter l'installation mont√©e. Il est possible que certains points doivent √™tre refaits pendant le fonctionnement, et je n'ai toujours pas ma√Ætris√© la disposition normale et simple des cartes de circuits imprim√©s. Apr√®s que l'appareil ait fonctionn√© pendant plusieurs mois sans modifications, il est probablement judicieux de d√©velopper et de commander des cartes de circuits imprim√©s en Chine. En attendant, nous avons un tel monstre de p√¢tes: un </font></font><br><br><img src="https://habrastorage.org/webt/59/eb/2f/59eb2f9f33582057597084.jpeg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">circuit intuitif et intuitif pour commuter les √©l√©ments de l'appareil.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le principe g√©n√©ral d'assemblage du prototype est simple - nous marquons grossi√®rement dans une bo√Æte en plastique que l√† o√π il sera situ√©, nous y fixons les √©l√©ments principaux puis tout est reli√© par un fil d'assemblage. Il convient de consid√©rer l'emplacement des √©l√©ments afin de ne pas cr√©er de d√©sagr√©ments inutiles.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En utilisant le scan irrempla√ßable chinois, les trous n√©cessaires (et pas seulement) sont faits, la fen√™tre de l'√©cran est ajust√©e avec un fichier. </font></font><br><img src="https://habrastorage.org/webt/59/ec/af/59ecaf20055ba125249194.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour alimenter l'√©lectronique, une unit√© d'alimentation 5V de haute qualit√© est utilis√©e qui est connect√©e en parall√®le √† un r√©seau 220V directement √† l'int√©rieur du bo√Ætier de l'appareil. </font></font><br><br> <b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est tr√®s important de comprendre que le 220V est d√©j√† une tension dangereuse, assurez-vous d'isoler toutes les connexions et, si possible, de localiser ces connexions dans une partie de l'appareil et la partie basse tension dans une autre. Lors des premiers tests de connexion, vous pouvez basculer sur une machine classique, personne n'est √† l'abri des erreurs.</font></font></u></b> <br><br><img src="https://habrastorage.org/webt/59/f0/c1/59f0c1e57785d168849742.jpeg"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √Ä propos des erreurs et de leur probabilit√©.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rien d'inhabituel, juste l√©g√®rement pris le contr√¥le des bombes thermonucl√©aires de toucher le sol en cas de crash accidentel avec l'avion apr√®s un ravitaillement infructueux au-dessus de l'Espagne en l'an 66. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Photo tir√©e de cet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MagisterLudi</font></font></a></i> <br><br> <s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ne vous consid√©rez pas comme le plus intelligent et le plus prudent. Eh bien, ou du moins touchez les fils √† haute tension √† l'ext√©rieur de la paume de votre main, mais il vaut mieux ne pas le faire.</font></font></s> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La photo montre que le capteur de courant est coll√© √† l'alimentation, je n'ai pas remarqu√© d'interf√©rence, mais j'ai remarqu√© que l'interf√©rence p√©n√©trait par le haut, j'ai d√ª d√©monter le capteur et le prot√©ger avec une feuille m√©tallique. Vous pouvez v√©rifier l'efficacit√© du blindage √† l'aide d'un aimant en n√©odyme.</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est important de ne pas oublier qu'une tension de 220 V est appliqu√©e sur un c√¥t√© de la puce du capteur, vous devez donc la prot√©ger avec une isolation </font></font></u> <s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exclusivement avec un ruban √©lectrique bleu</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si quelqu'un ne comprend pas le sch√©ma de circuit visuel des blocs de commutation donn√© ci-dessus, il y a un sch√©ma de circuit tordu. La premi√®re exp√©rience d'utilisation de fritzing semble √™tre grumeleuse. </font></font><br><br><img src="https://habrastorage.org/webt/59/eb/81/59eb81f2e4d58730142159.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La seule chose qui ne se refl√®te pas dans le diagramme est la conclusion des contacts n√©cessaires, pour le firmware, entre ESP et STM8 vers un connecteur s√©par√© sur le c√¥t√© de l'appareil. Ainsi, vous pouvez terminer l'assemblage pour commencer √† flasher le p√©riph√©rique fini, et non un croisement entre les n≈ìuds et les fils dispers√©s sur la table.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avant d'appliquer plusieurs fois l'alimentation, faites sonner le circuit d'alimentation pour un court-circuit ou la polarit√© correcte. </font><font style="vertical-align: inherit;">Cela semble √™tre des choses simples, mais un petit tas de ch√¢les morts dans le tiroir de mon bureau demande avec √©loquence de ne pas n√©gliger ces r√®gles simples.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Communication avec le monde ext√©rieur. </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous allons commencer √† terminer lentement le logiciel. Pour organiser la gestion et l'interaction avec notre point de vente, nous utiliserons le protocole MQTT. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comment √ßa marche? Tout est organis√© comme suit - dans le r√©seau local (ou peut-√™tre pas sur le r√©seau local) il y a un certain h√¥te sur lequel un programme sp√©cial ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">courtier MQTT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) est </font><font style="vertical-align: inherit;">lanc√© </font><font style="vertical-align: inherit;">qui re√ßoit diverses donn√©es de divers appareils et organise leur stockage d'une mani√®re similaire au syst√®me de fichiers et de r√©pertoires sur votre disque. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par exemple: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´SmartPowerSocket1 / Current¬ª</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - voici √† quoi ressemble le vrai </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sujet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MQTT </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le dossier de cet appareil est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´SmartPowerSocket1¬ª</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , les sous-dossiers sont des param√®tres internes de l'appareil, par exemple, la valeur actuelle est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Actuelle¬ª</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le chemin d'acc√®s complet au param√®tre (rubrique) est utilis√© pour que les appareils s'abonnent aux modifications de ces param√®tres. </font><font style="vertical-align: inherit;">L√†, les param√®tres sont enregistr√©s par l'appareil lui-m√™me. </font><font style="vertical-align: inherit;">Vous pouvez vous abonner √† l'int√©gralit√© du ¬´dossier¬ª (rubrique) et recevoir toutes les modifications de param√®tres pour un p√©riph√©rique sp√©cifique (rubrique ou sous-rubrique) - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SmartPowerSocket1 / #</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><img src="https://habrastorage.org/webt/59/ee/14/59ee1487b1d35208233896.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une vid√©o plus d√©taill√©e sur ce sujet.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vid√©o</font></font></b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/4O-2dJwRQtg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et encore une fois, je recommande cette cha√Æne, vous y trouverez beaucoup d'informations utiles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le courtier MQTT le plus c√©l√®bre est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mosquitto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Et depuis que j'ai d√©cid√© de d√©ployer imm√©diatement le syst√®me de gestion de la maison intelligente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MajorDoMo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui √©tait d√©j√† pr√©sent√© dans la vid√©o ci-dessus, tout cela a √©t√© soulev√© en vrac en d√©ployant l'image finale pour </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orange Pi PC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tout y est d√©j√† install√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilisation du protocole MQTT permettra d'utiliser diff√©rents syst√®mes de contr√¥le de la maison intelligente et non seulement ce protocole gagne en popularit√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous ne pouvez le faire qu'avec le courtier MQTT en l'installant sur votre PC, et de nombreux </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">clients MQTT</font></a><font style="vertical-align: inherit;"> interagissent avec lui, par exemple, depuis le t√©l√©phone, pour Android</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Et pas seulement pour Android. Ils sont configur√©s tout simplement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä l'aide de MajorDoMo, vous pouvez organiser un bel affichage d'informations, dessiner des graphiques et la gestion via n'importe quel navigateur. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez essayer de deviner quel type d'appareil en tant qu'exp√©rimental est affich√© dans les graphiques ci-dessous. </font></font><br><br><img src="https://habrastorage.org/webt/59/ee/fc/59eefc5862611092456787.png"><br><img src="https://habrastorage.org/webt/59/ee/fc/59eefc8497210678422831.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceci est un r√©frig√©rateur, un capteur de temp√©rature dans le cong√©lateur. Je suis un peu surpris que si vous r√©glez le bouton de commande du r√©frig√©rateur sur "2", les lectures sur les captures d'√©cran ci-dessus soient obtenues. S'il est r√©gl√© sur "3", le r√©frig√©rateur a martel√© pendant 40 minutes au lieu de 7 et maintient la temp√©rature entre -16 / -18 degr√©s. R√©glage pas tr√®s fluide comme pour moi. L'information n'a pas de valeur excessive, c'√©tait int√©ressant √† voir.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il est √©galement int√©ressant que les moments du courant √©lev√© de d√©part soient affich√©s et que la discr√©tion du capteur de temp√©rature (√©tape) soit visible, car le filtre moyen est utilis√© pour le courant, je ne m'attendais pas du tout √† voir de telles surtensions sur le graphique. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Esquisse pour ESP-12F </font></font></h4><br>  Pour forcer ESP √† √©changer des donn√©es via MQTT, il vous suffit d'utiliser la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que</a> appropri√©e sous Arduino.  Il convient de noter qu'il existe √©galement des biblioth√®ques similaires. <br><br><div class="spoiler">  <b class="spoiler_title">Un exemple de travail avec cette biblioth√®que sur ESP8266</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WiFi.h&gt; #include &lt;PubSubClient.h&gt; // Update these with values suitable for your network. const char* ssid = "........"; const char* password = "........"; const char* mqtt_server = "broker.mqtt-dashboard.com"; WiFiClient espClient; PubSubClient client(espClient); long lastMsg = 0; char msg[50]; int value = 0; void setup_wifi() { delay(10); // We start by connecting to a WiFi network Serial.println(); Serial.print("Connecting to "); Serial.println(ssid); WiFi.begin(ssid, password); while (WiFi.status() != WL_CONNECTED) { delay(500); Serial.print("."); } randomSeed(micros()); Serial.println(""); Serial.println("WiFi connected"); Serial.println("IP address: "); Serial.println(WiFi.localIP()); } void callback(char* topic, byte* payload, unsigned int length) { Serial.print("Message arrived ["); Serial.print(topic); Serial.print("] "); for (int i = 0; i &lt; length; i++) { Serial.print((char)payload[i]); } Serial.println(); // Switch on the LED if an 1 was received as first character if ((char)payload[0] == '1') { digitalWrite(BUILTIN_LED, LOW); // Turn the LED on (Note that LOW is the voltage level // but actually the LED is on; this is because // it is acive low on the ESP-01) } else { digitalWrite(BUILTIN_LED, HIGH); // Turn the LED off by making the voltage HIGH } } void reconnect() { // Loop until we're reconnected while (!client.connected()) { Serial.print("Attempting MQTT connection..."); // Create a random client ID String clientId = "ESP8266Client-"; clientId += String(random(0xffff), HEX); // Attempt to connect if (client.connect(clientId.c_str())) { Serial.println("connected"); // Once connected, publish an announcement... client.publish("outTopic", "hello world"); // ... and resubscribe client.subscribe("inTopic"); } else { Serial.print("failed, rc="); Serial.print(client.state()); Serial.println(" try again in 5 seconds"); // Wait 5 seconds before retrying delay(5000); } } } void setup() { pinMode(BUILTIN_LED, OUTPUT); // Initialize the BUILTIN_LED pin as an output Serial.begin(115200); setup_wifi(); client.setServer(mqtt_server, 1883); client.setCallback(callback); } void loop() { if (!client.connected()) { reconnect(); } client.loop(); long now = millis(); if (now - lastMsg &gt; 2000) { lastMsg = now; ++value; snprintf (msg, 75, "hello world #%ld", value); Serial.print("Publish message: "); Serial.println(msg); client.publish("outTopic", msg); } }</span></span></span></span></code> </pre> <br></div></div><br>  En bref, lorsque vous devez transf√©rer des donn√©es, elles sont transmises par la fonction de publication ("SmartPowerSocket1 / Current", "2").  Nous transmettons la valeur actuelle √©gale √† 2 perroquets. <br><br>  Pour recevoir des donn√©es d'un courtier, il vous suffit de vous abonner au sujet qui nous int√©resse et de v√©rifier la fonction √† partir de laquelle les donn√©es sont entr√©es en les triant dans les variables correspondantes.  C‚Äôest tout. <br><br>  Le croquis final s'est av√©r√© assez volumineux, mais il utilise des approches absolument standard pour organiser les √©changes sur i2c, 1 fil et travailler avec d'autres entit√©s.  Je pense que la personne qui a d√©j√† trait√© Arduino n'aura pas beaucoup de difficult√© √† comprendre et √† modifier la logique de contr√¥le pour r√©pondre √† leurs besoins, le cas √©ch√©ant. <br><br>  <b>EEPROM</b> .  L'esquisse a organis√© le stockage des param√®tres dans l'EEPROM, et en plus de cela, lorsque le serveur MQTT est disponible, ils sont retir√©s de l√† lorsque l'appareil d√©marre. <br><br>  <b>ArduinoOTA</b> .  M√™me dans l'esquisse, une chose comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ArduinoOTA</a> (OTA - ¬´over the air¬ª, qui peut √™tre traduit par ¬´over the air¬ª) saute, c'est-√†-dire que le firmware peut √™tre t√©l√©charg√© via Wifi. <br><br>  Le lien ci-dessus a une recette pour savoir comment l'utiliser.  J'ajouterai que le chargement de cette mani√®re est plusieurs fois plus rapide, mais cela n√©cessite un traitement sp√©cial pour √™tre int√©gr√© dans l'esquisse.  La boucle principale ne doit pas √™tre surcharg√©e, sinon il n'y aura pas de connexion entre l'ESP et l'ArduinoIDE.  C'est pourquoi il y a tellement de d√©lais d'expiration diff√©rents dans l'esquisse et le temps d'un cycle du cycle principal est mesur√©.  Le plus souvent, ESP v√©rifie "mais veulent-ils me flasher?"  le plus stable tout fonctionne.  Autre fonctionnalit√© que je n'ai pas encore surmont√©e, ArduinoOTA refuse de flasher sur certains r√©seaux wifi, bien que tout y r√©ponde.  Les chances de r√©ussite sont sup√©rieures si ArduinoIDE et ESP sont connect√©s par un point d'acc√®s d√©di√© (IoT uniquement). <br><br>  <b>Boutons.</b>  Au d√©but, je voulais cr√©er plus de deux boutons, mais il s'est av√©r√© que le GPIO de l'ESP-12F touchait √† sa fin.  Jugeant solidement que personne n'appuierait jamais sur ces boutons de toute fa√ßon (s'il y a un contr√¥le via le webmord de la maison intelligente), il a √©t√© d√©cid√© de le limiter √† deux.  Liez-les pour r√©guler le r√©glage actuel, et si vous appuyez sur les deux √† la fois, le relais s'arr√™te.  Apr√®s cela, vous ne pouvez l'allumer que si vous red√©marrez l'appareil lui-m√™me via l'alimentation ou via un webmord.  Ainsi, j'ai essay√© d'ajouter un peu de protection contre les commutations imprudentes si le courant d√©passait la limite autoris√©e, car cela pourrait signifier une urgence. <br><br>  [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Je posterai le croquis au fur et √† mesure de ma mise √† jour.</a>  ] <br><br><blockquote><h2>  "Je l'ai fait!" </h2></blockquote><br><img src="https://habrastorage.org/webt/59/e8/a7/59e8a7e09eee8669285885.jpeg"><br><br>  La myst√©rieuse bo√Æte noire a commenc√© √† cliquer sur le relais et √† √©mettre, non moins myst√©rieux, des grincements √† haute fr√©quence silencieux de diff√©rentes tonalit√©s dans diff√©rents modes de fonctionnement - une fonctionnalit√© / bug qui est apparu √† la suite de l'alimentation, apparemment il y a un √©tranglement de la musique. <br><br>  <i>C'est dr√¥le que ce soit lui qui m'a indirectement aid√© √† saisir les moments du blocage des n≈ìuds individuels.</i>  <i>Vous pouvez le regarder avec vos yeux, mais c'est fatigant, entendre en arri√®re-plan, il est tr√®s facile de saisir l'instant o√π le rythme du son change.</i>  <i>Par cons√©quent, je n'ai pas commenc√© √† calmer cet acc√©l√©rateur et j'ai m√™me pens√© √† ajouter une telle fonction √† d'autres appareils de d√©bogage.</i> <br><br>  Pendant un certain temps, j'ai r√©fl√©chi √† la fa√ßon de d√©montrer l'appareil s'il est lui-m√™me une bo√Æte noire ennuyeuse et ne bouge m√™me pas.  Essayons de faire du th√© en utilisant une chaudi√®re et l'un des capteurs de temp√©rature, pour une nous calculons la quantit√© d'√©nergie qu'il faudra. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/dmL-wbCozQI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Apr√®s avoir appuy√© sur le bouton qui d√©verrouille le relais plusieurs fois, rien ne s'est pass√©, il s'est av√©r√© plus tard que le r√©glage actuel √©tait tr√®s bas et a fonctionn√© les premi√®res fois. <br>  Lorsque la chaudi√®re s'est un peu r√©chauff√©e, le courant a un peu baiss√© et le relais s'est d√©verrouill√©. <br><br>  Quand je me suis mis √† l'aise, je me suis pr√©par√© √† attendre longtemps pour faire bouillir l'eau, mais la chaudi√®re chinoise √† shaitan a fait bouillir l'eau si rapidement que j'ai √† peine r√©ussi √† l'√©teindre en mode de contr√¥le manuel.  Et le capteur de temp√©rature s'est av√©r√© pas si agile, et bien que j'aie r√©gl√© le r√©glage √† 95 degr√©s, j'ai peur qu'au moment o√π il se d√©clenche, tout soit dans l'eau bouillante, j'ai peur de ne pas vouloir autant de th√©. <br><br>  Au d√©but, j'√©tais confus par l'inscription sur la chaudi√®re de 500W, mais le courant montre que c'est vrai.  Au final, j'avais d√©j√† peur que la partie plastique de la chaudi√®re ne fonde et ne se g√¢te <br>  "Exp√©rience", mais rien ne s'est pass√©. <br><br>  <i>Bien s√ªr, il serait possible de tourner une vid√©o selon le script, mais il me semble que le r√©sultat r√©el est plus pr√©cieux dans les exp√©riences, donc il a montr√© ce qui s'est pass√© la premi√®re fois sans r√©p√©titions.</i>  <i>En g√©n√©ral, voici un tel bapt√™me comique de prise intelligente de feu.</i> <br><br><img src="https://habrastorage.org/webt/59/ef/a6/59efa6771e2ec068346209.jpeg"><br><br>  Il est tr√®s facile de calculer l'√©nergie d√©pens√©e sur la base du fait que l'eau a bouilli au bout de 2,5 minutes.  et pendant tout ce temps, le courant √©tait d'environ 2,5 A: <b>(2,5 A * 220 V) / 60 min.</b>  <b>* 2,5 min.</b>  <b>= 0,023 kWh.</b> <br><br>  Si votre objectif est de conserver un compteur d'√©lectricit√©, il est bon d'ajouter un autre capteur de tension qui peut √™tre fabriqu√© √† partir d'un transformateur abaisseur, de cette fa√ßon, vous pouvez obtenir une isolation galvanique et la tension n'est pas dangereuse pour la mesure √† l'aide d'un microcontr√¥leur ADC.  Et vous devez l'ajouter car la tension dans nos prises n'est presque jamais de 220V, mais ¬± 10V la marche dans le meilleur des cas. <br><br>  Et une autre option si vous n'avez pas besoin de lectures de courant et de tension par vous-m√™me, et que vous ne devez prendre en compte que la consommation d'√©lectricit√© - ce sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des compteurs √©lectriques</a> chinois <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">simples</a> , ils ont g√©n√©ralement une sortie basse tension puls√©e et ils sont tr√®s compacts.  Dans ce cas, leur utilisation est justifi√©e. <br><br><img src="https://habrastorage.org/webt/59/f0/75/59f075f5a1331511963267.jpeg"><br><br>  <i>PS Si vous envisagez vraiment d'assembler une vraie bouilloire Wifi, je vous recommande fortement de calculer l'√©paisseur des fils et la puissance du relais car la bouilloire √©lectrique moyenne est tr√®s vorace.</i> <br><br>  <b>UPD n ¬∞ 1:</b> Dans les commentaires, plusieurs autres appareils ont √©t√© propos√©s, y compris ceux finis: <br><br>  1. Module pr√™t √† l'emploi pour mesurer les param√®tres √©lectriques <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PZEM-004T</a> . <br><img src="https://habrastorage.org/webt/6j/6v/dz/6j6vdze5jkwofqjw5crmaawlyty.jpeg"><br><br>  2. Modules complets <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sonoff Pow</a> . <br><br>  3. Module √©galement fini sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©lectrodragon</a> esp8266. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr407541/">https://habr.com/ru/post/fr407541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr407531/index.html">L'histoire de l'arriv√©e en France (et 150 ans du jet domestique)</a></li>
<li><a href="../fr407533/index.html">Radio joue: vieux tr√®s bien oubli√©</a></li>
<li><a href="../fr407535/index.html">Les testeurs se sont plaints que les ordinateurs portables ARM avec Windows 10 n'avaient pas d'indicateur de batterie, mais cela ne s'est pas av√©r√© √™tre un bug</a></li>
<li><a href="../fr407537/index.html">Anatomie d'une panique moraliste</a></li>
<li><a href="../fr407539/index.html">122 jours sous rayons UV: tests comparatifs de produits imprim√©s en ABS et ASA imprim√©s en 3D</a></li>
<li><a href="../fr407543/index.html">Contr√¥le de pompe de puits semi-automatique</a></li>
<li><a href="../fr407545/index.html">Pourquoi les plus grands mineurs de Bitcoin sont-ils situ√©s en Chine</a></li>
<li><a href="../fr407547/index.html">Wilson Center: une arme biologique OGM est dangereuse comme une arme nucl√©aire, mais elle est beaucoup plus facile √† fabriquer</a></li>
<li><a href="../fr407551/index.html">Demandez √† Ethan: Comment voyager en toute transparence dans l'espace?</a></li>
<li><a href="../fr407553/index.html">10 sites d'information int√©ressants qui m√©ritent d'√™tre mis en signet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>