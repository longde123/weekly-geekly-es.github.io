<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¯ ğŸ¤¶ ğŸ¢ ä»å¤´å¼€å§‹åˆ¶ä½œç°ä»£Webåº”ç”¨ç¨‹åº ğŸœ ğŸ§˜ğŸ½ ğŸ˜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å› æ­¤ï¼Œæ‚¨å†³å®šåˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚ è¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªWebåº”ç”¨ç¨‹åºã€‚ åˆ›å»ºåŸºæœ¬åŸå‹éœ€è¦å¤šå°‘æ—¶é—´ï¼Ÿ æœ‰å¤šéš¾ï¼Ÿ ç°ä»£ç½‘ç«™ä»ä¸€å¼€å§‹å°±åº”è¯¥åšä»€ä¹ˆï¼Ÿ 

 åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å°è¯•æ¦‚è¿°å…·æœ‰ä»¥ä¸‹ä½“ç³»ç»“æ„çš„ç®€å•Webåº”ç”¨ç¨‹åºçš„æ ·æ¿ï¼š 

  
 æˆ‘ä»¬å°†ä»‹ç»çš„å†…å®¹ï¼š 



- åœ¨docker-composeä¸­è®¾ç½®å¼€å‘ç¯å¢ƒã€‚ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä»å¤´å¼€å§‹åˆ¶ä½œç°ä»£Webåº”ç”¨ç¨‹åº</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444446/">å› æ­¤ï¼Œæ‚¨å†³å®šåˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚ è¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªWebåº”ç”¨ç¨‹åºã€‚ åˆ›å»ºåŸºæœ¬åŸå‹éœ€è¦å¤šå°‘æ—¶é—´ï¼Ÿ æœ‰å¤šéš¾ï¼Ÿ ç°ä»£ç½‘ç«™ä»ä¸€å¼€å§‹å°±åº”è¯¥åšä»€ä¹ˆï¼Ÿ <br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å°è¯•æ¦‚è¿°å…·æœ‰ä»¥ä¸‹ä½“ç³»ç»“æ„çš„ç®€å•Webåº”ç”¨ç¨‹åºçš„æ ·æ¿ï¼š <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/ul/ne/9v/ulne9vljujdrtxnf-qeqrrux7da.png"></a> </div><br> æˆ‘ä»¬å°†ä»‹ç»çš„å†…å®¹ï¼š <br><br><ul><li> åœ¨docker-composeä¸­è®¾ç½®å¼€å‘ç¯å¢ƒã€‚ </li><li>  Flaskä¸Šçš„åç«¯åˆ›å»ºã€‚ </li><li> åœ¨Expressä¸Šåˆ›å»ºå‰ç«¯ã€‚ </li><li> ä½¿ç”¨Webpackæ„å»ºJSã€‚ </li><li>  Reactï¼ŒReduxå’ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ã€‚ </li><li> å…·æœ‰RQçš„ä»»åŠ¡é˜Ÿåˆ—ã€‚ </li></ul><a name="habracut"></a><br><h2> å¼•è¨€ </h2><br> å½“ç„¶ï¼Œåœ¨å¼€å‘ä¹‹å‰ï¼Œæ‚¨é¦–å…ˆéœ€è¦ç¡®å®šæˆ‘ä»¬åœ¨å¼€å‘ä»€ä¹ˆï¼ ä½œä¸ºæœ¬æ–‡çš„æ¨¡å‹åº”ç”¨ç¨‹åºï¼Œæˆ‘å†³å®šåˆ¶ä½œä¸€ä¸ªåŸå§‹çš„Wikiå¼•æ“ã€‚ æˆ‘ä»¬å°†åœ¨Markdownå‘è¡Œå¡ï¼› å¯ä»¥è§‚çœ‹å®ƒä»¬ï¼Œå¹¶ï¼ˆåœ¨å°†æ¥çš„æŸä¸ªæ—¶å€™ï¼‰è¿›è¡Œç¼–è¾‘ã€‚ æˆ‘ä»¬å°†æ‰€æœ‰è¿™äº›å®‰æ’ä¸ºå…·æœ‰æœåŠ¡å™¨ç«¯å‘ˆç°çš„ä¸€é¡µåº”ç”¨ç¨‹åºï¼ˆè¿™å¯¹äºç´¢å¼•æˆ‘ä»¬æœªæ¥çš„TBçº§å†…å®¹ç»å¯¹å¿…è¦ï¼‰ã€‚ <br><br> è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°äº†è§£ä¸ºæ­¤æ‰€éœ€çš„ç»„ä»¶ï¼š <br><br><ul><li>  <b>é¡¾å®¢</b> è®©æˆ‘ä»¬åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">React</a> + <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Redux</a>åŒ…ä¸­åˆ›å»ºä¸€ä¸ªå•é¡µåº”ç”¨ç¨‹åºï¼ˆå³ä½¿ç”¨AJAXè¿›è¡Œé¡µé¢è½¬æ¢ï¼‰ï¼Œè¿™åœ¨å‰ç«¯ä¸–ç•Œä¸­å¾ˆå¸¸è§ã€‚ </li><li>  <b>å‰ç«¯</b> ã€‚ è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Express</a>æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨å°†å‘ˆç°æˆ‘ä»¬çš„Reactåº”ç”¨ç¨‹åºï¼ˆå¼‚æ­¥è¯·æ±‚åç«¯ä¸­çš„æ‰€æœ‰å¿…è¦æ•°æ®ï¼‰å¹¶å°†å…¶å‘å¸ƒç»™ç”¨æˆ·ã€‚ </li><li>  <b>åç«¯</b> ã€‚ æŒæ¡ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬çš„åç«¯å°†æ˜¯ä¸€ä¸ªå°çš„Flaskåº”ç”¨ç¨‹åºã€‚ æˆ‘ä»¬å°†æ•°æ®ï¼ˆæˆ‘ä»¬çš„å¡ï¼‰å­˜å‚¨åœ¨æµè¡Œçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MongoDB</a>æ–‡æ¡£å­˜å‚¨åº“ä¸­ï¼Œå¹¶ä¸”å¯¹äºä»»åŠ¡é˜Ÿåˆ—ä»¥åŠå°†æ¥å¯èƒ½çš„ç¼“å­˜ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Redis</a> ã€‚ </li><li>  <b>å·¥ä½œäººå‘˜</b> ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RQ</a>åº“å°†å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„å®¹å™¨æ¥å¤„ç†ç¹é‡çš„ä»»åŠ¡ã€‚ </li></ul><br><h2> åŸºç¡€è®¾æ–½ï¼šgit </h2><br> å¯èƒ½æˆ‘ä»¬ä¸ä¼šè°ˆè®ºè¿™ä»¶äº‹ï¼Œä½†æ˜¯ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬å°†åœ¨gitå­˜å‚¨åº“ä¸­è¿›è¡Œå¼€å‘ã€‚ <br><br><pre><code class="bash hljs">git init git remote add origin git@github.com:Saluev/habr-app-demo.git git commit --allow-empty -m <span class="hljs-string"><span class="hljs-string">"Initial commit"</span></span> git push</code> </pre> <br>  ï¼ˆåœ¨è¿™é‡Œï¼Œæ‚¨åº”è¯¥ç«‹å³å¡«å†™<code>.gitignore</code> ã€‚ï¼‰ <br><br> æœ€ç»ˆè‰æ¡ˆå¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨Github</a>ä¸ŠæŸ¥çœ‹ã€‚ æœ¬æ–‡çš„æ¯ä¸€èŠ‚éƒ½å¯¹åº”ä¸€ä¸ªæäº¤ï¼ˆä¸ºå®ç°è¿™ä¸€ç›®æ ‡ï¼Œæˆ‘å¤§åŠŸå‘Šæˆï¼ï¼‰ã€‚ <br><br><h2> åŸºç¡€æ¶æ„ï¼šdocker-compose </h2><br> è®©æˆ‘ä»¬ä»è®¾ç½®ç¯å¢ƒå¼€å§‹ã€‚ æœ‰äº†æˆ‘ä»¬æ‹¥æœ‰çš„å¤§é‡ç»„ä»¶ï¼Œéå¸¸åˆä¹é€»è¾‘çš„å¼€å‘è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨docker-composeã€‚ <br><br> å°†<code>docker-compose.yml</code>æ–‡ä»¶æ·»åŠ åˆ°<code>docker-compose.yml</code>ä»¥ä¸‹å†…å®¹çš„å­˜å‚¨åº“ä¸­ï¼š <br><br><pre> <code class="plaintext hljs">version: '3' services: mongo: image: "mongo:latest" redis: image: "redis:alpine" backend: build: context: . dockerfile: ./docker/backend/Dockerfile environment: - APP_ENV=dev depends_on: - mongo - redis ports: - "40001:40001" volumes: - .:/code frontend: build: context: . dockerfile: ./docker/frontend/Dockerfile environment: - APP_ENV=dev - APP_BACKEND_URL=backend:40001 - APP_FRONTEND_PORT=40002 depends_on: - backend ports: - "40002:40002" volumes: - ./frontend:/app/src worker: build: context: . dockerfile: ./docker/worker/Dockerfile environment: - APP_ENV=dev depends_on: - mongo - redis volumes: - .:/code</code> </pre><br> è®©æˆ‘ä»¬å¿«é€Ÿçœ‹ä¸€ä¸‹è¿™é‡Œå‘ç”Ÿçš„äº‹æƒ…ã€‚ <br><br><ul><li> å°†åˆ›å»ºä¸€ä¸ªMongoDBå®¹å™¨å’Œä¸€ä¸ªRediså®¹å™¨ã€‚ </li><li> åˆ›å»ºäº†ä¸€ä¸ªç”¨äºåç«¯çš„å®¹å™¨ï¼ˆæˆ‘ä»¬å°†åœ¨ä¸‹é¢æè¿°ï¼‰ã€‚ å°†ç¯å¢ƒå˜é‡APP_ENV = devä¼ é€’ç»™å®ƒï¼ˆæˆ‘ä»¬å°†æŸ¥çœ‹å®ƒä»¥äº†è§£è¦åŠ è½½çš„Flaskè®¾ç½®ï¼‰ï¼Œå¹¶ä¸”å…¶ç«¯å£40001å°†åœ¨å¤–éƒ¨æ‰“å¼€ï¼ˆé€šè¿‡å®ƒï¼Œæˆ‘ä»¬çš„æµè§ˆå™¨å®¢æˆ·ç«¯å°†è½¬åˆ°APIï¼‰ã€‚ </li><li> åˆ›å»ºäº†æˆ‘ä»¬å‰ç«¯çš„å®¹å™¨ã€‚ å„ç§å„æ ·çš„ç¯å¢ƒå˜é‡ä¹Ÿè¢«æ‰”è¿›å»ï¼Œä»¥åå¯¹æˆ‘ä»¬æœ‰ç”¨ï¼Œç«¯å£40002æ‰“å¼€ï¼Œè¿™æ˜¯Webåº”ç”¨ç¨‹åºçš„ä¸»è¦ç«¯å£ï¼šåœ¨æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬å°†è½¬åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">httpï¼š// localhostï¼š40002</a> ã€‚ </li><li> æˆ‘ä»¬å·¥äººçš„å®¹å™¨å·²åˆ›å»ºã€‚ ä»–ä¸éœ€è¦å¤–éƒ¨ç«¯å£ï¼Œåœ¨MongoDBå’ŒRedisä¸­ä»…éœ€è¦è®¿é—®ã€‚ </li></ul><br> ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºdockerfileã€‚ ç›®å‰ï¼ŒHabrÃ©å³å°†æä¾›<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸€ç³»åˆ—</a>æœ‰å…³Docker <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¼˜ç§€</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¿»è¯‘</a> -æ‚¨å¯ä»¥æ”¾å¿ƒå‰å¾€æ‰€æœ‰ç»†èŠ‚ã€‚ <br><br> è®©æˆ‘ä»¬ä»åç«¯å¼€å§‹ã€‚ <br><br><pre> <code class="plaintext hljs"># docker/backend/Dockerfile FROM python:stretch COPY requirements.txt /tmp/ RUN pip install -r /tmp/requirements.txt ADD . /code WORKDIR /code CMD gunicorn -w 1 -b 0.0.0.0:40001 --worker-class gevent backend.server:app</code> </pre><br> å¯ä»¥ç†è§£ï¼Œæˆ‘ä»¬éå†äº†gunicorn Flaskåº”ç”¨ç¨‹åºï¼Œè¯¥åº”ç”¨ç¨‹åºéšè—åœ¨<code>backend.server</code>æ¨¡å—ä¸­çš„åç§°<code>app</code>ä¸‹ã€‚ <br><br> åŒæ ·é‡è¦çš„<code>docker/backend/.dockerignore</code> ï¼š <br><br><pre> <code class="plaintext hljs">.git .idea .logs .pytest_cache frontend tests venv *.pyc *.pyo</code> </pre><br>  workeré€šå¸¸ä¸åç«¯ç›¸ä¼¼ï¼Œåªæ˜¯æˆ‘ä»¬é€šå¸¸ä¼šå¯åŠ¨pitæ¨¡å—è€Œä¸æ˜¯gunicornï¼š <br><br><pre> <code class="plaintext hljs"># docker/worker/Dockerfile FROM python:stretch COPY requirements.txt /tmp/ RUN pip install -r /tmp/requirements.txt ADD . /code WORKDIR /code CMD python -m worker</code> </pre><br> æˆ‘ä»¬å°†åœ¨<code>worker/__main__.py</code>å®Œæˆæ‰€æœ‰å·¥ä½œã€‚ <br><br>  <code>.dockerignore</code>å·¥ä½œç¨‹åºä¸<code>.dockerignore</code>åç«¯å®Œå…¨ç›¸ä¼¼ã€‚ <br><br> æœ€åï¼Œå‰ç«¯ã€‚ åœ¨HabrÃ©ä¸Šæœ‰å…³äºä»–çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ•´ç¯‡æ–‡ç« </a> ï¼Œä½†æ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¯¹StackOverflow</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¹¿æ³›è®¨è®º</a>å’Œæœ¬ç€â€œä½ ä»¬å·²ç»æ˜¯2018å¹´äº†ï¼Œä»ç„¶æ²¡æœ‰æ­£å¸¸è§£å†³æ–¹æ¡ˆå—ï¼Ÿâ€ç²¾ç¥çš„è¯„è®ºæ¥åˆ¤æ–­ã€‚ é‚£é‡Œçš„ä¸€åˆ‡éƒ½ä¸é‚£ä¹ˆç®€å•ã€‚ æˆ‘é€‰æ‹©äº†æ­¤ç‰ˆæœ¬çš„dockeræ–‡ä»¶ã€‚ <br><br><pre> <code class="plaintext hljs"># docker/frontend/Dockerfile FROM node:carbon WORKDIR /app #  package.json  package-lock.json   npm install,   . COPY frontend/package*.json ./ RUN npm install #       , #     PATH. ENV PATH /app/node_modules/.bin:$PATH #      . ADD frontend /app/src WORKDIR /app/src RUN npm run build CMD npm run start</code> </pre><br> ä¼˜ç‚¹ï¼š <br><br><ul><li> ä¸€åˆ‡éƒ½æŒ‰é¢„æœŸè¿›è¡Œäº†ç¼“å­˜ï¼ˆåœ¨åº•å±‚-ä¾èµ–å…³ç³»ï¼Œåœ¨é¡¶å±‚-åº”ç”¨ç¨‹åºçš„æ„å»ºï¼‰ï¼› </li><li>  <code>docker-compose exec frontend npm install --save newDependency</code>å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œå¹¶ä¸”å¯ä»¥ä¿®æ”¹å­˜å‚¨åº“ä¸­çš„<code>package.json</code> ï¼ˆå¾ˆå¤šäººå»ºè®®ï¼Œå¦‚æœä½¿ç”¨COPYåˆ™ä¸ä¼šè¿™æ ·ï¼‰ã€‚ æ— è®ºå¦‚ä½•éƒ½ä¸å¸Œæœ›åœ¨å®¹å™¨å¤–éƒ¨è¿è¡Œ<code>npm install --save newDependency</code> ï¼Œå› ä¸ºæ–°è½¯ä»¶åŒ…çš„æŸäº›ä¾èµ–é¡¹å¯èƒ½å·²ç»å­˜åœ¨å¹¶åœ¨å¦ä¸€ä¸ªå¹³å°ä¸‹æ„å»ºï¼ˆä¾‹å¦‚ï¼Œåœ¨<code>npm install --save newDependency</code>å†…éƒ¨çš„ä¸€ä¸ªå¹³å°ä¸‹ï¼Œè€Œä¸æ˜¯åœ¨æˆ‘ä»¬å·¥ä½œçš„macbookä¹‹ä¸‹ï¼‰ ï¼‰ï¼Œä½†æˆ‘ä»¬é€šå¸¸ä¸å¸Œæœ›å¼€å‘è®¡ç®—æœºä¸Šå­˜åœ¨Nodeã€‚ ä¸€ä¸ªDockeræ¥ç»Ÿæ²»ä»–ä»¬ï¼ </li></ul><br> å¥½å§ï¼Œå½“ç„¶è¿˜æœ‰<code>docker/frontend/.dockerignore</code> ï¼š <br><br><pre> <code class="plaintext hljs">.git .idea .logs .pytest_cache backend worker tools node_modules npm-debug tests venv</code> </pre><br> å› æ­¤ï¼Œæˆ‘ä»¬çš„å®¹å™¨æ¡†æ¶å·²å‡†å¤‡å°±ç»ªï¼Œæ‚¨å¯ä»¥å°†å…¶è£…æ»¡å†…å®¹ï¼ <br><br><h2> åç«¯ï¼šFlaskæ¡†æ¶ </h2><br> å°†<code>flask</code> ï¼Œ <code>flask-cors</code> ï¼Œ <code>gevent</code>å’Œ<code>gunicorn</code>åˆ°<code>requirements.txt</code>å¹¶åœ¨<code>backend/server.py</code>åˆ›å»ºä¸€ä¸ªç®€å•çš„Flaskåº”ç”¨ç¨‹åºã€‚ <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/server.py import os.path import flask import flask_cors class HabrAppDemo(flask.Flask): def __init__(self, *args, **kwargs): super().__init__(*args, **kwargs) # CORS        #    ,      # (  Access-Control-Origin  ). #   - . flask_cors.CORS(self) app = HabrAppDemo("habr-app-demo") env = os.environ.get("APP_ENV", "dev") print(f"Starting application in {env} mode") app.config.from_object(f"backend.{env}_settings")</span></span></code> </pre><br> æˆ‘ä»¬å‘Šè¯‰Flaskä»<code>backend.{env}_settings</code>æ–‡ä»¶<code>backend.{env}_settings</code>æ‹‰å‡ºè®¾ç½®ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªï¼ˆè‡³å°‘ä¸ºç©ºï¼‰æ–‡ä»¶<code>backend/dev_settings.py</code> ï¼Œä»¥ä½¿ä¸€åˆ‡è…¾é£ã€‚ <br><br> ç°åœ¨æˆ‘ä»¬å¯ä»¥æ­£å¼æå‡åç«¯äº†ï¼ <br><br><pre> <code class="plaintext hljs">habr-app-demo$ docker-compose up backend ... backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Starting gunicorn 19.9.0 backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Listening at: http://0.0.0.0:40001 (6) backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Using worker: gevent backend_1 | [2019-02-23 10:09:03 +0000] [9] [INFO] Booting worker with pid: 9</code> </pre><br> æˆ‘ä»¬ç»§ç»­å‰è¿›ã€‚ <br><br><h2> å‰ç«¯ï¼šExpressæ¡†æ¶ </h2><br> è®©æˆ‘ä»¬ä»åˆ›å»ºä¸€ä¸ªåŒ…å¼€å§‹ã€‚ åˆ›å»ºäº†å‰ç«¯æ–‡ä»¶å¤¹å¹¶åœ¨å…¶ä¸­è¿è¡Œ<code>npm init</code>ä¹‹åï¼Œç»è¿‡ä¸€äº›ç®€å•çš„é—®é¢˜ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°äº†å®Œæ•´çš„package.json <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"habr-app-demo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"This is an app demo for Habr article."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"repository"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"git"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"git+https://github.com/Saluev/habr-app-demo.git"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"Tigran Saluev &lt;tigran@saluev.com&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"MIT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bugs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/Saluev/habr-app-demo/issues"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"homepage"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/Saluev/habr-app-demo#readme"</span></span> }</code> </pre><br> å°†æ¥ï¼Œæˆ‘ä»¬åœ¨å¼€å‘äººå‘˜çš„æœºå™¨ä¸Šæ ¹æœ¬ä¸éœ€è¦Node.jsï¼ˆå°½ç®¡æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡Dockeré—ªé¿å¹¶å¯åŠ¨<code>npm init</code> ï¼Œä½†æ˜¯å¾ˆå¥½ï¼‰ã€‚ <br><br> åœ¨<code>Dockerfile</code>æˆ‘ä»¬æåˆ°äº†<code>npm run build</code>å’Œ<code>npm run start</code> <code>Dockerfile</code>æ‚¨éœ€è¦å°†é€‚å½“çš„å‘½ä»¤æ·»åŠ åˆ°<code>package.json</code> ï¼š <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/package.json +++ b/frontend/package.json @@ -4,6 +4,8 @@ "description": "This is an app demo for Habr article.", "main": "index.js", "scripts": { + "build": "echo 'build'", + "start": "node index.js", "test": "echo \"Error: no test specified\" &amp;&amp; exit 1" }, "repository": {</span></span></code> </pre><br>  <code>build</code>å‘½ä»¤ä»€ä¹ˆä¹Ÿæ²¡åšï¼Œä½†æ˜¯å¯¹æˆ‘ä»¬ä»ç„¶æœ‰ç”¨ã€‚ <br><br> æ·»åŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Express</a>ä¾èµ–é¡¹å¹¶åœ¨<code>index.js</code>åˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼š <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/package.json +++ b/frontend/package.json @@ -17,5 +17,8 @@ "bugs": { "url": "https://github.com/Saluev/habr-app-demo/issues" }, - "homepage": "https://github.com/Saluev/habr-app-demo#readme" + "homepage": "https://github.com/Saluev/habr-app-demo#readme", + "dependencies": { + "express": "^4.16.3" + } }</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js const express = require("express"); app = express(); app.listen(process.env.APP_FRONTEND_PORT); app.get("*", (req, res) =&gt; { res.send("Hello, world!") });</span></span></code> </pre><br> ç°åœ¨ï¼Œ <code>docker-compose up frontend</code>æå‡äº†æˆ‘ä»¬çš„å‰ç«¯ï¼ æ­¤å¤–ï¼Œåœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">httpï¼š// localhostï¼š40002ä¸Š</a> ï¼Œç»å…¸çš„â€œ Helloï¼Œworldâ€åº”è¯¥å·²ç»å±•ç¤ºå‡ºæ¥äº†ã€‚ <br><br><h2> å‰ç«¯ï¼šä½¿ç”¨webpackå’ŒReactåº”ç”¨ç¨‹åºæ„å»º </h2><br> ç°åœ¨æ˜¯æ—¶å€™åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­æç»˜æ¯”çº¯æ–‡æœ¬æ›´å¤šçš„ä¸œè¥¿äº†ã€‚ åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ <code>App</code>çš„æœ€ç®€å•çš„Reactç»„ä»¶å¹¶é…ç½®ç¨‹åºé›†ã€‚ <br><br> åœ¨Reactä¸­è¿›è¡Œç¼–ç¨‹æ—¶ï¼Œä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JSX</a>éå¸¸æ–¹ä¾¿ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JSX</a>æ˜¯ä¸€ç§JavaScriptçš„æ–¹è¨€ï¼Œé€šè¿‡å½¢å¼çš„è¯­æ³•æ„é€ å¾—åˆ°æ‰©å±• <br><br><pre> <code class="javascript hljs">render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MyButton</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">color</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"blue"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{this.props.caption}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MyButton</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; }</code> </pre><br> ä½†æ˜¯ï¼ŒJavaScriptå¼•æ“ä¸äº†è§£å®ƒï¼Œå› æ­¤é€šå¸¸å°†æ„å»ºé˜¶æ®µæ·»åŠ åˆ°å‰ç«¯ã€‚ ç‰¹æ®Šçš„JavaScriptç¼–è¯‘å™¨ï¼ˆyeah-yeahï¼‰å°†è¯­æ³•ç³–è½¬æ¢ä¸º<s>ä¸‘é™‹çš„</s>ç»å…¸JavaScriptï¼Œå¤„ç†å¯¼å…¥ï¼Œç¼©å°ç­‰æ“ä½œã€‚ <br><br><img src="https://habrastorage.org/webt/f1/rl/0j/f1rl0jer0cxs_ll69yagvwm_0gc.jpeg"><br><br>  <i>2014å¹´ã€‚</i>  <i>apt-cacheæœç´¢Java</i> <br><br> å› æ­¤ï¼Œæœ€ç®€å•çš„Reactç»„ä»¶çœ‹èµ·æ¥éå¸¸ç®€å•ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js import React, {Component} from 'react' class App extends Component { render() { return &lt;h1&gt;Hello, world!&lt;/h1&gt; } } export default App</span></span></code> </pre><br> ä»–åªä¼šç”¨æ›´å…·è¯´æœåŠ›çš„å›¾é’‰å‘æˆ‘ä»¬è¡¨ç¤ºé—®å€™ã€‚ <br><br> æ·»åŠ æ–‡ä»¶<code>frontend/src/template.js</code>å…¶ä¸­åŒ…å«æˆ‘ä»¬æœªæ¥åº”ç”¨ç¨‹åºçš„æœ€å°HTMLæ¡†æ¶ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/template.js export default function template(title) { let page = ` &lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;${title}&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="app"&gt;&lt;/div&gt; &lt;script src="/dist/client.js"&gt;&lt;/script&gt; &lt;/body&gt; &lt;/html&gt; `; return page; }</span></span></code> </pre><br> æ·»åŠ å®¢æˆ·ç«¯å…¥å£ç‚¹ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import App from './components/app' render( &lt;App/&gt;, document.querySelector('#app') );</span></span></code> </pre><br> è¦æ‰“é€ æ‰€æœ‰è¿™äº›ç¾ä¸½ï¼Œæˆ‘ä»¬éœ€è¦ï¼š <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">webpack</a>æ˜¯JSçš„æ—¶å°šé’å¹´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ„å»ºå™¨</a> ï¼ˆå°½ç®¡æˆ‘ä¸‰ä¸ªå°æ—¶éƒ½æ²¡æœ‰åœ¨å‰ç«¯é˜…è¯»æ–‡ç« ï¼Œæ‰€ä»¥æˆ‘ä¸ç¡®å®šæ—¶å°šï¼‰ï¼› <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">babel</a>æ˜¯é€‚ç”¨äºå„ç§ä¹³æ¶²ï¼ˆå¦‚JSXï¼‰çš„ç¼–è¯‘å™¨ï¼ŒåŒæ—¶æ˜¯é€‚ç”¨äºæ‰€æœ‰IEå¤–å£³çš„polyfillæä¾›ç¨‹åºã€‚ <br><br> å¦‚æœå‰ç«¯çš„ä¸Šä¸€ä¸ªè¿­ä»£ä»åœ¨è¿è¡Œï¼Œé‚£ä¹ˆæ‚¨è¦åšçš„å°±æ˜¯ <br><br><pre> <code class="bash hljs">docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save \ react \ react-dom docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save-dev \ webpack \ webpack-cli \ babel-loader \ @babel/core \ @babel/polyfill \ @babel/preset-env \ @babel/preset-react</code> </pre><br> å®‰è£…æ–°çš„ä¾èµ–é¡¹ã€‚ ç°åœ¨é…ç½®webpackï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/webpack.config.js const path = require("path"); //  . clientConfig = { mode: "development", entry: { client: ["./src/client.js", "@babel/polyfill"] }, output: { path: path.resolve(__dirname, "../dist"), filename: "[name].js" }, module: { rules: [ { test: /\.js$/, exclude: /node_modules/, loader: "babel-loader" } ] } }; //  .     : // 1. target: "node" -      import path. // 2.   ..,    ../dist --   //    ,   ! serverConfig = { mode: "development", target: "node", entry: { server: ["./index.js", "@babel/polyfill"] }, output: { path: path.resolve(__dirname, ".."), filename: "[name].js" }, module: { rules: [ { test: /\.js$/, exclude: /node_modules/, loader: "babel-loader" } ] } }; module.exports = [clientConfig, serverConfig];</span></span></code> </pre><br> è¦ä½¿babelæ­£å¸¸å·¥ä½œï¼Œæ‚¨éœ€è¦é…ç½®<code>frontend/.babelrc</code> ï¼š <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"presets"</span></span>: [<span class="hljs-string"><span class="hljs-string">"@babel/env"</span></span>, <span class="hljs-string"><span class="hljs-string">"@babel/react"</span></span>] }</code> </pre><br> æœ€åï¼Œä½¿æˆ‘ä»¬çš„<code>npm run build</code>å‘½ä»¤æœ‰æ„ä¹‰ï¼š <br><br><pre> <code class="json hljs">// frontend/package.json ... <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"build"</span></span>: <span class="hljs-string"><span class="hljs-string">"webpack"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-string"><span class="hljs-string">"node /app/server.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span> }, ...</code> </pre><br> ç°åœ¨ï¼Œæˆ‘ä»¬çš„å®¢æˆ·ç«¯ä»¥åŠ<code>../dist/client.js</code>åŠå…¶æ‰€æœ‰ä¾èµ–é¡¹ï¼Œé€šè¿‡babelè¿è¡Œï¼Œç¼–è¯‘å¹¶æŠ˜å æˆä¸€ä¸ªæ•´ä½“çš„ç¼©å°æ–‡ä»¶<code>../dist/client.js</code> ã€‚ æ·»åŠ å°†å…¶ä½œä¸ºé™æ€æ–‡ä»¶ä¸Šä¼ åˆ°æˆ‘ä»¬çš„Expressåº”ç”¨ç¨‹åºçš„åŠŸèƒ½ï¼Œå¹¶ä¸”åœ¨é»˜è®¤è·¯ç”±ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å§‹è¿”å›HTMLï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js // ,    , //  - . import express from 'express' import template from './src/template' let app = express(); app.use('/dist', express.static('../dist')); app.get("*", (req, res) =&gt; { res.send(template("Habr demo app")); }); app.listen(process.env.APP_FRONTEND_PORT);</span></span></code> </pre><br> æˆåŠŸï¼ ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è¿è¡Œ<code>docker-compose up --build frontend</code> ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°â€œ Helloï¼Œworldï¼â€ åœ¨ä¸€ä¸ªæ–°çš„é—ªäº®åŒ…è£…ä¸­ï¼Œå¦‚æœæ‚¨å®‰è£…äº†Reactå¼€å‘äººå‘˜å·¥å…·æ‰©å±•ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Chrome</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Firefox</a> ï¼‰ï¼Œé‚£ä¹ˆå¼€å‘äººå‘˜å·¥å…·ä¸­è¿˜ä¼šæœ‰ä¸€ä¸ªReactç»„ä»¶æ ‘ï¼š <br><br><img src="https://habrastorage.org/webt/q1/it/gu/q1itgukw2k0ko60pghlwwkfqfn0.png"><br><br><h2> åç«¯ï¼šMongoDBä¸­çš„æ•°æ® </h2><br> åœ¨ç»§ç»­å‰è¿›å¹¶ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ³¨å…¥ç”Ÿå‘½ä¹‹å‰ï¼Œæ‚¨å¿…é¡»é¦–å…ˆå°†å…¶å‘¼å¸åˆ°åç«¯ã€‚ ä¼¼ä¹æˆ‘ä»¬è¦å­˜å‚¨åœ¨Markdownä¸­æ ‡è®°çš„å¡ç‰‡-æ˜¯æ—¶å€™è¿™æ ·åšäº†ã€‚ <br><br> å°½ç®¡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">pythonä¸­æœ‰ç”¨äºMongoDBçš„ORM</a> ï¼Œä½†æˆ‘è®¤ä¸ºå¯¹ORMçš„ä½¿ç”¨æ˜¯æ¶æ„çš„ï¼Œå› æ­¤æˆ‘å°†é€‚å½“çš„è§£å†³æ–¹æ¡ˆçš„ç ”ç©¶äº¤ç»™æ‚¨ã€‚ ç›¸åï¼Œæˆ‘ä»¬å°†ä¸ºå¡ç‰‡å’Œéšé™„çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DAO</a>åšä¸€ä¸ªç®€å•çš„ç±»ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/storage/card.py import abc from typing import Iterable class Card(object): def __init__(self, id: str = None, slug: str = None, name: str = None, markdown: str = None, html: str = None): self.id = id self.slug = slug #    self.name = name self.markdown = markdown self.html = html class CardDAO(object, metaclass=abc.ABCMeta): @abc.abstractmethod def create(self, card: Card) -&gt; Card: pass @abc.abstractmethod def update(self, card: Card) -&gt; Card: pass @abc.abstractmethod def get_all(self) -&gt; Iterable[Card]: pass @abc.abstractmethod def get_by_id(self, card_id: str) -&gt; Card: pass @abc.abstractmethod def get_by_slug(self, slug: str) -&gt; Card: pass class CardNotFound(Exception): pass</span></span></code> </pre><br>  ï¼ˆå¦‚æœæ‚¨ä»æœªåœ¨Pythonä¸­ä½¿ç”¨ç±»å‹æ³¨é‡Šï¼Œè¯·åŠ¡å¿…æŸ¥çœ‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™äº›</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a> ï¼ï¼‰ <br><br> ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»º<code>CardDAO</code>æ¥å£çš„å®ç°ï¼Œè¯¥å®ç°å°†<code>CardDAO</code>ä¸­çš„<code>Database</code>å¯¹è±¡<code>pymongo</code> ï¼ˆæ˜¯çš„ï¼Œæ˜¯å°†<code>pymongo</code>æ·»åŠ åˆ°<code>requirements.txt</code> ï¼‰ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/storage/card_impl.py from typing import Iterable import bson import bson.errors from pymongo.collection import Collection from pymongo.database import Database from backend.storage.card import Card, CardDAO, CardNotFound class MongoCardDAO(CardDAO): def __init__(self, mongo_database: Database): self.mongo_database = mongo_database # , slug   . self.collection.create_index("slug", unique=True) @property def collection(self) -&gt; Collection: return self.mongo_database["cards"] @classmethod def to_bson(cls, card: Card): # MongoDB     BSON.  #       BSON- #  ,      . result = { k: v for k, v in card.__dict__.items() if v is not None } if "id" in result: result["_id"] = bson.ObjectId(result.pop("id")) return result @classmethod def from_bson(cls, document) -&gt; Card: #   ,     #     ,     #  .    id    # ,   -   . document["id"] = str(document.pop("_id")) return Card(**document) def create(self, card: Card) -&gt; Card: card.id = str(self.collection.insert_one(self.to_bson(card)).inserted_id) return card def update(self, card: Card) -&gt; Card: card_id = bson.ObjectId(card.id) self.collection.update_one({"_id": card_id}, {"$set": self.to_bson(card)}) return card def get_all(self) -&gt; Iterable[Card]: for document in self.collection.find(): yield self.from_bson(document) def get_by_id(self, card_id: str) -&gt; Card: return self._get_by_query({"_id": bson.ObjectId(card_id)}) def get_by_slug(self, slug: str) -&gt; Card: return self._get_by_query({"slug": slug}) def _get_by_query(self, query) -&gt; Card: document = self.collection.find_one(query) if document is None: raise CardNotFound() return self.from_bson(document)</span></span></code> </pre><br> æ˜¯æ—¶å€™åœ¨åç«¯è®¾ç½®ä¸­æ³¨å†ŒMongaé…ç½®äº†ã€‚ æˆ‘ä»¬åªæ˜¯ç”¨mongo <code>mongo</code>å‘½åäº†æˆ‘ä»¬çš„å®¹å™¨ï¼Œæ‰€ä»¥<code>MONGO_HOST = "mongo"</code> ï¼š <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/backend/dev_settings.py +++ b/backend/dev_settings.py @@ -0,0 +1,3 @@ +MONGO_HOST = "mongo" +MONGO_PORT = 27017 +MONGO_DATABASE = "core"</span></span></code> </pre><br> ç°åœ¨æˆ‘ä»¬éœ€è¦åˆ›å»º<code>MongoCardDAO</code>å¹¶ä¸ºFlaskåº”ç”¨ç¨‹åºæä¾›è®¿é—®æƒé™ã€‚ å°½ç®¡ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªéå¸¸ç®€å•çš„å¯¹è±¡å±‚æ¬¡ç»“æ„ï¼ˆè®¾ç½®â†’pymongoå®¢æˆ·ç«¯â†’pymongoæ•°æ®åº“â†’ <code>MongoCardDAO</code> ï¼‰ï¼Œä½†è®©æˆ‘ä»¬ç«‹å³åˆ›å»ºä¸€ä¸ªè¿›è¡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¾èµ–é¡¹æ³¨å…¥</a>çš„é›†ä¸­å¼Kingç»„ä»¶ï¼ˆå½“æˆ‘ä»¬å¤„ç†workerå’Œå·¥å…·æ—¶ï¼Œå®ƒå°†å†æ¬¡æ´¾ä¸Šç”¨åœºï¼‰ã€‚ <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/wiring.py import os from pymongo import MongoClient from pymongo.database import Database import backend.dev_settings from backend.storage.card import CardDAO from backend.storage.card_impl import MongoCardDAO class Wiring(object): def __init__(self, env=None): if env is None: env = os.environ.get("APP_ENV", "dev") self.settings = { "dev": backend.dev_settings, # (    # ,   !) }[env] #        . #        DI,  . self.mongo_client: MongoClient = MongoClient( host=self.settings.MONGO_HOST, port=self.settings.MONGO_PORT) self.mongo_database: Database = self.mongo_client[self.settings.MONGO_DATABASE] self.card_dao: CardDAO = MongoCardDAO(self.mongo_database)</span></span></code> </pre><br><br> æ˜¯æ—¶å€™ä¸ºFlaskåº”ç”¨ç¨‹åºæ·»åŠ æ–°è·¯çº¿å¹¶æ¬£èµç¾æ™¯äº†ï¼ <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/server.py import os.path import flask import flask_cors from backend.storage.card import CardNotFound from backend.wiring import Wiring env = os.environ.get("APP_ENV", "dev") print(f"Starting application in {env} mode") class HabrAppDemo(flask.Flask): def __init__(self, *args, **kwargs): super().__init__(*args, **kwargs) flask_cors.CORS(self) self.wiring = Wiring(env) self.route("/api/v1/card/&lt;card_id_or_slug&gt;")(self.card) def card(self, card_id_or_slug): try: card = self.wiring.card_dao.get_by_slug(card_id_or_slug) except CardNotFound: try: card = self.wiring.card_dao.get_by_id(card_id_or_slug) except (CardNotFound, ValueError): return flask.abort(404) return flask.jsonify({ k: v for k, v in card.__dict__.items() if v is not None }) app = HabrAppDemo("habr-app-demo") app.config.from_object(f"backend.{env}_settings")</span></span></code> </pre><br> é‡æ–°å¯åŠ¨<code>docker-compose up --build backend</code> ï¼š <br><br><img src="https://habrastorage.org/webt/ts/_a/1l/ts_a1ljldp9jztjvlupm4z6f29i.png"><br><br> ç³Ÿç³•...å“¦ï¼Œæ˜¯çš„ã€‚ æˆ‘ä»¬éœ€è¦æ·»åŠ å†…å®¹ï¼ æˆ‘ä»¬å°†æ‰“å¼€toolsæ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªè„šæœ¬ï¼Œä»¥æ·»åŠ ä¸€ä¸ªæµ‹è¯•å¡ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py from backend.storage.card import Card from backend.wiring import Wiring wiring = Wiring() wiring.card_dao.create(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. """))</span></span></code> </pre><br>  <code>docker-compose exec backend python -m tools.add_test_content</code>ç”¨<code>docker-compose exec backend python -m tools.add_test_content</code>å®¹å™¨å†…éƒ¨çš„å†…å®¹å¡«å……æˆ‘ä»¬çš„<code>docker-compose exec backend python -m tools.add_test_content</code> ã€‚ <br><br><img src="https://habrastorage.org/webt/em/n2/la/emn2laspljezpnoc66oeccj42l4.png"><br><br> æˆåŠŸï¼ ç°åœ¨æ˜¯æ—¶å€™åœ¨å‰ç«¯æä¾›æ”¯æŒäº†ã€‚ <br><br><h2> å‰ç«¯ï¼šRedux </h2><br> ç°åœ¨æˆ‘ä»¬è¦åˆ¶ä½œroute <code>/card/:id_or_slug</code> ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬çš„Reactåº”ç”¨ç¨‹åºå°†æ‰“å¼€ï¼Œä»APIåŠ è½½cardæ•°æ®å¹¶ä»¥æŸç§æ–¹å¼å‘æˆ‘ä»¬å±•ç¤ºã€‚ åœ¨è¿™é‡Œï¼Œä¹Ÿè®¸æ˜¯æœ€å›°éš¾çš„éƒ¨åˆ†å¼€å§‹äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›æœåŠ¡å™¨ç«‹å³ä¸ºæˆ‘ä»¬æä¾›åŒ…å«å¡ç‰‡å†…å®¹çš„HTMLï¼Œé€‚åˆç´¢å¼•ï¼Œä½†æ˜¯ä¸æ­¤åŒæ—¶ï¼Œå½“åº”ç”¨ç¨‹åºåœ¨å¡ç‰‡ä¹‹é—´å¯¼èˆªæ—¶ï¼Œå®ƒä¼šä»APIæ¥æ”¶JSONå½¢å¼çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶ä¸”é¡µé¢ä¸ä¼šè¿‡è½½ã€‚ è¿™æ ·ï¼Œæ‰€æœ‰è¿™äº›-æ— éœ€å¤åˆ¶ç²˜è´´ï¼ <br><br> è®©æˆ‘ä»¬ä»æ·»åŠ Reduxå¼€å§‹ã€‚  Reduxæ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨çŠ¶æ€çš„JavaScriptåº“ã€‚ è¿™ä¸ªæƒ³æ³•æ˜¯ï¼Œæ‚¨çš„ç»„ä»¶å…·æœ‰ä¸€ä¸ªé›†ä¸­çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯é€šè¿‡åœ¨ç”¨æˆ·æ“ä½œå’Œå…¶ä»–æœ‰è¶£äº‹ä»¶æœŸé—´å‘ç”Ÿå˜åŒ–çš„ä¸Šåƒä¸ªéšå¼çŠ¶æ€ï¼Œå¹¶é€šè¿‡é›†ä¸­çš„æ“ä½œæœºåˆ¶è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚ å› æ­¤ï¼Œå¦‚æœè¾ƒæ—©è¿›è¡Œå¯¼èˆªï¼Œæˆ‘ä»¬é¦–å…ˆæ‰“å¼€äº†åŠ è½½çš„GIFï¼Œç„¶åé€šè¿‡AJAXå‘å‡ºäº†è¯·æ±‚ï¼Œæœ€ååœ¨æˆåŠŸå›è°ƒä¸­ï¼Œæˆ‘ä»¬æ›´æ–°äº†é¡µé¢çš„å¿…è¦éƒ¨åˆ†ï¼Œç„¶ååœ¨ReduxèŒƒå¼ä¸­ï¼Œæˆ‘ä»¬è¢«é‚€è¯·å‘é€åŠ¨ä½œâ€œå°†å†…å®¹æ›´æ”¹ä¸ºå¸¦æœ‰åŠ¨ç”»çš„gifâ€ã€‚å°†æ›´æ”¹å…¨å±€çŠ¶æ€ï¼Œä»¥ä¾¿æ‚¨çš„ä¸€ä¸ªç»„ä»¶å°†ä¸¢å¼ƒå…ˆå‰çš„å†…å®¹å¹¶æ”¾å…¥åŠ¨ç”»ï¼Œç„¶åå‘å‡ºè¯·æ±‚ï¼Œå¹¶åœ¨å…¶æˆåŠŸå›è°ƒä¸­å‘é€å¦ä¸€ä¸ªæ“ä½œï¼Œâ€œå°†å†…å®¹æ›´æ”¹ä¸ºå·²åŠ è½½â€ã€‚ æ€»çš„æ¥è¯´ï¼Œç°åœ¨æˆ‘ä»¬å°†è‡ªå·±çœ‹åˆ°å®ƒã€‚ <br><br> è®©æˆ‘ä»¬ä»åœ¨å®¹å™¨ä¸­å®‰è£…æ–°çš„ä¾èµ–å…³ç³»å¼€å§‹ã€‚ <br><br><pre> <code class="bash hljs">docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save \ redux \ react-redux \ redux-thunk \ redux-devtools-extension</code> </pre><br> å®é™…ä¸Šï¼Œç¬¬ä¸€ä¸ªæ˜¯Reduxï¼Œç¬¬äºŒä¸ªæ˜¯ç”¨äºè·¨Reactå’ŒReduxçš„ç‰¹æ®Šåº“ï¼ˆç”±äº¤é…ä¸“å®¶ç¼–å†™ï¼‰ï¼Œç¬¬ä¸‰ä¸ªæ˜¯éå¸¸å¿…è¦çš„ï¼Œåœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">READMEä¸­</a>æœ‰å……åˆ†çš„ç†ç”±ï¼Œæœ€åï¼Œç¬¬å››ä¸ªæ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Redux DevTools</a>å·¥ä½œæ‰€éœ€çš„åº“<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‰©å±•å</a> ã€‚ <br><br> è®©æˆ‘ä»¬ä»æ ·æ¿Reduxä»£ç å¼€å§‹ï¼šåˆ›å»ºä¸€ä¸ªä¸æ‰§è¡Œä»»ä½•æ“ä½œçš„reducerå¹¶åˆå§‹åŒ–çŠ¶æ€ã€‚ <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js export default function root(state = {}, action) { return state; }</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/configureStore.js import {createStore, applyMiddleware} from "redux"; import thunkMiddleware from "redux-thunk"; import {composeWithDevTools} from "redux-devtools-extension"; import rootReducer from "./reducers"; export default function configureStore(initialState) { return createStore( rootReducer, initialState, composeWithDevTools(applyMiddleware(thunkMiddleware)), ); }</span></span></code> </pre><br> æˆ‘ä»¬çš„å®¢æˆ·æœ‰æ‰€æ”¹å˜ï¼Œåœ¨å¿ƒç†ä¸Šå‡†å¤‡ä¸Reduxåˆä½œï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' //      ... const store = configureStore(); render( // ...      , //     &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br> ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œdocker-compose up --build frontendæ¥ç¡®ä¿æ²¡æœ‰ä»»ä½•æŸåï¼Œå¹¶ä¸”æˆ‘ä»¬çš„åŸå§‹çŠ¶æ€å·²ç»å‡ºç°åœ¨Redux DevToolsä¸­ï¼š <br><br><img src="https://habrastorage.org/webt/x0/hr/_e/x0hr_empfso4poji4s8egshlcye.png"><br><br><h2> å‰ç«¯ï¼šå¡é¡µ </h2><br> åœ¨åˆ¶ä½œå¸¦æœ‰SSRçš„é¡µé¢ä¹‹å‰ï¼Œæ‚¨éœ€è¦åˆ¶ä½œæ²¡æœ‰SSRçš„é¡µé¢ï¼ æœ€åï¼Œè®©æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬ç‹¬åˆ›çš„APIæ¥è®¿é—®å¡å¹¶åœ¨å‰ç«¯ç»„æˆå¡é¡µé¢ã€‚ <br><br> æ˜¯æ—¶å€™åˆ©ç”¨æƒ…æŠ¥å¹¶é‡æ–°è®¾è®¡æˆ‘ä»¬çš„çŠ¶æ€ç»“æ„äº†ã€‚ å…³äºæ­¤ä¸»é¢˜<a href="">çš„</a>ææ–™<a href="">å¾ˆå¤š</a> ï¼Œå› æ­¤æˆ‘å»ºè®®ä¸è¦æ»¥ç”¨æ™ºåŠ›ï¼Œè€Œå°†é‡ç‚¹æ”¾åœ¨ç®€å•æ€§ä¸Šã€‚ ä¾‹å¦‚ï¼š <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"page"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"card"</span></span>, //     //       type=card: <span class="hljs-string"><span class="hljs-string">"cardSlug"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, //     <span class="hljs-attr"><span class="hljs-attr">"isFetching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, //      API <span class="hljs-attr"><span class="hljs-attr">"cardData"</span></span>: {...}, //   (  ) // ... }, // ... }</code> </pre><br> è®©æˆ‘ä»¬è·å¾—â€œå¡ç‰‡â€ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å°†cardDataçš„å†…å®¹ä½œä¸ºé“å…·ï¼ˆå®é™…ä¸Šæ˜¯mongoä¸­æˆ‘ä»¬å¡ç‰‡çš„å†…å®¹ï¼‰ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/card.js import React, {Component} from 'react'; class Card extends Component { componentDidMount() { document.title = this.props.name } render() { const {name, html} = this.props; return ( &lt;div&gt; &lt;h1&gt;{name}&lt;/h1&gt; &lt;!---,  HTML  React  - !--&gt; &lt;div dangerouslySetInnerHTML={{__html: html}}/&gt; &lt;/div&gt; ); } } export default Card;</span></span></code> </pre><br> ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å¡ç‰‡è·å–æ•´ä¸ªé¡µé¢çš„ç»„ä»¶ã€‚ ä»–å°†è´Ÿè´£ä»APIä¸­è·å–å¿…è¦çš„æ•°æ®å¹¶å°†å…¶ä¼ è¾“åˆ°Cardã€‚ æˆ‘ä»¬å°†ä»¥React-Reduxæ–¹å¼è¿›è¡Œæ•°æ®è·å–ã€‚ <br><br> é¦–å…ˆï¼Œåˆ›å»ºæ–‡ä»¶<code>frontend/src/redux/actions.js</code>å¹¶åˆ›å»ºä¸€ä¸ªä»APIä¸­æå–å¡ä¸­å†…å®¹çš„æ“ä½œï¼ˆå¦‚æœå°šæœªåˆ›å»ºçš„è¯ï¼‰ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCardIfNeeded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch, getState</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = getState().page; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.cardData === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> || state.cardData.slug !== state.cardSlug) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dispatch(fetchCard()); } }; }</code> </pre><br>  <code>fetchCard</code>æ“ä½œå®é™…ä¸Šä½¿è·å–å·¥ä½œç¨å¾®å¤æ‚ä¸€äº›ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCard</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch, getState</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    ,    . //     , , //    . dispatch(startFetchingCard()); //    API. let url = apiPath() + "/card/" + getState().page.cardSlug; // , ,   ,  //    . , ,  //    . return fetch(url) .then(response =&gt; response.json()) .then(json =&gt; dispatch(finishFetchingCard(json))); }; // ,  redux-thunk   //     . } function startFetchingCard() { return { type: START_FETCHING_CARD }; } function finishFetchingCard(json) { return { type: FINISH_FETCHING_CARD, cardData: json }; } function apiPath() { //    .    server-side // rendering,   API     -  //         localhost, //   backend. return "http://localhost:40001/api/v1"; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å“¦ï¼Œæˆ‘ä»¬é‡‡å–äº†æŸç§æªæ–½ï¼</font><font style="vertical-align: inherit;">åœ¨reducerä¸­å¿…é¡»æ”¯æŒï¼š</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js import { START_FETCHING_CARD, FINISH_FETCHING_CARD } from "./actions"; export default function root(state = {}, action) { switch (action.type) { case START_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: true } }; case FINISH_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: false, cardData: action.cardData } } } return state; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆè¯·æ³¨æ„ç”¨äºé€šè¿‡æ›´æ”¹å•ä¸ªå­—æ®µæ¥å…‹éš†å¯¹è±¡çš„æµè¡Œè¯­æ³•ã€‚ï¼‰</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ—¢ç„¶æ‰€æœ‰é€»è¾‘éƒ½æ˜¯åœ¨Reduxæ“ä½œä¸­æ‰§è¡Œçš„ï¼Œåˆ™ç»„ä»¶æœ¬èº«</font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†çœ‹èµ·æ¥ç›¸å¯¹ç®€å•ï¼š</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/cardPage.js import React, {Component} from 'react'; import {connect} from 'react-redux' import {fetchCardIfNeeded} from '../redux/actions' import Card from './card' class CardPage extends Component { componentWillMount() { //   ,  React  //   .      //   ,    " // "   ,    //  - .    -   //       HTML  // renderToString,      SSR. this.props.dispatch(fetchCardIfNeeded()) } render() { const {isFetching, cardData} = this.props; return ( &lt;div&gt; {isFetching &amp;&amp; &lt;h2&gt;Loading...&lt;/h2&gt;} {cardData &amp;&amp; &lt;Card {...cardData}/&gt;} &lt;/div&gt; ); } } //       ,   //  .        //  react-redux.   page    //  dispatch,   . function mapStateToProps(state) { const {page} = state; return page; } export default connect(mapStateToProps)(CardPage);</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åœ¨æˆ‘ä»¬çš„æ ¹Appç»„ä»¶ä¸­æ·»åŠ ä¸€ä¸ªç®€å•çš„page.typeå¤„ç†ï¼š </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js import React, {Component} from 'react' import {connect} from "react-redux"; import CardPage from "./cardPage" class App extends Component { render() { const {pageType} = this.props; return ( &lt;div&gt; {pageType === "card" &amp;&amp; &lt;CardPage/&gt;} &lt;/div&gt; ); } } function mapStateToProps(state) { const {page} = state; const {type} = page; return { pageType: type }; } export default connect(mapStateToProps)(App);</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæœ€åä¸€åˆ»ä»ç„¶å­˜åœ¨-æ‚¨éœ€è¦ä»¥æŸç§æ–¹å¼è¿›è¡Œåˆå§‹åŒ–</font></font><code>page.type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><code>page.cardSlug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…·ä½“å–å†³äºé¡µé¢çš„URLã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½†æ˜¯æœ¬æ–‡ä»ç„¶æœ‰å¾ˆå¤šéƒ¨åˆ†ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨æ— æ³•æä¾›é«˜è´¨é‡çš„è§£å†³æ–¹æ¡ˆã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬æš‚æ—¶åšå®ƒã€‚</font><font style="vertical-align: inherit;">é‚£å®Œå…¨æ˜¯æ„šè ¢çš„ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œåˆå§‹åŒ–åº”ç”¨ç¨‹åºæ—¶çš„å¸¸è§„ï¼</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' let initialState = { page: { type: "home" } }; const m = /^\/card\/([^\/]+)$/.exec(location.pathname); if (m !== null) { initialState = { page: { type: "card", cardSlug: m[1] }, } } const store = configureStore(initialState); render( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨å¸®åŠ©ä¸‹é‡å»ºå‰ç«¯ï¼Œ</font></font><code>docker-compose up --build frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»¥äº«ç”¨æˆ‘ä»¬çš„å¡äº†</font></font><code>helloworld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€¦â€¦ </font></font><br><br><img src="https://habrastorage.org/webt/vj/qi/iu/vjqiiu9iu3c0ieigltqbu35smfw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç­‰ç­‰ï¼Œç­‰ç­‰â€¦â€¦æˆ‘ä»¬çš„å†…å®¹åœ¨å“ªé‡Œï¼Ÿ</font><font style="vertical-align: inherit;">å“¦ï¼Œæˆ‘ä»¬å¿˜äº†è§£æMarkdownï¼</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å·¥äººï¼šRQ </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§£æMarkdownå¹¶ä¸ºå¯èƒ½æ— é™åˆ¶å¤§å°çš„å¡ç”ŸæˆHTMLæ˜¯ä¸€é¡¹å…¸å‹çš„â€œç¹é‡â€ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡é€šå¸¸åœ¨å•ç‹¬çš„å·¥ä½œæœºä¸Šæ’é˜Ÿå¹¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨ä¿å­˜æ›´æ”¹æ—¶ç›´æ¥åœ¨åç«¯è§£å†³ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»»åŠ¡é˜Ÿåˆ—æœ‰è®¸å¤šå¼€æºå®ç°ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†ä½¿ç”¨Rediså’Œä¸€ä¸ªç®€å•çš„åº“</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆRedis Queueï¼‰ï¼Œè¯¥</font><font style="vertical-align: inherit;">åº“</font><font style="vertical-align: inherit;">ä»¥</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pickle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ ¼å¼ä¼ è¾“ä»»åŠ¡å‚æ•°ï¼Œ</font><font style="vertical-align: inherit;">å¹¶ç»„ç»‡æˆ‘ä»¬çš„äº§åµè¿‡ç¨‹è¿›è¡Œå¤„ç†ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æ—¶å€™æ·»åŠ èåœäº†ï¼Œå…·ä½“å–å†³äºè®¾ç½®å’Œæ¥çº¿ï¼</font></font><br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/requirements.txt +++ b/requirements.txt @@ -3,3 +3,5 @@ flask-cors gevent gunicorn pymongo +redis +rq --- a/backend/dev_settings.py +++ b/backend/dev_settings.py @@ -1,3 +1,7 @@ MONGO_HOST = "mongo" MONGO_PORT = 27017 MONGO_DATABASE = "core" +REDIS_HOST = "redis" +REDIS_PORT = 6379 +REDIS_DB = 0 +TASK_QUEUE_NAME = "tasks" --- a/backend/wiring.py +++ b/backend/wiring.py @@ -2,6 +2,8 @@ import os from pymongo import MongoClient from pymongo.database import Database +import redis +import rq import backend.dev_settings from backend.storage.card import CardDAO @@ -21,3 +23,11 @@ class Wiring(object): port=self.settings.MONGO_PORT) self.mongo_database: Database = self.mongo_client[self.settings.MONGO_DATABASE] self.card_dao: CardDAO = MongoCardDAO(self.mongo_database) + + self.redis: redis.Redis = redis.StrictRedis( + host=self.settings.REDIS_HOST, + port=self.settings.REDIS_PORT, + db=self.settings.REDIS_DB) + self.task_queue: rq.Queue = rq.Queue( + name=self.settings.TASK_QUEUE_NAME, + connection=self.redis)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å·¥äººçš„æ ·æ¿ä»£ç ã€‚ </font></font><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># worker/__main__.py import argparse import uuid import rq import backend.wiring parser = argparse.ArgumentParser(description="Run worker.") #   ,      #  .  ,       rq. parser.add_argument( "--burst", action="store_const", const=True, default=False, help="enable burst mode") args = parser.parse_args() #       Redis. wiring = backend.wiring.Wiring() with rq.Connection(wiring.redis): w = rq.Worker( queues=[wiring.settings.TASK_QUEUE_NAME], #         # ,    . name=uuid.uuid4().hex) w.work(burst=args.burst)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹äºè§£ææœ¬èº«ï¼Œè¿æ¥</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤±è°ƒ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åº“</font><font style="vertical-align: inherit;">å¹¶ç¼–å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼š</font></font><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/tasks/parse.py import mistune from backend.storage.card import CardDAO def parse_card_markup(card_dao: CardDAO, card_id: str): card = card_dao.get_by_id(card_id) card.html = _parse_markdown(card.markdown) card_dao.update(card) _parse_markdown = mistune.Markdown(escape=True, hard_wrap=False)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€»è¾‘ä¸Šï¼šæˆ‘ä»¬éœ€è¦</font></font><code>CardDAO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·å–å¡çš„æºä»£ç å¹¶ä¿å­˜ç»“æœã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯åŒ…å«ä¸å¤–éƒ¨å­˜å‚¨å™¨çš„è¿æ¥çš„å¯¹è±¡æ— æ³•é€šè¿‡pickleè¿›è¡Œåºåˆ—åŒ–-è¿™æ„å‘³ç€è¯¥ä»»åŠ¡æ— æ³•ç«‹å³æ‰§è¡Œå¹¶æ’é˜Ÿç­‰å¾…RQã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸€ç§å¥½çš„æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦</font></font><code>Wiring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ä¾§é¢</font><font style="vertical-align: inherit;">åˆ›å»º</font><font style="vertical-align: inherit;">ä¸€ä¸ªå·¥ä½œå™¨ï¼Œå¹¶å°†å…¶æ‰”ç»™å„ç§å„æ ·â€¦â€¦è®©æˆ‘ä»¬è¿™æ ·åšï¼š</font></font><br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/worker/__main__.py +++ b/worker/__main__.py @@ -2,6 +2,7 @@ import argparse import uuid import rq +from rq.job import Job import backend.wiring @@ -16,8 +17,23 @@ args = parser.parse_args() wiring = backend.wiring.Wiring() + +class JobWithWiring(Job): + + @property + def kwargs(self): + result = dict(super().kwargs) + result["wiring"] = backend.wiring.Wiring() + return result + + @kwargs.setter + def kwargs(self, value): + super().kwargs = value + + with rq.Connection(wiring.redis): w = rq.Worker( queues=[wiring.settings.TASK_QUEUE_NAME], - name=uuid.uuid4().hex) + name=uuid.uuid4().hex, + job_class=JobWithWiring) w.work(burst=args.burst)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬å®£å¸ƒäº†æˆ‘ä»¬çš„å·¥ä½œç±»åˆ«ï¼Œå°†å¸ƒçº¿ä½œä¸ºæ‰€æœ‰é—®é¢˜ä¸­çš„ä¸€ä¸ªé¢å¤–äº‰è®ºã€‚</font><font style="vertical-align: inherit;">ï¼ˆè¯·æ³¨æ„ï¼Œå®ƒæ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿çº¿ï¼Œå› ä¸ºæŸäº›ä»»åŠ¡æ— æ³•åœ¨ä»»åŠ¡å¼€å§‹å¤„ç†ä¹‹å‰åœ¨RQå†…å‘ç”Ÿçš„æ´¾ç”Ÿä¹‹å‰åˆ›å»ºã€‚ï¼‰å› æ­¤ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¸ä¾èµ–äºè¿çº¿-å³ä¾èµ–äºæ‰€æœ‰å¯¹è±¡-è®©æˆ‘ä»¬è®©æˆ‘ä»¬åšä¸€ä¸ªè£…é¥°å™¨ï¼Œå®ƒåªèƒ½ä»å¸ƒçº¿ä¸­è·å¾—å¿…è¦çš„ä¸œè¥¿ï¼š</font></font><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/tasks/task.py import functools from typing import Callable from backend.wiring import Wiring def task(func: Callable): #    : varnames = func.__code__.co_varnames @functools.wraps(func) def result(*args, **kwargs): #  .  .pop(),     # ,        . wiring: Wiring = kwargs.pop("wiring") wired_objects_by_name = wiring.__dict__ for arg_name in varnames: if arg_name in wired_objects_by_name: kwargs[arg_name] = wired_objects_by_name[arg_name] #          #   ,  -   . return func(*args, **kwargs) return result</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ä¸ºæˆ‘ä»¬çš„ä»»åŠ¡æ·»åŠ è£…é¥°å™¨ï¼Œäº«å—ç”Ÿæ´»ï¼š </font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mistune <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> backend.storage.card <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CardDAO <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> backend.tasks.task <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> task @task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_card_markup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(card_dao: CardDAO, card_id: str)</span></span></span><span class="hljs-function">:</span></span> card = card_dao.get_by_id(card_id) card.html = _parse_markdown(card.markdown) card_dao.update(card) _parse_markdown = mistune.Markdown(escape=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, hard_wrap=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº«å—ç”Ÿæ´»ï¼Ÿ</font><font style="vertical-align: inherit;">ghï¼Œæˆ‘æƒ³è¯´ï¼Œæˆ‘ä»¬å¼€å§‹å·¥ä½œäº†ï¼š</font></font><br><br><pre> <code class="plaintext hljs">$ docker-compose up worker ... Creating habr-app-demo_worker_1 ... done Attaching to habr-app-demo_worker_1 worker_1 | 17:21:03 RQ worker 'rq:worker:49a25686acc34cdfa322feb88a780f00' started, version 0.13.0 worker_1 | 17:21:03 *** Listening on tasks... worker_1 | 17:21:03 Cleaning registries for queue: tasks</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IIIâ€¦â€¦ä»–ä»€ä¹ˆéƒ½ä¸åšï¼</font><font style="vertical-align: inherit;">å½“ç„¶ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰è®¾å®šå•ä¸ªä»»åŠ¡ï¼</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®©æˆ‘ä»¬é‡å†™ä¸€ä¸‹åˆ›å»ºæµ‹è¯•å¡çš„å·¥å…·ï¼Œä»¥ä¾¿å®ƒï¼šaï¼‰å¦‚æœå·²ç»åˆ›å»ºäº†æµ‹è¯•å¡ï¼Œå®ƒå°±ä¸ä¼šæ‰ä¸‹æ¥ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼‰ï¼›</font><font style="vertical-align: inherit;">bï¼‰å°†ä»»åŠ¡æ”¾åœ¨marqdownçš„è§£æä¸­ã€‚</font></font><br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py from backend.storage.card import Card, CardNotFound from backend.tasks.parse import parse_card_markup from backend.wiring import Wiring wiring = Wiring() try: card = wiring.card_dao.get_by_slug("helloworld") except CardNotFound: card = wiring.card_dao.create(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. """)) # ,   card_dao.get_or_create,  #      ! wiring.task_queue.enqueue_call( parse_card_markup, kwargs={"card_id": card.id})</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨ï¼Œä¸ä»…å¯ä»¥åœ¨åç«¯è¿è¡Œå·¥å…·ï¼Œè¿˜å¯ä»¥åœ¨å·¥ä½œçº¿ç¨‹ä¸Šè¿è¡Œå·¥å…·ã€‚</font><font style="vertical-align: inherit;">åŸåˆ™ä¸Šï¼Œç°åœ¨æˆ‘ä»¬ä¸åœ¨ä¹ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å¯åŠ¨å®ƒï¼Œ</font></font><code>docker-compose exec worker python -m tools.add_test_content</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶åœ¨ç»ˆç«¯çš„ç›¸é‚»é€‰é¡¹å¡ä¸­çœ‹åˆ°ä¸€ä¸ªå¥‡è¿¹-å·¥äººåšäº†äº›ä»€ä¹ˆï¼</font></font><br><br><pre> <code class="plaintext hljs">worker_1 | 17:34:26 tasks: backend.tasks.parse.parse_card_markup(card_id='5c715dd1e201ce000c6a89fa') (613b53b1-726b-47a4-9c7b-97cad26da1a5) worker_1 | 17:34:27 tasks: Job OK (613b53b1-726b-47a4-9c7b-97cad26da1a5) worker_1 | 17:34:27 Result is kept for 500 seconds</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ç”¨åç«¯é‡å»ºå®¹å™¨ä¹‹åï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°å¡çš„å†…å®¹ï¼š </font></font><br><br><img src="https://habrastorage.org/webt/ii/5f/zb/ii5fzb_nh2p4-hbv7obhjmxr5kk.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å‰ç«¯å¯¼èˆª </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ç»§ç»­è¿›è¡ŒSSRä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä½¿æˆ‘ä»¬æ‰€æœ‰çš„Reactäº‹æƒ…å˜å¾—æœ‰æ„ä¹‰ï¼Œå¹¶ä½¿æˆ‘ä»¬çš„å•é¡µé¢åº”ç”¨ç¨‹åºçœŸæ­£æˆä¸ºä¸€ä¸ªé¡µé¢ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„å·¥å…·ï¼Œä»¥åˆ›å»ºä¸¤ä¸ªå½¼æ­¤é“¾æ¥çš„å¡ï¼ˆâ€œéä¸€ä¸ªï¼Œä¸¤ä¸ªï¼å¦ˆå¦ˆï¼Œæˆ‘ç°åœ¨å¤§æ—¥æœŸï¼â€ï¼‰ï¼Œç„¶åæˆ‘ä»¬å°†å¤„ç†å®ƒä»¬ä¹‹é—´çš„å¯¼èˆªã€‚</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éšè—æ–‡å­—</font></font></b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py def create_or_update(card): try: card.id = wiring.card_dao.get_by_slug(card.slug).id card = wiring.card_dao.update(card) except CardNotFound: card = wiring.card_dao.create(card) wiring.task_queue.enqueue_call( parse_card_markup, kwargs={"card_id": card.id}) create_or_update(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. It can't really compete with the [demo page](demo). """)) create_or_update(Card( slug="demo", name="Demo Card!", markdown=""" Hi there, habrovchanin. You've probably got here from the awkward ["Hello, world" card](helloworld). Well, **good news**! Finally you are looking at a **really cool card**! """ ))</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å•å‡»é“¾æ¥å¹¶è€ƒè™‘æ¯æ¬¡ç²¾ç¾çš„åº”ç”¨ç¨‹åºå¦‚ä½•é‡æ–°å¯åŠ¨ã€‚</font><font style="vertical-align: inherit;">åˆ«è¯´äº† </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é¦–å…ˆï¼Œè®©æ‚¨çš„å¤„ç†ç¨‹åºå•å‡»é“¾æ¥ã€‚</font><font style="vertical-align: inherit;">å› ä¸ºå¸¦æœ‰é“¾æ¥çš„HTMLæ¥è‡ªåç«¯ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨Reactä¸Šæœ‰åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€äº›ç‰¹å®šäºReactçš„ç„¦ç‚¹ã€‚</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/card.js class Card extends Component { componentDidMount() { document.title = this.props.name } navigate(event) { //       .  //      ,    . if (event.target.tagName === 'A' &amp;&amp; event.target.hostname === window.location.hostname) { //     event.preventDefault(); //      this.props.dispatch(navigate(event.target)); } } render() { const {name, html} = this.props; return ( &lt;div&gt; &lt;h1&gt;{name}&lt;/h1&gt; &lt;div dangerouslySetInnerHTML={{__html: html}} onClick={event =&gt; this.navigate(event)} /&gt; &lt;/div&gt; ); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”±äºæ‰€æœ‰å°†é€»è¾‘å¡åŠ è½½åˆ°ç»„ä»¶ä¸­çš„é€»è¾‘</font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œåœ¨æ“ä½œæœ¬èº«ï¼ˆæƒŠäººï¼ï¼‰ä¸­ï¼Œæ— éœ€é‡‡å–ä»»ä½•æ“ä½œï¼š</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navigate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">link</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: NAVIGATE, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: link.pathname } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ·»åŠ ä¸€ä¸ªæ„šè ¢çš„å‡é€Ÿå™¨ï¼š </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js import { START_FETCHING_CARD, FINISH_FETCHING_CARD, NAVIGATE } from "./actions"; function navigate(state, path) { //     react-router,    ! // (       SSR.) let m = /^\/card\/([^/]+)$/.exec(path); if (m !== null) { return { ...state, page: { type: "card", cardSlug: m[1], isFetching: true } }; } return state } export default function root(state = {}, action) { switch (action.type) { case START_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: true } }; case FINISH_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: false, cardData: action.cardData } }; case NAVIGATE: return navigate(state, action.path) } return state; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”±äºç°åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçŠ¶æ€å¯ä»¥æ›´æ”¹ï¼Œå› æ­¤</font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬éœ€è¦æ·»åŠ </font></font><code>componentDidUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸å·²ç»</font><font style="vertical-align: inherit;">æ·»åŠ çš„æ–¹æ³•</font><font style="vertical-align: inherit;">ç›¸åŒ</font><font style="vertical-align: inherit;">çš„æ–¹æ³•</font></font><code>componentWillMount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ç°åœ¨ï¼Œåœ¨æ›´æ–°å±æ€§</font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆä¾‹å¦‚ï¼Œ</font></font><code>cardSlug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¼èˆªæœŸé—´çš„</font><font style="vertical-align: inherit;">å±æ€§</font><font style="vertical-align: inherit;">ï¼‰ä¹‹åï¼Œè¿˜å°†è¯·æ±‚æ¥è‡ªåç«¯çš„å¡çš„å†…å®¹ï¼ˆ</font></font><code>componentWillMount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»…åœ¨åˆå§‹åŒ–ç»„ä»¶æ—¶æ‰</font><font style="vertical-align: inherit;">è¿™æ ·</font><font style="vertical-align: inherit;">åšï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¥½çš„ï¼Œ</font></font><code>docker-compose up --build frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬çš„å¯¼èˆªæ­£å¸¸ï¼</font></font><br><br><img src="https://habrastorage.org/webt/4l/ov/b_/4lovb_vai0fxv0tjx6zfcmwb8y8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»†å¿ƒçš„è¯»è€…ä¼šæ³¨æ„åˆ°ï¼Œåœ¨å¡ç‰‡ä¹‹é—´å¯¼èˆªæ—¶ï¼Œé¡µé¢çš„URLä¸ä¼šæ›´æ”¹-å³ä½¿åœ¨å±å¹•æˆªå›¾ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ¼”ç¤ºå¡åœ°å€ä¸Šçœ‹åˆ°ä¸–ç•Œå¡ç‰‡Helloï¼Œå³ä¸–ç•Œé“¶è¡Œå¡ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œå‰åå¯¼èˆªä¹Ÿä¸‹é™ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬ç«‹å³æ·»åŠ ä¸€äº›å¸¦æœ‰å†å²çš„é»‘é­”æ³•æ¥ä¿®å¤å®ƒï¼</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨å¯ä»¥åšçš„æœ€ç®€å•çš„äº‹æƒ…å°±æ˜¯æ·»åŠ æ“ä½œã€‚</font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŒ‘æˆ˜</font></font><code>history.pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navigate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">link</span></span></span><span class="hljs-function">) </span></span>{ history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, link.href); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: NAVIGATE, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: link.pathname } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨ï¼Œå•å‡»é“¾æ¥æ—¶ï¼Œæµè§ˆå™¨åœ°å€æ ä¸­çš„URLå°†ä¼šçœŸæ­£æ”¹å˜ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œåé€€æŒ‰é’®</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¼šæŸå</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºäº†ä½¿å…¶æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ç›‘å¬</font></font><code>popstate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹è±¡</font><font style="vertical-align: inherit;">çš„äº‹ä»¶</font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ­¤å¤–ï¼Œå¦‚æœåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³å‘åå’Œå‘å‰ï¼ˆå³é€šè¿‡</font></font><code>dispatch(navigate(...))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰</font><font style="vertical-align: inherit;">è¿›è¡Œå¯¼èˆª</font><font style="vertical-align: inherit;">ï¼Œåˆ™å¿…é¡»åœ¨è¯¥å‡½æ•°ä¸Š</font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„â€œè¯·å‹¿</font></font><code>pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€ </font><font style="vertical-align: inherit;">æ ‡å¿—</font><font style="vertical-align: inherit;">ï¼ˆå¦åˆ™æ‰€æœ‰æ“ä½œéƒ½ä¼šä¸­æ–­ï¼ï¼‰ã€‚</font><font style="vertical-align: inherit;">å¦å¤–ï¼Œä¸ºäº†åŒºåˆ†â€œæˆ‘ä»¬çš„â€çŠ¶æ€ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨</font></font><code>pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¿å­˜å…ƒæ•°æ®çš„åŠŸèƒ½ã€‚</font><font style="vertical-align: inherit;">æœ‰å¾ˆå¤šé­”æœ¯å’Œè°ƒè¯•åŠŸèƒ½ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹ç¼–å†™ä»£ç å§ï¼</font><font style="vertical-align: inherit;">ä»¥ä¸‹æ˜¯è¯¥åº”ç”¨ç¨‹åºçš„å¤–è§‚ï¼š</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js class App extends Component { componentDidMount() { //     --   //      "". history.replaceState({ pathname: location.pathname, href: location.href }, ""); //     . window.addEventListener("popstate", event =&gt; this.navigate(event)); } navigate(event) { //    "" ,   //        ,    //   (or is it a good thing?..) if (event.state &amp;&amp; event.state.pathname) { event.preventDefault(); event.stopPropagation(); //      "  pushState". this.props.dispatch(navigate(event.state, true)); } } render() { // ... } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è¿™æ˜¯å¯¼èˆªåŠ¨ä½œï¼š </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js export function navigate(link, dontPushState) { if (!dontPushState) { history.pushState({ pathname: link.pathname, href: link.href }, "", link.href); } return { type: NAVIGATE, path: link.pathname } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæ•…äº‹å°†èµ·ä½œç”¨ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¥½å§ï¼Œæœ€åä¸€ç‚¹ï¼šæ—¢ç„¶æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªaction </font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸æ”¾å¼ƒå®¢æˆ·ç«¯ä¸­ç”¨äºè®¡ç®—åˆå§‹çŠ¶æ€çš„é¢å¤–ä»£ç å‘¢ï¼Ÿ</font><font style="vertical-align: inherit;">æˆ‘ä»¬å¯ä»¥è‡´ç”µå®šä½åˆ°å½“å‰ä½ç½®ï¼š</font></font><br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/src/client.js +++ b/frontend/src/client.js @@ -3,23 +3,16 @@ import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' +import {navigate} from "./redux/actions"; let initialState = { page: { type: "home" } }; -const m = /^\/card\/([^\/]+)$/.exec(location.pathname); -if (m !== null) { - initialState = { - page: { - type: "card", - cardSlug: m[1] - }, - } -} const store = configureStore(initialState); +store.dispatch(navigate(location));</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å¤åˆ¶ç²˜è´´å·²é”€æ¯ï¼ </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å‰ç«¯ï¼šæœåŠ¡å™¨ç«¯æ¸²æŸ“ </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æ—¶å€™ä½¿ç”¨æˆ‘ä»¬çš„ä¸»è¦èŠ¯ç‰‡äº†ï¼ˆæˆ‘è®¤ä¸ºï¼‰-SEOå‹å¥½ã€‚ä¸ºäº†ä½¿æœç´¢å¼•æ“å¯ä»¥ç´¢å¼•æˆ‘ä»¬çš„å†…å®¹ï¼Œè¯¥å†…å®¹æ˜¯åœ¨Reactç»„ä»¶ä¸­å®Œå…¨åŠ¨æ€åˆ›å»ºçš„ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿä¸ºå®ƒä»¬æä¾›å‘ˆç°Reactçš„ç»“æœï¼Œè¿˜éœ€è¦å­¦ä¹ å¦‚ä½•ä½¿è¯¥ç»“æœå†æ¬¡å…·æœ‰äº¤äº’æ€§ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€šç”¨æ–¹æ¡ˆå¾ˆç®€å•ã€‚é¦–å…ˆï¼šæˆ‘ä»¬éœ€è¦å°†Reactç»„ä»¶ç”Ÿæˆçš„HTMLæ’å…¥HTMLæ¨¡æ¿ä¸­</font></font><code>App</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚æœç´¢å¼•æ“ï¼ˆä»¥åŠç¦ç”¨JSçš„æµè§ˆå™¨ï¼Œå¯ä»¥çœ‹åˆ°æ­¤HTMLï¼‰ã€‚ç¬¬äºŒï¼šåœ¨æ¨¡æ¿</font></font><code>&lt;script&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­</font><font style="vertical-align: inherit;">æ·»åŠ ä¸€ä¸ªæ ‡è®°ï¼Œä»¥å°†</font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çŠ¶æ€è½¬å‚¨</font><font style="vertical-align: inherit;">ä¿å­˜åˆ°æŸä¸ªä½ç½®ï¼ˆä¾‹å¦‚ï¼Œobject </font><font style="vertical-align: inherit;">ï¼‰ï¼Œä»è¯¥çŠ¶æ€è½¬å‚¨æ­¤HTMLã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³ä»¥è¿™ç§çŠ¶æ€åœ¨å®¢æˆ·ç«¯åˆå§‹åŒ–æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå¹¶æ˜¾ç¤ºéœ€è¦ä»€ä¹ˆï¼ˆæˆ‘ä»¬ç”šè‡³å¯ä»¥åº”ç”¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ°´åˆç‰©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ°ç”Ÿæˆçš„HTMLï¼Œä»¥å…é‡æ–°åˆ›å»ºåº”ç”¨ç¨‹åºçš„DOMæ ‘ï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®©æˆ‘ä»¬ä»ç¼–å†™ä¸€ä¸ªè¿”å›æ¸²æŸ“çš„HTMLå’Œæœ€ç»ˆçŠ¶æ€çš„å‡½æ•°å¼€å§‹ã€‚</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/server.js import "@babel/polyfill" import React from 'react' import {renderToString} from 'react-dom/server' import {Provider} from 'react-redux' import App from './components/app' import {navigate} from "./redux/actions"; import configureStore from "./redux/configureStore"; export default function render(initialState, url) { //  store,    . const store = configureStore(initialState); store.dispatch(navigate(url)); let app = ( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt; ); // ,        ! // ,         ? let content = renderToString(app); let preloadedState = store.getState(); return {content, preloadedState}; };</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åœ¨æˆ‘ä»¬ä¸Šé¢è®¨è®ºè¿‡çš„æ¨¡æ¿ä¸­æ·»åŠ æ–°çš„å‚æ•°å’Œé€»è¾‘ï¼š </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/template.js function template(title, initialState, content) { let page = ` &lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;${title}&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="app"&gt;${content}&lt;/div&gt; &lt;script&gt; window.__STATE__ = ${JSON.stringify(initialState)} &lt;/script&gt; &lt;script src="/dist/client.js"&gt;&lt;/script&gt; &lt;/body&gt; &lt;/html&gt; `; return page; } module.exports = template;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æˆ‘ä»¬çš„ExpressæœåŠ¡å™¨å˜å¾—æ›´åŠ å¤æ‚ï¼š </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js app.get("*", (req, res) =&gt; { const initialState = { page: { type: "home" } }; const {content, preloadedState} = render(initialState, {pathname: req.url}); res.send(template("Habr demo app", preloadedState, content)); });</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ä½†æ˜¯å®¢æˆ·ç«¯æ›´å®¹æ˜“ï¼š </font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {hydrate} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' import {navigate} from "./redux/actions"; //         ! const store = configureStore(window.__STATE__); // render   hydrate. hydrate    // DOM tree,       . hydrate( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦æ¸…é™¤è·¨å¹³å°é”™è¯¯ï¼Œä¾‹å¦‚â€œæœªå®šä¹‰å†å²è®°å½•â€ã€‚</font><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œè¯·åœ¨ä¸­çš„æŸä¸ªä½ç½®æ·»åŠ ä¸€ä¸ªç®€å•çš„ï¼ˆåˆ°ç›®å‰ä¸ºæ­¢ï¼‰å‡½æ•°</font></font><code>utility.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/utility.js export function isServerSide() { //   ,      process, //     -   . return process.env.APP_ENV !== undefined; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç„¶åä¼šæœ‰ä¸€äº›å¸¸è§„æ›´æ”¹ï¼Œæˆ‘ä¸ä¼šåœ¨è¿™é‡Œè¿›è¡Œï¼ˆä½†æ˜¯å¯ä»¥åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç›¸åº”çš„commitä¸­</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰¾åˆ°</font><font style="vertical-align: inherit;">ï¼‰ã€‚</font><font style="vertical-align: inherit;">ç»“æœï¼Œæˆ‘ä»¬çš„Reactåº”ç”¨ç¨‹åºå°†èƒ½å¤Ÿåœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¸Šè¿›è¡Œæ¸²æŸ“ã€‚</font></font><br><br> æœ‰æ•ˆï¼<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œæ­£å¦‚ä»–ä»¬æ‰€è¯´ï¼Œæœ‰ä¸€ä¸ªè­¦å‘Š...æ­£åœ¨</font></font><br><br><img src="https://habrastorage.org/webt/gd/ac/ut/gdacut18knqjvzftjhkkuhnzxgk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŠ è½½ï¼Ÿ Googleåœ¨æˆ‘è¶…é…·çš„æ—¶å°šæœåŠ¡ä¸Šçœ‹åˆ°çš„å°±æ˜¯LOADING ï¼Ÿï¼</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¥½å§ï¼Œä¼¼ä¹æˆ‘ä»¬æ‰€æœ‰çš„å¼‚æ­¥æ€§éƒ½å¯¹æˆ‘ä»¬ä¸åˆ©ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§è®©æœåŠ¡å™¨ç†è§£çš„æ–¹æ³•ï¼Œå³åœ¨å°†Reactåº”ç”¨ç¨‹åºå‘ˆç°ä¸ºå­—ç¬¦ä¸²å¹¶å°†å…¶å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼Œéœ€è¦ç­‰å¾…åç«¯çš„å“åº”ä»¥åŠå¡çš„å†…å®¹ã€‚å¹¶ä¸”å¸Œæœ›è¯¥æ–¹æ³•ç›¸å½“é€šç”¨ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯èƒ½æœ‰å¾ˆå¤šè§£å†³æ–¹æ¡ˆã€‚ä¸€ç§æ–¹æ³•æ˜¯åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­æè¿°åº”ä¿æŠ¤å“ªäº›æ•°æ®çš„è·¯å¾„ï¼Œå¹¶åœ¨å‘ˆç°åº”ç”¨ç¨‹åºä¹‹å‰æ‰§è¡Œæ­¤æ“ä½œï¼ˆ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–‡ç« </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚è¯¥è§£å†³æ–¹æ¡ˆå…·æœ‰è®¸å¤šä¼˜ç‚¹ã€‚å®ƒå¾ˆç®€å•ï¼Œå¾ˆæ˜ç¡®ï¼Œè€Œä¸”è¡Œå¾—é€šã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½œä¸ºä¸€ä¸ªå®éªŒï¼ˆåŸå§‹å†…å®¹åº”è¯¥è‡³å°‘åœ¨æ–‡ç« ä¸­çš„æŸä¸ªä½ç½®ï¼ï¼‰ï¼Œæˆ‘æå‡ºäº†å¦ä¸€ç§æ–¹æ¡ˆã€‚</font><font style="vertical-align: inherit;">æ¯æ¬¡æˆ‘ä»¬è¿è¡Œå¼‚æ­¥æ“ä½œæ—¶ï¼ˆå¿…é¡»ç­‰å¾…ï¼‰ï¼Œåœ¨çŠ¶æ€ä¸­çš„æŸä¸ªä½ç½®æ·»åŠ é€‚å½“çš„æ‰¿è¯ºï¼ˆä¾‹å¦‚ï¼Œè¿”å›è·å–çš„æ‰¿è¯ºï¼‰ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘ä»¬å°†æä¾›ä¸€ä¸ªåœ°æ–¹ï¼Œæ‚¨å¯ä»¥éšæ—¶æ£€æŸ¥æ‰€æœ‰å†…å®¹æ˜¯å¦å·²ä¸‹è½½ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ·»åŠ ä¸¤ä¸ªæ–°æ“ä½œã€‚</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js function addPromise(promise) { return { type: ADD_PROMISE, promise: promise }; } function removePromise(promise) { return { type: REMOVE_PROMISE, promise: promise, }; }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯åŠ¨æå–æ—¶å°†è°ƒç”¨ç¬¬ä¸€ä¸ªï¼Œç¬¬äºŒä¸ªå°†åœ¨è°ƒç”¨ç»“æŸæ—¶è°ƒç”¨</font></font><code>.then()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨å°†å…¶å¤„ç†æ·»åŠ åˆ°å‡é€Ÿå™¨ä¸­ï¼š</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js export default function root(state = {}, action) { switch (action.type) { case ADD_PROMISE: return { ...state, promises: [...state.promises, action.promise] }; case REMOVE_PROMISE: return { ...state, promises: state.promises.filter(p =&gt; p !== action.promise) }; ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæˆ‘ä»¬å°†æ”¹å–„æ“ä½œ</font></font><code>fetchCard</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js function fetchCard() { return (dispatch, getState) =&gt; { dispatch(startFetchingCard()); let url = apiPath() + "/card/" + getState().page.cardSlug; let promise = fetch(url) .then(response =&gt; response.json()) .then(json =&gt; { dispatch(finishFetchingCard(json)); // " ,  " dispatch(removePromise(promise)); }); // "  ,  " return dispatch(addPromise(promise)); }; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»ç„¶éœ€è¦å‘</font></font><code>initialState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç©ºæ•°ç»„ä¸­</font><font style="vertical-align: inherit;">æ·»åŠ </font><font style="vertical-align: inherit;">æ‰¿è¯ºï¼Œå¹¶ä½¿æœåŠ¡å™¨ç­‰å¾…æ‰€æœ‰æ‰¿è¯ºï¼</font><font style="vertical-align: inherit;">æ¸²æŸ“å‡½æ•°å˜ä¸ºå¼‚æ­¥ï¼Œå¹¶é‡‡ç”¨ä»¥ä¸‹å½¢å¼ï¼š</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/server.js function hasPromises(state) { return state.promises.length &gt; 0 } export default async function render(initialState, url) { const store = configureStore(initialState); store.dispatch(navigate(url)); let app = ( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt; ); //  renderToString     // (  ). CardPage     . renderToString(app); // ,   !    - //    (  // , ),     //    . let preloadedState = store.getState(); while (hasPromises(preloadedState)) { await preloadedState.promises[0]; preloadedState = store.getState() } //  renderToString.    HTML. let content = renderToString(app); return {content, preloadedState}; };</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”±äºè·å¾—äº†</font></font><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¼‚æ­¥ï¼Œå› æ­¤è¯·æ±‚å¤„ç†ç¨‹åºä¹Ÿç¨å¾®å¤æ‚ä¸€äº›ï¼š</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js app.get("*", (req, res) =&gt; { const initialState = { page: { type: "home" }, promises: [] }; render(initialState, {pathname: req.url}).then(result =&gt; { const {content, preloadedState} = result; const response = template("Habr demo app", preloadedState, content); res.send(response); }, (reason) =&gt; { console.log(reason); res.status(500).send("Server side rendering failed!"); }); });</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ç­‰ç­‰ï¼ </font></font><br><br><img src="https://habrastorage.org/webt/vt/ed/uj/vteduj-6tnshnodaw0setd3b0wu.png"><br><br><h2> ç»“è®º </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æ‚¨æ‰€è§ï¼Œåˆ›å»ºé«˜ç§‘æŠ€åº”ç”¨ç¨‹åºå¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯æ²¡æœ‰é‚£ä¹ˆå›°éš¾ï¼</font><font style="vertical-align: inherit;">æœ€ç»ˆçš„åº”ç”¨ç¨‹åºä½äº</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Githubä¸Š</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">å­˜å‚¨åº“ä¸­</font></a><font style="vertical-align: inherit;">ï¼Œä»ç†è®ºä¸Šè®²ï¼Œæ‚¨åªéœ€è¦Dockerå³å¯è¿è¡Œå®ƒã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœéœ€è¦è¯¥æ–‡ç« ï¼Œåˆ™ç”šè‡³ä¸ä¼šæ”¾å¼ƒè¯¥å­˜å‚¨åº“ï¼</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†èƒ½å¤Ÿé€šè¿‡å…¶ä»–å¿…è¦çš„çŸ¥è¯†æ¥ç ”ç©¶å®ƒï¼š</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è®°å½•ï¼Œç›‘è§†ï¼Œè´Ÿè½½æµ‹è¯•ã€‚ </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æµ‹è¯•ï¼ŒCIï¼ŒCDã€‚ </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æˆæƒæˆ–å…¨æ–‡æœç´¢ç­‰æ›´é…·çš„åŠŸèƒ½ã€‚ </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å»ºç«‹å’Œå¼€å‘ç”Ÿäº§ç¯å¢ƒã€‚ </font></font></li></ul><br> æ„Ÿè°¢æ‚¨çš„å…³æ³¨ï¼ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN444446/">https://habr.com/ru/post/zh-CN444446/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN444434/index.html">Java 12çš„æ—¶æœºå·²åˆ°ï¼ çƒ­é—¨JEPçš„è¯„è®º</a></li>
<li><a href="../zh-CN444436/index.html">ä»€ä¹ˆæ˜¯Miraiåƒµå°¸ç½‘ç»œï¼Œå¦‚ä½•ä¿æŠ¤æˆ‘çš„è®¾å¤‡ï¼Ÿ</a></li>
<li><a href="../zh-CN444438/index.html">å¼€æºç®€å²-è‡ªç”±è½¯ä»¶ä¸ä¸“æœ‰è½¯ä»¶çš„å¯¹æŠ—</a></li>
<li><a href="../zh-CN444442/index.html">Jetson Nanoï¼šNvidiaæœºå™¨å­¦ä¹ å•æ¿</a></li>
<li><a href="../zh-CN444444/index.html">æˆ‘ä»¬ä¼šè®®ä¸­æœ€å¥½çš„å¤±è´¥ï¼ˆå°ä¸‘ï¼ŒJPointï¼ŒDotNextï¼ŒMobiusï¼ŒTechTrainç­‰ï¼‰</a></li>
<li><a href="../zh-CN444448/index.html">Mirai Cloneä¸ºç›®æ ‡ä¼ä¸šç‰©è”ç½‘è®¾å¤‡å¢åŠ äº†æ•°åä¸ªæ–°æ¼æ´</a></li>
<li><a href="../zh-CN444456/index.html">Atari 65XE-USBé”®ç›˜</a></li>
<li><a href="../zh-CN444460/index.html">ä»Pythonå‰§é™¢æµ·æŠ¥çš„è§£æå™¨åˆ°Telegramæœºå™¨äººã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN444462/index.html">æµ‹è¯•ä¸‰æ˜ŸGalaxy S10-æ™ºèƒ½æ‰‹æœºä½•æ—¶ä¼šèµ¶ä¸Šç›¸æœºï¼Ÿ</a></li>
<li><a href="../zh-CN444464/index.html">å¦ä¸€ç§ä½¿ç”¨std :: threadå°„è…¿çš„æ–¹æ³•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>