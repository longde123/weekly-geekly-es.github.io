<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒ² ğŸ‘©â€ğŸ‘©â€ğŸ‘¦ ğŸ—ï¸ æˆ‘ä»¬å¦‚ä½•å°†æœåŠ¡çš„é…ç½®ä»XMLè½¬æ¢ä¸ºYAML ğŸŒ‘ ğŸ’†ğŸ¿ ğŸ‘¨ğŸ¼â€ğŸ’»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="èƒŒæ™¯çŸ¥è¯† 
 é™¤å…¶ä»–äº‹é¡¹å¤–ï¼Œæˆ‘ä»¬å…¬å¸å·²å¼€å‘äº†å‡ ç§æœåŠ¡ï¼ˆæ›´ç¡®åˆ‡åœ°è¯´æ˜¯12ç§ï¼‰ï¼Œå¯ä½œä¸ºæˆ‘ä»¬ç³»ç»Ÿçš„åç«¯ã€‚ æ¯ä¸ªæœåŠ¡éƒ½æ˜¯WindowsæœåŠ¡ï¼Œå¹¶æ‰§è¡Œå…¶ç‰¹å®šä»»åŠ¡ã€‚ 

 æˆ‘æƒ³å°†æ‰€æœ‰è¿™äº›æœåŠ¡è½¬ç§»åˆ°* nix-OSã€‚ ä¸ºæ­¤ï¼Œè¯·æ”¾å¼ƒWindowsæœåŠ¡å½¢å¼çš„åŒ…è£…ï¼Œç„¶åä».NET Frameworkåˆ‡æ¢åˆ°.NET Sta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘ä»¬å¦‚ä½•å°†æœåŠ¡çš„é…ç½®ä»XMLè½¬æ¢ä¸ºYAML</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/utex/blog/438362/"><h2> èƒŒæ™¯çŸ¥è¯† </h2><br> é™¤å…¶ä»–äº‹é¡¹å¤–ï¼Œæˆ‘ä»¬å…¬å¸å·²å¼€å‘äº†å‡ ç§æœåŠ¡ï¼ˆæ›´ç¡®åˆ‡åœ°è¯´æ˜¯12ç§ï¼‰ï¼Œå¯ä½œä¸ºæˆ‘ä»¬ç³»ç»Ÿçš„åç«¯ã€‚ æ¯ä¸ªæœåŠ¡éƒ½æ˜¯WindowsæœåŠ¡ï¼Œå¹¶æ‰§è¡Œå…¶ç‰¹å®šä»»åŠ¡ã€‚ <br><br> æˆ‘æƒ³å°†æ‰€æœ‰è¿™äº›æœåŠ¡è½¬ç§»åˆ°* nix-OSã€‚ ä¸ºæ­¤ï¼Œè¯·æ”¾å¼ƒWindowsæœåŠ¡å½¢å¼çš„åŒ…è£…ï¼Œç„¶åä».NET Frameworkåˆ‡æ¢åˆ°.NET Standardã€‚ <br><br> æœ€åä¸€ä¸ªè¦æ±‚å¯¼è‡´éœ€è¦æ‘†è„±ä¸€äº›æ—§ç‰ˆä»£ç ï¼Œ.NET Standardä¸­ä¸æ”¯æŒè¯¥æ—§ç‰ˆä»£ç ï¼ŒåŒ…æ‹¬ æ”¯æŒé€šè¿‡XMLé…ç½®æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨System.Configurationä¸­çš„ç±»å®ç°ã€‚ åŒæ—¶ï¼Œè¿™è§£å†³äº†ä¸€ä¸ªé•¿æœŸå­˜åœ¨çš„é—®é¢˜ï¼Œè¯¥é—®é¢˜æ¶‰åŠä»¥ä¸‹äº‹å®ï¼šåœ¨XML-configsä¸­ï¼Œæ›´æ”¹è®¾ç½®æ—¶æœ‰æ—¶ä¼šçŠ¯é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œæœ‰æ—¶æˆ‘ä»¬å°†ç»“æŸæ ‡è®°æ”¾åœ¨é”™è¯¯çš„ä½ç½®æˆ–å®Œå…¨å¿˜è®°äº†å®ƒï¼‰ï¼Œä½†å´æ˜¯System.Xml XML-configsçš„ç»ä½³é˜…è¯»è€…ã€‚ XmlDocumenté»˜é»˜åœ°åä¸‹äº†æ­¤ç±»é…ç½®ï¼Œä»è€Œäº§ç”Ÿäº†å®Œå…¨æ— æ³•é¢„æµ‹çš„ç»“æœã€‚ <br><br> å†³å®šé€šè¿‡æµè¡Œçš„YAMLåˆ‡æ¢åˆ°é…ç½®ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é¢ä¸´å“ªäº›é—®é¢˜ä»¥åŠå¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ã€‚ <br><a name="habracut"></a><br><h2> æˆ‘ä»¬æœ‰ä»€ä¹ˆ </h2><br><h3> æˆ‘ä»¬å¦‚ä½•ä»XMLè¯»å–é…ç½® </h3><br> å¯¹äºå¤§å¤šæ•°å…¶ä»–é¡¹ç›®ï¼Œæˆ‘ä»¬ä»¥æ ‡å‡†æ–¹å¼è¯»å–XMLã€‚ <br><br> æ¯ä¸ªæœåŠ¡éƒ½æœ‰ä¸€ä¸ª.NETé¡¹ç›®çš„è®¾ç½®æ–‡ä»¶ï¼Œç§°ä¸ºAppSettings.csï¼Œå…¶ä¸­åŒ…å«è¯¥æœåŠ¡æ‰€éœ€çš„æ‰€æœ‰è®¾ç½®ã€‚ åƒè¿™æ ·ï¼š <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">System.Configuration.SettingsProvider(typeof(PortableSettingsProvider))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppSettings</span></span> : <span class="hljs-title"><span class="hljs-title">IServerManagerConfigStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IWebSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IServerSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IGraphiteAddressStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IDatabaseConfigStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IBlackListStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IKeyCloackConfigFilePathProvider</span></span>, <span class="hljs-title"><span class="hljs-title">IPrometheusSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IMetricsConfig</span></span> { }</code> </pre> <br><br> å°†è®¾ç½®åˆ†ä¸ºç•Œé¢çš„ç±»ä¼¼æŠ€æœ¯å¯ä»¥æ–¹ä¾¿ä»¥åé€šè¿‡DIå®¹å™¨ä½¿ç”¨å®ƒä»¬ã€‚ <br><br> å®é™…ä¸Šï¼Œå­˜å‚¨è®¾ç½®çš„æ‰€æœ‰ä¸»è¦é­”æœ¯éƒ½éšè—åœ¨PortableSettingsProviderä¸­ï¼ˆè¯·å‚é˜…classå±æ€§ï¼‰ä»¥åŠè®¾è®¡å™¨æ–‡ä»¶AppSettings.Designer.csä¸­ï¼š <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.CodeDom.Compiler.GeneratedCodeAttribute(<span class="hljs-string"><span class="hljs-string">"Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator"</span></span>, <span class="hljs-string"><span class="hljs-string">"14.0.0.0"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppSettings</span></span> : <span class="hljs-title"><span class="hljs-title">global</span></span>::<span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Configuration</span></span>.<span class="hljs-title"><span class="hljs-title">ApplicationSettingsBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings defaultInstance = ((AppSettings)(<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.ApplicationSettingsBase.Synchronized(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppSettings()))); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings Default { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultInstance; } } [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.UserScopedSettingAttribute()] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Diagnostics.DebuggerNonUserCodeAttribute()] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.DefaultSettingValueAttribute(<span class="hljs-string"><span class="hljs-string">"35016"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ListenPort { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"ListenPort"</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"ListenPort"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } ...</code> </pre><br> å¦‚æ‚¨æ‰€è§ï¼Œâ€œå¹•åâ€éšè—äº†æ‰€æœ‰é€šè¿‡Visual Studioä¸­çš„è®¾ç½®è®¾è®¡å™¨ç¼–è¾‘æœåŠ¡å™¨é…ç½®æ—¶æ·»åŠ åˆ°æœåŠ¡å™¨é…ç½®çš„å±æ€§ã€‚ <br><br> ä¸Šé¢æåˆ°çš„æˆ‘ä»¬çš„PortableSettingsProviderç±»ç›´æ¥è¯»å–XMLæ–‡ä»¶ï¼Œå¹¶ä¸”è¯»å–ç»“æœå·²åœ¨SettingsProviderä¸­ç”¨äºå°†è®¾ç½®å†™å…¥AppSettingså±æ€§ã€‚ <br><br> æˆ‘ä»¬æ­£åœ¨é˜…è¯»çš„XMLé…ç½®ç¤ºä¾‹ï¼ˆå‡ºäºå®‰å…¨åŸå› ï¼Œå¤§å¤šæ•°è®¾ç½®éƒ½è¢«éšè—äº†ï¼‰ï¼š <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sectionGroup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userSettings"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Configuration.UserSettingsGroup"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MetricServer.Properties.Settings"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Configuration.ClientSettingsSection"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sectionGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">userSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MetricServer.Properties.Settings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MCXSettings"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serializeAs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"String"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>Inactive, ChartLen: 1000, PrintLen: 50, UseProxy: False<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"KickUnknownAfter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serializeAs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"String"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>00:00:10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MetricServer.Properties.Settings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">userSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h3> æˆ‘æƒ³é˜…è¯»å“ªäº›YAMLæ–‡ä»¶ </h3><br> åƒè¿™æ ·ï¼š <br><br><pre> <code class="plaintext hljs">VirtualFeed: MaxChartHistoryLength: 10 Port: 35016 UseThrottling: True ThrottlingIntervalMs: 50000 UseHistoryBroadcast: True CalendarName: "EmptyCalendar" UsMarketFeed: UseImbalances: True</code> </pre><br><h3> è¿‡æ¸¡é—®é¢˜ </h3><br>  <b>é¦–å…ˆï¼Œ</b> XMLä¸­<b>çš„</b>é…ç½®æ˜¯â€œæ‰å¹³çš„â€ï¼Œä½†åœ¨YAMLä¸­åˆ™ä¸æ˜¯ï¼ˆæ”¯æŒèŠ‚å’Œå°èŠ‚ï¼‰ã€‚ åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚ ä½¿ç”¨XMLï¼Œæˆ‘ä»¬é€šè¿‡å¼•å…¥è‡ªå·±çš„è§£æå™¨è§£å†³äº†å¹³é¢è®¾ç½®çš„é—®é¢˜ï¼Œè¯¥è§£æå™¨å¯ä»¥å°†æŸç§ç±»å‹çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ›´å¤æ‚çš„ç±»ã€‚ è¿™æ ·çš„å¤æ‚å­—ç¬¦ä¸²çš„ç¤ºä¾‹ï¼š <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MCXSettings"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serializeAs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"String"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>Inactive, ChartLen: 1000, PrintLen: 50, UseProxy: False<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br> ä½¿ç”¨YAMLæ—¶ï¼Œæˆ‘ä¸å¸Œæœ›è¿›è¡Œæ­¤ç±»è½¬æ¢ã€‚ ä½†æ˜¯åŒæ—¶ï¼Œæˆ‘ä»¬å—åˆ°AppSettingsç±»ç°æœ‰çš„â€œæ‰å¹³â€ç»“æ„çš„é™åˆ¶ï¼šè¯¥ç±»ä¸­è®¾ç½®çš„æ‰€æœ‰å±æ€§éƒ½å †ç§¯åœ¨ä¸€ä¸ªå †ä¸­ã€‚ <br><br>  <b>å…¶æ¬¡ï¼Œ</b>æˆ‘ä»¬çš„æœåŠ¡å™¨é…ç½®ä¸æ˜¯é™æ€çš„æ•´ä½“é…ç½®ï¼Œæˆ‘ä»¬ä¼šåœ¨æœåŠ¡å™¨å·¥ä½œæœŸé—´ï¼ˆå³ï¼Œ è¿™äº›æ›´æ”¹éœ€è¦èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€æ•æ‰ã€‚ ä¸ºæ­¤ï¼Œåœ¨XMLå®ç°ä¸­ï¼Œæˆ‘ä»¬ä»INotifyPropertyChangedç»§æ‰¿äº†AppSettingsï¼ˆå®é™…ä¸Šï¼Œå®ç°AppSettingsçš„æ¯ä¸ªæ¥å£éƒ½ç»§æ‰¿è‡ªå®ƒï¼‰ï¼Œå¹¶è®¢é˜…è®¾ç½®å±æ€§äº‹ä»¶çš„æ›´æ–°ã€‚ è¿™ç§æ–¹æ³•ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œæ˜¯å› ä¸ºç°æˆçš„åŸºç±»System.Configuration.ApplicationSettingsBaseå®ç°äº†INotifyPropertyChangedã€‚ è¿‡æ¸¡åˆ°YAMLåï¼Œå¿…é¡»ä¿æŒç±»ä¼¼çš„è¡Œä¸ºã€‚ <br><br>  <b>ç¬¬ä¸‰ï¼Œ</b>å®é™…ä¸Šæ¯ä¸ªæœåŠ¡å™¨æ²¡æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼šä¸€ä¸ªå…·æœ‰é»˜è®¤è®¾ç½®ï¼Œå¦ä¸€ä¸ªå…·æœ‰è¢«è¦†ç›–çš„è®¾ç½®ã€‚ è¿™æ˜¯å¿…éœ€çš„ï¼Œä»¥ä¾¿åœ¨ç›¸åŒç±»å‹çš„æœåŠ¡å™¨çš„å¤šä¸ªå®ä¾‹ä¸­çš„æ¯ä¸ªå®ä¾‹ä¸­ï¼Œä¾¦å¬ä¸åŒçš„ç«¯å£å¹¶ä¸”è®¾ç½®ç¨æœ‰ä¸åŒï¼Œæ‚¨ä¸å¿…å®Œå…¨å¤åˆ¶æ•´ä¸ªè®¾ç½®ã€‚ <br><br>  <b>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜</b> -ä¸ä»…å¯ä»¥é€šè¿‡ç•Œé¢è®¿é—®è®¾ç½®ï¼Œè¿˜å¯ä»¥é€šè¿‡ç›´æ¥è®¿é—®AppSettings.Defaultæ¥è®¿é—®è®¾ç½®ã€‚ è®©æˆ‘æé†’æ‚¨å¦‚ä½•åœ¨åå°AppSettings.Designer.csä¸­å£°æ˜å®ƒï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings defaultInstance = ((AppSettings)(<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.ApplicationSettingsBase.Synchronized(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppSettings()))); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings Default { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultInstance; } }</code> </pre><br> åŸºäºä¸Šè¿°å†…å®¹ï¼Œæœ‰å¿…è¦æå‡ºä¸€ç§åœ¨AppSettingsä¸­å­˜å‚¨è®¾ç½®çš„æ–°æ–¹æ³•ã€‚ <br><br><h2> è§£å†³æ–¹æ¡ˆ </h2><br><h3> å·¥å…·åŒ… </h3><br> ä¸ºäº†ç›´æ¥é˜…è¯»ï¼ŒYAMLå†³å®šä½¿ç”¨é€šè¿‡NuGetæä¾›çš„ç°æˆåº“ï¼š <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">YamlDotNet-github.com/aaubry/YamlDotNet</a> ã€‚ ä»åº“æè¿°ï¼ˆç¿»è¯‘ï¼‰ï¼š <br><blockquote>  YamlDotNetæ˜¯YAMLçš„.NETåº“ã€‚  YamlDotNetæä¾›äº†ä½çº§è§£æå™¨å’ŒYAMLç”Ÿæˆå™¨ï¼Œä»¥åŠç±»ä¼¼äºXmlDocumentçš„é«˜çº§å¯¹è±¡æ¨¡å‹ã€‚ è¿˜åŒ…æ‹¬ä¸€ä¸ªåºåˆ—åŒ–åº“ï¼Œä½¿æ‚¨å¯ä»¥ä»YAMLæµä¸­è¯»å–å¯¹è±¡æˆ–å°†å¯¹è±¡å†™å…¥YAMLæµã€‚ </blockquote><br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NetEscapades.Configuration-github.com/andrewlock/NetEscapades.Configuration</a> ã€‚ è¿™æ˜¯é…ç½®æä¾›ç¨‹åºæœ¬èº«ï¼ˆå°±Microsoft.Extensions.Configuration.IConfigurationSourceè€Œè¨€ï¼Œåœ¨ASP.NET Coreåº”ç”¨ç¨‹åºä¸­æ´»è·ƒä½¿ç”¨ï¼‰ï¼Œå®ƒä»…ä½¿ç”¨ä¸Šè¿°YamlDotNetè¯»å–YAMLæ–‡ä»¶ã€‚ <br></li></ul><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>é˜…è¯»æœ‰å…³å¦‚ä½•ä½¿ç”¨è¿™äº›åº“çš„æ›´å¤šä¿¡æ¯ã€‚ <br><br><h3> è¿‡æ¸¡åˆ°YAML </h3><br> è¿‡æ¸¡æœ¬èº«åˆ†ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œï¼šé¦–å…ˆï¼Œæˆ‘ä»¬ç®€å•åœ°ä»XMLåˆ‡æ¢åˆ°YAMLï¼Œä½†æ˜¯ä¿ç•™äº†é…ç½®æ–‡ä»¶çš„ç»Ÿä¸€å±‚æ¬¡ç»“æ„ï¼Œç„¶ååœ¨YAMLæ–‡ä»¶ä¸­è¾“å…¥äº†éƒ¨åˆ†ã€‚ ä»åŸåˆ™ä¸Šè®²ï¼Œè¿™äº›é˜¶æ®µå¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ªé˜¶æ®µï¼Œä¸ºäº†ç®€åŒ–æ¼”ç¤ºï¼Œæˆ‘å°†è¿™æ ·åšã€‚ ä¸‹æ–‡æ‰€è¿°çš„æ‰€æœ‰æ“ä½œå‡ä¾æ¬¡åº”ç”¨äºæ¯ä¸ªæœåŠ¡ã€‚ <br><br><h3> å‡†å¤‡ä¸€ä¸ªYMLæ–‡ä»¶ </h3><br> é¦–å…ˆï¼Œæ‚¨éœ€è¦å‡†å¤‡YAMLæ–‡ä»¶æœ¬èº«ã€‚ æˆ‘ä»¬ç§°å…¶ä¸ºé¡¹ç›®çš„åç§°ï¼ˆç”¨äºå°†æ¥çš„é›†æˆæµ‹è¯•ï¼Œè¯¥åç§°åº”è¯¥èƒ½å¤Ÿä¸ä¸åŒçš„æœåŠ¡å™¨ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶åŒºåˆ†å®ƒä»¬ä¹‹é—´çš„é…ç½®ï¼‰ï¼Œå°†æ–‡ä»¶ç›´æ¥æ”¾åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼Œä½äºAppSettingsæ—è¾¹ï¼š <br><br><img src="https://habrastorage.org/webt/es/2h/jo/es2hjofltziwk8fbqj3f5faxte0.png"><br><br> åœ¨YMLæ–‡ä»¶ä¸­ï¼Œå¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œæˆ‘ä»¬ä¿å­˜ä¸€ä¸ªâ€œæ‰å¹³â€ç»“æ„ï¼š <br><br><pre> <code class="plaintext hljs">VirtualFeed: "MaxChartHistoryLength: 10, UseThrottling: True, ThrottlingIntervalMs: 50000, UseHistoryBroadcast: True, CalendarName: EmptyCalendar" VirtualFeedPort: 35016 UsMarketFeedUseImbalances: True</code> </pre><br><h3> ä½¿ç”¨è®¾ç½®å±æ€§å¡«å……AppSettings </h3><br> æˆ‘ä»¬å°†æ‰€æœ‰å±æ€§ä»AppSettings.Designer.csè½¬ç§»åˆ°AppSettings.csï¼ŒåŒæ—¶æ‘†è„±äº†è®¾è®¡å™¨çš„å¤šä½™å±æ€§ä»¥åŠget / set-partsä¸­çš„ä»£ç æœ¬èº«ã€‚ <br><br> é‚£æ˜¯ï¼š <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">global::System.Configuration.UserScopedSettingAttribute()</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Diagnostics.DebuggerNonUserCodeAttribute()] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.DefaultSettingValueAttribute(<span class="hljs-string"><span class="hljs-string">"35016"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> VirtualFeedPort{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"VirtualFeedPort"</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"VirtualFeedPort"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre><br> å®ƒå˜æˆäº†ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> VirtualFeedPort { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br> å¦‚æœ‰å¿…è¦ï¼Œæˆ‘ä»¬å°†å®Œå…¨åˆ é™¤AppSettings <b>.Designer</b> .csã€‚ ç°åœ¨ï¼Œé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå¦‚æœé¡¹ç›®ä¸­å­˜åœ¨app.configæ–‡ä»¶ï¼Œåˆ™å¯ä»¥å®Œå…¨æ‘†è„±å®ƒçš„userSettingséƒ¨åˆ†-ç›¸åŒçš„é»˜è®¤è®¾ç½®å­˜å‚¨åœ¨è¯¥ä½ç½®ï¼Œæˆ‘ä»¬é€šè¿‡è®¾ç½®è®¾è®¡å™¨æŒ‡å®šè¯¥é»˜è®¤è®¾ç½®ã€‚ <br> æ¥å§ <br><br><h3> å³æ—¶æ§åˆ¶è®¾å®š </h3><br> ç”±äºæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ•è·è®¾ç½®çš„æ›´æ–°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨AppSettingsä¸­å®ç°INotifyPropertyChangedã€‚ åŸºæœ¬çš„System.Configuration.ApplicationSettingsBaseä¸å†å­˜åœ¨ï¼Œæ‚¨ä¸èƒ½æŒ‡æœ›ä»»ä½•é­”æœ¯ã€‚ <br><br> æ‚¨å¯ä»¥â€œåœ¨é¢å¤´ä¸Šâ€å®ç°å®ƒï¼šé€šè¿‡æ·»åŠ æŠ›å‡ºæ‰€éœ€äº‹ä»¶çš„æ–¹æ³•çš„å®ç°ï¼Œå¹¶åœ¨æ¯ä¸ªå±æ€§çš„è®¾ç½®å™¨ä¸­å¯¹å…¶è¿›è¡Œè°ƒç”¨ã€‚ ä½†æ˜¯è¿™äº›æ˜¯å¤šä½™çš„ä»£ç è¡Œï¼Œæ­¤å¤–ï¼Œè¿˜éœ€è¦åœ¨æ‰€æœ‰æœåŠ¡ä¹‹é—´å¤åˆ¶è¿™äº›ä»£ç è¡Œã€‚ <br><br> è®©æˆ‘ä»¬åšå¾—æ›´æ¼‚äº®-å¼•å…¥è¾…åŠ©åŸºç±»AutoNotifierï¼Œè¯¥ç±»å®é™…ä¸ŠåšåŒæ ·çš„äº‹æƒ…ï¼Œä½†æ˜¯åœ¨åå°ï¼Œå°±åƒSystem.Configuration.ApplicationSettingsBaseä¹‹å‰æ‰€åšçš„é‚£æ ·ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Implements </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;see cref="INotifyPropertyChanged"/&gt;</span></span></span><span class="hljs-comment"> for classes with a lot of public properties (ie AppSettings). </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> This implementation is: </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> - fairly slow, so don't use it for classes where getting/setting of properties is often operation; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> - not for properties described in inherited classes of 2nd level (bad idea: Inherit2 -&gt; Inherit1 -&gt; AutoNotifier; good idea: sealed Inherit -&gt; AutoNotifier) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public abstract class AutoNotifier : INotifyPropertyChanged { public event PropertyChangedEventHandler PropertyChanged; private readonly ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, object&gt;</span></span></span><span class="hljs-comment"> _wrappedValues = new ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, object&gt;</span></span></span><span class="hljs-comment">(); //just to avoid manual writing a lot of fields protected T Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">([CallerMemberName] string propertyName = null) { return (T)_wrappedValues.GetValueOrDefault(propertyName, () =&gt; default(T)); } protected void Set</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(T value, [CallerMemberName] string propertyName = null) { // ReSharper disable once AssignNullToNotNullAttribute _wrappedValues.AddOrUpdate(propertyName, value, (s, o) =&gt; value); OnPropertyChanged(propertyName); } public object this[string propertyName] { get { return Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">(propertyName); } set { Set(value, propertyName); } } protected void OnPropertyChanged([CallerMemberName] string propertyName = null) { PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName)); } }</span></span></code> </pre><br> åœ¨è¿™é‡Œï¼Œ[CallerMemberName]å±æ€§ä½¿æ‚¨å¯ä»¥è‡ªåŠ¨è·å–è°ƒç”¨å¯¹è±¡çš„å±æ€§åç§°ï¼Œå³  AppSettings <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¯¥åŸºç±»AutoNotifierç»§æ‰¿æˆ‘ä»¬çš„AppSettingsï¼Œç„¶åå¯¹æ¯ä¸ªå±æ€§ç¨åŠ ä¿®æ”¹ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> VirtualFeedPort { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Get&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { Set(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } }</code> </pre><br> é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬çš„AppSettingsç±»ï¼ˆç”šè‡³åŒ…å«å¾ˆå¤šè®¾ç½®ï¼‰çœ‹èµ·æ¥å¾ˆç´§å‡‘ï¼ŒåŒæ—¶å®Œå…¨å®ç°äº†INotifyPropertyChangedã€‚ <br><br> æ˜¯çš„ï¼Œæˆ‘çŸ¥é“å¯ä»¥ä½¿ç”¨ä¾‹å¦‚Castle.DynamicProxy.IInterceptorå¼•å…¥æ›´å¤šçš„é­”æœ¯ï¼Œæ‹¦æˆªå¿…è¦å±æ€§ä¸­çš„æ›´æ”¹å¹¶åœ¨é‚£é‡Œå¼•å‘äº‹ä»¶ã€‚ ä½†æ˜¯åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™æ ·çš„å†³å®šå¤ªè¿‡åˆ†äº†ã€‚ <br><br><h3> ä»YAMLæ–‡ä»¶è¯»å–è®¾ç½® </h3><br> ä¸‹ä¸€æ­¥æ˜¯æ·»åŠ YAMLé…ç½®æœ¬èº«çš„è¯»å–å™¨ã€‚ è¿™å‘ç”Ÿåœ¨æ›´æ¥è¿‘æœåŠ¡å¼€å§‹çš„åœ°æ–¹ã€‚ éšè—ä¸æ­£åœ¨è®¨è®ºçš„ä¸»é¢˜æ— å…³çš„ä¸å¿…è¦çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å¾—åˆ°ç±»ä¼¼çš„ç»“æœï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IServerConfigurationProvider </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadServerConfiguration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReadOnlyDictionary&lt;Type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; allSections</span></span></span><span class="hljs-function">)</span></span> { IConfigurationBuilder builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationBuilder().SetBasePath(ConfigFiles.BasePath); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> configFile <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> configFiles) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> directory = Path.GetDirectoryName(configFile); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(directory)) <span class="hljs-comment"><span class="hljs-comment">//can be empty if relative path is used { Directory.CreateDirectory(directory); } builder = builder.AddYamlFile(configFile, optional: true, reloadOnChange: true); } IConfigurationRoot config = builder.Build(); // load prepared files and merge them return new ServerConfigurationProvider&lt;TAppSettings&gt;(config, allSections); }</span></span></code> </pre><br> åœ¨ç»™å‡ºçš„ä»£ç ä¸­ï¼ŒConfigurationBuilderå¯èƒ½ä¸æ˜¯ç‰¹åˆ«é‡è¦-ä½¿ç”¨å®ƒçš„æ‰€æœ‰å·¥ä½œéƒ½ç±»ä¼¼äºä½¿ç”¨ASP.NET Coreä¸­çš„é…ç½®ã€‚ ä½†æ˜¯ä»¥ä¸‹å‡ ç‚¹å¾ˆæœ‰è¶£ã€‚ é¦–å…ˆï¼Œâ€œå¼€ç®±å³ç”¨â€ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰æœºä¼šç»„åˆæ¥è‡ªå¤šä¸ªæ–‡ä»¶çš„è®¾ç½®ã€‚ å¦‚ä¸Šæ‰€è¿°ï¼Œè¿™è¦æ±‚æ¯ä¸ªæœåŠ¡å™¨è‡³å°‘æœ‰ä¸¤ä¸ªé…ç½®æ–‡ä»¶ã€‚ å…¶æ¬¡ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰è¯»å–çš„é…ç½®ä¼ é€’ç»™æŸä¸ªServerConfigurationProviderã€‚ æ€ä¹ˆäº† <br><br><h3>  YAMLæ–‡ä»¶ä¸­çš„éƒ¨åˆ† </h3><br> æˆ‘ä»¬ç¨åå°†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œç°åœ¨å›åˆ°å°†åˆ†å±‚ç»“æ„çš„è®¾ç½®å­˜å‚¨åœ¨YMLæ–‡ä»¶ä¸­çš„è¦æ±‚ã€‚ <br><br> åŸåˆ™ä¸Šï¼Œæ‰§è¡Œæ­¤æ“ä½œéå¸¸ç®€å•ã€‚ é¦–å…ˆï¼Œåœ¨YMLæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»æ‰€éœ€çš„ç»“æ„ï¼š <br><br><pre> <code class="plaintext hljs">VirtualFeed: MaxChartHistoryLength: 10 Port: 35016 UseThrottling: True ThrottlingIntervalMs: 50000 UseHistoryBroadcast: True CalendarName: "EmptyCalendar" UsMarketFeed: UseImbalances: True</code> </pre><br> ç°åœ¨ï¼Œæˆ‘ä»¬å»AppSettingså¹¶æ•™ä»–å¦‚ä½•å°†æˆ‘ä»¬çš„å±æ€§åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†ã€‚ åƒè¿™æ ·ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppSettings</span></span> : <span class="hljs-title"><span class="hljs-title">AutoNotifier</span></span>, <span class="hljs-title"><span class="hljs-title">IWebSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IServerSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IServerManagerAddressStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IGlobalCredentialsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IGraphiteAddressStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IDatabaseConfigStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IBlackListStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IKeyCloackConfigFilePathProvider</span></span>, <span class="hljs-title"><span class="hljs-title">IPrometheusSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IHeartBeatConfig</span></span>, <span class="hljs-title"><span class="hljs-title">IConcurrentAcceptorProperties</span></span>, <span class="hljs-title"><span class="hljs-title">IMetricsConfig</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IReadOnlyDictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Sections { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IDatabaseConfigStorage), <span class="hljs-string"><span class="hljs-string">"Database"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IWebSettingsStorage), <span class="hljs-string"><span class="hljs-string">"Web"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IServerSettingsStorage), <span class="hljs-string"><span class="hljs-string">"Server"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IConcurrentAcceptorProperties), <span class="hljs-string"><span class="hljs-string">"ConcurrentAcceptor"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IGraphiteAddressStorage), <span class="hljs-string"><span class="hljs-string">"Graphite"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IKeyCloackConfigFilePathProvider), <span class="hljs-string"><span class="hljs-string">"Keycloak"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IPrometheusSettingsStorage), <span class="hljs-string"><span class="hljs-string">"Prometheus"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IHeartBeatConfig), <span class="hljs-string"><span class="hljs-string">"Heartbeat"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IServerManagerAddressStorage), <span class="hljs-string"><span class="hljs-string">"ServerManager"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IGlobalCredentialsStorage), <span class="hljs-string"><span class="hljs-string">"GlobalCredentials"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IBlackListStorage), <span class="hljs-string"><span class="hljs-string">"Blacklist"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IMetricsConfig), <span class="hljs-string"><span class="hljs-string">"Metrics"</span></span>} }; ...</code> </pre><br> å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨AppSettingsä¸­æ·»åŠ äº†ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­çš„é”®æ˜¯AppSettingsç±»å®ç°çš„æ¥å£çš„ç±»å‹ï¼Œè€Œå€¼æ˜¯ç›¸åº”éƒ¨åˆ†çš„æ ‡é¢˜ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†YMLæ–‡ä»¶ä¸­çš„å±‚æ¬¡ç»“æ„ä¸AppSettingsä¸­çš„å±æ€§å±‚æ¬¡ç»“æ„è¿›è¡Œæ¯”è¾ƒï¼ˆå°½ç®¡ä¸æ·±äºä¸€å±‚åµŒå¥—ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™å°±è¶³å¤Ÿäº†ï¼‰ã€‚ <br><br> ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦åœ¨AppSettingsä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Ÿ å› ä¸ºä»¥è¿™ç§æ–¹å¼æˆ‘ä»¬ä¸ä¼šæ•£å¸ƒæœ‰å…³ä¸åŒå®ä½“è®¾ç½®çš„ä¿¡æ¯ï¼Œè€Œä¸”è¿™æ˜¯æœ€è‡ªç„¶çš„åœ°æ–¹ï¼Œå› ä¸º åœ¨æ¯ä¸ªæœåŠ¡ä¸­ï¼Œå¹¶å› æ­¤åœ¨æ¯ä¸ªAppSettingsä¸­ï¼Œéƒ½æœ‰å…¶è‡ªå·±çš„è®¾ç½®éƒ¨åˆ†ã€‚ <br><br><h3> å¦‚æœåœ¨è®¾ç½®ä¸­ä¸éœ€è¦å±‚æ¬¡ç»“æ„ï¼Ÿ </h3><br> åŸåˆ™ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„æƒ…å†µï¼Œä½†æ˜¯æˆ‘ä»¬æ°å¥½åœ¨ç¬¬ä¸€é˜¶æ®µå°±æ‹¥æœ‰äº†å®ƒï¼Œå½“æ—¶æˆ‘ä»¬åªæ˜¯ç®€å•åœ°ä»XMLåˆ‡æ¢åˆ°YAMLï¼Œè€Œæ²¡æœ‰åˆ©ç”¨YAMLçš„ä¼˜åŠ¿ã€‚ <br><br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéƒ¨åˆ†çš„æ•´ä¸ªåˆ—è¡¨æ— æ³•å­˜å‚¨ï¼ŒServerConfigurationProviderå°†æ›´åŠ ç®€å•ï¼ˆç¨åè®¨è®ºï¼‰ã€‚ <br><br> ä½†æ˜¯é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å†³å®šä¿ç•™å¹³å¦çš„å±‚æ¬¡ç»“æ„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ»¡è¶³ä¿æŒé€šè¿‡AppSettings.Defaultè®¿é—®è®¾ç½®çš„èƒ½åŠ›çš„è¦æ±‚ã€‚ ä¸ºæ­¤ï¼Œè¯·åœ¨AppSettingsä¸­æ·»åŠ è¿™æ ·ä¸€ä¸ªç®€å•çš„å…¬å…±æ„é€ å‡½æ•°ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings Default { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AppSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Default = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre><br> ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»§ç»­é€šè¿‡AppSettingsæ¥è®¿é—®å¸¦æœ‰è®¾ç½®çš„ç±»ã€‚åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨Defaultï¼ˆå‰ææ˜¯å·²ç»é€šè¿‡ServerConfigurationProviderä¸­çš„IConfigurationRootè¯»å–äº†è®¾ç½®ï¼Œå¹¶ä¸”å·²ç»å®ä¾‹åŒ–äº†AppSettingsï¼‰ã€‚ <br><br> å¦‚æœä¸èƒ½æ¥å—ä¸€ä¸ªå•ä¸€çš„å±‚æ¬¡ç»“æ„ï¼Œé‚£ä¹ˆæ— è®ºå¦‚ä½•ï¼Œæ‚¨éƒ½å¿…é¡»æ‘†è„±AppSettingsã€‚é€šè¿‡ä»£ç åœ¨æ¯ä¸ªåœ°æ–¹éƒ½è®¾ç½®é»˜è®¤å€¼ï¼Œå¹¶ä¸”åªèƒ½é€šè¿‡æ¥å£ä½¿ç”¨è®¾ç½®ï¼ˆè¿™åœ¨åŸåˆ™ä¸Šæ˜¯å¾ˆå¥½çš„ï¼‰ã€‚ ä¸ºä»€ä¹ˆä¼šè¿™æ ·-è¿™å°†å˜å¾—æ›´åŠ æ¸…æ™°ã€‚ <br><br><h3>  ServerConfigurationProvider </h3><br> å‰é¢æåˆ°çš„ç‰¹æ®ŠServerConfigurationProviderç±»å¤„ç†éå¸¸ç¥å¥‡çš„äº‹æƒ…ï¼Œå®ƒä½¿æ‚¨å¯ä»¥ä»…ä½¿ç”¨å¹³å¦çš„AppSettingsæ¥å®Œå…¨ä½¿ç”¨æ–°çš„åˆ†å±‚YAMLé…ç½®ã€‚ <br><br> å¦‚æœæ‚¨è¿«ä¸åŠå¾…ï¼Œå°±åœ¨è¿™é‡Œã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å®Œæ•´çš„ServerConfigurationProviderä»£ç </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Provides different configurations for current server </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class ServerConfigurationProvider</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAppSettings&gt;</span></span></span><span class="hljs-comment"> : IServerConfigurationProvider where TAppSettings : new() { private static readonly Logger Logger = LogManager.GetCurrentClassLogger(); private readonly IConfigurationRoot _configuration; private readonly IReadOnlyDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, string&gt;</span></span></span><span class="hljs-comment"> _sectionsByInterface; private readonly IReadOnlyDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, Type&gt;</span></span></span><span class="hljs-comment"> _interfacesBySections; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Section name -&gt; config </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private readonly ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, TAppSettings&gt;</span></span></span><span class="hljs-comment"> _cachedSections; public ServerConfigurationProvider(IConfigurationRoot configuration, IReadOnlyDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, string&gt;</span></span></span><span class="hljs-comment"> allSections) { _configuration = configuration; _cachedSections = new ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, TAppSettings&gt;</span></span></span><span class="hljs-comment">(); _sectionsByInterface = allSections; var interfacesBySections = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, Type&gt;</span></span></span><span class="hljs-comment">(); foreach (KeyValuePair</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, string&gt;</span></span></span><span class="hljs-comment"> interfaceAndSection in _sectionsByInterface) { //section names must be unique interfacesBySections.Add(interfaceAndSection.Value, interfaceAndSection.Key); } _interfacesBySections = interfacesBySections; _configuration.GetReloadToken()?.RegisterChangeCallback(OnConfigurationFileChanged, null); } private void OnConfigurationFileChanged(object _) { UpdateCache(); } private void UpdateCache() { foreach (string sectionName in _cachedSections.Keys) { Type sectionInterface = _interfacesBySections[sectionName]; TAppSettings newSection = ReadSection(sectionName, sectionInterface); TAppSettings oldSection; if (_cachedSections.TryGetValue(sectionName, out oldSection)) { UpdateSection(oldSection, newSection); } } } private void UpdateSection(TAppSettings oldConfig, TAppSettings newConfig) { foreach (PropertyInfo propertyInfo in typeof(TAppSettings).GetProperties().Where(p =&gt; p.GetMethod != null &amp;&amp; p.SetMethod != null)) { propertyInfo.SetValue(newConfig, propertyInfo.GetValue(oldConfig)); } } public IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type&gt;</span></span></span><span class="hljs-comment"> AllSections =&gt; _sectionsByInterface.Keys; public TSettingsSectionInterface FindSection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TSettingsSectionInterface&gt;</span></span></span><span class="hljs-comment">() where TSettingsSectionInterface : class { return (TSettingsSectionInterface)FindSection(typeof(TSettingsSectionInterface)); } [CanBeNull] public object FindSection(Type sectionInterface) { string sectionName = FindSectionName(sectionInterface); if (sectionName == null) { return null; } //we must return same instance of settings for same requested section (otherwise changing of settings will lead to inconsistent state) return _cachedSections.GetOrAdd(sectionName, typeName =&gt; ReadSection(sectionName, sectionInterface)); } private string FindSectionName(Type sectionInterface) { string sectionName; if (!_sectionsByInterface.TryGetValue(sectionInterface, out sectionName)) { Logger.Debug("This server doesn't contain settings for {0}", sectionInterface.FullName); return null; } return sectionName; } private TAppSettings ReadSection(string sectionName, Type sectionInterface) { TAppSettings parsed; try { IConfigurationSection section = _configuration.GetSection(sectionName); CheckSection(section, sectionName, sectionInterface); parsed = section.Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAppSettings&gt;</span></span></span><span class="hljs-comment">(); if (parsed == null) { //means that this section is empty or all its properties are empty return new TAppSettings(); } ReadArrays(parsed, section); } catch (Exception ex) { Logger.Fatal(ex, "Something wrong during reading section {0} in config", sectionName.SafeSurround()); throw; } return parsed; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Manual reading of array properties in config </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private void ReadArrays(TAppSettings settings, IConfigurationSection section) { foreach (PropertyInfo propertyInfo in GetPublicProperties(typeof(TAppSettings), needSetters: true).Where(p =&gt; typeof(IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment">).IsAssignableFrom(p.PropertyType))) { ClearDefaultArrayIfOverridenExists(section.Key, propertyInfo.Name); IConfigurationSection enumerableProperty = section.GetSection(propertyInfo.Name); propertyInfo.SetValue(settings, enumerableProperty.Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IEnumerable&lt;string&gt;</span></span></span><span class="hljs-comment">&gt;()); } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Clears array property from default config to use overriden one. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Standard implementation merges default and overriden array by indexes - this is not what we need </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private void ClearDefaultArrayIfOverridenExists(string sectionName, string propertyName) { List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IConfigurationProvider&gt;</span></span></span><span class="hljs-comment"> providers = _configuration.Providers.ToList(); if (providers.Count == 0) { return; } string propertyTemplate = $"{sectionName}:{propertyName}:"; if (!providers[providers.Count - 1].TryGet($"{propertyTemplate}{0}", out _)) { //we should use array from default config, because overriden config has no overriden array return; } foreach (IConfigurationProvider provider in providers.Take(providers.Count - 1)) { for (int i = 0; ; i++) { string propertyInnerName = $"{propertyTemplate}{i}"; if (!provider.TryGet(propertyInnerName, out _)) { break; } provider.Set(propertyInnerName, null); } } } private void CheckSection(IConfigurationSection section, string sectionName, Type sectionInterface) { ICollection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;PropertyInfo&gt;</span></span></span><span class="hljs-comment"> properties = GetPublicProperties(sectionInterface, needSetters: false); var configProperties = new HashSet</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment">(section.GetChildren().Select(c =&gt; c.Key)); foreach (PropertyInfo propertyInfo in properties) { if (!configProperties.Remove(propertyInfo.Name)) { if (propertyInfo.PropertyType != typeof(string) &amp;&amp; typeof(IEnumerable).IsAssignableFrom(propertyInfo.PropertyType)) { //no way to distinguish absent array and empty array :( Logger.Debug("Property {0} has no valuable items in configs section {1}", propertyInfo.Name, sectionName.SafeSurround()); } else { Logger.Fatal("Property {0} not found in configs section {1}", propertyInfo.Name, sectionName.SafeSurround()); } } } if (configProperties.Any()) { Logger.Fatal("Unexpected config properties {0} in configs section {1}", configProperties.SafeSurroundAndJoin(), sectionName.SafeSurround()); } } private static ICollection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;PropertyInfo&gt;</span></span></span><span class="hljs-comment"> GetPublicProperties(Type type, bool needSetters) { if (!type.IsInterface) { return type.GetProperties().Where(x =&gt; x.GetMethod != null &amp;&amp; (!needSetters || x.SetMethod != null)).ToArray(); } var propertyInfos = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;PropertyInfo&gt;</span></span></span><span class="hljs-comment">(); var considered = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type&gt;</span></span></span><span class="hljs-comment">(); var queue = new Queue</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type&gt;</span></span></span><span class="hljs-comment">(); considered.Add(type); queue.Enqueue(type); while (queue.Count &gt; 0) { Type subType = queue.Dequeue(); foreach (Type subInterface in subType.GetInterfaces()) { if (considered.Contains(subInterface)) { continue; } considered.Add(subInterface); queue.Enqueue(subInterface); } PropertyInfo[] typeProperties = subType.GetProperties(BindingFlags.FlattenHierarchy | BindingFlags.Public | BindingFlags.Instance); IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;PropertyInfo&gt;</span></span></span><span class="hljs-comment"> newPropertyInfos = typeProperties.Where(x =&gt; x.GetMethod != null &amp;&amp; (!needSetters || x.SetMethod != null) &amp;&amp; !propertyInfos.Contains(x)); propertyInfos.InsertRange(0, newPropertyInfos); } return propertyInfos; } }</span></span></code> </pre><br></div></div><br>  ServerConfigurationProviderç”±AppSettingsè®¾ç½®ç±»å‚æ•°åŒ–ï¼š <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerConfigurationProvider</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TAppSettings</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IServerConfigurationProvider</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TAppSettings</span></span> : <span class="hljs-title"><span class="hljs-title">new</span></span>()</code> </pre><br> æ‚¨å¯èƒ½ä¼šçŒœåˆ°ï¼Œè¿™ä½¿æ‚¨å¯ä»¥åœ¨æ‰€æœ‰æœåŠ¡ä¸­ç«‹å³ä½¿ç”¨å®ƒã€‚ <br><br> è¯»å–çš„é…ç½®æœ¬èº«ï¼ˆIConfigurationRootï¼‰ä»¥åŠä¸Šé¢æåˆ°çš„éƒ¨åˆ†å­—å…¸ï¼ˆAppSettings.Sectionsï¼‰è¢«ä¼ é€’ç»™æ„é€ å‡½æ•°ã€‚ è®¢é˜…äº†æ–‡ä»¶æ›´æ–°ï¼ˆå¦‚æœYMLæ–‡ä»¶å‘ç”Ÿæ›´æ”¹ï¼Œæˆ‘ä»¬æ˜¯å¦è¦ç«‹å³å°†è¿™äº›æ›´æ”¹ç§»äº¤ç»™æˆ‘ä»¬ï¼Ÿï¼‰ï¼š <br><br><pre> <code class="cs hljs">_configuration.GetReloadToken()?.RegisterChangeCallback(OnConfigurationFileChanged, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConfigurationFileChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> sectionName <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _cachedSections.Keys) { Type sectionInterface = _interfacesBySections[sectionName]; TAppSettings newSection = ReadSection(sectionName, sectionInterface); TAppSettings oldSection; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_cachedSections.TryGetValue(sectionName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> oldSection)) { UpdateSection(oldSection, newSection); } } }</code> </pre><br> å¦‚æ‚¨æ‰€è§ï¼Œåœ¨è¿™é‡Œï¼Œå¦‚æœè¦æ›´æ–°YMLæ–‡ä»¶ï¼Œæˆ‘ä»¬å°†éå†æ‰€æœ‰å·²çŸ¥çš„éƒ¨åˆ†å¹¶é€ä¸€é˜…è¯»ã€‚ ç„¶åï¼Œå¦‚æœè¯¥éƒ¨åˆ†æ—©å·²åœ¨ç¼“å­˜ä¸­è¢«è¯»å–ï¼ˆå³æŸä¸ªç±»å·²ç»åœ¨ä»£ç ä¸­çš„æŸå¤„è¯·æ±‚äº†è¯¥éƒ¨åˆ†ï¼‰ï¼Œåˆ™æˆ‘ä»¬ç”¨æ–°çš„å€¼é‡å†™ç¼“å­˜ä¸­çš„æ—§å€¼ã€‚ <br><br> ä¼¼ä¹-ä¸ºä»€ä¹ˆè¦è¯»å–æ¯ä¸ªéƒ¨åˆ†ï¼Œä¸ºä»€ä¹ˆä¸åªè¯»å–é«˜é€Ÿç¼“å­˜ä¸­çš„é‚£äº›éƒ¨åˆ†ï¼ˆå³è¦æ±‚çš„éƒ¨åˆ†ï¼‰ï¼Ÿ å› ä¸ºåœ¨é˜…è¯»æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†å¯¹æ­£ç¡®é…ç½®çš„æ£€æŸ¥ã€‚ å¦‚æœè®¾ç½®ä¸æ­£ç¡®ï¼Œåˆ™ä¼šæŠ›å‡ºç›¸åº”çš„è­¦æŠ¥ï¼Œå¹¶è®°å½•é—®é¢˜ã€‚ æœ€å¥½å°½å¿«äº†è§£é…ç½®æ›´æ”¹ä¸­çš„é—®é¢˜ï¼Œç„¶åä»ä¸­ç«‹å³é˜…è¯»æ‰€æœ‰éƒ¨åˆ†ã€‚ <br><br> ç”¨æ–°å€¼æ›´æ–°ç¼“å­˜ä¸­çš„æ—§å€¼å°±å¾ˆç®€å•äº†ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TAppSettings oldConfig, TAppSettings newConfig</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-function"><span class="hljs-function">PropertyInfo propertyInfo </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typeof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TAppSettings</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Where</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p =&gt; p.GetMethod != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;&amp; p.SetMethod != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">))</span></span> { propertyInfo.SetValue(newConfig, propertyInfo.GetValue(oldConfig)); } }</code> </pre><br> ä½†æ˜¯é˜…è¯»ç« èŠ‚å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> TAppSettings </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sectionName, Type sectionInterface</span></span></span><span class="hljs-function">)</span></span> { TAppSettings parsed; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { IConfigurationSection section = _configuration.GetSection(sectionName); CheckSection(section, sectionName, sectionInterface); parsed = section.Get&lt;TAppSettings&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parsed == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//means that this section is empty or all its properties are empty return new TAppSettings(); } ReadArrays(parsed, section); } catch (Exception ex) { Logger.Fatal(ex, "Something wrong during reading section {0} in config", sectionName.SafeSurround()); throw; } return parsed; }</span></span></code> </pre><br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨æ ‡å‡†IConfigurationRoot.GetSectioné˜…è¯»æœ¬èŠ‚æœ¬èº«ã€‚<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç„¶åï¼Œåªéœ€æ£€æŸ¥è¯»å–éƒ¨åˆ†çš„æ­£ç¡®æ€§å³å¯ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†bindimèŠ‚è¯»ä¸ºè®¾ç½®ç±»å‹ï¼šsection.Getã€‚è¿™é‡Œæˆ‘ä»¬é‡åˆ°äº†YAMLè§£æå™¨çš„ä¸€ä¸ªåŠŸèƒ½-å®ƒæ²¡æœ‰åŒºåˆ†ç©ºèŠ‚ï¼ˆæ— å‚æ•°ï¼Œå³ä¸å­˜åœ¨ï¼‰å’Œæ‰€æœ‰å‚æ•°éƒ½ä¸ºç©ºçš„èŠ‚ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™æ˜¯ç±»ä¼¼çš„æƒ…å†µï¼š</font></font><br><br><pre> <code class="plaintext hljs">VirtualFeed: Names: []</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åœ¨VirtualFeedéƒ¨åˆ†ä¸­ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªNameså‚æ•°ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç©ºå€¼åˆ—è¡¨ï¼Œä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼ŒYAMLåˆ†æå™¨ä¼šè¯´VirtualFeedéƒ¨åˆ†é€šå¸¸å®Œå…¨ä¸ºç©ºã€‚ </font></font>çœŸä¼¤å¿ƒ <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€åï¼Œåœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œå®æ–½äº†ä¸€äº›è¡—å¤´é­”æœ¯ä»¥æ”¯æŒè®¾ç½®ä¸­çš„IEnumerableå±æ€§ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬æ— æ³•æˆåŠŸåœ°â€œå¼€ç®±å³ç”¨â€åœ°æ­£å¸¸è¯»å–åˆ—è¡¨ã€‚</font></font><br><br><pre> <code class="cs hljs">ReadArrays(parsed, section); ... <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Manual reading of array properties in config </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private void ReadArrays(TAppSettings settings, IConfigurationSection section) { foreach (PropertyInfo propertyInfo in GetPublicProperties(typeof(TAppSettings), needSetters: true).Where(p =&gt; typeof(IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment">).IsAssignableFrom(p.PropertyType))) { ClearDefaultArrayIfOverridenExists(section.Key, propertyInfo.Name); IConfigurationSection enumerableProperty = section.GetSection(propertyInfo.Name); propertyInfo.SetValue(settings, enumerableProperty.Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IEnumerable&lt;string&gt;</span></span></span><span class="hljs-comment">&gt;()); } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Clears array property from default config to use overriden one. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Standard implementation merges default and overriden array by indexes - this is not what we need </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private void ClearDefaultArrayIfOverridenExists(string sectionName, string propertyName) { List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IConfigurationProvider&gt;</span></span></span><span class="hljs-comment"> providers = _configuration.Providers.ToList(); if (providers.Count == 0) { return; } string propertyTemplate = $"{sectionName}:{propertyName}:"; if (!providers[providers.Count - 1].TryGet($"{propertyTemplate}{0}", out _)) { //we should use array from default config, because overriden config has no overriden array return; } foreach (IConfigurationProvider provider in providers.Take(providers.Count - 1)) { for (int i = 0; ; i++) { string propertyInnerName = $"{propertyTemplate}{i}"; if (!provider.TryGet(propertyInnerName, out _)) { break; } provider.Set(propertyInnerName, null); } } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æ‰€æœ‰ç±»å‹éƒ½ç»§æ‰¿è‡ªIEnumerableçš„å±æ€§ï¼Œå¹¶ä»è™šæ‹Ÿâ€œèŠ‚â€ï¼ˆä¹Ÿç§°ä¸ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„è®¾ç½®ï¼‰ä¸ºå®ƒä»¬åˆ†é…å€¼ã€‚ä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œè¯·ä¸è¦å¿˜è®°æ£€æŸ¥ï¼šç¬¬äºŒä¸ªé…ç½®æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨æ­¤æšä¸¾å±æ€§çš„æ›¿ä»£å€¼ï¼Ÿå¦‚æœæœ‰çš„è¯ï¼Œæˆ‘ä»¬åªæ¥å—å®ƒï¼Œç„¶åæ¸…é™¤ä»åŸºæœ¬é…ç½®æ–‡ä»¶ä¸­è¯»å–çš„è®¾ç½®ã€‚å¦‚æœä¸è¿™æ ·åšï¼Œåˆ™ä¸¤ä¸ªå±æ€§ï¼ˆæ¥è‡ªåŸºæœ¬æ–‡ä»¶å’Œè¢«è¦†ç›–çš„å±æ€§ï¼‰éƒ½å°†åœ¨IConfigurationSectionçº§åˆ«è‡ªåŠ¨åˆå¹¶åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå¹¶ä¸”æ•°ç»„ç´¢å¼•å°†ç”¨ä½œåˆå¹¶çš„é”®ã€‚è¿™å°†å¯¼è‡´æŸç§å“ˆå¸Œå€¼ï¼Œè€Œä¸æ˜¯æ­£å¸¸çš„è¦†ç›–å€¼ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰€ç¤ºçš„ReadSectionæ–¹æ³•æœ€ç»ˆç”¨äºè¯¥ç±»çš„ä¸»è¦æ–¹æ³•ï¼šFindSectionã€‚</font></font><br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">CanBeNull</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type sectionInterface</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> sectionName = FindSectionName(sectionInterface); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sectionName == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//we must return same instance of settings for same requested section (otherwise changing of settings will lead to inconsistent state) return _cachedSections.GetOrAdd(sectionName, typeName =&gt; ReadSection(sectionName, sectionInterface)); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»åŸç†ä¸Šè®²ï¼Œå¾ˆæ¸…æ¥šä¸ºä»€ä¹ˆåœ¨å„èŠ‚çš„æ”¯æŒä¸‹æˆ‘ä»¬æ— æ³•æ”¯æŒAppSettingsã€‚ä»¥ä»»ä½•æ–¹å¼é»˜è®¤ï¼šé€šè¿‡FindSectionæ¯æ¬¡è®¿é—®æ–°çš„ï¼ˆä»¥å‰æœªè¯»çš„ï¼‰è®¾ç½®èŠ‚å®é™…ä¸Šå°†ä¸ºæˆ‘ä»¬æä¾›AppSettingsç±»çš„æ–°å®ä¾‹ï¼Œå°½ç®¡å®ƒé™„åŠ åœ¨æ‰€éœ€çš„æ¥å£ä¸Šï¼Œå› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨AppSettings.Defaultï¼Œåˆ™æ¯æ¬¡è¯»å–æ–°èŠ‚æ—¶éƒ½ä¼šé‡æ–°å®šä¹‰å®ƒï¼Œå¹¶ä¸”ä»…åŒ…å«å±äºæœ€åä¸€ä¸ªè¯»å–èŠ‚çš„é‚£äº›è®¾ç½®ï¼ˆå…¶ä½™è®¾ç½®å…·æœ‰é»˜è®¤å€¼-NULLå’Œ0ï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ¬èŠ‚ä¸­è®¾ç½®çš„éªŒè¯å®ç°å¦‚ä¸‹ï¼š</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationSection section, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sectionName, Type sectionInterface</span></span></span><span class="hljs-function">)</span></span> { ICollection&lt;PropertyInfo&gt; properties = GetPublicProperties(sectionInterface, needSetters: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configProperties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(section.GetChildren().Select(c =&gt; c.Key)); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (PropertyInfo propertyInfo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> properties) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!configProperties.Remove(propertyInfo.Name)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (propertyInfo.PropertyType != <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IEnumerable).IsAssignableFrom(propertyInfo.PropertyType)) { <span class="hljs-comment"><span class="hljs-comment">//no way to distinguish absent array and empty array :( Logger.Debug("Property {0} has no valuable items in configs section {1}", propertyInfo.Name, sectionName.SafeSurround()); } else { Logger.Fatal("Property {0} not found in configs section {1}", propertyInfo.Name, sectionName.SafeSurround()); } } } if (configProperties.Any()) { Logger.Fatal("Unexpected config properties {0} in configs section {1}", configProperties.SafeSurroundAndJoin(), sectionName.SafeSurround()); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨è¿™é‡Œï¼Œé¦–å…ˆï¼Œæå–æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ¥å£çš„æ‰€æœ‰å…¬å…±å±æ€§ï¼ˆè¯»å–-è®¾ç½®éƒ¨åˆ†ï¼‰ã€‚å¯¹äºè¿™äº›å±æ€§ä¸­çš„æ¯ä¸€ä¸ªï¼Œåœ¨è¯»å–è®¾ç½®ä¸­éƒ½ä¼šæ‰¾åˆ°ä¸€ä¸ªåŒ¹é…é¡¹ï¼šå¦‚æœæ‰¾ä¸åˆ°åŒ¹é…é¡¹ï¼Œåˆ™ä¼šè®°å½•ç›¸åº”çš„é—®é¢˜ï¼Œå› ä¸ºè¿™æ„å‘³ç€configæ–‡ä»¶ä¸­ç¼ºå°‘æŸäº›é…ç½®ã€‚æœ€åï¼Œè¿˜è¦æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•è¯»å–è®¾ç½®ä¸æ¥å£ä¸åŒ¹é…ã€‚å¦‚æœæœ‰ï¼Œåˆ™å†æ¬¡è®°å½•è¯¥é—®é¢˜ï¼Œå› ä¸ºè¿™æ„å‘³ç€åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°äº†æ¥å£ä¸­æœªæè¿°çš„å±æ€§ï¼Œè¿™åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¹Ÿä¸åº”è¯¥å‡ºç°ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡ºç°äº†é—®é¢˜-è¦æ±‚ä»å“ªé‡Œæ¥çš„ï¼Œè¯»æ–‡ä»¶ä¸­çš„æ‰€æœ‰è®¾ç½®éƒ½åº”è¯¥ä¸€å¯¹ä¸€åœ°å¯¹åº”äºç•Œé¢ä¸­å¯ç”¨çš„è®¾ç½®ï¼Ÿäº‹å®æ˜¯ï¼Œå®é™…ä¸Šï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæ­¤æ—¶æ²¡æœ‰è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€æ¬¡è¯»å–äº†ä¸¤ä¸ªæ–‡ä»¶-ä¸€ä¸ªå…·æœ‰é»˜è®¤è®¾ç½®ï¼Œå¦ä¸€ä¸ªå…·æœ‰è¢«è¦†ç›–çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸¤ä¸ªæ–‡ä»¶éƒ½æ˜¯è¿ç»­çš„ã€‚å› æ­¤ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬ä¸æ˜¯ä»ä¸€ä¸ªæ–‡ä»¶ä¸­æŸ¥çœ‹è®¾ç½®ï¼Œè€Œæ˜¯ä»å®Œæ•´æ–‡ä»¶ä¸­æŸ¥çœ‹ã€‚å½“ç„¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä»¬çš„è®¾ç½®åº”ä¸€å¯¹ä¸€å¯¹åº”äºé¢„æœŸçš„è®¾ç½®ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ä¸Šè¿°èµ„æºä¸­è¿˜åº”æ³¨æ„GetPublicPropertiesæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼¼ä¹åªè¿”å›æ¥å£çš„æ‰€æœ‰å…¬å…±å±æ€§ã€‚</font><font style="vertical-align: inherit;">ä½†è¿™å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºæœ‰æ—¶æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¥å£æè¿°ä»å¦ä¸€ä¸ªæ¥å£ç»§æ‰¿çš„æœåŠ¡å™¨è®¾ç½®ï¼Œå› æ­¤ï¼Œæœ‰å¿…è¦æŸ¥çœ‹æ¥å£çš„æ•´ä¸ªå±‚æ¬¡ç»“æ„ä»¥æŸ¥æ‰¾æ‰€æœ‰å…¬å…±å±æ€§ã€‚</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è·å–æœåŠ¡å™¨è®¾ç½® </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åŸºäºä¸Šè¿°å†…å®¹ï¼Œä¸ºäº†é€šè¿‡ä»£ç è·å–å„åœ°çš„æœåŠ¡å™¨è®¾ç½®ï¼Œæˆ‘ä»¬è½¬åˆ°ä»¥ä¸‹ç•Œé¢ï¼š </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Provides different configurations for current server </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public interface IServerConfigurationProvider { TSettingsSectionInterface FindSection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TSettingsSectionInterface&gt;</span></span></span><span class="hljs-comment">() where TSettingsSectionInterface : class; object FindSection(Type sectionInterface); IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type&gt;</span></span></span><span class="hljs-comment"> AllSections { get; } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è¯¥ç•Œé¢çš„ç¬¬ä¸€ç§æ–¹æ³•-FindSection-ä½¿æ‚¨å¯ä»¥è®¿é—®æ„Ÿå…´è¶£çš„è®¾ç½®éƒ¨åˆ†ã€‚ </font></font>åƒè¿™æ ·ï¼š <br><br><pre> <code class="cs hljs">IThreadPoolProperties threadPoolProperties = ConfigurationProvider.FindSection&lt;IThreadPoolProperties&gt;();</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ä¸ºä»€ä¹ˆéœ€è¦ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§æ–¹æ³•-æˆ‘å°†è¿›ä¸€æ­¥è§£é‡Šã€‚ </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è®¾ç½®ç•Œé¢æ³¨å†Œ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæ¸©èåŸå ¡è¢«ç”¨ä½œIoCå®¹å™¨ã€‚æ˜¯ç”±ä»–æä¾›çš„ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨è®¾ç½®ç•Œé¢ã€‚å› æ­¤ï¼Œè¿™äº›æ¥å£å¿…é¡»åœ¨å…¶ä¸­æ³¨å†Œã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œç¼–å†™äº†ä¸€ä¸ªç®€å•çš„Extension-classï¼Œå®ƒç®€åŒ–äº†æ­¤è¿‡ç¨‹ï¼Œä»¥å…åœ¨æ¯ä¸ªæœåŠ¡å™¨ä¸­å†™å…¥æ•´ä¸ªæ¥å£é›†çš„æ³¨å†Œï¼š</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerConfigurationProviderExtensions</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterAllConfigurationSections</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IWindsorContainer container, IServerConfigurationProvider configurationProvider</span></span></span><span class="hljs-function">)</span></span> { Register(container, configurationProvider, configurationProvider.AllSections.ToArray()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IWindsorContainer container, IServerConfigurationProvider configurationProvider, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Type[] configSections</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> registrations = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IRegistration[configSections.Length]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; registrations.Length; i++) { Type configSection = configSections[i]; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> section = configurationProvider.FindSection(configSection); registrations[i] = Component.For(configSection).Instance(section).Named(configSection.FullName); } container.Register(registrations); } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬ä¸€ç§æ–¹æ³•å…è®¸æ‚¨æ³¨å†Œè®¾ç½®çš„æ‰€æœ‰éƒ¨åˆ†ï¼ˆä¸ºæ­¤ï¼Œéœ€è¦IServerConfigurationProviderç•Œé¢ä¸­çš„AllSectionså±æ€§ï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬ä¸€ç§æ–¹æ³•ä¸­ä½¿ç”¨äº†ç¬¬äºŒç§æ–¹æ³•ï¼Œå®ƒä½¿ç”¨æˆ‘ä»¬çš„ServerConfigurationProviderè‡ªåŠ¨è¯»å–æŒ‡å®šçš„è®¾ç½®éƒ¨åˆ†ï¼Œä»è€Œå°†å…¶ç«‹å³å†™å…¥ServerConfigurationProviderç¼“å­˜å¹¶åœ¨Windsorä¸­æ³¨å†Œã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨è¿™é‡Œï¼Œä½¿ç”¨äº†IServerConfigurationProviderä¸­çš„ç¬¬äºŒä¸ªéå‚æ•°åŒ–FindSectionæ–¹æ³•ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰©ä¸‹çš„å°±æ˜¯åœ¨Windsorå®¹å™¨æ³¨å†Œä»£ç ä¸­è°ƒç”¨æˆ‘ä»¬çš„Extensionæ–¹æ³•ï¼š</font></font><br><br><pre> <code class="cs hljs">container.RegisterAllConfigurationSections(configProvider);</code> </pre><br><h2> ç»“è®º </h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å‘ç”Ÿä»€ä¹ˆäº‹äº† </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»¥è¿™ç§æ–¹å¼ï¼Œå¯ä»¥å¾ˆè½»æ¾åœ°å°†æˆ‘ä»¬æœåŠ¡å™¨çš„æ‰€æœ‰è®¾ç½®ä»XMLè½¬ç§»åˆ°YAMLï¼ŒåŒæ—¶å¯¹ç°æœ‰æœåŠ¡å™¨ä»£ç è¿›è¡Œæœ€å°‘çš„æ›´æ”¹ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸XMLä¸åŒï¼ŒYAMLé…ç½®ä¸ä»…å…·æœ‰æ›´é«˜çš„ç®€æ´æ€§ï¼Œè€Œä¸”è¿˜æ”¯æŒåˆ†åŒºï¼Œå› æ­¤æ›´å…·å¯è¯»æ€§ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬å¹¶ä¸æ˜¯å‘æ˜è‡ªå·±çš„è‡ªè¡Œè½¦æ¥è§£æYAMLï¼Œè€Œæ˜¯ä½¿ç”¨äº†ç°æˆçš„è§£å†³æ–¹æ¡ˆã€‚ä½†æ˜¯ï¼Œè¦å°†å®ƒä»¬é›†æˆåˆ°æˆ‘ä»¬é¡¹ç›®çš„ç°å®ä¸­ï¼Œéœ€è¦æœ¬æ–‡ä¸­ä»‹ç»çš„ä¸€äº›æŠ€å·§ã€‚æˆ‘å¸Œæœ›å®ƒä»¬å¯¹è¯»è€…æœ‰ç”¨ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯ä»¥ä¿ç•™å³æ—¶æ•è·æˆ‘ä»¬æœåŠ¡å™¨çš„ç½‘ç»œæªå£ä¸­çš„è®¾ç½®æ›´æ”¹çš„èƒ½åŠ›ã€‚</font><font style="vertical-align: inherit;">æ­¤å¤–ï¼Œä½œä¸ºå¥–åŠ±ï¼Œè¿˜å¯ä»¥å®æ—¶æ•è·YAMLæ–‡ä»¶æœ¬èº«ä¸­çš„æ›´æ”¹ï¼ˆä»¥å‰ï¼Œå¿…é¡»é‡æ–°å¯åŠ¨æœåŠ¡å™¨ä»¥è·å–é…ç½®æ–‡ä»¶ä¸­çš„ä»»ä½•æ›´æ”¹ï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬ä¿ç•™äº†åˆå¹¶ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼ˆé»˜è®¤è®¾ç½®å’Œè¦†ç›–è®¾ç½®ï¼‰çš„åŠŸèƒ½ï¼Œå¹¶ä¸”æˆ‘ä»¬ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹è§£å†³æ–¹æ¡ˆæ¥å®ç°ã€‚</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æ•ˆæœä¸ä½³ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä¸å¾—ä¸æ”¾å¼ƒä»¥å‰å¯ç”¨çš„åŠŸèƒ½ï¼Œå°†ä»æœåŠ¡å™¨Webç•Œé¢åº”ç”¨çš„æ›´æ”¹ä¿å­˜åˆ°é…ç½®æ–‡ä»¶ï¼Œå› ä¸º </font><font style="vertical-align: inherit;">å¯¹æ­¤ç±»åŠŸèƒ½çš„æ”¯æŒéœ€è¦åšå‡ºå¾ˆå¤§çš„å§¿æ€ï¼Œè€Œæ‘†åœ¨æˆ‘ä»¬é¢å‰çš„ä¸šåŠ¡ä»»åŠ¡é€šå¸¸å¹¶éå¦‚æ­¤ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å—¯ï¼Œæˆ‘è¿˜ä¸å¾—ä¸æ‹’ç»é€šè¿‡AppSettings.Defaultæ¥è®¿é—®è®¾ç½®ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªåŠ å·ï¼Œè€Œä¸æ˜¯å‡å·ã€‚</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN438362/">https://habr.com/ru/post/zh-CN438362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN438350/index.html">æœ‰å…³éšè—æ‘„åƒæœºå’Œé—´è°è®¾å¤‡çš„ä¸“ä¸šæœç´¢çš„å®Œæ•´æŒ‡å—</a></li>
<li><a href="../zh-CN438352/index.html">æœˆçƒè¡¨é¢ç¬¬ä¸€ç±³å¤„â€œ Yutu-2â€æµåŠ¨ç«™ä¸‹é™çš„è§†é¢‘ã€‚ åœ¨æœˆçƒä¸Šç¡äº†ä¸¤ä¸ªæ˜ŸæœŸ</a></li>
<li><a href="../zh-CN438354/index.html">Vueï¼ŒStorybookï¼ŒTypeScript â€”åœ¨è€ƒè™‘æœ€ä½³å®è·µçš„æƒ…å†µä¸‹å¼€å§‹æ–°é¡¹ç›®</a></li>
<li><a href="../zh-CN438356/index.html">SQL Serveræ•°æ®ä»“åº“å¿«é€Ÿé€šé“ï¼ˆDWFTï¼‰è®¤è¯çš„ä½“ç³»ç»“æ„ï¼šå«ä¹‰å’Œå·¥ä½œæ–¹å¼</a></li>
<li><a href="../zh-CN438358/index.html">å‰ç¾å›½å›½å®¶å®‰å…¨å±€ç‰¹å·¥åœ¨é˜¿è”é…‹ç›‘è§†å—å®³è€…çš„iPhone</a></li>
<li><a href="../zh-CN438364/index.html">å¤åˆ¶ä¸–ç•Œä¸Šç¬¬ä¸€ä¸ªæ•°å­—è¯­éŸ³åŠ å¯†å™¨</a></li>
<li><a href="../zh-CN438366/index.html">Azure Cloud MFAä¸­OATHç¡¬ä»¶ä»¤ç‰ŒåŠŸèƒ½çš„å¦ä¸€ç¯‡è¯„è®º</a></li>
<li><a href="../zh-CN438368/index.html">æ‰”è¿›åƒåœ¾æ¡¶çš„æ™ºèƒ½ç¯æ³¡æ˜¯ä¸ªäººä¿¡æ¯çš„å®è´µæ¥æºã€‚</a></li>
<li><a href="../zh-CN438370/index.html">ç½‘ç»œçŠ¯ç½ªå³æœåŠ¡ï¼šæœåŠ¡å’Œä»·æ ¼</a></li>
<li><a href="../zh-CN438372/index.html">ç¾å›½å®‡èˆªå±€ç»§ç»­å°è¯•è”ç³»æœºä¼š</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>