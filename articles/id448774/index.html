<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐳 🎫 💅🏿 SQL ke CSV menggunakan DBMS_SQL 🤸🏻 👩🏽‍🌾 🚉</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Seringkali, ketika memecahkan masalah integrasi sistem, perlu untuk menyajikan sejumlah data dalam satu format atau lainnya. Pada saat yang sama, siap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SQL ke CSV menggunakan DBMS_SQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448774/">  Seringkali, ketika memecahkan masalah integrasi sistem, perlu untuk menyajikan sejumlah data dalam satu format atau lainnya.  Pada saat yang sama, siapa pun dapat menjadi konsumen data, tetapi sumbernya hampir selalu berupa basis data perusahaan.  Misalnya, produsen dapat meminta pemasok untuk melaporkan secara berkala pergerakan barang dalam format XLSX atau XML, dll. <br><br>  Ada banyak alat untuk mengubah data menjadi berbagai format, dan kemungkinan penggunaannya bergantung pada tumpukan teknologi yang diadopsi di perusahaan dan arsitektur perangkat lunak.  Pada saat yang sama, Anda selalu ingin rantai yang terdiri dari berbagai pustaka, kerangka kerja, lapisan sistem yang digunakan untuk mengonversi data sumber menjadi sesingkat mungkin.  Ini akan mengurangi waktu yang dihabiskan untuk mengembangkan solusi dan meningkatkan efisiensi produksinya. <br><br>  Jika kita mengasumsikan bahwa, pada kenyataannya, kueri SQL adalah akar dari proses pemilihan data, maka idealnya rantai transformasi akan diinginkan untuk melihat ini: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-1"><span class="MJXp-msup" id="MJXp-Span-2"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-3" style="margin-right: 0.05em;">d</span><span class="MJXp-mo MJXp-script" id="MJXp-Span-4" style="vertical-align: 0.5em;">′</span></span><span class="MJXp-mo" id="MJXp-Span-5" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-6">f</span><span class="MJXp-mo" id="MJXp-Span-7" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-8">S</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-9">Q</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-10">L</span><span class="MJXp-mo" id="MJXp-Span-11" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-12">d</span><span class="MJXp-mo" id="MJXp-Span-13" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-14" style="margin-left: 0em; margin-right: 0em;">)</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processed" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.035ex" height="2.78ex" viewBox="0 -883.9 6903.8 1197.1" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-2032" x="741" y="583"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-3D" x="1097" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-66" x="2153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-28" x="2703" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-53" x="3093" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-51" x="3738" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-4C" x="4530" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-28" x="5211" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-64" x="5601" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-29" x="6124" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-29" x="6514" y="0"></use></g></svg></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> d '= f (SQL (d)) </script></p><br>  dimana <br><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-15"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-16">d</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.216ex" height="2.057ex" viewBox="0 -780.1 523.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-64" x="0" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-2"> d </script>  - sumber data, <br><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-17"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-18">S</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-19">Q</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-20">L</span><span class="MJXp-mo" id="MJXp-Span-21" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-22">d</span><span class="MJXp-mo" id="MJXp-Span-23" style="margin-left: 0em; margin-right: 0em;">)</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.946ex" height="2.66ex" viewBox="0 -832 3421 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-53" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-51" x="645" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-4C" x="1437" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-28" x="2118" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-64" x="2508" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-29" x="3031" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-3"> SQL (d) </script>  - Permintaan SQL untuk mengambil data, <br><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-24"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-25">f</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.419ex" viewBox="0 -780.1 550.5 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-66" x="0" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-4"> f </script>  - fungsi yang mengubah pemilihan ke format yang diinginkan, <br><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-26"><span class="MJXp-msup" id="MJXp-Span-27"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-28" style="margin-right: 0.05em;">d</span><span class="MJXp-mo MJXp-script" id="MJXp-Span-29" style="vertical-align: 0.5em;">′</span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.903ex" height="2.178ex" viewBox="0 -832 819.3 937.7" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhips5x-9juqIZ_aAXFDx0xcZOHoNw#MJMAIN-2032" x="741" y="513"></use></g></svg></span><script type="math/tex" id="MathJax-Element-5"> d '</script>  - data dalam format yang diperlukan. <br><br>  Untuk Oracle PL / SQL, ada sejumlah paket bawaan dan pihak ketiga yang mengimplementasikan fungsi ini.  Ini adalah DBMS_XMLGEN, DBMS_XMLQUERY, AS_XLSX, PL / JSON dan lainnya. <br><br>  Namun, ketika muncul pertanyaan tentang mengkonversi data ke format CSV, untuk beberapa alasan tidak ada solusi yang siap pakai.  Saya harus melakukannya sendiri, maka akan ditunjukkan caranya. <a name="habracut"></a><br><br>  Pernyataan masalah <br><br>  Membuat alat (paket PL / SQL) yang menerima kueri SELECT sewenang-wenang sebagai string atau sebagai variabel kursor pada input, dan mengembalikan objek tipe CLOB yang mengenkapsulasi data dalam format CSV pada output.  Dalam hal terjadi kesalahan, NULL harus dikembalikan.  Format CSV itu sendiri tidak perlu diwakili - ini adalah string yang unsur-unsurnya dipisahkan oleh beberapa karakter, paling sering ";", tetapi dalam kasus umum karakter sewenang-wenang dapat bertindak sebagai pemisah.  Asumsikan bahwa karakter 0x0D + 0x0A digunakan untuk memisahkan string.  Baris pertama dalam file CSV biasanya adalah header dan mendefinisikan nama kolom. <br><br>  Tentukan antarmuka paket <br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> PACKAGE pp_csv <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( stmt <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( ref_cursor <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> SYS_REFCURSOR, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Ada dua prosedur kelebihan beban, perbedaan di antara mereka adalah bahwa salah satu dari mereka menerima permintaan sebagai string, dan yang lainnya sebagai tautan ke kursor.  Parameter kedua adalah output, ini adalah hasil yang diinginkan pada objek CLOB.  Akhirnya, parameter ketiga adalah pemisah CSV. <br><br>  Dalam implementasi prosedur ini, paket DBMS_SQL bawaan akan membantu kami, yang memungkinkan kami untuk bekerja dengan kursor dinamis ketika tidak diketahui sebelumnya (pada tahap kompilasi) persis berapa banyak kolom yang terlibat dalam pemilihan. <br><br>  Fitur-fitur DBMS_SQL memungkinkan Anda untuk mengurai dan mengeksekusi permintaan arbitrer secara dinamis.  Untuk prosedur yang menerima permintaan sebagai string, ini terjadi seperti ini: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cur PLS_INTEGER := DBMS_SQL.OPEN_CURSOR; <span class="hljs-comment"><span class="hljs-comment">--     DBMS_SQL ignore INTEGER; BEGIN DBMS_SQL.PARSE(cur, stmt, DBMS_SQL.NATIVE); ignore := DBMS_SQL.EXECUTE(cur);</span></span></code> </pre> <br>  Untuk prosedur yang mengambil variabel kursor, semuanya lebih sederhana - dimulai dengan Oracle versi ke-11, konversi "variabel kursor → nomor kursor SQL" telah tersedia. <br><br>  Fungsi DBMS_SQL.TO_CURSOR_NUMBER mengubah variabel REFCURSOR (diketik dengan kuat atau lemah) menjadi nomor kursor SQL, yang kemudian dapat diteruskan ke rutinitas DBMS_SQL.  Dalam hal ini, variabel kursor harus terbuka sebelum transfernya ke fungsi DBMS_SQL.TO_CURSOR_NUMBER. <br><br><pre> <code class="pgsql hljs">cur PLS_INTEGER := DBMS_SQL.TO_CURSOR_NUMBER(ref_cursor);</code> </pre> <br>  Dengan demikian, kedua opsi panggilan turun untuk mendapatkan <i>nomor</i> kursor dinamis dan kumpulan data yang terkait.  Langkah selanjutnya adalah mendapatkan informasi tentang kolom set ini dan mengekstrak data itu sendiri. <br><br>  Paket DMBS_SQL memungkinkan Anda untuk mendeskripsikan kolom dari kursor dinamis, mengembalikan informasi tentang setiap kolom dalam array catatan asosiatif. <br><br>  Untuk melakukan ini, Anda harus mendeklarasikan koleksi PL / SQL berdasarkan jenis koleksi DBMS_SQL.DESC_TAB (atau DESC_TAB2 jika kueri dapat mengembalikan nama kolom yang lebih panjang dari 30 karakter).  Setelah itu, Anda dapat menggunakan metode pengumpulan untuk beralih di atas tabel dan mengambil informasi kursor. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cols DBMS_SQL.DESC_TAB2; ncols NUMBER; <span class="hljs-comment"><span class="hljs-comment">--     col_val_chr VARCHAR2(32767); BEGIN DBMS_SQL.DESCRIBE_COLUMNS2(cur, ncols, cols);</span></span></code> </pre> <br>  Selanjutnya, paket DBMS_SQL harus diberi tahu jenis setiap kolom yang dipilih menggunakan kueri dinamis.  Ini dilakukan dengan memanggil DEFINE_COLUMN. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .. ncols <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> DBMS_SQL.DEFINE_COLUMN(cur, i, col_val_chr, <span class="hljs-number"><span class="hljs-number">32767</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>;</code> </pre> <br>  Argumen kedua DEFINE_COLUMN adalah angka - posisi berurutan dari kolom dalam daftar.  Argumen ketiga menetapkan tipe data kolom kursor.  Melewati ekspresi dari tipe yang sesuai.  Dengan kata lain, DBMS_SQL.DEFINE_COLUMN dilewatkan bukan string dengan nama tipe (katakanlah, "VARCHAR2"), tetapi variabel yang didefinisikan dengan tipe VARCHAR2. <br><br>  Saat mendefinisikan kolom tipe karakter dalam argumen keempat, Anda harus menentukan panjang maksimum dari nilai-nilai yang dapat dimuat ke dalam kursor. <br><br>  Operasi persiapan selesai, sekarang Anda dapat membuat baris header dan mulai mengekstraksi data. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cap CLOB; <span class="hljs-comment"><span class="hljs-comment">--    CSV- BEGIN DBMS_LOB.CREATETEMPORARY(cap, TRUE, DBMS_LOB.SESSION); FOR i IN 1 .. ncols LOOP DBMS_LOB.APPEND(cap, cols(i).col_name || delimeter); END LOOP;</span></span></code> </pre> <br>  Data diambil baris demi baris menggunakan DBMS_SQL.FETCH_ROWS dan panggilan selanjutnya ke DBMS_SQL.COLUMN_VALUE untuk mendapatkan nilai dari masing-masing kolom. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> bod CLOB; <span class="hljs-comment"><span class="hljs-comment">--   CSV- c_line_break CONSTANT VARCHAR2(2) := chr(13) || chr(10); BEGIN DBMS_LOB.CREATETEMPORARY(bod, TRUE, DBMS_LOB.SESSION); WHILE DBMS_SQL.FETCH_ROWS(ur) &gt; 0 LOOP FOR i IN 1 .. ncols LOOP DBMS_SQL.COLUMN_VALUE(cur, i, col_val_chr); DBMS_LOB.APPEND(bod, col_val_chr || delimeter); END LOOP; DBMS_LOB.APPEND(bod, c_line_break); END LOOP;</span></span></code> </pre> <br>  Maka tinggal mengumpulkan CSV yang dihasilkan <br><br><pre> <code class="pgsql hljs">DBMS_LOB.APPEND(sheet, cap); DBMS_LOB.APPEND(sheet, c_line_break); DBMS_LOB.APPEND(sheet, bod);</code> </pre> <br>  Tangani kesalahan <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> OTHERS <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> sheet := <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>;</code> </pre> <br>  Dan tutup kursor <br><br><pre> <code class="pgsql hljs">DBMS_SQL.CLOSE_CURSOR(cur);</code> </pre> <br>  Opsi Penggunaan Paket <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(<span class="hljs-string"><span class="hljs-string">'SELECT empcode, fio FROM employee WHERE ROWNUM &lt; 10'</span></span>, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; cur SYS_REFCURSOR; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> empcode, fio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> employee <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ROWNUM &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(cur, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Itu, pada kenyataannya, semua, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kode sumber terlampir</a> . <br><br>  Buku ini membantu dalam pengembangan <br>  Feuerstein S., Tiba B. - Oracle PL / SQL.  Untuk para profesional. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id448774/">https://habr.com/ru/post/id448774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id448762/index.html">Kerusuhan di Picaba. Pengguna secara besar-besaran pergi ke Reddit</a></li>
<li><a href="../id448764/index.html">Jam tangan di ATtiny13</a></li>
<li><a href="../id448766/index.html">Buat monorepositori dengan ruang kerja lerna & benang</a></li>
<li><a href="../id448768/index.html">Kontrol pencahayaan multi-level: ketahanan solusi dan produk</a></li>
<li><a href="../id448770/index.html">Dukungan Razor yang diperbarui dalam Visual Studio Code. Sekarang dengan pisau cukur</a></li>
<li><a href="../id448776/index.html">RxVMS - Arsitektur Praktis untuk Aplikasi Flutter</a></li>
<li><a href="../id448778/index.html">Memperkenalkan Debugging Perjalanan Waktu untuk Visual Studio Enterprise 2019</a></li>
<li><a href="../id448780/index.html">Apa yang memberi perangkat lunak untuk merekrut uang</a></li>
<li><a href="../id448784/index.html">Fitur baru untuk penulis ekstensi di Visual Studio 2019 versi 16.1</a></li>
<li><a href="../id448786/index.html">Pengujian Python dengan pytest. BAB 3 Jadwal Terbaik</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>