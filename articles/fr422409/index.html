<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèª üë©‚Äçüç≥ ‚ú≥Ô∏è Python: m√©taprogrammation en production. Premi√®re partie ‚ù£Ô∏è ‚õ¥Ô∏è üë∞üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beaucoup de gens pensent que la m√©taprogrammation en Python complique inutilement le code, mais si vous l'utilisez correctement, vous pouvez impl√©ment...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python: m√©taprogrammation en production. Premi√®re partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/binarydistrict/blog/422409/"><p> Beaucoup de gens pensent que la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">m√©taprogrammation</a> en Python complique inutilement le code, mais si vous l'utilisez correctement, vous pouvez impl√©menter rapidement et avec √©l√©gance des mod√®les de conception complexes.  De plus, les frameworks Python bien connus tels que Django, DRF et SQLAlchemy utilisent des m√©taclasses pour fournir une extensibilit√© et une r√©utilisation de code faciles. </p><br><p><img src="https://habrastorage.org/webt/ls/ty/gh/lstyghddpotgif7f6jg8cl6kcbi.jpeg"></p><br><p>  Dans cet article, je vais vous expliquer pourquoi vous ne devriez pas avoir peur d'utiliser la m√©taprogrammation dans vos projets et montrer √† quelles t√¢ches il convient le mieux.  Vous pouvez en savoir plus sur les options de m√©taprogrammation dans le cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Advanced Python</a> . </p><a name="habracut"></a><br><p>  Pour commencer, rappelons les bases de la m√©taprogrammation en Python.  Il ne sera pas superflu d'ajouter que tout ce qui est √©crit ci-dessous s'applique √† Python version 3.5 et sup√©rieure. </p><br><h2 id="kratkiy-ekskurs-v-model-dannyh-python">  Pr√©sentation rapide du mod√®le de donn√©es Python </h2><br><p>  Donc, nous savons tous que tout en Python est un objet, et ce n'est un secret pour personne que pour chaque objet il existe une certaine classe par laquelle il a √©t√© g√©n√©r√©, par exemple: </p><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; type(f) &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  Le type de l'objet ou la classe par laquelle l'objet a √©t√© g√©n√©r√© peut √™tre d√©termin√© √† l'aide de la fonction de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">type</a> int√©gr√©e, qui a une signature d'appel plut√¥t int√©ressante (nous en parlerons un peu plus tard).  Le m√™me effet peut √™tre obtenu en d√©rivant l'attribut <code>__class__</code> sur n'importe quel objet. </p><br><p>  Ainsi, pour cr√©er des fonctions, une certaine <code>function</code> classe <code>function</code> .  Voyons ce que nous pouvons en faire.  Pour ce faire, prenez le blanc du module de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">types</a> int√©gr√©: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> types <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FunctionType &gt;&gt;&gt; FunctionType &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">help</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FunctionType)</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(code, globals[, name[, argdefs[, closure]]])</span></span></span><span class="hljs-class"> | | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">code</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dictionary</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">overrides</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">code</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">argdefs</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tuple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specifies</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">argument</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">values</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">closure</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tuple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">supplies</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bindings</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">free</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variables</span></span></span><span class="hljs-class">.</span></span></code> </pre> <br><p>  Comme nous pouvons le voir, toute fonction en Python est une instance de la classe d√©crite ci-dessus.  Essayons maintenant de cr√©er une nouvelle fonction sans recourir √† sa d√©claration via <code>def</code> .  Pour ce faire, nous devons apprendre √† cr√©er des objets de code √† l'aide de la fonction de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compilation</a> int√©gr√©e √† l'interpr√©teur: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,    "Hello, world!" &gt;&gt;&gt; code = compile('print("Hello, world!")', '&lt;repl&gt;', 'eval') &gt;&gt;&gt; code &lt;code object &lt;module&gt; at 0xdeadbeef, file "&lt;repl&gt;", line 1&gt; #  ,     , #      &gt;&gt;&gt; func = FunctionType(code, globals(), 'greetings') &gt;&gt;&gt; func &lt;function &lt;module&gt; at 0xcafefeed&gt; &gt;&gt;&gt; func.__name__ 'greetings' &gt;&gt;&gt; func() Hello, world!</span></span></code> </pre> <br><p>  Super!  √Ä l'aide de m√©ta-outils, nous avons appris √† cr√©er des fonctions √† la vol√©e, mais dans la pratique, ces connaissances sont rarement utilis√©es.  Voyons maintenant comment les objets de classe et les objets d'instance de ces classes sont cr√©√©s: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; user = User() &gt;&gt;&gt; type(user) &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(User)</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  Il est assez √©vident que la classe <code>User</code> est utilis√©e pour cr√©er une instance d' <code>user</code> , il est beaucoup plus int√©ressant de regarder la classe <code>type</code> , qui est utilis√©e pour cr√©er la classe <code>User</code> elle-m√™me.  Ici, nous allons passer √† la deuxi√®me option d'appeler la fonction de <code>type</code> int√©gr√©e, qui en combinaison est une m√©taclasse pour n'importe quelle classe en Python.  Une m√©taclasse est, par d√©finition, une classe dont l'instance est une autre classe.  Les m√©taclasses nous permettent de personnaliser le processus de cr√©ation d'une classe et de contr√¥ler partiellement le processus de cr√©ation d'une instance d'une classe. </p><br><p>  Selon la documentation, le deuxi√®me <code>type(name, bases, attrs)</code> signature <code>type(name, bases, attrs)</code> - renvoie un nouveau type de donn√©es ou, si c'est simple - une nouvelle classe, et l'attribut <code>name</code> devient l'attribut <code>__name__</code> de la classe retourn√©e, <code>bases</code> - la liste des classes parentes sera disponible en tant que <code>__bases__</code> , Eh bien, <code>attrs</code> - un objet de type dict contenant tous les attributs et m√©thodes de la classe, ira dans <code>__dict__</code> .  Le principe de la fonction peut √™tre d√©crit comme un simple pseudo-code en Python: </p><br><pre> <code class="python hljs">type(name, bases, attrs) ~ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(bases)</span></span></span><span class="hljs-class">:</span></span> attrs</code> </pre> <br><p>  Voyons comment vous pouvez, en utilisant uniquement l'appel de <code>type</code> , construire une toute nouvelle classe: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>User = type(<span class="hljs-string"><span class="hljs-string">'User'</span></span>, (), {}) &gt;&gt;&gt; User &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  Comme vous pouvez le voir, nous n'avons pas besoin d'utiliser le mot <code>class</code> cl√© <code>class</code> pour cr√©er une nouvelle classe, la fonction <code>type</code> s'en passe, regardons maintenant un exemple plus compliqu√©: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SuperUser</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(User)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Encapsulate domain logic to work with super users"""</span></span> group_name = <span class="hljs-string"><span class="hljs-string">'admin'</span></span> @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">f'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.group_name}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.name}</span></span></span><span class="hljs-string">'</span></span>.lower() <span class="hljs-comment"><span class="hljs-comment">#     SuperUser "" CustomSuperUser = type( #   'SuperUser', #  ,      (User, ), #         { '__doc__': 'Encapsulate domain logic to work with super users', 'group_name': 'admin', 'login': property(lambda self: f'{self.group_name}/{self.name}'.lower()), } ) assert SuperUser.__doc__ == CustomSuperUser.__doc__ assert SuperUser('Vladimir').login == CustomSuperUser('Vladimir').login</span></span></code> </pre> <br><p>  Comme vous pouvez le voir dans les exemples ci-dessus, la description des classes et des fonctions √† l'aide des mots-cl√©s <code>class</code> et <code>def</code> n'est que du sucre syntaxique et tous les types d'objets peuvent √™tre cr√©√©s par des appels ordinaires aux fonctions int√©gr√©es.  Et maintenant, enfin, parlons de la fa√ßon dont vous pouvez utiliser la cr√©ation dynamique de classes dans des projets r√©els. </p><br><h2 id="dinamicheskoe-sozdanie-form-i-validatorov">  Cr√©ez dynamiquement des formulaires et des validateurs </h2><br><p>  Parfois, nous devons valider les informations de l'utilisateur ou d'autres sources externes selon un sch√©ma de donn√©es pr√©c√©demment connu.  Par exemple, nous voulons changer le formulaire de connexion utilisateur depuis le panneau d'administration - supprimer et ajouter des champs, changer la strat√©gie de leur validation, etc. </p><br><p>  Pour illustrer cela, essayons de cr√©er dynamiquement un formulaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Django</a> , dont la description du sch√©ma est stock√©e au format <code>json</code> suivant: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"fist_name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_length"</span></span>: <span class="hljs-number"><span class="hljs-number">25</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"last_name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_length"</span></span>: <span class="hljs-number"><span class="hljs-number">30</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"age"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"int"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"min_value"</span></span>: <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_value"</span></span>: <span class="hljs-number"><span class="hljs-number">99</span></span> } }</code> </pre> <br><p>  Maintenant, sur la base de la description ci-dessus, cr√©ez un ensemble de champs et un nouveau formulaire en utilisant la fonction <code>type</code> nous connaissons d√©j√†: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> forms fields_type_map = { <span class="hljs-string"><span class="hljs-string">'str'</span></span>: forms.CharField, <span class="hljs-string"><span class="hljs-string">'int'</span></span>: forms.IntegerField, } <span class="hljs-comment"><span class="hljs-comment"># form_description ‚Äì  json    deserialized_form_description: dict = json.loads(form_description) form_attrs = {} #            for field_name, field_description in deserialized_form_description.items(): field_class = fields_type_map[field_description.pop('type')] form_attrs[field_name] = field_class(**field_description) user_form_class = type('DynamicForm', (forms.Form, ), form_attrs) &gt;&gt;&gt; form = user_form_class({'age': 101}) &gt;&gt;&gt; form &lt;DynamicForm bound=True, valid=Unknown, fields=(fist_name;last_name;age)&gt; &gt;&gt;&gt; form.is_valid() False &gt;&gt;&gt; form.errors {'fist_name': ['This field is required.'], 'last_name': ['This field is required.'], 'age': ['Ensure this value is less than or equal to 99.']}</span></span></code> </pre> <br><p>  Super!  Vous pouvez maintenant transf√©rer le formulaire cr√©√© vers le mod√®le et le rendre pour l'utilisateur.  La m√™me approche peut √™tre utilis√©e avec d'autres cadres pour la validation et la pr√©sentation des donn√©es ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s√©rialiseurs DRF</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guimauve</a> et autres). </p><br><h2 id="konfiguriruem-sozdanie-novogo-klassa-cherez-metaklass">  Configuration de la cr√©ation d'une nouvelle classe via la m√©taclasse </h2><br><p>  Ci-dessus, nous avons examin√© la m√©taclasse de <code>type</code> d√©j√† ¬´termin√©e¬ª, mais le plus souvent dans le code, vous cr√©erez vos propres m√©taclasses et les utiliserez pour configurer la cr√©ation de nouvelles classes et leurs instances.  Dans le cas g√©n√©ral, le "blanc" d'une m√©taclasse ressemble √† ceci: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaClass</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   : mcs ‚Äì  ,  &lt;__main__.MetaClass&gt; name ‚Äì ,  ,     ,  "User" bases ‚Äì   -,  (SomeMixin, AbstractUser) attrs ‚Äì dict-like ,         cls ‚Äì  ,  &lt;__main__.User&gt; extra_kwargs ‚Äì  keyword-     args  kwargs ‚Äì          """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(mcs, name, bases, attrs) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, name, bases, attrs, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(cls) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__prepare__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, cls, bases, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__prepare__(mcs, cls, bases, **kwargs) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__call__(*args, **kwargs)</code> </pre> <br><p>  Pour utiliser cette m√©taclasse pour configurer la classe <code>User</code> , la syntaxe suivante est utilis√©e: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=MetaClass)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(cls) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name</code> </pre> <br><p>  La chose la plus int√©ressante est l'ordre dans lequel l'interpr√©teur Python appelle la m√©tam√©thode m√©taclasse au moment o√π la classe elle-m√™me est cr√©√©e: </p><br><ol><li>  L'interpr√©teur d√©termine et recherche les classes parentes de la classe actuelle (le cas √©ch√©ant). </li><li>  L'interpr√©teur d√©finit une m√©taclasse ( <code>MetaClass</code> dans notre cas). </li><li>  La m√©thode <code>MetaClass.__prepare__</code> est <code>MetaClass.__prepare__</code> - elle doit renvoyer un objet de type dict dans lequel les attributs et les m√©thodes de la classe seront √©crits.  Apr√®s cela, l'objet sera transmis √† la <code>MetaClass.__new__</code> via l'argument <code>attrs</code> .  Nous parlerons de l'utilisation pratique de cette m√©thode un peu plus loin dans les exemples. </li><li>  L'interpr√©teur lit le corps de la classe <code>User</code> et g√©n√®re des param√®tres pour les transmettre √† la m√©taclasse <code>MetaClass</code> . </li><li>  La m√©thode <code>MetaClass.__new__</code> est <code>MetaClass.__new__</code> - la m√©thode <code>MetaClass.__new__</code> , renvoie l'objet de classe cr√©√©.  Nous avons d√©j√† rencontr√© les arguments <code>name</code> , <code>bases</code> et <code>attrs</code> lorsque nous les avons pass√©s √† la fonction <code>type</code> , et nous parlerons un peu plus tard du param√®tre <code>**extra_kwargs</code> .  Si le type de l'argument <code>attrs</code> √©t√© modifi√© √† l'aide de <code>__prepare__</code> , il doit √™tre converti en <code>dict</code> avant de le passer √† l'appel de m√©thode <code>super()</code> . </li><li>  La m√©thode <code>MetaClass.__init__</code> est <code>MetaClass.__init__</code> - la m√©thode d'initialisation avec laquelle vous pouvez ajouter des attributs et des m√©thodes suppl√©mentaires √† l'objet classe dans la classe.  En pratique, il est utilis√© dans les cas o√π les m√©taclasses sont h√©rit√©es d'autres m√©taclasses, sinon tout ce qui peut √™tre fait dans <code>__init__</code> est mieux fait dans <code>__new__</code> .  Par exemple, le param√®tre <code>__slots__</code> ne <strong>peut</strong> √™tre d√©fini que dans la m√©thode <code>__new__</code> en l'√©crivant dans l'objet <code>attrs</code> . </li><li>  √Ä cette √©tape, la classe est consid√©r√©e comme cr√©√©e. </li></ol><br><p>  Cr√©ez maintenant une instance de notre classe <code>User</code> et regardez la cha√Æne d'appel: </p><br><pre> <code class="python hljs">user = User(name=<span class="hljs-string"><span class="hljs-string">'Alyosha'</span></span>)</code> </pre> <br><ol><li>  Au moment d'appeler <code>User(...)</code> interpr√©teur appelle la <code>MetaClass.__call__(name='Alyosha')</code> , o√π il passe l'objet classe et les arguments pass√©s. </li><li>  <code>MetaClass.__call__</code> appelle <code>User.__new__(name='Alyosha')</code> - une m√©thode constructeur qui cr√©e et renvoie une instance de la classe <code>User</code> </li><li>  Ensuite, <code>MetaClass.__call__</code> appelle <code>User.__init__(name='Alyosha')</code> - une m√©thode d'initialisation qui ajoute de nouveaux attributs √† l'instance cr√©√©e. </li><li>  <code>MetaClass.__call__</code> renvoie l'instance cr√©√©e et initialis√©e de la classe <code>User</code> . </li><li>  √Ä ce stade, une instance de la classe est consid√©r√©e comme cr√©√©e. </li></ol><br><p>  Cette description, bien s√ªr, ne couvre pas toutes les nuances de l'utilisation des m√©taclasses, mais il suffit de commencer √† utiliser la m√©taprogrammation pour impl√©menter certains mod√®les architecturaux.  Passons aux exemples! </p><br><h2 id="abstraktnye-klassy">  Classes abstraites </h2><br><p>  Et le tout premier exemple peut √™tre trouv√© dans la biblioth√®que standard: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ABCMeta</a> - une m√©taclasse vous permet de d√©clarer n'importe lequel de nos r√©sum√©s de classe et de forcer tous ses descendants √† impl√©menter des m√©thodes, propri√©t√©s et attributs pr√©d√©finis, alors regardez: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasePlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   supported_formats   run        """</span></span> @property @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">supported_formats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; list:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, input_data: dict)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p>  Si toutes les m√©thodes abstraites et les attributs ne sont pas impl√©ment√©s dans l'h√©ritier, alors lorsque nous essayons de cr√©er une instance de la classe h√©riti√®re, nous obtenons une <code>TypeError</code> : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Processing video...'</span></span>) plugin = VideoPlugin() <span class="hljs-comment"><span class="hljs-comment"># TypeError: Can't instantiate abstract class VideoPlugin # with abstract methods supported_formats</span></span></code> </pre> <br><p>  L'utilisation de classes abstraites permet de corriger imm√©diatement l'interface de classe de base et d'√©viter de futures erreurs d'h√©ritage, par exemple des fautes de frappe dans le nom d'une m√©thode red√©finie. </p><br><h2 id="sistema-plaginov-s-avtomaticheskoy-registraciey">  Syst√®me de plugin d'enregistrement automatique </h2><br><p>  Tr√®s souvent, la m√©taprogrammation est utilis√©e pour impl√©menter divers mod√®les de conception.  Presque tous les frameworks connus utilisent des m√©taclasses pour cr√©er <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des</a> objets de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">registre</a> .  Ces objets stockent des liens vers d'autres objets et leur permettent d'√™tre re√ßus rapidement n'importe o√π dans le programme.  Prenons un exemple simple d'enregistrement automatique de plugins pour lire des fichiers multim√©dias de diff√©rents formats. </p><br><p>  Impl√©mentation de la m√©taclasse: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegistryMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" ,      .     " " -&gt; " " """</span></span> _registry_formats = {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> cls: <span class="hljs-string"><span class="hljs-string">'BasePlugin'</span></span> = super().__new__(mcs, name, bases, attrs) <span class="hljs-comment"><span class="hljs-comment">#     (BasePlugin) if inspect.isabstract(cls): return cls for media_format in cls.supported_formats: if media_format in mcs._registry_formats: raise ValueError(f'Format {media_format} is already registered') #       mcs._registry_formats[media_format] = cls return cls @classmethod def get_plugin(mcs, media_format: str): try: return mcs._registry_formats[media_format] except KeyError: raise RuntimeError(f'Plugin is not defined for {media_format}') @classmethod def show_registry(mcs): from pprint import pprint pprint(mcs._registry_formats)</span></span></code> </pre> <br><p>  Et voici les plugins eux-m√™mes, nous prendrons l'impl√©mentation <code>BasePlugin</code> de l'exemple pr√©c√©dent: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasePlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=RegistryMeta)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> supported_formats = [<span class="hljs-string"><span class="hljs-string">'mpg'</span></span>, <span class="hljs-string"><span class="hljs-string">'mov'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> supported_formats = [<span class="hljs-string"><span class="hljs-string">'mp3'</span></span>, <span class="hljs-string"><span class="hljs-string">'flac'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ...</code> </pre> <br><p>  Apr√®s avoir ex√©cut√© ce code, l'interpr√©teur enregistrera 4 formats et 2 plugins dans notre registre qui peuvent traiter ces formats: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>RegistryMeta.show_registry() {<span class="hljs-string"><span class="hljs-string">'flac'</span></span>: &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mov</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mp3</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mpg</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt;} &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegistryMeta</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_plugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-class"><span class="hljs-params"><span class="hljs-string">'mov'</span></span></span></span><span class="hljs-class"><span class="hljs-params">)</span></span></span><span class="hljs-class"> &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">video</span></span></span><span class="hljs-class">...</span></span></code> </pre> <br><p>  Il convient de noter une nuance plus int√©ressante de travailler avec des m√©taclasses, gr√¢ce √† l'ordre de r√©solution de m√©thode non √©vident, nous pouvons appeler la m√©thode <code>show_registry</code> non seulement sur la classe <code>RegistyMeta</code> , mais sur toute autre classe dont il s'agit d'une m√©taclasse: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>AudioPlugin.get_plugin(<span class="hljs-string"><span class="hljs-string">'avi'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># RuntimeError: Plugin is not found for avi</span></span></code> </pre> <br><h2 id="ispolzovanie-imen-atributov-v-kachestve-metadannyh">  Utilisation de noms d'attribut comme m√©tadonn√©es </h2><br><p>  √Ä l'aide de m√©taclasses, vous pouvez utiliser des noms d'attribut de classe comme m√©tadonn√©es pour d'autres objets.  Rien n'est clair?  Mais je suis s√ªr que vous avez d√©j√† vu cette approche √† plusieurs reprises, par exemple la d√©claration d√©clarative des champs de mod√®le dans Django: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Book</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> title = models.Charfield(max_length=<span class="hljs-number"><span class="hljs-number">250</span></span>)</code> </pre> <br><p>  Dans l'exemple ci-dessus, <code>title</code> est le nom de l'identifiant Python, il est √©galement utilis√© pour nommer la colonne dans la table du <code>book</code> , bien que nous ne l'ayons indiqu√© explicitement nulle part.  Oui, une telle ¬´magie¬ª peut √™tre r√©alis√©e √† l'aide de la m√©taprogrammation.  Imaginons par exemple un syst√®me de transmission des erreurs d'application au front-end, afin que chaque message ait un code lisible qui peut √™tre utilis√© pour traduire le message dans une autre langue.  Donc, nous avons un objet message qui peut √™tre converti en <code>json</code> : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, code=None)</span></span></span><span class="hljs-function">:</span></span> self.text = text self.code = code <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_json</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps({<span class="hljs-string"><span class="hljs-string">'text'</span></span>: self.text, <span class="hljs-string"><span class="hljs-string">'code'</span></span>: self.code})</code> </pre> <br><p>  Tous nos messages d'erreur seront stock√©s dans un "espace de noms" distinct: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Messages</span></span></span><span class="hljs-class">:</span></span> not_found = Message(<span class="hljs-string"><span class="hljs-string">'Resource not found'</span></span>) bad_request = Message(<span class="hljs-string"><span class="hljs-string">'Request body is invalid'</span></span>) ... &gt;&gt;&gt; Messages.not_found.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Resource not found"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: null}</code> </pre> <br><p>  Maintenant, nous voulons que le <code>code</code> devienne non <code>null</code> , mais <code>not_found</code> , pour cela, nous √©crivons la m√©taclasse suivante: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaMessage</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs.items(): <span class="hljs-comment"><span class="hljs-comment">#          Message #    code    # ( code   ) if isinstance(value, Message) and value.code is None: value.code = attr return super().__new__(mcs, name, bases, attrs) class Messages(metaclass=MetaMessage): ...</span></span></code> </pre> <br><p>  Voyons √† quoi ressemblent maintenant nos publications: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>Messages.not_found.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Resource not found"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: <span class="hljs-string"><span class="hljs-string">"not_found"</span></span>} &gt;&gt;&gt; Messages.bad_request.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Request body is invalid"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: <span class="hljs-string"><span class="hljs-string">"bad_request"</span></span>}</code> </pre> <br><p>  Ce dont vous avez besoin!  Vous savez maintenant quoi faire pour que le format de donn√©es vous permette de trouver facilement le code qui les traite. </p><br><h2 id="keshirovanie-metadannyh-o-klasse-i-ego-naslednikah">  Mise en cache des m√©tadonn√©es sur une classe et ses descendants </h2><br><p>  Un autre cas courant est la mise en cache de toutes les donn√©es statiques au stade de la cr√©ation de classe, afin de ne pas perdre de temps √† les calculer pendant l'ex√©cution de l'application.  De plus, certaines donn√©es peuvent √™tre mises √† jour lors de la cr√©ation de nouvelles instances de classes, par exemple, un compteur du nombre d'objets cr√©√©s. </p><br><p>  Comment cela peut-il √™tre utilis√©?  Supposons que vous d√©veloppez un cadre pour la cr√©ation de rapports et de tableaux et que vous disposez d'un tel objet: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=MetaRow)</span></span></span><span class="hljs-class">:</span></span> name: str age: int ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self.counter = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> kwargs.items(): setattr(self, attr, value) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__str__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> out = [self.counter] <span class="hljs-comment"><span class="hljs-comment">#  __header__      for name in self.__header__[1:]: out.append(getattr(self, name, 'N/A')) return ' | '.join(map(str, out))</span></span></code> </pre> <br><p>  Nous voulons enregistrer et augmenter le compteur lors de la cr√©ation d'une nouvelle ligne et √©galement g√©n√©rer √† l'avance l'en-t√™te de la table r√©sultante.  La m√©taclasse √† la rescousse! </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaRow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      row_count = 0 def __new__(mcs, name, bases, attrs): cls = super().__new__(mcs, name, bases, attrs) #          cls.__header__ = ['‚Ññ'] + sorted(attrs['__annotations__'].keys()) return cls def __call__(cls, *args, **kwargs): #      row: 'Row' = super().__call__(*args, **kwargs) #    cls.row_count += 1 #     row.counter = cls.row_count return row</span></span></code> </pre> <br><p>  Deux choses doivent √™tre clarifi√©es ici: </p><br><ul><li>  La classe <code>Row</code> n'a pas d'attributs de classe avec le <code>name</code> et l' <code>age</code> noms - ce sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des annotations de type</a> , donc ils ne sont pas dans les <code>attrs</code> dictionnaire <code>attrs</code> , et pour obtenir une liste de champs, nous utilisons l' <code>__annotations__</code> classe <code>__annotations__</code> . </li><li>  L'op√©ration <code>cls.row_count += 1</code> √©tait cens√©e vous induire en erreur: comment cela?  Apr√®s tout, <code>cls</code> est une classe <code>Row</code> ; elle n'a pas l'attribut <code>row_count</code> .  Tout est vrai, mais comme je l'ai expliqu√© ci-dessus - si la classe cr√©√©e n'a pas d'attribut ou de m√©thode qu'ils essaient d'appeler, alors l'interpr√©teur va plus loin dans la cha√Æne des classes de base - s'il n'y en a pas, une recherche est effectu√©e dans la m√©taclasse.  Dans de tels cas, afin de ne d√©router personne, il est pr√©f√©rable d'utiliser un autre enregistrement: <code>MetaRow.row_count += 1</code> . </li></ul><br><p>  Voyez avec quelle √©l√©gance vous pouvez maintenant afficher la table enti√®re: </p><br><pre> <code class="python hljs">rows = [ Row(name=<span class="hljs-string"><span class="hljs-string">'Valentin'</span></span>, age=<span class="hljs-number"><span class="hljs-number">25</span></span>), Row(name=<span class="hljs-string"><span class="hljs-string">'Sergey'</span></span>, age=<span class="hljs-number"><span class="hljs-number">33</span></span>), Row(name=<span class="hljs-string"><span class="hljs-string">'Gosha'</span></span>), ] print(<span class="hljs-string"><span class="hljs-string">' | '</span></span>.join(Row.__header__)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rows: print(row)</code> </pre> <br><pre> <code class="hljs ruby">‚Ññ <span class="hljs-params"><span class="hljs-params">| age |</span></span> name <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 25 |</span></span> Valentin <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-params"><span class="hljs-params">| 33 |</span></span> Sergey <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-params"><span class="hljs-params">| N/A |</span></span> Gosha</code> </pre> <br><p>  Soit dit en passant, l'affichage et l'utilisation d'une table peuvent √™tre encapsul√©s dans une classe <code>Sheet</code> distincte. </p><br><h2 id="prodolzhenie-sleduet">  √Ä suivre ... </h2><br><p>  Dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie suivante de</a> cet article, je d√©crirai comment utiliser des m√©taclasses pour d√©boguer votre code d'application, comment param√©trer la cr√©ation d'une m√©taclasse et montrer des exemples de base d'utilisation de la m√©thode <code>__prepare__</code> .  Restez √† l'√©coute! </p><br><p>  Plus en d√©tail sur les m√©taclasses et les descripteurs en Python, je le dirai dans le cadre d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Advanced Python</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr422409/">https://habr.com/ru/post/fr422409/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr422397/index.html">¬´L'essentiel, c'est que je l'ai r√©ussi¬ª: quoi et comment sont enseign√©s les futurs informaticiens √† Berlin</a></li>
<li><a href="../fr422399/index.html">Le processus de r√©vision du code dans hh.ru</a></li>
<li><a href="../fr422401/index.html">Un autre framework de plugin C ++</a></li>
<li><a href="../fr422403/index.html">20 septembre, Moscou - une r√©union pour les analystes</a></li>
<li><a href="../fr422407/index.html">Rechercher et trier les textes associ√©s</a></li>
<li><a href="../fr422411/index.html">Nouveaux r√¥les dans les entreprises √† l'√®re de la servitisation</a></li>
<li><a href="../fr422413/index.html">Application de Arm Mbed OS. R√©glage fin</a></li>
<li><a href="../fr422415/index.html">Python: m√©taprogrammation en production. Deuxi√®me partie</a></li>
<li><a href="../fr422417/index.html">Slavik et GMT + 3 ou avantage pour les personnes</a></li>
<li><a href="../fr422419/index.html">Pas sans panique chez Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>