<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè® üèáüèª üé¶ Parte 3: Casi cargando Linux desde una tarjeta SD a RocketChip üë®‚Äçüë¶ üë©üèΩ‚Äçüé® üí≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En la parte anterior , se implement√≥ un controlador de memoria m√°s o menos funcional, o m√°s bien, un contenedor sobre IP Core de Quartus, que es un ad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Parte 3: Casi cargando Linux desde una tarjeta SD a RocketChip</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458482/"><p><img src="https://habrastorage.org/webt/4j/fu/lu/4jfulumeapi32exqv7d6vnseaho.png" width="45%" align="left">  En la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte anterior</a> , se implement√≥ un controlador de memoria m√°s o menos funcional, o m√°s bien, un contenedor sobre IP Core de Quartus, que es un adaptador para TileLink.  Hoy, bajo el t√≠tulo "Llevamos RocketChip a una placa base china poco conocida con Cyclone", ver√° una consola que funciona.  El proceso se prolong√≥ un poco: ya pens√© que lanzar√≠a Linux r√°pidamente y seguir√≠a adelante, pero no estaba all√≠.  En esta parte, propongo analizar el proceso de inicio de U-Boot, BBL y los intentos t√≠midos de kernel de Linux para inicializar.  Pero hay una consola: U-Boot-ovsky, y bastante avanzada, que tiene mucho de lo que esperas de una consola completa. </p><br><p> En el hardware, se agregar√° una tarjeta SD conectada a trav√©s de SPI, as√≠ como UART.  En la parte del software, BootROM se reemplazar√° de <code>xip</code> a <code>sdboot</code> y, de hecho, se <code>sdboot</code> las siguientes etapas de arranque (en la tarjeta SD). </p><a name="habracut"></a><br><h2 id="dopilivanie-apparatnoy-chasti">  Dopando el hardware </h2><br><p>  Entonces, la tarea: debe cambiar al n√∫cleo "grande" y conectar el UART (desde Raspberry) y el adaptador SD (se utiliz√≥ alg√∫n tipo de placa Catalex con seis pines: GND, VCC, MISO, MOSI, SCK, CS). </p><br><p>  En principio, todo era bastante simple.  Pero antes de darme cuenta de esto, me arrojaron un poco de lado a lado: despu√©s de la vez anterior, decid√≠ que nuevamente solo necesita mezclar algo como <code>HasPeripheryUART</code> en el <code>System</code> (y la implementaci√≥n, respectivamente), lo mismo para la tarjeta SD, y eso es todo. Estar√° listo  Entonces decid√≠ ver c√≥mo se implementaba en un dise√±o "serio".  Entonces, ¬øqu√© hemos sacado en serio?  Arty, al parecer, no encaja: el monstruo permanece sin <code>unleahshed.DevKitConfigs</code> . <code>unleahshed.DevKitConfigs</code> .  Y de repente result√≥ que hab√≠a en todas partes alg√∫n tipo de superposiciones que se agregaron a trav√©s de los par√°metros mediante teclas.  Supongo que esto es probablemente muy flexible y configurable, pero me gustar√≠a comenzar algo para empezar ... <em>Pero no tienes lo mismo, ¬øsimplemente muletas m√°s f√°ciles? ...</em> Luego me encontr√© con <code>vera.iofpga.FPGAChip</code> para FPGAs Microsemi y <del>  enseguida sac√≥ entre comillas </del>  Trat√© de hacer mi implementaci√≥n por analog√≠a, el beneficio aqu√≠ es m√°s o menos todo el "dise√±o de la placa base" en un archivo. </p><br><p>  Result√≥, realmente, solo necesitas agregar l√≠neas a <code>System.scala</code> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">System</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RocketSubsystem</span></span></span><span class="hljs-class"> ... </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripherySPI</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryUART</span></span></span><span class="hljs-class"> ... </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> tlclock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">FixedClockResource</span></span>(<span class="hljs-string"><span class="hljs-string">"tlclk"</span></span>, p(<span class="hljs-type"><span class="hljs-type">DevKitFPGAFrequencyKey</span></span>)) ... } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemModule</span></span></span><span class="hljs-class">[+</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">L</span></span></span><span class="hljs-class"> &lt;: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">System</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">_outer: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">L</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RocketSubsystemModuleImp</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">_outer</span></span></span><span class="hljs-class">) ... </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryUARTModuleImp</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasPeripheryGPIOModuleImp</span></span></span><span class="hljs-class"> ...</span></span></code> </pre> <br><p>  Una l√≠nea en el cuerpo de la clase <code>System</code> agrega informaci√≥n sobre la frecuencia con la que esta parte de nuestro SoC funciona al archivo dts.  Seg√∫n tengo entendido, DTS / DTB es un an√°logo est√°tico de la tecnolog√≠a plug-and-play para dispositivos integrados: el √°rbol de descripci√≥n dts se compila en un archivo binario dtb y el cargador lo transmite al n√∫cleo para que pueda configurar correctamente el hardware.  Curiosamente, sin una l√≠nea con <code>tlclock</code> todo est√° perfectamente sintetizado, pero no funcionar√° para compilar BootROM (te recordar√© ahora que ser√° <code>sdboot</code> ): durante la compilaci√≥n analiza el archivo dts y crea un encabezado con la macro <code>TL_CLK</code> , gracias a la cual puede configurar correctamente los divisores de frecuencia para interfaces externas </p><br><p>  Tambi√©n deber√° arreglar ligeramente el "cableado": </p><br><p>  <strong>Platform.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlatformIO</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bundle</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">// UART io.uart_tx := sys.uart(0).txd sys.uart(0).rxd := RegNext(RegNext(io.uart_rx)) // SD card io.sd_cs := sys.spi(0).cs(0) io.sd_sck := sys.spi(0).sck io.sd_mosi := sys.spi(0).dq(0).o sys.spi(0).dq(0).i := false.B sys.spi(0).dq(1).i := RegNext(RegNext(io.sd_miso)) sys.spi(0).dq(2).i := false.B sys.spi(0).dq(3).i := false.B }</span></span></code> </pre> <br><p>  Las cadenas de registro, francamente, se agregaron simplemente por analog√≠a con algunos otros lugares en el c√≥digo fuente.  Lo m√°s probable es que deber√≠an proteger contra la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">metaestabilidad</a> .  Quiz√°s <em>algunos</em> bloques ya tienen su propia protecci√≥n, pero primero quiero correr al menos "a un alto nivel".  Una pregunta m√°s interesante para m√≠ es ¬øpor qu√© MISO y MOSI cuelgan en diferentes <code>dq</code> ?  Todav√≠a no he encontrado la respuesta, pero parece que el resto del c√≥digo cuenta con esa conexi√≥n. </p><br><p>  F√≠sicamente, acabo de asignar las conclusiones del dise√±o a los contactos sueltos en el bloque y reorganic√© el puente de selecci√≥n de voltaje a 3.3V. </p><br><div class="spoiler">  <b class="spoiler_title">Adaptador SD</b> <div class="spoiler_text"><p>  Vista superior: </p><br><img src="https://habrastorage.org/webt/su/zf/q4/suzfq4lwejcelmwt3rpk5w_min0.jpeg"><br><p>  Vista inferior: </p><br><img src="https://habrastorage.org/webt/y0/__/qq/y0__qqavfhkikpsorvmzqhbamlw.jpeg"></div></div><br><h2 id="otladka-programmnoy-chasti-instrumenty">  Depuraci√≥n de la parte de software: herramientas </h2><br><p>  Primero, hablemos sobre las herramientas de depuraci√≥n disponibles y sus limitaciones. </p><br><h3 id="minicom">  Minicom </h3><br><p>  Primero, necesitaremos leer de alguna manera qu√© es el cargador de arranque y la salida del kernel.  Para hacer esto, en Linux (en este caso, el de RaspberryPi), necesitamos el programa Minicom.  En t√©rminos generales, cualquier programa para trabajar con un puerto serie es adecuado. </p><br><p>  Tenga en cuenta que al inicio, el nombre del dispositivo del puerto debe especificarse como <code>-D /dev/ttyS0</code> - despu√©s de la opci√≥n <code>-D</code> .  Bueno, la informaci√≥n principal: para salir, use <code>Ctrl-A, X</code>  Realmente tuve un caso en el que esta combinaci√≥n no funcion√≥, entonces simplemente puede decir <code>killall -KILL minicom</code> desde una sesi√≥n SSH adyacente. </p><br><p>  Hay otra caracter√≠stica.  Espec√≠ficamente, hay dos UART en RaspberryPi, y ambos puertos ya se pueden adaptar para algo: uno para Bluetooth, y el otro, la consola del kernel se muestra de forma predeterminada.  Afortunadamente, este comportamiento se puede reconfigurar de <a href="">acuerdo con este manual</a> . </p><br><h3 id="perepisyvanie-pamyati">  Reescribiendo memoria </h3><br><p>  Al depurar, para probar la hip√≥tesis, a veces ten√≠a que <em>cargar el gestor de arranque</em> (lo siento) en la RAM directamente desde el host.  Tal vez esto se puede hacer directamente desde GDB, pero al final tom√© el camino simple: copi√© el archivo necesario a Raspberry, tambi√©n envi√© el puerto 4444 (telnet desde OpenOCD) a trav√©s de SSH y utilic√© el comando <code>load_image</code> .  Cuando lo ejecuta, parece que todo est√° congelado, pero en realidad <em>"no duerme, simplemente parpadea lentamente"</em> : carga el archivo, simplemente lo hace a una velocidad de un par de kilobytes por segundo. </p><br><h3 id="osobennosti-ustanovki-breakpoint-ov">  Caracter√≠sticas de la instalaci√≥n de puntos de interrupci√≥n </h3><br><p>  Probablemente, muchos no tuvieron que pensar en esto al depurar programas regulares, pero los puntos de interrupci√≥n no siempre se establecen en el hardware.  A veces, establecer un punto de interrupci√≥n implica escribir temporalmente una instrucci√≥n especial en el lugar correcto <strong>directamente en el c√≥digo de m√°quina</strong> .  Por ejemplo, as√≠ es como funcion√≥ mi comando <code>b</code> est√°ndar en GDB.  Esto es lo que sigue de esto: </p><br><ul><li>  no puedes poner un punto dentro de BootROM, porque ROM </li><li>  Puede establecer un punto de interrupci√≥n en el c√≥digo cargado en la RAM desde la tarjeta SD, pero debe esperar hasta que se cargue.  De lo contrario, no reescribiremos un c√≥digo, pero el cargador reescribir√° nuestro punto de interrupci√≥n </li></ul><br><p>  Estoy seguro de que puede solicitar expl√≠citamente el uso de puntos de interrupci√≥n de hardware, pero de todos modos hay un n√∫mero limitado de ellos. </p><br><h3 id="bystraya-podmena-bootrom">  Cambio r√°pido de BootROM </h3><br><p>  En la etapa inicial de depuraci√≥n, a menudo existe el deseo de arreglar BootROM e intentar nuevamente.  Pero hay un problema: BootROM es parte del dise√±o cargado en el FPGA, y su s√≠ntesis es cuesti√≥n de varios minutos (y esto es despu√©s de compilar casi instant√°neamente la propia imagen de BootROM desde C y Assembler ...).  Afortunadamente, de hecho, todo es <strong>mucho m√°s r√°pido</strong> : la secuencia de acciones es la siguiente: </p><br><ul><li>  regenerate bootrom.mif (cambi√© a MIF en lugar de HEX, porque con HEX siempre tuve algunos problemas, y MIF es el formato nativo de Alter) </li><li>  in Quartus say <code>Processing -&gt; Update Memory Initialization File</code> </li><li>  en Ensamblador (en la columna izquierda de Tareas), comando Comenzar de nuevo </li></ul><br><p>  Para todo sobre todo, un par de decenas de segundos. </p><br><h2 id="podgotovka-sd-karty">  Preparaci√≥n de la tarjeta SD </h2><br><p>  Aqu√≠ todo es relativamente simple, pero debe ser paciente y tener aproximadamente 14 Gb de espacio en disco: </p><br><pre> <code class="plaintext hljs">git clone https://github.com/sifive/freedom-u-sdk git submodule update --recursive --init make</code> </pre> <br><p>  Luego debe insertar una tarjeta SD limpia o, mejor dicho, que no contenga todo lo que necesita, y ejecutar </p><br><pre> <code class="plaintext hljs">sudo make DISK=/dev/sdX format-boot-loader</code> </pre> <br><p>  ... donde <code>sdX</code> es el dispositivo asignado a la tarjeta.  <strong>ATENCI√ìN: ¬°los datos en la tarjeta ser√°n eliminados, sobrescritos y en general!</strong>  No vale la pena hacer todo el ensamblaje desde debajo de <code>sudo</code> , porque entonces todos los artefactos de ensamblaje ser√°n propiedad de <code>root</code> , y el ensamblaje tendr√° que hacerse desde debajo de <code>sudo</code> tiempo. </p><br><p>  El resultado es una tarjeta marcada en GPT con cuatro secciones, una de las cuales es FAT con <code>uEnv.txt</code> y una imagen descargable en formato FIT (contiene varias <code>uEnv.txt</code> , cada una con su propia direcci√≥n de descarga), la otra secci√≥n est√° en blanco, se supone que est√° formateada en Ext4 para Linux  Dos secciones m√°s son <em>cr√≠pticas</em> : U-Boot vive en una (su compensaci√≥n, seg√∫n tengo entendido, est√° cableada en BootROM), en la otra, parece que sus variables de entorno viven, pero a√∫n no las uso. </p><br><h2 id="uroven-pervyy-bootrom">  Nivel uno, BootROM </h2><br><p>  La sabidur√≠a popular dice: "Si en la programaci√≥n hay bailes con una pandereta, luego en electr√≥nica, tambi√©n con un extintor de incendios".  Ni siquiera es que una vez casi quem√© el tablero, decidiendo que "Bueno, GND es el mismo nivel bajo" <em>(aparentemente, la resistencia a√∫n no doler√≠a ...)</em> Se trata m√°s del hecho de que si las manos no crecen a partir de ah√≠, entonces la electr√≥nica no deja de traer sorpresas: cuando solde el conector a la placa, todav√≠a no puedo disolver los contactos normalmente: el video muestra c√≥mo la soldadura se extiende directamente a trav√©s de la conexi√≥n, simplemente coloque el soldador, se me cay√≥ encima. de todos modos  Bueno, tal vez la soldadura no era adecuada para la temperatura del soldador, tal vez otra cosa ... En general, cuando vi que ya ten√≠a una docena de contactos, escup√≠ y comenc√© a depurar.  Y entonces comenz√≥ algo <em>misterioso</em> : conect√© RX / TX desde UART, cargu√© el firmware, escribe </p><br><pre> <code class="plaintext hljs">INIT CMD0 ERROR</code> </pre> <br><p>  Bueno, todo es l√≥gico: no conect√© el m√≥dulo de la tarjeta SD.  Arreglamos la situaci√≥n, cargamos el firmware ... Y silenciamos ... Lo que simplemente no cambi√≥ de opini√≥n, y el ata√∫d simplemente se abri√≥: una de las salidas del m√≥dulo ten√≠a que estar conectada a VCC.  En mi caso, el m√≥dulo soportaba 5V de potencia, as√≠ que sin pensarlo dos veces, pegu√© un cable que se extend√≠a desde el m√≥dulo al lado opuesto de la placa.  Como resultado, el conector soldado torcidamente se retorci√≥ y el <strong>contacto UART simplemente se perdi√≥.</strong>  <em>facepalm.jpg</em> En general, "una cabeza mala no da descanso a las piernas", y manos torcidas - a la cabeza ... </p><br><p>  Al final, vi el tan esperado en Minicom </p><br><pre> <code class="plaintext hljs">INIT CMD0 CMD8 ACMD41 CMD58 CMD16 CMD18 LOADING /</code> </pre> <br><p>  Por otra parte, <del>  se mueve </del>  El indicador de carga est√° girando.  Recuerdo directamente los a√±os escolares y el arranque pausado de MinuetOS desde un disquete.  A menos que la unidad muela. </p><br><p>  El problema es que no pasa nada despu√©s del mensaje BOOT.  Entonces, es hora de conectarse a trav√©s de OpenOCD en Raspberry, GDB en el host y ver qu√© es. </p><br><p>  En primer lugar, la conexi√≥n con GDB mostr√≥ inmediatamente que <code>$pc</code> (contador del programa, direcci√≥n de la instrucci√≥n actual) vuela a <code>0x0</code> ; esto probablemente ocurre despu√©s de un error m√∫ltiple.  Por lo tanto, inmediatamente despu√©s de emitir el mensaje <code>BOOT</code> , agregamos un bucle infinito.  <em>Esto lo retrasar√° por un momento ...</em> </p><br><pre> <code class="diff hljs">diff --git a/bootrom/sdboot/sd.cb/bootrom/sdboot/sd.c index c6b5ede..bca1b7f 100644 --- a/bootrom/sdboot/sd.c +++ b/bootrom/sdboot/sd.c @@ -224,6 +224,8 @@ int main(void) kputs("BOOT"); + while(*(volatile char *)0x10000){} + __asm__ __volatile__ ("fence.i" : : : "memory"); return 0; }</code> </pre> <br><p>  Tal c√≥digo complicado se usa "por confiabilidad": escuch√© en alguna parte que, al parecer, un bucle infinito es un comportamiento indefinido, y aqu√≠ es poco probable que el compilador adivine (recuerdo que BootROM se encuentra en <code>0x10000</code> ). </p><br><p><img src="https://habrastorage.org/webt/wj/xw/a9/wjxwa9m9hqoghtvy79zsbysctr0.png" alt="Hay un depurador, no hay fuente"></p><br><p>  Parece, pero qu√© m√°s esperar: una incrustaci√≥n dura, qu√© tipo de fuente hay.  Pero despu√©s de todo, en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ese art√≠culo, el</a> autor depur√≥ el c√≥digo ... Krex-fex-pex: </p><br><pre> <code class="plaintext hljs">(gdb) file builds/zeowaa-e115/sdboot.elf A program is being debugged already. Are you sure you want to change the file? (y or n) y Reading symbols from builds/zeowaa-e115/sdboot.elf...done.</code> </pre> <br><p><img src="https://habrastorage.org/webt/ya/08/zp/ya08zpufla55qz02j5fhwcoijy4.png" alt="¬°Hay c√≥digos fuente!"></p><br><p>  Solo necesita cargar no el archivo MIF y no bin, sino la versi√≥n original en formato ELF. </p><br><p>  Ahora, con el en√©simo intento de adivinar la direcci√≥n donde continuar√° la ejecuci√≥n (esta es otra raz√≥n por la cual el compilador no deber√≠a haber adivinado que el bucle es infinito).  El equipo </p><br><pre> <code class="plaintext hljs">set variable $pc=0xADDR</code> </pre> <br><p>  le permite cambiar el valor del registro sobre la marcha (en este caso, la direcci√≥n de la instrucci√≥n actual).  Con su ayuda, puede cambiar los valores registrados en la memoria (y los registros mapeados en memoria). </p><br><p>  Al final, llegu√© a la conclusi√≥n (no estoy seguro si es correcto) de que tenemos una "imagen de tarjeta SD del sistema incorrecto", y que necesitamos ir no al principio de los datos descargados, sino a <code>0x89800</code> bytes m√°s: </p><br><pre> <code class="diff hljs">diff --git a/bootrom/sdboot/head.S b/bootrom/sdboot/head.S index 14fa740..2a6c944 100644 --- a/bootrom/sdboot/head.S +++ b/bootrom/sdboot/head.S @@ -13,7 +13,7 @@ _prog_start: smp_resume(s1, s2) csrr a0, mhartid la a1, dtb - li s1, PAYLOAD_DEST + li s1, (PAYLOAD_DEST + 0x89800) jr s1 .section .rodata</code> </pre> <br><p>  Tal vez esto tambi√©n se vio afectado por el hecho de que no ten√≠a una tarjeta innecesaria de 4 Gb a mano, la llev√© a 2 Gb y la reemplac√© en el Makefile con <code>DEMO_END=11718750</code> con <code>DEMO_END=3078900</code> (no busque el significado en un valor espec√≠fico; no existe, ahora la imagen est√° colocada a la tarjeta). </p><br><h2 id="uroven-vtoroy-u-boot">  Nivel dos, arranque en U </h2><br><p>  Ahora todav√≠a estamos "cayendo", pero ya estamos en la direcci√≥n <code>0x0000000080089a84</code> .  Aqu√≠ tengo que admitir: de hecho, la presentaci√≥n no va "con todas las paradas", sino que est√° parcialmente escrita "despu√©s", as√≠ que aqu√≠ ya logr√© poner el archivo dtb correcto de nuestro SoC, ajustar la variable <code>CONFIG_SYS_TEXT_BASE=0x80089800</code> en la <code>HiFive_U-Boot</code> (en lugar de <code>0x08000000</code> ) para que la direcci√≥n de descarga coincida con la actual.  Descargar ahora <del>  mapa del siguiente nivel </del>  otra imagen: </p><br><pre> <code class="plaintext hljs">(gdb) file ../freedom-u-sdk/work/HiFive_U-Boot/u-boot (gdb) tui en</code> </pre> <br><p>  Y vemos: </p><br><pre> <code class="plaintext hljs"> ‚îÇ304 /* ‚îÇ ‚îÇ305 * trap entry ‚îÇ ‚îÇ306 */ ‚îÇ ‚îÇ307 trap_entry: ‚îÇ ‚îÇ308 addi sp, sp, -32*REGBYTES ‚îÇ &gt;‚îÇ309 SREG x1, 1*REGBYTES(sp) ‚îÇ ‚îÇ310 SREG x2, 2*REGBYTES(sp) ‚îÇ ‚îÇ311 SREG x3, 3*REGBYTES(sp) ‚îÇ</code> </pre> <br><p>  Y saltamos entre las l√≠neas 308 y 309. Y no es sorprendente, dado que <code>$sp</code> contiene el valor <code>0xfffffffe31cdc0a0</code> .  Por desgracia, tambi√©n se "escapa" constantemente debido a la l√≠nea 307. Por lo tanto, intentaremos establecer un punto de interrupci√≥n en <code>trap_entry</code> y luego <code>0x80089800</code> nuevamente a <code>0x80089800</code> (punto de entrada de U-Boot), y esperamos que no requiera la configuraci√≥n correcta de registros antes de la transici√≥n ... Parece funcionar: </p><br><pre> <code class="plaintext hljs">(gdb) b trap_entry Breakpoint 1 at 0x80089a80: file /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S, line 308. (gdb) set variable $pc=0x80089800 (gdb) c Continuing. Breakpoint 1, trap_entry () at /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S:308 (gdb) p/x $sp $4 = 0x81cf950</code> </pre> <br><p>  Entonces, el puntero de la pila, digamos sin rodeos: generalmente apunta m√°s all√° de la RAM (a menos que, por supuesto, todav√≠a tengamos traducci√≥n de direcciones, pero esperemos una opci√≥n simple). </p><br><p>  Intentemos reemplazar el puntero con <code>0x881cf950</code> .  Como resultado, llegamos al hecho de que se llama y se llama a <code>_exit_trap</code> , mientras se deja en <code>_exit_trap</code> con el argumento <code>epc=2148315240</code> (en decimal): </p><br><pre> <code class="plaintext hljs">(gdb) x/10i 2148315240 0x800cb068 &lt;strnlen+12&gt;: lbu a4,0(a5) 0x800cb06c &lt;strnlen+16&gt;: bnez a4,0x800cb078 &lt;strnlen+28&gt; 0x800cb070 &lt;strnlen+20&gt;: sub a0,a5,a0 0x800cb074 &lt;strnlen+24&gt;: ret 0x800cb078 &lt;strnlen+28&gt;: addi a5,a5,1 0x800cb07c &lt;strnlen+32&gt;: j 0x800cb064 &lt;strnlen+8&gt; 0x800cb080 &lt;strdup&gt;: addi sp,sp,-32 0x800cb084 &lt;strdup+4&gt;: sd s0,16(sp) 0x800cb088 &lt;strdup+8&gt;: sd ra,24(sp) 0x800cb08c &lt;strdup+12&gt;: li s0,0</code> </pre> <br><p>  Establecemos un punto de interrupci√≥n en <code>strnlen</code> , continuamos y vemos: </p><br><pre> <code class="plaintext hljs">(gdb) bt #0 strnlen (s=s@entry=0x10060000 "", count=18446744073709551615) at lib/string.c:283 #1 0x00000000800cc14c in string (buf=buf@entry=0x881cbd4c "", end=end@entry=0x881cc15c "", s=0x10060000 "", field_width=&lt;optimized out&gt;, precision=&lt;optimized out&gt;, flags=&lt;optimized out&gt;) at lib/vsprintf.c:265 #2 0x00000000800cc63c in vsnprintf_internal (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=0x800d446e "s , epc %08x , ra %08lx\n", fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=0x881cc1a0, args@entry=0x881cc188) at lib/vsprintf.c:619 #3 0x00000000800cca54 in vsnprintf (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=args@entry=0x881cc188) at lib/vsprintf.c:710 #4 0x00000000800cca68 in vscnprintf (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=args@entry=0x881cc188) at lib/vsprintf.c:717 #5 0x00000000800ccb50 in printf (fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n") at lib/vsprintf.c:792 #6 0x000000008008a9f0 in _exit_trap (regs=&lt;optimized out&gt;, epc=2148315240, code=&lt;optimized out&gt;) at arch/riscv/lib/interrupts.c:92 #7 handle_trap (mcause=&lt;optimized out&gt;, epc=&lt;optimized out&gt;, regs=&lt;optimized out&gt;) at arch/riscv/lib/interrupts.c:55 #8 0x0000000080089b10 in trap_entry () at /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S:343 Backtrace stopped: frame did not save the PC</code> </pre> <br><p>  Parece que <code>_exit_trap</code> quiere dar informaci√≥n de depuraci√≥n sobre la excepci√≥n que ocurri√≥, <em>pero falla</em> .  Entonces, algo con nuestro c√≥digo fuente no se muestra nuevamente.  <code>set directories ../freedom-u-sdk/HiFive_U-Boot/</code> ¬°Oh!  Ahora se muestra! </p><br><p>  Bueno, ejec√∫telo nuevamente y vea en la pila rastrear la causa del problema original que caus√≥ el primer error ( <code>mcause == 5</code> ).  Si entiendo correctamente lo que est√° escrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> en la p√°gina 37, entonces esta excepci√≥n significa <code>Load access fault</code> .  La raz√≥n, aparentemente, es porque aqu√≠ </p><br><p>  <strong>arch / riscv / cpu / HiFive / start.S:</strong> </p><br><pre> <code class="plaintext hljs">call_board_init_f: li t0, -16 li t1, CONFIG_SYS_INIT_SP_ADDR and sp, t1, t0 /* force 16 byte alignment */ #ifdef CONFIG_DEBUG_UART jal debug_uart_init #endif call_board_init_f_0: mv a0, sp jal board_init_f_alloc_reserve mv sp, a0 jal board_init_f_init_reserve mv a0, zero /* a0 &lt;-- boot_flags = 0 */ la t5, board_init_f jr t5 /* jump to board_init_f() */</code> </pre><br><p>  <code>$sp</code> tiene el mismo valor incorrecto y se produce un error dentro de <code>board_init_f_init_reserve</code> .  Ese parece ser el culpable: una variable con el nombre expl√≠cito <code>CONFIG_SYS_INIT_SP_ADDR</code> .  Est√° definido en el archivo <code>HiFive_U-Boot/include/configs/HiFive-U540.h</code> .  En alg√∫n momento, incluso pens√©, o tal vez, bueno, terminar el gestor de arranque para el procesador, ¬øtal vez es m√°s f√°cil arreglar ligeramente el procesador?  Pero luego vi que era m√°s como un artefacto de la configuraci√≥n no completamente <code>#if 0</code> para una configuraci√≥n de memoria diferente, y puede intentar hacer esto: </p><br><pre> <code class="diff hljs">diff --git a/include/configs/HiFive-U540.hb/include/configs/HiFive-U540.h index ca89383..245542c 100644 --- a/include/configs/HiFive-U540.h +++ b/include/configs/HiFive-U540.h @@ -65,12 +65,9 @@ #define CONFIG_SYS_SDRAM_BASE PHYS_SDRAM_0 #endif #if 1 -/*#define CONFIG_NR_DRAM_BANKS 1*/ +#define CONFIG_NR_DRAM_BANKS 1 #define PHYS_SDRAM_0 0x80000000 /* SDRAM Bank #1 */ -#define PHYS_SDRAM_1 \ - (PHYS_SDRAM_0 + PHYS_SDRAM_0_SIZE) /* SDRAM Bank #2 */ -#define PHYS_SDRAM_0_SIZE 0x80000000 /* 2 GB */ -#define PHYS_SDRAM_1_SIZE 0x10000000 /* 256 MB */ +#define PHYS_SDRAM_0_SIZE 0x40000000 /* 1 GB */ #define CONFIG_SYS_SDRAM_BASE PHYS_SDRAM_0 #endif /* @@ -81,7 +78,7 @@ #define CONSOLE_ARG "console=ttyS0,115200\0" /* Init Stack Pointer */ -#define CONFIG_SYS_INIT_SP_ADDR (0x08000000 + 0x001D0000 - \ +#define CONFIG_SYS_INIT_SP_ADDR (0x80000000 + 0x001D0000 - \ GENERATED_GBL_DATA_SIZE) #define CONFIG_SYS_LOAD_ADDR 0xa0000000 /* partway up SDRAM */</code> </pre> <br><p>  En alg√∫n momento, la cantidad <del>  muletas </del>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los sujetadores tecnol√≥gicos</a> alcanzaron un punto cr√≠tico.  Despu√©s de un peque√±o tormento, llegu√© a la necesidad de hacer el puerto correcto en mi placa.  Para hacer esto, debe copiar y corregir una cierta cantidad de archivos para nuestra configuraci√≥n. </p><br><div class="spoiler">  <b class="spoiler_title">Bueno, aproximadamente, aqu√≠ hay una mesita</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">trosinenko@trosinenko-pc:/hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot$ git show --name-status commit 39cd67d59c16ac87b46b51ac1fb58f16f1eb1048 (HEAD -&gt; zeowaa-1gb) Author: Anatoly Trosinenko &lt;anatoly.trosinenko@gmail.com&gt; Date: Tue Jul 2 17:13:16 2019 +0300 Initial support for Zeowaa A-E115FB board M arch/riscv/Kconfig A arch/riscv/cpu/zeowaa-1gb/Makefile A arch/riscv/cpu/zeowaa-1gb/cpu.c A arch/riscv/cpu/zeowaa-1gb/start.S A arch/riscv/cpu/zeowaa-1gb/timer.c A arch/riscv/cpu/zeowaa-1gb/u-boot.lds M arch/riscv/dts/Makefile A arch/riscv/dts/zeowaa-1gb.dts A board/Zeowaa/zeowaa-1gb/Kconfig A board/Zeowaa/zeowaa-1gb/MAINTAINERS A board/Zeowaa/zeowaa-1gb/Makefile A board/Zeowaa/zeowaa-1gb/Zeowaa-A-E115FB.c A configs/zeowaa-1gb_defconfig A include/configs/zeowaa-1gb.h</code> </pre> <br><p>  Los detalles se pueden encontrar en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> . </p></div></div><br><p>  Al final result√≥ que, en esta placa SiFive, los registros de algunos dispositivos tienen direcciones diferentes.  Tambi√©n result√≥ que U-Boot est√° configurado por el mecanismo Kconfig, ya familiarizado con el kernel de Linux; por ejemplo, puede ordenar <code>make menuconfig</code> , y ver√° una interfaz de texto conveniente con las descripciones de los par√°metros que se muestran en <code>?</code>  etc.  En general, despu√©s de cegar la descripci√≥n de la tercera de las descripciones de las dos placas, descartando cualquier pat√©tica reconfiguraci√≥n de PLL desde all√≠ (aparentemente, esto est√° de alguna manera conectado con el control PCIe desde la computadora host, pero esto no es exacto), obtuve un firmware, que, si el clima es correcto en Marte Me dio un mensaje UART sobre de qu√© hash de confirmaci√≥n se recopil√≥ y cu√°nta DRAM tengo (pero tambi√©n registr√© esta informaci√≥n en el encabezado). </p><br><p>  Es una pena que despu√©s de esto, la placa generalmente dejara de responder con el procesador JTAG, y el arranque desde la tarjeta SD, por desgracia, no es r√°pido en mi configuraci√≥n.  Por otro lado, a veces BootROM mostraba un mensaje de que <code>ERROR</code> no pod√≠a arrancar, y U-Boot apareci√≥ inmediatamente.  Fue entonces cuando ca√≠ en la cuenta: aparentemente, despu√©s de reiniciar el flujo de bits, la memoria no se deshilacha en el FPGA, no tiene tiempo para "romperse", etc.  En resumen, puede simplemente cuando aparece el mensaje <code>LOADING /</code> , conectarse con un depurador y una <code>set variable $pc=0x80089800</code> comandos <code>set variable $pc=0x80089800</code> , evitando as√≠ esta descarga larga (por supuesto, suponiendo que se rompi√≥ bastante temprano y no tuvo tiempo encima del c√≥digo original descargar). </p><br><p>  Por cierto, y generalmente es normal que el procesador se cuelgue completamente y que el depurador JTAG con mensajes no pueda conectarse a √©l </p><br><pre> <code class="plaintext hljs">Error: unable to halt hart 0 Error: dmcontrol=0x80000001 Error: dmstatus =0x00030c82</code> </pre> <br><p>  ¬°Entonces espera!  Ya lo vi! -     TileLink,      -   ‚Äî   ‚Ä¶ ,           : </p><br><pre> <code class="plaintext hljs">INIT CMD0 CMD8 ACMD41 CMD58 CMD16 CMD18 LOADING BOOT U-Boot 2018.09-g39cd67d-dirty (Jul 03 2019 - 13:50:33 +0300) DRAM: 1 GiB MMC: BEFORE LOAD ENVBEFORE FDTCONTROLADDRBEFORE LOADADDRIn: serial Out: serial Err: serial Hit any key to stop autoboot: 3</code> </pre> <br><p>      <code>In: serial</code>    ‚Äî       ,      environment.  , ¬´    ¬ª?          !  :  U-Boot      2^24   SD-, ,    <del>   </del>  ,      ,        ,   ELF-,    .  : ,       ,     . </p><br><p> ,    ? ,    -  ... </p><br><pre> <code class="plaintext hljs">(gdb) x/x 0x0200bff8 0x200bff8: 0x00000000</code> </pre> <br><p>  ,    ? </p><br><pre> <code class="plaintext hljs">(gdb) set variable *0x0200bff8=310000000 (gdb) c</code> </pre> <br><p> : </p><br><pre> <code class="plaintext hljs">Hit any key to stop autoboot: 0 MMC_SPI: 0 at 0:1 hz 20000000 mode 0</code> </pre> <br><p> :   . , -        : </p><br><p> <strong>HiFive_U-Boot/cmd/bootmenu.c:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bootmenu_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct bootmenu_data *menu, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">enum</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bootmenu_key *key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *esc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!tstc()) { WATCHDOG_RESET(); mdelay(<span class="hljs-number"><span class="hljs-number">10</span></span>); } c = getc(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*esc) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-comment"><span class="hljs-comment">/* First char of ANSI escape sequence '\e' */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'\e'</span></span>) { *esc = <span class="hljs-number"><span class="hljs-number">1</span></span>; *key = KEY_NONE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-comment"><span class="hljs-comment">/* Second char of ANSI '[' */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-string"><span class="hljs-string">'['</span></span>) { ...</code> </pre> <br><p>  <abbr title="En realidad no, al menos no solo en esto, ver m√°s">  </abbr> ,    :      : </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">DTSTimebase</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">BigInt</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><p> ‚Ä¶   ,      ¬´   ‚Äî  0¬ª.   <code>WithNBigCores</code>      1MHz (, ,      U-Boot).   , ,   :    ,  25MHz!     .   ¬´¬ª ... </p><br><pre> <code class="plaintext hljs">Hit any key to stop autoboot: 0 MMC_SPI: 0 at 0:1 hz 20000000 mode 0 ## Unknown partition table type 0 libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND ** No partition table - mmc 0 ** ## Info: input data size = 34 = 0x22 Running uEnv.txt boot2... ## Error: "boot2" not defined HiFive-Unleashed #</code> </pre> <br><p>    ! ,  , , ,   <code>mmc_spi 1 10000000 0; mmc part</code> ,   SPI  20MHz  10MHz.  Por qu√© ,       20MHz,      . ,   , ,    ,  :      (  ‚Äî  25MHz)  ,           .   ,    115200Hz UART-   ,  ,     25000000  20000000  1, ..     25MHz. ,   ,    , ,  -  (   )‚Ä¶  ,      ‚Äî  , , . 25MHz ‚Äî    Core i9. </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">HiFive-Unleashed # env edit mmcsetup edit: mmc_spi 1 10000000 0; mmc part HiFive-Unleashed # boot MMC_SPI: 1 at 0:1 hz 10000000 mode 0 Partition Map for MMC device 0 -- Partition Type: EFI Part Start LBA End LBA Name Attributes Type GUID Partition GUID 1 0x00000800 0x0000ffde "Vfat Boot" attrs: 0x0000000000000000 type: ebd0a0a2-b9e5-4433-87c0-68b6b72699c7 type: data guid: 76bd71fd-1694-4ff3-8197-bfa81699c2fb 2 0x00040800 0x002efaf4 "root" attrs: 0x0000000000000000 type: 0fc63daf-8483-4772-8e79-3d69d8477de4 type: linux guid: 9f3adcc5-440c-4772-b7b7-283124f38bf3 3 0x0000044c 0x000007e4 "uboot" attrs: 0x0000000000000000 type: 5b193300-fc78-40cd-8002-e86c45580b47 guid: bb349257-0694-4e0f-9932-c801b4d76fa3 4 0x00000400 0x0000044b "uboot-env" attrs: 0x0000000000000000 type: a09354ac-cd63-11e8-9aff-70b3d592f0fa guid: 4db442d0-2109-435f-b858-be69629e7dbf libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND 2376 bytes read in 0 ms Running uEnv.txt boot2... 15332118 bytes read in 0 ms ## Loading kernel from FIT Image at 90000000 ... Using 'config-1' configuration Trying 'bbl' kernel subimage Description: BBL/SBI/riscv-pk Type: Kernel Image Compression: uncompressed Data Start: 0x900000d4 Data Size: 74266 Bytes = 72.5 KiB Architecture: RISC-V OS: Linux Load Address: 0x80000000 Entry Point: 0x80000000 Hash algo: sha256 Hash value: 28972571467c4ad0cf08a81d9cf92b9dffc5a7cb2e0cd12fdbb3216cf1f19cbd Verifying Hash Integrity ... sha256+ OK ## Loading fdt from FIT Image at 90000000 ... Using 'config-1' configuration Trying 'fdt' fdt subimage Description: unavailable Type: Flat Device Tree Compression: uncompressed Data Start: 0x90e9d31c Data Size: 6911 Bytes = 6.7 KiB Architecture: RISC-V Load Address: 0x81f00000 Hash algo: sha256 Hash value: 10b0244a5a9205357772ea1c4e135a4f882409262176d8c7191238cff65bb3a8 Verifying Hash Integrity ... sha256+ OK Loading fdt from 0x90e9d31c to 0x81f00000 Booting using the fdt blob at 0x81f00000 ## Loading loadables from FIT Image at 90000000 ... Trying 'kernel' loadables subimage Description: Linux kernel Type: Kernel Image Compression: uncompressed Data Start: 0x900123e8 Data Size: 10781356 Bytes = 10.3 MiB Architecture: RISC-V OS: Linux Load Address: 0x80200000 Entry Point: unavailable Hash algo: sha256 Hash value: 72a9847164f4efb2ac9bae736f86efe7e3772ab1f01ae275e427e2a5389c84f0 Verifying Hash Integrity ... sha256+ OK Loading loadables from 0x900123e8 to 0x80200000 ## Loading loadables from FIT Image at 90000000 ... Trying 'ramdisk' loadables subimage Description: buildroot initramfs Type: RAMDisk Image Compression: gzip compressed Data Start: 0x90a5a780 Data Size: 4467411 Bytes = 4.3 MiB Architecture: RISC-V OS: Linux Load Address: 0x82000000 Entry Point: unavailable Hash algo: sha256 Hash value: 883dfd33ca047e3ac10d5667ffdef7b8005cac58b95055c2c2beda44bec49bd0 Verifying Hash Integrity ... sha256+ OK Loading loadables from 0x90a5a780 to 0x82000000</code> </pre> </div></div><br><p> ,     ,     .      .  mcause ,      <code>$pc</code>   <code>si</code>   <code>trap_entry</code> .    U-Boot     mcause = 0..4,      .     ,  ,    ,  :    <code>conf/rvboot-fit.txt</code> : </p><br><pre> <code class="plaintext hljs">fitfile=image.fit # below much match what's in FIT (ugha)</code> </pre> <br><p>  ,     ,      ,   ,  <code>SIF0</code> ‚Äî  <abbr title="En realidad no, como result√≥ despu√©s"> -  PCIe</abbr> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-bootargs=console=ttySIF0,921600 debug +bootargs=console=ttyS0,125200 debug</span></span></code> </pre> <br><p>        SHA-256  MD5:     ( ,  ),    ,         MD5 ‚Äî  .  Cual es el resultado?        (    ),   : </p><br><pre> <code class="plaintext hljs">... Verifying Hash Integrity ... md5+ OK Loading loadables from 0x90a5a758 to 0x82000000 libfdt fdt_check_header(): FDT_ERR_BADMAGIC chosen { linux,initrd-end = &lt;0x00000000 0x83000000&gt;; linux,initrd-start = &lt;0x00000000 0x82000000&gt;; riscv,kernel-end = &lt;0x00000000 0x80a00000&gt;; riscv,kernel-start = &lt;0x00000000 0x80200000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; }; libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND chosen { linux,initrd-end = &lt;0x00000000 0x83000000&gt;; linux,initrd-start = &lt;0x00000000 0x82000000&gt;; riscv,kernel-end = &lt;0x00000000 0x80a00000&gt;; riscv,kernel-start = &lt;0x00000000 0x80200000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; }; Loading Kernel Image ... OK Booting kernel in 3</code> </pre> <br><p>     ... </p><br><pre> <code class="plaintext hljs">(gdb) x/x 0x0200bff8 0x200bff8: 0x00000000</code> </pre> <br><p> , ,     ,     ,  . , ,  ,         ,  : </p><br><pre> <code class="plaintext hljs">0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=1000000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=2000000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x00000000bff6dbb0 in ?? () (gdb) set variable *0x0200bff8=3000000 (gdb) c Continuing.</code> </pre> <br><p>  ... </p><br><pre> <code class="plaintext hljs"> Loading Kernel Image ... OK Booting kernel in 3 2 1 0 ## Starting application at 0x80000000 ...</code> </pre> <br><p>  ,     ‚Äî  , ,     ! </p><br><p>        -  </p><br><pre> <code class="plaintext hljs">0000000080001c20 &lt;poweroff&gt;: 80001c20: 1141 addi sp,sp,-16 80001c22: e022 sd s0,0(sp) 80001c24: 842a mv s0,a0 80001c26: 00005517 auipc a0,0x5 80001c2a: 0ca50513 addi a0,a0,202 # 80006cf0 &lt;softfloat_countLeadingZeros8+0x558&gt; 80001c2e: e406 sd ra,8(sp) 80001c30: f7fff0ef jal ra,80001bae &lt;printm&gt; 80001c34: 8522 mv a0,s0 80001c36: 267000ef jal ra,8000269c &lt;finisher_exit&gt; 80001c3a: 00010797 auipc a5,0x10 80001c3e: 41e78793 addi a5,a5,1054 # 80012058 &lt;htif&gt; 80001c42: 639c ld a5,0(a5) 80001c44: c399 beqz a5,80001c4a &lt;poweroff+0x2a&gt; 80001c46: 72c000ef jal ra,80002372 &lt;htif_poweroff&gt; 80001c4a: 45a1 li a1,8 80001c4c: 4501 li a0,0 80001c4e: dc7ff0ef jal ra,80001a14 &lt;send_ipi_many&gt; 80001c52: 10500073 wfi 80001c56: bff5 j 80001c52 &lt;poweroff+0x32&gt;</code> </pre> <br><p>   Berkeley Boot Loader.       <code>htif</code> ‚Äî host interface,   tethered-  (      ARM), -  standalone. ,      ,  ,     : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poweroff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> code)</span></span></span><span class="hljs-function"> </span></span>{ printm(<span class="hljs-string"><span class="hljs-string">"Power off\r\n"</span></span>); finisher_exit(code); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (htif) { htif_poweroff(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { send_ipi_many(<span class="hljs-number"><span class="hljs-number">0</span></span>, IPI_HALT); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"wfi\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; } } }</code> </pre> <br><h2 id="kvest-zapusti-chasy"> :   </h2><br><p>    CLINT    </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> io = <span class="hljs-type"><span class="hljs-type">IO</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bundle</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rtcTick = <span class="hljs-type"><span class="hljs-type">Bool</span></span>(<span class="hljs-type"><span class="hljs-type">INPUT</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> time = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-type"><span class="hljs-type">UInt</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, width = timeWidth)) when (io.rtcTick) { time := time + <span class="hljs-type"><span class="hljs-type">UInt</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) }</code> </pre> <br><p>    RTC,    MockAON,     : ¬´,     ? ? !¬ª      ,       ,       <code>System.scala</code> : </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rtcDivider = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span>asUInt(<span class="hljs-number"><span class="hljs-number">16.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)) <span class="hljs-comment"><span class="hljs-comment">//      16,   :) val mhzInt = p(DevKitFPGAFrequencyKey).toInt // ,      rtcDivider := Mux(rtcDivider === (mhzInt - 1).U, 0.U, rtcDivider + 1.U) outer.clintOpt.foreach { clint =&gt; clint.module.io.rtcTick := rtcDivider === 0.U }</span></span></code> </pre> <br><h2 id="probirayas-k-linux-kernel">   Linux kernel </h2><br><p>           ,    : </p><br><p> BBL   FDT   <code>0xF0000000</code> ,     !   ,  ‚Ä¶   <strong>HiFive_U-Boot/arch/riscv/lib/boot.c</strong> ,   <code>0x81F00000</code> ,     U-Boot. </p><br><p>  BBL ,   .      <code>mem_prop</code> ,   <strong>riscv-pk/machine/fdt.c</strong> :   ,     fdt ram  <code>device_type = "memory"</code> ‚Äî , ,     ,      ‚Äî       . </p><br><p>     (   ,   ): </p><br><pre> <code class="plaintext hljs">This is bbl's dummy_payload. To boot a real kernel, reconfigure bbl with the flag --with-payload=PATH, then rebuild bbl. Alternatively, bbl can be used in firmware-only mode by adding device-tree nodes for an external payload and use QEMU's -bios and -kernel options.</code> </pre> <br><p> ,      <code>riscv,kernel-start</code>  <code>riscv,kernel-end</code>  DTB,   .  <code>query_chosen</code> ,  BBL   32- ,     <code>&lt;0x0 0xADDR&gt;</code> ,   , ,  .    <code>chosen</code> </p><br><pre> <code class="plaintext hljs">chosen { #address-cells = &lt;1&gt;; #size-cells = &lt;0&gt;; ... }</code> </pre> <br><p>    : <abbr title="Pero hay una mejor soluci√≥n">  <code>0x0</code>  </abbr> . </p><br><p>  100500       ,   : </p><br><div class="spoiler">  <b class="spoiler_title">Texto oculto</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> Verifying Hash Integrity ... md5+ OK Loading loadables from 0x90a5a758 to 0x82000000 libfdt fdt_check_header(): FDT_ERR_BADMAGIC chosen { linux,initrd-end = &lt;0x83000000&gt;; linux,initrd-start = &lt;0x82000000&gt;; riscv,kernel-end = &lt;0x80a00000&gt;; riscv,kernel-start = &lt;0x80200000&gt;; #address-cells = &lt;0x00000001&gt;; #size-cells = &lt;0x00000000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; stdout-path = "uart0:38400n8"; }; libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND chosen { linux,initrd-end = &lt;0x83000000&gt;; linux,initrd-start = &lt;0x82000000&gt;; riscv,kernel-end = &lt;0x80a00000&gt;; riscv,kernel-start = &lt;0x80200000&gt;; #address-cells = &lt;0x00000001&gt;; #size-cells = &lt;0x00000000&gt;; bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait"; stdout-path = "uart0:38400n8"; }; Loading Kernel Image ... OK Booting kernel in 3 2 1 0 ## Starting application at 0x80000000 ... bbl loader SIFIVE, INC. 5555555555555555555555555 5555 5555 5555 5555 5555 5555 5555 5555555555555555555555 5555 555555555555555555555555 5555 5555 5555 5555 5555 5555 5555555555555555555555555555 55555 55555 555555555 55555 55555 55555 55555 55555 5 55555 55555 55555 55555 55555 55555 55555 55555 55555 55555 55555 555555555 55555 5 SiFive RISC-V Core IP [ 0.000000] OF: fdt: Ignoring memory range 0x80000000 - 0x80200000 [ 0.000000] Linux version 4.19.0-sifive-1+ (trosinenko@trosinenko-pc) (gcc version 8.3.0 (Buildroot 2019.02-07449-g4eddd28f99)) #1 SMP Wed Jul 3 21:29:21 MSK 2019 [ 0.000000] bootconsole [early0] enabled [ 0.000000] Initial ramdisk at: 0x(____ptrval____) (16777216 bytes) [ 0.000000] Zone ranges: [ 0.000000] DMA32 [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] Normal [mem 0x00000000c0000000-0x00000bffffffffff] [ 0.000000] Movable zone start for each node [ 0.000000] Early memory node ranges [ 0.000000] node 0: [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] Initmem setup node 0 [mem 0x0000000080200000-0x00000000bfffffff] [ 0.000000] On node 0 totalpages: 261632 [ 0.000000] DMA32 zone: 3577 pages used for memmap [ 0.000000] DMA32 zone: 0 pages reserved [ 0.000000] DMA32 zone: 261632 pages, LIFO batch:63 [ 0.000000] software IO TLB: mapped [mem 0xbb1fc000-0xbf1fc000] (64MB)</code> </pre> </div></div><br><p> (  BBL,       ‚Äî ). </p><br><p>  ,  ,  ,   RocketChip     JTAG   trap-   ‚Äî      . </p><br><pre> <code class="plaintext hljs">Program received signal SIGTRAP, Trace/breakpoint trap. 0xffffffe0000024ca in ?? () (gdb) bt #0 0xffffffe0000024ca in ?? () Backtrace stopped: previous frame identical to this frame (corrupt stack?) (gdb) file work/linux/vmlinux A program is being debugged already. Are you sure you want to change the file? (y or n) y Reading symbols from work/linux/vmlinux...done. (gdb) bt #0 0xffffffe0000024ca in setup_smp () at /hdd/trosinenko/fpga/freedom-u-sdk/linux/arch/riscv/kernel/smpboot.c:75 #1 0x0000000000000000 in ?? () Backtrace stopped: frame did not save the PC</code> </pre> <br><p> <strong>freedom-u-sdk/linux/arch/riscv/kernel/smpboot.c:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-function">init </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup_smp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_node</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dn</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NULL</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hart; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found_boot_cpu = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cpuid = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((dn = of_find_node_by_type(dn, <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>))) { hart = riscv_of_processor_hartid(dn); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hart == cpuid_to_hartid_map(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { BUG_ON(found_boot_cpu); found_boot_cpu = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } cpuid_to_hartid_map(cpuid) = hart; set_cpu_possible(cpuid, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); set_cpu_present(cpuid, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); cpuid++; } BUG_ON(!found_boot_cpu); <span class="hljs-comment"><span class="hljs-comment">// &lt;    }</span></span></code> </pre> <br><p>     , <em>CPU not found, running software emulation</em> .    running.     . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* The lucky hart to first increment this variable will boot the other cores */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">atomic_t</span></span> hart_lottery; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> boot_cpu_hartid;</code> </pre> <br><p>    <strong>linux/arch/riscv/kernel/setup.c</strong> ‚Äî       .  ,   -  ,     ... </p><br><p>         . </p><br><p>  .       ,   ,      singlestep-. </p><br><p>    ( ): <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://asciinema.org/a/h22F5eCMXYF9n7n89CY6NJNEi.svg" alt="asciicast"></a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/458482/">https://habr.com/ru/post/458482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458464/index.html">Enlace gigabit de 3 km en m√≥dems l√°ser</a></li>
<li><a href="../458468/index.html">¬øC√≥mo ejecutar una impresionante reuni√≥n de Kanban StandUp?</a></li>
<li><a href="../458470/index.html">Texturizado, o lo que necesitas saber para convertirte en un Artista de Surface. Parte 2. M√°scaras y texturas.</a></li>
<li><a href="../458472/index.html">Compilaci√≥n de una clasificaci√≥n de territorios por el m√©todo de potenciales t√©rmicos utilizando datos abiertos</a></li>
<li><a href="../458474/index.html">Los mejores informes con HighLoad ++ 2018</a></li>
<li><a href="../458486/index.html">Secretos de trabajar con tela en el juego Alan Wake</a></li>
<li><a href="../458488/index.html">Data Science Digest (julio de 2019)</a></li>
<li><a href="../458490/index.html">Ag√°rrate fuerte al volante ... Nuestro proyecto para monitorear la condici√≥n de los conductores</a></li>
<li><a href="../458492/index.html">‚ÄúSiempre cre√≠mos en la competencia y en el derecho a elegir un usuario‚Äù ¬© Yandex</a></li>
<li><a href="../458494/index.html">Un ejemplo pr√°ctico del uso de las funciones de render de Vue: crear una cuadr√≠cula tipogr√°fica para un sistema de dise√±o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>