<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßùüèº üë©üèª‚Äçü§ù‚Äçüë®üèΩ ü§¶üèª Bot√£o m√°gico para LED no ATtiny4 üåã ‚úåÔ∏è ‚úçüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SESAM 


 H√° muito tempo, tive um interruptor milagroso sens√≠vel ao toque SESAM . Eu realmente gostei dele. Mas os tempos est√£o mudando, ele n√£o se en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot√£o m√°gico para LED no ATtiny4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411263/"><h4 id="sezam">  SESAM </h4><br><p> H√° muito tempo, tive um interruptor milagroso sens√≠vel ao toque <em>SESAM</em> .  Eu realmente gostei dele.  Mas os tempos est√£o mudando, ele n√£o se encaixa mais no interior e, em seguida, n√£o foi totalmente projetado para funcionar com todos os tipos de l√¢mpadas de economia de energia da moda.  Gostei do princ√≠pio de gerenciamento.  Um breve toque no sensor ligou / desligou a luz e um longo ajustou o brilho.  Quem se <em>importa</em> - o disjuntor foi o <em>K145AP2</em> , um an√°logo da <em>Siemens S576B</em> (o K145AP2 ainda √© vendido). </p><br><p>  Sob o corte, minha vers√£o de emular a opera√ß√£o deste chip. </p><a name="habracut"></a><br><p>  H√° pouco tempo, constru√≠ uma tira de LED em um perfil de alum√≠nio com um difusor acima da mesa para mim e surgiu a pergunta sobre o interruptor.  Preparar √© algo complicado.  Para ficar pendurado no arame - n√£o √© bonito, para um interruptor comum - estraga a vista e n√£o h√° realmente nenhum lugar para ir. </p><br><p>  Decidi construir um interruptor, e para um e um dimmer, no final do aglomerado de 16 mm.  Fa√ßa tocar, cubra com um adesivo, que os fabricantes de m√≥veis mascaram. </p><br><h4 id="zhelezo">  Ferro </h4><br><p>  Come√ßou com um sensor.  Tentei o princ√≠pio da transfer√™ncia de carga para o <em>ATtiny13A</em> .  A op√ß√£o est√° funcionando, mas eu estava com pregui√ßa de me preocupar com os par√¢metros de ajuste autom√°tico etc.  Ele tamb√©m n√£o pegou o final. </p><br><p>  Decidi tentar implementar o sensor na biblioteca <em>QTouch</em> .  Como um sensor <em>ATtiny10</em> .  Existe um utilit√°rio pronto que transforma o <em>ATtiny10</em> em um bot√£o de toque com todos os presentes.  Mas na sa√≠da, o bin√°rio √© dif√≠cil de adicionar seu c√≥digo l√°.  Pensei no que fazer, naveguei na Internet e me deparei <em>com uma</em> men√ß√£o ao <em>TTP223</em> - o controlador de um bot√£o de toque.  Esta op√ß√£o me serviu perfeitamente. </p><br><p>  Como o MK, a escolha recaiu sobre o <em>ATtiny4</em> .  T√£o pequeno quanto o <em>TTP223</em> , um timer de 16 bits.  Sim, e por um longo tempo eu quis fazer algo √∫til sobre esses tinki. </p><br><p>  Como uma chave - <em>P3055LD</em> da antiga placa-m√£e. </p><br><h4 id="pechatnaya-plata">  Placa de circuito </h4><br><p>  Ao desenvolver uma placa de circuito impresso, passei pelo fato de que os furos no final do cart√£o precisavam do m√≠nimo poss√≠vel, decidi que um di√¢metro de 7 mm seria suficiente.  A placa acabou 7x28mm, duas camadas. </p><br><p>  Mais tarde, quando a placa foi soldada, ficou claro que ela n√£o cabia no orif√≠cio de 7 mm, pelo menos 9 mm - n√£o levava em considera√ß√£o a altura dos elementos.  De alguma forma, a id√©ia com um adesivo tamb√©m deixou de gostar.  E ent√£o um esbo√ßo de m√≥veis chamou minha aten√ß√£o!  Projetado para furo de 10 mm e di√¢metro interno exatamente 7 mm!  Tudo coincidiu! </p><br><p>  O sensor √© aplicado em um len√ßo separado que √© soldado na extremidade principal.  Nas fotos voc√™ pode ver. </p><br><div class="spoiler">  <b class="spoiler_title">Imagens</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/geektimes/post_images/c90/811/124/c908111247ab756b2667c342f63910ef.jpg" alt="imagem legal"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/8e7/bb2/c17/8e7bb2c177c2f1f1940cc7a9edf1d7c6.jpg" alt="imagem legal"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/626/916/1bb/6269161bb3a78aa01bd7f6b77119af5d.jpg" alt="imagem legal"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e14/976/8f0/e149768f0a162a2598003f83d5741e4a.jpg" alt="imagem legal"></p></div></div><br><h4 id="programma">  O programa </h4><br><p>  O programa de controle √© escrito em assembler.  A cada 32 ms (Watchdog Timer) o sensor √© pesquisado.  Dependendo do estado atual e da dura√ß√£o da prensagem, determinadas a√ß√µes s√£o executadas.  A l√≥gica do trabalho √© um pouco diferente do prot√≥tipo <em>K145AP2</em> </p><br><p>  Se a luz estiver apagada (estado ap√≥s ligar): </p><br><ul><li>  Um breve toque acende a ilumina√ß√£o no mesmo n√≠vel em que foi desligada.  Quando ligado pela primeira vez com brilho m√°ximo </li><li>  Press√£o longa acende a luz no n√≠vel m√°ximo. </li></ul><br><p>  Se a luz estiver acesa: </p><br><ul><li>  Um breve toque apaga a luz </li><li>  Uma press√£o longa altera o brilho.  A dire√ß√£o da mudan√ßa de brilho muda pressionando repetidamente </li></ul><br><p>  Press√µes muito curtas (interfer√™ncia) do programa s√£o ignoradas.  O brilho √© definido pelo coeficiente PWM (16 bits).  Frequ√™ncia PWM de cerca de 122 Hz (8.000.000 Hz / 2 <sup>16</sup> ‚âà 122 Hz) </p><br><p>  <strong>Para compensar a percep√ß√£o psicofisiol√≥gica do brilho da ilumina√ß√£o a partir do brilho real, ocorre uma mudan√ßa no √∫ltimo ao longo de uma por√ß√£o da par√°bola c√∫bica</strong> .  Normalmente, as tabelas s√£o usadas para isso, mas na minha vers√£o o coeficiente √© calculado.  O coeficiente varia com a frequ√™ncia PWM, ou seja, quando o brilho muda, cada pulso √© obtido com sua pr√≥pria dura√ß√£o.  O valor m√≠nimo de PWM √© limitado por software. </p><br><p>  Na maioria das vezes, o MK dorme e consome cerca de 16 microamperes junto com o <em>TTP223</em> .  Ou seja, o circuito √© bastante adequado para dispositivos com energia aut√¥noma. </p><br><p>  <em>ATtiny4 tem</em> seis pinos.  Dois para energia, um padr√£o para redefini√ß√£o.  Eu j√° envolvi dois.  Apenas um sobrou.  Eu pensei em como us√°-lo.  E ent√£o me lembrei do laptop de um novo amigo com o trackpad Force Touch.  Como um experimento, decidi fazer algo semelhante.  N√£o preciso de muita confiabilidade da resposta e h√° muitos vibromotores de telefones antigos.  Como resultado, implementei uma fun√ß√£o no programa que aparece um impulso curto em uma sa√≠da livre, quando o limite de ajuste √© atingido.  No <em>K145AP2,</em> quando o limite de ajuste √© atingido, a dire√ß√£o do ajuste muda.  Portanto, era necess√°ria alguma habilidade para remover a m√£o do sensor no m√°ximo ou no m√≠nimo.  Na minha implementa√ß√£o, quando a borda √© atingida, o ajuste √© interrompido.  O tempo total de ajuste de um limite para outro √© de cerca de 4 segundos. </p><br><p>  C√≥digo dispon√≠vel no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Empurre!">GitHub</a> </p><br><h4 id="tpi-cherez-arduinu">  TPI via Arduino </h4><br><p>  Separadamente, observo a programa√ß√£o do MK.  Meu <em>JTAGICE3</em> n√£o suporta a interface de programa√ß√£o TPI.  Felizmente, por√©m, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pessoas boas escreveram um esbo√ßo no Arduin</a> para programar essa pequena coisa.  N√£o imediatamente, mas tudo deu certo para mim, o firmware foi inundado e tudo funcionou.  Al√©m dos arduinos, s√£o necess√°rios 4 resistores.  Todo o processo √© pintado em um esbo√ßo. </p><br><h4 id="itog">  Sum√°rio </h4><br><p>  O bot√£o m√°gico est√° instalado e funciona conforme o esperado.  O consumo e as dimens√µes atuais permitem que ele seja incorporado em dispositivos com energia aut√¥noma. </p><br><p>  N√£o obtive o efeito esperado da vibra√ß√£o.  Aqui, aparentemente, s√£o necess√°rias experi√™ncias com o local da instala√ß√£o. </p><br><p>  No prot√≥tipo <em>K145AP2</em> e no anal√≥gico <em>Siemens S576B,</em> h√° uma conclus√£o "Sleep".  Este √© um modo no qual o brilho diminui muito lentamente at√© que seja completamente desligado.  Conforme planejado pelo fabricante, para isso, um sensor adicional √© instalado pr√≥ximo √† cabeceira da cama.  16 bits do timer PWM ativam esse modo. </p><br><p>  Isto √© de id√©ias para o futuro. </p><br><div class="spoiler">  <b class="spoiler_title">Bot√£o no lugar</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/geektimes/post_images/757/2da/2b5/7572da2b50cf61fc18aef6e609b80650.jpg" alt="imagem legal"></p></div></div><br><p>  Como tudo. </p><br><p>  Obrigado a todos! </p><br><p>  UPD: Como prometido, aumentei a frequ√™ncia PWM para quase 1kHz.  C√≥digo do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Empurre!">Github</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt411263/">https://habr.com/ru/post/pt411263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt411253/index.html">A fus√£o de estrelas de n√™utrons p√¥s fim √†s alternativas de mat√©ria escura e energia escura</a></li>
<li><a href="../pt411255/index.html">Aplicativos descentralizados para milh√µes de usu√°rios no Ethereum</a></li>
<li><a href="../pt411257/index.html">Nos EUA, eles criam um sistema de laser que assusta o inimigo com som</a></li>
<li><a href="../pt411259/index.html">Conectamos um medidor de √°gua a uma casa inteligente</a></li>
<li><a href="../pt411261/index.html">Resposta vibrat√≥ria em pr√≥teses: uma nova maneira de melhorar o controle dos membros bi√¥nicos</a></li>
<li><a href="../pt411265/index.html">Casos de espi√£o (parte 3)</a></li>
<li><a href="../pt411267/index.html">Quem est√° realmente por tr√°s dos novos smartphones da marca Nokia?</a></li>
<li><a href="../pt411269/index.html">Os tr√™s componentes de "LOAD"</a></li>
<li><a href="../pt411271/index.html">Carro el√©trico Tesla Autopilot fica preso em trechos dif√≠ceis da estrada</a></li>
<li><a href="../pt411273/index.html">O primeiro estudo da atratividade dos robolits</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>