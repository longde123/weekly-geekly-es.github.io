<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏸️ 🤳🏽 🕴🏼 Thermomètre et hygromètre sur ATMEGA 328P-MU - Augmenter le niveau de développement Arduino 🧑🏽‍🤝‍🧑🏽 😢 🔐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, je veux partager l'un de mes projets Arduino. Il était une fois, il n'y a pas très longtemps, quelque part sur Internet, j'ai découvert A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Thermomètre et hygromètre sur ATMEGA 328P-MU - Augmenter le niveau de développement Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452234/"> Aujourd'hui, je veux partager l'un de mes projets Arduino.  Il était une fois, il n'y a pas très longtemps, quelque part sur Internet, j'ai découvert Arduino.  J'ai rejoint cette entreprise assez rapidement, le niveau d'entrée n'y est pas élevé.  Après un certain temps, après avoir déjà collecté un tas de capteurs, les capteurs d'une maison intelligente ont commencé à me surprendre en pensant que tout cela était hors de l'esprit. <a name="habracut"></a>  Modules, grandes boîtes unies, un tas de fils et de la colle chaude :).  En regardant ma boîte avec un capteur de température et, par exemple, le capteur de température du même Xiaomi, j'ai réalisé que je voudrais qu'elle ressemble à Xiaomi, mais en même temps que vous pouviez la reprogrammer comme la mienne dans une boîte de 10 cm par 6 cm avec des fils et de la colle thermofusible.  Et probablement le début de mes projets DIY Arduino sur des cartes PCB a été posé. <br><br>  Dans l'article d'aujourd'hui, nous parlerons d'un capteur de température et d'humidité basé sur le processeur atmega328p-mu.  Il s'agit d'une version «plus petite» (un analogue absolu) du processeur atmega328p-au (Arduino Uno, Pro Mini, Nano) connue de tous les développeurs Arduino.  Si quelqu'un a déjà lu mes articles, il sait que je préfère Mysensors.  Qu'est ce que c'est  Il s'agit d'une bibliothèque très simple et bien conçue et, ce qui est important, bien décrite pour Arduino IDE (et pas seulement) pour créer des réseaux radio IOT à des fréquences de 2,4 GHz, 915, 868, 433 MHz, ainsi que des réseaux câblés sur l'interface 485, peut-être pas tous mentionnés Le protocole évolue constamment, quelque chose est ajouté tout le temps. <br><br>  La première chose qui a été faite a été le capteur lui-même sur la carte PCB.  Je l'ai fait sans regarder le boîtier, selon le principe, l'essentiel est de fabriquer un capteur, et je vais imprimer le boîtier en quelque sorte ... ouais, ne le fais pas :)  En fait, le capteur lui-même est le même Arduinka Pro Mini, le module radio nRF24l01, le capteur de température et d'humidité SHT20, uniquement sans fils et colle chaude.  Parmi les «cloches et sifflets», il s'agit d'un lecteur flash SPI externe pour flasher dans les airs (le chargeur de démarrage DualOptibut est requis pour fonctionner, plus tard j'ai cessé de les mettre (lecteurs flash) sur les circuits imprimés, car il n'y a pas de firmware sur l'air et la moitié de la batterie) et le «micro crypto» ATSHA204A, pour ainsi dire, pour le plein kit matériel (dans Mysensors, pour activer les signatures, le chiffrement, etc., il vous suffit de spécifier le #def nécessaire au début du croquis). <br><br><img src="https://habrastorage.org/webt/mt/3r/ci/mt3rci4yk0yasyrccfbqe_ii3uw.jpeg"><br><br>  La carte elle-même a été créée dans le programme Diptrace, après avoir regardé les didacticiels vidéo sur YouTube, au début, cela semblait être quelque chose "d'enfer", mais en réalité, cela ne s'est pas avéré si difficile.  J'ai commandé des planches en Chine sur jlcpcb.com, 2 dollars, n'importe quelle couleur, et après 2 semaines, vous avez déjà 10 pièces de «votre propre création» en main :). <br><br><img src="https://habrastorage.org/webt/g8/vt/89/g8vt89xocfduchhvirqldwcurh4.png"><br><br><img src="https://habrastorage.org/webt/zu/wm/zs/zuwmzsu8ervyhmnbxzdfprmdbcu.jpeg"><br><br>  L'étape suivante a été le développement du corps.  Oh, cela s'est avéré être le même problème.  En général, je n'ai pas cherché de voies faciles, j'ai décidé de maîtriser le Solid Works.  Il s'est avéré que ce n'est pas du tout le cas avec Deeptrace.  Néanmoins, je recommande cet éditeur pour étude.  Le processus d'apprentissage a duré un mois en regardant tranquillement des leçons vidéo sur YouTube et en répétant la leçon dans l'éditeur.  Au cours du développement du boîtier, il est devenu clair que la fabrication d'une carte d'appareil sans tenir compte des paramètres du futur boîtier est une mauvaise décision, de la série où nous insérons les bâtons dans nos propres roues.  Selon les résultats des versions de la carte, trois sont sorties, en tenant compte de l'installation de la carte dans le boîtier, et je pense que ce n'est pas la dernière option. <br><br>  Au début du développement du bâtiment, l'idée était de l'imprimer sur une imprimante FDM 3D, mais plus il s'avançait dans la forêt, plus il devenait clair qu'il n'était pas en mesure de reproduire toute ma liste de souhaits.  Au moment où cette compréhension est arrivée, j'avais déjà appris l'existence d'une autre technologie d'impression 3D - SLA.  Sans réfléchir et impressionné par la qualité d'impression, la liste de souhaits sur Ali - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ANYCUBIC Photon a</a> été publiée.  (Lien ana Ali, pas de publicité, pas d'affiliation, ... juste un lien). <br><br>  J'écrirai tout de suite, maintenant, sur la base de mon expérience au moment de la rédaction de ce document, ... oh, cette chose cool est une chose cool !!!  Le cas qui a été conçu dans l'éditeur bien sûr et a été imprimé pas la première fois et il y a eu beaucoup d'améliorations.  Eh bien, ce n'est probablement pas l'inverse.  En conséquence, j'ai obtenu le résultat que je voulais.  Un appareil miniature, un bon étui de bricolage avec des détails très précis, des boutons, des polices, tout comme représenté dans la tête.  Un aimant a été ajouté au couvercle arrière, maintenant il peut être facilement monté sur des surfaces en fer. <br><br><img src="https://habrastorage.org/webt/q2/a8/yz/q2a8yzmu0x8pzg6qtxs9nf4d0sc.jpeg"><br><br><img src="https://habrastorage.org/webt/12/2j/pk/122jpkp-anp4zxqhshi7wp5bbga.jpeg"><br><br><img src="https://habrastorage.org/webt/er/il/ak/erilakhq5uhxtx09ab54rn5brao.jpeg"><br><br><img src="https://habrastorage.org/webt/d3/pa/fh/d3pafhom0t6ydozgxjgm_o0g9eo.jpeg"><br><br><img src="https://habrastorage.org/webt/k-/2i/yj/k-2iyjlk9snioo4vktlengxti_g.jpeg"><br><br><img src="https://habrastorage.org/webt/cc/du/yy/ccduyyya0_8awrvrplyrt4q3qze.jpeg"><br><br><img src="https://habrastorage.org/webt/et/nf/5w/etnf5wimx4pwsf6k76uh5gobk3e.jpeg"><br><br><img src="https://habrastorage.org/webt/re/g8/z9/reg8z9zer-swbz32kn5afhkvwsq.jpeg"><br><br>  Ce sont des tentatives d'imprimer le même modèle sur une imprimante FDM: <br><br><img src="https://habrastorage.org/webt/_i/et/hu/_iethu6tktjfhc85y3ulrh5xf8m.jpeg"><br><br><img src="https://habrastorage.org/webt/ow/6s/fh/ow6sfhpdvcmxy2lz0jemul6o0-i.jpeg"><br><br>  Puisque l'appareil s'est avéré être petit, mais c'est toujours un arduinka, j'ai été intrigué par la sortie de connecteurs miniatures pour la programmation.  Et en conséquence, un petit adaptateur a été conçu pour les connecteurs pour une connexion pratique avec le programmateur et le convertisseur TTL. <br><br><img src="https://habrastorage.org/webt/pl/-l/48/pl-l48rq33glvskysput8i6gu7y.jpeg"><br><br>  Tout a été acheté sur Ali (oui, il n'y a pas que des modules Arduino complets) <br><br>  Condensateur CMS au tantale 4.7uF - 4.7uF |  10v |  10% - C1 <br>  Condensateur céramique CMS 100nF |  Y5V - 100nF |  50v |  + 80-20% - C2, C3, C4, C5, C6, C7 <br>  LED - LED SIDE - D1 <br>  Embase à broches femelle - 2x3P |  6pin |  1,27 mm - J1, J2 <br>  Résistance CMS 20K Ohm - 20K |  5% - R1 <br>  Résistance CMS 4.7K Ohm - 4.7K |  5% - R2, R3, R4 <br>  Résistance CMS 470K Ohm - 470 |  1% - R5 <br>  Résistance CMS 1M Ohm - 1M |  1% - R6 <br>  Résistance CMS 18K Ohm - 18K |  5% - R7 <br>  Résistance CMS 10K Ohm - 10K |  5% - R8 <br>  Bouton latéral SMD à 4 broches - SW1, SW2 <br>  Mémoire flash série SPI 512 Kbit, 1,65 V - AT25DF512C-SSHN-B - U1 <br>  Mini NRF24L01 + 2,4 GHz 1,27 MM RF - nRF24l01 1,27 SMD - U2 <br>  ATMEGA328P-MU QFN32 - U3 <br>  AUTHENTIFICATION CRYPTO, 1 FIL - ATSHA204A-STUCZ-T - U4 <br>  IC capteur d'humidité et de température - SHT20 - U5 <br>  SUPPORT DE BATTERIE POUR CR2477-1 - L-KLS5-CR2477-1 - U6 <br><br>  Le code du programme est assez simple.  Un exemple de la bibliothèque DFRobot a été utilisé pour travailler avec le capteur SHT20.  En principe, n'importe quel croquis, pour n'importe quel capteur, peut être transformé en croquis pour travailler dans le réseau Mysensors en 5 minutes. <br><br><div class="spoiler">  <b class="spoiler_title">Liste des codes</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Wire.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DFRobot_SHT20.h"</span></span></span></span>
DFRobot_SHT20    sht20; <span class="hljs-comment"><span class="hljs-comment">// https://github.com/DFRobot/DFRobot_SHT20</span></span>

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_DEBUG</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_DISABLED_SERIAL</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_RADIO_RF24</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_PASSIVE_NODE</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_NODE_ID 200</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_PARENT_NODE_ID 0</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_PARENT_NODE_IS_STATIC</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_TRANSPORT_UPLINK_CHECK_DISABLED</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_OTA_FIRMWARE_FEATURE</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_SIGNING_ATSHA204</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_SIGNING_ATSHA204_PIN A3</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_SIGNING_REQUEST_SIGNATURES</span></span>

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TEMP_SENS_ID 1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HUM_SENS_ID 2</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SETTING_LED_SENS_ID 100</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DELAY_TIME_SENS_ID 101</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BATTARY_SEND_SENS_ID 102</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BATTARY_DATA_SENS_ID 103</span></span>

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BAT_COOF 3.04</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BAT_MIN 195</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BAT_MAX 295</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ON 1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OFF 0</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> humd;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> temp;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> oldhumd;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> oldtemp;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> tempThreshold = <span class="hljs-number"><span class="hljs-number">0.5</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> humThreshold = <span class="hljs-number"><span class="hljs-number">10.0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> lightMillis;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> previousMillis;
<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> send_batteryTime;
<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> w_battetyTime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> led_pin = <span class="hljs-number"><span class="hljs-number">4</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> mode_pin = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">// interrupt</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> delayTime;
<span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> battery;
<span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> old_battery;
<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> set_led;
boolean sleep_mode;
boolean configMode = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> timer_status = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> listen_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;MySensors.h&gt;</span></span></span></span>

<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_temp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TEMP_SENS_ID, V_TEMP)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_hum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HUM_SENS_ID, V_HUM)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_setting_led</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SETTING_LED_SENS_ID, V_VAR1)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_delay_time</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DELAY_TIME_SENS_ID, V_VAR1)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_battary_send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BATTARY_SEND_SENS_ID, V_VAR1)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">powerMsg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BATTARY_DATA_SENS_ID, V_VAR1)</span></span></span></span>;

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preHwInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  pinMode(led_pin, OUTPUT);
  digitalWrite(led_pin, OFF);
  pinMode(mode_pin, INPUT_PULLUP);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">before</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  set_led = loadState(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) {
    set_led = <span class="hljs-number"><span class="hljs-number">1</span></span>;
    saveState(<span class="hljs-number"><span class="hljs-number">100</span></span>, set_led);
  }
  delayTime = loadState(<span class="hljs-number"><span class="hljs-number">101</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (delayTime &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>) {
    delayTime = <span class="hljs-number"><span class="hljs-number">3</span></span>;
    saveState(<span class="hljs-number"><span class="hljs-number">101</span></span>, delayTime);
  }
  send_batteryTime = loadState(<span class="hljs-number"><span class="hljs-number">102</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (send_batteryTime &gt; <span class="hljs-number"><span class="hljs-number">48</span></span>) {
    send_batteryTime = <span class="hljs-number"><span class="hljs-number">6</span></span>;
    saveState(<span class="hljs-number"><span class="hljs-number">102</span></span>, send_batteryTime);
  }


  digitalWrite(led_pin, ON);
}


<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">presentation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  sendSketchInfo(<span class="hljs-string"><span class="hljs-string">"Temp &amp; Hum Sensor CR2477"</span></span>, <span class="hljs-string"><span class="hljs-string">"1.0"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(TEMP_SENS_ID, S_TEMP, <span class="hljs-string"><span class="hljs-string">"TEMPERATURE DATA"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(HUM_SENS_ID, S_HUM, <span class="hljs-string"><span class="hljs-string">"HUMIDITY DATA"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(SETTING_LED_SENS_ID, S_CUSTOM, <span class="hljs-string"><span class="hljs-string">"LED MODE"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(DELAY_TIME_SENS_ID, S_CUSTOM, <span class="hljs-string"><span class="hljs-string">"DELAY TIME/MIN"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(BATTARY_SEND_SENS_ID, S_CUSTOM, <span class="hljs-string"><span class="hljs-string">"BATTERY SEND TIME/H"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(BATTARY_DATA_SENS_ID, S_CUSTOM, <span class="hljs-string"><span class="hljs-string">"BATTERY DATA"</span></span>);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  <span class="hljs-comment"><span class="hljs-comment">//attachInterrupt(0, configListener, RISING);</span></span>
  digitalWrite(led_pin, OFF);
  wait(<span class="hljs-number"><span class="hljs-number">500</span></span>);
  digitalWrite(led_pin, ON);
  wait(<span class="hljs-number"><span class="hljs-number">75</span></span>);
  digitalWrite(led_pin, OFF);
  wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
  digitalWrite(led_pin, ON);
  wait(<span class="hljs-number"><span class="hljs-number">75</span></span>);
  digitalWrite(led_pin, OFF);
  wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
  digitalWrite(led_pin, ON);
  wait(<span class="hljs-number"><span class="hljs-number">75</span></span>);
  digitalWrite(led_pin, OFF);
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: OPERATING MODE\n"</span></span>));
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  readBatLev();
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  sht20.initSHT20();
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send_data();
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send(msg_delay_time.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(delayTime));
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send(msg_setting_led.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(set_led));
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send(msg_battary_send.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(send_batteryTime));
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configMode == <span class="hljs-number"><span class="hljs-number">0</span></span>) {



    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sleep_flag == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      timer_status = sleep(digitalPinToInterrupt(mode_pin), FALLING, delayTime * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
      <span class="hljs-comment"><span class="hljs-comment">//timer_status = sleep(digitalPinToInterrupt(mode_pin), RISING, delayTime * 60 * 1000, false);</span></span>
      sleep_flag = <span class="hljs-number"><span class="hljs-number">1</span></span>;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timer_status == <span class="hljs-number"><span class="hljs-number">-1</span></span>) {

      w_battetyTime = w_battetyTime + (delayTime * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>);

      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (w_battetyTime &gt;= send_batteryTime * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>) {
        readBatLev();
        w_battetyTime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
      }
      send_data();
      sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timer_status == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == LOW &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
      {
        flag_mode_button = <span class="hljs-number"><span class="hljs-number">1</span></span>;
        previousMillis = millis();
        wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
      }
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == LOW &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">2000</span></span>)) {
          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - lightMillis &gt; <span class="hljs-number"><span class="hljs-number">50</span></span>)    {
            lightMillis = millis();
            digitalWrite(led_pin, !digitalRead(led_pin));
          }
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">2000</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">2500</span></span>)) {
          digitalWrite(led_pin, OFF);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">2500</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">4500</span></span>)) {
          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - lightMillis &gt; <span class="hljs-number"><span class="hljs-number">25</span></span>)    {
            lightMillis = millis();
            digitalWrite(led_pin, !digitalRead(led_pin));
          }
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">4500</span></span>) {
          digitalWrite(led_pin, OFF);
        }
      }
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == HIGH &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
      {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">2000</span></span>)) {
          configMode = !configMode;
          flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: CONFIGURATION MODE\n"</span></span>));
          sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          digitalWrite(led_pin, OFF);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">2000</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">2500</span></span>)) {
          flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">2500</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">4500</span></span>))
        {
          flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          digitalWrite(led_pin, OFF);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">4500</span></span>) {
          flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
        }
      }
    }
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (listen_flag == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      RF24_startListening();
      listen_flag = <span class="hljs-number"><span class="hljs-number">1</span></span>;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - lightMillis &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) {
      lightMillis = millis();
      digitalWrite(led_pin, !digitalRead(led_pin));
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == LOW &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    {
      flag_mode_button = <span class="hljs-number"><span class="hljs-number">1</span></span>;
      <span class="hljs-comment"><span class="hljs-comment">//previousMillis = millis();</span></span>
      wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == LOW &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
      
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == HIGH &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
    {
       
      configMode = !configMode;
      listen_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
      flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
      TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: OPERATING MODE\n"</span></span>));
      digitalWrite(led_pin, OFF);
      wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
    }
  }
}



<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MyMessage &amp; message)</span></span></span><span class="hljs-function">
</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.sensor == SETTING_LED_SENS_ID) {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type == V_VAR1) {
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getByte() &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) {
        set_led = message.getBool();
        saveState(<span class="hljs-number"><span class="hljs-number">100</span></span>, set_led);
        send(msg_setting_led.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(set_led));
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
          TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: STATUS LED: OFF\n"</span></span>));
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: STATUS LED: ON\n"</span></span>));
          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
            digitalWrite(led_pin, ON);
            wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
            digitalWrite(led_pin, OFF);
          }
        }
      }
    }
  }
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.sensor == DELAY_TIME_SENS_ID) {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type == V_VAR1) {
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getULong() &lt;= <span class="hljs-number"><span class="hljs-number">60</span></span> &amp;&amp; message.getULong() != <span class="hljs-number"><span class="hljs-number">0</span></span>) {
        delayTime = message.getULong();
        saveState(<span class="hljs-number"><span class="hljs-number">101</span></span>, delayTime);
        send(msg_delay_time.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(delayTime));
        TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: THE NEW INTERVAL TEMP&amp;HUM SEND VALUE IS SET: %d MIN.\n"</span></span>), delayTime);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          digitalWrite(led_pin, ON);
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
          digitalWrite(led_pin, OFF);
        }
      } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getULong() &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>) {
        delayTime = <span class="hljs-number"><span class="hljs-number">60</span></span>;
        saveState(<span class="hljs-number"><span class="hljs-number">101</span></span>, delayTime);
        send(msg_delay_time.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(delayTime));
        TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: THE NEW INTERVAL TEMP&amp;HUM SEND VALUE IS SET: %d MIN.\n"</span></span>), delayTime);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          digitalWrite(led_pin, ON);
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
          digitalWrite(led_pin, OFF);
        }
      } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getULong() == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
        delayTime = <span class="hljs-number"><span class="hljs-number">1</span></span>;
        saveState(<span class="hljs-number"><span class="hljs-number">101</span></span>, delayTime);
        send(msg_delay_time.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(delayTime));
        TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: THE NEW INTERVAL TEMP&amp;HUM SEND VALUE IS SET: %d MIN.\n"</span></span>), delayTime);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          digitalWrite(led_pin, ON);
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
          digitalWrite(led_pin, OFF);
        }
      }
    }
  }
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.sensor == BATTARY_SEND_SENS_ID) {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type == V_VAR1) {
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getULong() &lt;= <span class="hljs-number"><span class="hljs-number">168</span></span>) {
        send_batteryTime = message.getULong();
        saveState(<span class="hljs-number"><span class="hljs-number">102</span></span>, send_batteryTime);
        send(msg_battary_send.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(send_batteryTime));
        TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: THE NEW INTERVAL BATTERY SEND IS SET: %d HOUR\n"</span></span>), send_batteryTime);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          digitalWrite(led_pin, ON);
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
          digitalWrite(led_pin, OFF);
        }
      }
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  humd = sht20.readHumidity();
  temp = sht20.readTemperature();
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t_humd = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)humd;
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t_temp = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)temp;
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(temp - oldtemp) &gt;= tempThreshold) {
    send(msg_temp.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(temp, <span class="hljs-number"><span class="hljs-number">1</span></span>));
    oldtemp = temp;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
      digitalWrite(led_pin, ON);
      wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
      digitalWrite(led_pin, OFF);
    }
  }
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(humd - oldhumd) &gt;= humThreshold) {
    send(msg_hum.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(humd, <span class="hljs-number"><span class="hljs-number">1</span></span>));
    oldhumd = humd;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
      digitalWrite(led_pin, ON);
      wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
      digitalWrite(led_pin, OFF);
    }
  }
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: DATA - TEMPERATURE: %d, HUMIDITY %d\n"</span></span>), t_temp, t_humd);
}


<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readBatLev</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
  ADMUX = _BV(REFS1) | _BV(REFS0) | _BV(MUX0);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  RF24_startListening();
  wait(<span class="hljs-number"><span class="hljs-number">200</span></span>);
  ADCSRA |= _BV(ADSC);
  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (bit_is_set(ADCSRA, ADSC));
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> low  = ADCL;
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> high = ADCH;
  <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> temp = (high &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | low;
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> vcc = temp * <span class="hljs-number"><span class="hljs-number">1.1</span></span> / <span class="hljs-number"><span class="hljs-number">1023</span></span> * BAT_COOF * <span class="hljs-number"><span class="hljs-number">100</span></span>;
  battery = <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)vcc, BAT_MIN, BAT_MAX, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (battery &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {
    battery = <span class="hljs-number"><span class="hljs-number">0</span></span>;
  }
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (battery &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) {
    battery = <span class="hljs-number"><span class="hljs-number">100</span></span>;
  }
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: BATTERY LEVEL: %d, PREVIUS BATTERY LEVEL: %d\n"</span></span>), battery, old_battery);
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: BATTERY LEVEL ADC: %d\n"</span></span>), temp);

  <span class="hljs-comment"><span class="hljs-comment">/*
    if (old_battery != battery) {
      if (battery &lt; old_battery) {
        old_battery = battery;
        wait(100);
        sendBatteryLevel(battery);
        wait(100);
        send(powerMsg.set(temp));
        TRANSPORT_DEBUG(PSTR("MyS: SEND BATTERY LEVEL\n"));
      } else {
        battery = old_battery;
      }
    }
  */</span></span>
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  sendBatteryLevel(battery);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send(powerMsg.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(temp));
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: SEND BATTERY LEVEL\n"</span></span>));
}
</code></pre><br>
</div></div><br>
     :<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/XWu5sogiiQg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
   :<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/juQU4pSIvPg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
    (   ),   Mysensors(       Mysensors  )<br>
<br>
<img src="https://habrastorage.org/webt/8x/6i/ie/8x6iie5r4kpdwjan5kqdkvq337c.png"><br>
<br>
      .   ,  , , 3d      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.openhardware.io</a>.     ,         Mysensors         — <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t.me/mysensors_rus</a></b>.</div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452234/">https://habr.com/ru/post/fr452234/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452224/index.html">Le guide rapide pour un développeur Web</a></li>
<li><a href="../fr452226/index.html">Le titre sera différent</a></li>
<li><a href="../fr452228/index.html">Anna Boyarkina, Miro (anciennement RealtimeBoard): sur la réflexion sur les produits, la culture d'équipe, les compétences futures</a></li>
<li><a href="../fr452230/index.html">Nous étudions la diode tunnel sur l'exemple du 3I306M</a></li>
<li><a href="../fr452232/index.html">ObjectRepository - Modèle de référentiel en mémoire .NET pour vos projets domestiques</a></li>
<li><a href="../fr452236/index.html">Harmonie des scripts dans l'application Android</a></li>
<li><a href="../fr452240/index.html">Qu'est-ce qui est commun entre l'orgasme et le Wi-Fi</a></li>
<li><a href="../fr452244/index.html">PHPUnit. Gestionnaire d'entité de la doctrine des pleurs</a></li>
<li><a href="../fr452246/index.html">Entretien avec Vitaly Bragilevsky: «Un monde dans lequel tout le monde programmera à Haskell n'est guère un bon monde»</a></li>
<li><a href="../fr452248/index.html">Nous pompons le développement sur Vue en utilisant des modèles: HOC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>