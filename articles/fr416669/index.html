<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçü§ù‚Äçüë®üèΩ üöâ üë©‚Äçüé§ Toute la v√©rit√© sur Linux Epoll üë®üèª‚Äçüé§ ü§∑üèº üôéüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eh bien, ou presque tous ... 





 Je crois que le probl√®me sur l'Internet moderne est une surabondance d'informations de qualit√© diff√©rente. Trouver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Toute la v√©rit√© sur Linux Epoll</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416669/"><p>  Eh bien, ou presque tous ... </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/91f/776/71c/91f77671c2186bc1f2393c47e0696ee9.png"></p><br><p>  Je crois que le probl√®me sur l'Internet moderne est une surabondance d'informations de qualit√© diff√©rente.  Trouver du mat√©riel sur un sujet d'int√©r√™t n'est pas un probl√®me; le probl√®me est de distinguer le bon mat√©riel du mauvais mat√©riel si vous avez peu d'exp√©rience dans ce domaine.  J'observe une image quand il y a beaucoup d'informations de synth√®se "au sommet" (presque au niveau d'une simple √©num√©ration), tr√®s peu d'articles approfondis et pas d'articles de transition du simple au complexe.  N√©anmoins, c'est la connaissance des caract√©ristiques d'un m√©canisme particulier qui nous permet de faire un choix √©clair√© lors du d√©veloppement. </p><br><p>  Dans l'article, j'essaierai de r√©v√©ler quelle est la diff√©rence fondamentale entre <strong>epoll</strong> et d'autres m√©canismes, ce qui le rend unique, ainsi que de citer des articles que vous avez juste besoin de lire pour mieux comprendre les possibilit√©s et les probl√®mes d' <strong>epoll</strong> . </p><br><blockquote> Tout le monde peut manier une hache, mais il faut un vrai guerrier pour lui faire chanter la m√©lodie de m√™l√©e. </blockquote><p>  Je suppose que le lecteur conna√Æt bien <strong>epoll</strong> , au moins lisez la page de manuel.  On en a assez √©crit sur <strong>epoll</strong> , <strong>poll</strong> , <strong>select</strong> pour que tous ceux qui d√©veloppent sous Linux en aient entendu parler au moins une fois. </p><a name="habracut"></a><br><h1 id="mnoga--fd">  Beaucoup de fd </h1><br><p>  Lorsque les gens parlent d' <strong>epoll,</strong> j'entends essentiellement la th√®se selon laquelle ¬´ses performances sont meilleures quand il y a beaucoup de descripteurs de fichiers¬ª. </p><br><p>  Je veux juste poser une question - combien co√ªte combien?  Combien de connexions sont n√©cessaires et, surtout, dans quelles conditions <strong>epoll</strong> commencera-t-il √† apporter des gains de performances tangibles? </p><br><p>  Pour ceux qui ont √©tudi√© <strong>epoll</strong> (il y a beaucoup de mat√©riel, y compris des articles scientifiques), la r√©ponse est √©vidente - il vaut mieux si et seulement si le nombre de compos√©s "en attente d'un √©v√©nement" d√©passe consid√©rablement le nombre de "pr√™ts pour le traitement".  La marque de la quantit√©, lorsque le gain devient si important qu'il n'y a tout simplement pas d'urine pour ignorer ce fait, les compos√©s 10k sont consid√©r√©s [4]. </p><br><p>  L'hypoth√®se selon laquelle la plupart des connexions seront en attente provient de la logique sonore et de la surveillance de la charge des serveurs en cours d'utilisation. </p><br><p>  Si le nombre de compos√©s actifs vise le nombre total, <del>  il n'y aura aucun gain </del>  il n'y aura pas de gain significatif, un gain significatif est d√ª et uniquement au fait que <strong>epoll</strong> ne retourne que les descripteurs n√©cessitant une attention, et <strong>poll</strong> renvoie tous les descripteurs qui ont √©t√© ajout√©s pour observation. </p><br><p>  √âvidemment, dans ce dernier cas, nous passons du temps √† parcourir tous les descripteurs + les frais g√©n√©raux de copie d'un tableau d'√©v√©nements √† partir du noyau. </p><br><p>  En effet, dans la mesure de performance initiale, qui √©tait attach√©e au patch [9], ce point n'est pas soulign√© et on ne peut que le deviner par la pr√©sence de l'utilitaire deadcon mentionn√© dans l'article (malheureusement, le code de l'utilitaire pipetest.c est perdu).  En revanche, dans d'autres sources [6, 8], il est tr√®s difficile de ne pas le remarquer, car ce fait se prolonge pratiquement. </p><br><p>  La question se pose imm√©diatement, mais que se passe-t-il maintenant s'il n'est pas pr√©vu de desservir un tel nombre de descripteurs de fichiers <strong>epoll</strong> , pour ainsi dire, et n'est pas n√©cessaire? </p><br><p>  Malgr√© le fait <strong>qu'epoll ait</strong> √©t√© initialement cr√©√© sp√©cifiquement pour de telles situations [5, 8, 9], c'est loin d'√™tre la seule diff√©rence entre <strong>epoll</strong> . </p><br><h1 id="epollet">  EPOLLET </h1><br><p>  Pour commencer, nous allons examiner la diff√©rence entre les d√©clencheurs d√©clench√©s par front et les d√©clencheurs d√©clench√©s par niveau. Il y a une tr√®s bonne d√©claration √† ce sujet dans l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Interruptions d√©clench√©es par niveau d√©clench√©es contre Edge d√©clench√©es - Venkatesh Yadav</a> : </p><br><blockquote>  Interruption de niveau, c'est comme un enfant.  Si le b√©b√© pleure, vous devez abandonner tout ce que vous avez fait et courir vers le b√©b√© pour le nourrir.  Ensuite, vous remettez le b√©b√© dans le berceau.  S'il pleure encore, vous ne le laisserez nulle part, mais vous essayerez de le calmer.  Et pendant que l'enfant pleure, vous ne le quitterez pas un instant, et vous ne retournerez au travail que lorsqu'il se calmera.  Mais disons que nous sommes sortis dans le jardin (interruption d√©sactiv√©e) lorsque l'enfant a commenc√© √† pleurer, puis lorsque vous √™tes rentr√© chez vous (interruption activ√©e) la premi√®re chose que vous faites est d'aller voir l'enfant.  Mais vous ne saurez jamais qu'il pleurait pendant que vous √©tiez dans le jardin. <br><br>  L'interruption sur le devant est comme une nounou √©lectronique pour parents sourds.  D√®s que l'enfant commence √† pleurer sur l'appareil, un voyant rouge s'allume et s'allume jusqu'√† ce que vous appuyiez sur le bouton.  M√™me si l'enfant a commenc√© √† pleurer, mais s'est rapidement arr√™t√© et s'est endormi, vous saurez toujours que l'enfant pleurait.  Mais s'il a commenc√© √† pleurer et que vous avez appuy√© sur le bouton (confirmation de l'interruption), la lumi√®re ne s'allumera pas m√™me s'il continue de pleurer.  Le niveau sonore dans la pi√®ce doit baisser puis remonter pour que la lumi√®re s'allume. </blockquote><p>  Si l' <strong>epoll</strong> (ainsi que <strong>poll</strong> / <strong>select</strong> ) est d√©verrouill√© dans le comportement d√©clench√© par le niveau si le descripteur est dans l'√©tat sp√©cifi√© et sera consid√©r√© comme actif jusqu'√† ce que cet √©tat soit effac√©, le d√©clenchement sur front est d√©verrouill√© uniquement en changeant l'√©tat ordonn√© donn√© actuel. </p><br><p>  Cela vous permet de g√©rer l'√©v√©nement plus tard, et pas imm√©diatement apr√®s sa r√©ception (presque une analogie directe avec la moiti√© sup√©rieure et la moiti√© inf√©rieure du gestionnaire d'interruption). </p><br><p>  Exemple sp√©cifique avec epoll: </p><br><p>  Niveau d√©clench√© </p><br><ul><li>  poign√©e ajout√©e √† <strong>epoll</strong> avec drapeau <strong>EPOLLIN</strong> </li><li>  <strong>epoll_wait ()</strong> bloque en attendant un √©v√©nement </li><li>  √©crire dans le descripteur de fichier 19 octets </li><li>  <strong>epoll_wait () se</strong> d√©verrouille avec l'√©v√©nement <strong>EPOLLIN</strong> </li><li>  nous ne faisons rien avec les donn√©es qui sont venues </li><li>  <strong>epoll_wait () se</strong> d√©verrouille √† nouveau avec l'√©v√©nement <strong>EPOLLIN</strong> </li></ul><br><p>  Et cela continuera jusqu'√† ce que nous comptions ou r√©initialisions compl√®tement les donn√©es du descripteur. </p><br><p>  D√©clenchement sur front </p><br><ul><li>  nouvelle poign√©e ajout√©e √† <strong>epoll</strong> avec les drapeaux <strong>EPOLLIN |</strong>  <strong>EPOLLET</strong> </li><li>  <strong>epoll_wait ()</strong> bloque en attendant un √©v√©nement </li><li>  √©crire dans le descripteur de fichier 19 octets </li><li>  <strong>epoll_wait () se</strong> d√©verrouille avec l'√©v√©nement <strong>EPOLLIN</strong> </li><li>  nous ne faisons rien avec les donn√©es qui sont venues </li><li>  <strong>epoll_wait () est</strong> bloqu√© en attendant un nouvel √©v√©nement </li><li>  √©crire encore 19 octets dans le descripteur de fichier </li><li>  <strong>epoll_wait () se</strong> d√©verrouille avec le nouvel √©v√©nement <strong>EPOLLIN</strong> </li><li>  <strong>epoll_wait () est</strong> bloqu√© en attendant un nouvel √©v√©nement </li></ul><br><p>  exemple simple: <a href="">epollet_socket.c</a> </p><br><p>  Ce m√©canisme est <strong>con√ßu</strong> pour emp√™cher le retour de <strong>epoll_wait () en</strong> raison d'un √©v√©nement qui est d√©j√† en cours de traitement. </p><br><p>  Si, dans le cas du niveau, lors de l'appel √† <strong>epoll_wait (), le</strong> noyau v√©rifie si fd est dans cet √©tat, alors edge saute cette v√©rification et met imm√©diatement le processus appelant en √©tat de veille. </p><br><p>  <strong>EPOLLET lui</strong> - <strong>m√™me</strong> est ce qui fait d' <strong>epoll</strong> O (1) un multiplexeur d'√©v√©nements. </p><br><p>  Il est n√©cessaire d'expliquer <strong>EAGAIN</strong> et <strong>EPOLLET</strong> - la recommandation avec <strong>EAGAIN n'est</strong> pas de traiter le flux d'octets, le danger dans ce dernier cas ne survient que si vous n'avez pas lu le descripteur √† la fin, et de nouvelles donn√©es ne sont pas arriv√©es.  Ensuite, la queue se bloque dans le descripteur, mais vous ne recevrez pas de nouvelle notification.  Avec <strong>accept (), la</strong> situation est juste diff√©rente, vous devez continuer jusqu'√† ce que <strong>accept ()</strong> renvoie <strong>EAGAIN</strong> , seulement dans ce cas le bon fonctionnement est garanti. </p><br><pre><code class="hljs lua">// TCP socket (<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> stream) //  fd    EPOLLIN      int <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(fd, buffer, BUFFER_LEN); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">len</span></span> &lt; BUFFER_LEN) { //   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //         //  -       epoll_wait, //      }</code> </pre> <br><pre> <code class="hljs ruby"> /<span class="hljs-regexp"><span class="hljs-regexp">/ accept /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  listenfd    EPOLLIN      event.events = EPOLLIN | EPOLLERR; epoll_ctl(epoll_fd, EPOLL_CTL_ADD, server_fd, &amp;event); sleep(5); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       &gt;1  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   while(epoll_wait()) { newfd = accept(listenfd, ...); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  epoll_wait    listenfd    } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   while(epoll_wait()) { while((newfd = accept(...)) &gt; 0) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  -  } if(newfd == -1 &amp;&amp; errno = EAGAIN) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       } }</span></span></code> </pre> <br><p>  Avec cette propri√©t√©, la famine suffit: </p><br><ul><li>  les paquets arrivent au descripteur </li><li>  lire les paquets dans le tampon </li><li>  un autre paquet vient </li><li>  lire les paquets dans le tampon </li><li>  vient une petite portion </li><li>  ... </li></ul><br><p>  Ainsi <strong>,</strong> nous ne recevrons pas <strong>EAGAIN</strong> prochainement, mais nous ne le recevrons peut-√™tre pas du tout. </p><br><p>  Ainsi, d'autres descripteurs de fichiers ne re√ßoivent pas de temps pour le traitement, et nous sommes occup√©s √† lire de petites portions de donn√©es qui arrivent constamment. </p><br><h1 id="thundering-nerd-herd">  tonnerre <del>  nerd </del>  troupeau </h1><br><p>  Pour passer au dernier indicateur, vous devez comprendre pourquoi il a √©t√© cr√©√© et l'un des probl√®mes rencontr√©s par les d√©veloppeurs avec l'√©volution de la technologie et des logiciels. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://en.wikipedia.org/wiki/">Probl√®me de troupeau tonnerre</a> </p><br><blockquote>  Probl√®me de troupeau de tonnerre <br><br>  Imaginez un grand nombre de processus en attente d'un √©v√©nement.  Si un √©v√©nement se produit, ils seront r√©veill√©s et la lutte pour les ressources commencera, bien qu'un seul processus soit n√©cessaire pour g√©rer le traitement ult√©rieur de l'√©v√©nement.  Le reste des processus dormira √† nouveau. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Terminologie informatique - Vasily Alekseenko</a> </blockquote><p>  Dans ce cas, nous nous int√©ressons au probl√®me de l' <strong>acceptation ()</strong> et de la <strong>lecture ()</strong> distribu√©es sur les flux conjointement avec <strong>epoll</strong> . </p><br><h1 id="accept">  accepter </h1><br><p>  En fait, avec un appel bloquant pour <strong>accepter (),</strong> il n'y a pas eu de probl√®me depuis longtemps.  Le noyau veillera √† ce qu'un seul processus ait √©t√© d√©verrouill√© pour cet √©v√©nement et que toutes les connexions entrantes soient s√©rialis√©es. </p><br><p>  Mais avec <strong>epoll,</strong> une telle astuce ne fonctionnera pas.  Si nous avons <strong>√©cout√© ()</strong> sur une socket non bloquante, lorsque la connexion est √©tablie, tous les <strong>epoll_wait () attendront</strong> l'√©v√©nement de ce descripteur. </p><br><p>  Bien s√ªr, <strong>accept ()</strong> ne pourra faire qu'un seul thread, les autres recevront <strong>EAGAIN</strong> , mais c'est un gaspillage de ressources. </p><br><p>  De plus, <strong>EPOLLET</strong> ne nous aide pas non plus, car nous ne savons pas exactement combien de connexions se trouvent dans la file d'attente de connexions ( <strong>backlog</strong> ).  Comme nous nous en souvenons, lorsque vous utilisez <strong>EPOLLET</strong> , le traitement des sockets doit continuer jusqu'√† ce qu'il revienne avec le <strong>code d'</strong> erreur <strong>EAGAIN</strong> , il y a donc une chance que tous <strong>accept ()</strong> soient trait√©s par un seul thread et que les autres ne fonctionnent pas. </p><br><p>  Et cela nous conduit √† nouveau √† une situation o√π le ruisseau voisin a √©t√© r√©veill√© en vain. </p><br><p>  Nous pouvons √©galement obtenir un autre type de famine - nous n'aurons qu'un seul thread charg√©, et le reste ne recevra pas de connexions pour le traitement. </p><br><h1 id="epolloneshot">  EPOLLONESHOT </h1><br><p>  Avant la version 4.5, la seule fa√ßon correcte de traiter le <strong>epoll</strong> distribu√© en un descripteur <strong>listen ()</strong> non bloquant avec le prochain appel <strong>accept ()</strong> √©tait de d√©finir l'indicateur <strong>EPOLLONESHOT</strong> , ce qui nous a conduit √† nouveau √† <strong>accepter ()</strong> uniquement en cours de traitement dans un thread √† la fois. </p><br><p>  En bref - si <strong>EPOLLONESHOT est</strong> utilis√© <strong>, l'</strong> √©v√©nement associ√© √† un descripteur particulier ne se d√©clenchera qu'une seule fois, apr√®s quoi il sera n√©cessaire de <strong>r√©armer</strong> les drapeaux en utilisant <strong>epoll_ctl ()</strong> . </p><br><h1 id="epollexclusive">  EPOLLEXCLUSIVE </h1><br><p>  Ici <strong>EPOLLEXCLUSIVE</strong> et d√©clench√© par niveau vient √† notre aide. </p><br><p>  <strong>EPOLLEXCLUSIVE</strong> d√©verrouille un <strong>epoll_wait ()</strong> √† la fois pour un √©v√©nement. </p><br><p>  Le sch√©ma est assez simple (en fait non): </p><br><ul><li>  Nous avons N threads en attente d'un √©v√©nement de connexion </li><li>  Le premier client se connecte √† nous </li><li>  Le thread 0 sera dispers√© et commencera le traitement, les autres threads resteront bloqu√©s </li><li>  Un deuxi√®me client se connecte √† nous, si le thread 0 est toujours occup√© par le traitement, alors le thread 1 est d√©verrouill√© </li><li>  Nous continuons jusqu'√† ce que le pool de threads soit √©puis√© (personne ne s'attend √† un √©v√©nement sur <strong>epoll_wait ()</strong> ) </li><li>  Un autre client se connecte √† nous </li><li>  Et son traitement recevra le premier thread, qui appellera <strong>epoll_wait ()</strong> </li><li>  Le deuxi√®me thread recevra le deuxi√®me client, qui appellera <strong>epoll_wait ()</strong> </li></ul><br><p>  Ainsi, toute la maintenance est r√©partie uniform√©ment sur les flux. </p><br><pre> <code class="bash hljs">$ ./epollexclusive --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> -i, --ip=ADDR specify ip address -p, --port=PORT specify port -n, --threads=NUM specify number of threads to use <span class="hljs-comment"><span class="hljs-comment">#    -  n*8 -t, --thunder not adding EPOLLEXCLUSIVE #     thunder herd -h, --help prints this message $ sudo taskset -c 0-7 ./epollexclusive -i 10.56.75.201 -p 40000 -n 8 2&gt;&amp;1</span></span></code> </pre> <br><p>  exemple de code: <a href="">epollexclusive.c</a> (ne fonctionnera qu'avec la version du noyau √† partir de 4.5) </p><br><p>  Nous obtenons un mod√®le de pr√©-fourche sur epoll.  Ce sch√©ma est bien applicable pour les connexions TCP de <strong>courte dur√©e</strong> . </p><br><h1 id="read">  lire </h1><br><p>  Mais avec <strong>read ()</strong> dans le cas du streaming d'octets, <strong>EPOLLEXCLUSIVE</strong> , comme <strong>EPOLLET,</strong> ne nous aidera pas. </p><br><p>  Pour des raisons √©videntes, sans <strong>EPOLLEXCLUSIVE,</strong> nous ne pouvons pas utiliser du tout d√©clench√© par niveau.  Avec <strong>EPOLLEXCLUSIVE,</strong> tout ne va pas mieux, car nous pouvons obtenir un package r√©parti sur les flux, en plus avec un ordre inconnu d'octets arriv√©s. </p><br><p>  Avec <strong>EPOLLET, la</strong> situation est la m√™me. </p><br><p>  Et ici, <strong>EPOLLONESHOT</strong> avec r√©initialisation √† la fin des travaux sera la <strong>solution</strong> .  Ainsi, d√®s qu'un thread fonctionnera avec ce descripteur de fichier et ce tampon: </p><br><ul><li>  poign√©e ajout√©e √† <strong>epoll</strong> avec les drapeaux <strong>EPOLLONESHOT |</strong>  <strong>EPOLLET</strong> </li><li>  en attente sur <strong>epoll_wait ()</strong> </li><li>  lire du socket au tampon jusqu'√† ce que <strong>read ()</strong> renvoie <strong>EAGAIN</strong> </li><li>  r√©initialiser avec les drapeaux <strong>EPOLLONESHOT |</strong>  <strong>EPOLLET</strong> </li></ul><br><h1 id="struct--epoll_event">  struct epoll_event </h1><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> epoll_data { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *ptr; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> u32; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> u64; } <span class="hljs-keyword"><span class="hljs-keyword">epoll_data_t</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">epoll_event</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> events; <span class="hljs-comment"><span class="hljs-comment">/* Epoll events */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">epoll_data_t</span></span> data; <span class="hljs-comment"><span class="hljs-comment">/* User data variable */</span></span> };</code> </pre> <br><p>  Cet article est peut-√™tre le seul dans mon article mon IMHO personnel.  La possibilit√© d'utiliser un pointeur ou un nombre est utile.  Par exemple, l'utilisation d'un pointeur lors de l'utilisation d'epoll vous permet de faire une astuce comme celle-ci: </p><br><pre> <code class="hljs go">#define container_of(ptr, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, member) ({ \ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> typeof( ((<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>)-&gt;member ) *__mptr = (ptr); \ (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> *)( (char *)__mptr - offsetof(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>,member) );}) <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client { <span class="hljs-comment"><span class="hljs-comment">/** some usefull associated data...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_event event; }; <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client* to_epoll_client(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_event* event) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> container_of(event, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client, event); } <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client ec; ... epoll_ctl(efd, EPOLL_CTL_ADD, fd, &amp;ec.e); ... epoll_wait (efd, events, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client* ec_ = to_epoll_client(events[<span class="hljs-number"><span class="hljs-number">0</span></span>].data.ptr);</code> </pre> <br><p>  Je pense que tout le monde sait d'o√π vient cette technique. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  J'esp√®re que nous avons pu ouvrir le sujet d' <strong>epoll</strong> .  Ceux qui veulent utiliser ce m√©canisme consciemment, ont juste besoin de lire les articles de la liste de r√©f√©rences [1, 2, 3, 5]. </p><br><p>  Sur la base de ce mat√©riel (ou, mieux encore, en lisant attentivement les mat√©riaux des r√©f√©rences), vous pouvez cr√©er un serveur pr√©-fork multi-thread (g√©n√©ration avanc√©e du processus) sans verrouillage (sans blocage) ou r√©viser les strat√©gies existantes en fonction des propri√©t√©s sp√©ciales d' <strong>epoll ()</strong> ). </p><br><p>  <strong>epoll est l'</strong> un des m√©canismes uniques que les gens qui ont choisi leurs chemins de programmation Linux doivent conna√Ætre, car ils donnent un s√©rieux avantage sur les autres syst√®mes d'exploitation), et, peut-√™tre, refuseront la multiplateforme pour un cas particulier (laissez-le fonctionner uniquement sous Linux mais le fera bien). </p><br><h2 id="rassuzhdeniya-ob-specifichnosti-zadachi">  Raisonnement sur la "sp√©cificit√©" du probl√®me </h2><br><p>  Avant que quelqu'un ne parle de la sp√©cificit√© de ces indicateurs et mod√®les d'utilisation, je veux poser une question: </p><br><p>  "Mais n'est-ce rien que nous essayons de discuter de la sp√©cificit√© du m√©canisme qui a √©t√© cr√©√© initialement pour des t√¢ches sp√©cifiques [9, 11]? Ou est-ce que nous entretenons m√™me des connexions 1k est une t√¢che quotidienne pour un programmeur?" </p><br><p>  Je ne comprends pas le concept de ¬´sp√©cificit√© des t√¢ches¬ª, cela me rappelle toutes sortes de cris sur l'utilit√© et la futilit√© des diff√©rentes disciplines enseign√©es.  En nous laissant ainsi raisonner, nous nous r√©servons le droit de d√©cider pour autrui quelles informations leur sont utiles et lesquelles sont inutiles, tout en ne participant pas au processus √©ducatif dans son ensemble. </p><br><p>  Pour les sceptiques, quelques liens: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Augmentation des performances avec SO_REUSEPORT dans NGINX 1.9.1 - VBart</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apprendre de la licorne: le troupeau tonnerre accepte () sans probl√®me - Chris Siebenmann</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">S√©rialisation accepter (), AKA Thundering Herd, AKA le probl√®me Zeeg - Roberto De Ioris</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment le mode EPOLLEXCLUSIVE d'epoll interagit-il avec le d√©clenchement de niveau?</a> </p><br><h1 id="spisok-literatury">  Les r√©f√©rences </h1><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Select est fondamentalement cass√© - Marek</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Epoll est fondamentalement cass√© 1/2 - Marek</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Epoll est fondamentalement bris√© 2/2 - Marek</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le probl√®me du C10K - Dan Kegel</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Poll vs Epoll, encore une fois - Jacques Mattheij</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">epoll - Fonction de notification d'√©v√©nements d'E / S - The Mann</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La m√©thode de la folie d'Epoll - Cindy Sridharan</a> </li></ol><br><h2 id="benchmarks">  Rep√®res </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.kernel.org/doc/ols/2004/ols2004v1-pages-215-226.pdf</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://lse.sourceforge.net/epoll/index.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://mvitolin.wordpress.com/2015/12/05/endurox-testing-epollexclusive-flag/</a> </li></ol><br><h2 id="evolyuciya-epoll">  L'√©volution d'Epoll </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://lwn.net/Articles/13918/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://lwn.net/Articles/520012/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://lwn.net/Articles/520198/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://lwn.net/Articles/542629/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://lwn.net/Articles/633422/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://lwn.net/Articles/637435/</a> </li></ol><br><h1 id="postskriptum">  Postscript </h1><br><p>  Un grand merci √† Sergey ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">dlinyj</a> ) et Peter Ovchenkov pour leurs pr√©cieuses discussions, commentaires et aide! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416669/">https://habr.com/ru/post/fr416669/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr416657/index.html">Les deux tiers des cartes m√©moire utilis√©es contiennent des donn√©es personnelles d'anciens propri√©taires</a></li>
<li><a href="../fr416659/index.html">En raison de ce que le volume des paiements num√©riques pour l'√©conomie des concerts atteindra 1,2 billion de dollars</a></li>
<li><a href="../fr416661/index.html">Quelles tendances devraient √™tre prises en compte par les utilisateurs et les fournisseurs de services bancaires mobiles</a></li>
<li><a href="../fr416665/index.html">R√©utilisation des biblioth√®ques Android priv√©es avec Sonatype Nexus Repository OSS</a></li>
<li><a href="../fr416667/index.html">Insonoriser la poussi√®re et le bruit de l'ancienne unit√© centrale</a></li>
<li><a href="../fr416673/index.html">Solution analytique pour manager</a></li>
<li><a href="../fr416677/index.html">Lunettes cyberpunk et miroir: reflets de la mode et de la culture</a></li>
<li><a href="../fr416679/index.html">Informatique p√©riph√©rique: une concordance amicale du ¬´brouillard¬ª avec les ¬´nuages¬ª</a></li>
<li><a href="../fr416681/index.html">Comment de PostgreSQL et ClickHouse en Python beaucoup, rapidement et imm√©diatement en numpy</a></li>
<li><a href="../fr416683/index.html">Et ensuite? Ou comment choisir les fonctionnalit√©s √† d√©velopper</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>