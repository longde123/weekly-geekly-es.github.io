<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöå üåã üî¢ Comment transformer un smartphone en caisse √† part enti√®re üôÜüèø üé• üò≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque jour, dans les magasins, nous voyons diff√©rentes caisses - toutes sortes de solutions int√©gr√©es avec des boutons myst√©rieux. Derri√®re ces caiss...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment transformer un smartphone en caisse √† part enti√®re</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/moysklad/blog/462993/"><p>  Chaque jour, dans les magasins, nous voyons diff√©rentes caisses - toutes sortes de solutions int√©gr√©es avec des boutons myst√©rieux.  Derri√®re ces caisses se trouvent des caissiers qui crient ¬´Galya, nous avons annul√©¬ª.  Ceci est g√™nant pour les caissiers et les acheteurs. </p><br><p>  L'interface de paiement devient plus conviviale au fil du temps, et Gali est d√©j√† moins n√©cessaire, mais le paiement est toujours un artefact lourd et complexe. </p><br><p><img src="https://habrastorage.org/webt/zq/bc/ia/zqbcia27fpbw0x-pgb09nk2khtw.png"></p><br><p>  Je m'appelle Vladimir Sarbeev, je suis d√©veloppeur Android sur MySklad.  Et je suis s√ªr que la caisse enregistreuse peut √™tre compacte et pratique.  De plus, vous pouvez transformer votre smartphone en caissier. </p><a name="habracut"></a><br><p>  Dans MyStore, nous avons cr√©√© l'application mobile Kassa MyStore.  Il s'agit d'un box-office complet √† l'int√©rieur du smartphone. </p><br><p>  Cela fonctionne comme ceci: apr√®s autorisation, le caissier peut ouvrir et fermer des quarts, vendre des marchandises directement ou sur r√©servation, prendre en compte les esp√®ces.  Vous pouvez connecter les appareils requis pour travailler √† la caisse.  Ils sont sur la photo: </p><br><p><img src="https://habrastorage.org/webt/wp/_t/8k/wp_t8kkm69mpwtht7fb7d6a36nq.png"><br>  <em>1 - billetterie Atol Sigma 10;</em>  <em>2 - l'application n'est pas prise en charge, int√©gration avec les employ√©s</em> <br>  <em>3 - billetterie Atol 11F;</em>  <em>4 - borne Verifone VX820;</em>  <em>5 - borne PAX S90</em> <br>  <em>6 - billetterie Shtrikh-Nano-F;</em>  <em>7 - billetterie Atol 15F;</em>  <em>8 - billetterie Bar-ON-LINE</em> <br>  <em>9 - scanner de codes √† barres;</em>  <em>10 - Terminal PayMe;</em>  <em>11 - caisse MSPOS-K</em> </p><br><p>  Le smartphone lui-m√™me ne peut pas imprimer les re√ßus de caisse et accepter le paiement par carte de cr√©dit, donc des caisses et des terminaux de paiement sont n√©cessaires.  Un scanner mat√©riel est n√©cessaire si l'appareil photo du smartphone ne convient pas pour un remplacement complet du scanner de codes-barres. </p><br><h2 id="vsevidyaschee-oko">  Oeil qui voit tout </h2><br><p>  M√™me avant la sortie de la caisse MySklad, nous avons d√©cid√© que la cam√©ra √©tait une cam√©ra, mais l'utilisateur peut avoir un scanner de code-barres mat√©riel qu'il souhaite utiliser. </p><br><p>  Nous pouvons travailler avec des scanners sous la forme d'un HID ordinaire (dispositif d'interface humaine).  Apr√®s avoir lu le code-barres, nous obtenons une s√©quence de caract√®res du scanner.  Il s'agit peut-√™tre de l'int√©gration la plus simple.  Le plus simple, sinon deux ¬´mais¬ª. </p><br><p>  Premi√®rement, √©tant ¬´pr√™t √† l'emploi¬ª, un scanner peut ne pas transmettre du tout ce qu'il devrait.  Deuxi√®mement, tous les mod√®les de scanner ne nous signalent pas que la lecture du code-barres est termin√©e. </p><br><p>  Le premier ¬´mais¬ª est r√©solu simplement: si le scanner commence √† transmettre ce qu'il ne doit pas scanner, vous devez trouver les instructions du scanner et le configurer √† l'aide des codes-barres de service.  En r√®gle g√©n√©rale, les instructions sont compl√®tes sur papier ou sous forme √©lectronique aupr√®s du fabricant.  Apr√®s avoir d√©crit les param√®tres disponibles, il contient des codes-barres qui scannent dans la s√©quence souhait√©e.  Vous pouvez donc configurer le scanner selon vos besoins. </p><br><p>  Le deuxi√®me ¬´mais¬ª est un probl√®me plus grave.  Le zoo des scanners est vaste et tous les appareils ne montrent pas la fin d'une ligne de lecture.  Il existe deux options pour r√©soudre ce probl√®me.  La premi√®re consiste √† utiliser les m√™mes codes-barres de service pour d√©finir un param√®tre qui transmettra le caract√®re de saut de ligne apr√®s la lecture.  Si vous n'√™tes pas chanceux avec le mod√®le et que la premi√®re option ne convient pas, vous pouvez d√©finir le suffixe du scanner.  √Ä l'aide des codes-barres de service, ajoutez un caract√®re √† la fin de la s√©quence de lecture pour attraper la fin de l'entr√©e. </p><br><h2 id="podklyuchaem-kassu">  Nous connectons la caisse </h2><br><p> Donc, l'application est l√†, le scanner de codes-barres est connect√©, mais nous ne pouvons toujours pas imprimer le ch√®que.  Pour cela, nous avons besoin du box-office lui-m√™me.  Dans MySklad, nous soutenons KKT Atol et Shtrikh, √©galement MSPOS, je vais en parler dans un autre article. </p><br><p>  En ce qui concerne l'int√©gration avec le caissier, la quantit√© de code de fer a commenc√© √† cro√Ætre inexorablement.  Nous avons d√©cid√© de mettre tout le travail avec l'√©quipement connect√© dans une biblioth√®que s√©par√©e.  L'application de caisse enregistreuse elle-m√™me est devenue un client tirant une biblioth√®que √† travers gradle. </p><br><p>  Selon le mod√®le, vous pouvez vous connecter via USB, Bluetooth ou Wi-Fi.  Et aussi selon le protocole UART, qui est un couplage rigide de la caisse enregistreuse et d'un appareil Android dans un cas.  En outre, diff√©rents fournisseurs diff√®rent radicalement dans la mise en ≈ìuvre de la connexion du client √† la caisse.  Wrapper Java au-dessus des biblioth√®ques natives .so, un module compl√©mentaire sur la biblioth√®que open source jPOS et m√™me le noyau fiscal accessible via un service avec une interface AIDL (langage de d√©finition d'interface Android). </p><br><p>  Lors des premi√®res tentatives d'int√©gration d'un appareil d'un fabricant, nous √©tions satisfaits du sch√©ma d'interaction de l'appareil KKM: </p><br><p><img src="https://habrastorage.org/webt/jz/tz/my/jztzmyluw0ilashos-8utonzj9m.png"></p><br><p>  Mais en tenant compte du nombre d'impl√©mentations de pilotes, des m√©thodes de connexion et de l'uniformit√© des fonctionnalit√©s, nous avons d√©cid√© de repenser le travail avec le mat√©riel.  En cons√©quence, le sch√©ma pr√©c√©dent a pris la forme suivante: </p><br><p><img src="https://habrastorage.org/webt/5s/l1/sz/5sl1szcf5jfdhbrvs0r7uebkpek.png"></p><br><p>  <em>T est un wrapper de pilote de bas niveau sp√©cifique</em> </p><br><p>  Le Gestionnaire de p√©riph√©riques masque l'impl√©mentation de la connexion au client.  Il suffit de cr√©er un assistant de connexion, qui vous obligera √† s√©lectionner syst√©matiquement le fabricant du caissier, le type de connexion et √† configurer les param√®tres.  Dans le cas d'une connexion r√©ussie, il nous renvoie un objet qui impl√©mente l'interface KKMDevice. </p><br><p>  KKMDevice masque les d√©tails de l'utilisation d'un pilote de fournisseur individuel.  Les wrappers de chaque fabricant sp√©cifique contiennent un lien vers le pilote T et des d√©l√©gu√©s qui impl√©mentent certains ensembles de fonctions.  Par exemple, FiscalDelegate, NonFiscalDelegate, DeviceInfoDelegate. </p><br><p>  Je noterai quelques points g√©n√©raux d'int√©gration: </p><br><ul><li>  Assurez-vous de rester √† l'√©coute pour les mises √† jour du pilote.  En plus des corrections de bugs et de la vitesse accrue, des sauts de qualit√© se produisent souvent.  Croyez-moi, la transition des commandes HEX de bas niveau √† une interface de type Java, et de celle-ci aux t√¢ches json, facilite grandement le travail et rend le code plus compr√©hensible. </li><li>  Pendant la dur√©e des op√©rations, bloquez l'interface utilisateur avec une barre de progression.  Le panneau indique que le bouton "Payer" appuy√© plusieurs fois de suite avec un CCP connect√© est un signe avant-coureur de critiques dans le traqueur de t√¢ches. </li><li>  Assurez-vous que toutes les op√©rations avec CCP sont effectu√©es de mani√®re strictement s√©quentielle.  Une course de flux ¬´r√©ussie¬ª peut bloquer le KKT, tandis que la barre de progression qui tourne en m√™me temps est √©galement une application. </li><li>  Si vous devez configurer le transfert de donn√©es vers l'op√©rateur de donn√©es fiscales, je vous conseille de s√©lectionner le nombre maximum de param√®tres dans une liste pr√©d√©finie.  Parce que la saisie manuelle de donn√©es avec une impulsion fiscale militaire est un excellent moyen de se tirer une balle dans le pied, mais du c√¥t√© de l'utilisateur lors de l'utilisation de l'application. </li></ul><br><p>  Une impulsion fiscale est un appareil qui collecte et traite des informations sur les op√©rations de trading.  Cela peut co√ªter plus cher que le box-office lui-m√™me.  Si le lecteur n'est pas configur√© correctement, la mise √† z√©ro du processus peut √™tre requise.  Pour ce faire, ouvrez la billetterie, imm√©diatement la garantie s'envole. </p><br><h2 id="ekvayring">  Acqu√©rir </h2><br><p>  Donc, nous avons l'interface de caisse, nous pouvons scanner les marchandises par code √† barres et imprimer le ch√®que.  Reste √† ajouter la possibilit√© de payer par carte. </p><br><p>  Notre application int√®gre la prise en charge des terminaux PayMe et Inpas.  Les premiers sont connect√©s via Bluetooth, tandis que les seconds peuvent √™tre connect√©s via USB ou via Wi-Fi. </p><br><p>  Le sch√©ma de connexion des terminaux de paiement est tr√®s similaire √† la connexion d'un CCP, sauf autorisation suppl√©mentaire requise. </p><br><p>  Mais il existe de s√©rieuses diff√©rences - dans la gestion du comportement anormal de l'appareil.  Ainsi, dans le PCC, toute op√©ration a r√©ussi ou non.  Si l'op√©ration a √©chou√©, vous pouvez r√©essayer ou l'annuler.  Tout le reste se passe sans intervention. </p><br><p>  Dans le cas des terminaux, il est n√©cessaire de surveiller les √©ventuelles interruptions du processus de paiement √† n'importe quelle √©tape.  Une carte bancaire peut ne pas √™tre prise en compte ou les fonds seront insuffisants sur la carte.  Vous ne pouvez pas attendre une r√©ponse de la banque ou attendre, mais obtenez un code HTTP 5xx en r√©ponse.  Et √† n'importe quelle √©tape, la connexion peut simplement tomber. </p><br><p>  De plus, vous ne pourrez pas publier une application fonctionnant correctement avec le support du terminal Inpas sans certification.  La certification comprend la v√©rification de la disponibilit√© et du bon fonctionnement de toutes les op√©rations utilisateur du terminal et le traitement des √©v√©nements tels que la d√©connexion du r√©seau apr√®s que l'acheteur a d√©j√† attach√© une carte au terminal. </p><br><p>  Lors du test du terminal, vous devez tenir compte de la banque ou du syst√®me de paiement auquel il est associ√©.  Dans certains cas, m√™me en mode d√©veloppement, l'argent est rembours√© uniquement via le compte personnel du compte et non automatiquement. </p><br><p>  Vous devez √©galement vous rappeler que la banque participe √©galement au processus de paiement.  Par exemple, l'absence d'un bordereau peut se produire s'il n'y a pas de param√©trage n√©cessaire dans le compte personnel de la banque. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  La connexion de divers appareils √† une application Android est un processus compliqu√© mais int√©ressant.  Nous avons parl√© de lui dans son ensemble, pour d√©crire tous les obstacles, bien s√ªr, est irr√©aliste. </p><br><p>  Si vous avez des questions, je me ferai un plaisir d'y r√©pondre dans les commentaires.  Si les questions sont saisies dans un article s√©par√©, √©crivez :) </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462993/">https://habr.com/ru/post/fr462993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462977/index.html">Acc√©l√©rez les processus RH de routine avec RPA et BluePrism</a></li>
<li><a href="../fr462979/index.html">Aide-m√©moire pour un stagiaire: r√©solution de probl√®mes √©tape par √©tape lors d'un entretien avec Google</a></li>
<li><a href="../fr462983/index.html">Voice for game dev: comment nous avons d√©velopp√© la qu√™te vocale "Lovecraft World"</a></li>
<li><a href="../fr462989/index.html">BERT conversationnel - Apprenez le r√©seautage neuronal dans le langage des m√©dias sociaux</a></li>
<li><a href="../fr462991/index.html">Surfer sur la vague du Web 3.0</a></li>
<li><a href="../fr462997/index.html">Mitap de la Society of Anonymous Testers # 7 - rapport de la r√©union</a></li>
<li><a href="../fr463001/index.html">Tester votre infrastructure en tant que code avec Pulumi. Partie 1</a></li>
<li><a href="../fr463005/index.html">S√©curit√© ASMR</a></li>
<li><a href="../fr463009/index.html">Evolution des ventes de la soci√©t√© N</a></li>
<li><a href="../fr463011/index.html">Ne jetez pas l'ancienne acoustique Nouvelle vie de l'ancienne acoustique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>