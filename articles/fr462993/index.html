<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚌 🌋 🔢 Comment transformer un smartphone en caisse à part entière 🙆🏿 🎥 😭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque jour, dans les magasins, nous voyons différentes caisses - toutes sortes de solutions intégrées avec des boutons mystérieux. Derrière ces caiss...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment transformer un smartphone en caisse à part entière</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/moysklad/blog/462993/"><p>  Chaque jour, dans les magasins, nous voyons différentes caisses - toutes sortes de solutions intégrées avec des boutons mystérieux.  Derrière ces caisses se trouvent des caissiers qui crient «Galya, nous avons annulé».  Ceci est gênant pour les caissiers et les acheteurs. </p><br><p>  L'interface de paiement devient plus conviviale au fil du temps, et Gali est déjà moins nécessaire, mais le paiement est toujours un artefact lourd et complexe. </p><br><p><img src="https://habrastorage.org/webt/zq/bc/ia/zqbcia27fpbw0x-pgb09nk2khtw.png"></p><br><p>  Je m'appelle Vladimir Sarbeev, je suis développeur Android sur MySklad.  Et je suis sûr que la caisse enregistreuse peut être compacte et pratique.  De plus, vous pouvez transformer votre smartphone en caissier. </p><a name="habracut"></a><br><p>  Dans MyStore, nous avons créé l'application mobile Kassa MyStore.  Il s'agit d'un box-office complet à l'intérieur du smartphone. </p><br><p>  Cela fonctionne comme ceci: après autorisation, le caissier peut ouvrir et fermer des quarts, vendre des marchandises directement ou sur réservation, prendre en compte les espèces.  Vous pouvez connecter les appareils requis pour travailler à la caisse.  Ils sont sur la photo: </p><br><p><img src="https://habrastorage.org/webt/wp/_t/8k/wp_t8kkm69mpwtht7fb7d6a36nq.png"><br>  <em>1 - billetterie Atol Sigma 10;</em>  <em>2 - l'application n'est pas prise en charge, intégration avec les employés</em> <br>  <em>3 - billetterie Atol 11F;</em>  <em>4 - borne Verifone VX820;</em>  <em>5 - borne PAX S90</em> <br>  <em>6 - billetterie Shtrikh-Nano-F;</em>  <em>7 - billetterie Atol 15F;</em>  <em>8 - billetterie Bar-ON-LINE</em> <br>  <em>9 - scanner de codes à barres;</em>  <em>10 - Terminal PayMe;</em>  <em>11 - caisse MSPOS-K</em> </p><br><p>  Le smartphone lui-même ne peut pas imprimer les reçus de caisse et accepter le paiement par carte de crédit, donc des caisses et des terminaux de paiement sont nécessaires.  Un scanner matériel est nécessaire si l'appareil photo du smartphone ne convient pas pour un remplacement complet du scanner de codes-barres. </p><br><h2 id="vsevidyaschee-oko">  Oeil qui voit tout </h2><br><p>  Même avant la sortie de la caisse MySklad, nous avons décidé que la caméra était une caméra, mais l'utilisateur peut avoir un scanner de code-barres matériel qu'il souhaite utiliser. </p><br><p>  Nous pouvons travailler avec des scanners sous la forme d'un HID ordinaire (dispositif d'interface humaine).  Après avoir lu le code-barres, nous obtenons une séquence de caractères du scanner.  Il s'agit peut-être de l'intégration la plus simple.  Le plus simple, sinon deux «mais». </p><br><p>  Premièrement, étant «prêt à l'emploi», un scanner peut ne pas transmettre du tout ce qu'il devrait.  Deuxièmement, tous les modèles de scanner ne nous signalent pas que la lecture du code-barres est terminée. </p><br><p>  Le premier «mais» est résolu simplement: si le scanner commence à transmettre ce qu'il ne doit pas scanner, vous devez trouver les instructions du scanner et le configurer à l'aide des codes-barres de service.  En règle générale, les instructions sont complètes sur papier ou sous forme électronique auprès du fabricant.  Après avoir décrit les paramètres disponibles, il contient des codes-barres qui scannent dans la séquence souhaitée.  Vous pouvez donc configurer le scanner selon vos besoins. </p><br><p>  Le deuxième «mais» est un problème plus grave.  Le zoo des scanners est vaste et tous les appareils ne montrent pas la fin d'une ligne de lecture.  Il existe deux options pour résoudre ce problème.  La première consiste à utiliser les mêmes codes-barres de service pour définir un paramètre qui transmettra le caractère de saut de ligne après la lecture.  Si vous n'êtes pas chanceux avec le modèle et que la première option ne convient pas, vous pouvez définir le suffixe du scanner.  À l'aide des codes-barres de service, ajoutez un caractère à la fin de la séquence de lecture pour attraper la fin de l'entrée. </p><br><h2 id="podklyuchaem-kassu">  Nous connectons la caisse </h2><br><p> Donc, l'application est là, le scanner de codes-barres est connecté, mais nous ne pouvons toujours pas imprimer le chèque.  Pour cela, nous avons besoin du box-office lui-même.  Dans MySklad, nous soutenons KKT Atol et Shtrikh, également MSPOS, je vais en parler dans un autre article. </p><br><p>  En ce qui concerne l'intégration avec le caissier, la quantité de code de fer a commencé à croître inexorablement.  Nous avons décidé de mettre tout le travail avec l'équipement connecté dans une bibliothèque séparée.  L'application de caisse enregistreuse elle-même est devenue un client tirant une bibliothèque à travers gradle. </p><br><p>  Selon le modèle, vous pouvez vous connecter via USB, Bluetooth ou Wi-Fi.  Et aussi selon le protocole UART, qui est un couplage rigide de la caisse enregistreuse et d'un appareil Android dans un cas.  En outre, différents fournisseurs diffèrent radicalement dans la mise en œuvre de la connexion du client à la caisse.  Wrapper Java au-dessus des bibliothèques natives .so, un module complémentaire sur la bibliothèque open source jPOS et même le noyau fiscal accessible via un service avec une interface AIDL (langage de définition d'interface Android). </p><br><p>  Lors des premières tentatives d'intégration d'un appareil d'un fabricant, nous étions satisfaits du schéma d'interaction de l'appareil KKM: </p><br><p><img src="https://habrastorage.org/webt/jz/tz/my/jztzmyluw0ilashos-8utonzj9m.png"></p><br><p>  Mais en tenant compte du nombre d'implémentations de pilotes, des méthodes de connexion et de l'uniformité des fonctionnalités, nous avons décidé de repenser le travail avec le matériel.  En conséquence, le schéma précédent a pris la forme suivante: </p><br><p><img src="https://habrastorage.org/webt/5s/l1/sz/5sl1szcf5jfdhbrvs0r7uebkpek.png"></p><br><p>  <em>T est un wrapper de pilote de bas niveau spécifique</em> </p><br><p>  Le Gestionnaire de périphériques masque l'implémentation de la connexion au client.  Il suffit de créer un assistant de connexion, qui vous obligera à sélectionner systématiquement le fabricant du caissier, le type de connexion et à configurer les paramètres.  Dans le cas d'une connexion réussie, il nous renvoie un objet qui implémente l'interface KKMDevice. </p><br><p>  KKMDevice masque les détails de l'utilisation d'un pilote de fournisseur individuel.  Les wrappers de chaque fabricant spécifique contiennent un lien vers le pilote T et des délégués qui implémentent certains ensembles de fonctions.  Par exemple, FiscalDelegate, NonFiscalDelegate, DeviceInfoDelegate. </p><br><p>  Je noterai quelques points généraux d'intégration: </p><br><ul><li>  Assurez-vous de rester à l'écoute pour les mises à jour du pilote.  En plus des corrections de bugs et de la vitesse accrue, des sauts de qualité se produisent souvent.  Croyez-moi, la transition des commandes HEX de bas niveau à une interface de type Java, et de celle-ci aux tâches json, facilite grandement le travail et rend le code plus compréhensible. </li><li>  Pendant la durée des opérations, bloquez l'interface utilisateur avec une barre de progression.  Le panneau indique que le bouton "Payer" appuyé plusieurs fois de suite avec un CCP connecté est un signe avant-coureur de critiques dans le traqueur de tâches. </li><li>  Assurez-vous que toutes les opérations avec CCP sont effectuées de manière strictement séquentielle.  Une course de flux «réussie» peut bloquer le KKT, tandis que la barre de progression qui tourne en même temps est également une application. </li><li>  Si vous devez configurer le transfert de données vers l'opérateur de données fiscales, je vous conseille de sélectionner le nombre maximum de paramètres dans une liste prédéfinie.  Parce que la saisie manuelle de données avec une impulsion fiscale militaire est un excellent moyen de se tirer une balle dans le pied, mais du côté de l'utilisateur lors de l'utilisation de l'application. </li></ul><br><p>  Une impulsion fiscale est un appareil qui collecte et traite des informations sur les opérations de trading.  Cela peut coûter plus cher que le box-office lui-même.  Si le lecteur n'est pas configuré correctement, la mise à zéro du processus peut être requise.  Pour ce faire, ouvrez la billetterie, immédiatement la garantie s'envole. </p><br><h2 id="ekvayring">  Acquérir </h2><br><p>  Donc, nous avons l'interface de caisse, nous pouvons scanner les marchandises par code à barres et imprimer le chèque.  Reste à ajouter la possibilité de payer par carte. </p><br><p>  Notre application intègre la prise en charge des terminaux PayMe et Inpas.  Les premiers sont connectés via Bluetooth, tandis que les seconds peuvent être connectés via USB ou via Wi-Fi. </p><br><p>  Le schéma de connexion des terminaux de paiement est très similaire à la connexion d'un CCP, sauf autorisation supplémentaire requise. </p><br><p>  Mais il existe de sérieuses différences - dans la gestion du comportement anormal de l'appareil.  Ainsi, dans le PCC, toute opération a réussi ou non.  Si l'opération a échoué, vous pouvez réessayer ou l'annuler.  Tout le reste se passe sans intervention. </p><br><p>  Dans le cas des terminaux, il est nécessaire de surveiller les éventuelles interruptions du processus de paiement à n'importe quelle étape.  Une carte bancaire peut ne pas être prise en compte ou les fonds seront insuffisants sur la carte.  Vous ne pouvez pas attendre une réponse de la banque ou attendre, mais obtenez un code HTTP 5xx en réponse.  Et à n'importe quelle étape, la connexion peut simplement tomber. </p><br><p>  De plus, vous ne pourrez pas publier une application fonctionnant correctement avec le support du terminal Inpas sans certification.  La certification comprend la vérification de la disponibilité et du bon fonctionnement de toutes les opérations utilisateur du terminal et le traitement des événements tels que la déconnexion du réseau après que l'acheteur a déjà attaché une carte au terminal. </p><br><p>  Lors du test du terminal, vous devez tenir compte de la banque ou du système de paiement auquel il est associé.  Dans certains cas, même en mode développement, l'argent est remboursé uniquement via le compte personnel du compte et non automatiquement. </p><br><p>  Vous devez également vous rappeler que la banque participe également au processus de paiement.  Par exemple, l'absence d'un bordereau peut se produire s'il n'y a pas de paramétrage nécessaire dans le compte personnel de la banque. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  La connexion de divers appareils à une application Android est un processus compliqué mais intéressant.  Nous avons parlé de lui dans son ensemble, pour décrire tous les obstacles, bien sûr, est irréaliste. </p><br><p>  Si vous avez des questions, je me ferai un plaisir d'y répondre dans les commentaires.  Si les questions sont saisies dans un article séparé, écrivez :) </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462993/">https://habr.com/ru/post/fr462993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462977/index.html">Accélérez les processus RH de routine avec RPA et BluePrism</a></li>
<li><a href="../fr462979/index.html">Aide-mémoire pour un stagiaire: résolution de problèmes étape par étape lors d'un entretien avec Google</a></li>
<li><a href="../fr462983/index.html">Voice for game dev: comment nous avons développé la quête vocale "Lovecraft World"</a></li>
<li><a href="../fr462989/index.html">BERT conversationnel - Apprenez le réseautage neuronal dans le langage des médias sociaux</a></li>
<li><a href="../fr462991/index.html">Surfer sur la vague du Web 3.0</a></li>
<li><a href="../fr462997/index.html">Mitap de la Society of Anonymous Testers # 7 - rapport de la réunion</a></li>
<li><a href="../fr463001/index.html">Tester votre infrastructure en tant que code avec Pulumi. Partie 1</a></li>
<li><a href="../fr463005/index.html">Sécurité ASMR</a></li>
<li><a href="../fr463009/index.html">Evolution des ventes de la société N</a></li>
<li><a href="../fr463011/index.html">Ne jetez pas l'ancienne acoustique Nouvelle vie de l'ancienne acoustique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>