<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚹 🌚 👦 Mengembangkan paket pypi yang sempurna dengan dukungan untuk berbagai versi python 🏇🏽 👩‍⚖️ 👰🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ini adalah manual kecil / cerita tentang cara membuat paket pypi "sempurna" untuk python, yang dapat dipasang oleh siapa pun dengan perintah yang diha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mengembangkan paket pypi yang sempurna dengan dukungan untuk berbagai versi python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483512/"><p>  Ini adalah manual kecil / cerita tentang cara membuat paket pypi "sempurna" untuk python, yang dapat dipasang oleh siapa pun dengan perintah yang dihargai: </p><br><pre><code class="plaintext hljs">pip install my-perfect-package</code> </pre> <br><p>  Ini ditujukan untuk pemula, tetapi saya mendesak para profesional untuk mengekspresikan pendapat mereka tentang cara meningkatkan paket "sempurna".  Karena itu, saya minta kucing. </p><a name="habracut"></a><br><h2 id="chto-znachit-idealnyy-paket">  Apa yang dimaksud dengan paket "ideal"? </h2><br><p>  Saya akan melanjutkan dari persyaratan berikut: </p><br><ul><li>  <strong>Sumber terbuka di github;</strong> <br>  Setiap orang harus dapat berkontribusi untuk pengembangan dan berterima kasih kepada penulis. </li><li>  <strong>Dukungan untuk semua versi python saat ini / populer (2.7, 3.5, 3.6, 3.7, 3.8);</strong> <br>  Ular berbeda, dan di suatu tempat masih aktif menulis di 2.7. </li><li>  <strong>Cakupan 100% dengan unit test;</strong> <br><del>  Tes unit meningkatkan arsitektur dan mengotomatiskan pemeriksaan regresi. </del><br>  Lencana dengan nomor yang dihargai meningkatkan FAQ dan <a href="https://cmustrudel.github.io/papers/icse18badges.pdf" rel="nofollow">menetapkan bilah untuk orang lain</a> . </li><li>  <strong>Menggunakan CI:</strong> <br>  Pemeriksaan otomatis sangat mudah! <del>  Dan banyak lencana keren </del><br><ul><li>  <strong>Menjalankan tes unit pada semua platform dan pada semua versi python;</strong> <br>  Jangan percaya mereka yang mengklaim bahwa python dan paket yang diinstal adalah <a href="https://docs.python.org/2/library/os.html" rel="nofollow">cross-platform</a> , karena Anda selalu dapat menemukan <a href="https://bugs.python.org/issue22587" rel="nofollow">bug</a> . </li><li>  <strong>Pemeriksaan kode gaya;</strong> <br>  Gaya seragam meningkatkan keterbacaan dan mengurangi jumlah diskusi kosong dalam ulasan. </li><li>  <strong>Penganalisa kode statis;</strong> <br>  Mencari bug dalam kode secara otomatis?  Beri aku dua! </li></ul></li><li>  <strong>Dokumentasi aktual;</strong> <br>  Contoh bekerja dengan paket, deskripsi metode / kelas dan analisis kesalahan khas - pengalaman yang didokumentasikan akan mengurangi ambang entri untuk pemula. </li><li>  <strong>Pengembangan lintas platform;</strong> <br>  Sayangnya, sulit untuk memberikan kontribusi pribadi untuk proyek hanya karena pengembang mempertajam alat untuk Unix.  Misalnya, saya menggunakan skrip bash untuk perakitan. </li><li>  <strong>Paket ini berguna dan membuat dunia menjadi tempat yang lebih baik.</strong> <br>  Suatu persyaratan yang sulit, karena dilihat dari jumlah paket dalam <a href="https://pypi.org/" rel="nofollow">pypi</a> <em>(~ 210k),</em> pengembang adalah altruis liar dan banyak yang telah ditulis. </li></ul><br><h2 id="s-chego-nachat">  Di mana untuk memulai? </h2><br><p>  Tidak ada ide bagus, jadi saya memilih topik yang usang dan sangat populer - bekerja dengan sistem angka.  Versi pertama harus dapat menerjemahkan angka ke dalam bahasa Romawi dan sebaliknya.  Untuk manual lebih rumit dan tidak perlu.  Oh ya, yang terpenting adalah namanya: <del>  numsys - sebagai dekripsi sistem angka. </del>  <em>numeral-system-py</em> . </p><br><h2 id="kak-testirovat">  Bagaimana cara menguji? </h2><br><p>  Saya mengambil <em>python3.7</em> dan pertama menulis tes dengan fungsi bertopik (kita semua <a href="https://habr.com/ru/post/121162/">TDD</a> ) menggunakan modul <a href="https://habr.com/ru/post/121162/">unittests</a> standar. </p><br><p>  Saya membuat struktur proyek berikut: </p><br><pre> <code class="plaintext hljs">src/ numeral-system/ __init__.py roman.py tests __init__.py test_roman.py</code> </pre> <br><p>  Saya tidak akan melakukan tes dalam paket, jadi saya pisahkan <del>  sekam </del>  .  Awalnya, <code>src/</code> tidak membuat folder <code>src/</code> , tetapi pengembangan lebih lanjut menunjukkan bahwa lebih nyaman bagi saya untuk beroperasi.  Ini tidak perlu, karena itu, sesuka hati. </p><br><p>  Saya memutuskan untuk menggunakan <a href="https://habr.com/ru/post/269759/">pytest</a> untuk diluncurkan - ia tahu cara bekerja dengan sempurna dengan tes dari modul standar.  Mungkin terlihat sedikit tidak masuk akal, tetapi modul standar untuk tes kepada saya <del>  sepertinya </del>  tampak sedikit lebih nyaman.  <em>Sekarang saya akan merekomendasikan menggunakan gaya penulisan terbaik.</em> </p><br><p>  Tapi, mereka mengatakan bahwa menempatkan <code>pytest</code> (seperti dependensi lainnya) dalam sistem python bukanlah ide yang sangat cerdas ... </p><br><h2 id="kak-upravlyat-zavisimostyami">  Bagaimana cara mengelola dependensi? </h2><br><p>  Hanya <a href="https://virtualenv.pypa.io/en/latest/" rel="nofollow">virtualenv</a> dan <code>requirements.txt</code> dapat digunakan.  Anda bisa menjadi progresif dan menggunakan <a href="https://poetry.eustace.io/" rel="nofollow">puisi</a> .  Saya, mungkin, akan menggunakan <a href="https://tox.readthedocs.io/en/latest/" rel="nofollow">racun</a> - alat untuk menyederhanakan otomatisasi dan pengujian, yang juga akan memungkinkan saya untuk mengelola dependensi. </p><br><p>  Saya membuat konfigurasi tox.ini sederhana dan menginstal <code>pytest</code> : </p><br><pre> <code class="plaintext hljs">[tox] envlist = py37 ;     ,   python3.7 [testenv] ;     deps =  `deps`  ,   . -r requirements.txt ;     -r requirements-test.txt ; commands = pytest ;  </code> </pre> <br><p>  Awalnya, saya secara eksplisit menunjukkan dependensi, tetapi praktik integrasi dengan layanan pihak ketiga menunjukkan bahwa cara terbaik masih akan menyimpan dependensi dalam file <code>requirements.txt</code> . </p><br><p>  Momen yang sangat halus muncul.  Perbaiki versi saat ini pada saat pengembangan atau selalu menempatkan yang terbaru? </p><br><p>  Jika Anda komit, maka selama instalasi mungkin ada konflik antara paket karena versi berbeda dari dependensi yang digunakan.  Jika Anda tidak melakukan, maka paket tersebut mungkin tiba-tiba berhenti bekerja.  Situasi yang terakhir ini sangat tidak menyenangkan untuk produk akhir, ketika semua bangunan dapat "berubah merah" dalam satu malam karena pembaruan kecil dari ketergantungan implisit.  Dan menurut <a href="https://en.wikipedia.org/wiki/Murphy%2527s_law" rel="nofollow">hukum Murphy,</a> ini akan terjadi pada hari rilis. </p><br><p>  Karena itu, saya mengembangkan aturan untuk diri saya sendiri: </p><br><ol><li>  Selalu perbaiki versi untuk produk akhir, karena versi mana yang digunakan adalah tanggung jawab mereka. </li><li>  Jangan memperbaiki versi yang digunakan untuk paket yang diinstal.  Atau batasi rentangnya jika fungsionalitas paket membutuhkannya. </li></ol><br><h2 id="chto-dalshe">  Apa selanjutnya </h2><br><p>  Saya sedang menulis ujian! </p><br><p>  Saya mengisi isi fungsinya, menambahkan komentar dan membuat tes berjalan dengan benar. <br>  Pada titik ini, kebanyakan pengembang biasanya berhenti (saya masih percaya bahwa semua orang menulis tes =), menerbitkan paket dan meretas bug.  Tapi saya pindah <del>  dan lompat ke lubang kelinci </del>  . </p><br><h2 id="kak-rabotat-s-razlichnymi-versiyami-python">  Bagaimana cara bekerja dengan berbagai versi python? </h2><br><p>  Dalam konfigurasi <code>tox</code> , <code>tox</code> menentukan peluncuran tes pada semua versi python yang menarik: </p><br><pre> <code class="plaintext hljs">[tox] envlist = py{27,35,36,37,38}</code> </pre> <br><p>  Menggunakan <a href="https://khashtamov.com/ru/pyenv-python/" rel="nofollow">pyenv, saya</a> mengirimkan versi yang diperlukan untuk diri saya sendiri secara lokal sehingga <code>tox</code> dapat menemukannya dan membuat lingkungan pengujian. </p><br><h2 id="gde-zavetnye-100">  Di mana 100% dihargai? </h2><br><p>  Saya akan menambahkan ukuran cakupan kode - untuk ini ada paket <a href="https://coverage.readthedocs.io/en/v4.5.x/" rel="nofollow">cakupan yang</a> sangat baik dan integrasi yang sangat baik dengan pytest - <a href="https://github.com/pytest-dev/pytest-cov" rel="nofollow">pytest-cov</a> . <br>  <code>requirements-test.txt</code> sekarang terlihat seperti ini: </p><br><pre> <code class="plaintext hljs">six=1.13.0 pytest=4.6.7 pytest-cov=2.8.1 parameterized=0.7.1</code> </pre> <br><p>  Menurut aturan di atas, saya memperbaiki versi paket yang digunakan untuk menjalankan tes. </p><br><p>  Saya mengubah perintah uji coba: </p><br><pre> <code class="plaintext hljs">deps = -r requirements.txt -r requirements-test.txt commands = pytest \ --cov=src/ \ --cov-config="{toxinidir}/tox.ini" \ --cov-append</code> </pre> <br><p>  Saya mengumpulkan statistik cakupan untuk semua kode dari <code>src/</code> folder - paket itu sendiri ( <em>numeral_system /</em> ) dan diperlukan untuk kode uji ( <em>tes /</em> ) - Saya tidak ingin tes itu sendiri berisi bagian yang tidak dapat dieksekusi? </p><br><p>  <code>--cov-append</code> perintah <code>--cov-append</code> semua statistik yang dikumpulkan untuk setiap panggilan di bawah versi python yang berbeda menjadi satu, karena cakupan untuk python kedua dan ketiga dapat berbeda (hi versi tergantung kode dan modul <a href="https://pypi.org/project/six/" rel="nofollow">enam</a> !), Tetapi totalnya memberikan 100 %  Contoh sederhana: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sys.version_info &gt; (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>): <span class="hljs-comment"><span class="hljs-comment"># Python 3 code in this block else: # Python 2 code in this block</span></span></code> </pre> <br><p>  Tambahkan lingkungan baru untuk membuat laporan cakupan. </p><br><pre> <code class="plaintext hljs">[testenv:coverage_report] deps = coverage commands = coverage html ;   ,   coverage report --include="src/*" --fail-under=100 -m ;    100% </code> </pre> <br><p>  Dan saya menambahkan ke daftar lingkungan setelah menjalankan tes pada semua versi python. </p><br><pre> <code class="plaintext hljs">[tox] envlist = py{27,35,36,37,38} coverage_report</code> </pre> <br><p>  Setelah menjalankan perintah <code>tox</code> , folder <code>tox</code> berisi file <code>index.html</code> dengan laporan yang indah akan muncul di root proyek. </p><br><p>  Untuk lambang yang didambakan, saya mengintegrasikan 100% dengan layanan <a href="https://codecov.io/" rel="nofollow">codecov</a> , yang dengan sendirinya akan berintegrasi dengan <code>github</code> dan memungkinkan Anda untuk melihat riwayat perubahan cakupan kode.  Untuk melakukan ini, tentu saja, Anda harus membuat akun di sana. </p><br><p>  Lingkungan peluncuran terakhir adalah sebagai berikut: </p><br><pre> <code class="plaintext hljs">[testenv:coverage_report] deps = coverage==5.0.2 codecov==2.0.15 commands = coverage html coverage report --include="src/*" --fail-under=100 -m coverage xml codecov -f coverage.xml --token=2455dcfa-f9fc-4b3a-b94d-9765afe87f0f ;     codecov,   </code> </pre> <br><p>  Tetap sekarang hanya untuk menambahkan tautan ke lencana di <code>README.rst</code> : </p><br><pre> <code class="plaintext hljs">|Code Coverage| .. |Code Coverage| image:: https://codecov.io/gh/zifter/numeral-system-py/branch/master/graph/badge.svg :target: https://codecov.io/gh/zifter/numeral-system-py</code> </pre> <br><h2 id="kak-formatirovat-i-analizirovat-kod">  Bagaimana memformat dan menganalisis kode? </h2><br><p>  Banyak analis tidak ada, karena mereka, sebagian besar, saling melengkapi.  Oleh karena itu, saya akan mengintegrasikan analisis statis populer yang akan memeriksa kepatuhan dengan <a href="https://www.python.org/dev/peps/pep-0008/" rel="nofollow">PEP8</a> , menemukan masalah potensial dan <del>  perbaiki semua bug </del>  memformat kode secara seragam. </p><br><p>  Anda harus segera mempertimbangkan di mana menentukan parameter untuk fine-tuning analisis.  Untuk melakukan ini, Anda dapat menggunakan file <code>setup.cfg</code> , <code>setup.cfg</code> , satu file khusus, atau file tertentu untuk analisis.  Saya memutuskan untuk menggunakan <code>tox.ini</code> secara langsung, karena Anda bisa menyalin <code>tox.ini</code> untuk proyek mendatang. </p><br><h2 id="isort">  isort </h2><br><p>  <a href="https://github.com/timothycrosley/isort" rel="nofollow">isort</a> adalah utilitas untuk memformat impor. </p><br><p>  Saya membuat lingkungan berikut untuk menjalankan <code>isort</code> dalam mode format kode. </p><br><pre> <code class="plaintext hljs">[testenv:isort] changedir = {toxinidir}/src deps = isort==4.3.21 commands = isort -y -sp={toxinidir}/tox.ini</code> </pre> <br><p>  Sayangnya, <code>isort</code> tidak dapat menentukan folder untuk pemformatan.  Oleh karena itu, Anda harus mengubah direktori startup melalui <code>changedir</code> dan tentukan path ke file dengan pengaturan <code>-sp={toxinidir}/tox.ini</code> .  Sakelar <code>-y</code> diperlukan untuk menonaktifkan mode interaktif. </p><br><p>  Untuk menjalankan dalam pengujian, Anda memerlukan mode verifikasi - untuk ini ada tanda - <code>--check-only</code> : </p><br><pre> <code class="plaintext hljs">[testenv:isort-check] changedir = {toxinidir}/src deps = isort==4.3.21 commands = isort --check-only -sp={toxinidir}/tox.ini</code> </pre> <br><h2 id="black">  hitam </h2><br><p>  Selanjutnya, saya mengintegrasikan dengan formatter kode <a href="https://black.readthedocs.io/en/stable/" rel="nofollow">hitam</a> .  Saya melakukannya dengan analogi dengan <code>isort</code> : </p><br><pre> <code class="plaintext hljs">[testenv:black] deps = black==19.10b0 commands = black src/ [testenv:black-check] deps = black==19.10b0 commands = black --check src/</code> </pre> <br><p>  Semuanya berfungsi dengan baik, tetapi ada konflik dengan <code>isort</code> - ada perbedaan dalam <a href="https://github.com/psf/black/issues/127" rel="nofollow">format impor</a> . </p><br><p>  Dalam <a href="https://github.com/timothycrosley/isort/issues/694" rel="nofollow">salah satu komentar saya</a> menemukan pengaturan <code>isort</code> kompatibel minimal, yang saya gunakan: </p><br><pre> <code class="plaintext hljs">[isort] multi_line_output=3 include_trailing_comma=True force_grid_wrap=0 use_parentheses=True line_length=88</code> </pre> <br><h2 id="flake8">  serpihan8 </h2><br><p>  Selanjutnya, saya mengintegrasikan dengan <a href="http://flake8.pycqa.org/en/latest/" rel="nofollow">analisis</a> statis <a href="http://flake8.pycqa.org/en/latest/" rel="nofollow">flake8</a> . </p><br><pre> <code class="plaintext hljs">[testenv:flake8-check] deps = flake8==3.7.9 commands = flake8 --config=tox.ini src/</code> </pre> <br><p>  Ada <a href="https://github.com/psf/black/issues/113" rel="nofollow">masalah dengan integrasi</a> dengan <code>black</code> lagi.  Kita harus menambahkan penyetelan halus, yang sebenarnya <a href="https://github.com/psf/black" rel="nofollow">direkomendasikan</a> oleh <code>black</code> itu sendiri: </p><br><pre> <code class="plaintext hljs">[flake8] max-line-length=88 ignore=E203</code> </pre> <br><p>  Sayangnya, pertama kali itu tidak berhasil.  Jatuh dengan kesalahan <code>E231 missing whitespace after ','</code> , saya harus menambahkan kesalahan ini untuk diabaikan: </p><br><pre> <code class="plaintext hljs">[flake8] max-line-length=88 ignore=E203,E231</code> </pre> <br><h2 id="pylint">  pylint </h2><br><p>  Integrasikan dengan <a href="https://www.pylint.org/" rel="nofollow">penganalisis</a> kode statis <a href="https://www.pylint.org/" rel="nofollow">pylint</a> </p><br><pre> <code class="plaintext hljs">[testenv:pylint-check] deps = {[testenv]deps} # pylint  ,     pylint==2.4.4 commands = pylint --rcfile=tox.ini src/</code> </pre> <br><p>  Saya segera menemukan batasan aneh - nama fungsi 30 karakter (ya, saya menulis nama metode pengujian yang sangat panjang) dan peringatan untuk keberadaan <code>TODO</code> dalam kode. <br>  Saya harus menambahkan beberapa pengecualian: </p><br><pre> <code class="plaintext hljs">[MESSAGES CONTROL] disable=fixme,invalid-name</code> </pre> <br><p>  Juga, saat yang tidak menyenangkan adalah bahwa pengembang <code>pylint</code> mengubur <code>python2.7</code> dan tidak lagi mengembangkan paket untuk itu.  Oleh karena itu, pemeriksaan harus dijalankan pada paket saat ini untuk <code>python3.7</code> . <br>  Tambahkan baris yang sesuai ke konfigurasi: </p><br><pre> <code class="plaintext hljs">[tox] envlist = isort-check black-check flake8-check pylint-check py{27,35,36,37,38} coverage_report basepython = python3.7</code> </pre> <br><p>  Ini juga penting untuk menjalankan tes pada platform yang berbeda, karena versi standar python dalam sistem CI berbeda. </p><br><h2 id="chto-tam-s-ci">  Ada apa dengan CI? </h2><br><h3 id="appveyor">  Pengantar </h3><br><p>  Integrasikan dengan <a href="https://www.appveyor.com/" rel="nofollow">appveyor</a> - CI untuk windows.  Pengaturan awal sederhana - semuanya bisa dilakukan di antarmuka, lalu unduh file yaml dan komit ke repositori. </p><br><pre> <code class="plaintext hljs">version: 0.0.{build} install: - cmd: &gt;- C:\\Python37\\python -m pip install --upgrade pip C:\\Python37\\pip install tox build: off test_script: - cmd: C:\\Python37\\tox</code> </pre> <br><p>  Di sini saya secara eksplisit menentukan versi <code>python3.7</code> , karena <code>python2.7</code> akan digunakan secara default (dan <code>tox</code> juga akan menggunakan versi ini, walaupun saya secara eksplisit menentukan <code>python3.7</code> ). <br>  Tautan ke lencana, seperti biasa, ditambahkan ke <code>README.rst</code> </p><br><pre> <code class="plaintext hljs">|Build status Appveyor| .. |Build status Appveyor| image:: https://ci.appveyor.com/api/projects/status/github/zifter/numeral-system-py?branch=master&amp;svg=true :target: https://ci.appveyor.com/project/zifter/numeral-system-py</code> </pre> <br><h3 id="travis-ci">  Travis ci </h3><br><p>  Setelah itu, saya mengintegrasikan dengan <a href="https://travis-ci.org/" rel="nofollow">Travis CI</a> - CI di Linux (dan di bawah MacOS dengan Windows, tetapi <a href="https://docs.travis-ci.com/user/languages/python/" rel="nofollow"><code>Python builds are not available on the macOS and Windows environments</code></a> . Pengaturannya sedikit lebih rumit, karena file konfigurasi akan digunakan langsung dari repositori. Beberapa percobaan dan kesalahan iterasi - konfigurasi sudah siap, saya tekan satu commit yang indah dan permintaan penggabungan sudah siap. </p><br><pre> <code class="plaintext hljs">language: python python: 3.8 # dist: xenial # required for Python 3.7 (travis-ci/travis-ci#9069) sudo: required # required for Python 3.7 (travis-ci/travis-ci#9069) addons: apt: sources: - deadsnakes packages: - python3.5 - python3.6 - python3.7 - pypy install: - pip install tox script: - tox</code> </pre> <br><p>  ( <em>Pertanyaan retoris: Dan mengapa proyek CI sangat menyukai format yaml?</em> ) </p><br><p>  Saya menunjukkan versi <code>python3.8</code> , karena tidak berfungsi dengan benar melalui <code>addon</code> , dan <code>Travis CI</code> berhasil membuat <code>virtualenv</code> dari versi yang ditentukan. </p><br><p>  Orang yang akrab dengan <code>Travis CI</code> mungkin bertanya, mengapa tidak secara eksplisit menentukan versi python dengan cara ini?  Bagaimanapun, <code>Travis CI</code> secara otomatis membuat <code>virtualenv</code> dan menjalankan perintah yang diperlukan di dalamnya. </p><br><p>  Alasannya adalah bahwa kita perlu mengumpulkan data cakupan kode dari semua versi.  Tetapi tes akan dijalankan di pekerjaan yang berbeda secara paralel, itulah sebabnya mengapa tidak akan bekerja untuk mengumpulkan laporan cakupan umum. </p><br><p>  Tentu saja, saya yakin sedikit lebih banyak pengertian dan ini bisa diperbaiki. </p><br><p>  Secara tradisional, tautan ke lencana juga ditambahkan ke <code>README.rst</code> </p><br><pre> <code class="plaintext hljs">|Build Status Travis CI| .. |Build Status Travis CI| image:: https://travis-ci.org/zifter/numeral-system-py.svg?branch=master :target: https://travis-ci.org/zifter/numeral-system-py</code> </pre> <br><h2 id="dokumentaciya">  Dokumentasi </h2><br><p>  Saya pikir setiap pengembang python telah menggunakan layanan setidaknya sekali - <a href="https://readthedocs.org/" rel="nofollow">readthedocs.org</a> .  Menurut saya ini adalah layanan terbaik untuk hosting dokumentasinya. <br>  Saya akan menggunakan alat standar untuk menghasilkan dokumentasi <a href="http://www.sphinx-doc.org/en/master/" rel="nofollow">Sphinx</a> .  Saya mengikuti langkah-langkah dari <a href="https://docs.readthedocs.io/en/stable/intro/getting-started-with-sphinx.html" rel="nofollow">manual awal</a> dan mendapatkan struktur berikut: </p><br><pre> <code class="plaintext hljs">src/ docs/ build/ #      html  source/ #     _static/ #   , ,  _templates/ #     conf.py #    index.rst #    make.bat Makefile # make     make</code> </pre> <br><p>  Selanjutnya, Anda perlu melakukan langkah-langkah minimum untuk mengonfigurasi: </p><br><ol><li>  <code>github</code> secara default menyarankan untuk membuat file <code>README.md</code> dalam format <a href="https://en.wikipedia.org/wiki/Markdown" rel="nofollow">Markdown</a> , ketika <code>sphinx</code> secara default disarankan menggunakan <a href="https://en.wikipedia.org/wiki/ReStructuredText" rel="nofollow">ReStructuredText</a> . </li></ol><br><p>  Karena itu, saya harus menulis ulang dalam format <code>.rst</code> . <del>  Dan jika saya telah membaca manual mulai sampai akhir setidaknya sekali, saya menyadari bahwa <code>sphinx</code> dapat melakukannya di Markdown </del>  . <br>  Saya <code>README.rst</code> file <code>README.rst</code> di <code>index.rst</code> </p><br><pre> <code class="plaintext hljs">.. include:: ../../README.rst</code> </pre> <br><ol><li>  Untuk menghasilkan dokumentasi secara otomatis dari komentar di sumber, saya menambahkan ekstensi <a href="http://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html" rel="nofollow">sphinx.ext.autodoc</a> . </li><li>  Saya <code>conf.py</code> folder paket ke <code>conf.py</code>  Ini akan memungkinkan <code>sphinx</code> mengimpor kode kami untuk analisis. <br><pre> <code class="plaintext hljs">import os import sys sys.path.insert(0, os.path.abspath('./../../src')) import numeral_system</code> </pre> </li><li>  Saya menambahkan folder <code>docs/source/api-docs</code> dan letakkan file deskripsi untuk setiap modul di sana.  Dokumentasi harus dihasilkan secara otomatis dari komentar: <br><pre> <code class="plaintext hljs">Roman numeral system ========================= .. automodule:: numeral_system.roman :members:</code> </pre> </li></ol><br><p>  Setelah itu, proyek siap untuk mengungkapkan deskripsinya kepada dunia.  Anda perlu membuat akun (lebih disukai melalui akun di <code>github</code> ) dan mengimpor proyek Anda, langkah-langkah rinci dijelaskan dalam <a href="" rel="nofollow">instruksi</a> . <br>  Secara tradisi, saya menciptakan lingkungan yang <code>tox</code> : </p><br><pre> <code class="plaintext hljs">[testenv:gen_docs] deps = -r docs/requirements.txt commands = sphinx-build -b html docs/source/ docs/build/</code> </pre> <br><p>  Saya menggunakan perintah <code>sphinx-build</code> secara eksplisit, bukan <code>make</code> , karena tidak ada di bawah Windows.  Dan saya tidak ingin melanggar prinsip pengembangan lintas platform. </p><br><p>  Segera setelah perubahan dibekukan, <code>readthedocs.org</code> akan secara otomatis mengumpulkan dokumentasi dan menerbitkannya. </p><br><p>  Tapi ... <a href="https://github.com/readthedocs/readthedocs.org/issues/2569" rel="nofollow"><code>Build failed</code></a> .  Saya tidak melakukan versi <code>sphinx</code> dan <code>sphinx_rtd_theme</code> , dan saya berharap <code>readthedocs.org</code> mengambil versi saat ini.  Tapi ini tidak benar.  Saya memperbaiki: </p><br><pre> <code class="plaintext hljs">sphinx==2.3.1 sphinx_rtd_theme==0.4.3</code> </pre> <br><p>  Dan saya membuat file config khusus <code>.readthedocs.yml</code> untuk <code>readthedocs.org</code> , di mana saya menggambarkan lingkungan untuk meluncurkan build: </p><br><pre> <code class="plaintext hljs">python: version: 3.7 install: - requirements: docs/requirements.txt - requirements: requirements.txt</code> </pre> <br><p>  Di sinilah fakta berguna bahwa dependensi berada dalam file <code>requirements.txt</code> .  Saya menunggu bangunan dan <a href="https://numeral-system-py.readthedocs.io/en/latest/" rel="nofollow">dokumentasinya tersedia</a> . </p><br><p>  Tambahkan lencana lagi: </p><br><pre> <code class="plaintext hljs">|Docs| .. |Docs| image:: https://readthedocs.org/projects/numeral-system-py/badge/?version=latest&amp;style=flat :target: https://numeral-system-py.readthedocs.io/en/latest/</code> </pre> <br><h2 id="licenzirovanie">  Perizinan </h2><br><p>  Perlu mempertimbangkan untuk memilih lisensi untuk paket tersebut. <br>  Ini adalah topik yang sangat luas, jadi saya membaca <a href="https://habr.com/ru/post/243091/">artikel ini</a> .  Pada dasarnya, pilihannya adalah antara <a href="http://directory.fsf.org/wiki/License:Expat" rel="nofollow">MIT</a> dan <a href="" rel="nofollow">Apache 2.0</a> .  Saya menyukai frasa yang berhasil dikeluarkan dari konteks: </p><br><pre> <code class="plaintext hljs">MIT      </code> </pre> <br><p>  Saya setuju sepenuhnya, saya akan melakukannya. Jika rencananya berubah, Anda dapat dengan mudah mengubah lisensi (meskipun versi sebelumnya akan di bawah yang lama). </p><br><p>  Sekali lagi, tambahkan lencana <del>  dewa lencana </del>  : </p><br><pre> <code class="plaintext hljs">|License| .. |License| image:: https://img.shields.io/badge/License-MIT-yellow.svg :target: https://opensource.org/licenses/MIT</code> </pre> <br><p>  <a href="https://gist.github.com/lukas-h/2a5d00690736b4c3a7ba" rel="nofollow">Di sini</a> Anda dapat menemukan lencana untuk semua lisensi. </p><br><h2 id="kak-zalit-na-pypi">  Bagaimana cara mengunggah ke pypi? </h2><br><p>  Pertama, Anda perlu membuat akun di <a href="https://pypi.org/" rel="nofollow">pypi.org</a> .  Kemudian lanjutkan dengan persiapan paket. </p><br><h3 id="sozdayu-setupcfg">  Saya membuat setup.cfg </h3><br><p>  Penting untuk menggambarkan konfigurasi untuk menginstal / membangun paket dengan benar.  Saya mengikuti <a href="https://docs.python.org/3/distutils/introduction.html" rel="nofollow">instruksi</a> .  Dimungkinkan untuk mengatur data melalui <code>setup.py</code> , tetapi tidak ada opsi untuk mengatur beberapa parameter.  Karena itu, gunakan file <code>setup.cfg</code> , di mana Anda dapat menentukan semua nuansa.  Ditemukan <a href="https://gist.github.com/althonos/6914b896789d3f2078d1e6237642c35c" rel="nofollow">templat kecil</a> tentang cara mengisi file ini.  Sebagai hasilnya, saya menggunakan keduanya dan file itu - lebih nyaman. </p><br><p>  File ini juga dapat digunakan untuk mengkonfigurasi <code>pylint</code> , <code>flake8</code> dan pengaturan lainnya, tetapi saya tidak melakukannya. </p><br><h3 id="kak-sobrat-paket">  Bagaimana cara merakit paket? </h3><br><p>  Sekali lagi saya menulis sebuah lingkungan yang akan membantu saya menyusun paket yang diperlukan: </p><br><pre> <code class="plaintext hljs">[testenv:build_wheel] skip_install = True deps = ;     wheel docutils pygments commands = python -c 'import shutil; (shutil.rmtree(p, ignore_errors=True) for p in ["build", "dist"]);' python setup.py sdist bdist_wheel</code> </pre> <br><p>  Mengapa saya menghapus folder menggunakan python?  Saya ingin mematuhi persyaratan untuk pengembangan lintas platform, tidak ada cara mudah untuk melakukan ini di Windows dan Unix. </p><br><p>  Saya meluncurkan lingkungan pengujian: </p><br><pre> <code class="plaintext hljs">tox -e build_wheel</code> </pre> <br><p>  Akibatnya, di folder <code>dist</code> saya dapatkan: </p><br><pre> <code class="plaintext hljs">dist/ numeral-system_py-0.1.0.tar.gz numeral_system-py-0.1.0-py2.py3-none-any.whl</code> </pre> <br><h3 id="zalivayu">  Saya isi! </h3><br><p>  Tidak juga. </p><br><p>  Untuk memulainya, perlu memeriksa apakah paket itu bekerja dengan benar.  Saya akan mengunggahnya ke repositori paket pengujian.  Karena itu, Anda perlu membuat akun lain, tetapi sudah ada di <a href="https://test.pypi.org/" rel="nofollow">test.pypi.org</a> . </p><br><p>  Saya menggunakan paket <a href="https://pypi.org/project/twine/" rel="nofollow">benang</a> untuk ini - alat untuk mengisi artefak di PyPi. </p><br><pre> <code class="plaintext hljs">[testenv:test_upload] skip_install = True deps = twine ;    commands = python -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*</code> </pre> <br><p>  Awalnya, proyek itu disebut <code>numsys</code> , tetapi ketika mencoba mengisinya, saya menemukan fakta bahwa sebuah paket dengan nama yang sama sudah ada!  Dan apa yang paling menyebalkan - dia juga tahu cara mengonversi angka Romawi :) Dia tidak terlalu kesal dan berganti nama menjadi <code>numeral-system-py</code> . </p><br><p>  Sekarang Anda perlu menginstal paket dari lingkungan pengujian.  Validasi juga harus otomatis: </p><br><pre> <code class="plaintext hljs">[testenv:test_venv] skip_install = True ;         deps = ;   commands = pip install -i https://test.pypi.org/simple/ numeral-system-py</code> </pre> <br><p>  Sekarang Anda hanya perlu menjalankan: </p><br><pre> <code class="plaintext hljs">tox -e test_venv ... test_venv: commands_succeeded congratulations :)</code> </pre> <br><p>  Sepertinya berhasil :) </p><br><h3 id="vot-teper-tochno-zalivayu">  Sekarang pasti tuangkan! </h3><br><p>  Ya </p><br><p>  Saya membuat lingkungan untuk mengunggah ke repositori produksi. </p><br><pre> <code class="plaintext hljs">[testenv:pypi_upload] skip_install = True deps = twine commands = python -m twine upload dist/*</code> </pre> <br><p>  Dan lingkungan untuk verifikasi produksi. </p><br><pre> <code class="plaintext hljs">[testenv:pypi_venv] skip_install = True deps = ;    commands = pip install numeral-system-py</code> </pre> <br><h3 id="a-vse-tochno-rabotaet">  Apakah semuanya berfungsi? </h3><br><p>  Saya memeriksa dengan perintah sederhana: </p><br><pre> <code class="plaintext hljs">&gt; virtualenv venv &gt; source venv/bin/activate (venv) &gt; pip install numeral-system-py (venv) &gt; python &gt;&gt;&gt; import numeral_system &gt;&gt;&gt; numeral_system.roman.encode(7) 'VII'</code> </pre> <br><p>  Semuanya hebat! </p><br><p>  <a href="https://help.github.com/en/articles/creating-releases" rel="nofollow">Saya memotong rilis di github</a> , mengumpulkan paket dan mengisinya di propi pypi. </p><br><h2 id="zamechaniya">  Komentar </h2><br><h3 id="obnovleniya-zavisimostey">  Pembaruan Ketergantungan </h3><br><p>  Selama persiapan artikel ini, versi baru pytest dirilis, di mana, pada kenyataannya, dukungan untuk python 3.4 dijatuhkan ( <a href="https://github.com/tox-dev/tox/issues/1483" rel="nofollow">sebenarnya</a> dalam paket <a href="https://github.com/tartley/colorama" rel="nofollow">colorama</a> ).  Ada dua opsi: </p><br><ol><li>  Versi colorama komit kompatibel dengan 3.4; </li><li>  Jatuhkan dukungan 3.4 :) </li></ol><br><p>  Dalam mendukung opsi kedua, argumen terakhir adalah bahwa <code>pip</code> menjatuhkan dukungan 3.4 di versi 19.1. </p><br><p>  Ada juga dependensi tetap dalam bentuk penganalisa, pembuat format dan layanan lainnya.  Ketergantungan ini dapat diperbarui secara bersamaan.  Jika Anda beruntung, maka Anda hanya akan turun dengan versi upgrade, jika tidak, Anda harus memperbaiki kode atau bahkan menambahkan pengaturan. </p><br><h3 id="travisci">  TravisCI </h3><br><p>  Tidak mendukung python untuk MacOS dan Windows.  Ada kesulitan dengan menjalankan <code>tox</code> untuk semua versi python dalam pekerjaan yang sama. </p><br><h3 id="versiya-paketa">  Versi paket </h3><br><p>  Perlu mematuhi <a href="https://semver.org/" rel="nofollow">versi semantik</a> , yaitu format: </p><br><pre> <code class="plaintext hljs">MAJOR.MINOR.PATCH</code> </pre> <br><h3 id="dublirovanie-meta-informacii">  Duplikasi informasi meta </h3><br><p>  Versi paket dan beberapa parameter lain harus ditentukan untuk menginstal paket (dalam <code>setup.cfg</code> atau <code>setup.py</code> ) dan dalam dokumentasi.  Untuk menghindari duplikasi, ia membuat indikasi hanya di paket <code>numeral_system/__init__.py</code> : </p><br><pre> <code class="plaintext hljs">__version__ = '0.2.0'</code> </pre> <br><p>  Dan kemudian di <code>setup.py</code> secara eksplisit menggunakan variabel ini </p><br><pre> <code class="plaintext hljs">setup(version=numeral_system.__version__)</code> </pre> <br><p>  Hal yang sama berlaku untuk di <code>docs/source/conf.py</code> </p><br><pre> <code class="plaintext hljs">release = numeral_system.__version__</code> </pre> <br><p>  Hal di atas berlaku untuk setiap informasi meta - <code>REAMDE.rst</code> , deskripsi proyek, lisensi, nama penulis, dan banyak lagi. </p><br><p>  Benar, ini mengarah pada fakta bahwa paket sedang diimpor pada saat perakitan, yang mungkin tidak diinginkan. </p><br><h3 id="dublirovanie-zavisimostey">  Duplikasi Ketergantungan </h3><br><p>      ,         <code>requirements.txt</code>  <code>setup.cfg</code> . <br>   <a href="https://caremad.io/posts/2013/07/setup-vs-requirement/" rel="nofollow"> </a> ,   —     <code>setup.cfg</code> . <br>      . ,      <code>requirements-dev.txt</code>  . </p><br><h3 id="organizaciya-ishodnikov">   </h3><br><p>    ,       <code>src/</code> .     : </p><br><ul><li>       ; </li><li>    ,             ,   ; </li></ul><br><p>     : </p><br><ul><li>    <code>PyCharm</code> (    ?) —   <code>src</code> ,   . </li></ul><br><h3 id="kommity-i-istoriya-izmeneniy">     </h3><br><p>           —   . <br>  <a href="https://github.com/zifter/numeral-system-py/commits/master" rel="nofollow"> </a>  ,     : </p><br><pre> <code class="plaintext hljs">Add badge with supported version Support for py38</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">Try fix py38 env creating Try fix py38 env creating Try fix py38 env creating Fix check</code> </pre> <br><p> , 3       !        Travis CI. </p><br><p>  <a href="https://habr.com/ru/post/416887/"> </a>  ,    .     —     ,         . </p><br><p>         ,         .       <code>CHANGELOG</code> . </p><br><h3 id="dokumentaciya-1">  </h3><br><p>     ,   <code>Markdown</code> .     ,      <code>rst</code> . </p><br><h3 id="beydzhi">  Lencana </h3><br><p>      —  ,  ,   ,      .    ,     <a href="https://cmustrudel.github.io/papers/icse18badges.pdf" rel="nofollow"> </a> . <br>     <a href="https://pypi.org/project/coverage/" rel="nofollow">coverage</a> . </p><br><h3 id="ogranicheniya-iz-za-ispolzovaniya-raznyh-versiy">  -    </h3><br><p>   ,     ,  , .   <code>six</code>    ,       ,  <code>type hint</code> , <code>asyncio</code>    — . <br>      <code>python2.7</code> ,   <a href="https://pythonclock.org/" rel="nofollow"> </a> .   ,    python3.5+,     . ,         ,      CI   .          . </p><br><h2 id="mozhno-li-sdelat-luchshe">    ? </h2><br><p>       ,    : </p><br><ul><li>   MacOS; </li><li>   python x64  x86; </li><li>   ; </li><li> 100%      ,    <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity" rel="nofollow">  </a> .     <a href="https://pypi.org/project/mccabe/" rel="nofollow">mccabe</a> ,      2017 .    ? </li><li>        <a href="https://pyup.io/" rel="nofollow">PyUp</a>  <a href="https://requires.io/" rel="nofollow">requires.io</a> .  ? </li><li>    .     <a href="https://github.com/PyCQA0" rel="nofollow">Python Code Quality Authority</a> , - ? <br><ul><li> <a href="http://mypy-lang.org/" rel="nofollow">mypy</a> —  ; </li><li> <a href="https://github.com/PyCQA/bandit" rel="nofollow">bandit</a> —       ; </li><li> <a href="https://github.com/PyCQA/pyflakes" rel="nofollow">Pyflakes</a> —      ; </li><li> <a href="https://github.com/PyCQA/prospector" rel="nofollow">prospector</a> — ,  <code>pylint</code> , <code>pep8</code> , <code>mccabe</code> . ,    ; </li></ul></li><li>   \   ? </li></ul><br><h2 id="zaklyuchenie">  Kesimpulan </h2><br><p>           open source ,     . <br>           ,    python   <code>github</code> ,       . <br>        <code>stackoverflow.com</code>  issues    <code>github</code>            . <br>           .      .      ?.. </p><br><p> ,  ,     <a href="https://habr.com/ru/company/ruvds/blog/444344/">   </a> . <br>       ,    <a href="https://sourcery.ai/blog/python-best-practices/" rel="nofollow"> </a> . </p><br><p> <a href="https://github.com/zifter/numeral-system-py" rel="nofollow">    github</a> . </p><br><p>  Terima kasih </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id483512/">https://habr.com/ru/post/id483512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id483502/index.html">Matahari, angin, dan air ver 0.2</a></li>
<li><a href="../id483504/index.html">How is Sporth - YaP untuk sesi musik live</a></li>
<li><a href="../id483506/index.html">Mimpi kekosongan yang dalam (bagian 1). Pompa steam-oil difusi: resusitasi dan sedikit teori</a></li>
<li><a href="../id483508/index.html">Top 10 C ++ CoreHard Autumn 2019 Conference Papers</a></li>
<li><a href="../id483510/index.html">Penguji untuk perusahaan kecil seperti ini</a></li>
<li><a href="../id483516/index.html">Berhenti meletakkan dioda 2</a></li>
<li><a href="../id483518/index.html">Pengembang game VVVVVV untuk menghormati dekade-nya membuat kode sumber terbuka</a></li>
<li><a href="../id483520/index.html">Menggunakan pengamat pola kesamaan dalam C</a></li>
<li><a href="../id483524/index.html">Analisis Habra: kapan sebaiknya mempublikasikan posting Anda?</a></li>
<li><a href="../id483526/index.html">Mengelola status aplikasi dengan RxJS / Immer sebagai alternatif sederhana untuk Redux / MobX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>