<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>„äóÔ∏è ü§ôüèº üë®üèæ‚Äçüé® Erfahrung im Aufbau einer Infrastruktur auf Microservice-Architektur üèª üëß üï§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im vergangenen Jahr gab es so viele Ver√∂ffentlichungen √ºber Microservices, dass es Zeitverschwendung w√§re, zu sagen, was es ist und warum. Der Rest de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erfahrung im Aufbau einer Infrastruktur auf Microservice-Architektur</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441310/"><p><img src="https://habrastorage.org/webt/vn/kb/qn/vnkbqnbwlqbmim3tn1ipiy_rhri.jpeg"></p><br><p>  Im vergangenen Jahr gab es so viele Ver√∂ffentlichungen √ºber Microservices, dass es Zeitverschwendung w√§re, zu sagen, was es ist und warum. Der Rest der Diskussion wird sich daher auf die Frage konzentrieren, wie diese Architektur implementiert werden kann und warum sie genau konfrontiert wurde und auf welche Probleme sie stie√ü. </p><br><p>  Wir hatten gro√üe Probleme in einer kleinen Bank: 3 Python-Monolithen, die durch eine ungeheure Menge synchroner RPC-Interaktionen mit einem gro√üen Volumen an Legacy verbunden waren.  Um alle gleichzeitig auftretenden Probleme zumindest teilweise zu l√∂sen, wurde beschlossen, auf eine Microservice-Architektur umzusteigen.  Bevor Sie sich jedoch f√ºr einen solchen Schritt entscheiden, m√ºssen Sie drei Hauptfragen beantworten: </p><br><ul><li>  Wie man einen Monolithen in Mikrodienste zerlegt und welche Kriterien befolgt werden sollten. </li><li>  Wie werden Microservices interagieren? </li><li>  Wie zu √ºberwachen? </li></ul><br><p>  Tats√§chlich werden diesem Artikel kurze Antworten auf diese Fragen gewidmet. </p><a name="habracut"></a><br><h2 id="kak-razbit-monolit-na-mikroservisy-i-kakimi-kriteriyami-sleduet-pri-etom-rukovodstvovatsya">  Wie man einen Monolithen in Mikrodienste zerlegt und welche Kriterien befolgt werden sollten. </h2><br><p>  Diese scheinbar einfache Frage bestimmte letztendlich die gesamte zuk√ºnftige Architektur. </p><br><p>  Wir sind eine Bank, daher dreht sich das gesamte System um Operationen mit Finanzen und verschiedenen Hilfsmitteln.  Es ist sicherlich m√∂glich, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">finanzielle ACID-Transaktionen mit Sagen auf ein verteiltes System zu √ºbertragen</a> , aber im Allgemeinen ist dies √§u√üerst schwierig.  Daher haben wir die folgenden Regeln entwickelt: </p><br><ul><li>  Beachten Sie f√ºr Microservices S von SOLID </li><li>  Die Transaktion sollte vollst√§ndig im Microservice ausgef√ºhrt werden - keine verteilten Transaktionen √ºber den Schaden der Datenbank </li><li>  Um zu funktionieren, ben√∂tigt der Microservice Informationen aus seiner eigenen Datenbank oder aus einer Anfrage </li><li>  Versuchen Sie, die Sauberkeit (im Sinne funktionaler Sprachen) von Microservices sicherzustellen </li></ul><br><p>  Gleichzeitig war es nat√ºrlich unm√∂glich, sie vollst√§ndig zu befriedigen, aber selbst eine teilweise Implementierung vereinfacht die Entwicklung erheblich. </p><br><h2 id="kakim-obrazom-mikroservisy-budut-vzaimodeystvovat">  Wie werden Microservices interagieren? </h2><br><p>  Es gibt viele Optionen, aber am Ende k√∂nnen sie alle mit einfachen ‚ÄûMicroservices Exchange Messages‚Äú abstrahiert werden. Wenn Sie jedoch ein synchrones Protokoll implementieren (z. B. RPC √ºber REST), bleiben die meisten Nachteile des Monolithen bestehen, aber die Vorteile von Microservices werden kaum sichtbar.  Die naheliegende L√∂sung bestand also darin, einen beliebigen Nachrichtenbroker zu nehmen und loszulegen.  Die Wahl zwischen RabbitMQ und Kafka entschied sich f√ºr Letzteres, und hier ist der Grund: </p><br><ul><li>  Kafka ist einfacher und bietet ein einziges Messaging-Modell - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ver√∂ffentlichen - Abonnieren</a> </li><li>  Es ist relativ einfach, ein zweites Mal Daten von Kafka zu erhalten.  Dies ist √§u√üerst praktisch zum Debuggen oder Beheben von Fehlern w√§hrend einer fehlerhaften Verarbeitung sowie zum √úberwachen und Protokollieren. </li><li>  Eine klare und einfache M√∂glichkeit, den Dienst zu skalieren: Partitionen zum Thema hinzugef√ºgt, mehr Abonnenten gestartet - der Rest wird von kafka erledigt. </li></ul><br><p>  Zus√§tzlich m√∂chte ich auf einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sehr hochwertigen und detaillierten Vergleich aufmerksam machen</a> . </p><br><p>  Warteschlangen bei kafka + asynchrony erm√∂glichen es uns: </p><br><ul><li>  Schalten Sie einen Microservice f√ºr Updates kurz aus, ohne dass sich daraus Konsequenzen ergeben </li><li>  Schalten Sie einen Dienst f√ºr l√§ngere Zeit aus und k√ºmmern Sie sich nicht um die Datenwiederherstellung.  Beispielsweise ist der Fiskalisierungs-Microservice k√ºrzlich gesunken.  Es wurde nach 2 Stunden repariert, er nahm die Rohkonten von Kafka und verarbeitete alles.  Nach wie vor war es nicht erforderlich, das, was dort geschehen sollte, wiederherzustellen und HTTP-Protokolle und eine separate Tabelle in der Datenbank manuell auszuf√ºhren. </li><li>  F√ºhren Sie Testversionen von Diensten f√ºr aktuelle Daten aus dem Verkauf aus und vergleichen Sie die Ergebnisse ihrer Verarbeitung mit der Version des Dienstes beim Verkauf. </li></ul><br><p>  Als Datenserialisierungssystem haben wir uns f√ºr AVRO entschieden, warum - beschrieben in einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">separaten Artikel</a> . </p><br><p>  Unabh√§ngig von der gew√§hlten Serialisierungsmethode ist es jedoch wichtig zu verstehen, wie das Protokoll aktualisiert wird.  Obwohl AVRO die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Schemaaufl√∂sung</a> unterst√ºtzt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">, verwenden</a> wir diese nicht und entscheiden rein administrativ: </p><br><ul><li>  Daten in Themen werden nur √ºber AVRO geschrieben und gelesen. Der Name des Themas entspricht dem Namen des Schemas (und Confluent verfolgt einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">anderen Ansatz</a> : Sie schreiben ID-AVRO-Schemata aus der Registrierung in die hohen Bytes der Nachricht, sodass sie unterschiedliche Nachrichtentypen in einem Thema haben k√∂nnen </li><li>  Wenn Sie Daten hinzuf√ºgen oder √§ndern m√ºssen, wird in kafka ein neues Schema mit einem neuen Thema erstellt. Anschlie√üend wechseln alle Hersteller zu einem neuen Thema, gefolgt von Abonnenten </li></ul><br><p>  Wir speichern die AVRO-Schaltungen selbst in Git-Submodulen und verbinden uns mit allen Kafka-Projekten.  Sie beschlossen, noch kein zentrales Systemregister einzuf√ºhren. </p><br><p>  PS: Kollegen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">haben die OpenSource-Option gew√§hlt, jedoch nur mit JSON-Schema anstelle von AVRO</a> . </p><br><h3 id="nekotorye-tonkosti">  Einige Feinheiten </h3><br><h4 id="kazhdyy-podpischik-poluchaet-vse-soobscheniya-iz-topika">  Jeder Teilnehmer erh√§lt alle Nachrichten vom Thema </h4><br><p>  Dies ist die Besonderheit des Publish - Subscribe-Interaktionsmodells. Wenn ein Abonnent ein Thema abonniert hat, erh√§lt der Abonnent alle.  Wenn der Dienst nur einige der Nachrichten ben√∂tigt, muss er diese herausfiltern.  Wenn dies zu einem Problem wird, kann ein separater Service-Router erstellt werden, der Nachrichten zu verschiedenen Themen auslegt, wodurch ein Teil der RabbitMQ-Funktionalit√§t implementiert wird, der nicht in der Kafka enthalten ist.  Jetzt haben wir einen Python-Abonnenten in einem Thread, der ungef√§hr 7-5.000 Nachrichten pro Sekunde verarbeitet. Wenn Sie jedoch √ºber PyPy laufen, steigt die Geschwindigkeit auf 11-15.000 / Sek. </p><br><h4 id="ogranichenie-vremeni-zhizni-ukazatelya-v-topike">  Begrenzen Sie die Lebensdauer eines Zeigers in einem Thema </h4><br><p>  In den Einstellungen der Kafka gibt es einen Parameter, der die Zeit begrenzt, in der sich die Kafka "erinnert", wo der Leser angehalten hat - die Standardeinstellung ist 2 Tage.  Es w√§re sch√∂n, es auf eine Woche anzuheben, damit, wenn das Problem in den Ferien auftritt und 2 Tage nicht gel√∂st werden, dies nicht zu einem Positionsverlust im Thema f√ºhren w√ºrde. </p><br><h4 id="ogranichenie-vremeni-na-podtverzhdenie-chteniya">  Best√§tigungszeitlimit lesen </h4><br><p>  Wenn der Kafka-Leser den Messwert nicht innerhalb von 30 Sekunden best√§tigt (ein konfigurierbarer Parameter), glaubt der Broker, dass ein Fehler aufgetreten ist und beim Versuch, den Messwert zu best√§tigen, ein Fehler auftritt.  Um dies zu vermeiden, senden wir bei der Verarbeitung einer Nachricht √ºber einen l√§ngeren Zeitraum Lesebest√§tigungen, ohne den Zeiger zu bewegen. </p><br><h4 id="graf-svyazey-poluchaetsya-trudnym-dlya-vospriyatiya">  Das Diagramm der Verbindungen ist schwer zu verstehen. </h4><br><p>  Wenn Sie ehrlich alle Beziehungen in graphviz zeichnen, dann gibt es einen Igel der Apokalypse, der f√ºr Mikrodienste mit Dutzenden von Verbindungen in einem Knoten traditionell ist.  Um es zumindest irgendwie lesbar zu machen (das Diagramm der Verbindungen), haben wir uns auf die folgende Notation geeinigt: Microservices - Ovale, Themen von Kafka - Rechtecken.  Somit ist es in einem Diagramm m√∂glich, sowohl die Tatsache der Interaktion als auch deren Typ anzuzeigen.  Aber leider wird es nicht viel besser.  Diese Frage ist also noch offen. </p><br><p><img src="https://habrastorage.org/webt/fy/lw/qf/fylwqfrc5nspiw_ci170mvntzku.png"></p><br><h2 id="kak-osuschestvlyat-monitoring">  Wie zu √ºberwachen? </h2><br><p>  Selbst als Teil des Monolithen hatten wir Protokolle in Dateien und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sentry.</a> Als wir jedoch √ºber Kafka auf Interaktion umstellten und auf k8s bereitstellten, wurden die Protokolle auf ElasticSearch verschoben und dementsprechend haben wir zuerst das Lesen der Protokolle des Abonnenten in Elastic √ºberwacht.  Keine Protokolle - keine Arbeit. <br>  Danach nutzten sie Prometheus und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">kafka-exporter</a> modifizierte sein Dashboard leicht: <a href="">https://github.com/kkirsanov/articles/blob/master/2019-habr-kafka/dashboard.json</a> </p><br><p>  Als Ergebnis erhalten wir diese Bilder: <br><img src="https://habrastorage.org/webt/lg/bg/k5/lgbgk5zs7fzl_3hrhork-ybejjw.png"><br>  Sie k√∂nnen sehen, welcher Dienst die Verarbeitung welcher Nachrichten beendet hat. </p><br><p>  Dar√ºber hinaus werden alle Nachrichten aus Schl√ºsselthemen (Zahlungstransaktionen, Benachrichtigungen von Partnern usw.) in InfluxDB kopiert, das in derselben Grafik eingerichtet ist.  So k√∂nnen wir nicht nur die Tatsache der Nachrichten√ºbermittlung aufzeichnen, sondern auch verschiedene Beispiele entsprechend dem Inhalt erstellen.  Antworten auf Fragen wie ‚ÄûWas ist die durchschnittliche Verz√∂gerungszeit f√ºr eine Antwort von einem Service?‚Äú Oder ‚ÄûUnterscheidet sich der Transaktionsfluss heute in diesem Gesch√§ft stark von gestern?‚Äú Sind immer verf√ºgbar. </p><br><p>  Um die Analyse von Vorf√§llen zu vereinfachen, verwenden wir den folgenden Ansatz: Jeder Dienst erg√§nzt eine Nachricht bei der Verarbeitung mit Metainformationen, die die UUID enthalten, die ausgegeben wird, wenn das System ein Array von Datens√§tzen des Typs anzeigt: </p><br><ul><li>  Servicename </li><li>  UUID des Verarbeitungsprozesses in diesem Microservice </li><li>  Prozessstart-Zeitstempel </li><li>  Prozesszeit </li><li>  Tag-Set </li></ul><br><p>  Infolgedessen wird die Nachricht beim Durchlaufen des Rechengraphen mit Informationen √ºber den im Graphen zur√ºckgelegten Pfad angereichert.  Es stellt sich ein Analogon von Zipkin / Opentracing f√ºr MQ heraus, das es erm√∂glicht, eine Nachricht zu empfangen, um ihren Pfad in der Grafik einfach wiederherzustellen.  Dies erh√§lt einen besonderen Wert in den F√§llen, in denen Zyklen in der Grafik erscheinen.  Denken Sie an das Beispiel eines kleinen Dienstes, dessen Anteil an Zahlungen nur 0,0001% betr√§gt. Durch die Analyse der Metainformationen in der Nachricht kann er feststellen, ob sie der Initiator der Zahlung waren, ohne die Datenbank zur √úberpr√ºfung zu kontaktieren. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de441310/">https://habr.com/ru/post/de441310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de441296/index.html">OpenStreetMap Part Medium: Versteckte Datenvisualisierung</a></li>
<li><a href="../de441298/index.html">Cisco Live EMEA 2019: Wechsel eines alten IT-Fahrrads zu BMW in den Wolken</a></li>
<li><a href="../de441300/index.html">Anachronismen, Crunches, schlechte Organisationsstruktur: Drei Schmerzen der Teamf√ºhrung in einem Unternehmen</a></li>
<li><a href="../de441302/index.html">AMA mit Habr (Direktverbindung mit TM, Version 6.0)</a></li>
<li><a href="../de441306/index.html">Wie man in einem Tag ein Angebot f√ºr einen QS-Ingenieur in Moskau bekommt (und es ist teuer, hier zu leben)</a></li>
<li><a href="../de441312/index.html">Perlins verschwommene L√§rmwelt</a></li>
<li><a href="../de441314/index.html">PyCon Russia 2019: Antworten auf wichtige Fragen</a></li>
<li><a href="../de441316/index.html">Auswahl echter drahtloser Ohrh√∂rer: 6 Monate sp√§ter ...</a></li>
<li><a href="../de441318/index.html">Beliebte Visual Studio-Codeerweiterungen</a></li>
<li><a href="../de441320/index.html">Z√§hme deinen technischen Support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>