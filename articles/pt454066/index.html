<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÄüèΩ üë®üèø‚Äçü§ù‚Äçüë®üèΩ üì§ Como parar de esquecer os √≠ndices e come√ßar a verificar o plano de execu√ß√£o nos testes üë®üèø‚Äçüè´ üïé ‚òÉÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Algum tempo atr√°s, uma hist√≥ria desagrad√°vel aconteceu comigo, que serviu de gatilho para um pequeno projeto no github e resultou neste artigo. 

 Um ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como parar de esquecer os √≠ndices e come√ßar a verificar o plano de execu√ß√£o nos testes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/454066/"><img src="https://habrastorage.org/webt/cb/kk/ps/cbkkpswi947gczpzqmwkyh2pwmm.jpeg" alt="cdpv"><br><br>  Algum tempo atr√°s, uma hist√≥ria desagrad√°vel aconteceu comigo, que serviu de gatilho para um pequeno projeto no github e resultou neste artigo. <br><br>  Um dia t√≠pico, uma libera√ß√£o normal: todas as tarefas s√£o verificadas para cima e para baixo pelo nosso engenheiro de controle de qualidade, portanto, com a calma da vaca sagrada, ‚Äúrolamos‚Äù para o palco.  O aplicativo se comporta bem, nos logs - sil√™ncio.  Decidimos fazer a troca (est√°gio &lt;-&gt; prod).  Mudamos, olhamos para os dispositivos ... <br><br>  Demora alguns minutos, o voo √© est√°vel.  O engenheiro de controle de qualidade faz um teste de fuma√ßa, percebe que o aplicativo est√° desacelerando de alguma forma n√£o natural.  Escrevemos para aquecer os caches. <br><br>  Alguns minutos se passam, a primeira reclama√ß√£o √© da primeira linha: os dados s√£o baixados dos clientes por muito tempo, o aplicativo fica mais lento, leva muito tempo para responder, etc.  Come√ßamos a nos preocupar ... olhamos para os logs, procuramos por poss√≠veis raz√µes. <br><a name="habracut"></a><br>  Alguns minutos depois, chega uma carta dos administradores do banco de dados.  Eles escrevem que o tempo de execu√ß√£o das consultas no banco de dados (doravante denominado banco de dados) quebrou todos os limites poss√≠veis e tende ao infinito. <br><br>  Abro o monitoramento (uso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JavaMelody</a> ), encontro esses pedidos.  Inicio o PGAdmin, reproduzo.  Muito longo.  Acrescento "explique", olho para o plano de execu√ß√£o ... √©, esquecemos os √≠ndices. <br><br><h2>  Por que a revis√£o de c√≥digo n√£o √© suficiente? </h2><br>  Esse incidente me ensinou muito.  Sim, eu "extinguiu o fogo" por uma hora, criando o √≠ndice certo diretamente no produto de alguma forma (n√£o se esque√ßa da op√ß√£o CONCURRENTLY): <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> CONCURRENTLY <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ix_pets_name <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pets_table (name_column);</code> </pre> <br>  Concordo que isso equivale a uma implanta√ß√£o com tempo de inatividade.  Para o aplicativo em que estou trabalhando, isso √© inaceit√°vel. <br><br>  Eu tirei conclus√µes e adicionei um ponto em negrito especial √† lista de verifica√ß√£o para revis√£o de c√≥digo: se eu constatar que durante o processo de desenvolvimento uma das classes Repository foi adicionada / alterada - eu verifico as migra√ß√µes sql para a presen√ßa de um script que cria e altera o √≠ndice l√°.  Se ele n√£o estiver l√°, estou escrevendo uma pergunta ao autor: ele tem certeza de que o √≠ndice n√£o √© necess√°rio aqui? <br><br>  √â prov√°vel que um √≠ndice n√£o seja necess√°rio se houver poucos dados, mas se trabalharmos com uma tabela na qual o n√∫mero de linhas √© contado em milh√µes, um erro de √≠ndice pode se tornar fatal e levar √† hist√≥ria descrita no in√≠cio do artigo. <br><br>  Nesse caso, pe√ßo ao autor da solicita√ß√£o pull (a seguir PR) que tenha 100% de certeza de que a consulta que ele escreveu no HQL √© pelo menos parcialmente coberta pelo √≠ndice (a Verifica√ß√£o de √çndice √© usada).  Para isso, o desenvolvedor: <br><br><ol><li>  lan√ßa o aplicativo </li><li>  procurando consulta convertida (HQL -&gt; SQL) nos logs </li><li>  abre o PGAdmin ou outra ferramenta de administra√ß√£o de banco de dados </li><li>  gera no banco de dados local, para n√£o incomodar ningu√©m com seus experimentos, uma quantidade de dados aceit√°vel para testes (registros m√≠nimos de 10K a 20K) </li><li>  atende √† solicita√ß√£o </li><li>  solicita plano de execu√ß√£o </li><li>  estuda cuidadosamente e tira conclus√µes apropriadas </li><li>  adiciona / modifica o √≠ndice, garantindo que o plano de execu√ß√£o seja adequado </li><li>  cancela a inscri√ß√£o no PR que a cobertura da solicita√ß√£o verificou </li><li>  Ao avaliar habilmente os riscos e a gravidade da solicita√ß√£o, posso verificar novamente suas a√ß√µes </li></ol><br>  Muitas a√ß√µes rotineiras e o fator humano, mas por algum tempo fiquei satisfeito e vivi com isso. <br><br><h2>  A caminho de casa </h2><br>  Eles dizem que √© muito √∫til, pelo menos √†s vezes, sair do trabalho sem ouvir m√∫sica / podcasts ao longo do caminho.  Neste momento, apenas pensando na vida, voc√™ pode chegar a conclus√µes e id√©ias interessantes. <br><br>  Um dia, voltei para casa e pensei no que aconteceu naquele dia.  Houve algumas an√°lises, verifiquei cada uma delas com uma lista de verifica√ß√£o e realizei uma s√©rie de a√ß√µes descritas acima.  Fiquei t√£o cansado dessa vez, pensei, que diabos?  √â imposs√≠vel fazer isso automaticamente? Dei um passo r√°pido, querendo rapidamente "cortar" essa id√©ia. <br><br><h2>  Declara√ß√£o do problema </h2><br>  O que √© mais importante para o desenvolvedor no plano de execu√ß√£o? <br>  Obviamente, a verifica√ß√£o seq em grandes quantidades de dados √© causada pela falta de um √≠ndice. <br><br>  Assim, foi necess√°rio fazer um teste que: <br><br><ol><li>  Executado em um banco de dados com uma configura√ß√£o semelhante ao prod </li><li>  Intercepta uma consulta ao banco de dados feita por um reposit√≥rio JPA (Hibernate) </li><li>  Obt√©m o plano de execu√ß√£o </li><li>  Analisar o Plano de Execu√ß√£o, colocando-o em uma estrutura de dados conveniente para verifica√ß√µes </li><li>  Usando um conjunto conveniente de m√©todos Assert, verifica as expectativas.  Por exemplo, essa verifica√ß√£o seq n√£o √© usada. </li></ol><br><br>  Foi necess√°rio testar rapidamente essa hip√≥tese criando um prot√≥tipo. <br><br><h2>  Arquitetura da solu√ß√£o </h2><br><img src="https://habrastorage.org/webt/6e/2i/bz/6e2ibz7cl8roycahqee4yb1lqqq.png" alt="arquitetura checkinx"><br><br>  O primeiro problema a ser resolvido foi o lan√ßamento do teste em um banco de dados real que corresponda √† vers√£o e √†s configura√ß√µes usadas no produto. <br><br>  Gra√ßas ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Docker &amp; TestContainers</a> , eles resolvem esse problema. <br><br>  SqlInterceptor, ExecutionPlanQuery, ExecutionPlanParse e AssertService s√£o as interfaces que eu implementei atualmente para o Postgres.  Os planos s√£o implementados para outros bancos de dados.  Se voc√™ quiser participar - seja bem-vindo.  O c√≥digo est√° escrito em Kotlin. <br><br>  Tudo isso juntos, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">publiquei</a> no GitHub e chamei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">checkinx-utils</a> .  Voc√™ n√£o precisa repetir isso, basta conectar a depend√™ncia ao checkinx no maven / gradle e usar declara√ß√µes convenientes.  Como fazer isso, descreverei mais detalhadamente abaixo. <br><br><h3>  Descri√ß√£o da intera√ß√£o dos componentes CheckInx </h3><br><h4>  ProxyDataSource </h4><br>  O primeiro problema a ser resolvido foi a intercepta√ß√£o de consultas ao banco de dados prontas para execu√ß√£o.  J√° com os par√¢metros estabelecidos, sem perguntas, etc. <br><br>  Para fazer isso, voc√™ precisa agrupar o dataSource real em um determinado Proxy, o que permitiria integrar o pipeline de execu√ß√£o da consulta e, consequentemente, intercept√°-los. <br><br>  Esse ProxyDataSource j√° foi implementado por muitos.  Usei a solu√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ttddyy</a> pronta, que permite instalar meu ouvinte interceptando a solicita√ß√£o de que preciso. <br><br>  Substituo o DataSource de origem usando a classe DataSourceWrapper (BeanPostProcessor). <br><br><h4>  SqlInterceptor </h4><br>  De fato, seu m√©todo start () define seu Listener em proxyDataSource e come√ßa a interceptar solicita√ß√µes, armazenando-as na lista de instru√ß√µes internas.  O m√©todo stop (), respectivamente, remove o Ouvinte instalado. <br><br><h4>  ExecutionPlanQuery </h4><br>  Aqui, a solicita√ß√£o original √© transformada em uma solicita√ß√£o de um plano de execu√ß√£o.  No caso do Postgres, isso √© uma adi√ß√£o √† palavra-chave de consulta "EXPLAIN". <br><br>  Al√©m disso, essa consulta √© executada no mesmo banco de dados a partir de testcontainders e um plano de execu√ß√£o "bruto" (lista de linhas) √© retornado. <br><br><h4>  ExecutionPlanParser </h4><br>  √â inconveniente trabalhar com um plano de execu√ß√£o bruto.  Portanto, analiso-o em uma √°rvore composta por n√≥s (PlanNode). <br><br>  Vamos analisar os campos do PlanNode usando um exemplo de um ExecutionPlan real: <br><br><pre> <code class="sql hljs">Index Scan using ix_pets_age on pets  (cost=0.29..8.77 rows=1 width=36) Index Cond: (age &lt; 10) Filter: ((name)::text = 'Jack'::text)</code> </pre> <br><div class="scrollable-table"><table><tbody><tr><th>  Propriedade </th><th>  Exemplo </th><th>  Descri√ß√£o do produto </th></tr><tr><td>  Raw: String </td><td>  Varredura de √≠ndice usando ix_pets_age em animais de estima√ß√£o (custo = 0,29 a 8,77 linhas = 1 largura = 36) </td><td>  cadeia de origem </td></tr><tr><td>  tabela: String? </td><td>  animais de estima√ß√£o <br></td><td>  nome da tabela </td></tr><tr><td>  alvo: String? </td><td>  ix_pets_age </td><td>  nome do √≠ndice </td></tr><tr><td>  cobertura: String? </td><td>  Varredura de √≠ndice </td><td>  cobertura </td></tr><tr><td>  cobertura </td><td>  Metade </td><td>  abstra√ß√£o de revestimento (ZERO, MEIO, CHEIO) </td></tr><tr><td>  filhos: MutableList &lt;PlanNode&gt; </td><td>  - </td><td>  n√≥s filhos </td></tr><tr><td>  propriedades: MutableList &lt;Pair &lt;String, String &gt;&gt; </td><td>  <i>chave</i> : √çndice Cond, <i>valor</i> : (idade &lt;10); <br>  <i>chave</i> : Filtro, <i>valor</i> : ((nome) :: text = 'Jack' :: texto) <br></td><td>  propriedades </td></tr><tr><td>  outros: MutableList &lt;&gt; </td><td>  - </td><td>  Tudo o que n√£o p√¥de ser reconhecido na vers√£o atual do checkinx </td></tr></tbody></table></div><br><h4>  AssertService </h4><br>  J√° √© poss√≠vel trabalhar normalmente com a estrutura de dados retornada pelo analisador.  CheckInxAssertService √© um conjunto de verifica√ß√µes da √°rvore PlanNode descrita acima.  Ele permite que voc√™ defina suas pr√≥prias lambdas de cheques ou use as predefinidas, na minha opini√£o, as mais populares.  Por exemplo, para que sua consulta n√£o tenha o Seq Scan, ou voc√™ deseja garantir que um √≠ndice espec√≠fico seja usado / n√£o usado. <br><br><h4>  Coveragelevel </h4><br>  Muito importante Enum, vou descrev√™-lo separadamente: <br><div class="scrollable-table"><table><tbody><tr><th>  Valor </th><th>  Descri√ß√£o do produto </th></tr><tr><td>  NOT_USING <br></td><td>  verifica se um destino espec√≠fico (√≠ndice) n√£o √© usado <br></td></tr><tr><td>  ZERO <br></td><td>  √≠ndice n√£o usado (Seq Scan) <br></td></tr><tr><td>  Metade <br></td><td>  cobertura parcial da consulta por √≠ndice (Index Scan).  Por exemplo, uma pesquisa √© realizada por √≠ndice, mas para os dados resultantes, refere-se a uma tabela <br></td></tr><tr><td>  COMPLETO <br></td><td>  cobertura total da consulta por √≠ndice (Index Only Scan) <br></td></tr><tr><td>  DESCONHECIDO <br></td><td>  cobertura desconhecida.  Por alguma raz√£o, n√£o foi poss√≠vel instal√°-lo. <br></td></tr></tbody></table></div><br>  A seguir, veremos alguns exemplos de uso. <br><br><h2>  Exemplos de teste usando o CheckInx </h2><br>  Eu fiz um projeto separado no GitHub <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">checkinx-demo</a> , onde implementei um reposit√≥rio JPA para a tabela pets e testes para esse reposit√≥rio, verificando a cobertura, √≠ndices, etc.  Ser√° √∫til olhar l√° como ponto de partida. <br><br>  Voc√™ pode ter um teste como este: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFindByLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {  <span class="hljs-comment"><span class="hljs-comment">// ARRANGE  val location = "Moscow"  //   ,      10-20.  //   TestNG      @BeforeClass  IntRange(1, 10000).forEach {      val pet = Pet()      pet.id = UUID.randomUUID()      pet.age = it      pet.location = "Saint Petersburg"      pet.name = "Jack-$it"      repository.save(pet)  }  // ACT  //     sqlInterceptor.startInterception()  //    val pets = repository.findByLocation(location)  //    sqlInterceptor.stopInterception()  // ASSERT  //         assertEquals(1, sqlInterceptor.statements.size.toLong())  // ,    ix_pets_location    (Index Scan)  checkInxAssertService.assertCoverage(CoverageLevel.HALF, "ix_pets_location", sqlInterceptor.statements[0])  //        ,      Seq Scan,        checkInxAssertService.assertCoverage(CoverageLevel.HALF, sqlInterceptor.statements[0])  // ...  ,      checkInxAssertService.assertPlan(plan) {          it.coverageLevel.level &lt; CoverageLevel.FULL.level      } }</span></span></code> </pre> <br>  O plano de implementa√ß√£o pode ser o seguinte: <br><br><pre> <code class="sql hljs">Index Scan using ix_pets_location on pets pet0_  (cost=0.29..4.30 rows=1 width=46) Index Cond: ((location)::text = 'Moscow'::text)</code> </pre> <br>  ... ou assim, se nos esquecemos do √≠ndice (os testes ficam vermelhos): <br><br><pre> <code class="sql hljs">Seq Scan on pets pet0_  (cost=0.00..19.00 rows=4 width=84) Filter: ((location)::text = 'Moscow'::text)</code> </pre> <br>  No meu projeto, uso principalmente a declara√ß√£o mais simples, que diz que n√£o h√° verifica√ß√£o de Seq no plano de execu√ß√£o: <br><br><pre> <code class="kotlin hljs">checkInxAssertService.assertCoverage(CoverageLevel.HALF, sqlInterceptor.statements[<span class="hljs-number"><span class="hljs-number">0</span></span>])</code> </pre> <br>  A presen√ßa desse teste sugere que eu, pelo menos, estudei o plano de implementa√ß√£o. <br>  Tamb√©m torna o gerenciamento de projetos mais expl√≠cito, e a documentabilidade e previsibilidade do c√≥digo aumentam. <br><br><div class="spoiler">  <b class="spoiler_title">Modo experiente</b> <div class="spoiler_text">  Eu recomendo usar o CheckInxAssertService, mas se necess√°rio, voc√™ pode ignorar a √°rvore analisada (ExecutionPlanParser) ou, em geral, analisar o plano de execu√ß√£o bruto (o resultado da execu√ß√£o de ExecutionPlanQuery). <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFindByLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {  <span class="hljs-comment"><span class="hljs-comment">// ARRANGE  val location = "Moscow"  // ACT  //     sqlInterceptor.startInterception()  //    val pets = repository.findByLocation(location)  //    sqlInterceptor.stopInterception()  // ASSERT  //  ""    val executionPlan = executionPlanQuery.execute(sqlInterceptor.statements[0])  //    -   val plan = executionPlanParser.parse(executionPlan)  assertNotNull(plan)  // ...     val rootNode = plan.rootPlanNode  assertEquals("Index Scan", rootNode.coverage)  assertEquals("ix_pets_location", rootNode.target)  assertEquals("pets pet0_", rootNode.table) }</span></span></code> </pre> </div></div><br><br><h2>  Conex√£o ao projeto </h2><br>  No meu projeto, aloquei esses testes para um grupo separado, chamando-o de Testes Intensivos de Integra√ß√£o. <br><br>  Conectar e come√ßar a usar o checkinx-utils √© f√°cil.  Vamos come√ßar com o script de constru√ß√£o. <br><br>  Conecte o reposit√≥rio primeiro.  Algum dia eu enviarei o checkinx para o maven, mas agora voc√™ pode fazer o download do artefato apenas no GitHub via jitpack. <br><br><pre> <code class="plaintext hljs">repositories { // ...  maven { url 'https://jitpack.io' } }</code> </pre> <br>  Em seguida, adicione a depend√™ncia: <br><br><pre> <code class="plaintext hljs">dependencies { // ...  implementation 'com.github.tinkoffcreditsystems:checkinx-utils:0.2.0' }</code> </pre> <br>  Conclu√≠mos a conex√£o adicionando a configura√ß√£o.  Atualmente, o Postgres √© suportado atualmente. <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Profile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"test"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@ImportAutoConfiguration(classes = [PostgresConfig::class])</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckInxConfig</span></span></span></span></code> </pre> <br>  Preste aten√ß√£o ao perfil do teste.  Caso contr√°rio, voc√™ encontrar√° o ProxyDataSource no seu produto. <br><br>  O PostgresConfig conecta v√°rios beans: <br><br><ol><li>  DataSourceWrapper </li><li>  PostgresInterceptor </li><li>  PostgresExecutionPlanParser </li><li>  PostgresExecutionPlanQuery </li><li>  CheckInxAssertServiceImpl </li></ol><br>  Se voc√™ precisar de algum tipo de personaliza√ß√£o que a API atual n√£o fornece, sempre poder√° substituir um dos beans por sua implementa√ß√£o. <br><br><h2>  Problemas conhecidos </h2><br>  √Äs vezes, um DataSourceWrapper falha ao substituir o dataSource original devido ao proxy Spring CGLIB.  Nesse caso, n√£o um DataSource trata do BeanPostProcessor, mas ScopedProxyFactoryBean e h√° problemas com a verifica√ß√£o de tipo. <br><br>  A solu√ß√£o mais f√°cil seria criar manualmente o HikariDataSource para testes.  Ent√£o sua configura√ß√£o ser√° a seguinte: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Profile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"test"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@ImportAutoConfiguration(classes = [PostgresConfig::class])</span></span> <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckInxConfig</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Primary</span></span>  <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>  <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"spring.datasource"</span></span></span><span class="hljs-meta">)</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: DataSource {      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DataSourceBuilder.create()          .type(HikariDataSource::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">i</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/i</span></span></span><span class="hljs-class">&gt;)          .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build</span></span></span></span>()  }  <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>  <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"spring.datasource.configuration"</span></span></span><span class="hljs-meta">)</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(properties: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">DataSourceProperties</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: HikariDataSource {      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> properties.initializeDataSourceBuilder()          .type(HikariDataSource::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">i</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/i</span></span></span><span class="hljs-class">&gt;)          .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build</span></span></span></span>()  } }</code> </pre> <br><br><h2>  Planos de desenvolvimento </h2><br><ol><li>  Eu gostaria de entender se algu√©m al√©m de mim precisa disso?  Para fazer isso, crie uma pesquisa.  Ficarei feliz em responder honestamente. </li><li>  Veja o que voc√™ realmente precisa e expanda a lista padr√£o de m√©todos de afirma√ß√£o. </li><li>  Escreva implementa√ß√µes para outros bancos de dados. </li><li>  A constru√ß√£o do sqlInterceptor.statements [0] n√£o parece muito √≥bvia, quero melhor√°-lo. </li></ol><br>  Eu ficaria feliz se algu√©m quiser participar e ganhar algum cr√©dito praticando em Kotlin. <br><br><h2>  Conclus√£o </h2><br>  Estou certo de que haver√° coment√°rios: <i>√© imposs√≠vel prever como o planejador de consultas se comportar√° no produto, tudo depende das estat√≠sticas coletadas</i> . <br><br>  Na verdade, um planejador.  Usando as estat√≠sticas coletadas anteriormente, ele pode criar um plano diferente do que est√° sendo testado.  O significado √© um pouco diferente. <br><br>  A tarefa do planejador √© melhorar, e n√£o piorar, a solicita√ß√£o.  Portanto, sem motivo aparente, ele n√£o usar√° de repente o Seq Scan, mas voc√™ pode, sem saber. <br><br>  Voc√™ precisa do CheckInx para que, ao escrever um teste, n√£o se esque√ßa de estudar o plano de execu√ß√£o da consulta e considere a possibilidade de criar um √≠ndice, ou vice-versa, mostre claramente com um teste que nenhum √≠ndice √© necess√°rio aqui e que voc√™ est√° satisfeito com o Seq Scan.  Isso pouparia perguntas desnecess√°rias na revis√£o de c√≥digo. <br><br><h2>  Refer√™ncias </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/TinkoffCreditSystems/checkinx-utils</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/dsemyriazhko/checkinx-demo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/ttddyy/datasource-proxy</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://mvnrepository.com/artifact/org.testcontainers/postgresql</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/javamelody/javamelody/wiki</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt454066/">https://habr.com/ru/post/pt454066/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt454056/index.html">Como conectar clusters Kubernetes em diferentes datacenters</a></li>
<li><a href="../pt454058/index.html">Ferramenta conveniente para medir o c√≥digo C #</a></li>
<li><a href="../pt454060/index.html">Uma vis√£o inesperada dos circuitos ass√≠ncronos independentes da velocidade</a></li>
<li><a href="../pt454062/index.html">Telefone corporativo - como uma faca su√≠√ßa: para invent√°rio, bate-papo, chamadas de suporte e consultas</a></li>
<li><a href="../pt454064/index.html">A hist√≥ria n√£o contada da IA</a></li>
<li><a href="../pt454070/index.html">Escolhendo uma roda mono para pendulares</a></li>
<li><a href="../pt454072/index.html">Cinco maiores exemplos de mentiras sobre 5G</a></li>
<li><a href="../pt454074/index.html">DynamicData: cole√ß√µes din√¢micas, arquitetura MVVM e extens√µes reativas</a></li>
<li><a href="../pt454076/index.html">DotNext 2019 Piter: pequeno relat√≥rio</a></li>
<li><a href="../pt454078/index.html">"Conte√∫do para celular" de gra√ßa, sem SMS e registros. Detalhes de fraude de megafone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>