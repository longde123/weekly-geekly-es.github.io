<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöè üë® üå≠ Einschr√§nkungen, gegen die versto√üen werden muss, oder wie wir Funktionstests dreimal beschleunigt haben üíÖüèº üíÜüèΩ üé≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Funktionstests sind eine n√ºtzliche Sache. Anfangs brauchen sie nicht viel Zeit, aber das Projekt w√§chst und es werden immer mehr Tests ben√∂tigt. Wir h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Einschr√§nkungen, gegen die versto√üen werden muss, oder wie wir Funktionstests dreimal beschleunigt haben</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/419671/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/t0/cx/ye/t0cxyeb2tn7qjezwopepfwjy1ne.jpeg" alt="Bild"></a> <br><br>  Funktionstests sind eine n√ºtzliche Sache.  Anfangs brauchen sie nicht viel Zeit, aber das Projekt w√§chst und es werden immer mehr Tests ben√∂tigt.  Wir hatten nicht vor, eine Verlangsamung der Liefergeschwindigkeit zu tolerieren, und haben die Funktionstests dreimal beschleunigt, um unsere Kr√§fte zu sammeln.  In dem Artikel finden Sie universelle Tipps, Sie werden jedoch einen besonderen Effekt auf gro√üe Projekte bemerken. <br><a name="habracut"></a><br><h3>  Kurz √ºber die Anwendung </h3><br>  Mein Team entwickelt eine √∂ffentliche API, die 2GIS-Benutzern Daten zur Verf√ºgung stellt.  Wenn Sie zu 2gis.ru gehen und nach "Superm√§rkten" suchen, erhalten Sie eine Liste der Organisationen - dies sind die Daten aus unserer API.  Bei unserem RPS √ºber 2000 wird fast jedes Problem kritisch, wenn eine Funktionalit√§t ausf√§llt. <br><br>  Die Anwendung ist in Scala geschrieben, Tests sind in PHP geschrieben, die Datenbank ist PostgreSQL-9.4.  Wir haben ungef√§hr 25.000 Funktionstests, die auf einer dedizierten virtuellen Maschine f√ºr die allgemeine Regression 30 Minuten dauern.  Die Dauer der Tests hat uns nicht sonderlich gest√∂rt - wir waren daran gew√∂hnt, dass Tests mit dem alten Framework 60 Minuten dauern konnten. <br><br><h3>  Wie wir die sogenannten ‚ÄûSchnelltests‚Äú beschleunigt haben </h3><br>  Alles begann zuf√§llig.  Wie immer.  Wir haben eine Funktion nach der anderen unterst√ºtzt und gleichzeitig Tests bestanden.  Ihre Zahl wuchs und auch die notwendige Zeit, um sie zu vollenden.  Sobald die Tests begannen, die ihnen zugewiesenen Fristen zu √ºberschreiten, wurde der Prozess ihrer Ausf√ºhrung mit Gewalt beendet.  Unvollst√§ndige Tests sind mit einem fehlenden Problem im Code behaftet. <br><br>  Wir haben die Geschwindigkeit der Tests analysiert und die Aufgabe, sie stark zu beschleunigen, wurde relevant.  So begann eine Studie mit dem Titel "Tests arbeiten langsam - beheben Sie sie." <br><br>  Im Folgenden sind drei der gro√üen Probleme aufgef√ºhrt, die wir bei den Tests festgestellt haben. <br><br><h3>  Problem 1: Missbrauchte jsQuery </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4g/t9/0a/4gt90azsdwffnvwr2zy7pdsafiq.gif"></div><br>  Alle Daten, die wir haben, werden in der PostgreSQL-Datenbank gespeichert.  Meistens in Form von json, daher verwenden wir jsQuery aktiv. <br><br>  Hier ist ein Beispiel f√ºr eine Abfrage, die wir in der Datenbank durchgef√ºhrt haben, um die erforderlichen Daten abzurufen: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> firm <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'rubrics.@# &gt; 0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'address_name = *'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'contact_groups.#.contacts.#.type = ‚Äúwebsite‚Äù'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RANDOM() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Es ist leicht zu bemerken, dass das Beispiel json_data mehrmals hintereinander verwendet, obwohl es richtig w√§re, dies zu schreiben: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> firm <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'rubrics.@# &gt; 0 AND address_name = * AND contact_groups.#.contacts.#.type = ‚Äúwebsite‚Äù'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RANDOM() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Solche M√§ngel waren nicht allzu auff√§llig, da wir in Tests nicht alle Abfragen mit unseren H√§nden schreiben, sondern QueryBuilder verwenden, die sie selbst nach Angabe der erforderlichen Funktionen zusammenstellen.  Wir dachten nicht, dass dies die Geschwindigkeit der Abfrageausf√ºhrung beeinflussen k√∂nnte.  Dementsprechend sieht es im Code ungef√§hr so ‚Äã‚Äãaus: <br><br><pre> <code class="php hljs">$qb = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>&gt;createQueryBulder() -&gt;selectAllBranchFields() -&gt;fromBranchPartition() -&gt;hasRubric() -&gt;hasAddressName() -&gt;hasWebsite() -&gt;orderByRandom() -&gt;setMaxResults(<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br>  <b>Wiederholen Sie unsere Fehler nicht</b> : Wenn ein JSONB-Feld mehrere Bedingungen enth√§lt, beschreiben Sie sie alle im Rahmen des einzelnen Operators '@@'.  Nach dem Redid haben wir die Ausf√ºhrungszeit jeder Anforderung zweimal beschleunigt.  Fr√ºher dauerte die beschriebene Anforderung 7500 ms, jetzt dauert sie 3500 ms. <br><br><h3>  Problem 2: Zus√§tzliche Testdaten </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yz/ko/yc/yzkoyc5ixzl8pmj6vtkdltnubbc.gif"></div><br>  Der Zugriff auf unsere API erfolgt √ºber einen Schl√ºssel. Jeder Benutzer hat seine eigene API.  Bisher war es in Tests h√§ufig erforderlich, die Tasteneinstellungen zu √§ndern.  Aus diesem Grund fielen die Tests. <br><br>  Wir haben beschlossen, f√ºr jeden Regressionslauf mehrere Schl√ºssel mit den erforderlichen Einstellungen zu erstellen, um Kreuzungsprobleme zu vermeiden.  Und da das Erstellen eines neuen Schl√ºssels die Funktionalit√§t der gesamten Anwendung nicht beeintr√§chtigt, hat dieser Testansatz keine Auswirkungen.  Sie lebten ungef√§hr ein Jahr unter solchen Bedingungen, bis sie anfingen, sich mit Produktivit√§t zu befassen. <br><br>  Es gibt nicht viele Schl√ºssel - 1000 St√ºck.  Um die Anwendung zu beschleunigen, speichern wir sie im Speicher und aktualisieren sie alle paar Minuten oder bei Bedarf.  Nach dem Speichern des n√§chsten Schl√ºssels starteten die Tests den Synchronisationsprozess, auf dessen Ende wir nicht gewartet haben. Wir erhielten die Antwort ‚Äû504‚Äú, die in die Protokolle geschrieben wurde.  Gleichzeitig signalisierte die Anwendung in keiner Weise ein Problem, und wir fanden, dass alles f√ºr uns gro√üartig funktionierte.  Der Regressionstestprozess selbst wurde fortgesetzt.  Und am Ende stellte sich heraus, dass wir immer Gl√ºck hatten und unsere Schl√ºssel gerettet wurden. <br><br>  Wir lebten in Unwissenheit, bis wir die Protokolle √ºberpr√ºften.  Es stellte sich heraus, dass wir die Schl√ºssel erstellt, aber nach dem Ausf√ºhren der Tests nicht gel√∂scht haben.  So haben wir 500.000 davon angesammelt. <br><br>  <b>Wiederholen Sie unsere Fehler nicht:</b> Wenn Sie die Datenbank in den Tests irgendwie √§ndern, stellen Sie sicher, dass die Datenbank wieder in ihren urspr√ºnglichen Zustand versetzt wird.  Nachdem wir die Datenbank bereinigt hatten, wurde der Schl√ºsselaktualisierungsprozess 500-mal beschleunigt. <br><br><h3>  Problem 3: Zufallsstichprobe </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x7/s4/yw/x7s4ywwe8d2kg4upx_y0-k98k4a.gif"></div><br>  Wir lieben es, die Anwendung mit verschiedenen Daten zu testen.  Wir haben viele Daten und es treten regelm√§√üig Probleme auf.  Zum Beispiel gab es einen Fall, in dem keine Werbedaten hochgeladen wurden, aber Tests dieses Problem rechtzeitig erkannt haben.  Deshalb sehen Sie in jeder Anfrage unserer Tests ORDER BY RANDOM () <br><br>  Bei der Betrachtung der Ergebnisse von Abfragen mit und ohne Zuf√§lligkeit mit EXPLAIN konnten wir eine 20-fache Leistungssteigerung feststellen.  Wenn wir √ºber das obige Beispiel sprechen, funktioniert es ohne Randomisierung f√ºr 160 ms.  Wir haben ernsthaft dar√ºber nachgedacht, was wir tun sollen, weil wir das zuf√§llige Haus nicht wirklich komplett verlassen wollten. <br><br>  In Nowosibirsk gibt es beispielsweise etwa 150.000 Unternehmen, und als wir versuchten, ein Unternehmen mit einer Adresse, einer Website und einer √úberschrift zu finden, erhielten wir eine zuf√§llige Aufzeichnung aus fast der gesamten Datenbank.  Wir haben beschlossen, die Auswahl auf die ersten 100 Unternehmen zu reduzieren, die unseren Bedingungen entsprechen.  Das Ergebnis der √úberlegungen war ein Kompromiss zwischen einer st√§ndigen Auswahl unterschiedlicher Daten und der Geschwindigkeit: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> firm_1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'rubrics.@# &gt; 0 AND address_name = * AND contact_groups.#.contacts.#.type = "website"'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>) random_hack <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RANDOM() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  Auf diese einfache Weise haben wir bei 20-facher Beschleunigung fast nichts verloren.  Die Ausf√ºhrungszeit einer solchen Anfrage betr√§gt 180 ms. <br><br>  <b>Wiederholen Sie unsere Fehler nicht:</b> Dieser Moment kann nat√ºrlich kaum als Fehler bezeichnet werden.  Wenn Sie wirklich viele Tests haben, denken Sie immer daran, wie viel Zuf√§lligkeit in den Daten ben√∂tigt wird.  Der Kompromiss zwischen der Geschwindigkeit der Abfrageausf√ºhrung in der Datenbank und der Eindeutigkeit der Auswahl hat uns geholfen, SQL-Abfragen um das 20-fache zu beschleunigen. <br><br><h3>  Nochmals eine kurze Liste von Aktionen: </h3><br><ol><li>  Wenn wir im JSONB-Feld mehrere Bedingungen f√ºr die Auswahl von Daten angeben, m√ºssen diese in einem einzigen Operator '@@' aufgef√ºhrt werden. </li><li>  Wenn wir Testdaten erstellen, m√ºssen Sie diese unbedingt l√∂schen.  Auch wenn es den Anschein hat, dass ihre Anwesenheit die Funktionalit√§t der Anwendung nicht beeintr√§chtigt. </li><li>  Wenn Sie f√ºr jeden Lauf zuf√§llige Daten ben√∂tigen, finden wir einen Kompromiss zwischen der Eindeutigkeit der Stichprobe und der Ausf√ºhrungsgeschwindigkeit. </li></ol><br>  Wir haben die Regression dank einfacher (und f√ºr einige wahrscheinlich sogar offensichtlicher) Modifikationen dreimal beschleunigt.  Jetzt sind unsere 25K-Tests in 10 Minuten abgeschlossen.  Und das ist nicht die Grenze - wir optimieren als n√§chstes den Code.  Es ist nicht bekannt, wie viele unerwartete Entdeckungen uns dort erwarten. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de419671/">https://habr.com/ru/post/de419671/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de419661/index.html">Einen Radiosender aus GTA machen: San Andreas</a></li>
<li><a href="../de419663/index.html">Regierungsorganisationen locken mit Vertr√§gen, Boni und einer Vereinfachung der B√ºrokratie Sch√∂pfer von extrem kleinem pH-Wert</a></li>
<li><a href="../de419665/index.html">Die Erfahrung mit LoRaWAN im ASKUE-System unter realen Stadtbedingungen</a></li>
<li><a href="../de419667/index.html">Eine Auswahl n√ºtzlicher Materialien zu Azure. Teil 1 - B√ºcher</a></li>
<li><a href="../de419669/index.html">Zehn beste Gaming-M√§use f√ºr jeden Geldbeutel</a></li>
<li><a href="../de419677/index.html">So schn√ºffeln Sie den HTTPS-Verkehr eines iOS-Ger√§ts</a></li>
<li><a href="../de419679/index.html">Implementierung der Spring Framework-API von Grund auf neu. Komplettl√∂sung f√ºr Anf√§nger. Teil 1</a></li>
<li><a href="../de419683/index.html">Was bedeuten Metriken f√ºr agile Teams?</a></li>
<li><a href="../de419685/index.html">Die wichtigsten Datenstrukturen, die Sie √ºber Ihr Programmierinterview wissen sollten</a></li>
<li><a href="../de419687/index.html">Geheime Tastatur Stufe 3 oder wie man einen langen Strich druckt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>