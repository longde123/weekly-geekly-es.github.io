<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç¢ ‚ùï üë®üèº‚Äç‚úàÔ∏è √úbertragen eines PHP-Backends auf den Redis-Streams-Bus und Ausw√§hlen einer von den Frameworks unabh√§ngigen Bibliothek üë©‚Äçüè´ ‚ìÇÔ∏è üíä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vorwort 
 Auf meiner Website, die ich als Hobby verwende, werden interessante Homepages und pers√∂nliche Websites gespeichert. Dieses Thema begann mich...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√úbertragen eines PHP-Backends auf den Redis-Streams-Bus und Ausw√§hlen einer von den Frameworks unabh√§ngigen Bibliothek</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483584/"><img src="https://habrastorage.org/webt/wk/hw/mm/wkhwmmingyzwy7-r1esz_9vna54.png"><br><br><h2>  Vorwort </h2><br>  Auf meiner Website, die ich als Hobby verwende, werden interessante Homepages und pers√∂nliche Websites gespeichert.  Dieses Thema begann mich zu Beginn meines Programmierens zu interessieren. In diesem Moment freute ich mich, gro√üartige Fachleute zu finden, die √ºber sich selbst, ihre Hobbys und Projekte schreiben.  Die Angewohnheit, sie zu entdecken, ist f√ºrs Erste geblieben: Auf fast jeder kommerziellen und nicht sehr Website schaue ich weiterhin in die Fu√üzeile, um nach Links zu Autoren zu suchen. <br><a name="habracut"></a><br><h2>  Umsetzung der Idee </h2><br>  Die erste Version war nur eine HTML-Seite auf meiner pers√∂nlichen Website, auf der ich Links mit Signaturen in eine UL-Liste einf√ºgte.  Nachdem ich einige Zeit 20 Seiten getippt hatte, kam ich zu dem Schluss, dass dies nicht sehr effektiv war, und entschied mich, den Prozess zu automatisieren.  Beim Stackoverflow ist mir aufgefallen, dass viele Websites in ihren Profilen angeben, und so habe ich einen PHP-Parser geschrieben, der die Profile ab dem ersten (Adresse auf SO und bis heute diese Art: `/ users / 1`) und extrahierten Links durchging vom gew√ºnschten Tag und in SQLite gestapelt. <br><br>  Dies kann als zweite Version bezeichnet werden: eine Sammlung von Zehntausenden von URLs in einer SQLite-Platte, die die statische Liste in HTML ersetzt hat.  Ich habe in dieser Liste eine einfache Suche durchgef√ºhrt.  Weil  es gab nur urls, dann war die suche nur f√ºr sie. <br><br>  In diesem Stadium habe ich das Projekt aufgegeben und bin nach langer Zeit wieder dorthin zur√ºckgekehrt.  Zu diesem Zeitpunkt war meine Berufserfahrung bereits mehr als drei Jahre und ich hatte das Gef√ºhl, dass ich etwas Ernsthafteres tun k√∂nnte.  Dar√ºber hinaus bestand ein gro√üer Wunsch, relativ neue Technologien f√ºr sich zu beherrschen. <br><br><h2>  Moderne Version </h2><br>  <a href="https://hpdb.ru/">Das Projekt wurde</a> in Docker implementiert, die Datenbank wurde auf MongoDb √ºbertragen und vor relativ kurzer Zeit wurden Radieschen hinzugef√ºgt, die zun√§chst nur zum Zwischenspeichern gedacht waren.  Als Basis wird einer der PHP-Microframes verwendet. <br><br><h4>  Das problem </h4><br>  Neue Sites werden mit einem Konsolenbefehl hinzugef√ºgt, der synchron Folgendes ausf√ºhrt: <br><br><ul><li>  Herunterladen von Inhalten per URL <br></li><li>  Gibt an, ob HTTPS verf√ºgbar war <br></li><li>  Bewahrt die Essenz der Website <br></li><li>  Quell-HTML und Header werden im Indexverlauf gespeichert <br></li><li>  Analysiert Inhalte, ruft Titel und Beschreibung ab <br></li><li>  Speichert Daten in einer separaten Sammlung. <br></li></ul><br>  Dies reichte aus, um Websites zu speichern und in einer Liste anzuzeigen: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a4/914/0f8/5a49140f8a7a27eac0e22c21b24ada69.png"><br><br>  Aber die Idee, alles automatisch zu indizieren, zu kategorisieren und zu ordnen, alles auf dem neuesten Stand zu halten, passt nur schwach zu diesem Paradigma.  Schon das Hinzuf√ºgen einer Webmethode zum Hinzuf√ºgen von Seiten erforderte eine Codeduplizierung und Blockierung, um potenzielle DDoS zu vermeiden. <br><br>  Im Allgemeinen kann nat√ºrlich alles synchron ausgef√ºhrt werden. Speichern Sie in der Webmethode einfach die URL, um sicherzustellen, dass der monstr√∂se D√§mon alle Aufgaben f√ºr URLs aus der Liste ausf√ºhrt.  Aber trotzdem bittet auch hier das Wort "dran".  Wenn die Warteschlange implementiert ist, k√∂nnen alle Aufgaben zumindest asynchron aufgeteilt und ausgef√ºhrt werden. <br><br><h4>  L√∂sung </h4><br>  Stellen Sie Warteschlangen ein und erstellen Sie ein ereignisgesteuertes Verarbeitungssystem f√ºr alle Aufgaben.  Und nur f√ºr eine lange Zeit wollte ich Redis Streams ausprobieren. <br><br><h2>  Redis-Streams in PHP verwenden </h2><br>  Weil  Ich habe kein Framework der drei Giganten Symfony, Laravel, Yii und m√∂chte eine unabh√§ngige Bibliothek finden.  Wie sich jedoch herausstellte (bei der ersten Untersuchung), ist es unm√∂glich, einzelne seri√∂se Bibliotheken zu finden.  Alles, was mit Warteschlangen zusammenh√§ngt, ist entweder eine Projektion von drei Commits vor f√ºnf Jahren oder an ein Framework gebunden. <br><br>  Ich habe von Symfony als Anbieter einiger n√ºtzlicher Komponenten geh√∂rt und benutze bereits einige.  Und auch von Laravel kann etwas verwendet werden, zum Beispiel ihr ORM, ohne dass das Framework selbst vorhanden ist. <br><br><h4>  symfony / messenger </h4><br>  Der erste Kandidat schien sofort ideal, und ohne Zweifel habe ich ihn installiert.  Es war jedoch schwieriger, Anwendungsbeispiele au√üerhalb von Symfony zu googeln.  Wie man aus einem Haufen von Klassen mit universellen, nichts sagenden Namen, einem Bus zum Versenden von Nachrichten und sogar auf Redis sammelt? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f2b/1bf/ac0/f2b1bfac07a1e307d7b5826a1b191e3d.png"><br><br>  Die Dokumentation auf der offiziellen Website war recht ausf√ºhrlich, aber die Initialisierung wurde nur f√ºr Symfony beschrieben, wobei deren Lieblings-YML und andere magische Methoden f√ºr einen Nicht-Symphoniker verwendet wurden.  Ich hatte kein Interesse an der Installation, besonders in den Neujahrsferien.  Aber ich musste das f√ºr eine unerwartet lange Zeit tun. <br><br>  Der Versuch, herauszufinden, wie ein System mithilfe von Symfony-Quellen instanziiert werden kann, ist auch bei engen Fristen nicht die einfachste Aufgabe: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bc7/de8/991/bc7de89919463a8e7e4bfc5adec9df27.png"><br><br>  Ich stocherte darin herum und versuchte, etwas mit meinen H√§nden zu tun. Ich kam zu dem Schluss, dass ich eine Art Kr√ºcken machte und beschloss, etwas anderes zu versuchen. <br><br><h4>  beleuchten / Warteschlange </h4><br>  Es stellte sich heraus, dass diese Bibliothek eng mit der Laravel-Infrastruktur und einer Reihe anderer Abh√§ngigkeiten verbunden war, sodass ich nicht viel Zeit darauf verwendet habe: Abh√§ngigkeiten installiert, gesucht, gesehen und gel√∂scht. <br><br><h4>  yiisoft / yii2-queue </h4><br>  Naja, hier wurde sofort vom Namen ausgegangen, wieder eine enge Bindung an Yii2.  Ich musste diese Bibliothek benutzen und es war nicht schlecht, aber ich dachte nicht, dass es vollst√§ndig von Yii2 abh√§ngt. <br><br><h4>  Der rest </h4><br>  Alles andere, was ich auf dem Github fand, war unzuverl√§ssig veraltete und verlassene Projektionen ohne Sterne, Gabeln und eine gro√üe Anzahl von Verpflichtungen. <br><br><h2>  Zur√ºck zu Symfony / Messenger, technische Details </h2><br>  Ich musste mich mit dieser Bibliothek auseinandersetzen und nachdem ich etwas mehr Zeit verbracht hatte, konnte ich es.  Es stellte sich heraus, dass alles sehr kurz und einfach ist.  F√ºr die Instantiierung des Busses habe ich eine kleine Fabrik gebaut, weil  Ich hatte mehrere Reifen mit unterschiedlichen Handlern. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/970/723/ab2/970723ab2c86a6b4adfb35f32208fa76.png"><br><br>  Nur ein paar Schritte: <br><br><ul><li>  Erstellen Sie Message-Handler, die nur aufrufbar sein sollen <br></li><li>  Wrap sie in HandlerDescriptor (Klasse aus der Bibliothek) <br></li><li>  Wir binden diese "Deskriptoren" in die HandlersLocator-Instanz ein. <br></li><li>  F√ºgen Sie der MessageBus-Instanz HandlersLocator hinzu <br></li><li>  Wir √ºbergeben dem SendersLocator eine Reihe von "SenderInterface", in meinem Fall Instanzen der "RedisTransport" -Klassen, die auf offensichtliche Weise konfiguriert sind <br></li><li>  F√ºgen Sie SendersLocator zur MessageBus-Instanz hinzu <br></li></ul><br>  MessageBus hat eine Methode `-&gt; dispatch ()`, die im HandlersLocator nach den entsprechenden Handlern sucht und ihnen die Nachricht mit dem entsprechenden `SenderInterface` zum Senden √ºber den Bus √ºbergibt (Redis-Streams). <br><br>  In der Containerkonfiguration (in diesem Fall php-di) kann diese ganze Gruppe wie folgt konfiguriert werden: <br><br><pre><code class="php hljs">CONTAINER_REDIS_TRANSPORT_SECRET =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedisTransport( $c-&gt;get(CONTAINER_REDIS_STREAM_CONNECTION_SECRET), $c-&gt;get(CONTAINER_SERIALIZER)) ; }, CONTAINER_REDIS_TRANSPORT_LOG =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedisTransport( $c-&gt;get(CONTAINER_REDIS_STREAM_CONNECTION_LOG), $c-&gt;get(CONTAINER_SERIALIZER)) ; }, CONTAINER_REDIS_STREAM_RECEIVER_SECRET =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedisReceiver( $c-&gt;get(CONTAINER_REDIS_STREAM_CONNECTION_SECRET), $c-&gt;get(CONTAINER_SERIALIZER) ); }, CONTAINER_REDIS_STREAM_RECEIVER_LOG =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedisReceiver( $c-&gt;get(CONTAINER_REDIS_STREAM_CONNECTION_LOG), $c-&gt;get(CONTAINER_SERIALIZER) ); }, CONTAINER_REDIS_STREAM_BUS =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $c)</span></span></span><span class="hljs-function"> </span></span>{ $sendersLocator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendersLocator([ \App\Messages\SecretJsonMessages::class =&gt; [CONTAINER_REDIS_TRANSPORT_SECRET], \App\Messages\DaemonLogMessage::class =&gt; [CONTAINER_REDIS_TRANSPORT_LOG], ], $c); $middleware[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendMessageMiddleware($sendersLocator); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageBus($middleware); }, CONTAINER_REDIS_STREAM_CONNECTION_SECRET =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $c)</span></span></span><span class="hljs-function"> </span></span>{ $host = <span class="hljs-string"><span class="hljs-string">'bu-02-redis'</span></span>; $port = <span class="hljs-number"><span class="hljs-number">6379</span></span>; $dsn = <span class="hljs-string"><span class="hljs-string">"redis://$host:$port"</span></span>; $options = [ <span class="hljs-string"><span class="hljs-string">'stream'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'secret'</span></span>, <span class="hljs-string"><span class="hljs-string">'group'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'consumer'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'default'</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Connection::fromDsn($dsn, $options); }, CONTAINER_REDIS_STREAM_CONNECTION_LOG =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $c)</span></span></span><span class="hljs-function"> </span></span>{ $host = <span class="hljs-string"><span class="hljs-string">'bu-02-redis'</span></span>; $port = <span class="hljs-number"><span class="hljs-number">6379</span></span>; $dsn = <span class="hljs-string"><span class="hljs-string">"redis://$host:$port"</span></span>; $options = [ <span class="hljs-string"><span class="hljs-string">'stream'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'log'</span></span>, <span class="hljs-string"><span class="hljs-string">'group'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'consumer'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'default'</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Connection::fromDsn($dsn, $options); },</code> </pre> <br>  Es ist zu sehen, dass wir in SendersLocator zwei verschiedenen Nachrichten einen unterschiedlichen ‚ÄûTransport‚Äú zugewiesen haben, von denen jede eine eigene Verbindung zu den entsprechenden Streams hat. <br><br>  Ich habe ein separates Demo-Projekt erstellt, in dem drei D√§monen demonstriert wurden, die √ºber einen solchen Bus miteinander kommunizieren: <a href="https://github.com/backend-university/products/tree/master/products/02-redis-streams-bus">https://github.com/backend-university/products/tree/master/products/02-redis-streams-bus</a> . <br><br>  Aber ich zeige Ihnen, wie ein Verbraucher vermittelt werden kann: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Messages</span></span>\<span class="hljs-title"><span class="hljs-title">DaemonLogMessage</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Messenger</span></span>\<span class="hljs-title"><span class="hljs-title">Handler</span></span>\<span class="hljs-title"><span class="hljs-title">HandlerDescriptor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Messenger</span></span>\<span class="hljs-title"><span class="hljs-title">Handler</span></span>\<span class="hljs-title"><span class="hljs-title">HandlersLocator</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Messenger</span></span>\<span class="hljs-title"><span class="hljs-title">MessageBus</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Messenger</span></span>\<span class="hljs-title"><span class="hljs-title">Middleware</span></span>\<span class="hljs-title"><span class="hljs-title">HandleMessageMiddleware</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Messenger</span></span>\<span class="hljs-title"><span class="hljs-title">Middleware</span></span>\<span class="hljs-title"><span class="hljs-title">SendMessageMiddleware</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Messenger</span></span>\<span class="hljs-title"><span class="hljs-title">Transport</span></span>\<span class="hljs-title"><span class="hljs-title">Sender</span></span>\<span class="hljs-title"><span class="hljs-title">SendersLocator</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/../vendor/autoload.php'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \Psr\Container\ContainerInterface $container */</span></span> $container = <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(<span class="hljs-string"><span class="hljs-string">'config/container.php'</span></span>); $handlers = [ DaemonLogMessage::class =&gt; [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HandlerDescriptor( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DaemonLogMessage $m)</span></span></span><span class="hljs-function"> </span></span>{ \error_log(<span class="hljs-string"><span class="hljs-string">'DaemonLogHandler: message handled: / '</span></span> . $m-&gt;getMessage()); }, [<span class="hljs-string"><span class="hljs-string">'from_transport'</span></span> =&gt; CONTAINER_REDIS_TRANSPORT_LOG] ) ], ]; $middleware = []; $middleware[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HandleMessageMiddleware(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HandlersLocator($handlers)); $sendersLocator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendersLocator([<span class="hljs-string"><span class="hljs-string">'*'</span></span> =&gt; [CONTAINER_REDIS_TRANSPORT_LOG]], $container); $middleware[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendMessageMiddleware($sendersLocator); $bus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageBus($middleware); $receivers = [ CONTAINER_REDIS_TRANSPORT_LOG =&gt; $container-&gt;get(CONTAINER_REDIS_STREAM_RECEIVER_LOG), ]; $w = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Symfony\Component\Messenger\Worker($receivers, $bus, $container-&gt;get(CONTAINER_EVENT_DISPATCHER)); $w-&gt;run();</code> </pre><br><h2>  Verwenden dieser Infrastruktur in einer Anwendung </h2><br>  Nachdem ich den Bus in meinem Backend implementiert hatte, w√§hlte ich einzelne Schritte aus dem alten Synchron-Team aus und stellte separate Handler her, von denen jeder mit seinem eigenen Gesch√§ft besch√§ftigt ist. <br><br>  Die Pipeline zum Hinzuf√ºgen einer neuen Site zur Datenbank sieht wie folgt aus: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1a/ccf/202/f1accf2020c51b0ae5e5c39033d7d375.png"><br><br>  Und gleich danach wurde es f√ºr mich viel einfacher, neue Funktionen hinzuzuf√ºgen, zum Beispiel das Extrahieren und Parsen von RSS.  Weil  Da f√ºr diesen Prozess auch Quellinhalte erforderlich sind, abonniert der Handler-Extraktor des RSS-Links sowie WebsiteIndexHistoryPersistor die Nachricht "Content / HtmlContent", verarbeitet sie und leitet die gew√ºnschte Nachricht in der Pipeline weiter. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8cc/641/d52/8cc641d52b4a394c5381967360187ab0.png"><br><br>  Am Ende stellte sich heraus, dass es mehrere D√§monen gibt, von denen jede nur Verbindungen zu den erforderlichen Ressourcen enth√§lt.  Der <i>Crawler-</i> Daemon enth√§lt beispielsweise alle Handler, die eine Verbindung zum Internet f√ºr Inhalte ben√∂tigen, und der <i>Persister-</i> Daemon stellt eine Verbindung zur Datenbank her. <br><br>  Anstatt nun aus der Datenbank auszuw√§hlen, wird die erforderliche ID nach dem Einf√ºgen durch den Persister einfach √ºber den Bus an alle interessierten Handler weitergeleitet. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de483584/">https://habr.com/ru/post/de483584/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de483568/index.html">Erstellen eines primitiven Computers von Grund auf neu</a></li>
<li><a href="../de483570/index.html">Aber was ist, wenn die Erde flach ist?</a></li>
<li><a href="../de483574/index.html">Zuverl√§ssigkeitsanalyse von elektronischen Schock- und Vibrationsger√§ten - √úbersicht</a></li>
<li><a href="../de483578/index.html">Neuigkeiten aus der Welt von OpenStreetMap Nr. 493 (24.12.2019 - 30.12.2019)</a></li>
<li><a href="../de483580/index.html">VIM - Dies ist nicht nur ein Editor, sondern eine Integration in Ihre gesamte Arbeitsumgebung</a></li>
<li><a href="../de483586/index.html">Die Grundlagen der Arbeit mit zmq in Python zum Erstellen eines einfachen Schl√ºssel- / Wertespeichers</a></li>
<li><a href="../de483588/index.html">Wie versuche ich, eine Website mit ILV zu blockieren?</a></li>
<li><a href="../de483590/index.html">Suche nach FDCAN-Fehler, der nicht ist</a></li>
<li><a href="../de483594/index.html">Zukunfts√∂konomie f√ºr Physiker</a></li>
<li><a href="../de483598/index.html">Noch musikalischer Ostereier: Wir sprechen weiterhin √ºber Geschenke f√ºr aufmerksame Zuh√∂rer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>