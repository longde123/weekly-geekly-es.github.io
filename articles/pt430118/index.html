<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîé üö∞ üôåüèª Unity3D: modificar delegado de aplicativo para iOS üòê üé¶ üõ∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eu acho que muitos no processo de desenvolvimento de um jogo para iOS tiveram que enfrentar o fato de que √© necess√°rio usar uma ou outra funcionalidad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unity3D: modificar delegado de aplicativo para iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430118/">  Eu acho que muitos no processo de desenvolvimento de um jogo para iOS tiveram que enfrentar o fato de que √© necess√°rio usar uma ou outra funcionalidade nativa.  Em rela√ß√£o ao Unity3D, muitos problemas podem surgir nesta edi√ß√£o: para implementar algum tipo de recurso, voc√™ deve procurar plugins nativos escritos no Objective-C.  Algu√©m neste momento imediatamente se desespera e abandona a id√©ia.  Algu√©m est√° procurando solu√ß√µes prontas no AssetStore ou em f√≥runs, esperando que j√° exista uma solu√ß√£o pronta.  Se n√£o houver solu√ß√µes prontas, o mais persistente de n√≥s n√£o v√™ outra maneira sen√£o mergulhar no abismo da programa√ß√£o iOS e da intera√ß√£o do Unity3D com o c√≥digo Objective-C. <br><br>  Aqueles que escolherem o √∫ltimo caminho (embora, eu acho, eles mesmos saibam), enfrentar√£o muitos problemas nesse caminho dif√≠cil e espinhoso: <br><br><ul><li>  O iOS √© um ecossistema absolutamente desconhecido e isolado, desenvolvendo-se √† sua maneira.  No m√≠nimo, voc√™ ter√° que gastar muito tempo para entender como chegar ao aplicativo e onde, nas profundezas do projeto Xcode gerado automaticamente, est√° o c√≥digo para o mecanismo Unity3D interagir com o componente nativo do aplicativo. </li><li>  Objective-C √© uma linguagem de programa√ß√£o bastante separada e pouco parecida.  E quando se trata de interagir com o c√≥digo C ++ do aplicativo Unity3D, o ‚Äúdialeto‚Äù dessa linguagem, chamado Objective-C ++, entra em cena.  H√° muito pouca informa√ß√£o sobre ele, a maior parte √© antiga e arquiv√≠stica. </li><li>  O protocolo de intera√ß√£o entre o Unity3D e o aplicativo iOS √© pouco descrito.  Voc√™ deve confiar apenas nos tutoriais de entusiastas da rede que escrevem como desenvolver o plugin nativo mais simples.  Ao mesmo tempo, poucas pessoas abordam quest√µes mais profundas e problemas decorrentes da necessidade de fazer algo complicado. </li></ul><br>  Aqueles que querem aprender sobre os mecanismos de intera√ß√£o do Unity3D com um aplicativo iOS, por favor, em cat. <br><a name="habracut"></a><br>  Para esclarecer o gargalo sombrio da intera√ß√£o do Unity3D com o c√≥digo nativo, este artigo descreve os aspectos de intera√ß√£o de um aplicativo iOS delegado com o c√≥digo Unity3D, com o qual as ferramentas C ++ e Objective-C s√£o implementadas e como voc√™ mesmo delegar o aplicativo.  Essas informa√ß√µes podem ser √∫teis tanto para uma melhor compreens√£o dos mecanismos de liga√ß√£o do Unity3D + iOS quanto para o uso pr√°tico. <br><br><h3>  Intera√ß√£o entre iOS e aplicativo </h3><br>  Como introdu√ß√£o, vamos ver como a intera√ß√£o do aplicativo com o sistema √© implementada no iOS e vice-versa.  Esquematicamente, o lan√ßamento de um aplicativo iOS se parece com o seguinte: <br><br><img src="https://habrastorage.org/webt/jd/vm/oi/jdvmoimtygqdsc095abusfopdao.png" alt="imagem"><br><br>  Para estudar esse mecanismo do ponto de vista do c√≥digo, √© adequado um novo aplicativo criado no Xcode usando o modelo "Aplicativo de visualiza√ß√£o √∫nica". <br><br><img src="https://habrastorage.org/webt/du/_z/75/du_z75efp4bdgv_fvb02x-mjfis.png"><br><br>  Ao selecionar este modelo, a sa√≠da fornecer√° o aplicativo iOS mais simples que pode ser executado em um dispositivo ou emulador e mostrar√° uma tela branca.  O Xcode ajudar√° a criar um projeto no qual haver√° apenas 5 arquivos com c√≥digo-fonte (com 2 deles sendo arquivos .h de cabe√ßalho) e v√°rios arquivos auxiliares que n√£o s√£o interessantes para n√≥s (composi√ß√£o, configura√ß√µes, √≠cones). <br><br><img src="https://habrastorage.org/webt/jt/mz/ov/jtmzov95oshddmprhby9wkqigve.png"><br><br>  Vamos ver pelo que os arquivos de c√≥digo fonte s√£o respons√°veis: <br><br><ul><li>  <i>ViewController.m</i> / <i>ViewController.h</i> - c√≥digos-fonte n√£o muito interessantes para n√≥s.  Como seu aplicativo possui uma View (que n√£o √© representada pelo c√≥digo, mas usando o Storyboard), voc√™ precisar√° da classe Controller, que controlar√° essa View.  Em geral, dessa maneira o pr√≥prio Xcode nos incentiva a usar o padr√£o MVC.  O projeto que gera o Unity3D n√£o ter√° esses arquivos de origem. </li><li>  <i>AppDelegate.m</i> / <i>AppDelegate.h</i> √© o delegado do seu aplicativo.  O ponto de interesse no aplicativo em que come√ßa o trabalho do c√≥digo do aplicativo customizado. </li><li>  <i>main.m</i> - o ponto de partida do aplicativo.  Como qualquer aplicativo C / C ++, ele cont√©m a fun√ß√£o principal, com a qual o programa √© iniciado. </li></ul><br>  Agora, vamos ver o c√≥digo come√ßando com o arquivo <i>main.m</i> : <br><br><pre><code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * argv[]) { <span class="hljs-comment"><span class="hljs-comment">//1 @autoreleasepool { //2 return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class])); // 3 } }</span></span></code> </pre> <br>  Com a linha 1, tudo est√° claro e sem explica√ß√£o, vamos para a linha 2. Indica que o ciclo de vida do aplicativo ocorrer√° dentro do pool de Autorelease.  O uso do pool de libera√ß√£o autom√°tica nos diz que confiaremos o gerenciamento de mem√≥ria do aplicativo a esse pool espec√≠fico, ou seja, ele lidar√° com problemas quando for necess√°rio liberar mem√≥ria para uma vari√°vel espec√≠fica.  A hist√≥ria sobre gerenciamento de mem√≥ria no iOS est√° al√©m do escopo desta hist√≥ria, portanto, n√£o faz sentido aprofundar-se neste t√≥pico.  Para aqueles interessados ‚Äã‚Äãneste t√≥pico, voc√™ pode encontrar, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">este artigo</a> . <br><br>  Vamos para a linha 3. Chama a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UIApplicationMain</a> .  Os par√¢metros de inicializa√ß√£o do programa (argc, argv) s√£o passados ‚Äã‚Äãpara ele.  Em seguida, nesta fun√ß√£o, √© indicada qual classe usar como classe principal do aplicativo, sua inst√¢ncia √© criada.  E, finalmente, √© indicada qual classe usar como delegado do aplicativo, sua inst√¢ncia √© criada, as conex√µes entre a inst√¢ncia da classe do aplicativo e seu delegado s√£o configuradas. <br><br>  Em nosso exemplo, nil √© passado como a classe que representar√° a inst√¢ncia do aplicativo - grosso modo, o anal√≥gico local √© nulo.  Al√©m de nulo, voc√™ pode passar uma classe espec√≠fica herdada do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UIApplication l√°</a> .  Se nil for especificado, o UIApplication ser√° usado.  Esta classe √© um ponto centralizado para gerenciar e coordenar o trabalho de um aplicativo no iOS e √© um singleton.  Com ele, voc√™ pode aprender quase tudo sobre o estado atual do aplicativo, notifica√ß√µes, janelas, eventos que ocorreram no pr√≥prio sistema que afetam esse aplicativo e muito mais.  Essa classe quase nunca herda.  Vamos abordar a cria√ß√£o da classe Application Delegate em mais detalhes. <br><br><h3>  Criar Delegado de Aplicativo </h3><br>  Uma indica√ß√£o de qual classe usar como delegado do aplicativo ocorre em uma chamada de fun√ß√£o <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSStringFromClass</span></span>([AppDelegate <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>])</code> </pre> <br>  Vamos analisar esta chamada em partes. <br><br><pre> <code class="objectivec hljs">[AppDelegate <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Essa constru√ß√£o</a> retorna um objeto da classe AppDelegate (que √© declarada em AppDelegate.h / .m) e a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NSStringFromClass</a> retorna o nome da classe como uma seq√º√™ncia de caracteres.  Simplesmente passamos o nome da string da classe a ser criada e usada como representante da fun√ß√£o UIApplicationMain.  Para um melhor entendimento, a linha 3 no arquivo <i>main.m</i> pode ser substitu√≠da pelo seguinte: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIApplicationMain</span></span>(argc, argv, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-string"><span class="hljs-string">@"AppDelegate"</span></span>);</code> </pre> <br>  E o resultado de sua implementa√ß√£o seria id√™ntico √† vers√£o original.  Aparentemente, os desenvolvedores decidiram adotar essa abordagem para n√£o usar uma constante de string.  Com uma abordagem padr√£o, se voc√™ renomear uma classe delegada, o analisador lan√ßar√° imediatamente um erro.  No caso de usar a linha usual, o c√≥digo ser√° compilado com √™xito e voc√™ receber√° um erro apenas iniciando o aplicativo. <br><br>  Um mecanismo semelhante para criar uma classe, usando apenas o nome da string da classe, pode lembr√°-lo do Reflection from C #.  O Objective-C e seu tempo de execu√ß√£o s√£o muito mais poderosos que o Reflection in C #.  Este √© um ponto muito importante no contexto deste artigo, mas levaria muito tempo para descrever todos os recursos.  No entanto, ainda encontraremos "Reflex√£o" no Objetivo-C abaixo.  Resta entender o conceito do delegado do aplicativo e suas fun√ß√µes. <br><br><h3>  Delegado do aplicativo </h3><br>  Toda intera√ß√£o do aplicativo com o iOS ocorre na classe UIApplication.  Essa classe assume muitas responsabilidades - notifica sobre a origem dos eventos, o estado do aplicativo e muito mais.  Na maior parte, seu papel √© notificar.  Mas quando algo acontece no sistema, devemos ser capazes de responder de alguma forma a essa altera√ß√£o, para executar algum tipo de funcionalidade personalizada.  Se uma inst√¢ncia da classe UIApplication fizer isso, essa pr√°tica come√ßar√° a se parecer com uma abordagem chamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Objeto Divino</a> .  Portanto, vale a pena pensar em libertar essa classe de parte de suas responsabilidades. <br><br>  √â para esses fins que o ecossistema do iOS usa algo como delegado de aplicativo.  A partir do pr√≥prio nome, podemos concluir que estamos lidando com um padr√£o de design como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Delega√ß√£o</a> .  Em resumo, simplesmente transferimos a responsabilidade pelo processamento da resposta a determinados eventos do aplicativo ao delegado do aplicativo.  Para esse fim, em nosso exemplo, a classe AppDelegate foi criada na qual podemos escrever funcionalidades personalizadas, deixando a classe UIApplication para trabalhar no modo de caixa preta.  Essa abordagem pode parecer controversa para algu√©m em termos de beleza do design arquitet√¥nico, mas os pr√≥prios autores do iOS est√£o nos pressionando para essa abordagem e a grande maioria dos desenvolvedores (se n√£o todos) a usa. <br><br>  Para verificar visualmente com que frequ√™ncia, durante o trabalho do aplicativo, o delegado do aplicativo recebe uma mensagem espec√≠fica, veja o diagrama: <br><br><img src="https://habrastorage.org/webt/md/61/bc/md61bc9my4focy1suoy5qn9om2s.png" alt="imagem"><br><br>  Os ret√¢ngulos amarelos indicam as chamadas de um ou outro m√©todo delegado em resposta a determinados eventos da vida √∫til do aplicativo (ciclo de vida do aplicativo).  Este diagrama ilustra apenas eventos relacionados a altera√ß√µes no estado do aplicativo e n√£o exibe muitos outros aspectos da responsabilidade do delegado, como aceitar notifica√ß√µes ou interagir com estruturas. <br><br>  Aqui est√£o alguns exemplos em que podemos precisar acessar um representante de aplicativo do Unity3D: <br><br><ol><li>  manipula√ß√£o de notifica√ß√µes push e locais </li><li>  Registrando Eventos de Ativa√ß√£o do Aplicativo no Analytics </li><li>  determina√ß√£o de como iniciar o aplicativo - ‚Äúlimpo‚Äù ou sair do plano de fundo </li><li>  como o aplicativo foi iniciado - por tach para notifica√ß√£o, usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A√ß√µes r√°pidas da tela inicial</a> ou apenas por tach on incon </li><li>  intera√ß√£o com WatchKit ou HealthKit </li><li>  abrir e processar URLs de outro aplicativo.  Se esse URL se aplicar ao seu aplicativo, voc√™ poder√° process√°-lo em vez de deixar o sistema abrir esse URL em um navegador </li></ol><br>  Esta n√£o √© a lista completa de cen√°rios.  Al√©m disso, √© importante notar que o delegado modifica muitos sistemas de an√°lise e publicidade em seus plugins nativos. <br><br><h3>  Como o Unity3D implementa um delegado de aplicativo </h3><br>  Vamos agora analisar o projeto Xcode gerado pelo Unity3D e descobrir como o delegado do aplicativo √© implementado no Unity3D.  Ao criar para a plataforma iOS, o Unity3D gera automaticamente um projeto Xcode para voc√™, que usa muito c√≥digo padr√£o.  Este c√≥digo de modelo tamb√©m inclui o c√≥digo de Delegado de Aplicativo.  Dentro de qualquer projeto gerado, voc√™ pode encontrar os arquivos <i>UnityAppController.he</i> <i>UnityAppController.mm</i> .  Esses arquivos cont√™m o c√≥digo da classe UnityAppController que nos interessa. <br><br>  De fato, o Unity3D usa uma vers√£o modificada do modelo "Aplicativo de exibi√ß√£o √∫nica".  Somente neste modelo, o Unity3D usa o delegado do aplicativo n√£o apenas para manipular eventos do iOS, mas tamb√©m para inicializar o pr√≥prio mecanismo, preparar componentes gr√°ficos e muito mais.  Isso √© muito f√°cil de entender se voc√™ observar o m√©todo. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)application:(<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span>*)application didFinishLaunchingWithOptions:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span>*)launchOptions</code> </pre><br>  no c√≥digo da classe UnityAppController.  Esse m√©todo √© chamado no momento da inicializa√ß√£o do aplicativo, quando voc√™ pode transferir o controle para o seu c√≥digo personalizado.  Dentro deste m√©todo, por exemplo, voc√™ pode encontrar as seguintes linhas: <br><br><pre> <code class="objectivec hljs">UnityInitApplicationNoGraphics([[[<span class="hljs-built_in"><span class="hljs-built_in">NSBundle</span></span> mainBundle] bundlePath] UTF8String]); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> selectRenderingAPI]; [UnityRenderingView InitializeForAPI: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.renderingAPI]; _window = [[<span class="hljs-built_in"><span class="hljs-built_in">UIWindow</span></span> alloc] initWithFrame: [<span class="hljs-built_in"><span class="hljs-built_in">UIScreen</span></span> mainScreen].bounds]; _unityView = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> createUnityView]; [DisplayManager Initialize]; _mainDisplay = [DisplayManager Instance].mainDisplay; [_mainDisplay createWithWindow: _window andView: _unityView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> createUI]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> preStartUnity];</code> </pre><br>  Sem sequer entrar em detalhes sobre o que esses desafios representam, voc√™ pode adivinhar que eles est√£o relacionados √† prepara√ß√£o do Unity3D para o trabalho.  Acontece o seguinte cen√°rio: <br><br><ol><li>  A fun√ß√£o principal √© chamada de <i>main.mm</i> </li><li>  As classes de inst√¢ncia do aplicativo e seu representante s√£o criadas. </li><li>  O delegado do aplicativo prepara e lan√ßa o mecanismo Unity3D </li><li>  Seu c√≥digo personalizado come√ßa a funcionar.  Se voc√™ usa o il2cpp, seu c√≥digo √© convertido de C # para IL e depois para c√≥digo C ++, que entra diretamente no projeto Xcode. </li></ol><br>  Esse script parece bastante simples e l√≥gico, mas traz um problema em potencial: como podemos modificar o delegado do aplicativo se n√£o tivermos acesso ao c√≥digo fonte ao trabalhar no Unity3D? <br><br><h3>  O Unity3D afetado para modificar o delegado do aplicativo </h3><br>  Podemos dar uma olhada nos arquivos <i>AppDelegateListener.mm/.h</i> .  Eles cont√™m macros que permitem registrar qualquer classe como ouvinte de eventos para o delegado do aplicativo.  Essa √© uma boa abordagem, n√£o precisamos modificar o c√≥digo existente, mas apenas adicionar um novo.  Mas tem uma desvantagem significativa: nem todos os eventos do aplicativo s√£o suportados e n√£o h√° como obter informa√ß√µes sobre o lan√ßamento do aplicativo. <br><br>  A sa√≠da mais √≥bvia, por√©m, inaceit√°vel √© alterar o c√≥digo-fonte delegado manualmente depois que o Unity3D cria o projeto Xcode.  O problema dessa abordagem √© √≥bvio - a op√ß√£o √© adequada se voc√™ fizer montagens com as m√£os e n√£o ficar confuso com a necessidade de modificar o c√≥digo manualmente ap√≥s cada montagem.  No caso de usar construtores (Unity Cloud Build ou qualquer outra m√°quina de compila√ß√£o), essa op√ß√£o √© absolutamente inaceit√°vel.  Para esses prop√≥sitos, os desenvolvedores do Unity3D nos deixaram uma brecha. <br><br>  O arquivo <i>UnityAppController.h</i> , al√©m de declarar vari√°veis ‚Äã‚Äãe m√©todos, tamb√©m cont√©m uma defini√ß√£o de macro: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define IMPL_APP_CONTROLLER_SUBCLASS(ClassName) ...</span></span></code> </pre> <br>  Essa macro apenas permite substituir o delegado do aplicativo.  Para fazer isso, voc√™ precisa executar algumas etapas simples: <br><br><ol><li>  Escreva seu pr√≥prio representante de aplicativo no Objective-C </li><li>  Em algum lugar dentro do c√≥digo fonte, adicione a seguinte linha <pre> <code class="objectivec hljs">IMPL_APP_CONTROLLER_SUBCLASS(___)</code> </pre> </li><li>  Coloque essa fonte na pasta Plugins / iOS do seu projeto Unity3D </li></ol><br>  Agora voc√™ receber√° um projeto no qual o delegado padr√£o do aplicativo Unity3D ser√° substitu√≠do pelo seu personalizado. <br><br><h3>  Como funciona a macro de substitui√ß√£o de delegado </h3><br>  Vamos dar uma olhada no c√≥digo fonte completo da macro: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define IMPL_APP_CONTROLLER_SUBCLASS(ClassName) ... @interface ClassName(OverrideAppDelegate) \ { \ } \ +(void)load; \ @end \ @implementation ClassName(OverrideAppDelegate) \ +(void)load \ { \ extern const char* AppControllerClassName; \ AppControllerClassName = #ClassName; \ } \ @end</span></span></code> </pre> <br>  O uso dessa macro na sua fonte adicionar√° o c√≥digo descrito na macro ao corpo da sua fonte no est√°gio de compila√ß√£o.  Essa macro faz o seguinte.  Primeiro, ele adicionar√° o m√©todo load √† interface da sua classe.  Uma interface no contexto do Objective-C pode ser pensada como uma cole√ß√£o de campos e m√©todos p√∫blicos.  Em C #, um m√©todo de carregamento est√°tico aparecer√° na sua classe que n√£o retorna nada.  A seguir, a implementa√ß√£o desse m√©todo de carregamento ser√° adicionada ao c√≥digo da sua classe.  Nesse m√©todo, a vari√°vel AppControllerClassName ser√° declarada, que √© uma matriz do tipo char e, em seguida, essa vari√°vel receber√° um valor.  Este valor √© o nome da string da sua classe.  Obviamente, essas informa√ß√µes n√£o s√£o suficientes para entender o mecanismo de opera√ß√£o dessa macro; portanto, devemos entender o que √© esse m√©todo de "carga" e por que uma vari√°vel √© declarada. <br><br>  A <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> diz que o carregamento √© um m√©todo especial chamado uma vez para cada classe (especificamente a classe, n√£o suas inst√¢ncias) no est√°gio inicial do lan√ßamento do aplicativo, mesmo antes da chamada da fun√ß√£o principal.  O ambiente de tempo de execu√ß√£o Objective-c (runtime) na inicializa√ß√£o do aplicativo registrar√° todas as classes que ser√£o usadas durante a opera√ß√£o do aplicativo e chamar√° o m√©todo load nele, se implementado.  Acontece que, mesmo antes do in√≠cio de qualquer c√≥digo em nosso aplicativo, a vari√°vel AppControllerClassName ser√° adicionada √† sua classe. <br><br>  Ent√£o voc√™ pode pensar: ‚ÄúE qual √© o sentido de ter essa vari√°vel se ela for declarada dentro do m√©todo e ser√° exclu√≠da da mem√≥ria quando voc√™ sair desse m√©todo?‚Äù.  A resposta a esta pergunta est√° um pouco al√©m dos limites do Objective-C. <br><br><h3>  E onde est√° o C ++? </h3><br>  Vamos dar uma outra olhada na declara√ß√£o dessa vari√°vel <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* AppControllerClassName;</code> </pre> <br>  A √∫nica coisa que pode ser incompreens√≠vel nesta declara√ß√£o √© o modificador externo.  Se voc√™ tentar usar esse modificador no Objective-C puro, o Xcode emitir√° um erro.  O fato √© que esse modificador n√£o faz parte do Objective-C; √© implementado em C ++.  O Objetivo-C pode ser descrito sucintamente dizendo que √© "linguagem C com classes".  √â uma extens√£o da linguagem C e permite o uso ilimitado do c√≥digo C intercalado com o c√≥digo Objective-C. <br><br>  No entanto, para usar recursos externos e outros recursos do C ++, voc√™ precisa fazer algum truque - use o Objective-C ++.  Praticamente n√£o h√° informa√ß√µes sobre essa linguagem, devido ao fato de ser apenas o c√≥digo Objective-C que permite a inser√ß√£o do c√≥digo C ++.  Para que o compilador considere que algum arquivo de origem deve ser compilado como Objective-C ++, e n√£o Objective-C, voc√™ s√≥ precisa alterar a extens√£o desse arquivo de <i>.m</i> para <i>.mm</i> . <br><br>  O pr√≥prio modificador externo √© usado para declarar uma vari√°vel global.  Mais precisamente, para dizer ao compilador ‚ÄúAcredite em mim, essa vari√°vel existe, mas a mem√≥ria para ela foi alocada n√£o aqui, mas em outra fonte.  E ela tamb√©m tem um valor, eu garanto. ‚Äù  Assim, nossa linha de c√≥digo simplesmente cria uma vari√°vel global e armazena nela o nome de nossa classe personalizada.  Resta apenas entender onde essa vari√°vel pode ser usada. <br><br><h3>  Voltar ao menu principal </h3><br>  Lembramos o que foi dito anteriormente - o delegado do aplicativo √© criado especificando o nome da classe.  Se o delegado foi criado usando o valor constante [classe myClass] no modelo de projeto regular do Xcode, aparentemente os caras do Unity decidiram que esse valor deveria ser envolvido em uma vari√°vel.  Usando o m√©todo de cutucada cient√≠fica, pegamos o projeto Xcode gerado pelo Unity3D e vamos para o arquivo <i>main.mm.</i> <br><br>  Nele vemos c√≥digo mais complexo do que antes, parte desse c√≥digo est√° faltando como desnecess√°rio: <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// WARNING: this MUST be c decl (NSString ctor will be called after +load, so we cant really change its value) const char* AppControllerClassName = "UnityAppController"; int main(int argc, char* argv[]) { ... UIApplicationMain(argc, argv, nil, [NSString stringWithUTF8String: AppControllerClassName]); } return 0; }</span></span></code> </pre> <br>  Aqui vemos a declara√ß√£o dessa vari√°vel e a cria√ß√£o do aplicativo delegado com sua ajuda. <br>  Se criamos um delegado personalizado, a vari√°vel necess√°ria existe e j√° importa - o nome da nossa classe.  Declarar e inicializar a vari√°vel antes da fun√ß√£o principal garante que ela tenha um valor padr√£o - UnityAppController. <br><br>  Agora, com esta decis√£o, tudo deve ficar bem claro. <br><br><h3>  Problema de macro </h3><br>  Obviamente, para a grande maioria das situa√ß√µes, o uso dessa macro √© uma √≥tima solu√ß√£o.  Mas vale a pena notar que h√° uma grande armadilha: voc√™ n√£o pode ter mais de um delegado personalizado.  Isso acontece porque se 2 ou mais classes usam a macro IMPL_APP_CONTROLLER_SUBCLASS (ClassName), para a primeira delas o valor da vari√°vel que precisamos ser√° atribu√≠do e outras atribui√ß√µes ser√£o ignoradas.  E essa vari√°vel √© uma sequ√™ncia, ou seja, n√£o pode ser atribu√≠da mais de um valor. <br><br>  Voc√™ pode pensar que esse problema √© degenerado e improv√°vel na pr√°tica.  Mas, este artigo n√£o teria acontecido se esse problema n√£o tivesse realmente ocorrido, e mesmo sob circunst√¢ncias muito estranhas.  A situa√ß√£o pode ser a seguinte.  Voc√™ tem um projeto no qual utiliza muitos servi√ßos de an√°lise e publicidade.  Muitos desses servi√ßos possuem componentes Objective-C.  Eles est√£o no seu projeto h√° muito tempo e voc√™ n√£o conhece os problemas com eles.  Aqui voc√™ precisa escrever um representante personalizado.  Voc√™ usa uma macro m√°gica projetada para evitar problemas, criar um projeto e obter um relat√≥rio sobre o sucesso da montagem.  Execute o projeto no dispositivo, e sua funcionalidade n√£o funciona e voc√™ n√£o recebe um √∫nico erro. <br><br>  E pode ser que um dos plugins de publicidade ou an√°lise use a mesma macro.  Por exemplo, no plug-in do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AppsFlyer,</a> essa macro √© usada. <br><br><h3>  Qual √© o valor da vari√°vel externa no caso de m√∫ltiplas declara√ß√µes? </h3><br>  √â interessante descobrir se a mesma vari√°vel externa √© declarada em v√°rios arquivos e eles s√£o inicializados da maneira que nossa macro (no m√©todo de carregamento); ent√£o, como podemos entender qual valor a vari√°vel ter√°?  Para entender o padr√£o, um aplicativo de teste simples foi criado, cujo c√≥digo pode ser encontrado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  A ess√™ncia do aplicativo √© simples.  Existem 2 classes A e B, em ambas as classes a vari√°vel externa AexternVar √© declarada, √© atribu√≠do um valor espec√≠fico.  Os valores da vari√°vel nas classes s√£o definidos de maneira diferente.  Na fun√ß√£o principal, o valor desta vari√°vel √© registrado.  Constatou-se experimentalmente que o valor da vari√°vel depende da ordem em que as fontes s√£o adicionadas ao projeto.  A ordem na qual o tempo de execu√ß√£o Objective-C registra classes durante a execu√ß√£o do aplicativo depende disso.  Se voc√™ deseja repetir a experi√™ncia, abra o projeto e selecione a guia Fases de constru√ß√£o nas configura√ß√µes do projeto.  Como o projeto √© pequeno e de teste, ele possui apenas 8 c√≥digos-fonte.  Todos eles est√£o presentes na guia Build Fhases na lista Compile Sources. <br><br><img src="https://habrastorage.org/webt/oi/ly/ln/oilylnhxdyjg3cvgcrj5nzhjvwy.png"><br><br>  Se nesta lista a fonte da classe A for maior que a fonte da classe B, a vari√°vel receber√° um valor da classe B. Caso contr√°rio, a vari√°vel receber√° um valor da classe A. <br><br>  Imagine quantos problemas isso teoricamente pode causar √© uma pequena nuance.  Especialmente se o projeto for grande, gerado automaticamente e voc√™ n√£o souber em quais classes essa vari√°vel √© declarada. <br><br><h3>  Resolu√ß√£o de problemas </h3><br>  No in√≠cio do artigo, foi dito que o Objective-C ajudaria a refletir o C #.  Especificamente, para resolver nosso problema, voc√™ pode usar o mecanismo chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">M√©todo Swizzling</a> .  A ess√™ncia desse mecanismo √© que temos a oportunidade de substituir a implementa√ß√£o de um m√©todo de qualquer classe por outro durante a aplica√ß√£o.  Assim, podemos substituir o m√©todo de interesse no UnityAppController por um personalizado.  Tomamos a implementa√ß√£o existente e complementamos o c√≥digo que precisamos.  Estamos escrevendo um c√≥digo que substitui a implementa√ß√£o existente do m√©todo pela que precisamos.  Durante o trabalho do aplicativo, o delegado que usa a macro funcionar√° como antes, chamando a implementa√ß√£o b√°sica do UnityAppController, e a√≠ nosso m√©todo personalizado entrar√° em a√ß√£o e alcan√ßaremos o resultado desejado.  Essa abordagem est√° bem escrita e ilustrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste artigo</a> .  Com essa t√©cnica, podemos criar uma classe auxiliar - um an√°logo de um delegado personalizado.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesta classe, escreveremos todo o c√≥digo personalizado, tornando a classe personalizada um tipo de Wrapper para chamar a funcionalidade de outras classes. </font><font style="vertical-align: inherit;">Essa abordagem funcionar√°, mas √© extremamente impl√≠cita devido ao fato de ser dif√≠cil rastrear onde o m√©todo √© substitu√≠do e quais consequ√™ncias ele levar√°.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Outra solu√ß√£o para o problema </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O principal aspecto do problema que aconteceu √© que h√° muitos delegados personalizados, ou voc√™ pode ter apenas um ou substitu√≠-lo parcialmente por um segundo. </font><font style="vertical-align: inherit;">Ao mesmo tempo, n√£o h√° como garantir que o c√≥digo dos delegados personalizados n√£o ocorra em arquivos de origem diferentes. </font><font style="vertical-align: inherit;">Acontece que a situa√ß√£o pode ser considerada como uma refer√™ncia quando h√° apenas um delegado no aplicativo, voc√™ precisa criar classes personalizadas quantas desejar, enquanto nenhuma dessas classes usa a macro para evitar problemas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema √© pequeno, resta determinar como isso pode ser feito usando o Unity3D, deixando a capacidade de criar um projeto usando uma m√°quina de compila√ß√£o. </font><font style="vertical-align: inherit;">O algoritmo da solu√ß√£o √© o seguinte:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Escrevemos delegados personalizados na quantidade necess√°ria, dividindo a l√≥gica dos plugins em diferentes classes, observando os princ√≠pios do SOLID e n√£o recorrendo √† sofistica√ß√£o. </font></font></li><li>       UnityAppController   XCode      .         UnityAppController   . </li><li>    UnityAppController     Unity . </li><li>     XCode     UnityAppController  ,       </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O item mais dif√≠cil desta lista √© sem d√∫vida o √∫ltimo. No entanto, esse recurso pode ser implementado no Unity3D usando o script de constru√ß√£o p√≥s-processo. Esse script foi escrito em uma linda noite, voc√™ pode assisti-lo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse p√≥s-processo √© bastante f√°cil de usar, escolha-o em um projeto do Unity. Olhe na janela Inspetor e veja um campo chamado NewDelegateFile. Arraste e solte seu UnityAppController modificado neste campo e salve.</font></font><br><br><img src="https://habrastorage.org/webt/zs/sb/l2/zssbl2ttito42xsbqwcpqzqfezs.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao criar um projeto iOS, o delegado padr√£o ser√° substitu√≠do por um modificado, e nenhuma interven√ß√£o manual √© necess√°ria. </font><font style="vertical-align: inherit;">Agora, ao adicionar novos delegados personalizados ao projeto, voc√™ s√≥ precisa modificar a op√ß√£o UnityAppController existente no projeto do Unity.</font></font><br><br><h4>  PS </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obrigado a todos que chegaram ao final, o artigo acabou sendo extremamente longo. </font><font style="vertical-align: inherit;">Espero que a informa√ß√£o pintada seja √∫til.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430118/">https://habr.com/ru/post/pt430118/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430106/index.html">Novo na XYZprinting na IMTS 2018: Rob√¥s e impressoras 3D</a></li>
<li><a href="../pt430108/index.html">Por que "Jovem T√©cnico" n√£o ser√° capaz de construir um laser</a></li>
<li><a href="../pt430112/index.html">Como ensinamos um carro a conversar com milh√µes de pessoas</a></li>
<li><a href="../pt430114/index.html">Como criar mec√¢nica de jogo confi√°vel no Excel. Parte 2</a></li>
<li><a href="../pt430116/index.html">Os computadores escrevem prosa, mas ainda inferiores √†s pessoas. Porque</a></li>
<li><a href="../pt430120/index.html">Domar a fera. O que enfrentamos ao desenvolver um aplicativo de di√°rio pessoal no React Native</a></li>
<li><a href="../pt430122/index.html">O workaholismo √© uma condi√ß√£o dolorosa que n√£o √© habitual falar.</a></li>
<li><a href="../pt430126/index.html">Outra lista de projetos para praticar em</a></li>
<li><a href="../pt430128/index.html">Desenvolvimento atrav√©s de testes: aprimorando habilidades</a></li>
<li><a href="../pt430132/index.html">O que aprendemos sobre a seguran√ßa do Intel ME nos √∫ltimos anos: 7 fatos sobre o misterioso subsistema</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>