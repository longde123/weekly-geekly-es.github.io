<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåÉ ‚ôâÔ∏è üåΩ Fehlertoleranter VoIP-Verkehrsausgleich. Lastwechsel zwischen Rechenzentren zur Spitzenzeit ‚úîÔ∏è üï£ üõÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ein paar Worte dar√ºber, was wir tun. DINS ist an der Entwicklung und Unterst√ºtzung von UCaaS-Diensten auf dem internationalen Markt f√ºr Firmenkunden b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fehlertoleranter VoIP-Verkehrsausgleich. Lastwechsel zwischen Rechenzentren zur Spitzenzeit</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dins/blog/436404/"><p>  Ein paar Worte dar√ºber, was wir tun.  DINS ist an der Entwicklung und Unterst√ºtzung von UCaaS-Diensten auf dem internationalen Markt f√ºr Firmenkunden beteiligt.  Der Service wird sowohl von kleinen Unternehmen als auch von Start-ups und gro√üen Unternehmen genutzt.  Clients stellen √ºber das Internet eine Verbindung √ºber das SIP-Protokoll √ºber TCP, TLS oder WSS her.  Dies f√ºhrt zu einer ziemlich gro√üen Last: Fast 1,5 Millionen Verbindungen von Endger√§ten - Polycom / Cisco / Yealink-Telefone und Soft-Clients f√ºr PC / Mac / IOS / Android. </p><br><p>  In diesem Artikel spreche ich dar√ºber, wie VoIP-Einstiegspunkte angeordnet sind. </p><a name="habracut"></a><br><h3 id="predystoriya">  Hintergrund </h3><br><p>  Am Umfang des Systems (zwischen den Endger√§ten und dem Kernel) befinden sich kommerzielle SBC (Session Border Controller). </p><br><p>  Seit 2012 verwenden wir L√∂sungen von Acme Packet, die sp√§ter von Oracle √ºbernommen wurden.  Vorher haben wir NatPASS verwendet. </p><br><p>  Listen Sie kurz die Funktionen auf, die wir verwenden: </p><br><p>  ‚Ä¢ NAT-Durchquerung; <br>  ‚Ä¢ B2BUA; <br>  ‚Ä¢ SIP-Normalisierung (zul√§ssige / nicht zul√§ssige Header, Regeln zur Manipulation von Headern usw.) <br>  ‚Ä¢ TLS- und SRTP-Offload; <br>  ‚Ä¢ Konvertierung des Transports (innerhalb des Systems verwenden wir SIP √ºber UDP); <br>  ‚Ä¢ MOS-√úberwachung (√ºber RTCP-XR); <br>  ‚Ä¢ ACLs, Bruteforce-Erkennung; <br>  ‚Ä¢ Reduzierter Registrierungsverkehr aufgrund eines erh√∂hten Kontaktablaufs (geringer Ablauf auf der Zugriffsseite, hoher Ablauf auf der Kernseite); <br>  ‚Ä¢ Drosselung der SIP-Nachrichten pro Methode. </p><br><p>  Kommerzielle Systeme haben ihre offensichtlichen Vor- und Nachteile (sofort einsatzbereite Funktionalit√§t, kommerzieller Support) und Nachteile (Preis, Lieferzeit, mangelnde M√∂glichkeiten oder zu lange Fristen f√ºr die Implementierung neuer Funktionen, Fristen f√ºr die L√∂sung von Problemen usw.).  Allm√§hlich √ºberwogen die M√§ngel, und es wurde klar, dass die Notwendigkeit reif war, eigene L√∂sungen zu entwickeln. </p><br><p>  Die Entwicklung wurde vor anderthalb Jahren gestartet.  Im Grenzsubsystem haben wir traditionell zwei Hauptkomponenten unterschieden: SIP- und Medienserver;  Load Balancer √ºber jeder Komponente.  Ich arbeite hier an Einstiegspunkten / Balancern, also werde ich versuchen, dar√ºber zu sprechen. </p><br><h4 id="trebovaniya">  Anforderungen </h4><br><ul><li>  Fehlertoleranz: Das System sollte einen Service bereitstellen, wenn eine oder mehrere Instanzen im Rechenzentrum oder im gesamten Rechenzentrum ausfallen </li><li>  Wartungsfreundlichkeit: Wir m√∂chten Lasten von einem Rechenzentrum in ein anderes umschalten k√∂nnen </li><li>  Skalierbarkeit: Ich m√∂chte die Kapazit√§t schnell und kosteng√ºnstig erh√∂hen </li></ul><br><h4 id="balansirovka">  Ausbalancieren </h4><br><p>  Wir haben IPVS (auch bekannt als LVS) im IPIP-Modus (Traffic Tunneling) ausgew√§hlt.  Ich werde nicht auf eine vergleichende Analyse von NAT / DR / TUN / L3DSR eingehen (Sie k√∂nnen zum Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> √ºber die Modi lesen), ich werde nur die Gr√ºnde erw√§hnen: </p><br><ul><li>  Wir m√∂chten Backends nicht die Anforderung auferlegen, dass sie sich im selben Subnetz wie LVS befinden m√ºssen (Pools enthalten Backends sowohl von unseren eigenen als auch von Remote-Rechenzentren). </li><li>  Das Backend muss die urspr√ºngliche Quell-IP des Clients (oder dessen NAT) erhalten. Mit anderen Worten, Quell-NAT ist nicht geeignet. </li><li>  Das Backend muss die gleichzeitige Arbeit mit mehreren VIPs unterst√ºtzen. </li></ul><br><p>  Wir gleichen den Medienverkehr aus (es stellte sich als sehr schwierig heraus, wir werden ihn ablehnen), daher lautet das aktuelle Bereitstellungsschema im Rechenzentrum wie folgt: <br><br><img src="https://habrastorage.org/webt/fk/vh/wg/fkvhwgftogjrev-a931o3a9qk-e.png"><br><br>  Die derzeitige IPVS-Ausgleichsstrategie lautet ‚Äûsed‚Äú (Shortest Expected Delay), mehr dazu.  Im Gegensatz zu Weighted Round Robin / Weighted Least-Connection k√∂nnen Sie den Datenverkehr erst dann an Backends mit geringerer Gewichtung √ºbertragen, wenn ein bestimmter Schwellenwert erreicht ist.  Die k√ºrzeste erwartete Verz√∂gerung wird nach der Formel (Ci + 1) / Ui berechnet, wobei Ci die Anzahl der Verbindungen im Backend i und Ui das Gewicht des Backends ist.  Wenn sich beispielsweise Backends im Pool mit Gewichten von 50.000 und 2 befinden, werden neue Verbindungen von den ersten verteilt, bis jeder Server 25.000 Verbindungen erreicht oder bis der Schwellenwert erreicht ist - eine Begrenzung der Gesamtzahl der Verbindungen. <br>  Lesen Sie mehr √ºber Ausgleichsstrategien in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">man ipvsadm</a> . </p><br><p>  Der IPVS-Pool sieht folgenderma√üen aus (hier und unten werden fiktive IP-Adressen aufgelistet): </p><br><pre><code class="plaintext hljs"># ipvsadm -ln Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 1.1.1.1:5060 sed -&gt; 10.11.100.181:5060 Tunnel 50000 5903 4 -&gt; 10.11.100.192:5060 Tunnel 50000 5905 1 -&gt; 10.12.100.137:5060 Tunnel 2 0 0 -&gt; 10.12.100.144:5060 Tunnel 2 0 0</code> </pre> <br><p>  Die Last auf dem VIP wird auf Server mit einem Gewicht von 50.000 verteilt (sie werden im selben Rechenzentrum wie eine bestimmte LVS-Instanz bereitgestellt). Wenn sie √ºberlastet sind oder in eine schwarze Liste aufgenommen werden, wird die Last an den Sicherungsteil des Pools gesendet - Server mit einem Gewicht von 2, die sich in befinden benachbartes Rechenzentrum. </p><br><p>  Genau der gleiche Pool, jedoch mit Skalen, wird im benachbarten Rechenzentrum konfiguriert (im Produktionssystem ist die Anzahl der Backends nat√ºrlich viel gr√∂√üer). </p><br><p>  Durch die Synchronisierung von Verbindungen √ºber die IPvs-Synchronisierung kann das Backup-LVS alle aktuellen Verbindungen ermitteln. </p><br><p>  F√ºr die Synchronisation zwischen Rechenzentren wurde eine "schmutzige" Technik angewendet, die dennoch gut funktioniert.  Die IPVS-Synchronisation funktioniert nur √ºber Multicast, was f√ºr uns schwierig war, korrekt an den benachbarten DC zu liefern.  Anstelle von Multicast duplizieren wir den Synchronisationsverkehr √ºber das iptables-Ziel-TEE vom IPvs-Master zum IP-IP-Tunnel zum Server im benachbarten DC. M√∂glicherweise gibt es mehrere Zielhosts / Rechenzentren: </p><br><pre> <code class="plaintext hljs">#### start ipvs sync master role: ipvsadm --start-daemon master --syncid 10 --sync-maxlen 1460 --mcast-interface sync01 --mcast-group 224.0.0.81 --mcast-port 8848 --mcast-ttl 1 #### duplicate all sync packets to remote LVS servers using iptables TEE target: iptables -t mangle -A POSTROUTING -d 224.0.0.81/32 -o sync01 -j TEE --gateway 172.20.21.10 # ip-ip remote lvs server 1 iptables -t mangle -A POSTROUTING -d 224.0.0.81/32 -o sync01 -j TEE --gateway 172.20.21.14 # ip-ip remote lvs server 2 #### start ipvs sync backup role: ipvsadm --start-daemon backup --syncid 10 --sync-maxlen 1460 --mcast-interface sync01 --mcast-group 224.0.0.81 --mcast-port 8848 --mcast-ttl 1 #### be ready to receive sync sync packets from remote LVS servers: iptables -t mangle -A PREROUTING -d 224.0.0.81/32 -i loc02_srv01 -j TEE --gateway 127.0.0.1 iptables -t mangle -A PREROUTING -d 224.0.0.81/32 -i loc02_srv02 -j TEE --gateway 127.0.0.1</code> </pre> <br><p>  Tats√§chlich spielt jeder unserer LVS-Server beide Rollen gleichzeitig (Master &amp; Backup). Dies ist zum einen nur praktisch, da der Rollenwechsel beim Umschalten des Datenverkehrs entf√§llt, zum anderen ist er erforderlich, da jeder DC standardm√§√üig den Datenverkehr seiner Gruppe verarbeitet √∂ffentliche VIPs. </p><br><h4 id="pereklyuchenie-nagruzki-mezhdu-data-centrami">  Lastumschaltung zwischen Rechenzentren </h4><br><p>  Im normalen Betrieb wird jede √∂ffentliche IP-Adresse von √ºberall im Internet angek√ºndigt (in diesem Diagramm von zwei Rechenzentren).  Der in den VIP eintretende Datenverkehr wird mithilfe des BGP-Attributs MED (Multi Exit Discriminator) mit unterschiedlichen Werten f√ºr Active DC und Backup DC an den derzeit ben√∂tigten DC weitergeleitet.  Gleichzeitig ist Backup DC immer bereit, Datenverkehr zu akzeptieren, wenn etwas mit dem aktiven passiert: <br><br><img src="https://habrastorage.org/webt/ir/s6/ht/irs6htkfhrve2zzevsl0cwcg4k4.png"><br><br>  Durch √Ñndern der Werte von BGP-MEDs und Verwendung der standort√ºbergreifenden IPVS-Synchronisierung erhalten wir die M√∂glichkeit, den Datenverkehr nahtlos von den Backends eines Rechenzentrums zu einem anderen zu √ºbertragen, ohne die etablierten Telefonanrufe zu beeintr√§chtigen, die fr√ºher oder sp√§ter auf nat√ºrliche Weise enden werden.  Der Prozess ist vollst√§ndig automatisiert (f√ºr jeden VIP haben wir eine Schaltfl√§che in der Verwaltungskonsole) und sieht folgenderma√üen aus: </p><br><ol><li><p>  SIP-VIP ist in DC1 (links) aktiv, der Cluster in DC2 (rechts) ist redundant, dank IPvs-Synchronisation hat er Informationen √ºber hergestellte Verbindungen in seinem Speicher.  Links werden aktive VIPs mit einem Wert von MED 100 angek√ºndigt, rechts mit einem Wert von 500: <br><br><img src="https://habrastorage.org/webt/v6/di/th/v6dithpguub8rbq7ggurj_vdlxi.png"></p><br></li><li><p>  Die Schaltertaste bewirkt eine √Ñnderung der sogenannten  "Target_state" (ein internes Konzept, das die Werte von BGP-MEDs zu einem bestimmten Zeitpunkt deklariert).  Hier hoffen wir nicht, dass DC1 in Ordnung ist und bereit ist, Verkehr zu verarbeiten, daher tritt LVS in DC2 in den Zustand "aktiv erzwingen" ein, senkt den MED-Wert auf 50 und zieht somit den Verkehr auf sich selbst.  Wenn die Backends in DC1 aktiv und verf√ºgbar sind, werden die Anrufe nicht unterbrochen.  Alle neuen TCP-Verbindungen (Registrierungen) werden an Backends in DC2 gesendet: <br><br><img src="https://habrastorage.org/webt/lx/zo/cb/lxzocb7gt-zzrznicu5k9hiju2k.png"></p><br></li><li><p>  DC1 hat eine neue Replikation target_state erhalten und den Sicherungswert MEDs (500) festgelegt.  Wenn DC2 davon erf√§hrt, normalisiert es seinen Wert (50 =&gt; 100).  Es bleibt zu warten, bis alle aktiven Anrufe in DC1 abgeschlossen sind und die hergestellten TCP-Verbindungen unterbrochen werden.  SBC-Instanzen in DC1 f√ºhren die notwendigen Dienste in die sogenannten ein  Status "Graceful Shutdown": "503" reagiert auf die n√§chsten SIP-Anforderungen und trennt die Verbindung, akzeptiert jedoch keine neuen Verbindungen.  Au√üerdem fallen diese Instanzen in die schwarze Liste von LVS.  Beim Unterbrechen stellt der Client eine neue Registrierung / Verbindung her, die bereits in DC2 enthalten ist: <br><br><img src="https://habrastorage.org/webt/by/rq/uf/byrquf_81kp8zvvryrrjzdtcl-a.png"></p><br></li><li><p>  Der Prozess endet, wenn der gesamte Datenverkehr in DC2 erfolgt. <br><br><img src="https://habrastorage.org/webt/1m/dm/h8/1mdmh8styniixoof0cragfatdqq.png"></p><br></li><li><p>  DC1 und DC2 wechselten die Rollen. <br><br><img src="https://habrastorage.org/webt/wu/t3/ts/wut3ts2mq5iznucnkesz2r3mnra.png"></p><br></li></ol><br><p>  Bei konstant hoher Belastung der Einstiegspunkte erwies es sich als sehr praktisch, den Verkehr jederzeit wechseln zu k√∂nnen.  Der gleiche Mechanismus wird automatisch gestartet, wenn der Backup-DC pl√∂tzlich Datenverkehr empf√§ngt.  Gleichzeitig wird zum Schutz vor Flattern das Umschalten nur einmal in eine Richtung ausgel√∂st und das Schloss auf automatisches Umschalten eingestellt, um es zu entfernen, ist ein menschliches Eingreifen erforderlich. </p><br><h4 id="chto-vnutri">  Was ist drin? </h4><br><p>  VRRP-Cluster &amp; IPVS-Manager: Keepalived.  Keepalived ist verantwortlich f√ºr den VIP-Wechsel innerhalb des Clusters sowie f√ºr das Backend Healthchecking / Blacklisting. </p><br><p>  BGP-Stapel: ExaBGP.  Er ist verantwortlich f√ºr die Ank√ºndigung von Routen zu VIP-Adressen und die Anbringung der entsprechenden BGP-MEDs.  Vollst√§ndig vom Verwaltungsserver gesteuert.  Ein zuverl√§ssiger BGP-Daemon, der in Python geschrieben wurde, entwickelt sich aktiv und erf√ºllt seine Aufgabe zu 100%. </p><br><p>  Verwaltungsserver (API / √úberwachung / Verwaltung von Unterkomponenten): Pyro4 + Flask.  Es ist ein Bereitstellungsserver f√ºr Keepalived und ExaBGP, verwaltet alle anderen Systemeinstellungen (sysctl / iptables / ipset / etc), bietet √úberwachung (gnlpy), f√ºgt Backends auf Anfrage hinzu und entfernt sie (sie kommunizieren mit seiner API). </p><br><h4 id="cifry">  Zahlen </h4><br><p>  Eine virtuelle Maschine mit vier Kernen Intel Xeon Gold 6140 CPU bei 2,30 GHz bedient einen Verkehrsfluss von 300 Mbit / s / 210 Kpps (Medienverkehr, √ºber den in Spitzenzeiten etwa 3.000 gleichzeitige Anrufe verarbeitet werden).  CPU-Auslastung gleichzeitig - 60%. </p><br><p>  Dies reicht jetzt aus, um den Datenverkehr von bis zu 100.000 Endger√§ten (Desktop-Telefonen) zu bedienen.  Um den gesamten Datenverkehr (mehr als 1 Million Endger√§te) zu bedienen, bauen wir in mehreren Rechenzentren etwa 10 Paare solcher Cluster auf. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de436404/">https://habr.com/ru/post/de436404/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de436392/index.html">Vorteile der Analyse von Level 7-Anwendungen in Firewalls. Teil 1. Grundlagen</a></li>
<li><a href="../de436394/index.html">Demis Hassabis - der gro√üe Intellekt, der den gro√üen Intellekt geschaffen hat</a></li>
<li><a href="../de436396/index.html">Kann ich funktionale Programmierung in meiner Sprache verwenden?</a></li>
<li><a href="../de436398/index.html">Wasser</a></li>
<li><a href="../de436400/index.html">Konfigurieren Sie die Entwicklungsumgebung zum Erlernen von HTML, CSS und PHP in Windows</a></li>
<li><a href="../de436406/index.html">Wie man ein Spieleentwickler wird, wenn Sie ein Makler sind</a></li>
<li><a href="../de436408/index.html">Numerische Modellierung - die Geschichte eines Projekts</a></li>
<li><a href="../de436412/index.html">Fototour durch Bostons neues Facebook-B√ºro</a></li>
<li><a href="../de436416/index.html">Migration von Mongo nach Postgres: Das Guardian-Zeitungserlebnis</a></li>
<li><a href="../de436420/index.html">Die gr√∂√üte M√ºllkippe in der Geschichte: 2,7 Milliarden Konten, von denen 773 Millionen einzigartig sind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>