<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Problemas al utilizar la funci贸n NtQuerySystemInformation con argumentos no documentados  じ </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La ma帽ana de ese d铆a comenz贸 con el hecho de que "si" se rompi贸. Esta expresi贸n fue una vez acu帽ada por uno de mis colegas que demostr贸 c贸mo su depura...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Problemas al utilizar la funci贸n NtQuerySystemInformation con argumentos no documentados</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/infopulse/blog/433906/">  La ma帽ana de ese d铆a comenz贸 con el hecho de que "si" se rompi贸.  Esta expresi贸n fue una vez acu帽ada por uno de mis colegas que demostr贸 c贸mo su depurador entra en el bloque if al recorrer el c贸digo, mientras que la condici贸n de que if se verific贸 era exactamente falsa.  El problema en ese momento result贸 ser trivial: utiliz贸 una versi贸n optimizada de lanzamiento y, en este escenario, la confianza en la depuraci贸n paso a paso, por supuesto, es imposible.  Pero la misma expresi贸n "si se rompi贸" se ha arraigado y se ha utilizado aqu铆 desde entonces para indicar una situaci贸n en la que algo tan fundamental dej贸 de funcionar que apenas se cre铆a en 茅l. <br><br>  Entonces, ese d铆a, la funci贸n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NtQuerySystemInformation</a> se descompuso, una de las funciones m谩s importantes del sistema operativo Windows, que devuelve informaci贸n sobre procesos, hilos, descriptores del sistema, etc.  Sobre los beneficios de usar esta funci贸n, una vez escrib铆 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este art铆culo</a> .  Pero result贸 que incluso esas piedras angulares de un sistema a veces pueden fallar. <br><br>  Entonces que paso. <br><a name="habracut"></a><br>  Durante un tiempo bastante largo (durante varios a帽os), utilizamos la llamada a la funci贸n NtQuerySystemInformation con el argumento SystemHandleInformation para obtener informaci贸n sobre todos los descriptores en el sistema.  S铆, este argumento se refiere formalmente a los indocumentados, pero si comienza a buscar informaci贸n sobre c贸mo enumerar todos los descriptores en todas las aplicaciones de Windows que se ejecutan actualmente, la combinaci贸n de NtQuerySystemInformation + SystemHandleInformation ser谩 la opci贸n propuesta con m谩s frecuencia.  Y realmente funciona, en todos los sistemas operativos que comienzan con Windows NT. <br><br>  驴Por qu茅 podr铆a necesitar buscar descriptores en todos los procesos?  Bueno, por varias razones.  Las utilidades como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Process Hacker</a> solo las muestran con fines informativos.  Hay programas que hacen esto para buscar un recurso que actualmente est谩 bloqueado por alguien (por ejemplo, un archivo).  Y puede, por ejemplo, encontrar en un proceso externo un mutex que se utiliza para permitir que solo se ejecute una copia del programa, cerrarlo y permitir que se inicien dos instancias de dicha aplicaci贸n.  O enumere los descriptores para duplicarlos para organizar el entorno limitado.  En general, hay muchas tareas. <br><br>  No dar茅 la descripci贸n completa de la enumeraci贸n del descriptor aqu铆, solo dir茅 que, en general, fue similar a ejemplos comunes, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este</a> : <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((status = NtQuerySystemInformation( SystemHandleInformation, handleInfo, handleInfoSize, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> )) == STATUS_INFO_LENGTH_MISMATCH) handleInfo = (PSYSTEM_HANDLE_INFORMATION)<span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(handleInfo, handleInfoSize *= <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">// NtQuerySystemInformation stopped giving us STATUS_INFO_LENGTH_MISMATCH. if (!NT_SUCCESS(status)) { printf("NtQuerySystemInformation failed!\n"); return 1; } for (i = 0; i &lt; handleInfo-&gt;HandleCount; i++) { ... }</span></span></code> </pre> <br>  Pero luego inicio nuestra aplicaci贸n, y de repente resulta que el descriptor que necesito (隆y estoy seguro de que existe!) No est谩 en la lista devuelta por la funci贸n NtQuerySystemInformation ().  Eso es todo, vinieron: "si est谩 roto". <br><br>  Intentando reproducir el problema en otras computadoras en la oficina.  En algunos se reproduce, en la mayor铆a, no.  Estamos tratando de entender c贸mo aquellos en los que se reproduce difieren de aquellos en los que todo es bueno.  La versi贸n de Windows es la misma en todas partes, las actualizaciones, la construcci贸n de nuestro programa: todo es id茅ntico.  De repente, alguien se da cuenta de que todas las computadoras port谩tiles en las que se reprodujo el problema son del mismo modelo.  Incompatibilidad de hardware?  Pero por qu茅 de repente ahora, sol铆a funcionar ... Adem谩s, hay otras computadoras port谩tiles del mismo modelo en la oficina que funcionan ahora.  Incluso se compararon las versiones de los controladores de dispositivos: todo parece ser el mismo.  Pero todo funciona en algunas computadoras port谩tiles, pero no en otras. <br><br>  Tirar del cabello en la cabeza dur贸 aproximadamente medio d铆a, hasta que accidentalmente not茅 dos cosas: <br><br><ol><li>  Los PID de proceso, que generalmente son n煤meros de tres, cuatro o cinco d铆gitos en mi computadora por alguna raz贸n, se han convertido en seis d铆gitos.  Era bastante extra帽o ver un PID del tipo 780936. No los hab铆a notado antes.  Adem谩s, el n煤mero total de procesos en ejecuci贸n fue bastante adecuado (hasta cien). </li><li>  El administrador de tareas en la pesta帽a CPU mostr贸 el n煤mero total de descriptores en el sistema, y fue enorme, m谩s de 800,000. </li></ol><br>  Para una aplicaci贸n normal, es normal abrir cien o dos descriptores.  Pues mil.  Con el uso activo, Chrome puede abrir aproximadamente 2000, Visual Studio puede abrir 3000 en proyectos grandes, pero 驴qui茅n abri贸 800 000?  Afortunadamente, el Process Hacker mencionado anteriormente le permite mostrar la cantidad de descriptores para cada proceso e incluso ordenar la lista de procesos por la cantidad de descriptores utilizados. <br><br>  Y que vemos  Y vemos algo como esta imagen: <br><br><img src="https://habrastorage.org/webt/yz/zi/vt/yzzivtoy8-an-odiloby55oherc.png"><br><br>  Debo decir que acabo de hacer la captura de pantalla anterior, por lo que el primero en la lista de procesos tiene "solo" unos 20,000 descriptores.  Y luego, cuando vi el problema por primera vez, hab铆a unos 650,000 all铆. 驴Y qui茅n es nuestro h茅roe?  Bingo!  Este es el proceso SynTPEnhService.exe. <br><br>  Y luego todo el rompecabezas se desarrolla en mi cabeza.  SynTPEnhService.exe es parte del controlador del panel t谩ctil Synaptics.  Se instal贸 solo en computadoras port谩tiles de cierto modelo en nuestra oficina, en las que ocurri贸 el problema.  Una breve observaci贸n mostr贸 que cada 5 segundos este proceso inicia el proceso secundario SynTPEnh.exe, que se cierra despu茅s de 1-2 segundos.  Al mismo tiempo, el proceso padre contin煤a manteniendo el descriptor del proceso hijo, lo que conduce a la fuga de descriptores.  Uno a la vez cada 5 segundos.  Esto es 17.280 descriptores por d铆a.  Deje la computadora encendida durante una semana y ahora tiene m谩s de cien mil descriptores de bloqueo.  Mi computadora personal no se reinici贸 durante m谩s de un mes, de ah铆 los PID de los nuevos procesos con n煤meros superiores a medio mill贸n.  Esto tambi茅n explica por qu茅 el problema se reprodujo en algunas computadoras port谩tiles en nuestra oficina, pero no ocurri贸 en otras computadoras port谩tiles: algunos de mis colegas reiniciaron sus computadoras todos los d铆as, y alguien, como yo, las dej贸 encendidas durante la noche. . <br><br>  Por cierto, en este lugar record茅 que ya hab铆a le铆do sobre alg煤n tipo de problema con los controladores del panel t谩ctil Synaptics.  Despu茅s de un poco de investigaci贸n, encontr茅 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este art铆culo</a> escrito por Bruce Dawson (muchas traducciones de sus art铆culos fueron publicadas en diferentes momentos en Habr茅, pero no esta espec铆fica).  All铆 describe el problema de p茅rdida de memoria debido a este reinicio sin fin del proceso SynTPEnh.exe, pero no dice nada sobre el problema de p茅rdida de identificador, por lo que mi hallazgo sigue siendo diferente. <br><br><h3>  Resoluci贸n de problemas </h3><br>  Entonces, el controlador del panel t谩ctil "come" cientos de miles de descriptores, 驴y qu茅?  Y el hecho de que la funci贸n NtQuerySystemInformation (SystemHandleInformation, ...) escrita en los d铆as de Windows NT ten铆a (y tiene) un b煤fer interno bastante limitado.  No pude encontrar una indicaci贸n exacta de su tama帽o en ning煤n lado, pero, obviamente, no fue dise帽ado para un mill贸n de descriptores.  Como resultado, la funci贸n los devuelve "tanto como pueden", lo que significa que entre ellos puede o no ser el deseado. <br><br>  Que hacer  Como Rick de la serie animada "Rick and Morty" dijo: "Cuando inventas la teletransportaci贸n, inmediatamente descubres algo desagradable: eres la 煤ltima persona en el universo que lo invent贸".  Al final result贸 que, Microsoft se dio cuenta de este problema con el b煤fer limitado en NtQuerySystemInformation cuando lo llam贸 con el argumento SystemHandleInformation hace 20 a帽os, y por lo tanto, a partir de WindowsXP, agregaron la funci贸n NtQuerySystemInformation otro argumento (y tambi茅n indocumentado) SystemExtendedHandleInformation.  Cuando llame a NtQuerySystemInformation (SystemExtendedHandleInformation, ...), se le devolver谩n todos los descriptores del sistema, sin importar cu谩ntos haya.  Bueno, o m谩s bien, no lo s茅 con certeza, tal vez hay algunas restricciones para este argumento, pero es seguro que puede devolver 800,000 descriptores en un estado. <br><br>  En la red puede encontrar ejemplos del uso de SystemExtendedHandleInformation, por ejemplo, <a href="">este</a> .  En general, todo es similar all铆, simplemente se usan otras estructuras, y eso es todo. <br><br>  Fue una historia instructiva sobre el uso de argumentos no documentados del sistema operativo Widnows, que puede ser muy 煤til, pero requiere pruebas cuidadosas y preparaci贸n para problemas no est谩ndar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433906/">https://habr.com/ru/post/es433906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433896/index.html">Usar el aprendizaje autom谩tico no es dif铆cil. Suficiente para esto por una semana ...</a></li>
<li><a href="../es433898/index.html">Digest MBLT DEV :: Issue No. 200</a></li>
<li><a href="../es433900/index.html">ICQ est谩 muerto. Larga vida a ICQ?</a></li>
<li><a href="../es433902/index.html">Repetici贸n para un programador: por qu茅 es importante resolver problemas similares</a></li>
<li><a href="../es433904/index.html">Jira DataCenter: 驴qu茅 es? Como funciona 驴C贸mo desplegar?</a></li>
<li><a href="../es433908/index.html">Tetris en C # en 100 l铆neas</a></li>
<li><a href="../es433910/index.html">Reflexiones sobre Rust 2019</a></li>
<li><a href="../es433912/index.html">驴Quieres atraer a los mejores ingenieros? C贸digo abierto</a></li>
<li><a href="../es433916/index.html">Ve comunidad en Kazan y nuestras reuniones</a></li>
<li><a href="../es433918/index.html">驴Por qu茅 la web es tan complicada?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>