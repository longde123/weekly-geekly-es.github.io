<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧓🏻 🏇🏾 💖 Problemas al utilizar la función NtQuerySystemInformation con argumentos no documentados 🛕 🤸🏾 😅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La mañana de ese día comenzó con el hecho de que "si" se rompió. Esta expresión fue una vez acuñada por uno de mis colegas que demostró cómo su depura...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Problemas al utilizar la función NtQuerySystemInformation con argumentos no documentados</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/infopulse/blog/433906/">  La mañana de ese día comenzó con el hecho de que "si" se rompió.  Esta expresión fue una vez acuñada por uno de mis colegas que demostró cómo su depurador entra en el bloque if al recorrer el código, mientras que la condición de que if se verificó era exactamente falsa.  El problema en ese momento resultó ser trivial: utilizó una versión optimizada de lanzamiento y, en este escenario, la confianza en la depuración paso a paso, por supuesto, es imposible.  Pero la misma expresión "si se rompió" se ha arraigado y se ha utilizado aquí desde entonces para indicar una situación en la que algo tan fundamental dejó de funcionar que apenas se creía en él. <br><br>  Entonces, ese día, la función <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NtQuerySystemInformation</a> se descompuso, una de las funciones más importantes del sistema operativo Windows, que devuelve información sobre procesos, hilos, descriptores del sistema, etc.  Sobre los beneficios de usar esta función, una vez escribí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este artículo</a> .  Pero resultó que incluso esas piedras angulares de un sistema a veces pueden fallar. <br><br>  Entonces que paso. <br><a name="habracut"></a><br>  Durante un tiempo bastante largo (durante varios años), utilizamos la llamada a la función NtQuerySystemInformation con el argumento SystemHandleInformation para obtener información sobre todos los descriptores en el sistema.  Sí, este argumento se refiere formalmente a los indocumentados, pero si comienza a buscar información sobre cómo enumerar todos los descriptores en todas las aplicaciones de Windows que se ejecutan actualmente, la combinación de NtQuerySystemInformation + SystemHandleInformation será la opción propuesta con más frecuencia.  Y realmente funciona, en todos los sistemas operativos que comienzan con Windows NT. <br><br>  ¿Por qué podría necesitar buscar descriptores en todos los procesos?  Bueno, por varias razones.  Las utilidades como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Process Hacker</a> solo las muestran con fines informativos.  Hay programas que hacen esto para buscar un recurso que actualmente está bloqueado por alguien (por ejemplo, un archivo).  Y puede, por ejemplo, encontrar en un proceso externo un mutex que se utiliza para permitir que solo se ejecute una copia del programa, cerrarlo y permitir que se inicien dos instancias de dicha aplicación.  O enumere los descriptores para duplicarlos para organizar el entorno limitado.  En general, hay muchas tareas. <br><br>  No daré la descripción completa de la enumeración del descriptor aquí, solo diré que, en general, fue similar a ejemplos comunes, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este</a> : <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((status = NtQuerySystemInformation( SystemHandleInformation, handleInfo, handleInfoSize, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> )) == STATUS_INFO_LENGTH_MISMATCH) handleInfo = (PSYSTEM_HANDLE_INFORMATION)<span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(handleInfo, handleInfoSize *= <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">// NtQuerySystemInformation stopped giving us STATUS_INFO_LENGTH_MISMATCH. if (!NT_SUCCESS(status)) { printf("NtQuerySystemInformation failed!\n"); return 1; } for (i = 0; i &lt; handleInfo-&gt;HandleCount; i++) { ... }</span></span></code> </pre> <br>  Pero luego inicio nuestra aplicación, y de repente resulta que el descriptor que necesito (¡y estoy seguro de que existe!) No está en la lista devuelta por la función NtQuerySystemInformation ().  Eso es todo, vinieron: "si está roto". <br><br>  Intentando reproducir el problema en otras computadoras en la oficina.  En algunos se reproduce, en la mayoría, no.  Estamos tratando de entender cómo aquellos en los que se reproduce difieren de aquellos en los que todo es bueno.  La versión de Windows es la misma en todas partes, las actualizaciones, la construcción de nuestro programa: todo es idéntico.  De repente, alguien se da cuenta de que todas las computadoras portátiles en las que se reprodujo el problema son del mismo modelo.  Incompatibilidad de hardware?  Pero por qué de repente ahora, solía funcionar ... Además, hay otras computadoras portátiles del mismo modelo en la oficina que funcionan ahora.  Incluso se compararon las versiones de los controladores de dispositivos: todo parece ser el mismo.  Pero todo funciona en algunas computadoras portátiles, pero no en otras. <br><br>  Tirar del cabello en la cabeza duró aproximadamente medio día, hasta que accidentalmente noté dos cosas: <br><br><ol><li>  Los PID de proceso, que generalmente son números de tres, cuatro o cinco dígitos en mi computadora por alguna razón, se han convertido en seis dígitos.  Era bastante extraño ver un PID del tipo 780936. No los había notado antes.  Además, el número total de procesos en ejecución fue bastante adecuado (hasta cien). </li><li>  El administrador de tareas en la pestaña CPU mostró el número total de descriptores en el sistema, y ​​fue enorme, más de 800,000. </li></ol><br>  Para una aplicación normal, es normal abrir cien o dos descriptores.  Pues mil.  Con el uso activo, Chrome puede abrir aproximadamente 2000, Visual Studio puede abrir 3000 en proyectos grandes, pero ¿quién abrió 800 000?  Afortunadamente, el Process Hacker mencionado anteriormente le permite mostrar la cantidad de descriptores para cada proceso e incluso ordenar la lista de procesos por la cantidad de descriptores utilizados. <br><br>  Y que vemos  Y vemos algo como esta imagen: <br><br><img src="https://habrastorage.org/webt/yz/zi/vt/yzzivtoy8-an-odiloby55oherc.png"><br><br>  Debo decir que acabo de hacer la captura de pantalla anterior, por lo que el primero en la lista de procesos tiene "solo" unos 20,000 descriptores.  Y luego, cuando vi el problema por primera vez, había unos 650,000 allí. ¿Y quién es nuestro héroe?  Bingo!  Este es el proceso SynTPEnhService.exe. <br><br>  Y luego todo el rompecabezas se desarrolla en mi cabeza.  SynTPEnhService.exe es parte del controlador del panel táctil Synaptics.  Se instaló solo en computadoras portátiles de cierto modelo en nuestra oficina, en las que ocurrió el problema.  Una breve observación mostró que cada 5 segundos este proceso inicia el proceso secundario SynTPEnh.exe, que se cierra después de 1-2 segundos.  Al mismo tiempo, el proceso padre continúa manteniendo el descriptor del proceso hijo, lo que conduce a la fuga de descriptores.  Uno a la vez cada 5 segundos.  Esto es 17.280 descriptores por día.  Deje la computadora encendida durante una semana y ahora tiene más de cien mil descriptores de bloqueo.  Mi computadora personal no se reinició durante más de un mes, de ahí los PID de los nuevos procesos con números superiores a medio millón.  Esto también explica por qué el problema se reprodujo en algunas computadoras portátiles en nuestra oficina, pero no ocurrió en otras computadoras portátiles: algunos de mis colegas reiniciaron sus computadoras todos los días, y alguien, como yo, las dejó encendidas durante la noche. . <br><br>  Por cierto, en este lugar recordé que ya había leído sobre algún tipo de problema con los controladores del panel táctil Synaptics.  Después de un poco de investigación, encontré <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este artículo</a> escrito por Bruce Dawson (muchas traducciones de sus artículos fueron publicadas en diferentes momentos en Habré, pero no esta específica).  Allí describe el problema de pérdida de memoria debido a este reinicio sin fin del proceso SynTPEnh.exe, pero no dice nada sobre el problema de pérdida de identificador, por lo que mi hallazgo sigue siendo diferente. <br><br><h3>  Resolución de problemas </h3><br>  Entonces, el controlador del panel táctil "come" cientos de miles de descriptores, ¿y qué?  Y el hecho de que la función NtQuerySystemInformation (SystemHandleInformation, ...) escrita en los días de Windows NT tenía (y tiene) un búfer interno bastante limitado.  No pude encontrar una indicación exacta de su tamaño en ningún lado, pero, obviamente, no fue diseñado para un millón de descriptores.  Como resultado, la función los devuelve "tanto como pueden", lo que significa que entre ellos puede o no ser el deseado. <br><br>  Que hacer  Como Rick de la serie animada "Rick and Morty" dijo: "Cuando inventas la teletransportación, inmediatamente descubres algo desagradable: eres la última persona en el universo que lo inventó".  Al final resultó que, Microsoft se dio cuenta de este problema con el búfer limitado en NtQuerySystemInformation cuando lo llamó con el argumento SystemHandleInformation hace 20 años, y por lo tanto, a partir de WindowsXP, agregaron la función NtQuerySystemInformation otro argumento (y también indocumentado) SystemExtendedHandleInformation.  Cuando llame a NtQuerySystemInformation (SystemExtendedHandleInformation, ...), se le devolverán todos los descriptores del sistema, sin importar cuántos haya.  Bueno, o más bien, no lo sé con certeza, tal vez hay algunas restricciones para este argumento, pero es seguro que puede devolver 800,000 descriptores en un estado. <br><br>  En la red puede encontrar ejemplos del uso de SystemExtendedHandleInformation, por ejemplo, <a href="">este</a> .  En general, todo es similar allí, simplemente se usan otras estructuras, y eso es todo. <br><br>  Fue una historia instructiva sobre el uso de argumentos no documentados del sistema operativo Widnows, que puede ser muy útil, pero requiere pruebas cuidadosas y preparación para problemas no estándar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433906/">https://habr.com/ru/post/es433906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433896/index.html">Usar el aprendizaje automático no es difícil. Suficiente para esto por una semana ...</a></li>
<li><a href="../es433898/index.html">Digest MBLT DEV :: Issue No. 200</a></li>
<li><a href="../es433900/index.html">ICQ está muerto. Larga vida a ICQ?</a></li>
<li><a href="../es433902/index.html">Repetición para un programador: por qué es importante resolver problemas similares</a></li>
<li><a href="../es433904/index.html">Jira DataCenter: ¿qué es? Como funciona ¿Cómo desplegar?</a></li>
<li><a href="../es433908/index.html">Tetris en C # en 100 líneas</a></li>
<li><a href="../es433910/index.html">Reflexiones sobre Rust 2019</a></li>
<li><a href="../es433912/index.html">¿Quieres atraer a los mejores ingenieros? Código abierto</a></li>
<li><a href="../es433916/index.html">Ve comunidad en Kazan y nuestras reuniones</a></li>
<li><a href="../es433918/index.html">¿Por qué la web es tan complicada?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>