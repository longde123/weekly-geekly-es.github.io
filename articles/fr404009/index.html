<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😟 👩🏿‍🤝‍👨🏽 👩🏿‍🍳 Nous contrôlons la maison via Telegram 🏳️‍🌈 🤵🏿 💡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Actuellement, les systèmes de commande domotique intelligents sont de plus en plus populaires. Une interface centralisée qui contrôle les appareils da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous contrôlons la maison via Telegram</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/404009/"><p>  Actuellement, les systèmes de commande domotique intelligents sont de plus en plus populaires.  Une interface centralisée qui contrôle les appareils dans toute la maison vous fait gagner du temps et vous permet de contrôler plus efficacement votre maison.  La réalisation de leur vision de tels systèmes est réalisée par d'éminentes marques: Apple, Amazon et Google, qui les intègrent dans leur infrastructure, ainsi que des artisans qui assemblent ces systèmes sur la base de la plate-forme Arduino. </p><br><p>  Notre objectif était le suivant: créer un système qui sera disponible sur un grand nombre d'appareils et qui ne sera lié à aucun endroit.  Une excellente option pour implémenter le contrôle s'est avérée être un bot pour le messager Telegram.  Telegram a des applications sur toutes les principales plates-formes, ainsi qu'une version Web.  Vous pouvez y accéder de n'importe où, il vous suffit d'avoir un compte. </p><br><p>  Parmi les modules, nous avons sélectionné les éléments suivants: </p><br><p>  • Bande LED contrôlée RGB <br>  • Point de vente géré <br>  • capteur de température <br>  • Capteur de lumière (il est utilisé pour allumer automatiquement la lumière) </p><a name="habracut"></a><br><h3>  De quoi avons-nous besoin </h3><br><h4>  1. Raspberry Pi 3 </h4><br><p>  Un ordinateur petit mais distant qui n'a pas besoin d'être présenté, sa puissance nous suffira pour faire ces tâches.  La troisième version est bonne avec un module Wi-Fi intégré, nous n'avons donc pas à penser à un adaptateur tiers. </p><br><h4>  2. Modules ESP8266 </h4><br><p>  Nous en aurons besoin de 4.  Nous avons utilisé l'ESP-12F, mais en général il n'y a pas de différence: l'ESP-1 suffira amplement.  De plus, les cartes NodeMCU prêtes à l'emploi peuvent vous faire gagner du temps et des efforts. </p><br><h4>  3. Bande LED </h4><br><p>  Nous avons pris une bande RVB gérée sur les contrôleurs WS2812b, bien que, soit dit en passant, toute bande fonctionnant sur 5 V et prise en charge par la plate-forme Arduino convient ici. </p><br><h4>  4. Capteurs de température et de lumière </h4><br><p>  Nous avons utilisé le module BH1750 pour déterminer l'éclairage de la pièce et le DS18B20 pour la température.  Les principaux critères étaient la disponibilité, la prise en charge par la plate-forme Arduino et la capacité de travailler avec la logique 3.3V ESP8266. </p><br><h4>  5. Relais </h4><br><p>  Le sous-module MOD-1CH pour Arduino peut passer jusqu'à 10A de courant et est contrôlé par 5V, nous n'avons pas trouvé d'analogues pour 3,3V, nous avons donc utilisé un transistor en mode clé pour le contrôle. </p><br><h4>  6. Bot télégramme </h4><br><p>  Le contrôle direct de l'ensemble du système sera effectué à l'aide du bot Telegram, lancé sur Raspberry: cela permettra au système d'être facilement accessible sur n'importe quelle plate-forme de n'importe où dans le monde.  La création d'un bot pour Telegram est assez simple, grâce à une plate-forme développée et à la prise en charge d'un grand nombre de langues. </p><br><p>  Ainsi, l'ensemble de notre système ressemblera à ceci: </p><br><p><img src="https://habrastorage.org/web/060/7b9/0b6/0607b90b6cd44144aa5e28641bc3e156.png" alt="image"></p><br><h3>  Implémentation </h3><br><p>  Tout d'abord, nous testons les modules. </p><br><p><img src="https://habrastorage.org/web/c2e/093/5de/c2e0935de6ad4b5dacda3e494e645eef.jpg" alt="image"></p><br><p>  Les circuits imprimés prêts à l'emploi adaptent la distance entre les broches, ce qui facilite grandement le soudage, et contiennent également les résistances nécessaires reliant les broches CH_PD et GPIO2 à Vcc. </p><br><p>  Malheureusement, les modules ESP8266 sont alimentés et fonctionnent à 3,3 V, et non à 5, comme l'Arduino.  Vous pouvez convertir la tension à l'aide d'un module convertisseur prêt à l'emploi, mais vous pouvez également souder le circuit basé sur le stabilisateur linéaire AMS1117, comme nous l'avons fait. </p><br><p><img src="https://habrastorage.org/web/171/88e/b51/17188eb517dd4ae7a781aae753d4df42.png" alt="image"></p><br><p>  La prochaine étape est la programmation. </p><br><p>  Heureusement, la plate-forme ESP8266 est prise en charge par l'IDE Arduino, ce qui nous ouvre de nombreuses possibilités.  Pour télécharger directement le firmware sur le module, nous utiliserons l'Arduino Nano, cependant, la même chose peut être effectuée via le convertisseur USB-UART habituel.  N'oubliez pas la différence de tension entre Arduino et ESP. </p><br><p>  Le schéma est le suivant: </p><br><p><img src="https://habrastorage.org/web/47d/caa/be9/47dcaabe9a06464aa8e9d4d1e35ca479.png" alt="image"></p><br><p>  Le bouton est nécessaire pour fermer la broche GPIO1 à GND lors de l'alimentation du module et, par conséquent, le transférer en mode de programmation. </p><br><p>  Ensuite, nous configurons l'IDE Arduino pour qu'il comprenne l'ESP ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions détaillées avec tous les liens</a> ) et essayons d'enregistrer un croquis de test pour le clignotement de la LED. </p><br><p><img src="https://habrastorage.org/web/b88/94a/65a/b8894a65aa6143e0be334ea8e7468ad3.jpg" alt="image"></p><br><p>  Après un clignotement réussi, nous avons commencé à souder tous les modules.  Avec un capteur de température et de lumière, tout est assez standard. </p><br><p>  Température: </p><br><p><img src="https://habrastorage.org/web/e7a/4a7/d03/e7a4a7d03d4e4c46b1af02d0f3e6a97e.png" alt="image"></p><br><p><img src="https://habrastorage.org/web/3ce/cbe/5fa/3cecbe5fadd144208d47b42f4b55f88d.jpg" alt="image"></p><br><p>  Éclairage: </p><br><p><img src="https://habrastorage.org/web/1ec/4db/505/1ec4db505e254635a6dfcc0e8c1f65ab.png" alt="image"></p><br><p><img src="https://habrastorage.org/web/5a6/5bf/202/5a65bf202e0c4f698282a5554221130e.jpg" alt="image"></p><br><p>  Mais la bande et la prise intelligente ont causé quelques difficultés. </p><br><p>  Une simple connexion de l'entrée de contrôle de la bande à l'ESP a échoué.  Ce n'est pas surprenant, car WS2812b nécessite au moins 70% de l'entrée VCC (5x0,7 = 3,5) pour l'entrée de commande, et une carte 3,3 V n'est clairement pas suffisante.  Cependant, nous avons trouvé <del>  béquille </del>  Une façon intéressante de les démarrer sans utiliser de convertisseur boost.  Si la diode nécessite un minimum de 0,7xVcc pour réagir au signal et que nous ne pouvons pas augmenter le niveau de ce signal, alors Vcc doit être réduit!  Oui, les LED ne s'allumeront pas si brillamment, cependant, nous n'avons pas besoin d'alimenter la bande entière de cette façon;  une diode suffit.  En transmettant le signal plus loin le long de la chaîne, la LED utilise déjà le niveau Vcc pour former le signal, ce qui est suffisant pour une LED «normale».  Ainsi, en connectant la première diode de la bande à l'alimentation via la diode, qui "consomme" environ 0,6 V, nous obtenons une bande parfaitement fonctionnelle directement contrôlée à partir de notre module ESP8266.  Et nous avons laissé la première LED légèrement plus faible pour les besoins de débogage: afficher l'état de la connexion réseau. </p><br><p>  Voici ce qui s'est passé: </p><br><p><img src="https://habrastorage.org/web/6ea/eba/f9e/6eaebaf9e0c741a7ab938a97318d5d25.png" alt="image"></p><br><p><img src="https://habrastorage.org/web/2c9/cb1/baa/2c9cb1baac0c41ea90c0ceeba0c252ea.jpg" alt="image"></p><br><p>  Nous voulions placer complètement notre prise intelligente dans le boîtier de l'ancienne prise avec une minuterie.  Il fallait qu'ils y entrent: l'ESP-12F lui-même, une alimentation électrique et un relais contrôlant la prise.  Cependant, ayant placé le relais et l'alimentation électrique là-bas, nous ne pouvions toujours pas y accueillir le module ESP.  Par conséquent, j'ai dû attacher une petite boîte ci-dessous. </p><br><p><img src="https://habrastorage.org/web/ed7/0d9/1fe/ed70d91fe74945818d27cfc476ed0305.jpg" alt="image"></p><br><p>  Le résultat n'était pas aussi élégant que nous le voulions à l'origine, mais c'était un appareil solide qui devait simplement être branché sur une prise de courant. </p><br><p><img src="https://habrastorage.org/web/476/4bc/f54/4764bcf5488b400b9b0b1d3dd25b428a.png" alt="image"></p><br><p><img src="https://habrastorage.org/web/b63/79f/683/b6379f6833c34e4f8e04f5a974a5ec96.jpg" alt="image"></p><br><p>  L'étape suivante consistait à configurer Raspberry.  Le plan était le suivant: nos modules se connectent au point d'accès Wi-Fi, qui est Raspberry, et, plus précisément, à son module Wi-Fi intégré.  Raspberry exécute Telegram-bot, qui se trouve avec tous les modules sur le réseau local et peut facilement échanger des requêtes http avec eux.  Tout est connecté à Internet via Ethernet. </p><br><p>  Pour implémenter ce plan, nous avons utilisé deux packages: </p><br><ul><li>  hostapd - vous permet d'utiliser le module wi-fi intégré comme point d'accès </li><li>  dnsmasq - combine les serveurs DHCP et DNS. </li></ul><br><p>  Nous avons essayé d'obtenir une relative indépendance du code et des périphériques, par conséquent, toutes les requêtes ont été exécutées non pas vers des adresses IP, mais vers des noms de la zone .sh inventée (light.sh, socket.sh, etc.).  Pour ce faire, nous avons configuré des adresses IP statiques pour chaque module et ajouté des enregistrements correspondant aux modules à ces adresses DNS.  Heureusement, dnsmasq est très facile à configurer ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions détaillées pour configurer ce système</a> ). </p><br><p>  Et enfin, le bot lui-même. </p><br><p>  Nous avons écrit un bot en Python en utilisant la bibliothèque python-telegram-bot.  Nous avons développé une interface à boutons, qui simplifie la gestion, transformant l'appareil en une sorte de télécommande: </p><br><p><img src="https://habrastorage.org/web/5c1/14e/04c/5c114e04c8f84c209cbdb34a2e4e4301.png" alt="image"></p><br><p><img src="https://habrastorage.org/web/07a/b0f/d39/07ab0fd391324935afccf4632226702f.png" alt="image"></p><br><p>  Le code source du bot peut être trouvé <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Et pour que personne ne puisse l'utiliser, nous avons défini la protection par mot de passe. </p><br><h3 id="vyvod">  Conclusion </h3><br><p>  Bien sûr, nous n'avons créé aucun système révolutionnaire; il existe un grand nombre d'implémentations plus holistiques et réfléchies.  Les modules de température et d'éclairage pourraient être rendus autonomes, car l'ESP8266 dispose d'un mode veille spécial dans lequel il consomme très peu d'énergie.  On pourrait ajouter une extensibilité utilisateur facile, qui ne nécessite pas de changer le code source et de reconfigurer les connexions réseau, et bien plus encore.  Cependant, l'objectif de tout ce projet n'était pas du tout cela.  Tout d'abord, nous voulions créer un système simple qui pourrait bien être créé par n'importe qui dans notre maison et ne nécessiterait pas de préparation et de coûts sérieux.  Et le plus important: nous voulions apprendre beaucoup de choses pendant que nous faisions ce projet.  Et si le caractère pratique et la fonctionnalité de notre solution peuvent être développés pendant longtemps, alors les connaissances que nous avons acquises dans le processus de planification et de mise en œuvre de ce système en valaient vraiment la peine. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr404009/">https://habr.com/ru/post/fr404009/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr403997/index.html">Ensemble jeune biohacker</a></li>
<li><a href="../fr403999/index.html">Culte du fret pour l'IA: le mythe de l'intelligence artificielle surhumaine</a></li>
<li><a href="../fr404003/index.html">Chimie du monde informatique</a></li>
<li><a href="../fr404005/index.html">Petite bobine, oui cher: écouteurs intra-auriculaires Fostex</a></li>
<li><a href="../fr404007/index.html">GPD Win - explorer un ordinateur portable miniature avec une diagonale de 5,5 ", conçu pour les jeux et les émulateurs</a></li>
<li><a href="../fr404011/index.html">Économies de sang: un nouveau système de livraison de biomatériaux de laboratoire a été développé</a></li>
<li><a href="../fr404015/index.html">Pourquoi aller mieux</a></li>
<li><a href="../fr404017/index.html">126 $ en 5 minutes: comment utiliser la différence de prix entre les pays et les spécialistes du marketing</a></li>
<li><a href="../fr404019/index.html">Likbez sur Kryonika: en langage simple sur un sujet complexe</a></li>
<li><a href="../fr404021/index.html">Le bunker de Doomsday en Norvège inondé de millions de graines archivées en raison de la fonte du pergélisol</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>