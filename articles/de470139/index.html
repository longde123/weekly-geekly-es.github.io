<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📽️ 🤦🏽 👍 2 Life Hacks: Alternativen zur klassischen Suche in Microsoft SQL Server 👩🏾‍🚒 ⁉️ 👉🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Unsere Freunde von Softpoint haben einen interessanten Artikel über Microsoft SQL Server vorbereitet. Es werden zwei praktische Beispiele ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>2 Life Hacks: Alternativen zur klassischen Suche in Microsoft SQL Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/470139/">  Hallo Habr!  Unsere Freunde von Softpoint haben einen interessanten Artikel über Microsoft SQL Server vorbereitet.  Es werden zwei praktische Beispiele für die Verwendung der Volltextsuche analysiert: <br><br><ul><li>  Suchen Sie in „unendlichen“ Zeilen (z. B. Kommentare) im Gegensatz zu einer regulären Suche in LIKE. </li><li>  Suche nach Dokumentennummern mit Präfixen.  Wo normalerweise die Volltextsuche nicht verwendet werden kann: Konstante Präfixe stören sie.  Es werden zwei Ansätze analysiert: Vorverarbeitung der Dokumentennummer und Hinzufügen eines eigenen Bibliothekswortbrechers. </li></ul><br>  Jetzt mitmachen! <br><br><img src="https://habrastorage.org/webt/cj/iu/to/cjiutotj7eknpw4cyapmoqw3yys.png"><a name="habracut"></a><br><br>  <i>Ich gebe dem Autor das Wort</i> <br><br>  Eine effektive Suche in Gigabyte gesammelter Daten ist eine Art „heiliger Gral“ von Buchhaltungssystemen.  Jeder möchte ihn finden und unsterblichen Ruhm erlangen, aber bei der Suche immer wieder stellt sich heraus, dass es keine einzige wundersame Lösung gibt. <br><br>  Die Situation wird durch die Tatsache kompliziert, dass Benutzer normalerweise nach einem Teilstring suchen möchten - irgendwo stellt sich heraus, dass die gewünschte Vertragsnummer in der Mitte des Kommentars "vergraben" ist;  irgendwo erinnert sich der Betreiber nicht genau an den Namen des Kunden, aber er erinnerte sich, dass sein Name „Alexey Evgrafovich“ war;  Irgendwo müssen Sie nur die wiederkehrende Eigentumsform von BYUBL weglassen und sofort nach dem Namen der Organisation suchen.  Für klassische relationale DBMS ist eine solche Suche eine sehr schlechte Nachricht.  Am häufigsten wird eine solche Teilstringsuche auf das methodische Scrollen jeder Zeile der Tabelle reduziert.  Nicht die effektivste Strategie, insbesondere wenn die Größe der Tabelle auf mehrere zehn Gigabyte ansteigt. <br><br>  Auf der Suche nach einer Alternative erinnere ich mich oft an die „Volltextsuche“.  Die Freude, eine Lösung zu finden, vergeht normalerweise schnell nach einer flüchtigen Überprüfung der bestehenden Praxis.  Es stellt sich schnell heraus, dass nach allgemeiner Meinung die Volltextsuche: <br><br><ul><li>  Schwer zu konfigurieren </li><li>  Langsam aktualisiert </li><li>  Hängt das System beim Update auf </li><li> Hat eine <s>dumme</s> ungewöhnliche Syntax </li><li>  Findet nicht, was sie fragen </li></ul><br>  Die Mythen können noch lange fortgesetzt werden, aber selbst Platon hat uns gelehrt, Skeptiker zu sein und die Meinung eines anderen zum Glauben nicht blind zu akzeptieren.  Mal sehen, ob der Teufel so schrecklich ist, wie er gemalt wird? <br><br>  Und obwohl wir nicht tief in die Studie vertieft sind, werden wir uns <b>sofort auf eine wichtige Bedingung einigen</b> .  Die Volltextsuchmaschine kann viel mehr als eine normale Zeichenfolgensuche.  Sie können beispielsweise ein Wörterbuch mit Synonymen definieren und das Wort "Kontakt" verwenden, um "Telefon" zu finden.  Oder suchen Sie nach Wörtern ohne Rücksicht auf Form und Endung.  Diese Optionen können für Benutzer sehr nützlich sein. In diesem Artikel wird die Volltextsuche jedoch nur als Alternative zur klassischen Zeilensuche betrachtet.  Das heißt, <b>wir werden nur nach dem Teilstring suchen, der in der Suchleiste angegeben wird</b> , ohne Synonyme zu berücksichtigen, ohne Wörter in die „normale“ Form und andere Magie umzuwandeln. <br><br><h2>  Funktionsweise der MS SQL-Volltextsuche </h2><br>  Die Volltextsuchfunktion in MS SQL wurde teilweise aus dem DBMS-Hauptdienst entfernt (am Ende des Artikels werden wir sehen, warum dies äußerst nützlich sein kann).  Für die Suche wird im Gegensatz zu den üblichen ausgeglichenen Bäumen ein spezieller Index mit seiner Struktur gebildet. <br><br>  Es ist wichtig, dass zum Erstellen eines Volltextsuchindex in der Schlüsseltabelle ein eindeutiger Index vorhanden ist, der nur aus einer Spalte besteht. Die Volltextsuche wird zur Identifizierung von Tabellenzeilen verwendet.  Oft hat die Tabelle bereits einen solchen Index für den Primärschlüssel, manchmal muss er jedoch zusätzlich erstellt werden. <br><br>  Der Volltextsuchindex wird asynchron und außerhalb der Transaktion ausgefüllt.  Nach dem Ändern einer Tabellenzeile wird diese zur Verarbeitung in die Warteschlange gestellt.  Beim Aktualisieren des Index werden von der Tabellenzeile (Zeile) alle Zeichenfolgenwerte empfangen, die den Index "abonniert" haben, und in separate Wörter unterteilt.  Danach können die Wörter auf eine „Standardform“ reduziert werden (z. B. ohne Endungen), so dass die Suche nach Wortformen einfacher ist.  "Stoppwörter" werden weggeworfen (Präpositionen, Artikel und andere Wörter, die keine Bedeutung haben).  Die verbleibenden Wort-zu-Zeichenfolge-Verknüpfungsübereinstimmungen werden in den Volltextsuchindex geschrieben. <br><br>  Es stellt sich heraus, dass jede im Index enthaltene Spalte der Tabelle eine solche Pipeline durchläuft: <br><br>  Lange Zeile -&gt; Wortbrecher -&gt; Satz von Teilen (Wörtern) -&gt; Stemmer -&gt; normalisierte Wörter -&gt; [optional] Stoppwortausnahme -&gt; In Index schreiben <br><br>  Wie bereits erwähnt, ist der Indexaktualisierungsprozess asynchron.  Daraus folgt: <br><br><ol><li>  Update blockiert keine Benutzeraktionen </li><li>  Das Update wartet auf den Abschluss der Zeilenänderungstransaktion und beginnt, die Änderungen frühestens beim Festschreiben anzuwenden </li><li>  Änderungen am Volltextindex werden mit einer gewissen Verzögerung gegenüber der Haupttransaktion angewendet.  Das heißt, zwischen dem Hinzufügen einer Zeile und dem Zeitpunkt, zu dem sie gefunden werden kann, tritt abhängig von der Länge der Indexaktualisierungswarteschlange eine Verzögerung auf </li><li>  Die Anzahl der im Index enthaltenen Elemente kann durch die Abfrage überwacht werden: </li></ol><br><pre><code class="cs hljs">SELECT cat.name, FULLTEXTCATALOGPROPERTY(cat.name,<span class="hljs-string"><span class="hljs-string">'ItemCount'</span></span>) AS [ItemCount] FROM sys.fulltext_catalogs AS cat</code> </pre> <br><h2>  Praktische Tests.  Suche nach physischen  Personen mit Namen </h2><br><h4>  Füllen Sie die Tabelle mit Daten </h4><br>  Für Experimente erstellen wir eine neue leere Basis mit einer Tabelle, in der die „Gegenparteien“ gespeichert werden.  Im Feld "Beschreibung" befindet sich eine Zeile mit dem Namen des Vertrags, in der der Name der Gegenpartei angegeben wird.  Irgendwie so: <br><br>  "Vertrag mit Borovik Demyan Emelyanovich" <br><br>  Oder so: <br><br>  „Hund.  mit Borovik-Romanov Anatoly Avdeevich " <br><br>  Ja, ich möchte mich sofort von einer solchen „Architektur“ abschießen, aber leider ist eine solche Anwendung von „Kommentaren“ oder „Beschreibungen“ häufig bei Geschäftsanwendern anzutreffen. <br><br>  Zusätzlich fügen wir einige Felder "für Gewicht" hinzu: Wenn die Tabelle nur 2 Spalten enthält, wird sie in wenigen Augenblicken durch einen einfachen Scan gelesen.  Wir müssen den Tisch „aufblasen“, damit der Scan lang ist.  Dies bringt uns näher an reale Geschäftsfälle: Wir speichern nicht nur die „Beschreibung“ in der Tabelle, sondern auch viele andere [teuflische] nützliche Informationen. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create table </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partners</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id bigint identity (</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function">, [description] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">max</span></span></span><span class="hljs-function">), [address] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'107240, ,  ., 168', [phone] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'+7 (</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">495</span></span></span></span></span><span class="hljs-function">) 111-222-33', [contact_name] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'', [bio] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2048</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> N'     . , ,  .  ,    .        ,     .   ,  , ,       ,  .    . ,    ,   .       ,  ,            .       ,    ,     , .          ,   ,   .       .    .') --  ,    ..       </span></span></code> </pre> <br><br>  Die nächste Frage ist, wo man so viele eindeutige Nachnamen, Vornamen und Patronymien bekommt.  Ich habe nach alter Gewohnheit als normaler russischer Student gehandelt, d.h.  ging zu Wikipedia: <br><br><ul><li>  Namen aus der Seite Kategorie: Russische männliche Namen </li><li>  Manuelle Umschreibung von Zweitnamen aus Namen, Änderung der Endungen </li><li>  Bei Nachnamen stellte sich heraus, dass es etwas komplizierter war.  Am Ende wurde die Kategorie "Namensvetter" gefunden.  Ein wenig Schamanismus mit Python und in einer separaten Tabelle ergab 46,5 Tausend Namen.  (Ein Skript zum Herunterladen von Nachnamen finden Sie hier) </li></ul><br>  Natürlich gab es merkwürdige Unterschiede zwischen den Nachnamen, aber für die Zwecke der Studie war dies durchaus akzeptabel. <br><br><img src="https://habrastorage.org/webt/0z/to/16/0zto16d8rkkkygbiuqvdorvlxdc.png"><br><br>  Ich habe ein SQL-Skript geschrieben, das jedem Nachnamen eine zufällige Anzahl von Namen und Patronymien hinzufügt.  5 Minuten warten und in einem separaten Tisch gab es bereits 4,5 Millionen Kombinationen.  Nicht schlecht!  Für jeden Nachnamen gab es 20 bis 231 Kombinationen des Namens + des zweiten Vornamens, durchschnittlich wurden 97 Kombinationen erhalten.  Die Verteilung nach Namen und Patronym stellte sich als leicht nach links voreingenommen heraus, aber es schien überflüssig, einen ausgewogeneren Algorithmus zu entwickeln. <br><br><img src="https://habrastorage.org/webt/lb/yx/ug/lbyxugz2sjsri9uw7bi7rzornl4.png"><br><br>  Die Daten werden vorbereitet, wir können mit unseren Experimenten beginnen. <br><br><h4>  Einrichtung der Volltextsuche </h4><br>  Erstellen Sie einen Volltextindex auf MS SQL-Ebene.  Zuerst müssen wir ein Repository für diesen Index erstellen - einen Volltextkatalog. <br><br><pre> <code class="cs hljs">USE [like_vs_fulltext] GO CREATE FULLTEXT CATALOG [basic_ftc] WITH ACCENT_SENSITIVITY = OFF AS DEFAULT AUTHORIZATION [dbo] GO</code> </pre> <br>  Es gibt einen Katalog, wir versuchen, einen Volltextindex für unsere Tabelle hinzuzufügen ... und nichts funktioniert. <br><br><img src="https://habrastorage.org/webt/-v/rd/ge/-vrdge8hjpp_c8pgt4j3imsmks4.png"><br><br>  Wie gesagt, für einen Volltextindex benötigen Sie einen regulären Index mit einer eindeutigen Spalte.  Wir erinnern uns, dass wir bereits das erforderliche Feld haben - eine eindeutige ID.  Erstellen wir einen eindeutigen Clusterindex (obwohl ein nicht gruppierter Index ausreichen würde): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create unique clustered index ndx1 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partners</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br>  Nachdem wir einen neuen Index erstellt haben, können wir endlich den Volltextsuchindex hinzufügen.  Warten wir einige Minuten, bis der Index voll ist (denken Sie daran, dass er asynchron aktualisiert wird!).  Sie können mit den Tests fortfahren. <br><br><h4>  Testen </h4><br>  Beginnen wir mit dem einfachsten Szenario, das der tatsächlichen Anwendung der Suche nahe kommt.  Wir simulieren eine „Listenansicht“ - eine Fensterauswahl von 45 Zeilen mit Auswahl nach Suchmaske.  Wir führen die Anfrage mit einem neuen Volltextindex aus, wir notieren die Zeit - 0 Sekunden - ausgezeichnet! <br><br><img src="https://habrastorage.org/webt/m8/ci/bk/m8cibkgbrwb2xkruwbspp3axfgk.png"><br><br>  Jetzt eine alte, bewährte Suche durch "Gefällt mir".  Es dauerte 3 Sekunden, um das Ergebnis zu bilden.  Nicht so schlimm, die totale Niederlage hat nicht funktioniert.  Vielleicht macht es dann keinen Sinn, eine Volltextsuche einzurichten - funktioniert alles einwandfrei? <br><br><img src="https://habrastorage.org/webt/bl/gr/hl/blgrhlafampbhbssctycbcweuis.png"><br><br>  Tatsächlich haben wir ein wichtiges Detail übersehen: Die Anforderung wurde ohne Sortierung ausgeführt.  Erstens liefert eine solche Abfrage, gepaart mit "Auswählen der ersten N Datensätze", ein ungerechtfertigtes Ergebnis.  Jeder Start kann N zufällige Datensätze zurückgeben, und es gibt keine Garantie dafür, dass zwei aufeinanderfolgende Starts denselben Datensatz ergeben.  Zweitens, wenn wir über das "Anzeigen der Liste mit einem Schiebefenster" sprechen - normalerweise wird dieses "Fenster" nach einer beliebigen Spalte sortiert, beispielsweise nach Namen.  Schließlich muss der Bediener wissen, was er erhält, wenn er zum nächsten „Fenster“ wechselt. <br><br>  Korrigieren Sie das Experiment.  Fügen Sie beispielsweise die Sortierung nach Telefonnummer hinzu: <br><br><img src="https://habrastorage.org/webt/tc/n-/i9/tcn-i9py1gxkrbrl927ygqqyudq.png"><br><br>  <b>Die Volltextsuche gewinnt mit einer ohrenbetäubenden Punktzahl: 0 Sekunden gegenüber 172 Sekunden!</b> <br><br>  Wenn Sie sich die Abfragepläne ansehen, wird klar, warum dies so ist.  Aufgrund der Hinzufügung der Reihenfolge zum Abfragetext wurde während der Ausführung eine Sortieroperation angezeigt.  Dies ist die sogenannte "Blockierungs" -Operation, bei der die Anforderung erst abgeschlossen werden kann, wenn die gesamte Datenmenge zum Sortieren empfangen wurde.  Wir können nicht die ersten 45 Datensätze abrufen, sondern müssen den gesamten Datensatz sortieren. <br><br>  Und in der Phase des Erhaltens von Daten zum Sortieren tritt ein dramatischer Unterschied auf.  Eine Suche mit "Gefällt mir" muss die gesamte verfügbare Tabelle durchsuchen.  Dies dauert 172 Sekunden.  Die Volltextsuche hat jedoch eine eigene optimierte Struktur, die sofort Links zu allen erforderlichen Einträgen zurückgibt. <br><br><img src="https://habrastorage.org/webt/gq/nu/fw/gqnufwndwjmo5skv5_uq6ewvdkc.png"><br><br><img src="https://habrastorage.org/webt/uv/ew/c9/uvewc93qvfchgagsclaqi55hvt8.png"><br><br>  Aber sollte es eine Fliege in der Salbe geben?  Da ist einer.  Wie eingangs erwähnt, kann eine Volltextsuche nur am Anfang eines Wortes suchen.  Und wenn wir "Ivan Poddubny" durch den Teilstring "* oak *" finden wollen, zeigt eine Volltextsuche nichts Nützliches. <br><br>  Glücklicherweise ist die Suche nach Namen nicht das beliebteste Szenario. <br><br><h4>  Suchen Sie nach einem Dokument nach Nummer </h4><br>  Versuchen wir etwas komplizierteres.  Der zweite beliebte Anwendungsfall für die Suche besteht darin, ein Dokument anhand eines Teils seiner Nummer zu finden.  Darüber hinaus besteht die Dokumentennummer häufig aus zwei Teilen: dem Buchstabenpräfix und der tatsächlichen Nummer, die führende Nullen enthält. <br><br>  Zwischen diesen Teilen befinden sich keine Leerzeichen oder Servicezeichen.  Gleichzeitig ist die Suche nach der vollständigen Zahl ungeheuer unpraktisch - Sie müssen sich daran erinnern, wie viele führende Nullen nach dem Präfix vor dem Beginn des signifikanten Teils stehen sollten.  Es stellt sich heraus, dass die Volltextsuche "out of the box" in einem solchen Szenario einfach nutzlos ist.  Versuchen wir es zu beheben. <br><br>  Für den Test habe ich eine neue Tabelle mit dem Namen document erstellt, in der ich 13,5 Millionen Datensätze mit eindeutigen Nummern vom Typ „ORG“ hinzugefügt habe.  Die Nummerierung ging in Ordnung, alle Nummern begannen mit "ORG".  Du kannst anfangen. <br><br><h4>  Eine Nummer vorab teilen </h4><br>  Die Volltextsuche kann effizient nach Wörtern suchen.  Nun, helfen wir ihm und teilen die „unangenehme“ Zahl im Voraus in bequeme Wörter auf.  Der Aktionsplan lautet wie folgt: <br><br><ol><li>  Fügen Sie der Quelltabelle eine zusätzliche Spalte hinzu, in der die speziell konvertierte Nummer gespeichert wird </li><li>  Fügen Sie einen Auslöser hinzu, der beim Ändern der Nummer in mehrere kleine Teile unterteilt wird, die durch ein Leerzeichen getrennt sind </li><li>  Die Volltextsuche weiß bereits, wie man eine Zeichenfolge durch Leerzeichen in Teile aufteilt, damit unsere geänderte Nummer problemlos indiziert wird </li></ol><br>  Mal sehen, wie das funktioniert. <br><br>  Fügen Sie der Tabelle eine zusätzliche Spalte hinzu. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">alter table document </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">add</span></span></span><span class="hljs-function"> number_parts </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nvarchar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">128</span></span></span></span></span><span class="hljs-function">) not </span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-literal">null</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> ''</span></span></code> </pre> <br>  Ein Trigger, der eine neue Spalte füllt, kann als „Stirn“ geschrieben werden, wobei mögliche Duplikate ignoriert werden (wie viele sich wiederholende Tripel enthält die Zahl „0000012“?). Außerdem können Sie XML-Magie hinzufügen und nur eindeutige Teile aufzeichnen.  Die erste Implementierung ist schneller, die zweite liefert ein kompakteres Ergebnis.  In der Tat ist die Wahl zwischen Schreibgeschwindigkeit und Lesegeschwindigkeit, wählen Sie, was in Ihrer Situation wichtiger ist.  Gehen Sie jetzt einfach ein <a href="">Skript durch</a> , das vorhandene Zahlen verarbeitet. <br><br><img src="https://habrastorage.org/webt/jh/su/yi/jhsuyix1k3vmyz-m4_2lit8mn0c.png"><br><br>  Volltextindex hinzufügen <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">create fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">number_parts</span></span></span><span class="hljs-function">) key index ndx1 with change_tracking</span></span> = Auto</code> </pre> <br>  Und überprüfen Sie das Ergebnis.  Das Experiment ist das gleiche - Modellierung einer „Fenster“ -Auswahl aus einer Liste von Dokumenten.  Wir wiederholen die vorherigen Fehler nicht und führen die Anforderung sofort mit Sortierung aus, in diesem Fall nach Datum. <br><br><img src="https://habrastorage.org/webt/2a/mc/aq/2amcaqolncb-oewf7l9dfivqstq.png"><br><br>  Es funktioniert!  Versuchen wir nun eine authentischere Nummer: <br><br><img src="https://habrastorage.org/webt/fe/a4/k9/fea4k9kc2isour1u-jkv5fla1pm.png"><br><br>  Und dann passiert eine Fehlzündung.  Die Länge der Suchzeichenfolge ist länger als die Länge der gespeicherten "Wörter".  Tatsächlich enthält die Suchdatenbank einfach keine einzige Zeile mit 4 Zeichen, sodass ehrlich gesagt ein leeres Ergebnis zurückgegeben wird.  Wir müssen den Suchstring in Teile zerlegen: <br><br><img src="https://habrastorage.org/webt/0z/tv/sy/0ztvsyfiijs2wuzppnutvugt-dy.png"><br><br>  Eine andere Sache!  Wir haben wieder eine schnelle Suche.  Ja, er erlegt der Wartung seinen Overhead auf, aber das Ergebnis ist hunderte Male schneller als die klassische Suche.  Wir notieren den gezählten Versuch, versuchen aber, die Wartung irgendwie zu vereinfachen - im nächsten Abschnitt. <br><br><h4>  Wir werden es auf unsere eigene Weise in Worte fassen! </h4><br>  Wer hat gesagt, dass Wörter durch Leerzeichen getrennt werden sollen?  Vielleicht möchte ich Nullen zwischen Wörtern!  (und, wenn möglich, das Präfix, damit es auch irgendwie ignoriert wird und nicht unter den Füßen stört).  Im Allgemeinen ist daran nichts unmöglich.  Erinnern wir uns an das Volltextsuchschema vom Anfang des Artikels - eine separate Komponente, Wordbreaker, ist für das Aufteilen in Wörter verantwortlich, und glücklicherweise können Sie mit Microsoft Ihren eigenen „Word Breaker“ implementieren. <br><br>  Und hier beginnt das Interessante.  Wordbreaker ist eine separate DLL, die eine Verbindung zur Volltextsuchmaschine herstellt.  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offizielle Dokumentation</a> besagt, dass das Erstellen dieser Bibliothek sehr einfach ist - implementieren Sie einfach die IWordBreaker-Schnittstelle.  Und hier sind einige kurze Initialisierungslisten in C ++.  Sehr erfolgreich habe ich gerade ein passendes Tutorial gefunden! <br><br><img src="https://habrastorage.org/webt/48/vk/hh/48vkhhkmxbga2tnxudfiktk2c4k.png">  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Quelle</a> ) <br><br>  Im Ernst, die Dokumentation zum Erstellen eines eigenen Worbreakers im Internet ist verschwindend klein.  Noch weniger Beispiele und Vorlagen.  Aber ich habe immer noch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Projekt einer</a> freundlichen Person gefunden, das eine C ++ - Implementierung geschrieben hat, die Wörter nicht in Trennzeichen, sondern einfach in Dreiergruppen aufteilt (ja, genau wie im vorherigen Abschnitt!). Außerdem enthält der Projektordner bereits eine sorgfältig kompilierte Binärdatei, die Sie nur benötigen Verbindung zur Suchmaschine herstellen. <br><br>  Einfach einstecken ... Eigentlich nicht ganz einfach.  Gehen wir die Schritte durch: <br><br>  Sie müssen die Bibliothek mit SQL Server in den Ordner kopieren: <br><br><img src="https://habrastorage.org/webt/oy/tj/wk/oytjwkzpv1b8mo6uvysgipl7fq0.png"><br><br>  Registrieren Sie eine neue „Sprache“ in der Volltextsuche <br><br><pre> <code class="cs hljs">exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\CLSID\{d225281a-7ca9-4a46-ae7d-c63a9d4815d4}'</span></span>, <span class="hljs-string"><span class="hljs-string">'DefaultData'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'sqlngram.dll'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\CLSID\{0a275611-aa4d-4b39-8290-4baf77703f55}'</span></span>, <span class="hljs-string"><span class="hljs-string">'DefaultData'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'sqlngram.dll'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'Locale'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_DWORD'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'WBreakerClass'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'{d225281a-7ca9-4a46-ae7d-c63a9d4815d4}'</span></span> exec master.dbo.xp_instance_regwrite <span class="hljs-string"><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span></span>, <span class="hljs-string"><span class="hljs-string">'StemmerClass'</span></span>, <span class="hljs-string"><span class="hljs-string">'REG_SZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'{0a275611-aa4d-4b39-8290-4baf77703f55}'</span></span> exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'verify_signature'</span></span> , <span class="hljs-number"><span class="hljs-number">0</span></span>; exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'update_languages'</span></span>; exec sp_fulltext_service <span class="hljs-string"><span class="hljs-string">'restart_all_fdhosts'</span></span>; exec sp_help_fulltext_system_components <span class="hljs-string"><span class="hljs-string">'wordbreaker'</span></span>;</code> </pre> <br>  Bearbeiten Sie mehrere Schlüssel in der Registrierung manuell (der Autor wollte den Prozess automatisieren, aber seit 2016 gibt es keine Neuigkeiten mehr. Dies war jedoch ursprünglich ein „Implementierungsbeispiel“, danke auch dafür). <br><br><img src="https://habrastorage.org/webt/dx/yd/iq/dxydiqkbefi03iseanfv_tzfcii.png"><br><br>  Die Schritte werden auf der Projektseite ausführlich beschrieben. <br><br>  Fertig.  Löschen wir den alten Volltextindex, da es nicht zwei Volltextindizes für eine Tabelle geben kann.  Erstellen Sie eine neue und indizieren Sie unsere Dokumentennummern.  Als Schlüsselspalte geben wir die Zahlen selbst an. Es werden keine Ersatzspalten mehr benötigt.  Stellen Sie sicher, dass Sie "Sprachnummer 1" angeben, um den frisch installierten Wordbreaker zu verwenden. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">drop fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> document go create fulltext index </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">on</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">number Language </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">) key index ndx1 with change_tracking</span></span> = Auto</code> </pre> <br>  Überprüfen? <br><br><img src="https://habrastorage.org/webt/1p/se/zz/1psezzovwm3mnoweyyfkpoo6o34.png"><br><br>  Es funktioniert!  Es funktioniert so schnell wie alle oben diskutierten Beispiele. <br><br>  Lassen Sie uns die lange Zeile überprüfen, auf die die vorherige Option gestoßen ist: <br><br><img src="https://habrastorage.org/webt/iq/to/n8/iqton8zugajg5e85tcaieenab7k.png"><br><br>  Die Suche funktioniert für den Benutzer und den Programmierer transparent.  Wordbreaker zerlegt die Suchzeichenfolge unabhängig voneinander in Teile und findet das gewünschte Ergebnis. <br><br>  Es stellt sich heraus, dass wir jetzt keine zusätzlichen Spalten und Trigger benötigen, dh die Lösung ist einfacher (sprich: zuverlässiger) als unser vorheriger Versuch.  In Bezug auf die Unterstützung ist eine solche Implementierung einfacher und transparenter, es besteht eine geringere Wahrscheinlichkeit von Fehlern. <br><br>  Also, hör auf, ich sagte "zuverlässiger"?  Wir haben gerade eine Bibliothek eines Drittanbieters mit unserem DBMS verbunden!  Und was passiert, wenn sie fällt?  Auch versehentlich zieht sich der gesamte Datenbankdienst heraus! <br><br>  Hier müssen Sie sich daran erinnern, wie ich am Anfang des Artikels den Volltextsuchdienst erwähnt habe, der vom Haupt-DBMS-Prozess getrennt ist.  Hier wird klar, warum dies wichtig ist.  Die Bibliothek stellt eine Verbindung zum Volltext-Indizierungsdienst her, der mit reduzierten Rechten betrieben werden kann.  Und was noch wichtiger ist: Wenn Komponenten von Drittanbietern ausfallen, fällt nur der Indexdienst.  Die Suche wird für eine Weile angehalten (ist jedoch bereits asynchron), und das Datenbankmodul funktioniert weiterhin so, als wäre nichts passiert. <br><br>  Zusammenfassend.  Das Hinzufügen eines eigenen Wortbrechers kann eine ziemliche Herausforderung sein.  Wenn Sie jedoch "auf lange Sicht" spielen, zahlen sich diese Bemühungen mit größerer Flexibilität und einfacher Wartung aus.  Die Wahl liegt wie immer bei Ihnen. <br><br><h2>  Warum ist das alles notwendig? </h2><br>  Ein neugieriger Leser hat sich wahrscheinlich mehr als einmal gefragt: "Das alles ist großartig, aber wie kann ich diese Funktionen verwenden, wenn ich die Suchanfragen in meiner Anwendung nicht ändern kann?"  Vernünftige Frage.  Die Einbeziehung der Volltext-MS SQL-Suche erfordert eine Änderung der Syntax der Abfragen. In der vorhandenen Architektur ist dies häufig einfach nicht möglich. <br><br>  Sie können versuchen, die Anwendung auszutricksen, indem Sie eine gleichnamige Tabellenwertfunktion anstelle einer regulären Tabelle „verschieben“, wodurch die Suche bereits wie gewünscht ausgeführt wird.  Sie können versuchen, die Suche als eine Art externe Datenquelle zu binden.  Es gibt eine andere Lösung - Softpoint Data Cluster - einen speziellen Dienst, der eine "Weiterleitung" zwischen der Quellanwendung und dem SQL Server-Dienst installiert, auf Datenverkehr wartet und Anforderungen "on the fly" nach speziellen Regeln ändern kann.  Mit diesen Regeln können wir mit LIKE regelmäßige Abfragen finden und diese mit Volltextsuche in CONTAINS konvertieren. <br><br>  Warum solche Schwierigkeiten?  Trotzdem ist die Suchgeschwindigkeit faszinierend.  In einem stark ausgelasteten System, in dem Bediener häufig in Millionen von Tabellen nach Datensätzen suchen, ist die Antwortgeschwindigkeit von entscheidender Bedeutung.  Das Sparen von Zeit beim häufigsten Betrieb führt zu Dutzenden von zusätzlich verarbeiteten Anwendungen, und dies ist echtes Geld, mit dem jedes Unternehmen zufrieden ist.  Am Ende zahlen sich einige Tage oder sogar Wochen für das Studium und die Implementierung der Technologie mit einer höheren Bedienereffizienz aus. <br><br>  Alle im Artikel erwähnten Skripte sind im Repository <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/frrrost/mssql_fulltext</a> verfügbar <br><br><h2>  Über den Autor </h2><br><img src="https://habrastorage.org/webt/xh/rm/q5/xhrmq5imxl5i7n9cp6lfjejy9w8.png" align="left" width="120">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Alexander Denisov</a> - MS SQL Server-Datenbankleistungsanalyst.  In den letzten 6 Jahren habe ich als Teil des Softpoint-Teams dazu beigetragen, Engpässe bei den Anfragen anderer zu finden und das Beste aus den Kundendatenbanken herauszuholen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de470139/">https://habr.com/ru/post/de470139/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de470125/index.html">Beurteilen Sie den Code eines anderen nicht streng</a></li>
<li><a href="../de470127/index.html">Komponist mit langem Kurzzeitgedächtnis</a></li>
<li><a href="../de470129/index.html">Deklarative Speicherverwaltung</a></li>
<li><a href="../de470133/index.html">So sammeln Sie mit Prometheus Metriken, die nicht durch Zeitangaben verzerrt sind</a></li>
<li><a href="../de470135/index.html">Eine interaktive Webanwendung ohne Programmierung? Einfach! Mavo in deinen Armen</a></li>
<li><a href="../de470145/index.html">„Vorsicht, FAS!“: Warum ist ein militärisches Ticket in der Werbung gefährlich, warum ist es wichtig, Mathe zu kennen und ob immer die bloße Wahrheit benötigt wird</a></li>
<li><a href="../de470153/index.html">Datenmodellwörterbuch</a></li>
<li><a href="../de470155/index.html">Merkmale der nationalen Mustererkennung</a></li>
<li><a href="../de470165/index.html">Die Philosophie der Teilung durch ... oder das Geständnis eines Verrückten</a></li>
<li><a href="../de470167/index.html">Konferenz für Wissenschaftsinteressierte, bevor sie zum Mainstream wurde</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>