<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø ü§ü üå∑ C√≥mo conectar un script a un sitio de terceros üö∫ üò´ üêí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Esta es la primera publicaci√≥n en nuestro blog. Muchas personas nos conocen como un chat para el sitio, fue con √©l que comenzamos, y ahora ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo conectar un script a un sitio de terceros</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jivosite/blog/452802/"> Hola Habr!  Esta es la primera publicaci√≥n en nuestro blog.  Muchas personas nos conocen como un chat para el sitio, fue con √©l que comenzamos, y ahora ocupamos posiciones de liderazgo en el campo de los mensajeros comerciales.  Poco a poco evolucionamos hacia una soluci√≥n comercial integral que brinda muchas oportunidades para los clientes: devoluci√≥n de llamada, comunicaci√≥n con clientes a trav√©s de mensajer√≠a instant√°nea, redes sociales, aplicaciones m√≥viles, PBX virtual, funciones CRM y mucho m√°s. <br><br>  Durante varios a√±os, resolvimos con √©xito muchos problemas t√©cnicos, acumulamos muchas cosas interesantes y, en algunos lugares, la experiencia √∫nica, por supuesto, escribi√≥ nuestras muletas y bicicletas.  Con esta publicaci√≥n, comenzamos una serie de art√≠culos en los que compartiremos nuestra experiencia en el desarrollo, la construcci√≥n de procesos en un equipo completamente remoto, hablaremos sobre nuestra arquitectura, soluciones t√©cnicas que nos permiten servir de manera efectiva a cientos de miles de clientes en todo el mundo. <br><br><img src="https://habrastorage.org/webt/zp/bn/fv/zpbnfvc-9q274ie5wcyhvuo3pma.jpeg" alt="imagen"><br><br>  <b>Jivosite hoy es:</b> <br><br><ul><li>  250 mil clientes en todo el mundo; </li><li>  150 millones de impresiones de widgets por d√≠a; </li><li>  3,5 millones de mensajes por d√≠a; </li><li>  10 millones de chats por mes; </li><li>  1M de conexiones simult√°neas; </li><li>  M√°s de 250 servidores en producci√≥n. </li></ul><br>  Como la mayor√≠a de las personas nos conocen como chat para un sitio, probablemente comencemos con √©l.  En este art√≠culo, le mostraremos c√≥mo conectar su c√≥digo a un sitio de terceros y a qu√© debe prestar atenci√≥n como ejemplo de nuestros muchos a√±os de experiencia trabajando con el chat.  Este art√≠culo ser√° √∫til para aquellos que planean o ya est√°n desarrollando un servicio de complemento, y simplemente para todos los que est√©n interesados ‚Äã‚Äãen este tema. <br><br><h3>  <font color="#00bf54">Punto de entrada</font> </h3><br>  El teatro comienza con una percha y el servicio conectado con un c√≥digo de inserci√≥n.  Es el punto de entrada para cualquier servicio o m√≥dulo en el sitio.  Como regla general, se puede encontrar en las instrucciones de instalaci√≥n, despu√©s de lo cual es necesario agregarlo al c√≥digo HTML del sitio, y luego hay "magia", que carga e inicializa el script de cierta manera. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Parece que podr√≠a ser m√°s f√°cil conectar el script al sitio? <a name="habracut"></a>  De manera est√°ndar, solo necesita agregar una etiqueta de script al c√≥digo HTML de la p√°gina.  Pero, de hecho, esta es una etapa importante, que esconde muchas trampas.  Por ejemplo, identificaci√≥n del usuario, implementaci√≥n de un canal de carga de script de respaldo, personalizaci√≥n de apariencia o l√≥gica, velocidad de carga de la p√°gina, etc.  Pero hablemos de todo en orden. <br><br><h3>  <font color="#00bf54">Identificaci√≥n</font> </h3><br>  Solo porque no es muy interesante para nadie conectar un script, seguro que el script realiza alg√∫n tipo de l√≥gica, y esta l√≥gica est√° vinculada al usuario.  Por ejemplo, la ID del contador, APP_ID de la red social, en nuestro caso, esta es la ID del canal de comunicaci√≥n creado.  Es decir, el script debe identificar al usuario en las solicitudes al servidor.  Para identificar al cliente a trav√©s del c√≥digo de inserci√≥n, hay tres opciones de implementaci√≥n. <br><br>  <b>Opcion # 1</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Pase la identificaci√≥n directamente en el enlace al archivo y del lado del servidor de alguna manera, incl√∫yalo en el script.  En este caso, el servidor tendr√° que escribir la ID en el archivo sobre la marcha o formar una cadena JS con la ID que cargar√° file.js.  Esta l√≥gica es similar a la implementaci√≥n de solicitudes JSONP. <br><br><img src="https://habrastorage.org/webt/e-/h5/ks/e-h5ks-gi2mnrck3jwkkogy9trk.png"><br>  Durante mucho tiempo trabajamos en este principio, pero las desventajas de este enfoque son que se agrega la carga "inactiva" en el servidor y la necesidad de implementar el almacenamiento en cach√© del servidor. <br><br>  <b>Opcion # 2</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag">]&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtext/javascript‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.serviceNameId = ‚Äú</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">123</span></span></span><span class="javascript">‚Äù; </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// ServiceNameModule.init({id: ‚Äú123‚Äù}); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <i>Atributo as√≠ncrono: le dice al navegador que no hay necesidad de esperar a que se cargue el script para construir el DOM, el script debe ejecutarse inmediatamente despu√©s de la carga.</i>  <i>Esto reduce el tiempo de carga de la p√°gina, pero tambi√©n hay un reverso de la moneda: el script se puede ejecutar antes de que el DOM est√© listo para funcionar.</i> <br><br>  Una de las implementaciones m√°s populares, incluidos los grandes servicios, hace exactamente eso, solo la sintaxis es diferente, pero la esencia de todo es la misma. <br><br><img src="https://habrastorage.org/webt/ga/9x/as/ga9xasvv7abeeu_f29q-y8zcqze.png"><br>  Este enfoque tiene dos desventajas principales, la primera, el c√≥digo de inserci√≥n es complicado, y la segunda, el orden de ejecuci√≥n de este c√≥digo es muy importante, de lo contrario, nada funcionar√°.  Adem√°s, debe elegir entre velocidad (as√≠ncrona) y estabilidad (sin as√≠ncrona), la mayor√≠a elige la segunda opci√≥n. <br><br>  <b>Opci√≥n # 3</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  De manera similar a la primera opci√≥n, transfiera la ID en el enlace al archivo, pero recup√©rela en el navegador y no en el servidor.  No es tan simple como parece, pero es posible.  La API del navegador tiene una propiedad document.currentScript, devuelve un enlace a un script que est√° cargado y actualmente se est√° ejecutando en el navegador.  Sabiendo esto, puede calcular la ID, para esto necesita obtener la propiedad document.currentScript.src y extraer regularmente la ID de ella. <br><br><img src="https://habrastorage.org/webt/p7/mc/jf/p7mcjfln8bnay8g2myb3289vt8y.png"><br>  Hay una cosa pero: document.currentScript no es compatible con todos los navegadores.  Para los navegadores que no admiten esta propiedad, se nos ocurri√≥ un truco interesante.  En el c√≥digo file.js, puede lanzar una excepci√≥n "falsa" especial envuelta en try / catch, despu√©s de lo cual se lanzar√° la URL del script en el que se produjo el error en la pila de errores.  La URL contendr√° la ID que obtenemos con la misma regularidad. <br><br>  Se obtiene este tipo de magia, pero funciona.  No hay problemas con el orden de ejecuci√≥n, el c√≥digo de inserci√≥n parece simple y no hay sobrecarga en el servidor.  En los √∫ltimos dos a√±os, hemos estado utilizando tal enfoque, aunque el c√≥digo de inserci√≥n en s√≠ es diferente, pero el principio es el mismo. <br><br><h3>  <font color="#00bf54">Configuraciones</font> </h3><br>  En la mayor√≠a de los casos, los scripts de complementos tienen configuraciones que son responsables de la apariencia o la l√≥gica del trabajo.  Esta configuraci√≥n debe "incluirse" en el script del complemento, para esto hay dos enfoques fundamentalmente diferentes. <br><br>  <b>Enfoque n. ¬∞ 1</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtext/javascript‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.serviceName = {</span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">color</span></span></span><span class="javascript">: ‚Äúred‚Äù, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">title</span></span></span><span class="javascript">: ‚Äú‚Äù, ...}; </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// ServiceNameModule.init({color: ‚Äúred‚Äù, title: ‚Äú‚Äù, ...}); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Este enfoque tambi√©n incluye pasar la configuraci√≥n en los par√°metros GET a la URL del script, similar a la opci√≥n # 1 de la secci√≥n "Identificaci√≥n".  El enfoque es que si el cliente desea cambiar la configuraci√≥n, debe editar el c√≥digo de inserci√≥n y actualizarlo en el sitio. <br><br><img src="https://habrastorage.org/webt/lo/ua/-n/loua-nwuth3l7a0vbilxtu8ilmk.png"><br>  Esto es bueno porque todas las configuraciones se almacenan en el cliente y no es necesario que se almacenen en el servidor, desarrolle y mantenga toda la l√≥gica empresarial relacionada con esto.  La principal desventaja de este enfoque es el inconveniente para el cliente, tiene que hacer todo manualmente, y si hay muchas configuraciones, el c√≥digo de inserci√≥n se convierte en una hoja dif√≠cil de mantener, en la que es f√°cil cometer un error.  Y para que las actualizaciones surtan efecto, debe actualizar el sitio, estos son los gestos adicionales de los desarrolladores y administradores. <br><br>  <b>Enfoque n. ¬∞ 2</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  El segundo enfoque es que si es necesario cambiar la configuraci√≥n, el cliente no necesita modificar el c√≥digo de inserci√≥n, todas las configuraciones se almacenan en el servidor.  Para cambiar la configuraci√≥n, vaya al panel gr√°fico, cambie los par√°metros necesarios y haga clic en el bot√≥n "Guardar".  Despu√©s de eso, la configuraci√≥n se aplicar√° autom√°ticamente a su sitio. <br><br><img src="https://habrastorage.org/webt/yq/xb/no/yqxbnominbt8r7_sj3ng0mib9wc.png"><br>  No es necesario comprender el c√≥digo y hacer un despliegue para esto, esto puede hacerlo una persona que est√© lejos de JavaScript, por ejemplo, un administrador.  Por supuesto, esta opci√≥n es mucho m√°s conveniente y simple para los usuarios, por eso la usamos.  Pero debe pagar por conveniencia, este enfoque requiere el desarrollo y el soporte de la l√≥gica en el servidor e implica una carga adicional en √©l.  En los siguientes art√≠culos, definitivamente le diremos c√≥mo procesamos 150 millones de solicitudes diarias. <br><br><h3>  <font color="#00bf54">Compatibilidad con versiones anteriores</font> </h3><br>  Es muy importante llegar a una versi√≥n madura del c√≥digo de inserci√≥n lo m√°s r√°pido posible.  Porque actualizar los c√≥digos de inserci√≥n ya instalados ser√° extremadamente dif√≠cil.  Un ejemplo de nuestra pr√°ctica: en las primeras versiones utilizamos ID num√©ricos, pero por razones de seguridad los reemplazamos por alfanum√©ricos.  Result√≥ que es muy dif√≠cil lograr un cambio en el c√≥digo de inserci√≥n ya instalado.  Muchas personas ni siquiera saben qu√© es HTML y c√≥mo est√°n dise√±ados los sitios web.  Por ejemplo, un sitio web fue creado por freelancers, se cre√≥ un estudio o un sitio web a trav√©s de un CMS / constructor, etc. En la mayor√≠a de los casos, nuestros clientes solo trabajan con el panel de configuraci√≥n de widgets.  Desde entonces, todav√≠a tenemos en nginx un mapa de reescritura de identificaciones antiguas a nuevas, que tiene alrededor de 40 mil registros. <br><br><pre> <code class="xml hljs">.... /script/widget/config/15**90 /script/widget/config/bqZB**rjW5; /script/widget/config/15**94 /script/widget/config/qtfx**xnTi; /script/widget/config/15**95 /script/widget/config/fqmpa**4YX; /script/widget/config/15**97 /script/widget/config/Vr21g**nuT; /script/widget/config/15**98 /script/widget/config/8NXL5**F8E; /script/widget/config/15**00 /script/widget/config/Th2HN**6RJ; ....</code> </pre><br>  Debido a esta caracter√≠stica, nos vemos obligados a mantener la compatibilidad con versiones anteriores del c√≥digo de inserci√≥n para todas las refactorizaciones, de las cuales hab√≠a aproximadamente 5 en nuestra memoria. <br><br><h3>  <font color="#00bf54">Aislamiento de c√≥digo</font> </h3><br>  Dado que el script est√° conectado a un sitio de terceros que ya tiene c√≥digo JavaScript y CSS para el sitio y otros servicios, el objetivo principal es no da√±ar el sitio para que nuestro c√≥digo no cambie la l√≥gica, y mucho menos lo rompa.  Esto podr√≠a ser un error de JavaScript que detiene el flujo de ejecuci√≥n o estilos que anulan los estilos del sitio.  Pero el c√≥digo del sitio tambi√©n puede afectar el script conectado, por ejemplo, se usa una biblioteca que modifica la API del navegador, despu√©s de lo cual el c√≥digo deja de funcionar o no funciona como esperamos. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//  mootools.js var JSON = new Hash({ encode: function () {}, decode: function () {} // ... }); //    JSON.parse(json); // Uncaught TypeError: JSON.parse is not a function </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> //      body * { padding: 20px; } form input { display: block; border: 2px solid red; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Hay diferentes opciones para aislar el c√≥digo.  Por ejemplo, puede usar prefijos en variables JS, cierres, para no obstruir el contexto global, use algo como BEM para los estilos.  Pero la forma m√°s f√°cil es ejecutar el c√≥digo en un iframe, resuelve la mayor√≠a de los problemas de aislamiento, pero impone ciertas restricciones.  Utilizamos una versi√≥n h√≠brida, en los siguientes art√≠culos le informaremos m√°s sobre el aislamiento del c√≥digo. <br><br><h3>  <font color="#00bf54">Bloquear sitio de carga</font> </h3><br><img src="https://habrastorage.org/webt/1l/wr/du/1lwrdup_ictcih9u7ectyzgwsp4.png"><br><br>  Evento de carga: ocurre despu√©s de que la p√°gina web est√° completamente cargada, incluidas im√°genes, estilos y scripts externos.  Una caracter√≠stica importante es que en la mayor√≠a de los sitios, la l√≥gica JS, los scripts de terceros y los anuncios comienzan a funcionar cuando se produce este evento.  Un punto muy importante para todos los scripts conectados es evitar un impacto negativo en este evento. <br><br>  Esto sucede en los casos en que el servidor desde el que se carga el script responde durante un tiempo prolongado o no responde en absoluto: entonces el evento de carga se retrasa y la carga adicional de la p√°gina se bloquea esencialmente.  En el caso de que el servidor no est√© disponible, el evento de carga ocurrir√° solo despu√©s de que la solicitud haya expirado, que es m√°s de 60 s.  Por lo tanto, los problemas en el servidor de carga de scripts esencialmente "rompen" los sitios, lo cual es inaceptable. <br><br>  <b>Experiencia personal</b> <br>  En el pasado, trabajaba para una empresa que ten√≠a un sitio web con citas simult√°neas en l√≠nea de 100K.  En aquellos d√≠as, los botones "Compartir en redes sociales" eran populares.  Para que aparecieran en el sitio, ten√≠a que conectar un script (sdk) desde las redes sociales deseadas.  Un d√≠a, los colegas corrieron hacia nosotros y dijeron que nuestro sitio no funcionaba.  Observamos el monitoreo, en el que todo era normal, y al principio no entend√≠amos cu√°l era el problema.  Cuando comenzaron a cavar m√°s profundo, se dieron cuenta de que los servidores cdn de Twitter estaban acostados, y su SDK no pod√≠a cargarse, esto nos impidi√≥ cargar el sitio durante aproximadamente 1,5 minutos.  Es decir, despu√©s de abrir el sitio, se carg√≥ un poco de HTML (el resto de SPA) y solo despu√©s de 1.5 minutos se carg√≥ todo, el tiempo de espera de la solicitud funcion√≥.  Tuvimos que organizar urgentemente un hotfix y eliminar su script del sitio.  Despu√©s de repetir esta situaci√≥n, decidimos eliminar el bloqueo Compartir. <br><br>  En las primeras versiones del c√≥digo de inserci√≥n, no tomamos esto en cuenta, y en caso de problemas t√©cnicos de nuestra parte, para decirlo suavemente, incomodamos a nuestros clientes, pero con el tiempo lo arreglamos. <br><br>  <b>Soluci√≥n</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'text/javascript'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> (</span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></span><span class="actionscript">{ </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> initCode = </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// insert script tag }; document.readyState === 'complete' ? initCode() : w.addEventListener('load', initCode, false); })(); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  La soluci√≥n es simple: debe suscribirse al evento de una carga completa del sitio y solo luego cargar el script, para esto debe usar el c√≥digo de inserci√≥n y no la etiqueta del script. <br><br><h3>  <font color="#00bf54">Velocidad de p√°gina de Google</font> </h3><br><br><img src="https://habrastorage.org/webt/ur/b9/4t/urb94tbcz9obpytp_da8ed27c8s.png"><br>  <i>An√°lisis de la versi√≥n m√≥vil de habr.com</i> <br><br>  La mayor√≠a de ellos prestan atenci√≥n a la velocidad de carga del sitio, seg√∫n muchos estudios, esto afecta directamente la ganancia, adem√°s, los algoritmos de b√∫squeda cuando la clasificaci√≥n comenz√≥ a tener en cuenta el tiempo de carga de la p√°gina.  En este sentido, los propietarios de sitios a menudo usan herramientas similares para evaluar el rendimiento del sitio.  Por lo tanto, es muy importante conectar de manera √≥ptima el c√≥digo al sitio, ya que afecta directamente su tiempo de descarga. <br><br>  Esto significa que debe utilizar t√©cnicas modernas para optimizar la carga de la p√°gina.  Por ejemplo, use Gzip, guarde en cach√© los archivos est√°ticos y las solicitudes, use la carga as√≠ncrona de scripts, comprima la est√°tica con algoritmos modernos como WebP / Brotli / etc. y use otras optimizaciones.  Regularmente realizamos auditor√≠as y respondemos a advertencias y recomendaciones para cumplir con los requisitos actuales. <br><br><h3>  <font color="#00bf54">CDN</font> </h3><br>  En las primeras versiones, descargamos estad√≠sticas de los servidores de aplicaciones.  Pero este enfoque tiene desventajas: tr√°fico costoso, lejan√≠a de los visitantes del sitio y carga excesiva en el canal del servidor.  Puede obstruir f√°cilmente el canal de los servidores de aplicaciones con el efecto habr de los sitios, ya que el tr√°fico est√°tico es muy "pesado". <br><br>  Para ahorrar presupuesto, estabilidad y reducir la latencia de la red, es √≥ptimo descargar estad√≠sticas de servidores especialmente dise√±ados para esto.  Puede usar proveedores de CDN ya preparados, pero a gran escala no es barato y tiene que estar limitado por las capacidades que proporciona este o aquel proveedor. <br><br><img src="https://habrastorage.org/webt/vi/jy/f3/vijyf3bxfqmihwwfswlfqzxtqie.png"><br><br>  Lo implementamos simplemente, pedimos servidores econ√≥micos en Rusia, Europa y Am√©rica con tr√°fico ilimitado y un amplio canal.  Es barato, no nos impone restricciones, podemos personalizar todo para nosotros y el mecanismo que funciona en el navegador garantiza la tolerancia a fallos.  Actualmente, se cargan diariamente 1 TB de estad√≠sticas de nuestros servidores CDN. <br><br><h3>  <font color="#00bf54">Tolerancia a fallos</font> </h3><br>  Desafortunadamente, el mundo no es perfecto, se producen incendios, los enlaces ascendentes caen, los CD se sumergen por completo, el ILV bloquea las subredes y las personas cometen errores.  Sin embargo, es necesario poder manejar tales situaciones y continuar trabajando. <br><br>  <b>Monitoreo</b> <br>  Primero debes entender que algo sali√≥ mal.  Por supuesto, puede esperar hasta que los usuarios vengan y se quejen, pero es mejor configurar el monitoreo y las alertas, y despu√©s de los lanzamientos, verificar si todo est√° en orden.  Monitoreamos muchos par√°metros diferentes, tanto del servidor como del cliente, y si algo sali√≥ mal, lo vemos de inmediato.  Por ejemplo, la cantidad de descargas de widgets o un aumento anormal del tr√°fico en los servidores CDN ha disminuido. <br><br><img src="https://habrastorage.org/webt/z7/kp/dq/z7kpdqcble85t395hv7z_bqt8fg.png"><br>  <i>El n√∫mero total de descargas de widgets para cada versi√≥n</i> <br><br>  <b>Colecci√≥n de errores</b> <br>  JavaScript es un lenguaje muy espec√≠fico y es f√°cil cometer un error.  Adem√°s, el zool√≥gico de navegadores en la web moderna es muy grande;  lo que funciona en el √∫ltimo Chrome no es un hecho que funcione en Safari o Firefox.  Por lo tanto, es muy importante configurar la recopilaci√≥n de errores desde el navegador y responder a los picos a tiempo.  Si su c√≥digo funciona en un iframe, puede hacerlo mediante el seguimiento del controlador global window.onerror y, en caso de error, enviar datos al servidor.  Si el c√≥digo funciona fuera del iframe, entonces es muy dif√≠cil implementar la recopilaci√≥n de errores. <br><br><img src="https://habrastorage.org/webt/g-/d6/jd/g-d6jddyvo9gpslniix1ndyvo1y.png"><br>  <i>El n√∫mero total de errores de todos los sitios y navegadores.</i> <br><br><img src="https://habrastorage.org/webt/3w/fp/ju/3wfpjuzxcyzpfervxtkq6o_zx10.png"><br>  <i>Informaci√≥n de error espec√≠fico</i> <br><br>  <b>Conmutaci√≥n por error de CDN</b> <br>  Ya escrib√≠ anteriormente que todo tiene la propiedad de caerse, por lo que es importante manejar estas situaciones y mejor, autom√°ticamente.  Pasamos por varias etapas del retroceso de los servidores CDN, comenzamos desde el manual y finalmente encontramos una manera de hacerlo de manera autom√°tica y √≥ptima para el navegador. <br><br>  En modo manual, esto funcion√≥ simplemente: SMS recibi√≥ administradores que dec√≠an que el CDN estaba inactivo, realizaron ciertas manipulaciones, despu√©s de lo cual el widget comenz√≥ a cargarse desde los servidores de aplicaciones.  Esto puede llevar de 5 minutos a 2 horas. <br><br>  Para implementar la recuperaci√≥n autom√°tica, debe detectar de alguna manera que el script ha comenzado a cargarse, pero esto no es tan f√°cil como parece.  El navegador no proporciona la capacidad de monitorear estados intermedios de la carga de la etiqueta del script, como el evento onprogress en XMLHttpRequest, pero solo informa el evento cuando el script se carga y ejecuta.  Tambi√©n es imposible que un tiempo aceptable descubra que el servidor no est√° disponible actualmente, el √∫nico evento de error se activa despu√©s de que expira el tiempo de espera de la solicitud, m√°s de 1 minuto.  En un minuto, el visitante ya puede abandonar la p√°gina, pero el script no se cargar√°. <br><br>  Probamos diferentes opciones, simples y complejas, pero al final se nos ocurri√≥ una solicitud de ping para un servidor CDN.  Funciona as√≠: primero hacemos ping al servidor CDN, si responde, luego cargamos el widget desde √©l.  Para implementar este esquema de manera √≥ptima para el navegador y nuestros servidores, utilizamos una solicitud HEAD ligera (sin cuerpo), y durante las descargas posteriores no lo hacemos hasta que se actualiza la versi√≥n del widget, porque el widget ya est√° en la memoria cach√© del navegador. <br><br><img src="https://habrastorage.org/webt/r-/zf/gh/r-zfghwbzyarwvybwbdkbaaz5py.png"><br>  Por lo tanto, recibimos una detecci√≥n muy r√°pida y autom√°tica de la disponibilidad del servidor est√°tico y, en caso de una ca√≠da, cambiamos al servidor de respaldo casi sin demora. <br><br><h3>  <font color="#00bf54">Cargador</font> </h3><br>  Para cargar su script en un sitio de terceros, debe tener en cuenta muchos puntos, pero es dif√≠cil implementar esta l√≥gica en el c√≥digo de inserci√≥n, ya que simplemente se convertir√° en "carne".  Pero a√∫n necesita hacer esto, para esto hemos creado un peque√±o m√≥dulo que gestiona toda esta l√≥gica "bajo el cap√≥" y carga el c√≥digo principal del widget.  Primero se carga e implementa CDN Failover, almacenamiento en cach√©, compatibilidad con c√≥digos de inserci√≥n antiguos, pruebas A / B, dise√±o gradual de la nueva versi√≥n del widget y muchas otras funciones. <br><br><img src="https://habrastorage.org/webt/-e/pj/-j/-epj-jpym6xcdxu9bk7axxtmtsa.png"><br>  Por lo tanto, en etapas, llegamos a un esquema que cubre los casos principales de carga e inicializaci√≥n del widget.  Ella ha demostrado su efectividad a lo largo de los a√±os de uso en una gran cantidad de sitios diferentes.  Al mismo tiempo, el c√≥digo de inserci√≥n sigue siendo simple y universal, ya que no tiene l√≥gica y podemos cambiarlo en cualquier momento, sin obligar a los usuarios a cambiar el c√≥digo de inserci√≥n. <br><br><h3>  <font color="#00bf54">Servicios de terceros</font> </h3><br>  Y, por √∫ltimo, vale la pena mencionar los servicios de terceros que se conectan al sitio o de alguna manera interact√∫an con los sitios: robots de b√∫squeda, an√°lisis, varios analizadores, etc.  Estos servicios dejan una huella en el trabajo, tampoco debe olvidarse de esto.  Te contar√© algunos casos de nuestra pr√°ctica. <br><br>  <b>Googlebot</b> <br>  La aplicaci√≥n de nuestro operador tiene la funci√≥n "Visitantes", en la que puede ver los visitantes que actualmente est√°n viendo el sitio, y diversa informaci√≥n sobre ellos: tiempo en el sitio, p√°gina, n√∫mero de p√°ginas visitadas, etc.  En alg√∫n momento, los clientes comenzaron a quejarse de que estaban "colgando" visitantes de otros sitios, es decir, en el sitio que vend√≠a iPhones, un cliente que supuestamente ten√≠a una p√°gina llamada "Comprar crema para la cara".  Cuando comenzaron a resolverlo, result√≥ que era GoogleBot, que, al cambiar de un sitio a otro, primero almacen√≥ en cach√© LocalStorage y luego transfiri√≥ datos incorrectos al servidor. <br><br>  La soluci√≥n es simple, el servidor comenz√≥ a ignorar los datos de GoogleBot. <br><br>  <b>Yandex.Metrica</b> <br>  Hay una caracter√≠stica maravillosa en la m√©trica: un navegador web que le permite ver lo que el usuario vio e hizo en forma de screencast.  Para hacer esto, la m√©trica registra todas las acciones del usuario, y despu√©s de que un robot de m√©trica especial recorre los sitios, realiza las mismas acciones y lo registra.  El problema era que para emular el navegador m√≥vil del usuario, de acuerdo con nuestros datos, Firefox estaba activado en el modo de emulaci√≥n m√≥vil, pero el Agente de usuario en el bot era de escritorio. <br><br>  Esto condujo al hecho de que al ver sesiones de usuarios m√≥viles en el navegador web, la versi√≥n de escritorio del widget se abr√≠a en las grabaciones, aunque, de hecho, los usuarios abr√≠an la versi√≥n m√≥vil.  Nuestros clientes pensaron que s√≠, y nos bombardearon con quejas.     ,     , ,      ,        . <br><br>   , , ,      . <br><br><h3> <font color="#00bf54"></font> </h3><br>      ,        .   ,         .                , ,    NodeJS   ,     270         -    ,         . <br><br>   ,        ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452802/">https://habr.com/ru/post/452802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452792/index.html">Revisi√≥n de SSD de estado s√≥lido para usuarios corporativos Kingston DC500R</a></li>
<li><a href="../452794/index.html">Sobre la localizaci√≥n de productos. Primera parte: ¬øpor d√≥nde empezar?</a></li>
<li><a href="../452796/index.html">Te invitamos a la reuni√≥n del departamento de desarrollo de juegos de GeekUniversity</a></li>
<li><a href="../452798/index.html">Almacenamiento y clasificaci√≥n autom√°tica de fotos y otros archivos. Trabajar con almacenamiento de archivos basado en NAS Synology</a></li>
<li><a href="../452800/index.html">Microbiota C√≥mo las bacterias intestinales afectan la enfermedad</a></li>
<li><a href="../452804/index.html">Renunci√© al trabajo de mis sue√±os porque no soporto el desarrollo de productos</a></li>
<li><a href="../452806/index.html">Entrevista: 10 preguntas sobre Swift. Parte 2</a></li>
<li><a href="../452808/index.html">Gesti√≥n de un equipo de programadores: ¬øc√≥mo y c√≥mo motivarlos correctamente? Parte dos</a></li>
<li><a href="../452812/index.html">Recib√≠ un cheque 0x $ 3.00 de Knut</a></li>
<li><a href="../452816/index.html">¬øQu√© pasar√° el 1 de febrero de 2020?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>