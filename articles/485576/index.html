<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåó üî¢ üõÅ Caracter√≠sticas de establecer una conexi√≥n entre los participantes en un juego de red de igual a igual ‚ùáÔ∏è üè≠ ü§Ωüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta es una recopilaci√≥n de informaci√≥n que necesitaba para implementar la etapa de establecer una conexi√≥n entre los participantes en un juego de red...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Caracter√≠sticas de establecer una conexi√≥n entre los participantes en un juego de red de igual a igual</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485576/"> Esta es una recopilaci√≥n de informaci√≥n que necesitaba para implementar la etapa de establecer una conexi√≥n entre los participantes en un juego de red de igual a igual utilizando el protocolo UDP. <br><br>  El art√≠culo est√° dise√±ado para desarrolladores de juegos para principiantes.  Trat√© de escribir un art√≠culo que yo mismo quisiera leer en un momento en que apenas comenzaba a entender este tema: para que todos los matices necesarios se recopilen en un solo lugar, pero al mismo tiempo no hay nada superfluo, en un lenguaje simple y con im√°genes visuales.  Tal vez alguien sea √∫til. <br><br>  Es poco probable que los desarrolladores de juegos experimentados encuentren algo nuevo para ellos aqu√≠.  Pero agradecer√© los comentarios y comentarios. <br><br><div style="text-align:center;"> <a href="https://habr.com/ru/post/485576/"><img src="https://habrastorage.org/webt/pg/wy/7h/pgwy7h2hgc0rws8_5-btx0brno8.png"></a> </div><br><a name="habracut"></a><br><h2>  Juego en red con arquitectura peer-to-peer </h2><br><ul><li>  Cada jugador almacena todo el estado del mundo del juego y lo procesa sincr√≥nicamente con otros jugadores.  Cada jugador pasa las acciones del usuario a todos los dem√°s jugadores.  El jugador principal que recoge a los otros jugadores se llama servidor y el resto son clientes.  El servidor es el principal solo en la etapa de recolecci√≥n de jugadores.  Y durante el juego no hay computadora principal. <br></li><li>  Este enfoque tiene las siguientes caracter√≠sticas: <br><ul><li>  El tr√°fico no depende de la complejidad del mundo del juego, sino solo del n√∫mero de jugadores.  En este modo, <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25B8%25D1%258F_%25D0%25B2_%25D1%2580%25D0%25B5%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25BC_%25D0%25B2%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B8" rel="nofollow">las estrategias en tiempo real</a> generalmente funcionan, donde necesita procesar miles de unidades. <br></li><li>  El volumen de tr√°fico es del orden de N¬≤, donde N es el n√∫mero de jugadores.  Por lo tanto, este enfoque es aplicable solo para juegos con un peque√±o n√∫mero de jugadores. <br></li><li>  Dado que los datos se transmiten directamente entre jugadores sin un servidor intermedio, los retrasos de transmisi√≥n (retrasos) son m√≠nimos.  Pero si al menos uno de los jugadores tiene problemas de comunicaci√≥n, esto afectar√° a todos los jugadores. <br></li><li>  Es necesario establecer canales de comunicaci√≥n entre todos los jugadores.  Pero si los jugadores est√°n en diferentes redes locales, entonces esto no siempre es posible. <br></li></ul></li><li>  Puedes usar TCP o UDP para transferir datos en el juego. <br><ul><li>  <a href="https://ru.wikipedia.org/wiki/Transmission_Control_Protocol" rel="nofollow">TCP (Protocolo de control de transmisi√≥n)</a> proporciona una entrega confiable de flujo de bytes.  Esto simplifica la implementaci√≥n del juego, pero no hay control sobre los retrasos en la transmisi√≥n de datos. <br></li><li>  <a href="https://ru.wikipedia.org/wiki/UDP" rel="nofollow">UDP (User Datagram Protocol)</a> es un protocolo simple de transferencia de paquetes sin una garant√≠a de su entrega.  Pero debido a su simplicidad, UDP se usa en sistemas en tiempo real cuando es inaceptable esperar paquetes retrasados ‚Äã‚Äão perdidos.  El uso de UDP puede reducir los retrasos en el juego, pero complica la implementaci√≥n del juego. <br></li></ul>  Este art√≠culo describe el uso de UDP. <br></li></ul><br><h2>  Establecer una conexi√≥n en la red local </h2><br><ul><li>  Para establecer una conexi√≥n entre jugadores, el cliente necesita conocer la direcci√≥n IP del servidor y el puerto que escucha el programa del juego. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n3/di/2u/n3di2usgoz4bj4cyqcmbk3txocy.png"></div><br><ul><li>  Por ejemplo, la computadora del jugador A tiene una direcci√≥n IP de 192.168.1.2 en la red local.  El jugador A inicia el programa del juego en su computadora en modo servidor, y el programa escucha en el puerto 50120. El jugador A de alguna manera comunica esta informaci√≥n al jugador B. <br></li><li>  La computadora del jugador B tiene una direcci√≥n IP de 192.168.1.5 en la red local.  El jugador B inicia el programa del juego en su computadora en modo cliente, y el programa ocupa el puerto 50150. El jugador B ingresa la direcci√≥n del servidor 192.168.1.2‚ñ∫0120 en el programa del juego, y el programa env√≠a una solicitud al servidor en la direcci√≥n especificada. <br></li><li>  El servidor est√° en modo de espera y, tras recibir una solicitud del jugador B, encontrar√° su direcci√≥n 192.168.1.5‚ñ∫0150.  Por lo tanto, el cliente y el servidor establecieron una conexi√≥n y pueden iniciar el juego. <br></li></ul></li><li>  Si varios clientes est√°n conectados al servidor, entonces el servidor debe enviar a cada uno de ellos las direcciones de otros clientes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f9/zu/zg/f9zuzgexmd5bqe8fxgypsynspyu.png"></div><br>  En el ejemplo de la imagen, el servidor A env√≠a al cliente B la direcci√≥n del cliente C (192.168.1.6‚ñ∫0160), y al cliente C env√≠a la direcci√≥n del cliente B (192.168.1.5‚ñ∫0150).  Por lo tanto, todos los jugadores podr√°n establecer conexiones "cada uno con cada uno". <br></li><li>  Cada vez que se inicia el juego, el servidor puede solicitar cualquier puerto libre del sistema operativo.  Pero es m√°s conveniente usar el mismo puerto cada vez para que el cliente no tenga que ingresar un nuevo puerto cada vez. <br><br>  Todos los puertos se dividen en tres rangos: <br><ul><li>  [0, 1023] - bien conocido (sist√©mico). <br></li><li>  [1024, 49151] - registrado (usuario).  El puerto para el servidor debe seleccionarse en este rango. <br></li><li>  [49152, 65535] - din√°mico (privado).  Aqu√≠, el sistema operativo asigna puertos temporales para los programas. <br></li></ul><br>  En Wikipedia, puede ver una lista de <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BA_%25D0%25BF%25D0%25BE%25D1%2580%25D1%2582%25D0%25BE%25D0%25B2_TCP_%25D0%25B8_UDP" rel="nofollow">puertos reservados</a> .  A continuaci√≥n, por ejemplo, se selecciona el puerto 49094 para el servidor de juegos. <br></li><li>  Una computadora puede tener varias interfaces de red, tanto reales (Ethernet, WiFi) como virtuales (VPN).  Cada interfaz de red tiene su propia direcci√≥n IP.  El programa puede proporcionar al usuario del servidor la oportunidad de seleccionar la interfaz de red mediante la cual esperar√° las solicitudes del cliente.  Pero es conveniente usar una direcci√≥n IP comod√≠n especial <a href="https://en.wikipedia.org/wiki/0.0.0.0" rel="nofollow">0.0.0.0</a> .  Si el programa abre un socket con esta direcci√≥n IP, escuchar√° el puerto especificado para todas las interfaces de red de esta computadora.  Por lo tanto, el jugador no tiene que pensar qu√© interfaz de red elegir. <br></li><li>  Tambi√©n puede ayudar al cliente y determinar autom√°ticamente la direcci√≥n IP del servidor.  Si el cliente env√≠a una solicitud a una <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B8%25D1%2580%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25B5%25D1%2589%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B5%25D1%2581" rel="nofollow">direcci√≥n IP de transmisi√≥n</a> especial <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B8%25D1%2580%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25B5%25D1%2589%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B5%25D1%2581" rel="nofollow">(transmisi√≥n)</a> , todas las computadoras de la red local la recibir√°n. <br><br>  Por ejemplo, si la direcci√≥n de red es 192.168.1.0, la m√°scara de subred es 255.255.255.0, entonces la direcci√≥n IP de transmisi√≥n ser√° 192.168.1.255. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4y/yj/ot/4yyjotxuzbtirqk2pewwm_npmd8.png"></div><br>  Si todos los servidores de juegos est√°n escuchando en el puerto 49094, entonces el paquete enviado a la direcci√≥n 192.168.1.255-00-009094 ser√° recibido por todos los servidores de juegos en esta red.  Cada servidor enviar√° una confirmaci√≥n al remitente.  Y as√≠, el cliente recibir√° una lista de todos los servidores del juego en su red, y podr√° seleccionar el servidor que necesita. <br></li><li>  Si todos los jugadores est√°n en la misma red local, entonces establecer conexiones "cada una con cada" es bastante simple.  Puede haber problemas con el acceso del cliente al puerto del servidor debido a Firewall.  Pero depende del sistema operativo y la configuraci√≥n de seguridad. <br></li></ul><br><h2>  Establecer una conexi√≥n desde una red local a un servidor en Internet </h2><br><ul><li>  Como regla general, las computadoras no est√°n conectadas a Internet directamente, sino a trav√©s de un enrutador.  Y, como regla, el enrutador realiza <a href="https://ru.wikipedia.org/wiki/NAT" rel="nofollow">la traducci√≥n de direcciones de red (NAT, traducci√≥n de direcciones de red)</a> . <br><br>  Por ejemplo, el cliente C est√° en la red local y tiene acceso a Internet a trav√©s del enrutador B, mientras que el servidor A tiene una direcci√≥n IP p√∫blica en Internet.  Perm√≠tales tener las siguientes direcciones: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/cf/qt/gqcfqtu-vneghva8qq7v2do7lxo.png"></div><br><ul><li>  La direcci√≥n de Internet del servidor A es 203.0.113.2.  El programa del servidor escucha en el puerto 49094. <br></li><li>  La direcci√≥n del enrutador B en Internet es 203.0.113.5.  La direcci√≥n del enrutador B en la red local es 192.168.1.1. <br></li><li>  La direcci√≥n del cliente C en la red local es 192.168.1.5.  El programa cliente ocupa el puerto 50150 y env√≠a un paquete al servidor en 203.0.113.2-00-009094. <br></li><li>  El enrutador B es la <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25BB%25D1%258E%25D0%25B7_%25D0%25BF%25D0%25BE_%25D1%2583%25D0%25BC%25D0%25BE%25D0%25BB%25D1%2587%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258E" rel="nofollow">puerta</a> de <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25BB%25D1%258E%25D0%25B7_%25D0%25BF%25D0%25BE_%25D1%2583%25D0%25BC%25D0%25BE%25D0%25BB%25D1%2587%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258E" rel="nofollow">enlace predeterminada</a> en su red local.  Es decir, todos los paquetes con direcciones que no pertenecen a la red local actual se env√≠an a ella. <br></li><li>  El enrutador tiene una tabla de traducci√≥n de direcciones: (direcci√≥n interna: puerto interno) - (direcci√≥n externa: puerto externo).  Despu√©s de recibir un paquete del cliente al servidor 203.0.113.2-00-009094, el enrutador selecciona cualquier puerto externo libre, por ejemplo 52050, y crea una entrada en la tabla de traducci√≥n de direcciones: 192.168.1.5‚ñ∫0150 - 203.0.113.5‚ñ∫2050. <br></li><li>  El enrutador reemplaza la direcci√≥n interna del remitente 192.168.1.5/100150 en el paquete con la direcci√≥n externa 203.0.113.5/102050, y transfiere el paquete cambiado al servidor. <br></li><li>  El servidor recibe un paquete con la direcci√≥n del remitente 203.0.113.5‚ñ∫ 2020, y env√≠a una respuesta a esta direcci√≥n, es decir, al enrutador. <br></li><li>  Despu√©s de recibir el paquete del servidor, el enrutador busca la direcci√≥n del destinatario en su tabla de traducci√≥n de direcciones, realiza el reemplazo inverso de la direcci√≥n externa del destinatario 203.0.113.5‚ñ∫2050 con la direcci√≥n interna 192.168.1.5‚ñ∫0150, y env√≠a el paquete a esta direcci√≥n, es decir, al cliente. <br></li><li>  Si el cliente env√≠a paquetes subsiguientes al servidor, el enrutador mira la direcci√≥n del remitente para ver si ese registro ya existe en la tabla y, de ser as√≠, utiliza el puerto externo previamente asignado, en este caso 52050. <br></li><li>  Por lo tanto, el cliente y el servidor establecieron una conexi√≥n a trav√©s de NAT y pueden iniciar el juego.  Pero el servidor no conoce la direcci√≥n interna del cliente en su red local y considera que el cliente es un enrutador. <br></li><li>  La entrada en la tabla de traducci√≥n de direcciones es v√°lida por un cierto per√≠odo de tiempo, generalmente de 1 a 3 minutos.  Por lo tanto, el cliente y el servidor necesitan intercambiar paquetes peri√≥dicamente para que no se elimine el registro que los conecta.  Si el cliente env√≠a un nuevo paquete al servidor despu√©s de eliminar el registro, se puede asignar un puerto externo diferente para el nuevo registro en el enrutador, y para el servidor ser√° otro cliente con una direcci√≥n diferente. <br></li></ul></li><li>  Como regla general, el enrutador del usuario no est√° conectado directamente a Internet, sino que se encuentra en la red interna del proveedor de Internet.  Es decir, el cliente est√° detr√°s de dos NAT. <br><br>  Por ejemplo, as√≠: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7u/ht/cw/7uhtcwvuy-lojgg6_sxifcd_ucc.png"></div><br>  Es decir, se realiza una doble traducci√≥n de las direcciones de red. <br></li><li>  Existen diferentes tipos de NAT: <br><ul><li>  Cono completo NAT <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gn/ar/8u/gnar8u7m0xlyigrhgihadyqe0d0.png"></div><br><ul><li>  Despu√©s de crear una entrada en la tabla de traducci√≥n de direcciones (direcci√≥n interna: puerto interno) - (direcci√≥n externa: puerto externo), todos los paquetes del remitente (direcci√≥n interna: puerto interno) se transmiten a trav√©s de (direcci√≥n externa: puerto externo) a cualquier direcci√≥n de destinatario. <br></li><li>  Cualquier servidor externo puede enviar paquetes a (direcci√≥n interna: puerto interno), enviando paquetes a (direcci√≥n externa: puerto externo). <br></li></ul>  Por ejemplo, el cliente C env√≠a paquetes a los servidores A y D utilizando la misma direcci√≥n externa 203.0.113.5‚ñ∫ 202050.  Si el servidor E env√≠a un paquete a esta direcci√≥n 203.0.113.5‚ñ∫ 202050, el enrutador lo pasar√° al cliente C. <br></li><li>  Cono restringido por direcci√≥n NAT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i6/on/ao/i6onaojluqotmemktgufswzg-ia.png"></div><br><ul><li>  Despu√©s de crear una entrada en la tabla de traducci√≥n de direcciones (direcci√≥n interna: puerto interno) - (direcci√≥n externa: puerto externo), todos los paquetes del remitente (direcci√≥n interna: puerto interno) se transmiten a trav√©s de (direcci√≥n externa: puerto externo) a cualquier direcci√≥n de destinatario. <br></li><li>  Un servidor externo (direcci√≥n del servidor: puerto del servidor) puede enviar paquetes a (direcci√≥n interna: puerto interno), enviando paquetes a (direcci√≥n externa: puerto externo) solo si (direcci√≥n interna: puerto interno) envi√≥ previamente paquetes a (direcci√≥n del servidor: cualquiera puerto). <br></li></ul>  Por ejemplo, el cliente C env√≠a paquetes a los servidores A y D utilizando la misma direcci√≥n externa 203.0.113.5‚ñ∫ 202050.  El servidor D puede enviar un paquete al cliente C a trav√©s de la direcci√≥n de enrutador 203.0.113.5‚ñ∫ 202050 desde cualquiera de sus puertos.  Pero el enrutador no pasar√° paquetes del servidor E. <br></li><li>  Cono restringido a puertos NAT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kr/6v/di/kr6vdi2regppcywwajtz-1basdy.png"></div><br><ul><li>  Despu√©s de crear una entrada en la tabla de traducci√≥n de direcciones (direcci√≥n interna: puerto interno) - (direcci√≥n externa: puerto externo), todos los paquetes del remitente (direcci√≥n interna: puerto interno) se transmiten a trav√©s de (direcci√≥n externa: puerto externo) a cualquier direcci√≥n de destinatario. <br></li><li>  Un servidor externo (direcci√≥n del servidor: puerto del servidor) puede enviar paquetes a (direcci√≥n interna: puerto interno), enviando paquetes a (direcci√≥n externa: puerto externo) solo si (direcci√≥n interna: puerto interno) envi√≥ paquetes previamente a (direcci√≥n del servidor: puerto servidor). <br></li></ul>  Por ejemplo, el cliente C env√≠a paquetes a los servidores A y D utilizando la misma direcci√≥n externa 203.0.113.5‚ñ∫ 202050.  El enrutador no pasar√° paquetes desde el servidor E u otro puerto del servidor D. <br></li><li>  NAT sim√©trica (NAT sim√©trica). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ha/lr/98halr7veiq_ibj_irj2lxixcec.png"></div><br><ul><li>  Si el mismo remitente interno (direcci√≥n interna: puerto interno) env√≠a paquetes a diferentes destinatarios (direcci√≥n del servidor: puerto del servidor), se asignar√° un puerto externo separado para cada direcci√≥n de destinatario y se usar√° una entrada separada en la tabla de traducci√≥n de direcciones. <br></li><li>  Solo el servidor externo (direcci√≥n del servidor: puerto del servidor) que recibi√≥ el paquete del remitente interno (direcci√≥n interna: puerto interno) puede devolver el paquete. <br></li></ul>  Por ejemplo, el cliente C env√≠a paquetes al servidor A usando una direcci√≥n externa 203.0.113.5‚ñ∫ 202050, y al servidor D usando otra direcci√≥n externa 203.0.113.5. 20201.  El enrutador no pasar√° paquetes desde el servidor E u otro puerto del servidor D. <br></li></ul></li><li>  Si varios clientes est√°n conectados al servidor del juego, entonces para un juego entre pares, debe establecer una conexi√≥n directamente entre cada par de clientes sin pasar por el servidor. <br><br>  Por ejemplo, dos clientes C y E conectados al servidor A: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ai/if/ym/aiifymcc-epffu0da8rkksj_4es.png"></div><br><ul><li>  El cliente C tiene una direcci√≥n interna de 192.168.1.5/100150 y una direcci√≥n externa de 203.0.113.5/102050. <br></li><li>  El cliente E tiene una direcci√≥n interna de 192.168.2.5:50250 y una direcci√≥n externa de 203.0.113.6-062060. <br></li><li>  El servidor debe informar a cada cliente la direcci√≥n externa del otro cliente. <br></li><li>  Por lo general, los enrutadores utilizan un cono NAT de tipo puerto restringido.  El enrutador pasa los paquetes al cliente solo desde el remitente (direcci√≥n IP y puerto) al que el cliente envi√≥ los paquetes anteriormente.  Y si el cliente C env√≠a un paquete al cliente E, el enrutador D no perder√° este paquete. <br></li><li>  En este caso, se utiliza el m√©todo de <a href="https://en.wikipedia.org/wiki/UDP_hole_punching" rel="nofollow">perforaci√≥n de agujeros UDP</a> .  Ambos clientes deben enviarse paquetes UDP entre s√≠.  Tan pronto como el cliente C env√≠e un paquete al cliente E, el enrutador B estar√° listo para recibir paquetes del cliente E. De manera similar, tan pronto como el cliente E env√≠e un paquete al cliente C, el enrutador D estar√° listo para recibir paquetes del cliente C. Los primeros paquetes del cliente que inici√≥ transmitir primero se perder√°.  Pero tan pronto como el segundo cliente tambi√©n comience a enviar paquetes, ambos clientes podr√°n intercambiar paquetes. <br></li><li>  Pero si el enrutador usa NAT sim√©trica, se asignar√° un nuevo puerto externo para cada destinatario.  Y, como regla, no hay forma de averiguar qu√© puerto ha asignado el enrutador.  Por lo tanto, si al menos uno de los enrutadores utiliza NAT sim√©trica, ser√° imposible establecer una conexi√≥n entre los clientes. <br></li></ul></li><li>  Si dos clientes est√°n en la misma red local, entonces solo conocer√°n las direcciones externas de cada uno. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jj/si/a4/jjsia4y7k50gk3esxa_5hvzx3ks.png"></div><br>  Por ejemplo, el cliente C env√≠a un paquete al cliente D en su direcci√≥n externa 203.0.113.5Point2051.  El enrutador B debe procesar este paquete como si se hubiera recibido de una red externa, reemplazar la direcci√≥n del destinatario 203.0.113.5‚ñ∫ 20205 con la direcci√≥n interna del cliente D 192.168.1.6‚ñ∫0060 y enviar el paquete al cliente D nuevamente a la red local.  Esta funci√≥n de enrutador se llama <a href="https://ru.wikipedia.org/wiki/NAT" rel="nofollow">NAT loopback</a> ( <a href="https://en.wikipedia.org/wiki/Hairpinning" rel="nofollow">NAT hairpinning</a> ).  Si NAT loopback est√° deshabilitado en el enrutador, entonces ser√° imposible establecer una conexi√≥n entre clientes. <br></li><li>  Los clientes pueden estar ubicados en diferentes redes locales, pero tienen acceso a Internet a trav√©s de un proveedor de Internet com√∫n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q8/dj/yo/q8djyoaqbhaq6z3_wxc7_afbphk.png"></div><br>  Si NAT loopback est√° desactivado en el equipo del proveedor de servicios de Internet, ser√° imposible establecer una conexi√≥n entre los clientes. <br></li><li>  ¬øQu√© debo hacer si se utiliza NAT sim√©trica en el enrutador o si se desactiva NAT loopback? <br><br>  Seg√∫n tengo entendido, la √∫nica forma confiable de resolver estos problemas es transferir paquetes no directamente entre clientes, sino a trav√©s de un servidor.  Es necesario implementar esta funci√≥n en el programa del juego dentro del marco de la arquitectura punto a punto o implementar la arquitectura cliente-servidor. <br><br>  O puede usar programas de terceros para crear una VPN, por ejemplo <a href="https://ru.wikipedia.org/wiki/LogMeIn_Hamachi" rel="nofollow">LogMeIn Hamachi</a> . <br></li></ul><br><h2>  Establecimiento de una conexi√≥n entre LAN en Internet </h2><br><ul><li>  Como regla general, ninguno de los jugadores tiene una direcci√≥n IP p√∫blica, y los jugadores est√°n en diferentes redes locales detr√°s de NAT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/56/cr/up/56crup-geun05fnbtaokha2vqia.png"></div><br>  Por ejemplo, en este esquema, el cliente C enviar√° paquetes al servidor A en su direcci√≥n externa 203.0.113.2-022020, en la cual el puerto es seleccionado por el enrutador B. Por lo tanto, elegir el puerto interno del servidor A no importa, y puede seleccionar cualquier puerto.  En este caso, en lugar del puerto 49094, el servidor A puede solicitar cualquier puerto libre del sistema operativo, por ejemplo 50120. <br></li><li>  Para que el servidor A y el cliente C establezcan una conexi√≥n, primero, cada uno de ellos necesita encontrar de alguna manera su direcci√≥n externa. <br><br>  Puede utilizar el protocolo <a href="https://ru.wikipedia.org/wiki/STUN" rel="nofollow">STUN (Utilidades de recorrido de sesi√≥n para NAT) para esto</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sk/lj/cm/skljcmi1c5ztbt6law8nf_ylsy0.png"></div><br>  El protocolo STUN permite al cliente ubicado detr√°s de NAT determinar su puerto y direcci√≥n IP externa. <br><br>  Los mensajes STUN se env√≠an en paquetes UDP. <br><br>  El cliente puede acceder a cualquiera de los servidores STUN p√∫blicos.  Se puede encontrar una lista de servidores STUN p√∫blicos en <a href="https://ru.wikipedia.org/wiki/STUN" rel="nofollow">Wikipedia</a> .  O busque la <a href="https://www.google.com/search%3Fq%3Dpublic%2BSTUN%2Bservers%2Blist" rel="nofollow">"lista de servidores STUN p√∫blicos"</a> . <br><br>  Este m√©todo no es aplicable si al menos uno de los jugadores en el enrutador usa "NAT sim√©trica". <br></li><li>  Despu√©s de que cada uno de los jugadores haya aprendido su direcci√≥n externa, de alguna manera debe dar su direcci√≥n a todos los dem√°s jugadores. <br><br>  Para que los jugadores puedan intercambiar sus direcciones, puede usar su servidor p√∫blico.  En el diagrama, se llama servidor de direcciones. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ev/e_/fi/eve_fiqezp76wwmjfexsb0vlzka.png"></div><br>  Esto no requiere necesariamente un servidor dedicado.  Puede utilizar cualquier alojamiento con un <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B5%25D0%25B1-%25D1%2581%25D0%25B5%25D1%2580%25D0%25B2%25D0%25B5%25D1%2580" rel="nofollow">servidor web</a> y con el soporte de cualquier lenguaje de script, como PHP.  Usando el <a href="https://ru.wikipedia.org/wiki/HTTP" rel="nofollow">protocolo HTTP,</a> cada jugador debe enviar su direcci√≥n externa al servidor de direcciones.  Y luego solicite las direcciones de todos los dem√°s jugadores. <br></li><li>  Por ejemplo, cada servidor de juegos puede registrar su identificador √∫nico (game-id) en el servidor de direcciones.  Puede usar cualquier cadena como id del juego, por ejemplo, el apodo (alias) del usuario del servidor.  El usuario del servidor de alguna manera le dice a los jugadores a quienes quiere invitar a su juego.  Y estos jugadores podr√°n unirse al juego solicitando por id de juego del servidor de direcciones las direcciones externas de todos los participantes en este juego. <br></li><li>  Despu√©s de que cada jugador haya recibido las direcciones externas de todos los dem√°s jugadores, pueden establecer conexiones de uno a cada usando el <a href="https://en.wikipedia.org/wiki/UDP_hole_punching" rel="nofollow">m√©todo de perforaci√≥n de agujeros UDP</a> . <br></li></ul></div></div><p>Source: <a href="https://habr.com/ru/post/485576/">https://habr.com/ru/post/485576/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485556/index.html">Tom√≥ 12 a√±os crear una secci√≥n del mapa cerebral de Drosophila, los esfuerzos de 250 personas y $ 40 millones</a></li>
<li><a href="../485558/index.html">No hay mosquitos! Descripci√≥n general de los mosquitos "fito-municiones"</a></li>
<li><a href="../485562/index.html">Navegando en Internet con un Gamepad (Javascript)</a></li>
<li><a href="../485564/index.html">Ingenier√≠a inversa del protocolo ngrok v2</a></li>
<li><a href="../485570/index.html">Agregaci√≥n de rutas para listas ILV y c√≥mo amenaza servicios respetables</a></li>
<li><a href="../485578/index.html">Mahjong con ni√±os: para qu√©, cu√°ndo y c√≥mo</a></li>
<li><a href="../485582/index.html">Paul Graham: "Un inversor como reba√±o de animales" (2013)</a></li>
<li><a href="../485584/index.html">El resumen de materiales frescos del mundo del front-end para la √∫ltima semana No. 399 (20 al 26 de enero de 2020)</a></li>
<li><a href="../485586/index.html">Paul Graham: Ideas para Startups (Ideas para Startups, 2005)</a></li>
<li><a href="../485592/index.html">PHP Digest No. 172 (14-27 de enero de 2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>