<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕋 🙍🏾 👨‍👩‍👧‍👦 Lompat ke awan. Membangun solusi IoT anggaran di NodeMCU + Azure IoT Hub 👕 🍅 🏮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tujuan paling populer untuk perangkat IoT adalah pengumpulan telemetri. Hingga saat ini, harga untuk layanan cloud IoT telah menurun sedemikian rupa s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lompat ke awan. Membangun solusi IoT anggaran di NodeMCU + Azure IoT Hub</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/421847/"><p>  Tujuan paling populer untuk perangkat IoT adalah pengumpulan telemetri.  Hingga saat ini, harga untuk layanan cloud IoT telah menurun sedemikian rupa sehingga bahkan pengguna biasa pun dapat menggunakannya.  Hari ini kita akan berbicara tentang cara mengirim data ke cloud dari papan NodeMCU menggunakan bahasa Lua. </p><br><p><img src="https://habrastorage.org/webt/k3/f5/nx/k3f5nxom4hfjshqqwpgl43ppjwo.jpeg"><a name="habracut"></a></p><br><p>  <em>Catatan: kami melanjutkan serangkaian publikasi artikel versi lengkap dari majalah Hacker.</em>  <em>Ejaan dan tanda baca penulis disimpan.</em> </p><br><p>  Saya memberikan lantai kepada penulis. </p><br><p>  Karena saya bekerja di tumpukan teknologi Microsoft, saya menggunakan Fungsi Azure dan Penyimpanan Tabel untuk membuat bagian cloud dari solusi IoT, tetapi PoC saya untuk NodeMCU dan Lua juga dapat digunakan dengan penyedia cloud lainnya dari solusi IoT. </p><br><h1>  INFO </h1><br><p>  Expressif NodeMCU adalah salah satu motherboard yang paling terjangkau dengan Wi-Fi, micro USB dan on-board programmer.  Ini didasarkan pada modul ESP8266.  Papan generasi kedua dapat dibeli sekitar $ 6-7.  Anda dapat bekerja dengan papan dari Arduino IDE.  Selain itu, dewan mendukung bahasa penulisan yang disebut Lua (diterjemahkan dari bahasa Portugis sebagai "Bulan"). </p><br><h2>  Hubungkan dan konfigurasikan perangkat </h2><br><p>  Agar perangkat dikenali di bawah Windows, Anda perlu mengunduh driver dari tautan berikut: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">CP210x USB ke UART Bridge VCP Drivers</a> </p><br><p> Kecepatan port serial NodeMCU standar adalah 115'200bps.  Anda dapat mengatur kecepatan yang berbeda, pada reset pertama perangkat itu akan kembali ke 115200. <br>  Penting bahwa pengemudi diatur ke kecepatan yang persis sama: </p><br><p><img src="https://habrastorage.org/webt/ce/sq/y5/cesqy5kslu5pos-rrdqsxvch-vo.png"></p><br><h2>  Firmware </h2><br><p>  Kemungkinan besar, ada sesuatu yang terlewatkan dalam firmware awal, jadi idealnya mem-flash perangkat sendiri.  Ada beberapa cara untuk membangun citra Firmware.  Menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">layanan cloud</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">gambar Docker</a> , atau menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">instruksi untuk Linux</a> .  Saya mengumpulkan menggunakan layanan cloud.  Saya juga menyarankan Anda opsi ini. </p><br><p>  Jika Anda perlu mengirim data ke cloud, maka fungsi yang diperlukan untuk seleksi adalah SNTP, MQTT, HTTP (WiFi, timer, file, GPIO, net, node, UART sudah dipilih secara default).  Penting juga untuk menandai sebagaimana diperlukan dukungan TLS / SSL dalam opsi Lain-lain <br>  Tautan dengan file bin datang ke email.  Lebih tepatnya, bahkan 2 tautan langsung hadir.  Satu dengan gambar yang mendukung operasi titik mengambang, dan yang kedua dengan yang tidak mendukung. </p><br><p>  Sebelum menginstal ESP8266, Anda harus membawanya ke mode khusus.  Ada tombol FLASH terpisah di papan tulis.  Menekannya selama power-up atau menekan reset membawa perangkat ke mode bootloader.  Jika tiba-tiba tidak ada tombol seperti itu di papan modifikasi Anda, maka sebelum flashing Anda harus menghubungkan GPIO0 ke GND dan tekan reset (metode ini cocok untuk ESP-12). </p><br><p>  Firmware dapat di- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">flash</a> dengan utilitas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PyFlasher</a> .  Py dalam namanya berarti bahwa aplikasi tersebut ditulis dalam Python.  Ada juga <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">nodemcu-flasher</a> , tetapi belum diperbarui untuk waktu yang lama.  Saya belum mencobanya. </p><br><p>  Jendela PyFlasher terlihat seperti ini: </p><br><p><img src="https://habrastorage.org/webt/1a/ns/rh/1ansrh_oc-zpqvaif8eujfvetvg.png"></p><br><p>  Mode lampu kilat dipilih tergantung pada papan yang Anda miliki.  Kebanyakan motherboard modern berdasarkan pada modul ESP8266 ESP-12 dan ESP32 menggunakan mode DIO.  ESP8266 01 hingga 07 cocok dengan mode QIO yang lebih cepat.  DOUT digunakan oleh ESP8285. </p><br><h2>  Pengaturan IDE </h2><br><p>  Unduh IDE gratis di tautan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ESPlorer</a> .  Atau ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ZeroBrane Studio</a> .  Saya paling suka ESPlorer, jadi saya akan memberikan contoh bekerja dengannya.  ESPlorer ditulis dalam bahasa JAWA.  Antarmuka aplikasi </p><br><p><img src="https://habrastorage.org/webt/gi/lj/vs/giljvs_zxesytj7k52d_nlka_u8.png"></p><br><p>  Di sebelah kiri adalah kode, pengaturan dan beberapa fungsi serupa lainnya.  Di sebelah kanan adalah jendela pemantauan dan perintah manajemen perangkat.  Buka aplikasi, pilih port.  Tetapkan kecepatan pertukaran akan terjadi (kemungkinan besar adalah 115200) dan klik Buka. </p><br><p><img src="https://habrastorage.org/webt/1p/iq/xr/1piqxr933-f-nwkk6wagwtw42ea.png"></p><br><p>  Untuk pemanasan, Anda dapat menjalankan skrip sederhana yang berkedip dengan LED bawaan: </p><br><pre><code class="hljs powershell">LED = <span class="hljs-number"><span class="hljs-number">0</span></span> gpio.mode(LED, gpio.OUTPUT) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash_led</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.LOW)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(500000)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.HIGH)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1, 1000, tmr.ALARM_AUTO, flash_led)</span></span></span></span></code> </pre> <br><p>  Jika papan Anda tidak memiliki LED bawaan (atau Anda benar-benar bosan dengan contoh LED berkedip), maka Anda dapat mencoba menjalankan skrip yang lebih sederhana yang menampilkan baris: </p><br><pre> <code class="hljs swift"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from Lua!"</span></span>)</code> </pre> <br><p>  Setelah Anda membuat file .lua (katakan test.lua), tambahkan kode itu dan simpan ke disk, Anda dapat mengunduhnya ke perangkat Anda.  Untuk melakukan ini, buka port jika tidak terbuka (tombol Buka) dan klik tombol Unggah.  Anda dapat menemukannya di antara tombol-tombol yang terletak di bawah kode (di sebelah kiri). </p><br><p>  Setelah mengunduh file, Anda dapat menjalankannya dengan mengirimkan perintah: </p><br><pre> <code class="hljs lisp">dofile(<span class="hljs-string"><span class="hljs-string">"test.lua"</span></span>)</code> </pre> <br><p>  Perintah dapat dimasukkan secara manual di bidang bawah yang terletak di kanan bawah monitor.  Atau jika Anda tidak ingin mengetik teks apa pun, Anda dapat mengklik tombol Muat Ulang (baris tombol paling ekstrem di kanan).  Setelah mengklik tombol ini, Anda akan menerima daftar tombol dengan file .lua dimuat di papan tulis.  Mengklik tombol dengan nama file akan meluncurkan file untuk dieksekusi. </p><br><p>  Jika Anda ingin file mulai segera setelah dihidupkan, maka buat file bernama init.lua. </p><br><h2>  Mengkonfigurasi bagian cloud untuk bekerja dengan perangkat </h2><br><p>  Mari kita tinggalkan perangkat kita untuk beberapa waktu dan buat gandanya di cloud.  Baru-baru ini, perangkat ganda dapat dibuat langsung di portal Azure, menggunakan fungsionalitas baru.  Di grup pengaturan hub IoT yang disebut Penjelajah, Anda harus memilih Perangkat IoT dan klik “+ Tambah” </p><br><p>  Untuk menghubungkan perangkat ke hub IoT, kita perlu membuat SAS (tanda tangan akses bersama).  Untuk menghasilkan SAS, kunci ganda perangkat digunakan, yang dapat diperoleh dengan menggunakan beberapa utilitas tambahan (Device Explorer, iothub-explorer, IoT Extension untuk Azure CLI 2.0).  Tetapi cara termudah adalah dengan mendapatkan kunci di tempat yang sama, di portal Azure, dengan pergi ke IoT Hub -&gt; IoT Devices. </p><br><p><img src="https://habrastorage.org/webt/gu/fn/jz/gufnjz89qukktzouxgsoauw01ww.png"></p><br><p>  SAS dapat dibuat di perangkat, atau dapat dibuat menggunakan salah satu layanan online-nya.  Jika Anda menggunakan SDK, maka ia dapat menghasilkan SAS untuk Anda secara otomatis (itu sudah cukup untuk menentukan kunci ganda perangkat dalam kode). </p><br><p><img src="https://habrastorage.org/webt/ob/gs/v1/obgsv1ag1bhj7rrcjejvonpvs3u.png"></p><br><p>  Cara SAS token dihasilkan oleh layanan web untuk waktu terbatas tertentu sedikit lebih aman.  Meski ada nuansa tertentu.  Jika Anda hanya mengirim nama perangkat ke layanan, maka seseorang dapat mencari melalui nama untuk mendapatkan token dari beberapa perangkat lain.  Oleh karena itu, untuk membuat proses ini sedikit lebih aman, saya mengusulkan solusi ini: mari kita simpan hash Azure dari kunci ganda perangkat pada perangkat.  Dan dalam kode layanan, sebelum menghasilkan SAS, kami akan memeriksa apakah hash cocok dengan hash kunci perangkat.  Dengan demikian, akan mungkin untuk mendapatkan SAS hanya dengan mengetahui nama perangkat dan hash kuncinya. </p><br><p>  Cara pertama di mana SAS dihasilkan pada perangkat lebih sederhana dan lebih nyaman, tetapi sedikit kurang aman.  Karena, setelah mendapatkan akses ke perangkat, penyerang akan dapat memperoleh kunci dan menghasilkan perangkat SAS sendiri.  Dalam kasus kedua, setelah mendapatkan akses ke perangkat, cracker hanya dapat menerima token SAS, yang masa pakainya terbatas. </p><br><p>  Ternyata kedua metode ini pada umumnya tidak ideal jika peretas memiliki akses ke perangkat.  Bahkan mengamankan koneksi menggunakan VPN tidak akan membantu di sini.  Dalam hal ini, saluran transmisi akan dilindungi, tetapi mereka yang memiliki perangkat di tangan mereka akan dapat mengakses saluran tersebut.  Sayangnya, pada perangkat NodeMCU, Arduino, dll  tidak ada cara untuk menyimpan kunci / kata sandi dalam penyimpanan aman apa pun.  Mungkin pasar untuk perangkat IoT murah membutuhkan fungsi perangkat keras baru. </p><br><h2>  Membuat Fungsi Azure untuk Generasi SAS </h2><br><p>  Sebagai layanan online, paling mudah menggunakan fitur Azure.  Ini adalah cuplikan unik yang dapat ditulis langsung di portal Azure di browser.  Bercanda sebagai lelucon, tetapi dengan cara ini Anda dapat memprogram bahkan dari telepon pintar.  Tentu saja, tidak ada yang melarang membuat dan men-debug mereka dari Visual Studio, dan hanya kemudian menerbitkannya ke Azure dalam bentuk yang dikompilasi. </p><br><p>  Tugas dari fungsi ini adalah untuk melakukan beberapa operasi yang biasanya tidak terlalu rumit.  Menurut gagasan layanan mikro, setiap fungsi dapat melakukan satu hal, tetapi sangat bagus (Prinsip tanggung jawab tunggal). </p><br><p>  Anda dapat membuat Aplikasi Fungsi Azure di portal dengan mengisi formulir singkat </p><br><p><img src="https://habrastorage.org/webt/hd/ec/cu/hdeccuzb_kfv3cz7ggi1x5cnwe4.png"></p><br><p>  Paket Konsumsi memungkinkan Anda membayar hanya untuk panggilan-panggilan fungsi yang telah dilakukan.  Ini adalah opsi termurah.  Saat ini, sejuta panggilan fitur gratis. </p><br><p>  Perhatikan bahwa seiring dengan penciptaan fungsi, penyimpanan data tambahan (Penyimpanan) juga dibuat. </p><br><p>  Setelah membuat Aplikasi Fungsi, Anda dapat membuat fungsi itu sendiri.  Dalam hal ini, kita memerlukan fungsi seperti Webhook + API.  Fungsi ini mungkin terbuka untuk semua orang (akses anonim), dan mungkin hanya tersedia untuk pemilik kode khusus.  Kode dapat diperoleh dari jendela dengan fungsi dengan mengklik tautan &lt;/&gt; Dapatkan URL fungsi: </p><br><p><img src="https://habrastorage.org/webt/fl/mi/4w/flmi4wk8td66jpkudkozeqaec_o.png"></p><br><p>  Fungsinya dapat ditulis dalam berbagai bahasa.  Saya lebih suka C #. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Common.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Globalization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static async Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req, TraceWriter <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) { string deviceid = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "deviceid", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; string hash = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "hash", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(deviceid)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "device id missing"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(hash)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "hash missing"); var resourceUri ="ArduinoDemoHub.azure-devices.net/devices/"+deviceid; // taken <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> IoT Hub <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> devices rights (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Device Explorer) var connectionString = "HostName=ArduinoDemoHub.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=cuYBKc42lfJr4oSRGQGQ8IiKWxGQkLre7rprZDZ/ths="; var registryManager = RegistryManager.CreateFromConnectionString(connectionString); var device = await registryManager.GetDeviceAsync(deviceid); var key = device.Authentication.SymmetricKey.PrimaryKey; HMACSHA256 hmac = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HMACSHA256(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes("somerandomkeyKJBWyfy4gski")); var hashedkey = Convert.ToBase64String(hmac.ComputeHash(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes(key))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hashedkey!=hash) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "wrong hash"); SharedAccessSignatureBuilder sasBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SharedAccessSignatureBuilder() { Key = key, Target = resourceUri, TimeToLive = TimeSpan.FromDays(Convert.ToDouble(<span class="hljs-number"><span class="hljs-number">7</span></span>)) }; var SAS = sasBuilder.ToSignature(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.OK, SAS); }</code> </pre> <br><p>  Kami membuat file project.json dan menambahkan konten berikut ke dalamnya: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"frameworks"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"net46"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Microsoft.Azure.Devices"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.4.1"</span></span> } } } }</code> </pre> <br><p>  Kode menggunakan string koneksi ke hub IoT.  Ini dapat dikacaukan dengan string koneksi ke perangkat.  Agar Anda tidak bingung, izinkan saya mengingatkan Anda di mana Anda bisa mendapatkannya: </p><br><p><img src="https://habrastorage.org/webt/7v/i9/jd/7vi9jdnq12-lsf2gwv82pbbhge0.png"></p><br><p>  Diperlukan untuk mengambil string Koneksi dari beberapa Kebijakan dengan hak terhubung Perangkat. <br>  Yang terbaik adalah tidak menentukan string koneksi itu sendiri dalam kode, seperti yang saya lakukan.  Saya melakukan ini semata-mata demi contoh.  Yang terbaik untuk masuk ke fungsi pengaturan aplikasi. </p><br><p><img src="https://habrastorage.org/webt/u2/e_/uc/u2e_uchy0i1np_d6ikqjpbtpflw.png"></p><br><p>  Dan tentukan string koneksi di sana.  Setelah itu, Anda bisa "mendapatkannya" dari toko aman menggunakan </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ConfigurationManager</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionStrings</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">["___"]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionString</span></span></code> </pre> <br><p>  Di perangkat, kita perlu menyimpan hashedkey.  Tetapi pertama-tama Anda harus menyandikan karakter.  HttpUtility.UrlEncode dari ruang System.Web akan membantu kita dengan ini. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hashedkey</span></span> = HttpUtility.UrlEncode(hashedkey);</code> </pre> <br><p>  Kami akan mengirimkan permintaan menggunakan Get, tetapi tidak semua karakter dapat diteruskan sebagai nilai parameter. </p><br><h2>  Menulis kode untuk mengirim data ke cloud </h2><br><p>  Saya menulis sedikit kode pada Lua mengirim data ke cloud.  Hasilnya adalah semacam PoC.  Anda dapat menggunakannya dan memodifikasinya sesuai kebutuhan Anda. <br>  Buat 2 file init.lua dan SendDataToCloud.lua <br>  Isi yang pertama: </p><br><pre> <code class="hljs php">--    <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'init.lua ver 1.2'</span></span>) wifi.setmode(wifi.STATION) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'set mode=STATION (mode='</span></span>..wifi.getmode()..<span class="hljs-string"><span class="hljs-string">')'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'MAC: '</span></span>..wifi.sta.getmac()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'chip: '</span></span>..node.chipid()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'heap: '</span></span>..node.heap()) --  Wifi station_cfg={} station_cfg.ssid=<span class="hljs-string"><span class="hljs-string">"_SSID"</span></span> station_cfg.pwd=<span class="hljs-string"><span class="hljs-string">"___"</span></span> station_cfg.save=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> wifi.sta.config(station_cfg) wifi_status_codes = { [<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"Idle"</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connecting"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Wrong Password"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"No AP Found"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connection Failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-string"><span class="hljs-string">"Got IP"</span></span> } sntp_connect_status_codes = { [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"DNS lookup failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Memory allocation failure"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"UDP send failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Timeout, no NTP response received"</span></span> } --    Wi-fi (   ) tmr.alarm(<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sta</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">==</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nil</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Waiting for IP address! (Status: "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi_status_codes[wifi.sta.status</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">]..</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">")"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"New IP address is "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi.sta.getip</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> --    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NTP</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sntp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'pool.ntp.org'</span></span></span></span><span class="hljs-function"><span class="hljs-params">}, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(sec, usec, server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Synced: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..usec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tls.cert.verify</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(false)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --    dofile</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">'SendDataToCloud.lua'</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(error_code)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Sync Failed: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sntp_connect_status_codes[error_code])</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --      )</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> )</span></span></code> </pre> <br><p>  File ini terhubung ke jaringan dan mengeksekusi kode dari file SendDataToCloud.lua jika koneksi berhasil. </p><br><p>  Anda harus menentukan data titik akses Wi-Fi Anda sebagai nilai untuk station_cfg.ssid dan station_cfg.pwd. </p><br><p>  Dalam file berikut, Anda perlu mengubah nama perangkat dan IOT hub (variabel PERANGKAT dan IOTHUB).  Variabel funcurl berisi alamat fungsi penghasil SAS dan hash kunci perangkat (yang sebelumnya kami disandikan menggunakan HttpUtility.UrlEncode) sebagai nilai parameter hash </p><br><pre> <code class="hljs powershell">--  DEVICE = <span class="hljs-string"><span class="hljs-string">"LuaDevice"</span></span> IOTHUB = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net"</span></span> PORT = <span class="hljs-number"><span class="hljs-number">8883</span></span> USER = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/api-version=2016-11-14"</span></span> telemetry_topic=<span class="hljs-string"><span class="hljs-string">"devices/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/messages/events/"</span></span> connected = false local headers = <span class="hljs-string"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'Accept: */*\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0'</span></span> funcurl = <span class="hljs-string"><span class="hljs-string">"https://arduinofunction.azurewebsites.net/api/GenerateSASFunction?code=Jn7j54PbR31BSRa0UZrDwp4ZEltjmWHmblG9zLo0Ne0tyGM7w/wQ7w=="</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;hash=oJzykimyQsTPtzgJxYq90Xfqmw1rZTPTCH%2bJ5sSurKI%3d"</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;deviceid="</span></span>..DEVICE tmr.alarm(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, function() http.get(funcurl, headers, function(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, header) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then print(<span class="hljs-string"><span class="hljs-string">"HTTP request failed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sas = true print(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> string.match(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-string"><span class="hljs-string">"Shared"</span></span>) then tmr.stop(<span class="hljs-number"><span class="hljs-number">1</span></span>) SAS = string.sub(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,string.len(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)<span class="hljs-literal"><span class="hljs-literal">-1</span></span>) print(SAS) connect(SAS) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DEVICE, 240, USER, SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IoTHub</span></span></span><span class="hljs-function">    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connecting to MQTT broker. Please wait...")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2,1000, 1, function()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IOTHUB, PORT, 1, -- Callback     function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connected to MQTT: "..IOTHUB..":"..PORT.." as "..DEVICE)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">, -- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Callback</span></span></span><span class="hljs-function">    </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client, reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Error Connecting: "..reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> ) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomseed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(3, 1000, tmr.ALARM_AUTO, publish_data)</span></span></span><span class="hljs-function"> --   ,     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("offline", function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("MQTT Disconnected.")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">false</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> --      </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> == </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">somedata</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">random</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1,100)</span></span></span><span class="hljs-function"> --     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payload</span></span></span><span class="hljs-function"> = "</span></span>{ \<span class="hljs-string"><span class="hljs-string">"deviceId\"</span></span> : \<span class="hljs-string"><span class="hljs-string">""</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"\"</span></span>,<span class="hljs-string"><span class="hljs-string">".. "</span></span>\<span class="hljs-string"><span class="hljs-string">"iotdata\"</span></span> :<span class="hljs-string"><span class="hljs-string">"..somedata.."</span></span>}<span class="hljs-string"><span class="hljs-string">" --   client:publish(telemetry_topic, payload, 1, 0, function(client) print("</span></span><span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> published successfully.<span class="hljs-string"><span class="hljs-string">") end) end end</span></span></code> </pre> <br><p>  Data dikirim tanpa menggunakan Azure SDK, sehingga Anda dapat menggunakan kode ini tidak hanya untuk mengirim data ke Azure.  Ada banyak alternatif: AWS, Google Cloud IoT, IBM Watson IoT Platform. </p><br><p>  Contoh ini menggunakan protokol MQTT (Message Queuing Telemetry Transport).  Ini adalah protokol terbuka yang dirancang khusus untuk perangkat IoT.  Data dikirim dalam format JSON.  Di mana dalam proyek nyata data diambil dari sensor, angka acak dihasilkan dalam contoh. </p><br><p>  Selama proses jabat tangan antara perangkat dan hub IoT, server dapat mengirim sertifikatnya, atau dapat meminta sertifikat perangkat.  Jika Anda ingat, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">terakhir kali kami</a> bekerja dengan perangkat Arduino, kami menginstalnya dengan sertifikat.  Sekarang satu kode sudah cukup: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tls</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cert</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.verify</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">false</span></span>)</code> </pre> <br><p>  Kami terbatas pada sertifikat yang akan dikirimkan server kepada kami. </p><br><h2>  INFO </h2><br><p>  Anda mungkin tertarik pada konten sertifikat untuk hub Anda menggunakan perintah OpenSSL berikut. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s_client</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-showcerts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-connect</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ArduinoDemoHub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.azure-devices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.net</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8883</span></span></code> </pre> <br><p>  Untuk menyiapkan materi, laboratorium digunakan, yang tersedia di tautan: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mengirim Pesan Device-to-Cloud (D2C)</a> <br>  Kode ini tidak cukup terbaru dan saya harus memperbaruinya sedikit, tetapi secara umum, tautannya mungkin berguna. </p><br><h2>  Bekerja dengan NodeMCU dari Arduino IDE </h2><br><p>  Saya tidak bisa mengabaikan topik menggunakan SDK.  Solusi Anda bagus, tetapi SDK adalah kode yang sama yang sudah didebug, disederhanakan, dan siap digunakan.  Beberapa kata tentang cara mengkonfigurasi dan menggunakan Arduino IDE untuk bekerja dengan NodeMCU. </p><br><p>  Setelah menginstal IDE Arduino, Anda harus pergi ke menu File - Preferences </p><br><p><img src="https://habrastorage.org/webt/ea/u_/fq/eau_fqwxsvtujmn50otjftkgwvi.png"></p><br><p>  Dan tambahkan tautan ke manajer dewan tambahan - masukkan bidang URL Pengelola Papan Tambahan alamat: <a href="">http://arduino.esp8266.com/versions/2.4.0/package_esp8266com_index.json</a> </p><br><p>  Lalu pergi ke menu Tools - Board xxx - Boardx Manager dan instal ESP8266 <br>  Instal perpustakaan AzureIoTHub, AzureIoTUtility, AzureIoTProtocol_MQTT.  Setelah menginstal pustaka terakhir dalam contoh (File menu - Contoh - AzureIoTProtocol_MQTT), Anda dapat menemukan contoh simplesample_mqtt untuk ESP8266. </p><br><p>  Contohnya siap untuk digunakan.  Cukup isi nilai variabel dalam file iot_configs.h <br>  Saya menyebutkan satu minus kecil.  Menyusun proyek dan mengunduh ke papan, dibandingkan dengan Lua, membutuhkan waktu yang cukup lama. </p><br><h2>  Menyimpan data di cloud Azure </h2><br><p>  Dengan pengiriman data, semuanya jelas, tetapi betapa murahnya menyimpan data di cloud. <br>  Cara paling murah untuk mengirim data dari hub IoT ke database adalah Fungsi Azure.  Dan penyimpanan data yang paling murah adalah Azure Table Storage. </p><br><p>  Menariknya, ketika Anda membuat Aplikasi Fungsi, Penyimpanan juga dibuat secara otomatis, yang fungsi itu sendiri perlu berfungsi.  Jika Anda membuat repositori yang terpisah, maka disarankan untuk membuat pengaturan dasar seperti ini: </p><br><p><img src="https://habrastorage.org/webt/zg/va/sz/zgvaszlilbyzjh6srxdmrq3cjyi.png"></p><br><p>  Replikasi LSR saat ini merupakan opsi yang paling murah.  Itu dipilih ketika secara otomatis membuat repositori terikat ke suatu fungsi. <br>  Yang kita butuhkan sekarang adalah menerima data dari hub IoT dan menuliskannya ke penyimpanan.  Untuk kasus ini, saat membuat fungsi, jendela Mulai Cepat tidak akan dapat menawarkan opsi yang diinginkan kepada kami. </p><br><p><img src="https://habrastorage.org/webt/x5/vw/6i/x5vw6ia4ubsfidgvpqmlrretqru.png"></p><br><p>  Oleh karena itu, klik pada tautan fungsi Kustom yang terletak di bagian bawah dan pilih opsi IoT Hub (Event Hub). <br>  Jendela ini akan terbuka untuk kita: </p><br><p><img src="https://habrastorage.org/webt/gu/t6/ry/gut6ryx8peg_aq2mqfv0dr62agk.jpeg"></p><br><p>  Di mana kita dapat mengisi bidang koneksi Event Hub dengan pilihan sederhana (dengan mengklik baru).  Tetapi untuk menunjukkan nama Hub Acara Anda harus pergi ke hub IoT.  Di hub Anda harus pergi ke Endpoints (endpoints) dan mendapatkan nama yang kompatibel dengan Event Hub dari sana </p><br><p><img src="https://habrastorage.org/webt/dl/tk/lb/dltklbv7hubhxdhe07nioe7ckgu.png"></p><br><p>  Mari kita beralih ke kode fungsi.  Cuplikan berikut menerima data dari hub IoT dan menyimpannya di Table Storage: </p><br><pre> <code class="hljs lua">#r <span class="hljs-string"><span class="hljs-string">"Microsoft.WindowsAzure.Storage"</span></span> #r <span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span> using Microsoft.Azure; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudConfigurationManager using Microsoft.WindowsAzure.Storage; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudStorageAccount using Microsoft.WindowsAzure.Storage.Table; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Table storage types using Newtonsoft.Json; public static void Run(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> myIoTHubMessage, TraceWriter <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) { var e = JsonConvert.DeserializeObject&lt;EventDataEntity&gt;(myIoTHubMessage); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.Info($<span class="hljs-string"><span class="hljs-string">"C# IoT Hub trigger function processed a message: {myIoTHubMessage}"</span></span>); CloudStorageAccount storageAccount = CloudStorageAccount.Parse (<span class="hljs-string"><span class="hljs-string">"DefaultEndpointsProtocol=https;AccountName=iotdatademostorage;AccountKey=JgStNcJvlQYeNsVCmpkHQUkWlZiQ7tJwAm6OCL34+lGx3XrR+0CPiY9RoxIDA6VSvMKlOEUrVWL+KWP0qLMLrw==;EndpointSuffix=core.windows.net"</span></span>); CloudTableClient tableClient = storageAccount.CreateCloudTableClient(); CloudTable <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = tableClient.GetTableReference(<span class="hljs-string"><span class="hljs-string">"iottable"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.CreateIfNotExists(); EventDataEntity edata = new EventDataEntity(<span class="hljs-string"><span class="hljs-string">"IOTpartition"</span></span>, Guid.NewGuid().ToString()); edata.DeviceId = e.DeviceId; edata.IotData = e.IotData; TableOperation insertOperation = TableOperation.Insert(edata); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.Execute(insertOperation); } public class EventDataEntity : TableEntity { public EventDataEntity(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pkey, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> rkey) { this.PartitionKey = pkey; this.RowKey = rkey; } public EventDataEntity() { } public <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> DeviceId { get; set; } public int IotData { get; set; } }</code> </pre> <br><p>  Jika Anda akan menggunakan kode ini dalam proyek nyata, maka jangan lupa untuk meletakkan string koneksi di tempat yang lebih aman - di pengaturan App (persis sama dengan string koneksi dari fungsi pertama). </p><br><p>  String koneksi itu sendiri dapat diambil dalam item pengaturan yang disebut Kunci akses: </p><br><p><img src="https://habrastorage.org/webt/ot/z9/pb/otz9pbjqyflhjivwztvvsmkjms4.png"></p><br><p>  Lihat konten tabel dengan utilitas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Azure Storage Explorer</a> gratis </p><br><p>  Karena biaya Penyimpanan Meja Azure cukup rendah, dan Fungsi Azure dan hub IoT menawarkan sumber daya tertentu setiap bulan secara gratis, biaya seluruh solusi per bulan bisa kurang dari $ 1.  Tentu saja, itu tergantung pada jumlah data.  Hitung sendiri.  Hari ini, 1 GB data biayanya 7 sen per bulan dan untuk setiap juta transaksi Anda hanya akan dikenakan biaya 4 sen. </p><br><h2>  INFO </h2><br><p>  Saat menggunakan layanan cloud dari penyedia mana pun, saya selalu menyarankan Anda untuk menautkan kartu kredit dengan jumlah minimum uang ke akun Anda.  Secara kebetulan, dengan memilih semacam pengaturan yang salah Anda membayar lebih dari yang Anda harapkan. </p><br><p>  Kami mengingatkan Anda bahwa ini adalah versi lengkap dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel dari majalah Hacker</a> .  Penulisnya adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Alexey Sommer</a> . </p><br><h2>  Bahan yang berguna </h2><br><h4>  Panduan Arsitektur Aplikasi Cloud </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/zk/ns/pq/zknspqark8ose3vto4iom_kbdaq.jpeg"></a>  Ambil pendekatan terstruktur untuk mengembangkan aplikasi cloud.  E-book 300 halaman tentang arsitektur komputasi awan ini membahas arsitektur, pengembangan, dan pedoman implementasi yang berlaku terlepas dari platform cloud mana yang Anda pilih.  Panduan ini mencakup langkah-langkah untuk: </p><br><ul><li>  Memilih gaya arsitektur aplikasi cloud yang tepat untuk aplikasi atau solusi Anda; </li><li>  pemilihan teknologi komputasi dan penyimpanan data yang tepat; </li><li>  menerapkan 10 prinsip pengembangan untuk membuat aplikasi yang skalabel, tangguh, dan mudah dikelola; </li><li>  mengikuti lima prinsip untuk menciptakan perangkat lunak berkualitas yang menjamin keberhasilan aplikasi cloud Anda; </li><li>  Menggunakan pola desain yang dirancang untuk masalah yang Anda coba selesaikan. </li></ul><br><p>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><b>Unduh</b></a> </p><br><h4>  Panduan Pengembang Azure </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img width="200" align="right" src="https://habrastorage.org/webt/ik/2g/ot/ik2gotwyadnbqcjeusitbjdk550.png"></a> </p><br><p>  Dalam pembaruan ini untuk Panduan Pengembang Azure, Anda akan melihat bagaimana rangkaian layanan lengkap untuk platform perangkat lunak Azure memenuhi kebutuhan Anda.  Di sini Anda akan menemukan informasi tentang pendekatan arsitektur dan situasi paling umum yang muncul saat membuat aplikasi cloud. </p><br><p>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><b>Unduh</b></a> </p><br><h4>  Dasar-Dasar Microsoft Azure </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/w1/pe/sj/w1pesji9lrslkdggsjzwdkya2la.png"></a>  Buku ini memberikan wawasan penting tentang layanan Azure utama bagi pengembang dan profesional TI yang baru dalam komputasi awan.  Demo langkah-demi-langkah disertakan untuk membantu pembaca memahami cara memulai dengan masing-masing layanan utama.  Setiap bab independen, tidak diperlukan untuk melakukan demonstrasi praktis dari bab-bab sebelumnya untuk memahami bab tertentu. </p><br><p>  Topik-topik berikut tercakup dalam buku ini: </p><br><ul><li>  Memulai dengan Azure; </li><li>  Layanan Aplikasi Azure dan Aplikasi Web; </li><li>  Mesin virtual; </li><li>  Layanan penyimpanan; </li><li>  Basis data </li><li>  Layanan Azure Tambahan. </li></ul><br><p>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><b>Unduh</b></a> </p><br><h2>  Tautan yang bermanfaat </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi berbahasa Rusia untuk IoT Hub</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Contoh Azure IoT untuk Csharp (.NET)</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id421847/">https://habr.com/ru/post/id421847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id421835/index.html">Komisi Antarlembaga mengembangkan teknologi baru untuk memblokir Telegram</a></li>
<li><a href="../id421837/index.html">Membuat kekacauan 1k intro untuk ZX-Spectrum</a></li>
<li><a href="../id421839/index.html">Pemrograman Java Fungsional dengan Vavr</a></li>
<li><a href="../id421841/index.html">Robotaxi Waymo tidak cukup siap untuk mengakses jalan umum</a></li>
<li><a href="../id421845/index.html">Apa yang sebenarnya dilakukan analis data? Temuan dari 35 Wawancara</a></li>
<li><a href="../id421849/index.html">Acara untuk SDM di bidang TI pada bulan September 2018: My Circle Digest</a></li>
<li><a href="../id421851/index.html">Masalah burung hantu dan bola dunia: menghubungkan dua majelis dengan ruang nama dan nama kelas yang identik</a></li>
<li><a href="../id421855/index.html">Proyektor rumah: “menurut versi” terbaik, fokus ultra-pendek, juara dalam kecerahan dan kecepatan</a></li>
<li><a href="../id421857/index.html">ToFoIn v 1. Reservasi gateway dan beralih di antara saluran eksternal di FreeBSD</a></li>
<li><a href="../id421859/index.html">Catatan dari penyedia IoT. Perangkat dan kalah menang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>