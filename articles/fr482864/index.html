<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ ‚úèÔ∏è ‚è≥ Vid√©o surveillance √† domicile. Sch√©ma de maintenance d'une archive vid√©o sans registraire √† domicile ü§∑üèª üõÄüèº üë©üèæ‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendant un certain temps, j'ai voulu √©crire un article sur un script pour travailler avec une cam√©ra via le protocole DVRIP, mais la discussion sur le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vid√©o surveillance √† domicile. Sch√©ma de maintenance d'une archive vid√©o sans registraire √† domicile</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482864/">  Pendant un certain temps, j'ai voulu √©crire un article sur un script pour travailler avec une cam√©ra via le protocole DVRIP, mais la discussion sur les derni√®res nouvelles √† propos de <a href="https://habr.com/ru/news/t/482770">Xiaomi</a> m'a incit√© √† parler d'abord de la fa√ßon dont j'ai organis√© la vid√©osurveillance √† la maison, puis √† passer √† des scripts et plus encore. <br><br>  <strike>Nous avions 2 paquets ...</strike> Alors, arr√™tez, ce n'est pas l'histoire. <br>  Nous avions 2 routeurs TP-LINK, un acc√®s Internet pour le fournisseur NAT, une cam√©ra de surveillance Partizan, je ne me souviens pas quel mod√®le (toute cam√©ra IP prenant en charge RTSP sur TCP ou DVRIP fonctionnera) et un VPS bon march√© pour 4 euros avec des caract√©ristiques: 2 c≈ìurs Processeur 2,4 GHz, 4 Go de RAM, disque dur de 300 Go, port 100 Mbit / s.  Et aussi la r√©ticence √† acheter autre chose qui co√ªterait plus cher qu'un cordon de brassage. <br><a name="habracut"></a><br><h3>  Pr√©face </h3><br>  Pour des raisons √©videntes, nous ne pouvons pas simplement transf√©rer les ports de la cam√©ra sur le routeur et profiter de la vie.En outre, m√™me si nous le pouvions, nous ne devrions pas le faire. <br><br>  De mon oreille, j'ai entendu dire qu'il existe certaines options avec le tunneling IPv6, o√π il semble que vous pouvez tout faire pour que tous les appareils du r√©seau re√ßoivent une adresse IPv6 externe, et cela simplifierait un peu les choses, tout en laissant la s√©curit√© de cet √©v√©nement en question , et la prise en charge du micrologiciel TP-LINK standard pour ce miracle est quelque peu √©trange.  Bien qu'il soit probable que dans la phrase pr√©c√©dente je parle de b√™tises, alors n'y pr√™tez aucune attention. <br><br>  Mais, heureusement, presque n'importe quel firmware pour n'importe quel routeur (une d√©claration assez infond√©e en fait) contient un client PPTP / L2TP ou la possibilit√© d'installer un firmware personnalis√© avec sa pr√©sence.  Et √† partir de cela, nous pouvons d√©j√† construire une sorte de strat√©gie comportementale. <br><br><h3>  Topologie </h3><br>  Dans une crise de fi√®vre, mon cerveau a donn√© naissance √† quelque chose comme ce sch√©ma de connexion, <br><br><div class="spoiler">  <b class="spoiler_title">et lors d'une autre attaque, il a dessin√© pour mettre sur un magazine geek</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/og/sk/5j/ogsk5j5rwmyz8ocg8qk8kjod8da.png"><br></div></div><br>  <i>L'adresse 169.178.59.82 est g√©n√©r√©e al√©atoirement et sert uniquement d'exemple.</i> <br><br>  Eh bien, ou si en mots, alors: <br><br><ul><li>  Routeur <b>TP-LINK 1 (192.168.1.1)</b> , dans lequel un c√¢ble est ins√©r√©, qui d√©passe du mur.  Un lecteur curieux devinera qu'il s'agit d'un c√¢ble fournisseur via lequel j'ai acc√®s √† Internet.  Divers appareils domestiques sont connect√©s √† ce routeur via un cordon de raccordement ou une connexion Wi-Fi.  Ceci est un r√©seau <b>192.168.1.0</b> </li><li>  Le routeur <b>TP-LINK 2 (192.168.0.1, 192.168.1.200)</b> , dans lequel le c√¢ble est ins√©r√©, qui d√©passe du routeur TP-LINK 1. Gr√¢ce √† ce c√¢ble, le routeur TP-LINK 2, ainsi que les appareils qui y sont connect√©s, ont √©galement acc√®s √† Internet.  Sur ce routeur, la connexion PPTP (10.0.5.100) au serveur 169.178.59.82 est configur√©e.  La cam√©ra IP 192.168.0.200 est √©galement connect√©e √† ce routeur et les ports suivants sont redirig√©s <ul><li>  192.168.0.200:80 -&gt; 49151 (webmord) </li><li>  192.168.0.200 ‚àó 4567 -&gt; 49152 (DVRIP) </li><li>  192.168.0.200/1054 -&gt; 49153 (RTSP) </li></ul></li><li>  <b>Serveur (169.178.59.82, 10.0.5.1)</b> , auquel le routeur TP-LINK 2 est connect√©. Pptpd, shadowsocks et 3proxy tournent sur le serveur, √† travers lequel vous pouvez acc√©der aux p√©riph√©riques r√©seau 10.0.5.0 et ainsi avoir acc√®s au routeur TP-LINK 2 . </li></ul><br>  Ainsi, tous les appareils domestiques du r√©seau 192.168.1.0 ont acc√®s √† la cam√©ra via TP-LINK 2 √† 192.168.1.200, et tous les autres peuvent se connecter via pptp, shadowsocks ou socks5 et acc√©der √† 10.0.5.100. <br><br><h3>  Personnalisation </h3><br>  La premi√®re √©tape consiste √† connecter tous les appareils selon le sch√©ma de la figure ci-dessus. <br><br><ul><li>  La configuration du routeur TP-LINK 1 revient √† r√©server l'adresse 192.168.1.200 pour TP-LINK 2. En option, si vous avez besoin d'une adresse fixe pour acc√©der au r√©seau 192.168.1.0.  Et, si vous le souhaitez, vous pouvez lui r√©server 10-20 Mbit (10 est suffisant pour un flux vid√©o en 1080 avec une t√™te). </li><li>  Vous devez installer et configurer pptpd sur le serveur.  J'ai Ubuntu 18.04 et les actions √©taient approximativement les suivantes (l'exemple √©tait <a href="" rel="nofollow">blog.xenot.ru/bystraya-nastrojka-vpn-servera-pptp-na-ubuntu-server-18-04-lts.fuck</a> ): <ul><li>  Installez les packages n√©cessaires: <br><br><pre><code class="bash hljs">sudo apt install pptpd iptables-persistent</code> </pre> </li><li>  Nous apportons au formulaire suivant <br><br><div class="spoiler">  <b class="spoiler_title">/etc/pptpd.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">option /etc/ppp/pptpd-options bcrelay eth0 # ,        logwtmp localip 10.0.5.1 remoteip 10.0.5.100-200</code> </pre> <br></div></div></li><li>  Correct <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / ppp / pptpd-options</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">novj novjccomp nologfd name pptpd refuse-pap refuse-chap refuse-mschap require-mschap-v2 #require-mppe-128 #  ,   TP-LINK c    ms-dns 8.8.8.8 ms-dns 1.1.1.1 ms-dns 77.88.8.8 ms-dns 8.8.4.4 ms-dns 1.0.0.1 ms-dns 77.88.8.1 proxyarp nodefaultroute lock nobsdcomp</code> </pre></div></div></li><li>  Ajouter des informations d'identification √† <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / ppp / chap-secrets</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># Secrets for authentication using CHAP # client server secret IP addresses username pptpd password *</code> </pre> </div></div></li><li>  Ajouter √† <br><br><div class="spoiler">  <b class="spoiler_title">/etc/sysctl.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">net.ipv4.ip_forward=1</code> </pre> </div></div><br>  et recharger sysctl <br><br><pre> <code class="bash hljs">sudo sysctl -p</code> </pre> </li><li>  Red√©marrez pptpd et ajoutez-le au d√©marrage <br><br><pre> <code class="bash hljs">sudo service pptpd restart sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> pptpd</code> </pre> </li><li>  Correct <br><br><div class="spoiler">  <b class="spoiler_title">iptables</b> <div class="spoiler_text"><pre> <code class="bash hljs">sudo iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT sudo iptables -A INPUT -p tcp -m tcp --dport 1723 -j ACCEPT sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE sudo iptables --table nat --append POSTROUTING --out-interface ppp+ -j MASQUERADE sudo iptables -I INPUT -s 10.0.5.0/24 -i ppp+ -j ACCEPT sudo iptables --append FORWARD --<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface eth0 -j ACCEPT</code> </pre> </div></div><br>  Et √©conomisez <br><br><pre> <code class="bash hljs">sudo netfilter-persistent save sudo netfilter-persistent reload</code> </pre></li></ul></li><li>  Configurer TP-LINK 2 <ul><li>  Nous r√©servons l'adresse 192.168.0.200 pour notre cam√©ra: <br><br><div class="spoiler">  <b class="spoiler_title">DHCP -&gt; R√©servation d'adresse</b> <div class="spoiler_text">  - Adresse MAC - Cam√©ras MAC, peuvent √™tre consult√©es dans DHCP -&gt; Liste des clients DHCP <br>  - Adresse IP r√©serv√©e - 192.168.0.200 </div></div></li><li>  Nous exp√©dions les ports: <br><div class="spoiler">  <b class="spoiler_title">Transfert -&gt; Serveurs virtuels</b> <div class="spoiler_text">  - Port de service: 49151, Port interne: 80, Adresse IP: 192.168.0.200, Protocole: TCP <br>  - Port de service: 49152, Port interne: 34567, Adresse IP: 192.168.0.200, Protocole: TCP <br>  - Port de service: 49153, Port interne: 554, Adresse IP: 192.168.0.200, Protocole: TCP <br></div></div></li><li>  Configurer la connexion VPN: <br><br><div class="spoiler">  <b class="spoiler_title">R√©seau -&gt; WAN</b> <div class="spoiler_text">  - Type de connexion WAN: PPTP <br>  - Nom d'utilisateur: nom d'utilisateur (voir / etc / ppp / chap-secrets) <br>  - Mot de passe: mot de passe (voir / etc / ppp / chap-secrets) <br>  - Confirmer le mot de passe: mot de passe (voir / etc / ppp / chap-secrets) <br>  - IP dynamique <br>  - Adresse IP / Nom du serveur: 169.178.59.82 (√©videmment l'IP externe de votre serveur) <br>  - Mode de connexion: connectez-vous automatiquement <br></div></div></li><li>  Autoriser √©ventuellement l'acc√®s √† distance au webmord du routeur <br><div class="spoiler">  <b class="spoiler_title">S√©curit√© -&gt; Gestion √† distance</b> <div class="spoiler_text">  - Port de gestion Web: 80 <br>  - Adresse IP de la t√©l√©commande: 255.255.255.255 </div></div></li><li>  Red√©marrez le routeur TP-LINK 2 </li></ul></li></ul><br><br>  <i>Au lieu de PPTP, vous pouvez utiliser L2TP ou, si vous avez un firmware personnalis√©, alors tout ce que votre c≈ìur d√©sire.</i>  <i>J'ai choisi PPTP, car ce sch√©ma n'a pas √©t√© construit pour des raisons de s√©curit√©, mais pptpd d'apr√®s mon exp√©rience est le serveur VPN le plus rapide.</i>  <i>De plus, je ne voulais vraiment pas installer de firmware personnalis√©, ce qui signifie que je devais choisir entre PPTP et L2TP.</i> <br><br>  Si je n'ai commis aucune erreur dans le guide, et que vous avez tout fait correctement et que vous avez eu de la chance, apr√®s toutes ces manipulations <ul><li>  d'abord <br><br><pre> <code class="bash hljs">ifconfig</code> </pre> <br>  affichera l'interface <code>ppp0 inet 10.0.5.1 netmask 255.255.255.255 destination 10.0.5.100</code> , </li><li>  d'autre part, le 10.0.5.100 devrait r√©pondre, </li><li>  et troisi√®mement <br><br><pre> <code class="bash hljs">ffprobe -rtsp_transport tcp <span class="hljs-string"><span class="hljs-string">"rtsp://10.0.5.100:49153/user=admin&amp;password=password&amp;channel=1&amp;stream=0.sdp"</span></span></code> </pre> <br>  Doit d√©tecter le flux. <br>  <i>port rtsp, identifiant et mot de passe que vous pouvez trouver dans la documentation de votre appareil photo</i> <br></li></ul><br><br><h3>  Conclusion </h3><br>  En principe, c'est d√©j√† pas mal, il y a acc√®s au RTSP, si le logiciel propri√©taire fonctionne via DVRIP, alors vous pouvez l'utiliser.  Vous pouvez enregistrer le flux √† l'aide de ffmpeg, acc√©l√©rer la vid√©o 2-3-5 fois, la diviser en morceaux √† l'heure, t√©l√©charger le tout sur googledisk ou sur les r√©seaux sociaux et bien plus encore. <br><br>  Je n'aimais pas RTSP sur TCP, car cela ne fonctionnait pas tr√®s stable, mais sur UDP, pour la raison que nous ne pouvons pas (ou pouvons, mais je ne veux pas le faire) transmettre la plage de ports sur lesquels RTSP enverra le flux vid√©o , Je ne peux pas l'utiliser, j'ai √©crit un script qui fait glisser un flux sur TCP via DVRIP.  Il s'est av√©r√© √™tre plus stable. <br><br>  Parmi les avantages de l'approche - nous pouvons prendre quelque chose qui prend en charge le sifflet 4G √† la place du routeur TP-LINK 2, alimenter le tout avec la cam√©ra de l'onduleur (qui sera sans aucun doute beaucoup moins volumineux que lors de l'utilisation de l'enregistreur), en outre, l'enregistrement est transmis presque instantan√©ment au serveur, donc m√™me si des intrus vous p√©n√®trent, ils ne pourront pas supprimer la vid√©o.  En g√©n√©ral, il y a une marge de man≈ìuvre et tout d√©pend de votre imagination. <br><br>  PS: Je sais que de nombreux fabricants proposent des solutions cloud pr√™tes √† l'emploi, mais elles co√ªtent pr√®s du double du prix de mon arm√©e de l'air (dont j'en ai d√©j√† 3, donc j'ai besoin de mettre des ressources quelque part), offrent beaucoup moins de contr√¥le, et aussi qualit√© tr√®s satisfaisante. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482864/">https://habr.com/ru/post/fr482864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482854/index.html">√Ä propos de l'estimation</a></li>
<li><a href="../fr482856/index.html">√âtranger divin</a></li>
<li><a href="../fr482858/index.html">Capteurs de fen√™tre sans fil maison: STM32L051 + RFM69 + Android</a></li>
<li><a href="../fr482860/index.html">J'√©tais responsable des relations internationales chez Google. Voil√† pourquoi je suis parti</a></li>
<li><a href="../fr482862/index.html">Y a-t-il un GameDev √† Sakhaline? 1.V</a></li>
<li><a href="../fr482866/index.html">Vaut-il la peine d'acheter du Bitcoin l'ann√©e prochaine et combien cela co√ªtera</a></li>
<li><a href="../fr482870/index.html">Comment j'ai achet√© un ordinateur portable verrouill√© sur eBay et essay√© de faire mon AntiTheft bas√© sur IntelAMT</a></li>
<li><a href="../fr482872/index.html">Des polygones dans un autre monde</a></li>
<li><a href="../fr482874/index.html">La mort de Koshchei dans la liste des recommandations (pouvez-vous rendre YouTube confortable et s√ªr?)</a></li>
<li><a href="../fr482876/index.html">Calcul du co√ªt de production d'√©lectricit√© solaire pour les besoins propres d'un m√©nage dans le centre de l'Europe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>