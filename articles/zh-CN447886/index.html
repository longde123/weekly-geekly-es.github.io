<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ”„ ğŸ™ ğŸ™‹ ä½¿ç”¨Amazon Athenaå’ŒCube.jsçš„Nginxæ—¥å¿—åˆ†æ ğŸ‘ˆğŸ¾ ğŸ¥‰ ğŸ³</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="é€šå¸¸ï¼ŒNginxä½¿ç”¨å•†ä¸šäº§å“æˆ–å¼€æºæ›¿ä»£äº§å“ï¼ˆä¾‹å¦‚Prometheus + Grafanaï¼‰æ¥ç›‘è§†å’Œåˆ†æNginxçš„æ€§èƒ½ã€‚ è¿™å¯¹äºç›‘è§†æˆ–å®æ—¶åˆ†ææ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†å¯¹äºå†å²åˆ†æè€Œè¨€å´ä¸å¤ªæ–¹ä¾¿ã€‚ åœ¨ä»»ä½•æµè¡Œçš„èµ„æºä¸Šï¼Œnginxæ—¥å¿—ä¸­çš„æ•°æ®é‡éƒ½åœ¨è¿…é€Ÿå¢é•¿ï¼Œå› æ­¤ä½¿ç”¨æ›´ä¸“ä¸šçš„å·¥å…·æ¥åˆ†æå¤§é‡æ•°æ®æ˜¯åˆä¹é€»è¾‘çš„ã€‚ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨Amazon Athenaå’ŒCube.jsçš„Nginxæ—¥å¿—åˆ†æ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447886/"><p> é€šå¸¸ï¼ŒNginxä½¿ç”¨å•†ä¸šäº§å“æˆ–å¼€æºæ›¿ä»£äº§å“ï¼ˆä¾‹å¦‚Prometheus + Grafanaï¼‰æ¥ç›‘è§†å’Œåˆ†æNginxçš„æ€§èƒ½ã€‚ è¿™å¯¹äºç›‘è§†æˆ–å®æ—¶åˆ†ææ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†å¯¹äºå†å²åˆ†æè€Œè¨€å´ä¸å¤ªæ–¹ä¾¿ã€‚ åœ¨ä»»ä½•æµè¡Œçš„èµ„æºä¸Šï¼Œnginxæ—¥å¿—ä¸­çš„æ•°æ®é‡éƒ½åœ¨è¿…é€Ÿå¢é•¿ï¼Œå› æ­¤ä½¿ç”¨æ›´ä¸“ä¸šçš„å·¥å…·æ¥åˆ†æå¤§é‡æ•°æ®æ˜¯åˆä¹é€»è¾‘çš„ã€‚ </p><br><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä»¥Nginxä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Athena</a>åˆ†ææ—¥å¿—ï¼Œå¹¶å±•ç¤ºå¦‚ä½•ä½¿ç”¨å¼€æº<a href="">cube.js</a>æ¡†æ¶ä»æ­¤æ•°æ®ç¼–è¯‘åˆ†æä»ªè¡¨æ¿ã€‚ è¿™æ˜¯å®Œæ•´çš„è§£å†³æ–¹æ¡ˆæ¶æ„ï¼š </p><br><p><img src="https://habrastorage.org/webt/km/xo/3i/kmxo3izommuyzgajw20t6-aolcg.png" alt="å»ºç­‘å­¦"></p><br><p>  TLï¼šDRï¼› <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é“¾æ¥åˆ°å®Œæˆçš„ä»ªè¡¨æ¿</a> ã€‚ </p><a name="habracut"></a><br><p> æˆ‘ä»¬ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Fluentd</a>æ”¶é›†ä¿¡æ¯ï¼Œä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWS Kinesis Data Firehose</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWS Glue</a>è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AWS S3</a>è¿›è¡Œå­˜å‚¨ã€‚ ä½¿ç”¨æ­¤æ†ç»‘åŒ…ï¼Œæ‚¨ä¸ä»…å¯ä»¥å­˜å‚¨nginxæ—¥å¿—ï¼Œè¿˜å¯ä»¥å­˜å‚¨å…¶ä»–äº‹ä»¶ä»¥åŠå…¶ä»–æœåŠ¡çš„æ—¥å¿—ã€‚ æ‚¨å¯ä»¥å°†æŸäº›éƒ¨åˆ†æ›¿æ¢ä¸ºå †æ ˆä¸­çš„ç›¸ä¼¼éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä»nginxå°†æ—¥å¿—å†™å…¥kinesisï¼Œç»•è¿‡fluentdï¼Œæˆ–ä½¿ç”¨logstashåšåˆ°è¿™ä¸€ç‚¹ã€‚ </p><br><h2 id="sobiraem-logi-nginx"> æ”¶é›†Nginxæ—¥å¿— </h2><br><p> é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginxæ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre><code class="bash hljs">4/9/2019 12:58:17 PM1.1.1.1 - - [09/Apr/2019:09:58:17 +0000] <span class="hljs-string"><span class="hljs-string">"GET /sign-up HTTP/2.0"</span></span> 200 9168 <span class="hljs-string"><span class="hljs-string">"https://example.com/sign-in"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> 4/9/2019 12:58:17 PM1.1.1.1 - - [09/Apr/2019:09:58:17 +0000] <span class="hljs-string"><span class="hljs-string">"GET /sign-in HTTP/2.0"</span></span> 200 9168 <span class="hljs-string"><span class="hljs-string">"https://example.com/sign-up"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span></code> </pre> <br><p> å¯ä»¥è§£æå®ƒä»¬ï¼Œä½†æ˜¯ä¿®å¤Nginxé…ç½®è¦å®¹æ˜“å¾—å¤šï¼Œä»¥ä¾¿å®ƒä»¥JSONæ˜¾ç¤ºæ—¥å¿—ï¼š </p><br><pre> <code class="plaintext hljs">log_format json_combined escape=json '{ "created_at": "$msec", ' '"remote_addr": "$remote_addr", ' '"remote_user": "$remote_user", ' '"request": "$request", ' '"status": $status, ' '"bytes_sent": $bytes_sent, ' '"request_length": $request_length, ' '"request_time": $request_time, ' '"http_referrer": "$http_referer", ' '"http_x_forwarded_for": "$http_x_forwarded_for", ' '"http_user_agent": "$http_user_agent" }'; access_log /var/log/nginx/access.log json_combined;</code> </pre> <br><h3 id="s3-dlya-hraneniya">  S3ç”¨äºå­˜å‚¨ </h3><br><p> è¦å­˜å‚¨æ—¥å¿—ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨S3ã€‚ ç”±äºAthenaå¯ä»¥ç›´æ¥ä½¿ç”¨S3ä¸­çš„æ•°æ®ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹å­˜å‚¨å’Œåˆ†ææ—¥å¿—ã€‚ åœ¨æœ¬æ–‡åé¢çš„å†…å®¹ä¸­ï¼Œæˆ‘å°†å‘Šè¯‰æ‚¨å¦‚ä½•æ­£ç¡®æŠ˜å å’Œå¤„ç†æ—¥å¿—ï¼Œä½†æ˜¯é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨S3ä¸­æœ‰ä¸€ä¸ªå¹²å‡€çš„å­˜å‚¨æ¡¶ï¼Œè¯¥å­˜å‚¨æ¡¶ä¸­ä¸ä¼šå­˜å‚¨å…¶ä»–ä»»ä½•å†…å®¹ã€‚ æå‰è€ƒè™‘åœ¨å“ªä¸ªåŒºåŸŸåˆ›å»ºå­˜å‚¨æ¡¶æ˜¯å€¼å¾—çš„ï¼Œå› ä¸ºAthenaå¹¶éåœ¨æ‰€æœ‰åŒºåŸŸéƒ½å¯ç”¨ã€‚ </p><br><h3 id="sozdaem-shemu-v-konsoli-athena"> åœ¨Athenaæ§åˆ¶å°ä¸­åˆ›å»ºå›¾è¡¨ </h3><br><p> åœ¨Athenaä¸­åˆ›å»ºä¸€ä¸ªç”¨äºæ—¥å¿—çš„è¡¨ã€‚ å¦‚æœæ‚¨æ‰“ç®—ä½¿ç”¨Kinesis Firehoseï¼Œåˆ™å†™ä½œå’Œé˜…è¯»éƒ½éœ€è¦å®ƒã€‚ æ‰“å¼€Athenaæ§åˆ¶å°å¹¶åˆ›å»ºä¸€ä¸ªè¡¨ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">SQLè¡¨åˆ›å»º</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`kinesis_logs_nginx`</span></span>( <span class="hljs-string"><span class="hljs-string">`created_at`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>, <span class="hljs-string"><span class="hljs-string">`remote_addr`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`remote_user`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`request`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`status`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`bytes_sent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`request_length`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-string"><span class="hljs-string">`request_time`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>, <span class="hljs-string"><span class="hljs-string">`http_referrer`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`http_x_forwarded_for`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-string"><span class="hljs-string">`http_user_agent`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FORMAT</span></span> SERDE <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcSerde'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> INPUTFORMAT <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'</span></span> OUTPUTFORMAT <span class="hljs-string"><span class="hljs-string">'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'</span></span> LOCATION <span class="hljs-string"><span class="hljs-string">'s3://&lt;YOUR-S3-BUCKET&gt;'</span></span> TBLPROPERTIES (<span class="hljs-string"><span class="hljs-string">'has_encrypted_data'</span></span>=<span class="hljs-string"><span class="hljs-string">'false'</span></span>);</code> </pre> </div></div><br><h3 id="sozdaem-kinesis-firehose-stream"> åˆ›å»ºKinesis Firehoseæµ </h3><br><p>  Kinesis Firehoseå°†ä»¥é€‰å®šçš„æ ¼å¼å°†ä»Nginxæ¥æ”¶çš„æ•°æ®å†™å…¥S3ï¼Œå¹¶åˆ†æˆYYYY / MM / DD / HHæ ¼å¼çš„ç›®å½•ã€‚ è¿™åœ¨è¯»å–æ•°æ®æ—¶å¾ˆæœ‰ç”¨ã€‚ å½“ç„¶ï¼Œæ‚¨å¯ä»¥ä»fluentdç›´æ¥å†™å…¥S3ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¿…é¡»ç¼–å†™JSONï¼Œç”±äºæ–‡ä»¶å¤§è€Œæ•ˆç‡ä½ã€‚ æ­¤å¤–ï¼Œåœ¨ä½¿ç”¨PrestoDBæˆ–Athenaæ—¶ï¼ŒJSONæ˜¯æœ€æ…¢çš„æ•°æ®æ ¼å¼ã€‚ å› æ­¤ï¼Œæ‰“å¼€Kinesis Firehoseæ§åˆ¶å°ï¼Œå•å‡»â€œåˆ›å»ºäº¤ä»˜æµâ€ï¼Œåœ¨â€œäº¤ä»˜â€å­—æ®µä¸­é€‰æ‹©â€œç›´æ¥PUTâ€ï¼š </p><br><p><img src="https://habrastorage.org/webt/xe/vb/mc/xevbmcpntl3aqkgg50lh844gxe4.png" alt="Kinesis Firehoseæ§åˆ¶å°1"></p><br><p> åœ¨ä¸‹ä¸€ä¸ªæ ‡ç­¾ä¸­ï¼Œé€‰æ‹©â€œè®°å½•æ ¼å¼è½¬æ¢â€-â€œå¯ç”¨â€ï¼Œç„¶åé€‰æ‹©â€œ Apache ORCâ€ä½œä¸ºè®°å½•æ ¼å¼ã€‚ æ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Owen O'Malleyçš„</a>è¯´æ³•ï¼Œè¿™æ˜¯PrestoDBå’ŒAthenaçš„æœ€ä½³æ ¼å¼ã€‚ ä½œä¸ºå›¾è¡¨ï¼Œæˆ‘ä»¬æŒ‡å‡ºäº†æˆ‘ä»¬åœ¨ä¸Šé¢åˆ›å»ºçš„è¡¨ã€‚ è¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥åœ¨è¿åŠ¨å­¦ä¸­æŒ‡å®šä»»ä½•S3ä½ç½®ï¼Œä»…ä½¿ç”¨è¡¨ä¸­çš„æ–¹æ¡ˆã€‚ ä½†æ˜¯ï¼Œå¦‚æœæŒ‡å®šå¦ä¸€ä¸ªS3ä½ç½®ï¼Œåˆ™æ— æ³•ä»è¯¥è¡¨è¯»å–è¿™äº›è®°å½•ã€‚ </p><br><p><img src="https://habrastorage.org/webt/vu/y1/ro/vuy1royrwm3pb3jle5nvclzskd0.png" alt="Kinesis Firehoseæ§åˆ¶å°2"></p><br><p> æˆ‘ä»¬é€‰æ‹©S3è¿›è¡Œå­˜å‚¨ï¼Œå¹¶é€‰æ‹©ä¹‹å‰åˆ›å»ºçš„å­˜å‚¨æ¡¶ã€‚ æˆ‘å°†åœ¨ç¨åè®¨è®ºçš„Aws Glue Crawlerä¸çŸ¥é“å¦‚ä½•åœ¨S3å­˜å‚¨æ¡¶ä¸­ä½¿ç”¨å‰ç¼€ï¼Œå› æ­¤å°†å…¶ç•™ç©ºå¾ˆé‡è¦ã€‚ </p><br><p><img src="https://habrastorage.org/webt/jq/0u/bs/jq0ubs7jvqmehbfqaaycrmxryso.png" alt="Kinesisæ¶ˆé˜²æ°´å¸¦æ§åˆ¶å°3"></p><br><p> å…¶ä½™é€‰é¡¹å¯ä»¥æ ¹æ®æ‚¨çš„è´Ÿè½½è¿›è¡Œæ›´æ”¹ï¼Œæˆ‘é€šå¸¸ä½¿ç”¨é»˜è®¤é€‰é¡¹ã€‚ è¯·æ³¨æ„ï¼ŒS3å‹ç¼©ä¸å¯ç”¨ï¼Œä½†æ˜¯ORCé»˜è®¤ä½¿ç”¨æœ¬æœºå‹ç¼©ã€‚ </p><br><h3 id="fluentd"> æµåˆ©çš„ </h3><br><p> ç°åœ¨æˆ‘ä»¬å·²ç»é…ç½®äº†æ—¥å¿—çš„å­˜å‚¨å’Œæ¥æ”¶ï¼Œæ‚¨éœ€è¦é…ç½®å‘é€ã€‚ å› ä¸ºæˆ‘å–œæ¬¢Rubyï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Fluentd</a> ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨Logstashæˆ–å°†æ—¥å¿—ç›´æ¥å‘é€åˆ°kinesisã€‚ æ‚¨å¯ä»¥é€šè¿‡å‡ ç§æ–¹å¼å¯åŠ¨FluentdæœåŠ¡å™¨ï¼Œæˆ‘å°†è®¨è®ºdockerï¼Œå› ä¸ºå®ƒæ—¢ç®€å•åˆæ–¹ä¾¿ã€‚ </p><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦fluent.confé…ç½®æ–‡ä»¶ã€‚ åˆ›å»ºå®ƒå¹¶æ·»åŠ æºï¼š </p><br><br><p> å‘å‰è¾“å…¥ <br> ç«¯å£24224 <br> ç»‘å®š0.0.0.0 </p><br><br><p> ç°åœ¨æ‚¨å¯ä»¥å¯åŠ¨FluentdæœåŠ¡å™¨ã€‚ å¦‚æœæ‚¨éœ€è¦æ›´é«˜çº§çš„é…ç½®ï¼Œåˆ™<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Docker Hub</a>ä¼šæä¾›è¯¦ç»†çš„æŒ‡å—ï¼ŒåŒ…æ‹¬å¦‚ä½•ç»„è£…æ˜ åƒã€‚ </p><br><pre> <code class="bash hljs">$ docker run \ -d \ -p 24224:24224 \ -p 24224:24224/udp \ -v /data:/fluentd/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> \ -v &lt;PATH-TO-FLUENT-CONF&gt;:/fluentd/etc fluentd \ -c /fluentd/etc/fluent.conf fluent/fluentd:stable</code> </pre> <br><p> æ­¤é…ç½®åœ¨å‘é€å‰ä½¿ç”¨<code>/fluentd/log</code>è·¯å¾„ç¼“å­˜æ—¥å¿—ã€‚ æ‚¨å¯ä»¥ä¸è¿™æ ·åšï¼Œä½†æ˜¯éšåé‡æ–°å¯åŠ¨æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šä¸¢å¤±è¿‡å¤šåŠ³åŠ›æ‰€ç¼“å­˜çš„æ‰€æœ‰å†…å®¹ã€‚ ä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•ç«¯å£ï¼Œ24224æ˜¯é»˜è®¤çš„Fluentdç«¯å£ã€‚ </p><br><p> ç°åœ¨æˆ‘ä»¬å·²ç»è¿è¡Œäº†Fluentdï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ­¤å¤„å‘é€Nginxæ—¥å¿—äº†ã€‚ æˆ‘ä»¬é€šå¸¸åœ¨Dockerå®¹å™¨ä¸­è¿è¡ŒNginxï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDockerå…·æœ‰Fluentdçš„æœ¬æœºæ—¥å¿—é©±åŠ¨ç¨‹åºï¼š </p><br><pre> <code class="bash hljs">$ docker run \ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-driver=fluentd \ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-opt fluentd-address=&lt;FLUENTD-SERVER-ADDRESS&gt;\ --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-opt tag=\<span class="hljs-string"><span class="hljs-string">"{{.Name}}\" \ -v /some/content:/usr/share/nginx/html:ro \ -d \ nginx</span></span></code> </pre> <br><p> å¦‚æœä»¥å…¶ä»–æ–¹å¼è¿è¡ŒNginxï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ—¥å¿—æ–‡ä»¶ï¼ŒFluentdå…·æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ä»¶å°¾æ’ä»¶</a> ã€‚ </p><br><p> å°†ä¸Šé¢é…ç½®çš„æ—¥å¿—è§£ææ·»åŠ åˆ°Fluenté…ç½®ä¸­ï¼š </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">YOUR-NGINX-TAG.</span></span></span><span class="hljs-tag">*&gt;</span></span> @type parser key_name log emit_invalid_record_to_error false <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parse</span></span></span><span class="hljs-tag">&gt;</span></span> @type json <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parse</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> å¹¶ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kinesis firehoseæ’ä»¶</a>å°†æ—¥å¿—å‘é€åˆ°Kinesisï¼š </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">match</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">YOUR-NGINX-TAG.</span></span></span><span class="hljs-tag">*&gt;</span></span> @type kinesis_firehose region region delivery_stream_name <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR-KINESIS-STREAM-NAME</span></span></span><span class="hljs-tag">&gt;</span></span> aws_key_id <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR-AWS-KEY-ID</span></span></span><span class="hljs-tag">&gt;</span></span> aws_sec_key <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YOUR_AWS-SEC_KEY</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">match</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h2 id="athena"> é›…å…¸å¨œ </h2><br><p> å¦‚æœæ­£ç¡®é…ç½®äº†æ‰€æœ‰å†…å®¹ï¼Œåˆ™è¿‡ä¸€ä¼šå„¿ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼ŒKinesisä¼šæ¯10åˆ†é’Ÿå†™å…¥ä¸€æ¬¡æ¥æ”¶åˆ°çš„æ•°æ®ï¼‰ï¼Œæ‚¨åº”è¯¥ä¼šåœ¨S3ä¸­çœ‹åˆ°æ—¥å¿—æ–‡ä»¶ã€‚ åœ¨Kinesis Firehoseçš„â€œç›‘è§†â€èœå•ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å‘S3å†™å…¥äº†å¤šå°‘æ•°æ®ä»¥åŠé”™è¯¯ã€‚ ä¸è¦å¿˜è®°ä¸ºKinesisè§’è‰²æˆäºˆå¯¹S3å­˜å‚¨æ¡¶çš„å†™è®¿é—®æƒé™ã€‚ å¦‚æœKinesisæ— æ³•è§£ææŸäº›å†…å®¹ï¼Œä»–å°†åœ¨åŒä¸€å­˜å‚¨æ¡¶ä¸­æ·»åŠ é”™è¯¯ã€‚ </p><br><p> ç°åœ¨æ‚¨å¯ä»¥åœ¨Athenaä¸­æŸ¥çœ‹æ•°æ®ã€‚ è®©æˆ‘ä»¬æ‰¾åˆ°ä¸€äº›é”™è¯¯çš„æ–°æŸ¥è¯¢ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"db_name"</span></span>.<span class="hljs-string"><span class="hljs-string">"table_name"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> &gt; <span class="hljs-number"><span class="hljs-number">499</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> created_at <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><h3 id="skanirovanie-vseh-zapisey-na-kazhdyy-zapros"> æ‰«ææ¯ä¸ªè¯·æ±‚çš„æ‰€æœ‰è®°å½• </h3><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬çš„æ—¥å¿—å·²åœ¨ORCä¸­çš„S3ä¸­è¿›è¡Œå¤„ç†å’Œå †å ï¼Œå‹ç¼©å¹¶å‡†å¤‡è¿›è¡Œåˆ†æã€‚  Kinesis Firehoseç”šè‡³æ¯å°æ—¶éƒ½å°†å®ƒä»¬æ”¾åœ¨ç›®å½•ä¸­ã€‚ ä½†æ˜¯ï¼Œåœ¨ä¸å¯¹è¡¨è¿›è¡Œåˆ†åŒºçš„æƒ…å†µä¸‹ï¼ŒAthenaä¼šä¸ºæ¯ä¸ªæŸ¥è¯¢åŠ è½½æ‰€æœ‰æ—¶é—´çš„æ•°æ®ï¼ˆæå°‘æ•°ä¾‹å¤–ï¼‰ã€‚ è¿™æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š </p><br><ul><li> æ•°æ®é‡åœ¨ä¸æ–­å¢é•¿ï¼Œå‡æ…¢äº†æŸ¥è¯¢é€Ÿåº¦ï¼› </li><li> é›…å…¸å¨œæ˜¯æ ¹æ®æ‰«æçš„æ•°æ®é‡è®¡è´¹çš„ï¼Œæ¯ä¸ªè¯·æ±‚è‡³å°‘10 MBã€‚ </li></ul><br><p> ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨AWS Glue Crawlerï¼Œå®ƒå°†æ‰«æS3ä¸­çš„æ•°æ®å¹¶å°†åˆ†åŒºä¿¡æ¯è®°å½•åœ¨Glue Metastoreä¸­ã€‚ è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†åˆ†åŒºç”¨ä½œAthenaä¸­è¯·æ±‚çš„ç­›é€‰å™¨ï¼Œå¹¶ä¸”ä»…æ‰«æè¯·æ±‚ä¸­æŒ‡å®šçš„ç›®å½•ã€‚ </p><br><h3 id="nastraivaem-amazon-glue-crawler"> è‡ªå®šä¹‰Amazon Glue Crawler </h3><br><p>  Amazon Glue Crawleræ‰«æS3å­˜å‚¨æ¡¶ä¸­çš„æ‰€æœ‰æ•°æ®å¹¶åˆ›å»ºåˆ†åŒºè¡¨ã€‚ ä»AWS Glueæ§åˆ¶å°åˆ›å»ºä¸€ä¸ªGlue Crawlerï¼Œç„¶åæ·»åŠ å­˜å‚¨æ•°æ®çš„å­˜å‚¨æ¡¶ã€‚ æ‚¨å¯ä»¥å°†ä¸€ä¸ªæœå¯»å™¨ç”¨äºå¤šä¸ªå­˜å‚¨æ¡¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†åœ¨æŒ‡å®šçš„æ•°æ®åº“ä¸­åˆ›å»ºåç§°ä¸å­˜å‚¨æ¡¶åç§°åŒ¹é…çš„è¡¨ã€‚ å¦‚æœæ‚¨æ‰“ç®—ä¸€ç›´ä½¿ç”¨æ­¤æ•°æ®ï¼Œè¯·ç¡®ä¿è°ƒæ•´Crawlerå¯åŠ¨æ—¶é—´è¡¨ä»¥é€‚åˆæ‚¨çš„éœ€æ±‚ã€‚ æˆ‘ä»¬å¯¹æ‰€æœ‰è¡¨ä½¿ç”¨ä¸€ä¸ªCrawlerï¼Œè¯¥è¡¨æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ã€‚ </p><br><h3 id="particirovannye-tablicy"> åˆ†åŒºè¡¨ </h3><br><p> é¦–æ¬¡å¯åŠ¨æœå¯»å™¨åï¼Œæ¯ä¸ªå·²æ‰«æå­˜å‚¨åŒºçš„è¡¨åº”å‡ºç°åœ¨è®¾ç½®ä¸­æŒ‡å®šçš„æ•°æ®åº“ä¸­ã€‚ æ‰“å¼€Athenaæ§åˆ¶å°ï¼Œæ‰¾åˆ°å¸¦æœ‰Nginxæ—¥å¿—çš„è¡¨ã€‚ è®©æˆ‘ä»¬å°è¯•é˜…è¯»ä¸€äº›å†…å®¹ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"default"</span></span>.<span class="hljs-string"><span class="hljs-string">"part_demo_kinesis_bucket"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span>( partition_0 = <span class="hljs-string"><span class="hljs-string">'2019'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_1 = <span class="hljs-string"><span class="hljs-string">'04'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_2 = <span class="hljs-string"><span class="hljs-string">'08'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> partition_3 = <span class="hljs-string"><span class="hljs-string">'06'</span></span> );</code> </pre> <br><p> è¯¥æŸ¥è¯¢å°†é€‰æ‹©2019å¹´4æœˆ8æ—¥ä¸Šåˆ6ç‚¹è‡³ä¸Šåˆ7ç‚¹æ”¶åˆ°çš„æ‰€æœ‰è®°å½•ã€‚ ä½†æ˜¯ï¼Œæ¯”ä»…ä»éåˆ†åŒºè¡¨ä¸­è¯»å–æ•°æ®æ›´æœ‰æ•ˆï¼Ÿ è®©æˆ‘ä»¬é€šè¿‡æŒ‰æ—¶é—´æˆ³è¿‡æ»¤æ‰¾åˆ°å¹¶é€‰æ‹©ç›¸åŒçš„è®°å½•ï¼š </p><br><p><img src="https://habrastorage.org/webt/mu/bg/me/mubgmef262bxyte5dsqsa1q_hag.png" alt="è¯·æ±‚æ— åˆ†åŒº"></p><br><p> æ•°æ®é›†ä¸Šçš„æ•°æ®åªæœ‰3.59ç§’å’Œ244.34å…†å­—èŠ‚ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªæ˜ŸæœŸçš„æ—¥å¿—ã€‚ è®©æˆ‘ä»¬å°è¯•æŒ‰åˆ†åŒºè¿›è¡Œè¿‡æ»¤ï¼š </p><br><p><img src="https://habrastorage.org/webt/9-/n4/dc/9-n4dczjdvcrspm0zbypq-ul5cs.png" alt="åˆ†åŒºè¿‡æ»¤å™¨è¯·æ±‚"></p><br><p> æ›´å¿«ä¸€ç‚¹ï¼Œä½†æœ€é‡è¦çš„æ˜¯-åªæœ‰1.23å…†å­—èŠ‚çš„æ•°æ®ï¼ å¦‚æœä»·æ ¼ä¸ä½äºæ¯ä¸ªè¯·æ±‚10å…†å­—èŠ‚ï¼Œåˆ™ä»·æ ¼ä¼šä¾¿å®œå¾—å¤šã€‚ ä½†æ— è®ºå¦‚ä½•è¿˜æ˜¯è¦å¥½å¾—å¤šï¼Œåœ¨å¤§å‹æ•°æ®é›†ä¸Šï¼Œå·®å¼‚å°†æ›´åŠ æ˜æ˜¾ã€‚ </p><br><h2 id="sobiraem-deshbord-s-pomoschyu-cubejs"> ä½¿ç”¨Cube.jsæ„å»ºä»ªè¡¨æ¿ </h2><br><p> è¦æ„å»ºä»ªè¡¨æ¿ï¼Œæˆ‘ä»¬ä½¿ç”¨Cube.jsåˆ†ææ¡†æ¶ã€‚ å®ƒå…·æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œä½†æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ˜¯ä¸¤ä¸ªï¼šåœ¨åˆ†åŒºä¸Šè‡ªåŠ¨ä½¿ç”¨è¿‡æ»¤å™¨å’Œé¢„å…ˆèšåˆæ•°æ®çš„åŠŸèƒ½ã€‚ å®ƒä½¿ç”¨ç”¨Javascriptç¼–å†™çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ•°æ®æ¨¡å¼</a>æ¥ç”ŸæˆSQLå¹¶æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ã€‚ æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯æŒ‡ç¤ºå¦‚ä½•åœ¨æ•°æ®æ¨¡å¼ä¸­ä½¿ç”¨åˆ†åŒºè¿‡æ»¤å™¨ã€‚ </p><br><p> è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºCube.jsã€‚ ç”±äºæˆ‘ä»¬å·²ç»ä½¿ç”¨è¿‡AWSå †æ ˆï¼Œå› æ­¤ä½¿ç”¨Lambdaè¿›è¡Œéƒ¨ç½²æ˜¯åˆä¹é€»è¾‘çš„ã€‚ å¦‚æœè®¡åˆ’åœ¨Herokuæˆ–Dockerä¸­æ‰˜ç®¡Cube.jsåç«¯ï¼Œåˆ™å¯ä»¥ä½¿ç”¨expressæ¨¡æ¿è¿›è¡Œç”Ÿæˆã€‚ è¯¥æ–‡æ¡£æè¿°äº†å…¶ä»–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‰˜ç®¡æ–¹æ³•</a> ã€‚ </p><br><pre> <code class="bash hljs">$ npm install -g cubejs-cli $ cubejs create nginx-log-analytics -t serverless -d athena</code> </pre> <br><p> ç¯å¢ƒå˜é‡ç”¨äºåœ¨cube.jsä¸­é…ç½®å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚ ç”Ÿæˆå™¨å°†åˆ›å»ºä¸€ä¸ª.envæ–‡ä»¶ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æŒ‡å®š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Athena</a>çš„å¯†é’¥ã€‚ </p><br><p> ç°åœ¨æˆ‘ä»¬éœ€è¦<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸€ä¸ªæ•°æ®æ–¹æ¡ˆï¼Œ</a>åœ¨å…¶ä¸­å¯ä»¥æŒ‡ç¤ºæ—¥å¿—çš„å­˜å‚¨æ–¹å¼ã€‚ æ‚¨å¯ä»¥åœ¨æ­¤å¤„æŒ‡å®šå¦‚ä½•è¯»å–ä»ªè¡¨æ¿çš„æŒ‡æ ‡ã€‚ </p><br><p> åœ¨<code>schema</code>ç›®å½•ä¸­ï¼Œåˆ›å»º<code>Logs.js</code>æ–‡ä»¶ã€‚ è¿™æ˜¯nginxçš„ç¤ºä¾‹æ•°æ®æ¨¡å‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">å‹å·ä»£ç </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> partitionFilter = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">` date(from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">)) &lt;= date_parse(partition_0 || partition_1 || partition_2, '%Y%m%d') AND date(from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${to}</span></span></span><span class="hljs-string">)) &gt;= date_parse(partition_0 || partition_1 || partition_2, '%Y%m%d') `</span></span> cube(<span class="hljs-string"><span class="hljs-string">`Logs`</span></span>, { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">` select * from part_demo_kinesis_bucket WHERE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${FILTER_PARAMS.Logs.createdAt.filter(partitionFilter)}</span></span></span><span class="hljs-string"> `</span></span>, <span class="hljs-attr"><span class="hljs-attr">measures</span></span>: { <span class="hljs-attr"><span class="hljs-attr">count</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`count`</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">errorCount</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`count`</span></span>, <span class="hljs-attr"><span class="hljs-attr">filters</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${CUBE.isError}</span></span></span><span class="hljs-string"> = 'Yes'`</span></span> } ] }, <span class="hljs-attr"><span class="hljs-attr">errorRate</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`number`</span></span>, <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`100.0 * </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${errorCount}</span></span></span><span class="hljs-string"> / </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${count}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-string"><span class="hljs-string">`percent`</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">dimensions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">status</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`status`</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`number`</span></span> }, <span class="hljs-attr"><span class="hljs-attr">isError</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`string`</span></span>, <span class="hljs-attr"><span class="hljs-attr">case</span></span>: { <span class="hljs-attr"><span class="hljs-attr">when</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${CUBE}</span></span></span><span class="hljs-string">.status &gt;= 400`</span></span>, <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">`Yes`</span></span> }], <span class="hljs-attr"><span class="hljs-attr">else</span></span>: { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">`No`</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">createdAt</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: <span class="hljs-string"><span class="hljs-string">`from_unixtime(created_at)`</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`time`</span></span> } } });</code> </pre> </div></div><br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FILTER_PARAMS</a>å˜é‡æ¥ç”Ÿæˆå¸¦æœ‰åˆ†åŒºè¿‡æ»¤å™¨çš„SQLæŸ¥è¯¢ã€‚ </p><br><p> æˆ‘ä»¬è¿˜æŒ‡å®šäº†è¦æ˜¾ç¤ºåœ¨ä»ªè¡¨æ¿ä¸Šçš„æŒ‡æ ‡å’Œå‚æ•°ï¼Œå¹¶æŒ‡å®šäº†é¢„èšåˆã€‚  Cube.jså°†ä½¿ç”¨é¢„èšåˆçš„æ•°æ®åˆ›å»ºå…¶ä»–è¡¨ï¼Œå¹¶å°†åœ¨æ•°æ®å¯ç”¨æ—¶è‡ªåŠ¨æ›´æ–°ã€‚ è¿™ä¸ä»…åŠ å¿«äº†è¯·æ±‚çš„é€Ÿåº¦ï¼Œè€Œä¸”é™ä½äº†ä½¿ç”¨Athenaçš„æˆæœ¬ã€‚ </p><br><p> å°†æ­¤ä¿¡æ¯æ·»åŠ åˆ°æ•°æ®æ¨¡å¼æ–‡ä»¶ï¼š </p><br><pre> <code class="javascript hljs">preAggregations: { <span class="hljs-attr"><span class="hljs-attr">main</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">`rollup`</span></span>, <span class="hljs-attr"><span class="hljs-attr">measureReferences</span></span>: [count, errorCount], <span class="hljs-attr"><span class="hljs-attr">dimensionReferences</span></span>: [isError, status], <span class="hljs-attr"><span class="hljs-attr">timeDimensionReference</span></span>: createdAt, <span class="hljs-attr"><span class="hljs-attr">granularity</span></span>: <span class="hljs-string"><span class="hljs-string">`day`</span></span>, <span class="hljs-attr"><span class="hljs-attr">partitionGranularity</span></span>: <span class="hljs-string"><span class="hljs-string">`month`</span></span>, <span class="hljs-attr"><span class="hljs-attr">refreshKey</span></span>: { <span class="hljs-attr"><span class="hljs-attr">sql</span></span>: FILTER_PARAMS.Logs.createdAt.filter(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">`select CASE WHEN from_iso8601_timestamp(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${to}</span></span></span><span class="hljs-string">) + interval '3' day &gt; now() THEN date_trunc('hour', now()) END`</span></span> ) } } }</code> </pre> <br><p> åœ¨æ­¤æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬æŒ‡å‡ºæœ‰å¿…è¦ä¸ºæ‰€æœ‰ä½¿ç”¨çš„æŒ‡æ ‡é¢„å…ˆæ±‡æ€»æ•°æ®ï¼Œå¹¶ä½¿ç”¨æ¯æœˆåˆ†åŒºã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¯¹é¢„èšåˆ</a>è¿›è¡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆ†åŒº</a>å¯ä»¥å¤§å¤§åŠ å¿«æ•°æ®æ”¶é›†å’Œæ›´æ–°çš„é€Ÿåº¦ã€‚ </p><br><p> ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»„è£…ä¸€ä¸ªä»ªè¡¨æ¿äº†ï¼ </p><br><p>  Cube.jsåç«¯ä¸ºæµè¡Œçš„å‰ç«¯æ¡†æ¶æä¾›äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">REST API</a>å’Œä¸€ç»„å®¢æˆ·ç«¯åº“ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨å®¢æˆ·ç«¯çš„Reactç‰ˆæœ¬æ¥æ„å»ºä»ªè¡¨æ¿ã€‚  Cube.jsä»…æä¾›æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯è§†åŒ–åº“-æˆ‘å–œæ¬¢<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">recharts</a> ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸€ä¸ªã€‚ </p><br><p>  Cube.jsæœåŠ¡å™¨æ¥å—<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JSONæ ¼å¼</a>çš„è¯·æ±‚ï¼Œè¯¥è¯·æ±‚æŒ‡ç¤ºå¿…è¦çš„æŒ‡æ ‡ã€‚ ä¾‹å¦‚ï¼Œè¦è®¡ç®—Nginxæ¯å¤©ç»™å‡ºçš„é”™è¯¯æ•°é‡ï¼Œæ‚¨éœ€è¦å‘é€ä»¥ä¸‹è¯·æ±‚ï¼š </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"measures"</span></span>: [<span class="hljs-string"><span class="hljs-string">"Logs.errorCount"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"timeDimensions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"dimension"</span></span>: <span class="hljs-string"><span class="hljs-string">"Logs.createdAt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateRange"</span></span>: [<span class="hljs-string"><span class="hljs-string">"2019-01-01"</span></span>, <span class="hljs-string"><span class="hljs-string">"2019-01-07"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"granularity"</span></span>: <span class="hljs-string"><span class="hljs-string">"day"</span></span> } ] }</code> </pre> <br><p> é€šè¿‡NPMå®‰è£…Cube.jså®¢æˆ·ç«¯å’ŒReactç»„ä»¶åº“ï¼š </p><br><pre> <code class="bash hljs">$ npm i --save @cubejs-client/core @cubejs-client/react</code> </pre> <br><p> æˆ‘ä»¬å¯¼å…¥<code>cubejs</code>å’ŒQueryRendererç»„ä»¶ä»¥å¸è½½æ•°æ®ï¼Œå¹¶æ”¶é›†ä»ªè¡¨æ¿ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ä»ªè¡¨æ¿ä»£ç </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { LineChart, Line, XAxis, YAxis } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'recharts'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cubejs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@cubejs-client/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { QueryRenderer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@cubejs-client/react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cubejsApi = cubejs( <span class="hljs-string"><span class="hljs-string">'YOUR-CUBEJS-API-TOKEN'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">apiUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'http://localhost:4000/cubejs-api/v1'</span></span> }, ); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;QueryRenderer query={{ measures: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Logs.errorCount'</span></span></span></span><span class="hljs-function"><span class="hljs-params">], timeDimensions: [{ dimension: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Logs.createdAt'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dateRange: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'2019-01-01'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'2019-01-07'</span></span></span></span><span class="hljs-function"><span class="hljs-params">], granularity: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'day'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> }] }} cubejsApi={cubejsApi} render={({ resultSet }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!resultSet) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Loading...'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( &lt;LineChart data={resultSet.rawData()}&gt; &lt;XAxis dataKey="Logs.createdAt"/&gt; &lt;YAxis/&gt; &lt;Line type="monotone" dataKey="Logs.errorCount" stroke="#8884d8"/&gt; &lt;/LineChart&gt; ); }} /&gt; ) }</code> </pre> </div></div><br><p> ä»ªè¡¨æ¿æºä½äº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CodeSandboxä¸Š</a> ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN447886/">https://habr.com/ru/post/zh-CN447886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN447876/index.html">ä¸€åˆ‡éƒ½éå¸¸ç³Ÿç³•ï¼Œæˆ–è€…æ˜¯ä¸€ç§æ–°å‹çš„äº¤é€šæ‹¦æˆª</a></li>
<li><a href="../zh-CN447878/index.html">ä½¿ç”¨PVS-Studioæ£€æŸ¥rdesktopå’Œxrdp</a></li>
<li><a href="../zh-CN447880/index.html">ä½¿ç”¨PVS-Studioåˆ†æä»ªéªŒè¯rdesktopå’Œxrdp</a></li>
<li><a href="../zh-CN447882/index.html">ç½‘ç»œå·¥å…·ï¼Œè¿˜æ˜¯ä»å“ªé‡Œå¼€å§‹ï¼Ÿ</a></li>
<li><a href="../zh-CN447884/index.html">æˆ‘ä»¬äº†è§£äº†5Gå¦‚ä½•åœ¨è¡—é“å’Œå®¤å†…æ¯«ç±³èŒƒå›´å†…å·¥ä½œ</a></li>
<li><a href="../zh-CN447890/index.html">è°¢è°¢ä¸Šå¸ï¼Œæˆ‘ä¸æ˜¯ç»ç†</a></li>
<li><a href="../zh-CN447892/index.html">ä¸¤ä¸ªæ–°çš„PHDaysç«èµ›ï¼šIDSç»•è¿‡å’Œå·¥å‚å…¥ä¾µ</a></li>
<li><a href="../zh-CN447894/index.html">MODXæ‘˜è¦ï¼ƒ3ï¼ˆ2019å¹´3æœˆ25æ—¥è‡³4æœˆ8æ—¥ï¼‰</a></li>
<li><a href="../zh-CN447896/index.html">ç²—ç•¥å›¾ç‰‡çš„ç…§ç‰‡ï¼šNVIDIA GauGANç¥ç»ç½‘ç»œçš„å·¥ä½œåŸç†</a></li>
<li><a href="../zh-CN447898/index.html">ç»éªŒä¸°å¯Œçš„å“²å­¦å®¶æˆ–æœ‰ç«äº‰åŠ›çš„.NETç¼–ç¨‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>