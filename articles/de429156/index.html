<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👲🏾 🤴 👨‍🎓 Die ganze Wahrheit über RTOS. Artikel Nr. 19. Semaphoren: Einführung und Grundversorgung 💅🏿 👨‍⚕️ 📏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Semaphoren wurden in einem der vorherigen Artikel (Nr. 5) erwähnt. Ihre Hauptaufgabe besteht darin, den Zugriff auf Ressourcen zu kontrollieren. 

 Fr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die ganze Wahrheit über RTOS. Artikel Nr. 19. Semaphoren: Einführung und Grundversorgung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429156/"><img src="https://habrastorage.org/webt/59/6c/rd/596crdjhkaeefilqj_5ogaagbsc.jpeg"><br><br>  Semaphoren wurden in einem der vorherigen Artikel (Nr. 5) erwähnt.  Ihre Hauptaufgabe besteht darin, den Zugriff auf Ressourcen zu kontrollieren. <br><a name="habracut"></a><br>  Frühere Artikel in der Reihe: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 18.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ereignisflag-Gruppen: Hilfsdienste und Datenstrukturen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 17.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ereignisflag-Gruppen: Einführung und Basisdienste</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 16.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Signale</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 15.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Speicherpartitionen: Dienste und Datenstrukturen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel # 14.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Speicherbereiche: Einführung und Grundversorgung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel Nr. 13.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgabendatenstrukturen und nicht unterstützte API-Aufrufe</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 12.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dienstleistungen für die Arbeit mit Aufgaben</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 11.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgaben: Konfiguration und Einführung in die API</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 10.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Scheduler: Erweiterte Funktionen und Kontexterhaltung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 9.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Scheduler: Implementierung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 8.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nucleus SE: Internes Design und Bereitstellung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 7.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nucleus SE: Einführung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 6.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Andere RTOS-Dienste</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgabeninteraktion und Synchronisation</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgaben, Kontextwechsel und Interrupts</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgaben und Planung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RTOS: Struktur und Echtzeitmodus</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><br></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel 1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RTOS: Einführung.</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><br></a> <br><h2>  Semaphoren verwenden </h2><br>  In Nucleus SE werden Semaphoren in der Assemblierungsphase definiert.  Eine Anwendung kann bis zu 16 Semaphoren enthalten.  Wenn keine Semaphoren angegeben sind, ist der Code für Serviceaufrufe und Datenstrukturen nicht in der Anwendung enthalten. <br><br>  Ein Semaphor ist ein Zähler vom Typ <b>U8</b> , dessen Zugriff so gesteuert wird, dass mehrere Aufgaben ihn verwenden können.  Eine Aufgabe kann den Wert des Semaphorzählers verringern (erfassen) oder erhöhen (freigeben).  Der Versuch, ein Semaphor mit dem Wert Null zu erfassen, kann abhängig von den ausgewählten API-Aufrufparametern und der Nucleus SE-Konfiguration zu einem Fehler oder einer Unterbrechung der Aufgabe führen. <br><br><h2>  Semaphore einrichten </h2><br><h3>  Anzahl der Semaphoren </h3><br>  Wie bei den meisten Nucleus SE-Objekten wird die Einstellung von Semaphoren durch die Direktiven <b>#define</b> in <b>nuse_config.h bestimmt</b> .  Der Hauptparameter ist <b>NUSE_SEMAPHORE_NUMBER</b> , der die Anzahl der Semaphoren in der Anwendung bestimmt.  Standardmäßig ist der Parameter auf 0 gesetzt (Semaphoren werden in der Anwendung nicht verwendet) und kann einen beliebigen Wert bis 16 annehmen. Ein falscher Wert führt zu einem Kompilierungsfehler, der durch Einchecken in <b>nuse_config_check.h</b> generiert wird (diese Datei ist in <b>nuse_config.c enthalten</b> , <b>dh</b> sie wird kompiliert zusammen mit diesem Modul) wird <b>daher die</b> Direktive <b>#error ausgelöst</b> . <br><br>  Die Auswahl eines Werts ungleich Null dient als Hauptaktivator für Semaphoren.  Dieser Parameter wird beim Definieren von Datenstrukturen verwendet und ihre Größe hängt von ihrem Wert ab (weitere Einzelheiten finden Sie weiter unten in diesem Artikel).  Darüber hinaus aktiviert ein Wert ungleich Null die API-Einstellungen. <br><br><h3>  API-Aufrufe aktivieren </h3><br>  Jede API-Funktion (Dienstprogrammaufruf) in Nucleus SE wird durch die Direktive <b>#define</b> in <b>nuse_config.h</b> aktiviert.  Zu Semaphoren gehören: <br><br> <code>NUSE_SEMAPHORE_OBTAIN <br> NUSE_SEMAPHORE_RELEASE <br> NUSE_SEMAPHORE_RESET <br> NUSE_SEMAPHORE_INFORMATION <br> NUSE_SEMAPHORE_COUNT <br></code> <br><br>  Standardmäßig sind sie auf <b>FALSE gesetzt</b> , wodurch jeder Serviceabruf deaktiviert und die Aufnahme von Code blockiert wird, der sie implementiert.  Um Semaphoren einzurichten, müssen Sie die erforderlichen API-Aufrufe auswählen und die entsprechenden Anweisungen auf <b>TRUE setzen</b> . <br><br>  Das Folgende ist ein Auszug aus der Standarddatei <b>nuse_config.h</b> . <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NUSE_SEMAPHORE_NUMBER 0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Number of semaphores in the system - 0-16 */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NUSE_SEMAPHORE_OBTAIN FALSE </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Service call enabler */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NUSE_SEMAPHORE_RELEASE FALSE </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Service call enabler */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NUSE_SEMAPHORE_RESET FALSE </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Service call enabler */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NUSE_SEMAPHORE_INFORMATION FALSE </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Service call enabler */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NUSE_SEMAPHORE_COUNT FALSE </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Service call enabler */</span></span></span></span></code> </pre><br>  Eine aktivierte API-Funktion, wenn die Anwendung keine Semaphoren enthält, führt zu einem Kompilierungsfehler (mit Ausnahme von <b>NUSE_Semaphore_Count ()</b> , das immer aktiviert ist).  Wenn Ihr Code einen API-Aufruf verwendet, der nicht aktiviert wurde, tritt ein Layoutfehler auf, da der Implementierungscode nicht in der Anwendung enthalten war. <br><br><h2>  Utility-Semaphoraufrufe </h2><br>  Nucleus RTOS unterstützt acht Serviceaufrufe mit folgenden Funktionen: <br><br><ul><li>  Semaphor-Erfassung.  Nucleus SE ist in der Funktion <b>NUSE_Semaphore_Obtain ()</b> implementiert. </li><li>  Semaphor freigeben.  In Nucleus SE ist es in der Funktion <b>NUSE_Semaphore_Release ()</b> implementiert. </li><li>  Zurücksetzen des Semaphors in einen nicht verwendeten Zustand mit Freigabe aller angehaltenen Aufgaben (Neustart).  Nucleus SE ist in <b>NUSE_Semaphore_Reset ()</b> implementiert. </li><li>  Bereitstellung von Informationen zu einem bestimmten Semaphor.  Nucleus SE ist in <b>NUSE_Semaphore_Information ()</b> implementiert. </li><li>  Gibt die Anzahl der konfigurierten Semaphoren in der Anwendung zurück.  Nucleus SE in <b>NUSE_Semaphore_Count ()</b> implementiert. </li><li>  Hinzufügen eines neuen Semaphors zur Anwendung.  Nucleus SE ist nicht implementiert. </li><li>  Semaphor aus der Anwendung entfernen.  Nucleus SE ist nicht implementiert. </li><li>  Rückgabe von Zeigern auf alle Semaphoren.  Nucleus SE ist nicht implementiert. </li></ul><br>  Die Implementierung jedes Serviceabrufs wird nachstehend ausführlich beschrieben. <br><br><h2>  Dienstprogrammaufrufe zum Erfassen und Freigeben von Semaphoren </h2><br>  Die grundlegenden Operationen, die an Semaphoren ausgeführt werden können, sind das Erfassen und Freigeben (Verringern und Erhöhen des Werts).  Nucleus RTOS und Nucleus SE bieten zwei grundlegende API-Aufrufe für diese Operationen. <br><br><h3>  Semaphor-Erfassung </h3><br>  Der Aufruf des Nucleus RTOS-Dienstprogramms zum Erfassen eines Semaphors ist sehr flexibel und ermöglicht es Ihnen, Aufgaben implizit oder mit einem bestimmten Zeitlimit anzuhalten, wenn der Vorgang derzeit nicht ausgeführt werden kann, z. B. wenn Sie versuchen, ein Semaphor mit einem Wert von Null zu erfassen.  Nucleus SE bietet dieselben Funktionen, nur die Unterbrechung der Aufgabe ist optional und eine Zeitüberschreitung ist nicht implementiert. <br><br>  <b><i>Herausforderung, Semaphor in Nucleus RTOS zu erfassen</i></b> <br>  Prototyp eines Serviceabrufs: <br>  <b>STATUS NU_Obtain_Semaphore (NU_SEMAPHORE * -Semaphor, UNSIGNED suspend);</b> <br><br>  Parameter: <br><br>  <b>Semaphor</b> - Zeiger auf den vom Benutzer bereitgestellten Semaphor-Steuerblock; <br>  <b>suspend</b> - Task Suspension-Parameter kann die Werte <b>NU_NO_SUSPEND</b> oder <b>NU_SUSPEND</b> sowie den Timeout-Wert <b>annehmen</b> . <br><br>  Rückgabewert: <br><br>  <b>NU_SUCCESS</b> - Der Anruf wurde erfolgreich abgeschlossen. <br>  <b>NU_UNAVAILABLE</b> - Das Semaphor hatte einen Nullwert. <br>  <b>NU_INVALID_SEMAPHORE</b> - ungültiger Zeiger auf ein Semaphor; <br>  <b>NU_INVALID_SUSPEND</b> - Versuch, von einem nicht aufgabenbezogenen Thread aus <b>anzuhalten</b> ; <br>  <b>NU_SEMAPHORE_WAS_RESET</b> - Das Semaphor wurde zurückgesetzt, während die Aufgabe angehalten wurde. <br><br>  <b><i>Herausforderung, Semaphor in Nucleus SE zu erfassen</i></b> <br>  Dieser API-Aufruf unterstützt die Kernfunktionalität der Nucleus RTOS-API. <br><br>  Prototyp eines Serviceabrufs: <br><br>  <b>STATUS NUSE_Semaphore_Obtain (NUSE_SEMAPHORE-Semaphor, U8-Suspend);</b> <br><br>  Parameter: <br><br>  <b>Semaphor</b> - Index (ID) des verwendeten Semaphors; <br>  <b>suspend</b> - Der Parameter für <b>die</b> Task-Suspendierung kann <b>NUSE_NO_SUSPEND</b> oder <b>NUSE_SUSPEND sein</b> . <br><br>  Rückgabewert: <br><br>  <b>NUSE_SUCCESS</b> - Der Anruf wurde erfolgreich abgeschlossen. <br>  <b>NUSE_UNAVAILABLE</b> - Das Semaphor hatte einen Nullwert. <br>  <b>NUSE_INVALID_SEMAPHORE</b> - ungültiger Semaphorindex; <br>  <b>NUSE_INVALID_SUSPEND</b> - ein Versuch, von einem nicht aufgabenbezogenen Thread aus <b>anzuhalten</b> oder wenn die API-Blockierungsfunktion deaktiviert ist; <br>  <b>NUSE_SEMAPHORE_WAS_RESET</b> - Das Semaphor wurde zurückgesetzt, während die Aufgabe angehalten wurde. <br><br>  <b><i>Implementierung der Semaphor-Erfassung in Nucleus SE</i></b> <br>  Die <b>Codevariante der</b> Funktion <b>NUSE_Semaphore_Obtain ()</b> (nach Überprüfung der Parameter) wird mithilfe der bedingten Kompilierung ausgewählt, je nachdem, ob die Unterstützung für das Blockieren (Anhalten) von Aufgaben aktiviert ist oder nicht.  Betrachten Sie beide Optionen. <br><br>  Wenn die Sperre nicht aktiviert ist, ist die Logik dieses API-Aufrufs ziemlich einfach: <br><br><pre> <code class="hljs powershell"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NUSE_Semaphore_Counter[<span class="hljs-type"><span class="hljs-type">semaphore</span></span>] != <span class="hljs-number"><span class="hljs-number">0</span></span>) /* semaphore available */ { NUSE_Semaphore_Counter[<span class="hljs-type"><span class="hljs-type">semaphore</span></span>]--; return_value = NUSE_SUCCESS; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> /* semaphore unavailable */ { return_value = NUSE_UNAVAILABLE; }</code> </pre><br>  Der Wert des Semaphorzählers wird überprüft und nimmt ab, wenn er nicht gleich Null ist. <br><br>  Wenn die Task-Sperre aktiviert ist, wird die Logik komplexer: <br><br><pre> <code class="hljs powershell"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NUSE_Semaphore_Counter[<span class="hljs-type"><span class="hljs-type">semaphore</span></span>] != <span class="hljs-number"><span class="hljs-number">0</span></span>) /* semaphore available */ { NUSE_Semaphore_Counter[<span class="hljs-type"><span class="hljs-type">semaphore</span></span>]--; return_value = NUSE_SUCCESS; suspend = NUSE_NO_SUSPEND; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> /* semaphore unavailable */ { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (suspend == NUSE_NO_SUSPEND) { return_value = NUSE_UNAVAILABLE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { /* block task */ NUSE_Semaphore_Blocking_Count[<span class="hljs-type"><span class="hljs-type">semaphore</span></span>]++; NUSE_Suspend_Task(NUSE_Task_Active, semaphore &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) | NUSE_SEMAPHORE_SUSPEND); return_value = NUSE_Task_Blocking_Return[<span class="hljs-type"><span class="hljs-type">NUSE_Task_Active</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (return_value != NUSE_SUCCESS) { suspend = NUSE_NO_SUSPEND; } } } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (suspend == NUSE_SUSPEND);</code> </pre><br>  Einige Erläuterungen können hilfreich sein. <br><br>  Der Code wird in eine <b>do ... while-Schleife gestellt</b> , die ausgeführt wird, während der <b>suspend-</b> Parameter <b>NUSE_SUSPEND lautet</b> . <br><br>  Wenn das Semaphor einen Wert ungleich Null hat, nimmt es ab.  Die <b>Suspend-</b> Variable wird auf <b>NUSE_NO_SUSPEND gesetzt</b> , und der API-Aufruf wird beendet und gibt <b>NUSE_SUCESS zurück</b> . <br><br>  Wenn das Semaphor null ist und die <b>Suspend-</b> Variable auf <b>NUSE_NO_SUSPEND gesetzt ist</b> , gibt der API-Aufruf <b>NUSE_UNAVAILABLE zurück</b> .  Wenn die Aussetzung auf <b>NUSE_SUSPEND gesetzt wurde</b> , wird die Aufgabe <b>angehalten</b> .  Wenn der Aufruf nach Abschluss des Aufrufs (z. B. wenn die Aufgabe <b>fortgesetzt</b> wird) <b>NUSE_SUCCESS lautet</b> (was darauf hinweist, dass die Aufgabe nach dem <b>Freigeben</b> des Semaphors und nicht nach dem Zurücksetzen wieder aufgenommen wurde), beginnt der Zyklus von <b>vorne</b> . <br><br><h3>  Semaphor-Veröffentlichung </h3><br>  Der Dienstprogrammaufruf an die Nucleus RTOS-API zum Freigeben des Semaphors ist recht einfach: Der Wert des Semaphorzählers steigt und eine Erfolgsmeldung wird zurückgegeben.  Nucleus SE bietet dieselben Funktionen, jedoch mit zusätzlicher Überlaufprüfung. <br><br>  <b><i>Herausforderung, Semaphoren in Nucleus RTOS freizugeben</i></b> <br>  Prototyp eines Serviceabrufs: <br><br>  <b>STATUS NU_Release_Semaphore (NU_SEMAPHORE * -Semaphor);</b> <br><br>  Parameter: <br><br>  <b>Semaphor</b> - Ein Zeiger auf einen vom Benutzer bereitgestellten Semaphor-Steuerblock. <br><br>  Rückgabewert: <br><br>  <b>NU_SUCCESS</b> - Der Anruf wurde erfolgreich abgeschlossen. <br>  <b>NU_INVALID_SEMAPHORE</b> - <b>Ungültiger</b> Semaphorzeiger. <br><br>  <b><i>Herausforderung, Semaphor in Nucleus SE freizugeben</i></b> <br>  Dieser API-Aufruf unterstützt die Kernfunktionalität der Nucleus RTOS-API. <br><br>  Prototyp eines Serviceabrufs: <br><br>  <b>STATUS NUSE_Semaphore_Release (NUSE_SEMAPHORE-Semaphor);</b> <br><br>  Parameter: <br><br>  <b>Semaphor</b> - Der Index (ID) des freigegebenen Semaphors. <br><br>  Rückgabewert: <br><br>  <b>NUSE_SUCCESS</b> - Der Anruf wurde erfolgreich abgeschlossen. <br>  <b>NUSE_INVALID_SEMAPHORE</b> - ungültiger Semaphorindex; <br>  <b>NUSE_UNAVAILABLE</b> - Das Semaphor hat einen Wert von 255 und kann nicht erhöht werden. <br><br>  <b><i>Implementierung der Semaphorfreigabe in Nucleus SE</i></b> <br>  Der Funktionscode <b>NUSE_Semaphore_Release ()</b> (nach Überprüfung der Parameter) ist üblich, unabhängig davon, ob die Task-Sperre aktiviert ist oder nicht.  Der Wert des Semaphorzählers wird überprüft, und wenn er kleiner als 255 ist, erhöht er sich. <br><br>  Weiterer Code wird mithilfe der bedingten Kompilierung ausgewählt, wenn die Unterstützung für API-Blockierungsaufrufe (Task-Suspendierung) aktiviert ist: <br><br><pre> <code class="hljs kotlin">NUSE_CS_Enter(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NUSE_Semaphore_Counter[semaphore] &lt; <span class="hljs-number"><span class="hljs-number">255</span></span>) { NUSE_Semaphore_Counter[semaphore]++; return_value = NUSE_SUCCESS; #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> NUSE_BLOCKING_ENABLE <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NUSE_Semaphore_Blocking_Count[semaphore] != <span class="hljs-number"><span class="hljs-number">0</span></span>) { U8 index; <span class="hljs-comment"><span class="hljs-comment">/* check whether a task is blocked */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* on this semaphore */</span></span> NUSE_Semaphore_Blocking_Count[semaphore]--; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (index=<span class="hljs-number"><span class="hljs-number">0</span></span>; index&lt;NUSE_TASK_NUMBER; index++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((LONIB(NUSE_Task_Status[index]) == NUSE_SEMAPHORE_SUSPEND) &amp;&amp; (HINIB(NUSE_Task_Status[index]) == semaphore)) { NUSE_Task_Blocking_Return[index] = NUSE_SUCCESS; NUSE_Wake_Task(index); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } #endif } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { return_value = NUSE_UNAVAILABLE; } NUSE_CS_Exit(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> return_value;</code> </pre><br>  Wenn Aufgaben für dieses Semaphor angehalten werden, wird die erste fortgesetzt. <br><br>  Der folgende Artikel beschreibt zusätzliche API-Aufrufe, die Semaphoren und ihren Datenstrukturen zugeordnet sind. <br><br>  <b>Über den Autor:</b> Colin Walls ist seit über dreißig Jahren in der Elektronikindustrie tätig und widmet sich die meiste Zeit der Firmware.  Heute ist er Firmware-Ingenieur bei Mentor Embedded (einer Abteilung von Mentor Graphics).  Colin Walls spricht häufig auf Konferenzen und Seminaren, Autor zahlreicher technischer Artikel und zweier Bücher über Firmware.  Lebt in Großbritannien.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Colins</a> professioneller <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Blog</a> , E-Mail: colin_walls@mentor.com. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de429156/">https://habr.com/ru/post/de429156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de429146/index.html">Schaltnetzteil für Teletyp aus den 1940er Jahren (mit leuchtenden Quecksilberthyratrons!)</a></li>
<li><a href="../de429148/index.html">Wie "effektive Manager" Flickr ertranken</a></li>
<li><a href="../de429150/index.html">Verwalten Ihrer Module für CMS mit Composer</a></li>
<li><a href="../de429152/index.html">Android-Navigationskomponente. Einfache Dinge, die Sie selbst tun müssen</a></li>
<li><a href="../de429154/index.html">Zweitabrechnung, Marktplatz und Sandboxes für Big Data: Was können Testumgebungen in der Cloud tun?</a></li>
<li><a href="../de429158/index.html">Das Impostor-Syndrom betrifft Männer nicht weniger als Frauen ... und andere Ergebnisse aus 10.000 technischen Interviews</a></li>
<li><a href="../de429160/index.html">Nintendo DS Console GPUs und interessante Funktionen</a></li>
<li><a href="../de429162/index.html">„Um Änderungen vorzunehmen, verstehen Sie, warum Menschen sich dagegen wehren“: Jim Holmes über das Testen der Kultur</a></li>
<li><a href="../de429166/index.html">Multikristall: Von der Geschichte bis zur Spekulation über die Zukunft</a></li>
<li><a href="../de429168/index.html">Durch Feuer und Wasser: die Geschichte der russischen populärwissenschaftlichen Literatur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>