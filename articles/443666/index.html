<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëåüèΩ üç™ üîù Nuestro enfoque para colorear hilos ‚§µÔ∏è üë©üèΩ‚Äçü§ù‚Äçüë®üèº üìç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En la empresa siempre nos esforzamos por aumentar la capacidad de mantenimiento de nuestro c√≥digo, utilizando pr√°cticas generalmente aceptadas, inclus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nuestro enfoque para colorear hilos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/443666/">  En la empresa siempre nos esforzamos por aumentar la capacidad de mantenimiento de nuestro c√≥digo, utilizando pr√°cticas generalmente aceptadas, incluso en asuntos de subprocesamiento m√∫ltiple.  Esto no resuelve todas las dificultades que conlleva una carga cada vez mayor, pero simplifica el soporte: tambi√©n gana legibilidad de c√≥digo y la velocidad de desarrollo de nuevas funciones. <br><br>  Ahora tenemos 47,000 usuarios diarios, alrededor de 30 servidores en producci√≥n, 2,000 solicitudes de API por segundo y lanzamientos diarios.  El servicio Miro se ha desarrollado desde 2011, y en la implementaci√≥n actual, las solicitudes de los usuarios son procesadas en paralelo por un grupo de servidores heterog√©neos. <br><br><img src="https://habrastorage.org/webt/al/ef/z0/alefz0rg731nodv93vg78p2hvsa.png"><br><a name="habracut"></a><br><h2>  Subsistema de control de acceso competitivo </h2><br>  El valor principal de nuestro producto son las placas colaborativas de usuarios, por lo que la carga principal recae sobre ellas.  El subsistema principal que controla la mayor parte del acceso competitivo es el sistema con estado de sesiones de usuario en el tablero. <br><br>  Para cada placa que se puede abrir en uno de los servidores, el estado aumenta.  Almacena los datos de tiempo de ejecuci√≥n de la aplicaci√≥n necesarios para garantizar la colaboraci√≥n y la visualizaci√≥n del contenido, as√≠ como los datos del sistema, como la vinculaci√≥n a subprocesos de procesamiento.  La informaci√≥n sobre en qu√© servidor se almacena el estado se escribe en una estructura distribuida y es accesible para el cl√∫ster mientras el servidor se est√© ejecutando, y al menos un usuario est√© en el tablero.  Utilizamos Hazelcast para proporcionar esta parte del subsistema.  Todas las conexiones nuevas a la placa se env√≠an al servidor con este estado. <br><br>  Cuando se conecta al servidor, el usuario ingresa a la secuencia receptora, cuya √∫nica tarea es vincular la conexi√≥n al estado de la placa correspondiente, en cuyo flujo se realizar√° todo el trabajo adicional. <br><br>  Hay dos transmisiones asociadas a la placa: la red, las conexiones de procesamiento y el "negocio", responsable de la l√≥gica empresarial.  Esto le permite transformar la ejecuci√≥n de tareas heterog√©neas de procesamiento de paquetes de red y ejecuci√≥n de comandos comerciales de serie a paralelo.  Los comandos de red procesados ‚Äã‚Äãde los usuarios forman tareas empresariales aplicadas y los dirigen a la secuencia empresarial, donde se procesan secuencialmente.  Esto evita la sincronizaci√≥n innecesaria al desarrollar el c√≥digo de la aplicaci√≥n. <br><br>  La divisi√≥n del c√≥digo en negocio / aplicaci√≥n y sistema es nuestra convenci√≥n interna.  Le permite distinguir entre el c√≥digo responsable de las caracter√≠sticas y capacidades para los usuarios, de los detalles de bajo nivel de comunicaci√≥n, eliminaci√≥n y almacenamiento, que son la herramienta de servicio. <br><br>  Si la secuencia receptora detecta que no hay estado para la placa, se establece la tarea de inicializaci√≥n correspondiente.  La inicializaci√≥n de estado es manejada por un tipo separado de hilo. <br><br>  Los tipos de tareas y su direcci√≥n se pueden representar de la siguiente manera: <br><br><img src="https://habrastorage.org/webt/tu/77/0l/tu770l4w53i7wewueqtoytcvdfc.png"><br><br>  Dicha implementaci√≥n nos permite resolver los siguientes problemas: <br><br><ol><li>  No hay l√≥gica de negocios en la secuencia de recepci√≥n que pueda ralentizar la nueva conexi√≥n.  Este tipo de subproceso en el servidor existe en una sola copia, por lo que los retrasos afectar√°n inmediatamente el tiempo de apertura de las placas, y si hay un error en el c√≥digo comercial, puede colgarlo f√°cilmente. </li><li>  La inicializaci√≥n del estado no se realiza en el flujo comercial de las juntas y no afecta el tiempo de procesamiento de los comandos comerciales de los usuarios.  Puede llevar algo de tiempo, y los flujos comerciales procesan varias juntas a la vez, por lo que la apertura de nuevas juntas no afecta directamente a las existentes. </li><li>  Analizar los comandos de red a menudo es m√°s r√°pido que ejecutarlos directamente, por lo que la configuraci√≥n del grupo de subprocesos de red puede ser diferente de la configuraci√≥n del grupo de subprocesos de negocios para utilizar eficientemente los recursos del sistema. </li></ol><br><h2>  Coloraci√≥n de flujo </h2><br>  El subsistema descrito anteriormente en la implementaci√≥n es bastante no trivial.  El desarrollador debe tener en cuenta el esquema del sistema y tener en cuenta el proceso inverso de cierre de paneles.  Al cerrar, es necesario eliminar todas las suscripciones, eliminar entradas de los registros y hacer esto en las mismas secuencias en las que se inicializaron. <br><br>  Notamos que los errores y las complejidades de la modificaci√≥n del c√≥digo que surgieron en este subsistema a menudo se asociaron con una falta de comprensi√≥n del contexto de ejecuci√≥n.  El malabarismo de hilos y tareas dificult√≥ la respuesta a la pregunta en qu√© hilo en particular se est√° ejecutando un c√≥digo en particular. <br><br>  Para resolver este problema, utilizamos el m√©todo de colorear hilos: esta es una pol√≠tica dirigida a regular el uso de hilos en el sistema.  Los colores se asignan a los hilos y los m√©todos definen el alcance para la ejecuci√≥n dentro de los hilos.  El color aqu√≠ es una abstracci√≥n, puede ser cualquier entidad, por ejemplo, una enumeraci√≥n.  En Java, las anotaciones pueden servir como lenguaje de marcado de color: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Color</span></span> <span class="hljs-meta"><span class="hljs-meta">@IncompatibleColors</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyColor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Grant</span></span> <span class="hljs-meta"><span class="hljs-meta">@Revoke</span></span></code> </pre> <br>  Se agregan anotaciones al m√©todo, utiliz√°ndolas puede establecer la validez del m√©todo.  Por ejemplo, si la anotaci√≥n de un m√©todo permite el amarillo y el rojo, entonces el primer hilo puede llamar al m√©todo, y para el segundo, dicha llamada ser√° err√≥nea. <br><br><img src="https://habrastorage.org/webt/cv/rt/5x/cvrt5xki24dz6q26dbgitgr1t70.png"><br><br>  Se pueden especificar colores no v√°lidos: <br><br><img src="https://habrastorage.org/webt/td/zo/cz/tdzoczjxi31awdahg6q0pz_i0ck.png"><br><br>  Puede agregar y eliminar privilegios de subproceso en la din√°mica: <br><br><img src="https://habrastorage.org/webt/ef/tc/o_/eftco_jb_yduvaqnbss7usmpdro.png"><br><br>  La ausencia de anotaci√≥n o anotaci√≥n como en el ejemplo a continuaci√≥n dice que el m√©todo se puede ejecutar en cualquier hilo: <br><br><img src="https://habrastorage.org/webt/9o/_7/h5/9o_7h5adpnmvctotkxwaavzhpdm.png"><br><br>  Los desarrolladores de Android pueden estar familiarizados con este enfoque para anotaciones MainThread, UiThread, WorkerThread, etc. <br><br>  La coloraci√≥n de hilos utiliza el principio del c√≥digo autodocumentado, y el m√©todo en s√≠ mismo se presta bien para el an√°lisis est√°tico.  Con el an√°lisis est√°tico, puede decir antes de ejecutar el c√≥digo que est√° escrito correctamente o no.  Si excluimos las anotaciones Grant y Revoke y asumimos que la secuencia despu√©s de la inicializaci√≥n ya tiene un conjunto de privilegios inmutable, entonces este ser√° un an√°lisis insensible al flujo, una versi√≥n simple del an√°lisis est√°tico que no tiene en cuenta el orden de las llamadas. <br><br>  En el momento de la implementaci√≥n del m√©todo de coloraci√≥n de flujo, no hab√≠a soluciones listas para el an√°lisis est√°tico en nuestra infraestructura de desarrollo, por lo que fuimos de la manera m√°s simple y econ√≥mica: presentamos nuestras anotaciones, que est√°n asociadas de manera √∫nica con cada tipo de flujos.  Comenzamos a verificar su correcci√≥n con la ayuda de aspectos en tiempo de ejecuci√≥n. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Aspect</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThreadAnnotationAspect</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Pointcut</span></span>(<span class="hljs-string"><span class="hljs-string">"if()"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isActive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment">//   ,    . , ,    } @Pointcut("execution(@ThreadAnnotation * *.*(..))") public static void annotatedMethod() { } @Around("isActive() &amp;&amp; annotatedMethod()") public Object around(ProceedingJoinPoint joinPoint) throws Throwable { Thread thread = Thread.currentThread(); Method method = ((MethodSignature) jp.getSignature()).getMethod(); ThreadAnnotation annotation = getThreadAnnotation(method); if (!annotationMatches(annotation, thread)) { throw new ThreadAnnotationMismatchException(method, thread); } return jp.proceed(); } }</span></span></code> </pre><br>  Para los aspectos, utilizamos la biblioteca aspectoj y el complemento maven, que proporciona tejido al compilar el proyecto.  El tejido se configur√≥ inicialmente para el tiempo de carga al cargar clases con ClassLoader.  Sin embargo, nos enfrentamos al hecho de que el tejedor a veces se comport√≥ incorrectamente al cargar la misma clase de manera competitiva, como resultado de lo cual el c√≥digo fuente de la clase permaneci√≥ sin cambios.  Como resultado, esto result√≥ en un comportamiento de producci√≥n muy impredecible y dif√≠cil de reproducir.  Quiz√°s en las versiones actuales de la biblioteca no haya tal problema. <br><br>  La soluci√≥n en aspectos nos permiti√≥ encontrar r√°pidamente la mayor√≠a de los problemas en el c√≥digo. <br><br>  Es importante no olvidar mantener siempre las anotaciones actualizadas: se pueden eliminar, agregar pereza, los aspectos de tejido se pueden desactivar por completo; en este caso, la coloraci√≥n perder√° r√°pidamente su relevancia y valor. <br><br><h2>  Guardado </h2><br>  Una de las variedades de coloraci√≥n es la anotaci√≥n GuardedBy de java.util.concurrent.  Delimita el acceso a los campos y m√©todos, indicando qu√© bloqueos son necesarios para el acceso correcto. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PrivateLock</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object lock = Object(); <span class="hljs-meta"><span class="hljs-meta">@GuardedBy</span></span> (‚Äúlock‚Äù) Widget widget; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (lock) { <span class="hljs-comment"><span class="hljs-comment">//Access or modify the state of widget } } }</span></span></code> </pre><br>  Los IDE modernos incluso admiten el an√°lisis de esta anotaci√≥n.  Por ejemplo, IDEA muestra este mensaje si algo est√° mal con el c√≥digo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w1/d_/lg/w1d_lgkgbtnsueqjd6lnva0gsto.png"></div><br>  El m√©todo de colorear hilos no es nuevo, pero parece que en lenguajes como Java, donde el acceso multiproceso a menudo va a objetos mutables, su uso no solo como parte de la documentaci√≥n, sino tambi√©n en la etapa de compilaci√≥n, el ensamblaje podr√≠a simplificar enormemente el desarrollo de c√≥digo multiproceso. <br><br>  Todav√≠a usamos la implementaci√≥n en aspectos.  Si est√° familiarizado con una soluci√≥n m√°s elegante o una herramienta de an√°lisis que le permita aumentar la estabilidad de este enfoque ante los cambios del sistema, por favor comp√°rtalo en los comentarios. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/443666/">https://habr.com/ru/post/443666/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../443656/index.html">Siguiendo los pasos de las calculadoras: calcular</a></li>
<li><a href="../443658/index.html">Configuraci√≥n del cl√∫ster de Kubernetes HA en bare metal, monitoreo, registros y ejemplos de uso. Parte 3/3</a></li>
<li><a href="../443660/index.html">Expertos: "Un esc√°ner 3D costar√° 10 veces m√°s barato que un error con el control de calidad tradicional"</a></li>
<li><a href="../443662/index.html">Comprender el c√≥digo limpio en Android</a></li>
<li><a href="../443664/index.html">Estaci√≥n Meteorol√≥gica Arduino</a></li>
<li><a href="../443668/index.html">Volver a los microservicios con Istio. Parte 3</a></li>
<li><a href="../443670/index.html">Error en la nueva versi√≥n de Google Chrome (73.0.3683.75)</a></li>
<li><a href="../443672/index.html">Pruebas basadas en riesgo</a></li>
<li><a href="../443676/index.html">Vinilo en lugar de un sello postal: rareza inusual</a></li>
<li><a href="../443678/index.html">Legibilidad de c√≥digo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>